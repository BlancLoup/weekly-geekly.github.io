<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Why do I need the flexibility of Python if I am forbidden to use it?</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello! I had the following task: I had to parse a bunch of data and organize it into classes, and later load it into a database. It seems to be nothin...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Why do I need the flexibility of Python if I am forbidden to use it?</h1><div class="post__text post__text-html js-mediator-article">  Hello!  I had the following task: I had to parse a bunch of data and organize it into classes, and later load it into a database.  It seems to be nothing complicated, but on this day I even forgot to eat, and why - look under the cat, because I sdelal. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/2a9/55d/56d/2a955d56dc12eb8aebeb8f08b94f640a.jpg" alt="image"></div><a name="habracut"></a><br>  There was, of course, a lot of data, but it didn‚Äôt complicate the task, complicated the fact that the same element could be found in different parts of the site.  This data can be compared with accounts in social networks.  One and the same account can leave its mark everywhere - and put likes on different pages, write comments everywhere, and hang something on the wall for different people.  And we need all this to be the same object in our program and not to duplicate it in any way.  It seems that everything is simple, check to yourself whether this element has already been found - that's all.  But it is ugly, it is not true.  Yes, and contrary to the philosophy of Python.  I wanted a beautiful solution, something that would simply prohibit the creation of an element that already exists or simply does not create it, would ignore all initialization, and the inner constructor returns an already existing element. <br><br>  I will give an example.  I have, for example, an entity. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre><code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Animal</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, id)</span></span></span><span class="hljs-function">:</span></span> self.id=id</code> </pre> <br>  And each such entity has its own unique id. <br><br>  As a result, finding two identical entities in different places, we create 2 absolutely identical objects.  The first thing to do is add some sort of object storage: <br><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Animal</span></span></span><span class="hljs-class">:</span></span> __cache__=dict() <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, id)</span></span></span><span class="hljs-function">:</span></span> self.id=id</code> </pre><br>  A new object in python is created in the function of the <i>__new__</i> class, this function should return the newly created object, and it is in it that we need to dig in to override the element creation behavior. <br><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Animal</span></span></span><span class="hljs-class">:</span></span> __cache__=dict() <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__new__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(cls, id)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> id <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> Animal.__cache__: Animal.__cache__[id]=super().__new__(cls) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Animal.__cache__[id] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, id)</span></span></span><span class="hljs-function">:</span></span> self.id=id</code> </pre><br>  Here, it seems, and everything, the problem is solved.  I thought the first 20 minutes.  When expanding the program and increasing the classes, I began to receive an error like: <i>__init __ () required N positional argument</i> <br><br>  The problem forced me to go to google with the search for what, maybe, I did absolutely everything against the rules.  It turned out, <a href="http://qaru.site/questions/8822/pythons-use-of-new-and-init">yes</a> .  They tell me not to get into the __new__ method without need, and the alternative is offered to the Factory pattern. <br><br>  In short, the Factory pattern is that we allocate a place that controls the creation of objects.  For Python, they offered this <a href="http://code.activestate.com/recipes/86900/">example.</a> <br><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Factory</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">register</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, methodName, constructor, *args, **kargs)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">"""register a constructor"""</span></span> _args = [constructor] _args.extend(args) setattr(self, methodName,apply(Functor,_args, kargs)) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">unregister</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, methodName)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">"""unregister a constructor"""</span></span> delattr(self, methodName) <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Functor</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, function, *args, **kargs)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span> callable(function), <span class="hljs-string"><span class="hljs-string">"function should be a callable obj"</span></span> self._function = function self._args = args self._kargs = kargs <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__call__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, *args, **kargs)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">"""call function"""</span></span> _args = list(self._args) _args.extend(args) _kargs = self._kargs.copy() _kargs.update(kargs) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> apply(self._function,_args,_kargs)</code> </pre><br>  We are allowed to create objects only using the methods of the class Factory  Given that we can absolutely not use it and create objects directly.  In general, this solution may be correct, but I did not like it, so I decided to look for a solution in my own code. <br><br>  A little study of the creation process gave me the answer.  Creating an object (in brief) is as follows: first, the __new__ method is called, into which the class and all the arguments of the constructor are passed, this method creates an object and returns it.  Later, the __init__ method of the class to which the object belongs is called. <br><br>  Abstracted code: <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__new__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(cls, id, b, k, zz)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> super().__new__(cls) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, id, b, k, zz)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-comment"><span class="hljs-comment"># anything self.id=id obj=Animal.__new__(Animal, 1, 2, k=3, zz=4) obj.__class__.__init__(obj, 1, 2, k=3, zz=4)</span></span></code> </pre><br>  The problem came out with the next action.  For example, I add the Cat class <br><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Cat</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(Animal)</span></span></span><span class="hljs-class">:</span></span> data=<span class="hljs-string"><span class="hljs-string">"data"</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, id, b, k, zz, variable, one_more_variable)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-comment"><span class="hljs-comment"># anything pass</span></span></code> </pre><br>  As you can see, the constructors of the classes are different.  Imagine that we have already created an Animal with id = 1.  Later we create a Cat element with id = 1. <br><br>  An object of class Animal with id = 1 already exists, so according to the logic of things, an object of class Cat should not be created.  In general, he does not do this, but ends the error so that a different number of arguments are passed to __init__. <br><br>  As you understand, he tries to create an element of the Cat class, but later calls the constructor of the class Animal.  Not only does it call the wrong constructor, the very bad result is that even if we created Animal again with id = 1, the constructor for the same object was called again.  And, perhaps, would overwrite all the data and do unwanted actions. <br><br>  Not good.  It also makes sense to retreat and create a factory for the production of objects. <br>  But we write in Python, the most flexible and beautiful language, why we have to make concessions. <br><br>  As it turned out, the solution is: <br><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Animal</span></span></span><span class="hljs-class">:</span></span> __cache__=dict() __tmp__=<span class="hljs-keyword"><span class="hljs-keyword">None</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__fake_init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, *args, **kwargs)</span></span></span><span class="hljs-function">:</span></span> self.__class__.__init__=Animal.__tmp__ Animal.__tmp__=<span class="hljs-keyword"><span class="hljs-keyword">None</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__new__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(cls, id)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> id <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> Animal.__cache__: Animal.__cache__[id]=super().__new__(cls) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: Animal.__tmp__=Animal.__cache__[id].__class__.__init__ Animal.__cache__[id].__class__.__init__=Animal.__fake_init__ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Animal.__cache__[id] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, id)</span></span></span><span class="hljs-function">:</span></span> self.id=id</code> </pre><br>  It was impossible to disable the constructor call, after performing __new__, the function call __init__ from the class of the object created (or not, as in our case) of the object went without question.  There was only one way out - to replace __init__ in the class of the created object.  In order not to lose the class constructor, I saved it in some variable and later, instead of it, I slipped the fake constructor, which was then called when the object was ‚Äúcreated‚Äù.  But the fake constructor is not empty, it is precisely what the old designer returns to his place. <br><br>  I‚Äôll say finally that maybe I‚Äôm completely wrong, I realized in absentia that my code contradicts warnings, even in the official Python developer communities they say that you can only touch __new__ when inheriting from iterative types, such as lists, tuples, etc.  But, as it seems to me, sometimes it is worth going beyond the bounds of decency only so that later you can calmly write. <br><br><pre> <code class="python hljs">an1=Animal(<span class="hljs-number"><span class="hljs-number">1</span></span>) an2=Animal(<span class="hljs-number"><span class="hljs-number">1</span></span>) cat1=Cat(<span class="hljs-number"><span class="hljs-number">1</span></span>)</code> </pre><br>  and do not worry about problems. <br><br>  Thanks for attention! </div><p>Source: <a href="https://habr.com/ru/post/339272/">https://habr.com/ru/post/339272/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../339258/index.html">English subtitles with Leo</a></li>
<li><a href="../339262/index.html">Trends and forecasts: which specialists will be snapped up in the near future?</a></li>
<li><a href="../339264/index.html">Introduction to reverse engineering with Radare2</a></li>
<li><a href="../339268/index.html">Play bash'im together</a></li>
<li><a href="../339270/index.html">Wi-Fi is over: calculate offenders wireless</a></li>
<li><a href="../339274/index.html">Trillion Markets, or have time to do in 10 years</a></li>
<li><a href="../339276/index.html">How to accept payments in a mobile application: tokenization, NFC, optical scanning and other buns in one SDK</a></li>
<li><a href="../339278/index.html">Technical composition of process diagrams</a></li>
<li><a href="../339280/index.html">We study the blockchain in practice</a></li>
<li><a href="../339282/index.html">It's time to kill C #</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>