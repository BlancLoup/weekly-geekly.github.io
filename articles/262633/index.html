<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Shine always, shine everywhere. Start</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Probably, this is a mental disorder - the desire to realize something of its own, whatever it takes, preferably from scratch. Especially nice to pre-s...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Shine always, shine everywhere. Start</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/db8/018/0a7/db80180a758d48a393c34a5c6ba39fee.jpg"><br><br>  Probably, this is a mental disorder - the desire to realize something of its own, whatever it takes, preferably from scratch.  Especially nice to pre-shatter to the ground made by predecessors.  The irrepressible desire to build your own bike is also explained by the fact that all existing solutions currently have fatal flaws - too few wheels, too many pedals, it is inconvenient to steer when landing backwards and so on.  Here a wild fantasy turns on, and after a while the world community is overjoyed by a fundamentally new means of transport, exclusively adapted for two reptiloids and one raccoon. <br><a name="habracut"></a><br><br>  This is me actually to the fact that I always wanted to build my home automation system.  Connect a bunch of sensors and actuators, set up the work logic that I need directly, and enjoy the long catch of interesting bugs.  Of course, you can use ready-made solutions.  Now there are many interesting devices on the market for ‚Äúsmart home‚Äù, and if you approach the question in a monumental way, why not build a system based on industrial PLCs and I / O modules?  To bring all this stuff into a SCADA system ... Pretty tempting.  But the creative itch does not allow us to take advantage of the many years of experience of hundreds and thousands of other people, this is how capoeira begins on a rake. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      I still have a little common sense.  In addition, from the cabinets and from the shelves at me, periodically with mute reproach, I look at the unfinished devices, to which I have to get "someday."  So, we need to set ourselves a relatively real task, the solution of which can be brought to its logical conclusion.  Let's start with the lighting control in a small city apartment. <br><br>  <b>I am repelled by the following theses:</b> <br><br>  1) Overhaul.  In terms of power and low current wiring, the hands are completely untied. <br>  2) The ridge of the system - only wired.  I do not rely on Wi-Fi or 433 MHz in critical areas. <br>  3) Minimal use of ready-made devices and units.  For self-education, pumping development skills, installation, programming. <br><br>  <b>Now concretized.</b> <br><br>  1) The main lighting - LED strip.  Bulbs are sent to the dustbin of history.  Additional lighting - fluorescent lamps.  This is for the birds.  Their vision is considerably different from ours, therefore, in order to be comfortable and comfortable, they use full-spectrum lamps with a certain amount of ultraviolet radiation. <br>  2) On-off (for all lighting fixtures) and brightness adjustment (for tapes) should be carried out both manually and programmatically. <br>  3) For emergency situations, an ‚Äúiron‚Äù bypass of the system is necessary.  Roughly speaking, the "brains" were cut off - go on manual control. <br><br>  Now I focus on the second paragraph.  The following tasks are highlighted here: <br><br>  1) Formation of the list of executive devices.  Just two.  Driver LED strip and "relay".  In quotes - because in fact it is a triac. <br>  2) List of control devices.  Too two.  A knob with a button and just a button. <br>  3) Select the method of communication.  You need to dwell on it. <br><br>  Since I decided that the wires will be used, there are few options.  Ethernet can be used.  One network, all on TCP / IP.  It is tempting.  But when I imagined a microcontroller with an Ethernet and a single button, I felt a little sad.  We go further, in the direction of reducing the number of wires and minimizing the requirements for iron.  The complete solution is DMX512.  At the low RS-485 level, everything is fairly simple to implement, but there is no feedback.  What else?  CAN?  Good industrial option, but I want it even easier.  Modbus over RS-485?  Already warmer.  But what about cycling?  In addition, I have already tuned in to the use of cheap microcontrollers with minimal strapping.  And here it is, the decision.  I‚Äôll take RS-485 and think up my own ersatz protocol for it.  In this case, however, it is necessary to leave the path to retreat.  If I dig in, I'll come back to Modbus again. <br><br>  So, the RS-485 network, the master computer (the malinka, most likely), all other devices are slaves.  In terms of iron - ATmega328 + MAX485.  The controller is exactly this because of the presence of several things, with a successful scenario in the "serial" device is replaced by ATmega8.  The packet consists of five bytes.  Device address, command code, two data registers and checksum.  The master sends the packet, all the slaves accept and parse it.  If the address is the same and the checksum is correct, certain actions are performed and a confirmation is sent.  In my opinion, nowhere is easier. <br><br>  I decided to take the matter "from the middle".  Power wiring and any protection devices are later, because everything is relatively clear here.  But in the design and debugging of new devices for me there will be a lot of fun discoveries, so I start with iron.  Or rather - with two devices, the regulator and the driver of the LED tape. <br><br>  <b>Regulator</b> <br><br><img src="https://habrastorage.org/files/791/7b7/f95/7917b7f950694a2091e4ea5798a23e4d.png"><br><br>  Mechanical encoder with a button, microcontroller, RS-485 adapter.  First I implement the connection, then the actual processing of the encoder.  Communication works as follows: <br><br>  1) When the device is turned on, the register values ‚Äã‚Äãare set to 0. Later they will be loaded from the EEPROM.  The address is clogged in the code and will also be stored in non-volatile memory in the future (there is a cap for the procedure for changing the address). <br>  2) During the initialization process, the modes of operation of the UART and the timer are configured (used to stop receiving on timeout) <br>  3) On the ~ RE and DE pins of the MAX485 adapter connected together, the low level is the receive mode. <br>  4) Waiting for reception of the first packet.  As we waited, we start the timer and take four more bytes. <br>  5) If successful, the reception of the five-byte packet and the correct checksum (it is really just a sum, not a CRC) the packet can be parsed. <br>  6) If the address in the packet matches the device address, we check the command code (the second byte of the packet), depending on it, perform the required actions (for example, write the variable values ‚Äã‚Äãof the third and fourth byte).  Within the framework of the described system, I call these variables the device registers. <br>  7) We send confirmation: ~ RE and DE high level, transmission resolution, sending a packet (with the address of the master, some command code and the current value of the device registers). <br>  8) GOTO 3 <br><br>  The receive timeout is monitored simply: the timeout flag is initially 0. When the timer is interrupted, it is set to 1. This flag is checked in the wait cycle for four bytes of the packet. <br><br>  Now encoder processing.  Principle I learned <a href="http://easyelectronics.ru/avr-uchebnyj-kurs-inkrementalnyj-enkoder.html">from here</a> . <br><br>  In short - we keep the current state of the encoder, by interrupting the timer we read the new one.  Depending on what has changed - we determine where the pen turned and whether the button was pressed.  So, in paragraph 2 of the above list, the initialization of Timer2 is added with the expectation that the interrupt will occur at about 1 kHz.  Plus, in order not to interfere with the operation of the UART, in the process of reading or writing to 0, the enable flag of polling the encoder is set (checked in the interrupt handler of the second timer). <br><br>  Actually, the regulator does not need to know anything else. <br><br><img src="https://habrastorage.org/files/898/67d/449/89867d4491af4f5f8d6fd121df4a0cbd.jpg"><br>  <i>I do not describe the errors in the layout and other minor troubles.</i>  <i>To wash the board is also no good at all - she will still get a couple of pokes with a soldering iron</i> <br><br>  <b>About rake at this stage</b> <br><br>  I only had one trouble with the encoder.  She was generally associated with all devices.  Periodically, the network had an extra zero byte, which badly spoiled the picture.  Given the absence of an oscilloscope and a logic analyzer, the problem had to be looked for theoretically.  It turned out to be enough to pull the TX to Vcc so that when switching the "receive-transmit" no unnecessary processes occur. <br><br>  <b>Driver</b> <br><br><img src="https://habrastorage.org/files/bf0/946/7d0/bf09467d04aa4c73852ee0435cb2a0ee.png"><br><br>  We have already solved the communication problem.  We take what concerns RS-485 from the implementation of the controller and add PWM to one output by means of Timer2.  The first register of the device is responsible for the brightness, the second for switching the output on and off as such.  In terms of iron, I use the already proven scheme of two bipolar transistors (they used to be BC639 and BC640, now I use SMD BCP53 and BCP56), the output is IRF540.  There were no interesting jokes with the driver, except for such a buggy 12-volt power supply, whose operation caused the entire system to freeze at once. <br><br><img src="https://habrastorage.org/files/ab1/e8d/787/ab1e8d7876894d25adfbbaed3a5102b6.jpg"><br>  <i>There is also a lot of mounting ugliness.</i>  <i>An early prototype that is already there.</i> <br><br>  <b>General notes on hardware</b> <br><br>  Microcontrollers are clocked at 8 MHz without external quartz.  The power harness consists of a single 100 nF capacitor.  Conclusion ~ RST pulled to power through a 10 kŒ© resistor.  I have already mentioned that the stability of the work has drastically improved after tightening the TX to the power line.  When constructing a regulator, I did not rely on internal pull-up resistors (on the pins to which the encoder is connected), but used external ones.  No more tweaks (yet?) Required.  The RS-485 line is pulled to Vcc (A) and GND (B) through 560 ohm resistors from the lead adapter, terminated at both ends with 120 ohm resistors. <br><br>  The project is available on <a href="https://github.com/eta4ever/dimmer485">github</a> , the structure is as follows: <br><br>  - avr-dimmer - driver firmware (project Eclipse + AVR); <br>  - avr-encoder - regulator firmware; <br>  - host - network wizard software (Python), about it next time; <br>  - At the root are the schemes (Eagle) and PCB layout (Sprint Layout 6). <br><br>  Next time I will talk about what is happening on the host side (network wizard). <br><br>  UPD.  2015-07-19 the <a href="http://geektimes.ru/post/259004/">second part</a> , in the gland, too, there are changes. </div><p>Source: <a href="https://habr.com/ru/post/262633/">https://habr.com/ru/post/262633/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../262617/index.html">48 hours of your publication on Habr√©</a></li>
<li><a href="../262623/index.html">36 million requests per hour, 10,000+ constantly working clients, on one server, nginx + mysql</a></li>
<li><a href="../262625/index.html">Ten commandments of a successful data center</a></li>
<li><a href="../262627/index.html">6 phrases that can change your approach to customer service</a></li>
<li><a href="../262631/index.html">Beeline interferes with user traffic</a></li>
<li><a href="../262635/index.html">Internet Explorer 11 discovered zero day vulnerability</a></li>
<li><a href="../262639/index.html">Epic Games official forums hacked</a></li>
<li><a href="../262645/index.html">Firefox blocks Adobe Flash Player plugin</a></li>
<li><a href="../262647/index.html">"Pimp my game", or how to "pump over" games without API</a></li>
<li><a href="../262649/index.html">[ABAP] Learn to use FOR ALL ENTRIES IN correctly</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>