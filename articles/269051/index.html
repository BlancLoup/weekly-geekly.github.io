<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Converting multi-page xls / xslx to csv with PHPExcel</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In my projects, it was often necessary to collect data from different sources in a CSV format, and so far I did not need to receive data from several ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Converting multi-page xls / xslx to csv with PHPExcel</h1><div class="post__text post__text-html js-mediator-article"> In my projects, it was often necessary to collect data from different sources in a CSV format, and so far I did not need to receive data from several pages of xls tables, I just had a simple fgetcsv () / fputcsv ().  But the day came when the task ‚Äúto get data from all pages of the document‚Äù was set before me.  And, as usual, I began to look for a ready-made solution in order not to build my ‚Äúbicycle‚Äù.  But, unfortunately, I didn‚Äôt find exactly what I needed: there was a similar solution that displayed a multi-page document on the screen, but another library was used, which, as I understood, did not support the xslx format (Excel 2007 +).  A little more searching for other options, I realized that it was a bad job and decided to deal with the library myself.  Combining some tips on working with the PHPExcel library into one, I got the following script.  So let's get started. <br><a name="habracut"></a><br>  First we need <a href="https://github.com/PHPOffice/PHPExcel">PHPExcel</a> itself.  Immediately, I note that the library is perfectly installed through the composer, but there is no explicitly full version of the library anywhere indicated.  I selected version 1.8 with the selection method with the addition of the ‚Äúinaccuracy‚Äù attribute. <br><br>  In my composer.json, which I added to the ‚Äúrequire-dev‚Äù block: {}, I got this entry: <br><br> <code>"require-dev": { <br> "phpoffice/phpexcel": "~1.8" <br> }, <br></code> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      At the moment, version 1.8.1 has been installed.  Since the PHPExcel library inherits SPL, which is in PHP, starting with version 5.3, instead of the standard walkthroughs of the array of strings and document cells using foreach (), I decided to use Iterators. <br><br>  We connect the library, load the document and define some initial data: <br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">/** Include PHPExcel */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">include_once</span></span> <span class="hljs-string"><span class="hljs-string">'../Classes/PHPExcel.php'</span></span>; $callStartTime = microtime(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); $tmpFileName = microtime(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); $format = <span class="hljs-string"><span class="hljs-string">'Ym-d'</span></span>; <span class="hljs-comment"><span class="hljs-comment">// Load PHPExcel object $objPHPExcel = PHPExcel_IOFactory::load('multipage.xls');</span></span></code> </pre><br>  Next, we get an Iterator of pages, for which we don‚Äôt need to know their number: <br><br><pre> <code class="php hljs">$sheetsIterator = $objPHPExcel-&gt;getWorksheetIterator();</code> </pre><br>  The iterator is bypassed using this simple construction: <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">while</span></span>( $sheetsIterator-&gt;valid()) { $pageNumber = $sheetsIterator-&gt;key(); $pageContent = $sheetsIterator-&gt;current(); $sheetsIterator-&gt;next();</code> </pre><br>  Similarly, the lines and cells of the document were obtained and bypassed  How nice to get data from the cell, I found here, in Habr√©, in the article <a href="http://habrahabr.ru/post/136540/">Universal reading cells in PHPExcel</a> .  I will not describe in detail all the checks, who have a desire - you can read in this article. <br><br>  Writing to a CSV file, I produce the same through this library like this. <br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// Create new object to write converted data and separate documents sheets $csvPagePhpExcel = new PHPExcel(); // HERE Add Data to Object // Creating CSV writer Object and save data to file $objWriter = PHPExcel_IOFactory::createWriter($csvPagePhpExcel, 'CSV'); $objWriter-&gt;save($currentTmpFileName);</span></span></code> </pre><br>  Filling the object to write to the file I will show below in the full version of the script.  The only thing I can add is: if you need to write dates again in xls / xlsx documents and specify <b>explicit formatting</b> , you can use the following construct when preparing the PHPExcel object: <br><br><pre> <code class="php hljs"> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($isDate) { $csvPagePhpExcel-&gt;getActiveSheet()-&gt;getStyle($cellIterator-&gt;key().$rowIterator-&gt;key())-&gt;getNumberFormat()-&gt;setFormatCode(PHPExcel_Style_NumberFormat::FORMAT_DATE_YYYYMMDD2); $csvPagePhpExcel-&gt;getActiveSheet()-&gt;setCellValue($cellIterator-&gt;key().$rowIterator-&gt;key(), $cellValue); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { $csvPagePhpExcel-&gt;getActiveSheet()-&gt;setCellValue($cellIterator-&gt;key().$rowIterator-&gt;key(), $cellValue); }</code> </pre><br>  Where the format is specified using the <b>PHPExcel_Style_NumberFormat :: FORMAT_DATE_YYYYMMDD2 constant</b> .  In this case, it is the yyyy-mm-dd format, which you can immediately use in the MySql query. <br><br>  By the way, here are all available library constants: <br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">/* Pre-defined formats */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> FORMAT_GENERAL = <span class="hljs-string"><span class="hljs-string">'General'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> FORMAT_TEXT = <span class="hljs-string"><span class="hljs-string">'@'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> FORMAT_NUMBER = <span class="hljs-string"><span class="hljs-string">'0'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> FORMAT_NUMBER_00 = <span class="hljs-string"><span class="hljs-string">'0.00'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> FORMAT_NUMBER_COMMA_SEPARATED1 = <span class="hljs-string"><span class="hljs-string">'#,##0.00'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> FORMAT_NUMBER_COMMA_SEPARATED2 = <span class="hljs-string"><span class="hljs-string">'#,##0.00_-'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> FORMAT_PERCENTAGE = <span class="hljs-string"><span class="hljs-string">'0%'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> FORMAT_PERCENTAGE_00 = <span class="hljs-string"><span class="hljs-string">'0.00%'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> FORMAT_DATE_YYYYMMDD2 = <span class="hljs-string"><span class="hljs-string">'yyyy-mm-dd'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> FORMAT_DATE_YYYYMMDD = <span class="hljs-string"><span class="hljs-string">'yy-mm-dd'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> FORMAT_DATE_DDMMYYYY = <span class="hljs-string"><span class="hljs-string">'dd/mm/yy'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> FORMAT_DATE_DMYSLASH = <span class="hljs-string"><span class="hljs-string">'d/m/y'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> FORMAT_DATE_DMYMINUS = <span class="hljs-string"><span class="hljs-string">'dm-y'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> FORMAT_DATE_DMMINUS = <span class="hljs-string"><span class="hljs-string">'d-m'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> FORMAT_DATE_MYMINUS = <span class="hljs-string"><span class="hljs-string">'m-y'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> FORMAT_DATE_XLSX14 = <span class="hljs-string"><span class="hljs-string">'mm-dd-yy'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> FORMAT_DATE_XLSX15 = <span class="hljs-string"><span class="hljs-string">'d-mmm-yy'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> FORMAT_DATE_XLSX16 = <span class="hljs-string"><span class="hljs-string">'d-mmm'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> FORMAT_DATE_XLSX17 = <span class="hljs-string"><span class="hljs-string">'mmm-yy'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> FORMAT_DATE_XLSX22 = <span class="hljs-string"><span class="hljs-string">'m/d/yy h:mm'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> FORMAT_DATE_DATETIME = <span class="hljs-string"><span class="hljs-string">'d/m/yh:mm'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> FORMAT_DATE_TIME1 = <span class="hljs-string"><span class="hljs-string">'h:mm AM/PM'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> FORMAT_DATE_TIME2 = <span class="hljs-string"><span class="hljs-string">'h:mm:ss AM/PM'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> FORMAT_DATE_TIME3 = <span class="hljs-string"><span class="hljs-string">'h:mm'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> FORMAT_DATE_TIME4 = <span class="hljs-string"><span class="hljs-string">'h:mm:ss'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> FORMAT_DATE_TIME5 = <span class="hljs-string"><span class="hljs-string">'mm:ss'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> FORMAT_DATE_TIME6 = <span class="hljs-string"><span class="hljs-string">'h:mm:ss'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> FORMAT_DATE_TIME7 = <span class="hljs-string"><span class="hljs-string">'i:s.S'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> FORMAT_DATE_TIME8 = <span class="hljs-string"><span class="hljs-string">'h:mm:ss;@'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> FORMAT_DATE_YYYYMMDDSLASH = <span class="hljs-string"><span class="hljs-string">'yy/mm/dd;@'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> FORMAT_CURRENCY_USD_SIMPLE = <span class="hljs-string"><span class="hljs-string">'"$"#,##0.00_-'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> FORMAT_CURRENCY_USD = <span class="hljs-string"><span class="hljs-string">'$#,##0_-'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> FORMAT_CURRENCY_EUR_SIMPLE = <span class="hljs-string"><span class="hljs-string">'[$EUR ]#,##0.00_-'</span></span>;</code> </pre><br>  As a result, I got a script that writes each page of the document in a separate csv-file, while receiving the correct cell values ‚Äã‚Äãregardless of the availability of external data and formats the date in a suitable format. <br><br>  Here it is: <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-comment"><span class="hljs-comment">/** Include PHPExcel */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">include_once</span></span> <span class="hljs-string"><span class="hljs-string">'../Classes/PHPExcel.php'</span></span>; $callStartTime = microtime(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); <span class="hljs-comment"><span class="hljs-comment">// Load PHPExcel object $objPHPExcel = PHPExcel_IOFactory::load('multipage.xls'); // Get all document sheets $sheetsIterator = $objPHPExcel-&gt;getWorksheetIterator(); $tmpFileName = microtime(true); // Date format ready to import in SQL database $format = 'Ym-d'; while( $sheetsIterator-&gt;valid()) { $currentTmpFileName = "/tmp/{$tmpFileName}_sheet_{$sheetsIterator-&gt;key()}.csv"; echo $sheetsIterator-&gt;key() . '&lt;hr /&gt;'; // Get current sheet rows $rowIterator = $sheetsIterator-&gt;current()-&gt;getRowIterator(); // Create new object to write converted data and separate documents sheets $csvPagePhpExcel = new PHPExcel(); while ($rowIterator-&gt;valid()) { // Get Cells from current Rows $cellIterator = $rowIterator-&gt;current()-&gt;getCellIterator(); echo '&lt;br /&gt;' . $rowIterator-&gt;key() .'-'; while ($cellIterator-&gt;valid()) { $cellValue = $cellIterator-&gt;current()-&gt;getCalculatedValue(); //check is date if(PHPExcel_Shared_Date::isDateTime($cellIterator-&gt;current())) { $cellValue = date($format, PHPExcel_Shared_Date::ExcelToPHP($cellValue)); } //for incorrect formulas take old value if((substr($cellValue,0,1) === '=' ) &amp;&amp; (strlen($cellValue) &gt; 1)){ $cellValue = $cellIterator-&gt;current()-&gt;getOldCalculatedValue(); } $currentCellNum = PHPExcel_Cell::columnIndexFromString($cellIterator-&gt;key()); echo $cellIterator-&gt;key() . '(' . $currentCellNum . ') =&gt; ' . $cellValue; $csvPagePhpExcel-&gt;getActiveSheet()-&gt;setCellValue($cellIterator-&gt;key().$rowIterator-&gt;key(), $cellValue); $cellIterator-&gt;next(); } $rowIterator-&gt;next(); } // Creating CSV writer Object and save data to file $objWriter = PHPExcel_IOFactory::createWriter($csvPagePhpExcel, 'CSV'); $objWriter-&gt;save($currentTmpFileName); // clearing trash $csvPagePhpExcel-&gt;__destruct(); unset($csvPagePhpExcel); $objWriter = ''; unset($objWriter); $sheetsIterator-&gt;next(); } $callEndTime = microtime(true); $callTime = $callEndTime - $callStartTime; echo $callTime;</span></span></code> </pre><br>  At the stage of testing, all values ‚Äã‚Äãare displayed on the screen, then who does not need to naturally output can be removed. <br><br>  Criticism, additions and corrections are welcome.  Thank you all, and I will be very happy if my article will help someone and shorten a few hours of work. </div><p>Source: <a href="https://habr.com/ru/post/269051/">https://habr.com/ru/post/269051/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../269037/index.html">Program modification and what is better to change: executable code or AST program?</a></li>
<li><a href="../269039/index.html">PHP Digest 72 - interesting news, materials and tools (October 5 - 18, 2015)</a></li>
<li><a href="../269041/index.html">Solving common problems when building an Xcode project generated by Unity3D</a></li>
<li><a href="../269045/index.html">Phone numbers in email clients</a></li>
<li><a href="../269049/index.html">Serge - the solution for continuous localization from Evernote</a></li>
<li><a href="../269053/index.html">Asterisk: using AEL in everyday life</a></li>
<li><a href="../269055/index.html">Pulling information from the URL, in the style of Slack and Twitter</a></li>
<li><a href="../269057/index.html">Very handy abstract adapter for RecyclerView do it yourself</a></li>
<li><a href="../269059/index.html">Detective story - What do auto.ru and brazzers have in common?</a></li>
<li><a href="../26906/index.html">Starter Plucker Notes</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>