<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Analyze it - Lenta.ru</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Analyze it. Lenta.ru (part 1) 
 What, How, Why 
 For those who are too lazy to read - link to datasets below the article. 

 What - analysis of articl...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Analyze it - Lenta.ru</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://habrastorage.org/webt/5s/ce/5u/5sce5uzwqgziax74va_ni4jzq1q.jpeg"></p><br><h1 id="analiziruy-eto-lentaru-chast-1">  Analyze it.  Lenta.ru (part 1) </h1><br><h3 id="what-how-why">  What, How, Why </h3><br><blockquote>  For those who are too lazy to read - link to datasets below the article. </blockquote><p>  What - analysis of articles news resource Lenta.ru over the past 18 years (from September 1, 1999).  How - by means of the R language (with the involvement of the MySterm program from Yandex on a separate site).  Why ... In my case, the short answer to the question ‚Äúwhy‚Äù will be ‚Äúgaining experience‚Äù in Big Data.  A more detailed explanation would be "the fulfillment of a real task, within which I can apply the skills acquired during training, as well as get a result that I could show as confirmation of my skills." </p><a name="habracut"></a><br><blockquote>  My background is 15 years as a 1C programmer and the first 5 courses in the <a href="https://www.coursera.org/specializations/jhu-data-science">Data Science</a> specialization from Coursera.org, which basically gave a basis and work with R. Well, you can add experience writing small procedures on Basic, Pascal and Java 17-18 years backwards  Despite the fact that in the current profession 80lvl is almost reached, no job has yet been sent from Google.  Therefore, it was decided to put on the mainstream and touch the bigdate, since the threshold of entry is relatively lower compared to the same Java. </blockquote><p>  Of course, having decided within myself that I need practice and a portfolio, I would have to grab a couple of datasets, of which the sea is now, and analyze, analyze, analyze ... But having figured my skills in my head by directly analyzing and remembering that analysis is only 20-30% time and the rest is a search-collection-survey-data preparation, decided to take on the second.  Yes, and I wanted something special, perhaps even interesting, in contrast to the analysis of air tickets sold in the USA over the past 30 years or the statistics of arrests. </p><br><p>  <a href="https://lenta.ru/">Lenta.ru</a> was chosen as an object of research.  In part, because I am a long-time reader of it, although I regularly spit on the slag that slips past the editors (if there are any at all).  In part, because it seemed relatively easy for data mining.  However, to be honest, when approaching the choice of an object, I practically did not take into account the questions "and what will I do with this date" and "what questions will I ask."  And this is due to the fact that at the moment I have more or less mastered only Getting and Cleaning Data and my knowledge of analysis is very poor.  Of course, I imagined that at a minimum I could answer the question "how the average daily amount of news published has changed over the last 5-10 years," but I did not think beyond that. </p><br><p>  And so, this article will be devoted to the extraction and cleaning of data that will be suitable for the analysis of Lenta.ru. </p><br><h3 id="grabbing">  Grabbing </h3><br><p>  First of all, I needed to decide how to grab and parse the contents of the resource pages.  Google suggested that the best <a href="https://cran.r-project.org/web/packages/rvest/rvest.pdf">option</a> would be to use the <a href="https://cran.r-project.org/web/packages/rvest/rvest.pdf">rvest</a> package, which at the same time allows you to get the text of the page by its address and using xPath to pull the contents of the fields I need.  Of course, moving on, I had to split this task into two - getting pages and direct parsing, but I realized this later, but for now the first step was to get a list of links to the articles themselves. </p><br><p>  After a brief study, the site had an Archive section that, using a simple script, redirected me to a page containing links to all the news for a specific date and the path to this page looked like <a href="https://lenta.ru/2017/07/01/">https://lenta.ru/2017/07/01 /</a> or <a href="https://lenta.ru/2017/03/09/">https://lenta.ru/2017/03/09/</a> .  It only remained to go through all these pages and get these latest news links. <br>  For these purposes (grabbing and parsing) one way or another I used the following packages: </p><br><pre><code class="hljs lisp">require(<span class="hljs-name"><span class="hljs-name">lubridate</span></span>) require(<span class="hljs-name"><span class="hljs-name">rvest</span></span>) require(<span class="hljs-name"><span class="hljs-name">dplyr</span></span>) require(<span class="hljs-name"><span class="hljs-name">tidyr</span></span>) require(<span class="hljs-name"><span class="hljs-name">purrr</span></span>) require(<span class="hljs-name"><span class="hljs-name">XML</span></span>) require(<span class="hljs-name"><span class="hljs-name">data</span></span>.table) require(<span class="hljs-name"><span class="hljs-name">stringr</span></span>) require(<span class="hljs-name"><span class="hljs-name">jsonlite</span></span>) require(<span class="hljs-name"><span class="hljs-name">reshape2</span></span>)</code> </pre> <br><p>  Not a tricky code that allowed to get all the links to all articles in the last 8 years: </p><br><pre> <code class="hljs pgsql">articlesStartDate &lt;- <span class="hljs-keyword"><span class="hljs-keyword">as</span></span>.Date("2010-01-01") articlesEndDate &lt;- <span class="hljs-keyword"><span class="hljs-keyword">as</span></span>.Date("2017-06-30") ## STEP <span class="hljs-number"><span class="hljs-number">1.</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Prepare</span></span> articles links list # Dowload list <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> pages <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> archived articles. # Takes about <span class="hljs-number"><span class="hljs-number">40</span></span> minutes GetNewsListForPeriod &lt;- <span class="hljs-keyword"><span class="hljs-keyword">function</span></span>() { <span class="hljs-type"><span class="hljs-type">timestamp</span></span>() # <span class="hljs-keyword"><span class="hljs-keyword">Prepare</span></span> vector <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> links <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> archive pages <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> https://lenta.ru//yyyy/mm/dd/ <span class="hljs-keyword"><span class="hljs-keyword">format</span></span> dayArray &lt;- seq(<span class="hljs-keyword"><span class="hljs-keyword">as</span></span>.Date(articlesStartDate), <span class="hljs-keyword"><span class="hljs-keyword">as</span></span>.Date(articlesEndDate), <span class="hljs-keyword"><span class="hljs-keyword">by</span></span>="days") archivePagesLinks &lt;- paste0(baseURL, "/", year(dayArray), "/", formatC(month(dayArray), width = <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">format</span></span> = "d", flag = "0"), "/", formatC(day(dayArray), width = <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">format</span></span> = "d", flag = "0"), "/") # Go through <span class="hljs-keyword"><span class="hljs-keyword">all</span></span> pages <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> extract <span class="hljs-keyword"><span class="hljs-keyword">all</span></span> news links articlesLinks &lt;- c() <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>:length(archivePagesLinks)) { pg &lt;- read_html(archivePagesLinks[i], encoding = "UTF-8") linksOnPage &lt;- html_nodes(pg, xpath=".//section[@class='b-longgrid-column']//div[@class='titles']//a") %&gt;% html_attr("href") articlesLinks &lt;- c(articlesLinks, linksOnPage) saveRDS(articlesLinks, file.path(tempDataFolder, "tempArticlesLinks.rds")) } # <span class="hljs-keyword"><span class="hljs-keyword">Add</span></span> root <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-keyword"><span class="hljs-keyword">write</span></span> down <span class="hljs-keyword"><span class="hljs-keyword">all</span></span> the news links articlesLinks &lt;- paste0(baseURL, articlesLinks) writeLines(articlesLinks, file.path(tempDataFolder, "articles.urls")) <span class="hljs-type"><span class="hljs-type">timestamp</span></span>() }</code> </pre> <br><p>  <code>2017-06-30</code> generated an array of dates from <code>2010-01-01</code> to <code>2017-06-30</code> and transforming <code>archivePagesLinks</code> , I received links to all the so-called "archive pages": </p><br><pre> <code class="hljs pgsql">&gt; head(archivePagesLinks) [<span class="hljs-number"><span class="hljs-number">1</span></span>] "https://lenta.ru/2010/01/01/" [<span class="hljs-number"><span class="hljs-number">2</span></span>] "https://lenta.ru/2010/01/02/" [<span class="hljs-number"><span class="hljs-number">3</span></span>] "https://lenta.ru/2010/01/03/" [<span class="hljs-number"><span class="hljs-number">4</span></span>] "https://lenta.ru/2010/01/04/" [<span class="hljs-number"><span class="hljs-number">5</span></span>] "https://lenta.ru/2010/01/05/" [<span class="hljs-number"><span class="hljs-number">6</span></span>] "https://lenta.ru/2010/01/06/" &gt; length(archivePagesLinks) [<span class="hljs-number"><span class="hljs-number">1</span></span>] <span class="hljs-number"><span class="hljs-number">2738</span></span></code> </pre> <br><p>  Using the <code>read_html</code> method <code>read_html</code> I ‚Äúdownloaded‚Äù the contents of the pages into the buffer in a loop, and with the help of the <code>html_nodes</code> and <code>html_attr</code> methods <code>html_attr</code> received direct links to articles, of which almost <code>400</code> were published: </p><br><pre> <code class="hljs pgsql">&gt; head(articlesLinks) [<span class="hljs-number"><span class="hljs-number">1</span></span>] "https://lenta.ru/news/2009/12/31/kids/" [<span class="hljs-number"><span class="hljs-number">2</span></span>] "https://lenta.ru/news/2009/12/31/silvio/" [<span class="hljs-number"><span class="hljs-number">3</span></span>] "https://lenta.ru/news/2009/12/31/postpone/" [<span class="hljs-number"><span class="hljs-number">4</span></span>] "https://lenta.ru/photo/2009/12/31/meeting/" [<span class="hljs-number"><span class="hljs-number">5</span></span>] "https://lenta.ru/news/2009/12/31/boeviks/" [<span class="hljs-number"><span class="hljs-number">6</span></span>] "https://lenta.ru/news/2010/01/01/celebrate/" &gt; length(articlesLinks) [<span class="hljs-number"><span class="hljs-number">1</span></span>] <span class="hljs-number"><span class="hljs-number">379862</span></span></code> </pre> <br><p>  After getting the first results, I realized the problem.  The code above was about <code>40 </code> .  Considering the fact that during this time <code>2738</code> links were processed, it can be calculated that it <code>379862</code> <code>5550</code> minutes to process <code>379862</code> links, or <code>92   </code> , that you will agree to no gate ... Built-in methods <code>readLines {base}</code> and <code>download.file {utils}</code> , which allowed just to get the text, gave similar results.  The <code>htmlParse {XML}</code> method, which, like <code>read_html</code> , allowed to download and continue content parsing, did not improve the situation either.  The same result using <code>getURL {RCurl}</code> .  Dead end. </p><br><p><img src="https://habrastorage.org/webt/fk/fk/qz/fkfkqzfygyyxmp_0xcgs_iyd4-k.jpeg"></p><br><p>  In search of a solution to the problem, I and Google decided to look in the direction of the "parallel" execution of my requests, so at the time the code worked, neither the network, nor the memory, nor the processor were loaded.  Google prompted to dig in the direction of <code>parallel-package {parallel}</code> .  A few hours of study and tests have shown that there is no profit with running even in two "parallel" threads.  Scanty information in Google said that using this package you can parallelize any calculations or data manipulations, but when working with a disk or an external source, all requests are performed within a single process and are lined up (I could be mistaken in understanding the situation).  Yes, and as I understood, even if the topic had taken off, it was worth only expecting an increase in performance multiple of the existing cores, i.e  even with 8 pieces (which I didn't have) and real parallelism, I had to smoke for about 690 minutes. </p><br><p>  The next idea was to run in parallel several processes R, in which their own part of a large list of links would be processed.  However, Google didn‚Äôt say anything to the question ‚Äúhow to start several new R sessions from session R‚Äù.  I also thought about the option of launching the R-script via the command line, but the experience with CMD was at the level of "type dir and get a list of files in the folder".  I was again at an impasse. </p><br><p>  When Google stopped giving me new results, with a clear conscience I decided to ask for help from the audience.  Since Google quite often gave out <a href="https://stackoverflow.com/">stackoverflow</a> , I decided to try my luck there.  Having experience in thematic forums and knowing the reaction to newcomers' questions, I tried to state the <a href="https://stackoverflow.com/questions/39180106/i-have-to-grab-plantext-from-over-290k-webpages-is-there-a-way-to-improve-the-s">problem</a> as clearly and clearly as possible.  And about a miracle, after a few hours I received from <a href="https://rud.is/">Bob Rudis a</a> more than detailed answer, which, after being inserted into my code, almost completely solved my problem.  True with a caveat: I absolutely did not understand how it works.  The first time I heard about <code>wget</code> , I didn‚Äôt understand what the code does with the <code>WARC</code> and why they transfer the function to the method (I repeat, I didn‚Äôt finish the seminaries and didn‚Äôt use tricks in my previous language).  However, if you look at the code for a long, long time, then enlightenment still comes.  And by adding attempts to perform it piece by piece, examining the function by function, you can achieve certain results.  Well, the same Google helped me with <code>wget</code> . </p><br><blockquote>  In spite of the fact that all development was conducted in the macOS environment, the need to use wget (and later MyStem, which worked only on Windows), had to narrow the runtime to Windows.  I have an idea that curl can do something like that, and maybe I will take the time and try to implement it with it, but for now I decided not to stop at the place and move on. </blockquote><p>  As a result, the essence of the decision was reduced to the following - a previously prepared file containing links to articles was slipped to the <code>wget</code> command: </p><br><pre> <code class="hljs pgsql"> wget <span class="hljs-comment"><span class="hljs-comment">--warc-file=lenta -i lenta.urls</span></span></code> </pre> <br><p>  Directly the execution code looked like this: </p><br><pre> <code class="hljs pgsql"> <span class="hljs-keyword"><span class="hljs-keyword">system</span></span>("wget --warc-file=lenta -i lenta.urls", intern = <span class="hljs-keyword"><span class="hljs-keyword">FALSE</span></span>)</code> </pre> <br><p>  After execution, I received a bunch of files (one for each transmitted link) with html content of web pages.  Also at my disposal was a packed <code>WARC</code> , which contained a log of communication with the resource, as well as the very contents of the web pages.  That <code>WARC</code> and offered to <a href="https://rud.is/">parse Bob Rudis</a> .  Exactly what is needed.  And I left copies of the read pages, which made it possible for them to re-read. </p><br><p>  The first measurements of performance showed that <code>10 </code> were spent for downloading <code>2000</code> links, and an extrapolation method (I wanted to use this word for a long time) received <code>1890 </code> for all articles - ‚ÄúOlmost three times fast baht music notes‚Äù - almost three times faster, but still not enough.  Returning a couple of steps back and testing a new mechanism with regard to <code>parallel-package {parallel}</code> , I realized that there is no profit here either. </p><br><p>  There was a knight's turn.  Run several truly parallel processes.  Taking into account the fact that I already took a step aside from "reproducible research" (the principle we talked about in the courses) (using the external program wget and actually tying the implementation to the Windows environment), I decided to take another step and return to the idea running parallel processes, however, already outside R. How to make the CMD file execute several consecutive commands, without waiting for the previous one (read in parallel), the same <a href="https://stackoverflow.com/">stackoverflow</a> told.  It turned out that the excellent <code>START</code> command allows you to run a command in a separate window.  Armed with this knowledge, I delivered the following code: </p><br><pre> <code class="hljs pgsql">## STEP <span class="hljs-number"><span class="hljs-number">2.</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Prepare</span></span> wget CMD files <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> parallel downloading # <span class="hljs-keyword"><span class="hljs-keyword">Create</span></span> CMD file. # Downloading process <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-number"><span class="hljs-number">400</span></span>K pages takes about <span class="hljs-number"><span class="hljs-number">3</span></span> hours. Expect about <span class="hljs-number"><span class="hljs-number">70</span></span>GB # <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> html files <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-number"><span class="hljs-number">12</span></span>GB <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> compressed WARC files CreateWgetCMDFiles &lt;- <span class="hljs-keyword"><span class="hljs-keyword">function</span></span>() { <span class="hljs-type"><span class="hljs-type">timestamp</span></span>() articlesLinks &lt;- readLines(file.path(tempDataFolder, "articles.urls")) dir.<span class="hljs-keyword"><span class="hljs-keyword">create</span></span>(warcFolder, showWarnings = <span class="hljs-keyword"><span class="hljs-keyword">FALSE</span></span>) # Split up articles links <span class="hljs-keyword"><span class="hljs-keyword">array</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span>K links numberOfLinks &lt;- length(articlesLinks) digitNumber &lt;- <span class="hljs-type"><span class="hljs-type">nchar</span></span>(numberOfLinks) groupSize &lt;- <span class="hljs-number"><span class="hljs-number">10000</span></span> filesGroup &lt;- seq(<span class="hljs-keyword"><span class="hljs-keyword">from</span></span> = <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> = numberOfLinks, <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> = groupSize) cmdCodeAll &lt;- c() <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>:length(filesGroup)) { # <span class="hljs-keyword"><span class="hljs-keyword">Prepare</span></span> folder <span class="hljs-type"><span class="hljs-type">name</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-number"><span class="hljs-number">00001</span></span><span class="hljs-number"><span class="hljs-number">-10000</span></span>, <span class="hljs-number"><span class="hljs-number">10001</span></span><span class="hljs-number"><span class="hljs-number">-20000</span></span> etc firstFileInGroup &lt;- filesGroup[i] lastFileInGroup &lt;- min(firstFileInGroup + groupSize - <span class="hljs-number"><span class="hljs-number">1</span></span>, numberOfLinks) leftPartFolderName &lt;- formatC(firstFileInGroup, width = digitNumber, <span class="hljs-keyword"><span class="hljs-keyword">format</span></span> = "d", flag = "0") rigthPartFolderName &lt;- formatC(lastFileInGroup, width = digitNumber, <span class="hljs-keyword"><span class="hljs-keyword">format</span></span> = "d", flag = "0") subFolderName &lt;- paste0(leftPartFolderName, "-", rigthPartFolderName) subFolderPath &lt;- file.path(downloadedArticlesFolder, subFolderName) dir.<span class="hljs-keyword"><span class="hljs-keyword">create</span></span>(subFolderPath) # <span class="hljs-keyword"><span class="hljs-keyword">Write</span></span> articles.urls <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">each</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span>K folders that contains <span class="hljs-number"><span class="hljs-number">10</span></span>K articles urls writeLines(articlesLinks[firstFileInGroup:lastFileInGroup], file.path(subFolderPath, "articles.urls")) # <span class="hljs-keyword"><span class="hljs-keyword">Add</span></span> command <span class="hljs-type"><span class="hljs-type">line</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> CMD file that will looks <span class="hljs-keyword"><span class="hljs-keyword">like</span></span>: # <span class="hljs-string"><span class="hljs-string">'START wget --warc-file=warc\000001-010000 -i 000001-010000\list.urls -P 000001-010000'</span></span> cmdCode &lt;-paste0("START ..\\wget -i ", subFolderName, "\\", "articles.urls -P ", subFolderName) # Use commented code below <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> downloading <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> WARC files: #cmdCode &lt;-paste0("START ..\\wget --warc-file=warc\\", subFolderName," -i ", # subFolderName, "\\", "articles.urls -P ", subFolderName) cmdCodeAll &lt;- c(cmdCodeAll, cmdCode) } # <span class="hljs-keyword"><span class="hljs-keyword">Write</span></span> down command file cmdFile &lt;- file.path(downloadedArticlesFolder, "start.cmd") writeLines(cmdCodeAll, cmdFile) print(paste0("Run ", cmdFile, " to start downloading.")) print("wget.exe should be placed in working directory.") <span class="hljs-type"><span class="hljs-type">timestamp</span></span>() }</code> </pre> <br><p>  This code breaks an array of links to blocks of 10,000 pieces (in my case, 38 blocks turned out).  For each block in the cycle, a folder of the type <code>00001-10000</code> , <code>10001-20000</code> , etc. is created, into which your own "articles.urls" file (with its 10,000 links) will be added and the downloaded files will also be there.  In the same cycle, a CMD file is collected, which must simultaneously run 38 windows: </p><br><pre> <code class="hljs tex">START ..<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">wget</span></span></span></span> --warc-file=warc<span class="hljs-tag"><span class="hljs-tag">\</span></span>000001-010000 -i 000001-010000<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">articles</span></span></span></span>.urls -P 000001-010000 START ..<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">wget</span></span></span></span> --warc-file=warc<span class="hljs-tag"><span class="hljs-tag">\</span></span>010001-020000 -i 010001-020000<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">articles</span></span></span></span>.urls -P 010001-020000 START ..<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">wget</span></span></span></span> --warc-file=warc<span class="hljs-tag"><span class="hljs-tag">\</span></span>020001-030000 -i 020001-030000<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">articles</span></span></span></span>.urls -P 020001-030000 ... START ..<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">wget</span></span></span></span> --warc-file=warc<span class="hljs-tag"><span class="hljs-tag">\</span></span>350001-360000 -i 350001-360000<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">articles</span></span></span></span>.urls -P 350001-360000 START ..<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">wget</span></span></span></span> --warc-file=warc<span class="hljs-tag"><span class="hljs-tag">\</span></span>360001-370000 -i 360001-370000<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">articles</span></span></span></span>.urls -P 360001-370000 START ..<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">wget</span></span></span></span> --warc-file=warc<span class="hljs-tag"><span class="hljs-tag">\</span></span>370001-379862 -i 370001-379862<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">articles</span></span></span></span>.urls -P 370001-379862</code> </pre> <br><p>  Launching the generated CMD file launches the expected 38 windows with the <code>wget</code> command and gives the following computer boot with the following characteristics <code>3.5GHz Xeon E-1240 v5, 32Gb, SSD, Windows Server 2012</code> </p><br><p><img src="https://habrastorage.org/webt/0k/c4/g5/0kc4g5ey-ut5hldh0iwznrc5i5g.jpeg" alt="Download computer at the time of simultaneous download pages"></p><br><p>  The total time is <code>180 </code> or <code>3 </code> .  The ‚Äúcrutch‚Äù parallelism yielded almost <code>10-</code> gain compared to single-threaded execution of <code>wget</code> and <code>30-</code> gain relative to the initial use <code>read_html {rvest}</code> .  It was the first small victory and I had to use a similar ‚Äúcrutch‚Äù approach several more times later. </p><br><p>  The result of the execution on the hard disk was as follows: </p><br><pre> <code class="hljs pgsql">&gt; indexFiles &lt;- list.files(downloadedArticlesFolder, <span class="hljs-keyword"><span class="hljs-keyword">full</span></span>.names = <span class="hljs-keyword"><span class="hljs-keyword">TRUE</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">recursive</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">TRUE</span></span>, pattern = "index") &gt; length(indexFiles) [<span class="hljs-number"><span class="hljs-number">1</span></span>] <span class="hljs-number"><span class="hljs-number">379703</span></span> &gt; sum(file.size(indexFiles))/<span class="hljs-number"><span class="hljs-number">1024</span></span>/<span class="hljs-number"><span class="hljs-number">1024</span></span> [<span class="hljs-number"><span class="hljs-number">1</span></span>] <span class="hljs-number"><span class="hljs-number">66713.61</span></span> &gt; warcFiles &lt;- list.files(downloadedArticlesFolder, <span class="hljs-keyword"><span class="hljs-keyword">full</span></span>.names = <span class="hljs-keyword"><span class="hljs-keyword">TRUE</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">recursive</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">TRUE</span></span>, pattern = "warc") &gt; length(warcFiles) [<span class="hljs-number"><span class="hljs-number">1</span></span>] <span class="hljs-number"><span class="hljs-number">38</span></span> &gt; sum(file.size(warcFiles))/<span class="hljs-number"><span class="hljs-number">1024</span></span>/<span class="hljs-number"><span class="hljs-number">1024</span></span> [<span class="hljs-number"><span class="hljs-number">1</span></span>] <span class="hljs-number"><span class="hljs-number">18770.4</span></span></code> </pre> <br><p>  Which means <code>379703</code> downloaded web pages with a total size of <code>66713.61MB</code> and <code>38</code> compressed <code>WARC</code> files with a total size of <code>18770.40MB</code> .  A simple calculation showed that I had ‚Äúlost‚Äù <code>159</code> pages.  Perhaps their fate can be learned by parsing the <code>WARC</code> files, following the example of <a href="https://rud.is/">Bob Rudis</a> , but I decided to write them off for error and go my own way, directly by <code>379703</code> files. </p><br><h3 id="parsing">  Parsing </h3><br><p>  Before pulling something from the downloaded page, I had to determine what exactly to pull out, what kind of information I might be interested in.  After a long study of the contents of the pages, prepared the following code: </p><br><pre> <code class="hljs mel"># Parse srecific <span class="hljs-keyword"><span class="hljs-keyword">file</span></span> # Parse srecific <span class="hljs-keyword"><span class="hljs-keyword">file</span></span> ReadFile &lt;- function(filename) { pg &lt;- read_html(filename, encoding = <span class="hljs-string"><span class="hljs-string">"UTF-8"</span></span>) # Extract Title, Type, Description metaTitle &lt;- html_nodes(pg, xpath=<span class="hljs-string"><span class="hljs-string">".//meta[@property='og:title']"</span></span>) %&gt;% html_attr(<span class="hljs-string"><span class="hljs-string">"content"</span></span>) %&gt;% SetNAIfZeroLength() metaType &lt;- html_nodes(pg, xpath=<span class="hljs-string"><span class="hljs-string">".//meta[@property='og:type']"</span></span>) %&gt;% html_attr(<span class="hljs-string"><span class="hljs-string">"content"</span></span>) %&gt;% SetNAIfZeroLength() metaDescription &lt;- html_nodes(pg, xpath=<span class="hljs-string"><span class="hljs-string">".//meta[@property='og:description']"</span></span>) %&gt;% html_attr(<span class="hljs-string"><span class="hljs-string">"content"</span></span>) %&gt;% SetNAIfZeroLength() # Extract script contect that contains rubric and subrubric data scriptContent &lt;- html_nodes(pg, xpath=<span class="hljs-string"><span class="hljs-string">".//script[contains(text(),'chapters: [')]"</span></span>) %&gt;% html_text() %&gt;% strsplit(<span class="hljs-string"><span class="hljs-string">"\n"</span></span>) %&gt;% unlist() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (is.null(scriptContent[<span class="hljs-number"><span class="hljs-number">1</span></span>])) { chapters &lt;- NA } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (is.na(scriptContent[<span class="hljs-number"><span class="hljs-number">1</span></span>])) { chapters &lt;- NA } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { chapters &lt;- scriptContent[grep(<span class="hljs-string"><span class="hljs-string">"chapters: "</span></span>, scriptContent)] %&gt;% unique() } articleBodyNode &lt;- html_nodes(pg, xpath=<span class="hljs-string"><span class="hljs-string">".//div[@itemprop='articleBody']"</span></span>) # Extract articles body plaintext &lt;- html_nodes(articleBodyNode, xpath=<span class="hljs-string"><span class="hljs-string">".//p"</span></span>) %&gt;% html_text() %&gt;% paste0(collapse=<span class="hljs-string"><span class="hljs-string">""</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (plaintext == <span class="hljs-string"><span class="hljs-string">""</span></span>) { plaintext &lt;- NA } # Extract links from articles body plaintextLinks &lt;- html_nodes(articleBodyNode, xpath=<span class="hljs-string"><span class="hljs-string">".//a"</span></span>) %&gt;% html_attr(<span class="hljs-string"><span class="hljs-string">"href"</span></span>) %&gt;% unique() %&gt;% paste0(collapse=<span class="hljs-string"><span class="hljs-string">" "</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (plaintextLinks == <span class="hljs-string"><span class="hljs-string">""</span></span>) { plaintextLinks &lt;- NA } # Extract links related to articles additionalLinks &lt;- html_nodes(pg, xpath=<span class="hljs-string"><span class="hljs-string">".//section/div[@class='item']/div/..//a"</span></span>) %&gt;% html_attr(<span class="hljs-string"><span class="hljs-string">"href"</span></span>) %&gt;% unique() %&gt;% paste0(collapse=<span class="hljs-string"><span class="hljs-string">" "</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (additionalLinks == <span class="hljs-string"><span class="hljs-string">""</span></span>) { additionalLinks &lt;- NA } # Extract <span class="hljs-keyword"><span class="hljs-keyword">image</span></span> Description and Credits imageNodes &lt;- html_nodes(pg, xpath=<span class="hljs-string"><span class="hljs-string">".//div[@class='b-topic__title-image']"</span></span>) imageDescription &lt;- html_nodes(imageNodes, xpath=<span class="hljs-string"><span class="hljs-string">"div//div[@class='b-label__caption']"</span></span>) %&gt;% html_text() %&gt;% unique() %&gt;% SetNAIfZeroLength() imageCredits &lt;- html_nodes(imageNodes, xpath=<span class="hljs-string"><span class="hljs-string">"div//div[@class='b-label__credits']"</span></span>) %&gt;% html_text() %&gt;% unique() %&gt;% SetNAIfZeroLength() # Extract video Description and Credits <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (is.na(imageDescription)&amp;is.na(imageCredits)) { videoNodes &lt;- html_nodes(pg, xpath=<span class="hljs-string"><span class="hljs-string">".//div[@class='b-video-box__info']"</span></span>) videoDescription &lt;- html_nodes(videoNodes, xpath=<span class="hljs-string"><span class="hljs-string">"div[@class='b-video-box__caption']"</span></span>) %&gt;% html_text() %&gt;% unique() %&gt;% SetNAIfZeroLength() videoCredits &lt;- html_nodes(videoNodes, xpath=<span class="hljs-string"><span class="hljs-string">"div[@class='b-video-box__credits']"</span></span>) %&gt;% html_text() %&gt;% unique() %&gt;% SetNAIfZeroLength() } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { videoDescription &lt;- NA videoCredits &lt;- NA } # Extract articles url url &lt;- html_nodes(pg, xpath=<span class="hljs-string"><span class="hljs-string">".//head/link[@rel='canonical']"</span></span>) %&gt;% html_attr(<span class="hljs-string"><span class="hljs-string">"href"</span></span>) %&gt;% SetNAIfZeroLength() # Extract authors authorSection &lt;- html_nodes(pg, xpath=<span class="hljs-string"><span class="hljs-string">".//p[@class='b-topic__content__author']"</span></span>) authors &lt;- html_nodes(authorSection, xpath=<span class="hljs-string"><span class="hljs-string">"//span[@class='name']"</span></span>) %&gt;% html_text() %&gt;% SetNAIfZeroLength() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (length(authors) &gt; <span class="hljs-number"><span class="hljs-number">1</span></span>) { authors &lt;- paste0(authors, collapse = <span class="hljs-string"><span class="hljs-string">"|"</span></span>) } authorLinks &lt;- html_nodes(authorSection, xpath=<span class="hljs-string"><span class="hljs-string">"a"</span></span>) %&gt;% html_attr(<span class="hljs-string"><span class="hljs-string">"href"</span></span>) %&gt;% SetNAIfZeroLength() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (length(authorLinks) &gt; <span class="hljs-number"><span class="hljs-number">1</span></span>) { authorLinks &lt;- paste0(authorLinks, collapse = <span class="hljs-string"><span class="hljs-string">"|"</span></span>) } # Extract publish <span class="hljs-keyword"><span class="hljs-keyword">date</span></span> and time datetimeString &lt;- html_nodes(pg, xpath=<span class="hljs-string"><span class="hljs-string">".//div[@class='b-topic__info']/time[@class='g-date']"</span></span>) %&gt;% html_text() %&gt;% unique() %&gt;% SetNAIfZeroLength() datetime &lt;- html_nodes(pg, xpath=<span class="hljs-string"><span class="hljs-string">".//div[@class='b-topic__info']/time[@class='g-date']"</span></span>) %&gt;% html_attr(<span class="hljs-string"><span class="hljs-string">"datetime"</span></span>) %&gt;% unique() %&gt;% SetNAIfZeroLength() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (is.na(datetimeString)) { datetimeString &lt;- html_nodes(pg, xpath=<span class="hljs-string"><span class="hljs-string">".//div[@class='b-topic__date']"</span></span>) %&gt;% html_text() %&gt;% unique() %&gt;% SetNAIfZeroLength() } data.frame(url = url, filename = filename, metaTitle= metaTitle, metaType= metaType, metaDescription= metaDescription, chapters = chapters, datetime = datetime, datetimeString = datetimeString, plaintext = plaintext, authors = authors, authorLinks = authorLinks, plaintextLinks = plaintextLinks, additionalLinks = additionalLinks, imageDescription = imageDescription, imageCredits = imageCredits, videoDescription = videoDescription, videoCredits = videoCredits, stringsAsFactors=FALSE) }</code> </pre> <br><p>  To start the title.  Initially, I received from the <code>title</code> something like <code>      : : : Lenta.ru</code> , hoping to split the title into a direct title and into a rubric with a subheading.  However, then I decided to tighten up the title in pure form from the page metadata under the safety net. </p><br><p>  The date and time I get from <code>&lt;time class="g-date" datetime="2017-07-10T12:35:00Z" itemprop="datePublished" pubdate=""&gt; 15:35, 10  2017&lt;/time&gt;</code> , and I decided to get for safety not only <code>2017-07-10T12:35:00Z</code> , but also the text presentation <code>15:35, 10  2017</code> and as it turned out not in vain.  This textual representation allowed to get article time for cases when <code>time[@class='g-date']</code> for some reason was missing on the page. </p><br><p>  Authorship in the articles is extremely rare, but I still decided to pull this information, just in case.  Also, it seemed to me interesting links that appeared in the texts of the articles themselves and under them in the section "Related Links".  I spent a little more time than I would like to correctly parse information about pictures and videos at the beginning of the article, but also just in case. </p><br><p>  To get the heading and subheadings (I originally wanted to pull it out of the headline) I decided to play it safe and save the line <code>chapters: ["","","lenta.ru:_:_:_______"], // Chapters </code> and she pull out the "World" and "Society" will be slightly easier than from the title. </p><br><p>  Of particular interest to me was the number of shareings, the number of comments on the article, and of course the comments themselves (dictionary content, temporary activity), since that was the only information about how readers reacted to the article.  But it was the most interesting thing that didn‚Äôt work for me.  Counters of the number of ball and cam are set by a script that executes after the page loads.  And all my super-tricky code was pumping the page up to this point, leaving the corresponding fields empty.  Comments are also loaded by the script, in addition, they are disabled for articles after some time and it is not possible to get them.  But I still work on this issue, since I still want to see the dependence of the presence of the words Ukraine / Putin / Candolysis and the number of sracha in the kammenta. </p><br><blockquote>  In fact, thanks to the help of the former colleague, I did manage to get to this information, but this will be discussed below. </blockquote><p>  That's basically all the information that I found useful. </p><br><p>  The following code allowed me to start the parsing of files located in the first folder (out of 38): </p><br><pre> <code class="hljs pgsql">folderNumber &lt;- <span class="hljs-number"><span class="hljs-number">1</span></span> # <span class="hljs-keyword"><span class="hljs-keyword">Read</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> parse files <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> folder <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> provided number ReadFilesInFolder &lt;- <span class="hljs-keyword"><span class="hljs-keyword">function</span></span>(folderNumber) { <span class="hljs-type"><span class="hljs-type">timestamp</span></span>() # <span class="hljs-keyword"><span class="hljs-keyword">Get</span></span> <span class="hljs-type"><span class="hljs-type">name</span></span> <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> folder that have <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> be parsed folders &lt;- list.files(downloadedArticlesFolder, <span class="hljs-keyword"><span class="hljs-keyword">full</span></span>.names = <span class="hljs-keyword"><span class="hljs-keyword">FALSE</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">recursive</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">FALSE</span></span>, pattern = "-") folderName &lt;- folders[folderNumber] currentFolder &lt;- file.path(downloadedArticlesFolder, folderName) files &lt;- list.files(currentFolder, <span class="hljs-keyword"><span class="hljs-keyword">full</span></span>.names = <span class="hljs-keyword"><span class="hljs-keyword">TRUE</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">recursive</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">FALSE</span></span>, pattern = "index") # Split files <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> folder <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-number"><span class="hljs-number">1000</span></span> chunks <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> parse them <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> ReadFile numberOfFiles &lt;- length(files) print(numberOfFiles) groupSize &lt;- <span class="hljs-number"><span class="hljs-number">1000</span></span> filesGroup &lt;- seq(<span class="hljs-keyword"><span class="hljs-keyword">from</span></span> = <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> = numberOfFiles, <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> = groupSize) dfList &lt;- list() <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>:length(filesGroup)) { firstFileInGroup &lt;- filesGroup[i] lastFileInGroup &lt;- min(firstFileInGroup + groupSize - <span class="hljs-number"><span class="hljs-number">1</span></span>, numberOfFiles) print(paste0(firstFileInGroup, "-", lastFileInGroup)) dfList[[i]] &lt;- map_df(files[firstFileInGroup:lastFileInGroup], ReadFile) } # combine <span class="hljs-keyword"><span class="hljs-keyword">rows</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> data frame <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-keyword"><span class="hljs-keyword">write</span></span> down df &lt;- bind_rows(dfList) <span class="hljs-keyword"><span class="hljs-keyword">write</span></span>.csv(df, file.path(parsedArticlesFolder, paste0(folderName, ".csv")), fileEncoding = "UTF-8") }</code> </pre> <br><p>  Having received the address of a folder of the type <code>00001-10000</code> and its contents, I broke the array of files into blocks of <code>1000</code> and in a cycle using <code>map_df</code> started my <code>ReadFile</code> function for each such block. </p><br><p>  The measurements showed that it took about <code>8 </code> to process <code>10000</code> articles (and the <code>read_html</code> method was <code>95%</code> time).  All the same extrapolation received <code>300 </code> or <code>5 </code> . </p><br><p>  And here is the promised second move of the knight.  Running a truly parallel sessions R (good experience with CMD already had).  Therefore, using this script, I got the required CMD file: </p><br><pre> <code class="hljs pgsql">## STEP <span class="hljs-number"><span class="hljs-number">3.</span></span> Parse downloaded articles # <span class="hljs-keyword"><span class="hljs-keyword">Create</span></span> CMD file <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> parallel articles parsing. # Parsing process takes about <span class="hljs-number"><span class="hljs-number">1</span></span> hour. Expect about <span class="hljs-number"><span class="hljs-number">1.7</span></span>Gb <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> parsed files CreateCMDForParsing &lt;- <span class="hljs-keyword"><span class="hljs-keyword">function</span></span>() { <span class="hljs-type"><span class="hljs-type">timestamp</span></span>() # <span class="hljs-keyword"><span class="hljs-keyword">Get</span></span> list <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> folders that contain downloaded articles folders &lt;- list.files(downloadedArticlesFolder, <span class="hljs-keyword"><span class="hljs-keyword">full</span></span>.names = <span class="hljs-keyword"><span class="hljs-keyword">FALSE</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">recursive</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">FALSE</span></span>, pattern = "-") # <span class="hljs-keyword"><span class="hljs-keyword">Create</span></span> CMD contains commands <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> run parse.R script <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> specified folder number nn &lt;- <span class="hljs-number"><span class="hljs-number">1</span></span>:length(folders) cmdCodeAll &lt;- paste0("start C:/R/R-3.4.0/bin/Rscript.exe ", file.path(getwd(), "parse.R "), nn) cmdFile &lt;- file.path(downloadedArticlesFolder, "parsing.cmd") writeLines(cmdCodeAll, cmdFile) print(paste0("Run ", cmdFile, " to start parsing.")) <span class="hljs-type"><span class="hljs-type">timestamp</span></span>() }</code> </pre> <br><p>  View: </p><br><pre> <code class="hljs sql"><span class="hljs-keyword"><span class="hljs-keyword">start</span></span> C:/R/R<span class="hljs-number"><span class="hljs-number">-3.4</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-keyword"><span class="hljs-keyword">bin</span></span>/Rscript.exe C:/<span class="hljs-keyword"><span class="hljs-keyword">Users</span></span>/ildar/lenta/parse.R <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">start</span></span> C:/R/R<span class="hljs-number"><span class="hljs-number">-3.4</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-keyword"><span class="hljs-keyword">bin</span></span>/Rscript.exe C:/<span class="hljs-keyword"><span class="hljs-keyword">Users</span></span>/ildar/lenta/parse.R <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">start</span></span> C:/R/R<span class="hljs-number"><span class="hljs-number">-3.4</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-keyword"><span class="hljs-keyword">bin</span></span>/Rscript.exe C:/<span class="hljs-keyword"><span class="hljs-keyword">Users</span></span>/ildar/lenta/parse.R <span class="hljs-number"><span class="hljs-number">3</span></span> ... <span class="hljs-keyword"><span class="hljs-keyword">start</span></span> C:/R/R<span class="hljs-number"><span class="hljs-number">-3.4</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-keyword"><span class="hljs-keyword">bin</span></span>/Rscript.exe C:/<span class="hljs-keyword"><span class="hljs-keyword">Users</span></span>/ildar/lenta/parse.R <span class="hljs-number"><span class="hljs-number">36</span></span> <span class="hljs-keyword"><span class="hljs-keyword">start</span></span> C:/R/R<span class="hljs-number"><span class="hljs-number">-3.4</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-keyword"><span class="hljs-keyword">bin</span></span>/Rscript.exe C:/<span class="hljs-keyword"><span class="hljs-keyword">Users</span></span>/ildar/lenta/parse.R <span class="hljs-number"><span class="hljs-number">37</span></span> <span class="hljs-keyword"><span class="hljs-keyword">start</span></span> C:/R/R<span class="hljs-number"><span class="hljs-number">-3.4</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-keyword"><span class="hljs-keyword">bin</span></span>/Rscript.exe C:/<span class="hljs-keyword"><span class="hljs-keyword">Users</span></span>/ildar/lenta/parse.R <span class="hljs-number"><span class="hljs-number">38</span></span></code> </pre> <br><p>  Which in turn launched 38 scripts for execution: </p><br><pre> <code class="hljs pgsql">args &lt;- commandArgs(<span class="hljs-keyword"><span class="hljs-keyword">TRUE</span></span>) n &lt;- <span class="hljs-keyword"><span class="hljs-keyword">as</span></span>.integer(args[<span class="hljs-number"><span class="hljs-number">1</span></span>]) # <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> workling directory <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> locale <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> macOS <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> Windows <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Sys.<span class="hljs-keyword"><span class="hljs-keyword">info</span></span>()[<span class="hljs-string"><span class="hljs-string">'sysname'</span></span>] == "Windows") { workingDirectory &lt;- paste0(Sys.getenv("HOMEPATH"), "\\lenta") Sys.setlocale("LC_ALL", "Russian") } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { workingDirectory &lt;- ("~/lenta") Sys.setlocale("LC_ALL", "ru_RU.UTF-8") } setwd(workingDirectory) source("get_lenta_articles_list.R") ReadFilesInFolder(n)</code> </pre> <br><p><img src="https://habrastorage.org/webt/hg/kx/ob/hgkxob2mjvbxvgui3yvf9drlk4e.jpeg" alt="Loading a computer while simultaneously parsing pages"></p><br><p>  Such parallelization allowed us to load the server <code>100%</code> and complete the task in <code>30 </code> .  Another <code>10-</code> win. </p><br><p>  It remains only to execute a script that will merge 38 files just created: </p><br><pre> <code class="hljs pgsql">## STEP <span class="hljs-number"><span class="hljs-number">4.</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Prepare</span></span> combined articles data # <span class="hljs-keyword"><span class="hljs-keyword">Read</span></span> <span class="hljs-keyword"><span class="hljs-keyword">all</span></span> parsed csv <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> combine them <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> one. # Expect about <span class="hljs-number"><span class="hljs-number">1.7</span></span>Gb <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> combined file UnionData &lt;- <span class="hljs-keyword"><span class="hljs-keyword">function</span></span>() { <span class="hljs-type"><span class="hljs-type">timestamp</span></span>() files &lt;- list.files(parsedArticlesFolder, <span class="hljs-keyword"><span class="hljs-keyword">full</span></span>.names = <span class="hljs-keyword"><span class="hljs-keyword">TRUE</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">recursive</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">FALSE</span></span>) dfList &lt;- c() <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>:length(files)) { file &lt;- files[i] print(file) dfList[[i]] &lt;- <span class="hljs-keyword"><span class="hljs-keyword">read</span></span>.csv(file, stringsAsFactors = <span class="hljs-keyword"><span class="hljs-keyword">FALSE</span></span>, encoding = "UTF-8") } df &lt;- bind_rows(dfList) <span class="hljs-keyword"><span class="hljs-keyword">write</span></span>.csv(df, file.path(parsedArticlesFolder, "untidy_articles_data.csv"), fileEncoding = "UTF-8") <span class="hljs-type"><span class="hljs-type">timestamp</span></span>() }</code> </pre> <br><p>  And in the end, we have on the <code>1.739MB</code> disk a crude and unreduced date: </p><br><pre> <code class="hljs mel">&gt; <span class="hljs-keyword"><span class="hljs-keyword">file</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">size</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">file</span></span>.path(parsedArticlesFolder, <span class="hljs-string"><span class="hljs-string">"untidy_articles_data.csv"</span></span>))/<span class="hljs-number"><span class="hljs-number">1024</span></span>/<span class="hljs-number"><span class="hljs-number">1024</span></span> [<span class="hljs-number"><span class="hljs-number">1</span></span>] <span class="hljs-number"><span class="hljs-number">1739.047</span></span></code> </pre> <br><p>  What is inside? </p><br><pre> <code class="hljs perl">&gt; str(dfM, vec.len = <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-string"><span class="hljs-string">'data.frame'</span></span>: <span class="hljs-number"><span class="hljs-number">379746</span></span> obs. of <span class="hljs-number"><span class="hljs-number">21</span></span> variables: $ X.<span class="hljs-number"><span class="hljs-number">1</span></span> : <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> ... $ X : <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> ... $ url : <span class="hljs-keyword"><span class="hljs-keyword">chr</span></span> <span class="hljs-string"><span class="hljs-string">"https://lenta.ru/news/2009/12/31/kids/"</span></span> ... $ filename : <span class="hljs-keyword"><span class="hljs-keyword">chr</span></span> <span class="hljs-string"><span class="hljs-string">"C:/Users/ildar/lenta/downloaded_articles/000001-010000/index.html"</span></span> ... $ metaTitle : <span class="hljs-keyword"><span class="hljs-keyword">chr</span></span> <span class="hljs-string"><span class="hljs-string">"      "</span></span> ... $ metaType : <span class="hljs-keyword"><span class="hljs-keyword">chr</span></span> <span class="hljs-string"><span class="hljs-string">"article"</span></span> ... $ metaDescription : <span class="hljs-keyword"><span class="hljs-keyword">chr</span></span> <span class="hljs-string"><span class="hljs-string">"           .   "</span></span>| __truncated_<span class="hljs-number"><span class="hljs-number">_</span></span> ... $ rubric : logi NA ... $ chapters : <span class="hljs-keyword"><span class="hljs-keyword">chr</span></span> <span class="hljs-string"><span class="hljs-string">" chapters: [\"\",\"_\",\"lenta.ru:_:_____"</span></span>| __truncated_<span class="hljs-number"><span class="hljs-number">_</span></span> ... $ datetime : <span class="hljs-keyword"><span class="hljs-keyword">chr</span></span> <span class="hljs-string"><span class="hljs-string">"2009-12-31T21:24:33Z"</span></span> ... $ datetimeString : <span class="hljs-keyword"><span class="hljs-keyword">chr</span></span> <span class="hljs-string"><span class="hljs-string">" 00:24, 1  2010"</span></span> ... $ title : <span class="hljs-keyword"><span class="hljs-keyword">chr</span></span> <span class="hljs-string"><span class="hljs-string">"      : : Lenta.ru"</span></span> ... $ plaintext : <span class="hljs-keyword"><span class="hljs-keyword">chr</span></span> <span class="hljs-string"><span class="hljs-string">"           .   "</span></span>| __truncated_<span class="hljs-number"><span class="hljs-number">_</span></span> ... $ authors : <span class="hljs-keyword"><span class="hljs-keyword">chr</span></span> NA ... $ authorLinks : <span class="hljs-keyword"><span class="hljs-keyword">chr</span></span> NA ... $ plaintextLinks : <span class="hljs-keyword"><span class="hljs-keyword">chr</span></span> <span class="hljs-string"><span class="hljs-string">"http://www.interfax.ru/"</span></span> ... $ additionalLinks : <span class="hljs-keyword"><span class="hljs-keyword">chr</span></span> <span class="hljs-string"><span class="hljs-string">"https://lenta.ru/news/2009/12/29/golovan/ https://lenta.ru/news/2009/09/01/children/"</span></span> ... $ imageDescription: <span class="hljs-keyword"><span class="hljs-keyword">chr</span></span> NA ... $ imageCredits : <span class="hljs-keyword"><span class="hljs-keyword">chr</span></span> NA ... $ videoDescription: <span class="hljs-keyword"><span class="hljs-keyword">chr</span></span> NA ... $ videoCredits : <span class="hljs-keyword"><span class="hljs-keyword">chr</span></span> NA ...</code> </pre> <br><p>  .      ,   .          . </p><br><h3 id="social-media"> SOCIAL MEDIA </h3><br><p>   ,            (       ).   , -        ,       .  ,        Google Chrome        Network  : </p><br><pre> <code class="hljs perl">https:<span class="hljs-regexp"><span class="hljs-regexp">//graph</span></span>.facebook.com/?id=https%3A%2F%2Flenta.ru%2Fnews%2F2017%2F08%2F10%2Fudostov%2F</code> </pre> <br><p>      : </p><br><pre> <code class="hljs json">{ <span class="hljs-attr"><span class="hljs-attr">"share"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"comment_count"</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-attr"><span class="hljs-attr">"share_count"</span></span>: <span class="hljs-number"><span class="hljs-number">243</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"og_object"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"id"</span></span>: <span class="hljs-string"><span class="hljs-string">"1959067174107041"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"description"</span></span>: ..., <span class="hljs-attr"><span class="hljs-attr">"title"</span></span>: ..., <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"article"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"updated_time"</span></span>: <span class="hljs-string"><span class="hljs-string">"2017-08-10T09:21:29+0000"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"id"</span></span>: <span class="hljs-string"><span class="hljs-string">"https://lenta.ru/news/2017/08/10/udostov/"</span></span> }</code> </pre> <br><p>       ,   ,          (       ).  ,         .      <code>   4</code> ,        "". </p><br><p> ,   4 CMD ,         : </p><br><pre> <code class="hljs pgsql">## STEP <span class="hljs-number"><span class="hljs-number">5.</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Prepare</span></span> wget CMD files <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> parallel downloading social # <span class="hljs-keyword"><span class="hljs-keyword">Create</span></span> CMD file. CreateWgetCMDFilesForSocial &lt;- <span class="hljs-keyword"><span class="hljs-keyword">function</span></span>() { <span class="hljs-type"><span class="hljs-type">timestamp</span></span>() articlesLinks &lt;- readLines(file.path(tempDataFolder, "articles.urls")) dir.<span class="hljs-keyword"><span class="hljs-keyword">create</span></span>(warcFolder, showWarnings = <span class="hljs-keyword"><span class="hljs-keyword">FALSE</span></span>) dir.<span class="hljs-keyword"><span class="hljs-keyword">create</span></span>(warcFolderForFB, showWarnings = <span class="hljs-keyword"><span class="hljs-keyword">FALSE</span></span>) dir.<span class="hljs-keyword"><span class="hljs-keyword">create</span></span>(warcFolderForVK, showWarnings = <span class="hljs-keyword"><span class="hljs-keyword">FALSE</span></span>) dir.<span class="hljs-keyword"><span class="hljs-keyword">create</span></span>(warcFolderForOK, showWarnings = <span class="hljs-keyword"><span class="hljs-keyword">FALSE</span></span>) dir.<span class="hljs-keyword"><span class="hljs-keyword">create</span></span>(warcFolderForCom, showWarnings = <span class="hljs-keyword"><span class="hljs-keyword">FALSE</span></span>) # split up articles links <span class="hljs-keyword"><span class="hljs-keyword">array</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span>K links numberOfLinks &lt;- length(articlesLinks) digitNumber &lt;- <span class="hljs-type"><span class="hljs-type">nchar</span></span>(numberOfLinks) groupSize &lt;- <span class="hljs-number"><span class="hljs-number">10000</span></span> filesGroup &lt;- seq(<span class="hljs-keyword"><span class="hljs-keyword">from</span></span> = <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> = numberOfLinks, <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> = groupSize) cmdCodeAll &lt;- c() cmdCodeAllFB &lt;- c() cmdCodeAllVK &lt;- c() cmdCodeAllOK &lt;- c() cmdCodeAllCom &lt;- c() <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>:length(filesGroup)) { # <span class="hljs-keyword"><span class="hljs-keyword">Prepare</span></span> folder <span class="hljs-type"><span class="hljs-type">name</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-number"><span class="hljs-number">00001</span></span><span class="hljs-number"><span class="hljs-number">-10000</span></span>, <span class="hljs-number"><span class="hljs-number">10001</span></span><span class="hljs-number"><span class="hljs-number">-20000</span></span> etc firstFileInGroup &lt;- filesGroup[i] lastFileInGroup &lt;- min(firstFileInGroup + groupSize - <span class="hljs-number"><span class="hljs-number">1</span></span>, numberOfLinks) leftPartFolderName &lt;- formatC(firstFileInGroup, width = digitNumber, <span class="hljs-keyword"><span class="hljs-keyword">format</span></span> = "d", flag = "0") rigthPartFolderName &lt;- formatC(lastFileInGroup, width = digitNumber, <span class="hljs-keyword"><span class="hljs-keyword">format</span></span> = "d", flag = "0") subFolderName &lt;- paste0(leftPartFolderName, "-", rigthPartFolderName) subFolderPathFB &lt;- file.path(downloadedArticlesFolderForFB, subFolderName) dir.<span class="hljs-keyword"><span class="hljs-keyword">create</span></span>(subFolderPathFB) subFolderPathVK &lt;- file.path(downloadedArticlesFolderForVK, subFolderName) dir.<span class="hljs-keyword"><span class="hljs-keyword">create</span></span>(subFolderPathVK) subFolderPathOK &lt;- file.path(downloadedArticlesFolderForOK, subFolderName) dir.<span class="hljs-keyword"><span class="hljs-keyword">create</span></span>(subFolderPathOK) subFolderPathCom &lt;- file.path(downloadedArticlesFolderForCom, subFolderName) dir.<span class="hljs-keyword"><span class="hljs-keyword">create</span></span>(subFolderPathCom) # Encode <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-keyword"><span class="hljs-keyword">write</span></span> down articles.urls <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">each</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span>K folders that contains # <span class="hljs-number"><span class="hljs-number">10</span></span>K articles urls. # <span class="hljs-keyword"><span class="hljs-keyword">For</span></span> FB it has <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> be done <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> a <span class="hljs-type"><span class="hljs-type">bit</span></span> different way because FB allows <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> pass # up <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-number"><span class="hljs-number">50</span></span> links <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> a request parameter. articlesLinksFB &lt;- articlesLinks[firstFileInGroup:lastFileInGroup] numberOfLinksFB &lt;- length(articlesLinksFB) digitNumberFB &lt;- <span class="hljs-type"><span class="hljs-type">nchar</span></span>(numberOfLinksFB) groupSizeFB &lt;- <span class="hljs-number"><span class="hljs-number">50</span></span> filesGroupFB &lt;- seq(<span class="hljs-keyword"><span class="hljs-keyword">from</span></span> = <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> = numberOfLinksFB, <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> = groupSizeFB) articlesLinksFBEncoded &lt;- c() <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (k <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>:length(filesGroupFB )) { firstFileInGroupFB &lt;- filesGroupFB[k] lastFileInGroupFB &lt;- min(firstFileInGroupFB + groupSizeFB - <span class="hljs-number"><span class="hljs-number">1</span></span>, numberOfLinksFB) articlesLinksFBGroup &lt;- paste0(articlesLinksFB[firstFileInGroupFB:lastFileInGroupFB], collapse = ",") articlesLinksFBGroup &lt;- URLencode(articlesLinksFBGroup , reserved = <span class="hljs-keyword"><span class="hljs-keyword">TRUE</span></span>) articlesLinksFBGroup &lt;- paste0("https://graph.facebook.com/?fields=engagement&amp;access_token=PlaceYourTokenHere&amp;ids=", articlesLinksFBGroup) articlesLinksFBEncoded &lt;- c(articlesLinksFBEncoded, articlesLinksFBGroup) } articlesLinksVK &lt;- paste0("https://vk.com/share.php?act=count&amp;index=1&amp;url=", sapply(articlesLinks[firstFileInGroup:lastFileInGroup], URLencode, reserved = <span class="hljs-keyword"><span class="hljs-keyword">TRUE</span></span>), "&amp;format=json") articlesLinksOK &lt;- paste0("https://connect.ok.ru/dk?st.cmd=extLike&amp;uid=okLenta&amp;ref=", sapply(articlesLinks[firstFileInGroup:lastFileInGroup], URLencode, reserved = <span class="hljs-keyword"><span class="hljs-keyword">TRUE</span></span>), "") articlesLinksCom &lt;- paste0("https://c.rambler.ru/api/app/126/comments-count?xid=", sapply(articlesLinks[firstFileInGroup:lastFileInGroup], URLencode, reserved = <span class="hljs-keyword"><span class="hljs-keyword">TRUE</span></span>), "") writeLines(articlesLinksFBEncoded, file.path(subFolderPathFB, "articles.urls")) writeLines(articlesLinksVK, file.path(subFolderPathVK, "articles.urls")) writeLines(articlesLinksOK, file.path(subFolderPathOK, "articles.urls")) writeLines(articlesLinksCom, file.path(subFolderPathCom, "articles.urls")) # <span class="hljs-keyword"><span class="hljs-keyword">Add</span></span> command <span class="hljs-type"><span class="hljs-type">line</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> CMD file cmdCode &lt;-paste0("START ..\\..\\wget --warc-file=warc\\", subFolderName," -i ", subFolderName, "\\", "articles.urls -P ", subFolderName, " --output-document=", subFolderName, "\\", "index") cmdCodeAll &lt;- c(cmdCodeAll, cmdCode) } cmdFile &lt;- file.path(downloadedArticlesFolderForFB, "start.cmd") print(paste0("Run ", cmdFile, " to start downloading.")) writeLines(cmdCodeAll, cmdFile) cmdFile &lt;- file.path(downloadedArticlesFolderForVK, "start.cmd") writeLines(cmdCodeAll, cmdFile) print(paste0("Run ", cmdFile, " to start downloading.")) cmdFile &lt;- file.path(downloadedArticlesFolderForOK, "start.cmd") writeLines(cmdCodeAll, cmdFile) print(paste0("Run ", cmdFile, " to start downloading.")) cmdFile &lt;- file.path(downloadedArticlesFolderForCom, "start.cmd") writeLines(cmdCodeAll, cmdFile) print(paste0("Run ", cmdFile, " to start downloading.")) print("wget.exe should be placed in working directory.") <span class="hljs-type"><span class="hljs-type">timestamp</span></span>() }</code> </pre> <br><p>     ,       10,     (   ),    .        ,     WARC ,   .     ,       100   .   ,     ,   ,         .        50     ,         . </p><br><p>      : </p><br><pre> <code class="hljs pgsql">## Parse downloaded articles social ReadSocial &lt;- <span class="hljs-keyword"><span class="hljs-keyword">function</span></span>() { <span class="hljs-type"><span class="hljs-type">timestamp</span></span>() # <span class="hljs-keyword"><span class="hljs-keyword">Read</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> parse <span class="hljs-keyword"><span class="hljs-keyword">all</span></span> warc files <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> FB folder dfList &lt;- list() dfN &lt;- <span class="hljs-number"><span class="hljs-number">0</span></span> warcs &lt;- list.files(file.path(downloadedArticlesFolderForFB, "warc"), <span class="hljs-keyword"><span class="hljs-keyword">full</span></span>.names = <span class="hljs-keyword"><span class="hljs-keyword">TRUE</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">recursive</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">FALSE</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>:length(warcs)) { filename &lt;- warcs[i] print(filename) res &lt;- readLines(filename, warn = <span class="hljs-keyword"><span class="hljs-keyword">FALSE</span></span>, encoding = "UTF-8") anchorPositions &lt;- which(res == "WARC-Type: response") responsesJSON &lt;- res[anchorPositions + <span class="hljs-number"><span class="hljs-number">28</span></span>] getID &lt;- <span class="hljs-keyword"><span class="hljs-keyword">function</span></span>(responses) { links &lt;- sapply(responses, <span class="hljs-keyword"><span class="hljs-keyword">function</span></span>(x){x$id}, USE.NAMES = <span class="hljs-keyword"><span class="hljs-keyword">FALSE</span></span>) %&gt;% unname() links} getQuantity &lt;- <span class="hljs-keyword"><span class="hljs-keyword">function</span></span>(responses) { links &lt;- sapply(responses, <span class="hljs-keyword"><span class="hljs-keyword">function</span></span>(x){x$engagement$<span class="lua"><span class="lua">share_count}, USE.NAMES = FALSE) %&gt;% unname() links} </span><span class="hljs-keyword"><span class="lua"><span class="hljs-keyword">for</span></span></span><span class="lua">(k </span><span class="hljs-keyword"><span class="lua"><span class="hljs-keyword">in</span></span></span><span class="lua"> </span><span class="hljs-number"><span class="lua"><span class="hljs-number">1</span></span></span><span class="lua">:length(responsesJSON)) { </span><span class="hljs-keyword"><span class="lua"><span class="hljs-keyword">if</span></span></span><span class="lua">(responsesJSON[k]==</span><span class="hljs-string"><span class="lua"><span class="hljs-string">""</span></span></span><span class="lua">){ </span><span class="hljs-built_in"><span class="lua"><span class="hljs-built_in">next</span></span></span><span class="lua"> } responses &lt;- fromJSON(responsesJSON[k]) </span><span class="hljs-keyword"><span class="lua"><span class="hljs-keyword">if</span></span></span><span class="lua">(!is.null(responses$</span><span class="hljs-built_in"><span class="lua"><span class="hljs-built_in">error</span></span></span><span class="lua">)) { </span><span class="hljs-built_in"><span class="lua"><span class="hljs-built_in">next</span></span></span><span class="lua"> } links &lt;- sapply(responses, </span><span class="hljs-function"><span class="hljs-keyword"><span class="lua"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span></span><span class="hljs-params"><span class="lua"><span class="hljs-function"><span class="hljs-params">(x)</span></span></span></span></span><span class="lua">{x$id}, USE.NAMES = FALSE) %&gt;% unname() %&gt;% unlist() quantities &lt;- sapply(responses, </span><span class="hljs-function"><span class="hljs-keyword"><span class="lua"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span></span><span class="hljs-params"><span class="lua"><span class="hljs-function"><span class="hljs-params">(x)</span></span></span></span></span><span class="lua">{x$engagement$</span></span>share_count}, USE.NAMES = <span class="hljs-keyword"><span class="hljs-keyword">FALSE</span></span>) %&gt;% unname() %&gt;% unlist() df &lt;- data.frame(link = links, quantity = quantities, social = "FB", stringsAsFactors = <span class="hljs-keyword"><span class="hljs-keyword">FALSE</span></span>) dfN &lt;- dfN + <span class="hljs-number"><span class="hljs-number">1</span></span> dfList[[dfN]] &lt;- df } } dfFB &lt;- bind_rows(dfList) # <span class="hljs-keyword"><span class="hljs-keyword">Read</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> parse <span class="hljs-keyword"><span class="hljs-keyword">all</span></span> warc files <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> VK folder dfList &lt;- list() dfN &lt;- <span class="hljs-number"><span class="hljs-number">0</span></span> warcs &lt;- list.files(file.path(downloadedArticlesFolderForVK, "warc"), <span class="hljs-keyword"><span class="hljs-keyword">full</span></span>.names = <span class="hljs-keyword"><span class="hljs-keyword">TRUE</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">recursive</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">FALSE</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>:length(warcs)) { filename &lt;- warcs[i] print(filename) res &lt;- readLines(filename, warn = <span class="hljs-keyword"><span class="hljs-keyword">FALSE</span></span>, encoding = "UTF-8") anchorPositions &lt;- which(res == "WARC-Type: response") links &lt;- res[anchorPositions + <span class="hljs-number"><span class="hljs-number">4</span></span>] %&gt;% str_replace_all("WARC-Target-URI: https://vk.com/share.php\\?act=count&amp;index=1&amp;url=|&amp;format=json", "") %&gt;% sapply(URLdecode) %&gt;% unname() quantities &lt;- res[anchorPositions + <span class="hljs-number"><span class="hljs-number">24</span></span>] %&gt;% str_replace_all(" |.*\\,|\\);", "") %&gt;% <span class="hljs-keyword"><span class="hljs-keyword">as</span></span>.integer() df &lt;- data.frame(link = links, quantity = quantities, social = "VK", stringsAsFactors = <span class="hljs-keyword"><span class="hljs-keyword">FALSE</span></span>) dfN &lt;- dfN + <span class="hljs-number"><span class="hljs-number">1</span></span> dfList[[dfN]] &lt;- df } dfVK &lt;- bind_rows(dfList) # <span class="hljs-keyword"><span class="hljs-keyword">Read</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> parse <span class="hljs-keyword"><span class="hljs-keyword">all</span></span> warc files <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> OK folder dfList &lt;- list() dfN &lt;- <span class="hljs-number"><span class="hljs-number">0</span></span> warcs &lt;- list.files(file.path(downloadedArticlesFolderForOK, "warc"), <span class="hljs-keyword"><span class="hljs-keyword">full</span></span>.names = <span class="hljs-keyword"><span class="hljs-keyword">TRUE</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">recursive</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">FALSE</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>:length(warcs)) { filename &lt;- warcs[i] print(filename) res &lt;- readLines(filename, warn = <span class="hljs-keyword"><span class="hljs-keyword">FALSE</span></span>, encoding = "UTF-8") anchorPositions &lt;- which(res == "WARC-Type: response") links &lt;- res[anchorPositions + <span class="hljs-number"><span class="hljs-number">4</span></span>] %&gt;% str_replace_all("WARC-Target-URI: https://connect.ok.ru/dk\\?st.cmd=extLike&amp;uid=okLenta&amp;ref=", "") %&gt;% sapply(URLdecode) %&gt;% unname() quantities &lt;- res[anchorPositions + <span class="hljs-number"><span class="hljs-number">22</span></span>] %&gt;% str_replace_all(" |.*\\,|\\);|'", "") %&gt;% <span class="hljs-keyword"><span class="hljs-keyword">as</span></span>.integer() df &lt;- data.frame(link = links, quantity = quantities, social = "OK", stringsAsFactors = <span class="hljs-keyword"><span class="hljs-keyword">FALSE</span></span>) dfN &lt;- dfN + <span class="hljs-number"><span class="hljs-number">1</span></span> dfList[[dfN]] &lt;- df } dfOK &lt;- bind_rows(dfList) # <span class="hljs-keyword"><span class="hljs-keyword">Read</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> parse <span class="hljs-keyword"><span class="hljs-keyword">all</span></span> warc files <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> Com folder dfList &lt;- list() dfN &lt;- <span class="hljs-number"><span class="hljs-number">0</span></span> warcs &lt;- list.files(file.path(downloadedArticlesFolderForCom, "warc"), <span class="hljs-keyword"><span class="hljs-keyword">full</span></span>.names = <span class="hljs-keyword"><span class="hljs-keyword">TRUE</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">recursive</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">FALSE</span></span>) x &lt;- c() <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>:length(warcs)) { filename &lt;- warcs[i] print(filename) res &lt;- readLines(filename, warn = <span class="hljs-keyword"><span class="hljs-keyword">FALSE</span></span>, encoding = "UTF-8") anchorPositions &lt;- which(str_sub(res, start = <span class="hljs-number"><span class="hljs-number">1</span></span>, end = <span class="hljs-number"><span class="hljs-number">9</span></span>) == <span class="hljs-string"><span class="hljs-string">'{"xids":{'</span></span>) x &lt;- c(x, res[anchorPositions]) } <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>:length(warcs)) { filename &lt;- warcs[i] print(filename) res &lt;- readLines(filename, warn = <span class="hljs-keyword"><span class="hljs-keyword">FALSE</span></span>, encoding = "UTF-8") anchorPositions &lt;- which(str_sub(res, start = <span class="hljs-number"><span class="hljs-number">1</span></span>, end = <span class="hljs-number"><span class="hljs-number">9</span></span>) == <span class="hljs-string"><span class="hljs-string">'{"xids":{'</span></span>) x &lt;- c(x, res[anchorPositions]) responses &lt;- res[anchorPositions] %&gt;% str_replace_all(<span class="hljs-string"><span class="hljs-string">'\\{\\"xids\\":\\{|\\}'</span></span>, "") <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(responses==""){ next } links &lt;- str_replace_all(responses, "(\":[^ ]+)|\"", "") quantities &lt;- str_replace_all(responses, ".*:", "") %&gt;% <span class="hljs-keyword"><span class="hljs-keyword">as</span></span>.integer() df &lt;- data.frame(link = links, quantity = quantities, social = "Com", stringsAsFactors = <span class="hljs-keyword"><span class="hljs-keyword">FALSE</span></span>) dfN &lt;- dfN + <span class="hljs-number"><span class="hljs-number">1</span></span> dfList[[dfN]] &lt;- df } dfCom &lt;- bind_rows(dfList) dfCom &lt;- dfCom[dfCom$link!="",] # Combine dfs <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> reshape them <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> "link", "FB", "VK", "OK", "Com" dfList &lt;- list() dfList[[<span class="hljs-number"><span class="hljs-number">1</span></span>]] &lt;- dfFB dfList[[<span class="hljs-number"><span class="hljs-number">2</span></span>]] &lt;- dfVK dfList[[<span class="hljs-number"><span class="hljs-number">3</span></span>]] &lt;- dfOK dfList[[<span class="hljs-number"><span class="hljs-number">4</span></span>]] &lt;- dfCom df &lt;- bind_rows(dfList) dfCasted &lt;- dcast(df, link ~ social, <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>.var = "quantity") dfCasted &lt;- dfCasted[<span class="hljs-keyword"><span class="hljs-keyword">order</span></span>(dfCasted$link),] <span class="hljs-keyword"><span class="hljs-keyword">write</span></span>.csv(dfCasted, file.path(parsedArticlesFolder, "social_articles.csv"), fileEncoding = "UTF-8") <span class="hljs-type"><span class="hljs-type">timestamp</span></span>() }</code> </pre> <br><p>     .   . </p><br><h3 id="cleaning"> Cleaning </h3><br><p>     ,     <code>379746 obs. of 21 variables and size of 1.739MB</code> ,      .           <code>fread {data.table}</code> . : </p><br><pre> <code class="hljs pgsql">&gt; <span class="hljs-keyword"><span class="hljs-keyword">system</span></span>.time(dfM &lt;- <span class="hljs-keyword"><span class="hljs-keyword">read</span></span>.csv(untidyDataFile, stringsAsFactors = <span class="hljs-keyword"><span class="hljs-keyword">FALSE</span></span>, encoding = "UTF-8"))    <span class="hljs-number"><span class="hljs-number">133.17</span></span> <span class="hljs-number"><span class="hljs-number">1.50</span></span> <span class="hljs-number"><span class="hljs-number">134.67</span></span> &gt; <span class="hljs-keyword"><span class="hljs-keyword">system</span></span>.time(dfM &lt;- fread(untidyDataFile, stringsAsFactors = <span class="hljs-keyword"><span class="hljs-keyword">FALSE</span></span>, encoding = "UTF-8")) <span class="hljs-keyword"><span class="hljs-keyword">Read</span></span> <span class="hljs-number"><span class="hljs-number">379746</span></span> <span class="hljs-keyword"><span class="hljs-keyword">rows</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-number"><span class="hljs-number">21</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">of</span></span> <span class="hljs-number"><span class="hljs-number">21</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">columns</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-number"><span class="hljs-number">1.698</span></span> GB file <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">18</span></span>    <span class="hljs-number"><span class="hljs-number">17.67</span></span> <span class="hljs-number"><span class="hljs-number">0.54</span></span> <span class="hljs-number"><span class="hljs-number">18.22</span></span></code> </pre> <br><p>        ,     -     <code>NA</code> .   -  ‚Äî   -    (        Parsing).   ,     ,     : </p><br><pre> <code class="hljs lua"># Load required packages <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(lubridate) <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(dplyr) <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(tidyr) <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(data.<span class="hljs-built_in"><span class="hljs-built_in">table</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(tldextract) <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(XML) <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(stringr) <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(tm) # Set workling directory <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> locale <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> macOS <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> Windows <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Sys.info()[<span class="hljs-string"><span class="hljs-string">'sysname'</span></span>] == <span class="hljs-string"><span class="hljs-string">"Windows"</span></span>) { workingDirectory &lt;- paste0(Sys.<span class="hljs-built_in"><span class="hljs-built_in">getenv</span></span>(<span class="hljs-string"><span class="hljs-string">"HOMEPATH"</span></span>), <span class="hljs-string"><span class="hljs-string">"\\lenta"</span></span>) Sys.<span class="hljs-built_in"><span class="hljs-built_in">setlocale</span></span>(<span class="hljs-string"><span class="hljs-string">"LC_ALL"</span></span>, <span class="hljs-string"><span class="hljs-string">"Russian"</span></span>) } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { workingDirectory &lt;- (<span class="hljs-string"><span class="hljs-string">"~/lenta"</span></span>) Sys.<span class="hljs-built_in"><span class="hljs-built_in">setlocale</span></span>(<span class="hljs-string"><span class="hljs-string">"LC_ALL"</span></span>, <span class="hljs-string"><span class="hljs-string">"ru_RU.UTF-8"</span></span>) } setwd(workingDirectory) # Set common variables parsedArticlesFolder &lt;- file.<span class="hljs-built_in"><span class="hljs-built_in">path</span></span>(getwd(), <span class="hljs-string"><span class="hljs-string">"parsed_articles"</span></span>) tidyArticlesFolder &lt;- file.<span class="hljs-built_in"><span class="hljs-built_in">path</span></span>(getwd(), <span class="hljs-string"><span class="hljs-string">"tidy_articles"</span></span>) # Creare required folders <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> exist dir.<span class="hljs-built_in"><span class="hljs-built_in">create</span></span>(tidyArticlesFolder, showWarnings = FALSE) ## STEP <span class="hljs-number"><span class="hljs-number">5.</span></span> Clear <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> tidy data # Section <span class="hljs-number"><span class="hljs-number">7</span></span> takes about <span class="hljs-number"><span class="hljs-number">2</span></span><span class="hljs-number"><span class="hljs-number">-4</span></span> hours TityData &lt;- <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { dfM &lt;- fread(file.<span class="hljs-built_in"><span class="hljs-built_in">path</span></span>(parsedArticlesFolder, <span class="hljs-string"><span class="hljs-string">"untidy_articles_data.csv"</span></span>), stringsAsFactors = FALSE, encoding = <span class="hljs-string"><span class="hljs-string">"UTF-8"</span></span>) # SECTION <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(paste0(<span class="hljs-string"><span class="hljs-string">"1 "</span></span>,Sys.<span class="hljs-built_in"><span class="hljs-built_in">time</span></span>())) # Remove duplicate rows, <span class="hljs-built_in"><span class="hljs-built_in">remove</span></span> rows with url = NA, <span class="hljs-built_in"><span class="hljs-built_in">create</span></span> urlKey column as a key dtD &lt;- dfM %&gt;% <span class="hljs-built_in"><span class="hljs-built_in">select</span></span>(-V1,-X) %&gt;% distinct(url, .keep_all = TRUE) %&gt;% na.omit(cols=<span class="hljs-string"><span class="hljs-string">"url"</span></span>) %&gt;% mutate(urlKey = <span class="hljs-built_in"><span class="hljs-built_in">gsub</span></span>(<span class="hljs-string"><span class="hljs-string">":|\\.|/"</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>, url)) # Function SplitChapters is used to process formatted chapter column <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> retrive rubric # <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> subrubric SplitChapters &lt;- <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(x)</span></span></span></span> { splitOne &lt;- strsplit(x, <span class="hljs-string"><span class="hljs-string">"lenta.ru:_"</span></span>)<span class="hljs-string"><span class="hljs-string">[[1]]</span></span> splitLeft &lt;- strsplit(splitOne[<span class="hljs-number"><span class="hljs-number">1</span></span>], <span class="hljs-string"><span class="hljs-string">","</span></span>)<span class="hljs-string"><span class="hljs-string">[[1]]</span></span> splitLeft &lt;- unlist(strsplit(splitLeft, <span class="hljs-string"><span class="hljs-string">":_"</span></span>)) splitRight &lt;- strsplit(splitOne[<span class="hljs-number"><span class="hljs-number">2</span></span>], <span class="hljs-string"><span class="hljs-string">":_"</span></span>)<span class="hljs-string"><span class="hljs-string">[[1]]</span></span> splitRight &lt;- splitRight[splitRight %<span class="hljs-keyword"><span class="hljs-keyword">in</span></span>% splitLeft] splitRight &lt;- <span class="hljs-built_in"><span class="hljs-built_in">gsub</span></span>(<span class="hljs-string"><span class="hljs-string">"_"</span></span>, <span class="hljs-string"><span class="hljs-string">" "</span></span>, splitRight) paste0(splitRight, collapse = <span class="hljs-string"><span class="hljs-string">"|"</span></span>) } # SECTION <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(paste0(<span class="hljs-string"><span class="hljs-string">"2 "</span></span>,Sys.<span class="hljs-built_in"><span class="hljs-built_in">time</span></span>())) # Process chapter column to retrive rubric <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> subrubric # Column value such as: # chapters: [<span class="hljs-string"><span class="hljs-string">"_"</span></span>,<span class="hljs-string"><span class="hljs-string">""</span></span>,<span class="hljs-string"><span class="hljs-string">"lenta.ru:__:_:______"</span></span>], // Chapters  # should be represented as rubric value <span class="hljs-string"><span class="hljs-string">" "</span></span> # <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> subrubric value <span class="hljs-string"><span class="hljs-string">""</span></span> dtD &lt;- dtD %&gt;% mutate(chapters = <span class="hljs-built_in"><span class="hljs-built_in">gsub</span></span>(<span class="hljs-string"><span class="hljs-string">'\"|\\[|\\]| |chapters:'</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>, chapters)) %&gt;% mutate(chaptersFormatted = as.character(sapply(chapters, SplitChapters))) %&gt;% separate(col = <span class="hljs-string"><span class="hljs-string">"chaptersFormatted"</span></span>, into = c(<span class="hljs-string"><span class="hljs-string">"rubric"</span></span>, <span class="hljs-string"><span class="hljs-string">"subrubric"</span></span>) , sep = <span class="hljs-string"><span class="hljs-string">"\\|"</span></span>, extra = <span class="hljs-string"><span class="hljs-string">"drop"</span></span>, fill = <span class="hljs-string"><span class="hljs-string">"right"</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">remove</span></span> = FALSE) %&gt;% filter(!rubric == <span class="hljs-string"><span class="hljs-string">"NA"</span></span>) %&gt;% <span class="hljs-built_in"><span class="hljs-built_in">select</span></span>(-chapters, -chaptersFormatted) # SECTION <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(paste0(<span class="hljs-string"><span class="hljs-string">"3 "</span></span>,Sys.<span class="hljs-built_in"><span class="hljs-built_in">time</span></span>())) # Process imageCredits column <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> split into imageCreditsPerson # <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> imageCreditsCompany # Column value such as: <span class="hljs-string"><span class="hljs-string">":   /  "</span></span> should be represented # as imageCreditsPerson value <span class="hljs-string"><span class="hljs-string">" "</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> # imageCreditsCompany value <span class="hljs-string"><span class="hljs-string">" "</span></span> pattern &lt;- <span class="hljs-string"><span class="hljs-string">': | |: |: |, |()||¬´|¬ª|\\(|)|\"'</span></span> dtD &lt;- dtD %&gt;% mutate(imageCredits = <span class="hljs-built_in"><span class="hljs-built_in">gsub</span></span>(pattern, <span class="hljs-string"><span class="hljs-string">""</span></span>, imageCredits)) %&gt;% separate(col = <span class="hljs-string"><span class="hljs-string">"imageCredits"</span></span>, into = c(<span class="hljs-string"><span class="hljs-string">"imageCreditsPerson"</span></span>, <span class="hljs-string"><span class="hljs-string">"imageCreditsCompany"</span></span>) , sep = <span class="hljs-string"><span class="hljs-string">"/"</span></span>, extra = <span class="hljs-string"><span class="hljs-string">"drop"</span></span>, fill = <span class="hljs-string"><span class="hljs-string">"left"</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">remove</span></span> = FALSE) %&gt;% mutate(imageCreditsPerson = as.character(sapply(imageCreditsPerson, trimws))) %&gt;% mutate(imageCreditsCompany = as.character(sapply(imageCreditsCompany, trimws))) %&gt;% <span class="hljs-built_in"><span class="hljs-built_in">select</span></span>(-imageCredits) # SECTION <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(paste0(<span class="hljs-string"><span class="hljs-string">"4 "</span></span>,Sys.<span class="hljs-built_in"><span class="hljs-built_in">time</span></span>())) # Function UpdateDatetime is used to process missed values <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> datetime column # <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> fill them up with <span class="hljs-built_in"><span class="hljs-built_in">date</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-built_in"><span class="hljs-built_in">time</span></span> retrived from <span class="hljs-built_in"><span class="hljs-built_in">string</span></span> presentation # such as <span class="hljs-string"><span class="hljs-string">"13:47, 18  2017"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> from url such # as https://lenta.ru/news/<span class="hljs-number"><span class="hljs-number">2017</span></span>/<span class="hljs-number"><span class="hljs-number">07</span></span>/<span class="hljs-number"><span class="hljs-number">18</span></span>/frg/. Hours <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> Minutes set randomly # from <span class="hljs-number"><span class="hljs-number">8</span></span> to <span class="hljs-number"><span class="hljs-number">21</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> last case months &lt;- c(<span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>) UpdateDatetime &lt;- <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(datetime, datetimeString, url)</span></span></span></span> { datetimeNew &lt;- datetime <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (is.na(datetime)) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (is.na(datetimeString)) { parsedURL &lt;- strsplit(url, <span class="hljs-string"><span class="hljs-string">"/"</span></span>)<span class="hljs-string"><span class="hljs-string">[[1]]</span></span> parsedURLLength &lt;- length(parsedURL) d &lt;- parsedURL[parsedURLLength<span class="hljs-number"><span class="hljs-number">-1</span></span>] m &lt;- parsedURL[parsedURLLength<span class="hljs-number"><span class="hljs-number">-2</span></span>] y &lt;- parsedURL[parsedURLLength<span class="hljs-number"><span class="hljs-number">-3</span></span>] H &lt;- round(runif(<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-number"><span class="hljs-number">21</span></span>)) M &lt;- round(runif(<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">59</span></span>)) S &lt;- <span class="hljs-number"><span class="hljs-number">0</span></span> datetimeString &lt;- paste0(paste0(c(y, m, d), collapse = <span class="hljs-string"><span class="hljs-string">"-"</span></span>), <span class="hljs-string"><span class="hljs-string">" "</span></span>, paste0(c(H, M, S), collapse = <span class="hljs-string"><span class="hljs-string">":"</span></span>)) datetimeNew &lt;- ymd_hms(datetimeString, tz = <span class="hljs-string"><span class="hljs-string">"Europe/Moscow"</span></span>, quiet = TRUE) } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { parsedDatetimeString &lt;- unlist(strsplit(datetimeString, <span class="hljs-string"><span class="hljs-string">","</span></span>)) %&gt;% trimws %&gt;% strsplit(<span class="hljs-string"><span class="hljs-string">" "</span></span>) %&gt;% unlist() monthNumber &lt;- which(grepl(parsedDatetimeString[<span class="hljs-number"><span class="hljs-number">3</span></span>], months)) dateString &lt;- paste0(c(parsedDatetimeString[<span class="hljs-number"><span class="hljs-number">4</span></span>], monthNumber, parsedDatetimeString[<span class="hljs-number"><span class="hljs-number">2</span></span>]), collapse = <span class="hljs-string"><span class="hljs-string">"-"</span></span>) datetimeString &lt;- paste0(dateString, <span class="hljs-string"><span class="hljs-string">" "</span></span>, parsedDatetimeString[<span class="hljs-number"><span class="hljs-number">1</span></span>], <span class="hljs-string"><span class="hljs-string">":00"</span></span>) datetimeNew &lt;- ymd_hms(datetimeString, tz = <span class="hljs-string"><span class="hljs-string">"Europe/Moscow"</span></span>, quiet = TRUE) } } datetimeNew } # Process datetime <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> fill up missed values dtD &lt;- dtD %&gt;% mutate(datetime = ymd_hms(datetime, tz = <span class="hljs-string"><span class="hljs-string">"Europe/Moscow"</span></span>, quiet = TRUE)) %&gt;% mutate(datetimeNew = mapply(UpdateDatetime, datetime, datetimeString, url)) %&gt;% mutate(datetime = as.POSIXct(datetimeNew, tz = <span class="hljs-string"><span class="hljs-string">"Europe/Moscow"</span></span>,origin = <span class="hljs-string"><span class="hljs-string">"1970-01-01"</span></span>)) # SECTION <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(paste0(<span class="hljs-string"><span class="hljs-string">"5 "</span></span>,Sys.<span class="hljs-built_in"><span class="hljs-built_in">time</span></span>())) # Remove rows with missed datetime values, <span class="hljs-built_in"><span class="hljs-built_in">rename</span></span> metaTitle to title, # <span class="hljs-built_in"><span class="hljs-built_in">remove</span></span> columns that we <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> need anymore dtD &lt;- dtD %&gt;% as.data.<span class="hljs-built_in"><span class="hljs-built_in">table</span></span>() %&gt;% na.omit(cols=<span class="hljs-string"><span class="hljs-string">"datetime"</span></span>) %&gt;% <span class="hljs-built_in"><span class="hljs-built_in">select</span></span>(-filename, -metaType, -datetimeString, -datetimeNew) %&gt;% <span class="hljs-built_in"><span class="hljs-built_in">rename</span></span>(title = metaTitle) %&gt;% <span class="hljs-built_in"><span class="hljs-built_in">select</span></span>(url, urlKey, datetime, rubric, subrubric, title, metaDescription, plaintext, authorLinks, additionalLinks, plaintextLinks, imageDescription, imageCreditsPerson, imageCreditsCompany, videoDescription, videoCredits) # SECTION <span class="hljs-number"><span class="hljs-number">6</span></span> <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(paste0(<span class="hljs-string"><span class="hljs-string">"6 "</span></span>,Sys.<span class="hljs-built_in"><span class="hljs-built_in">time</span></span>())) # Clean additionalLinks <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> plaintextLinks symbolsToRemove &lt;- <span class="hljs-string"><span class="hljs-string">"href=|-‚Äì-|¬´|¬ª|‚Ä¶|,|‚Ä¢|‚Äú|‚Äù|\n|\"|,|[|]|&lt;a|&lt;br"</span></span> symbolsHttp &lt;- <span class="hljs-string"><span class="hljs-string">"http:\\\\\\\\|:http://|-http://|.http://"</span></span> symbolsHttp2 &lt;- <span class="hljs-string"><span class="hljs-string">"http://http://|https://https://"</span></span> symbolsReplace &lt;- <span class="hljs-string"><span class="hljs-string">"[-|-|#!]"</span></span> dtD &lt;- dtD %&gt;% mutate(plaintextLinks = <span class="hljs-built_in"><span class="hljs-built_in">gsub</span></span>(symbolsToRemove,<span class="hljs-string"><span class="hljs-string">""</span></span>, plaintextLinks)) %&gt;% mutate(plaintextLinks = <span class="hljs-built_in"><span class="hljs-built_in">gsub</span></span>(symbolsHttp, <span class="hljs-string"><span class="hljs-string">"http://"</span></span>, plaintextLinks)) %&gt;% mutate(plaintextLinks = <span class="hljs-built_in"><span class="hljs-built_in">gsub</span></span>(symbolsReplace, <span class="hljs-string"><span class="hljs-string">"e"</span></span>, plaintextLinks)) %&gt;% mutate(plaintextLinks = <span class="hljs-built_in"><span class="hljs-built_in">gsub</span></span>(symbolsHttp2, <span class="hljs-string"><span class="hljs-string">"http://"</span></span>, plaintextLinks)) %&gt;% mutate(additionalLinks = <span class="hljs-built_in"><span class="hljs-built_in">gsub</span></span>(symbolsToRemove,<span class="hljs-string"><span class="hljs-string">""</span></span>, additionalLinks)) %&gt;% mutate(additionalLinks = <span class="hljs-built_in"><span class="hljs-built_in">gsub</span></span>(symbolsHttp, <span class="hljs-string"><span class="hljs-string">"http://"</span></span>, additionalLinks)) %&gt;% mutate(additionalLinks = <span class="hljs-built_in"><span class="hljs-built_in">gsub</span></span>(symbolsReplace, <span class="hljs-string"><span class="hljs-string">"e"</span></span>, additionalLinks)) %&gt;% mutate(additionalLinks = <span class="hljs-built_in"><span class="hljs-built_in">gsub</span></span>(symbolsHttp2, <span class="hljs-string"><span class="hljs-string">"http://"</span></span>, additionalLinks)) # SECTION <span class="hljs-number"><span class="hljs-number">7</span></span> <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(paste0(<span class="hljs-string"><span class="hljs-string">"7 "</span></span>,Sys.<span class="hljs-built_in"><span class="hljs-built_in">time</span></span>())) # Clean additionalLinks <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> plaintextLinks using UpdateAdditionalLinks # <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">. </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Links</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">such</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">as</span></span></span><span class="hljs-function">: # "</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">http</span></span></span><span class="hljs-function">://</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">www.dw.com</span></span></span><span class="hljs-function">/</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ru</span></span></span><span class="hljs-function">/../</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">B2</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">https</span></span></span><span class="hljs-function">://</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">www.welt.de</span></span></span><span class="hljs-function">/</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">politik</span></span></span><span class="hljs-function">/.../</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">de</span></span></span><span class="hljs-function">/" # </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">should</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">be</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">represented</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">as</span></span></span><span class="hljs-function"> "</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">dw.com</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">welt.de</span></span></span><span class="hljs-function">" # </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">UpdateAdditionalLinks</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">is</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">used</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">to</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">process</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">and</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">clean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">additionalLinks</span></span></span><span class="hljs-function"> # </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">and</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">plaintextLinks</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">UpdateAdditionalLinks</span></span></span><span class="hljs-function"> &lt;- </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(additionalLinks, url)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (is.na(additionalLinks)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>(NA) } additionalLinksSplitted &lt;- <span class="hljs-built_in"><span class="hljs-built_in">gsub</span></span>(<span class="hljs-string"><span class="hljs-string">"http://|https://|http:///|https:///"</span></span>,<span class="hljs-string"><span class="hljs-string">" "</span></span>, additionalLinks) additionalLinksSplitted &lt;- <span class="hljs-built_in"><span class="hljs-built_in">gsub</span></span>(<span class="hljs-string"><span class="hljs-string">"http:/|https:/|htt://"</span></span>,<span class="hljs-string"><span class="hljs-string">""</span></span>, additionalLinksSplitted) additionalLinksSplitted &lt;- trimws(additionalLinksSplitted) additionalLinksSplitted &lt;- unlist(strsplit(additionalLinksSplitted, <span class="hljs-string"><span class="hljs-string">" "</span></span>)) additionalLinksSplitted &lt;- additionalLinksSplitted[!additionalLinksSplitted==<span class="hljs-string"><span class="hljs-string">""</span></span>] additionalLinksSplitted &lt;- additionalLinksSplitted[!grepl(<span class="hljs-string"><span class="hljs-string">"lenta."</span></span>, additionalLinksSplitted)] additionalLinksSplitted &lt;- unlist(strsplit(additionalLinksSplitted, <span class="hljs-string"><span class="hljs-string">"/[^/]*$"</span></span>)) additionalLinksSplitted &lt;- paste0(<span class="hljs-string"><span class="hljs-string">"http://"</span></span>, additionalLinksSplitted) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!length(additionalLinksSplitted) == <span class="hljs-number"><span class="hljs-number">0</span></span>) { URLSplitted &lt;- c() <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>:length(additionalLinksSplitted)) { parsed &lt;- tryCatch(parseURI(additionalLinksSplitted[i]), <span class="hljs-built_in"><span class="hljs-built_in">error</span></span> = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(x)</span></span></span></span> {<span class="hljs-keyword"><span class="hljs-keyword">return</span></span>(NA)}) parsedURL &lt;- parsed[<span class="hljs-string"><span class="hljs-string">"server"</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!is.na(parsedURL)) { URLSplitted &lt;- c(URLSplitted, parsedURL) } } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (length(URLSplitted)==<span class="hljs-number"><span class="hljs-number">0</span></span>){ NA } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { URLSplitted &lt;- URLSplitted[!is.na(URLSplitted)] paste0(URLSplitted, collapse = <span class="hljs-string"><span class="hljs-string">" "</span></span>) } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { NA } } # Function UpdateAdditionalLinksDomain is used to process additionalLinks # <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> plaintextLinks <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> retrive source domain name UpdateAdditionalLinksDomain &lt;- <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(additionalLinks, url)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (is.na(additionalLinks)|(additionalLinks==<span class="hljs-string"><span class="hljs-string">"NA"</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>(NA) } additionalLinksSplitted &lt;- unlist(strsplit(additionalLinks, <span class="hljs-string"><span class="hljs-string">" "</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!length(additionalLinksSplitted) == <span class="hljs-number"><span class="hljs-number">0</span></span>) { parsedDomain &lt;- tryCatch(tldextract(additionalLinksSplitted), <span class="hljs-built_in"><span class="hljs-built_in">error</span></span> = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(x)</span></span></span></span> {data_frame(domain = NA, tld = NA)}) parsedDomain &lt;- parsedDomain[!is.na(parsedDomain$domain), ] <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (nrow(parsedDomain)==<span class="hljs-number"><span class="hljs-number">0</span></span>) { #<span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"--------"</span></span>) #<span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(additionalLinks) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>(NA) } domain &lt;- paste0(parsedDomain$domain, <span class="hljs-string"><span class="hljs-string">"."</span></span>, parsedDomain$tld) domain &lt;- unique(domain) domain &lt;- paste0(domain, collapse = <span class="hljs-string"><span class="hljs-string">" "</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>(domain) } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>(NA) } } dtD &lt;- dtD %&gt;% mutate(plaintextLinks = mapply(UpdateAdditionalLinks, plaintextLinks, url)) %&gt;% mutate(additionalLinks = mapply(UpdateAdditionalLinks, additionalLinks, url)) # Retrive domain from external links using updateAdditionalLinksDomain # <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">. </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Links</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">such</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">as</span></span></span><span class="hljs-function">: # "</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">http</span></span></span><span class="hljs-function">://</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">www.dw.com</span></span></span><span class="hljs-function">/</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ru</span></span></span><span class="hljs-function">/../</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">B2</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">https</span></span></span><span class="hljs-function">://</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">www.welt.de</span></span></span><span class="hljs-function">/</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">politik</span></span></span><span class="hljs-function">/.../</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">de</span></span></span><span class="hljs-function">/" # </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">should</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">be</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">represented</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">as</span></span></span><span class="hljs-function"> "</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">dw.com</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">welt.de</span></span></span><span class="hljs-function">" </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">numberOfLinks</span></span></span><span class="hljs-function"> &lt;- </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">nrow</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(dtD)</span></span></span></span> groupSize &lt;- <span class="hljs-number"><span class="hljs-number">10000</span></span> groupsN &lt;- seq(from = <span class="hljs-number"><span class="hljs-number">1</span></span>, to = numberOfLinks, by = groupSize) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>:length(groupsN)) { n1 &lt;- groupsN[i] n2 &lt;- <span class="hljs-built_in"><span class="hljs-built_in">min</span></span>(n1 + groupSize - <span class="hljs-number"><span class="hljs-number">1</span></span>, numberOfLinks) dtD$additionalLinks[n1:n2] &lt;- mapply(UpdateAdditionalLinksDomain, dtD$additionalLinks[n1:n2], dtD$url[n1:n2]) dtD$plaintextLinks[n1:n2] &lt;- mapply(UpdateAdditionalLinksDomain, dtD$plaintextLinks[n1:n2], dtD$url[n1:n2]) } # SECTION <span class="hljs-number"><span class="hljs-number">8</span></span> <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(paste0(<span class="hljs-string"><span class="hljs-string">"8 "</span></span>,Sys.<span class="hljs-built_in"><span class="hljs-built_in">time</span></span>())) # Clean title, descriprion <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> plain text. Remove puntuation <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> stop words. # Prepare <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> the stem step stopWords &lt;- readLines(<span class="hljs-string"><span class="hljs-string">"stop_words.txt"</span></span>, warn = FALSE, encoding = <span class="hljs-string"><span class="hljs-string">"UTF-8"</span></span>) dtD &lt;- dtD %&gt;% as.tbl() %&gt;% mutate(stemTitle = tolower(title), stemMetaDescription = tolower(metaDescription), stemPlaintext = tolower(plaintext)) dtD &lt;- dtD %&gt;% as.tbl() %&gt;% mutate(stemTitle = enc2utf8(stemTitle), stemMetaDescription = enc2utf8(stemMetaDescription), stemPlaintext = enc2utf8(stemPlaintext)) dtD &lt;- dtD %&gt;% as.tbl() %&gt;% mutate(stemTitle = removeWords(stemTitle, stopWords), stemMetaDescription = removeWords(stemMetaDescription, stopWords), stemPlaintext = removeWords(stemPlaintext, stopWords)) dtD &lt;- dtD %&gt;% as.tbl() %&gt;% mutate(stemTitle = removePunctuation(stemTitle), stemMetaDescription = removePunctuation(stemMetaDescription), stemPlaintext = removePunctuation(stemPlaintext)) dtD &lt;- dtD %&gt;% as.tbl() %&gt;% mutate(stemTitle = str_replace_all(stemTitle, <span class="hljs-string"><span class="hljs-string">"\\s+"</span></span>, <span class="hljs-string"><span class="hljs-string">" "</span></span>), stemMetaDescription = str_replace_all(stemMetaDescription, <span class="hljs-string"><span class="hljs-string">"\\s+"</span></span>, <span class="hljs-string"><span class="hljs-string">" "</span></span>), stemPlaintext = str_replace_all(stemPlaintext, <span class="hljs-string"><span class="hljs-string">"\\s+"</span></span>, <span class="hljs-string"><span class="hljs-string">" "</span></span>)) dtD &lt;- dtD %&gt;% as.tbl() %&gt;% mutate(stemTitle = str_trim(stemTitle, side = <span class="hljs-string"><span class="hljs-string">"both"</span></span>), stemMetaDescription = str_trim(stemMetaDescription, side = <span class="hljs-string"><span class="hljs-string">"both"</span></span>), stemPlaintext = str_trim(stemPlaintext, side = <span class="hljs-string"><span class="hljs-string">"both"</span></span>)) # SECTION <span class="hljs-number"><span class="hljs-number">9</span></span> <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(paste0(<span class="hljs-string"><span class="hljs-string">"9 "</span></span>,Sys.<span class="hljs-built_in"><span class="hljs-built_in">time</span></span>())) <span class="hljs-built_in"><span class="hljs-built_in">write</span></span>.csv(dtD, file.<span class="hljs-built_in"><span class="hljs-built_in">path</span></span>(tidyArticlesFolder, <span class="hljs-string"><span class="hljs-string">"tidy_articles_data.csv"</span></span>), fileEncoding = <span class="hljs-string"><span class="hljs-string">"UTF-8"</span></span>) # SECTION <span class="hljs-number"><span class="hljs-number">10</span></span> Finish <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(paste0(<span class="hljs-string"><span class="hljs-string">"10 "</span></span>,Sys.<span class="hljs-built_in"><span class="hljs-built_in">time</span></span>())) # SECTION <span class="hljs-number"><span class="hljs-number">11</span></span> Adding social dfM &lt;- <span class="hljs-built_in"><span class="hljs-built_in">read</span></span>.csv(file.<span class="hljs-built_in"><span class="hljs-built_in">path</span></span>(tidyArticlesFolder, <span class="hljs-string"><span class="hljs-string">"tidy_articles_data.csv"</span></span>), stringsAsFactors = FALSE, encoding = <span class="hljs-string"><span class="hljs-string">"UTF-8"</span></span>) dfS &lt;- <span class="hljs-built_in"><span class="hljs-built_in">read</span></span>.csv(file.<span class="hljs-built_in"><span class="hljs-built_in">path</span></span>(parsedArticlesFolder, <span class="hljs-string"><span class="hljs-string">"social_articles.csv"</span></span>), stringsAsFactors = FALSE, encoding = <span class="hljs-string"><span class="hljs-string">"UTF-8"</span></span>) dt &lt;- as.tbl(dfM) dtS &lt;- as.tbl(dfS) %&gt;% <span class="hljs-built_in"><span class="hljs-built_in">rename</span></span>(url = link) %&gt;% <span class="hljs-built_in"><span class="hljs-built_in">select</span></span>(url, FB, VK, OK, Com) dtG &lt;- left_join(dt, dtS, by = <span class="hljs-string"><span class="hljs-string">"url"</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">write</span></span>.csv(dtG, file.<span class="hljs-built_in"><span class="hljs-built_in">path</span></span>(tidyArticlesFolder, <span class="hljs-string"><span class="hljs-string">"tidy_articles_data.csv"</span></span>), fileEncoding = <span class="hljs-string"><span class="hljs-string">"UTF-8"</span></span>) }</code> </pre> <br><p>        ,    <code>time stamp</code>   <code>print(paste0("1 ",Sys.time()))</code> .     <code>2.7GHz i5, 16Gb Ram, SSD, macOS 10.12, R version 3.4.0</code> : </p><br><pre> <code class="hljs json">[<span class="hljs-number"><span class="hljs-number">1</span></span>] <span class="hljs-string"><span class="hljs-string">"1 2017-07-21 16:36:59"</span></span> [<span class="hljs-number"><span class="hljs-number">1</span></span>] <span class="hljs-string"><span class="hljs-string">"2 2017-07-21 16:37:13"</span></span> [<span class="hljs-number"><span class="hljs-number">1</span></span>] <span class="hljs-string"><span class="hljs-string">"3 2017-07-21 16:38:15"</span></span> [<span class="hljs-number"><span class="hljs-number">1</span></span>] <span class="hljs-string"><span class="hljs-string">"4 2017-07-21 16:39:11"</span></span> [<span class="hljs-number"><span class="hljs-number">1</span></span>] <span class="hljs-string"><span class="hljs-string">"5 2017-07-21 16:42:58"</span></span> [<span class="hljs-number"><span class="hljs-number">1</span></span>] <span class="hljs-string"><span class="hljs-string">"6 2017-07-21 16:42:58"</span></span> [<span class="hljs-number"><span class="hljs-number">1</span></span>] <span class="hljs-string"><span class="hljs-string">"7 2017-07-21 16:43:35"</span></span> [<span class="hljs-number"><span class="hljs-number">1</span></span>] <span class="hljs-string"><span class="hljs-string">"8 2017-07-21 18:41:25"</span></span> [<span class="hljs-number"><span class="hljs-number">1</span></span>] <span class="hljs-string"><span class="hljs-string">"9 2017-07-21 19:00:32"</span></span> [<span class="hljs-number"><span class="hljs-number">1</span></span>] <span class="hljs-string"><span class="hljs-string">"10 2017-07-21 19:01:04"</span></span></code> </pre> <br><p>    <code>3.5GHz Xeon E-1240 v5, 32Gb, SSD, Windows Server 2012</code> : </p><br><pre> <code class="hljs json">[<span class="hljs-number"><span class="hljs-number">1</span></span>] <span class="hljs-string"><span class="hljs-string">"1 2017-07-21 14:36:44"</span></span> [<span class="hljs-number"><span class="hljs-number">1</span></span>] <span class="hljs-string"><span class="hljs-string">"2 2017-07-21 14:37:08"</span></span> [<span class="hljs-number"><span class="hljs-number">1</span></span>] <span class="hljs-string"><span class="hljs-string">"3 2017-07-21 14:38:23"</span></span> [<span class="hljs-number"><span class="hljs-number">1</span></span>] <span class="hljs-string"><span class="hljs-string">"4 2017-07-21 14:41:24"</span></span> [<span class="hljs-number"><span class="hljs-number">1</span></span>] <span class="hljs-string"><span class="hljs-string">"5 2017-07-21 14:46:02"</span></span> [<span class="hljs-number"><span class="hljs-number">1</span></span>] <span class="hljs-string"><span class="hljs-string">"6 2017-07-21 14:46:02"</span></span> [<span class="hljs-number"><span class="hljs-number">1</span></span>] <span class="hljs-string"><span class="hljs-string">"7 2017-07-21 14:46:57"</span></span> [<span class="hljs-number"><span class="hljs-number">1</span></span>] <span class="hljs-string"><span class="hljs-string">"8 2017-07-21 18:58:04"</span></span> [<span class="hljs-number"><span class="hljs-number">1</span></span>] <span class="hljs-string"><span class="hljs-string">"9 2017-07-21 19:30:27"</span></span> [<span class="hljs-number"><span class="hljs-number">1</span></span>] <span class="hljs-string"><span class="hljs-string">"10 2017-07-21 19:35:18"</span></span></code> </pre> <br><p>  (   ),   <code>UpdateAdditionalLinksDomain</code> (         )    .      <code>tldextract {tldextract}</code> .              -      ‚Äî      . </p><br><blockquote>   ‚Äî            2  ?  7  4   2   . </blockquote><p>      ,     .  Result: </p><br><pre> <code class="hljs perl">&gt; str(dfM, vec.len = <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-string"><span class="hljs-string">'data.frame'</span></span>: <span class="hljs-number"><span class="hljs-number">379746</span></span> obs. of <span class="hljs-number"><span class="hljs-number">21</span></span> variables: $ X.<span class="hljs-number"><span class="hljs-number">1</span></span> : <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> ... $ X : <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> ... $ url : <span class="hljs-keyword"><span class="hljs-keyword">chr</span></span> <span class="hljs-string"><span class="hljs-string">"https://lenta.ru/news/2009/12/31/kids/"</span></span> ... $ filename : <span class="hljs-keyword"><span class="hljs-keyword">chr</span></span> <span class="hljs-string"><span class="hljs-string">"C:/Users/ildar/lenta/downloaded_articles/000001-010000/index.html"</span></span> ... &gt; str(dfM, vec.len = <span class="hljs-number"><span class="hljs-number">1</span></span>) Classes <span class="hljs-string"><span class="hljs-string">'data.table'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-string"><span class="hljs-string">'data.frame'</span></span>: <span class="hljs-number"><span class="hljs-number">376913</span></span> obs. of <span class="hljs-number"><span class="hljs-number">19</span></span> variables: $ url : <span class="hljs-keyword"><span class="hljs-keyword">chr</span></span> <span class="hljs-string"><span class="hljs-string">"https://lenta.ru/news/2009/12/31/kids/"</span></span> ... $ urlKey : <span class="hljs-keyword"><span class="hljs-keyword">chr</span></span> <span class="hljs-string"><span class="hljs-string">"httpslentarunews20091231kids"</span></span> ... $ datetime : <span class="hljs-keyword"><span class="hljs-keyword">chr</span></span> <span class="hljs-string"><span class="hljs-string">"2010-01-01 00:24:33"</span></span> ... $ rubric : <span class="hljs-keyword"><span class="hljs-keyword">chr</span></span> <span class="hljs-string"><span class="hljs-string">""</span></span> ... $ subrubric : <span class="hljs-keyword"><span class="hljs-keyword">chr</span></span> NA ... $ title : <span class="hljs-keyword"><span class="hljs-keyword">chr</span></span> <span class="hljs-string"><span class="hljs-string">"      "</span></span> ... $ metaDescription : <span class="hljs-keyword"><span class="hljs-keyword">chr</span></span> <span class="hljs-string"><span class="hljs-string">"           .   "</span></span>| __truncated_<span class="hljs-number"><span class="hljs-number">_</span></span> ... $ plaintext : <span class="hljs-keyword"><span class="hljs-keyword">chr</span></span> <span class="hljs-string"><span class="hljs-string">"           .   "</span></span>| __truncated_<span class="hljs-number"><span class="hljs-number">_</span></span> ... $ authorLinks : <span class="hljs-keyword"><span class="hljs-keyword">chr</span></span> NA ... $ additionalLinks : <span class="hljs-keyword"><span class="hljs-keyword">chr</span></span> NA ... $ plaintextLinks : <span class="hljs-keyword"><span class="hljs-keyword">chr</span></span> <span class="hljs-string"><span class="hljs-string">"interfax.ru"</span></span> ... $ imageDescription : <span class="hljs-keyword"><span class="hljs-keyword">chr</span></span> NA ... $ imageCreditsPerson : <span class="hljs-keyword"><span class="hljs-keyword">chr</span></span> NA ... $ imageCreditsCompany: <span class="hljs-keyword"><span class="hljs-keyword">chr</span></span> NA ... $ videoDescription : <span class="hljs-keyword"><span class="hljs-keyword">chr</span></span> NA ... $ videoCredits : <span class="hljs-keyword"><span class="hljs-keyword">chr</span></span> NA ... $ stemTitle : <span class="hljs-keyword"><span class="hljs-keyword">chr</span></span> <span class="hljs-string"><span class="hljs-string">"      "</span></span> ... $ stemMetaDescription: <span class="hljs-keyword"><span class="hljs-keyword">chr</span></span> <span class="hljs-string"><span class="hljs-string">"             "</span></span>| __truncated_<span class="hljs-number"><span class="hljs-number">_</span></span> ... $ stemPlaintext : <span class="hljs-keyword"><span class="hljs-keyword">chr</span></span> <span class="hljs-string"><span class="hljs-string">"             "</span></span>| __truncated_<span class="hljs-number"><span class="hljs-number">_</span></span> ...</code> </pre> <br><p>     . <br>  ,   : </p><br><pre> <code class="hljs mel">&gt; <span class="hljs-keyword"><span class="hljs-keyword">file</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">size</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">file</span></span>.path(tidyArticlesFolder, <span class="hljs-string"><span class="hljs-string">"tidy_articles_data.csv"</span></span>))/<span class="hljs-number"><span class="hljs-number">1024</span></span>/<span class="hljs-number"><span class="hljs-number">1024</span></span> [<span class="hljs-number"><span class="hljs-number">1</span></span>] <span class="hljs-number"><span class="hljs-number">2741.01</span></span></code> </pre> <br><h3 id="reproducible-research"> REPRODUCIBLE RESEARCH </h3><br><p>    (  STEMMING)   ,     -   .  -  (    STEMMING)       .        <code>1  1999 </code>           . </p><br><blockquote>          700 . </blockquote><p>     <code>2 </code>       <code>700 </code> : </p><br><pre> <code class="hljs pgsql">&gt; head(articlesLinks) [<span class="hljs-number"><span class="hljs-number">1</span></span>] "https://lenta.ru/news/1999/08/31/stancia_mir/" [<span class="hljs-number"><span class="hljs-number">2</span></span>] "https://lenta.ru/news/1999/08/31/vzriv/" [<span class="hljs-number"><span class="hljs-number">3</span></span>] "https://lenta.ru/news/1999/08/31/credit_japs/" [<span class="hljs-number"><span class="hljs-number">4</span></span>] "https://lenta.ru/news/1999/08/31/fsb/" [<span class="hljs-number"><span class="hljs-number">5</span></span>] "https://lenta.ru/news/1999/09/01/dagestan/" [<span class="hljs-number"><span class="hljs-number">6</span></span>] "https://lenta.ru/news/1999/09/01/kirgiz1/" &gt; length(articlesLinks) [<span class="hljs-number"><span class="hljs-number">1</span></span>] <span class="hljs-number"><span class="hljs-number">702246</span></span></code> </pre> <br><p>  700000  (  18 )   70     <code>4.5 </code> .  Result: </p><br><pre> <code class="hljs pgsql">&gt; indexFiles &lt;- list.files(downloadedArticlesFolder, <span class="hljs-keyword"><span class="hljs-keyword">full</span></span>.names = <span class="hljs-keyword"><span class="hljs-keyword">TRUE</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">recursive</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">TRUE</span></span>, pattern = "index") &gt; length(indexFiles) [<span class="hljs-number"><span class="hljs-number">1</span></span>] <span class="hljs-number"><span class="hljs-number">702246</span></span> &gt; sum(file.size(indexFiles))/<span class="hljs-number"><span class="hljs-number">1024</span></span>/<span class="hljs-number"><span class="hljs-number">1024</span></span> [<span class="hljs-number"><span class="hljs-number">1</span></span>] <span class="hljs-number"><span class="hljs-number">123682.1</span></span></code> </pre> <br><p>  <code>123GB</code>  -     70   <code>60 </code> (   ).  <code>2.831MB</code>    : </p><br><pre> <code class="hljs mel">&gt; <span class="hljs-keyword"><span class="hljs-keyword">file</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">size</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">file</span></span>.path(parsedArticlesFolder, <span class="hljs-string"><span class="hljs-string">"untidy_articles_data.csv"</span></span>))/<span class="hljs-number"><span class="hljs-number">1024</span></span>/<span class="hljs-number"><span class="hljs-number">1024</span></span> [<span class="hljs-number"><span class="hljs-number">1</span></span>] <span class="hljs-number"><span class="hljs-number">3001.875</span></span></code> </pre> <br><p>     8  (   ,  7).     <code>3.5GHz Xeon E-1240 v5, 32Gb, SSD, Windows Server 2012</code> : </p><br><pre> <code class="hljs json">[<span class="hljs-number"><span class="hljs-number">1</span></span>] <span class="hljs-string"><span class="hljs-string">"1 2017-07-27 08:21:46"</span></span> [<span class="hljs-number"><span class="hljs-number">1</span></span>] <span class="hljs-string"><span class="hljs-string">"2 2017-07-27 08:22:44"</span></span> [<span class="hljs-number"><span class="hljs-number">1</span></span>] <span class="hljs-string"><span class="hljs-string">"3 2017-07-27 08:25:21"</span></span> [<span class="hljs-number"><span class="hljs-number">1</span></span>] <span class="hljs-string"><span class="hljs-string">"4 2017-07-27 08:30:56"</span></span> [<span class="hljs-number"><span class="hljs-number">1</span></span>] <span class="hljs-string"><span class="hljs-string">"5 2017-07-27 08:38:29"</span></span> [<span class="hljs-number"><span class="hljs-number">1</span></span>] <span class="hljs-string"><span class="hljs-string">"6 2017-07-27 08:38:29"</span></span> [<span class="hljs-number"><span class="hljs-number">1</span></span>] <span class="hljs-string"><span class="hljs-string">"7 2017-07-27 08:40:01"</span></span> [<span class="hljs-number"><span class="hljs-number">1</span></span>] <span class="hljs-string"><span class="hljs-string">"8 2017-07-27 15:55:18"</span></span> [<span class="hljs-number"><span class="hljs-number">1</span></span>] <span class="hljs-string"><span class="hljs-string">"9 2017-07-27 16:44:49"</span></span> [<span class="hljs-number"><span class="hljs-number">1</span></span>] <span class="hljs-string"><span class="hljs-string">"10 2017-07-27 16:53:02"</span></span></code> </pre><br><p>      <code>4.5GB</code> ,    : </p><br><pre> <code class="hljs mel">&gt; <span class="hljs-keyword"><span class="hljs-keyword">file</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">size</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">file</span></span>.path(tidyArticlesFolder, <span class="hljs-string"><span class="hljs-string">"tidy_articles_data.csv"</span></span>))/<span class="hljs-number"><span class="hljs-number">1024</span></span>/<span class="hljs-number"><span class="hljs-number">1024</span></span> [<span class="hljs-number"><span class="hljs-number">1</span></span>] <span class="hljs-number"><span class="hljs-number">4534.328</span></span></code> </pre> <br><h3 id="stemming"> STEMMING </h3><br><p>  .   ,       ,  <code>///</code> (   )     <code></code> (   ).      <a href="http://r.psylab.info/blog/2015/05/26/text-stemming/">    </a>   <a href="https://tech.yandex.ru/mystem/">MyStem</a> .   : </p><br><pre> <code class="hljs lua"># Load required packages <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(data.<span class="hljs-built_in"><span class="hljs-built_in">table</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(dplyr) <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(tidyr) <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(stringr) <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(gdata) # Set workling directory <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> locale <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> macOS <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> Windows <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Sys.info()[<span class="hljs-string"><span class="hljs-string">'sysname'</span></span>] == <span class="hljs-string"><span class="hljs-string">"Windows"</span></span>) { workingDirectory &lt;- paste0(Sys.<span class="hljs-built_in"><span class="hljs-built_in">getenv</span></span>(<span class="hljs-string"><span class="hljs-string">"HOMEPATH"</span></span>), <span class="hljs-string"><span class="hljs-string">"\\lenta"</span></span>) Sys.<span class="hljs-built_in"><span class="hljs-built_in">setlocale</span></span>(<span class="hljs-string"><span class="hljs-string">"LC_ALL"</span></span>, <span class="hljs-string"><span class="hljs-string">"Russian"</span></span>) } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { workingDirectory &lt;- (<span class="hljs-string"><span class="hljs-string">"~/lenta"</span></span>) Sys.<span class="hljs-built_in"><span class="hljs-built_in">setlocale</span></span>(<span class="hljs-string"><span class="hljs-string">"LC_ALL"</span></span>, <span class="hljs-string"><span class="hljs-string">"ru_RU.UTF-8"</span></span>) } setwd(workingDirectory) # Load library that helps to chunk vectors source(<span class="hljs-string"><span class="hljs-string">"chunk.R"</span></span>) # Set common variables tidyArticlesFolder &lt;- file.<span class="hljs-built_in"><span class="hljs-built_in">path</span></span>(getwd(), <span class="hljs-string"><span class="hljs-string">"tidy_articles"</span></span>) stemedArticlesFolder &lt;- file.<span class="hljs-built_in"><span class="hljs-built_in">path</span></span>(getwd(), <span class="hljs-string"><span class="hljs-string">"stemed_articles"</span></span>) # Create required folders <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> exist dir.<span class="hljs-built_in"><span class="hljs-built_in">create</span></span>(stemedArticlesFolder, showWarnings = FALSE) ## STEP <span class="hljs-number"><span class="hljs-number">6.</span></span> Stem title, description <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> plain text # Write columns on disk, run mystem, <span class="hljs-built_in"><span class="hljs-built_in">read</span></span> stemed data <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> add to data.<span class="hljs-built_in"><span class="hljs-built_in">table</span></span> StemArticlesData &lt;- <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { # Read tidy data <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> keep only column that have to be stemed. # Add === separate rows <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> stem <span class="hljs-built_in"><span class="hljs-built_in">output</span></span>. # dt that takes about <span class="hljs-number"><span class="hljs-number">5</span></span>GB RAM <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-number"><span class="hljs-number">700000</span></span> obs. of <span class="hljs-number"><span class="hljs-number">25</span></span> variables # <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-number"><span class="hljs-number">2.2</span></span>GB <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-number"><span class="hljs-number">700000</span></span> obs. of <span class="hljs-number"><span class="hljs-number">5</span></span> variables as tbl timestamp(prefix = <span class="hljs-string"><span class="hljs-string">"## START reading file "</span></span>) tidyDataFile &lt;- file.<span class="hljs-built_in"><span class="hljs-built_in">path</span></span>(tidyArticlesFolder, <span class="hljs-string"><span class="hljs-string">"tidy_articles_data.csv"</span></span>) dt &lt;- fread(tidyDataFile, stringsAsFactors = FALSE, encoding = <span class="hljs-string"><span class="hljs-string">"UTF-8"</span></span>) %&gt;% as.tbl() dt &lt;- dt %&gt;% mutate(sep = <span class="hljs-string"><span class="hljs-string">"==="</span></span>) %&gt;% <span class="hljs-built_in"><span class="hljs-built_in">select</span></span>(sep, X, stemTitle, stemMetaDescription, stemPlaintext) # Check memory usage <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(ll(unit = <span class="hljs-string"><span class="hljs-string">"MB"</span></span>)) # Prepare the list that helps us to stem <span class="hljs-number"><span class="hljs-number">3</span></span> column sectionList &lt;- list() sectionList<span class="hljs-string"><span class="hljs-string">[[1]]</span></span> &lt;- list(columnToStem = <span class="hljs-string"><span class="hljs-string">"stemTitle"</span></span>, stemedColumn = <span class="hljs-string"><span class="hljs-string">"stemedTitle"</span></span>, sourceFile = file.<span class="hljs-built_in"><span class="hljs-built_in">path</span></span>(stemedArticlesFolder, <span class="hljs-string"><span class="hljs-string">"stem_titles.txt"</span></span>), stemedFile = file.<span class="hljs-built_in"><span class="hljs-built_in">path</span></span>(stemedArticlesFolder, <span class="hljs-string"><span class="hljs-string">"stemed_titles.txt"</span></span>)) sectionList<span class="hljs-string"><span class="hljs-string">[[2]]</span></span> &lt;- list(columnToStem = <span class="hljs-string"><span class="hljs-string">"stemMetaDescription"</span></span>, stemedColumn = <span class="hljs-string"><span class="hljs-string">"stemedMetaDescription"</span></span>, sourceFile = file.<span class="hljs-built_in"><span class="hljs-built_in">path</span></span>(stemedArticlesFolder, <span class="hljs-string"><span class="hljs-string">"stem_metadescriptions.txt"</span></span>), stemedFile = file.<span class="hljs-built_in"><span class="hljs-built_in">path</span></span>(stemedArticlesFolder, <span class="hljs-string"><span class="hljs-string">"stemed_metadescriptions.txt"</span></span>)) sectionList<span class="hljs-string"><span class="hljs-string">[[3]]</span></span> &lt;- list(columnToStem = <span class="hljs-string"><span class="hljs-string">"stemPlaintext"</span></span>, stemedColumn = <span class="hljs-string"><span class="hljs-string">"stemedPlaintext"</span></span>, sourceFile = file.<span class="hljs-built_in"><span class="hljs-built_in">path</span></span>(stemedArticlesFolder, <span class="hljs-string"><span class="hljs-string">"stem_plaintext.txt"</span></span>), stemedFile = file.<span class="hljs-built_in"><span class="hljs-built_in">path</span></span>(stemedArticlesFolder, <span class="hljs-string"><span class="hljs-string">"stemed_plaintext.txt"</span></span>)) timestamp(prefix = <span class="hljs-string"><span class="hljs-string">"## steming file "</span></span>) # Write the <span class="hljs-built_in"><span class="hljs-built_in">table</span></span> with sep, X, columnToStem columns <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> run mystem. # It takes about <span class="hljs-number"><span class="hljs-number">30</span></span> <span class="hljs-built_in"><span class="hljs-built_in">min</span></span> to process Title, MetaDescription <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> Plaintext # <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-number"><span class="hljs-number">700</span></span>K rows <span class="hljs-built_in"><span class="hljs-built_in">table</span></span>. # https://tech.yandex.ru/mystem/ <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>:length(sectionList)) { <span class="hljs-built_in"><span class="hljs-built_in">write</span></span>.<span class="hljs-built_in"><span class="hljs-built_in">table</span></span>(dt[, c(<span class="hljs-string"><span class="hljs-string">"sep"</span></span>,<span class="hljs-string"><span class="hljs-string">"X"</span></span>, sectionList<span class="hljs-string"><span class="hljs-string">[[i]]</span></span>$columnToStem)], sectionList<span class="hljs-string"><span class="hljs-string">[[i]]</span></span>$sourceFile, fileEncoding = <span class="hljs-string"><span class="hljs-string">"UTF-8"</span></span>, sep = <span class="hljs-string"><span class="hljs-string">","</span></span>, quote = FALSE, row.names = FALSE, col.names = FALSE) system(paste0(<span class="hljs-string"><span class="hljs-string">"mystem -nlc "</span></span>, sectionList<span class="hljs-string"><span class="hljs-string">[[i]]</span></span>$sourceFile, <span class="hljs-string"><span class="hljs-string">" "</span></span>, sectionList<span class="hljs-string"><span class="hljs-string">[[i]]</span></span>$stemedFile), intern = FALSE) } # Remove dt from memory <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> call garbage collection rm(dt) gc() # Check memory usage <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(ll(unit = <span class="hljs-string"><span class="hljs-string">"MB"</span></span>)) timestamp(prefix = <span class="hljs-string"><span class="hljs-string">"## process file "</span></span>) # Process stemed files. it takes about <span class="hljs-number"><span class="hljs-number">60</span></span> <span class="hljs-built_in"><span class="hljs-built_in">min</span></span> to process <span class="hljs-number"><span class="hljs-number">3</span></span> stemed files <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>:length(sectionList)) { stemedText &lt;- readLines(sectionList<span class="hljs-string"><span class="hljs-string">[[i]]</span></span>$stemedFile, warn = FALSE, encoding = <span class="hljs-string"><span class="hljs-string">"UTF-8"</span></span>) # Split stemed text <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> chunks chunkList &lt;- chunk(stemedText, chunk.size = <span class="hljs-number"><span class="hljs-number">10000000</span></span>) # Clean chunks one by one <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-built_in"><span class="hljs-built_in">remove</span></span> characters that were added by mystem resLines &lt;- c() <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (j <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>:length(chunkList)) { resTemp &lt;- chunkList<span class="hljs-string"><span class="hljs-string">[[j]]</span></span> %&gt;% str_replace_all(<span class="hljs-string"><span class="hljs-string">"===,"</span></span>, <span class="hljs-string"><span class="hljs-string">"==="</span></span>) %&gt;% strsplit(split = <span class="hljs-string"><span class="hljs-string">"\\\\n|,"</span></span>) %&gt;% unlist() %&gt;% str_replace_all(<span class="hljs-string"><span class="hljs-string">"(\\|[^ ]+)|(\\\\[^ ]+)|\\?|,|_"</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>) resLines &lt;- c(resLines, resTemp[resTemp!=<span class="hljs-string"><span class="hljs-string">""</span></span>]) } # Split processed text <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> rows using === added at the beginnig chunkedRes &lt;- chunk(resLines, chunk.delimiter = <span class="hljs-string"><span class="hljs-string">"==="</span></span>, fixed.delimiter = FALSE, keep.delimiter = TRUE) # Process each row <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> extract key (row number) <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> stemed content stemedList &lt;- lapply(chunkedRes, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(x)</span></span></span></span> { data.frame(key = as.integer(str_replace_all(x[<span class="hljs-number"><span class="hljs-number">1</span></span>], <span class="hljs-string"><span class="hljs-string">"==="</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>)), content = paste0(x[<span class="hljs-number"><span class="hljs-number">2</span></span>:length(x)], collapse = <span class="hljs-string"><span class="hljs-string">" "</span></span>), stringsAsFactors = FALSE)}) # Combine all rows <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> data frame with key <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> content colums sectionList<span class="hljs-string"><span class="hljs-string">[[i]]</span></span>$dt &lt;- bind_rows(stemedList) colnames(sectionList<span class="hljs-string"><span class="hljs-string">[[i]]</span></span>$dt) &lt;- c(<span class="hljs-string"><span class="hljs-string">"key"</span></span>, sectionList<span class="hljs-string"><span class="hljs-string">[[i]]</span></span>$stemedColumn) } # Remove variables used <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> loop <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> call garbage collection rm(stemedText, chunkList, resLines, chunkedRes, stemedList) gc() # Check memory usage <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(ll(unit = <span class="hljs-string"><span class="hljs-string">"MB"</span></span>)) # <span class="hljs-built_in"><span class="hljs-built_in">read</span></span> tidy data again timestamp(prefix = <span class="hljs-string"><span class="hljs-string">"## reading file (again)"</span></span>) dt &lt;- fread(tidyDataFile, stringsAsFactors = FALSE, encoding = <span class="hljs-string"><span class="hljs-string">"UTF-8"</span></span>) %&gt;% as.tbl() # add key column as a key <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> add tables with stemed data to tidy data timestamp(prefix = paste0(<span class="hljs-string"><span class="hljs-string">"## combining tables "</span></span>)) dt &lt;- dt %&gt;% mutate(key = X) dt &lt;- left_join(dt, sectionList<span class="hljs-string"><span class="hljs-string">[[1]]</span></span>$dt, by = <span class="hljs-string"><span class="hljs-string">"key"</span></span>) dt &lt;- left_join(dt, sectionList<span class="hljs-string"><span class="hljs-string">[[2]]</span></span>$dt, by = <span class="hljs-string"><span class="hljs-string">"key"</span></span>) dt &lt;- left_join(dt, sectionList<span class="hljs-string"><span class="hljs-string">[[3]]</span></span>$dt, by = <span class="hljs-string"><span class="hljs-string">"key"</span></span>) sectionList<span class="hljs-string"><span class="hljs-string">[[1]]</span></span>$dt &lt;- <span class="hljs-string"><span class="hljs-string">""</span></span> sectionList<span class="hljs-string"><span class="hljs-string">[[2]]</span></span>$dt &lt;- <span class="hljs-string"><span class="hljs-string">""</span></span> sectionList<span class="hljs-string"><span class="hljs-string">[[3]]</span></span>$dt &lt;- <span class="hljs-string"><span class="hljs-string">""</span></span> dt &lt;- dt %&gt;% <span class="hljs-built_in"><span class="hljs-built_in">select</span></span>(-V1, -X, -urlKey, -metaDescription, -plaintext, -stemTitle, -stemMetaDescription, -stemPlaintext, - key) <span class="hljs-built_in"><span class="hljs-built_in">write</span></span>.csv(dt, file.<span class="hljs-built_in"><span class="hljs-built_in">path</span></span>(stemedArticlesFolder, <span class="hljs-string"><span class="hljs-string">"stemed_articles_data.csv"</span></span>), fileEncoding = <span class="hljs-string"><span class="hljs-string">"UTF-8"</span></span>) file.<span class="hljs-built_in"><span class="hljs-built_in">remove</span></span>(sectionList<span class="hljs-string"><span class="hljs-string">[[1]]</span></span>$sourceFile) file.<span class="hljs-built_in"><span class="hljs-built_in">remove</span></span>(sectionList<span class="hljs-string"><span class="hljs-string">[[2]]</span></span>$sourceFile) file.<span class="hljs-built_in"><span class="hljs-built_in">remove</span></span>(sectionList<span class="hljs-string"><span class="hljs-string">[[3]]</span></span>$sourceFile) file.<span class="hljs-built_in"><span class="hljs-built_in">remove</span></span>(sectionList<span class="hljs-string"><span class="hljs-string">[[1]]</span></span>$stemedFile) file.<span class="hljs-built_in"><span class="hljs-built_in">remove</span></span>(sectionList<span class="hljs-string"><span class="hljs-string">[[2]]</span></span>$stemedFile) file.<span class="hljs-built_in"><span class="hljs-built_in">remove</span></span>(sectionList<span class="hljs-string"><span class="hljs-string">[[3]]</span></span>$stemedFile) # Remove dt, sectionList <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> call garbage collection rm(dt) gc() # Check memory usage <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(ll(unit = <span class="hljs-string"><span class="hljs-string">"MB"</span></span>)) timestamp(prefix = <span class="hljs-string"><span class="hljs-string">"## END "</span></span>) }</code> </pre> <br><p>   ,    : </p><br><pre> <code class="hljs smalltalk">&gt; file.size(file.path(stemedArticlesFolder, <span class="hljs-comment"><span class="hljs-comment">"stemed_articles_data.csv"</span></span>))/<span class="hljs-number"><span class="hljs-number">1024</span></span>/<span class="hljs-number"><span class="hljs-number">1024</span></span> [<span class="hljs-number"><span class="hljs-number">1</span></span>] <span class="hljs-number"><span class="hljs-number">2273.52</span></span> &gt; str(x, vec.len = <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-type"><span class="hljs-type">Classes</span></span> <span class="hljs-string"><span class="hljs-string">'data.table'</span></span> and <span class="hljs-string"><span class="hljs-string">'data.frame'</span></span>: <span class="hljs-number"><span class="hljs-number">697601</span></span> obs. of <span class="hljs-number"><span class="hljs-number">21</span></span> variables: <span class="hljs-string"><span class="hljs-string">$ </span></span><span class="hljs-type"><span class="hljs-type">V1</span></span> : chr <span class="hljs-comment"><span class="hljs-comment">"1"</span></span> ... <span class="hljs-string"><span class="hljs-string">$ </span></span>url : chr <span class="hljs-comment"><span class="hljs-comment">"https://lenta.ru/news/1999/08/31/stancia_mir/"</span></span> ... <span class="hljs-string"><span class="hljs-string">$ </span></span>datetime : chr <span class="hljs-comment"><span class="hljs-comment">"1999-09-01 01:58:40"</span></span> ... <span class="hljs-string"><span class="hljs-string">$ </span></span>rubric : chr <span class="hljs-comment"><span class="hljs-comment">""</span></span> ... <span class="hljs-string"><span class="hljs-string">$ </span></span>subrubric : chr <span class="hljs-type"><span class="hljs-type">NA</span></span> ... <span class="hljs-string"><span class="hljs-string">$ </span></span>title : chr <span class="hljs-comment"><span class="hljs-comment">"    \"</span></span>\<span class="hljs-comment"><span class="hljs-comment">"\"</span></span>\<span class="hljs-comment"><span class="hljs-comment">"\"</span></span>\<span class="hljs-comment"><span class="hljs-comment">"\"</span></span>\<span class="hljs-comment"><span class="hljs-comment">"\"</span></span>\<span class="hljs-comment"><span class="hljs-comment">"\"</span></span>\<span class="hljs-comment"><span class="hljs-comment">"\"</span></span>\<span class="hljs-comment"><span class="hljs-comment">"\"</span></span>\<span class="hljs-comment"><span class="hljs-comment">""</span></span> ... <span class="hljs-string"><span class="hljs-string">$ </span></span>authorLinks : chr <span class="hljs-type"><span class="hljs-type">NA</span></span> ... <span class="hljs-string"><span class="hljs-string">$ </span></span>additionalLinks : chr <span class="hljs-type"><span class="hljs-type">NA</span></span> ... <span class="hljs-string"><span class="hljs-string">$ </span></span>plaintextLinks : chr <span class="hljs-type"><span class="hljs-type">NA</span></span> ... <span class="hljs-string"><span class="hljs-string">$ </span></span>imageDescription : chr <span class="hljs-type"><span class="hljs-type">NA</span></span> ... <span class="hljs-string"><span class="hljs-string">$ </span></span>imageCreditsPerson : chr <span class="hljs-type"><span class="hljs-type">NA</span></span> ... <span class="hljs-string"><span class="hljs-string">$ </span></span>imageCreditsCompany : chr <span class="hljs-type"><span class="hljs-type">NA</span></span> ... <span class="hljs-string"><span class="hljs-string">$ </span></span>videoDescription : chr <span class="hljs-type"><span class="hljs-type">NA</span></span> ... <span class="hljs-string"><span class="hljs-string">$ </span></span>videoCredits : chr <span class="hljs-type"><span class="hljs-type">NA</span></span> ... <span class="hljs-string"><span class="hljs-string">$ </span></span><span class="hljs-type"><span class="hljs-type">FB</span></span> : int <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> ... <span class="hljs-string"><span class="hljs-string">$ </span></span><span class="hljs-type"><span class="hljs-type">VK</span></span> : int <span class="hljs-type"><span class="hljs-type">NA</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> ... <span class="hljs-string"><span class="hljs-string">$ </span></span><span class="hljs-type"><span class="hljs-type">OK</span></span> : int <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> ... <span class="hljs-string"><span class="hljs-string">$ </span></span><span class="hljs-type"><span class="hljs-type">Com</span></span> : int <span class="hljs-type"><span class="hljs-type">NA</span></span> <span class="hljs-type"><span class="hljs-type">NA</span></span> ... <span class="hljs-string"><span class="hljs-string">$ </span></span>stemedTitle : chr <span class="hljs-comment"><span class="hljs-comment">"   "</span></span> ... <span class="hljs-string"><span class="hljs-string">$ </span></span>stemedMetaDescription: chr <span class="hljs-comment"><span class="hljs-comment">"            "</span></span>| __truncated__ ... <span class="hljs-string"><span class="hljs-string">$ </span></span>stemedPlaintext : chr <span class="hljs-comment"><span class="hljs-comment">"            "</span></span>| __truncated__ ... - attr(*, <span class="hljs-comment"><span class="hljs-comment">".internal.selfref"</span></span>)=&lt;externalptr&gt;</code> </pre> <br><p>     .      .     ,    "",         .       <a href="https://github.com/ildarcheg/lenta"> </a> . </p><br><p>  PS <br>    : </p><br><ol><li>  "    "    ?          macOS, Linux, Windows? </li><li>        timestamp'  print("  N")? </li><li>     <code>2.7GHz i5, 16Gb Ram, SSD, macOS 10.12, R version 3.4.0</code>     <code>3.5GHz Xeon E-1240 v5, 32Gb, SSD, Windows Server 2012</code> ? </li><li>     ? </li><li>        "code smells"? </li></ol><br><p> PPS -           ,      ,    ,  ,         ,            . ‚Ä¶   . </p><br><h1 id="analiziruy-eto-lenta-analru-chast-2">  Analyze it. Lenta-anal.ru ( 2) </h1><br><h3 id="data-engineering">  Data Engineering </h3><br><p>  -  (    ) ,        .            ,     Linux Foundation Certified System Administrator (LFCS)   Sander van Vugt (,    ). 15       (   ,    Kernel   ).  ,             ,     .  ,          -  " -, ,    ,     .". </p><br><p>             .          2   2 ,       RStudio Server       .         ,  ,      .     ,      (                ). </p><br><p>   4 : </p><br><pre> <code class="hljs actionscript">DefCollections &lt;- <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ collections &lt;- c(<span class="hljs-string"><span class="hljs-string">"c01_daytobeprocessed"</span></span>, <span class="hljs-string"><span class="hljs-string">"c02_linkstobeprocessed"</span></span>, <span class="hljs-string"><span class="hljs-string">"c03_pagestobeprocessed"</span></span>, <span class="hljs-string"><span class="hljs-string">"c04_articlestobeprocessed"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>(collections) }</code> </pre> <br><p>  4 : </p><br><pre> <code class="hljs actionscript">DefScripts &lt;- <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ scripts &lt;- c(<span class="hljs-string"><span class="hljs-string">"01_days_process.R"</span></span>, <span class="hljs-string"><span class="hljs-string">"02_links_process.R"</span></span>, <span class="hljs-string"><span class="hljs-string">"03_pages_process.R"</span></span>, <span class="hljs-string"><span class="hljs-string">"04_articles_process.R"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>(scripts) }</code> </pre> <br><p>    : </p><br><ol><li>   <code>c01_daytobeprocessed</code>  ,    ,      <code>2010-01-10 - 2010-01-10</code> . </li><li>    <code>01_days_process.R</code> ,     <code>c01_daytobeprocessed</code> ,  ,             <code>c02_linkstobeprocessed</code> . </li><li>    <code>02_links_process.R</code> ,     <code>c02_linkstobeprocessed</code> ,  ,     ,   ,       <code>c03_pagestobeprocessed</code> . </li><li>    <code>03_pages_process.R</code> ,     <code>c03_pagestobeprocessed</code> ,       ,  ,  (  )     <code>c04_articlestobeprocessed</code> . </li></ol><br><p>  ,            (        )     ,   . ,    cron      ,     . ‚Ä¶        .       (    <code>c("1999-09-01", as.Date(Sys.time())</code> )      . </p><br><p>  ,    : </p><br><ol><li>   5   cron,    .      ,     80%,       <code>c01_daytobeprocessed</code> ,   10    <code>01_days_process.R</code> . </li><li>    ,   5      ,          80%,       100       . </li></ol><br><p><img src="https://habrastorage.org/webt/wz/5j/cy/wz5jcyqpclkeoqfu01nlaqwct5g.jpeg" alt="        "></p><br><p>  ,          <code>c("1999-09-01", as.Date(Sys.time())</code>   . ,   2   2     ,         16,    8.         , 700      ,         . </p><br><p>       ‚Äî           ,      . </p><br><p>       .     ,       CSV, ,  ,        . </p><br><p>     <a href="https://lenta-anal.ru/">LENTA-ANAL.RU</a> . </p><br><p>   ( 01-09-1999 ‚Äî 04-12-2017)    <a href="https://drive.google.com/open%3Fid%3D1NlFuOjOt0oQ9Mx70Z7ZvfOsB3-1fCALp">lenta-ru-data-set_19990901_20171204.zip</a> . </p><br><p>     *: </p><br><pre> <code class="hljs json">[ { <span class="hljs-attr"><span class="hljs-attr">"_id"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"$oid"</span></span>: <span class="hljs-string"><span class="hljs-string">"5a0b067b537f258f034ffc51"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"link"</span></span>: <span class="hljs-string"><span class="hljs-string">"https://lenta.ru/news/2017/11/14/cazino/"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"linkDate"</span></span>: <span class="hljs-string"><span class="hljs-string">"20171114"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"status"</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-attr"><span class="hljs-attr">"updated_at"</span></span>: <span class="hljs-string"><span class="hljs-string">"20171204154248 ICT"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"process"</span></span>: <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-attr"><span class="hljs-attr">"page"</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">"urlKey"</span></span>: <span class="hljs-string"><span class="hljs-string">"httpslentarunews20171114cazino"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"url"</span></span>: <span class="hljs-string"><span class="hljs-string">"https://lenta.ru/news/2017/11/14/cazino/"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"metaTitle"</span></span>: <span class="hljs-string"><span class="hljs-string">"      "</span></span>, <span class="hljs-attr"><span class="hljs-attr">"metaType"</span></span>: <span class="hljs-string"><span class="hljs-string">"article"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"metaDescription"</span></span>: <span class="hljs-string"><span class="hljs-string">"17 ,    ‚Äî      ,         .   260 ¬´ ¬ª,       .      ."</span></span>, <span class="hljs-attr"><span class="hljs-attr">"datetime"</span></span>: <span class="hljs-string"><span class="hljs-string">"2017-11-14 17:40:00"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"datetimeString"</span></span>: <span class="hljs-string"><span class="hljs-string">" 17:40, 14  2017"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"plaintext"</span></span>: <span class="hljs-string"><span class="hljs-string">"         (),         .    , 14 ,  ¬´.¬ª        ()  .   ,       2015   , 51-    33-  .          15 ,         .  , ,   ,             66  .     ,   ,          ,   260   ,    ,    ,  ,     .     12 ,      ,        .        ¬´.¬ª,         ,       .  ,       200    .      ¬´     ,   ,        ¬ª (171.2  )  ¬´  ¬ª (210  ).   ¬´.¬ª    ,                .        .      31       ,     .     .  1  2009                 ."</span></span>, <span class="hljs-attr"><span class="hljs-attr">"imageCreditsPerson"</span></span>: <span class="hljs-string"><span class="hljs-string">" "</span></span>, <span class="hljs-attr"><span class="hljs-attr">"imageCreditsCompany"</span></span>: <span class="hljs-string"><span class="hljs-string">" "</span></span>, <span class="hljs-attr"><span class="hljs-attr">"dateToUse"</span></span>: <span class="hljs-string"><span class="hljs-string">"20171114"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"rubric"</span></span>: <span class="hljs-string"><span class="hljs-string">" "</span></span>, <span class="hljs-attr"><span class="hljs-attr">"subrubric"</span></span>: <span class="hljs-string"><span class="hljs-string">"  "</span></span>, <span class="hljs-attr"><span class="hljs-attr">"stemedTitle"</span></span>: <span class="hljs-string"><span class="hljs-string">"     "</span></span>, <span class="hljs-attr"><span class="hljs-attr">"stemedMetaDescription"</span></span>: <span class="hljs-string"><span class="hljs-string">"17                   260              "</span></span>, <span class="hljs-attr"><span class="hljs-attr">"stemedPlaintext"</span></span>: <span class="hljs-string"><span class="hljs-string">"                 14                   2015    51   33        15                     66                260                   12                                   200                      1712      210                             31            1  2009              "</span></span> } ], <span class="hljs-attr"><span class="hljs-attr">"social"</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">"FB"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-attr"><span class="hljs-attr">"VK"</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-attr"><span class="hljs-attr">"OK"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-attr"><span class="hljs-attr">"Com"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span> } ], <span class="hljs-attr"><span class="hljs-attr">"comments"</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">"id"</span></span>: <span class="hljs-number"><span class="hljs-number">30154446</span></span>, <span class="hljs-attr"><span class="hljs-attr">"hasLink"</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-attr"><span class="hljs-attr">"hasGreyWord"</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-attr"><span class="hljs-attr">"text"</span></span>: <span class="hljs-string"><span class="hljs-string">"     .     ,      ,    . ,            .  , ,    ,        .       ,     ;    , ‚Äî        .  ,     ,    ,   , ,  ,              ...\n\n  ‚Äî     "</span></span>, <span class="hljs-attr"><span class="hljs-attr">"moderation"</span></span>: <span class="hljs-string"><span class="hljs-string">"approved"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"createdAt"</span></span>: <span class="hljs-string"><span class="hljs-string">"2017-11-14 23:10:31"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"sessionSourceIcon"</span></span>: <span class="hljs-string"><span class="hljs-string">"livejournal"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"userId"</span></span>: <span class="hljs-number"><span class="hljs-number">2577791</span></span>, <span class="hljs-attr"><span class="hljs-attr">"userpic"</span></span>: <span class="hljs-string"><span class="hljs-string">"https://avatars-c.rambler.ru/ca/v3/c/av/6d3dcf4b71dfde1edcfe149198747a48099f867369dfdb4ad8e2be69e41e2276b288a819cb98d3f3dafd72e1a2d46bf6529d74e4d245e4ada673fc057a48bfd5ba3c2f1d1f39fc57c9ec3d3f3a0ea8d1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"displayName"</span></span>: <span class="hljs-string"><span class="hljs-string">"vladtmb"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"level"</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-attr"><span class="hljs-attr">"childrenCount"</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-attr"><span class="hljs-attr">"hasChild"</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-attr"><span class="hljs-attr">"stemedText"</span></span>: <span class="hljs-string"><span class="hljs-string">"                                                                           "</span></span> } ] } ]</code> </pre> <br><p> *      ,    sample (100 )     </p><br><p> ,  -         .      ,     . <br></p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/343838/">https://habr.com/ru/post/343838/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../343828/index.html">Writing a simple Linux kernel module</a></li>
<li><a href="../343830/index.html">Dependency injection in .Net Mark Siman 1 - Dependencies between application layers</a></li>
<li><a href="../343832/index.html">Designing a system for reading data from input devices (Part Two)</a></li>
<li><a href="../343834/index.html">Introduction to reinforcement training: from a multi-armed gangster to a full-fledged RL agent</a></li>
<li><a href="../343836/index.html">EU GDPR: Compliance with the requirements of regulators in the field of cloud computing</a></li>
<li><a href="../343840/index.html">Renga development team: how we reached the idyll, working without managers</a></li>
<li><a href="../343842/index.html">WD (Western Digital) plans to create a 40 TB disk, but is this enough?</a></li>
<li><a href="../343844/index.html">How programmers with PVS-Studio looked for project errors</a></li>
<li><a href="../343846/index.html">.Net Core bots for Telegram, Slack and Facebook</a></li>
<li><a href="../343848/index.html">Gifts from M.Video: what's under the hood?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>