<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Go language. We write the CHIP-8 emulator</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Go recently celebrated the first year of his life. The CHIP-8 interpreter has already turned forty. 
 This post is dedicated to lovers of new language...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Go language. We write the CHIP-8 emulator</h1><div class="post__text post__text-html js-mediator-article">  <a href="http://golang.org/">Go</a> recently celebrated the first year of his life.  The <a href="http://chip8.com/">CHIP-8</a> interpreter has already turned forty. <br>  This post is dedicated to lovers of new languages ‚Äã‚Äãand old iron - in it we will write the CHIP-8 virtual machine emulator in the Go language. <br><br>  How to set up the environment to work with Go <a href="http://habrahabr.ru/blogs/webdev/102523/">wrote</a> <a href="http://habrahabr.ru/blogs/google/75025/">more</a> <a href="http://habrahabr.ru/blogs/programming/74913/">than once</a> .  Recently, little has changed, except that the <a href="http://code.google.com/p/gomingw/downloads/list">Windows version</a> has become more stable. <br>  Having installed everything according to the instructions, proceed to the study of the interior of CHIP-8. <a name="habracut"></a><br><br><h4>  Story </h4><br>  CHIP-8-based game consoles are notable for being among the first virtual machines in history. <br>  Programs for CHIP-8 are not executed on a real processor, but are interpreted.  Moreover, the original interpreter occupied only 512 bytes. <br>  The characteristics of CHIP-8 are impressively modest: an 8-bit processor with a frequency of a couple of megahertz, 4 KB of RAM (the program code is also stored in RAM), a 32x64 monochrome screen, two timers - one for timing, another for playing sound (‚Äútweeters‚Äù ). <br>  Despite all the flaws, the CHIP-8 has enough power to launch Space Invaders, Pong and other old school games. <br>  Programs for CHIP-8 are written on a specific assembler.  The whole language consists of <a href="http://howtoemulation.netfirms.com/extra_pages/chip8_instruction_set.shtml">35 commands</a> - arithmetic, conditional / unconditional jumps, input / output (working with the display, keyboard, sound). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Project structure </h4><br>  Our emulator will consist of a single c8emu.go file ... <br><pre> <code class="hljs perl">//   <span class="hljs-string"><span class="hljs-string">""</span></span>   Go <span class="hljs-keyword"><span class="hljs-keyword">package</span></span> main func main() { }</code> </pre><br>  ... and Makefile: <br><pre> <code class="hljs pgsql">#  Makefile   Go <span class="hljs-keyword"><span class="hljs-keyword">include</span></span> $(GOROOT)/src/Make.inc TARG=c8emu GOFILES=c8emu.go <span class="hljs-keyword"><span class="hljs-keyword">include</span></span> $(GOROOT)/src/Make.cmd</code> </pre><br>  To make it easier to understand the source below, I remind you that: <br><ul><li>  dots with commas in Go are optional, parentheses in for / if statements are also.  The rest of the language is similar to C / Java.  Variables in Go can be declared in several ways (yes, overwhelm versus C): <br> <code>var i int <br> var i int = 0 <br> i := 0</code> </li> <li>  for cycles there is only one operator - for <br> <code>for i:=0; i&lt;10; i++ { .. } <br> for cond == true { ... } <br> for { }</code> </li> <li>  You can perform actions and check its result in one statement: <br> <code>if err = DoSomethin(); err != nil { fmt.Println("Error: "+err) }</code> </li> <li>  private / public methods and attributes differ only in case: <br> <code>someMethod() //  <br> SomeMethod() //  <br></code> </li></ul><br>  Of course, the language features are much more, and they all seem unusual, but do not judge strictly.  The language is just different. <br><br>  So, to emulate CHIP-8, we need the appropriate class (there are no classes in Go, but there are structures with fields and methods for working with the structure): <br><pre> <code class="hljs haskell"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Chip8</span></span></span><span class="hljs-class"> struct { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">memory</span></span></span><span class="hljs-class"> []</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">byte</span></span></span><span class="hljs-class"> // </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">memory</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">address</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">is</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">in</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">range</span></span></span><span class="hljs-class">: 0</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">x200</span></span></span><span class="hljs-class">...0</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">xfff</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">regs</span></span></span><span class="hljs-class"> [16]</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">byte</span></span></span><span class="hljs-class"> // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CHIP</span></span></span><span class="hljs-class">-8 </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">has</span></span></span><span class="hljs-class"> 16 8-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bit</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">registers</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ireg</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">uint16</span></span></span><span class="hljs-class"> // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">I</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">reg</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">was</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">a</span></span></span><span class="hljs-class"> 16-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bit</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">register</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">for</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">memory</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">operations</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">stack</span></span></span><span class="hljs-class"> [16]</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">uint16</span></span></span><span class="hljs-class"> // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Stack</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">up</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to</span></span></span><span class="hljs-class"> 16 </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">levels</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">of</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nesting</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">sp</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Stack</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">pointer</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">pc</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">uint16</span></span></span><span class="hljs-class"> // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Program</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">counter</span></span></span><span class="hljs-class"> }</span></span></code> </pre><br>  This structure describes the interiors of CHIP-8: a memory block, 16 eight-bit registers, register-pointer I, a stack of 16 nesting levels, as well as a command counter and a stack pointer. <br><br><h4>  Emulator Initialization </h4><br>  To create our CHIP-8 object, write the <code>NewChip8()</code> function: <br><pre> <code class="hljs swift"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">NewChip8</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> (<span class="hljs-built_in"><span class="hljs-built_in">c</span></span> *<span class="hljs-type"><span class="hljs-type">Chip8</span></span>) { <span class="hljs-built_in"><span class="hljs-built_in">c</span></span> = new(<span class="hljs-type"><span class="hljs-type">Chip8</span></span>); <span class="hljs-comment"><span class="hljs-comment">//     c.memory = make([]byte, 0xfff) //  "" ( )   c.sp = 0 c.pc = 0x200 //   CHIP-8    0x200 c.ireg = 0 //        return c }</span></span></code> </pre><br>  To load the program code into the CHIP-8 interpreter, write the Load () method.  Methods in Go are described in the same way as functions: <br><pre> <code class="hljs lua">func (c *Chip8) Load(rom []<span class="hljs-built_in"><span class="hljs-built_in">byte</span></span>) (err <span class="hljs-built_in"><span class="hljs-built_in">os</span></span>.Error) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-built_in"><span class="hljs-built_in">len</span></span>(rom) &gt; <span class="hljs-built_in"><span class="hljs-built_in">len</span></span>(c.memory) - <span class="hljs-number"><span class="hljs-number">0x200</span></span> { //  <span class="hljs-built_in"><span class="hljs-built_in">len</span></span>    (- ) err = <span class="hljs-built_in"><span class="hljs-built_in">os</span></span>.NewError(<span class="hljs-string"><span class="hljs-string">"ROM is too large!"</span></span>) // -    <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> } copy(c.memory[<span class="hljs-number"><span class="hljs-number">0x200</span></span>:], rom) //     <span class="hljs-number"><span class="hljs-number">0</span></span><span class="hljs-number"><span class="hljs-number">200</span></span> err = <span class="hljs-literal"><span class="hljs-literal">nil</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> }</code> </pre><br><h4>  Processing instructions </h4><br>  The Step () method allows you to perform a separate CHIP-8 instruction.  All instructions are 2-byte.  Opcodes are more or less structured, although certainly not as in ARM ... Mostly you can navigate by the older 4 bits of the code. <br><pre> <code class="hljs lua">func (c *Chip8) Step() (err <span class="hljs-built_in"><span class="hljs-built_in">os</span></span>.Error) { var op uint16 //      <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (c.pc &gt;= uint16(<span class="hljs-built_in"><span class="hljs-built_in">len</span></span>(c.memory))) { err = <span class="hljs-built_in"><span class="hljs-built_in">os</span></span>.EOF <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> } //     op = (uint16(c.memory[c.pc]) &lt;&lt; <span class="hljs-number"><span class="hljs-number">8</span></span>) | uint16(c.memory[c.pc + <span class="hljs-number"><span class="hljs-number">1</span></span>]) switch (op &amp; <span class="hljs-number"><span class="hljs-number">0xf000</span></span>) &gt;&gt; <span class="hljs-number"><span class="hljs-number">12</span></span> { case ... /*       */ default: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">os</span></span>.NewError(<span class="hljs-string"><span class="hljs-string">"Illelal instruction"</span></span>) } c.pc += <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> }</code> </pre><br>  Most of the instructions are rather trivial: <br><pre> <code class="hljs pgsql">// JMP addr - jump <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> address <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">0x1</span></span>: c.pc = op &amp; <span class="hljs-number"><span class="hljs-number">0xfff</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> // SKEQ reg, <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> - skip <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> register equals <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">0x3</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> c.regs[(op &amp; <span class="hljs-number"><span class="hljs-number">0x0f00</span></span>) &gt;&gt; <span class="hljs-number"><span class="hljs-number">8</span></span>] == byte(op &amp; <span class="hljs-number"><span class="hljs-number">0xff</span></span>) { c.pc += <span class="hljs-number"><span class="hljs-number">2</span></span> // skip one instruction } // SKNE reg, <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> - skip <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> equal <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">0x4</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> c.regs[(op &amp; <span class="hljs-number"><span class="hljs-number">0x0f00</span></span>) &gt;&gt; <span class="hljs-number"><span class="hljs-number">8</span></span>] != byte(op &amp; <span class="hljs-number"><span class="hljs-number">0xff</span></span>) { c.pc += <span class="hljs-number"><span class="hljs-number">2</span></span> // skip one instruction } // MOV reg, <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">0x6</span></span>: c.regs[(op &amp; <span class="hljs-number"><span class="hljs-number">0x0f00</span></span>) &gt;&gt; <span class="hljs-number"><span class="hljs-number">8</span></span>] = byte(op &amp; <span class="hljs-number"><span class="hljs-number">0xff</span></span>) // MVI addr -   - I <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">0xa</span></span>: c.ireg = op &amp; <span class="hljs-number"><span class="hljs-number">0xfff</span></span> // RAND reg, max -      <span class="hljs-number"><span class="hljs-number">0.</span></span>.max <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">0xc</span></span>: c.regs[(op &amp; <span class="hljs-number"><span class="hljs-number">0x0f00</span></span>) &gt;&gt; <span class="hljs-number"><span class="hljs-number">8</span></span>] = byte(rand.Intn(<span class="hljs-type"><span class="hljs-type">int</span></span>(op &amp; <span class="hljs-number"><span class="hljs-number">0xff</span></span>)))</code> </pre><br>  Arithmetic and logical instructions are handled similarly. <br>  Handling the procedure call and exit is also pretty easy: <br><pre> <code class="hljs bash">// RET -    ( 00EE) <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> 0x0: switch op &amp; 0xff { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> 0xee: c.sp-- c.pc = c.stack[c.sp] <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> } // CALL addr -     <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> 0x2: c.stack[c.sp] = c.pc + 2 c.sp++ c.pc = op &amp; 0xfff <span class="hljs-built_in"><span class="hljs-built_in">return</span></span></code> </pre><br>  I will not describe all instructions here.  I will dwell on the three most important ones (they are used in almost any game) - working with a timer and displaying images on the screen. <br><br><h4>  Timer </h4><br>  The timer runs at 60 Hz, you can enter a number (one byte), and it will decrease by 1 with each ‚Äútick‚Äù. <br>  The timer can be periodically read and see how many ‚Äúticks‚Äù have passed since its launch.  Below zero the timer value cannot go away. <br>  This is what happens: <br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">type</span></span> Timer struct { <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> byte //      <span class="hljs-keyword"><span class="hljs-keyword">start</span></span> int64 //   period int64 //    "" } //    func NewTimer(hz <span class="hljs-type"><span class="hljs-type">int</span></span>) (t *Timer) { t = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span>(Timer) t.period = int64(<span class="hljs-number"><span class="hljs-number">1000000000</span></span>/hz) t.<span class="hljs-keyword"><span class="hljs-keyword">value</span></span> = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> t } //  func (t *Timer) <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">value</span></span> byte) { t.<span class="hljs-keyword"><span class="hljs-keyword">value</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> t.start = <span class="hljs-type"><span class="hljs-type">time</span></span>.Nanoseconds() } //   func (t *Timer) <span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>() byte { delta := (<span class="hljs-type"><span class="hljs-type">time</span></span>.Nanoseconds() - t.<span class="hljs-keyword"><span class="hljs-keyword">start</span></span>) / t.period <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> int64(t.<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>) &gt; delta { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> t.<span class="hljs-keyword"><span class="hljs-keyword">value</span></span> - byte(delta) } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> }</code> </pre><br>  Add a timer field to the Chip8 structure and initialize it when creating a Chip8 object: <br><pre> <code class="hljs haskell"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Chip8</span></span></span><span class="hljs-class"> struct { ... </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">timer</span></span></span><span class="hljs-class"> *</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Timer</span></span></span><span class="hljs-class"> ... } func </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NewChip8</span></span></span><span class="hljs-class">() (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">c</span></span></span><span class="hljs-class"> *</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Chip8</span></span></span><span class="hljs-class">) { ... </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">c</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">timer</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NewTimer(60)</span></span></span><span class="hljs-class"> .. } case 0xf: switch (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">op</span></span></span><span class="hljs-class"> &amp; 0</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">xff</span></span></span><span class="hljs-class">) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> 0</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">x07</span></span></span><span class="hljs-class">: //    </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">c</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">regs</span></span></span><span class="hljs-class">[(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">op</span></span></span><span class="hljs-class"> &amp; 0</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">x0f00</span></span></span><span class="hljs-class">) &gt;&gt; 8] = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">c</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">timer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Get</span></span></span><span class="hljs-class">() </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> 0</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">x15</span></span></span><span class="hljs-class">: //   </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">c</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">timer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Set</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">c</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">regs</span></span></span><span class="hljs-class">[(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">op</span></span></span><span class="hljs-class"> &amp; 0</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">x0f00</span></span></span><span class="hljs-class">) &gt;&gt; 8]) }</span></span></code> </pre><br><h4>  Display </h4><br>  There is only one instruction to display the image on the screen.  The CHIP-8 graphics are based on the concept of the sprite.  All sprites of the same width - 8 pixels, differ only in height. <br>  For example, a sprite that draws a cross looks like a sequence of five bytes: <br><pre> <code class="hljs">0x88 ; 10001000 0x50 ; 01010000 0x20 ; 00100000 0x50 ; 01010000 0x88 ; 10001000</code> </pre><br>  Before output, you must specify the address of the beginning of the sprite, setting the value of register I accordingly. <br>  To display the sprite on the screen, you need to enter the coordinates in any two registers and call the draw statement, in which you specify the height of the sprite: <br><pre> <code class="hljs">mvi x_sprite mov v0, 10 mov v1, 15 draw v0, v1, 5 ;    5    (10,15) x_sprite: db 0x88, 0x50, 0x20, 0x50, 0x88</code> </pre><br>  But draw doesn't just draw, it does XOR existing pixels with sprite pixels.  This is convenient - to erase the sprite it can be displayed again in the same coordinates. <br>  In addition, if one of the pixels was reset to 0, draw sets the value of the vf register (usually used as a flag register) to one. <br>  Add a video buffer array to the Chip8 structure: screen [64 * 32] bool and write a function for drawing: <br><pre> <code class="hljs go">c.regs[<span class="hljs-number"><span class="hljs-number">0xf</span></span>] = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> col:=<span class="hljs-number"><span class="hljs-number">0</span></span>; col&lt;<span class="hljs-number"><span class="hljs-number">8</span></span>; col++ { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> row:=<span class="hljs-number"><span class="hljs-number">0</span></span>; row&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>(size); row++ { px := <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>(x) + col py := <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>(y) + row bit := (c.memory[c.ireg + <span class="hljs-keyword"><span class="hljs-keyword">uint16</span></span>(row)] &amp; (<span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; <span class="hljs-keyword"><span class="hljs-keyword">uint</span></span>(col))) != <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (px &lt; <span class="hljs-number"><span class="hljs-number">64</span></span> &amp;&amp; py &lt; <span class="hljs-number"><span class="hljs-number">32</span></span> &amp;&amp; px &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span> &amp;&amp; py &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) { src := c.screen[py*<span class="hljs-number"><span class="hljs-number">64</span></span> + px] dst := (bit != src) <span class="hljs-comment"><span class="hljs-comment">// ,  XOR      c.screen[py*64 + px] = dst if (src &amp;&amp; !dst) { c.regs[0xf] = 1 } } } }</span></span></code> </pre><br>  In order to somehow test the resulting emulator, I output the contents of the video buffer directly to the terminal.  <a href="http://mattmik.com/cosmac/cosmac-vip/programming-in-chip-8/">This</a> program was used.  To my surprise, she earned and started drawing tic-tac-toe treadmills: <br><img src="http://img35.imageshack.us/img35/334/20101209164513524x396sc.png" alt="image"><br><br><h4>  What's next? </h4><br>  Actually, I really like the CHIP-8 platform.  No practical use, but brains can be trained on it.  I started the <a href="http://bitbucket.org/zserge/c8kit">c8kit</a> project - I plan to include an emulator, an assembler and a disassembler in it. <br>  I think I should fasten the graphics and keyboard using SDL (Go successfully supports it).  Synchronizing the interface module and the CHIP-8 core would be convenient using the Go channels. <br>  I hope it will be interesting! </div><p>Source: <a href="https://habr.com/ru/post/109862/">https://habr.com/ru/post/109862/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../109854/index.html">Facebook</a></li>
<li><a href="../109856/index.html">Updated Gmail app for Android</a></li>
<li><a href="../109857/index.html">What can you learn from search engines</a></li>
<li><a href="../109859/index.html">Drupal 7.0 RC 2 released</a></li>
<li><a href="../109860/index.html">MTS unknowingly revealed the principles of mobile operators</a></li>
<li><a href="../109864/index.html">MODx Revolution 2.0.5 released</a></li>
<li><a href="../109867/index.html">Playstation Phone due out in March 2011</a></li>
<li><a href="../109869/index.html">Bulbulator tracker. PCB etching accelerator</a></li>
<li><a href="../109870/index.html">How to open a department of an online store in a mall or why we are now standing next to the department of PocketBook</a></li>
<li><a href="../109871/index.html">Which forum engine do you prefer?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>