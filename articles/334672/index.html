<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>JetBrains MPS for those interested # 3</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Bingo Bongo and Jimbo Jumbo, dear friends! 


 I had no light for 2 days at the dacha, I was practically a witch and went into hibernation, but here I...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>JetBrains MPS for those interested # 3</h1><div class="post__text post__text-html js-mediator-article"><h1 id="bingo-bongo-i-dzhimbo-dzhambo-dorogie-druzya">  Bingo Bongo and Jimbo Jumbo, dear friends! </h1><br><p>  I had no light for 2 days at the dacha, I was practically a witch and went into hibernation, but here I am again!  In this post, we will start writing weather predictions and <em>write a</em> little <em>code, rather than poking it with a mouse</em> !  Hooray!  Finally! </p><br><h2 id="kakie-prognozy-my-hotim-delat">  What predictions do we want to make </h2><br><p>  Very simple!  For now, we will only forecast the next day, and think up the rules ourselves;  rather, the rules will not be.  We will simply display the temperature the next day, absolutely the same as today.  Let's make one prikolchik, demonstrating the possibilities of projectional editor. </p><br><h2 id="koncepty">  Concepts </h2><br><p>  In this case, we will resort to a cool feature - we will create a concept that will contain only a link to the original data, and we will output the data as a graph on our Swing component.  About how we can, although I do not like swinging horror. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/d79/393/b48/d79393b48de7f406bcb708c4db07a514.png" alt="image"></p><a name="habracut"></a><br><p>  Create a <em>PredictionResult</em> concept, add reference "input" to it, which is a link to the concept implementation in the current scope of AST!  But since we do not need scopes, or <em>scope</em> , then we‚Äôll get to search for all elements of this type. (By the way, <em>Scopes</em> is not the easiest topic in MPS + for it is quite complicated documentation, sometimes incomprehensible, so I‚Äôll roll over an article about <em>Scope</em> Someday.) But now you need to add authentication for <em>WeatherData</em> , change the structure and the <em>Editor</em> aspect a bit. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/375/bbf/c73/375bbfc735f44fd58aaae646f2eaedbf.png" alt="image"><br><br>  I added <em>INamedConcept</em> after <strong>implements</strong> , and now our <em>WeatherData</em> concept has a name, but we don‚Äôt give it a name, so we‚Äôll change the <em>Editor</em> . </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/760/3a1/368/7603a13682242657985b996cd8c6f89b.png" alt="image"><br><br>  Here we just added 1 line, which will contain the name.  Reassemble the language and see what happened. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/f63/21c/c3c/f6321cc3cee4154b31a90991595126cf.png" alt="image">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Hurray, now call this <em>WeatherData</em> named "today" and return to the concept of <em>PredictionResult</em> and change its <em>Editor</em> aspect. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/0c2/da4/05a/0c2da405aeef17531764859e24cf856a.png" alt="image"><br><br>  Let it be for now.  We will have <em>Prediction for tommorow, data% name_of_weather_data%</em> <br>  Add a concept to <em>PredictionList</em> - our root concept, where only input data is still available. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/95d/a9c/016/95da9c01695daa98a10d5cec2c66e83b.png" alt="image"></p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/85a/636/852/85a6368521501973b716c6cf021a7332.png" alt="image"></p><br><p>  If you collect, you get </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/374/994/b9c/374994b9cd646c355d7fa0883559a9f9.png" alt="image"><br><br>  ... just what we wanted.  We can choose <em>WeatherData</em> from the list (it's okay that we only have 1 WeatherData, but it‚Äôs expandable). </p><br><p>  Great, now we need to somehow cool to display our forecasts.  I have already written that we will output them on the swing component, if anyone does not know - <em>javax.swing.</em>  - package for the development of native graphical interfaces in Java.  It is built IntelliJ.  Swing components can be used in the editor.  Urya. </p><br><p>  Before you draw the whole thing, write out the points, how we act. </p><br><ol><li><p>  We take the width of the graph in pixels and divide it by 60 * 24 - the number of minutes per day.  This is necessary in order to correctly display the points on the x-axis. </p><br></li><li><p>  We translate all temperatures into one unit of measurement, for example, Celsius (then we adjust it so that we can choose, show in Celsius or in Fahrenheit) and find the highest temperature and the lowest.  Subtract the smallest from the largest and get the full "height" in degrees.  The bottom line is that if we divide the height of the graph by this value, we get how many "pixels in one degree."  This is required in order to project temperatures on a graph. </p><br></li><li><p>  We sort the array of input data by time (the closer to 00:00 - the less, of course) and pass through it.  We calculate <em>x</em> by the formula </p><br><p><math> </math> $$ display $$ time_in_minutes * coefficient_ of_point_1 $$ display $$ </p><br><p>  a <em>y</em> </p><br><p><math> </math> $$ display $$ temperature * coefficient __ from __ item 2 $$ display $$ </p><br><p>  PS formula is terrible </p><br></li><li>  We draw! </li></ol><br><p>  In order not to torment you with a phased writing of lines, I will throw off the whole and go through more or less difficult places. </p><br><pre><code class="java hljs">{ <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> chartWidth = <span class="hljs-number"><span class="hljs-number">400</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> chartHeight = <span class="hljs-number"><span class="hljs-number">200</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> JPanel panel = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> JPanel() { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">paintComponent</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Graphics graphics)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.paintComponent(graphics); editorContext.getRepository().getModelAccess().runReadAction(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Runnable() { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ string unit = node.unit; <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> list&lt;Point2D.Double&gt; labels = node.input.items.where({~it =&gt; !it.temperature.concept.isAbstract(); }).select({~it =&gt; message debug <span class="hljs-string"><span class="hljs-string">"Woaw!"</span></span> + it.temperature.concept.isAbstract(), &lt;no project&gt;, &lt;no throwable&gt;; <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> x = it.time.hours * <span class="hljs-number"><span class="hljs-number">60</span></span> + it.time.minutes; <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> y = it.temperature.getValueFromUnit(unit.toString()); <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Point2D.Double(x, y); }).sortBy({~it =&gt; it.x; }, asc).toList; <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> minTemp = labels.sortBy({~it =&gt; it.y; }, asc).first.y; <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> maxTemp = labels.sortBy({~it =&gt; it.y; }, asc).last.y; <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> yKoef = chartHeight / (maxTemp - minTemp); <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> xKoef = chartWidth / (<span class="hljs-number"><span class="hljs-number">60.0</span></span> * <span class="hljs-number"><span class="hljs-number">24.0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> prevY = chartHeight; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> prevX = -<span class="hljs-number"><span class="hljs-number">1</span></span>; Graphics2D g2 = ((Graphics2D) graphics); labels.forEach({~it =&gt; message debug unit + <span class="hljs-string"><span class="hljs-string">"/"</span></span> + it.y, &lt;no project&gt;, &lt;no throwable&gt;; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> xTranslated = (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>) (it.x * xKoef); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> yTranslated = chartHeight - (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>) ((it.y - minTemp) * yKoef); g2.setStroke(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BasicStroke(<span class="hljs-number"><span class="hljs-number">1</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (prevX &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-comment"><span class="hljs-comment">// It is first element, no need to draw trailing line g2.drawLine(prevX, prevY, xTranslated, yTranslated); } g2.drawString(String.format("%.2f", it.y) + unit, xTranslated + 3, chartHeight - Math.abs(chartHeight - (yTranslated + 20))); g2.setStroke(new BasicStroke(5)); g2.drawLine(xTranslated, yTranslated, xTranslated, yTranslated); prevX = xTranslated; prevY = yTranslated; }); } }); } }; panel.setPreferredSize(new Dimension(chartWidth, chartHeight)); return panel; }</span></span></code> </pre> <br><p>  The first thing that catches the eye is <code>editorContext.getRepository().getModelAccess().runReadAction...</code> </p><br><p>  This is such a feature of the MPS editor: in order to access the model / node from anywhere, we need to request the execution of this code.  This is similar to <code>runOnUIThread</code> in android, the meaning is about the same.  In short, if you need to get something from the main thread, then you need to do it that way.  There is <code>runWriteAction</code> , it is needed for making changes and we still need it. </p><br><p>  What happens inside: </p><br><p>  1) We define the units <br>  2) Determine the width and height of the chart <br>  3) Transform an array of type <em>WeatherTimedData</em> into a list of type <em>java.awt.geom.Point2D.Double</em> , where </p><br><p></p><p><math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><div class="MathJax_SVG_Display" style="text-align: center;"><span class="MathJax_SVG" id="MathJax-Element-3-Frame" tabindex="0" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;><mi>x</mi><mo>=</mo><mi>h</mi><mi>o</mi><mi>u</mi><mi>r</mi><mi>s</mi><mo>&amp;#x2217;</mo><mn>60</mn><mo>+</mo><mi>m</mi><mi>i</mi><mi>n</mi><mi>u</mi><mi>t</mi><mi>e</mi><mi>s</mi></math>" role="presentation" style="font-size: 100%; display: inline-block; position: relative;"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="26.304ex" height="2.178ex" viewBox="0 -780.1 11325.4 937.7" role="img" focusable="false" style="vertical-align: -0.366ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/334672/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjSJB1VTBh6vUmpIfQv-eovSa9LBA#MJMATHI-78" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/334672/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjSJB1VTBh6vUmpIfQv-eovSa9LBA#MJMAIN-3D" x="850" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/334672/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjSJB1VTBh6vUmpIfQv-eovSa9LBA#MJMATHI-68" x="1906" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/334672/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjSJB1VTBh6vUmpIfQv-eovSa9LBA#MJMATHI-6F" x="2483" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/334672/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjSJB1VTBh6vUmpIfQv-eovSa9LBA#MJMATHI-75" x="2968" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/334672/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjSJB1VTBh6vUmpIfQv-eovSa9LBA#MJMATHI-72" x="3541" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/334672/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjSJB1VTBh6vUmpIfQv-eovSa9LBA#MJMATHI-73" x="3992" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/334672/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjSJB1VTBh6vUmpIfQv-eovSa9LBA#MJMAIN-2217" x="4684" y="0"></use><g transform="translate(5407,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/334672/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjSJB1VTBh6vUmpIfQv-eovSa9LBA#MJMAIN-36"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/334672/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjSJB1VTBh6vUmpIfQv-eovSa9LBA#MJMAIN-30" x="500" y="0"></use></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/334672/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjSJB1VTBh6vUmpIfQv-eovSa9LBA#MJMAIN-2B" x="6630" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/334672/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjSJB1VTBh6vUmpIfQv-eovSa9LBA#MJMATHI-6D" x="7630" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/334672/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjSJB1VTBh6vUmpIfQv-eovSa9LBA#MJMATHI-69" x="8509" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/334672/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjSJB1VTBh6vUmpIfQv-eovSa9LBA#MJMATHI-6E" x="8854" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/334672/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjSJB1VTBh6vUmpIfQv-eovSa9LBA#MJMATHI-75" x="9455" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/334672/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjSJB1VTBh6vUmpIfQv-eovSa9LBA#MJMATHI-74" x="10027" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/334672/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjSJB1VTBh6vUmpIfQv-eovSa9LBA#MJMATHI-65" x="10389" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/334672/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjSJB1VTBh6vUmpIfQv-eovSa9LBA#MJMATHI-73" x="10855" y="0"></use></g></svg><span class="MJX_Assistive_MathML MJX_Assistive_MathML_Block" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><mi>x</mi><mo>=</mo><mi>h</mi><mi>o</mi><mi>u</mi><mi>r</mi><mi>s</mi><mo>‚àó</mo><mn>60</mn><mo>+</mo><mi>m</mi><mi>i</mi><mi>n</mi><mi>u</mi><mi>t</mi><mi>e</mi><mi>s</mi></math></span></span></div><script type="math/tex;mode=display" id="MathJax-Element-3"> x = hours * 60 + minutes </script></p><br><p>  and <em>y</em> = temperature in the selected measurement, for example, in Celsius. </p><br><p>  We use the <em>baseLanguage</em> syntax, which makes working with collections easier and allows for the normal use of various patterns, such as <em>map</em> , <em>filter</em> , <em>flatMap</em> .  Naturally, <br>  instead of the usual names, <em>select</em> , <em>where</em> , <em>selectMany are used,</em> respectively. </p><br><p>  Attention!  A piece of code that is responsible for filtering <em>WeatherTimedData</em> , namely <code>where({~it =&gt; !it.temperature.concept.isAbstract(); })</code> - when we initialize a new <em>WeatherTimedData</em> , then our temperature is not initialized.  That is, we have no default in Celsius or Fahrenheit, so we have an abstract temperature, and if we didn‚Äôt add this filtering, then our editor would hang.  Here it is, experience! </p><br><p>  4) We obtain the upper and lower limits of temperature, then we get the very "coefficients" for the projections on the axes <br>  5) Drawing on the component is a very simple part.  If we draw the first point - we draw only a point and a signature about the temperature, if we draw NOT the first - we draw a line between the previous and current points.  Well, plus all sorts of visual prikolchiki, ala indents from the edges, so that you can see the text. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/213/dd9/544/213dd95443f7209932069ab7a0cfcb99.png" alt="image"><br><br>  Wow  What is this - really schedule?  Right in the code editor?  Which is reactively updated if you change the temperature or time?  Wow </p><br><p>  Nevertheless, now the width and height of the chart are hardcoded, and we cannot choose units of measurement. </p><br><p>  Now is the time to replace our hard-core "¬∞ C", "¬∞ F" with enumeration datatype everywhere.  I think it‚Äôs not worth explaining the essence of enumeration, only in the context of the MPS. </p><br><p>  enumeration datatype is a simple enum class that can be used in property. <br>  If earlier we used only <em>string</em> , <em>integer</em> and <em>_FPNumber_String</em> , then now we can create an enum for temperature measurement units, in which there will be 2 elements: Celsius and Fahrenheit. </p><br><p>  PCM on WeatherPrediction.structure ‚Üí New ‚Üí Enum Data Type ‚Üí <em>TemperatureUnit</em> . </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/c68/8ce/81e/c688ce81e4822d58762bad7cd288a53d.png" alt="image"><br><br>  We select type, in this case <strong>string</strong> <br>  We need the default value, so we leave false in <em>no default</em> <br>  default = first member (celsius) <br>  <em>member identifier</em> - is responsible for determining the item by input.  To change the TemperatureUnit value, you need to input a string that is compared with each internal or external value, whichever you choose. </p><br><p>  I explain: what is left and blue is the inner value of the element enum.  It is hidden.  Right - external, it is used to display in the editor. </p><br><p>  That is, if we choose <em>derive from internal value</em> in the <em>member identifier</em> , then we will have to set the value to either <em>celsius</em> or <em>fahrenheit</em> .  And if we choose to <em>derive from presentation</em> , then we will have to set the value in <em>¬∞ C</em> or <em>¬∞ F.</em>  You can also add custom identification, for example, so that you can set a value by internal and external value, but we don‚Äôt need it ourselves. </p><br><p>  Select <em>derive from presentation</em> and add 2 elements. </p><br><p>  Clearly! </p><br><p>  Add the <em>unit</em> property to the <em>PredictionResult</em> . </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/8c0/035/3c6/8c00353c6fcbc0b69514aee3819d536e.png" alt="image"></p><br><p>  Now we need to add a drop-down list in which we will select the unit of measurement. </p><br><pre> <code class="java hljs">string[] units = <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span>/TemperatureUnit/.members.select({~it =&gt; it.externalValue; }).toArray; <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> ModelAccess modelAccess = editorContext.getRepository().getModelAccess(); <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> JComboBox&lt;string&gt; box = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> JComboBox&lt;string&gt;(units); box.addActionListener(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ActionListener() { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">actionPerformed</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ActionEvent p0)</span></span></span><span class="hljs-function"> </span></span>{ modelAccess.executeCommand(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> EditorCommand(editorContext) { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">doExecute</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ Object selectedItem = box.getSelectedItem(); node.unit = selectedItem.toString(); } }); } }); box.setSelectedIndex(<span class="hljs-number"><span class="hljs-number">0</span></span>); box;</code> </pre> <br><p>  This is the code for another <em>$ swing component $</em> in the <em>PredictionResult</em> code editor.  We get a list of possible temperature units, create a drop-down list, hang the event handler.  It also uses the "funny MPS", instead of <em>readAction</em> or <em>writeAction</em> you can simply <em>executeCommand</em> .  Apparently, 2 previous exist for readability. </p><br><p>  When the selected item is changed from JComboBox, the node.unit is <em>changed</em> , which is set to a string value, as I explained above. </p><br><p>  We collect language, we look. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/432/fa7/c19/432fa7c19167863887a38462f2df5a3f.png" alt="image"></p><br><p>  Believe me, it really falls there and fahrenheit.  It remains only to link the JComboBox and the schedule, and on this you can finish, and it will be easy to do.  I cite the original graphics rendering code. </p><br><div class="spoiler">  <b class="spoiler_title">Shacked units</b> <div class="spoiler_text"><pre> <code class="java hljs">{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ string unit = <span class="hljs-string"><span class="hljs-string">"¬∞C"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> list&lt;Point2D.Double&gt; labels = node.input.items.select({~it =&gt; <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> x = it.time.hours * <span class="hljs-number"><span class="hljs-number">60</span></span> + it.time.minutes; <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> y = it.temperature.getValueFromUnit(unit.toString()); <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Point2D.Double(x, y); }).sortBy({~it =&gt; it.x; }, asc).toList; <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> minTemp = labels.sortBy({~it =&gt; it.y; }, asc).first.y; <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> maxTemp = labels.sortBy({~it =&gt; it.y; }, asc).last.y; <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> yKoef = chartHeight / (maxTemp - minTemp); <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> xKoef = chartWidth / (<span class="hljs-number"><span class="hljs-number">60.0</span></span> * <span class="hljs-number"><span class="hljs-number">24.0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> prevY = chartHeight; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> prevX = -<span class="hljs-number"><span class="hljs-number">1</span></span>; Graphics2D g2 = ((Graphics2D) graphics); labels.forEach({~it =&gt; message debug unit + <span class="hljs-string"><span class="hljs-string">"/"</span></span> + it.y, &lt;no project&gt;, &lt;no throwable&gt;; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> xTranslated = (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>) (it.x * xKoef); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> yTranslated = chartHeight - (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>) ((it.y - minTemp) * yKoef); g2.setStroke(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BasicStroke(<span class="hljs-number"><span class="hljs-number">1</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (prevX &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-comment"><span class="hljs-comment">// It is first element, no need to draw trailing line g2.drawLine(prevX, prevY, xTranslated, yTranslated); } g2.drawString(String.format("%.2f", it.y) + unit, xTranslated + 3, chartHeight - Math.abs(chartHeight - (yTranslated + 20))); g2.setStroke(new BasicStroke(5)); g2.drawLine(xTranslated, yTranslated, xTranslated, yTranslated); prevX = xTranslated; prevY = yTranslated; }); } }</span></span></code> </pre> </div></div><br><p>  Yes, dare?  We only need to replace <code>string unit = "¬∞C";</code>  on <code>string unit = node.unit;</code>  and we are guchi! </p><br><p>  And now the result: the schedule in Celsius and Fahrenheit, wah! </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/333/1bb/3d6/3331bb3d689a526a3c8935367a91ba71.png" alt="image"></p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/9d9/617/42f/9d961742f3a0156e0db81114bbbfa61a.png" alt="image"></p><br><p>  PS <br>  I think it is in this article that there are a lot of typos, discrepancies, because I was distracted a lot, at least to realize what I wanted to tell in this article.  Every day, the opening, so please write in the comments all the points that seem strange to you, most likely I dropped out of the context of the story and wrote some kind of heresy. </p><br><p>  In the next article, we will look at an aspect like TextGen.  We will generate a weather forecast in text form! </p></div><p>Source: <a href="https://habr.com/ru/post/334672/">https://habr.com/ru/post/334672/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../334662/index.html">Zimbra - we build communications in the company</a></li>
<li><a href="../334664/index.html">About supporting C # language features in Visual Studio and CodeRush for Roslyn</a></li>
<li><a href="../334666/index.html">Generation of documents. Problems and Solutions</a></li>
<li><a href="../334668/index.html">Thematic modeling with BigARTM</a></li>
<li><a href="../334670/index.html">Math pack for Android - "Micro-Math" - now open source</a></li>
<li><a href="../334674/index.html">How not to distract yourself from work. Tips and slak bot</a></li>
<li><a href="../334676/index.html">Leaflet 1.xx vs Openlayers 4.xx Part 2. How maps are drawn</a></li>
<li><a href="../334678/index.html">Writing a bot for Slack in Python</a></li>
<li><a href="../334680/index.html">Apache Curator for Apache Zookeeper features overview</a></li>
<li><a href="../334682/index.html">Rapid deployment containers</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>