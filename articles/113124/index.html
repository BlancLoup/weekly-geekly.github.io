<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>And we will go the other way. Moving the model to the database</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Recently, web development from a knee-down product has become a serious engineering discipline. All this was made possible by the efforts of the legio...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>And we will go the other way. Moving the model to the database</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage/habraeffect/b1/b9/b1b91f6ad3a49926e30a008a097a70ef.jpg" align="left" alt="And we will go another way">  Recently, web development from a knee-down product has become a serious engineering discipline.  All this was made possible by the efforts of the legion of specialists who developed common practices that allow writing web projects using certain architecture, rather than like a researcher dropping a box of typographic font from the roof of a skyscraper in the hope that it will miraculously fit into the first volume. War and Peace.  The most common web programming paradigm is, no doubt, <a href="http://ru.wikipedia.org/wiki/Model-View-Controller">MVC</a> - Model-View-Controller.  Speaking primitively, this paradigm provides for the separation of application code into a control layer (Controller), a view layer (View) and a data control layer (Model).  In this case, MVC provides that the Controller and View may (but are not required) to depend on the Model, while the Model should under no circumstances depend on them. <br>  There are many different approaches to how to separate the business logic of an application from the logic of display and control.  All of them provide that the model is part of the application and interacts with the database, using the latter only as a data warehouse.  We will try to go a different way and, as far as possible, bring the business logic of the application to the database level. <br>  <strong>Warning</strong> : it is better for people with fine mental organization not to see what is going on under the cut. <br><a name="habracut"></a><br><h4>  Introduction </h4><br>  In order not to resemble a schizophrenic, I will say: in my life I happened to see one very large application written in a similar way.  Almost all of its business logic was executed at the database level.  It was effective in terms of application performance and terrible in terms of programmer performance.  True, it was written under ASP.NET + MS SQL Server with its incomparably great capabilities.  In our experiments, we will use a hardened bundle: PHP (5.3.1) + Zend Framework (1.11) + MySQL (5.1.4). <br>  So, let's take a close look at our toolkit and let's not get very discouraged (although there is something from it).  Tools for working with stored procedures and functions in MySQL are in their infancy, there is virtually no built-in support for working with stored procedures and functions in PHP. <br><br><h4>  And what will we sculpt? .. </h4><br>  As a Hello-world project, we take a simple blog with posts, comments and tags.  Minimal functionality - our task is simply to investigate the principle of model transfer to the database. <br>  We will use Zend Framework as a software platform. <br><br><h4>  On the assault! </h4><br>  So, our database has the simplest structure of 4 tables: <img src="https://habrastorage.org/storage/habraeffect/f2/fe/f2fe07e0b7691b1dc1f4ffd8ad174dfb.jpg" alt="image"><br>  So, our task is to transfer all (or at least some) business logic to the database layer.  To do this, we will use stored procedures and functions stored and executed directly on the database server side. <br>  First, we initialize the Zend Framework application from the command line: <br><pre><code class="bash hljs">zf create project ./ zf create controller posts zf create controller comments zf create controller tags zf create action add Posts zf create action edit Posts zf create action save Posts zf create action delete Posts zf create action addComment Posts zf create action view Posts zf create db-table Posts sb_posts zf create db-table Comments sb_comments zf create db-table Tags sb_tags zf create db-table PostTags sb_post_tags zf create form Post zf create form Comment zf <span class="hljs-built_in"><span class="hljs-built_in">enable</span></span> layout</code> </pre> <br>  To begin, write the procedure for saving the post: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> DEFINER = <span class="hljs-string"><span class="hljs-string">'sqlblog'</span></span>@<span class="hljs-string"><span class="hljs-string">'localhost'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PROCEDURE</span></span> <span class="hljs-string"><span class="hljs-string">`Posts_save`</span></span>( <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> title <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">100</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> <span class="hljs-built_in"><span class="hljs-built_in">text</span></span> <span class="hljs-built_in"><span class="hljs-built_in">TEXT</span></span>, INOUT post_id <span class="hljs-built_in"><span class="hljs-built_in">INTEGER</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) ) <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ISNULL</span></span>(<span class="hljs-string"><span class="hljs-string">`post_id`</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-string"><span class="hljs-string">`post_id`</span></span> = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> <span class="hljs-string"><span class="hljs-string">`sb_posts`</span></span> (<span class="hljs-string"><span class="hljs-string">`title`</span></span>, <span class="hljs-string"><span class="hljs-string">`text`</span></span>, <span class="hljs-string"><span class="hljs-string">`date`</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-string"><span class="hljs-string">`title`</span></span>, <span class="hljs-string"><span class="hljs-string">`text`</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">NOW</span></span>()); <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> <span class="hljs-string"><span class="hljs-string">`post_id`</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">LAST_INSERT_ID</span></span>(); ELSE <span class="hljs-keyword"><span class="hljs-keyword">UPDATE</span></span> <span class="hljs-string"><span class="hljs-string">`sb_posts`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> p <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> p.<span class="hljs-string"><span class="hljs-string">`title`</span></span> = <span class="hljs-string"><span class="hljs-string">`title`</span></span>, p.<span class="hljs-string"><span class="hljs-string">`text`</span></span> = <span class="hljs-string"><span class="hljs-string">`text`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> p.<span class="hljs-string"><span class="hljs-string">`id`</span></span> = <span class="hljs-string"><span class="hljs-string">`post_id`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LIMIT</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>;</code> </pre> <br>  The first two parameters passed to the procedure are the title of the record and the text of the record itself.  The last parameter is the record ID.  This parameter is not accidentally of type INOUT.  The attentive reader could already verify that this procedure has a dual logic: creates an entry if post_id was not transmitted or transmitted as 0, and updates the entry otherwise.  After the procedure is completed, the record ID is returned in the same third parameter. <br>  Unfortunately, the convenience of working with stored procedures from PHP leaves much to be desired.  In particular, PDO allows, when executing a request, to indicate what type of transmitted parameter is INOUT.  In this case, after executing the request for the procedure call, the variable specified as such a parameter will return the value returned by the stored procedure: <br><pre> <code class="php hljs">$post_id = <span class="hljs-number"><span class="hljs-number">0</span></span>; $sth = $dbh-&gt;prepare(<span class="hljs-string"><span class="hljs-string">'CALL Posts_save(?, ?, ?)'</span></span>); $sth-&gt;bindParam(<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">'Post title'</span></span>, PDO::PARAM_STR); $sth-&gt;bindParam(<span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-string"><span class="hljs-string">'Post body'</span></span>, PDO::PARAM_STR); $sth-&gt;bindParam(<span class="hljs-number"><span class="hljs-number">3</span></span>, $post_id, PDO::PARAM_INT|PDO::PARAM_INPUT_OUTPUT, <span class="hljs-number"><span class="hljs-number">11</span></span>); $sth-&gt;execute(); <span class="hljs-keyword"><span class="hljs-keyword">print</span></span>(<span class="hljs-string"><span class="hljs-string">"New post ID is: $post_id"</span></span>);</code> </pre> <br>  However, this remarkable feature does not work in relation to MySQL.  Therefore, for normal work with MySQL, you have to pervert and use the variables of MySQL itself.  The trick is simple: specify the MySQL variable as the third parameter, and then retrieve its value using the SELECT: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @post_id = <span class="hljs-number"><span class="hljs-number">12</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">CALL</span></span> Posts_save(<span class="hljs-string"><span class="hljs-string">'Post title'</span></span>, <span class="hljs-string"><span class="hljs-string">'Post body'</span></span>, @post_id); <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> @post_id <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> post_id;</code> </pre>  The first request is needed only when updating an existing entry. <br>  To create a record, create the following form: <br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Application_Form_Post</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Zend_Form</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">init</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span> -&gt;addElement(<span class="hljs-string"><span class="hljs-string">'hidden'</span></span>, <span class="hljs-string"><span class="hljs-string">'id'</span></span>) -&gt;addElement(<span class="hljs-string"><span class="hljs-string">'text'</span></span>, <span class="hljs-string"><span class="hljs-string">'title'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-string"><span class="hljs-string">'label'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Title:'</span></span>, <span class="hljs-string"><span class="hljs-string">'required'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>)) -&gt;addElement(<span class="hljs-string"><span class="hljs-string">'textarea'</span></span>, <span class="hljs-string"><span class="hljs-string">'text'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-string"><span class="hljs-string">'label'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Text:'</span></span>, <span class="hljs-string"><span class="hljs-string">'required'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>)) -&gt;addElement(<span class="hljs-string"><span class="hljs-string">'text'</span></span>, <span class="hljs-string"><span class="hljs-string">'tags'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-string"><span class="hljs-string">'label'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Tags:'</span></span>, <span class="hljs-string"><span class="hljs-string">'required'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>)) -&gt;addElement(<span class="hljs-string"><span class="hljs-string">'submit'</span></span>, <span class="hljs-string"><span class="hljs-string">'submit'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-string"><span class="hljs-string">'label'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Add Post'</span></span>)); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">prepareDecorators</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;setDecorators(<span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'FormElements'</span></span>, <span class="hljs-string"><span class="hljs-string">'FormErrors'</span></span>, <span class="hljs-string"><span class="hljs-string">'Form'</span></span> )); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>; } }</code> </pre> <br>  Now in the controller code we just need to write the following: <br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PostsController</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Zend_Controller_Action</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">addAction</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;view-&gt;form = $form = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Application_Form_Post(<span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'name'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'postForm'</span></span>, <span class="hljs-string"><span class="hljs-string">'action'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'/posts/save/'</span></span> )); $form-&gt;prepareDecorators(); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">saveAction</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $post_id = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_getParam(<span class="hljs-string"><span class="hljs-string">'id'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;view-&gt;form = $form = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Application_Form_Post(<span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'name'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'postForm'</span></span>, <span class="hljs-string"><span class="hljs-string">'action'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'/posts/save/'</span></span> )); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;getRequest()-&gt;isPost()) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($form-&gt;isValid(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;getRequest()-&gt;getPost())) { $result = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_helper-&gt;procedure()-&gt;Posts_save( $form-&gt;getValue(<span class="hljs-string"><span class="hljs-string">'title'</span></span>), $form-&gt;getValue(<span class="hljs-string"><span class="hljs-string">'text'</span></span>), $post_id ); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($post_id) { $tags = $form-&gt;getValue(<span class="hljs-string"><span class="hljs-string">'tags'</span></span>); $tags = explode(<span class="hljs-string"><span class="hljs-string">','</span></span>, $tags); $tags = array_map(<span class="hljs-string"><span class="hljs-string">'trim'</span></span>, $tags); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_helper-&gt;procedure()-&gt;Post_clearTags($post_id); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($tags <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $tag) { <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_helper-&gt;procedure()-&gt;Post_addTag($post_id, $tag); } <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_redirect(<span class="hljs-string"><span class="hljs-string">'/posts/view/id/'</span></span> . $post_id); } } <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;view-&gt;form = $form-&gt;prepareDecorators(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_redirect(<span class="hljs-string"><span class="hljs-string">'/posts'</span></span>); } } }</code> </pre>  Expand our functionality slightly.  As expected, the author adds tags to each post, which then need to be displayed as a cloud.  In order to accomplish this task, we need to at some stage calculate the weight of each tag.  There are several options: <br><ol><li>  Calculate on the fly, request for each tag </li><li>  Store the weight of each tag in the table and update it with any changes </li></ol><br>  The first option is easily solved by the query: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> t.*, getTagWeight(t.id) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> weight <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> sb_tags <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> t</code> </pre> <br>  Here getTagWeight is a pre-created function that calculates the tag weight.  However, due to the fact that the tag cloud will be displayed very often (much more often than the order and composition of the tags will change), such a request cannot be considered an effective solution to the problem.  A good way out of this situation would be caching the tag cloud entirely, but we will try to solve this problem in a different way. <br>  In MySQL, starting from version 5.0, a mechanism of triggers appeared - procedures that are run when a certain condition is met.  Such a trigger is attached and it can work, for example, before inserting data or after deletion.  Thus, we can solve the problem of calculating tag weights by hanging two triggers on the link table - sb_post_tags: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> DEFINER = <span class="hljs-string"><span class="hljs-string">'sqlblog'</span></span>@<span class="hljs-string"><span class="hljs-string">'localhost'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRIGGER</span></span> <span class="hljs-string"><span class="hljs-string">`sb_post_tags_after_ins_tr`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AFTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-string"><span class="hljs-string">`sb_post_tags`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FOR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EACH</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ROW</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">UPDATE</span></span> <span class="hljs-string"><span class="hljs-string">`sb_tags`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> t <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> t.<span class="hljs-string"><span class="hljs-string">`weight`</span></span> = <span class="hljs-string"><span class="hljs-string">`Tag_calculateWeight`</span></span>(<span class="hljs-string"><span class="hljs-string">`Tag_getById`</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">NEW</span></span> . tag_id)) <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> t.<span class="hljs-string"><span class="hljs-string">`id`</span></span> = NEW.tag_id; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> DEFINER = <span class="hljs-string"><span class="hljs-string">'sqlblog'</span></span>@<span class="hljs-string"><span class="hljs-string">'localhost'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRIGGER</span></span> <span class="hljs-string"><span class="hljs-string">`sb_post_tags_after_del_tr`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AFTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DELETE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-string"><span class="hljs-string">`sb_post_tags`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FOR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EACH</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ROW</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">UPDATE</span></span> <span class="hljs-string"><span class="hljs-string">`sb_tags`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> t <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> t.<span class="hljs-string"><span class="hljs-string">`weight`</span></span> = <span class="hljs-string"><span class="hljs-string">`Tag_calculateWeight`</span></span>(<span class="hljs-string"><span class="hljs-string">`Tag_getById`</span></span>(OLD.<span class="hljs-string"><span class="hljs-string">`tag_id`</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> t.<span class="hljs-string"><span class="hljs-string">`id`</span></span> = OLD.<span class="hljs-string"><span class="hljs-string">`tag_id`</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>;</code> </pre><br>  Thus, at each insertion / deletion to / from the sb_post_tags table, tag weights are recalculated and stored in the sb_tags table, from where they can be extracted by a simple query. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  findings </h4><br>  So what‚Äôs the bottom line?  You can write simple projects in this way, but for large projects with this approach, in my opinion, costs per person will grow exponentially with the complexity of the project. <br>  Are there any pluses?  There is: it is fast.  Even compared to DDD, this is fast.  I spent 15-20 minutes writing 13 procedures and 7 functions.  And they are written really easy and simple. <br>  Minuses: <br><ul><li>  Debugging is bad.  I do not know if step-by-step debugging of stored procedures is possible. </li><li>  A bunch of PHP-Mysql applied to stored procedures works disgustingly.  Perhaps, if you use PgSQL or MSSql, then development efficiency can be improved. </li><li>  Due to some limitations of the MYSQL language, some functionality nevertheless had to be implemented by standard means.  In particular, I am talking about paginated output, since LIMIT can take only constant values, except when the PREPARE / EXECUTE combination is used. </li></ul><br>  In any case, this topic should be considered only as an experiment.  Discussion is welcome. <br>  I did not consider all the procedures here, but only indicated the key points of the development.  For those who are interested in the project as a whole, I can offer a project repository on <a href="https://github.com/tankist/sqlblog">github</a> </div><p>Source: <a href="https://habr.com/ru/post/113124/">https://habr.com/ru/post/113124/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../113118/index.html">C # problem</a></li>
<li><a href="../113119/index.html">On the issue of GPU performance</a></li>
<li><a href="../113121/index.html">Introduction to MVP GWT 2.1</a></li>
<li><a href="../113122/index.html">Idea motivation</a></li>
<li><a href="../113123/index.html">Ubuntu 11.04 Natty Narwhal Alpha 2 released</a></li>
<li><a href="../113126/index.html">Chrome 9: Breakthrough in speed, support for 3D and web applications</a></li>
<li><a href="../113127/index.html">Having fun with hashes</a></li>
<li><a href="../113128/index.html">How not to write factorial in Java</a></li>
<li><a href="../113129/index.html">yourfilms.org - your movies</a></li>
<li><a href="../113131/index.html">February 18, St. Petersburg - Java Tech Day 2011</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>