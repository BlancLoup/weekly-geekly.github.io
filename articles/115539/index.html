<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Communication billing and Cisco Catalyst 2960 via SNMP. Change port speed, traffic count</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="As promised, after the greeting , we begin to slightly disclose technical details. 

 Task 
 Give users the ability to choose the connection speed and...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Communication billing and Cisco Catalyst 2960 via SNMP. Change port speed, traffic count</h1><div class="post__text post__text-html js-mediator-article">  As promised, after the <a href="http://habrahabr.ru/company/serverclub/blog/115169/">greeting</a> , we begin to slightly disclose technical details. <br><br><h4>  Task </h4><br>  Give users the ability to choose the connection speed and charging method for each of their servers.  Give administrators the ability to switch the speed of the channel or even extinguish the port through the admin panel. <br><br><h4>  Iron </h4><br>  Each rack has at least one Cisco Catalyst 2960 switch. The specific model is WS-C2960G-48TC-L with LANBASE SPF.  The input to it is 4x SFP, and 48 Gigabit Ethernet ports are facing the servers.  With a live load of several gigabits, there were no problems.  In the photo, various members of the 2960 family. <br><img src="http://nekaka.com/pics/cisco.jpg" alt="image"><br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Port speed and status </h4><br><br>  From the user‚Äôs side, everything <a href="https://serverclub.com/order_R210_SAS">looks</a> pretty simple: <br><img src="http://nekaka.com/pics/network.png"><br><br>  In case of selecting 10 Mb connection, the lower options disappear, as the traffic in this case is free.  The option of limiting traffic on the use of prepaid volume is due to concern for users, because according to 95th policy, if you downloaded at a gigabit speed of 36 hours and then did not use the channel at all, then the account will be just for full gigabit.  Imagine, while you were away fishing for the weekend, you got the Habra effect and thousands of users continuously download the image of your virtual machine, which was laid out on your server and can help many developers, and on Monday you will find $ 2000 on your hosting account.  This Monday will be especially difficult.  In our case, after 24 hours, the port will switch to 10 megabits, or after 36 hours, traffic will be purchased in equal portions until the financial limit of a specific user is reached. <br><br>  From the backend side, all of the work for us, in fact, has already been done by Cisco engineers, and to manage their devices, we will use the Simple Network Management Protocol (SNMP), which was created in 1988, and secured in 1990 ( <a href="http://www.rfc-editor.org/rfc/rfc1157.txt">RFC 1157</a> ) by the group hackers (in the original meaning of the word), headed by JD Case, for which a special thanks to him. <br><br>  For this feature to work, you must enable SNMP support on your switch, and also remember to specify the communtity and allow for this community to perform operations not only on reading, but also on writing.  The PHP function looks like this: <br><br> <code>function set_switch_port_speed ($host, $community, $port_no, $speed, $model='2960'){ <br> // use SNMP to set speed. $speed can be 10, 100, 1000 or 0 to shutDown port. <br> if(!in_array($speed, array(10, 100, 1000))){ <br> //echo 'Wrong port speed! '.$speed."\n"; <br> return false; <br> } <br> <br> $oid = ''; <br> <br> if(stristr($model, '2960')){ // magic smtp strings, path to <br> $oid = '1.3.6.1.4.1.9.5.1.4.1.1.9.1.'.$port_no; <br> }else{ <br> $oid = '1.3.6.1.4.1.9.9.87.1.4.1.1.33.0.'.$port_no; // c2900PortAdminSpeed <br> } <br> <br> $speed *= 1000000; <br> echo "setting new speed...\n"; <br> return snmpset($host, $community, $oid, 'i', $speed); <br> <br> } <br></code> <br><br>  Accordingly, it is called when the server is configured, the limit is reached, the lease is terminated, and so on. <br><br>  The port can be turned off in two ways - by setting the speed equal to port 0, or by using a separate function: <br><br> <code>function set_switch_port_status($host, $community, $port_no, $status, $model=''){ <br> // use SNMP to set status. $status can be 0 or 1 <br> $status = (int) $status; <br> if(!in_array($status, array(0, 1))){ <br> echo 'Wrong port status! '.$status."\n"; <br> return false; <br> } <br> <br> // decode status, 1 means UP 2 means down <br> if($status == 0){ <br> $status = 2; <br> } <br> <br> $oid = ''; <br> <br> // for 2960 set oid = 'IF-MIB::ifAdminStatus.101'.$port_no; <br> if(stristr($model, '2960')){ <br> if($port_no &lt; 10){ <br> $port_no = '0'.$port_no; <br> } <br> $oid = 'IF-MIB::ifAdminStatus.101'.$port_no; <br> }else{ <br> $oid = 'IF-MIB::ifAdminStatus.'.($port_no + 1); // first interface on 2900xl is VLAN1 <br> } <br> <br> return snmpset($host, $community, $oid, 'i', $status); <br> <br> } <br></code> <br><br><h4>  Traffic counting </h4><br>  What the user sees: <br><img src="http://nekaka.com/pics/widget.png"><br>  The server widget, on it is spark graphics, showing a traffic trend for the last 48 hours without a scale value (for that reason it is sparkling - there is little space in the widgets).  The number indicates the current usage of the channel. <br><br>  A general schedule for all servers is displayed under the server list (it has no relation to billing, the traffic is shared individually for each server) <br><img src="http://nekaka.com/pics/total.png"><br><br>  Well, the schedule of a particular server is already a full-fledged display in a larger format, with the ability to select a period of time.  According to these indicators, a bandwidth bill is already being formed. <br><img src="http://nekaka.com/pics/server.png"><br><br>  The red line measures 95%.  Anything higher is not charged.  As you can see, this user experienced Habraeffect for free and without a single break :).  Well, who has not seen - our <a href="">panel</a> entirely. <br><br>  To collect statistics from ports, we use the <a href="http://www.cacti.net/">cacti</a> package.  After cacti has removed and processed the information, it writes data to the rrd file for each port.  This file contains statistics for the entire port operation period.  In the future, we can extract this information and carry out any operations, whether it is traffic counting for a certain period or drawing a chart for a client.  Below is a function to extract data from this file for further post-processing using the rrdtool utility: <br><br> <code>function getRRDData($rrd_file, $start, $end = ''){ <br> <br> $str_end = ''; <br> if($end) <br> $str_end = ' -e '.$end; <br> <br> $res = exec('/usr/local/bin/rrdtool fetch '.$rrd_file.' AVERAGE -s '.$start.$str_end, $output); <br> if(!$res || (count($output) &lt; 1)){ <br> return array(); // smth is wrong <br> } <br> // we need only 3 ... N-1 elements <br> $rrd_data = array(); <br> for($i = 2; $i &lt; (count($output) ); $i++){ <br> <br> // replace NAN with 0 <br> if(stristr($output[$i], 'nan')) <br> $output[$i] = str_ireplace('nan', '0', $output[$i]); <br> <br> $values = explode(' ', str_replace(':', '', $output[$i])); <br> // check timestamp <br> if($end &amp;&amp; ($values[0] &gt; $end)) <br> break; <br> <br> $rrd_data[] = $output[$i]; <br> } <br> return $rrd_data; <br> <br> } <br></code> <br><br>  In order not to get the sheets from the code at all, we will not give here massive functions of traffic counting and drawing.  When traffic is calculated, the beginning and the end of the time interval are determined, the data extraction function is called (the code is above), this data is calculated and at the end a figure of 95 percent or the number of gigabytes is output.  95% is considered averaged five-minute segments, 1 megabit equals 1000 * 1000 bits per second, and a gigabyte is 1024 * 1024 * 1024 bytes.  An impressive percentage of ordinary people go astray when naming these numbers, and no wonder :). <br><br>  In anticipation of constructive criticism, <br>  <a href="https://serverclub.com/">ServerClub Dedicated Servers</a> . </div><p>Source: <a href="https://habr.com/ru/post/115539/">https://habr.com/ru/post/115539/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../115529/index.html">Free access to the course on ReSharper from PluralSight</a></li>
<li><a href="../115531/index.html">Server from image: DHCP + TFTP + Initrd + OpenVZ</a></li>
<li><a href="../115533/index.html">Donetsk coffee-and-code with a taste of Ruby on Rails</a></li>
<li><a href="../115536/index.html">The simplest RSS reader</a></li>
<li><a href="../115538/index.html">Features Firewall in Windows 7</a></li>
<li><a href="../115540/index.html">What does VKontakte do with personal data after deleting the page?</a></li>
<li><a href="../115542/index.html">Google is preparing a major update blogger</a></li>
<li><a href="../115543/index.html">Why is your GTD ineffective?</a></li>
<li><a href="../115544/index.html">Microsoft Word. Automatic correction of text language</a></li>
<li><a href="../115547/index.html">In programs that use a developed, but unusual system of hotkeys, do you most often?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>