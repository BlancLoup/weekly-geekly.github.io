<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Using Yii's ActiveRecord in a time manager game</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello! 

 Today I want to tell you how the work with the cache was implemented in a social time manager game. You can consider this article as a conti...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Using Yii's ActiveRecord in a time manager game</h1><div class="post__text post__text-html js-mediator-article">  Hello! <br><br>  Today I want to tell you how the work with the cache was implemented in a social time manager game.  You can consider this article as a continuation of <a href="http://habrahabr.ru/post/176497/">this one</a> . <br><br>  Let me remind you that the project uses php (Yii), mysql and memcached.  There are a lot of entities in the project, each of which has its own model, which is inherited from CActiveRecord. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Model files are stored as follows.  In the models folder, create the base folder.  When we generate a model through Gii, we indicate that we need to put it in the models / base folder and add Base to the class name.  Then we create in models a similar class without Base, which is inherited from the base class and has only the model () method in it. <br><br>  By the way, I will say in advance that the basic models are not inherited from CActiveRecord, but from ExtActiveRecord - we extend CActiveRecord to our needs.  But more about that later.  So far, no difference. <br><br><blockquote>  Example: <br>  models / base / BaseUser.php - standard class that is generated via Gii <br>  models / User.php - a class that inherits from BaseUser and has a model () method in it <br><pre><code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">/** * Returns the static model of the specified AR class. * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> string $className active record class name. * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> User the static model class */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">model</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($className=__CLASS__)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">parent</span></span>::model($className); }</code> </pre> <br></blockquote><br><br>  This scheme is used to ensure that in case of repeated generation of the model file, not to lose your code and simply not to fill in the space with the standard code from Yii. <br><br>  Do not forget to add in the config 'application.models.base. *'. <br><br>  Let's move on to the topic of the post and set the tasks that we want to solve: <br><ol><li>  Reduce the number of requests to the database to update </li><li>  Reduce the number of requests to the database per sample </li></ol><br><br><a name="habracut"></a><br><br><h2>  Reducing the number of requests to the database for updating </h2><br>  As you remember from the last article, we use a queue to execute commands.  And for a particular user, it may be necessary to execute more than 2 commands in sequence.  For example, we receive a pack of 3 teams: increase experience, buy a building and change the player's name.  Suppose that experience, money, and name are stored in one user table. <br><br>  The implementation of queue processing is such that the teams know nothing about each other and in the standard implementation, each team will load the user model, modify it and save. <br><br>  We will now do so that the user will be loaded upon first access to it, and saved only after all the commands are executed.  To do this, we will make a register of models. <br>  This is the kind of thing that we will turn to to get the User model, instead of writing User :: model () -&gt; findByPk (). <br><br>  The model registry will be a component and will be registered in the components config. <br><pre> <code class="php hljs"><span class="hljs-string"><span class="hljs-string">'components'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-comment"><span class="hljs-comment">// ... 'modelRegistry'=&gt;array( 'class' =&gt; 'ModelRegistry' ) // ... )</span></span></code> </pre><br><br>  The class itself looks like this. <br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ModelRegistry</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $registries = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">init</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{} <span class="hljs-comment"><span class="hljs-comment">/** *     * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> string $name * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> mixed $attr * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> ExtActiveRecord */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> &amp; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">registry</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($name, $attr = array</span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">()</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ $key = $name . md5(serialize($attr)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;registries[$key])) { $model = ucfirst($name); $obj = $model::model(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!is_array($attr)) $attr = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>($attr); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;registries[$key] = call_user_func_array(<span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(&amp;$obj, <span class="hljs-string"><span class="hljs-string">'registry'</span></span>), $attr); } <span class="hljs-comment"><span class="hljs-comment">//         &amp;    return $this-&gt;registries[$key]; } /** *   */ public function saveAll() { foreach ($this-&gt;registries as $obj) { $obj-&gt;save(); } } }</span></span></code> </pre><br><br>  Each of our models that we want to receive through the model registry will have a registry method that will return an object.  User in this case looks like this. <br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@property</span></span></span><span class="hljs-comment"> integer $id * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@property</span></span></span><span class="hljs-comment"> integer $exp * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@property</span></span></span><span class="hljs-comment"> integer $money * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@property</span></span></span><span class="hljs-comment"> integer $name */</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">User</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BaseUser</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** * Returns the static model of the specified AR class. * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> string $className active record class name. * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> User the static model class */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">model</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($className=__CLASS__)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">parent</span></span>::model($className); } <span class="hljs-comment"><span class="hljs-comment">/** *    * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> int $userID * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> User|bool */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">registry</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($userID)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($obj = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;findByPk($userID)) { $res = $obj; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { $res = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $res; } }</code> </pre><br><br>  What it all led to.  For example, we have a controller that calls two methods that modify the user. <br><br><pre> <code class="php hljs"> <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> ModelRegistry */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $reg; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">actionRun</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $userID = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;reg = &amp;Yii::app()-&gt;modelRegistry; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;firstChange($userID); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;secondChange($userID); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;reg-&gt;saveAll(); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">firstChange</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($userID)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//   .         // &amp; ,        $user = &amp;$this-&gt;reg-&gt;registry('user', $userID); $user-&gt;exp = 10; } public function secondChange($userID) { //    ,     .     // &amp;  $user = &amp;$this-&gt;reg-&gt;registry('user', $userID); $user-&gt;money = 20; }</span></span></code> </pre><br><br>  Actually there will be one access to the database on select and one on update. <br>  Here we face an extra challenge.  If you call this code a second time, the user fields will remain the same, but the saving will still be made.  We need to make sure that our ActiveRecord is saved only if the object has tolerated changes. <br><br>  This is where our ExtActiveRecord comes in, which we used to extend CActiveRecord. <br><br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ExtActiveRecord</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CActiveRecord</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $_oldAttributes = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(); <span class="hljs-comment"><span class="hljs-comment">/** *   ,       */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">registry</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{} <span class="hljs-comment"><span class="hljs-comment">/** *     */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">memoryAttributes</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_oldAttributes = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;attributes; } <span class="hljs-comment"><span class="hljs-comment">/** *    .     *           ,   false * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> array|false */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getChanges</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $res = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_oldAttributes)) { $res = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_oldAttributes <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $key =&gt; $value) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;$key != $value) { $res[] = $key; } } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $res; } <span class="hljs-comment"><span class="hljs-comment">/** *    * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> bool */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">save</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (($attr = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;getChanges()) === <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>) { $res = <span class="hljs-keyword"><span class="hljs-keyword">parent</span></span>::save(); } <span class="hljs-keyword"><span class="hljs-keyword">elseif</span></span> ($attr) { $res = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;update($attr); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { $res = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $res; } }</code> </pre><br><br>  And update the registry method in the User model <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">registry</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($userID)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($obj = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;findByPk($userID)) { $res = $obj; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { $res = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($res) { <span class="hljs-comment"><span class="hljs-comment">//     $res-&gt;memoryAttributes(); } return $res; }</span></span></code> </pre><br><br>  Actually now only insert or update of the modified model fields will be performed. <br>  I leave you space for creativity and let you figure out how to create a new user and place it in the model registry during the execution of the script. <br><br>  I showed you how to store any objects in the registry.  But sometimes there are situations when we need to keep a list there.  For example, for each user we have 10 cars.  And we want the registry to have not 10 machines, but one object containing all the machines.  To do this, use the ModelList class, which stores models of machines. <br><br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ModelList</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> array   ExtActiveRecord */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> $list = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(); <span class="hljs-comment"><span class="hljs-comment">/** *    * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> array|bool $list   ExtActiveRecord * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> ModelList */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">make</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($list = array</span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">()</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!is_array($list) &amp;&amp; <span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>($list)) { $list = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(); } $obj = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ModelList(); $obj-&gt;list = $list; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $obj; } <span class="hljs-comment"><span class="hljs-comment">/** *     * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> ExtActiveRecord $obj */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">pushObject</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($obj)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;list[] = $obj; } <span class="hljs-comment"><span class="hljs-comment">/** *      * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> string $name */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">callMethod</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($name)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;list <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> &amp;$obj) { $obj-&gt;$name(); } } <span class="hljs-comment"><span class="hljs-comment">/** *    */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">save</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;callMethod(<span class="hljs-string"><span class="hljs-string">'save'</span></span>); } }</code> </pre><br><br>  And here is the model of the car <br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@property</span></span></span><span class="hljs-comment"> integer $id * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@property</span></span></span><span class="hljs-comment"> integer $user_id * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@property</span></span></span><span class="hljs-comment"> integer $car_id * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@property</span></span></span><span class="hljs-comment"> integer $speed */</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Car</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BaseCar</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** * Returns the static model of the specified AR class. * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> string $className active record class name. * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> Car the static model class */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">model</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($className=__CLASS__)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">parent</span></span>::model($className); } <span class="hljs-comment"><span class="hljs-comment">/** *      * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> int $userID * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> ModelList */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">registry</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($userID)</span></span></span><span class="hljs-function"> </span></span>{ $list = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;findAllByAttributes(<span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-string"><span class="hljs-string">'user_id'</span></span>=&gt;$userID)); $res = ModelList::make($list); <span class="hljs-comment"><span class="hljs-comment">//      $res-&gt;callMethod('memoryAttributes'); return $res; } /** * ,   . ,      ModelList  pushObject * @param int $userID * @param int $carID * @return Car */ public static function make($userID, $carID) { $obj = new Car(); $obj-&gt;user_id = $userID; $obj-&gt;car_id = $dict-&gt;area_id; $obj-&gt;speed = 10; return $obj; } }</span></span></code> </pre><br><br>  Actually now, when we execute the following code, <br><pre> <code class="php hljs">$carList = &amp;Yii::app()-&gt;modelRegistry-&gt;registry(<span class="hljs-string"><span class="hljs-string">'car'</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>);</code> </pre><br>  then we get an object of the class ModelList, which will contain all the player's machines.  They can also be changed (without forgetting to refer to the link in $ carList-&gt; list) and then saved through the model registry with the standard saveAll. <br><br>  Since the article is quite large, I will tell you about caching all this in the next article. <br>  I can say that in ideal conditions with caching this implementation does not apply for the same data twice, even if after the first time they were updated. <br><br>  This version of working with models is conveniently used in our project, but it may not suit you. <br>  All I wanted was just to show what tasks there are and how they can be solved. </div><p>Source: <a href="https://habr.com/ru/post/177181/">https://habr.com/ru/post/177181/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../177165/index.html">Simple custom unit</a></li>
<li><a href="../177167/index.html">In the new Ubuntu Touch preview builds, the first applications will soon appear.</a></li>
<li><a href="../177171/index.html">Russian Code Cup 2013: analysis of the tasks of the first qualifying round</a></li>
<li><a href="../177175/index.html">Secrets of Hyper-V Windows Server 2012 Virtualization by Microsoft Architect Alexey Kibkalo</a></li>
<li><a href="../177179/index.html">Google prohibits selling / lending your Google Glass</a></li>
<li><a href="../177187/index.html">Powerful speakers at the conference # MBLT13</a></li>
<li><a href="../177189/index.html">Function Code Integrity Monitoring</a></li>
<li><a href="../177191/index.html">Zingaya's free iOS mobile app</a></li>
<li><a href="../177197/index.html">Turing's biggest test</a></li>
<li><a href="../177201/index.html">Porting the Genode OS Framework to a new hardware platform</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>