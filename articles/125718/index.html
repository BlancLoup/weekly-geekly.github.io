<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Connecting Facebook Credits for online stores</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi, Habr. Not so long ago we wrote a module that connects 1C-Bitrix stores to the social network Facebook. I want to share my experience, as well as t...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Connecting Facebook Credits for online stores</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage1/b9c97794/709b178a/c5028eca/ae2bf1f9.png" align="left">  Hi, Habr.  Not so long ago we wrote a module that connects 1C-Bitrix stores to the social network Facebook.  I want to share my experience, as well as the features of setting up reception of Facebook Credits in your store - it does not matter what CMS it is implemented on.  Rushed! <br><a name="habracut"></a><br><br><h1>  History reference </h1><br>  Facebook Credits is the local currency of the social networking site Facebook, which first appeared in 2009, and became the only allowed one, according to the rules of Facebook, since June 1 of this year.  For a long time, it was impossible to connect a Russian bank for the withdrawal of earned loans - Russia was simply not in the list of countries for connecting Facebook Credits. <br><br>  The only possible ways to withdraw earned loans were either withdrawal via PayPal (there is no legal, white or fluffy way out of PayPal to Russia <a href="https://www.paypal.com/helpcenter/main.jsp%3Ft%3DsolutionTab%26ft%3DhomeTab%26ps%3D%26solutionId%3D1208179%26locale%3Dru_RU%26_dyncharset%3DUTF-8%26countrycode%3DRU%26cmd%3D_help%26m%3DBT">at the moment</a> ), or opening an account in a foreign bank.  However, on June 27, Russia appeared in the form of connecting payments, although it is not yet on the <a href="http://www.facebook.com/help/%3Ffaq%3D167386783322340">official list</a> .  But we really hope and are ready :-) 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h1>  We connect payments to the application </h1><br>  We will proceed from the fact that you already have a working application for Facebook, and your task is to connect the acceptance of credits.  So, go to the <a href="https://developers.facebook.com/apps">settings of your application.</a> <br>  and click "Edit".  Go to the section "On Facebook" -&gt; Credits.  Follow the link to <a href="https://secure.facebook.com/developers/company.php">register a new company</a> .  Carefully fill in the fields on your organization.  The most interesting tab is the third one.  This is a bank account setup. <br><br><img src="https://habrastorage.org/storage1/14d59c24/3858ba3b/7e802ead/f9f0905f.png"><br>  <i>Immediately a few tips.</i>  <i>The form podglyuchivaet a few, and if you fill it in incorrectly, it erases some of the fields.</i>  <i>Therefore, I recommend not to click on the ‚ÄúOK‚Äù button, but to click ‚ÄúOpen in a separate window‚Äù - so even in case of errors, you will not have to interrupt the data again.</i>  <i>Fill in all fields in English.</i>  <i>Enter the SWIFT field without spaces.</i> <br><br><img src="https://habrastorage.org/storage1/f08004d4/4c0ba42f/a7c1c4f6/8536023b.png"><br>  After registering an organization, you can add it to receive credits in your application. <br><br><h4>  On a note </h4><br><img src="https://habrastorage.org/storage1/01d00419/576fb2c6/2ee29e88/cca45c1a.jpg" align="left">  According to the rules of Facebook, you can sell <a href="http://www.facebook.com/help/%3Ffaq%3D18408">only virtual goods</a> for Facebook Credits.  Personally, I would be interested to know whether the sale of QR codes is a virtual commodity (if, for example, you can go to the movies by this QR code or order a pizza :-)). <br>  Facebook commission is 30% (this is a lot, but less than, for example, in Odnoklassniki).  In general, there are nuances that need to be taken into account when planning a business strategy for sales in social networks. <br><br><h1>  The overall scheme of Facebook Credits </h1><br>  So, let's see what happens in your application at the moment when the user decides to pay for something and clicks on the cherished button. <br><img src="https://habrastorage.org/storage1/4637ec68/545c6da5/bb20a67e/ea3f1d98.png"><br><br>  Your application using the JavaScript call Facebook Api creates a payment dialog for the goods: <br><pre><code class="javascript hljs">FB.init({<span class="hljs-attr"><span class="hljs-attr">appId</span></span>: <span class="xml"><span class="php"><span class="hljs-meta"><span class="xml"><span class="php"><span class="hljs-meta">&lt;?</span></span></span></span><span class="xml"><span class="php">=$facebookAppID</span></span><span class="hljs-meta"><span class="xml"><span class="php"><span class="hljs-meta">?&gt;</span></span></span></span></span><span class="xml">, status: true, cookie: true}); function placeOrder() { //    var obj = { method: 'pay', order_info: {"order_id": "</span><span class="php"><span class="hljs-meta"><span class="xml"><span class="php"><span class="hljs-meta">&lt;?</span></span></span></span><span class="xml"><span class="php">=$orderId</span></span><span class="hljs-meta"><span class="xml"><span class="php"><span class="hljs-meta">?&gt;</span></span></span></span></span><span class="xml">"}, purchase_type: 'item' }; FB.ui(obj, callback); } var callback = function(data) { if (data['order_id']) { $("#payment").hide(); $("#result-success").show(); } else if ((data['error_code']) &amp;&amp; (data['error_message'].indexOf("User canceled", 0) == -1)) { $("#payment").hide(); $("#result-failure").show(); } else if ((data['error_code']) &amp;&amp; (data['error_message'].indexOf("User canceled", 0) != -1)) { $("#result-cancel").show(); } else { $("#result-failure").show(); } };</span></span></code> </pre> <br><br><img src="https://habrastorage.org/storage1/f75fb841/004c415c/993b3798/10b463b5.png"><br>  Facebook sends a request to the server side of your application for order details: <br><ul><li>  <b>item_id</b> - product identifier; </li><li>  <b>title</b> - the name of the product; </li><li>  <b>description</b> - description; </li><li>  <b>image_url</b> - picture; </li><li>  <b>product_url</b> - link to the page with the product; </li><li>  <b>price</b> - price; </li><li>  <b>data</b> - additional data. </li></ul><br>  As you have noticed, Facebook assumes that a user can buy only one product per transaction.  But nothing prevents you from forming the entire contents of the basket in the form of goods. <br><br>  Client callback will be called immediately after the payment window is closed.  In it, you must process the error / cancellation code, if any, or congratulate the user on a successful purchase. <br><br><h1>  We accept the order </h1><br>  As soon as the user confirms the payment, a second request is sent to your server to change the status of the order.  If everything is ok, your task is to implement an order handler.  For example, send the owner of the store a notification about the order, or set the status ‚Äúpaid‚Äù in the database. <br><br><pre> <code class="hljs bash">&lt;?require(<span class="hljs-variable"><span class="hljs-variable">$_SERVER</span></span>[<span class="hljs-string"><span class="hljs-string">"DOCUMENT_ROOT"</span></span>].<span class="hljs-string"><span class="hljs-string">"/bitrix/modules/main/include/prolog_before.php"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!CModule::IncludeModule(<span class="hljs-string"><span class="hljs-string">"sale"</span></span>) || !CModule::IncludeModule(<span class="hljs-string"><span class="hljs-string">"iblock"</span></span>)) { <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span>(<span class="hljs-string"><span class="hljs-string">" -  !"</span></span>); require(<span class="hljs-variable"><span class="hljs-variable">$_SERVER</span></span>[<span class="hljs-string"><span class="hljs-string">"DOCUMENT_ROOT"</span></span>] . <span class="hljs-string"><span class="hljs-string">"/bitrix/modules/main/include/epilog_after.php"</span></span>); die(); } //    <span class="hljs-variable"><span class="hljs-variable">$frontendPath</span></span> = COption::GetOptionString(<span class="hljs-string"><span class="hljs-string">"sibirix.freshshop"</span></span>, <span class="hljs-string"><span class="hljs-string">"frontend"</span></span>); <span class="hljs-variable"><span class="hljs-variable">$catalogIblockId</span></span> = COption::GetOptionString(<span class="hljs-string"><span class="hljs-string">"sibirix.freshshop"</span></span>, <span class="hljs-string"><span class="hljs-string">"catalogIblockId"</span></span>); <span class="hljs-variable"><span class="hljs-variable">$fbcExchange</span></span> = COption::GetOptionString(<span class="hljs-string"><span class="hljs-string">"sibirix.freshshop"</span></span>, <span class="hljs-string"><span class="hljs-string">"exchange"</span></span>); <span class="hljs-variable"><span class="hljs-variable">$api_key</span></span> = COption::GetOptionString(<span class="hljs-string"><span class="hljs-string">"sibirix.freshshop"</span></span>, <span class="hljs-string"><span class="hljs-string">"facebook_appid"</span></span>); <span class="hljs-variable"><span class="hljs-variable">$secret</span></span> = COption::GetOptionString(<span class="hljs-string"><span class="hljs-string">"sibirix.freshshop"</span></span>, <span class="hljs-string"><span class="hljs-string">"facebook_appsecret"</span></span>); require_once(<span class="hljs-string"><span class="hljs-string">'facebook.php'</span></span>); // prepare the <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> data array <span class="hljs-variable"><span class="hljs-variable">$data</span></span> = array(<span class="hljs-string"><span class="hljs-string">'content'</span></span> =&gt; array()); <span class="hljs-variable"><span class="hljs-variable">$request</span></span> = parse_signed_request(<span class="hljs-variable"><span class="hljs-variable">$_REQUEST</span></span>[<span class="hljs-string"><span class="hljs-string">'signed_request'</span></span>], <span class="hljs-variable"><span class="hljs-variable">$secret</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-variable"><span class="hljs-variable">$request</span></span> == null) { // handle an unauthenticated request here die(<span class="hljs-string"><span class="hljs-string">"empty request\n"</span></span>); } //    order_id     <span class="hljs-built_in"><span class="hljs-built_in">float</span></span>         (      ,    FB).    <span class="hljs-variable"><span class="hljs-variable">$payloadData</span></span> = explode(<span class="hljs-string"><span class="hljs-string">'.'</span></span>, <span class="hljs-variable"><span class="hljs-variable">$_REQUEST</span></span>[<span class="hljs-string"><span class="hljs-string">'signed_request'</span></span>], 2); <span class="hljs-variable"><span class="hljs-variable">$payloadData</span></span> = base64_url_decode(<span class="hljs-variable"><span class="hljs-variable">$payloadData</span></span>[1]); preg_match(<span class="hljs-string"><span class="hljs-string">'/\"order_id\"\:([0-9]*)/'</span></span>, <span class="hljs-variable"><span class="hljs-variable">$payloadData</span></span>, <span class="hljs-variable"><span class="hljs-variable">$matches</span></span>); <span class="hljs-variable"><span class="hljs-variable">$stringOrderId</span></span> = <span class="hljs-variable"><span class="hljs-variable">$matches</span></span>[1]; <span class="hljs-variable"><span class="hljs-variable">$payload</span></span> = <span class="hljs-variable"><span class="hljs-variable">$request</span></span>[<span class="hljs-string"><span class="hljs-string">'credits'</span></span>]; // retrieve all params passed <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-variable"><span class="hljs-variable">$func</span></span> = <span class="hljs-variable"><span class="hljs-variable">$_REQUEST</span></span>[<span class="hljs-string"><span class="hljs-string">'method'</span></span>]; <span class="hljs-variable"><span class="hljs-variable">$order_info</span></span> = json_decode(<span class="hljs-variable"><span class="hljs-variable">$payload</span></span>[<span class="hljs-string"><span class="hljs-string">'order_info'</span></span>]); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!empty(<span class="hljs-variable"><span class="hljs-variable">$order_info</span></span>) &amp;&amp; isset(<span class="hljs-variable"><span class="hljs-variable">$order_info</span></span>-&gt;order_id)) { <span class="hljs-variable"><span class="hljs-variable">$orderId</span></span> = (int)<span class="hljs-variable"><span class="hljs-variable">$order_info</span></span>-&gt;order_id; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (empty(<span class="hljs-variable"><span class="hljs-variable">$orderId</span></span>)) { //   ( ),     order_id  .      order_id <span class="hljs-variable"><span class="hljs-variable">$orderRes</span></span> = CSaleOrder::GetList(array(), array(<span class="hljs-string"><span class="hljs-string">"COMMENTS"</span></span> =&gt; <span class="hljs-variable"><span class="hljs-variable">$stringOrderId</span></span>, <span class="hljs-string"><span class="hljs-string">"PAYED"</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"N"</span></span>), <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-literal"><span class="hljs-literal">false</span></span>, array(<span class="hljs-string"><span class="hljs-string">"*"</span></span>)); <span class="hljs-variable"><span class="hljs-variable">$orderData</span></span> = <span class="hljs-variable"><span class="hljs-variable">$orderRes</span></span>-&gt;GetNext(); <span class="hljs-variable"><span class="hljs-variable">$orderId</span></span> = <span class="hljs-variable"><span class="hljs-variable">$orderData</span></span>[<span class="hljs-string"><span class="hljs-string">'ID'</span></span>]; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { //       <span class="hljs-variable"><span class="hljs-variable">$orderData</span></span> = CSaleOrder::GetByID(<span class="hljs-variable"><span class="hljs-variable">$orderId</span></span>); } <span class="hljs-variable"><span class="hljs-variable">$basketRes</span></span> = CSaleBasket::GetList(array(), array( <span class="hljs-string"><span class="hljs-string">"LID"</span></span> =&gt; SITE_ID, <span class="hljs-string"><span class="hljs-string">"ORDER_ID"</span></span> =&gt; <span class="hljs-variable"><span class="hljs-variable">$orderId</span></span>), <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-literal"><span class="hljs-literal">false</span></span>, array(<span class="hljs-string"><span class="hljs-string">"*"</span></span>)); <span class="hljs-variable"><span class="hljs-variable">$basket</span></span> = array(); <span class="hljs-variable"><span class="hljs-variable">$description</span></span> = array(); <span class="hljs-variable"><span class="hljs-variable">$itemIds</span></span> = array(); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-variable"><span class="hljs-variable">$item</span></span> = <span class="hljs-variable"><span class="hljs-variable">$basketRes</span></span>-&gt;GetNext()) { <span class="hljs-variable"><span class="hljs-variable">$basket</span></span>[] = <span class="hljs-variable"><span class="hljs-variable">$item</span></span>; <span class="hljs-variable"><span class="hljs-variable">$description</span></span>[] = iconv(SITE_CHARSET, <span class="hljs-string"><span class="hljs-string">"UTF-8"</span></span>, <span class="hljs-variable"><span class="hljs-variable">$item</span></span>[<span class="hljs-string"><span class="hljs-string">'~NAME'</span></span>]) . <span class="hljs-string"><span class="hljs-string">" - "</span></span> . number_format(<span class="hljs-variable"><span class="hljs-variable">$item</span></span>[<span class="hljs-string"><span class="hljs-string">'QUANTITY'</span></span>], 0) . <span class="hljs-string"><span class="hljs-string">"."</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!empty(<span class="hljs-variable"><span class="hljs-variable">$item</span></span>[<span class="hljs-string"><span class="hljs-string">'PRODUCT_ID'</span></span>])) <span class="hljs-variable"><span class="hljs-variable">$itemIds</span></span>[] = <span class="hljs-variable"><span class="hljs-variable">$item</span></span>[<span class="hljs-string"><span class="hljs-string">'PRODUCT_ID'</span></span>]; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (count(<span class="hljs-variable"><span class="hljs-variable">$itemIds</span></span>)) { <span class="hljs-variable"><span class="hljs-variable">$res</span></span> = CIBlockElement::GetList(array(), array(<span class="hljs-string"><span class="hljs-string">"IBLOCK_ID"</span></span> =&gt; <span class="hljs-variable"><span class="hljs-variable">$catalogIblockId</span></span>, <span class="hljs-string"><span class="hljs-string">"ID"</span></span> =&gt; <span class="hljs-variable"><span class="hljs-variable">$itemIds</span></span>), <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-literal"><span class="hljs-literal">false</span></span>, array(<span class="hljs-string"><span class="hljs-string">"DETAIL_PICTURE"</span></span>, <span class="hljs-string"><span class="hljs-string">"PREVIEW_PICTURE"</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-variable"><span class="hljs-variable">$item</span></span> = <span class="hljs-variable"><span class="hljs-variable">$res</span></span>-&gt;GetNext()) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!empty(<span class="hljs-variable"><span class="hljs-variable">$item</span></span>[<span class="hljs-string"><span class="hljs-string">'DETAIL_PICTURE'</span></span>])) { <span class="hljs-variable"><span class="hljs-variable">$pictureId</span></span> = <span class="hljs-variable"><span class="hljs-variable">$item</span></span>[<span class="hljs-string"><span class="hljs-string">'DETAIL_PICTURE'</span></span>]; <span class="hljs-built_in"><span class="hljs-built_in">break</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!empty(<span class="hljs-variable"><span class="hljs-variable">$item</span></span>[<span class="hljs-string"><span class="hljs-string">'PREVIEW_PICTURE'</span></span>])) { <span class="hljs-variable"><span class="hljs-variable">$pictureId</span></span> = <span class="hljs-variable"><span class="hljs-variable">$item</span></span>[<span class="hljs-string"><span class="hljs-string">'PREVIEW_PICTURE'</span></span>]; <span class="hljs-built_in"><span class="hljs-built_in">break</span></span>; } } } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (isset(<span class="hljs-variable"><span class="hljs-variable">$pictureId</span></span>)) { <span class="hljs-variable"><span class="hljs-variable">$uploadDir</span></span> = <span class="hljs-string"><span class="hljs-string">"/"</span></span> . COption::GetOptionString(<span class="hljs-string"><span class="hljs-string">"main"</span></span>, <span class="hljs-string"><span class="hljs-string">"upload_dir"</span></span>, <span class="hljs-string"><span class="hljs-string">"upload"</span></span>) . <span class="hljs-string"><span class="hljs-string">"/"</span></span>; <span class="hljs-variable"><span class="hljs-variable">$resFile</span></span> = CFile::GetList(array(), array(<span class="hljs-string"><span class="hljs-string">"ID"</span></span> =&gt; <span class="hljs-variable"><span class="hljs-variable">$pictureId</span></span>)); <span class="hljs-variable"><span class="hljs-variable">$ifile</span></span> = <span class="hljs-variable"><span class="hljs-variable">$resFile</span></span>-&gt;Fetch(); <span class="hljs-variable"><span class="hljs-variable">$picture</span></span> = <span class="hljs-variable"><span class="hljs-variable">$ifile</span></span>; <span class="hljs-variable"><span class="hljs-variable">$picture</span></span>[<span class="hljs-string"><span class="hljs-string">'SRC'</span></span>] = <span class="hljs-variable"><span class="hljs-variable">$uploadDir</span></span> . <span class="hljs-variable"><span class="hljs-variable">$ifile</span></span>[<span class="hljs-string"><span class="hljs-string">"SUBDIR"</span></span>] . <span class="hljs-string"><span class="hljs-string">"/"</span></span> . <span class="hljs-variable"><span class="hljs-variable">$ifile</span></span>[<span class="hljs-string"><span class="hljs-string">'FILE_NAME'</span></span>]; } <span class="hljs-variable"><span class="hljs-variable">$picture</span></span> = CFacebookShop::getThumbImage(<span class="hljs-variable"><span class="hljs-variable">$picture</span></span>, CFacebookShop::PRODUCT_PREVIEW_IMG, SITE_TEMPLATE_PATH.<span class="hljs-string"><span class="hljs-string">'/images'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-variable"><span class="hljs-variable">$orderData</span></span>[<span class="hljs-string"><span class="hljs-string">'PAYED'</span></span>] == <span class="hljs-string"><span class="hljs-string">"Y"</span></span>) { //     <span class="hljs-variable"><span class="hljs-variable">$data</span></span>[<span class="hljs-string"><span class="hljs-string">'content'</span></span>][<span class="hljs-string"><span class="hljs-string">'status'</span></span>] = <span class="hljs-string"><span class="hljs-string">'settled'</span></span>; } elseif (<span class="hljs-variable"><span class="hljs-variable">$func</span></span> == <span class="hljs-string"><span class="hljs-string">'payments_status_update'</span></span>) { // FB  ,     <span class="hljs-variable"><span class="hljs-variable">$status</span></span> = <span class="hljs-variable"><span class="hljs-variable">$payload</span></span>[<span class="hljs-string"><span class="hljs-string">'status'</span></span>]; // write your logic here, determine the state you wanna move to <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-variable"><span class="hljs-variable">$status</span></span> == <span class="hljs-string"><span class="hljs-string">'placed'</span></span>) { <span class="hljs-variable"><span class="hljs-variable">$next_state</span></span> = <span class="hljs-string"><span class="hljs-string">'settled'</span></span>; <span class="hljs-variable"><span class="hljs-variable">$data</span></span>[<span class="hljs-string"><span class="hljs-string">'content'</span></span>][<span class="hljs-string"><span class="hljs-string">'status'</span></span>] = <span class="hljs-variable"><span class="hljs-variable">$next_state</span></span>; //   <span class="hljs-variable"><span class="hljs-variable">$ret</span></span> = CSaleOrder::PayOrder(<span class="hljs-variable"><span class="hljs-variable">$orderId</span></span>, <span class="hljs-string"><span class="hljs-string">"Y"</span></span>); } // compose returning data array_change_key_case <span class="hljs-variable"><span class="hljs-variable">$data</span></span>[<span class="hljs-string"><span class="hljs-string">'content'</span></span>][<span class="hljs-string"><span class="hljs-string">'order_id'</span></span>] = <span class="hljs-variable"><span class="hljs-variable">$orderId</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-variable"><span class="hljs-variable">$func</span></span> == <span class="hljs-string"><span class="hljs-string">'payments_get_items'</span></span>) { // FB      <span class="hljs-variable"><span class="hljs-variable">$item</span></span>[<span class="hljs-string"><span class="hljs-string">'title'</span></span>] = <span class="hljs-string"><span class="hljs-string">' ‚Ññ'</span></span> . <span class="hljs-variable"><span class="hljs-variable">$orderId</span></span> . <span class="hljs-string"><span class="hljs-string">"    "</span></span> . COption::GetOptionString(<span class="hljs-string"><span class="hljs-string">"main"</span></span>, <span class="hljs-string"><span class="hljs-string">"site_name"</span></span>); <span class="hljs-variable"><span class="hljs-variable">$item</span></span>[<span class="hljs-string"><span class="hljs-string">'price'</span></span>] = ceil(<span class="hljs-variable"><span class="hljs-variable">$orderData</span></span>[<span class="hljs-string"><span class="hljs-string">'PRICE'</span></span>] / <span class="hljs-variable"><span class="hljs-variable">$fbcExchange</span></span>); <span class="hljs-variable"><span class="hljs-variable">$item</span></span>[<span class="hljs-string"><span class="hljs-string">'description'</span></span>] = implode(<span class="hljs-string"><span class="hljs-string">", "</span></span>, <span class="hljs-variable"><span class="hljs-variable">$description</span></span>); <span class="hljs-variable"><span class="hljs-variable">$item</span></span>[<span class="hljs-string"><span class="hljs-string">'image_url'</span></span>] = <span class="hljs-string"><span class="hljs-string">"http://"</span></span> . COption::GetOptionString(<span class="hljs-string"><span class="hljs-string">"main"</span></span>, <span class="hljs-string"><span class="hljs-string">"server_name"</span></span>) . <span class="hljs-variable"><span class="hljs-variable">$picture</span></span>; <span class="hljs-variable"><span class="hljs-variable">$item</span></span>[<span class="hljs-string"><span class="hljs-string">'product_url'</span></span>] = <span class="hljs-string"><span class="hljs-string">"http://"</span></span> . COption::GetOptionString(<span class="hljs-string"><span class="hljs-string">"main"</span></span>, <span class="hljs-string"><span class="hljs-string">"server_name"</span></span>) . <span class="hljs-variable"><span class="hljs-variable">$picture</span></span>; <span class="hljs-variable"><span class="hljs-variable">$item</span></span>[<span class="hljs-string"><span class="hljs-string">'order_id'</span></span>] = <span class="hljs-variable"><span class="hljs-variable">$orderId</span></span>; CSaleOrder::Update(<span class="hljs-variable"><span class="hljs-variable">$orderId</span></span>, array(<span class="hljs-string"><span class="hljs-string">"COMMENTS"</span></span> =&gt; <span class="hljs-variable"><span class="hljs-variable">$stringOrderId</span></span>)); <span class="hljs-variable"><span class="hljs-variable">$data</span></span>[<span class="hljs-string"><span class="hljs-string">'content'</span></span>] = array(<span class="hljs-variable"><span class="hljs-variable">$item</span></span>); } // required by api_fetch_response() <span class="hljs-variable"><span class="hljs-variable">$data</span></span>[<span class="hljs-string"><span class="hljs-string">'method'</span></span>] = <span class="hljs-variable"><span class="hljs-variable">$func</span></span>; // send data back <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> json_encode(<span class="hljs-variable"><span class="hljs-variable">$data</span></span>); // you can find the following <span class="hljs-built_in"><span class="hljs-built_in">functions</span></span> and more details // on http://developers.facebook.com/docs/authentication/canvas <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> parse_signed_request(<span class="hljs-variable"><span class="hljs-variable">$signed_request</span></span>, <span class="hljs-variable"><span class="hljs-variable">$secret</span></span>) { list(<span class="hljs-variable"><span class="hljs-variable">$encoded_sig</span></span>, <span class="hljs-variable"><span class="hljs-variable">$payload</span></span>) = explode(<span class="hljs-string"><span class="hljs-string">'.'</span></span>, <span class="hljs-variable"><span class="hljs-variable">$signed_request</span></span>, 2); <span class="hljs-variable"><span class="hljs-variable">$sig</span></span> = base64_url_decode(<span class="hljs-variable"><span class="hljs-variable">$encoded_sig</span></span>); <span class="hljs-variable"><span class="hljs-variable">$data</span></span> = json_decode(base64_url_decode(<span class="hljs-variable"><span class="hljs-variable">$payload</span></span>), <span class="hljs-literal"><span class="hljs-literal">true</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (strtoupper(<span class="hljs-variable"><span class="hljs-variable">$data</span></span>[<span class="hljs-string"><span class="hljs-string">'algorithm'</span></span>]) !== <span class="hljs-string"><span class="hljs-string">'HMAC-SHA256'</span></span>) { error_log(<span class="hljs-string"><span class="hljs-string">'Unknown algorithm. Expected HMAC-SHA256'</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> null; } // check signature <span class="hljs-variable"><span class="hljs-variable">$expected_sig</span></span> = hash_hmac(<span class="hljs-string"><span class="hljs-string">'sha256'</span></span>, <span class="hljs-variable"><span class="hljs-variable">$payload</span></span>, <span class="hljs-variable"><span class="hljs-variable">$secret</span></span>, <span class="hljs-variable"><span class="hljs-variable">$raw</span></span> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-variable"><span class="hljs-variable">$sig</span></span> !== <span class="hljs-variable"><span class="hljs-variable">$expected_sig</span></span>) { error_log(<span class="hljs-string"><span class="hljs-string">'Bad Signed JSON signature!'</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> null; } <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> <span class="hljs-variable"><span class="hljs-variable">$data</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> base64_url_decode(<span class="hljs-variable"><span class="hljs-variable">$input</span></span>) { <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> base64_decode(strtr(<span class="hljs-variable"><span class="hljs-variable">$input</span></span>, <span class="hljs-string"><span class="hljs-string">'-_'</span></span>, <span class="hljs-string"><span class="hljs-string">'+/'</span></span>)); } require(<span class="hljs-variable"><span class="hljs-variable">$_SERVER</span></span>[<span class="hljs-string"><span class="hljs-string">"DOCUMENT_ROOT"</span></span>].<span class="hljs-string"><span class="hljs-string">"/bitrix/modules/main/include/epilog_after.php"</span></span>);?&gt;</code> </pre><br><br><h1>  We register payment system </h1><br><img src="https://habrastorage.org/storage1/9d124007/12ae1e8f/ca63a787/fc07cf96.png"><br><br>  We wrote the payment specifically for orders through 1C-Bitrix, so it remains a trifle: to register the payment system in the list of 1C-Bitrix payment systems when installing the module: <br><br><pre> <code class="hljs bash">//    Facebook Credits <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> <span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">InstallPaysystem</span></span></span></span>() { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!CModule::IncludeModule(<span class="hljs-string"><span class="hljs-string">"sale"</span></span>) || !CModule::IncludeModule(<span class="hljs-string"><span class="hljs-string">"catalog"</span></span>)) { throw new Exception(<span class="hljs-string"><span class="hljs-string">"Can't include sale and catalog modules"</span></span>); } <span class="hljs-variable"><span class="hljs-variable">$paysystemRes</span></span> = CSalePaySystem::GetList(array(), array(<span class="hljs-string"><span class="hljs-string">"NAME"</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"Facebook Credits"</span></span>)); <span class="hljs-variable"><span class="hljs-variable">$paysystem</span></span> = <span class="hljs-variable"><span class="hljs-variable">$paysystemRes</span></span>-&gt;GetNext(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!empty(<span class="hljs-variable"><span class="hljs-variable">$paysystem</span></span>)) { //  ,   ID COption::SetOptionString(<span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;MODULE_ID, <span class="hljs-string"><span class="hljs-string">"paysystemId"</span></span>, <span class="hljs-variable"><span class="hljs-variable">$paysystem</span></span>[<span class="hljs-string"><span class="hljs-string">'ID'</span></span>]); <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-variable"><span class="hljs-variable">$paysystemId</span></span> = CSalePaySystem::Add(array( <span class="hljs-string"><span class="hljs-string">"LID"</span></span> =&gt; SITE_ID, <span class="hljs-string"><span class="hljs-string">"CURRENCY"</span></span> =&gt; CCurrency::GetBaseCurrency(), <span class="hljs-string"><span class="hljs-string">"NAME"</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"Facebook Credits"</span></span>, <span class="hljs-string"><span class="hljs-string">"ACTIVE"</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"N"</span></span>, <span class="hljs-string"><span class="hljs-string">"DESCRIPTION"</span></span> =&gt; GetMessage(<span class="hljs-string"><span class="hljs-string">"SHOPBOOK_INSTALL_FBC_DESCR"</span></span>) )); COption::SetOptionString(<span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;MODULE_ID, <span class="hljs-string"><span class="hljs-string">"paysystemId"</span></span>, <span class="hljs-variable"><span class="hljs-variable">$paysystem</span></span>[<span class="hljs-string"><span class="hljs-string">'ID'</span></span>]); } <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; }</code> </pre><br><br>  Voila!  Our store is ready to receive virtual money from Facebook Credits, ct.d. </div><p>Source: <a href="https://habr.com/ru/post/125718/">https://habr.com/ru/post/125718/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../125712/index.html">Evernote for Windows Phone update: edit rich text, checkbox support, and more</a></li>
<li><a href="../125713/index.html">Aeon Project for future cars</a></li>
<li><a href="../125714/index.html">Fantasy sport: what it is, why it is, and how it affects real life</a></li>
<li><a href="../125716/index.html">N00ter software package allows you to avoid shaping by type of traffic</a></li>
<li><a href="../125717/index.html">Akka for Java developer (part 1)</a></li>
<li><a href="../125719/index.html">Epidemic in the data</a></li>
<li><a href="../125720/index.html">Getting an instance of a query class by its interface signature</a></li>
<li><a href="../125721/index.html">Jimmy Wales: Wikipedia loses authors</a></li>
<li><a href="../125722/index.html">thank you!</a></li>
<li><a href="../125723/index.html">Survival Guide on Black Hat and Defcon conferences: how to escape from hackers</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>