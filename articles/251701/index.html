<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>PhonoPaper Optimization Using Intel Tools</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Some time ago I already wrote about one of my developments - the PhonoPaper technology and the program of the same name, which allows you to play soun...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>PhonoPaper Optimization Using Intel Tools</h1><div class="post__text post__text-html js-mediator-article">  Some time ago I <a href="http://habrahabr.ru/post/220061">already wrote</a> about one of my developments - the <a href="http://warmplace.ru/soft/phonopaper/index_ru.php">PhonoPaper</a> technology and the program of the same name, which allows you to play sound printed in the form of a spectrogram on paper or any other surface.  The process looks like this: 10 seconds of sound (voice, a piece of a song) are converted into a picture of a special format.  The picture is printed and, for example, glued to the wall.  A passerby, noticing the code, launches the PhonoPaper-scanner on the phone, points the camera at the picture and at the same moment begins to hear the sound encoded in it.  At the same time, the user is fully involved in the process - the direction and speed of playback depend on the movement of his hand (although there is also an automatic mode).  All necessary information is stored in the image, no Internet access is required. <br><br><iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/-GAJ9e8ifYU%3Ffeature%3Doembed&amp;xid=17259,1500002,15700021,15700186,15700191,15700253&amp;usg=ALkJrhj8lM8p-5eVFHi0kPL-auqyHkUSLw" frameborder="0" allowfullscreen=""></iframe><br><br>  PhonoPaper has aroused keen interest among musicians, artists, and just lovers of unusual experiments.  And in the third quarter of last year, the application <a href="http://apps4all.ru/post/10-08-14-zvukovaya-dopolnennaya-realnost-phonopaper-top-razrabotchik-intel">won first place</a> in the <a href="http://apps4all.ru/ecos/intel/cases">Intel Rating for Developers</a> project on Apps4All.ru.  In this connection, Intel kindly provided me with a tablet based on Android x86 for further improvement and optimization of PhonoPaper.  I was quick to take advantage of this, and I will tell you more about the work done and the results. <a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h1>  Video capture </h1><br>  The first thing that was done was the <a href="https://software.intel.com/en-us/media-for-mobile">Intel INDE Media for Mobile</a> library.  Specifically, the GLCapture class for capturing video from an OpenGL ES surface in real time (in HD quality and with sound).  Why do you need it?  First of all, the process of searching and playing PhonoPaper codes itself is a fun, exciting spectacle that resembles playing on some unusual musical instrument.  Secondly, PhonoPaper can work in a free mode when everything is converted into sound without analysis - including your carpet and a cat.  Both would be great to record and share on YouTube. <br><br><iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/cT0sqz-sc-A%3Ffeature%3Doembed&amp;xid=17259,1500002,15700021,15700186,15700191,15700253&amp;usg=ALkJrhhAI8qPMyXmkirn_rDS8hMwHAm7wQ" frameborder="0" allowfullscreen=""></iframe><br>  Hand-drawn PhonoPaper Codes <br><br><iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/kj7X6O4SUk8%3Ffeature%3Doembed&amp;xid=17259,1500002,15700021,15700186,15700191,15700253&amp;usg=ALkJrhjEiyf2eGTFM9Y22DDNQJXusYK6bg" frameborder="0" allowfullscreen=""></iframe><br>  Free mode - any image from the camera is perceived as a spectrum of sound. <br><br>  The process of connecting GLCapture is repeatedly described in <a href="http://habrahabr.ru/company/intel/blog/218761/">different</a> <a href="http://habrahabr.ru/company/intel/blog/219649/">articles</a> .  I'll tell you about a few points that you should know about before starting work. <br><ul><li>  Android version must be at least 4.3.  For older devices, I made a cross-platform MJPEG recorder, the speed and quality of which, of course, is much inferior to hardware-accelerated GLCapture, writing in mp4. </li><li>  The application must be built on the basis of OpenGL ES 2.0.  My programs historically used version 1.1, so the code had to be rewritten.  But the transition to GLES 2.0 ultimately had a positive impact on performance, since it became possible to manually configure shaders. </li><li>  GLCapture can write sound from a microphone.  This is good if you need to accompany the video with your comments.  If you need high-quality sound directly from the application, you will have to record it separately into a file, and then merge with mp4.  For merging, you can use the MediaComposer class with the SubstituteAudioEffect effect from the Media for Mobile suite.  Another way is to write to WAV, encode from WAV to AAC, add an AAC track to an mp4 file using the <a href="https://github.com/sannies/mp4parser">mp4parser</a> library. </li></ul><br>  Since PhonoPaper is written in the <a href="http://warmplace.ru/soft/pixilang/index_ru.php">Pixilang</a> programming language, the video capture function will be further distributed to other pixilang-based applications (PixiTracker, PixiVisor, Nature - Oscillator, Virtual ANS), and most importantly - will be available to all developers using Pixilang.  At the same time it is very easy to access (just a few functions: to start capturing, to stop and save). <br><br><h1>  Intel C ++ and Optimization </h1><br>  The next step is to build the x86 Android version of PhonoPaper using the Intel compiler (version 15.0.0) and compare the results with GCC 4.8.  I am a user of Debian Linux and a rather old version to the same.  Therefore, the first problem was to find the appropriate version of Intel C ++.  For some reason, most of the links led to the Intel INDE project, within which there is the correct compiler, but only for Windows and OS X. This seemed strange ... Fortunately, the correct distribution was still found - this is <a href="https://software.intel.com/en-us/intel-system-studio">Intel System Studio 2015</a> .  And despite the warnings during installation, everything worked and the very first build was successful. <br><br>  Compilation was performed with the following keys: <i>-xATOM_SSSE3 -ipo -fomit-frame-pointer -fstrict-aliasing -finline-limit = 300 -ffunction-sections -restrict</i> .  To test the performance of the Pixilang virtual machine (it is based on all my applications), small tests were written, the source code and the results of which can be found in <a href="">this archive</a> .  As a result, even without preliminary preparation, some pieces of code were sped up 5 (!) Times.  Pretty impressive results! <br><br>  In PhonoPaper most of the load goes to the function of the spectral synthesizer (table-wave, not FFT) - <i>wavetable_generator ()</i> .  A separate test was written for it, which for four seconds renders a stream of sound with a random spectrum.  At the end, the test gives the highest possible sampling rate.  Alas, here ICC coped worse: 105 kHz versus 100 kHz on the GCC.  When compiling, we <i>add the -qopt-report = 2</i> key and see the message in the report: <br><br><blockquote>  loop was not vectorized: vector vector. </blockquote><br>  The main loop inside our function could not be vectorized, since the input data pointers can point to overlapping sections of memory: <br><br><pre><code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span>* amp = (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>*)amp_cont-&gt;data <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>* amp_delta = (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>*)amp_delta_cont-&gt;data;</code> </pre> <br>  As a developer, I see that in this place the intersection is excluded and you just need to inform the compiler.  In C / C ++, there is a special keyword, restrict, indicating that the pointer being declared points to a block of memory that no other pointer points to.  Therefore, the above code is replaced by this: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span>* <span class="hljs-keyword"><span class="hljs-keyword">restrict</span></span> amp = (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>*)amp_cont-&gt;data; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>* <span class="hljs-keyword"><span class="hljs-keyword">restrict</span></span> amp_delta = (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>*)amp_delta_cont-&gt;data;</code> </pre><br>  After that, once again we collect the application and see that the cycle has been successfully vectorized.  Taking into account some additional changes (in the process it turned out that it is possible to get rid of several bit operations) we have a result - 190 kHz.  GCC with the same changes issued 130 kHz.  We get a performance increase of 1.46 times! <br><br><h1>  What's next </h1><br>  As you can see, the results are very positive!  PhonoPaper became faster (thanks in large part to the Intel C ++ compiler) and gained the functionality of video capture.  In addition, the video recording will appear in the form of a few simple functions in the next update Pixilang 3.6. <br>  For those who do not know, Pixilang is an open cross-platform programming language, sharpened to work with sound and graphics.  The syntax of the language is very minimalistic and is a kind of a hybrid of BASIC and C, which, together with other features (the ability to write code without functions, universal containers for storing any data) reduces the threshold of entry. </div><p>Source: <a href="https://habr.com/ru/post/251701/">https://habr.com/ru/post/251701/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../251687/index.html">Conversational bot for Vkontakte in PHP</a></li>
<li><a href="../251689/index.html">6 principles of visual hierarchy</a></li>
<li><a href="../251691/index.html">Record of the webinar "What's new in Kerio Control 8.5"</a></li>
<li><a href="../251693/index.html">The quality of data networks. Transport</a></li>
<li><a href="../251695/index.html">LEDs, tapes and their power supply from alternating current</a></li>
<li><a href="../251703/index.html">How to set up free alerts about problems with your site</a></li>
<li><a href="../251705/index.html">"Reverse Engineering" client application in an educational center</a></li>
<li><a href="../251707/index.html">Our company at the largest game development conference in San Francisco - GDC</a></li>
<li><a href="../251709/index.html">7 Tips for Creating GIF Animations</a></li>
<li><a href="../251711/index.html">Blog of the Department of Information Technology of the city of Moscow on "Habrahabr"</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>