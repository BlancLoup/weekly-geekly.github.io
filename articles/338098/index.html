<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We pull video from YouTube and distribute via WebRTC in real-time</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The task is as follows. To share video with YouTube in real time by several users. Viewers should receive video at the same time, with minimal delay. ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We pull video from YouTube and distribute via WebRTC in real-time</h1><div class="post__text post__text-html js-mediator-article"><div style="text-align:center;"><img src="https://habrastorage.org/web/0b9/9c2/1fb/0b99c21fbb9f42f78f7bea5b4902b4d1.jpg"></div><br><br>  The task is as follows.  To share video with YouTube in real time by several users.  Viewers should receive video at the same time, with minimal delay. <a name="habracut"></a><br><br><h2>  Movie Stream </h2><br>  It is clear that if each of the spectators just starts playing the video, the goal will not be achieved, because  one will get the video faster, the other slower.  There will be an uncontrollable scatter. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In order to scatter was not necessary to distribute this video all at once.  This can be realized if you wrap the clip in Live-stream.  We will show how to do this using the bundle of <a href="https://github.com/rg3/youtube-dl">this library</a> with ffmpeg. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/web/39d/0b5/f32/39d0b5f32ac04547b266a4721047aba6.jpg"></div><br>  We need to implement the scheme described above.  Namely, ydl connects to YouTube and starts downloading the video.  FFmpeg picks up the downloaded video, wraps it in an RTMP stream and sends it to the server.  The server distributes the received stream as WebRTC in real time. <br><br><h2>  Installing youtube-dl </h2><br>  We start by installing youtube-dl.  The installation process on Linux is extremely simple and is described <a href="">in</a> detail <a href="">in the Readme under Lin and under Win</a> . <br><br>  1. Download. <br><br><pre><code class="bash hljs">curl -L https://yt-dl.org/downloads/latest/youtube-dl -o /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/bin/youtube-dl</code> </pre> <br>  2. We give launch rights <br><br><pre> <code class="bash hljs">chmod a+rx /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/bin/youtube-dl</code> </pre> <br>  That's all.  YouTube downloader is ready to go. <br><br>  Take a YouTube video and look at its meta data: <br><br><pre> <code class="bash hljs">youtube-dl --list-formats https://www.youtube.com/watch?v=9cQT4urTlXM</code> </pre> <br>  The result will be: <br><br><pre> <code class="hljs pgsql">[youtube] <span class="hljs-number"><span class="hljs-number">9</span></span>cQT4urTlXM: Downloading webpage [youtube] <span class="hljs-number"><span class="hljs-number">9</span></span>cQT4urTlXM: Downloading video <span class="hljs-keyword"><span class="hljs-keyword">info</span></span> webpage [youtube] <span class="hljs-number"><span class="hljs-number">9</span></span>cQT4urTlXM: Extracting video information [youtube] <span class="hljs-number"><span class="hljs-number">9</span></span>cQT4urTlXM: Downloading MPD manifest [<span class="hljs-keyword"><span class="hljs-keyword">info</span></span>] Available formats <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-number"><span class="hljs-number">9</span></span>cQT4urTlXM: <span class="hljs-keyword"><span class="hljs-keyword">format</span></span> code <span class="hljs-keyword"><span class="hljs-keyword">extension</span></span> resolution note <span class="hljs-number"><span class="hljs-number">171</span></span> webm audio <span class="hljs-keyword"><span class="hljs-keyword">only</span></span> DASH audio <span class="hljs-number"><span class="hljs-number">8</span></span>k , vorbis@<span class="hljs-number"><span class="hljs-number">128</span></span>k, <span class="hljs-number"><span class="hljs-number">540.24</span></span>KiB <span class="hljs-number"><span class="hljs-number">249</span></span> webm audio <span class="hljs-keyword"><span class="hljs-keyword">only</span></span> DASH audio <span class="hljs-number"><span class="hljs-number">10</span></span>k , opus @ <span class="hljs-number"><span class="hljs-number">50</span></span>k, <span class="hljs-number"><span class="hljs-number">797.30</span></span>KiB <span class="hljs-number"><span class="hljs-number">250</span></span> webm audio <span class="hljs-keyword"><span class="hljs-keyword">only</span></span> DASH audio <span class="hljs-number"><span class="hljs-number">10</span></span>k , opus @ <span class="hljs-number"><span class="hljs-number">70</span></span>k, <span class="hljs-number"><span class="hljs-number">797.30</span></span>KiB <span class="hljs-number"><span class="hljs-number">251</span></span> webm audio <span class="hljs-keyword"><span class="hljs-keyword">only</span></span> DASH audio <span class="hljs-number"><span class="hljs-number">10</span></span>k , opus @<span class="hljs-number"><span class="hljs-number">160</span></span>k, <span class="hljs-number"><span class="hljs-number">797.30</span></span>KiB <span class="hljs-number"><span class="hljs-number">139</span></span> m4a audio <span class="hljs-keyword"><span class="hljs-keyword">only</span></span> DASH audio <span class="hljs-number"><span class="hljs-number">53</span></span>k , m4a_dash container, mp4a<span class="hljs-number"><span class="hljs-number">.40</span></span><span class="hljs-number"><span class="hljs-number">.5</span></span>@ <span class="hljs-number"><span class="hljs-number">48</span></span>k (<span class="hljs-number"><span class="hljs-number">22050</span></span>Hz), <span class="hljs-number"><span class="hljs-number">10.36</span></span>MiB <span class="hljs-number"><span class="hljs-number">140</span></span> m4a audio <span class="hljs-keyword"><span class="hljs-keyword">only</span></span> DASH audio <span class="hljs-number"><span class="hljs-number">137</span></span>k , m4a_dash container, mp4a<span class="hljs-number"><span class="hljs-number">.40</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span>@<span class="hljs-number"><span class="hljs-number">128</span></span>k (<span class="hljs-number"><span class="hljs-number">44100</span></span>Hz), <span class="hljs-number"><span class="hljs-number">27.56</span></span>MiB <span class="hljs-number"><span class="hljs-number">278</span></span> webm <span class="hljs-number"><span class="hljs-number">256</span></span>x144 <span class="hljs-number"><span class="hljs-number">144</span></span>p <span class="hljs-number"><span class="hljs-number">41</span></span>k , webm container, vp9, <span class="hljs-number"><span class="hljs-number">30</span></span>fps, video <span class="hljs-keyword"><span class="hljs-keyword">only</span></span>, <span class="hljs-number"><span class="hljs-number">6.54</span></span>MiB <span class="hljs-number"><span class="hljs-number">242</span></span> webm <span class="hljs-number"><span class="hljs-number">426</span></span>x240 <span class="hljs-number"><span class="hljs-number">240</span></span>p <span class="hljs-number"><span class="hljs-number">70</span></span>k , vp9, <span class="hljs-number"><span class="hljs-number">30</span></span>fps, video <span class="hljs-keyword"><span class="hljs-keyword">only</span></span>, <span class="hljs-number"><span class="hljs-number">13.42</span></span>MiB <span class="hljs-number"><span class="hljs-number">243</span></span> webm <span class="hljs-number"><span class="hljs-number">640</span></span>x360 <span class="hljs-number"><span class="hljs-number">360</span></span>p <span class="hljs-number"><span class="hljs-number">101</span></span>k , vp9, <span class="hljs-number"><span class="hljs-number">30</span></span>fps, video <span class="hljs-keyword"><span class="hljs-keyword">only</span></span>, <span class="hljs-number"><span class="hljs-number">20.55</span></span>MiB <span class="hljs-number"><span class="hljs-number">160</span></span> mp4 <span class="hljs-number"><span class="hljs-number">256</span></span>x144 DASH video <span class="hljs-number"><span class="hljs-number">123</span></span>k , avc1<span class="hljs-number"><span class="hljs-number">.4</span></span>d400c, <span class="hljs-number"><span class="hljs-number">15</span></span>fps, video <span class="hljs-keyword"><span class="hljs-keyword">only</span></span>, <span class="hljs-number"><span class="hljs-number">24.83</span></span>MiB <span class="hljs-number"><span class="hljs-number">134</span></span> mp4 <span class="hljs-number"><span class="hljs-number">640</span></span>x360 DASH video <span class="hljs-number"><span class="hljs-number">138</span></span>k , avc1<span class="hljs-number"><span class="hljs-number">.4</span></span>d401e, <span class="hljs-number"><span class="hljs-number">30</span></span>fps, video <span class="hljs-keyword"><span class="hljs-keyword">only</span></span>, <span class="hljs-number"><span class="hljs-number">28.07</span></span>MiB <span class="hljs-number"><span class="hljs-number">244</span></span> webm <span class="hljs-number"><span class="hljs-number">854</span></span>x480 <span class="hljs-number"><span class="hljs-number">480</span></span>p <span class="hljs-number"><span class="hljs-number">149</span></span>k , vp9, <span class="hljs-number"><span class="hljs-number">30</span></span>fps, video <span class="hljs-keyword"><span class="hljs-keyword">only</span></span>, <span class="hljs-number"><span class="hljs-number">30.55</span></span>MiB <span class="hljs-number"><span class="hljs-number">135</span></span> mp4 <span class="hljs-number"><span class="hljs-number">854</span></span>x480 DASH video <span class="hljs-number"><span class="hljs-number">209</span></span>k , avc1<span class="hljs-number"><span class="hljs-number">.4</span></span>d401f, <span class="hljs-number"><span class="hljs-number">30</span></span>fps, video <span class="hljs-keyword"><span class="hljs-keyword">only</span></span>, <span class="hljs-number"><span class="hljs-number">42.42</span></span>MiB <span class="hljs-number"><span class="hljs-number">133</span></span> mp4 <span class="hljs-number"><span class="hljs-number">426</span></span>x240 DASH video <span class="hljs-number"><span class="hljs-number">274</span></span>k , avc1<span class="hljs-number"><span class="hljs-number">.4</span></span>d4015, <span class="hljs-number"><span class="hljs-number">30</span></span>fps, video <span class="hljs-keyword"><span class="hljs-keyword">only</span></span>, <span class="hljs-number"><span class="hljs-number">57.63</span></span>MiB <span class="hljs-number"><span class="hljs-number">247</span></span> webm <span class="hljs-number"><span class="hljs-number">1280</span></span>x720 <span class="hljs-number"><span class="hljs-number">720</span></span>p <span class="hljs-number"><span class="hljs-number">298</span></span>k , vp9, <span class="hljs-number"><span class="hljs-number">30</span></span>fps, video <span class="hljs-keyword"><span class="hljs-keyword">only</span></span>, <span class="hljs-number"><span class="hljs-number">59.25</span></span>MiB <span class="hljs-number"><span class="hljs-number">136</span></span> mp4 <span class="hljs-number"><span class="hljs-number">1280</span></span>x720 DASH video <span class="hljs-number"><span class="hljs-number">307</span></span>k , avc1<span class="hljs-number"><span class="hljs-number">.4</span></span>d401f, <span class="hljs-number"><span class="hljs-number">30</span></span>fps, video <span class="hljs-keyword"><span class="hljs-keyword">only</span></span>, <span class="hljs-number"><span class="hljs-number">62.58</span></span>MiB <span class="hljs-number"><span class="hljs-number">17</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span>gp <span class="hljs-number"><span class="hljs-number">176</span></span>x144 small , mp4v<span class="hljs-number"><span class="hljs-number">.20</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span>, mp4a<span class="hljs-number"><span class="hljs-number">.40</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span>@ <span class="hljs-number"><span class="hljs-number">24</span></span>k <span class="hljs-number"><span class="hljs-number">36</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span>gp <span class="hljs-number"><span class="hljs-number">320</span></span>x180 small , mp4v<span class="hljs-number"><span class="hljs-number">.20</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span>, mp4a<span class="hljs-number"><span class="hljs-number">.40</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> <span class="hljs-number"><span class="hljs-number">43</span></span> webm <span class="hljs-number"><span class="hljs-number">640</span></span>x360 medium , vp8<span class="hljs-number"><span class="hljs-number">.0</span></span>, vorbis@<span class="hljs-number"><span class="hljs-number">128</span></span>k <span class="hljs-number"><span class="hljs-number">18</span></span> mp4 <span class="hljs-number"><span class="hljs-number">640</span></span>x360 medium , avc1<span class="hljs-number"><span class="hljs-number">.42001</span></span>E, mp4a<span class="hljs-number"><span class="hljs-number">.40</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span>@ <span class="hljs-number"><span class="hljs-number">96</span></span>k <span class="hljs-number"><span class="hljs-number">22</span></span> mp4 <span class="hljs-number"><span class="hljs-number">1280</span></span>x720 hd720 , avc1<span class="hljs-number"><span class="hljs-number">.64001</span></span>F, mp4a<span class="hljs-number"><span class="hljs-number">.40</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span>@<span class="hljs-number"><span class="hljs-number">192</span></span>k (best)</code> </pre> <br><br><h2>  Install ffmpeg </h2><br>  Next, set the <b>ffmpeg</b> standard spells: <br><br><pre> <code class="hljs bash">wget http://ffmpeg.org/releases/ffmpeg-3.3.4.tar.bz2 tar -xvjf ffmpeg-3.3.4.tar.bz2 <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ffmpeg-3.3.4 ./configure --<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>-shared --<span class="hljs-built_in"><span class="hljs-built_in">disable</span></span>-logging --<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>-gpl --<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>-pthreads --<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>-libx264 --<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>-librtmp make make install</code> </pre> <br>  Checking what happened <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">ffmpeg</span></span> -v</code> </pre> <br>  Now the fun part.  Library youtube-dl is designed for download.  It is called YouTube Download.  Those.  You can download the youtube video completely and after that clip it through ffmpeg as a file. <br><br>  But imagine such a user.  Sit in a web conference marketer, manager and programmer.  Marketer wants to show everyone in real-time video from YouTube, which weighs, say 300 megabytes.  Agree, there will be a certain awkwardness, if you need to deflate the entire movie before you start showing it. <br><br><ol><li>  Marketer says - "Now, colleagues, let's see this video with cats, it fully meets our strategy of entering the market," and presses the button "show everyone the video." </li><li>  A preloader appears on the screen: ‚ÄúWait, the video with the cats is downloading.  It takes less than 10 minutes. ‚Äù </li><li>  The manager goes to drink coffee, and the programmer - to read habr. </li></ol><br>  In order not to make people wait, you need realtime.  It is necessary to pick up the video directly during the download, on the fly to wrap the stream and distribute in real time.  Next we show how to do it. <br><br><h2>  Data transfer from youtube-dl to ffmpeg </h2><br>  Grabber youtube-dl saves the stream in the file system.  You need to connect to this stream and organize a read from the ffmpeg file as you download it using youtube-dl. <br><br>  To combine these two processes: downloading and streaming ffmpeg, we need a small binding script. <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/python import subprocess import sys def show_help(): print 'Usage: ' print './streamer.py url streamName destination' print './streamer.py https://www.youtube.com/watch?v=9cQT4urTlXM streamName rtmp://192.168.88.59:1935/live' return def streamer() : url = sys.argv[1] if not url : print 'Error: url is empty' return stream_id = sys.argv[2] if not stream_id: print 'Error: stream name is empty' return destination = sys.argv[3] if not destination: print 'Error: destination is empty' return _youtube_process = subprocess.Popen(('youtube-dl','-f','','--prefer-ffmpeg', '--no-color', '--no-cache-dir', '--no-progress','-o', '-', '-f', '22/18', url, '--reject-title', stream_id),stdout=subprocess.PIPE) _ffmpeg_process = subprocess.Popen(('ffmpeg','-re','-i', '-','-preset', 'ultrafast','-vcodec', 'copy', '-acodec', 'copy','-threads','1', '-f', 'flv',destination + "/" + stream_id), stdin=_youtube_process.stdout) return if len(sys.argv) &lt; 4: show_help() else: streamer()</span></span></code> </pre> <br>  This python script does the following: <br><br><ol><li>  Creates a <b>_youtube_process</b> subprocess of <b>reading a</b> movie by youtube-dl library </li><li>  Creates a second <b>_ffmpeg_process</b> subprocess to which data from the first is passed through a pipe.  This process already creates an RTMP stream and sends it to the server at the specified address. </li></ol><br><br><h2>  Script Testing </h2><br>  To run the script you need to install python.  Download <a href="https://www.python.org/downloads">here</a> . <br><br>  We used version 2.6.6 for testing.  Most likely any version is suitable, because  The script is quite simple and its task is to transfer from one process to another. <br><br>  Running the script: <br><pre> <code class="bash hljs">python streamer.py https://www.youtube.com/watch?v=9cQT4urTlXM stream1 rtmp://192.168.88.59:1935/live</code> </pre> <br>  As you can see, three arguments are passed: <br><br><ol><li>  Address youtube video. <br>  <a href="https://www.youtube.com/watch%3Fv%3D9cQT4urTlXM">www.youtube.com/watch?v=9cQT4urTlXM</a> </li><li>  The name of the stream with which the RTMP broadcast will take place. <br>  stream1 </li><li>  The address of the RTMP server. <br>  rtmp: //192.168.88.59: 1935 / live </li></ol><br>  For testing, we will use the <a href="https://flashphoner.com/">Web Call Server</a> .  He is able to receive RTMP streams and distribute them via WebRTC.  <a href="https://flashphoner.com/download">Here</a> you can download and install WCS5 on your VPS or local test server running Linux. <br><br>  Testing scheme with Web Call Server: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/web/e28/489/d27/e28489d272f84f44926883ccb3998528.jpg"></div><br>  Below we use one of the demo servers for the test: <br><br><pre> <code class="hljs objectivec">rtmp:<span class="hljs-comment"><span class="hljs-comment">//wcs5-eu.flashphoner.com:1935/live</span></span></code> </pre> <br>  This is the RTMP address that you need to transfer to the streamer.py script in order to quickly test the broadcast with our demo server. <br><br>  The launch should look like this: <br><br><pre> <code class="bash hljs">python streamer.py https://www.youtube.com/watch?v=9cQT4urTlXM stream1 rtmp://wcs5-eu.flashphoner.com:1935/live</code> </pre> <br>  In the stdout console, we see the following output: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># python streamer.py https://www.youtube.com/watch?v=9cQT4urTlXM stream1 rtmp://wcs5-eu.flashphoner.com:1935/live ffmpeg version 3.2.3 Copyright (c) 2000-2017 the FFmpeg developers built with gcc 4.4.7 (GCC) 20120313 (Red Hat 4.4.7-11) configuration: --enable-shared --disable-logging --enable-gpl --enable-pthreads --enable-libx264 --enable-librtmp --disable-yasm libavutil 55. 34.101 / 55. 34.101 libavcodec 57. 64.101 / 57. 64.101 libavformat 57. 56.101 / 57. 56.101 libavdevice 57. 1.100 / 57. 1.100 libavfilter 6. 65.100 / 6. 65.100 libswscale 4. 2.100 / 4. 2.100 libswresample 2. 3.100 / 2. 3.100 libpostproc 54. 1.100 / 54. 1.100 ]# [youtube] 9cQT4urTlXM: Downloading webpage [youtube] 9cQT4urTlXM: Downloading video info webpage [youtube] 9cQT4urTlXM: Extracting video information [youtube] 9cQT4urTlXM: Downloading MPD manifest [download] Destination: - Input #0, mov,mp4,m4a,3gp,3g2,mj2, from 'pipe:': Metadata: major_brand : mp42 minor_version : 0 compatible_brands: isommp42 creation_time : 2016-08-23T12:21:06.000000Z Duration: 00:29:59.99, start: 0.000000, bitrate: N/A Stream #0:0(und): Video: h264 (Main) (avc1 / 0x31637661), yuv420p, 1280x720 [SAR 1:1 DAR 16:9], 288 kb/s, 30 fps, 30 tbr, 90k tbn, 60 tbc (default) Metadata: creation_time : 2016-08-23T12:21:06.000000Z handler_name : ISO Media file produced by Google Inc. Stream #0:1(und): Audio: aac (LC) (mp4a / 0x6134706D), 44100 Hz, stereo, fltp, 125 kb/s (default) Metadata: creation_time : 2016-08-23T12:21:06.000000Z handler_name : ISO Media file produced by Google Inc. Output #0, flv, to 'rtmp://192.168.88.59:1935/live/stream1': Metadata: major_brand : mp42 minor_version : 0 compatible_brands: isommp42 encoder : Lavf57.56.101 Stream #0:0(und): Video: h264 (Main) ([7][0][0][0] / 0x0007), yuv420p, 1280x720 [SAR 1:1 DAR 16:9], q=2-31, 288 kb/s, 30 fps, 30 tbr, 1k tbn, 90k tbc (default) Metadata: creation_time : 2016-08-23T12:21:06.000000Z handler_name : ISO Media file produced by Google Inc. Stream #0:1(und): Audio: aac (LC) ([10][0][0][0] / 0x000A), 44100 Hz, stereo, 125 kb/s (default) Metadata: creation_time : 2016-08-23T12:21:06.000000Z handler_name : ISO Media file produced by Google Inc. Stream mapping: Stream #0:0 -&gt; #0:0 (copy) Stream #0:1 -&gt; #0:1 (copy) frame= 383 fps= 30 q=-1.0 size= 654kB time=00:00:12.70 bitrate= 421.8kbits/s speed= 1x</span></span></code> </pre> <br>  If you quickly run through this log, you can understand that the following is happening: <br><br><ol><li>  A video page opens. </li><li>  Retrieves data about video formats. </li><li>  Downloadable mp4 video 1280x720, H.264 + AAC </li><li>  Runs ffmpeg, picks up the downloaded data and stream over RTMP with a bit rate of 421 kbps.  Such a meager bit rate is due to the selected roller with a timer.  A normal video will give an order of magnitude greater value of the bitrate. </li></ol><br>  After the streaming process starts, we try to play the stream in the <a href="https://habrahabr.ru/company/flashphoner/blog/337114">WebRTC player</a> .  The stream name is set in the Stream field, and the server address in the Server field.  Connection to the server occurs via the Websocket (wss) protocol, and the stream comes to the player via WebRTC (UDP). <br><br><div style="text-align:center;"><img src="https://habrastorage.org/web/d2f/296/bdb/d2f296bdb94244bc93fbb2201da5cb9c.jpg"></div><br>  We specifically took this particular video on YouTube to be able to test the real-timeness of the stream, because our ultimate goal was to deliver the stream from YouTube to all viewers at the same time, with minimal delay and time variation.  <a href="https://www.youtube.com/watch%3Fv%3D9cQT4urTlXM">Movie with a millisecond timer</a> , could not be more suitable for such a test. <br><br>  The test itself is very simple.  We open two browser tabs (we simulate two viewers), we play this stream with a timer according to our scheme, and we take several screenshots to capture the difference in the time of arrival of the video.  Next, compare the milliseconds and see who got the video before, and who later and how much. <br><br>  We get the following results: <br><br>  Test 1 <br><br><div style="text-align:center;"><img src="https://habrastorage.org/web/b51/9eb/331/b519eb3313a44dada7322f040fe6b5bb.jpg"></div><br>  Test 2 <br><br><div style="text-align:center;"><img src="https://habrastorage.org/web/6bd/1c7/b5c/6bd1c7b5c20a4a1b8c4bb2cbfb21be9f.jpg"></div><br>  Test 3 <br><br><div style="text-align:center;"><img src="https://habrastorage.org/web/c08/60e/4d1/c0860e4d11f544789b4b7beb1525f68f.jpg"></div><br>  As you can see, each of the viewers sees the same video, with a spread of not more than 130 milliseconds. <br><br>  Thus, the task of real-time broadcast video from YouTube to WebRTC is solved.  Viewers received the stream almost simultaneously.  The manager did not leave to drink coffee, the programmer didn‚Äôt read Habr, and the marketer successfully showed everyone a video with cats. <br><br>  Good streaming! <br><br><h2>  Links </h2><br>  <a href="https://github.com/rg3/youtube-dl">youtube-dl</a> - library for downloading videos from YouTube <br>  <a href="https://ffmpeg.org/">ffmpeg</a> - RTMP encoder <br>  <a href="https://flashphoner.com/">Web Call Server</a> - a server that can split RTMP stream over WebRTC <br>  <a href="">streamer.py</a> - a script for integrating youtube-dl and ffmpeg with sending an RTMP stream </div><p>Source: <a href="https://habr.com/ru/post/338098/">https://habr.com/ru/post/338098/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../338084/index.html">Ethereum Smart Contracts: writing a simple contract for ICO</a></li>
<li><a href="../338086/index.html">ASO: ranking in the App Store and Google Play (find 10 differences in algorithms)</a></li>
<li><a href="../338088/index.html">Projections? No thanks</a></li>
<li><a href="../338090/index.html">Something about homegrown</a></li>
<li><a href="../338092/index.html">Joseph "Lick" Liclider: "Intergalactic Computer Network" (1963)</a></li>
<li><a href="../338100/index.html">Remote desktop + distributed commands =?</a></li>
<li><a href="../338102/index.html">As I was interviewing for the position of Junior .Net Developer</a></li>
<li><a href="../338104/index.html">My experience in conducting Java courses for new employees</a></li>
<li><a href="../338106/index.html">Nuklear + - mini cross-platform GUI</a></li>
<li><a href="../338108/index.html">5 rules for working with amounts</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>