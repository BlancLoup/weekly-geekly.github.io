<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Development of a WEB project on Node.JS: Part 2</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the last article, I began to talk about my experience in developing an experimental WEB project ‚Äú What to do ?‚Äù On Node.JS. The first part was a re...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Development of a WEB project on Node.JS: Part 2</h1><div class="post__text post__text-html js-mediator-article">  In the <a href="http://habrahabr.ru/blogs/nodejs/138071/">last article,</a> I began to talk about my experience in developing an experimental WEB project ‚Äú <a href="http://chtodelat.com/">What to do</a> ?‚Äù On Node.JS.  The first part was a review, in it I tried to reveal the pros and cons of technology, as well as warn about the problems that may have to face during the development.  In this article I will focus on technical details. <br><br><h4>  Some words about habraeffekt </h4><br><a name="habracut"></a>  Honestly, after periodic observations of the fall of sites, links to which fall on the main habr, I expected to see much more serious numbers.  Both previous articles visited the main page.  Although the <a href="http://habrahabr.ru/blogs/i_am_advertising/137637/">first article</a> was in the closed blog ‚ÄúI am PR‚Äù and was visible only to its subscribers, the second one in the profile blog ‚ÄúNode.JS‚Äù caused quite a lengthy discussion in the comments - the number of people who came to the site from both articles was about the same.  Equally small. <br><img src="https://habrastorage.org/storage2/cc3/7cf/f18/cc37cff1898881cb813ee3ce4542a56d.png"><br><br><img src="https://habrastorage.org/storage2/f0d/16a/e85/f0d16ae85bafb7b79cc10f417daa5671.png">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      These numbers are too small to talk about any serious load.  At the very peak of visits, htop showed approximately the following picture: <br><img src="https://habrastorage.org/storage2/52e/e5f/66a/52ee5f66ad04783f6547a9c03b4569e6.png"><br><br>  Load average sometimes reached 1, but then again went down to 0.3-0.5.  Pages were given away quickly.  The average time of page generation, the data for the formation of which is in memcached - 15-20ms.  If the data in memcached is missing, the generation time is increased to 40-100ms, but this happens very rarely.  Some visitors tested the site using the siege and ab utilities, as well as using the LoadImpact service.  At that time I was sure that all pages are well cached by Nginx and these requests do not reach Node.JS.  It turned out that this was not the case.  Later, I discovered the incorrect behavior of one of the modules, which prevented page caching (I will discuss this in more detail later).  In fact, all requests were served by Node.JS and at the same time the site worked stably. <br><br>  Unfortunately, I do not know how much the ‚Äúhabraeffect‚Äù differs depending on the subject of the article and the subject of the site to which the link is set.  But if the site falls from the same (well, or even x2) number of people, then the problem here is far from the choice of technology. <br><br>  Based on the tests and data on attendance, I concluded that the project is quite stable and will not fall during a sharp influx of visitors. <br><br><h4>  Architecture </h4><br><h5>  Iron and software </h5><br>  The site lives on a VPS with modest characteristics: <br><ul><li>  1 CPU with a guaranteed frequency of 1200Mhz; </li><li>  1024Mb RAM; </li><li>  25Gb HDD (for this project, this figure does not play a special role). </li></ul>  Ubuntu Server is installed on the server.  I'm used to it, it is convenient for me to work with it, so I chose her. <br><br>  Additional software installed at minimum.  In this case, it is: <br><ul><li>  Node.JS - JavaScript application execution environment on the server; </li><li>  MongoDB - NoSQL DBMS; </li><li>  Memcached - Caching daemon; </li><li>  Nginx - Frontend server. </li></ul>  Software versions I try to keep up to date. <br><br><h5>  Configuration </h5><br>  By default, Node.JS runs in one thread, which is not very convenient and not optimal, especially for multi-core processors.  Almost immediately, modules appeared for conveniently launching several processes (various implementations of Web Workers).  It was not difficult to do this with the <a href="http://nodejs.org/docs/latest/api/child_processes.html">standard API Node.JS.</a>  With the release of version 0.6.0, Node.JS has a new module - <a href="http://nodejs.org/docs/latest/api/cluster.html">Cluster</a> .  It greatly simplifies the task of starting multiple Node.JS processes.  The API of this module allows forking processes of node, net / http servers which will use a common TCP port.  The parent process can manage child processes: stop, start new, respond to unexpected terminations.  Child processes can exchange messages with their parent. <br><br>  Despite the fact that with the help of Cluster it is convenient to start the required number of processes, I run 2 instances of node on different TCP ports.  I do this in order to avoid application downtime during the update, otherwise during a reboot (which, by the way, it only takes a few seconds), the site will be unavailable to users.  Between instances of node, the load is distributed using <a href="http://wiki.nginx.org/HttpUpstreamModule">Nginx's</a> HttpUpstreamModule.  When, during a reboot, one of the instances becomes unavailable, the second takes over all requests. <br><br>  Nginx is configured so that for non-authorized users all pages on the site are cached for a short period of time - 1 minute.  This allows you to significantly remove the load from Node.JS and at the same time display the actual content rather quickly.  For authorized users, the cache time is set to 3 seconds.  This is completely invisible to ordinary users, but it will save from intruders who are trying to load the site with a large number of requests containing cookie authorizations. <br><br><h5>  Modules </h5><br>  When developing applications on Node.JS, very often there is a question of choosing a module for performing a particular task.  For some tasks, there are already proven, popular modules; for others, the choice is more difficult to make.  Choosing a module should focus on the number of observers, the number of forks and the date of the latest commits (now we are talking about GitHub).  These indicators can determine whether the project is alive.  Greatly facilitates this task recently appeared service <a href="http://toolbox.no.de/">The Node Toolbox</a> . <br><br>  Now it's time to talk about the modules that I chose to develop the project. <br><br><h6>  connect </h6>  <a href="https://github.com/senchalabs/connect">github.com/senchalabs/connect</a> <br>  This module is an add-on over <a href="&amp;xid=17259,15700022,15700186,15700190,15700253,15700256,15700259&amp;usg=ALkJrhiLbpWbfP2MRZeEcuo5kkDImfuXfg#">the Node.JS http-server</a> and significantly expands its capabilities.  It adds such functionality as routing, support for cookies, session support, parsing the request body and much more, without which the development of a web application on Node.JS is likely to turn into a nightmare.  Most connect capabilities are implemented as plugins.  There are also many equally useful <a href="https://github.com/senchalabs/connect/wiki">plugins for connect</a> , which are not included in its standard distribution.  Adding the missing functionality by developing your plugin is also quite simple. <br><br>  Despite the popularity of this module and its rapid development, the problem that prevented Nginx from caching the response from Node.JS was precisely in it.  By default, the proxy_cache directive in Nginx does not cache backend responses if at least one of the following headers is present in them: <br><ul><li>  Set-Cookie; </li><li>  Cache-Control containing ‚Äúno-cache‚Äù, ‚Äúno-store‚Äù, ‚Äúprivate‚Äù, or ‚Äúmax-age‚Äù values ‚Äã‚Äãwith a non-numeric or zero value; </li><li>  Expires with a past date; </li><li>  X-Accel-Expires: 0. </li></ul>  In the connect session, the sessions were implemented so that the Set-Cookie header was sent with each response.  This was done to support sessions with a lifetime longer than the lifetime of the browser session.  In PHP, if you set the session time to a specific value - it will end after this time, even if the user is active on the site.  Connect uses a different policy - the cookie is updated with each request and its lifetime begins to count from the current, i.e.  while the user is active - the session will not end.  PHP approach seems to me more true, because  session is not intended for long-term data storage.  I made the appropriate changes to the code and sent a pull request.  Further, after a <a href="https://github.com/senchalabs/connect/pull/475">brief discussion</a> (do not kick for my English), a compromise solution was found - for those sessions that have not been set, expires, the cookie is now sent only once.  For sessions with a rigidly defined lifetime, this problem has not yet been resolved. <br><br><h6>  connect-memcached </h6>  <a href="https://github.com/balor/connect-memcached">github.com/balor/connect-memcached</a> <br>  This module is a plugin for connect.  It adds the ability to store sessions in memcached.  Without additional plug-ins, connect can only store sessions in the memory of one process.  This is clearly not enough for use in combat conditions, so the corresponding plug-ins have already been developed for all popular repositories. <br><br><h6>  async </h6>  <a href="https://github.com/caolan/async">github.com/caolan/async</a> <br>  Without this module, writing asynchronous code for Node.JS would be much more difficult.  This library contains methods that allow you to "juggle" asynchronous calls and not inflate the code with a lot of functions nested in each other.  For example, it is much easier to start several asynchronous calls and perform some action on their completion.  I highly recommend that you familiarize yourself with the full range of features of this library in order to avoid further inventing bicycles. <br><br><h6>  node-oauth </h6>  <a href="https://github.com/ciaranj/node-oauth">github.com/ciaranj/node-oauth</a> <br>  This module implements the OAuth and OAuth2 protocols, which makes it quite simple to ensure user authorization on the site through social networks that support these protocols. <br><br><h6>  node-cron </h6>  <a href="https://github.com/ncb000gt/node-cron">github.com/ncb000gt/node-cron</a> <br>  The name of this module speaks for itself.  It allows you to perform tasks on a schedule.  Schedule syntax is very similar to the cron to which everyone is used to linux, but, unlike him, node-cron supports one-second startup intervals.  Ie, you can customize the launch of the method every 10 seconds or even every second.  Tasks such as displaying popular questions on the main page and posting them on Twitter are launched using this module. <br><br><h6>  node-twitter </h6> <a href="https://github.com/jdub/node-twitter">github.com/jdub/node-twitter</a> <br>  This module implements the interaction of the application with the Twitter API.  For work, he uses the above node-oauth module. <br><br><h6>  node-mongodb-native </h6>  <a href="https://github.com/christkv/node-mongodb-native">github.com/christkv/node-mongodb-native</a> <br>  This module is an interface to MongoDB NoSQL DBMS.  Among its competitors, it stands out for better development and rapid development.  Opening multiple database connections (pool) is supported out of the box, which saves you from writing your own crutches.  Based on this module, a rather convenient <a href="https://github.com/LearnBoost/mongoose">ORM Mongoose was</a> developed. <br><br><h6>  node-memcached </h6>  <a href="https://github.com/3rd-Eden/node-memcached">github.com/3rd-Eden/node-memcached</a> <br>  This is the best, in my opinion, memcached access interface from Node.JS.  It supports multiple memcached servers and the distribution of keys between them, as well as a pool of connections. <br><br><h6>  http-get </h6>  <a href="http-get">github.com/SaltwaterC/http-get</a> <br>  This module is designed to access remote resources via HTTP / HTTPS protocols.  With its help, photos of users who log into the site through social networks are downloaded. <br><br><h6>  sprintf </h6>  <a href="https://github.com/maritz/node-sprintf">github.com/maritz/node-sprintf</a> <br>  A small, but very useful module, which, as can be seen from its name, implements the functions sprintf and vsprintf in JavaScript. <br><br><h6>  daemon.node </h6>  <a href="">github.com/indexzero/daemon.node</a> <br>  This module makes it very easy to make a daemon from Node.JS applications.  With its help it is convenient to untie the application from the console and redirect the output to the log files. <br><br><h5>  My contribution </h5><br>  The following modules were developed by me while working on the project, since  at the time of writing, I was not able to find ready-made solutions suitable for them.  These modules are <a href="https://github.com/baryshev">published on GitHub</a> and in the npm module directory. <br><br><h6>  aop </h6>  <a href="https://github.com/baryshev/aop">github.com/baryshev/aop</a> <br>  This module does not yet claim the full implementation of the <a href="http://ru.wikipedia.org/wiki/%25D0%2590%25D1%2581%25D0%25BF%25D0%25B5%25D0%25BA%25D1%2582%25D0%25BD%25D0%25BE-%25D0%25BE%25D1%2580%25D0%25B8%25D0%25B5%25D0%25BD%25D1%2582%25D0%25B8%25D1%2580%25D0%25BE%25D0%25B2%25D0%25B0%25D0%25BD%25D0%25BD%25D0%25BE%25D0%25B5_%25D0%25BF%25D1%2580%25D0%25BE%25D0%25B3%25D1%2580%25D0%25B0%25D0%25BC%25D0%25BC%25D0%25B8%25D1%2580%25D0%25BE%25D0%25B2%25D0%25B0%25D0%25BD%25D0%25B8%25D0%25B5">AOP pattern</a> .  Now it contains a single method that allows you to wrap a function in an aspect that, if necessary, can change its behavior.  This technique is very convenient to use for caching the results of the functions. <br><br>  For example, we have some asynchronous function: <br><br><pre><code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> someAsyncFunction = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">num, callback</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> result = num * <span class="hljs-number"><span class="hljs-number">2</span></span>; callback(<span class="hljs-literal"><span class="hljs-literal">undefined</span></span>, result); };</code> </pre> <br><br>  This function is often called and the result needs to be cached.  Usually it looks like this: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> someAsyncFunction = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">num, callback</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> key = <span class="hljs-string"><span class="hljs-string">'someModule'</span></span> + <span class="hljs-string"><span class="hljs-string">'_'</span></span> + <span class="hljs-string"><span class="hljs-string">'someAsyncFunction'</span></span> + <span class="hljs-string"><span class="hljs-string">'_'</span></span> + num; cache.get(key, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">error, cachedResult</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (error || !cachedResult) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> result = num * <span class="hljs-number"><span class="hljs-number">2</span></span>; callback(<span class="hljs-literal"><span class="hljs-literal">undefined</span></span>, result); cache.set(key, result); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { callback(<span class="hljs-literal"><span class="hljs-literal">undefined</span></span>, cachedResult); } }); };</code> </pre> <br><br>  There may be a lot of such functions in the project.  The code will swell up a lot and becomes less readable, a large amount of copy-paste appears.  And this is how you can do the same with aop.wrap: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> someAsyncFunction = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">num, callback</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> result = num * <span class="hljs-number"><span class="hljs-number">2</span></span>; callback(<span class="hljs-literal"><span class="hljs-literal">undefined</span></span>, result); }; <span class="hljs-comment"><span class="hljs-comment">/** *   -    this   *   - ,      *   - ,        *   -  ,    (    ) */</span></span> someAsyncFunction = aop.wrap(someAsyncFunction, someAsyncFunction, aspects.cache, <span class="hljs-string"><span class="hljs-string">'someModule'</span></span>, <span class="hljs-string"><span class="hljs-string">'someAsyncFunction'</span></span>);</code> </pre> <br><br>  Separately, we create the aspects library and define the cache function there, which will be responsible for caching everything and everyone. <br><br><pre> <code class="javascript hljs"><span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports.cache = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">method, params, moduleName, functionName</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> that = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; <span class="hljs-comment"><span class="hljs-comment">//         var key = moduleName + '_' + functionName + '_' + params[0]; cache.get(key, function(error, cachedResult) { //    callback- (   ) var callback = params[params.length - 1]; if (error || !cachedResult) { //     ,    ,  callback- params[params.length - 1] = function(error, result) { callback(error, result); if (!error) cache.set(key, result); }; method.apply(that, params); } else { callback(undefined, cachedResult); } }); };</span></span></code> </pre> <br><br>  As required, the aspect functionality can be expanded.  In a large project, this approach greatly saves the amount of code and localizes the entire end-to-end functionality in one place. <br><br>  In the future, I plan to expand this library with the implementation of the remaining features of the AOP pattern. <br><br><br><h6>  form </h6>  <a href="https://github.com/baryshev/form">github.com/baryshev/form</a> <br>  The task of this module is to check and filter the input data.  Most often these are forms, but it can also be data obtained from a request from external APIs, etc.  This module includes the <a href="https://github.com/chriso/node-validator">node-validator library</a> and allows full use of its capabilities. <br><br>  The principle of operation of this module is as follows: each form is described by a set of fields on which filters are hung (functions affecting the field value) and validators (functions checking the field value for compliance with the condition).  When data is received, it is passed to the form method process.  In callback, we will receive either an error description (if any data did not meet the criteria of the form) or an object containing a filtered set of fields and ready for further use.  A small example of use: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> fields = { <span class="hljs-attr"><span class="hljs-attr">text</span></span>: [ form.filter(form.Filter.trim), form.validator(form.Validator.notEmpty, <span class="hljs-string"><span class="hljs-string">'Empty text'</span></span>), form.validator(form.Validator.len, <span class="hljs-string"><span class="hljs-string">'Bad text length'</span></span>, <span class="hljs-number"><span class="hljs-number">30</span></span>, <span class="hljs-number"><span class="hljs-number">1000</span></span>) ], <span class="hljs-attr"><span class="hljs-attr">name</span></span>: [ form.filter(form.Filter.trim), form.validator(form.Validator.notEmpty, <span class="hljs-string"><span class="hljs-string">'Empty name'</span></span>) ] }; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> textForm = form.create(fields); textForm.process({<span class="hljs-string"><span class="hljs-string">'text'</span></span> : <span class="hljs-string"><span class="hljs-string">'some short text'</span></span>, <span class="hljs-string"><span class="hljs-string">'name'</span></span>: <span class="hljs-string"><span class="hljs-string">'tester'</span></span>}, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">error, data</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(error); <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(data); });</code> </pre> <br><br>  In this case, we get the error 'Bad text length' for the text field, since  The length of the transmitted text is less than 30 characters. <br><br>  Filters and validators are executed sequentially, so even if we add lots of spaces to the end of the line, we still get an error, because  before checking the spaces will be removed by the trim filter. <br><br>  How to create your own filters and validators can be found on <a href="https://github.com/chriso/node-validator">the node-validator page</a> or see the source code. In future plans, make a port of this module for use in the browser and document its capabilities well. <br><br><h6>  configjs </h6>  <a href="https://github.com/baryshev/configjs">github.com/baryshev/configjs</a> <br>  This module is designed for easy application configuration.  Configurations are stored in regular JS-files, this makes it possible to use JavaScript during configuration and does not require additional parsing of files.  You can create several additional configurations for different environments (development, production, testing, etc.) that will expand and / or change the basic configuration. <br><br><h6>  localejs </h6>  <a href="https://github.com/baryshev/localejs">github.com/baryshev/localejs</a> <br>  This module is very similar to configjs, but it is designed to store strings of different locales to support multilanguage.  The module is hardly suitable for applications with a large amount of text.  In this case, it will be more convenient to use solutions like <a href="http://ru.wikipedia.org/wiki/Gettext">GetText</a> .  In addition to the means of loading the necessary locale, the module contains a function for outputting numerals that supports Russian and English. <br><br><h6>  hub </h6>  <a href="">github.com/baryshev/hub/blob/master/lib/index.js</a> <br>  Perhaps this module can claim to be the smallest module for Node.JS.  It consists of just one line: module.exports = {};  In this case, without it, the development would be much more difficult.  This module is a container for storing objects while the application is running.  It uses the Node.JS feature ‚Äî when connected, the module is initialized only once.  All calls to require ('moduleName'), no matter how many in the application, return a reference to the same module instance, initialized at the first mention.  In fact, it replaces the use of global space to share resources between parts of an application.  This need arises quite often.  Examples: database connection pool, cache connection pool, link to loaded configuration and locale.  These resources are needed in many parts of the application and access to them should be easy.  When a resource is initialized, it is assigned to the property of the hub object and later it can be accessed from any other module by connecting the hub to it. <br><br><h6>  connect-response </h6>  This plugin for connect adds the ability to easily work with cookies, and also includes a template engine to form a response to the user.  I developed my template engine.  It turned out pretty good.  The <a href="https://github.com/visionmedia/ejs">EJS template engine</a> was taken as a basis, but in the end it turned out to be a completely different product, with its own functionality, albeit with a similar syntax.  But this is a big topic for a separate article. <br><br>  Unfortunately, this module has not yet been published, because  not properly executed and not all errors have been fixed.  I am going to finish and publish it in the near future, as soon as some free time appears. <br><br><h4>  Application structure </h4><br>  Since the application does not use frameworks, its structure is not tied to any rules other than the general style of writing applications on Node.JS and common sense.  The application uses the MVC model. <br><br>  The server.js file that is started contains the initialization of the main application resources: starting the http server, configuring connect, loading the configuration and language, establishing connections with MongoDB and Memcached, connecting controllers, setting references to resources that need to be shared between modules in the hub.  Here forks the required number of processes.  In the master process, node-cron is started, to perform tasks on a schedule, and in child processes, http servers are run. <br><br>  A connect url is set to the handler method in each controller by means of connect.  Each request passes through a chain of methods that is created when connect is initialized.  Example: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> server = connect(); server.listen(port, hub.config.app.host); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (hub.config.app.profiler) server.use(connect.profiler()); server.use(connect.cookieParser()); server.use(connect.bodyParser()); server.use(connect.session({ <span class="hljs-attr"><span class="hljs-attr">store</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> connectMemcached(hub.config.app.session.memcached), <span class="hljs-attr"><span class="hljs-attr">secret</span></span>: hub.config.app.session.secret, <span class="hljs-attr"><span class="hljs-attr">key</span></span>: hub.config.app.session.cookie_name, <span class="hljs-attr"><span class="hljs-attr">cookie</span></span>: hub.config.app.session.cookie })); server.use(connect.query()); server.use(connect.router(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">router</span></span></span><span class="hljs-function">) </span></span>{ hub.router = router; }));</code> </pre> <br><br>  This is a convenient mechanism that makes it very easy to add new behavior to the request processing and response generation algorithm. <br><br>  The controller, if necessary, calls model methods that receive data from MongoDb or Memcached.  When all the data for the response is ready, the controller gives a command to the template engine to form the page and sends the generated html to the user. <br><br><h4>  Conclusion </h4><br>  The topic of developing WEB applications on Node.JS is quite large and interesting.  Explain it completely in two articles is impossible.  Yes, this is probably not necessary.  I tried to describe the basic principles of development and point out possible problems.  This should be enough to ‚Äúenter‚Äù the topic, and then <a href="http://google.com/">Google</a> and <a href="http://github.com/">GitHub</a> will come to the rescue.  All links to module pages on GitHub that I cited in the article contain a detailed description of the installation of modules and examples of their use. <br><br>  Thanks to everyone who read it.  I would be very interested to hear feedback and questions in the comments. </div><p>Source: <a href="https://habr.com/ru/post/138629/">https://habr.com/ru/post/138629/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../138622/index.html">Citrix XenServer Free 5.6 Security or "... you need to find a different hypervisor"</a></li>
<li><a href="../138623/index.html">NFC tags from metro maps</a></li>
<li><a href="../138625/index.html">Sort: key vs cmp</a></li>
<li><a href="../138627/index.html">Django Meetup - March 1 in Moscow</a></li>
<li><a href="../138628/index.html">Black holes and gold mines on the web development market</a></li>
<li><a href="../138630/index.html">Embedded Systems: Windows Special Purpose</a></li>
<li><a href="../138631/index.html">Be the center of attention!</a></li>
<li><a href="../138632/index.html">A unified look at communities and social networks</a></li>
<li><a href="../138633/index.html">Network access to libraries and runtime-formation of function calls</a></li>
<li><a href="../138634/index.html">What to expect from MWC 2012?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>