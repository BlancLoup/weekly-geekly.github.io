<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Nested Diagnostic Context, log4cpp and Boost asio</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this article I want to show how you can use NDC in asynchronous operations using the example of log4cpp and boost.asio 

 Nested Diagnostic Context...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Nested Diagnostic Context, log4cpp and Boost asio</h1><div class="post__text post__text-html js-mediator-article">  In this article I want to show how you can use NDC in asynchronous operations using the example of log4cpp and boost.asio <br><br>  Nested Diagnostic Context (NDC) - the context that is added to the log.  This context can be used to further filter the log file.  This is especially useful if several operations are performed, and these operations are interconnected, for example: sampling data from the database, processing, packing into a message, sending a message over the network to the client, etc. ... If there are many such operations and they occur in parallel (or asynchronously ), then the log is sometimes hard to restore the sequence of operations.  This is what NDC is used for: we first create a unique (pseudo) identifier, and then we tag each logging operation in our chain with this identifier. <br><br>  In theory, everything is fine: we generate a unique ID and transfer it to the logger, but in practice there are several problems: <br><ul><li>  The NDC implementation in the log4cpp library is based on the Thread Local Storage (Thread Specific Ptr) mechanism, so the NDC is stored for only one thread.  Accordingly, the question arises of the transfer of NDC between threads. </li><li>  The following problem also emerges from the first item: asynchronous operations, for example, in boost :: asio :: io_service.  Since asio allows you to perform many asynchronous operations in one (or several) threads, due to the peculiarities of log4cpp, we will not be able to see the correct NDC in the log.  We need a special mechanism that will ensure the correctness of the NDC in asio asynchronous operations </li></ul>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <a name="habracut"></a><br><br><h5>  Preparing to start </h5><br><ul><li>  CMake-2.8 as a build system </li><li>  boost-1.49 from the debian wheezy repository </li><li>  log4cpp - logging library </li><li>  gcc-4.7.1 with C ++ 11 support included (used by Variadic templates) </li><li>  The source code is <a href="https://github.com/prograholic/blog">on GitHub</a> in the <b>asio_log4cpp</b> subdirectory <b>.</b> </li></ul><br><br><h5>  Brief description of the example </h5><br>  The example implements a client and server that exchange messages. <br><br>  The principle of the server: <br><ul><li>  The server is waiting for a connection from any address on port 12345 </li><li>  after connection, it generates an arbitrary number in the range from 0 to 1000 (for generation, the library is used boost.random, as a generator - the <a href="http://ru.wikipedia.org/wiki/%25D0%2592%25D0%25B8%25D1%2585%25D1%2580%25D1%258C_%25D0%259C%25D0%25B5%25D1%2580%25D1%2581%25D0%25B5%25D0%25BD%25D0%25BD%25D0%25B0">Mersenne Vortex</a> ) </li><li>  Sends the generated number to the client. </li><li>  Starts an asynchronous timer for the specified number of milliseconds. </li><li>  After the timer has run, it starts an asynchronous read, receives a message from the client, and terminates the session </li></ul><br><br>  Similarly, the client works: <br><ul><li>  Runs 100 asynchronous connections to the address 127.0.0.1:12345 </li><li>  after connecting, it reads a message from the server that contains a timeout </li><li>  Starts an asynchronous timer for the specified number of milliseconds. </li><li>  After the timer has run, it starts an asynchronous recording, sends a farewell message to the server. </li></ul><br><br>  In this example, I specifically made an arbitrary timeout to show how NDC is handled in asynchronous operations. <br><br>  Also in the example, a primitive connection control management mechanism is implemented (for a correct shutdown, as well as for the correct generation of NDC).  In principle, you can tell in detail about the client and server implementation itself, but this is beyond the scope of this article. <br><br><h5>  We start the client and the server without NDC </h5><br>  If we run the examples with the parameter simple, then we will see on the screen lines like this (for the client): <br><pre><code class="hljs css">17 <span class="hljs-selector-tag"><span class="hljs-selector-tag">INFO</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">connection</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">status</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">system</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:0</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">message</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">Success</span></span> 17 <span class="hljs-selector-tag"><span class="hljs-selector-tag">INFO</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">starting</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">asynchronous</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">reading</span></span>... ... 33 <span class="hljs-selector-tag"><span class="hljs-selector-tag">INFO</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">answer</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">from</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">server</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">readed</span></span>: <span class="hljs-selector-attr"><span class="hljs-selector-attr">[552]</span></span> 33 <span class="hljs-selector-tag"><span class="hljs-selector-tag">INFO</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">starting</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">asynchronous</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">timeout</span></span> 00<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:00</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:00.552000</span></span> ... ... 141 <span class="hljs-selector-tag"><span class="hljs-selector-tag">INFO</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">timer</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">status</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">system</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:0</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">message</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">Success</span></span> 141 <span class="hljs-selector-tag"><span class="hljs-selector-tag">INFO</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">starting</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">asynchronous</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">write</span></span>... 141 <span class="hljs-selector-tag"><span class="hljs-selector-tag">INFO</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">write</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">status</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">system</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:0</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">message</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">Success</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">bytes</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">written</span></span>: 8</code> </pre> <br>  All operations are performed asynchronously, so in the log we will see first a bunch of read operations, then a bunch of start timeout operations, and then a bunch of write operations.  Moreover, since the timeouts are different for us, then the operations will go in a different order. <br><br><h5>  Implementation details </h5><br>  First we enable NDC support in log4cpp.  For this we use the class <b>PatternLayout</b> , using the <b>setConversionPattern</b> method <b>,</b> we generate the information visible to us.  The <b>% x</b> parameter is responsible for the output of the NDC (see <b>consts :: ndcLayoutPattern</b> in the common.h file) <br><br><h6>  Option 1 </h6><br>  The following idea comes to mind: since asio accepts any <a href="http://www.boost.org/doc/libs/1_51_0/doc/html/boost_asio/reference/CompletionHandler.html">CompletionHandler (which satisfies the signature</a> ), we can make a wrapper over our CompletionHandler of the following form: <br><pre> <code class="hljs cpp"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NdcHolder</span></span></span><span class="hljs-class"> :</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> boost::noncopyable { NdcHolder(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">string</span></span> &amp; ndc) { log4cpp::NDC::push(ndc); } ~NdcHolder() { log4cpp::NDC::pop(); } }; <span class="hljs-comment"><span class="hljs-comment">//... template &lt;typename Oldhandler&gt; void newHandler(OldHandler func, const std::string &amp; ndc) { NdcHolder ndcHolder(ndc); func(); }</span></span></code> </pre><br>  Naturally, we have to wrap func and ndc into another Handler, for example, using boost :: bind, or our function <br><br>  With this code, we install the NDC before executing our Handler and remove it after executing. <br><blockquote>  We are obliged to reset the NDC after the completion of our Handler, otherwise we may see messages with incorrect NDC in the logs. </blockquote><br><br><h6>  Option # 2 </h6><br>  A more canonical version, which is offered by the asio library - using the <a href="http://www.boost.org/doc/libs/1_51_0/doc/html/boost_asio/reference/asio_handler_invoke.html">Handler Invocation</a> mechanism <br>  This mechanism allows you to write your function to perform (invoke) Handler. <br><br>  In principle, for our needs, both options are about the same, but the version with the handler invocation is more flexible, allowing other possibilities to be realized, for example, deferred execution, <a href="">priority execution</a> <br><br>  By default, this function is defined in <b>boost / asio / handler_invoke_hook.hpp</b> as follows: <br><pre> <code class="hljs javascript">template &lt;typename <span class="hljs-built_in"><span class="hljs-built_in">Function</span></span>&gt; inline <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> asio_handler_invoke(<span class="hljs-built_in"><span class="hljs-built_in">Function</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">, ...) </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>); }</span></span></code> </pre> <br>  This is a function that takes a variable number of arguments (but uses only the first argument).  It is known that when searching for a function to call, a function with a variable number of arguments has the lowest priority, therefore such an implementation will be substituted if no other implementations are specified. <br><br>  It is used in <b>boost / asio / detail / handler_invoke_helpers.hpp</b> approximately as follows (threw out macros): <br><pre> <code class="hljs cpp"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> Function, <span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> Context&gt; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">inline</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">invoke</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Function&amp; function, Context&amp; context)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> boost::asio::asio_handler_invoke; asio_handler_invoke(function, boost::addressof(context)); }</code> </pre> <br><br>  In order for the function we need to be called, it is necessary that it be higher than the priority when choosing, and it can take two parameters, the first parameter is the Handler itself, and the second parameter is a certain context in which our Handler will be executed.  In our case, <b>function</b> and <b>context are the</b> same (roughly speaking, asio takes a Handler and uses it both as a function and as a context).  Thus, our task is to write a special kind of <b>CompletionHandler</b> and the function <b>asio_handler_invoke</b> <br><br>  Let's start with the implementation of Handler: <br><pre> <code class="hljs java">template &lt;typename HandlerT&gt; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NdcDecorator</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: <span class="hljs-function"><span class="hljs-function">explicit </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">NdcDecorator</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(HandlerT handler, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> std::string &amp; ndc)</span></span></span><span class="hljs-function"> : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mHandler</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(handler)</span></span></span><span class="hljs-function">, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mNdc</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ndc)</span></span></span><span class="hljs-function"> </span></span>{} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">operator</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ mHandler(); } template &lt;typename Arg1&gt; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">operator</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Arg1 arg1)</span></span></span><span class="hljs-function"> </span></span>{ mHandler(arg1); } template &lt;typename Arg1, typename Arg2&gt; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">operator</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Arg1 arg1, Arg2 arg2)</span></span></span><span class="hljs-function"> </span></span>{ mHandler(arg1, arg2); } <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> std::string &amp; ndc() <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> mNdc; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span>: HandlerT mHandler; std::string mNdc; };</code> </pre> <br>  Asio requires our Handler to satisfy the requirements, so it contains an implementation of the () operators. <br><br>  This template is essentially a regular wrapper over a previously designed Handler, the only difference is that it also stores the NDC, which we will have to set before execution and removed after. <br><br>  In order to use this <b>Handler</b> , we need to define the <b>asio_handler_invoke</b> function with this signature: <br><pre> <code class="hljs swift">template &lt;typename <span class="hljs-type"><span class="hljs-type">FunctionT</span></span>, typename <span class="hljs-type"><span class="hljs-type">HandlerT</span></span>&gt; void asio_handler_invoke(<span class="hljs-type"><span class="hljs-type">FunctionT</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function">, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">NdcDecorator</span></span></span><span class="hljs-function">&lt;HandlerT&gt; * </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ndcHandler</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-type"><span class="hljs-type">NdcHolder</span></span> ndcHolder(ndcHandler-&gt;ndc()); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; }</code> </pre> <br>  As we can see, the implementation is trivial: we install the NDC and call our Handler, it's simple. <br><br>  Now we need to force asio to call exactly our function, because the usual Handler will still be called using the old function <b>asio_handler_invoke</b> . <br>  Consider an example of starting an asynchronous read: <br><pre> <code class="hljs lisp">mSocket-&gt;async_read_some(<span class="hljs-name"><span class="hljs-name">to_asio_buffer</span></span>(<span class="hljs-name"><span class="hljs-name">mInputMsg</span></span>), boost:<span class="hljs-symbol"><span class="hljs-symbol">:bind</span></span>(<span class="hljs-name"><span class="hljs-name">&amp;server_connection</span></span>:<span class="hljs-symbol"><span class="hljs-symbol">:onRead</span></span>, shared_from(<span class="hljs-name"><span class="hljs-name">this</span></span>), placeholders:<span class="hljs-symbol"><span class="hljs-symbol">:error</span></span>, placeholders:<span class="hljs-symbol"><span class="hljs-symbol">:bytes_transferred</span></span>))<span class="hljs-comment"><span class="hljs-comment">;</span></span></code> </pre> <br>  Here we create a Handler using boost :: bind.  To set our context, we wrap the created Handler into our <b>NdcDecorator</b> using the decorate function: <br><pre> <code class="hljs lisp">mSocket-&gt;async_read_some(<span class="hljs-name"><span class="hljs-name">to_asio_buffer</span></span>(<span class="hljs-name"><span class="hljs-name">mInputMsg</span></span>), decorate( <span class="hljs-name"><span class="hljs-name">boost</span></span>:<span class="hljs-symbol"><span class="hljs-symbol">:bind</span></span>(<span class="hljs-name"><span class="hljs-name">&amp;server_connection</span></span>:<span class="hljs-symbol"><span class="hljs-symbol">:onRead</span></span>, shared_from(<span class="hljs-name"><span class="hljs-name">this</span></span>), placeholders:<span class="hljs-symbol"><span class="hljs-symbol">:error</span></span>, placeholders:<span class="hljs-symbol"><span class="hljs-symbol">:bytes_transferred</span></span>)))<span class="hljs-comment"><span class="hljs-comment">;</span></span></code> </pre> <br>  As we see, the change is not significant - namely, the call of another function, but this function creates the context we need and sets the NDC: <br><pre> <code class="hljs cpp"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> HandlerT&gt; NdcDecorator&lt;HandlerT&gt; decorate(HandlerT handler, <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">string</span></span> &amp; ndc = log4cpp::NDC::get()) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> NdcDecorator&lt;HandlerT&gt;(handler, ndc); }</code> </pre> <br>  The implementation is also quite trivial: the second parameter is set by the default value - equal to the current NDC value.  The current value of the NDC can be set earlier (in our example, this happens immediately after the connection is created - when the first asynchronous operation is started). <br><br><h5>  We start the client and the server with NDC </h5><br>  Now we start with the ndc (server) parameter: <br><pre> <code class="hljs xml">9179 INFO starting asynchronous write... <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">SID=1</span></span></span><span class="hljs-tag">&gt;</span></span> 9179 INFO starting asynchronous accept... 9179 INFO write status: system:0, message: Success, bytes written: 4 <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">SID=1</span></span></span><span class="hljs-tag">&gt;</span></span> 9179 INFO starting asynchronous timeout 00:00:00.765000 ... <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">SID=1</span></span></span><span class="hljs-tag">&gt;</span></span> ... 9595 INFO read status: system:0, message: Success <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">SID=3</span></span></span><span class="hljs-tag">&gt;</span></span> 9595 INFO answer from client readed: [GOODBYE] <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">SID=3</span></span></span><span class="hljs-tag">&gt;</span></span> 9595 INFO timer status: system:0, message: Success <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">SID=65</span></span></span><span class="hljs-tag">&gt;</span></span> 9595 INFO starting asynchronous read... <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">SID=65</span></span></span><span class="hljs-tag">&gt;</span></span> 9598 INFO read status: system:0, message: Success <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">SID=12</span></span></span><span class="hljs-tag">&gt;</span></span> 9598 INFO answer from client readed: [GOODBYE] <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">SID=12</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><br>  In the server log, we see that all operations are really mixed up, but now we can see it.  Moreover, we can use, for example, grep to filter the operations we need: <br><pre> <code class="bash hljs">cat ndc_server.log | grep <span class="hljs-string"><span class="hljs-string">"&lt;SID=50&gt;"</span></span> &gt; 50.log</code> </pre> <br><pre> <code class="hljs xml">9199 INFO starting asynchronous write... <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">SID=50</span></span></span><span class="hljs-tag">&gt;</span></span> 9199 INFO write status: system:0, message: Success, bytes written: 4 <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">SID=50</span></span></span><span class="hljs-tag">&gt;</span></span> 9199 INFO starting asynchronous timeout 00:00:00.879000 ... <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">SID=50</span></span></span><span class="hljs-tag">&gt;</span></span> 10079 INFO timer status: system:0, message: Success <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">SID=50</span></span></span><span class="hljs-tag">&gt;</span></span> 10079 INFO starting asynchronous read... <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">SID=50</span></span></span><span class="hljs-tag">&gt;</span></span> 10100 INFO read status: system:0, message: Success <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">SID=50</span></span></span><span class="hljs-tag">&gt;</span></span> 10100 INFO answer from client readed: [GOODBYE] <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">SID=50</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><br>  References: <br><ul><li>  <a href="http://asio-samples.blogspot.ru/2011/06/design-journeys-with-asio.html">Asio samples</a> - I thought it necessary to add it, since it was this article that prompted me to solve this problem. </li></ul></div><p>Source: <a href="https://habr.com/ru/post/157353/">https://habr.com/ru/post/157353/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../157335/index.html">Continuous Delivery PHP Applications</a></li>
<li><a href="../157337/index.html">WPF: 4 options buttons with icon and text</a></li>
<li><a href="../157341/index.html">Build client-side javascript templates</a></li>
<li><a href="../157347/index.html">Unboxing: iPad mini's two dollar killer</a></li>
<li><a href="../157351/index.html">How to make a desktop, or outsourcing decides</a></li>
<li><a href="../157357/index.html">On intellectual property with a cool head. Part 1</a></li>
<li><a href="../157359/index.html">Google turns off background images in search</a></li>
<li><a href="../157361/index.html">Android Phishing</a></li>
<li><a href="../157363/index.html">Qt signal / slot implementation on Android</a></li>
<li><a href="../157367/index.html">On intellectual property with a cool head. Part 2</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>