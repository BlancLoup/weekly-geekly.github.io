<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We force FFMPEG to change HLS flows depending on the current throughput</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello, residents of Habr. Today I want to tell a story about how I had to dive into the depths of ffmpeg without preparation. This article will be a g...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We force FFMPEG to change HLS flows depending on the current throughput</h1><div class="post__text post__text-html js-mediator-article">  Hello, residents of Habr.  Today I want to tell a story about how I had to dive into the depths of ffmpeg without preparation.  This article will be a guide for those who need the ability of FFMPEG to work correctly with HLS streams (namely, a change of flows depending on the current network bandwidth). <br><a name="habracut"></a><br>  Let's start a little with background.  Not so long ago, we had a project, android tv, in which one of the features was playing several videos at the same time, that is, the user looks at the screen and sees 4 videos.  Then he chooses one of them and watches it already in full screen.  The task is clear, it remains only to do.  The peculiarity is that the video comes in the <a href="https://developer.apple.com/streaming/">HLS</a> format.  I think that if you are reading this, you are already familiar with HLS, but still briefly - we are given a file, in which there are links to several streams that should change depending on the current Internet speed. <br><div class="spoiler">  <b class="spoiler_title">Example:</b> <div class="spoiler_text"><pre><code class="hljs smalltalk"><span class="hljs-symbol"><span class="hljs-symbol">#EXTM3U</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#EXT</span></span>-<span class="hljs-type"><span class="hljs-type">X</span></span>-<span class="hljs-type"><span class="hljs-type">STREAM</span></span>-<span class="hljs-type"><span class="hljs-type">INF</span></span>:<span class="hljs-type"><span class="hljs-type">PROGRAM</span></span>-<span class="hljs-type"><span class="hljs-type">ID</span></span>=<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-type"><span class="hljs-type">BANDWIDTH</span></span>=<span class="hljs-number"><span class="hljs-number">688301</span></span> http://qthttp.apple.com.edgesuite.net/<span class="hljs-number"><span class="hljs-number">1010</span></span>qwoeiuryfg/<span class="hljs-number"><span class="hljs-number">0640</span></span>_vod.m3u8 <span class="hljs-symbol"><span class="hljs-symbol">#EXT</span></span>-<span class="hljs-type"><span class="hljs-type">X</span></span>-<span class="hljs-type"><span class="hljs-type">STREAM</span></span>-<span class="hljs-type"><span class="hljs-type">INF</span></span>:<span class="hljs-type"><span class="hljs-type">PROGRAM</span></span>-<span class="hljs-type"><span class="hljs-type">ID</span></span>=<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-type"><span class="hljs-type">BANDWIDTH</span></span>=<span class="hljs-number"><span class="hljs-number">165135</span></span> http://qthttp.apple.com.edgesuite.net/<span class="hljs-number"><span class="hljs-number">1010</span></span>qwoeiuryfg/<span class="hljs-number"><span class="hljs-number">0150</span></span>_vod.m3u8 <span class="hljs-symbol"><span class="hljs-symbol">#EXT</span></span>-<span class="hljs-type"><span class="hljs-type">X</span></span>-<span class="hljs-type"><span class="hljs-type">STREAM</span></span>-<span class="hljs-type"><span class="hljs-type">INF</span></span>:<span class="hljs-type"><span class="hljs-type">PROGRAM</span></span>-<span class="hljs-type"><span class="hljs-type">ID</span></span>=<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-type"><span class="hljs-type">BANDWIDTH</span></span>=<span class="hljs-number"><span class="hljs-number">262346</span></span> http://qthttp.apple.com.edgesuite.net/<span class="hljs-number"><span class="hljs-number">1010</span></span>qwoeiuryfg/<span class="hljs-number"><span class="hljs-number">0240</span></span>_vod.m3u8 <span class="hljs-symbol"><span class="hljs-symbol">#EXT</span></span>-<span class="hljs-type"><span class="hljs-type">X</span></span>-<span class="hljs-type"><span class="hljs-type">STREAM</span></span>-<span class="hljs-type"><span class="hljs-type">INF</span></span>:<span class="hljs-type"><span class="hljs-type">PROGRAM</span></span>-<span class="hljs-type"><span class="hljs-type">ID</span></span>=<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-type"><span class="hljs-type">BANDWIDTH</span></span>=<span class="hljs-number"><span class="hljs-number">481677</span></span> http://qthttp.apple.com.edgesuite.net/<span class="hljs-number"><span class="hljs-number">1010</span></span>qwoeiuryfg/<span class="hljs-number"><span class="hljs-number">0440</span></span>_vod.m3u8 <span class="hljs-symbol"><span class="hljs-symbol">#EXT</span></span>-<span class="hljs-type"><span class="hljs-type">X</span></span>-<span class="hljs-type"><span class="hljs-type">STREAM</span></span>-<span class="hljs-type"><span class="hljs-type">INF</span></span>:<span class="hljs-type"><span class="hljs-type">PROGRAM</span></span>-<span class="hljs-type"><span class="hljs-type">ID</span></span>=<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-type"><span class="hljs-type">BANDWIDTH</span></span>=<span class="hljs-number"><span class="hljs-number">1308077</span></span> http://qthttp.apple.com.edgesuite.net/<span class="hljs-number"><span class="hljs-number">1010</span></span>qwoeiuryfg/<span class="hljs-number"><span class="hljs-number">1240</span></span>_vod.m3u8 <span class="hljs-symbol"><span class="hljs-symbol">#EXT</span></span>-<span class="hljs-type"><span class="hljs-type">X</span></span>-<span class="hljs-type"><span class="hljs-type">STREAM</span></span>-<span class="hljs-type"><span class="hljs-type">INF</span></span>:<span class="hljs-type"><span class="hljs-type">PROGRAM</span></span>-<span class="hljs-type"><span class="hljs-type">ID</span></span>=<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-type"><span class="hljs-type">BANDWIDTH</span></span>=<span class="hljs-number"><span class="hljs-number">1927853</span></span> http://qthttp.apple.com.edgesuite.net/<span class="hljs-number"><span class="hljs-number">1010</span></span>qwoeiuryfg/<span class="hljs-number"><span class="hljs-number">1840</span></span>_vod.m3u8 <span class="hljs-symbol"><span class="hljs-symbol">#EXT</span></span>-<span class="hljs-type"><span class="hljs-type">X</span></span>-<span class="hljs-type"><span class="hljs-type">STREAM</span></span>-<span class="hljs-type"><span class="hljs-type">INF</span></span>:<span class="hljs-type"><span class="hljs-type">PROGRAM</span></span>-<span class="hljs-type"><span class="hljs-type">ID</span></span>=<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-type"><span class="hljs-type">BANDWIDTH</span></span>=<span class="hljs-number"><span class="hljs-number">2650941</span></span> http://qthttp.apple.com.edgesuite.net/<span class="hljs-number"><span class="hljs-number">1010</span></span>qwoeiuryfg/<span class="hljs-number"><span class="hljs-number">2540</span></span>_vod.m3u8 <span class="hljs-symbol"><span class="hljs-symbol">#EXT</span></span>-<span class="hljs-type"><span class="hljs-type">X</span></span>-<span class="hljs-type"><span class="hljs-type">STREAM</span></span>-<span class="hljs-type"><span class="hljs-type">INF</span></span>:<span class="hljs-type"><span class="hljs-type">PROGRAM</span></span>-<span class="hljs-type"><span class="hljs-type">ID</span></span>=<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-type"><span class="hljs-type">BANDWIDTH</span></span>=<span class="hljs-number"><span class="hljs-number">3477293</span></span> http://qthttp.apple.com.edgesuite.net/<span class="hljs-number"><span class="hljs-number">1010</span></span>qwoeiuryfg/<span class="hljs-number"><span class="hljs-number">3340</span></span>_vod.m3u8</code> </pre> <br></div></div><br>  The first thing we started to implement this feature is the EXOPlayer cherer.  Which was quite logical, since <a href="http://google.github.io/ExoPlayer/guide.html">EXOPlayer</a> uses hardware codecs to play the video stream.  But it turned out that EXO has its dark side.  When using EXO to run more than one thread, no one knows what will happen.  In our case, when we launched 4 threads, on some devices everything worked well, on some only 3 worked, and the fourth one did not start, and on some, for example, something else happened on Nexus 7 2013.  When Nexus 72013 ran more than 1 stream, the hardware codecs just crashed and no videos worked, not only in our application, but also in other applications that use hardware codecs.  The only way to raise them is to reboot the device.  As it turned out, this topic was devoted to the <a href="https://github.com/google/ExoPlayer/issues/273">githaba topic</a> .  As it became clear, we cannot use hardware codecs, which means that we need to use software codecs and I remind you that the main task was to play 4 videos at the same time. <br><br>  And the search began and we searched for a long time and we tried a lot, but the only thing that suited us was <a href="https://github.com/Bilibili/ijkplayer">IJKPlayer</a> .  This is a player that is a ffmpeg wrapper.  He played HLS, played them in 4 streams, and also played other streams that EXOplayer did not play on all devices (for example, HEVC).  And for a very long time everything was fine, until we began to notice that the player always plays the same stream and does not change it depending on the network bandwidth.  For the small videos, the preview was not a problem, but for full screen it was a problem. <br><br>  After searching, it turned out that the streams do not change, and the host IJKPplayer <a href="https://github.com/Bilibili/ijkplayer/issues/299">advised to</a> parse the streams separately from the player and launch the one that is needed (just like the <a href="https://trac.ffmpeg.org/ticket/2886">ffmpeg</a> ticket).  Naturally, this did not fit because the player must adapt itself to the Internet.  The problem is a problem, but it must be solved.  There was nothing on the Internet to find so that it was decided to personally add logic to changing the flow to lib.  But before you do something, you need to understand where to do it.  FFMPEG itself is a very big way and it‚Äôs not so easy to understand what is what, but I outlined for you a few basic places that we will need to work with. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      So, the main points that we need to know: <br><br><ul><li>  There is a <a href="http://git.videolan.org/%3Fp%3Dffmpeg.git%3Ba%3Dblob%3Bf%3Dlibavformat/hls.c%3Bh%3D1ad08a4d40d62fee04fff54deec5747c663c1b2b%3Bhb%3DHEAD">read_data</a> method, which is in libavformat / hls.c, where the main magic happens.  Here we download the stream and put it in the buffer.  And at the end of the method there is a goto restart, where the segment changes.  Before this restart, we will replace the stream if we need it. </li><li>  The second object that interests us is libavformat / avio.c.  There is a ffurl_close method that is called when the link is closed, which means we‚Äôll summarize the current throughput here.  As well as the ffurl_open method, which, of course, opens our stream, which means we will reset the loaded data counter here, as well as restart the timer. </li><li>  It would also be nice to draw your attention to the new_variant and new_playlist methods - they create a playlist with all possible bitrates.  According to my observations, the player takes the first item from the list and plays it, if there was any mistake, it takes the second item.  If you need to make it so that only the smallest is played (which is logical, if you play 4 streams at the same time) or the largest stream, then pay attention to these methods. </li></ul><br>  So, summarize our tasks: <br><ul><li>  Calculate current throughput </li><li>  Replace the link, if necessary, for the appropriate bandwidth </li><li>  Clean the data after the user stops watching the video </li></ul><br>  Listing: <br><br><div class="spoiler">  <b class="spoiler_title">bitrate_manager.h</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-meta"><span class="hljs-meta">#include &lt;stdint.h&gt; #ifndef IJKPLAYER_TEST_H #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> IJKPLAYER_TEST_H extern int64_t start_loading; extern int64_t end_loading ; extern int64_t loaded_bytes; extern int64_t currentBitrate; extern int64_t diff; //  extern char** urls; //  ,     extern int64_t* bandwidth; extern int n_arrays_items; extern char* selected_url; extern int current_url_index; extern int64_t current_bandwidth; void saveStartLoadingData(); int64_t getStartLoading(); //    int isInited(); //    ,       void addToLoadingByte(int64_t bytesCount); //   ,         void endOfLoading(); //   void calculateAndSaveCurrentBitrate(); int64_t getDiff(); int64_t getLoadedBites(); int64_t getEndLoading(); int64_t getCurrentBitrate(); void setFullUrl(char* url); void setParturlParts(); //      int doWeHaveBadwidth(); //   void createDataArrays(int n_items); //   void addData(int i, char* url, int64_t band_width); //  void freeData(); //    char* getCurrentUrl(); //      int compareUrl(char* url); //       void findBestSolutionForCurrentBandwidth(); char* getUrlString(int index); #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span><span class="hljs-meta"> //IJKPLAYER_TEST_H</span></span></code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">bitrate_manager.c</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"bitrate_manager.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;time.h&gt; #include &lt;stdint.h&gt; #include &lt;string.h&gt; #include "libavutil/log.h" static const int64_t ONE_SECOND= 1000000000LL; int64_t start_loading; int64_t end_loading ; int64_t loaded_bytes; int64_t currentBitrate; int64_t diff; char** urls; int64_t* bandwidth; int n_arrays_items; char* selected_url; int current_url_index; int64_t current_bandwidth; /* * It conyains current last index + 1 */ int pointerAfterLastItem; int isInitedData = 0; int64_t now_ms() { struct timespec now; clock_gettime(CLOCK_MONOTONIC, &amp;now); return (int64_t) now.tv_sec*1000000000LL + now.tv_nsec; } void saveStartLoadingData(){ loaded_bytes = 0LL; start_loading = now_ms(); } int64_t getStartLoading(){ return start_loading; } int isInited(){ return isInitedData; } void addToLoadingByte(int64_t bytesCount){ loaded_bytes += bytesCount; } void endOfLoading(){ end_loading = now_ms(); diff = end_loading - start_loading; } void calculateAndSaveCurrentBitrate(){ if(loaded_bytes != 0) { currentBitrate = loaded_bytes * ONE_SECOND / diff; } loaded_bytes = 0; } int64_t getDiff(){ return diff; } int64_t getLoadedBites(){ return loaded_bytes; } int64_t getEndLoading(){ return end_loading; } int64_t getCurrentBitrate(){ return currentBitrate; } int doWeHaveBadwidth(){ if(bandwidth &amp;&amp; pointerAfterLastItem != 0){ return 1; } return 0; } void createDataArrays(int n_items){ isInitedData = 1; pointerAfterLastItem = 0; n_arrays_items = n_items; bandwidth = (int64_t*) malloc(n_items * sizeof(int64_t)); urls = (char**) malloc(n_items * sizeof(char*)); for(int i =0; i &lt; n_items; i++){ urls[i] = (char*) malloc(sizeof(char)); } } void addData(int i, char* url, int64_t band_width){ if(band_width == 0LL){ return; } free(urls[i]); urls[i] = (char*) malloc(strlen(url) * sizeof(char)); strcpy(urls[pointerAfterLastItem], url); bandwidth[pointerAfterLastItem] = band_width; pointerAfterLastItem++; } void freeData(){ if(isInitedData == 0){ return; } isInitedData = 0; for(int i = 0;i &lt; pointerAfterLastItem;++i) free(urls[i]); free(urls); free(bandwidth); } char* getCurrentUrl(){ return selected_url; } int compareUrl(char* url){ if(selected_url){ return strcmp(selected_url, url); } return 0; } void findBestSolutionForCurrentBandwidth() { if (currentBitrate == 0) { selected_url = urls[0]; current_url_index = 0; current_bandwidth = bandwidth[0]; return; } if (currentBitrate == current_bandwidth) return; int index = 0; int64_t selectedBitrate = bandwidth[index]; int start = 0; int length = pointerAfterLastItem; for (int i = start; i &lt; length; i++) { if (currentBitrate &gt;= bandwidth[i] &amp;&amp; selectedBitrate &lt;= bandwidth[i]) { index = i; selectedBitrate = bandwidth[i]; } } if (current_bandwidth != selectedBitrate) { selected_url = urls[index]; current_url_index = index; current_bandwidth = selectedBitrate; } }</span></span></span></span></code> </pre><br></div></div><br>  Now go to the listing of the ffmpeg <br>  Add to avio.c <br><br><div class="spoiler">  <b class="spoiler_title">avio.c</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ffurl_open</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(URLContext **puc, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *filename, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> flags, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> AVIOInterruptCB *int_cb, AVDictionary **options)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(isInited() == <span class="hljs-number"><span class="hljs-number">1</span></span>) { saveStartLoadingData(); } ‚Ä¶. } ‚Ä¶. <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ffurl_close</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(URLContext *h)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( isInited() == <span class="hljs-number"><span class="hljs-number">1</span></span>) { endOfLoading(); calculateAndSaveCurrentBitrate(); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ffurl_closep(&amp;h); }</code> </pre><br></div></div><br><br>  In hls.c, the read_data method will look like this. <br><br><div class="spoiler">  <b class="spoiler_title">hls.c</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">read_data</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *opaque, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint8_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *buf, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> buf_size)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">playlist</span></span></span><span class="hljs-class"> *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">v</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">opaque</span></span></span><span class="hljs-class">;</span></span> HLSContext *c = v-&gt;parent-&gt;priv_data; <span class="hljs-comment"><span class="hljs-comment">//   if (isInited() == 0) { createDataArrays(c-&gt;n_variants); for (int i = 0; i &lt; c-&gt;n_variants; i++) { addData(i, c-&gt;playlists[i]-&gt;url, c-&gt;variants[i]-&gt;bandwidth); } } // ,   if(doWeHaveBadwidth() == 1 &amp;&amp; isInited() == 1 &amp;&amp; compareUrl(v-&gt;url) != 0){ strcpy(v-&gt;url, getCurrentUrl()); } int ret, i; int just_opened = 0; restart: if (!v-&gt;needed) return AVERROR_EOF; if (!v-&gt;input) { int64_t reload_interval; /* Check that the playlist is still needed before opening a new * segment. */ if (v-&gt;ctx &amp;&amp; v-&gt;ctx-&gt;nb_streams &amp;&amp; v-&gt;parent-&gt;nb_streams &gt;= v-&gt;stream_offset + v-&gt;ctx-&gt;nb_streams) { v-&gt;needed = 0; for (i = v-&gt;stream_offset; i &lt; v-&gt;stream_offset + v-&gt;ctx-&gt;nb_streams; i++) { if (v-&gt;parent-&gt;streams[i]-&gt;discard &lt; AVDISCARD_ALL) v-&gt;needed = 1; } } if (!v-&gt;needed) { av_log(v-&gt;parent, AV_LOG_INFO, "No longer receiving playlist %d\n", v-&gt;index); return AVERROR_EOF; } /* If this is a live stream and the reload interval has elapsed since * the last playlist reload, reload the playlists now. */ reload_interval = default_reload_interval(v); reload: if (!v-&gt;finished &amp;&amp; av_gettime_relative() - v-&gt;last_load_time &gt;= reload_interval) { if ((ret = parse_playlist(c, v-&gt;url, v, NULL)) &lt; 0) { av_log(v-&gt;parent, AV_LOG_WARNING, "Failed to reload playlist %d\n", v-&gt;index); return ret; } //      if(isInited() == 1 &amp;&amp; doWeHaveBadwidth() == 1) { addToLoadingByte(ret); } /* If we need to reload the playlist again below (if * there's still no more segments), switch to a reload * interval of half the target duration. */ reload_interval = v-&gt;target_duration / 2; } if (v-&gt;cur_seq_no &lt; v-&gt;start_seq_no || v-&gt;cur_seq_no &gt; (v-&gt;start_seq_no + (v-&gt;n_segments * 5)) ) { av_log(NULL, AV_LOG_WARNING, "skipping %d segments ahead, expired from playlists\n", v-&gt;start_seq_no - v-&gt;cur_seq_no); v-&gt;cur_seq_no = v-&gt;start_seq_no; } if (v-&gt;cur_seq_no &gt;= v-&gt;start_seq_no + v-&gt;n_segments) { if (v-&gt;finished) return AVERROR_EOF; while (av_gettime_relative() - v-&gt;last_load_time &lt; reload_interval) { if (ff_check_interrupt(c-&gt;interrupt_callback)) return AVERROR_EXIT; av_usleep(100*1000); } /* Enough time has elapsed since the last reload */ goto reload; } ret = open_input(c, v); //      if(isInited() == 1 &amp;&amp; doWeHaveBadwidth() == 1) { addToLoadingByte(ret); } if (ret &lt; 0) { if (ff_check_interrupt(c-&gt;interrupt_callback)) return AVERROR_EXIT; av_log(v-&gt;parent, AV_LOG_WARNING, "Failed to open segment of playlist %d\n", v-&gt;index); v-&gt;cur_seq_no += 1; goto reload; } just_opened = 1; } ret = read_from_url(v, buf, buf_size, READ_NORMAL); //      if(isInited() == 1 &amp;&amp; doWeHaveBadwidth() == 1) { addToLoadingByte(ret); } if (ret &gt; 0) { if (just_opened &amp;&amp; v-&gt;is_id3_timestamped != 0) { /* Intercept ID3 tags here, elementary audio streams are required * to convey timestamps using them in the beginning of each segment. */ intercept_id3(v, buf, buf_size, &amp;ret); } return ret; } ffurl_close(v-&gt;input); v-&gt;input = NULL; v-&gt;cur_seq_no++; c-&gt;cur_seq_no = v-&gt;cur_seq_no; //   .      bandwidth          if(isInited() == 1 &amp;&amp; doWeHaveBadwidth() == 1) { findBestSolutionForCurrentBandwidth(); if (compareUrl(v-&gt;url) != 0) { strcpy(v-&gt;url, getCurrentUrl()); } } goto restart; }</span></span></code> </pre><br></div></div><br><br>  Remaining trifles we add new files to the makefile inside libavformat in HEADERS and OBJS we add the corresponding references <br><br><div class="spoiler">  <b class="spoiler_title">makefile</b> <div class="spoiler_text"><pre> <code class="hljs tex">NAME = avformat HEADERS = avformat.h <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>avio.h <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>version.h <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>avc.h <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>url.h <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>internal.h <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>bitrate_mamnger.h <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>OBJS = allformats.o <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>avio.o <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>aviobuf.o <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>cutils.o <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>dump.o <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>format.o <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>id3v1.o <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>id3v2.o <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>metadata.o <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>mux.o <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>options.o <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>os_support.o <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>riff.o <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>sdp.o <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>url.o <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>utils.o <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>avc.o <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>bitrate_mamnger.o <span class="hljs-tag"><span class="hljs-tag">\</span></span></code> </pre><br></div></div><br><br>  We also add the IjkMediaPlayer_freeBitateWorkData method to ijkplayer_jni.c, which we will call after the view is complete, to clear the data. <br><br><div class="spoiler">  <b class="spoiler_title">ijkplayer_jni.c</b> <div class="spoiler_text"><pre> <code class="hljs cs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">IjkMediaPlayer_freeBitateWorkData</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">JNIEnv *env, jclass clazz</span></span></span><span class="hljs-function">)</span></span>{ freeData(); } <span class="hljs-comment"><span class="hljs-comment">//      g_methods ... { "_freeBitateWorkData", "()V", (void *)IjkMediaPlayer_freeBitateWorkData }, ...</span></span></code> </pre><br></div></div><br><br>  Everything, our implementation is ready, now it remains to rebuild and watch videos with changing stream. </div><p>Source: <a href="https://habr.com/ru/post/307232/">https://habr.com/ru/post/307232/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../307220/index.html">This little miracle is the Knut-Morris-Pratt (KMP) algorithm.</a></li>
<li><a href="../307222/index.html">About pricing for indie games</a></li>
<li><a href="../307224/index.html">Fairy, evil corporation and duck. How games are really made. Part 2. Programmer</a></li>
<li><a href="../307226/index.html">New x features: Bind in UWP</a></li>
<li><a href="../307228/index.html">Sensor of absolute pressure BMP180</a></li>
<li><a href="../307234/index.html">Migrating Xenserver 7 to linux raid</a></li>
<li><a href="../307236/index.html">Approximation of Pi by Mandelbrot Set</a></li>
<li><a href="../307242/index.html">Pattern recognition in R using convolutional neural networks from the MXNet package</a></li>
<li><a href="../307248/index.html">Work with PGPool + ORM Yii2</a></li>
<li><a href="../307250/index.html">The intersection of the muzzles of top domains 1,000,000 by N-grams</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>