<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Acceleration of Python code using the language itself</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="No matter how good Python is, he has a problem known to all developers - speed. On this topic was written many articles , including on Habr√© . 


 Mos...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Acceleration of Python code using the language itself</h1><div class="post__text post__text-html js-mediator-article"><img align="left" src="https://habrastorage.org/storage1/0b6d8bda/51bc539c/a6bfc807/4b2a95f6.png">  No matter how good Python is, he has a problem known to all developers - speed.  On this topic was written many <a href="http://eax.me/python-benchmark/">articles</a> , including <a href="http://habrahabr.ru/blogs/programming/66562/">on</a> <a href="http://habrahabr.ru/blogs/programming/124346/">Habr√©</a> . <br><br><a name="habracut"></a><br>  Most often, offer the following solutions: <br><ul><li>  Use <a href="http://psyco.sourceforge.net/">Psyco</a> </li><li>  Rewrite part of the program in C using Python C Extensions </li><li>  Change <s>brains</s> algorithm </li></ul><br><br>  Of course, the decisions are correct.  But each of them has its drawbacks. <br>  <b>Psyco</b> is an excellent module that achieves code acceleration by hundreds of percent, but: only 32-bit Python versions not higher than 2.6 are supported, <a href="http://stackoverflow.com/questions/575385/why-not-always-use-psyco-for-python-code">high memory consumption</a> and the fact that lately the development of psyco slowed down, the last update on the <a href="http://psyco.sourceforge.net/">site is</a> dated July 16, 2010.  Perhaps with the release of Psyco v2, the situation will change, but so far, this module is not always applicable. <br>  <b>Python C Extensions</b> (I recommend an excellent article <a href="https://habrahabr.ru/users/rushman/" class="user_link">rushman</a> <a href="http://habrahabr.ru/blogs/python/44520/">Writing an extension module for Python on C</a> ) - the creators of Python made all developers using this language an invaluable gift - Python / C API, giving the possibility of relatively transparent integration of C-code in Python programs 'e.  There are only two drawbacks to this solution: <br><ol><li>  The ‚Äúthreshold of entry‚Äù for C and Python / C API is still higher than that of ‚Äúbare‚Äù Python, which cuts off this opportunity for developers who are not familiar with C </li><li>  One of the key features of Python is the speed of development.  Writing a part of a C program reduces it, in proportion to the part of the code rewritten in C to the whole program. </li></ol><br>  So, this method is also not suitable for everyone. <br>  <b>The change of the algorithm</b> is not always possible, the situations are frequent, as the fastest algorithm produces disappointing results in speed. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h5>  So what to do? </h5><br>  Then, if for your project the above listed methods did not fit, what should I do?  Change Python to another language?  No, you can not give up.  We will optimize the code itself.  <i>Examples will be taken from a program that builds <a href="http://ru.wikipedia.org/wiki/%25D0%259C%25D0%25BD%25D0%25BE%25D0%25B6%25D0%25B5%25D1%2581%25D1%2582%25D0%25B2%25D0%25BE_%25D0%259C%25D0%25B0%25D0%25BD%25D0%25B4%25D0%25B5%25D0%25BB%25D1%258C%25D0%25B1%25D1%2580%25D0%25BE%25D1%2582%25D0%25B0">a Mandelbrot</a> set of a given size with a given number of iterations.</i> <i><br></i>  <i>The operating time of the original version with parameters 600 * 600 pixels, 100 iterations was <b>3.07 seconds</b> , we take this value as 100%</i> <br><br>  <b>I will say in advance, part of the optimization will lead to the fact that the code will become less pythonic, forgive the adherents of the python-way.</b> <br><br><h6>  Step 0. Bringing the main program code to a separate </h6><br>  This step helps the python interpreter to better conduct internal optimizations about the launch, and when using psyco, this step can help a lot, since  psyco optimizes only functions without affecting the main body of the program. <br>  If earlier the calculated part of the source program looked like this: <br><pre><code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> Y <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> xrange(height): <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> X <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> xrange(width): <span class="hljs-comment"><span class="hljs-comment">#   (X,Y)   , itt </span></span></code> </pre> <br>  That, changing it to: <br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mandelbrot</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(height, itt, width)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> Y <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> xrange(height): <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> X <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> xrange(width): <span class="hljs-comment"><span class="hljs-comment">#   (X,Y)   , itt  mandelbrot(height, itt, width)</span></span></code> </pre><br>  we got a time of <b>2.4 seconds</b> , i.e.  <b>78%</b> of the original. <br><br><h6>  Step 1. Profiling </h6><br>  The standard Python library, it's just a Klondike of useful modules.  Now we are interested in the cProfile module, thanks to which, profiling the code becomes simple and even interesting. <br>  Full documentation on this module can be found <a href="http://docs.python.org/library/profile.html">here</a> , we have enough of a couple of simple commands. <br><br> <code>python -m cProfile sample.py</code> <br>  <font color="#333333"><i>The -m key allows you to run modules as separate programs if the module itself provides such an opportunity.</i></font> <br>  The result of this command will be getting the "profile" of the program - a table, like <br> <code>4613944 function calls (4613943 primitive calls) in 2.818 seconds <br> <br> Ordered by: internal time <br> <br> ncalls tottime percall cumtime percall filename:lineno(function) <br> 1 2.309 2.309 2.766 2.766 mand_slow.py:22(mandelbrot) <br> ... <br></code> <br>  With its help, it is easy to identify the places that need optimization (the lines with the highest values ‚Äã‚Äãof ncalls (the number of function calls), tottime and percall (the running time of all calls to this function and each individual, respectively)). <br><br>  For convenience, you can add the <code>-s time</code> sorting the profiler output by runtime. <br><br>  In my case, the interesting part of the output was (the execution time differs from the above because the profiler adds its ‚Äúoverhead‚Äù): <br> <code>4613944 function calls (4613943 primitive calls) in 2.818 seconds <br> <br> Ordered by: internal time <br> <br> ncalls tottime percall cumtime percall filename:lineno(function) <br> 1 2.309 2.309 2.766 2.766 mand_slow.py:22(mandelbrot) <br> 3533224 0.296 0.000 0.296 0.000 {abs} <br> 360000 0.081 0.000 0.081 0.000 {math.atan2} <br> 360000 0.044 0.000 0.044 0.000 {math.cos} <br> 360000 0.036 0.000 0.036 0.000 {math.sqrt} <br> ...</code> <br>  So, the profile is received, now we will be engaged in optimization closely. <br><br><h6>  Step 2. Profile analysis </h6><br>  We see that in the first place in time is our main function mandelbrot, followed by the system function abs, followed by several functions from the math module, then - single function calls, with minimal time costs, they are not interesting for us. <br><br>  So, the system functions "licked" by the community, we can hardly be improved, so let's move on to our own code: <br><br><h6>  Step 3. Math </h6><br>  Now, the code looks like this: <br><pre> <code class="python hljs">pix = img.load() <span class="hljs-comment"><span class="hljs-comment">#   def mandelbrot(height, itt, width): step_x = (2 - width / 1.29) / (width / 2.6) - (1 - width / 1.29) / (width / 2.6) #    for Y in xrange(height): y = (Y - height / 2) / (width / 2.6) # Y        ,       x = - (width / 1.29) / (width / 2.6) for X in xrange(width): x += step_x z = complex(x, y) phi = math.atan2(y, x - 0.25) p = math.sqrt((x - 0.25) ** 2 + y ** 2) pc = 0.5 - 0.5 * math.cos(phi) if p &lt;= pc: #     -  pix[X, Y] = (255, 255, 255) continue Z_i = 0j for i in xrange(itt): #    " " Z_i = Z_i ** 2 + z if abs(Z_i) &gt; 2: color = (i * 255) // itt pix[X, Y] = (color, color, color) break else: pix[X, Y] = (255, 255, 255) print("\r%d/%d" % (Y, height)),</span></span></code> </pre><br>  Note that the exponentiation ** operator is quite ‚Äúcommon‚Äù, we only need the second-degree construction, i.e.  all constructions of the form x ** 2 can be replaced by x * x, thus winning a little more time.  Let's look at the time: <br>  <b>1.9 seconds</b> , or <b>62% of the</b> initial time, is achieved by simply replacing two lines: <br><pre> <code class="python hljs">p = math.sqrt((x - <span class="hljs-number"><span class="hljs-number">0.25</span></span>) ** <span class="hljs-number"><span class="hljs-number">2</span></span> + y ** <span class="hljs-number"><span class="hljs-number">2</span></span>) ... Z_i = Z_i **<span class="hljs-number"><span class="hljs-number">2</span></span> + z</code> </pre><br>  on: <br><pre> <code class="python hljs">p = math.sqrt((x - <span class="hljs-number"><span class="hljs-number">0.25</span></span>) * (x - <span class="hljs-number"><span class="hljs-number">0.25</span></span>) + y * y) ... Z_i = Z_i * Z_i + z</code> </pre><br><br><h6>  Steps 5, 6 and 7. Small but important </h6><br>  The basic truth that all Python programmers know about is working with global variables more slowly than working with local variables.  But it is often forgotten that this is true not only for variables but in general for all objects.  In the function code, calls are made to several functions from the math module.  So why not import them into the function itself?  Made by: <br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mandelbrot</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(height, itt, width)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> math <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> atan2, cos, sqrt pix = img.load() <span class="hljs-comment"><span class="hljs-comment">#  </span></span></code> </pre><br>  Another 0.1 seconds is won back. <br>  Recall that abs (x) returns a float number.  So, it is worth comparing it with float and not int: <br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> abs(Z_i) &gt; <span class="hljs-number"><span class="hljs-number">2</span></span>: ------&gt; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> abs(Z_i) &gt; <span class="hljs-number"><span class="hljs-number">2.0</span></span>:</code> </pre><br>  Another 0.15s.  <b>53%</b> of the start time. <br><br>  And finally, the dirty hack. <br>  In this particular task, it can be understood that the bottom half of the image is equal to the top, so  The number of calculations can be halved, resulting in a total of <b>0.84 seconds</b> or <b>27%</b> of the original time. <br><br><h5>  Conclusion </h5><br>  Profile.  Use timeit.  Optimize.  Python is a powerful language, and the programs on it will work at a speed proportional to your desire to understand and polish everything :) <br>  The purpose of this article is to show that due to minor and minor changes, such as replacing ** with *, you can make a green snake crawl <i>up to two times faster</i> without using heavy artillery in the form of Xi, or psyco shamanism. <br>  Also, you can combine different tools, such as the above optimization and the psyco module, it won't get any worse :) <br><br>  Thanks to everyone who read to the end, I will be glad to hear your opinions and comments in the comments! <br><br>  <b>UPD</b> Useful <a href="http://wiki.python.org/moin/PythonSpeed/PerformanceTips">link</a> in the comments cited <a href="https://habrahabr.ru/users/funca/" class="user_link">funca</a> . </div><p>Source: <a href="https://habr.com/ru/post/124388/">https://habr.com/ru/post/124388/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../124383/index.html">Open Science and Open Education</a></li>
<li><a href="../124384/index.html">New in Ext GWT 3.0</a></li>
<li><a href="../124385/index.html">Physical Standby DB for Oracle SE</a></li>
<li><a href="../124386/index.html">Inventory of computers in the domain. Laziness is the engine of progress</a></li>
<li><a href="../124387/index.html">FAQ on the leak of SMS texts from the MegaFon website</a></li>
<li><a href="../124389/index.html">Electrodnevnik</a></li>
<li><a href="../124392/index.html">Windows 8 system requirements will not differ from Windows 7</a></li>
<li><a href="../124394/index.html">Errors and errors of customers in the development of a corporate website</a></li>
<li><a href="../124395/index.html">Basics of number systems</a></li>
<li><a href="../124399/index.html">How to create an e-economy in Russia? (theory)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>