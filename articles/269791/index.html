<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Janusjs: concept of the system, where the client and server are conjoined twins</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="By the nature of my work, I often have to develop a variety of crm-systems. The client part I have been collecting for a very long time on Extjs (I st...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Janusjs: concept of the system, where the client and server are conjoined twins</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/2a9/a0d/f35/2a9a0df3552ff6e8e0925bb157d18c59.jpg" alt="image" align="left">  By the nature of my work, I often have to develop a variety of crm-systems.  The client part I have been collecting for a very long time on Extjs (I started from version 2).  A couple of years ago Nodejs firmly settled on the server, replacing the usual PHP. <br><br>  Last year, the idea of ‚Äã‚Äãa unified platform for the client and server parts of the web application based on Extjs.  After a year of trial and error, the puzzle has more or less taken shape.  In this article, I want to share the concept of a framework whose code looks the same on the client and server side. <br><a name="habracut"></a><br>  A few reasons for choosing Sencha as the base library: <br><br><ol><li>  Products of the company Sencha (Extjs in particular) are known among the developers, respectively, there are a sufficient number of specialists in this topic.  For the same reason, there are no problems with documentation, examples, and the community. </li><li>  Extjs is one of the few js frameworks with a logical, well-thought-out architecture that is equally well applicable on both the client and server side of the application. </li><li>  A single code base allows you to describe both client and server logic in a single file.  This reduces the number of lines of code and avoids duplication. </li></ol>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h2>  Installation </h2><br>  We need Nodejs, Mongodb, Memcached.  Nodejs and Mongodb, preferably, fresh versions (especially Nodejs).  I see no point in describing the installation process of these programs in the article, there are enough instructions for every taste and OS on the network. <br><br>  Before starting the installation, be sure to check whether the mongodb and memcached processes are running.  The installation script checks the connectivity.  If there is no connection, the installation will fail. <br><br>  Install the framework: <br><pre><code class="bash hljs">npm i janusjs</code> </pre> <br><br>  At the end of the installation, the installer will ask a few suggestive questions for generating the sample project (database connection parameters, default user, etc.). <br><br>  After all the manipulations, in the current directory you will have the following content: <br><pre> <code class="bash hljs">node_modules projects cluster.config.js cluster.js daemon.js server.js</code> </pre><br>  projects - project directory <br>  from the rest of the files, we are, for now, interested in server.js, and run it: <br><pre> <code class="bash hljs">node server</code> </pre><br>  If everything is in order, the console will say: ‚ÄúServer localhost is listening on port 8008‚Äù <br>  In case of an error, check if the port is busy and Mongodb and Memcached are running. <br>  The web interface of the system is available at the address <a href="http://localhost/">localhost</a> : 8008 / admin / (if you did not change the user during the installation, then admin: admin).  Access parameters can be checked in the project's project file. <pre> <code class="bash hljs">projects/crm/config.json</code> </pre><br>  The user interface is quite standard.  The system allows for different user groups to create different types of interfaces. <br><br>  On the video you can see an example of the work of crm real estate agency: <br><br><iframe width="420" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/9-TeLcVw520%3Ffeature%3Doembed&amp;xid=17259,15700021,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjfMd2dnUYLgpiJeGILeJnXE3pULg" frameborder="0" allowfullscreen=""></iframe><br><br><h2>  Creating modules </h2><br>  When installing Janus, an empty project was to be created in the projects / crm directory.  Project directory structure: <br><br><pre> <code class="javascript hljs">protected <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> admin css extended locale modules news controller model view config.json config.json</code> </pre><br><br>  <b>static / admin / modules / news</b> is an example of a CRM module.  There is a simple list of news.  Let's see how this is done. <br><br>  Janusjs modules are built based on the MVP pattern.  In detail we will consider each part of the module: <br><br>  <b>controller / News.js</b> - controller (Presenter).  The module implements the standard behavior (the list of entries is a record card), therefore all the functionality ‚Äúlives‚Äù in the parent class.  Controller code: <br><br><pre> <code class="javascript hljs">Ext.define(<span class="hljs-string"><span class="hljs-string">'Crm.modules.news.controller.News'</span></span>, { <span class="hljs-attr"><span class="hljs-attr">extend</span></span>: <span class="hljs-string"><span class="hljs-string">'Core.controller.Controller'</span></span>, <span class="hljs-attr"><span class="hljs-attr">launcher</span></span>: { <span class="hljs-attr"><span class="hljs-attr">text</span></span>: <span class="hljs-string"><span class="hljs-string">'News'</span></span>, <span class="hljs-comment"><span class="hljs-comment">//   iconCls:'fa fa-newspaper-o' //  ,  Font Awesome } });</span></span></code> </pre><br>  The news module has 2 standard views - a list of news and a separate news card.  It is important for representations to give names corresponding to the controller: <br><br>  List view (view / NewsList.js) <br><pre> <code class="javascript hljs">Ext.define(<span class="hljs-string"><span class="hljs-string">'Crm.modules.news.view.NewsList'</span></span>, { <span class="hljs-attr"><span class="hljs-attr">extend</span></span>: <span class="hljs-string"><span class="hljs-string">'Core.grid.GridWindow'</span></span>, <span class="hljs-attr"><span class="hljs-attr">sortManually</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-comment"><span class="hljs-comment">//      filterbar: true, //    /*    */ buildColumns: function() { return [{ text: 'Title', flex: 1, sortable: true, dataIndex: 'name', filter: true },{ text: 'Date start', flex: 1, sortable: true, xtype: 'datecolumn', dataIndex: 'date_start', filter: true },{ text: 'Date finish', flex: 1, sortable: true, xtype: 'datecolumn', dataIndex: 'date_end', filter: true }] } })</span></span></code> </pre><br>  Presentation for the news card (view / NewsForm.js) <br><pre> <code class="javascript hljs">Ext.define(<span class="hljs-string"><span class="hljs-string">'Crm.modules.news.view.NewsForm'</span></span>, { <span class="hljs-attr"><span class="hljs-attr">extend</span></span>: <span class="hljs-string"><span class="hljs-string">'Core.form.DetailForm'</span></span> ,<span class="hljs-attr"><span class="hljs-attr">titleIndex</span></span>: <span class="hljs-string"><span class="hljs-string">'name'</span></span> <span class="hljs-comment"><span class="hljs-comment">//  ,          ,layout: 'border' ,border: false ,bodyBorder: false ,height: 450 ,width: 750 ,buildItems: function() { return [{ xtype: 'panel', region: 'north', border: false, bodyBorder: false, layout: 'anchor', bodyStyle: 'padding: 5px;', items: [{ name: 'name', anchor: '100%', xtype: 'textfield', fieldLabel: 'Title' },{ xtype: 'fieldcontainer', layout: 'hbox', anchor: '100%', items: [{ xtype: 'datefield', fieldLabel: 'Date start', name: 'date_start', flex: 1, margin: '0 10 0 0' },{ xtype: 'datefield', fieldLabel: 'Date finish', name: 'date_end', flex: 1 }] },{ xtype: 'textarea', anchor: '100%', height: 60, name: 'stext', emptyText: 'Announce' }] }, this.fullText() ] } ,fullText: function() { return Ext.create('Desktop.modules.pages.view.HtmlEditor', { hideLabel: true, region: 'center', name: 'text' }) } })</span></span></code> </pre><br>  Views should not be difficult - these are standard Extjs components.  Controllers of different modules can use the same views. <br><br>  Now the most interesting is the model.  In Janusjs, the model code is used on both the client side and the server side.  Consider the news module model: <br><br>  News model (model / NewsModel.js) <br><pre> <code class="javascript hljs">Ext.define(<span class="hljs-string"><span class="hljs-string">'Crm.modules.news.model.NewsModel'</span></span>, { <span class="hljs-attr"><span class="hljs-attr">extend</span></span>: <span class="hljs-string"><span class="hljs-string">"Core.data.DataModel"</span></span> ,<span class="hljs-attr"><span class="hljs-attr">collection</span></span>: <span class="hljs-string"><span class="hljs-string">'news'</span></span> <span class="hljs-comment"><span class="hljs-comment">//  /   ,removeAction: 'remove' //       /*    */ ,fields: [{ name: '_id', //   type: 'ObjectID', //   visible: true //     },{ name: 'name', type: 'string', filterable: true, //      editable: true, //    visible: true },{ name: 'date_start', type: 'date', filterable: true, editable: true, visible: true },{ name: 'date_end', type: 'date', filterable: true, editable: true, visible: true },{ name: 'stext', type: 'string', filterable: false, editable: true, visible: true },{ name: 'text', type: 'string', filterable: false, editable: true, visible: true }] })</span></span></code> </pre><br>  The name of the model file must also match the name of the controller.  Otherwise, in the controller, you must manually specify which model it should work with (the 'modelName' parameter). <br><br>  At the root of the news module directory is the file ‚Äúmanifest.json‚Äù.  This file is needed for the module to appear in the main menu of the user interface.  In complex cases, a module may consist of several controllers and the system must know which of them is the main one, for this, a manifest is needed.  If the manifest file is not in the module directory, the module will not be visible in the main menu. <br><br>  <b>Important note:</b> for any changes in the server part of the system, restart the Janusjs server! <br><br><h2>  One code on client and server </h2><br>  To illustrate the architectural features of Janusjs, we will slightly modify the news module.  Add a button, when clicked, all selected news in the list will be published for a week (start date = current date, end date = +7 days). <br><br>  Add a button to the list view: <br><br><pre> <code class="javascript hljs">Ext.define(<span class="hljs-string"><span class="hljs-string">'Crm.modules.news.view.NewsList'</span></span>, { ‚Ä¶ <span class="hljs-comment"><span class="hljs-comment">//     Tbar ,buildTbar: function() { //      //    var items = this.callParent(); //    items.splice(2,0, { text: 'Publish selected', action: 'publish' }) return items; } ‚Ä¶ })</span></span></code> </pre><br><br>  Add a handler to the controller for the new button: <br><br><pre> <code class="javascript hljs">Ext.define(<span class="hljs-string"><span class="hljs-string">'Crm.modules.news.controller.News'</span></span>, { <span class="hljs-attr"><span class="hljs-attr">extend</span></span>: <span class="hljs-string"><span class="hljs-string">'Core.controller.Controller'</span></span> ,<span class="hljs-attr"><span class="hljs-attr">addControls</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">win</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> me = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span> me.control(win,{ <span class="hljs-string"><span class="hljs-string">"[action=publish]"</span></span>: {<span class="hljs-attr"><span class="hljs-attr">click</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{me.publish(win)}} }) me.callParent(<span class="hljs-built_in"><span class="hljs-built_in">arguments</span></span>) } ,<span class="hljs-attr"><span class="hljs-attr">publish</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">win</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> grid = win.down(<span class="hljs-string"><span class="hljs-string">'grid'</span></span>) <span class="hljs-comment"><span class="hljs-comment">//    ,selected = grid.getSelectionModel().selected //      ,ids = []; if(selected &amp;&amp; selected.items) { selected.items.forEach(function(item) { ids.push(item.data._id) }) if(ids.length) { //     //      this.model.publish(ids, function() { grid.getStore().reload(); }) } } } })</span></span></code> </pre><br>  Let's finalize the news model: <br><br><pre> <code class="javascript hljs">Ext.define(<span class="hljs-string"><span class="hljs-string">'Crm.modules.news.model.NewsModel'</span></span>, { <span class="hljs-attr"><span class="hljs-attr">extend</span></span>: <span class="hljs-string"><span class="hljs-string">"Core.data.DataModel"</span></span> ,<span class="hljs-attr"><span class="hljs-attr">collection</span></span>: <span class="hljs-string"><span class="hljs-string">'news'</span></span> ,<span class="hljs-attr"><span class="hljs-attr">removeAction</span></span>: <span class="hljs-string"><span class="hljs-string">'remove'</span></span> ,<span class="hljs-attr"><span class="hljs-attr">fields</span></span>: [ ....... ] ,<span class="hljs-attr"><span class="hljs-attr">publish</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ids, cb</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//      this.runOnServer('publish', {ids: ids}, cb) } //          //     $,     //    $   (. 6  ) ,$publish: function(data, cb) { var me = this ,date_start = new Date() //   ,date_end = new Date(date_start.getTime() + 86400000 * 7) // + 7  ,ids = data.ids || null; if(!ids) { cb({ok: false}) return; } //    //     ObjectId ids.each(function(id) { return me.src.db.fieldTypes.ObjectID.getValueToSave(null, id) }, true) //     // me.dbCollection -      me.dbCollection.update({ _id:{$in: ids} }, { $set: { date_start: date_start, date_end: date_end } }, { multi: true }, function() { cb({ok: true}) }) } })</span></span></code> </pre><br>  Thus, the ‚Äúpublish‚Äù method will work on the client, and the $ publish method on the server. <br><br><h2>  Safety issue </h2><br>  There is one significant problem with our model:  the model code is available on the client and on the server; you can see from the outside what is going on inside.  Show the server logic methods to the outside is not kosher, so hide them.  This is done with the help of special server directives that are placed in the comments.  There are 2 directives: scope: server and scope: client <br><br>  <b>/ * scope: server * /</b> - removes the method following this comment from the code when returning to the client <br>  <b>// scope: server</b> - removes the entire line from the code when returning to the client <br>  <b>/ * scope: client * /</b> - removes the method following this comment from the code before executing the code on the server <br>  <b>// scope: client</b> - removes the entire line from the code before executing the code on the server <br><br>  Using this knowledge, we will make our model safe: <br><br><pre> <code class="javascript hljs">Ext.define(<span class="hljs-string"><span class="hljs-string">'Crm.modules.news.model.NewsModel'</span></span>, { <span class="hljs-attr"><span class="hljs-attr">extend</span></span>: <span class="hljs-string"><span class="hljs-string">"Core.data.DataModel"</span></span> ,<span class="hljs-attr"><span class="hljs-attr">collection</span></span>: <span class="hljs-string"><span class="hljs-string">'news'</span></span> <span class="hljs-comment"><span class="hljs-comment">// scope:server ,removeAction: 'remove' // scope:server ,fields: [{ name: '_id', type: 'ObjectID', // scope:server visible: true },{ name: 'name', type: 'string', // scope:server filterable: true, editable: true, visible: true },{ name: 'date_start', type: 'date', // scope:server filterable: true, editable: true, visible: true },{ name: 'date_end', type: 'date', // scope:server filterable: true, editable: true, visible: true },{ name: 'stext', type: 'string', // scope:server filterable: false, editable: true, visible: true },{ name: 'text', type: 'string', // scope:server filterable: false, editable: true, visible: true }] /* scope:client */ ,publish: function(ids, cb) { this.runOnServer('publish', {ids: ids}, cb) } /* scope:server */ ,$publish: function(data, cb) { var me = this ,date_start = new Date() //   ,date_end = new Date(date_start.getTime() + 86400000 * 7) // + 7  ,ids = data.ids || null; if(!ids) { cb({ok: false}) return; } ids.each(function(id) { return me.src.db.fieldTypes.ObjectID.getValueToSave(null, id) }, true) me.dbCollection.update({ _id:{$in: ids} }, { $set: { date_start: date_start, date_end: date_end } }, { multi: true }, function() { cb({ok: true}) }) } })</span></span></code> </pre><br>  Now you can sleep peacefully, server methods are not visible from the outside.  By the way, using the ‚Äúscope‚Äù directives, you can give client and server methods and properties of the same model the same names. <br><br><h2>  Related Modules </h2><br>  Janusjs makes it easy to combine several related modules into one.  On the video at the beginning of the article, the list of interested clients, the comments of the agents, and the documents related to the object are pulled into the real estate card. <br><br>  Add a tab with comments to the news card.  To begin with, create directories and files for the comment module (all the paths below are relative to the project directory projects / crm /): <br><br><pre> <code class="bash hljs">static admin modules comments controller Comments.js model CommentsModel.js view CommentsList.js CommentsForm.js</code> </pre><br>  Controller code (Comments.js): <br><pre> <code class="javascript hljs">Ext.define(<span class="hljs-string"><span class="hljs-string">'Crm.modules.comments.controller.Comments'</span></span>, { <span class="hljs-attr"><span class="hljs-attr">extend</span></span>: <span class="hljs-string"><span class="hljs-string">'Core.controller.Controller'</span></span>, <span class="hljs-attr"><span class="hljs-attr">launcher</span></span>: { <span class="hljs-attr"><span class="hljs-attr">text</span></span>: <span class="hljs-string"><span class="hljs-string">'Comments'</span></span>, <span class="hljs-comment"><span class="hljs-comment">//   iconCls:'fa fa-comment-o' //   } });</span></span></code> </pre><br>  Presentation of the list of comments (CommentsList.js): <br><pre> <code class="javascript hljs">Ext.define(<span class="hljs-string"><span class="hljs-string">'Crm.modules.comments.view.CommentsList'</span></span>, { <span class="hljs-attr"><span class="hljs-attr">extend</span></span>: <span class="hljs-string"><span class="hljs-string">'Core.grid.GridWindow'</span></span>, <span class="hljs-comment"><span class="hljs-comment">//           buildColumns: function() { return [{ text: 'Comment', flex: 1, sortable: true, dataIndex: 'text', filter: true }] } })</span></span></code> </pre><br><br>  The form for adding and editing a comment (CommentsForm.js): <br><pre> <code class="javascript hljs">Ext.define(<span class="hljs-string"><span class="hljs-string">'Crm.modules.comments.view.CommentsForm'</span></span>, { <span class="hljs-attr"><span class="hljs-attr">extend</span></span>: <span class="hljs-string"><span class="hljs-string">'Core.form.DetailForm'</span></span> ,<span class="hljs-attr"><span class="hljs-attr">titleIndex</span></span>: <span class="hljs-string"><span class="hljs-string">'text'</span></span> <span class="hljs-comment"><span class="hljs-comment">//  ,          ,buildItems: function() { return [ //      { fieldLabel: 'Comment text', name: 'text', xtype: 'textarea', anchor: '100%', height: 150 }, //        //   { name: 'pid', hidden: true }] } })</span></span></code> </pre><br>  And finally, the client-server model (CommentsModel.js): <br><br><pre> <code class="javascript hljs">Ext.define(<span class="hljs-string"><span class="hljs-string">'Crm.modules.comments.model.CommentsModel'</span></span>, { <span class="hljs-attr"><span class="hljs-attr">extend</span></span>: <span class="hljs-string"><span class="hljs-string">"Core.data.DataModel"</span></span> ,<span class="hljs-attr"><span class="hljs-attr">collection</span></span>: <span class="hljs-string"><span class="hljs-string">'comments'</span></span> <span class="hljs-comment"><span class="hljs-comment">// scope:server ,removeAction: 'remove' // scope:server ,fields: [{ name: '_id', type: 'ObjectID', // scope:server visible: true },{ name: 'pid', type: 'ObjectID', // scope:server visible: true, filterable: true, editable: true },{ name: 'text', type: 'string', // scope:server filterable: true, editable: true, visible: true }] })</span></span></code> </pre><br>  As you can see, in the slave module it is enough to declare the field where the foreign key will be stored.  Next, add a comments tab to the news editing form (static / admin / modules / news / view / NewsForm.js): <br><br><pre> <code class="javascript hljs">Ext.define(<span class="hljs-string"><span class="hljs-string">'Crm.modules.news.view.NewsForm'</span></span>, { <span class="hljs-attr"><span class="hljs-attr">extend</span></span>: <span class="hljs-string"><span class="hljs-string">'Core.form.DetailForm'</span></span> ,<span class="hljs-attr"><span class="hljs-attr">titleIndex</span></span>: <span class="hljs-string"><span class="hljs-string">'name'</span></span> <span class="hljs-comment"><span class="hljs-comment">//  ,          ,layout: 'border' ,border: false ,bodyBorder: false ,height: 450 ,width: 750 //  tabpanel     ,buildItems: function() { return [{ xtype: 'tabpanel', region: 'center', items: [ this.buildMainFormTab(), this.buildCommentsTab() ] }] } //     ,buildMainFormTab: function() { return { xtype: 'panel', title: '', layout: 'border', items: this.buildMainFormTabItems() } } //    ,buildMainFormTabItems: function() { return [{ xtype: 'panel', region: 'north', border: false, bodyBorder: false, layout: 'anchor', bodyStyle: 'padding: 5px;', items: [{ name: 'name', anchor: '100%', xtype: 'textfield', fieldLabel: 'Title' },{ xtype: 'fieldcontainer', layout: 'hbox', anchor: '100%', items: [{ xtype: 'datefield', fieldLabel: 'Date start', name: 'date_start', flex: 1, margin: '0 10 0 0' },{ xtype: 'datefield', fieldLabel: 'Date finish', name: 'date_end', flex: 1 }] },{ xtype: 'textarea', anchor: '100%', height: 60, name: 'stext', emptyText: 'Announce' }] }, this.fullText() ] } ,fullText: function() { return Ext.create('Desktop.modules.pages.view.HtmlEditor', { hideLabel: true, region: 'center', name: 'text' }) } ,buildCommentsTab: function() { return { xtype: 'panel', title: 'Comments', layout: 'fit', // , ,      //    childModule: { //   controller: 'Crm.modules.comments.controller.Comments', //      (_id ) outKey: '_id', //       (pid  ) inKey: 'pid' } } } })</span></span></code> </pre><br>  Thus, it is enough to specify the childModule parameter in one of the panels of the window with the news card. <br><br><h2>  Websocket instead of AJAX </h2><br>  In Janus, I refused to use the usual AJAX to exchange data between the client and the server in favor of web sockets.  This solution allows you to create systems that work in real time.  For example, when creating a news item, it instantly appears in the news lists of other users.  A little surprised that in the standard Extjs bundle (even the latest versions) there was no proxy on the web sockets and had to sweat to get extjs to communicate with the server through them.  In general, the topic of using web sockets in extjs applications is interesting in itself, I think, to write about it separately. <br><br><h2>  Website development </h2><br>  Janusjs can also be used to build regular sites.  For example, let's list our news on a separate page.  First, create a simple html template and place it in the protected / view / index.tpl file <br><br>  Template code: <br><br><pre> <code class="html hljs xml"><span class="hljs-meta"><span class="hljs-meta">&lt;!DOCTYPE HTML&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">head</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">title</span></span></span><span class="hljs-tag">&gt;</span></span>{[values.metatitle? values.metatitle:values.name]}<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">title</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">head</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">tpl</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">if</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"blocks &amp;&amp; blocks[1]"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">tpl</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">for</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"blocks[1]"</span></span></span><span class="hljs-tag">&gt;</span></span>{.}<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">tpl</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">tpl</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><br>  A slightly modified XTemplate from the standard Extjs package (http://docs.sencha.com/extjs/4.2.2/#!/api/Ext.XTemplate) is used as a template engine.  Here I will not consider the issues of how to make navigation, this is a topic for a separate article.  Content is transferred in the block array.  The number of blocks is not limited and they can be located in different places of the template code. <br><br>  Next, create a news module, it will consist of 3 files: a controller and 2 templates.  Let's start with the news list template: <br><br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">tpl</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">for</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"list"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h4</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"/news/{_id}"</span></span></span><span class="hljs-tag">&gt;</span></span>{name}<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">i</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"date"</span></span></span><span class="hljs-tag">&gt;</span></span>: {[Ext.Date.format(new Date(values.date_start),'dmY')]}<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">i</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h4</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span>{stext}<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">tpl</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  Save the file in protected / site / news / view / list.tpl <br><br>  News template: <br><br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h4</span></span></span><span class="hljs-tag">&gt;</span></span> {name} <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">i</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"date"</span></span></span><span class="hljs-tag">&gt;</span></span>: {[Ext.Date.format(new Date(values.date_start),'dmY')]}<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">i</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h4</span></span></span><span class="hljs-tag">&gt;</span></span> {text} <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"./"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  Save the file to protected / site / news / view / one.tpl <br><br>  The controller uses a module model from CRM.  For clarity, we implement the simplest functionality without paging, sorting, etc. <br><br><pre> <code class="javascript hljs">Ext.define(<span class="hljs-string"><span class="hljs-string">'Crm.site.news.controller.News'</span></span>,{ <span class="hljs-attr"><span class="hljs-attr">extend</span></span>: <span class="hljs-string"><span class="hljs-string">"Core.Controller"</span></span> ,<span class="hljs-attr"><span class="hljs-attr">show</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">params, cb</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//   url   ,      if(params.pageData.page) this.showOne(params, cb) else //   ,    this.showList(params, cb) } ,showOne: function(params, cb) { var me = this; Ext.create('Crm.modules.news.model.NewsModel', { scope: me }).getData({ filters: [{property: '_id', value: params.pageData.page}] }, function(data) { me.tplApply('.one', data.list[0] || {}, cb) }); } ,showList: function(params, cb) { var me = this; Ext.create('Crm.modules.news.model.NewsModel', { scope: me }).getData({ filters: [] }, function(data) { me.tplApply('.list', data, cb) }); } });</span></span></code> </pre><br><br>  The controller will save <b>protected / site / news / controller / News.js</b> <br><br>  In Janusjs, you can implement any approach for organizing routing.  It all depends on which path controller is connected to the server.  By default, a controller is connected that implements the following algorithm: <br><ul><li>  Paths of the form &lt;domain.name&gt; /Crm.model.moduleName.methodName/ are reserved for calling public methods of models (this is needed for building, of any kind, API) </li><li>  Paths like &lt;domain.name&gt; / page1 / page2 / are intended for access to the virtual pages of the public site.  The modules for managing virtual pages are located in the admin <b>panel</b> under <b>Start-&gt; Control Panel</b> . </li></ul><br><br>  So, to display the list of news on the public side, you need to create a virtual page and bind to one of the content blocks the public method of the news module controller.  Video how to do it: <br><br><iframe width="420" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/vHgBf3_VOfc%3Ffeature%3Doembed&amp;xid=17259,15700021,15700186,15700190,15700248,15700253&amp;usg=ALkJrhgltReNds-OTCyfQaOKRivQGBMvhQ" frameborder="0" allowfullscreen=""></iframe><br><br>  A page with a list of news will be available at: <br><br> <code><a href="http://localhost/"></a> localhost:8008/news/</code> <br> <br><h2>  Fragmentation and work offline </h2><br>  Consider a typical case.  Suppose we are developing a system for managing a network of small hotels.  Manager when creating a reservation should have access to the number of rooms of all hotels.  At the same time, each hotel should be able to work in isolation in case of connection failure.  In Janus, an experimental approach is implemented that allows you to run separate copies of the server on behalf of individual users.  Such servers contain only the data set that the user has access to on behalf of which the server is running.  Other users in the local network of the hotel can connect to such a server using their own accounts.  In addition, such servers are synchronized in real time with the central server.  In the case of disconnection of the Internet at the hotel, the system continues to work with a local dataset accumulating changes.  When the connection is restored, the data is synchronized with the central server. <br><br><h2>  Conclusion </h2><br>  In conclusion, I will list the points why I needed my own bike.  Needed a system: <br><ul><li>  with the unified program code of the client and server parts; </li><li>  which can be supported by one or more interchangeable specialists; </li><li>  which can work in real time; </li><li>  supporting unlimited number of languages; </li><li>  allows you to quickly create prototypes of projects with a complex user interface; </li><li>  would be completely open. </li></ul><br><br>  PS This article is an overview and many questions remained behind the scenes.  For each of them, you can write a separate article.  Here is a sample list of not disclosed topics: <br><br><ul><li>  Data types, adding custom types, related fields. </li><li>  User interface creation: related modules, non-standard UI elements, work with images and files. </li><li>  <a href="http://habrahabr.ru/post/270369/">Using web sockets, real time system based on Janusjs.</a> </li><li>  Change the appearance of the desktop for different groups of users. </li><li>  The system of distribution of access rights, customization of the set of rights for Janusjs modules. </li><li>  Creation of CMS and sites based on Janusjs. </li><li>  Integration with the search engine Elasticsearch. </li><li>  Additional features: the execution of scripts on a schedule, mail functions. </li><li>  Use of relational databases, use of several DBMS in one project. </li><li>  Multilingual projects. </li><li>  Setting up production server: enable logs, use of all processor cores, load balancing. </li></ul></div><p>Source: <a href="https://habr.com/ru/post/269791/">https://habr.com/ru/post/269791/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../269779/index.html">Creating a game on Blend4Web. The beginnings of intelligence</a></li>
<li><a href="../269783/index.html">DDoS analytics</a></li>
<li><a href="../269785/index.html">Ghost Methods in Ruby (translation)</a></li>
<li><a href="../269787/index.html">How to keep outdated programming language</a></li>
<li><a href="../269789/index.html">Once again about the seven main development methodologies</a></li>
<li><a href="../269793/index.html">DevOps: send metrics and sleep well</a></li>
<li><a href="../269795/index.html">Who is more successful in the market, why users remove applications - and other news of the week for a mobile developer</a></li>
<li><a href="../269797/index.html">November 10-17, we invite you to take part in the action for mobile developers and users - Russian AppFest</a></li>
<li><a href="../269799/index.html">Cloud Cloud Jobs: Odin VDI and IBS</a></li>
<li><a href="../269803/index.html">‚ÄúMany people choose Agile because they can't do anything else‚Äù - an interview with Dmitry Zavalishin from DZ Systems</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>