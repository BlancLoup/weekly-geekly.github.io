<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Office 365. An example of working with the Microsoft Graph API in Angular5 using ADAL JS. ADAL JS vs MSAL JS</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Last time we discussed the authorization mechanism for working with the Office 365 API (in particular with the Microsoft Graph API): 



- each time y...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Office 365. An example of working with the Microsoft Graph API in Angular5 using ADAL JS. ADAL JS vs MSAL JS</h1><div class="post__text post__text-html js-mediator-article">  <a href="https://habrahabr.ru/post/346552/">Last time</a> we discussed the authorization mechanism for working with the Office 365 API (in particular with the Microsoft Graph API): <br><br><ul><li>  each time you call an API, you must pass token.  Token has a limited lifespan </li><li>  token issues a Microsoft service, the so-called ‚ÄúAzure AD Authorization Endpoint‚Äù </li><li>  You can get token without a server using only JavaScript in the browser.  For this, Microsoft made the <a href="https://github.com/AzureAD/azure-activedirectory-library-for-js">ADAL JS</a> JavaScript library, which simplifies communication with the ‚ÄúAzure AD Authorization Endpoint‚Äù to get token. </li></ul><br>  Then we made a simple static HTML page, on which our vanilla JavaScript made a request to the Microsoft Graph API and displayed a list of letters from Office 365. In this note we will develop an example and do the same on Angular5. <br><br><img src="https://habrastorage.org/webt/_8/ii/p7/_8iip7-nohnv1zuecgb8bch6nxg.png" alt="angular5 office 365 adal js">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      We will also talk about the differences between work (school or school account) and personal (personal account) accounts when using the Office 365 API. <br><br>  An example on <a href="https://github.com/AlexeyBoiko/angular5-office365-adal-example">github</a> . <br><a name="habracut"></a><br>  We assume that you are familiar with the <a href="https://habrahabr.ru/post/346552/">previous article</a> , understand the process of obtaining and using token, have already registered the application in Azure, received the Application ID. <br><br><h2>  ADAL JS and MSAL JS </h2><br>  Microsoft has two types of accounts: <br>  - Work or school Account <br>  - Personal Account <br><br>  The work or school account is created (and deleted) by the administrator of the company that purchased the Office 365 subscription. Employees use it, for example, to connect to corporate email, SharePoint, OneDrive. <br><br>  Personal account you create yourself, is used to connect to personal services, such as personal OneDrive. <br><blockquote>  In more detail about Work and Personal accounts you can read here ‚Äú <a href="http://www.brucebnews.com/2016/06/finding-your-way-through-microsofts-maze-of-work-and-personal-accounts/">Understanding Microsoft Work And Personal Accounts</a> ‚Äù. </blockquote>  Office 365 API (for example, Microsoft Graph API) has different support for personal and work accounts.  For example, both the Work account and Personal account can work with mail, but there is no personal SharePoint (and hence the SharePoint API for the Personal account). <br><br>  We already know that the token for API calls is issued by ‚ÄúAzure AD Authorization Endpoint‚Äù.  Authorization points exist 2: <br><br><ul><li>  <b>Authorization endpoint</b> <br>  Issues tokens only for Work Account. <br>  Upon login, the user is sent to <br>  https: //login.microsoftonline.com/common/oauth2/authorize?client_id = ... <br></li><li>  <b>Authorization Endpoint v2.0</b> <br>  Issues tokens for both Work and Personal Account. <br>  Upon login, the user is sent to <br>  https: //login.microsoftonline.com/common/oauth2/v2.0/authorize? <br>  client_id = ... <br></li></ul><br>  Why then do I need an ‚ÄúAuthorization Endpoint‚Äù at all?  The peculiarity is that ‚ÄúAuthorization Endpoint v2.0‚Äù will issue a token only for those API features that exist for both Work and Personal accounts.  Those.  using Endpoint v2.0 and Work account you will be able to access mail, but there will be no access to the SharePoint API (for details on which APIs support Endpoint v2.0, see the links at the end). <br><br>  Currently, v2.0 endpoint does not work with applications that are registered in the corporate Azure portal (such registration we did in the last note), you need to use a separate <a href="https://apps.dev.microsoft.com/">Microsoft Application Registration Portal</a> . <br><br>  Microsoft promises to expand the capabilities of v2.0 endpoint in the future, and provide support for applications registered in the corporate Azure portal - v2.0 endpoint will be able to issue tokens for them.  In the meantime, for corporate applications, Microsoft recommends using ‚ÄúAuthorization Endpoint‚Äù: <br><blockquote>  If you use the v2.0 endpoint </blockquote>  ADAL JS works with ‚ÄúAuthorization Endpoint‚Äù, MSAL JS with v2.0 endpoint.  In this article we will use Authorization Endpoint of the first version and accordingly ADAL JS. <br><br><h2>  Angular 5 and ADAL JS </h2><br>  We will need the installed Node.js, npm, and <a href="https://github.com/angular/angular-cli">Angular CLI</a> - a utility that helps create and build Angular projects.  The whole process is well described in <a href="https://angular.io/guide/quickstart">Angular QuickStart</a> . <br><br>  Let's make a new project: <br><br><pre><code class="hljs cs">ng <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> angular5-office365-adal-example</code> </pre> <br>  There are no official (from Microsoft) TypeScript d.ts descriptions for Adal.js.  Several options for using Adal.js in Angular 5: <br><br><ol><li>  Do not use d.ts descriptions, declare the AuthenticationContext object (from Adal.js) as a global any and write untyped code as in regular JavaScript </li><li>  Most do d.ts description </li><li>  Take advantage of the <a href="https://www.npmjs.com/package/adal-angular5">adal-angular5 project</a> , which is a tracing copy of the original adal-angular.js for AngularJS from Microsoft ( <a href="https://github.com/AzureAD/azure-activedirectory-library-for-js">Adal js</a> ) </li><li>  There are projects in which Adal js is completely rewritten to TypeScript ( <a href="https://www.npmjs.com/package/adal-ts">adal-ts</a> , <a href="https://www.npmjs.com/package/adal-typescript">adal-typescript</a> ) </li><li>  Use ready-made d.ts description. </li></ol><br>  5 option looks the most simple and convenient: using the original Adal.js from Microsoft and using d.ts descriptions add intellisense and checks during assembly. <br><br>  Install verified d.ts descriptions for <a href="https://www.npmjs.com/package/%40types/adal">Adal.js.</a>  Being in the project folder: <br><br><pre> <code class="hljs sql">npm <span class="hljs-keyword"><span class="hljs-keyword">install</span></span> <span class="hljs-comment"><span class="hljs-comment">--save @types/adal</span></span></code> </pre> <br>  We have a test case, so let's make it as simple as possible: we will connect to the Microsoft Graph API directly in the AppComponent. <br><br>  In the app.component.ts file, import HttpClient and adal <br><br><pre> <code class="hljs javascript"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { HttpClient, HttpHeaders } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'@angular/common/http'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'adal'</span></span>; <span class="hljs-comment"><span class="hljs-comment">//     ,     </span></span></code> </pre> <br>  In app.module.ts we will connect HttpClientModule <br><br><pre> <code class="hljs coffeescript"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { BrowserModule } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'@angular/platform-browser'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { NgModule } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'@angular/core'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { HttpClientModule } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'@angular/common/http'</span></span>; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>&lt;- ADD <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { AppComponent } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./app.component'</span></span>; @NgModule({ declarations: [ AppComponent ], imports: [ BrowserModule, HttpClientModule <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>&lt;- ADD ], providers: [], bootstrap: [AppComponent] }) <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AppModule</span></span></span><span class="hljs-class"> { }</span></span></code> </pre> <br>  Let's connect js-library to the page <br><br><img src="https://habrastorage.org/webt/tp/f6/x-/tpf6x-vd3b6hqj1ptadgsmhbfhm.png" alt="adal js link"><br><br>  Next will be exactly the same code as in the previous example in JS. <br><br>  In ngOnInit we will check whether the user is authorized or not, if not authorized or token is rotten, we will send the user to the registration page. <br><br><pre> <code class="hljs pgsql">let config: adal.Config = { tenant: <span class="hljs-string"><span class="hljs-string">'igtit.onmicrosoft.com'</span></span>, clientId: <span class="hljs-string"><span class="hljs-string">'21XXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX'</span></span>, postLogoutRedirectUri: <span class="hljs-keyword"><span class="hljs-keyword">window</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">location</span></span>.origin, endpoints: { graphApiUri: "https://graph.microsoft.com", }, cacheLocation: "localStorage", redirectUri: <span class="hljs-string"><span class="hljs-string">''</span></span> }; let authContext = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> AuthenticationContext(config); let isCallback = authContext.isCallback(<span class="hljs-keyword"><span class="hljs-keyword">window</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">location</span></span>.hash); authContext.handleWindowCallback(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (isCallback &amp;&amp; !authContext.getLoginError()) { <span class="hljs-keyword"><span class="hljs-keyword">window</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">location</span></span>.href = (&lt;<span class="hljs-keyword"><span class="hljs-keyword">any</span></span>&gt;authContext)._getItem((&lt;<span class="hljs-keyword"><span class="hljs-keyword">any</span></span>&gt;authContext).CONSTANTS.<span class="hljs-keyword"><span class="hljs-keyword">STORAGE</span></span>.LOGIN_REQUEST); } // <span class="hljs-keyword"><span class="hljs-keyword">check</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">user</span></span> need <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">login</span></span> let <span class="hljs-keyword"><span class="hljs-keyword">user</span></span> = authContext.getCachedUser(); let token = authContext.getCachedToken(config.clientId); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">user</span></span> || !token) { authContext.<span class="hljs-keyword"><span class="hljs-keyword">login</span></span>(); }</code> </pre> <br>  Now you can use token to call Microsoft Graph API <br><br><pre> <code class="hljs pgsql">authContext.acquireToken(config.endpoints.graphApiUri, (error, token) =&gt; { // <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> Microsoft Graph API <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> token let url = config.endpoints.graphApiUri + "/v1.0/me/messages"; this.http.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(url, { headers: { "Authorization": "Bearer " + token } }).subscribe(mgs =&gt; this.messages = (&lt;<span class="hljs-keyword"><span class="hljs-keyword">any</span></span>&gt;mgs).<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>); });</code> </pre> <br>  Full <a href="https://github.com/AlexeyBoiko/angular5-office365-adal-example">GitHub</a> example. <br><br><h2>  Links </h2><br>  <a href="https://github.com/AzureAD/azure-activedirectory-library-for-js">Active Directory Authentication Library (ADAL) for JavaScript</a> <br>  <a href="https://github.com/AzureAD/microsoft-authentication-library-for-js">Microsoft Authentication Library Preview for JavaScript (MSAL.js)</a> <br>  <a href="https://docs.microsoft.com/en-us/azure/active-directory/develop/active-directory-v2-limitations">Should I use the v2.0 endpoint?</a> <br>  <a href="https://docs.microsoft.com/en-us/azure/active-directory/develop/active-directory-v2-compare">What's different about the v2.0 endpoint?</a> <br>  <a href="http://www.brucebnews.com/2016/06/finding-your-way-through-microsofts-maze-of-work-and-personal-accounts/">Understanding Microsoft Work And Personal Accounts</a> </div><p>Source: <a href="https://habr.com/ru/post/348106/">https://habr.com/ru/post/348106/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../348094/index.html">Cisco ASA Firewall Critical Vulnerability Allows Remote Code Execution</a></li>
<li><a href="../348096/index.html">Orgi among programmers</a></li>
<li><a href="../348098/index.html">Why is it important to check that the malloc function returned</a></li>
<li><a href="../348100/index.html">Indian programmers, cookies from England and the Caucasus: the history of technical support department</a></li>
<li><a href="../348102/index.html">Object Recognition with PowerAI Vision</a></li>
<li><a href="../348108/index.html">How to destroy the Internet?</a></li>
<li><a href="../348110/index.html">Visualization of data for moviegoers: scrap movie recommendations and make interactive graph</a></li>
<li><a href="../348112/index.html">Wolfram Language (Mathematica) Virtual Textbook, 5th Edition</a></li>
<li><a href="../348116/index.html">‚ÄúProgrammer pragmatist. The journey from the apprentice to the master ": briefly about the main thing (part one)</a></li>
<li><a href="../348118/index.html">Expanding Ansible functionality with modules</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>