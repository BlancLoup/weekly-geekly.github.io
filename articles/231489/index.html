<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Bitcoin check</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Nothing epic in this article will be. We have checked Bitcoin source code with PVS-Studio. Found only a couple of suspicious places. No wonder. I thin...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Bitcoin check</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/377/c24/1ac/377c241acf84e067639c95163c2afd46.png" alt="Bitcoin, PVS-Studio" align="right" height="200"><br>  Nothing epic in this article will be.  We have checked Bitcoin source code with PVS-Studio.  Found only a couple of suspicious places.  No wonder.  I think these source codes are not checked only lazy.  But once checked, I decided to write a small note.  So to say, "for show". <br><a name="habracut"></a><br>  It all started with the fact that we thought about comparing PVS-Studio and Clang on open source projects.  The task is big, difficult and I think we will not do it soon.  The difficulty is in the following points: <br><ol><li>  We need to find projects that are built with the help of GCC, but you can build them with Clang.  If we check projects that are already focused on Clang, it will not be fair.  Clang will naturally find nothing in them, since the errors have already been corrected.  And PVS-Studio will find it. </li><li>  The PVS-Studio analyzer has to play in a foreign field called ‚ÄúLinux‚Äù.  There are almost no projects that can be simultaneously built using Clang and Visual Studio.  Theoretically, it says that Clang is already well compatible with Visual Studio.  In practice, this is not true.  Unable to collect and verify many projects.  PVS-Studio, in turn, badly checks projects in Linux.  As a result, one has to choose projects with which both tools can work equally well. </li></ol><br>  One of the projects selected for comparison was Bitcoin.  Both analyzers found almost nothing in it.  No wonder.  I think this project has already been tested with many tools.  Accordingly, this project, most likely, will not be included in the comparison.  Therefore, let it remain at least this brief note. <br><br><h2>  Project analysis </h2><br>  Describe what <a href="http://www.viva64.com/go.php%3Furl%3D1410">Bitcoin is</a> not needed.  Source codes are taken using: <br><br>  git clone <a href="">https://github.com/bitcoin/bitcoin.git</a> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The analysis was performed using <a href="http://www.viva64.com/ru/pvs-studio/">PVS-Studio</a> version 5.17. <br><br><h3>  Strange cycle </h3><br>  There was only one place interesting in my opinion.  This is a function related to cryptography.  What she does I do not know.  Perhaps I found an EPIC FAIL.  Now it is fashionable to find epic errors related to security.  However, most likely, this is a minor mistake or even completely, and it was conceived. <br><pre><code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> CCryptoKeyStore::Unlock(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> CKeyingMaterial&amp; vMasterKeyIn) { { LOCK(cs_KeyStore); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!SetCrypted()) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; CryptedKeyMap::const_iterator mi = mapCryptedKeys.begin(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (; mi != mapCryptedKeys.end(); ++mi) { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> CPubKey &amp;vchPubKey = (*mi).second.first; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">vector</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>&gt; &amp;vchCryptedSecret = (*mi).second.second; CKeyingMaterial vchSecret; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!DecryptSecret(vMasterKeyIn, vchCryptedSecret, vchPubKey.GetHash(), vchSecret)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (vchSecret.size() != <span class="hljs-number"><span class="hljs-number">32</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; CKey key; key.Set(vchSecret.begin(), vchSecret.end(), vchPubKey.IsCompressed()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (key.GetPubKey() == vchPubKey) <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } vMasterKey = vMasterKeyIn; } NotifyStatusChanged(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; }</code> </pre> <br>  PVS-Studio warning: V612 An unconditional 'return' within a loop.  crypter.cpp 169 <br><br>  Pay attention to the cycle.  Some keys must be moved in it.  But the loop body is executed only once.  At the end of the loop is the operator "return false;".  The cycle can also be interrupted prematurely with the help of ‚Äúbreak;‚Äù operators.  At the same time, there is no ‚Äúcontinue;‚Äù operator in the loop body. <br><br><h3>  Suspicious shift </h3><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> int64_t </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">set_vch</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">std</span></span></span></span><span class="hljs-function"><span class="hljs-params">::</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">vector</span></span></span></span><span class="hljs-function"><span class="hljs-params">&lt;</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">unsigned</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params">&gt;&amp; vch)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (vch.empty()) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int64_t</span></span> result = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i != vch.size(); ++i) result |= <span class="hljs-keyword"><span class="hljs-keyword">static_cast</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">int64_t</span></span>&gt;(vch[i]) &lt;&lt; <span class="hljs-number"><span class="hljs-number">8</span></span>*i; <span class="hljs-comment"><span class="hljs-comment">// If the input vector's most significant byte is 0x80, // remove it from the result's msb and return a negative. if (vch.back() &amp; 0x80) return -(result &amp; ~(0x80 &lt;&lt; (8 * (vch.size() - 1)))); return result; }</span></span></code> </pre> <br>  PVS-Studio warning: V629 Consider inspecting the '0x80 &lt;&lt; (8 * (vch.size () - 1))' expression.  Bit shifting of the 32-bit type.  script.h 169 <br><br>  The function generates a 64-bit value.  One shift is done correctly, and the second is probably not. <br><br>  Right: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">static_cast</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">int64_t</span></span>&gt;(vch[i]) &lt;&lt; <span class="hljs-number"><span class="hljs-number">8</span></span>*i</code> </pre> <br>  At the beginning, the variable expands to int64_t and only then a shift occurs. <br><br>  Suspiciously: <br><pre> <code class="cpp hljs"><span class="hljs-number"><span class="hljs-number">0x80</span></span> &lt;&lt; (<span class="hljs-number"><span class="hljs-number">8</span></span> * (vch.size() - <span class="hljs-number"><span class="hljs-number">1</span></span>))</code> </pre> <br>  The constant 0x80 is of type 'int'.  This means that an overflow may occur during shear.  Since the function generates a 64-bit value, I suspect an error.  I wrote more about the shifts in the article " <a href="http://www.viva64.com/ru/b/0142/">Without knowing the ford, do not climb into the water - part three</a> ." <br><br>  Safe option: <br><pre> <code class="cpp hljs"><span class="hljs-number"><span class="hljs-number">0x80</span></span>ull &lt;&lt; (<span class="hljs-number"><span class="hljs-number">8</span></span> * (vch.size() - <span class="hljs-number"><span class="hljs-number">1</span></span>))</code> </pre> <br><h3>  Dangerous classes </h3><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CKey</span></span></span><span class="hljs-class"> {</span></span> .... <span class="hljs-comment"><span class="hljs-comment">// Copy constructor. This is necessary because of memlocking. CKey(const CKey &amp;secret) : fValid(secret.fValid), fCompressed(secret.fCompressed) { LockObject(vch); memcpy(vch, secret.vch, sizeof(vch)); } .... };</span></span></code> </pre> <br>  PVS-Studio warning: V690 The 'CKey' class implements a copy constructor, but lacks the '=' operator.  It is dangerous to use such a class.  key.h 175 <br><br>  As follows from the text of the comment, the copy constructor is needed for synchronization.  However, you can copy an object not only using the copy constructor, but also using operator =.  And this operator is not implemented.  Even if operator = now is not used anywhere, it is still potentially dangerous. <br><br>  Similarly, you should pay attention to several other classes: <ul><li>  V690 The 'Semantic_actions' class implements the '=' operator, but there is no copy constructor.  It is dangerous to use such a class.  json_spirit_reader_template.h 196 </li><li>  V690 The 'CFeeRate' class implements a copy constructor, but lacks the '=' operator.  It is dangerous to use such a class.  core.h 118 </li><li>  V690 The 'CTransaction' class implements the '=' operator, but there is no copy constructor.  It is dangerous to use such a class.  core.h 212 </li><li>  V690 The 'CTxMemPoolEntry' class implements a copy constructor  It is dangerous to use such a class.  txmempool.h 27 </li><li>  V690 The 'Json_grammer' class implements the '=' operator, but there is no copy constructor.  It is dangerous to use such a class.  json_spirit_reader_template.h 370 </li><li>  V690 The 'Generator' class implements the '=' operator, but there is no copy constructor.  It is dangerous to use such a class.  json_spirit_writer_template.h 98 </li></ul><br><h2>  Conclusion </h2><br>  Regular use of static analyzers can save a lot of time and nerve cells.  The main thing is that it is convenient.  For example, try incremental analysis in PVS-Studio.  Just write the code and if anything, you will be stopped.  You quickly get used to the <a href="http://www.viva64.com/ru/b/0222/">good</a> . <br><br><h2>  This article is in English. </h2><br>  If you want to share this article with an English-speaking audience, then please use the link to the translation: Andrey Karpov.  <a href="http://www.viva64.com/en/b/0268/">http://www.viva64.com/en/b/0268/</a> . <br><br><div class="spoiler">  <b class="spoiler_title">Read the article and have a question?</b> <div class="spoiler_text">  Often our articles are asked the same questions.  We collected the answers to them here: <a href="http://www.viva64.com/ru/a/0085/">Answers to questions from readers of articles about PVS-Studio and CppCat, version 2014</a> .  Please review the list. <br></div></div></div><p>Source: <a href="https://habr.com/ru/post/231489/">https://habr.com/ru/post/231489/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../231477/index.html">Philips VISIQ: portable ultrasound scanner tablet</a></li>
<li><a href="../231481/index.html">According to NASA, Opportunity became the record for the mileage among all extraterrestrial spacecraft.</a></li>
<li><a href="../231483/index.html">Exchange mailbox audit. Part 1</a></li>
<li><a href="../231485/index.html">The director of the film Suzy Q asked to post his picture on The Pirate Bay</a></li>
<li><a href="../231487/index.html">SPM Conf-4: complex is available</a></li>
<li><a href="../231491/index.html">Protecting the L2 network with switches</a></li>
<li><a href="../231493/index.html">Nokia X, X + and XL received an update</a></li>
<li><a href="../231495/index.html">Open Yandex PHP Library to work with the Yandex API</a></li>
<li><a href="../231497/index.html">OpenVZ + venet + vlan / addresses from different networks</a></li>
<li><a href="../231499/index.html">How to make a phone holder with your own hands</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>