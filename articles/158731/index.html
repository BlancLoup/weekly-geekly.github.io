<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>PostgreSQL - Asynchronous Replication + Pooling + Failover</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The easy-to-understand option for asynchronous master-slave replication based on Postgresql 9.1 

 For the first time, the challenge was to single-han...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>PostgreSQL - Asynchronous Replication + Pooling + Failover</h1><div class="post__text post__text-html js-mediator-article"><h5>  The easy-to-understand option for asynchronous master-slave replication based on Postgresql 9.1 </h5><br><br>  For the first time, the challenge was to single-handedly implement full-fledged replication and for the first time a mini-manual was written, which I want to present here. <br><br>  For the Master Slave replication system, a combination was used. <br><ul><li>  PostgreSQL 9.1 (DB) + </li><li>  Bucardo 4.5 (replicator) + </li><li>  PgPool-II (puller and filer) </li></ul><br><a name="habracut"></a><br><h6>  <b>Bucardo</b> </h6><br>  Asynchronous Postgres replication system written in Perl5. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Convenient built-in postgres and easy, reflected in the database, setting. <br><br>  Creates its own database, in which replicated servers, databases, tables, enclosed in sheets (lists) are written. <br>  The communication type is Pushdelta (Trigger. One way master-slave). <br>  Change of structure does not support.  Works both ways, i.e.  in the case of a temporary shutdown of the master, when it is restored, it will automatically ‚Äúcatch up‚Äù with the slave. <br><br>  A rough plan for installing bucardo on the Wizard: <br><br><pre><code class="bash hljs">sudo aptitude install bucardo <span class="hljs-comment"><span class="hljs-comment"># + install Perl mods (DBI, DBD::Pg, DBIx::Safe) sudo bucardo_ctl install # connection settings</span></span></code> </pre> <br><br>  Next, manually create the management database bucardo, fill it with bucardo.schema (by default it is attached to 8.4 and in older versions there is a misfire with auto-creation of the management database) <br><br><pre> <code class="bash hljs"> sudo bucardo_ctl add db bucardo_dbname name=master_dbname <span class="hljs-comment"><span class="hljs-comment">#  - # +      bucardo.db (   ) sudo bucardo_ctl add db bucardo_dbname name=slave_dbname #  - sudo bucardo_ctl add table tbl_name db=bucardo_dbname herd=source_name #     (herd) sudo bucardo_ctl add sync sync_name type=pushdelta source=herd_name targetdb=slave_dbname #     sudo bucardo_ctl start #  </span></span></code> </pre><br><br>  I installed it on the slave, but did not fill it (since the slave was alone and there was no place to go from it anyway) <br><br><h6>  <b>PgPool-II</b> </h6><br>  It has ample opportunities, suffers from a lack of manuals.  It supports parallel queries, load balancing, distribution of connections to the database by pools, as well as FailOver, i.e.  automatic switch from master to slave and back in cases of problems with connections. <br><br>  On debian it is placed from the repository, it does not depend on the postgres version. <br><pre> <code class="bash hljs"> sudo aptitude install pgpool2</code> </pre><br><br>  Configs stored in / etc / pgpool2 / <br><br><ul><li>  pgpool.conf - Basic settings (about them below) </li><li>  pcp.conf - System - you can not touch </li><li>  pool_hba.conf - Configure connection access.  You can use your own, you can - postgresovy.  Better postgresovy </li></ul><br>  I used PgPool as a puller, load balancer and, most importantly, a filer. <br><br>  An example of setting /etc/pgpool2/pgpool.conf (partially) For the Wizard: <br><pre> <code class="bash hljs"> listen_addresses = <span class="hljs-string"><span class="hljs-string">'*'</span></span> port = 9999 socket_dir = <span class="hljs-string"><span class="hljs-string">'/var/run/postgresql'</span></span> pcp_port = 9898 pcp_socket_dir = <span class="hljs-string"><span class="hljs-string">'/var/run/postgresql'</span></span> backend_hostname0 = master_server backend_port0 = 5432 backend_weight0 = 1 backend_data_directory0 = <span class="hljs-string"><span class="hljs-string">'/master_data'</span></span> backend_flag0 = <span class="hljs-string"><span class="hljs-string">'ALLOW_TO_FAILOVER'</span></span> backend_hostname1 = slave_server backend_port1 = 5432 backend_weight1 = 1 backend_data_directory1 = <span class="hljs-string"><span class="hljs-string">'/slave_data'</span></span> backend_flag1 = <span class="hljs-string"><span class="hljs-string">'ALLOW_TO_FAILOVER'</span></span> connection_cache = on replication_mode = off load_balance_mode = on master_slave_mode = on master_slave_sub_mode = <span class="hljs-string"><span class="hljs-string">'stream'</span></span> parallel_mode = on pgpool2_hostname = <span class="hljs-string"><span class="hljs-string">''</span></span> system_db_hostname = master_server system_db_port = 5432 system_db_dbname = <span class="hljs-string"><span class="hljs-string">'pgpool'</span></span> system_db_schema = <span class="hljs-string"><span class="hljs-string">'pgpool_catalog'</span></span> system_db_user = <span class="hljs-string"><span class="hljs-string">'pgpool'</span></span> system_db_password = <span class="hljs-string"><span class="hljs-string">''</span></span> failover_command = <span class="hljs-string"><span class="hljs-string">'/etc/pgpool2/failover.sh %d %P %H %R'</span></span> recovery_user = <span class="hljs-string"><span class="hljs-string">'postgres'</span></span> recovery_password = <span class="hljs-string"><span class="hljs-string">''</span></span> recovery_1st_stage_command = <span class="hljs-string"><span class="hljs-string">'/etc/pgpool2/recovery_1st_stage.sh'</span></span> recovery_2nd_stage_command = <span class="hljs-string"><span class="hljs-string">''</span></span> recovery_timeout = 90 client_idle_limit_in_recovery = 0</code> </pre><br><br>  Also in / etc / pgpool2 /, the following scripts are created that are specified in the config file: <br><br>  '' failover.sh '' - Actually a script that executes if the wizard crashes <br><pre> <code class="bash hljs"> <span class="hljs-comment"><span class="hljs-comment">#!/bin/bash -x FALLING_NODE=$1 # %d OLDPRIMARY_NODE=$2 # %P NEW_PRIMARY=$3 # %H PGDATA=$4 # %R if [ $FALLING_NODE = $OLDPRIMARY_NODE ]; then if [ $UID -eq 0 ] then su postgres -c "ssh -T postgres@$NEW_PRIMARY touch $PGDATA/trigger" else ssh -T postgres@$NEW_PRIMARY touch $PGDATA/trigger fi exit 0; fi; exit 0;</span></span></code> </pre><br>  '' recovery_1st_stage.sh '' - Script with a talking name <br><pre> <code class="bash hljs"> <span class="hljs-comment"><span class="hljs-comment">#!/bin/bash -x PGDATA=$1 REMOTE_HOST=$2 REMOTE_PGDATA=$3 PORT=5432 PGHOME=/home/yugo-n/pgsql-9.2.1 ARCH=$PGHOME/data/arch rm -rf $ARCH/* ssh -T postgres@$REMOTE_HOST " LD_LIBRARY_PATH=$PGHOME/lib:LD_LIBRARH_PATH; rm -rf $REMOTE_PGDATA $PGHOME/bin/pg_basebackup -h $HOSTNAME -U r_user -D $REMOTE_PGDATA -x -c fast rm $REMOTE_PGDATA/trigger" ssh -T postgres@$REMOTE_HOST "rm -rf $ARCH/*" ssh -T postgres@$REMOTE_HOST "mkdir -p $REMOTE_PGDATA/pg_xlog/archive_status" ssh -T postgres@$REMOTE_HOST " cd $REMOTE_PGDATA; cp postgresql.conf postgresql.conf.bak; sed -e 's/#*hot_standby = off/hot_standby = on/' postgresql.conf.bak &gt; postgresql.conf; rm -f postgresql.conf.bak; cat &gt; recovery.conf &lt;&lt; EOT standby_mode = 'on' primary_conninfo = 'host="$HOSTNAME" port=$PORT user=r_user' restore_command = 'scp $HOSTNAME:$ARCH/%f %p' trigger_file = '$PGDATA/trigger' EOT "</span></span></code> </pre><br><br>  <b>An important point!</b>  It is necessary that all files / folders used by pgpool are with owner postgres :: postgres <br><br>  For Slave, everything is almost the same, only with master_slave_mode = off and failover_command = '' <br><br>  PgPool is launched by the simplest console <br><pre> <code class="bash hljs">sudo pgpool</code> </pre><br><br>  Thus, we obtain a master-mono-slave replication with load sharing and a filer. <br><br>  Connection always goes only to the master via the pgPool port (here - 9999). <br>  In normal operation, the master is written, the back-end is replicated to the slave, and the reading is done from that and the other. <br>  In case of shutdown of the slave, when it resumes its operation, all the data of the idle time will be automatically replicated. <br>  If the wizard is disabled, without breaking the user connection, pgpool redirects read and write completely to the replica, temporarily making it a ‚Äúmaster‚Äù.  When the master is picked up, he catches up with all the data from the slave and the reverse switching occurs, again without breaking the user connection. <br><br>  There is a certain problem in the fact that it was not possible to create rights management in some way, so that with a live master the slave would only have RO rights, and when it fell it would switch to RW (and then restore it again), but since the external call goes only to address of the Master, the danger remains only in the playful hands of developers. <br><br>  Hopefully, the article will be used by beginners in DBA. <br>  And thank you all for your attention! </div><p>Source: <a href="https://habr.com/ru/post/158731/">https://habr.com/ru/post/158731/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../158713/index.html">Programmer's letter to designers (in the process of preparing a new Winx project ...)</a></li>
<li><a href="../158717/index.html">TV online</a></li>
<li><a href="../158719/index.html">Number Recognition Systems in Practice</a></li>
<li><a href="../158725/index.html">Accelerate VBA work in Excel</a></li>
<li><a href="../158729/index.html">Building neural networks in php using FANN, an example implementation</a></li>
<li><a href="../158733/index.html">Q & A with Alexander Guest</a></li>
<li><a href="../158737/index.html">Last Ya.Subbotnik Year: St. Petersburg</a></li>
<li><a href="../158741/index.html">Found the remains of a pigeon with a cryptogram of World War II</a></li>
<li><a href="../158743/index.html">How to port libcURL to Android</a></li>
<li><a href="../158745/index.html">10 years of Xbox Live</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>