<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Examples of using MongoDB in e-commerce (part 2)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="[ First part ] 

 This post will be something that does not fit in the first part. These are some operators that are in the aggregation framework and ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Examples of using MongoDB in e-commerce (part 2)</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/e36/58a/ca6/e3658aca69ab496895f5bc53c7357632.jpeg"><br><br>  [ <a href="http://habrahabr.ru/post/259219/">First part</a> ] <br><br>  This post will be something that does not fit in the first part.  These are some operators that are in the <code>aggregation framework</code> and a rather loose translation of three articles from the <a href="http://docs.mongodb.org/ecosystem/">ecosystem</a> section of the site with help to <code>MongoDB</code> , describing some use cases for Internet commerce. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The use cases are divided there into eight articles, which can be divided into three groups.  It seemed to me the most interesting for translation are three materials related to <code>e-commerce</code> . <br><br><ol><li>  <a href="https://habr.com/ru/post/260291/">Operators in the aggregation framework</a> </li><li>  <a href="https://habr.com/ru/post/260291/">Product Catalog</a> </li><li>  <a href="https://habr.com/ru/post/260291/">Cart and stock management</a> </li><li>  <a href="https://habr.com/ru/post/260291/">Category Hierarchy</a> </li></ol><br><a name="habracut"></a><br><br><h3><a name="1"></a>  <font color="green">Operators in the aggregation framework</font> </h3><br>  As a rule, in the <code>aggregation framework</code> there are basic operators, such as <code>$project</code> or <code>$group</code> from which the <code>pipeline</code> chains are formed. <br>  But there are also such operators as <code>$cond</code> , which are always located inside the main operators. <br>  <em><font color="blue">$ cond</font> <font color="#008B8B">approximate analogue of the usual if</font></em> <br>  It appeared from version <code>2.6</code> and it has two forms of writing: <br><pre> <code class="python hljs">{ $cond: { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>: &lt;boolean-expression&gt;, then: &lt;true-case&gt;, <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: &lt;false-case-&gt; } }  { $cond: [ &lt;boolean-expression&gt;, &lt;true-case&gt;, &lt;false-case&gt; ] }</code> </pre><br>  An example is the following documents: <br><pre> <code class="python hljs">{ <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"item"</span></span> : <span class="hljs-string"><span class="hljs-string">"abc1"</span></span>, qty: <span class="hljs-number"><span class="hljs-number">300</span></span> } { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-string"><span class="hljs-string">"item"</span></span> : <span class="hljs-string"><span class="hljs-string">"abc2"</span></span>, qty: <span class="hljs-number"><span class="hljs-number">200</span></span> } { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-string"><span class="hljs-string">"item"</span></span> : <span class="hljs-string"><span class="hljs-string">"xyz1"</span></span>, qty: <span class="hljs-number"><span class="hljs-number">250</span></span> }</code> </pre><br>  Set <code>discount</code> to <code>30</code> if the <code>qty</code> field is greater than or equal to <code>250</code> , otherwise the <code>discount</code> will be equal to <code>20</code> <br><pre> <code class="python hljs">db.test.aggregate( [ { $project:{ item: <span class="hljs-number"><span class="hljs-number">1</span></span>, discount: { $cond: { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>: { $gte: [ <span class="hljs-string"><span class="hljs-string">"$qty"</span></span>, <span class="hljs-number"><span class="hljs-number">250</span></span> ] }, then: <span class="hljs-number"><span class="hljs-number">30</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: <span class="hljs-number"><span class="hljs-number">20</span></span> } } } } ] )</code> </pre><br>  The result: <br><pre> <code class="python hljs">{ <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"item"</span></span> : <span class="hljs-string"><span class="hljs-string">"abc1"</span></span>, <span class="hljs-string"><span class="hljs-string">"discount"</span></span> : <span class="hljs-number"><span class="hljs-number">30</span></span> } { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-string"><span class="hljs-string">"item"</span></span> : <span class="hljs-string"><span class="hljs-string">"abc2"</span></span>, <span class="hljs-string"><span class="hljs-string">"discount"</span></span> : <span class="hljs-number"><span class="hljs-number">20</span></span> } { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-string"><span class="hljs-string">"item"</span></span> : <span class="hljs-string"><span class="hljs-string">"xyz1"</span></span>, <span class="hljs-string"><span class="hljs-string">"discount"</span></span> : <span class="hljs-number"><span class="hljs-number">30</span></span> }</code> </pre><br><br>  <em><font color="blue">$ ifNull</font> <font color="#008B8B">checks that the field exists and is not null</font></em> <br><br>  If there is no field, it replaces it with the desired value <br><pre> <code class="python hljs">{ <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"item"</span></span> : <span class="hljs-string"><span class="hljs-string">"abc1"</span></span>, description: <span class="hljs-string"><span class="hljs-string">"product 1"</span></span>, qty: <span class="hljs-number"><span class="hljs-number">300</span></span> } { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-string"><span class="hljs-string">"item"</span></span> : <span class="hljs-string"><span class="hljs-string">"abc2"</span></span>, description: null, qty: <span class="hljs-number"><span class="hljs-number">200</span></span> } { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-string"><span class="hljs-string">"item"</span></span> : <span class="hljs-string"><span class="hljs-string">"xyz1"</span></span>, qty: <span class="hljs-number"><span class="hljs-number">250</span></span> }</code> </pre>  Returns <code>Unspecified</code> if the <code>description</code> field does not exist or is <code>null</code> . <br><pre> <code class="python hljs">db.test.aggregate( [ { $project: { item: <span class="hljs-number"><span class="hljs-number">1</span></span>, description: { $ifNull: [ <span class="hljs-string"><span class="hljs-string">"$description"</span></span>, <span class="hljs-string"><span class="hljs-string">"Unspecified"</span></span> ]}} } ] )</code> </pre>  Result: <br><pre> <code class="python hljs">{ <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"item"</span></span> : <span class="hljs-string"><span class="hljs-string">"abc1"</span></span>, <span class="hljs-string"><span class="hljs-string">"description"</span></span> : <span class="hljs-string"><span class="hljs-string">"product 1"</span></span> } { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-string"><span class="hljs-string">"item"</span></span> : <span class="hljs-string"><span class="hljs-string">"abc2"</span></span>, <span class="hljs-string"><span class="hljs-string">"description"</span></span> : <span class="hljs-string"><span class="hljs-string">"Unspecified"</span></span> } { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-string"><span class="hljs-string">"item"</span></span> : <span class="hljs-string"><span class="hljs-string">"xyz1"</span></span>, <span class="hljs-string"><span class="hljs-string">"description"</span></span> : <span class="hljs-string"><span class="hljs-string">"Unspecified"</span></span> }</code> </pre><br>  <em><font color="blue">$ let</font> <font color="#008B8B">creates variables</font></em> <br><br>  The <code>$let</code> operator can create variables and then perform some operations with them. <br>  In the example, we create two variables, <code>total</code> assign the value of the sum of two <code>price, tax</code> fields.  And variable <code>discounted</code> result, which returns a logical operator <code>cond</code> . <br>  After that we multiply the variables <code>total</code> and <code>discounted</code> and return their product. <br><br><pre> <code class="python hljs">{ _id: <span class="hljs-number"><span class="hljs-number">1</span></span>, price: <span class="hljs-number"><span class="hljs-number">10</span></span>, tax: <span class="hljs-number"><span class="hljs-number">0.50</span></span>, applyDiscount: true } { _id: <span class="hljs-number"><span class="hljs-number">2</span></span>, price: <span class="hljs-number"><span class="hljs-number">10</span></span>, tax: <span class="hljs-number"><span class="hljs-number">0.25</span></span>, applyDiscount: false } db.test.aggregate( [ { $project: { finalTotal: { $let: { vars: { total: { $add: [ <span class="hljs-string"><span class="hljs-string">'$price'</span></span>, <span class="hljs-string"><span class="hljs-string">'$tax'</span></span> ] }, discounted: { $cond: { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>: <span class="hljs-string"><span class="hljs-string">'$applyDiscount'</span></span>, then: <span class="hljs-number"><span class="hljs-number">0.9</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span> } } }, <span class="hljs-keyword"><span class="hljs-keyword">in</span></span>: { $multiply: [ <span class="hljs-string"><span class="hljs-string">"$$total"</span></span>, <span class="hljs-string"><span class="hljs-string">"$$discounted"</span></span> ] } } } } }] ) { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"finalTotal"</span></span> : <span class="hljs-number"><span class="hljs-number">9.450000000000001</span></span> } { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-string"><span class="hljs-string">"finalTotal"</span></span> : <span class="hljs-number"><span class="hljs-number">10.25</span></span> }</code> </pre><br>  <em><font color="blue">$ map</font> <font color="#008B8B">applies a specific expression to each element.</font></em> <br>  Applies any expression to each element, in this example, each element of the array is added <code>+2</code> . <br><pre> <code class="python hljs">{ _id: <span class="hljs-number"><span class="hljs-number">1</span></span>, quizzes: [ <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-number"><span class="hljs-number">6</span></span>, <span class="hljs-number"><span class="hljs-number">7</span></span> ] } { _id: <span class="hljs-number"><span class="hljs-number">2</span></span>, quizzes: [ ] } db.grades.aggregate([{ $project:{ adjustedGrades: {$map: {input: <span class="hljs-string"><span class="hljs-string">"$quizzes"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">as</span></span>: <span class="hljs-string"><span class="hljs-string">"grade"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">in</span></span>: { $add: [ <span class="hljs-string"><span class="hljs-string">"$$grade"</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span> ] } } } } }]) { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"adjustedGrades"</span></span> : [ <span class="hljs-number"><span class="hljs-number">7</span></span>, <span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-number"><span class="hljs-number">9</span></span> ] } { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-string"><span class="hljs-string">"adjustedGrades"</span></span> : [ ] }</code> </pre><br><br>  <em><font color="blue">$ setEquals</font> <font color="#008B8B">compares arrays</font></em> <br><br>  Compares two or more arrays and returns <code>true</code> if they have similar elements. <br><table><tbody><tr><td>  Example </td><td>  Result </td></tr><tr><td>  {$ setEquals: [["a", "b", "a"], ["b", "a"]]} </td><td>  true </td></tr><tr><td>  {$ setEquals: [["a", "b"], [["a", "b"]]]} </td><td>  false </td></tr></tbody></table><br>  <em><font color="blue">$ setIntersection</font> <font color="#008B8B">returns matched items</font></em> <br>  It takes two or more arrays and returns an array containing the elements that are present in each of the input arrays.  If one of the arrays is empty or contains nested arrays, then returns an empty array. <br><table><tbody><tr><td>  Example </td><td>  Result </td></tr><tr><td>  {$ setIntersection: [["a", "b", "a"], ["b", "a"]]} </td><td>  ["B", "a"] </td></tr><tr><td>  {$ setIntersection: [["a", "b"], [["a", "b"]]]} </td><td>  [] </td></tr></tbody></table><br>  <em><font color="blue">$ setUnion</font> <font color="#008B8B">returns the elements present in any of the input parameters.</font></em> <br><br>  Accepts two or more arrays and returns an array containing the elements that appear in any input array. <br><table><tbody><tr><td>  Example </td><td>  Result </td></tr><tr><td>  {$ setUnion: [["a", "b", "a"], ["b", "a"]]} </td><td>  ["B", "a"] </td></tr><tr><td>  {$ setUnion: [["a", "b"], [["a", "b"]]]} </td><td>  [["A", "b"], "b", "a"] </td></tr></tbody></table><br>  <em><font color="blue">$ setDifference is</font> <font color="#008B8B">also setUnion but vice versa</font></em> <br><table><tbody><tr><td>  Example </td><td>  Result </td></tr><tr><td>  {$ setDifference: [["a", "b", "a"], ["b", "a"]]} </td><td>  [] </td></tr><tr><td>  {$ setDifference: [["a", "b"], [["a", "b"]]]} </td><td>  ["A", "b"] </td></tr></tbody></table><br>  <em><font color="blue">$ setIsSubset</font> <font color="#008B8B">checks for a subset</font></em> <br>  Takes two arrays and returns True if the first array is a subset of the second, including when the first array is equal to the second, and false if vice versa. <br><table><tbody><tr><td>  Example </td><td>  Result </td></tr><tr><td>  {$ setIsSubset: [["a", "b", "a"], ["b", "a"]]} </td><td>  true </td></tr><tr><td>  {$ setIsSubset: [["a", "b"], [["a", "b"]]]} </td><td>  false </td></tr></tbody></table><br>  <em><font color="blue">$ anyElementTrue</font></em> <br>  Evaluates an array as a set of elements and returns True if any of the elements is True and false if vice versa.  An empty array returns false.  Takes one argument. <br><table><tbody><tr><td>  Example </td><td>  Result </td></tr><tr><td>  {$ anyElementTrue: [[true, false]]} </td><td></td></tr><tr><td>  {$ anyElementTrue: [[[false]]]} </td><td></td></tr><tr><td>  {$ anyElementTrue: [[null, false, 0]]} </td><td></td></tr><tr><td>  {$ anyElementTrue: [[]]} </td><td></td></tr></tbody></table><br>  <em><font color="blue">$ allElementsTrue</font></em> <br>  Checks an array and returns True if not one element of the array is false.  Otherwise, returns false.  An empty array returns true. <br><table><tbody><tr><td>  Example </td><td>  Result </td></tr><tr><td>  {$ allElementsTrue: [[true, 1, "someString"]]} </td><td></td></tr><tr><td>  {$ allElementsTrue: [[[false]]]} </td><td></td></tr><tr><td>  {$ allElementsTrue: [[]]} </td><td></td></tr><tr><td>  {$ allElementsTrue: [[null, false, 0]]} </td><td></td></tr></tbody></table><br>  <em><font color="blue">$ cmp</font> <font color="#008B8B">- compares two items</font></em> <br>  Compares two items and returns: <br><ul><li>  -1 if the first value is less than the second. </li><li>  1 if the first value is greater than the second. </li><li>  0 if both values ‚Äã‚Äãare equal. </li></ul><br><pre> <code class="python hljs">{ <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"item"</span></span> : <span class="hljs-string"><span class="hljs-string">"abc1"</span></span>, description: <span class="hljs-string"><span class="hljs-string">"product 1"</span></span>, qty: <span class="hljs-number"><span class="hljs-number">300</span></span> } { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-string"><span class="hljs-string">"item"</span></span> : <span class="hljs-string"><span class="hljs-string">"abc2"</span></span>, description: <span class="hljs-string"><span class="hljs-string">"product 2"</span></span>, qty: <span class="hljs-number"><span class="hljs-number">200</span></span> } { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-string"><span class="hljs-string">"item"</span></span> : <span class="hljs-string"><span class="hljs-string">"xyz1"</span></span>, description: <span class="hljs-string"><span class="hljs-string">"product 3"</span></span>, qty: <span class="hljs-number"><span class="hljs-number">250</span></span> }</code> </pre><br>  Using <code>$cmp</code> compare the value of the <code>qty</code> field with <code>250</code> : <br><br><pre> <code class="python hljs">db.test.aggregate( [ { $project:{ _id: <span class="hljs-number"><span class="hljs-number">0</span></span>, item: <span class="hljs-number"><span class="hljs-number">1</span></span>,qty: <span class="hljs-number"><span class="hljs-number">1</span></span>, cmpTo250: { $cmp: [ <span class="hljs-string"><span class="hljs-string">"$qty"</span></span>, <span class="hljs-number"><span class="hljs-number">250</span></span> ] } } } ] )</code> </pre><br>  Result: <br><pre> <code class="python hljs">{ <span class="hljs-string"><span class="hljs-string">"item"</span></span> : <span class="hljs-string"><span class="hljs-string">"abc1"</span></span>, <span class="hljs-string"><span class="hljs-string">"qty"</span></span> : <span class="hljs-number"><span class="hljs-number">300</span></span>, <span class="hljs-string"><span class="hljs-string">"cmpTo250"</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span> } { <span class="hljs-string"><span class="hljs-string">"item"</span></span> : <span class="hljs-string"><span class="hljs-string">"abc2"</span></span>, <span class="hljs-string"><span class="hljs-string">"qty"</span></span> : <span class="hljs-number"><span class="hljs-number">200</span></span>, <span class="hljs-string"><span class="hljs-string">"cmpTo250"</span></span> : <span class="hljs-number"><span class="hljs-number">-1</span></span> } { <span class="hljs-string"><span class="hljs-string">"item"</span></span> : <span class="hljs-string"><span class="hljs-string">"xyz1"</span></span>, <span class="hljs-string"><span class="hljs-string">"qty"</span></span> : <span class="hljs-number"><span class="hljs-number">250</span></span>, <span class="hljs-string"><span class="hljs-string">"cmpTo250"</span></span> : <span class="hljs-number"><span class="hljs-number">0</span></span> }</code> </pre><br><br>  <em><font color="blue">$ add</font> <font color="#008B8B">adds</font></em> <br><pre> <code class="python hljs">{ <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"item"</span></span> : <span class="hljs-string"><span class="hljs-string">"abc"</span></span>, <span class="hljs-string"><span class="hljs-string">"price"</span></span> : <span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-string"><span class="hljs-string">"fee"</span></span> : <span class="hljs-number"><span class="hljs-number">2</span></span> } { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-string"><span class="hljs-string">"item"</span></span> : <span class="hljs-string"><span class="hljs-string">"jkl"</span></span>, <span class="hljs-string"><span class="hljs-string">"price"</span></span> : <span class="hljs-number"><span class="hljs-number">20</span></span>, <span class="hljs-string"><span class="hljs-string">"fee"</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span> } db.test.aggregate([ { $project: { item: <span class="hljs-number"><span class="hljs-number">1</span></span>, total: { $add: [ <span class="hljs-string"><span class="hljs-string">"$price"</span></span>, <span class="hljs-string"><span class="hljs-string">"$fee"</span></span> ] } } } ]) { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"item"</span></span> : <span class="hljs-string"><span class="hljs-string">"abc"</span></span>, <span class="hljs-string"><span class="hljs-string">"total"</span></span> : <span class="hljs-number"><span class="hljs-number">12</span></span> } { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-string"><span class="hljs-string">"item"</span></span> : <span class="hljs-string"><span class="hljs-string">"jkl"</span></span>, <span class="hljs-string"><span class="hljs-string">"total"</span></span> : <span class="hljs-number"><span class="hljs-number">21</span></span> }</code> </pre><br><br>  <em><font color="blue">$ subtract</font> <font color="#008B8B">deducts</font></em> <br>  It can return the difference of dates in milliseconds. <br><pre> <code class="python hljs">{ <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"item"</span></span> : <span class="hljs-string"><span class="hljs-string">"abc"</span></span>, <span class="hljs-string"><span class="hljs-string">"price"</span></span> : <span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-string"><span class="hljs-string">"fee"</span></span> : <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-string"><span class="hljs-string">"discount"</span></span> : <span class="hljs-number"><span class="hljs-number">5</span></span> } { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-string"><span class="hljs-string">"item"</span></span> : <span class="hljs-string"><span class="hljs-string">"jkl"</span></span>, <span class="hljs-string"><span class="hljs-string">"price"</span></span> : <span class="hljs-number"><span class="hljs-number">20</span></span>, <span class="hljs-string"><span class="hljs-string">"fee"</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"discount"</span></span> : <span class="hljs-number"><span class="hljs-number">2</span></span> } db.test.aggregate( [ { $project: { item: <span class="hljs-number"><span class="hljs-number">1</span></span>, total: { $subtract: [ { $add: [ <span class="hljs-string"><span class="hljs-string">"$price"</span></span>, <span class="hljs-string"><span class="hljs-string">"$fee"</span></span> ] }, <span class="hljs-string"><span class="hljs-string">"$discount"</span></span> ] } } } ] ) { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"item"</span></span> : <span class="hljs-string"><span class="hljs-string">"abc"</span></span>, <span class="hljs-string"><span class="hljs-string">"total"</span></span> : <span class="hljs-number"><span class="hljs-number">7</span></span> } { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-string"><span class="hljs-string">"item"</span></span> : <span class="hljs-string"><span class="hljs-string">"jkl"</span></span>, <span class="hljs-string"><span class="hljs-string">"total"</span></span> : <span class="hljs-number"><span class="hljs-number">19</span></span> }</code> </pre><br>  <em><font color="blue">$ multiply</font> <font color="#008B8B">multiplies</font></em> <br><br><pre> <code class="python hljs">{ <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"item"</span></span> : <span class="hljs-string"><span class="hljs-string">"abc"</span></span>, <span class="hljs-string"><span class="hljs-string">"price"</span></span> : <span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-string"><span class="hljs-string">"quantity"</span></span>: <span class="hljs-number"><span class="hljs-number">2</span></span> } { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-string"><span class="hljs-string">"item"</span></span> : <span class="hljs-string"><span class="hljs-string">"jkl"</span></span>, <span class="hljs-string"><span class="hljs-string">"price"</span></span> : <span class="hljs-number"><span class="hljs-number">20</span></span>, <span class="hljs-string"><span class="hljs-string">"quantity"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span> } db.test.aggregate([ { $project: { item: <span class="hljs-number"><span class="hljs-number">1</span></span>, total: { $multiply: [ <span class="hljs-string"><span class="hljs-string">"$price"</span></span>, <span class="hljs-string"><span class="hljs-string">"$quantity"</span></span> ] } } } ]) { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"item"</span></span> : <span class="hljs-string"><span class="hljs-string">"abc"</span></span>, <span class="hljs-string"><span class="hljs-string">"total"</span></span> : <span class="hljs-number"><span class="hljs-number">20</span></span> } { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-string"><span class="hljs-string">"item"</span></span> : <span class="hljs-string"><span class="hljs-string">"jkl"</span></span>, <span class="hljs-string"><span class="hljs-string">"total"</span></span> : <span class="hljs-number"><span class="hljs-number">20</span></span> }</code> </pre><br>  <em><font color="blue">$ divide</font> <font color="#008B8B">division operator</font></em> <br><pre> <code class="python hljs">{ <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"name"</span></span> : <span class="hljs-string"><span class="hljs-string">"A"</span></span>, <span class="hljs-string"><span class="hljs-string">"hours"</span></span> : <span class="hljs-number"><span class="hljs-number">80</span></span>, <span class="hljs-string"><span class="hljs-string">"resources"</span></span> : <span class="hljs-number"><span class="hljs-number">7</span></span> }, { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-string"><span class="hljs-string">"name"</span></span> : <span class="hljs-string"><span class="hljs-string">"B"</span></span>, <span class="hljs-string"><span class="hljs-string">"hours"</span></span> : <span class="hljs-number"><span class="hljs-number">40</span></span>, <span class="hljs-string"><span class="hljs-string">"resources"</span></span> : <span class="hljs-number"><span class="hljs-number">4</span></span> } db.test.aggregate([ { $project: { name: <span class="hljs-number"><span class="hljs-number">1</span></span>, workdays: { $divide: [ <span class="hljs-string"><span class="hljs-string">"$hours"</span></span>, <span class="hljs-number"><span class="hljs-number">8</span></span> ] } } } ]) { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"name"</span></span> : <span class="hljs-string"><span class="hljs-string">"A"</span></span>, <span class="hljs-string"><span class="hljs-string">"workdays"</span></span> : <span class="hljs-number"><span class="hljs-number">10</span></span> } { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-string"><span class="hljs-string">"name"</span></span> : <span class="hljs-string"><span class="hljs-string">"B"</span></span>, <span class="hljs-string"><span class="hljs-string">"workdays"</span></span> : <span class="hljs-number"><span class="hljs-number">5</span></span> }</code> </pre><br><br>  <em><font color="blue">$ concat</font> <font color="#008B8B">- string concatenation</font></em> <br><pre> <code class="python hljs">{ <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"item"</span></span> : <span class="hljs-string"><span class="hljs-string">"ABC1"</span></span>, quarter: <span class="hljs-string"><span class="hljs-string">"13Q1"</span></span>, <span class="hljs-string"><span class="hljs-string">"description"</span></span> : <span class="hljs-string"><span class="hljs-string">"product 1"</span></span> } db.test.aggregate([ { $project: { itemDescription: { $concat: [ <span class="hljs-string"><span class="hljs-string">"$item"</span></span>, <span class="hljs-string"><span class="hljs-string">" - "</span></span>, <span class="hljs-string"><span class="hljs-string">"$description"</span></span> ] } } } ]) { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"itemDescription"</span></span> : <span class="hljs-string"><span class="hljs-string">"ABC1 - product 1"</span></span> }</code> </pre><br>  <em><font color="blue">$ substr</font> <font color="#008B8B">returns a substring</font></em> <br><br>  Gets the index of the beginning and the number of characters from the beginning.  The index starts from scratch. <br><br><pre> <code class="python hljs">{ <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"item"</span></span> : <span class="hljs-string"><span class="hljs-string">"ABC1"</span></span>, quarter: <span class="hljs-string"><span class="hljs-string">"13Q1"</span></span>, <span class="hljs-string"><span class="hljs-string">"description"</span></span> : <span class="hljs-string"><span class="hljs-string">"product 1"</span></span> } { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-string"><span class="hljs-string">"item"</span></span> : <span class="hljs-string"><span class="hljs-string">"ABC2"</span></span>, quarter: <span class="hljs-string"><span class="hljs-string">"13Q4"</span></span>, <span class="hljs-string"><span class="hljs-string">"description"</span></span> : <span class="hljs-string"><span class="hljs-string">"product 2"</span></span> } db.inventory.aggregate([{ $project:{ item: <span class="hljs-number"><span class="hljs-number">1</span></span>, yearSubstring: { $substr: [ <span class="hljs-string"><span class="hljs-string">"$quarter"</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span> ] }, quarterSubtring: { $substr: [ <span class="hljs-string"><span class="hljs-string">"$quarter"</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">-1</span></span> ] } } }]) { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"item"</span></span> : <span class="hljs-string"><span class="hljs-string">"ABC1"</span></span>, <span class="hljs-string"><span class="hljs-string">"yearSubstring"</span></span> : <span class="hljs-string"><span class="hljs-string">"13"</span></span>, <span class="hljs-string"><span class="hljs-string">"quarterSubtring"</span></span> : <span class="hljs-string"><span class="hljs-string">"Q1"</span></span> } { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-string"><span class="hljs-string">"item"</span></span> : <span class="hljs-string"><span class="hljs-string">"ABC2"</span></span>, <span class="hljs-string"><span class="hljs-string">"yearSubstring"</span></span> : <span class="hljs-string"><span class="hljs-string">"13"</span></span>, <span class="hljs-string"><span class="hljs-string">"quarterSubtring"</span></span> : <span class="hljs-string"><span class="hljs-string">"Q4"</span></span> }</code> </pre><br><br>  <em><font color="blue">$ toLower</font> <font color="#008B8B">- converts to lower case</font></em> <br><pre> <code class="python hljs">{ <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"item"</span></span> : <span class="hljs-string"><span class="hljs-string">"ABC1"</span></span>, quarter: <span class="hljs-string"><span class="hljs-string">"13Q1"</span></span>, <span class="hljs-string"><span class="hljs-string">"description"</span></span> : <span class="hljs-string"><span class="hljs-string">"PRODUCT 1"</span></span> } db.test.aggregate([{ $project:{ item: { $toLower: <span class="hljs-string"><span class="hljs-string">"$item"</span></span> }, description: { $toLower: <span class="hljs-string"><span class="hljs-string">"$description"</span></span> }} }]) { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"item"</span></span> : <span class="hljs-string"><span class="hljs-string">"abc1"</span></span>, <span class="hljs-string"><span class="hljs-string">"description"</span></span> : <span class="hljs-string"><span class="hljs-string">"product 1"</span></span> }</code> </pre><br>  <em><font color="blue">$ toUpper</font> <font color="#008B8B">converts to upper case</font></em> <br><br><pre> <code class="python hljs">{ <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-string"><span class="hljs-string">"item"</span></span> : <span class="hljs-string"><span class="hljs-string">"abc2"</span></span>, quarter: <span class="hljs-string"><span class="hljs-string">"13Q4"</span></span>, <span class="hljs-string"><span class="hljs-string">"description"</span></span> : <span class="hljs-string"><span class="hljs-string">"Product 2"</span></span> } db.inventory.aggregate( [ { $project:{ item: { $toUpper: <span class="hljs-string"><span class="hljs-string">"$item"</span></span> }, description: { $toUpper: <span class="hljs-string"><span class="hljs-string">"$description"</span></span> } } } ] ) { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-string"><span class="hljs-string">"item"</span></span> : <span class="hljs-string"><span class="hljs-string">"ABC2"</span></span>, <span class="hljs-string"><span class="hljs-string">"description"</span></span> : <span class="hljs-string"><span class="hljs-string">"PRODUCT 2"</span></span> }</code> </pre><br><br>  <em><font color="blue">$ strcasecmp</font> <font color="#008B8B">compares strings</font></em> <br>  Compares two strings and returns: <br><ul><li>  1 if the first line is ‚Äúlarger‚Äù than the second line. </li><li>  0 if two strings are equal. </li><li>  -1 if the first line is less than the second line. </li></ul><br>  The operator is not case sensitive. <br><pre> <code class="python hljs">{ <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"item"</span></span> : <span class="hljs-string"><span class="hljs-string">"ABC1"</span></span>, quarter: <span class="hljs-string"><span class="hljs-string">"13Q1"</span></span>, <span class="hljs-string"><span class="hljs-string">"description"</span></span> : <span class="hljs-string"><span class="hljs-string">"product 1"</span></span> } { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-string"><span class="hljs-string">"item"</span></span> : <span class="hljs-string"><span class="hljs-string">"ABC2"</span></span>, quarter: <span class="hljs-string"><span class="hljs-string">"13Q4"</span></span>, <span class="hljs-string"><span class="hljs-string">"description"</span></span> : <span class="hljs-string"><span class="hljs-string">"product 2"</span></span> } { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-string"><span class="hljs-string">"item"</span></span> : <span class="hljs-string"><span class="hljs-string">"XYZ1"</span></span>, quarter: <span class="hljs-string"><span class="hljs-string">"14Q2"</span></span>, <span class="hljs-string"><span class="hljs-string">"description"</span></span> : null } db.inventory.aggregate([{ $project:{ item: <span class="hljs-number"><span class="hljs-number">1</span></span>, comparisonResult: { $strcasecmp: [ <span class="hljs-string"><span class="hljs-string">"$quarter"</span></span>, <span class="hljs-string"><span class="hljs-string">"13q4"</span></span> ] } } }]) { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"item"</span></span> : <span class="hljs-string"><span class="hljs-string">"ABC1"</span></span>, <span class="hljs-string"><span class="hljs-string">"comparisonResult"</span></span> : <span class="hljs-number"><span class="hljs-number">-1</span></span> } { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-string"><span class="hljs-string">"item"</span></span> : <span class="hljs-string"><span class="hljs-string">"ABC2"</span></span>, <span class="hljs-string"><span class="hljs-string">"comparisonResult"</span></span> : <span class="hljs-number"><span class="hljs-number">0</span></span> } { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-string"><span class="hljs-string">"item"</span></span> : <span class="hljs-string"><span class="hljs-string">"XYZ1"</span></span>, <span class="hljs-string"><span class="hljs-string">"comparisonResult"</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span> }</code> </pre><br><br><h5>  Work with dates </h5><br>  <em><font color="blue">$ dayOfYear</font> <font color="#008B8B">day of the year in a row</font></em> <br>  <em><font color="blue">$ dayOfMonth</font> <font color="#008B8B">day in month by account</font></em> <br>  <em><font color="blue">$ dayOfWeek</font> <font color="#008B8B">returns the day of the week in a row, 1 (Saturday) - 7 (Sunday).</font></em> <br>  <em><font color="blue">$ year</font> <font color="#008B8B">returns the year</font></em> <br>  <em><font color="blue">$ month</font> <font color="#008B8B">returns the month in a row</font></em> <br>  <em><font color="blue">$ week</font> <font color="#008B8B">returns the</font> <font color="blue">week</font> <font color="#008B8B">number of the year as a number from 0 to 53</font></em> <br>  <em><font color="blue">$ hour</font> <font color="#008B8B">returns the hour as a number between 0 and 23</font></em> <br>  <em><font color="blue">$ minute</font> <font color="#008B8B">returns a minute as a number between 0 and 59</font></em> <br>  <em><font color="blue">$ second</font> <font color="#008B8B">returns seconds as a number between 0 and 23</font></em> <br>  <em><font color="blue">$ millisecond</font> <font color="#008B8B">returns milliseconds as a number between 0 and 999</font></em> <br><br>  Returns the day of the year for a date as a number between 1 and 366. <br>  For example, for January 1 will return 1. <br><pre> <code class="python hljs">{ <span class="hljs-string"><span class="hljs-string">"_id"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"item"</span></span>: <span class="hljs-string"><span class="hljs-string">"abc"</span></span>, <span class="hljs-string"><span class="hljs-string">"date"</span></span> : ISODate(<span class="hljs-string"><span class="hljs-string">"2014-01-01T08:15:39.736Z"</span></span>) } db.sales.aggregate( [ { $project: { year: { $year: <span class="hljs-string"><span class="hljs-string">"$date"</span></span> }, month: { $month: <span class="hljs-string"><span class="hljs-string">"$date"</span></span> }, day: { $dayOfMonth: <span class="hljs-string"><span class="hljs-string">"$date"</span></span> }, hour: { $hour: <span class="hljs-string"><span class="hljs-string">"$date"</span></span> }, minutes: { $minute: <span class="hljs-string"><span class="hljs-string">"$date"</span></span> }, seconds: { $second: <span class="hljs-string"><span class="hljs-string">"$date"</span></span> }, milliseconds: { $millisecond: <span class="hljs-string"><span class="hljs-string">"$date"</span></span> }, dayOfYear: { $dayOfYear: <span class="hljs-string"><span class="hljs-string">"$date"</span></span> }, dayOfWeek: { $dayOfWeek: <span class="hljs-string"><span class="hljs-string">"$date"</span></span> }, week: { $week: <span class="hljs-string"><span class="hljs-string">"$date"</span></span> } } } ] ) { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"year"</span></span> : <span class="hljs-number"><span class="hljs-number">2014</span></span>, <span class="hljs-string"><span class="hljs-string">"month"</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"day"</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"hour"</span></span> : <span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-string"><span class="hljs-string">"minutes"</span></span> : <span class="hljs-number"><span class="hljs-number">15</span></span>, <span class="hljs-string"><span class="hljs-string">"seconds"</span></span> : <span class="hljs-number"><span class="hljs-number">39</span></span>, <span class="hljs-string"><span class="hljs-string">"milliseconds"</span></span> : <span class="hljs-number"><span class="hljs-number">736</span></span>, <span class="hljs-string"><span class="hljs-string">"dayOfYear"</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"dayOfWeek"</span></span> : <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-string"><span class="hljs-string">"week"</span></span> : <span class="hljs-number"><span class="hljs-number">0</span></span> }</code> </pre><br><br>  <em><font color="blue">$ dateToString</font> <font color="#008B8B">converts to string</font></em> <br><br>  Converts a date object to a string according to the specified format. <br><pre> <code class="python hljs">{ <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"item"</span></span> : <span class="hljs-string"><span class="hljs-string">"abc"</span></span>, <span class="hljs-string"><span class="hljs-string">"price"</span></span> : <span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-string"><span class="hljs-string">"quantity"</span></span> : <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-string"><span class="hljs-string">"date"</span></span> : ISODate(<span class="hljs-string"><span class="hljs-string">"2014-01-01T08:15:39.736Z"</span></span>) } db.test.aggregate( [ { $project: { yearMonthDay: { $dateToString: { format: <span class="hljs-string"><span class="hljs-string">"%Y-%m-%d"</span></span>, date: <span class="hljs-string"><span class="hljs-string">"$date"</span></span> } }, time: { $dateToString: { format: <span class="hljs-string"><span class="hljs-string">"%H:%M:%S:%L"</span></span>, date: <span class="hljs-string"><span class="hljs-string">"$date"</span></span> } } } } ] ) { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"yearMonthDay"</span></span> : <span class="hljs-string"><span class="hljs-string">"2014-01-01"</span></span>, <span class="hljs-string"><span class="hljs-string">"time"</span></span> : <span class="hljs-string"><span class="hljs-string">"08:15:39:736"</span></span> }</code> </pre><br><br><h3><a name="2"></a>  <font color="green">Product Catalog</font> </h3><br>  This chapter describes the basic principles for designing a product catalog in an e-commerce system using <code>MongoDB</code> . <br><br>  The product catalog should be able to store different types of objects, each of which should have its own list of characteristics. <br>  For relational databases, there are several solutions to similar problems, differing in performance as well.  We will look at some of these options, and then see how this will be resolved in <code>MongoDB</code> . <br><br><h4>  <font color="blue">SQL and relational data model</font> </h4><br>  <em><font color="blue">Concrete Table Inheritance (Inheritance with tables of finite classes)</font></em> <br>  The first option in the relational model is to create your own table for each category of goods: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-string"><span class="hljs-string">`product_audio_album`</span></span> ( <span class="hljs-string"><span class="hljs-string">`sku`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">char</span></span>(<span class="hljs-number"><span class="hljs-number">8</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, ... <span class="hljs-string"><span class="hljs-string">`artist`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">255</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`genre_0`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">255</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`genre_1`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">255</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, ..., PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span>(<span class="hljs-string"><span class="hljs-string">`sku`</span></span>)) ... <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-string"><span class="hljs-string">`product_film`</span></span> ( <span class="hljs-string"><span class="hljs-string">`sku`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">char</span></span>(<span class="hljs-number"><span class="hljs-number">8</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, ... <span class="hljs-string"><span class="hljs-string">`title`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">255</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`rating`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">char</span></span>(<span class="hljs-number"><span class="hljs-number">8</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, ..., PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span>(<span class="hljs-string"><span class="hljs-string">`sku`</span></span>)) ...</code> </pre><br>  This approach has two main limitations related to flexibility. <br><ul><li>  Actually creating every time a new table for each new product category. </li><li>  Explicit adaptation of requests for a specific type of product. </li></ul><br><br>  <em><font color="blue">Single Table Inheritance (Inheritance with a single table)</font></em> <br><br>  The second option in the relational model is to use a single table for all categories of goods.  And adding new columns at any time you need to save data about the types of goods: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-string"><span class="hljs-string">`product`</span></span> ( <span class="hljs-string"><span class="hljs-string">`sku`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">char</span></span>(<span class="hljs-number"><span class="hljs-number">8</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, ... <span class="hljs-string"><span class="hljs-string">`artist`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">255</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`genre_0`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">255</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`genre_1`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">255</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, ... <span class="hljs-string"><span class="hljs-string">`title`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">255</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`rating`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">char</span></span>(<span class="hljs-number"><span class="hljs-number">8</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, ..., PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span>(<span class="hljs-string"><span class="hljs-string">`sku`</span></span>))</code> </pre><br>  This approach is more flexible and allows you to make single requests based on different types of products. <br><br>  <em><font color="blue">Multiple Table Inheritance (multiple inheritance tables)</font></em> <br><br>  Also in the relational model, one can use ‚Äúmultiple inheritance of tables‚Äù, a pattern in which attributes common to all product categories are in the main <code>product</code> table and separate tables (for each category have their own) will contain different attributes. <br><br>  Consider the following <code>SQL</code> example: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-string"><span class="hljs-string">`product`</span></span> ( <span class="hljs-string"><span class="hljs-string">`sku`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">char</span></span>(<span class="hljs-number"><span class="hljs-number">8</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`title`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">255</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`description`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">255</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`price`</span></span>, ... PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span>(<span class="hljs-string"><span class="hljs-string">`sku`</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-string"><span class="hljs-string">`product_audio_album`</span></span> ( <span class="hljs-string"><span class="hljs-string">`sku`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">char</span></span>(<span class="hljs-number"><span class="hljs-number">8</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, ... <span class="hljs-string"><span class="hljs-string">`artist`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">255</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`genre_0`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">255</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`genre_1`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">255</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, ..., PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span>(<span class="hljs-string"><span class="hljs-string">`sku`</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">FOREIGN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span>(<span class="hljs-string"><span class="hljs-string">`sku`</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">REFERENCES</span></span> <span class="hljs-string"><span class="hljs-string">`product`</span></span>(<span class="hljs-string"><span class="hljs-string">`sku`</span></span>)) ... <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-string"><span class="hljs-string">`product_film`</span></span> ( <span class="hljs-string"><span class="hljs-string">`sku`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">char</span></span>(<span class="hljs-number"><span class="hljs-number">8</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, ... <span class="hljs-string"><span class="hljs-string">`title`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">255</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`rating`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">char</span></span>(<span class="hljs-number"><span class="hljs-number">8</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, ..., PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span>(<span class="hljs-string"><span class="hljs-string">`sku`</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">FOREIGN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span>(<span class="hljs-string"><span class="hljs-string">`sku`</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">REFERENCES</span></span> <span class="hljs-string"><span class="hljs-string">`product`</span></span>(<span class="hljs-string"><span class="hljs-string">`sku`</span></span>)) ...</code> </pre><br>  This option is more efficient than inheriting a single table and slightly more flexible than creating a table for each category.  This option requires the use of an ‚Äúexpensive‚Äù <code>JOIN</code> to get all the attributes related to a particular product. <br><br>  <em><font color="blue">Attribute values ‚Äã‚Äãfor each entity</font></em> <br><br>  And the last pattern in the relational model is the <code>entity-attribute-value</code> schema.  In accordance with this scheme, we will have a table with three columns, for example, <code>entity_id</code> , <code>attribute_id</code> , <code>value</code> with which each product will be described. <br><br>  Consider an example of storing audio recordings: <br><table><tbody><tr><td>  Entity </td><td>  Attribute </td><td>  Value </td></tr><tr><td>  sku_00e8da9b </td><td>  type </td><td>  Audio album </td></tr><tr><td>  sku_00e8da9b </td><td>  title </td><td>  A love supreme </td></tr><tr><td>  sku_00e8da9b </td><td>  ... </td><td>  ... </td></tr><tr><td>  sku_00e8da9b </td><td>  artist </td><td>  John coltrane </td></tr><tr><td>  sku_00e8da9b </td><td>  genre </td><td>  Jazz </td></tr><tr><td>  sku_00e8da9b </td><td>  genre </td><td>  General </td></tr><tr><td>  ... </td><td>  ... </td><td>  ... </td></tr></tbody></table><br><br><br>  This scheme is quite flexible: <br><br>  Any product can have any set of attributes.  New product categories do not require changes to the database. <br><br>  The disadvantage of this option is that it takes a lot of queries containing a <code>JOIN</code> , which in turn is not very good for performance. <br><br>  In addition, some <code>e-commerce</code> solutions with relational database systems serialize this data in the BLOB column.  And the attributes of goods become difficult to search and sort. <br><br><h4>  <font color="blue">Non relational data model</font> </h4><br>  Since <code>mongodb</code> not a relational database, we have additional flexibility in creating a product catalog. <br><br>  The best option is to use one collection to store all kinds of documents.  And since for each document there can be any scheme, it is possible to store all the characteristics (attributes) of the goods in one document. <br><br>  At the root of the document should be general information about the product to facilitate searching the entire catalog.  And already in the subdocuments there should be fields that are unique for each document.  Consider an example: <br><br><pre> <code class="python hljs">{ sku: <span class="hljs-string"><span class="hljs-string">"00e8da9b"</span></span>, type: <span class="hljs-string"><span class="hljs-string">"Audio Album"</span></span>, title: <span class="hljs-string"><span class="hljs-string">"A Love Supreme"</span></span>, description: <span class="hljs-string"><span class="hljs-string">"by John Coltrane"</span></span>, asin: <span class="hljs-string"><span class="hljs-string">"B0000A118M"</span></span>, shipping: { weight: <span class="hljs-number"><span class="hljs-number">6</span></span>, dimensions: { width: <span class="hljs-number"><span class="hljs-number">10</span></span>, height: <span class="hljs-number"><span class="hljs-number">10</span></span>, depth: <span class="hljs-number"><span class="hljs-number">1</span></span> }, }, pricing: { list: <span class="hljs-number"><span class="hljs-number">1200</span></span>, retail: <span class="hljs-number"><span class="hljs-number">1100</span></span>, savings: <span class="hljs-number"><span class="hljs-number">100</span></span>, pct_savings: <span class="hljs-number"><span class="hljs-number">8</span></span> }, details: { title: <span class="hljs-string"><span class="hljs-string">"A Love Supreme [Original Recording Reissued]"</span></span>, artist: <span class="hljs-string"><span class="hljs-string">"John Coltrane"</span></span>, genre: [ <span class="hljs-string"><span class="hljs-string">"Jazz"</span></span>, <span class="hljs-string"><span class="hljs-string">"General"</span></span> ], ... tracks: [ <span class="hljs-string"><span class="hljs-string">"A Love Supreme Part I: Acknowledgement"</span></span>, <span class="hljs-string"><span class="hljs-string">"A Love Supreme Part II - Resolution"</span></span>, <span class="hljs-string"><span class="hljs-string">"A Love Supreme, Part III: Pursuance"</span></span>, <span class="hljs-string"><span class="hljs-string">"A Love Supreme, Part IV-Psalm"</span></span> ], }, }</code> </pre><br><br>  For documents that store information about films <code>{ type: "Film" }</code> The main fields are price, delivery, etc.  remain the same.  But the contents of the sub-document will be different.  For example: <br><br><pre> <code class="python hljs">{ sku: <span class="hljs-string"><span class="hljs-string">"00e8da9d"</span></span>, type: <span class="hljs-string"><span class="hljs-string">"Film"</span></span>, ..., asin: <span class="hljs-string"><span class="hljs-string">"B000P0J0AQ"</span></span>, shipping: { ... }, pricing: { ... }, details: { title: <span class="hljs-string"><span class="hljs-string">"The Matrix"</span></span>, director: [ <span class="hljs-string"><span class="hljs-string">"Andy Wachowski"</span></span>, <span class="hljs-string"><span class="hljs-string">"Larry Wachowski"</span></span> ], writer: [ <span class="hljs-string"><span class="hljs-string">"Andy Wachowski"</span></span>, <span class="hljs-string"><span class="hljs-string">"Larry Wachowski"</span></span> ], ..., aspect_ratio: <span class="hljs-string"><span class="hljs-string">"1.66:1"</span></span> }, }</code> </pre><br><br>  In most cases, the basic operations for the product catalog is a search.  Below we will see various types of queries that may come in handy.  All examples will be in <code>Python/PyMongo</code> . <br><br>  <em><font color="blue">Find albums by genre and sort by release year</font></em> <br>  This request returns documents with goods corresponding to a particular genre and sorted in reverse chronological order: <br><pre> <code class="python hljs">query = db.products.find({<span class="hljs-string"><span class="hljs-string">'type'</span></span>:<span class="hljs-string"><span class="hljs-string">'Audio Album'</span></span>, <span class="hljs-string"><span class="hljs-string">'details.genre'</span></span>: <span class="hljs-string"><span class="hljs-string">'jazz'</span></span>}).sort([(<span class="hljs-string"><span class="hljs-string">'details.issue_date'</span></span>, <span class="hljs-number"><span class="hljs-number">-1</span></span>)])</code> </pre><br>  This query requires an index for the fields used in the query and in the sort: <br><pre> <code class="python hljs">db.products.ensure_index([ (<span class="hljs-string"><span class="hljs-string">'type'</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>), (<span class="hljs-string"><span class="hljs-string">'details.genre'</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>), (<span class="hljs-string"><span class="hljs-string">'details.issue_date'</span></span>, <span class="hljs-number"><span class="hljs-number">-1</span></span>)])</code> </pre><br><br>  <em><font color="blue">Find products sorted by discount percentage in descending order.</font></em> <br>  While most requests will be for a specific type of product (for example, albums, movies, etc.), we may often need to return all products in a certain price range. <br><br>  We will find products that have a good discount. We will use the price field in all documents for the search. <br><br><pre> <code class="python hljs">query = db.products.find( { <span class="hljs-string"><span class="hljs-string">'pricing.pct_savings'</span></span>: {<span class="hljs-string"><span class="hljs-string">'$gt'</span></span>: <span class="hljs-number"><span class="hljs-number">25</span></span> }).sort([(<span class="hljs-string"><span class="hljs-string">'pricing.pct_savings'</span></span>, <span class="hljs-number"><span class="hljs-number">-1</span></span>)])</code> </pre><br>  For this request, create an index across the field <code>pricing.pct_savings</code> : <br><br><pre> <code class="python hljs">db.products.ensure_index(<span class="hljs-string"><span class="hljs-string">'pricing.pct_savings'</span></span>)</code> </pre><br>  <code>MongoDB</code> can read indexes in ascending or descending order. <br><br>  <em><font color="blue">Find all the movies that famous actors played</font></em> <br>  Find documents whose document type is <code>"Film"</code> and the document attributes have the value <code>{ 'actor': 'Keanu Reeves' }</code> .  Result will be sorted by date in descending order. <br><br><pre> <code class="python hljs">query = db.products.find({<span class="hljs-string"><span class="hljs-string">'type'</span></span>: <span class="hljs-string"><span class="hljs-string">'Film'</span></span>, <span class="hljs-string"><span class="hljs-string">'details.actor'</span></span>: <span class="hljs-string"><span class="hljs-string">'Keanu Reeves'</span></span>}).sort([(<span class="hljs-string"><span class="hljs-string">'details.issue_date'</span></span>, <span class="hljs-number"><span class="hljs-number">-1</span></span>)])</code> </pre><br>  For this query, create the following index: <br><br><pre> <code class="python hljs">db.products.ensure_index([ (<span class="hljs-string"><span class="hljs-string">'type'</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>), (<span class="hljs-string"><span class="hljs-string">'details.actor'</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>), (<span class="hljs-string"><span class="hljs-string">'details.issue_date'</span></span>, <span class="hljs-number"><span class="hljs-number">-1</span></span>)])</code> </pre><br>  The index begins with the <code>type</code> field which is in all documents and goes further along the <code>details.actor</code> field. By this we narrow down the search area.  Thus, the index will be as efficient as possible. <br><br>  <em><font color="blue">Find all the movies that have a certain word in the title.</font></em> <br><br>  In order to perform a word search query regardless of the type of database, the database will have to scan some part of the documents to get the result. <br><br>  <code>Mongodb</code> supports regular expressions in queries.  In Python, you can use the <code>re</code> module to construct regular expressions. <br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> re re_hacker = re.compile(<span class="hljs-string"><span class="hljs-string">r'.*hacker.*'</span></span>, re.IGNORECASE) query = db.products.find({<span class="hljs-string"><span class="hljs-string">'type'</span></span>: <span class="hljs-string"><span class="hljs-string">'Film'</span></span>, <span class="hljs-string"><span class="hljs-string">'title'</span></span>: re_hacker}).sort([(<span class="hljs-string"><span class="hljs-string">'details.issue_date'</span></span>, <span class="hljs-number"><span class="hljs-number">-1</span></span>)])</code> </pre><br><br>  Mongodb provides a special syntax for regular expressions, so querying is possible for queries without the <code>re</code> module.  Consider the following example, an alternative to the previous one. <br><br><pre> <code class="python hljs">query = db.products.find({ <span class="hljs-string"><span class="hljs-string">'type'</span></span>: <span class="hljs-string"><span class="hljs-string">'Film'</span></span>, <span class="hljs-string"><span class="hljs-string">'title'</span></span>: {<span class="hljs-string"><span class="hljs-string">'$regex'</span></span>: <span class="hljs-string"><span class="hljs-string">'.*hacker.*'</span></span>, <span class="hljs-string"><span class="hljs-string">'$options'</span></span>:<span class="hljs-string"><span class="hljs-string">'i'</span></span>}}).sort([(<span class="hljs-string"><span class="hljs-string">'details.issue_date'</span></span>, <span class="hljs-number"><span class="hljs-number">-1</span></span>)])</code> </pre><br>  <code>$options</code> special operator, in this case it indicates that the search word is not case sensitive. <br><br>  Create an index: <br><br><pre> <code class="python hljs">db.products.ensure_index([ (<span class="hljs-string"><span class="hljs-string">'type'</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>), (<span class="hljs-string"><span class="hljs-string">'details.issue_date'</span></span>, <span class="hljs-number"><span class="hljs-number">-1</span></span>), (<span class="hljs-string"><span class="hljs-string">'title'</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>) ])</code> </pre><br>  This index allows you to avoid scanning entire documents, thanks to the index only the <code>title</code> field will be scanned. <br><br><h4>  Sharding </h4><br><br>  Database performance when scaling depends on indexes.  You can use sharding to improve performance, then large indexes will fit into the RAM. <br>  In the configuration of shards, select the <code>shard key</code> , this will allow <code>mongos</code> route requests directly to the shard we need or a small group of shards. <br><br>  Since most requests have a <code>type</code> field, you can include it in the <code>shard key</code> .  For the rest of the <code>shard key</code> you need to consider: <br><ul><li>  <code>details.issue_date</code> we will not include in the <code>shard key</code> , because this field is not present in requests but only in sorting. </li><li>  You need to include one or more fields that are contained in <code>detail</code> and are often requested. </li></ul><br><br>  In the following example, assume that the <code>details.genre</code> field is the second most important field after <code>type</code> .  Initialize sharding with <code>Python/PyMongo</code> <br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">&gt;&gt;&gt; </span></span>db.command(<span class="hljs-string"><span class="hljs-string">'shardCollection'</span></span>, <span class="hljs-string"><span class="hljs-string">'product'</span></span>, { key : { <span class="hljs-string"><span class="hljs-string">'type'</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">'details.genre'</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">'sku'</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span> } } ) { <span class="hljs-string"><span class="hljs-string">"collectionsharded"</span></span> : <span class="hljs-string"><span class="hljs-string">"details.genre"</span></span>, <span class="hljs-string"><span class="hljs-string">"ok"</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span> }</code> </pre><br>  Even if we create an unsuccessful <code>shard key</code> , it will still benefit from sharding: <br><ol><li>  Sharding will provide a large amount of RAM available for storing indexes. </li><li>  <code>MongoDB</code> will parallelize requests for shards, reducing latency. </li></ol><br><br><h5>  Reading </h5><br>  Although sharding is a good way to scale, some datasets cannot be divided in such a way that <code>mongos</code> directs requests to the right shards. <br>  In this case, <code>mongos</code> sends requests to all shards at once, and then returns to the client with the result. <br>  We can slightly increase performance due to the fact that we explicitly indicate from which shard it is preferable to read. <br><br>  The <code>SECONDARY</code> property in the following example allows you to read from the secondary node (as well as the primary) for the entire connection. <br><pre> <code class="python hljs">conn = pymongo.MongoClient(read_preference=pymongo.SECONDARY)</code> </pre><br>  <code>SECONDARY_ONLY</code> means that the client will only read from the secondary member. <br><pre> <code class="python hljs">conn = pymongo.MongoClient(read_preference=pymongo.SECONDARY_ONLY)</code> </pre><br>  You can also specify a <code>read_preference</code> for specific requests, for example: <br><pre> <code class="python hljs">results = db.product.find(..., read_preference=pymongo.SECONDARY)</code> </pre><br>  or <br><pre> <code class="python hljs">results = db.product.find(..., read_preference=pymongo.SECONDARY_ONLY)</code> </pre><br><br><h3><a name="3"></a>  <font color="green">Cart and stock management</font> </h3><br><br>  Users of online stores regularly add and remove items from their ‚Äúbasket‚Äù, and therefore the quantity of goods in stock may constantly change during the purchase several times, besides, the store user may refuse to buy at any time, and sometimes other unforeseen problems may arise. To solve which you will need to cancel the order. <br><br>  All this may slightly complicate the accounting of goods in stock, and we need to make sure that users cannot ‚Äúbuy‚Äù those goods of which are already reserved. <br><br>  Therefore, the basket will have time during which, if it was inactive, the reserved goods will again be available to everyone else and the basket will be cleared. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/dc4/4c7/77a/dc44c777a24dc25eb4dbff115df2e865.png"><br><br>  Documents containing the current quantity of stocks for each inventory unit ( <a href="https://ru.wikipedia.org/wiki/SKU">SKU</a> ; or item), as well as a list of baskets with the quantity of goods in each, should be saved to the <code>Inventory</code> collection.  Then we can return the available balances if they were in the basket, but the client did not use the basket for a while. <br><br>  In the following example, <code>_id</code> field storing a <a href="https://ru.wikipedia.org/wiki/SKU">SKU.</a> <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#     _id:SKU,   ,      16 , 1 .  #   id 42,  2 .   c id 43.      19    . { _id: '00e8da9b', qty: 16, carted: [ { qty: 1, cart_id: 42, timestamp: ISODate("2012-03-09T20:55:36Z") }, { qty: 2, cart_id: 43, timestamp: ISODate("2012-03-09T21:55:36Z") }, ] }</span></span></code> </pre><br> <i>     ,              .</i> <br><br>        <a href="https://ru.wikipedia.org/wiki/SKU">SKU</a> , <code>quantity</code> ,       ,   <code>item_details</code> <br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#  item_details          # ,           . { _id: 42, last_modified: ISODate("2012-03-09T20:55:36Z"), status: 'active', items: [ { sku: '00e8da9b', qty: 1, item_details: {...} }, { sku: '0ab42f88', qty: 4, item_details: {...} } ] }</span></span></code> </pre><br><br><h4>  Operations </h4><h4> <em><font color="blue">   </font></em> <br><br>                . <br>        .      <code>add_item_to_cart</code> . <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">add_item_to_cart</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(cart_id, sku, qty, details)</span></span></span><span class="hljs-function">:</span></span> now = datetime.utcnow() <span class="hljs-comment"><span class="hljs-comment"># ,         result = db.cart.update( {'_id': cart_id, 'status': 'active' }, {'$set': {'last_modified':now}, '$push': {'items': {'sku':sku, 'qty':qty, 'details':details}}}, w=1 ) if not result['updatedExisting']: raise CartInactive() #   result = db.inventory.update( {'_id':sku, 'qty': {'$gte': qty}}, {'$inc': {'qty':-qty}, '$push': {'carted': {'qty':qty, 'cart_id':cart_id, 'timestamp':now}}}, w=1 ) if not result['updatedExisting']: #     ,    ,    . db.cart.update( {'_id': cart_id }, { '$pull': { 'items': {'sku': sku } } }) raise InadequateInventory()</span></span></code> </pre><br> <i>     ,    <code>_id</code>   .</i> <br>      ‚Äî  ,          .            ,   . <br>           ,    . <br><br> <em><font color="blue">   </font></em> <br><br>   ,        ,      . <br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">update_quantity</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(cart_id, sku, old_qty, new_qty)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-comment"><span class="hljs-comment">#        _id   . now = datetime.utcnow() delta_qty = new_qty - old_qty # ,           . result = db.cart.update( {'_id': cart_id, 'status': 'active', 'items.sku': sku }, {'$set': { 'last_modified': now, 'items.$.qty': new_qty } }, w=1 ) if not result['updatedExisting']: raise CartInactive() #   result = db.inventory.update( {'_id':sku, 'carted.cart_id': cart_id, 'qty': {'$gte': delta_qty} }, {'$inc': {'qty': -delta_qty },'$set': { 'carted.$.qty': new_qty, 'timestamp': now } }, w=1 ) if not result['updatedExisting']: #           db.cart.update( {'_id': cart_id, 'items.sku': sku }, {'$set': { 'items.$.qty': old_qty } } ) raise InadequateInventory()</span></span></code> </pre><br><br> <em><font color="blue"> </font></em> <br><br>       ,   ,   . <br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">checkout</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(cart_id)</span></span></span><span class="hljs-function">:</span></span> now = datetime.utcnow() <span class="hljs-comment"><span class="hljs-comment">#     &lt;code&gt;active&lt;/code&gt;    &lt;code&gt;pending&lt;/code&gt;. #           cart = db.cart.find_and_modify( {'_id': cart_id, 'status': 'active' }, update={'$set': { 'status': 'pending','last_modified': now } } ) if cart is None: raise CartInactive() #   ;  payment try: collect_payment(cart) db.cart.update( {'_id': cart_id }, {'$set': { 'status': 'complete' } } ) db.inventory.update( {'carted.cart_id': cart_id}, {'$pull': {'cart_id': cart_id} }, multi=True) except: db.cart.update( {'_id': cart_id }, {'$set': { 'status': 'active' } } ) raise</span></span></code> </pre><br>    ,   <code>pending</code> .        ,   . <br><ul><li>    ,    <code>cart_id</code>     <code>inventory</code> .     <code>complete</code> . </li><li>    ,   ,          . </li></ul><br><br> <em><font color="blue">   .</font></em> <br>            . <br>  <code>timeout</code>       . <br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">expire_carts</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(timeout)</span></span></span><span class="hljs-function">:</span></span> now = datetime.utcnow() threshold = now - timedelta(seconds=timeout) <span class="hljs-comment"><span class="hljs-comment">#       db.cart.update( {'status': 'active', 'last_modified': { '$lt': threshold } }, {'$set': { 'status': 'expiring' } }, multi=True ) #     for cart in db.cart.find({'status': 'expiring'}): #      for item in cart['items']: db.inventory.update( { '_id': item['sku'], 'carted.cart_id': cart['id'], 'carted.qty': item['qty'] }, {'$inc': { 'qty': item['qty'] }, '$pull': { 'carted': { 'cart_id': cart['id'] } } } ) db.cart.update( {'_id': cart['id'] }, {'$set': { 'status': 'expired' })</span></span></code> </pre><br><br>  : <br><ul><li>   ,    . </li><li>    ,        . </li><li>        ,    <code>expired</code> . </li></ul><br><br>     <code>status</code>  <code>last_modified</code> . <br><pre> <code class="python hljs">db.cart.ensure_index([(<span class="hljs-string"><span class="hljs-string">'status'</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>), (<span class="hljs-string"><span class="hljs-string">'last_modified'</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>)])</code> </pre><br><br> <em><font color="blue"> .</font></em> <br>       :      ,       <code>inventory</code> ,        ,     ,      . <br><br>    ,        <code>inventory</code>    <code>carted</code>                . <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">cleanup_inventory</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(timeout)</span></span></span><span class="hljs-function">:</span></span> now = datetime.utcnow() threshold = now - timedelta(seconds=timeout) <span class="hljs-comment"><span class="hljs-comment">#       for item in db.inventory.find( {'carted.timestamp': {'$lt': threshold }}): carted = dict( (carted_item['cart_id'], carted_item) for carted_item in item['carted'] if carted_item['timestamp'] &lt; threshold ) #  :       carted,     inventory for cart in db.cart.find( { '_id': {'$in': carted.keys() }, 'status':'active'}): cart = carted[cart['_id']] db.inventory.update( {'_id': item['_id'], 'carted.cart_id':cart['_id'] }, { '$set': {'carted.$.timestamp':now }} ) del carted[cart['_id']] #  :  carted        . for cart_id, carted_item in carted.items(): db.inventory.update( { '_id': item['_id'], 'carted.cart_id': cart_id, 'carted.qty': carted_item['qty'] }, { '$inc': { 'qty': carted_item['qty'] }, '$pull': { 'carted': { 'cart_id': cart_id } } } )</span></span></code> </pre><br><br>       ¬´carted¬ª ,     ,   <code>timeout</code> .        : <br><ul><li>       <code>timeout</code> ,   - ,  . </li><li>  ,      ,    . </li></ul><br><br> <em><font color="blue"></font></em> <br>      ,     <code>shard key</code>  <code>_id</code> ,        <code>_id</code> . <br>   <code>mongos</code>       <code>_id</code>    <code>mongod</code> . <br><br>       <code>_id</code>   <code>shard key</code> . <br><br>  <code>_id</code>   <code>cart</code>  ,        . <br><br>     ,      ,    ( MD5  SHA-1)   ObjectID,  _id. <br>    : <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> hashlib <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> bson cart_id = bson.ObjectId() cart_id_hash = hashlib.md5(str(cart_id)).hexdigest() cart = { <span class="hljs-string"><span class="hljs-string">"_id"</span></span>: cart_id, <span class="hljs-string"><span class="hljs-string">"cart_hash"</span></span>: cart_id_hash } db.cart.insert(cart)</code> </pre><br>      ,        ,  <code>_id</code>   <code>shard key</code> . <br><br>      ,     ,      (   <code>Sleep ()</code> ),     . <br><br>     Python/PyMongo   : <br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">&gt;&gt;&gt; </span></span>db.command(<span class="hljs-string"><span class="hljs-string">'shardCollection'</span></span>, <span class="hljs-string"><span class="hljs-string">'inventory'</span></span>, <span class="hljs-string"><span class="hljs-string">'key'</span></span>: { <span class="hljs-string"><span class="hljs-string">'_id'</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span> } ) { <span class="hljs-string"><span class="hljs-string">"collectionsharded"</span></span> : <span class="hljs-string"><span class="hljs-string">"inventory"</span></span>, <span class="hljs-string"><span class="hljs-string">"ok"</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span> } &gt;&gt;&gt; db.command(<span class="hljs-string"><span class="hljs-string">'shardCollection'</span></span>, <span class="hljs-string"><span class="hljs-string">'cart'</span></span>, <span class="hljs-string"><span class="hljs-string">'key'</span></span>: { <span class="hljs-string"><span class="hljs-string">'_id'</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span> } ) { <span class="hljs-string"><span class="hljs-string">"collectionsharded"</span></span> : <span class="hljs-string"><span class="hljs-string">"cart"</span></span>, <span class="hljs-string"><span class="hljs-string">"ok"</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span> }</code> </pre><br><br></h4><h3><a name="4"></a> <font color="green"> </font> </h3><br><br>      .               . <br>      : <br><br><img src="http://docs.mongodb.org/ecosystem/_images/use-cases-category1.png"><br>       ,          ,     . <br><br>     : <br><ul><li>        </li><li> <code>Objectid</code>        . </li><li>            URL-. </li><li>       ,         . </li></ul><br><br>   : <br><pre> <code class="python hljs">{ <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : ObjectId(<span class="hljs-string"><span class="hljs-string">"4f5ec858eb03303a11000002"</span></span>), <span class="hljs-string"><span class="hljs-string">"name"</span></span> : <span class="hljs-string"><span class="hljs-string">"Modal Jazz"</span></span>, <span class="hljs-string"><span class="hljs-string">"parent"</span></span> : ObjectId(<span class="hljs-string"><span class="hljs-string">"4f5ec858eb03303a11000001"</span></span>), <span class="hljs-string"><span class="hljs-string">"slug"</span></span> : <span class="hljs-string"><span class="hljs-string">"modal-jazz"</span></span>, <span class="hljs-string"><span class="hljs-string">"ancestors"</span></span> : [ { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : ObjectId(<span class="hljs-string"><span class="hljs-string">"4f5ec858eb03303a11000001"</span></span>), <span class="hljs-string"><span class="hljs-string">"slug"</span></span> : <span class="hljs-string"><span class="hljs-string">"bop"</span></span>, <span class="hljs-string"><span class="hljs-string">"name"</span></span> : <span class="hljs-string"><span class="hljs-string">"Bop"</span></span> }, { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : ObjectId(<span class="hljs-string"><span class="hljs-string">"4f5ec858eb03303a11000000"</span></span>), <span class="hljs-string"><span class="hljs-string">"slug"</span></span> : <span class="hljs-string"><span class="hljs-string">"ragtime"</span></span>, <span class="hljs-string"><span class="hljs-string">"name"</span></span> : <span class="hljs-string"><span class="hljs-string">"Ragtime"</span></span> } ] }</code> </pre><br><br>          ,     E-Commerce .     <code>Python/PyMongo</code> <br><br> <em><font color="blue">   </font></em> <br> . <br>         .       <code>slug</code>      <code>‚Äúbread crumb‚Äù</code> <br><br><pre> <code class="python hljs">category = db.categories.find({<span class="hljs-string"><span class="hljs-string">'slug'</span></span>:slug}, {<span class="hljs-string"><span class="hljs-string">'_id'</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">'name'</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">'ancestors.slug'</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">'ancestors.name'</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span> })</code> </pre><br>      <code>slug</code> . <br><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">&gt;&gt;&gt; </span></span>db.categories.ensure_index(<span class="hljs-string"><span class="hljs-string">'slug'</span></span>, unique=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>)</code> </pre><br> <em><font color="blue"> </font></em> <br>   ,     .    - <code>Swing</code>     <code>Ragtime</code> ,    : <br><img src="http://docs.mongodb.org/ecosystem/_images/use-cases-category2.png"><br><br>     ,   .     ,   : <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">build_ancestors</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(_id, parent_id)</span></span></span><span class="hljs-function">:</span></span> parent = db.categories.find_one({<span class="hljs-string"><span class="hljs-string">'_id'</span></span>: parent_id}, {<span class="hljs-string"><span class="hljs-string">'name'</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">'slug'</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">'ancestors'</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span>}) parent_ancestors = parent.pop(<span class="hljs-string"><span class="hljs-string">'ancestors'</span></span>) ancestors = [ parent ] + parent_ancestors db.categories.update({<span class="hljs-string"><span class="hljs-string">'_id'</span></span>: _id}, {<span class="hljs-string"><span class="hljs-string">'$set'</span></span>: { <span class="hljs-string"><span class="hljs-string">'ancestors'</span></span>: ancestors } })</code> </pre><br>              <code>Ragtime</code> ,        <code>Swing</code> . <br>        : <br><br><pre> <code class="python hljs">doc = dict(name=<span class="hljs-string"><span class="hljs-string">'Swing'</span></span>, slug=<span class="hljs-string"><span class="hljs-string">'swing'</span></span>, parent=ragtime_id) swing_id = db.categories.insert(doc) build_ancestors(swing_id, ragtime_id)</code> </pre><br>            <code>_id</code> <br><br> <em><font color="blue">   </font></em> <br>       ,   <code>bop</code>   <code>swing</code> . <br><img src="http://docs.mongodb.org/ecosystem/_images/use-cases-category3.png"><br><br>   <code>bop</code>    : <br><pre> <code class="python hljs">db.categories.update({<span class="hljs-string"><span class="hljs-string">'_id'</span></span>:bop_id}, {<span class="hljs-string"><span class="hljs-string">'$set'</span></span>: { <span class="hljs-string"><span class="hljs-string">'parent'</span></span>: swing_id } } )</code> </pre><br>       . <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">build_ancestors_full</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(_id, parent_id)</span></span></span><span class="hljs-function">:</span></span> ancestors = [] <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> parent_id <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-keyword"><span class="hljs-keyword">None</span></span>: parent = db.categories.find_one({<span class="hljs-string"><span class="hljs-string">'_id'</span></span>: parent_id}, {<span class="hljs-string"><span class="hljs-string">'parent'</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">'name'</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">'slug'</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">'ancestors'</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span>}) parent_id = parent.pop(<span class="hljs-string"><span class="hljs-string">'parent'</span></span>) ancestors.append(parent) db.categories.update({<span class="hljs-string"><span class="hljs-string">'_id'</span></span>: _id}, {<span class="hljs-string"><span class="hljs-string">'$set'</span></span>: { <span class="hljs-string"><span class="hljs-string">'ancestors'</span></span>: ancestors } })</code> </pre><br>         <code>bop</code> <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> cat <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> db.categories.find({<span class="hljs-string"><span class="hljs-string">'ancestors._id'</span></span>: bop_id}, {<span class="hljs-string"><span class="hljs-string">'parent'</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>}): build_ancestors_full(cat[<span class="hljs-string"><span class="hljs-string">'_id'</span></span>], cat[<span class="hljs-string"><span class="hljs-string">'parent'</span></span>])</code> </pre><br>     <code>ancestors._id</code>     . <br><br><pre> <code class="python hljs">db.categories.ensure_index(<span class="hljs-string"><span class="hljs-string">'ancestors._id'</span></span>)</code> </pre><br><br> <em><font color="blue"> </font></em> <br>            . <br>    ‚ÄúBop‚Äù  ‚ÄúBeBop‚Äù     : <br><img src="http://docs.mongodb.org/ecosystem/_images/use-cases-category4.png"><br>    ‚Äî    : <br><br><pre> <code class="python hljs">db.categories.update({<span class="hljs-string"><span class="hljs-string">'_id'</span></span>:bop_id}, {<span class="hljs-string"><span class="hljs-string">'$set'</span></span>: { <span class="hljs-string"><span class="hljs-string">'name'</span></span>: <span class="hljs-string"><span class="hljs-string">'BeBop'</span></span> } })</code> </pre><br>        : <br><br><pre> <code class="python hljs">db.categories.update({<span class="hljs-string"><span class="hljs-string">'ancestors._id'</span></span>: bop_id}, {<span class="hljs-string"><span class="hljs-string">'$set'</span></span>: { <span class="hljs-string"><span class="hljs-string">'ancestors.$.name'</span></span>: <span class="hljs-string"><span class="hljs-string">'BeBop'</span></span> } }, multi=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>)</code> </pre><br>   : <br><ul><li>   $         <code>_id</code> . </li><li>  <code>multi</code>          . </li></ul><br>         <code>ancestors._id</code> . <br><br> <em><font color="blue"></font></em> <br><br>         ,       .      <code>shard key</code>   <code>_id</code> . <br><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">&gt;&gt;&gt; </span></span>db.command(<span class="hljs-string"><span class="hljs-string">'shardCollection'</span></span>, <span class="hljs-string"><span class="hljs-string">'categories'</span></span>, { <span class="hljs-string"><span class="hljs-string">'key'</span></span>: {<span class="hljs-string"><span class="hljs-string">'_id'</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>} }) { <span class="hljs-string"><span class="hljs-string">"collectionsharded"</span></span> : <span class="hljs-string"><span class="hljs-string">"categories"</span></span>, <span class="hljs-string"><span class="hljs-string">"ok"</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span> }</code> </pre><br><br>  PS Request for grammatical errors and translation errors to write to the PM. <br><br>  Materials used: <br><br> <a href="http://docs.mongodb.org/ecosystem/">  MongoDB</a> <br> <a href="http://docs.mongodb.org/manual/reference/operator/aggregation/">    aggregation framework</a> <br> <a href="http://habrahabr.ru/post/217393/">    </a> <br> <a href="http://design-pattern.ru/"> ¬´ ¬ª (ru)</a> </div><p>Source: <a href="https://habr.com/ru/post/260291/">https://habr.com/ru/post/260291/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../260277/index.html">That the site did not fall: an economical method</a></li>
<li><a href="../260279/index.html">Do we really need start-ups for large corporations</a></li>
<li><a href="../260285/index.html">Analysis of the tasks of the qualifying round of RCC 2015</a></li>
<li><a href="../260287/index.html">Are you ready to complain?</a></li>
<li><a href="../260289/index.html">LabVIEW Programming Contest. The decision of the winning team</a></li>
<li><a href="../260295/index.html">Jii: Full Query Builder for Node.js with API from Yii 2</a></li>
<li><a href="../260297/index.html">Accelerate MySQL insert / update 5-10 times</a></li>
<li><a href="../260301/index.html">Buying in the online store: work on the bugs</a></li>
<li><a href="../260303/index.html">The hijacking of Telecom Malaysia trunk provider noticeably worsened global routing last Friday.</a></li>
<li><a href="../260309/index.html">New panels and connections for Kubotronika</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>