<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Parsing telegram channels for content aggregator in PHP</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi, Habr! 

 A few years ago, I started developing my own content aggregator to simplify my surfing on the net. Initially, I only parsed rss, vk and f...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Parsing telegram channels for content aggregator in PHP</h1><div class="post__text post__text-html js-mediator-article">  Hi, Habr! <br><br>  A few years ago, I started developing my own content aggregator to simplify my surfing on the net.  Initially, I only parsed rss, vk and facebook, but last year I decided to do a full refactoring of the project: abandon parsing on the client, make a normal back-end, use the database to store data and expand the list of supported resources. <br><br>  In addition to the standard set of rss, fb, vk, twitter, instagram, youtube, I added support for arbitrary open channels from the telegram. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/819/7f7/e0c/8197f7e0c6d46eaf9b262f6a0c4a4d8d.jpg" alt="image"></div><br>  Under the cat step by step instructions on how to parse any channels in a telegram <s>without registering and SMS</s> . <br><a name="habracut"></a><br>  Initially, I assumed that parsing channels is possible through the popular BotApi, for which there were many instructions on the network.  But it turned out that in order for a bot to read a channel, a bot must be added to this channel.  For third-party channels, this option is not possible.  I switched to reading manuals on the main API of the telegram. <br><br>  After 30 minutes of studying the documentation, I was desperate.  All data from the telegram is encrypted, in order to get something from their servers you need to have a master's degree in cryptography ... And instead of http requests, you use a socket that I haven‚Äôt previously encountered.  In general, pure hardcore and no clear examples on the network ... It was almost a fiasco. <br><br>  The last hope was to find some ready-made solution.  And then, finally, luck smiled at me.  On the telegram site, I came across a link to an unofficial opensource php client.  Yes Yes!  You can use a telegram for php, and there even support calls!  This miracle is called <a href="https://github.com/danog/MadelineProto">madelineProto</a> .  It can connect to servers using cryptographic magic and give me the data I need in the form of a normal, human associative array. <br><br>  I started setting up a php client. <br><br>  <b>1. Register your customer.</b> <br><br>  Unfortunately, at the beginning of the post I deceived you and we will still need registration and SMS authorization in the telegraph ... <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/c68/87f/1f7/c6887f1f7112f7a52707051a9d11c57c.gif" alt="image"></div><br>  If you already have an account in the telegram, it remains to register your application / client and get the keys for access to the telegram servers. <br><br>  This is a standard procedure, similar to the similar in social.  networks to access the API.  <a href="https://core.telegram.org/api/obtaining_api_id">Instructions for creating your keys.</a> <br><br>  After registering a client, we only need ‚ÄúApp api_id‚Äù and ‚ÄúApp api_hash‚Äù from the page <a href="https://my.telegram.org/apps">my.telegram.org/apps</a> <br><br>  <b>2. Installing madelineProto.</b> <br><br>  It requires php7 to work, but the Readme says that there is a way to run on php5.6. <br><br>  With the launch of MacOs with php7 from the Mamp package, and a simple hosting for 150 rubles per month, there were no problems. <br><br>  The process is not tricky: download the release, install the dependencies through the composer and you can start the setup. <br><br>  To reduce the size, I removed the extra dependencies and left only danog, paragonie and phpseclib.  This did not affect the client‚Äôs work. <br><br>  <b>3. Set up madelineProto and first launch.</b> <br><br>  All examples on the use and configuration are described in the client repository, but I will provide my code with comments. <br><br>  First you need to start the client in the key generation mode. <br><br>  At this stage, you will need to authorize a new connection and enter the verification code that will come to the previously authorized telegram client.  It is necessary to run the code from the console, as in the process of the script operation it will be necessary to enter the authorization code.  In the case of restarting the script, the code will change. <br><br>  The number of authorizations that can be requested is limited.  If something does not work, it is not necessary to run the code many times in a row, otherwise Telegram will block sending confirmations for a day or more. <br><br>  I, unfortunately, learned about this feature the hard way.  Normal those.  There is no support for the telegram either, by the way, so in case of blocking you will have to wait :) <br><br><pre><code class="php hljs">set_time_limit(<span class="hljs-number"><span class="hljs-number">60</span></span>); <span class="hljs-comment"><span class="hljs-comment">//       60 ,           . require_once ROOT_DIR.'/libs/MadelineProto/vendor/autoload.php'; //   ,  -  . C        ReadMe   github. $settings = [ 'authorization' =&gt; [ 'default_temp_auth_key_expires_in' =&gt; 315576000, //   10 ,      . ], 'app_info' =&gt; [ //         https://my.telegram.org 'api_id' =&gt; XXXXX, 'api_hash' =&gt; XXXXXXXXXX ], 'logger' =&gt; [ //     'logger' =&gt; 3, //    echo 'logger_level' =&gt; 'FATAL ERROR', //    . ], 'max_tries' =&gt; [ //        .   ,          'query' =&gt; 5, 'authorization' =&gt; 5, 'response' =&gt; 5, ], 'updates' =&gt; [ //     ,         . 'handle_updates' =&gt; false, 'handle_old_updates' =&gt; false, ], ]; $MadelineProto = new \danog\MadelineProto\API($settings); $MadelineProto-&gt;phone_login(readline('Enter your phone number: ')); //      $authorization = $MadelineProto-&gt;complete_phone_login(readline('Enter the code you received: ')); //     ,     if ($authorization['_'] === 'account.noPassword') { throw new \danog\MadelineProto\Exception('2FA is enabled but no password is set!'); } if ($authorization['_'] === 'account.password') { $authorization = $MadelineProto-&gt;complete_2fa_login(readline('Please enter your password (hint '.$authorization['hint'].'): ')); //   ,     . } if ($authorization['_'] === 'account.needSignup') { $authorization = $MadelineProto-&gt;complete_signup(readline('Please enter your first name: '), readline('Please enter your last name (can be empty): ')); } $MadelineProto-&gt;session = 'session.madeline'; $MadelineProto-&gt;serialize(); //     ,       .</span></span></code> </pre> <br>  After successful authorization, the code above can be deleted, it is no longer required. <br><br>  In the root of the project, the file ‚Äúsession.madeline‚Äù will be created, in which, in binary form, the data of our session will be stored.  To change the client settings, you must either create a new session, or try to edit this file in a binary editor.  Taking into account the fact that the number of authorization attempts per day at the telegram is limited, I recommend that you select the settings wisely so that you would not have to change them often. <br><br>  Now we can use fast resumption of the session, so we are writing a new code. <br><br>  <b>4. Getting posts from an arbitrary open telegram channel.</b> <br><br>  Resuming a session works pretty quickly.  It takes me 2-4 seconds to get data, so we no longer need set_time_limit. <br><br><pre> <code class="php hljs"> <span class="hljs-keyword"><span class="hljs-keyword">require_once</span></span> ROOT_DIR.<span class="hljs-string"><span class="hljs-string">'/libs/MadelineProto/vendor/autoload.php'</span></span>; $MadelineProto = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> \danog\MadelineProto\API(<span class="hljs-string"><span class="hljs-string">'session.madeline'</span></span>); $settings = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'peer'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'@'</span></span>.$val[<span class="hljs-string"><span class="hljs-string">'url'</span></span>], <span class="hljs-comment"><span class="hljs-comment">//_,    @,  @breakingmash,   ,  limit,    0 'offset_id' =&gt; $val['offset_id']?:0, 'offset_date' =&gt; $val['offset_date']?:0, 'add_offset' =&gt; $val['add_offset']?:0, 'limit' =&gt; $val['limit']?:10, // ,    'max_id' =&gt; $val['max_id']?:0, // id  'min_id' =&gt; $val['min_id']?:0, // id  -   ,  0   . 'hash' =&gt; 0 ); $data = $MadelineProto-&gt;messages-&gt;getHistory($settings);</span></span></code> </pre><br>  Since I update many channels at once, it makes sense to use one and the same session, and not to spend 2 seconds on each channel. <br><br>  The final code is as follows: <br><br><pre> <code class="php hljs"> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!is_array($url)){ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mb_strpos($url,<span class="hljs-string"><span class="hljs-string">','</span></span>)!==<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>){ $url = explode(<span class="hljs-string"><span class="hljs-string">','</span></span>,$url); }<span class="hljs-keyword"><span class="hljs-keyword">else</span></span>{ $url = [$url]; } } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>($url)) { <span class="hljs-keyword"><span class="hljs-keyword">require_once</span></span> ROOT_DIR.<span class="hljs-string"><span class="hljs-string">'/libs/MadelineProto/vendor/autoload.php'</span></span>; $file_contents = []; <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($url <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $val){ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!is_array($val)){ $val = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'url'</span></span> =&gt; $val ); } $settings = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'peer'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'@'</span></span>.$val[<span class="hljs-string"><span class="hljs-string">'url'</span></span>], <span class="hljs-string"><span class="hljs-string">'offset_id'</span></span> =&gt; $val[<span class="hljs-string"><span class="hljs-string">'offset_id'</span></span>]?:<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">'offset_date'</span></span> =&gt; $val[<span class="hljs-string"><span class="hljs-string">'offset_date'</span></span>]?:<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">'add_offset'</span></span> =&gt; $val[<span class="hljs-string"><span class="hljs-string">'add_offset'</span></span>]?:<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">'limit'</span></span> =&gt; $val[<span class="hljs-string"><span class="hljs-string">'limit'</span></span>]?:<span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-string"><span class="hljs-string">'max_id'</span></span> =&gt; $val[<span class="hljs-string"><span class="hljs-string">'max_id'</span></span>]?:<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">'min_id'</span></span> =&gt; $val[<span class="hljs-string"><span class="hljs-string">'min_id'</span></span>]?:<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">'hash'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">0</span></span> ); $file_contents[$val[<span class="hljs-string"><span class="hljs-string">'url'</span></span>]] = $MadelineProto-&gt;messages-&gt;getHistory($settings); } }</code> </pre><br>  After execution, we get an array with the number of messages / posts we need, divided by channels.  Also transmitted data about media investments. <br><br>  It remains to save the text of the post, if there is a photo / video, get a preview and a caption to the media file and create a link to view the post. <br><br>  <b>4. Getting media investments.</b> <br><br>  Fortunately, recently, telegram has introduced html previews of posts, so you can not save binary data received from the client to your server, but simply take a link to the photo and video stored on the telegram servers. <br><br>  By the name of the channel and the post id, we form a link of the format: <a href="https://t.me/%25D0%259D%25D0%2590%25D0%2597%25D0%2592%25D0%2590%25D0%259D%25D0%2598%25D0%2595_%25D0%259A%25D0%2590%25D0%259D%25D0%2590%25D0%259B%25D0%2590/ID_%25D0%259F%25D0%259E%25D0%25A1%25D0%25A2%25D0%2590%3Fembed%3D1">t.me/KNAME_CHANNEL/ID_POSTA?embed=1</a> , for example <a href="https://t.me/breakingmash/4193%3Fembed%3D1">t.me/breakingmash/4193?embed=1</a> <br><br>  Well, then everything is simple: <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">telegram_media_parse</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($posts_data, $source)</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">include_once</span></span>(ROOT_DIR.<span class="hljs-string"><span class="hljs-string">'/libs/phpQuery.php'</span></span>); <span class="hljs-comment"><span class="hljs-comment">//  html       phpQuery foreach ($posts_data as &amp;$post_data) { if (!empty($post_data['media'])){ $file_contents = self::loader($post_data['post_url'],'site');// curl  html   . $document = phpQuery::newDocumentHTML($file_contents); // dom-  html  $post_data['post_image'] = preg_replace('/[\s\S]*background-image:[ ]*url\(["\']*([\s\S]*[^"\'])["\']*\)[\s\S]*/u','$1',$document-&gt;find($source['rules']['post_img_path'])-&gt;eq(0)-&gt;attr('style')); //    background-image . $post_data['post_description'] = $document-&gt;find($source['rules']['post_text_path'])-&gt;eq(0)-&gt;text(); // caption . } unset($post_data['media']); } unset($post_data); return $posts_data; }</span></span></code> </pre><br>  At this parsing is completed and you can save posts in the database or display on the page. <br><br>  I hope that my first post will be useful to someone.  I don‚Äôt leave a link to my aggregator, as I‚Äôm not sure if this is allowed. </div><p>Source: <a href="https://habr.com/ru/post/349942/">https://habr.com/ru/post/349942/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../349930/index.html">The digest of fresh materials from the world of the frontend for the last week ‚Ññ303 (February 19 - 25, 2018)</a></li>
<li><a href="../349932/index.html">Business, let's go ...</a></li>
<li><a href="../349934/index.html">Richard Hamming: Chapter 8. Artificial Intelligence-III</a></li>
<li><a href="../349936/index.html">Richard Hamming: Chapter 3. The History of Computers - Iron</a></li>
<li><a href="../349940/index.html">Kubernetes success stories in production. Part 8: Huawei</a></li>
<li><a href="../349944/index.html">List.of () and everything, everything, everything ...</a></li>
<li><a href="../349946/index.html">Confession of a product manager</a></li>
<li><a href="../349948/index.html">Dismissal for keeping pornography on the computer: the European Court found no violation</a></li>
<li><a href="../349950/index.html">Making holes in torrents freeing up space and remaining on hand (part 1)</a></li>
<li><a href="../349954/index.html">‚ÄúProfit is great. We got a lot of freedoms that we didn‚Äôt have before, ‚Äù- Vladimir Plizga about microservices</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>