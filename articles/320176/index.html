<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Bitcoin in a nutshell - Blockchain</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Blockchain is the technology on which Bitcoin is built. And if a couple of years ago, all the fame came to cryptocurrency, then today you can hear mor...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Bitcoin in a nutshell - Blockchain</h1><div class="post__text post__text-html js-mediator-article"><p>  Blockchain is the technology on which Bitcoin is built.  And if a couple of years ago, all the fame came to cryptocurrency, then today you can hear more and more bold <a href="https://medium.com/%40L4yuan/forget-bitcoin-long-live-blockchain-5d4b55efce0b">phrases</a> like: "Forget Bitcoin, Long Live Blockchain".  Platforms like Ethereum, IPFS or Overstock are actively developing. They consider the blockchain not as a tool to create another payment system, but as a completely separate technology, comparable in its innovativeness to the Internet. </p><br><p>  In this chapter, I will tell you what the Bitcoin blockchain is.  Even compared to Ethereum, this is a terrible anachronism, but an understanding of the principles of its work will help you greatly if you decide to deal with more complex projects. </p><br><p><img src="https://habrastorage.org/files/4c3/e00/72e/4c3e0072ec6946be9d24307de5a0fcf8.png" alt="meme"></p><a name="habracut"></a><br><h2 id="book">  Book </h2><br><ul><li>  <a href="https://habrahabr.ru/post/319868/">Bitcoin in a nutshell - Cryptography</a> </li><li>  <a href="https://habrahabr.ru/post/319860/">Bitcoin in a nutshell - Transaction</a> </li><li>  <a href="https://habrahabr.ru/post/319862/">Bitcoin in a nutshell - Protocol</a> </li><li>  Bitcoin in a nutshell - Blockchain </li><li>  <a href="https://habrahabr.ru/post/320178/">Bitcoin in a nutshell - Mining</a> </li></ul><br><h2 id="table-of-content">  Table of content </h2><br><ol><li>  Blockchain for dummies </li><li>  Structure </li><li>  Merkle tree </li><li>  Timestamp </li><li>  Raw block </li><li>  Links </li></ol><br><h2 id="blockchain-for-dummies">  Blockchain for dummies </h2><br><p>  The blockchain itself is an extremely simple thing.  It is easiest to illustrate using the example of an accounting book in which all transactions in the Bitcoin network are recorded.  Moreover, such a book is present for each member of the network, which means that anyone, if desired, can check whether this or that transaction was real or not. </p><br><p><img src="https://habrastorage.org/files/b9c/1bc/431/b9c1bc4313134516b013416338c7242c.png" alt="Public ledger"></p><br><p>  And if the whole blockchain is a book, then individual blocks can be represented as pages on which transactions are recorded.  Each block "refers" to the previous one and so on until the very first block ( <em>genesis block</em> ).  This is what creates such an interesting feature of the blockchain as immutability.  It is impossible to take and change the block # 123 so that no one noticed.  Because the blockchain is designed in such a way that it will change the block # 124, then # 125 and so on, to the very top. </p><br><h2 id="structure">  Structure </h2><br><p>  With a familiar hand movement we open <a href="https://en.bitcoin.it/wiki/Protocol_documentation">the protocol specification</a> and look at the block structure. </p><br><p><img src="https://habrastorage.org/files/0e5/0d3/059/0e50d30597f942e7abc2083edfc4eecb.png"></p><br><ul><li>  <em>version</em> - block <a href="https://bitcoin.org/en/developer-reference">version</a> </li><li>  <em>prev_block</em> - <em>parent block</em> hash </li><li>  <em>merkle_root</em> - if simplified, then this is a hash of all transactions in the block </li><li>  timestamp - date and time of block creation </li><li>  <em>bits</em> , <em>nonce</em> - I will tell you about these parameters in detail in the chapter <a href="https://habrahabr.ru/post/320178/">Bitcoin in a nutshell - Mining</a> </li><li>  <em>txn_count</em> , <em>txns</em> - the number of transactions in the block and their list </li></ul><br><p>  The first six parameters (all but <em>txn_count</em> and <em>txns</em> ) form the header of the block ( <em>header</em> ).  It is the hash of the header that is called the block hash, that is, the transactions themselves are not directly involved in hashing. </p><br><p>  Instead, they are entered into a special structure - the <em>Merkle tree</em> , which I will discuss below. </p><br><h2 id="merkle-tree">  Merkle tree </h2><br><h3 id="technical-side">  Technical side </h3><br><p><img src="https://habrastorage.org/files/8ec/cb8/821/8eccb882196f45389740f659319a2c0e.jpg" alt="merkle"></p><br><p>  A merkle tree is a data structure, also known as a binary hash tree.  In the case of Bitcoin, it is structured as follows: </p><br><ol><li><p> First, the hashes of all transactions in the <code>hash_A = SHA256(SHA256(A))</code> block are <code>hash_A = SHA256(SHA256(A))</code> </p><br></li><li><p>  Then the hashes of the transaction hashes amount <code>hash_AB = SHA256(SHA256(hash_A + hash_B))</code> </p><br></li><li><p>  Similarly, we consider hashes of the sum of the resulting hashes <code>hash_ABCD = SHA256(SHA256(hash_AB + hash_CD))</code> and further along the recursion.  Lyrical digression - since the tree is binary, then at each step there must be an even number of elements.  Therefore, if, for example, we have only three transactions, then the last transaction is simply duplicated: </p><br><p><img src="https://habrastorage.org/files/ac2/046/7d3/ac20467d3f424f2292ea0a2cdb10875a.png" alt="Double txn"></p><br></li><li>  The process continues until a single hash is obtained - it is called <em>merkle_root</em> (the third field in the <em>header of the</em> block) </li></ol><br><p>  Below is the implementation of the Merkle tree, you can check it on any block. </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> hashlib <span class="hljs-comment"><span class="hljs-comment"># Hash pairs of items recursively until a single value is obtained def merkle(hashList): if len(hashList) == 1: return hashList[0] newHashList = [] # Process pairs. For odd length, the last is skipped for i in range(0, len(hashList)-1, 2): newHashList.append(hash2(hashList[i], hashList[i+1])) if len(hashList) % 2 == 1: # odd, hash last item twice newHashList.append(hash2(hashList[-1], hashList[-1])) return merkle(newHashList) def hash2(a, b): # Reverse inputs before and after hashing # due to big-endian / little-endian nonsense a1 = a.decode('hex')[::-1] b1 = b.decode('hex')[::-1] h = hashlib.sha256(hashlib.sha256(a1 + b1).digest()).digest() return h[::-1].encode('hex')</span></span></code> </pre> <br><h3 id="immutability">  Immutability </h3><br><p><img src="http://www.reactiongifs.com/r/jonw.gif"></p><br><p>  Now about why this is needed in Bitcoin.  I think you understand that if you change at least one transaction, then <em>merkle_root</em> will also change.  Therefore, such a data structure allows to ensure that transactions are not "workable" in a block.  That is, the following situation cannot happen: </p><br><blockquote>  Some of the miners found a new unit and began to scatter it over the network.  At this time, the attacker intercepts the block and, for example, deletes any transaction from the block, after which it distributes the already changed block. </blockquote><p>  For verification, it is enough to count the <em>merkle_root</em> yourself and compare it with what is written in the <em>header of the</em> block. </p><br><h3 id="spv">  SPV </h3><br><p>  But here it is reasonable to argue that, first, such difficulties are completely useless.  It is enough just to count the hash of the sum of all transactions in the <code>txns_hash = SHA256(SHA256(sum(txns)))</code> ‚Äî it will also change after any manipulations with transactions.  And, secondly, what prevents the attacker to replace the <em>merkle_root</em> in the block?  I will answer the second question right away: in fact, nothing can be changed in the block at all, because the block will immediately become invalid (you will understand this after reading the next chapter of <a href="https://habrahabr.ru/post/320178/">Bitcoin in a nutshell - Mining</a> ). </p><br><p>  And the Merkle tree is actually needed in order to be able to create <em>SPV</em> nodes (Simplified Payment Verification).  Such nodes synchronize only block headers, without the transactions themselves.  As a result, the blockchain takes up less space (for beauty we take the height of 500.000 blocks, the size of the header is fixed - 80 bytes): </p><br><blockquote>  500.000 * 80/1024/1024 ‚âà 40 MB </blockquote><p>  Such a blockchain can already easily fit on a phone, tablet or some IoT.  What in the future should give greater decentralization, network security and so on. </p><br><p>  The essence of <em>simplified payment verification is</em> as follows: let you have an <em>SPV</em> node.  I have the entire blockchain entirely and I need to convince you that some transaction really was (in the picture this is transaction <em>K</em> ).  In this case, I just need to provide you with a few hashes: <code>H_L, H_IJ, H_MNOP, H_ABCDEFGH</code> , they are also called the <em>authentication path</em> . </p><br><p><img src="http://orm-chimera-prod.s3.amazonaws.com/1234000001802/images/msbt_0705.png" alt="Auth path"></p><br><p>  After that, you first consider <code>H_K = SHA256(SHA256(K))</code> , then <code>H_KL = SHA256(SHA256(H_K + H_L))</code> and so on to the very top.  If in the end you find a block with the same <em>merkle_root</em> , then the fact of the existence of a transaction is considered confirmed. </p><br><p>  <strong>BTW</strong> Ralph Merkle even patented his data structure, as evidenced by patent <a href="http://www.google.com/patents/US4309569">US4309569 A.</a> </p><br><h2 id="timestamp">  Timestamp </h2><br><p>  Another interesting question.  Imagine that a new block appeared somewhere on the network and the nodes start transmitting it to each other.  Each node should make sure that the block is correct.  For this, she: </p><br><ul><li>  checks syntax and block structure </li><li>  checks each transaction in a block for validity </li><li>  hashes transactions and compares <em>merkle root</em> </li><li>  checks several criteria related to mining, and so on </li></ul><br><p>  But how can I check the timestamp?  It is clear that the time on different computers may vary, so even if the new block has a timestamp different from your current time an hour ahead, this does not mean that the block is "wrong", maybe the miner simply hastens the clock. </p><br><p>  Therefore, to test the timestamp for validity, <a href="https://en.bitcoin.it/wiki/Block_timestamp">two criteria</a> were invented.  First, it must be greater than the arithmetic average timestamps of the previous 11 blocks.  This is done so that it does not happen that block # 123 was released on March 12, 2011, and # 124 - on February 13, 1984. But at the same time, some error is allowed. </p><br><p>  Secondly, the timestamp must be less than the <em>network adjusted time</em> .  That is, the node, when receiving a new block, is interested in the current time from its "neighbors" on the network, considers the arithmetic average and if the block timestamp is less than the resulting value + 2 hours, then everything is fine. </p><br><p>  <strong>BTW,</strong> as you can see, the timestamp of a new block may turn out to be even smaller than the timestamp of an earlier block.  This is not such a rarity, for example <a href="https://blockr.io/block/info/145045"># 145045</a> , <a href="https://blockr.io/block/info/145046"># 145046</a> and <a href="https://blockr.io/block/info/145047"># 145047</a> . </p><br><pre> <code class="hljs pgsql"><span class="hljs-number"><span class="hljs-number">145044</span></span>: <span class="hljs-number"><span class="hljs-number">2011</span></span><span class="hljs-number"><span class="hljs-number">-09</span></span><span class="hljs-number"><span class="hljs-number">-12</span></span> <span class="hljs-number"><span class="hljs-number">15</span></span>:<span class="hljs-number"><span class="hljs-number">46</span></span>:<span class="hljs-number"><span class="hljs-number">39</span></span> <span class="hljs-number"><span class="hljs-number">145045</span></span>: <span class="hljs-number"><span class="hljs-number">2011</span></span><span class="hljs-number"><span class="hljs-number">-09</span></span><span class="hljs-number"><span class="hljs-number">-12</span></span> <span class="hljs-number"><span class="hljs-number">16</span></span>:<span class="hljs-number"><span class="hljs-number">05</span></span>:<span class="hljs-number"><span class="hljs-number">07</span></span> <span class="hljs-number"><span class="hljs-number">145046</span></span>: <span class="hljs-number"><span class="hljs-number">2011</span></span><span class="hljs-number"><span class="hljs-number">-09</span></span><span class="hljs-number"><span class="hljs-number">-12</span></span> <span class="hljs-number"><span class="hljs-number">16</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">05</span></span> // ~<span class="hljs-number"><span class="hljs-number">5</span></span> minutes <span class="hljs-keyword"><span class="hljs-keyword">before</span></span> prior block <span class="hljs-number"><span class="hljs-number">145047</span></span>: <span class="hljs-number"><span class="hljs-number">2011</span></span><span class="hljs-number"><span class="hljs-number">-09</span></span><span class="hljs-number"><span class="hljs-number">-12</span></span> <span class="hljs-number"><span class="hljs-number">15</span></span>:<span class="hljs-number"><span class="hljs-number">53</span></span>:<span class="hljs-number"><span class="hljs-number">36</span></span> // ~<span class="hljs-number"><span class="hljs-number">7</span></span> &amp; ~<span class="hljs-number"><span class="hljs-number">12</span></span> minutes <span class="hljs-keyword"><span class="hljs-keyword">before</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> prior blocks <span class="hljs-number"><span class="hljs-number">145048</span></span>: <span class="hljs-number"><span class="hljs-number">2011</span></span><span class="hljs-number"><span class="hljs-number">-09</span></span><span class="hljs-number"><span class="hljs-number">-12</span></span> <span class="hljs-number"><span class="hljs-number">16</span></span>:<span class="hljs-number"><span class="hljs-number">04</span></span>:<span class="hljs-number"><span class="hljs-number">06</span></span> // <span class="hljs-keyword"><span class="hljs-keyword">after</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> prior blocks but still <span class="hljs-keyword"><span class="hljs-keyword">before</span></span> <span class="hljs-number"><span class="hljs-number">145045</span></span></code> </pre> <br><h2 id="raw-block">  Raw block </h2><br><p>  If you still have any questions about the structure of the block, then I suggest you look at them in a "raw" form.  The most obvious way to do this is to run <code>bitcoind --daemon</code> for a couple of hours, and then examine the already downloaded blocks.  But, first of all, not everyone has the time / desire to synchronize the blockchain.  Secondly, in Bitcoin blocks are stored in a very specific <a href="https://github.com/google/leveldb">LevelDB</a> database, also in a rather <a href="http://bitcoin.stackexchange.com/questions/28168/what-are-the-keys-used-in-the-blockchain-leveldb-ie-what-are-the-keyvalue-pair">strange way</a> .  And since the book is designed not only for experienced developers, I will go through the proven way and use the protocol again in its original form. </p><br><p>  To get the block, send the <a href="https://en.bitcoin.it/wiki/Protocol_documentation">getdata</a> message, in which we specify the <code>type : MSG_BLOCK</code> and <code>hash : 000000000003ba27aa200b1cecaad478d2b00432346c3f1f3986da1afd33e506</code> is the hash of the block <a href="https://blockr.io/block/info/100000"># 100.000</a> .  The entire code can be viewed <a href="https://github.com/pavlovdog/bitcoin_in_a_nutshell">here</a> . </p><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getdataMessage</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> block_hash = <span class="hljs-string"><span class="hljs-string">'000000000003ba27aa200b1cecaad478d2b00432346c3f1f3986da1afd33e506'</span></span> count = struct.pack(<span class="hljs-string"><span class="hljs-string">"&lt;B"</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>) inventory = struct.pack(<span class="hljs-string"><span class="hljs-string">"&lt;L"</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-comment"><span class="hljs-comment"># type : MSG_BLOCK inventory += block_hash.decode('hex')[::-1] return count + inventory</span></span></code> </pre> <br><p><img src="https://habrastorage.org/files/256/667/2a4/2566672a4baa470d9b4fabb429744b37.png" alt="Wireshark block"></p><br><h2 id="links">  Links </h2><br><ul><li>  <a href="http://chimera.labs.oreilly.com/books/1234000001802/ch07.html">Mastering Bitcoin - The Blockchain</a> </li><li>  <a href="">Documentation of the physical Bitcoin blockchain</a> </li><li>  <a href="http://bitcoin.stackexchange.com/questions/28168/what-are-the-keys-used-in-the-blockchain-leveldb-ie-what-are-the-keyvalue-pair">What are the keys used in the blockchain levelDB</a> </li><li>  <a href="https://github.com/bitcoin-core/leveldb/blob/bitcoin-fork/doc/table_format.txt">bitcoin-core / leveldb / doc / table_format.txt</a> </li><li>  <a href="https://impgun.wordpress.com/2015/11/22/merkling-in-ethereum/">Merkle Trees in Ethereum</a> </li></ul></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/320176/">https://habr.com/ru/post/320176/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../320164/index.html">Caution: HSTS</a></li>
<li><a href="../320166/index.html">The digest of fresh materials from the world of the frontend for the last week ‚Ññ246 (January 16 - 22, 2017)</a></li>
<li><a href="../320168/index.html">Depth: how to make a quality project without millions in your pocket and why you shouldn‚Äôt be afraid of ‚Äúlong-term construction projects‚Äù</a></li>
<li><a href="../320172/index.html">JSON API My Warehouse, self-learning</a></li>
<li><a href="../320174/index.html">Local python typographer - typus Œ≤</a></li>
<li><a href="../320178/index.html">Bitcoin in a nutshell - Mining</a></li>
<li><a href="../320180/index.html">JDK 9 development has completed the ‚ÄúFeature Complete‚Äù phase</a></li>
<li><a href="../320184/index.html">Automatic visualization of python code using flowcharts</a></li>
<li><a href="../320186/index.html">Selection of useful slides from Julia Evans</a></li>
<li><a href="../320188/index.html">Hey, tv, are you the smartest?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>