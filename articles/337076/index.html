<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Experience in the development of a high-loaded system within the HighLoad Cup</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Mail.Ru offered an interesting championship for backend developers: HighLoad Cup. Which allows not only to get good prizes, but also to raise your ski...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Experience in the development of a high-loaded system within the HighLoad Cup</h1><div class="post__text post__text-html js-mediator-article">  Mail.Ru offered an interesting championship for backend developers: HighLoad Cup.  Which allows not only to get good prizes, but also to raise your skill backend-developer.  About experience of development and environment setup it will be told under cat. <br><a name="habracut"></a><br><h3>  1. Input data </h3><br>  You need to write a fast server that will provide a web API for the travelers service. <br><br>  In the initial data for the server there are three types of entities: User (Traveler), Location (Visit), Visit (Visits).  Each has its own set of fields. <br><br>  You must implement the following queries: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre> GET / &lt;entity&gt; / &lt;id&gt; to get entity data
 GET / users / &lt;id&gt; / visits for getting a list of visits by user
 GET / locations / &lt;id&gt; / avg to get average sights
 POST / &lt;entity&gt; / &lt;id&gt; to update
 POST / &lt;entity&gt; / new to create
</pre><br>  The maximum penalty time for a request is equal to the timeout of the tank and is 2 seconds (2k microseconds). <br><br>  The solution should be in one docker container. <br>  Iron used for testing: Intel Xeon x86_64 2 GHz 4 cores, 4 GB RAM, 10 GB HDD. <br><br>  So, the task is essentially simple, but the knowledge in Docker is 0, the development experience under high load is around 50%. <br>  For writing, php7 + nginx + mysql was chosen because the experience gained could be used later in the work. <br><br><h3>  2. Docker </h3><br>  We will understand what a Docker. <br><blockquote>  Docker is an automation software for deploying and managing applications in a virtualization environment at the operating system level.  Allows you to "pack" the application with all its environments and dependencies into a container that can be transferred to any Linux system with cgroups support in the kernel, and also provides a container management environment. </blockquote>  It sounds just fine, if in brief, we do not need to configure nginx / php / apache locally for each project and not get additional dependencies on other projects.  For example, there is a site that is not compatible with php7, in order to work with it you need to switch the php module in apache2 to the correct version.  Everything is simple with the docker - we launch the container with the project and develop it.  We switched to another project, stop the current container and raise a new one. <br><br>  Docker ideology 1 process - 1 container.  That is, nginx with php in its container, mysql in its.  Docker-compose is used to combine and configure them. <br><br><div class="spoiler">  <b class="spoiler_title">Sample docker-compose.yml file</b> <div class="spoiler_text"><pre><code class="hljs 1c">version: '2' services: mysql: image: mysql:<span class="hljs-number"><span class="hljs-number">5.7</span></span> <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword"></span></span></span><span class="hljs-meta">   environment: MYSQL_ROOT_PASSWORD: 12345 # root  volumes: - ./db:/var/lib/mysql #      ports: - 3306:3306 #   - _: nginx: build: context: ./ dockerfile: Dockerfile # </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword"></span></span></span><span class="hljs-meta">   depends_on: [mysql] #  ports: - 80:80 volumes: - ./:/var/www/html #    ,     </span></span></code> </pre> <br></div></div><br>  Run: <br><br><pre> <code class="bash hljs">docker-compose -f docker-compose.yml up</code> </pre> <br>  Everything works, there is a connection.  We try to send for review the solution iiii read carefully the task - everything should be in 1 container.  And the container in turn works while the process running via the CMD or ENTRYPOINT command is alive.  Since we have several services, you need to use the process manager - supervisord. <br><br><div class="spoiler">  <b class="spoiler_title">Dockerfile configuration</b> <div class="spoiler_text"><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> ubuntu:<span class="hljs-number"><span class="hljs-number">17.10</span></span> RUN apt-<span class="hljs-keyword"><span class="hljs-keyword">get</span></span> <span class="hljs-keyword"><span class="hljs-keyword">update</span></span> &amp;&amp; apt-<span class="hljs-keyword"><span class="hljs-keyword">get</span></span> -y upgrade \ &amp;&amp; DEBIAN_FRONTEND=noninteractive apt-<span class="hljs-keyword"><span class="hljs-keyword">get</span></span> install -y mysql-<span class="hljs-keyword"><span class="hljs-keyword">server</span></span> mysql-client mysql-common \ &amp;&amp; rm -rf /var/lib/mysql &amp;&amp; mkdir -p /var/lib/mysql /var/run/mysqld \ &amp;&amp; chown -R mysql:mysql /var/lib/mysql /var/run/mysqld \ &amp;&amp; chmod <span class="hljs-number"><span class="hljs-number">777</span></span> /var/run/mysqld \ &amp;&amp; rm /etc/mysql/my.cnf \ &amp;&amp; apt-<span class="hljs-keyword"><span class="hljs-keyword">get</span></span> install -y curl supervisor nginx \ php7<span class="hljs-number"><span class="hljs-number">.1</span></span>-fpm php7<span class="hljs-number"><span class="hljs-number">.1</span></span>-<span class="hljs-type"><span class="hljs-type">json</span></span> \ php7<span class="hljs-number"><span class="hljs-number">.1</span></span>-mysql php7<span class="hljs-number"><span class="hljs-number">.1</span></span>-opcache \ php7<span class="hljs-number"><span class="hljs-number">.1</span></span>-zip <span class="hljs-keyword"><span class="hljs-keyword">ADD</span></span> ./config/mysqld.cnf /etc/mysql/my.cnf <span class="hljs-keyword"><span class="hljs-keyword">COPY</span></span> config/www.conf /etc/php/<span class="hljs-number"><span class="hljs-number">7.1</span></span>/fpm/pool.d/www.conf <span class="hljs-keyword"><span class="hljs-keyword">COPY</span></span> config/nginx.conf /etc/nginx/nginx.conf <span class="hljs-keyword"><span class="hljs-keyword">COPY</span></span> config/nginx-vhost.conf /etc/nginx/conf.d/<span class="hljs-keyword"><span class="hljs-keyword">default</span></span>.conf <span class="hljs-keyword"><span class="hljs-keyword">COPY</span></span> config/opcache.ini /etc/php/<span class="hljs-number"><span class="hljs-number">7.1</span></span>/mods-available/opcache.ini <span class="hljs-keyword"><span class="hljs-keyword">COPY</span></span> config/supervisord.conf /etc/supervisord.conf <span class="hljs-keyword"><span class="hljs-keyword">COPY</span></span> scripts/ /usr/<span class="hljs-keyword"><span class="hljs-keyword">local</span></span>/bin/ <span class="hljs-keyword"><span class="hljs-keyword">COPY</span></span> src /var/www/html #          # #RUN mkdir /tmp/data /tmp/db #<span class="hljs-keyword"><span class="hljs-keyword">COPY</span></span> data_full.zip /tmp/data/data.zip ENV PHP_MODULE_OPCACHE <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> ENV PHP_DISPLAY_ERRORS <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> RUN chmod <span class="hljs-number"><span class="hljs-number">755</span></span> /usr/<span class="hljs-keyword"><span class="hljs-keyword">local</span></span>/bin/docker-entrypoint.sh /usr/<span class="hljs-keyword"><span class="hljs-keyword">local</span></span>/bin/startup.sh RUN chmod +x /usr/<span class="hljs-keyword"><span class="hljs-keyword">local</span></span>/bin/docker-entrypoint.sh /usr/<span class="hljs-keyword"><span class="hljs-keyword">local</span></span>/bin/startup.sh WORKDIR /var/www/html RUN service php7<span class="hljs-number"><span class="hljs-number">.1</span></span>-fpm <span class="hljs-keyword"><span class="hljs-keyword">start</span></span> EXPOSE <span class="hljs-number"><span class="hljs-number">80</span></span> <span class="hljs-number"><span class="hljs-number">3306</span></span> CMD ["/usr/local/bin/docker-entrypoint.sh"]</code> </pre><br></div></div><br>  The CMD command ["/usr/local/bin/docker-entrypoint.sh"] makes a small environment configuration after starting the container and starting the process manager. <br><br><div class="spoiler">  <b class="spoiler_title">Process Manager Setup</b> <div class="spoiler_text"><pre> <code class="hljs ruby">[unix_http_server] file=<span class="hljs-regexp"><span class="hljs-regexp">/var/run</span></span><span class="hljs-regexp"><span class="hljs-regexp">/supervisor.sock [supervisord] logfile=/tmp</span></span><span class="hljs-regexp"><span class="hljs-regexp">/supervisord.log logfile_maxbytes=50MB logfile_backups=10 loglevel=info pidfile=/tmp</span></span><span class="hljs-regexp"><span class="hljs-regexp">/supervisord.pid nodaemon=false minfds=1024 minprocs=200 user=root [rpcinterface:supervisor] supervisor.rpcinterface_factory = supervisor.rpcinterface:make_main_rpcinterface [supervisorctl] serverurl=unix:/</span></span><span class="hljs-regexp"><span class="hljs-regexp">//var</span></span><span class="hljs-regexp"><span class="hljs-regexp">/run/supervisor</span></span>.sock [<span class="hljs-symbol"><span class="hljs-symbol">program:</span></span>php-fpm] command=<span class="hljs-regexp"><span class="hljs-regexp">/usr/sbin</span></span><span class="hljs-regexp"><span class="hljs-regexp">/php-fpm7.1 autostart=true autorestart=true priority=5 stdout_events_enabled=true stderr_events_enabled=true stdout_logfile=/dev</span></span><span class="hljs-regexp"><span class="hljs-regexp">/stdout stdout_logfile_maxbytes=0 stderr_logfile=/dev</span></span><span class="hljs-regexp"><span class="hljs-regexp">/stderr stderr_logfile_maxbytes=0 [program:nginx] command=/usr</span></span><span class="hljs-regexp"><span class="hljs-regexp">/sbin/nginx</span></span> -g <span class="hljs-string"><span class="hljs-string">"daemon off;"</span></span> autostart=<span class="hljs-literal"><span class="hljs-literal">true</span></span> autorestart=<span class="hljs-literal"><span class="hljs-literal">true</span></span> priority=<span class="hljs-number"><span class="hljs-number">10</span></span> stdout_events_enabled=<span class="hljs-literal"><span class="hljs-literal">true</span></span> stderr_events_enabled=<span class="hljs-literal"><span class="hljs-literal">true</span></span> stdout_logfile=<span class="hljs-regexp"><span class="hljs-regexp">/dev/stdout</span></span> stdout_logfile_maxbytes=<span class="hljs-number"><span class="hljs-number">0</span></span> stderr_logfile=<span class="hljs-regexp"><span class="hljs-regexp">/dev/stderr</span></span> stderr_logfile_maxbytes=<span class="hljs-number"><span class="hljs-number">0</span></span> [<span class="hljs-symbol"><span class="hljs-symbol">program:</span></span>mysql] command=mysqld_safe autostart=<span class="hljs-literal"><span class="hljs-literal">true</span></span> autorestart=<span class="hljs-literal"><span class="hljs-literal">true</span></span> priority=<span class="hljs-number"><span class="hljs-number">1</span></span> stdout_events_enabled=<span class="hljs-literal"><span class="hljs-literal">true</span></span> stderr_events_enabled=<span class="hljs-literal"><span class="hljs-literal">true</span></span> stdout_logfile=<span class="hljs-regexp"><span class="hljs-regexp">/dev/stdout</span></span> stdout_logfile_maxbytes=<span class="hljs-number"><span class="hljs-number">0</span></span> stderr_logfile=<span class="hljs-regexp"><span class="hljs-regexp">/dev/stderr</span></span> stderr_logfile_maxbytes=<span class="hljs-number"><span class="hljs-number">0</span></span> [<span class="hljs-symbol"><span class="hljs-symbol">program:</span></span>startup] command=<span class="hljs-regexp"><span class="hljs-regexp">/usr/local</span></span><span class="hljs-regexp"><span class="hljs-regexp">/bin/startup</span></span>.sh startretries=<span class="hljs-number"><span class="hljs-number">0</span></span> priority=<span class="hljs-number"><span class="hljs-number">1100</span></span> stdout_events_enabled=<span class="hljs-literal"><span class="hljs-literal">true</span></span> stderr_events_enabled=<span class="hljs-literal"><span class="hljs-literal">true</span></span> stdout_logfile=<span class="hljs-regexp"><span class="hljs-regexp">/dev/stdout</span></span> stdout_logfile_maxbytes=<span class="hljs-number"><span class="hljs-number">0</span></span> stderr_logfile=<span class="hljs-regexp"><span class="hljs-regexp">/dev/stderr</span></span> stderr_logfile_maxbytes=<span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre><br></div></div><br>  Using the priority parameter, you can change the startup sequence, and stdout_logfile / stderr_logfile allows you to display the logs of services in the container log.  The most recent startup.sh script runs, which contains the database filling with data from the archive. <br>  Now you can finally send your child to the first check.  Docker commands are similar to git, for sending we use: <br><br><pre> <code class="bash hljs">docker tag &lt; -&gt; stor.highloadcup.ru/travels/&lt; &gt; docker push stor.highloadcup.ru/travels/&lt; &gt;</code> </pre><br>  You can also register on the official website <a href="https://cloud.docker.com/">https://cloud.docker.com</a> and add the container there.  There you can set up an automatic assembly when updating a branch on github or bitbucket and continue to use the ready-made image in other projects as a basis. <br><br><h3>  3. Service development </h3><br>  To ensure high performance, it was decided to abandon all the frameworks and use bare php + pdo.  The framework, though much easier to develop, but pulls along a bunch of dependencies that use script execution time. <br>  The starting point will be the index.php script with routing requests and results (Router + Controller).  Using urls like: <br><br><pre> <code class="bash hljs">/&lt;entity&gt;/&lt;id&gt;</code> </pre> <br>  Itself involves the use of regulars to determine the route and parameters.  It is very flexible and makes it easy to expand the service.  But the option on if'ah was faster (Although there is a possibility of an error, why? Read below). <br><br><div class="spoiler">  <b class="spoiler_title">index.php</b> <div class="spoiler_text"><pre> <code class="php hljs">$uri = parse_url($_SERVER[<span class="hljs-string"><span class="hljs-string">'REQUEST_URI'</span></span>], PHP_URL_PATH); $routes = explode(<span class="hljs-string"><span class="hljs-string">'/'</span></span>, $uri); <span class="hljs-comment"><span class="hljs-comment">//    $entity = $routes[1] ?? 0; $id = $routes[2] ?? 0; $action = $routes[3] ?? 0; $className = __NAMESPACE__.'\\'.ucfirst($entity); if (!class_exists($className)) { //     header('HTTP/1.0 404 Not Found'); die(); } $db = new \PDO( 'mysql:dbname=travel;host=localhost;port=3306', 'root', null, [ \PDO::MYSQL_ATTR_INIT_COMMAND =&gt; 'SET NAMES \'UTF8\'', \PDO::ATTR_PERSISTENT =&gt; true ] ); //   /** @var \Travel\AbstractEntity $class */ $class = new $className($db); // POST  (/ ) if ($_SERVER['REQUEST_METHOD'] === 'POST') { if (isset($_SERVER['Content-Type'])) { //  json  $type = trim(explode(';', $_SERVER['Content-Type'])[0]); if ($type !== 'application/json') { header('HTTP/1.0 400 Bad Values'); die(); } } $inputJSON = file_get_contents('php://input'); $input = json_decode($inputJSON, true); // if ($input &amp;&amp; $class-&gt;checkFields($input, $id !== 'new')) { $itemId = (int)$id; if ($itemId &gt; 0 &amp;&amp; $class-&gt;hasItem($itemId)) { $class-&gt;update($input, $itemId); header('Content-Type: application/json; charset=utf-8'); header('Content-Length: 2'); echo '{}'; die(); } //   if ($id === 'new') { $class-&gt;insert($input); header('Content-Type: application/json; charset=utf-8'); header('Content-Length: 2'); echo '{}'; die(); } //    -  header('HTTP/1.0 404 Not Found'); die(); } //    header('HTTP/1.0 400 Bad Values'); die(); } // GET  if ((int)$id &gt; 0) { if (!$action) { //   ,    $res = $class-&gt;findById($id); if ($res) { $val = json_encode($class-&gt;hydrate($res)); header('Content-Type: application/json; charset=utf-8'); header('Content-Length: '.strlen($val)); echo $val; die(); } header('HTTP/1.0 404 Not Found'); die(); } //     $res = $class-&gt;hasItem($id); if (!$res) { header('HTTP/1.0 404 Not Found'); die(); } $filter = []; if (!empty($_GET)) { //  $filter = $class-&gt;getFilter($_GET); if (!$filter) { header('HTTP/1.0 400 Bad Values'); die(); } } header('Content-Type: application/json; charset=utf-8'); echo json_encode([$action =&gt; $class-&gt;{$action}($id, $filter)]); die(); } header('HTTP/1.0 404 Not Found'); die();</span></span></code> </pre><br></div></div><br>  It looks awkward, but it works quickly.  Next, the main class for processing data is AbstractEntity.  I will not bring it here, because everything is just corny here - insert / update / selection (all the source code can be viewed on <a href="https://github.com/Afinogen/highloadcup_travel">GiHub</a> ).  It already forms classes with entities.  For example, take the essence Users. <br><br>  <b>Filter</b> <br>  It checks data from the GET request for validity and forms a filter for the request in the database.  In the code below, there are no checks / filtering on injections, etc.  Do not repeat this <s>at home</s> in combat projects. <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getFilter</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(array $data)</span></span></span><span class="hljs-function"> </span></span>{ $columns = [ <span class="hljs-string"><span class="hljs-string">'fromDate'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'visited_at &gt; '</span></span>, <span class="hljs-string"><span class="hljs-string">'toDate'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'visited_at &lt; '</span></span>, <span class="hljs-string"><span class="hljs-string">'country'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'country = '</span></span>, <span class="hljs-string"><span class="hljs-string">'toDistance'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'distance &lt; '</span></span>, ]; $filter = []; <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($data <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $key =&gt; $datum) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>($columns[$key])) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (($key === <span class="hljs-string"><span class="hljs-string">'fromDate'</span></span> || $key === <span class="hljs-string"><span class="hljs-string">'toDate'</span></span> || $key === <span class="hljs-string"><span class="hljs-string">'toDistance'</span></span>) &amp;&amp; !is_numeric($datum)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } $filter[] = $columns[$key].<span class="hljs-string"><span class="hljs-string">"'"</span></span>.$datum.<span class="hljs-string"><span class="hljs-string">"'"</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $filter; }</code> </pre> <br>  <b>Getting places visited by the user</b> <br>  Places and ratings for a specific user are displayed, the filter obtained above can also be applied. <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">visits</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(int $id, array $filter = [])</span></span></span><span class="hljs-function"> </span></span>{ $sql = <span class="hljs-string"><span class="hljs-string">'select mark, visited_at, place from visits LEFT JOIN locations ON locations.id = visits.location where user = '</span></span>.$id; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (count($filter)) { $sql .= <span class="hljs-string"><span class="hljs-string">' and '</span></span>.implode(<span class="hljs-string"><span class="hljs-string">' and '</span></span>, $filter); } $sql .= <span class="hljs-string"><span class="hljs-string">' order by visited_at asc'</span></span>; $rows = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_db-&gt;query($sql); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!$rows) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } $items = $rows-&gt;fetchAll(\PDO::FETCH_ASSOC); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($items <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> &amp;$item) { $item[<span class="hljs-string"><span class="hljs-string">'mark'</span></span>] = (int)$item[<span class="hljs-string"><span class="hljs-string">'mark'</span></span>]; $item[<span class="hljs-string"><span class="hljs-string">'visited_at'</span></span>] = (int)$item[<span class="hljs-string"><span class="hljs-string">'visited_at'</span></span>]; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $items; }</code> </pre> <br>  <b>Age calculation</b> <br>  This was probably the most discussed topic in the telegram chat.  The user's date of birth is given in the timestamp format (number of seconds from the beginning of the Linux era), for example, 12333444. But the countdown has been going on since 1970, and there are still people who were born before the 70s.  In this case, the timestamp will be negative, for example -123324.  Users can be superimposed by age filter, for example, select all who are over 18 years old.  In order not to calculate the age each time when querying in the database, I calculated it before adding the user to the database and saved it in an additional field. <br><br>  Age calculation function: <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getAge</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($y, $m, $d)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($m &gt; date(<span class="hljs-string"><span class="hljs-string">'m'</span></span>, TEST_TIMESTAMP) || ($m == date(<span class="hljs-string"><span class="hljs-string">'m'</span></span>, TEST_TIMESTAMP) &amp;&amp; $d &gt; date(<span class="hljs-string"><span class="hljs-string">'d'</span></span>, TEST_TIMESTAMP))) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (date(<span class="hljs-string"><span class="hljs-string">'Y'</span></span>, TEST_TIMESTAMP) - $y - <span class="hljs-number"><span class="hljs-number">1</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (date(<span class="hljs-string"><span class="hljs-string">'Y'</span></span>, TEST_TIMESTAMP) - $y); }</code> </pre> <br>  A ‚Äúcrutch‚Äù with TEST_TIMESTAMP is needed for passing tests, since the data + responses are generated simultaneously and unchanged over time.  The php date function perfectly converts a negative timestamp to a date, given leap years. <br><br>  <b>Database</b> <br>  The database was created exactly for the entity, all field sizes were TK.  DB engine InnoDb.  Indexes have been added to the fields participating in the filter or sorting. <br><br>  <b>Web server setup and database</b> <br>  To improve performance, the settings found on the Internet were used; they should have been the beginning from where to turn the services tune knob. <br><br><h3>  4. Processing reports, adjusting service settings </h3><br>  The source code in php turned out to be minimal in size and it quickly became clear that I was turning from a backend developer into a sysadmin.  Rapid tests run on a small amount of data and are more used to verify the correctness of the answers than to test the application under load.  A full-fledged tests could be run only 2 times in 12 hours.  Testing on my computer did not always lead to clear results - it could have worked quickly for me, but it failed to fail on checking. Due to this, I could not set up memcached, which should speed up server responses. <br><br>  The only positive thing was the use of the MyISAM engine instead of InnoDb.  Tests gave 133 penalty seconds, instead of 250 on InnoDb. <br><br>  Now that did not give a good setup to configure nginx / mysql / php-fpm - <a href="https://github.com/sat2707/hlcupdocs/issues/45">Significant variation in the results of a single solution at different times of day</a> .  This thoroughly upset me, since I also had a variation in the evening / morning results of the same solution.  I don‚Äôt know how the ‚Äúcombat‚Äù inspection infrastructure was arranged for them, but it is obvious that something could interfere with and load the car (perhaps the preparation of the next launch solution is possible).  And when the account goes on for a millisecond in the rating, it becomes impossible to fine-tune the server. <br><br>  Below are the configurations on which I stopped: <br><br><div class="spoiler">  <b class="spoiler_title">mysql</b> <div class="spoiler_text"><pre> <code class="hljs pgsql">[mysqld_safe] socket = /var/run/mysqld/mysqld.sock nice = <span class="hljs-number"><span class="hljs-number">0</span></span> [mysqld] # # * Basic Settings # <span class="hljs-keyword"><span class="hljs-keyword">user</span></span> = mysql pid-file = /var/run/mysqld/mysqld.pid socket = /var/run/mysqld/mysqld.sock port = <span class="hljs-number"><span class="hljs-number">3306</span></span> basedir = /usr datadir = /var/lib/mysql tmpdir = /tmp lc-messages-dir = /usr/<span class="hljs-keyword"><span class="hljs-keyword">share</span></span>/mysql skip-<span class="hljs-keyword"><span class="hljs-keyword">external</span></span>-locking # # <span class="hljs-keyword"><span class="hljs-keyword">Instead</span></span> <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> skip-networking the <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> now <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">listen</span></span> <span class="hljs-keyword"><span class="hljs-keyword">only</span></span> <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> # localhost which <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> more compatible <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> less secure. bind-address = <span class="hljs-number"><span class="hljs-number">127.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> # # * Fine Tuning # key_buffer_size = <span class="hljs-number"><span class="hljs-number">16</span></span>M max_allowed_packet = <span class="hljs-number"><span class="hljs-number">16</span></span>M thread_stack = <span class="hljs-number"><span class="hljs-number">192</span></span>K thread_cache_size = <span class="hljs-number"><span class="hljs-number">32</span></span> sort_buffer_size = <span class="hljs-number"><span class="hljs-number">256</span></span>K read_buffer_size = <span class="hljs-number"><span class="hljs-number">128</span></span>K read_rnd_buffer_size = <span class="hljs-number"><span class="hljs-number">256</span></span>K myisam_sort_buffer_size = <span class="hljs-number"><span class="hljs-number">64</span></span>M myisam_use_mmap = <span class="hljs-number"><span class="hljs-number">1</span></span> myisam-recover-<span class="hljs-keyword"><span class="hljs-keyword">options</span></span> = BACKUP table_open_cache = <span class="hljs-number"><span class="hljs-number">64</span></span> # # * Query <span class="hljs-keyword"><span class="hljs-keyword">Cache</span></span> Configuration # query_cache_limit = <span class="hljs-number"><span class="hljs-number">10</span></span>M query_cache_size = <span class="hljs-number"><span class="hljs-number">64</span></span>M query_cache_type = <span class="hljs-number"><span class="hljs-number">1</span></span> join_buffer_size = <span class="hljs-number"><span class="hljs-number">4</span></span>M # # Error <span class="hljs-keyword"><span class="hljs-keyword">log</span></span> - should be very few entries. # log_error = /var/<span class="hljs-keyword"><span class="hljs-keyword">log</span></span>/mysql/error.<span class="hljs-keyword"><span class="hljs-keyword">log</span></span> expire_logs_days = <span class="hljs-number"><span class="hljs-number">10</span></span> max_binlog_size = <span class="hljs-number"><span class="hljs-number">100</span></span>M # # * InnoDB # innodb_buffer_pool_size = <span class="hljs-number"><span class="hljs-number">2048</span></span>M innodb_log_file_size = <span class="hljs-number"><span class="hljs-number">256</span></span>M innodb_log_buffer_size = <span class="hljs-number"><span class="hljs-number">16</span></span>M innodb_flush_log_at_trx_commit = <span class="hljs-number"><span class="hljs-number">2</span></span> innodb_thread_concurrency = <span class="hljs-number"><span class="hljs-number">8</span></span> innodb_read_io_threads = <span class="hljs-number"><span class="hljs-number">64</span></span> innodb_write_io_threads = <span class="hljs-number"><span class="hljs-number">64</span></span> innodb_io_capacity = <span class="hljs-number"><span class="hljs-number">50000</span></span> innodb_flush_method = O_DIRECT <span class="hljs-keyword"><span class="hljs-keyword">transaction</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">isolation</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">READ</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">COMMITTED</span></span> innodb_support_xa = <span class="hljs-number"><span class="hljs-number">0</span></span> innodb_commit_concurrency = <span class="hljs-number"><span class="hljs-number">8</span></span> innodb_old_blocks_time = <span class="hljs-number"><span class="hljs-number">1000</span></span></code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">nginx</b> <div class="spoiler_text"><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">user</span></span> www-data; <span class="hljs-attribute"><span class="hljs-attribute">worker_processes</span></span> auto; <span class="hljs-attribute"><span class="hljs-attribute">error_log</span></span> /var/log/nginx/error.log <span class="hljs-literal"><span class="hljs-literal">warn</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">pid</span></span> /var/run/nginx.pid; <span class="hljs-section"><span class="hljs-section">events</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">worker_connections</span></span> <span class="hljs-number"><span class="hljs-number">2048</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">multi_accept</span></span> <span class="hljs-literal"><span class="hljs-literal">on</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">use</span></span> <span class="hljs-literal"><span class="hljs-literal">epoll</span></span>; } <span class="hljs-section"><span class="hljs-section">http</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">include</span></span> /etc/nginx/mime.types; <span class="hljs-attribute"><span class="hljs-attribute">default_type</span></span> application/octet-stream; <span class="hljs-attribute"><span class="hljs-attribute">log_format</span></span> main <span class="hljs-string"><span class="hljs-string">'</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$remote_addr</span></span></span><span class="hljs-string"> - </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$remote_user</span></span></span><span class="hljs-string"> [</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$time_local</span></span></span><span class="hljs-string">] "</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$request</span></span></span><span class="hljs-string">" '</span></span> <span class="hljs-string"><span class="hljs-string">'</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$status</span></span></span><span class="hljs-string"> </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$body_bytes_sent</span></span></span><span class="hljs-string"> "</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$http_referer</span></span></span><span class="hljs-string">" '</span></span> <span class="hljs-string"><span class="hljs-string">'"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$http_user_agent</span></span></span><span class="hljs-string">" "</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$http_x_forwarded_for</span></span></span><span class="hljs-string">"'</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">sendfile</span></span> <span class="hljs-literal"><span class="hljs-literal">on</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">tcp_nodelay</span></span> <span class="hljs-literal"><span class="hljs-literal">on</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">tcp_nopush</span></span> <span class="hljs-literal"><span class="hljs-literal">on</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">access_log</span></span> <span class="hljs-literal"><span class="hljs-literal">off</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">client_max_body_size</span></span> <span class="hljs-number"><span class="hljs-number">50M</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">client_body_buffer_size</span></span> <span class="hljs-number"><span class="hljs-number">1m</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">client_body_timeout</span></span> <span class="hljs-number"><span class="hljs-number">15</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">client_header_timeout</span></span> <span class="hljs-number"><span class="hljs-number">15</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">keepalive_timeout</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">send_timeout</span></span> <span class="hljs-number"><span class="hljs-number">15</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">open_file_cache</span></span> max=<span class="hljs-number"><span class="hljs-number">2000</span></span> inactive=<span class="hljs-number"><span class="hljs-number">20s</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">open_file_cache_valid</span></span> <span class="hljs-number"><span class="hljs-number">60s</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">open_file_cache_min_uses</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">open_file_cache_errors</span></span> <span class="hljs-literal"><span class="hljs-literal">off</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">gzip_static</span></span> <span class="hljs-literal"><span class="hljs-literal">on</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">gzip</span></span> <span class="hljs-literal"><span class="hljs-literal">on</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">gzip_vary</span></span> <span class="hljs-literal"><span class="hljs-literal">on</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">gzip_min_length</span></span> <span class="hljs-number"><span class="hljs-number">1400</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">gzip_buffers</span></span> <span class="hljs-number"><span class="hljs-number">16</span></span> <span class="hljs-number"><span class="hljs-number">8k</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">gzip_comp_level</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">gzip_http_version</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>.<span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">gzip_proxied</span></span> any; <span class="hljs-attribute"><span class="hljs-attribute">gzip_disable</span></span> <span class="hljs-string"><span class="hljs-string">"MSIE [1-6]\.(?!.*SV1)"</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">gzip_types</span></span> text/plain text/css application/x-javascript text/xml application/xml application/xml+rss text/javascript application/json image/svg+xml svg svgz; <span class="hljs-attribute"><span class="hljs-attribute">include</span></span> /etc/nginx/conf.d/<span class="hljs-regexp"><span class="hljs-regexp">*.conf</span></span>; }</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">nginx-vhost</b> <div class="spoiler_text"><pre> <code class="hljs nginx"><span class="hljs-section"><span class="hljs-section">server</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">listen</span></span> <span class="hljs-number"><span class="hljs-number">80</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">server_name</span></span> _; <span class="hljs-attribute"><span class="hljs-attribute">chunked_transfer_encoding</span></span> <span class="hljs-literal"><span class="hljs-literal">off</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">root</span></span> /var/www/html; <span class="hljs-attribute"><span class="hljs-attribute">index</span></span> index.php index.html index.htm; <span class="hljs-attribute"><span class="hljs-attribute">error_log</span></span> /var/log/nginx/error.log <span class="hljs-literal"><span class="hljs-literal">crit</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">location</span></span> / { <span class="hljs-attribute"><span class="hljs-attribute">try_files</span></span> <span class="hljs-variable"><span class="hljs-variable">$uri</span></span> <span class="hljs-variable"><span class="hljs-variable">$uri</span></span>/ /index.php?<span class="hljs-variable"><span class="hljs-variable">$args</span></span>; } <span class="hljs-attribute"><span class="hljs-attribute">location</span></span> <span class="hljs-regexp"><span class="hljs-regexp">~ \.php$</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">try_files</span></span> <span class="hljs-variable"><span class="hljs-variable">$uri</span></span> =<span class="hljs-number"><span class="hljs-number">404</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">include</span></span> /etc/nginx/fastcgi_params; <span class="hljs-attribute"><span class="hljs-attribute">fastcgi_pass</span></span> unix:/var/run/php/php7.1-fpm.sock; <span class="hljs-attribute"><span class="hljs-attribute">fastcgi_index</span></span> index.php; <span class="hljs-attribute"><span class="hljs-attribute">fastcgi_param</span></span> SCRIPT_FILENAME <span class="hljs-variable"><span class="hljs-variable">$document_root</span></span><span class="hljs-variable"><span class="hljs-variable">$fastcgi_script_name</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">fastcgi_read_timeout</span></span> <span class="hljs-number"><span class="hljs-number">3s</span></span>; } }</code> </pre> <br></div></div><br>  In php-fpm it was not possible to achieve anything specific. <br><br>  Before the final, the amount of data was increased, unfortunately I did not have enough time to try to further optimize my solution.  But after the final, a sandbox was opened where you can still try to drive your decisions and compare the results with the top. <br><br><h2>  5. Conclusions </h2><br>  I am glad that I participated in this championship.  Understand the principle of the docker, a deeper configuration of servers under high loads.  And I also liked the competitive spirit and chat chatting telegram.  For all the time championship in the top were programmers with ++ and go.  One could follow the example and also write in any of these languages.  But I wanted to look at my results in what I know and with what I work.  Thank you Mail.Ru for this. <br><br><h3>  6. References </h3><br>  1. <a href="https://github.com/Afinogen/highloadcup_travel">Source Code</a> <br>  2. <a href="https://highloadcup.ru/round/1/">highloadcup.ru</a> first round of competition </div><p>Source: <a href="https://habr.com/ru/post/337076/">https://habr.com/ru/post/337076/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../337064/index.html">Building a digital future on the Fujitsu World Tour</a></li>
<li><a href="../337066/index.html">Step-by-step configuration of web services in OTRS 5 as requester</a></li>
<li><a href="../337068/index.html">The digest of fresh materials from the world of the frontend for the last week ‚Ññ278 (August 28 - September 3, 2017)</a></li>
<li><a href="../337070/index.html">Dagger 2. Subcomponents. Best practice. Part 2</a></li>
<li><a href="../337072/index.html">PUSH authorization in services using a mobile application</a></li>
<li><a href="../337078/index.html">Using Graphviz for flowcharts</a></li>
<li><a href="../337080/index.html">Our rake when starting Calltouch Predict: 365 days of speech recognition and machine learning</a></li>
<li><a href="../337082/index.html">Practical use of the blockchain as a distributed data warehouse</a></li>
<li><a href="../337084/index.html">Methods for detecting "glued" files</a></li>
<li><a href="../337086/index.html">Corporate communication in Telegram. Migration from WhatsApp at full speed</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>