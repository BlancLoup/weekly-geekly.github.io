<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Local autonomous data collection system</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="At the company, NEKST-M monitoring posts of domestic production Nekst Technologies were purchased. To ensure the visualization of the pumping units, 
...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Local autonomous data collection system</h1><div class="post__text post__text-html js-mediator-article">  At the company, NEKST-M monitoring posts of domestic production Nekst Technologies were purchased.  To ensure the visualization of the pumping units, <br>  fire alarm, voltage on the starters, room temperature, emergency water level.  The heart of NEKST-M is ATMEGA 1280, and this fact was encouraging in terms of the possibility of creating its own set for specific needs. <br><a name="habracut"></a><br>  The task was set in the shortest possible time and at minimum cost to create a fully autonomous system of local dispatching for specific needs.  The basis of the microcontroller.  Development, manufacturing, created by the staff itself. <br><br>  The system should work without dependence on cellular networks, servers, the Internet and an authorization system of using radio frequency resources, not use computers or maximum periodic use of laptops in the control and management system, without access to objects for a long time (6-9 months).  The network configuration has a radial structure.  Data is collected at one point and then sent for processing via normal communication channels or as a hard copy. <br><br>  The system should provide: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ul><li>  control of pumping units </li><li>  technological automation </li><li>  emergency protection </li><li>  emergency alarm </li><li>  life time counting </li><li>  calculation of the amount of electricity consumed </li><li>  temperature control equipment </li><li>  fire and security alarm </li><li>  periodic remote removal of information </li><li>  unknown requirements in the future </li></ul><br>  Working conditions: <br><br><ul><li>  coverage area of ‚Äã‚Äã1 sq. km. </li><li>  line-of-sight between objects </li><li>  temperature from +50 to -50  </li><li>  humidity up to 100% </li><li>  biologically active deposits (mold, sulfate-reducing bacteria) </li><li>  vibration, no more, cars of 1‚Äì2 classes in accordance with GOST ISO 10816-1-97 </li><li>  Electromagnetic environment - switching of electric motors by KT 6053 contactors, RVS-DN soft start equipment, SIEMENS MICROMASTER PID control equipment, ISM and GSM emissions according to the requirements for these devices, on-site manual arc welding </li><li>  Overvoltage of the network, short-term power outages, thunderstorm overvoltages, phase imbalance when the VL wire is broken in 6-10 kV distribution networks. </li></ul><br>  In spite of such strict requirements, the implementation is quite simple in the phased solution of the problem. <br><br>  Taking everything into account, the Arduino Nano 3.0 board has become the ‚Äúbrain‚Äù of the plan.  The ‚ÄúRobotdyn‚Äù shawl has an ATMEGA 328 controller, the required voltage regulator is 3.3V per <br>  800 mA current and converter to CH340G UART-USB. <br><br>  First of all, the operating time counters were created as the most relevant.  Previously used industrial meters assembled on PICs with a transformerless power supply circuit failed due to voltage surges during the year of operation.  Only the connected ones with the help of self-made power supplies with a voltage of 5V remained intact.  To speed up the installation and the universality of the connection, the signal on the state of the units is taken from the terminals of the switching devices, i.e.  registration of the presence of the 1st phase voltage at three-phase power supply 380V.  For coordination with the controller, an intermediate relay with a winding of 220V or an optocoupler composed of a LED and a GL5516 photoresistor or an PC817 optocoupler is used.  All variants were tested in work.  The LED is powered by a rectified voltage with current limiting by means of two capacitors CBV22 designed for 630V connected in series for safety when randomly checking circuits with a megohmmeter. <br>  Reading the operating time using the ST7735S LCD screen, transmitting data over the radio channel in real time using the E01-ML01DP05 module at 2.4 MHz.  This device contains the nRF24L01 + chip and the RFX2401C transmit / receive amplifier, <br>  output power up to 100 mW.  Spiral antennas designed for the desired range in the online <a href="https://3g-aerial.biz/onlajn-raschety/raschety-antenn/raschet-spiralnoj-antenny">site</a> calculator.  The choice of the type of antennas is due to the exception of receiving once reflected waves from the surrounding metal structures.  Details of the antennas are printed on a 3D printer.  The current state of the counters is stored in the controller's EEPROM and is restored in the event of an unexpected power outage.  The time intervals for the account are provided by the RTC chip DS3231 as a module with a battery backup power supply.  The power supply unit uses 3 modules, the HLK-PM01 600mA switching source 220 / 5V, the <a href="">HW-553</a> and <a href="">03962A</a> converter from 1-5V to 5V - a battery controller with a <a href="">circuit</a> for protection against short circuit, overdischarge and overcharge.  All components were purchased on Aliexpress. <br><br><div class="spoiler">  <b class="spoiler_title">Bread board</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/av/qi/cv/avqicved5qkwbjnxhqeqa0syxh0.jpeg" alt="image alt" align="left"></div></div><br>  4-channel counter.  The inputs are LC filters to protect against interference on the communication line of twisted pair.  Data on the status of objects of control are constantly read once per second, displayed in color on the LCD.  Updating of indications and record in non-volatile memory happens each 36 sec.  36 seconds is 1/100 of an hour, data is required in this format.  Every 12 sec.  information is transmitted on the number of seconds of work for each control unit.  EEPROM memory has a limited number of write-erase cycles, according to the manufacturer, 100,000 times.  The worst option is when constantly updating at least one cell.  The volume of the 1st counter is 4 bytes, this is a long format number, 4 counters, a total of 16 bytes occupies one record.  The memory length of the microcircuit is 1024 bytes; after 64 records of 4 counters, the recording will begin again.  In the EEPROM library, the EEPROM.put method does not write, if the value of the cell and the recorded information is the same, there will be no cell degradation.  As a result, the time guaranteed memory will be more than 7 years.  Time possible, but non-guaranteed work can be much more. <br><br><div class="spoiler">  <b class="spoiler_title">Schematic diagram</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/ww/d9/ia/wwd9iavzarcvpeadigd7a-kc_ju.jpeg" alt="image alt" align="left"></div></div><br><div class="spoiler">  <b class="spoiler_title">Program in the Arduino IDE</b> <div class="spoiler_text"> // 12 328 bytes (38%) <br><br>  #include &lt;Adafruit_GFX.h&gt; // Core graphics library <br>  #include &lt;Adafruit_ST7735.h&gt; // Hardware-specific library <br>  #include &lt;SPI.h&gt; <br>  #include &lt;EEPROM.h&gt; <br>  #include &lt;Wire.h&gt; <br>  #include &lt;nRF24L01.h&gt; <br>  #include &lt;RF24.h&gt; <br>  RF24 radio (9, 10);  // radio object for working with RF24 library, <br>  // and pin numbers nRF24L01 + (CE, CSN) <br>  #include &lt;DS3231.h&gt; <br>  DS3231 rtc (SDA, SCL); <br>  Time t; <br><br>  // # define TFT_CS 10 <br>  #define TFT_CS 8 <br>  #define TFT_RST -1 // you can also connect this to the Arduino reset <br>  // in which case, set this #define pin to -1! <br>  // # define TFT_DC 9 // DC = RS = A0- variants of notation for the output of the selection of the register of commands or data. <br>  #define TFT_DC 3 <br><br>  Adafruit_ST7735 tft = Adafruit_ST7735 (TFT_CS, TFT_DC, TFT_RST); <br><br>  // Option 2: use any pins but a little slower! <br>  #define TFT_SCLK 13 // set these to be whatever you like! <br>  #define TFT_MOSI 11 // set these to be whatever you like! <br>  // Adafruit_ST7735 tft = Adafruit_ST7735 (TFT_CS, TFT_DC, TFT_MOSI, TFT_SCLK, TFT_RST); <br>  #include &lt;avr / wdt.h&gt; <br><br>  byte shift = 52; <br>  byte pinState; <br>  unsigned long pump [4]; // array with 4 values ‚Äã‚Äãof seconds counters <br>  float m = 3600.0; <br>  unsigned int address = 0; <br>  int rc; // variable for counters <br>  unsigned long sumprim = 0; <br>  unsigned long sumsec = 0; <br>  byte i = 0; <br>  byte k = 34; <br>  unsigned int z = 0; <br>  byte b = B00000001; <br>  byte pumrcounter [4];  // array for storing object states, 1- off, 0- on. <br>  int start = 0;  // <br><br>  void setup () { <br><br>  rtc.begin (); <br>  radio.begin ();  // Initiate nRF24L01 + operation <br>  radio.setChannel (120);  // data transmission channel (from 0 to 127). <br>  radio.setDataRate (RF24_250KBPS);  // data transfer rate (RF24_250KBPS, RF24_1MBPS, RF24_2MBPS). <br>  radio.setPALevel (RF24_PA_MAX);  // transmitter power (RF24_PA_MIN = -18dBm, RF24_PA_LOW = -12dBm, <br>  // RF24_PA_HIGH = -6dBm, RF24_PA_MAX = 0dBm) <br>  radio.openWritingPipe (0xAABBCCDD11LL);  // Open the pipe with the identifier for data transfer <br><br>  // To set the time - uncomment the necessary lines <br>  //rtc.setDOW (1);  // Day of the week <br>  //rtc.setTime (21, 20, 0);  // Time, in the format of 24 hours. <br>  //rtc.setDate (2929, 10, 2018);  // Date, October 29, 2018 <br><br>  tft.initR (INITR_BLACKTAB);  // initialize a ST7735S chip, black tab <br>  // Use this initializer (uncomment) if you are using a 1.44 "TFT <br>  //tft.initR(INITR_144GREENTAB);  // initialize a ST7735S chip, RED rcB tab <br>  tft.setTextWrap (false);  // Allow text to run off right edge <br>  tft.setRotation (2);  // for BLACK PCB and RED tft.setRotation (0) or not. <br>  tft.fillScreen (ST7735_BLACK);  // clear the screen <br><br>  DDRD = DDRD |  B00000000; <br>  PORTD = PORTD |  B11110000; // software tightening works, high level- <br>  // monitored objects ‚Äúdo not work‚Äù, all 4 senior ports D are recorded as ‚Äú1‚Äù, no counting is going on. <br><br>  for (rc = 0; rc &lt;4; rc ++) <br>  { <br>  tft.setCursor (3, rc * 10 + shift);  // output position numbers of control objects <br>  tft.print (rc + 1); <br>  } <br><br>  tft.setCursor (12, 0);  // output 3 lines of text <br>  tft.println ("DEVELOPERS &amp; BUILD");  // to praise your loved ones <br>  tft.setCursor (24, 10);  // or evil copyright <br>  tft.print ("DEVELOPER MM"); <br>  tft.setCursor (28, 20); <br>  tft.print ("BUILD-ER DD"); <br><br>  //data recovery////////////////////////////////////////////// /////////// <br><br>  for (z = 0; z &lt;1023; z + = 16) {// Enumerates all the cells of its industry <br>  // and writes to the array of 4 pump variables, 4 bytes each counter, since <br>  // variable unsigned long.  Counters 4, one record of all 4 takes 16 bytes. <br>  EEPROM.get (z, pump [0]);  // so, without a for loop, less volume <br>  EEPROM.get (z + 4, pump [1]); <br>  EEPROM.get (z + 8, pump [2]); <br>  EEPROM.get (z + 12, pump [3]); <br><br>  // assignment of the next new value of the sum of 4-x counters <br>  sumprim = (pump [0] + pump [1] + pump [2] + pump [3]); <br><br>  // compares the new value of the sum of 4 counters in the variable sumprim with the previous value in the variable <br>  // sumsec and if the previous amount is less than or equal to the new amount, a new greater or equal is assigned <br>  // sumsec value. <br><br>  if (sumsec &lt;= sumprim) { <br>  sumsec = sumprim;  // <br><br>  // and the current value z is assigned to the variable z, z is the address of the beginning of the block of 16 bytes from 4 values <br>  // counters recorded at the same time (since when a port is polled, all its 8 bits are recorded simultaneously, <br>  // including our needed high 4 bits of port D). <br>  address = z; <br>  } <br>  } <br><br>  // once again, accessing the memory of the e-industry at the address of the beginning of the block is 16 bytes from the 4 values ‚Äã‚Äãof the counters recorded <br>  // last, i.e.  values ‚Äã‚Äãbefore shutting down or rebooting due to a hang.  Last record <br>  // values ‚Äã‚Äãof counters in an array of 4 pump variables. <br><br>  EEPROM.get (address, pump [0]); <br>  EEPROM.get (address + 4, pump [1]); <br>  EEPROM.get (address + 8, pump [2]); <br>  EEPROM.get (address + 12, pump [3]); <br><br>  address + = 16;  // increment the address to write the next block without erasing the last record <br><br>  // end of data recovery ///////////////////////////////////////////// /////////////////// <br><br>  attachInterrupt (0, count, RISING);  // pin D2, resolution of work of interruption, every second come <br>  // pulses from RTC DS3231 from SQW output <br><br>  wdt_enable (WDTO_8S);  // start the watchdog timer, reload the controller in case of a hang, time <br>  // for which you need to issue a wdt_reset timer reset command (and avoid rebooting during normal operation - 8 seconds. <br>  // for tests it is not recommended to set the value to less than 8 seconds. In this case, the timer is reset in <br>  // digging, but it is every second. <br><br>  } <br><br>  void loop () { <br>  // empty cycle, there will be control over the non-phase-phase operation of the electric motor <br>  } <br><br>  void count () { <br><br>  tft.setTextColor (ST7735_WHITE);  // set the font color <br>  t = rtc.getTime ();  // read time <br>  tft.setCursor (5, 120);  // set the cursor position <br>  tft.fillRect (5, 120, 50, 7, ST7735_BLACK);  // clear time display area <br>  tft.print (rtc.getTimeStr ());  // display hours <br><br>  wdt_reset ();  // reset the watchdog timer every cycle, i.e. a second <br><br>  for (rc = 0; rc &lt;4; rc ++) // the beginning of the state input matching cycle <br>  // bits of the port to the previous read state of the bits of port D <br>  { <br>  pinState = (PIND &gt;&gt; 4) &amp; (b &lt;&lt; rc); <br><br>  if (pumrcounter [rc]! = pinState) {// and if it doesn't match, then <br>  pumrcounter [rc] = pinState;  // assignment of the state variable of the port bit to the new value 1/0 <br>  } <br>  // indication of the state of objects of color control <br>  // BLUE is a small glitch of the available screen (or library?), RGB and BGR are confused. <br>  if (pinState == (b &lt;&lt; rc)) { <br>  tft.fillRect (15, ((rc * 10 + shift)), 7, 7, ST7735_BLUE);  // for low counting, change GREEN to BLUE <br>  } else { <br>  tft.fillRect (15, ((rc * 10 + shift)), 7, 7, ST7735_GREEN);  // for low counting, change BLUE to GREEN <br>  pump [rc] + = 1;  // add to the time counter 1 second <br>  } <br>  } <br><br>  k ++; <br>  if (k = 36) { <br>  k = 0; <br><br>  tft.fillRect (30, shift, 97, 40, ST7735_BLACK);  // clear the running time display area <br>  tft.fillRect (60, 120, 73, 7, ST7735_BLACK);  // and dates <br><br>  tft.setCursor (60, 120);  // set the cursor position <br>  tft.print (rtc.getDateStr ());  // display date on LCD screen <br><br>  for (rc = 0; rc &lt;4; rc ++) // output of the operating time readings in integers, tenths and <br>  { <br>  tft.setCursor (30, rc * 10 + shift); // hundredths of an hour with screen down by 10 pixels <br>  tft.println (pump [rc] / m); <br>  } <br><br>  // write raw values ‚Äã‚Äã(in seconds) in the EEPROM ////////////////////////////// <br><br>  for (rc = 0; rc &lt;4; rc ++) <br>  { <br>  EEPROM.put (address, pump [rc]); <br>  address + = sizeof (float);  // increment of the variable address of the entry <br>  } <br>  } <br><br>  // send data by radio from data indicating how many bytes should be sent. <br>  if ((k == 6) || (k == 18) || (k == 30)) { <br><br>  unsigned long data; <br><br>  radio.write (&amp; start, sizeof (start)); <br><br>  for (i = 0; i &lt;4; i ++) { <br>  data = pump [i]; <br>  radio.write (&amp; data, sizeof (data)); <br>  } <br>  } <br>  } <br></div></div><br>  Small remarks at the end.  The score is at a low logic level at the inputs. <br><br>  Tightening resistance R2-R5 36 kOhm for the version with photoresistors GL5516.  In the case of phototransistor optocouplers and relays, put 4.7-5.1 kOhm.  Loader Arduino Nano v3.0 replaced by Arduino Uno using the programmer TL866A for correct operation of the watchdog timer.  The fuses are corrected for operation at a voltage higher than 4.3 V. The external reset circuit R6 C3 was not used.  In the example program, the transmitter frequency does not correspond to the unlicensed range, the 2.4 MHz range is limited to the frequencies 2400.0‚Äì2483.5 MHz. <br><br>  The range of the E01-ML01DP05 transmitter is 2400-2525 MHz.  The bandwidth of one channel is 1 MHz, when setting the speed as ‚ÄúRF24_2MBPS‚Äù, the specified radio.setChannel (120) channel and the next one, i.e.  the band will be 2 MHz. </div><p>Source: <a href="https://habr.com/ru/post/447168/">https://habr.com/ru/post/447168/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../447158/index.html">Wireshark 3.x: code analysis for macOS and error review</a></li>
<li><a href="../447160/index.html">Space - for children. A few ideas for the Day of Cosmonautics</a></li>
<li><a href="../447162/index.html">Don't buy ERP</a></li>
<li><a href="../447164/index.html">How to combine the benefits of a laptop and a desktop computer? Analysis of the problem and ideas for solving (Part 2)</a></li>
<li><a href="../447166/index.html">Help Desk for 3 hours. Automate simple business processes in PowerApps, Flow and Teams</a></li>
<li><a href="../447174/index.html">Personnel Hunger Myth or Basic Rules for Job Creation</a></li>
<li><a href="../447178/index.html">5 effective possibilities of using process mining technology</a></li>
<li><a href="../447180/index.html">Overview and Comparison of Ingress Controllers for Kubernetes</a></li>
<li><a href="../447182/index.html">Operating Systems: Three Easy Pieces. Part 3: Process API (Translation)</a></li>
<li><a href="../447184/index.html">What is Initial Exchange Offering (IEO) and how does it differ from ICO?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>