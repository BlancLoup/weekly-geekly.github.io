<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>The story of two threads</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="At the interview in the IT company was asked to answer the following question. 

 Task. Given the code: 



 static int counter = 0; void worker () { ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>The story of two threads</h1><div class="post__text post__text-html js-mediator-article">  At the interview in the IT company was asked to answer the following question. <br><br>  <strong>Task.</strong>  Given the code: <br><br><pre>		 static int counter = 0;

		 void worker ()
		 {
			 for (int i = 1; i &lt;= 10; i ++)
				 counter ++;
		 }
</pre>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The <code>worker()</code> procedure is run from two threads.  What value will the <code>counter</code> variable contain when both threads are completed and why? <br><br>  <strong>A bit of theory.</strong>  Threads are parallel-executable tasks within a single process.  The main difference between processes and threads is such that all threads of a process work in the common address space of their process. <br><br>  I do not call threads as threads, so as not to confuse threads ( <a href="http://en.wikipedia.org/wiki/Thread_(computer_science)">thread</a> ) and data streams ( <a href="http://en.wikipedia.org/wiki/Stream_(computing)">stream</a> ). <br><br><a name="habracut"></a><br><br>  <strong>Variant of answer No. 1. The</strong> variable <code>counter</code> will contain the number 20 - this is the most desirable result, but also the most incorrect answer. <br><br>  The problem is that this code is not protected from out of sync.  Each thread works independently of each other and does not suspect that the common data ( <code>counter</code> variable) can be changed by someone else.  Therefore, the more correct answer is this: <em>this is an insecure code and the value of the <code>counter</code> variable will be undefined</em> . <br><br>  <strong>Option number 2.</strong> Yet knowing the basics of the processor, OS and compiler, you can more accurately assume what result we get. <br><br>  The <code>worker()</code> routine is fairly simple.  Therefore, at the optimization stage, the compiler can expand the for-loop into such a structure: <br><br><pre>	 counter + = 10; </pre><br><br>  Now the code is so trivial that the first thread can manage to finish its execution even before the second thread starts.  So we get the number 20. <br><br>  Possible and such a case.  The threads read the value of the <code>counter</code> variable (zero) from the RAM and put it into the processor register.  Since each thread operates in its own processor context, each has its own independent set of registers.  Thus, the first thread in its context will increase the value of the register from zero to ten and then bring the result back into memory.  And then the second thread will do the same and rewrite that ten of its own.  As a result, we get the number 10. <br><br>  <em>Values ‚Äã‚Äãof 10 and 20 are most likely in real practice</em> , but this is not the complete answer. <br><br>  <strong>Option number 3.</strong> Let's imagine a potentially real, but the most inefficient scheme of work.  So each iteration of the cycle will repeat three atomic actions in the same way: reading the <code>counter</code> value in the processor register, increment of this register, writing the new value from the register back to memory.  (I do not consider the implementation of the cycle itself, since it does not play any role.) Plus, the thread execution context switching will occur when we want it.  <em>Under such conditions, we can get a result from 2 to 20.</em> <br><br>  Now on the timeline in the form of a table, consider the possibility of obtaining a two.  Step 0 is the original state.  The operations "‚Üí <em>n</em> ", " <em>n</em> +" and " <em>n</em> ‚Üí" respectively represent reading from memory into a register, register increment and writing the register value to memory in the context of thread No. <em>n</em> .  The ‚Äúloop‚Äù line shows the iteration number.  Changes to the values ‚Äã‚Äãin the current step <strong>are highlighted</strong> for better perception. <br><br><table><tbody><tr><th colspan="2">  Step </th><td>  0 </td><td></td><td>  one </td><td>  2 </td><td></td><td>  3 </td><td>  four </td><td>  five </td><td>  ... </td><td>  27 </td><td>  28 </td><td>  29 </td><td></td><td>  thirty </td><td></td><td>  31 </td><td>  32 </td><td></td><td>  33 </td><td>  34 </td><td>  35 </td><td>  ... </td><td>  57 </td><td>  58 </td><td>  59 </td><td></td><td>  60 </td></tr><tr><th colspan="2">  Operation </th><td>  - </td><td></td><td>  ‚Üí 1 </td><td>  1+ </td><td></td><td>  ‚Üí 2 </td><td>  2+ </td><td>  2 ‚Üí </td><td></td><td>  ‚Üí 2 </td><td>  2+ </td><td>  2 ‚Üí </td><td></td><td>  1 ‚Üí </td><td></td><td>  ‚Üí 2 </td><td>  2+ </td><td></td><td>  ‚Üí 1 </td><td>  1+ </td><td>  1 ‚Üí </td><td></td><td>  ‚Üí 1 </td><td>  1+ </td><td>  1 ‚Üí </td><td></td><td>  2 ‚Üí </td></tr><tr><th rowspan="2">  Thread number 1 </th><th>  Register </th><td>  - </td><td></td><td>  <strong>0</strong> </td><td>  <strong>one</strong> </td><td></td><td>  one </td><td>  one </td><td>  one </td><td></td><td>  one </td><td>  one </td><td>  one </td><td></td><td>  one </td><td></td><td>  one </td><td>  one </td><td></td><td>  <strong>one</strong> </td><td>  <strong>2</strong> </td><td>  2 </td><td rowspan="2">  ... </td><td>  <strong>9</strong> </td><td>  <strong>ten</strong> </td><td>  ten </td><td></td><td>  ten </td></tr><tr><th>  Cycle </th><td>  one </td><td></td><td>  one </td><td>  one </td><td></td><td>  one </td><td>  one </td><td>  one </td><td></td><td>  one </td><td>  one </td><td>  one </td><td></td><td>  one </td><td></td><td>  one </td><td>  one </td><td></td><td>  2 </td><td>  2 </td><td>  2 </td><td>  ten </td><td>  ten </td><td>  ten </td><td></td><td>  ten </td></tr><tr><th rowspan="2">  Thread number 2 </th><th>  Register </th><td>  - </td><td></td><td>  - </td><td>  - </td><td></td><td>  <strong>0</strong> </td><td>  <strong>one</strong> </td><td>  one </td><td rowspan="2">  ... </td><td>  <strong>eight</strong> </td><td>  <strong>9</strong> </td><td>  9 </td><td></td><td>  9 </td><td></td><td>  <strong>one</strong> </td><td>  <strong>2</strong> </td><td></td><td>  2 </td><td>  2 </td><td>  2 </td><td></td><td>  2 </td><td>  2 </td><td>  2 </td><td></td><td>  2 </td></tr><tr><th>  Cycle </th><td>  one </td><td></td><td>  one </td><td>  one </td><td></td><td>  one </td><td>  one </td><td>  one </td><td>  9 </td><td>  9 </td><td>  9 </td><td></td><td>  9 </td><td></td><td>  ten </td><td>  ten </td><td></td><td>  ten </td><td>  ten </td><td>  ten </td><td></td><td>  ten </td><td>  ten </td><td>  ten </td><td></td><td>  ten </td></tr><tr><th colspan="2">  Memory </th><td>  0 </td><td></td><td>  0 </td><td>  0 </td><td></td><td>  0 </td><td>  0 </td><td>  <strong>one</strong> </td><td></td><td>  eight </td><td>  eight </td><td>  <strong>9</strong> </td><td></td><td>  <strong>one</strong> </td><td></td><td>  one </td><td>  one </td><td></td><td>  one </td><td>  one </td><td>  <strong>2</strong> </td><td></td><td>  9 </td><td>  9 </td><td>  <strong>ten</strong> </td><td></td><td>  <strong>2</strong> </td></tr></tbody></table><br>  (Added: at the request of the reader, here <a href="">is the raster version of the table</a> .) <br><br>  Steps 1-2: the first thread enters the register zero and increments it by one.  3-29: control is transferred to the second thread, which also reads zero and performs nine complete iterations.  30: The first thread completes the first iteration of the loop and puts the counted unit into memory (by grinding the nine).  31‚Äî32: the second thread starts the last (tenth) iteration, reads and incriminates the unit.  33-59: the first thread completely performs the nine remaining iterations and finishes its work.  60: the second thread memorizes the counted deuce and finishes its work. <br><br>  <font color="#cccccc">_________</font> <font color="#cccccc"><br></font>  <font color="#cccccc">NB: This is a cross-post from my blog.</font>  <font color="#cccccc">I reprinted because the audience at Habr√© is larger than that of my blog (: I think the material is interesting.</font> </div><p>Source: <a href="https://habr.com/ru/post/63697/">https://habr.com/ru/post/63697/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../63684/index.html">The idea of ‚Äã‚Äãthe timeline and its application</a></li>
<li><a href="../63687/index.html">Mobile devices: device idea</a></li>
<li><a href="../63691/index.html">Investor Day at iCamp Russia - $ 10 million for investments</a></li>
<li><a href="../63692/index.html">Cute robots</a></li>
<li><a href="../63696/index.html">"Runner" visiting PA AdLabs</a></li>
<li><a href="../63698/index.html">Layers + Unity Container</a></li>
<li><a href="../63699/index.html">Philco Radio - home media center in retrostyle</a></li>
<li><a href="../63700/index.html">GadgetBlog.ru - another blog about gadgets?</a></li>
<li><a href="../63701/index.html">Simple geocoder</a></li>
<li><a href="../63702/index.html">OpenSource games and simple Linux games</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>