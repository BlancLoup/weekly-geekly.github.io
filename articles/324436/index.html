<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Hardware solution hang GSM-modems</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="1. Problem 
2. Solution to the problem 
3. How is the device used 
4. Result 
 Problem 
 Our organization has 140 unattended units (complexes), which ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Hardware solution hang GSM-modems</h1><div class="post__text post__text-html js-mediator-article"><ol><li>  Problem </li><li>  Solution to the problem </li><li>  How is the device used </li><li>  Result </li></ol><br><h2>  Problem </h2><br>  Our organization has 140 unattended units (complexes), which are installed in remote locations from Anapa to Pevek, mainly at departmental sites.  The complex itself consists of a compact Win32 computer and a GNSS receiver with an antenna on the roof.  We need to receive data from them every 15 minutes.  Some stations have access to a departmental network, but often have to use the <b>mobile Internet</b> .  Here is the complex: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/ee7/ba7/e57/ee7ba7e570c74767b27e2b661cbf3435.jpg"></div><br>  Ordinary <b>USB modems</b> (so-called ‚Äúwhistles‚Äù) have proven themselves very bad: they <b>hang</b> too often, and the reception quality of a weak signal leaves much to be desired.  We began to use more expensive industrial-type USB-modems with a remote room antenna.  But they periodically hung up, which led to the inaccessibility of the complex.  We had to call at the meteorological station, where our complexes are installed, for a long time to explain to older observers what kind of cable you need to pull out and insert back.  Not everyone agreed to perform such a complex procedure. <br><a name="habracut"></a><br><h2>  Solution to the problem </h2><br>  There are GSM routers on the market with a watchdog built-in inside, but most often they work with end equipment over Ethernet, which complicates setup and costs several times more.  Stable modems at a reasonable price do not support 3G. <br><br>  We decided to go the other way.  At first, we set up an automatic daily reboot of computers, but this did not always help: power was supplied to the USB modem even when the computer was turned off, and it was impossible to reconfigure in the BIOS.  In addition, a reboot interrupts data collection. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      So the idea arose to create a <b>USB relay</b> that will hard <b>reset the power of the GSM modem</b> in case of its hangup.  We received a suitable product to order and began to open the "plus" using the relay by a team from a computer.  In general, the solution worked, but when the modem was turned on, in half the cases, the computer went into reboot.  This was due to the fact that the modem had two large input capacitors that caused a current surge when turned on, which the USB port was not designed for, and our small computer felt this.  To avoid unwanted reboots, we ordered a special release of a USB relay with a <b>two-step load switch</b> : first, the modem is turned on through a resistor, and then directly.  Here is the finished device with an extension for convenience: <br><br><img src="https://habrastorage.org/files/c68/b47/79f/c68b4779f80845e39321beafb9683d31.jpg"><br><br>  The design has two USB plugs: one to control the relay, and one to transit to the controlled device (modem).  The only USB-slot is designed to connect the device, it is in it that the plus command is opened by the control command. <br><br>  <b>How is the device used</b> <br><br>  Next, we wrote a control program that determines when to reboot the modem, and sends a command to reboot it.  It works according to the following algorithm: <br><br><ol><li>  3 times per hour the program is launched from the Windows Task Scheduler. </li><li>  The program checks the availability of our server. </li><li>  If 4 pings in a row were unsuccessful, then the program sends a command to turn off / on the modem via a relay.  In this case, a delay is made before switching on so that the built-in capacitors have time to discharge. </li><li>  Ping results and actions taken are logged (turn off / turn on the modem). </li><li>  At the first opportunity, logs are sent to our server, where all events are recorded in a database for subsequent centralized analysis of all causes of station failures. </li></ol><br>  Here is an example log: <br><table><tbody><tr><th>  Date Time </th><th>  Number of servers available </th><th>  Number of unsuccessful pings in a row </th><th>  Primary server availability </th><th>  Command execution </th></tr><tr><td>  2017-01-24 20:37:00 </td><td>  0/2 </td><td>  6 </td><td>  no </td><td></td></tr><tr><td>  2017-01-24 20:57:00 </td><td>  0/2 </td><td>  7 </td><td>  no </td><td></td></tr><tr><td>  2017-01-24 21:17:00 </td><td>  0/2 </td><td>  eight </td><td>  no </td><td>  resetmodem </td></tr><tr><td>  2017-01-24 21:37:00 </td><td>  0/2 </td><td>  9 </td><td>  no </td><td></td></tr><tr><td>  2017-01-24 21:57:00 </td><td>  0/2 </td><td>  ten </td><td>  no </td><td></td></tr><tr><td>  2017-01-24 22:17:00 </td><td>  0/2 </td><td>  eleven </td><td>  no </td><td></td></tr><tr><td>  2017-01-24 22:37:00 </td><td>  0/2 </td><td>  12 </td><td>  no </td><td>  resetmodem </td></tr><tr><td>  2017-01-24 22:57:00 </td><td>  0/2 </td><td>  13 </td><td>  no </td><td></td></tr><tr><td>  2017-01-24 23:17:00 </td><td>  1/2 </td><td>  0 </td><td>  ok </td><td></td></tr><tr><td>  2017-01-24 23:37:00 </td><td>  1/2 </td><td>  0 </td><td>  ok </td><td></td></tr><tr><td>  2017-01-24 23:57:00 </td><td>  1/2 </td><td>  0 </td><td>  ok </td><td></td></tr></tbody></table><br>  From this log, it is clear that two modem reboots were made, after the second of them our server became ultimately available. <br><br>  A typical situation: the money on the SIM card ran out, the modem does not work, the station is not available.  The account was replenished, but the modem itself cannot start the mobile Internet until it reboots the USB relay (it may be necessary to re-register in the GSM network via cold start).  If everything is okay with the money, the network does not disappear, the modem will work without problems for about 36 hours, and then, most likely, it will freeze again and will require a reboot.  Previously, to reboot the modem, we had to call other time zones, disturb people, explain ... Observers at remote locations received parcels with our fancy device, overpowered the instructions for connecting three USB plugs, and we didn‚Äôt ask them to reboot the modems anymore, now it happens on click USB relay and solved by the computer itself. <br><br>  The <b>program</b> itself <b>is written by us in JScript</b> (it is such a Javascript-like language built into Windows) and installed on the station remotely either via Remote Desktop or through its own centralized station management system using <b>PowerShell Remoting</b> .  It must be said that using PowerShell it is easier to work with a large number of stations: I wrote instructions once, and installation is done automatically at all stations.  In addition, you do not need to wait for the graphical interface to load (as is the case with Remote Desktop). <br><br>  At some critical stations with unstable wired connection, a GSM modem is used as a backup channel.  And it was desirable to turn it on only when the wired channel is not working.  Here, again, the USB relay comes to the rescue: as soon as the pings stopped passing through the main (wired) channel, the modem is turned on, Windows automatically switches to a new connection with another default gateway.  Then, once a day, the modem switches off via a relay so that the main connection can be checked.  If it still does not work, the modem is turned back on. <br><br>  It should be noted that managing default gateways is usually a whole story: there is only one ‚Äúdefault gateway‚Äù in IP laws, and routing table manipulations lead to problems.  The fact is that when a mobile connection is disconnected, the numbers of network adapters, to which manual entries in the routing table are attached, can change.  There are two ways out: either ‚Äúiron‚Äù disconnection of the second channel through the relay, or fine and accurate setting of the gateway metrics with checking the logic of the metrics in all scenarios. <br><br>  All events are written to the database and displayed in the interface of the accounting table of the central server stations: <br><br><img src="https://habrastorage.org/files/9a8/4d3/933/9a84d3933fb547d4b1fa5b333c1fd3de.png"><br><br>  <b>Result</b> <br><br>  I briefly summarize how the resulting system works: <br><br><ol><li>  The computer collects data from the measuring device of the station. </li><li>  USB-modem transmits data over the cellular network. </li><li>  USB relay controls modem power. </li><li>  The program turns off and turns on the power of the modem (through a relay) in case of a hang or when it is necessary to switch the communication channel. </li><li>  The relay turns on the modem smoothly to avoid current surges. </li></ol><br>  The modems that we use cost about 6,000 rubles each, and 2,300 rubles more.  USB relay.  In sum, it is cheaper than using modems with a built-in watchdog timer, which have several disadvantages: <br><br><ol><li>  Watchdog modems use a separate power supply unit, the connector from which would have to be soldered to our 12-volt uninterruptible power supply. </li><li>  It is not possible to simply turn off or turn on the modem to automatically switch between the wired communication channel and GSM. </li><li>  There are cases when the modem is not frozen, but the SIM card is not registered on the network.  Whether the watchdog will help here is unknown.  As well as no one guarantees that he will not hang.  Our solution acts on the end result: no connection - reset the power of the modem. </li></ol><br>  Using the same USB relay to control the modem has the following advantages: <br><br><ol><li>  Modems can be used already available, including inexpensive, often hanging. </li><li>  When a wired connection is working, the modem can simply be turned off, in order not to consume traffic, but to switch it on only if there are problems with the wired connection.  And automatically. </li><li>  Easy installation: you only need to connect three USB plugs and install the program.  It is difficult to make a mistake in the physical connection. </li></ol><br>  You can see and hear how the relay works, turning off and on the modem, in this video: <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/oMv6Lx1vCeM" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>  As a result, the <b>problem of GSM-modem hangup is solved by iron</b> (in the direct and figurative sense) and does not bother us anymore.  But at the same time there were additional opportunities for managing communication channels. <br><br>  The problem of remote unattended points arose because of the specifics of working with distributed systems: we are monitoring space weather and maintain a network of measuring stations, you can read about it <a href="http://space-weather.ru/">here</a> . <br><br>  If you have any questions, please contact: vort@ipg.geospace.ru <br><br>  <b>PS</b> I express my gratitude to my colleague Alexey Vasilyev for participating in writing the article. </div><p>Source: <a href="https://habr.com/ru/post/324436/">https://habr.com/ru/post/324436/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../324424/index.html">‚ÄúComplicated architecture is very simple to do‚Äù - an interview with Oleg Anastasiev from Odnoklassniki</a></li>
<li><a href="../324426/index.html">Where do programmers go after 40</a></li>
<li><a href="../324428/index.html">We share information about the work of your site. Service Overview HostTracker Part 5</a></li>
<li><a href="../324430/index.html">How I did a tester optimizer for finding profitable strategies on the Exchange - 2</a></li>
<li><a href="../324432/index.html">Analysis of demand for virtual servers</a></li>
<li><a href="../324438/index.html">How is the search for package tours in a country where people do not really trust credit cards?</a></li>
<li><a href="../324440/index.html">Tales of the project manager</a></li>
<li><a href="../324442/index.html">How clouds change the colocation market in data centers</a></li>
<li><a href="../324444/index.html">We are inventing a name for the new hypervisor for MIPS architecture with hardware-supported virtualization</a></li>
<li><a href="../324446/index.html">Vkontakte made another breakthrough. For a short time, all users of the social network received moderator rights.</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>