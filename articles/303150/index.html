<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We automate the purchase of railway tickets Ukrzal—ñznits—ñ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello! Probably, each of us once came across a situation where you need to urgently go somewhere, but all the F / D tickets are already sold out. In t...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We automate the purchase of railway tickets Ukrzal—ñznits—ñ</h1><div class="post__text post__text-html js-mediator-article"><p>  Hello!  Probably, each of us once came across a situation where you need to urgently go somewhere, but all the F / D tickets are already sold out.  In this article I will talk about how I wrote Telegram bot to track and purchase vacated tickets Ukrzal—ñznits—ñ. </p><br><h1>  How it works </h1><br><p>  For the purchase of train tickets in Ukraine, the company Ukrzaliznitsya launched a resource <a href="http://booking.uz.gov.ua/">http://booking.uz.gov.ua/</a> .  The resource is convenient because you do not need to visit the ticket office to pick up the ticket itself.  It is enough to show the conductor the QR code from the boarding pass on the smartphone screen or printed out on the printer. </p><br><p>  The problem is that on popular flights the places end very quickly and sometimes buying a ticket is quite problematic.  However, many people do not buy a ticket, but book it.  The reservation is valid only for 24 hours and after that, if it is not purchased at the box office, the ticket will be returned to the pool of free.  Thus, it is necessary to have time to catch this moment when the ticket is available for purchase before it is again booked or purchased. </p><br><p>  It was decided to solve this problem with the help of a script, which once a minute checks free tickets for the train of interest and, if available, reserves it for 15 minutes.  After that, the user must complete the procedure of payment through a web browser. </p><br><p>  Telegram was chosen as the interface as it is a new platform for me and I wanted to deal with it a bit.  As a bonus, we immediately receive notifications to the mobile, without thinking about push notifications or emails. <br>  Python was chosen as the programming language. </p><a name="habracut"></a><br><h2>  Interface </h2><br><p>  And yet, how does this work from the user's point of view? <br>  The bot recognizes the following commands: </p><br><ul><li> <code>/help</code> - returns list of supported commands. </li><li>  <code>/trains 2016-06-12 Kyiv Lviv</code> - will return the list of trains from Kiev to Lviv, departing June 12, 2016 </li><li>  <code>/scan Ivanov Ivan 2016-06-12 Kyiv Lviv 743K</code> - will start monitoring tickets for the 743K Kiev-Lviv train.  Returns ID of this scan. </li><li>  <code>/status_1234</code> - will return the scan status with ID 1234 </li><li>  <code>/abort_1234</code> - will stop scanning with ID 1234 </li></ul><br><p>  In case of successful reservation of the ticket, the user will receive a message containing the Session ID.  This ID is then required to manually register in the browser‚Äôs cookie and complete the ticket purchase. </p><br><h1>  UZ API </h1><br><p>  First, let's deal with the API format used by the portal.  This is not a big deal, just open the developer console in the browser and see what requests the script performs on the ticket search page. </p><br><p>  The API uses only POST requests.  To protect against third-party API use, a token is included in the body in almost all calls.  Without a token, you can only search for stations. </p><br><p>  It is also worth noting some of the nuances of working with dates.  First, the date format changes depending on the current locale of the API.  For example, for the <code>en</code> locale, the format would be <code>mm.dd.yyyy</code> .  Whereas for <code>ua</code> and <code>ru</code> it will be familiar to us <code>dd.mm.yyyy</code> .  Secondly, for some requests, the date is represented as a timestamp, but it depends on the state of summer / winter time.  So I decided not to bother with serializing / deserializing these stamps, but to use them in the form in which the API returns them. </p><br><h2>  Getting a token </h2><br><p>  Having rummaged in scripts connected by a site, it is possible to find out such piece with ease: </p><br><pre> <code class="hljs javascript"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ajax = $v.ajax(url).header({ <span class="hljs-string"><span class="hljs-string">'GV-Ajax'</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">'GV-Referer'</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">encodeURI</span></span>(GV.site.htcur_url + GV.site.requestUri), <span class="hljs-string"><span class="hljs-string">'GV-Screen'</span></span>: screen.width + <span class="hljs-string"><span class="hljs-string">'x'</span></span> + screen.height, <span class="hljs-string"><span class="hljs-string">'GV-Token'</span></span>: localStorage.getItem(<span class="hljs-string"><span class="hljs-string">'gv-token'</span></span>) || <span class="hljs-string"><span class="hljs-string">''</span></span> });</code> </pre> <br><p>  Here we see that when calling the API, the token is read from the browser localStorage.  It remains to find where it is recorded there. </p><br><p>  This part was the most interesting, because it could not be found by a simple search on html and js.  After spending several hours in Google, I came across an <a href="https://good-developers.com/skript-dlya-monitoringa-biletov-1/">article</a> in which the author resolves the same issue with monitoring tickets on the UZ website.  So, the article describes in detail that the token is generated by obfuscated code using <a href="http://utf-8.jp/public/jjencode.html">JJEncode</a> .  In a few minutes we find the implementation of <a href="https://github.com/crackinglandia/python-jjdecoder">deobfuscator on python</a> , which will be used in the future. </p><br><h2>  Short API reference </h2><br><p>  To call API methods, you must include the following headers: </p><br><pre> <code class="hljs objectivec">GV-Ajax: <span class="hljs-number"><span class="hljs-number">1</span></span> GV-Referer: http:<span class="hljs-comment"><span class="hljs-comment">//booking.uz.gov.ua/en/ GV-Token: &lt;token&gt;</span></span></code> </pre> <br><h3>  Search stations </h3><br><p>  For example, to generate hints for autocompletion of stations, a request is made with an empty body at <code>http://booking.uz.gov.ua/en/purchase/station/ky/</code> , where <code>ky</code> is what the user enters in the text box of the station selection. </p><br><p>  In response, the server sends approximately the following JSON: </p><br><pre> <code class="hljs json">{ <span class="hljs-attr"><span class="hljs-attr">"value"</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">"title"</span></span>: <span class="hljs-string"><span class="hljs-string">"Kyiv"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"station_id"</span></span>: <span class="hljs-string"><span class="hljs-string">"2200001"</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">"title"</span></span>: <span class="hljs-string"><span class="hljs-string">"Kyivska Rusanivka"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"station_id"</span></span>: <span class="hljs-string"><span class="hljs-string">"2201180"</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">"title"</span></span>: <span class="hljs-string"><span class="hljs-string">"Kyj"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"station_id"</span></span>: <span class="hljs-string"><span class="hljs-string">"2031278"</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">"title"</span></span>: <span class="hljs-string"><span class="hljs-string">"Kykshor"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"station_id"</span></span>: <span class="hljs-string"><span class="hljs-string">"2011189"</span></span> } ], <span class="hljs-attr"><span class="hljs-attr">"error"</span></span>: <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-attr"><span class="hljs-attr">"data"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"req_text"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"ky"</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span> ] }, <span class="hljs-attr"><span class="hljs-attr">"captcha"</span></span>: <span class="hljs-literal"><span class="hljs-literal">null</span></span> }</code> </pre> <br><h3>  Search for trains </h3><br><p>  To search for trains, you must perform a request at <code>http://booking.uz.gov.ua/en/purchase/search/</code> with the following body: </p><br><pre> <code class="hljs objectivec">station_id_from=<span class="hljs-number"><span class="hljs-number">2200001</span></span> <span class="hljs-meta"><span class="hljs-meta"># ID   station_id_till=2218000 # ID   date_dep=06.12.2016 #     mm.dd.yyyy time_dep=00:00 time_dep_till= another_ec=0 search=</span></span></code> </pre> <br><p>  In response, we will receive a list of trains following the specified route.  Also, the answer will include information on the number of empty seats in the cars of each type (Suite, Coupe, Platzkart, etc.): </p><br><pre> <code class="hljs json">{ <span class="hljs-attr"><span class="hljs-attr">"value"</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">"num"</span></span>: <span class="hljs-string"><span class="hljs-string">"743"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"model"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-attr"><span class="hljs-attr">"category"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-attr"><span class="hljs-attr">"travel_time"</span></span>: <span class="hljs-string"><span class="hljs-string">"5:01"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"from"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"station_id"</span></span>: <span class="hljs-number"><span class="hljs-number">2200001</span></span>, <span class="hljs-attr"><span class="hljs-attr">"station"</span></span>: <span class="hljs-string"><span class="hljs-string">"Darnytsya"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"date"</span></span>: <span class="hljs-number"><span class="hljs-number">1465741200</span></span>, <span class="hljs-attr"><span class="hljs-attr">"src_date"</span></span>: <span class="hljs-string"><span class="hljs-string">"2016-06-12 17:20:00"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"till"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"station_id"</span></span>: <span class="hljs-number"><span class="hljs-number">2218000</span></span>, <span class="hljs-attr"><span class="hljs-attr">"station"</span></span>: <span class="hljs-string"><span class="hljs-string">"Lviv"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"date"</span></span>: <span class="hljs-number"><span class="hljs-number">1465759260</span></span>, <span class="hljs-attr"><span class="hljs-attr">"src_date"</span></span>: <span class="hljs-string"><span class="hljs-string">"2016-06-12 22:21:00"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"types"</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">"title"</span></span>: <span class="hljs-string"><span class="hljs-string">"Seating first class"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"letter"</span></span>: <span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"places"</span></span>: <span class="hljs-number"><span class="hljs-number">117</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">"title"</span></span>: <span class="hljs-string"><span class="hljs-string">"Seating second class"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"letter"</span></span>: <span class="hljs-string"><span class="hljs-string">"2"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"places"</span></span>: <span class="hljs-number"><span class="hljs-number">176</span></span> } ], <span class="hljs-attr"><span class="hljs-attr">"reserve_error"</span></span>: <span class="hljs-string"><span class="hljs-string">"reserve_24h"</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">"num"</span></span>: <span class="hljs-string"><span class="hljs-string">"091"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"model"</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-attr"><span class="hljs-attr">"category"</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-attr"><span class="hljs-attr">"travel_time"</span></span>: <span class="hljs-string"><span class="hljs-string">"7:25"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"from"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"station_id"</span></span>: <span class="hljs-number"><span class="hljs-number">2200001</span></span>, <span class="hljs-attr"><span class="hljs-attr">"station"</span></span>: <span class="hljs-string"><span class="hljs-string">"Kyiv-Pasazhyrsky"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"date"</span></span>: <span class="hljs-number"><span class="hljs-number">1465760460</span></span>, <span class="hljs-attr"><span class="hljs-attr">"src_date"</span></span>: <span class="hljs-string"><span class="hljs-string">"2016-06-12 22:41:00"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"till"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"station_id"</span></span>: <span class="hljs-number"><span class="hljs-number">2218000</span></span>, <span class="hljs-attr"><span class="hljs-attr">"station"</span></span>: <span class="hljs-string"><span class="hljs-string">"Lviv"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"date"</span></span>: <span class="hljs-number"><span class="hljs-number">1465787160</span></span>, <span class="hljs-attr"><span class="hljs-attr">"src_date"</span></span>: <span class="hljs-string"><span class="hljs-string">"2016-06-13 06:06:00"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"types"</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">"title"</span></span>: <span class="hljs-string"><span class="hljs-string">"Suite / first-class sleeper"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"letter"</span></span>: <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-attr"><span class="hljs-attr">"places"</span></span>: <span class="hljs-number"><span class="hljs-number">11</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">"title"</span></span>: <span class="hljs-string"><span class="hljs-string">"Coupe / coach with compartments"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"letter"</span></span>: <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-attr"><span class="hljs-attr">"places"</span></span>: <span class="hljs-number"><span class="hljs-number">50</span></span> } ], <span class="hljs-attr"><span class="hljs-attr">"reserve_error"</span></span>: <span class="hljs-string"><span class="hljs-string">"reserve_24h"</span></span> } ], <span class="hljs-attr"><span class="hljs-attr">"error"</span></span>: <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-attr"><span class="hljs-attr">"data"</span></span>: <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-attr"><span class="hljs-attr">"captcha"</span></span>: <span class="hljs-literal"><span class="hljs-literal">null</span></span> }</code> </pre> <br><h3>  View wagons </h3><br><p>  You can view the list of cars and the number of empty seats by completing a request at <code>http://booking.uz.gov.ua/en/purchase/coaches/</code> with the following body: </p><br><pre> <code class="hljs objectivec">station_id_from=<span class="hljs-number"><span class="hljs-number">2200001</span></span> station_id_till=<span class="hljs-number"><span class="hljs-number">2218000</span></span> date_dep=<span class="hljs-number"><span class="hljs-number">1462976400</span></span> train=<span class="hljs-number"><span class="hljs-number">743</span></span> <span class="hljs-meta"><span class="hljs-meta">#   model=3 #   coach_type=2 #   (, ,  . .) round_trip=0 another_ec=0</span></span></code> </pre> <br><p>  In response, we will receive a list of cars of this type with the number of empty seats and the price: </p><br><pre> <code class="hljs json">{ <span class="hljs-attr"><span class="hljs-attr">"coach_type_id"</span></span>: <span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-attr"><span class="hljs-attr">"coaches"</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">"num"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-attr"><span class="hljs-attr">"allow_bonus"</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-attr"><span class="hljs-attr">"places_cnt"</span></span>: <span class="hljs-number"><span class="hljs-number">21</span></span>, <span class="hljs-attr"><span class="hljs-attr">"has_bedding"</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-attr"><span class="hljs-attr">"reserve_price"</span></span>: <span class="hljs-number"><span class="hljs-number">1700</span></span>, <span class="hljs-attr"><span class="hljs-attr">"services"</span></span>: [], <span class="hljs-attr"><span class="hljs-attr">"prices"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">""</span></span>: <span class="hljs-number"><span class="hljs-number">35831</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"coach_type_id"</span></span>: <span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-attr"><span class="hljs-attr">"coach_class"</span></span>: <span class="hljs-string"><span class="hljs-string">"2"</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">"num"</span></span>: <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-attr"><span class="hljs-attr">"allow_bonus"</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-attr"><span class="hljs-attr">"places_cnt"</span></span>: <span class="hljs-number"><span class="hljs-number">21</span></span>, <span class="hljs-attr"><span class="hljs-attr">"has_bedding"</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-attr"><span class="hljs-attr">"reserve_price"</span></span>: <span class="hljs-number"><span class="hljs-number">1700</span></span>, <span class="hljs-attr"><span class="hljs-attr">"services"</span></span>: [], <span class="hljs-attr"><span class="hljs-attr">"prices"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">""</span></span>: <span class="hljs-number"><span class="hljs-number">35831</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"coach_type_id"</span></span>: <span class="hljs-number"><span class="hljs-number">9</span></span>, <span class="hljs-attr"><span class="hljs-attr">"coach_class"</span></span>: <span class="hljs-string"><span class="hljs-string">"2"</span></span> } ], <span class="hljs-attr"><span class="hljs-attr">"places_allowed"</span></span>: <span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-attr"><span class="hljs-attr">"places_max"</span></span>: <span class="hljs-number"><span class="hljs-number">8</span></span> }</code> </pre> <br><h3>  View available places </h3><br><p>  To view the available seats in the selected car, you must fulfill the request at <code>http://booking.uz.gov.ua/en/purchase/coach/</code> with the body: </p><br><pre> <code class="hljs">station_id_from=2200001 station_id_till=2218000 train=743 coach_num=1 coach_class=2 coach_type_id=19 date_dep=1462976400 change_scheme=1</code> </pre> <br><p>  In response, we get a list of available places: </p><br><pre> <code class="hljs json">{ <span class="hljs-attr"><span class="hljs-attr">"value"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"places"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">""</span></span>: [ <span class="hljs-string"><span class="hljs-string">"8"</span></span>, <span class="hljs-string"><span class="hljs-string">"12"</span></span>, <span class="hljs-string"><span class="hljs-string">"16"</span></span>, <span class="hljs-string"><span class="hljs-string">"18"</span></span>, <span class="hljs-string"><span class="hljs-string">"22"</span></span>, <span class="hljs-string"><span class="hljs-string">"27"</span></span>, <span class="hljs-string"><span class="hljs-string">"28"</span></span>, <span class="hljs-string"><span class="hljs-string">"32"</span></span>, <span class="hljs-string"><span class="hljs-string">"33"</span></span>, <span class="hljs-string"><span class="hljs-string">"34"</span></span>, <span class="hljs-string"><span class="hljs-string">"36"</span></span>, <span class="hljs-string"><span class="hljs-string">"37"</span></span>, <span class="hljs-string"><span class="hljs-string">"38"</span></span>, <span class="hljs-string"><span class="hljs-string">"39"</span></span>, <span class="hljs-string"><span class="hljs-string">"42"</span></span>, <span class="hljs-string"><span class="hljs-string">"43"</span></span>, <span class="hljs-string"><span class="hljs-string">"47"</span></span>, <span class="hljs-string"><span class="hljs-string">"48"</span></span>, <span class="hljs-string"><span class="hljs-string">"49"</span></span>, <span class="hljs-string"><span class="hljs-string">"55"</span></span>, <span class="hljs-string"><span class="hljs-string">"56"</span></span> ] } }, <span class="hljs-attr"><span class="hljs-attr">"error"</span></span>: <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-attr"><span class="hljs-attr">"data"</span></span>: <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-attr"><span class="hljs-attr">"captcha"</span></span>: <span class="hljs-literal"><span class="hljs-literal">null</span></span> }</code> </pre> <br><h3>  Work with a basket </h3><br><p>  In order to put a ticket in the basket, thus having reserved it for 15 minutes for payment, you must fulfill the request at <code>http://booking.uz.gov.ua/en/cart/add/</code> with the body: </p><br><pre> <code class="hljs markdown">code<span class="hljs-emphasis"><span class="hljs-emphasis">_station_</span></span>from:2200007 code<span class="hljs-emphasis"><span class="hljs-emphasis">_station_</span></span>to:2218000 train:743 date:1463580000 round<span class="hljs-emphasis"><span class="hljs-emphasis">_trip:0 places[0][ord]:0 places[0][coach_</span></span>num]:5 places[<span class="hljs-string"><span class="hljs-string">0</span></span>][<span class="hljs-symbol"><span class="hljs-symbol">coach_class</span></span>]:2 places[<span class="hljs-string"><span class="hljs-string">0</span></span>][<span class="hljs-symbol"><span class="hljs-symbol">coach_type_id</span></span>]:22 places[<span class="hljs-string"><span class="hljs-string">0</span></span>][<span class="hljs-symbol"><span class="hljs-symbol">place_num</span></span>]:37 places[<span class="hljs-string"><span class="hljs-string">0</span></span>][<span class="hljs-symbol"><span class="hljs-symbol">firstname</span></span>]:Name places[<span class="hljs-string"><span class="hljs-string">0</span></span>][<span class="hljs-symbol"><span class="hljs-symbol">lastname</span></span>]:Surname places[<span class="hljs-string"><span class="hljs-string">0</span></span>][<span class="hljs-symbol"><span class="hljs-symbol">bedding</span></span>]:0 places[<span class="hljs-string"><span class="hljs-string">0</span></span>][<span class="hljs-symbol"><span class="hljs-symbol">child</span></span>]: places[<span class="hljs-string"><span class="hljs-string">0</span></span>][<span class="hljs-symbol"><span class="hljs-symbol">stud</span></span>]: places[<span class="hljs-string"><span class="hljs-string">0</span></span>][<span class="hljs-symbol"><span class="hljs-symbol">transp</span></span>]:0 places[<span class="hljs-string"><span class="hljs-string">0</span></span>][<span class="hljs-symbol"><span class="hljs-symbol">reserve</span></span>]:0</code> </pre> <br><h1>  Monitoring </h1><br><p>  So, here we are at the most interesting part, the monitoring of free tickets.  To solve this problem, the <code>UZScanner</code> class has been implemented, which has several methods: </p><br><ul><li>  add train to monitor </li><li>  remove train from monitoring </li><li>  launch monitoring </li><li>  stop monitoring </li></ul><br><p>  The monitoring class is implemented in such a way that you can easily connect any user interfaces to it, for example, any other non-Telegram, bot, or web site. </p><br><p>  Monitoring is an asynchronous process and is performed as quorutine.  In case of successful reservation of the ticket, the callback monitoring is performed, informing the user about the result.  For this, a callback function is passed to the class constructor. </p><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UZScanner</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(object)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, success_cb, delay=</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">60</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">:</span></span> self.success_cb = success_cb self.loop = asyncio.get_event_loop() self.delay = delay self.session = aiohttp.ClientSession() self.client = UZClient(self.session) self.__state = dict() self.__running = <span class="hljs-keyword"><span class="hljs-keyword">False</span></span></code> </pre> <br><p>  In order for the calling code to distinguish for which particular user the callback occurred, in addition to the data on the train itself, callback ID is also transmitted: </p><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">add_item</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, success_cb_id, firstname, lastname, date, source, destination, train_num, ct_letter=None)</span></span></span><span class="hljs-function">:</span></span> scan_id = uuid4().hex self.__state[scan_id] = dict( success_cb_id=success_cb_id, firstname=firstname, lastname=lastname, date=date, source=source, destination=destination, train_num=train_num, ct_letter=ct_letter, lock=asyncio.Lock(), attempts=<span class="hljs-number"><span class="hljs-number">0</span></span>, error=<span class="hljs-keyword"><span class="hljs-keyword">None</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> scan_id</code> </pre> <br><p>  The main monitoring function is a cycle in which the function of checking seats is launched for each train. </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> self.__running = <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> self.__running: <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> scan_id, data <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> self.__state.items(): asyncio.ensure_future(self.scan(scan_id, data)) <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> reliable_async_sleep(self.delay)</code> </pre> <br><p>  The monitoring function itself works according to the following algorithm: </p><br><ul><li>  Get a list of trains for a given date on a given route </li><li>  Check if there is a desired train. </li><li>  For all cars (or only for the specified type) check availability </li><li>  Try to reserve the first found free space. </li><li>  If successful, execute callback, remove train from monitoring. </li></ul><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">scan</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, scan_id, data)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> data[<span class="hljs-string"><span class="hljs-string">'lock'</span></span>].locked(): <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> data[<span class="hljs-string"><span class="hljs-string">'lock'</span></span>]: data[<span class="hljs-string"><span class="hljs-string">'attempts'</span></span>] += <span class="hljs-number"><span class="hljs-number">1</span></span> train = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> self.client.fetch_train( data[<span class="hljs-string"><span class="hljs-string">'date'</span></span>], data[<span class="hljs-string"><span class="hljs-string">'source'</span></span>], data[<span class="hljs-string"><span class="hljs-string">'destination'</span></span>], data[<span class="hljs-string"><span class="hljs-string">'train_num'</span></span>]) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> train <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">None</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> self.handle_error( scan_id, data, <span class="hljs-string"><span class="hljs-string">'Train {} not found'</span></span>.format(data[<span class="hljs-string"><span class="hljs-string">'train_num'</span></span>])) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> data[<span class="hljs-string"><span class="hljs-string">'ct_letter'</span></span>]: coach_type = self.find_coach_type(train, data[<span class="hljs-string"><span class="hljs-string">'ct_letter'</span></span>]) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> coach_type <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">None</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> self.handle_error( scan_id, data, <span class="hljs-string"><span class="hljs-string">'Coach type {} not found'</span></span>.format(data[<span class="hljs-string"><span class="hljs-string">'ct_letter'</span></span>])) coach_types = [coach_type] <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: coach_types = train.coach_types session_id = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> self.book(train, coach_types, data[<span class="hljs-string"><span class="hljs-string">'firstname'</span></span>], data[<span class="hljs-string"><span class="hljs-string">'lastname'</span></span>]) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> session_id <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">None</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> self.handle_error(scan_id, data, <span class="hljs-string"><span class="hljs-string">'No available seats'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> self.success_cb(data[<span class="hljs-string"><span class="hljs-string">'success_cb_id'</span></span>], session_id) self.abort(scan_id) @staticmethod <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">book</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(train, coach_types, firstname, lastname)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> UZClient() <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> client: <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> coach_type <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> coach_types: <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> coach <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> client.list_coaches(train, coach_type): <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: seats = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> client.list_seats(train, coach) <span class="hljs-keyword"><span class="hljs-keyword">except</span></span> ResponseError: <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> seat <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> seats: <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> client.book_seat(train, coach, seat, firstname, lastname) <span class="hljs-keyword"><span class="hljs-keyword">except</span></span> ResponseError: <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> client.get_session_id()</code> </pre> <br><h1>  Conclusion </h1><br><p>  We dealt with the API used by the <a href="http://booking.uz.gov.ua/">http://booking.uz.gov.ua</a> portal and implemented the ticket reservation script.  The code is available on <a href="https://github.com/vit-/telegram-uz-bot">github</a> .  Docker image is available on <a href="https://hub.docker.com/r/vit1/telegram-uz-bot/">DockerHub</a> .  Also available Telegram bot <a href="http://telegram.me/uz_ticket_bot">@uz_ticket_bot</a> </p><br><p>  UPD UZ blocked IP bot.  Bot is temporarily disabled. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/303150/">https://habr.com/ru/post/303150/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../303138/index.html">What makes us go to work every morning?</a></li>
<li><a href="../303140/index.html">Matrix procrastination (postponing cases "for later")</a></li>
<li><a href="../303142/index.html">OpenGL ES 2.0. One million particles</a></li>
<li><a href="../303144/index.html">CD Changer Control Protocol</a></li>
<li><a href="../303146/index.html">NetApp SDS: ONTAP Select</a></li>
<li><a href="../303156/index.html">Delayed Durability or a story about how to speed up the execution of autotests from 11 to 2.5 minutes</a></li>
<li><a href="../303158/index.html">The digest of interesting materials for the mobile # 157 developer (June 6-13)</a></li>
<li><a href="../303160/index.html">10 rules that allow NASA to write millions of lines of code with minimal errors</a></li>
<li><a href="../303162/index.html">On the implementation of persistent processes in real-time control systems (part 1)</a></li>
<li><a href="../303164/index.html">Renewal of the old code or how to do well to an application that is bad</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>