<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We write a bot for MMORPG with assembler and draenei. Part 3</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi% username%! So, let's continue writing our bot. From past articles, we learned how to find the address of the intercepted function for DirectX 9 an...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We write a bot for MMORPG with assembler and draenei. Part 3</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/708/53f/a39/70853fa39f3f4d4f82bc6525a2ebc41f.png" align="left">  Hi% username%!  So, let's continue writing our bot.  From past articles, we learned how to find the address of the intercepted function for DirectX 9 and 11, as well as execute arbitrary assembly code in the main stream of the game and hide from various methods of protection.  Now all this knowledge can be applied in real combat conditions.  And we begin with the study of the program for which we write the bot. <a name="habracut"></a><br><br><h6>  <b>Disclaimer: The author is not responsible for your use of the knowledge gained in this article or damage as a result of their use.</b>  <b>All information here is for educational purposes only.</b>  <b>Especially for companies developing MMORPG, that would help them to fight with the bot.</b>  <b>And, of course, the author of the article is not a botmaster, not a cheater, and never was.</b> <br></h6><br><hr><br><br>  For those who missed past articles, here is the content, and who read everything, we go further: <br><h6>  <b>Content</b> </h6><br><ol><li>  <a href="http://habrahabr.ru/post/251137/">Part 0 - Search for a code injection point</a> </li><li>  <a href="http://habrahabr.ru/post/251149/">Part 1 - Implementing and executing third-party code</a> </li><li>  <a href="http://habrahabr.ru/post/251199/">Part 2 - Hide the code from prying eyes</a> </li><li>  <a href="http://habrahabr.ru/post/251353/">Part 3 - Under the gun World of Warcraft 5.4.x (Structures)</a> </li><li>  <a href="http://habrahabr.ru/post/251479/">Part 4 - Under the gun World of Warcraft 5.4.x (Moving)</a> </li><li>  Part 5 - Under the gun World of Warcraft 5.4.x (Casting Fireball) </li></ol>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Before you start, you can put on World of Warcraft 5.4.x download, for a start, we only need Wow.exe, so you can only download it.  And now I will immerse you in the holy of holies of all the cheaters and botovodov World of Warcraft game. <br>  I'll start quite far away.  Each program has an algorithm by which it works and the memory in which it stores data, in other words, there is code, and sometimes there is data in the code itself.  So in order to have an idea about the world around us in the game, we need the data.  To get them, consider how they are stored in memory and how they are.  So, we introduce the concept of a game object (hereinafter WowObject) - this is the basic object that is stored in memory and has the following properties Descriptors, ObjectType and Guid, here is its structure: <br><a name="WowObjStruct"></a><br><pre><code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">StructLayout(LayoutKind.Sequential)</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> WowObjStruct { IntPtr vtable; <span class="hljs-comment"><span class="hljs-comment">// 0x00 public IntPtr Descriptors; // 0x4 IntPtr unk1; // 0x8 public int ObjectType; // 0xC int unk3; // 0x10 IntPtr unk4; // 0x14 IntPtr unk5; // 0x18 IntPtr unk6; // 0x1C IntPtr unk7; // 0x20 IntPtr unk8; // 0x24 public ulong Guid; // 0x28 }</span></span></code> </pre> <br>  where Guid is the unique value of the object in the game, OjectType is the type of object in the game and can take the following values: <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> WoWObjectType : <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> { Object = <span class="hljs-number"><span class="hljs-number">0</span></span>, Item = <span class="hljs-number"><span class="hljs-number">1</span></span>, Container = <span class="hljs-number"><span class="hljs-number">2</span></span>, Unit = <span class="hljs-number"><span class="hljs-number">3</span></span>, Player = <span class="hljs-number"><span class="hljs-number">4</span></span>, GameObject = <span class="hljs-number"><span class="hljs-number">5</span></span>, DynamicObject = <span class="hljs-number"><span class="hljs-number">6</span></span>, Corpse = <span class="hljs-number"><span class="hljs-number">7</span></span>, AreaTrigger = <span class="hljs-number"><span class="hljs-number">8</span></span>, SceneObject = <span class="hljs-number"><span class="hljs-number">9</span></span>, NumClientObjectTypes = <span class="hljs-number"><span class="hljs-number">0xA</span></span>, None = <span class="hljs-number"><span class="hljs-number">0x270f</span></span>, } [Flags] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> WoWObjectTypeFlags { Object = <span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; WoWObjectType.Object, Item = <span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; WoWObjectType.Item, Container = <span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; WoWObjectType.Container, Unit = <span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; WoWObjectType.Unit, Player = <span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; WoWObjectType.Player, GameObject = <span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; WoWObjectType.GameObject, DynamicObject = <span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; WoWObjectType.DynamicObject, Corpse = <span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; WoWObjectType.Corpse, AreaTrigger = <span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; WoWObjectType.AreaTrigger, SceneObject = <span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; WoWObjectType.SceneObject }</code> </pre><br>  and Descriptors is a pointer to memory with data about a WowObject object.  To make it clearer I will give a small example: <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">WowObject</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> IntPtr BaseAddress; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WowObjStruct ObjectData; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">WowObject</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IntPtr address</span></span></span><span class="hljs-function">)</span></span> { BaseAddress = address; ObjectData = Memory.Process.Read&lt;WowObjStruct&gt;(BaseAddress); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> IsValid { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> BaseAddress != IntPtr.Zero; } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> T GetValue&lt;T&gt;(Enum index) <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> T : <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Memory.Process.Read&lt;T&gt;(ObjectData.Descriptors + (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)index * IntPtr.Size); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> SetValue&lt;T&gt;(Enum index, T val) <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> T : <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> { Memory.Process.Write&lt;T&gt;(ObjectData.Descriptors + (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)index * IntPtr.Size, val); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">IsA</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">WoWObjectTypeFlags flags</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (GetValue&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt;(Descriptors.ObjectFields.Type) &amp; (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)flags) != <span class="hljs-number"><span class="hljs-number">0</span></span>; } }</code> </pre><br>  For example, we want to get an EntryId (EntryId is something like a class for objects, that is, 2 identical objects in the game world have the same EntryId, but they have a different Guid), here are the basic descriptors for WowObject: <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> ObjectFields { Guid = <span class="hljs-number"><span class="hljs-number">0</span></span>, Data = <span class="hljs-number"><span class="hljs-number">2</span></span>, Type = <span class="hljs-number"><span class="hljs-number">4</span></span>, EntryId = <span class="hljs-number"><span class="hljs-number">5</span></span>, DynamicFlags = <span class="hljs-number"><span class="hljs-number">6</span></span>, Scale = <span class="hljs-number"><span class="hljs-number">7</span></span>, End = <span class="hljs-number"><span class="hljs-number">8</span></span>, } [Flags] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> ObjectDynamicFlags : <span class="hljs-keyword"><span class="hljs-keyword">uint</span></span> { Invisible = <span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; <span class="hljs-number"><span class="hljs-number">0</span></span>, Lootable = <span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; <span class="hljs-number"><span class="hljs-number">1</span></span>, TrackUnit = <span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; <span class="hljs-number"><span class="hljs-number">2</span></span>, TaggedByOther = <span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; <span class="hljs-number"><span class="hljs-number">3</span></span>, TaggedByMe = <span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; <span class="hljs-number"><span class="hljs-number">4</span></span>, Unknown = <span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; <span class="hljs-number"><span class="hljs-number">5</span></span>, Dead = <span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; <span class="hljs-number"><span class="hljs-number">6</span></span>, ReferAFriendLinked = <span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; <span class="hljs-number"><span class="hljs-number">7</span></span>, IsTappedByAllThreatList = <span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; <span class="hljs-number"><span class="hljs-number">8</span></span>, }</code> </pre><br>  Obviously, the code will be as follows: <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">WowObject</span></span> { <span class="hljs-comment"><span class="hljs-comment">//    public int Entry { get { return GetValue&lt;int&gt;(ObjectFields.EntryId); } } }</span></span></code> </pre><br>  All game objects of the game are stored sequentially, i.e.  the structure of the next object will be found at offset 0x28 (see <a href="https://habr.com/ru/post/251353/">WowObjStruct</a> ) from the current pointer, provided that it exists.  Now let's figure out how to find all the structures of the game.  All WowObject is managed by the object manager (hereinafter ObjectManager). <div class="spoiler">  <b class="spoiler_title">Declare it using the following structures.</b> <div class="spoiler_text"><pre> <code class="cs hljs"> [<span class="hljs-meta"><span class="hljs-meta">StructLayout(LayoutKind.Sequential)</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> TSExplicitList <span class="hljs-comment"><span class="hljs-comment">// 12 { public TSList baseClass; // 12 } [StructLayout(LayoutKind.Sequential)] struct TSList // 12 { public int m_linkoffset; // 4 public TSLink m_terminator; // 8 } [StructLayout(LayoutKind.Sequential)] struct TSLink // 8 { public IntPtr m_prevlink; //TSLink *m_prevlink // 4 public IntPtr m_next; // C_OBJECTHASH *m_next // 4 } [StructLayout(LayoutKind.Sequential)] struct TSHashTable // 44 { public IntPtr vtable; // 4 public TSExplicitList m_fulllist; // 12 public int m_fullnessIndicator; // 4 public TSGrowableArray m_slotlistarray; // 20 public int m_slotmask; // 4 } [StructLayout(LayoutKind.Sequential)] struct TSBaseArray // 16 { public IntPtr vtable; // 4 public uint m_alloc; // 4 public uint m_count; // 4 public IntPtr m_data;//TSExplicitList* m_data; // 4 } [StructLayout(LayoutKind.Sequential)] struct TSFixedArray // 16 { public TSBaseArray baseClass; // 16 } [StructLayout(LayoutKind.Sequential)] struct TSGrowableArray // 20 { public TSFixedArray baseclass; // 16 public uint m_chunk; // 4 } [StructLayout(LayoutKind.Sequential)] struct CurMgr // 248 bytes x86, 456 bytes x64 { public TSHashTable VisibleObjects; // m_objects 44 public TSHashTable LazyCleanupObjects; // m_lazyCleanupObjects 44 [MarshalAs(UnmanagedType.ByValArray, SizeConst = 11)] // m_lazyCleanupFifo, m_freeObjects, m_visibleObjects, m_reenabledObjects, whateverObjects... public TSExplicitList[] Links; // Links[10] has all objects stored in VisibleObjects it seems 12 * 11 = 132 #if !X64 public int Unknown1; // wtf is that and why x86 only? // 4 public int Unknown2; // not sure if this actually reflects the new object manager structure, but it does get the rest of the struct aligned correctly public int Unknown3; // not sure if this actually reflects the new object manager structure, but it does get the rest of the struct aligned correctly #endif public ulong ActivePlayer; // 8 public int PlayerType; // 4 public int MapId; // 4 public IntPtr ClientConnection; // 4 public IntPtr MovementGlobals; // 4 }</span></span></code> </pre><br></div></div><br>  And this offset for a specific version of World of Warcraft <br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> ObjectManager { connection = <span class="hljs-number"><span class="hljs-number">0xEC4140</span></span>, objectManager = <span class="hljs-number"><span class="hljs-number">0x462c</span></span>, }</code> </pre><br>  Now I will explain how to find them.  To get started, run IDA and open it, I hope already downloaded, Wow.exe.  How to open, remember BaseAddress, most often it is 0x400000, press Ctrl + L and look for the label <b>aObjectmgrclien</b> .  After switching to it, press Ctrl + X and open the last reference.  You should see something like this: <br><pre> <code class="hljs sql"> push 0 push 0A9Fh push offset aObjectmgrclien ; "ObjectMgrClient.cpp" push 100h <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> sub_5DC588 <span class="hljs-keyword"><span class="hljs-keyword">test</span></span> eax, eax jz <span class="hljs-keyword"><span class="hljs-keyword">short</span></span> loc_79EEEB mov ecx, eax <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> sub_79E1E1 jmp <span class="hljs-keyword"><span class="hljs-keyword">short</span></span> loc_79EEED loc_79EEEB: <span class="hljs-keyword"><span class="hljs-keyword">xor</span></span> eax, eax loc_79EEED: mov ecx, dword_12C4140 fldz mov [ecx+<span class="hljs-number"><span class="hljs-number">462</span></span>Ch], eax</code> </pre><br>  We are interested in the first dword, this is <b>dword_12C4140</b> and the next following it is <b>mov [ecx + 462Ch], eax</b> .  From here we get, connection = 0x12C4140 - 0x400000 = 0xEC4140, objectManager = 0x462C.  For recalculation, I use <a href="http://fbe.am/vNt">HackCalc</a> <br><img src="//habrastorage.org/files/cdb/73b/738/cdb73b73817e41e09880a3168477ec06.png"><br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ObjectManager</span></span> : <span class="hljs-title"><span class="hljs-title">IEnumerable</span></span>&lt;<span class="hljs-title"><span class="hljs-title">WowObject</span></span>&gt; { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> CurMgr _curMgr; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> IntPtr _baseAddress; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WowGuid _activePlayer; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WowPlayer _activePlayerObj; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">UpdateBaseAddress</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> connection = Memory.Process.Read&lt;IntPtr&gt;((<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)ObjectManager.connection, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); _baseAddress = Memory.Process.Read&lt;IntPtr&gt;(connection + (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)ObjectManager.objectManager); } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> IntPtr BaseAddress { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _baseAddress; } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> WowGuid ActivePlayer { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _activePlayer; } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> WowPlayer ActivePlayerObj { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _activePlayerObj; } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> IntPtr ClientConnection { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _curMgr.ClientConnection; } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> IntPtr </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">FirstObject</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _curMgr.VisibleObjects.m_fulllist.baseClass.m_terminator.m_next; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> IntPtr </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">NextObject</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IntPtr current</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Memory.Process.Read&lt;IntPtr&gt;(current + _curMgr.VisibleObjects.m_fulllist.baseClass.m_linkoffset + IntPtr.Size); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> IEnumerable&lt;WowObject&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetObjects</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { _curMgr = Memory.Process.Read&lt;CurMgr&gt;(BaseAddress); _activePlayer = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> WowGuid(_curMgr.ActivePlayer); IntPtr first = FirstObject(); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (((first.ToInt64() &amp; <span class="hljs-number"><span class="hljs-number">1</span></span>) == <span class="hljs-number"><span class="hljs-number">0</span></span>) &amp;&amp; first != IntPtr.Zero) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> wowObject = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> WowObject(first); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (wowObject.Guid.Value == _curMgr.ActivePlayer) { _activePlayerObj = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> WowPlayer(first); } first = NextObject(first); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> IEnumerator&lt;WowObject&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetEnumerator</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> GetObjects().GetEnumerator(); } IEnumerator IEnumerable.GetEnumerator() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> GetEnumerator(); } }</code> </pre><br>  Thus, we can get all the WowObjects, well, let's learn how to find all game units (these are all game and not game characters).  We introduce the WowUnit class: <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> UnitField { CachedSubName = <span class="hljs-number"><span class="hljs-number">0</span></span>, UnitClassificationOffset2 = <span class="hljs-number"><span class="hljs-number">32</span></span>, CachedQuestItem1 = <span class="hljs-number"><span class="hljs-number">48</span></span>, CachedTypeFlag = <span class="hljs-number"><span class="hljs-number">76</span></span>, IsBossOffset2 = <span class="hljs-number"><span class="hljs-number">76</span></span>, CachedModelId1 = <span class="hljs-number"><span class="hljs-number">92</span></span>, CachedName = <span class="hljs-number"><span class="hljs-number">108</span></span>, UNIT_SPEED = <span class="hljs-number"><span class="hljs-number">128</span></span>, TaxiStatus = <span class="hljs-number"><span class="hljs-number">0xc0</span></span>, TransportGUID = <span class="hljs-number"><span class="hljs-number">2096</span></span>, UNIT_FIELD_X = <span class="hljs-number"><span class="hljs-number">0x838</span></span>, UNIT_FIELD_Y = <span class="hljs-number"><span class="hljs-number">0x83C</span></span>, UNIT_FIELD_Z = <span class="hljs-number"><span class="hljs-number">0x840</span></span>, UNIT_FIELD_R = <span class="hljs-number"><span class="hljs-number">2120</span></span>, DBCacheRow = <span class="hljs-number"><span class="hljs-number">2484</span></span>, IsBossOffset1 = <span class="hljs-number"><span class="hljs-number">2484</span></span>, UnitClassificationOffset1 = <span class="hljs-number"><span class="hljs-number">2484</span></span>, CanInterrupt = <span class="hljs-number"><span class="hljs-number">3172</span></span>, CastingSpellID = <span class="hljs-number"><span class="hljs-number">3256</span></span>, ChannelSpellID = <span class="hljs-number"><span class="hljs-number">3280</span></span>, } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> UnitFields { Charm = ObjectFields.End + <span class="hljs-number"><span class="hljs-number">0</span></span>, Summon = <span class="hljs-number"><span class="hljs-number">10</span></span>, Critter = <span class="hljs-number"><span class="hljs-number">12</span></span>, CharmedBy = <span class="hljs-number"><span class="hljs-number">14</span></span>, SummonedBy = <span class="hljs-number"><span class="hljs-number">16</span></span>, CreatedBy = <span class="hljs-number"><span class="hljs-number">18</span></span>, DemonCreator = <span class="hljs-number"><span class="hljs-number">20</span></span>, Target = <span class="hljs-number"><span class="hljs-number">22</span></span>, BattlePetCompanionGUID = <span class="hljs-number"><span class="hljs-number">24</span></span>, ChannelObject = <span class="hljs-number"><span class="hljs-number">26</span></span>, ChannelSpell = <span class="hljs-number"><span class="hljs-number">28</span></span>, SummonedByHomeRealm = <span class="hljs-number"><span class="hljs-number">29</span></span>, Sex = <span class="hljs-number"><span class="hljs-number">30</span></span>, DisplayPower = <span class="hljs-number"><span class="hljs-number">31</span></span>, OverrideDisplayPowerID = <span class="hljs-number"><span class="hljs-number">32</span></span>, Health = <span class="hljs-number"><span class="hljs-number">33</span></span>, Power = <span class="hljs-number"><span class="hljs-number">34</span></span>, MaxHealth = <span class="hljs-number"><span class="hljs-number">39</span></span>, MaxPower = <span class="hljs-number"><span class="hljs-number">40</span></span>, PowerRegenFlatModifier = <span class="hljs-number"><span class="hljs-number">45</span></span>, PowerRegenInterruptedFlatModifier = <span class="hljs-number"><span class="hljs-number">50</span></span>, Level = <span class="hljs-number"><span class="hljs-number">55</span></span>, EffectiveLevel = <span class="hljs-number"><span class="hljs-number">56</span></span>, FactionTemplate = <span class="hljs-number"><span class="hljs-number">57</span></span>, VirtualItemID = <span class="hljs-number"><span class="hljs-number">58</span></span>, Flags = <span class="hljs-number"><span class="hljs-number">61</span></span>, Flags2 = <span class="hljs-number"><span class="hljs-number">62</span></span>, AuraState = <span class="hljs-number"><span class="hljs-number">63</span></span>, AttackRoundBaseTime = <span class="hljs-number"><span class="hljs-number">64</span></span>, RangedAttackRoundBaseTime = <span class="hljs-number"><span class="hljs-number">66</span></span>, BoundingRadius = <span class="hljs-number"><span class="hljs-number">67</span></span>, CombatReach = <span class="hljs-number"><span class="hljs-number">68</span></span>, DisplayID = <span class="hljs-number"><span class="hljs-number">69</span></span>, NativeDisplayID = <span class="hljs-number"><span class="hljs-number">70</span></span>, MountDisplayID = <span class="hljs-number"><span class="hljs-number">71</span></span>, MinDamage = <span class="hljs-number"><span class="hljs-number">72</span></span>, MaxDamage = <span class="hljs-number"><span class="hljs-number">73</span></span>, MinOffHandDamage = <span class="hljs-number"><span class="hljs-number">74</span></span>, MaxOffHandDamage = <span class="hljs-number"><span class="hljs-number">75</span></span>, AnimTier = <span class="hljs-number"><span class="hljs-number">76</span></span>, PetNumber = <span class="hljs-number"><span class="hljs-number">77</span></span>, PetNameTimestamp = <span class="hljs-number"><span class="hljs-number">78</span></span>, PetExperience = <span class="hljs-number"><span class="hljs-number">79</span></span>, PetNextLevelExperience = <span class="hljs-number"><span class="hljs-number">80</span></span>, ModCastingSpeed = <span class="hljs-number"><span class="hljs-number">81</span></span>, ModSpellHaste = <span class="hljs-number"><span class="hljs-number">82</span></span>, ModHaste = <span class="hljs-number"><span class="hljs-number">83</span></span>, ModRangedHaste = <span class="hljs-number"><span class="hljs-number">84</span></span>, ModHasteRegen = <span class="hljs-number"><span class="hljs-number">85</span></span>, CreatedBySpell = <span class="hljs-number"><span class="hljs-number">86</span></span>, NpcFlag = <span class="hljs-number"><span class="hljs-number">87</span></span>, EmoteState = <span class="hljs-number"><span class="hljs-number">89</span></span>, Stats = <span class="hljs-number"><span class="hljs-number">90</span></span>, StatPosBuff = <span class="hljs-number"><span class="hljs-number">95</span></span>, StatNegBuff = <span class="hljs-number"><span class="hljs-number">100</span></span>, Resistances = <span class="hljs-number"><span class="hljs-number">105</span></span>, ResistanceBuffModsPositive = <span class="hljs-number"><span class="hljs-number">112</span></span>, ResistanceBuffModsNegative = <span class="hljs-number"><span class="hljs-number">119</span></span>, BaseMana = <span class="hljs-number"><span class="hljs-number">126</span></span>, BaseHealth = <span class="hljs-number"><span class="hljs-number">127</span></span>, ShapeshiftForm = <span class="hljs-number"><span class="hljs-number">128</span></span>, AttackPower = <span class="hljs-number"><span class="hljs-number">129</span></span>, AttackPowerModPos = <span class="hljs-number"><span class="hljs-number">130</span></span>, AttackPowerModNeg = <span class="hljs-number"><span class="hljs-number">131</span></span>, AttackPowerMultiplier = <span class="hljs-number"><span class="hljs-number">132</span></span>, RangedAttackPower = <span class="hljs-number"><span class="hljs-number">133</span></span>, RangedAttackPowerModPos = <span class="hljs-number"><span class="hljs-number">134</span></span>, RangedAttackPowerModNeg = <span class="hljs-number"><span class="hljs-number">135</span></span>, RangedAttackPowerMultiplier = <span class="hljs-number"><span class="hljs-number">136</span></span>, MinRangedDamage = <span class="hljs-number"><span class="hljs-number">137</span></span>, MaxRangedDamage = <span class="hljs-number"><span class="hljs-number">138</span></span>, PowerCostModifier = <span class="hljs-number"><span class="hljs-number">139</span></span>, PowerCostMultiplier = <span class="hljs-number"><span class="hljs-number">146</span></span>, MaxHealthModifier = <span class="hljs-number"><span class="hljs-number">153</span></span>, HoverHeight = <span class="hljs-number"><span class="hljs-number">154</span></span>, MinItemLevel = <span class="hljs-number"><span class="hljs-number">155</span></span>, MaxItemLevel = <span class="hljs-number"><span class="hljs-number">156</span></span>, WildBattlePetLevel = <span class="hljs-number"><span class="hljs-number">157</span></span>, BattlePetCompanionNameTimestamp = <span class="hljs-number"><span class="hljs-number">158</span></span>, InteractSpellID = <span class="hljs-number"><span class="hljs-number">159</span></span>, End = <span class="hljs-number"><span class="hljs-number">160</span></span>, } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">WowUnit</span></span> : <span class="hljs-title"><span class="hljs-title">WowObject</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">WowUnit</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IntPtr address</span></span></span><span class="hljs-function">) : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">base</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">address</span></span></span><span class="hljs-function">)</span></span> { } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> Health { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> GetValue&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt;(UnitFields.Health); } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> MaxHealth { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> GetValue&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt;(UnitFields.MaxHealth); } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> IsAlive { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> !IsDead; } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> IsDead { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.Health &lt;= <span class="hljs-number"><span class="hljs-number">0</span></span> || (DynamicFlags &amp; ObjectDynamicFlags.Dead) != <span class="hljs-number"><span class="hljs-number">0</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ulong</span></span> TransportGuid { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> GetValue&lt;<span class="hljs-keyword"><span class="hljs-keyword">ulong</span></span>&gt;(UnitField.TransportGUID); } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> InTransport { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> TransportGuid &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Vector3 Position { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Pointer == IntPtr.Zero) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Vector3.Zero; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (InTransport) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> wowObject = Memory.ObjectManager.GetObjectByGUID(TransportGuid); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (wowObject != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> wowUnit = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> WowUnit(wowObject.Pointer); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (wowUnit.IsValid &amp;&amp; wowUnit.IsAlive) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> wowUnit.Position; } } <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> position = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Vector3( Memory.Process.Read&lt;<span class="hljs-keyword"><span class="hljs-keyword">float</span></span>&gt;(Pointer + (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)UnitField.UNIT_FIELD_X), Memory.Process.Read&lt;<span class="hljs-keyword"><span class="hljs-keyword">float</span></span>&gt;(Pointer + (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)UnitField.UNIT_FIELD_Y), Memory.Process.Read&lt;<span class="hljs-keyword"><span class="hljs-keyword">float</span></span>&gt;(Pointer + (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)UnitField.UNIT_FIELD_Z), <span class="hljs-string"><span class="hljs-string">"None"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> position; } } }</code> </pre><br>  It remains to iterate ObjectManager and check wowObject.IsA (WoWObjectTypeFlags.Unit).  That's all for now, and so the article came out huge for assimilation.  If something will not work, write in a personal with a link to the weights on GitHub.  Good luck! </div><p>Source: <a href="https://habr.com/ru/post/251353/">https://habr.com/ru/post/251353/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../251341/index.html">Whip and ... whip information security in the enterprise</a></li>
<li><a href="../251345/index.html">Pebble Time: a new watch with a color screen</a></li>
<li><a href="../251347/index.html">Context Model Pattern via Aero Framework</a></li>
<li><a href="../251349/index.html">Processing logs based on previous messages in logstash / elasticsearch</a></li>
<li><a href="../251351/index.html">CoinFest-2015-Moscow</a></li>
<li><a href="../251355/index.html">Several subtleties of using jade in Meteor-projects</a></li>
<li><a href="../251357/index.html">Data exchange using MPI. Working with the MPI Library on the example of the Intel¬Æ MPI Library</a></li>
<li><a href="../251359/index.html">Complete energy autonomy or how to survive with solar panels in the outback (part 1. theoretical)</a></li>
<li><a href="../251361/index.html">MVC and Model 2. Component Knowledge and Responsibilities</a></li>
<li><a href="../251363/index.html">Modifying HTTP traffic using FiddlerScript and .NET plug-ins to Fiddler</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>