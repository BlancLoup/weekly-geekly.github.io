<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How to graze cats. The history of building a system of control and accounting of working time for an IT company</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This story is based on a number of successful coincidences, in which we, it seems to us, managed to recognize the correct trend and create a product t...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How to graze cats. The history of building a system of control and accounting of working time for an IT company</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/7b7/4b5/1d1/7b74b51d1aeb4aebabdcf8ef631f9a72.jpg"><br>  This story is based on a number of successful coincidences, in which we, it seems to us, managed to recognize the correct trend and create a product that can suit many like us.  Because ... well, first things first. <br><a name="habracut"></a><br>  So, we are a company that provides high-tech services to its customers - outsourcing IT expertise, remote support, custom software development, etc.  etc.  As with any other company, for us the issue of compliance with labor discipline and control of the presence of our highly qualified employees in the workplace is topical.  Tasks of this kind are relatively successfully solved in cases where employees a) work on a strict schedule in the office and b) their attitude to what is being followed can be neglected.  That is, you can install traditional ACS at the entrance to the office, put the tracking software on the office computers and quietly implement the functions of Big Brother.  But in the case of working with an expert team, all these measures will work rather in the negative, and here's why. <br><br>  First, a typical employee of a high-tech company (hereinafter referred to as ‚Äúexpert‚Äù) is a person who works not only at work and not only in traditional working hours.  It is connected ... it can be a lot with what it is connected - with the actual need to do some work at night, with the difference in time zones with customers, in the end with the fact that the peak performance of our ingenious developer falls on the interval between 23-00 and 4- 00, and at this time he works wonders.  Accordingly, it is necessary to take into account not being in the immediate vicinity of the work computer, but actual work on it (possibly, remotely from home). <br><br>  Secondly, the expert is a freedom-loving creature.  The idea that a program deals exclusively with what controls its activities, acts on it demotivatingly, undermines the spirit of innovative teams and, accordingly, negatively affects productivity. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Thirdly, an expert is an expert, with his professional ambitions.  The existence of software, which he (the expert) opposes, can direct the talents of this person to fight this software.  Thus, our expert at his workplace during his working time will spend energy ... to fight the system of accounting of working time!  Agree that something is wrong here =). <br><br>  Well and, fourthly, high-tech companies themselves are suspicious of programs that collect user data.  Who knows where then this data floats away ... <br><br>  In general, we realized the problem for ourselves, but, like a real ‚Äúshoemaker without shoes,‚Äù we were not in a hurry to solve it.  So far our Client has not addressed us with the same problem.  From here begin previously announced matches. <br><br>  So, our client is a company that provides high-tech services to its customers.  Namely, a startup specializing in the Dedicated Developers Team service (when programmers are leased to a customer).  Gradually, the number of programmers at the client has grown, and the question arose of labor discipline and control of working time.  And the client did not want to use traditional means, for reasons completely coinciding with those described above.  So the coincidence of needs was one hundred percent.  With a proposal to solve this problem for him, the client turned to us, and we enthusiastically (anticipating at least double the benefit =)) began to investigate the issue. <br><br>  It turned out that our client, like us, works mainly under Windows.  And the applications with which he (like us!) Works are rather heavyweight, like SharePoint.  On an ordinary home laptop, and even more so on the iPad, you will not work.  Therefore, employees use their work machine even when they work from home ‚Äî they connect to it through the Remote Desktop Gateway (RDG) service.  Everything like ours! <br><br>  Then it turned out that both we and the customer use Skype for Business (formerly MS Lync) as both a PBX and universal means of communication.  This program, in addition to its direct responsibilities, performs another one - it can at any time report the status of the user's presence in the system.  So, an employee always uses a work computer for work - Skype for Business is always on it - Skype always knows the user's presence status ... A little mental effort - and the idea of ‚Äã‚Äãcollecting a history of status changes and obtaining a work schedule based on it is firmly established in our collective mind.  It remains only to implement it, to which we started. <br><br>  Naturally, the collection of statistics from the client did not make much sense, because  I can't see on which device the employee is currently working.  Consequently, it was necessary to look at the contents of the Skype server databases (this, of course, about the corporate Skype4B servers).  The corresponding information about the database structure of Skype4B servers, although it was not documented, but access to it did not require any decryption or decompilation operations.  Under a cat there are some technical details for interested. <br><br><div class="spoiler">  <b class="spoiler_title">Technical details</b> <div class="spoiler_text">  Plan: <br><ol><li>  Databases Skype for Business server. </li><li>  Rtcdyn base: <ul><li>  Concept client in rtcdyn. </li><li>  We retrieve customers.  Table [RegistrarEndpoint]. </li><li>  We work with changes in customer status.  Table [PublishedInstance]. </li><li>  Customer statuses.  Availability column. </li></ul></li><li>  Log of presence logs. </li></ol><br><h4>  <b>Skype For Business Server Databases</b> </h4><br>  There are two databases we work with when monitoring status changes: <br><br>  <i>[rtc]</i> - contains static information that does not change over time.  This database contains information about users, contact information, profile photos, status messages, etc. <br><br>  <i>[rtcdyn]</i> - contains dynamic information regarding changes in the status of clients (programs) that are connected to the Skype For Business server. <br><br><h4>  <b>Rtcdyn database</b> </h4><br>  As mentioned above, this database contains dynamic information regarding changes in the status of clients (programs) that are connected to the Skype For Business server. <br><br><h5>  <b>Concept of client in rtcdyn</b> </h5><br>  First of all, it should be agreed with the concept of "client".  This is primarily a program or a web browser that connects to the Skype For Business server.  The ‚Äúclient‚Äù to connect requires a username and password and provides additional information regarding the device, time zone.  It is important to understand that the information collected on the "Client" applies only to the "Client" and not the real user.  Those.  the information we will collect depends on where the user launches the ‚ÄúClient‚Äù. <br><br>  Consider an example: <br><ol><li>  User A can launch the client inside the Remote Desktop session, and therefore his client will send the computer information within the Remote Desktop session to the Skype For Business server. </li><li>  User A can run the client on a mobile phone, and therefore the data regarding the mobile phone will be transmitted in the same way. </li></ol><br>  All information from the "clients" are independent of each other. <br><br><h5>  <b>We retrieve customers.</b>  <b>Table [RegistrarEndpoint]</b> </h5><br>  After connecting to the rtcdyn database, we see several tables.  Among them is the RegistrarEndpoint table.  Let's try to extract some information from this table. <br><br><pre><code class="hljs sql"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> top <span class="hljs-number"><span class="hljs-number">5</span></span> ContactInfo <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> [rtcdyn].[dbo].[RegistrarEndpoint];</code> </pre> <br><img src="https://habrastorage.org/files/67e/030/fbb/67e030fbb3d44ba093ead13352ed46e2.jpg"><br><br>  After converting the received information, we can see the information about the source of connection to the Skype For Business server. <br><br>  For example: <br><br><pre> <code class="hljs pgsql">P;sip:<span class="hljs-number"><span class="hljs-number">212.3</span></span><span class="hljs-number"><span class="hljs-number">.112</span></span><span class="hljs-number"><span class="hljs-number">.68</span></span>:<span class="hljs-number"><span class="hljs-number">51024</span></span>;transport=tls;ms-<span class="hljs-type"><span class="hljs-type">opaque</span></span>=b68b30d990;ms-received-cid=<span class="hljs-number"><span class="hljs-number">608500</span></span>;] ;;sip:lyncedge1-uk.point.<span class="hljs-keyword"><span class="hljs-keyword">local</span></span>:<span class="hljs-number"><span class="hljs-number">5061</span></span>;transport=tls;<span class="hljs-type"><span class="hljs-type">opaque</span></span>=state:Ee.ag8rxSddCvwU5-K8q7K742RAAA;lrbwbyztosJ7NpwKGhwBHTHlngAA70f2c5f712 &lt;sip:lyncedge1-uk.point.<span class="hljs-keyword"><span class="hljs-keyword">local</span></span>:<span class="hljs-number"><span class="hljs-number">5061</span></span>;transport=tls;<span class="hljs-type"><span class="hljs-type">opaque</span></span>=state:Ee.ag8rxSddCvwU5-K8q7K742RAAA;lrbwbyztosJ7NpwKGhwBHTHlngAA70f2c5f712&gt;</code> </pre> <br>  From this line, you can extract the IP address of the device from which the "client" is connected. <br><br>  Similarly, you can extract information from the ClientApp column.  This column contains information about the application from which the connection to the Skype For Business server itself takes place. <br><br>  Examples of values ‚Äã‚Äãthat ClientApp may contain are as follows: <br><br>  <i>UCCAPI / 15.0.4753.1000 OC / 15.0.4753.1000 (Skype for Business)</i> <i><br></i>  <i>RTCC / 5.0.0.0 OWA / 15.00.1076.009</i> <br><br>  Based on ClientApp, you can determine the name, type of client and its version. <br><br><h5>  <b>We work with changes in customer status.</b>  <b>Table [PublishedInstance]</b> </h5><br>  The PublishedInstance table is populated automatically when information is received about the status change (Activity) of the ‚ÄúClient‚Äù.  Among all the columns are particularly interesting: <br><br>  <i>PublisherId</i> - user account identifier that connects to Skype For Business; <br><br>  <i>LastPubTime</i> - the date and time at which the change in the status of the "Client" occurred; <br><br>  <i>Data</i> - the main part of the information on the changed status.  It allows you to understand what exactly happened with the status in a specific period of time.  A more detailed description of the information that may be in the column can be found in Chapter 6 of the Enhanced Presence Lync 2010 book. <br><br>  We extract from Data only information about Availability, TimeZoneBias, Device and PublisherId. <br><br>  Separately, it should be said about BoundEndpointId.  This column indicates the session ID, which is established each time a client connects to the Skype For Business server.  Using this identifier, we can determine additional information on the device from which the ‚Äúclient‚Äù is connected.  This allows for status changes to be made individually for each device. <br><br>  As a result, after applying the sample from the Data column, grouping and sorting, we get the following result: <br><img src="https://habrastorage.org/files/c34/0a2/da0/c340a2da0c574adb908772fa1654a336.jpg"><br><br><h5>  <b>Customer statuses.</b>  <b>Availability column</b> </h5><br><br>  All statuses in the database are written only by numbers, and Microsoft does not provide information on what status means.  There is only general information on the ranges that are reserved for various Activities. <br><br>  For example, 15500 - away, mobile.  Or 6700 - busy, presenting. <br><br>  I had to spend time researching and collecting statistics to compile a table of reference ranges. Activity: <br><img src="https://habrastorage.org/files/c68/61f/57d/c6861f57d08d449d93bb596ab9bdebd0.jpg"><br>  In this case, on the basis of the directory and the isav column, it is determined whether the time is counted as active or not. <br><br><h4>  <b>Presence Log</b> </h4><br>  New incoming information on statuses is stored in a separate database, which is not related to the rtc and rtcdyn bases.  At the same time, we compute general information for the past days in order to speed up the output of active and inactive ‚Äúclient‚Äù reports.  Logs are saved using TimerJob, or in the case of using SQL Express using the Windows schedule. <br></div></div><br><br>  As a result, we have complete information about when and how the user's status changed, and about the device from which this status was obtained (in our particular case, we were interested only in office computers, but no one prevented anyone from turning on the fantasy). <br><br>  Using this information, you can get information about the work schedule.  At the moment, with great certainty, we get: <br><ul><li>  The time of arrival at the office. </li><li>  The time of the beginning and end of the lunch break. </li><li>  Leaving time </li><li>  How many hours have been worked. </li><li>  Whether the employee worked in the evening from home. </li></ul><br>  The invoice is enough to build a full-fledged system of control of working time, but with reference to the real workplace of the worker of the intellectual front - a programmer or a support engineer.  Actually, we have implemented such a system, and we are in a hurry to boast. <br><br>  You can receive, for example, such reports: <br><ul><li>  The average and maximum lateness for the period. </li><li>  The entire history of absences, indicating the consent of the head. </li><li>  Time after class work. </li><li>  Work from home - the system receives information from the RDG gateways and you can see whether the employee came to the computer locally or from home. </li></ul><br>  As with all such systems, there is a vacation schedule, sick leave, manager permits for working from home and other bonuses. <br><br>  Another feature is the personal office of the employee, and sending reports to the mail.  That is, the system does not position itself as a ‚Äúspy‚Äù (we will secretly collect information about you, and then we deduct it from salary), but as an ‚Äúassistant‚Äù (we‚Äôll show you that statistics are being kept and let us analyze these statistics and draw conclusions for ourselves) .  This function turned out to be very useful - even though all our employees and employees of the customer are quite responsible people, after the start of the distribution of reports, the average time of presence of an employee in the workplace has increased. <br><br>  Implementation with screenshots of the system: <br><br><div class="spoiler">  <b class="spoiler_title">Skypetime</b> <div class="spoiler_text">  Personal Area: <br><img src="https://habrastorage.org/files/3a8/9a3/7bf/3a89a37bfbfc43128a9985d3abf32f70.png"><br><br>  Employee report for the period: <br><img src="https://habrastorage.org/files/818/055/7a6/8180557a6ef94838b393631b826d1d93.png"><br><br>  more screenshots can be seen on <a href="http://servilon.ru/skypetime/">our website</a> <br></div></div><br><br>  We can state - we coped with the task.  Our customer is satisfied, we are (using the system itself) satisfied, employees whose activities are controlled ... well, at least, not dissatisfied, and some, as already mentioned above, are grateful to the system for structured work schedule reports and other employee-oriented features .  Perhaps, the system should not be used to maintain a time sheet or payroll, but as a tool that provides the manager with evaluative information on the work of an employee, it is very effective.  She is also an invaluable help employee-administrator, leading information about time off and leave.  Such a situation as - an employee on vacation, the head asked him to work out of the house for half a day, and then take this time off time - is now easily monitored.  And the possibility of setting flexible conditions such as ‚Äúif at 9:15 not at work means absenteeism‚Äù or even ‚Äúyou can be late no more than twice a week and if you worked with a customer at night, you can sleep until lunch, and after working from home‚Äù made it possible use the system for IT companies where conventional access control systems are practically not applicable.  Well, the fact that there is no ‚Äúspyware‚Äù on the computers of employees has a positive effect on the atmosphere in the team.  A good working atmosphere is, ‚Äúaccording to British scientists,‚Äù up to 80% of work success =) <br><br>  <b>PS</b> Yes, of course, it would be nice to look at the statistics of work on the Internet, and collect a list of installed programs, but this is a completely different level of espionage, fraught with a loss of team loyalty.  In addition, in our practice, such sophisticated cheaters are extremely rare, and they still rather quickly reveal themselves to be low productivity or poor quality of work - so the reward still finds heroes. <br><br>  Yours, <a href="http://servilon.ru/">Servilon Team</a> </div><p>Source: <a href="https://habr.com/ru/post/272701/">https://habr.com/ru/post/272701/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../272681/index.html">Compare Swift and Rust</a></li>
<li><a href="../272689/index.html">Own index types in Cach√© DBMS</a></li>
<li><a href="../272693/index.html">Microsoft fixed a dangerous vulnerability in Windows Server</a></li>
<li><a href="../272695/index.html">As I have been rewriting my cryptocurrency with PHP for Go for 8 months. Part 1</a></li>
<li><a href="../272697/index.html">Optimizing hyperparameters in Vowpal Wabbit with the new vw-hyperopt module</a></li>
<li><a href="../272703/index.html">The WikiLeaks Revolution: The Digest of Mishaps</a></li>
<li><a href="../272705/index.html">Record and video processing on Android</a></li>
<li><a href="../272707/index.html">Bit magic: getting the next lexicographic combination</a></li>
<li><a href="../272709/index.html">Site navigation - burping a bygone era</a></li>
<li><a href="../272711/index.html">Simple metasearch algorithm in Python</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>