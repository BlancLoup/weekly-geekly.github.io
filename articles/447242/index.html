<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Automation of SQL server in Jenkins: we return the result beautifully</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Again continuing the theme of arranging Zero Touch PROD under RDS . Future DBAs will not be able to connect to the PROD servers directly, but will be ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Automation of SQL server in Jenkins: we return the result beautifully</h1><div class="post__text post__text-html js-mediator-article">  Again <a href="https://habr.com/ru/post/447100/">continuing the theme of arranging <b>Zero Touch PROD</b> under RDS</a> .  Future DBAs will not be able to connect to the PROD servers directly, but will be able to use <b>Jenkins</b> jobs for a limited set of operations.  DBA starts job and after a while receives the letter with the report on performance of this operation.  Let's look at how to present these results to the user. <br><br><img src="https://habrastorage.org/webt/ej/4e/bj/ej4ebj3imh4eyxfm0xky6nvqeqs.jpeg"><br><a name="habracut"></a><br><h2>  Plain text </h2><br>  Let's start with the most trivial.  The first way is so simple that there‚Äôs nothing to talk about (the author uses FreeStyle jobs hereinafter): <br><br><img src="https://habrastorage.org/webt/0f/ky/by/0fkybyskomac9dfvff-hn_cfgke.png">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <b>sqlcmd</b> does something, and we will present it to the user.  Ideal for, for example, backup jobs: <br><br><img src="https://habrastorage.org/webt/xk/uf/jj/xkufjjpltumusxosfefqhjvndni.png"><br><br>  Do not forget, by the way, that under RDS backup / restore asnhronen, so we should wait for it: <br><br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> @rds <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>, task_type <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">128</span></span>), database_name sysname, pct <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">duration</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>, lifecycle <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">128</span></span>), taskinfo <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">max</span></span>) <span class="hljs-literal"><span class="hljs-literal">null</span></span>, upd datetime, cre datetime, s3 <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">256</span></span>), ovr <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>, KMS <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">256</span></span>) <span class="hljs-literal"><span class="hljs-literal">null</span></span>) waitfor delay <span class="hljs-string"><span class="hljs-string">'00:00:20'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> @rds exec msdb.dbo.rds_task_status @db_name=<span class="hljs-string"><span class="hljs-string">'{db}'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> @xid=<span class="hljs-keyword"><span class="hljs-keyword">max</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> @rds again: waitfor delay <span class="hljs-string"><span class="hljs-string">'00:00:02'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">delete</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> @rds <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> @rds exec msdb.dbo.rds_task_status @db_name=<span class="hljs-string"><span class="hljs-string">'{db}'</span></span> <span class="hljs-comment"><span class="hljs-comment"># {db} substituted with db name by powershell select @stat=lifecycle,@info=taskinfo from @rds where id=@xid if @stat not in ('ERROR','SUCCESS','CANCELLED') goto again</span></span></code> </pre> <br><h2>  Second way CSV </h2><br>  Here, everything is also very simple: <br><br><img src="https://habrastorage.org/webt/kj/kv/wl/kjkvwliuz5u6kxkq2yctxv2e39k.png"><br><br>  However, this method only works if the data returned in CSV is ‚Äúsimple‚Äù.  If you try to return, for example, the list of TOP N CPU intensive queries, then the CSV will ‚Äúbreak up‚Äù because the query text may contain any characters - commas, quotes, and even line breaks.  Therefore, we need something more complicated. <br><br><h2>  Beautiful signs on HTML </h2><br>  I'll give you a snippet right away. <br><br><pre> <code class="python hljs">$Header = @<span class="hljs-string"><span class="hljs-string">" &lt;style&gt; TABLE {border-width: 1px; border-style: solid; border-color: black; border-collapse: collapse;} TH {border-width: 1px; padding: 3px; border-style: solid; border-color: black; background-color: #6495ED;} TD {border-width: 1px; padding: 3px; border-style: solid; border-color: black;} &lt;/style&gt; "</span></span>@ $Result = invoke-Sqlcmd -ConnectionString $jstr -Query <span class="hljs-string"><span class="hljs-string">"select * from DbInv"</span></span> ` | Select-Object -Property * -ExcludeProperty <span class="hljs-string"><span class="hljs-string">"ItemArray"</span></span>, <span class="hljs-string"><span class="hljs-string">"RowError"</span></span>, <span class="hljs-string"><span class="hljs-string">"RowState"</span></span>, <span class="hljs-string"><span class="hljs-string">"Table"</span></span>, <span class="hljs-string"><span class="hljs-string">"HasErrors"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($Result -eq $null) { $cnt = <span class="hljs-number"><span class="hljs-number">0</span></span>; } elseif ($Result.getType().FullName -eq <span class="hljs-string"><span class="hljs-string">"System.Management.Automation.PSCustomObject"</span></span>) { $cnt = <span class="hljs-number"><span class="hljs-number">1</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { $cnt = $Result.Rows.Count; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($cnt -gt <span class="hljs-number"><span class="hljs-number">0</span></span>) { $body = <span class="hljs-string"><span class="hljs-string">"&lt;h2&gt;My table&lt;/h2&gt;"</span></span> $Result | ConvertTo-HTML -Title <span class="hljs-string"><span class="hljs-string">"Rows"</span></span> -Head $header -body $body ` | Out-File <span class="hljs-string"><span class="hljs-string">"res.log"</span></span> -Append -Encoding UTF8 } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-string"><span class="hljs-string">"&lt;h3&gt;No data&lt;/h3&gt;"</span></span> | Out-File <span class="hljs-string"><span class="hljs-string">"res.log"</span></span> -Append -Encoding UTF8 }</code> </pre> <br>  By the way, pay attention to the line with System.Management.Automation.PSCustomObject, it is magic, if there is exactly one line in the grid, then there were some problems.  The decision is taken from the Internet without really understanding.  As a result, you get a conclusion that looks like this: <br><br><img src="https://habrastorage.org/webt/fw/ju/ek/fwjuekuiafqwwlzepqsedusdas8.png"><br><br><h2>  Draw graphics </h2><br>  Warning: perverted code below! <br><br>  There is a funny query to the SQL server, which displays the CPU for the last N minutes - it turns out, Comrade Major remembers everything!  Try this round: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @ts_now <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span> = (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> cpu_ticks/(cpu_ticks/ms_ticks) <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> sys.dm_os_sys_info <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> (NOLOCK)); <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> TOP(<span class="hljs-number"><span class="hljs-number">256</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DATEADD</span></span>(ms, <span class="hljs-number"><span class="hljs-number">-1</span></span> * (@ts_now - [<span class="hljs-built_in"><span class="hljs-built_in">timestamp</span></span>]), <span class="hljs-keyword"><span class="hljs-keyword">GETDATE</span></span>()) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [EventTime], SQLProcessUtilization <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [SQLCPU], <span class="hljs-number"><span class="hljs-number">100</span></span> - SystemIdle - SQLProcessUtilization <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [OtherCPU] <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> record.value(<span class="hljs-string"><span class="hljs-string">'(./Record/@id)[1]'</span></span>, <span class="hljs-string"><span class="hljs-string">'int'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> record_id, record.value(<span class="hljs-string"><span class="hljs-string">'(./Record/SchedulerMonitorEvent/SystemHealth/SystemIdle)[1]'</span></span>, <span class="hljs-string"><span class="hljs-string">'int'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [SystemIdle], record.value(<span class="hljs-string"><span class="hljs-string">'(./Record/SchedulerMonitorEvent/SystemHealth/ProcessUtilization)[1]'</span></span>, <span class="hljs-string"><span class="hljs-string">'int'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [SQLProcessUtilization], [<span class="hljs-built_in"><span class="hljs-built_in">timestamp</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> [<span class="hljs-built_in"><span class="hljs-built_in">timestamp</span></span>], <span class="hljs-keyword"><span class="hljs-keyword">CONVERT</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">xml</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">record</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [<span class="hljs-built_in"><span class="hljs-built_in">record</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> sys.dm_os_ring_buffers <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> (NOLOCK) <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> ring_buffer_type = N<span class="hljs-string"><span class="hljs-string">'RING_BUFFER_SCHEDULER_MONITOR'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> <span class="hljs-built_in"><span class="hljs-built_in">record</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LIKE</span></span> N<span class="hljs-string"><span class="hljs-string">'%&lt;SystemHealth&gt;%'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> x) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> y <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DESC</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OPTION</span></span> (RECOMPILE);</code> </pre> <br>  Now, using this formatting ($ Fragment variable) <br><pre> <code class="markdown hljs"><span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">table</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">style</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"width: 100%"</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span><span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">tbody</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span><span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">tr</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">style</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"background-color: white; height: 2pt;"</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span> <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">td</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">style</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"width: SQLCPU%; background-color: green;"</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span><span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">td</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span> <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">td</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">style</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"width: OtherCPU%; background-color: blue;"</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span><span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">td</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span> <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">td</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">style</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"width: REST%; background-color: #C0C0C0;"</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span><span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">td</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span><span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">tr</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span><span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">tbody</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span> <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">table</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span></code> </pre> <br>  We can form the body of the letter: <br><pre> <code class="python hljs">$Result = invoke-Sqlcmd -ConnectionString $connstr -Query $Query ` | Select-Object -Property * -ExcludeProperty ` <span class="hljs-string"><span class="hljs-string">"ItemArray"</span></span>, <span class="hljs-string"><span class="hljs-string">"RowError"</span></span>, <span class="hljs-string"><span class="hljs-string">"RowState"</span></span>, <span class="hljs-string"><span class="hljs-string">"Table"</span></span>, <span class="hljs-string"><span class="hljs-string">"HasErrors"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($Result.HasRows) { foreach($item <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> $Result) { $time = $itemEventTime $sqlcpu = $item.SQLCPU $other = $itemOtherCPU $rest = <span class="hljs-number"><span class="hljs-number">100</span></span> - $sqlcpu - $other $f = $fragment -replace <span class="hljs-string"><span class="hljs-string">"SQLCPU"</span></span>, $sqlcpu $f = $f -replace <span class="hljs-string"><span class="hljs-string">"OtherCPU"</span></span>, $other $f = $f -replace <span class="hljs-string"><span class="hljs-string">"REST"</span></span>, $rest $f | Out-File <span class="hljs-string"><span class="hljs-string">"res.log"</span></span> -Append -Encoding UTF8 }</code> </pre> <br>  Which will look like this: <br><br><img src="https://habrastorage.org/webt/fy/au/ii/fyauiiv5ak9s3cnqrus3-ewgadu.png"><br><br>  So yes, monsieur knows a lot about perversions!  Interestingly, this code contains: Powershell (written on it), SQL, Xquery, HTML.  It is a pity that we cannot add Javascript to HTML (as it is for writing), but polishing Python code (which can be used in SQL) is everyone‚Äôs duty! <br><br><h2>  SQL profiler trace output </h2><br>  It is clear that the trace "does not climb" in CSV because of the TextData field.  But it‚Äôs also strange to display the trace in the letter, both because of its size and because this data is often used for further analysis.  Therefore, we do the following: call through <b>invoke-SqlCmd</b> a certain script, in the depths of which is done <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> SPID,EventClass,TextData, <span class="hljs-keyword"><span class="hljs-keyword">Duration</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">Reads</span></span>,Writes,CPU, StartTime,EndTime,DatabaseName,HostName, ApplicationName,LoginName <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> ::fn_trace_gettable ( @filename , <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> )</code> </pre> <br>  Then, on <b>another</b> server accessible by DBA, there is a Traces database with an empty stub, a Model plate, ready to accept all the specified columns.  We copy this model into a new table with a unique name: <br><br><pre> <code class="python hljs">$dt = Get-Date -format <span class="hljs-string"><span class="hljs-string">"yyyyMMdd"</span></span> $tm = Get-Date -format <span class="hljs-string"><span class="hljs-string">"hhmmss"</span></span> $tableName = $srv + <span class="hljs-string"><span class="hljs-string">"_"</span></span> + $dt + <span class="hljs-string"><span class="hljs-string">"_"</span></span> + $tm $copytab = <span class="hljs-string"><span class="hljs-string">"select * into "</span></span> + $tableName + <span class="hljs-string"><span class="hljs-string">" from Model"</span></span> invoke-SqlCmd -ConnectionString $tstr -Query $copytab</code> </pre> <br>  And now we can write our trace into it using <b>Data.SqlClient.SqlBulkCopy</b> - I already gave an example of this above.  Yes, it would be nice to make masking constants in TextData: <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># mask data foreach ($Row in $Result) { $v = $Row["TextData"] $v = $v -replace "'([^']{2,})'", "'str'" -replace "[0-9][0-9]+", '999' $Row["TextData"] = $v }</span></span></code> </pre><br>  We replace numbers with more than one character that is 999 long, and we replace strings longer than one character with 'str'.  Numbers from 0 to 9 are often used as flags, and we do not touch them, as well as empty and single-character strings - among them there are often 'Y', 'N', etc. <br><br><h2>  Let's add colors to our life (strictly 18+) </h2><br>  In the plates often want to highlight the cells that require attention.  For example, FAILS, high fragmentation, and so on.  Of course, this can be done on bare SQL, generating HTML using PRINT, and putting the HTML file type in Jenkins: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> @<span class="hljs-keyword"><span class="hljs-keyword">body</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">max</span></span>), @<span class="hljs-keyword"><span class="hljs-keyword">chunk</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">max</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> @<span class="hljs-keyword"><span class="hljs-keyword">body</span></span>=<span class="hljs-string"><span class="hljs-string">'&lt;font face="Lucida Console" size="3"&gt;'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> @<span class="hljs-keyword"><span class="hljs-keyword">body</span></span>=@<span class="hljs-keyword"><span class="hljs-keyword">body</span></span>+<span class="hljs-string"><span class="hljs-string">'&lt;b&gt;Server name: '</span></span>+@@servername+<span class="hljs-string"><span class="hljs-string">'&lt;/b&gt;&lt;br&gt;'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> @<span class="hljs-keyword"><span class="hljs-keyword">body</span></span>=@<span class="hljs-keyword"><span class="hljs-keyword">body</span></span>+<span class="hljs-string"><span class="hljs-string">'&lt;br&gt;&lt;br&gt;'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> @<span class="hljs-keyword"><span class="hljs-keyword">body</span></span>=@<span class="hljs-keyword"><span class="hljs-keyword">body</span></span>+<span class="hljs-string"><span class="hljs-string">'&lt;table&gt;&lt;tr&gt;&lt;th&gt;Job&lt;/th&gt;&lt;th&gt;Last Run&lt;/th&gt;&lt;th&gt;Avg Duration, sec&lt;/th&gt;&lt;th&gt;Last Run, Sec&lt;/th&gt;&lt;th&gt;Last Status&lt;/th&gt;&lt;/tr&gt;'</span></span> print @<span class="hljs-keyword"><span class="hljs-keyword">body</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> tab <span class="hljs-keyword"><span class="hljs-keyword">CURSOR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FOR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-string"><span class="hljs-string">'&lt;tr&gt;&lt;td&gt;'</span></span>+<span class="hljs-keyword"><span class="hljs-keyword">name</span></span>+<span class="hljs-string"><span class="hljs-string">'&lt;/td&gt;&lt;td&gt;'</span></span>+ LastRun+<span class="hljs-string"><span class="hljs-string">'&lt;/td&gt;&lt;td&gt;'</span></span>+ <span class="hljs-keyword"><span class="hljs-keyword">convert</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>,AvgDuration)+<span class="hljs-string"><span class="hljs-string">'&lt;/td&gt;&lt;td&gt;'</span></span>+ <span class="hljs-keyword"><span class="hljs-keyword">convert</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>,LastDuration)+<span class="hljs-string"><span class="hljs-string">'&lt;/td&gt;&lt;td&gt;'</span></span>+ <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> LastStatus&lt;&gt;<span class="hljs-string"><span class="hljs-string">'Succeeded'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-string"><span class="hljs-string">'&lt;font color="red"&gt;'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-string"><span class="hljs-string">''</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>+ LastStatus+ <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> LastStatus&lt;&gt;<span class="hljs-string"><span class="hljs-string">'Succeeded'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-string"><span class="hljs-string">'&lt;/font&gt;'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-string"><span class="hljs-string">''</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>+ +<span class="hljs-string"><span class="hljs-string">'&lt;/td&gt;&lt;td&gt;'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-comment"><span class="hljs-comment">#j2 OPEN tab; FETCH NEXT FROM tab into @chunk WHILE @@FETCH_STATUS = 0 BEGIN print @chunk FETCH NEXT FROM tab into @chunk; END CLOSE tab; DEALLOCATE tab; print '&lt;/table&gt;'</span></span></code> </pre><br>  Why did I write such code? <br><br><img src="https://habrastorage.org/webt/pf/0d/sf/pf0dsfukdeazt6dobeaqzxf4da4.jpeg"><br><br>  But there is a more beautiful solution.  <b>ConvertTo-HTML</b> does not allow us to color the cells, but we can do it after the fact.  For example, we want to select cells with a level of fragmentation of more than 80 and more than 90. Add styles: <br><br><pre> <code class="markdown hljs"><span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">style</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="undefined"></span></span><span class="xml"><span class="undefined"></span></span> .SQLmarkup-red { color: red; background-color: yellow; } .SQLmarkup-yellow { color: black; background-color: #FFFFE0; } .SQLmarkup-default { color: black; background-color: white; } <span class="xml"><span class="undefined"></span><span class="hljs-tag"><span class="xml"><span class="undefined"></span><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">style</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span></code> </pre> <br>  We'll add a dummy column <b>directly to the</b> column we want to color.  The column should be called <i>SQLmarkup-</i> something: <br><pre> <code class="sql hljs">case when ps.avg_fragmentation_in_percent&gt;=90.0 then 'SQLmarkup-red' when ps.avg_fragmentation_in_percent&gt;=80.0 then 'SQLmarkup-yellow' else 'SQLmarkup-default' <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> [SQLmarkup<span class="hljs-number"><span class="hljs-number">-1</span></span>], ps.avg_fragmentation_in_percent,</code> </pre> <br>  Now, when we get the HTML created by Powershell, we will remove the dummy column from the header, and in the data body we will transfer the value from the column to the style.  This is done with just two substitutions: <br><br><pre> <code class="python hljs">$html = $html ` -replace <span class="hljs-string"><span class="hljs-string">"&lt;th&gt;SQLmarkup[^&lt;]*&lt;/th&gt;"</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span> ` -replace <span class="hljs-string"><span class="hljs-string">"&lt;td&gt;SQLmarkup-(.+?)&lt;/td&gt;&lt;td&gt;"</span></span>,<span class="hljs-string"><span class="hljs-string">'&lt;td class="SQLmarkup-$1"&gt;'</span></span></code> </pre><br>  Result: <br><br><img src="https://habrastorage.org/webt/5a/p9/vu/5ap9vutsv9ohxplzvd6tsibnj10.png"><br><br>  Isn't it elegant?  No, this coloring reminds me <br><br><img src="https://habrastorage.org/webt/gr/px/ji/grpxjislnrni2k44kntgzjwqbx4.jpeg"></div><p>Source: <a href="https://habr.com/ru/post/447242/">https://habr.com/ru/post/447242/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../447226/index.html">Interview with the popularizer of science, the head of the only private school of astronomy in Russia, Pavel Skripnichenko</a></li>
<li><a href="../447232/index.html">Personal experience. How we connected international telephony: comparison of 6 virtual PBXs</a></li>
<li><a href="../447234/index.html">How to write polymorphic programs with Arrow</a></li>
<li><a href="../447236/index.html">Creating a farm of Android devices using Open STF</a></li>
<li><a href="../447240/index.html">We study Adversarial Tactics, Techniques & Common Knowledge (ATT @ CK). Enterprise Tactics. Part 10</a></li>
<li><a href="../447246/index.html">Prototype in 1 day instead of 2-3 weeks: 3D-printing in concern ‚ÄúOceanpribor‚Äù</a></li>
<li><a href="../447248/index.html">What is explored in the stratosphere?</a></li>
<li><a href="../447250/index.html">Learning to communicate between microservices on Node.js via RabbitMQ</a></li>
<li><a href="../447252/index.html">Help Duke to find a way out</a></li>
<li><a href="../447256/index.html">Miracle Materialize Magics: Nissan spends seconds instead of several months of work</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>