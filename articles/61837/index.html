<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>UserJS. Part 2: Tricks</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this article, I will describe how to reuse the code, as well as various tricks that are specific to userjs. 

 Other articles in the series: 

- Pa...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>UserJS. Part 2: Tricks</h1><div class="post__text post__text-html js-mediator-article">  In this article, I will describe how to reuse the code, as well as various tricks that are specific to userjs. <br><br>  Other articles in the series: <ul><li>  <a href="http://habrahabr.ru/blogs/opera/61835/">Part 1: Introduction</a> </li><li>  <a href="http://habrahabr.ru/blogs/opera/61840/">Part 3: Security</a> </li><li>  <a href="http://habrahabr.ru/blogs/opera/62045/">Part 4: libretki framework</a> </li></ul><br><a name="habracut"></a><br>  <strong>Note.</strong> <br>  The examples are then purposely simplified, brazenly cluttering up the global namespace, and do not care about security.  These issues are covered separately. <br><br><h4>  Code reuse: we organize loading of scripts </h4><br>  The order of loading userjs in Opera version 10 is determined by the order in which files are issued by the operating system, i.e.  generally undefined.  It depends on the OS, on the FS driver and the FS itself, as well as on the weather on Mars.  Starting with the 10th version of Opera downloads files in alphabetical order, it is already easier, but still not convenient enough. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The lack of a guaranteed boot order hinders the normal reuse of the code.  Of course, this is not a problem if functions are needed only in event handlers (at this moment all scripts are loaded), but often they are also needed when loading userjs itself.  And in this case, each script is forced to pull all the necessary functionality with them and reinvent the wheel. <br><br>  Instead of the immediate execution of the function, add the function to the array: <br><pre> if (! ('scripts' in window)) scripts = [];  // Array may not be if the script is loaded first.
 scripts.push (function () {/ * bla-bla-bla * /});
</pre><br><br>  And the launch of the code will be handled by a special <em>loader.js</em> script: <br><pre> if (! ('scripts' in window)) scripts = [];
 for (var i = 0; i &lt;scripts.length; ++ i) scripts [i] ();
 scripts = {push: function (f) {f ();  }};
</pre><br>  Pay attention to the last line: scripts loaded after <em>loader.js</em> will call a new function <em>push</em> , which will not put the function into an array, but execute it immediately. <br><br>  As long as the change did not give us anything, the functions are still put in an array in an arbitrary order.  However now, having on hands an array of functions entirely, we can operate this order. <br><br>  For example, you can use a list of dependencies: <br><pre> scripts.push ({
   name: 'example',
   requires: ['utils', 'xpath'],
   init: function () {/ * bla-bla-bla * /}
 });
</pre><br><br>  It should be noted that when loading a script there is no way to know that this script is loaded last.  It can be argued that all scripts are already loaded with a signal handler, for example <em>DOMContentLoaded</em> , but the handler is no longer available advanced features provided by Opera to user scripts, such as <em>opera.addEventListener</em> , <em>defineMagicVariable</em> and others.  Therefore, dependency analysis should be performed immediately when adding each new function and the function is executed as soon as all dependencies are satisfied.  And in the page event handler, you can already identify functions with unmet dependencies. <br><br>  In this sense, the output and distribution of the tenth version will help simplify the code - you can add a script with the lexicographically last name, which will be guaranteed to be loaded last and will perform the calculation of dependencies and the launch of all functions. <br><br><h4>  Data exchange between scripts </h4><br>  As stated in the first article, the global namespace should not be used.  But how then can you use the objects of one script from another (and why would you otherwise need to ensure the order of their loading)? <br><br>  Method one is to simply try to avoid conflicts with scripts on the page using a separate namespace: <br><br>  <em>unique_script_name.js</em> <br><pre> unique_script_name = {
   doIt: function () {...},
   dontDoIt: function () {...},
 };
</pre><br><br>  <em>some_other_script.js</em> <br><pre> unique_script_name.doIt ();
</pre><br><br>  The second method uses the modified <em>loader.js</em> , but the data will be completely inaccessible to the scripts from the page: <br><br>  <em>loader.js</em> : <br><pre> (function () {
   var shared = {};
   if (! ('scripts' in window)) scripts = [];
   for (var i = 0; i &lt;scripts.length; ++ i) scripts [i] (shared);
   scripts = {push: function (f) {f (shared);  }};
 }) ();
</pre><br><br>  Now each script receives a <em>shared</em> object as an argument to the <em>init</em> function.  This object is unreachable through the <em>window</em> object (unless of course any userjs makes it so foolishly). <br><br><pre> if (! ('scripts' in window)) scripts = [];
 scripts.push (function (shared) {
   shared.very_useful_script = {
     doIt: function () {...},
   };
 });
</pre><br><br><h4>  Configuring Scripts </h4><br>  Many userjs require pre-configuration.  Typically, the setting is to open the script and edit the values ‚Äã‚Äãof some variables.  But I would like to provide for this a normal user interface.  Creating an interface in the browser is not a problem, but where to save the configuration so that the script can get it, while preferably at no extra cost? <br><br>  If the setting is local for the page, then everything is simple: save the settings in cookies.  But for global settings it is not suitable. <br><br>  One option is to save the configuration to the global repository or files using the tricks described below, but they require loading either extra frames, or a plug-in, or Java on each page.  There is a cheaper option - save the configuration as userjs.  This can be done either using LiveConnect, or a Java applet (both versions require Java), or simply asking the user to save the data: // link in the scripts folder. <br><br>  Sample configuration script: <br><pre> if (! ('scripts' in window)) scripts = [];
 scripts.push (function (shared) {
   shared.configuration = {
     example_script: {timeout: 10;  },
     another_script: {password: '123'},
   };
 });
</pre><br><br>  The lightning-fast configuration of the Opera itself is loaded without using any tricks.  With the help of <em>loader.js,</em> you can guarantee the loading of the configuration before running other scripts. <br><br><h4>  XDM - Cross-domain messaging </h4><br>  XDM is a way to exchange information between documents, which can even be from different domains.  Consists of two components: <br><ul><li>  The <em>Window.postMessage (str)</em> function to send a string to another window.  To send a message to a frame, use <em>iframe.contentWindow.postMessage (str)</em> </li><li>  The <em>message</em> event <em>raised</em> when a message is received.  The <em>data</em> field of the event object contains a message string, and the source field contains a link to the sending window. </li></ul><br><br><pre> window.addEventListener ('message', function (ev) {
   alert ('got message:' + ev.data);
   ev.source.postMessage ('got it');
 }, true);
 iframe.contentWindow.postMessage ('test');
</pre><br><br>  <strong>Attention!</strong>  Naive use of XDM is dangerous.  Scripts on the page can receive a link to the iframe and send messages to it, thus obtaining important information from shared storage or performing cross-domain requests.  Methods of protection will be described in the following article. <br><br><h5>  Shared Data Warehouse </h5><br>  Compared to the GreaseMonkey, Opera userjs scripts are devoid of useful <em>GM_getValue</em> , <em>GM_setValue</em> , <em>GM_deleteValue functions</em> that allow you to save data in common for all pages of storage.  But their functionality can be emulated by using the fact that: <br><ul><li>  userjs are executed even on pages that are not loaded due to an error; </li><li>  Opera supports message transfer between frames (XDM - Cross-domain messaging); </li><li>  Unable to load the page with the address " <a href="http://0.0.0.0/">0.0.0.0</a> ". </li></ul><br>  This trick is called ‚ÄúOpera 0.0.0.0 hack‚Äù, although in fact the address can be any other.  It is simply not safe to use the correct address.  So, the script consists of two parts, one of which is executed on the page with the address ‚Äú <a href="http://0.0.0.0/">0.0.0.0</a> ‚Äù, the other on all the others.  The first part subscribes to XDM messages, the second part creates a hidden <em>iframe</em> on the page with the address ‚Äú <a href="http://0.0.0.0/">0.0.0.0</a> ‚Äù, sends it messages with commands (get / set / delete) and gets the results.  The data itself is stored in cookies page " <a href="http://0.0.0.0/">0.0.0.0</a> ". <br><pre> if (location.href == 'http://0.0.0.0/') {
   document.addEventListener ('message', function (evt) {
     var a = msg.data.split ('|');
     switch (a [0]) {
     case 'get': evt.source.postMessage (getCookie (a [1]));
     case 'set': setCookie (a [1]);
     case 'del': delCookie (a [1]);
     }
   }, true);
 } else {
   document.addEventListener ('message', function (evt) {
     alert ('got value:' + evt.data);
   });

   document.addEventListener ('DOMContentLoaded', function () {
     var iframe = document.createElement ('iframe');
     iframe.style.display = 'none';
     iframe.onload = function () {
       iframe.contentWindow.postMessage ('set | name | value');
       iframe.contentWindow.postMessage ('get | name');
     }
     iframe.src = 'http://0.0.0.0/';
     document.documentElement.appendChild (iframe);
   }, true);
 }
</pre><br><br><h5>  Cross-domain XMLHttpRequest </h5><br>  You can create a lot of useful scripts if you allow <em>XMLHttpRequest</em> to make requests to other domains.  This spell check, and translation, and auto-completion, and a lot more then.  But here, Opera didn‚Äôt take pity on users either - userjs have the same ‚Äúsame origin‚Äù restriction as the scripts on the page. <br><br>  However, using the same XDM as for shared storage, you can run <em>XMLHttpRequest</em> in the context of another domain.  I will not give an example, it will be similar to the previous one, but instead of calling <em>getCookie there</em> will be a call to <em>XMLHttpRequest</em> . <br><br>  <strong>Trick.</strong>  In order not to download the contents of the domain in the frame in vain, you can upload "-xmlhttprequest.domain.ru" instead of "domain.ru", the domain name is incorrect, so that the domain cannot even have such a subdomain.  Then in the context of the frame you need to run <br><pre> document.domain = "domain.ru";
</pre><br>  and then you can use <em>XMLHttpRequest</em> . <br><br><h4>  LiveConnect </h4><br>  LiveConnect is a way to call Java code from JavaScipt.  First appeared in Netscape and works in Opera.  The <em>java</em> global object provides access to Java packages and classes. <br><br>  Code example: <br><pre> // Find out if the file exists.
 var file_exists = (new java.io.File (path)). exists ();
</pre><br><br>  With Java you can do a lot: get access to files (including writing), work with the clipboard, use sockets, etc.  Details can be found in the Java documentation. <br><br>  But by default, all this, of course, is forbidden, otherwise the very first visit to the unreliable site would have ended miserably. <br>  Permissions are written in the Java policy file.  The path to it can be found in the "opera: config # Java | SecurityPolicy" setting.  I recommend not to modify the existing file, but to copy it and register it in the settings. <br><br>  <a href="http://java.sun.com/j2se/1.3/docs/guide/security/PolicyFiles.html">Official policy file documentation</a> is on the Sun website. <br><br>  Example of recording permissions: <br><br><pre> grant codeBase "http://some.host.ru/" {
   // Allow ALL.
   // permission java.security.AllPermission;

   // Allow full access to files in the "~ / .opera / userjs / data" folder.
   // $ {/} substitutes the system path delimiter: ‚Äú/‚Äù on Unix, ‚Äú\‚Äù on Windows.
   // ‚Äú-‚Äù at the end of the path means ‚Äúall folders and files inside recursively‚Äù.
   // permission java.io.FilePermission "$ {user.home} $ {/}. opera $ {/} userjs $ {/} data / -", "read, write, delete";

   // Allow access to the clipboard.
   // permission java.awt.AWTPermission "accessClipboard";
 };
</pre><br><br>  <strong>Attention!</strong>  Setting permissions for any path will allow performing not only your userjs scripts, but also scripts from the page.  Although it is unlikely that someone will use LiveConnect on their website in the hope of this, it‚Äôs better to be paranoid in terms of security.  The way to solve this problem is given in the next article. </div><p>Source: <a href="https://habr.com/ru/post/61837/">https://habr.com/ru/post/61837/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../61828/index.html">Education 2.0. Overview of another educational site</a></li>
<li><a href="../61830/index.html">Testing wav mp3 ogg</a></li>
<li><a href="../61833/index.html">Expand comment</a></li>
<li><a href="../61835/index.html">UserJS. Part I: Introduction</a></li>
<li><a href="../61836/index.html">Is the end of Beltelecom's monopoly close?</a></li>
<li><a href="../61839/index.html">FMSPy, Alpha release (0.1)</a></li>
<li><a href="../61840/index.html">UserJS. Part 3: Security</a></li>
<li><a href="../61842/index.html">Preventive protection of your and not your scripts</a></li>
<li><a href="../61845/index.html">Determine the order of the columns in the composite index</a></li>
<li><a href="../61847/index.html">New beta: Flash Builder 4, Flash Catalyst, Flex SDK 4</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>