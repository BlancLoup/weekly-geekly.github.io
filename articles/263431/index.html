<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Configure Ubiquiti Wi-Fi and Cisco (Guest DHCP and VLANs)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This article describes one of the ways to configure guest and corporate wireless networks using Enterprise Wi-Fi Ubiquiti UniFi and Cisco Integrated S...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Configure Ubiquiti Wi-Fi and Cisco (Guest DHCP and VLANs)</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/5c1/615/21f/5c161521f70ba19fa112262ccf9d58bf.jpg" alt="image"><br><br>  This article describes one of the ways to configure guest and corporate wireless networks using Enterprise Wi-Fi Ubiquiti UniFi and Cisco Integrated Services Routers solutions. <br><br><a name="habracut"></a><br><h4>  Recipe </h4><br>  Create a corporate SSID network <br>  Create a guest SSID network <br>  Create VLAN networks on one physical port <br>  Configure DHCP Forwarding <br>  Isolate guest VLAN <br>  Release clients under different static IP 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Ingredients </h4><br>  Router: Cisco 2901 Router <br>  OS for controller: Ubuntu server 12.04 <br>  Software: Ubiquiti UniFi Controller 4.6.6 <br>  Switch: Ubiquiti TOUGHSwitch PoE Pro <br>  Points: Ubiquiti UniFi AP LR <br><br><h4>  Topology </h4><br><img src="https://habrastorage.org/getpro/habr/post_images/311/9b8/f94/3119b8f945376d19e86f97d8fca3c500.png" alt="image"><br><br><h4>  Cooking Cisco </h4><br>  <b>Create a VLAN database</b> <br>  VLAN id you can use at your discretion <br><br><pre><code class="bash hljs">cisco<span class="hljs-comment"><span class="hljs-comment">#vlan database cisco(vlan)#vlan 1 VLAN 1 added: Name: VLAN0001 cisco(vlan)#vlan 2 VLAN 2 added: Name: VLAN0002 cisco(vlan)#vlan 3 VLAN 3 added: Name: VLAN0003 cisco(vlan)#apply APPLY completed. cisco(vlan)#exit cisco#wr</span></span></code> </pre> <br><br>  <b>Configure and create VLANs</b> <br>  Here we immediately nail down NAT for our clients with the <b>ip nat inside command</b> . <br><br><pre> <code class="bash hljs">cisco<span class="hljs-comment"><span class="hljs-comment">#conf t cisco(config)#interface vlan 1 cisco(config-if)#ip address 172.16.1.1 255.255.255.0 cisco(config-if)#ip nat inside cisco(config-if)#ip virtual-reassembly in cisco(config-if)#ip tcp adjust-mss 1452 cisco(config-if)#exit cisco(config)#interface vlan 2 cisco(config-if)#ip address 172.15.1.1 255.255.255.0 cisco(config-if)#ip nat inside cisco(config-if)#ip virtual-reassembly in cisco(config-if)#ip tcp adjust-mss 1452 cisco(config-if)#exit cisco(config)#interface vlan 3 cisco(config-if)#ip address 172.17.1.1 255.255.255.0 cisco(config-if)#ip nat inside cisco(config-if)#ip virtual-reassembly in cisco(config-if)#ip tcp adjust-mss 1452 cisco(config-if)#exit cisco(config)#exit cisco#wr</span></span></code> </pre><br><br>  <b>We configure and create DHCP</b> <br>  172.16.1.1/24 We will use for network management, namely - there our points will receive IP and knock on the controller.  172.15.1.1/24 We will distribute to guests, and we will give the network 172.17.1.1/24 to corporate devices.  The example uses the DNS server Yandex: 77.88.8.8 Google: 8.8.4.4.  The lease parameter indicates how many days we give IP to the client. <br><br><pre> <code class="bash hljs">cisco<span class="hljs-comment"><span class="hljs-comment">#conf t cisco(config)#ip dhcp pool Vlan1 cisco(dhcp-config)#import all cisco(dhcp-config)#network 172.16.1.0 255.255.255.0 cisco(dhcp-config)#default-router 172.16.1.1 cisco(dhcp-config)#dns-server 77.88.8.8 8.8.4.4 cisco(dhcp-config)#lease 8 cisco(dhcp-config)#exit cisco(config)#ip dhcp pool Vlan2 cisco(dhcp-config)#import all cisco(dhcp-config)#network 172.15.1.0 255.255.255.0 cisco(dhcp-config)#default-router 172.15.1.1 cisco(dhcp-config)#dns-server 77.88.8.8 8.8.4.4 cisco(dhcp-config)#lease 1 cisco(dhcp-config)#exit cisco(config)#ip dhcp pool Vlan3 cisco(dhcp-config)#import all cisco(dhcp-config)#network 172.17.1.0 255.255.255.0 cisco(dhcp-config)#default-router 172.17.1.1 cisco(dhcp-config)#dns-server 77.88.8.8 8.8.4.4 cisco(dhcp-config)#lease 1 cisco(dhcp-config)#exit cisco(config)#exit cisco#wr</span></span></code> </pre><br><br>  <b>We help the DHCP server</b> <br>  For the correct distribution of IP addresses, it is desirable to explicitly specify the ip helper-address - DHCP server on all VLANs. <br><br><pre> <code class="bash hljs">cisco<span class="hljs-comment"><span class="hljs-comment">#conf t cisco(config)#interface vlan 1 cisco(config-if)#ip helper-address 172.16.1.1 cisco(config-if)#exit cisco(config)#interface vlan 2 cisco(config-if)#ip helper-address 172.15.1.1 cisco(config-if)#exit cisco(config)#interface vlan 3 cisco(config-if)#ip helper-address 172.17.1.1 cisco(config-if)#exit cisco(config)#exit cisco#wr</span></span></code> </pre><br><br>  Exclude the issuance of service IP addresses <br><pre> <code class="bash hljs">cisco<span class="hljs-comment"><span class="hljs-comment">#conf t cisco(config)#ip dhcp excluded-address 172.15.1.1 172.15.1.3 cisco(config)#ip dhcp excluded-address 172.16.1.1 172.16.1.3 cisco(config)#ip dhcp excluded-address 172.17.1.1 172.17.1.3 cisco(config)#exit cisco#wr</span></span></code> </pre><br><br>  <b>Configuring interfaces</b> <br>  After creating a VLAN and configuring DHCP, we need to configure the port on the router that will distribute these networks in a special way.  In our example, we will set the GigabitEthernet 0/0 port to the primary VLAN 1 and allow us to pull the VLAN 2 and VLAN 3. <br><br>  <u>The example uses the GigabitEthernet 0/0 interface, it is assumed that you have at least 2 more ports - one for Internet access GigabitEthernet 0/1 and one port for your corporate wired network, for example GigabitEthernet 0/2.</u> <br><br><pre> <code class="bash hljs">cisco<span class="hljs-comment"><span class="hljs-comment">#conf t cisco(config)#GigabitEthernet 0/0 cisco(config-if)#switchport trunk encapsulation dot1q cisco(config-if)#switchport mode trunk cisco(config-if)#switchport trunk allowed vlan 1,2,3 cisco(config-if)#switchport trunk native vlan 1 cisco(config-if)#no shutdown cisco(config-if)#exit cisco(config)#exit cisco#wr</span></span></code> </pre><br><br>  Now, when the GigabitEthernet 0/0 port is connected, our controller and points will receive the 172.16.1.0/24 network, and VLAN2 and VLAN3 will be used on demand. <br><br>  <b>We tighten the nuts</b> <br>  Now that we have configured the primary port for all networks, it‚Äôs time to deny guest network access (VLAN2) to go to our neighboring networks. <br>  <u>In this example, a wired corporate network hangs on GigabitEthernet 0/2 192.168.0.0 255.255.255.0</u> <br><br><pre> <code class="bash hljs">cisco<span class="hljs-comment"><span class="hljs-comment">#conf t cisco(config)#access-list 110 deny ip 172.15.1.0 0.0.0.255 192.168.0.0 0.0.0.255 cisco(config)#access-list 110 deny ip 172.15.1.0 0.0.0.255 172.16.1.0 0.0.0.255 cisco(config)#access-list 110 deny ip 172.15.1.0 0.0.0.255 172.17.1.0 0.0.0.255 cisco(config)#access-list 110 permit ip any any cisco(config)#exit cisco#wr</span></span></code> </pre><br>  We beat this access-list 110 to our VLAN2 <br><br><pre> <code class="bash hljs">cisco<span class="hljs-comment"><span class="hljs-comment">#conf t cisco(config)#interface vlan 2 cisco(config-if)#ip access-group 110 in cisco(config-if)#exit cisco(config)# cisco#wr</span></span></code> </pre><br><br>  <b>We route our clients with different external IPs.</b> <br>  In order to indicate which clients go through which external IP I use pools. <br>  Imagine that we have 3 external IP addresses issued by our ISP: 100.100.100.101, 100.100.100.102, 100.100.100.103 with one gateway 100.100.100.1 <br><br>  Configuration example <br><pre> <code class="bash hljs">interface GigabitEthernet0/0 switchport trunk native vlan 2 switchport mode trunk no ip address ! interface GigabitEthernet0/1 ip address 100.100.100.101 255.255.255.0 ip nbar protocol-discovery ip nat outside ip virtual-reassembly <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> duplex auto speed auto ! interface GigabitEthernet0/2 ip address 192.168.0.0 255.255.255.0 ip access-group 109 <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> ip nat inside ip virtual-reassembly <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> ip tcp adjust-mss 1452 duplex auto speed auto ! ip route 0.0.0.0 0.0.0.0 100.100.100.1 ! access-list 109 permit ip 192.168.0.0 0.0.0.255 any access-list 110 deny ip 172.15.1.0 0.0.0.255 192.168.0.0 0.0.0.255 access-list 110 deny ip 172.15.1.0 0.0.0.255 172.16.1.0 0.0.0.255 access-list 110 deny ip 172.15.1.0 0.0.0.255 172.17.1.0 0.0.0.25 access-list 110 permit ip any any</code> </pre><br><br>  So, we want clients from the 192.168.0.0 network to go to the world via IP 100.100.100.101, clients from the guest wireless network 172.15.1.0 go to the world via IP 100.100.100.102, and clients from the corporate wireless network via IP 100.100.100.103 <br><br>  Let's create an additional access-list 108 for clients from a corporate wireless network. <br><pre> <code class="bash hljs">cisco<span class="hljs-comment"><span class="hljs-comment">#conf t cisco(config)#access-list 108 permit ip 172.17.1.0 0.0.0.255 any cisco(config)#exit cisco#wr</span></span></code> </pre><br><br>  Screw access-list 108 to VLAN3 <br><pre> <code class="bash hljs">cisco<span class="hljs-comment"><span class="hljs-comment">#conf t cisco(config)#interface vlan 3 cisco(config-if)#ip access-group 108 in cisco(config-if)#exit cisco(config)# cisco#wr</span></span></code> </pre><br><br>  It is assumed that you have already created the access-list 109 yourself when you set up a wired network <br>  So, we have 3 access-list, let's go. <br><br>  Create pools ( <b>netmask should strictly correspond to the one issued by ISP</b> ) <br><pre> <code class="bash hljs">cisco<span class="hljs-comment"><span class="hljs-comment">#conf t ip nat pool OFFICELAN 100.100.100.101 100.100.100.101 netmask 255.255.255.0 ip nat pool WIFIGUEST 100.100.100.102 100.100.100.102 netmask 255.255.255.0 ip nat pool WIFICORP 100.100.100.103 100.100.100.103 netmask 255.255.255.0</span></span></code> </pre><br><br>  We beat the access-list to the pool <br><pre> <code class="bash hljs">cisco<span class="hljs-comment"><span class="hljs-comment">#conf t cisco(config)#ip nat inside source list 109 pool OFFICELAN overload cisco(config)#ip nat inside source list 110 pool WIFIGUEST overload cisco(config)#ip nat inside source list 108 pool WIFICORP overload cisco(config)#ip nat inside source route-map nonat interface GigabitEthernet0/1 overload cisco(config)#exit cisco#wr</span></span></code> </pre><br><br>  At this point, the configuration of the Cisco router is complete. <br><br><h4>  Cooking controller </h4><br>  So, now we take the server under the controller, install <a href="https://community.ubnt.com/t5/UniFi-Updates-Blog/UniFi-4-6-6-is-released/ba-p/1288816">Ubiquiti UniFi Controller 4.6.6</a> software there, I will not describe the installation process, OS of your choice, I installed Ubuntu server 12.04 and assigned IP 172.16.1.3 to the controller <br><br>  <b>Basic setting</b> <br>  Open the web interface of the controller <a href="https://172.16.1.3/">172.16.1.3</a> : 8443 <br><br>  1. Go to Settings -&gt; Site <br>  Put the checkbox - <u>Automatically upgrade AP firmware</u> , and the rest to taste: <br><img src="https://habrastorage.org/getpro/habr/post_images/a47/f52/66e/a47f5266e5e24ef2f85d8afca6e2f6d0.jpg" alt="image"><br><br>  2. Go to Settings -&gt; Controller <br>  Register the IP address of the controller (this is the so-called inform ip) <br>  Put the checkbox - <u>Make controller discoverable on L2 Network</u> <br><img src="https://habrastorage.org/getpro/habr/post_images/2bc/bcc/8a1/2bcbcc8a1253d416092933de6669f6d7.jpg" alt="image"><br><br>  3. We pass in Settings -&gt; Networks <br>  We select the default network, edit, specify for example our corporate - <u>192.168.0.1/24</u> <br><img src="https://habrastorage.org/getpro/habr/post_images/f06/108/147/f061081477ff3088015664290b9376f9.jpg" alt="image"><br><br>  3.1 Creating VLAN2 <br>  Create New Network -&gt; VLAN ONLY <br>  We set the checkbox <u>Enable DHCP Guarding</u> and specify our DHCP server <u>172.15.1.1</u> for VLAN2 <br><img src="https://habrastorage.org/getpro/habr/post_images/944/2a8/16d/9442a816d9ece09312ad44d217e4c6c4.jpg" alt="image"><br><br>  3.2 Creating VLAN3 - (all the same) <br>  Create New Network -&gt; VLAN ONLY <br>  We set the checkbox Enable <u>DHCP Guarding</u> and specify our DHCP server <u>172.17.1.1</u> for VLAN3 <br><img src="https://habrastorage.org/getpro/habr/post_images/165/4e8/25c/1654e825c0850934175c7db9b6b5e123.jpg" alt="image"><br><br>  <b>We screw VLANy to SSID</b> <br>  We have reached the final moment of the trick - now we will attach our VLAN2, VLAN3 to the guest and corporate network <br><br>  We pass in Settings -&gt; Wireless Networks <br>  Create a guest network with parameters: <br>  Name / SSID: Guest <br>  Security: WPA-PERSONAL <br>  Security Key: password <br>  Advanced Options -&gt; <br>  <b>VLAN - Use VLAN ID 2</b> <br>  WPA Mode: WPA2 Only <br>  Encryption: AES / CCMP Only <br>  Usergroup: Default <br><br><img src="https://habrastorage.org/getpro/habr/post_images/f04/2ea/ffd/f042eaffd8dcbd77e600e1321c99e657.jpg" alt="image"><br><br>  Let's create a corporate network with parameters: <br>  Name / SSID: Corp <br>  Security: WPA-PERSONAL <br>  Security Key: password <br>  Advanced Options -&gt; <br>  <b>VLAN - Use VLAN ID 3</b> <br>  WPA Mode: WPA2 Only <br>  Encryption: AES / CCMP Only <br>  Usergroup: Default <br><br>  <b>Results</b> <br>  At this, the basic configuration of the Ubiquiti UniFi Controller is completed, your access points now receive IP addresses from the 172.16.1.1/24 network, now the clients that connect to the Guest wireless network receive the IP addresses 172.15.1.1/24 and access the Internet under the external IP 100.100.100.102 , and clients who connect to the Corp network, go to the Internet under an external IP 100.100.100.103 and pick up 172.17.1.1/24.  Your office employees go to the Internet under the external IP 100.100.100.101.  We also banned guest access to all private networks except ours.  You can also use the guest network without a password - this is optional.  This topology may vary depending on your needs, for example, you can remove the redundant network 172.16.1.1/24 ... Have a good weekend! <br><br>  <i>PS If you find spelling errors - please email me at PM</i> <br><cut></cut></div><p>Source: <a href="https://habr.com/ru/post/263431/">https://habr.com/ru/post/263431/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../263417/index.html">Features withCredentials</a></li>
<li><a href="../263419/index.html">A simple and obvious replacement for android.util.Log</a></li>
<li><a href="../263423/index.html">Voice control computer and Python</a></li>
<li><a href="../263427/index.html">Common sense is more important than algorithmic mastery.</a></li>
<li><a href="../263429/index.html">Beeline automatically changes HTML tags</a></li>
<li><a href="../263433/index.html">Responsive Sites, or How to Get Google Favor</a></li>
<li><a href="../263435/index.html">OData REST API - minor tricks (part 3)</a></li>
<li><a href="../263441/index.html">Print service support in ReactOS - very soon</a></li>
<li><a href="../263443/index.html">Internet Explorer 11 Bookmarklets: Storage Format, Limits and Silent Rules, Treacherous Bug</a></li>
<li><a href="../263445/index.html">TIS-100 - a puzzle about a multithreaded assembler that no one expected</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>