<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How I stopped worrying and fell in love with Hyper-V Server</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Recently, I had a task to ‚Äúget used to the user's skin‚Äù and actually check how it works on the free Microsoft Hyper-V Server 2012. 



 Yes, yes, ther...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How I stopped worrying and fell in love with Hyper-V Server</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/8d9/0da/890/8d90da890801a4d21a760133a5a80a63.png" alt="      Hyper-V Server" align="right" title="How I stopped worrying and fell in love with Hyper-V Server"><br><p>  Recently, I had a task to ‚Äúget used to the user's skin‚Äù and actually check how it works on the free Microsoft Hyper-V Server 2012. </p><br><br><p>  Yes, yes, there is free cheese not only in a mousetrap, but also at Microsoft.  If you want to virtualize a server or at least your old laptop, but do not want to pay extra money for the hypervisor, then Hyper-V Server is what you need to try.  Why?  Firstly, it is really free - all functions, including even ‚Äúenterprise‚Äù, are available to users immediately and without any reservations, secondly, it is supported and developed by a large company, and, thirdly, it‚Äôs just plain old Windows, though a bit cropped to Server Core. </p><br><br><p>  Under the cut, you will find a story about how to install and configure Hyper-V Server and elegantly bypass the limitations of this platform using Linux. </p><br><a name="habracut"></a><br><h4>  Installation </h4><br><p>  Everything is so standard that even nothing to write about.  <a href="http://www.microsoft.com/en-us/server-cloud/hyper-v-server/default.aspx" title="Microsoft Hyper-V Server 2012">ISO image we take from here</a> on the proud link "Free Download". </p>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>  The entire installation process takes a few minutes and ends with a standard invitation for the administrator.  After setting the password, an unusually bare desktop with two console windows opens. </p><br><br><img src="https://habrastorage.org/getpro/habr/post_images/e9f/cb0/8a6/e9fcb08a6e703a2e5f136114331e45ed.png" alt="" title="Console"><br><br><p>  In principle, if you think about it, it's not so scary: after all, the task of our server is to run virtual machines, and you can also play solitaire somewhere else. </p><br><br><h4>  Configuration: System </h4><br><p>  Use the blue console to set the necessary parameters - name, network addresses, enable RDP and auto-update. </p><br><br><p>  Speaking of updating the system: circumcision to Server Core was done to reduce the attack surface, in other words, to reduce the number of services and software components that may contain vulnerabilities, and therefore must be patched regularly.  And since installing patches often requires a server reboot, reducing the number of updated server components will not only lead to an increase in its security, but also accessibility. </p><br><br><h4>  Configuration: Hyper-V </h4><br><p>  For some reason, no virtual switches are created during installation, so virtual machines by default have no connection with the outside world.  Fix it - let's create the simplest switch bridge to the physical adapter. </p><br><br><p>  Run powershell in the second console.  Yes, circumcision of the server to console programs makes sacrifices, but we are pursuing noble goals (see above). </p><br><br>  1) We learn under what names the adapters appear.  To do this, run the command Get-NetAdapter <br><pre><code class="hljs delphi">PS C:\Users\Administrator&gt; Get-NetAdapter <span class="hljs-keyword"><span class="hljs-keyword">Name</span></span> InterfaceDescription ifIndex Statu s ---- -------------------- ------- ----- Ethernet <span class="hljs-number"><span class="hljs-number">5</span></span> Broadcom BCM5708C NetXtreme II Gi...<span class="hljs-string"><span class="hljs-string">#47</span></span> <span class="hljs-number"><span class="hljs-number">16</span></span> Up Ethernet <span class="hljs-number"><span class="hljs-number">4</span></span> Intel(R) PRO/<span class="hljs-number"><span class="hljs-number">1000</span></span> PT Dual Port Ser...<span class="hljs-string"><span class="hljs-string">#2</span></span> <span class="hljs-number"><span class="hljs-number">15</span></span> Di... Ethernet <span class="hljs-number"><span class="hljs-number">3</span></span> Intel(R) PRO/<span class="hljs-number"><span class="hljs-number">1000</span></span> PT Dual Port Serve... <span class="hljs-number"><span class="hljs-number">14</span></span> Di... Ethernet <span class="hljs-number"><span class="hljs-number">2</span></span> Broadcom BCM5708C NetXtreme II Gi...<span class="hljs-string"><span class="hljs-string">#49</span></span> <span class="hljs-number"><span class="hljs-number">13</span></span> Up</code> </pre> <br>  2) Create a virtual switch tied to an Ethernet adapter 5 <br><pre> <code class="hljs pgsql">PS C:\Users\Administrator&gt; <span class="hljs-built_in"><span class="hljs-built_in">New</span></span>-VMSwitch -<span class="hljs-type"><span class="hljs-type">Name</span></span> "bridged" -NetAdapterName "Ethernet 5" <span class="hljs-type"><span class="hljs-type">Name</span></span> SwitchType NetAdapterInterfaceDescription <span class="hljs-comment"><span class="hljs-comment">---- ---------- ------------------------------ bridged External Broadcom BCM5708C NetXtreme II GigE (NDIS VBD Client) #47</span></span></code> </pre> <br><p>  To create a virtual machine - everything is ready. </p><br><br><h4>  Create a virtual machine </h4><br>  Most likely, we will need an ISO image to install the operating system, we copy it in the usual way for Windows - over the network through dollar balls on our server. <br><br><p>  Now create a car. </p><br><pre> <code class="hljs pgsql">PS C:\Users\Administrator&gt; <span class="hljs-built_in"><span class="hljs-built_in">New</span></span>-VM -<span class="hljs-type"><span class="hljs-type">Name</span></span> "test1" -<span class="hljs-type"><span class="hljs-type">Path</span></span> C:\vms\test1 -MemoryStartupBytes <span class="hljs-number"><span class="hljs-number">2</span></span>GB -NewVHDPath C:\vms\test1\disk1.vhdx -NewVHDSizeBytes <span class="hljs-number"><span class="hljs-number">40</span></span>GB -SwitchName "bridged" <span class="hljs-type"><span class="hljs-type">Name</span></span> State CPUUsage(%) MemoryAssigned(M) Uptime Status <span class="hljs-comment"><span class="hljs-comment">---- ----- ----------- ----------------- ------ ------ test1 Off 0 0 00:00:00 Operating normally</span></span></code> </pre> <br><p>  There is a small subtlety in choosing the type of network adapter - if the choice of operating system fell on Windows 2012, then you can choose a standard adapter, but if something else is better, choose the ‚Äúlegacy‚Äù type of adapter.  This can be done by adding the adapter to the virtual machine with the -IsLegacy 1 key. </p><br><pre> <code class="hljs pgsql">Remove-VMNetworkAdapter -VMName test1 <span class="hljs-keyword"><span class="hljs-keyword">Add</span></span>-VMNetworkAdapter -VMName test1 -IsLegacy <span class="hljs-number"><span class="hljs-number">1</span></span> -SwitchName ¬´bridged¬ª</code> </pre> <br><p>  Insert an ISO image into the default DVD drive </p><br><pre> <code class="hljs tex">PS C:<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Users</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Administrator</span></span></span></span>&gt; Set-VMDvdDrive -VMName test1 -Path C:<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">iso</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">en</span></span></span></span>_windows_server_2012_vl_x64_dvd_917758.iso</code> </pre> <br><p>  For the future - when you need to pull the disk out of the virtual drive, you need to run Set-VMDvdDrive -VMName &lt;machine name&gt; -Path $ null </p><br><br><p>  Well, sort of, everything ... You can run! </p><br><pre> <code class="hljs tex">PS C:<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Users</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Administrator</span></span></span></span>&gt; Start-VM test1</code> </pre> <br><p>  Mmmm, I ran the progress at the top of the powershell window, apparently everything started.  Check the command Get-VM </p><br><pre> <code class="hljs pgsql">PS C:\Users\Administrator&gt; <span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>-VM test1 <span class="hljs-type"><span class="hljs-type">Name</span></span> State CPUUsage(%) MemoryAssigned(M) Uptime Status <span class="hljs-comment"><span class="hljs-comment">---- ----- ----------- ----------------- ------ ------ test1 Running 0 2048 00:01:30 Operating normally</span></span></code> </pre> <br><p>  Everything is good - the machine works. </p><br><br><h4>  However, how to look at the screen ?! </h4><br><p>  Wait a second ... but how can you look at the installation screen, where to poke a mouse?  In general - where is the console?  locally - no way: it is not on the server! </p><br><br><p>  What Microsoft offers - you can put RSAT (remote system administration tools) on the client station.  With these tools, you can connect to the virtual machine console, and, by the way, from there, you can also create and run virtual machines via mmc snap-in Hyper-V.  However, there are interesting features: </p><br><br><ul><li>  RSAT for Windows 8 only works with Windows 2012 </li><li>  RSAT for Windows 7 Sp1 works only with Windows 2008 R2 SP1 </li></ul><br><p>  In my opinion, it‚Äôs not a matter of changing the server version to change the client axis!  Where are the product managers at Microsoft looking at ?!  How can I go to the console? </p><br><br><p>  The idea came from no waiting ... Why not use a Linux virtual machine as a RDP proxy? </p><br><br><h4>  A gift for everyone </h4><br><p>  As a result, I made a virtual machine based on CentOS, which can be accessed via RDP, logged in, and then run the console on any virtual machines on this or any Hyper-V server on the network in a simple interactive script. </p><br><br><p>  You can <a href="http://bit.ly/1i80NVQ" title="Virtual machine backup">download this machine image</a> (371MB) and deploy it using the free version of Veeam Backup &amp; Replication on a Hyper-V server.  The root user has the password 123qweASD.  To change the password, you must first run passwd, and then do not forget vncpasswd. </p><br><br><p>  After starting the machine, you can find out the IP address of this machine by running this command on the server Get-VM &lt;machine name&gt; |  select -ExpandProperty NetworkAdapters |  select Ipaddresses.  You need to have a DHCP server on the network. </p><br><pre> <code class="hljs pgsql">PS C:\Users\Administrator&gt; <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>-vm rdpproxy | <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> -ExpandProperty NetworkAdapters | <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> IPaddresses IPAddresses <span class="hljs-comment"><span class="hljs-comment">----------- {192.168.1.8, fe80::215:5dff:fe01:6703}</span></span></code> </pre> <br><p>  Using the client's RDP, we go to this machine, add a Hyper-V server, select a virtual machine and ... voil√† - now you can proceed with the installation of the operating system </p><br><br><img src="https://habrastorage.org/getpro/habr/post_images/4ea/982/039/4ea982039c12372f165c813bd3a66291.png" alt="    Windows Server 2012" title="Installing the operating system in Windows Server 2012"><br><br><h4>  How it works </h4><br><p>  The main work was done by cool guys from FreeRDP.  No - well, they are really cool, because they supported the RDP protocol even better than at Microsoft.  There is support for RemoteFX, add-ins, caches, audio redirection and clipboard ... in general, all that they can connect not only to different versions of Windows, but also to virtual machines directly through a specially open for this on Hyper-V server port 2179. </p><br><br><p>  All the latest protocols needed to work with Hyper-V are only in beta 1.1.0 version.  I modified the version a bit just to override the sending of Ctrl + Alt + Del to the combination Ctrl + Alt + Insert, and the Linux proxy was the first to process it and to go to Windows the virtual machine had no way.  As an honest person, I posted the source here: <a href="https://github.com/VeeamSoftware/FreeRDP">https://github.com/VeeamSoftware/FreeRDP</a> </p><br><br><p>  Xrdp is used as the RDP server. </p><br><br><p>  The script for polling hosts and launching consoles is written in bash.  I wrote on it for the first time - I beg your condescension to the clumsiness. </p><br><br><p>  Poll hosts for the presence of running virtual machines and their identifiers made through WMI.  Thanks to the wmic utility, written on the basis of the Samba 4 library. </p><br><br><p>  CentOS 6.4 has inside itself a part of Integration Services, which via the channel host-virtual machine about itself some information, from which we need only IP addresses. </p><br><br><h4>  Something about the future </h4><br><p>  Not very good news, on Friday a new version of Hyper-V Server 2012 R2 just came out, I tried to run on its Preview, but CentOS integration services could not get IP address on the host.  Apparently Microsoft again changed / expanded something without backward compatibility.  Let's wait for the release of Intergation Services for Linux and support this version. </p><br><br><h4>  Conclusion </h4><br><p>  Hyper-V Server is a good system for starting the development of a small IT company.  Full gratuity - a good help when the budget is limited.  And in the future, this hypervisor will allow you to easily add "enterprise" capabilities without extra expenses: develop capacity by adding new servers, implement more cunning network schemes, provide fault tolerance through clustering, etc. </p><br><br><p>  I hope that this story and applains will help you use this platform effectively from the first steps. </p><br><br><h4>  useful links </h4><br><ul><li>  <a href="http://technet.microsoft.com/en-us/library/dn282278.aspx">What is new for us in Hyper-V 2012 R2</a> (TechNet article in English) </li><li>  <a href="http://www.youtube.com/watch%3Fv%3DBAqSUS6UDa4">Video retrospective of all Hyper-V features from the first to the just-released version with a demo</a> (47 min, in English) </li><li>  <a href="http://www.veeam.com/ru/virtual-machine-backup-solution-free.html" title="Veeam Backup Free Editon">Free Hyper-V Buckup from our company</a> </li><li>  <a href="http://www.veeam.com/ru/virtual-server-management-one-free.html" title="Veeam ONE Free Edition">Free monitoring from us</a> </li><li>  <a href="http://www.microsoft.com/en-us/download/details.aspx%3Fid%3D40732">Hyper-V 2012 R2 posters</a> (in English) </li></ul></div><p>Source: <a href="https://habr.com/ru/post/198144/">https://habr.com/ru/post/198144/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../198132/index.html">02 Collector: Friday content, 3D and typography</a></li>
<li><a href="../198134/index.html">The user selected the domain for "renewal of registration with malicious intent"</a></li>
<li><a href="../198138/index.html">A selection of useful CSS recipes, or what we do on bare Fridays.</a></li>
<li><a href="../198140/index.html">Python Meetup: Garbage Collector</a></li>
<li><a href="../198142/index.html">QtCreator: Qt cross-compiling from linux 64 to linux 32, win32, win64 and Mac OS X; upx, usb, dmg, etc</a></li>
<li><a href="../198148/index.html">FreeBSD auto configuration</a></li>
<li><a href="../198150/index.html">Getting to know Go, part 2: writing a grabber of images with a balancer and perversions</a></li>
<li><a href="../198152/index.html">Bitcoin users may have discovered Ross Ulbricht‚Äôs personal wallet</a></li>
<li><a href="../198154/index.html">Localization of Node.js applications Part 2: Toolkit and Process</a></li>
<li><a href="../198158/index.html">Warp9 is another reactive js library. At this time composable and without leaks</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>