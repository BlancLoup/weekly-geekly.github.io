<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Experience Angular + Typescript + Offline SPA project in a year</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I want to share my small positive experience about the project based on Angular + Typescript after a year. This is far from a new bundle, and I am sur...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Experience Angular + Typescript + Offline SPA project in a year</h1><div class="post__text post__text-html js-mediator-article"><img align="left" src="https://habrastorage.org/getpro/habr/post_images/a6a/3a6/fcd/a6a3a6fcd020b45cb527742b17e0d603.jpg" alt="image" width="384">  I want to share my small positive experience about the project based on Angular + Typescript after a year.  This is far from a new bundle, and I am sure that many already use it successfully.  Of course, many are already waiting for more articles on React or Angular 2.0, but it seems to me, and this experience will be useful to someone. <br><a name="habracut"></a><br><h4>  Context </h4><br>  I work in a grocery company.  The main product is a corporate application and a history of 10+ years (Web, ASP.Net, C # MSSQL).  Despite the honorary age and codebase 1M + LoC, the project is still relevant, supported, refactoring and updates of libraries and approaches are being systematically carried out. <br><br>  But here the client wanted to make the replacement of the main UI with SPA (Angular) so that it would work on the devices.  - So the new project began a year ago. <br><br>  Before that, I worked as an architect on the backend C # parts, and worked on business rules, SQL-performance, SQL-deadlocks, queues, and so on. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Javascript was actively working only on its pet-projects and the amount of code was not significant.  I even had to transfer one of my pet projects from javascript to java (GWT switch) after 15k LoC!  Due to the fact that the project has ceased to be supported.  Hard transition justified itself (until Angular appeared). <br><br>  Therefore, it was difficult for me to imagine how to write a javascript project with&gt; 20k LoC and at the same time save it maintained, readability and extensibility. <br><br>  After analyzing the current similar SPA projects on Backbone, Angular, I was once again convinced that they had 20k-35k LoC, the structure was, but not clear, any refactoring in them was no longer possible. <br><br><h4>  Requirements </h4><br>  The requirements of the new Angular project were estimated to be 2-4 times greater than the current. <br><br>  Moreover, the requirements also required support for HTML5 Offline mode, with support for data editing (which means that in addition to REST, we still need to have a similar implementation on IndexedDB). <br><br>  The start of the project was planned in a month or two.  Therefore, I had enough calendar time to study the current experience of the current javascript team and enter a new javascript for me - Angular ecosystem. <br><br><h4>  Making decisions </h4><br>  <b>Angular</b> <br><br>  Not even discussed.  We had a team with 1-2 years of its use.  The customer insisted on it.  He also impressed me, and after my long experience with clean jQuery, GWT UI, heavy UI Toolkits, it seemed like a breath of fresh air. <br>  Knockout, and the good old Backbone demanded to build a model on their objects / methods.  I ate this such ‚Äúrestrictions‚Äù in full before that.  The ability to use Plain Javascript Objects / Arrays in Angular outweighed any performance benefits of Knockout, Backbone. <br><br>  On the other hand, Angular has its own characteristics - its own DI and overdesign. <br><br>  Service, Module is the unit for structuring code (like a class), Factory, Controller is the sugar around Service.  I didn‚Äôt really like to use Angular DI, which is also completely confusing to WebStorm 9. <br><br>  <b>Typescript</b> <br><br>  The main decision that I had been thinking about for a long time, tried, prototyped and promoted to the client.  By the way, it was rather difficult then to explain to the client (and the team) why we should write in a different language, and not in Javascript which is to the trend, especially on a strategic project designed for a year. <br><br>  It is important to understand the main message - Typescript is NOT another language, it is an extension of Javascript (just like LESS is a CSS preprocessor). <br>  It is also important to understand why we generally need Compile-time Type Checking (by analogy with C #, Java, C ++): <br><br><ul><li>  It makes elementary checks for the correctness of the code, otherwise, you need to write hundreds of elementary Unit-tests that add size to the project and break down with any change in the application. </li><li>  It makes possible refactoring, changing the structure, merge code possible and controlled </li><li>  IDE support is usually much better - and this is a high development speed.  In any place of the code you call auto-complite after "."  and see 5-10 options, rather than 100 approximately possible.  Find-usage really works, in IDE searching by user.id will not confuse with product.id </li><li>  The developer runs less heavy application, IDE, grunt build immediately warns about simple and sometimes complex errors </li><li>  Simplifies review / code analysis </li><li>  Especially relevant for large projects (in my experience&gt; 10k LOC) </li></ul><br>  From my point of view, the Typescript killer feature is optional typing. <br><br>  When I worked with GWT (there you write on java in your IDE, and the compiler converts it to javascript), it bothers me that EVERYTHING, you need to mark each variable with a type, it is expensive and not necessary.  I want to designate types only some things inside the application (contracts between modules, data and their conversion into a model, arguments and return of functions etc.). <br><br>  By the way, C #, Java, C ++ are also moving towards optional typing - var, auto, dynamic. <br><br>  If you just copy the strict-Javascript code into a Typescript file, then it compiles without problems.  If type checking is not needed - just led to the special type ‚Äúany‚Äù, and everything is possible: <br><br><pre><code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> a=<span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">any</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">0; // 1 var a:any=0; // 2 a().some().thing()[15].else();</span></span></code> </pre> <br>  Generic-types support is especially convenient (as well as C # and Java), together with ES6 Arrow functions all translations and work with promises and models are extremely readable and safe, and it saves this: <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-function">function </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">loadUsers</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:ng.IPromise&lt;Array&lt;User&gt;&gt;</span></span>{ <span class="hljs-comment"><span class="hljs-comment">/*some*/</span></span>} <span class="hljs-function"><span class="hljs-function">function </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">loadBirthDates</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:ng.IPromise&lt;Array&lt;Date&gt;&gt;</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> loadUsers().then(users=&gt;users.map(u=&gt;u.birthDate)); }</code> </pre><br>  Here the IDE clearly knows that u - has a class User, and will generate an error if birthDate is not there or is not of type Date. <br><br>  Support for ES6 class in Typescript. <br><br>  At first glance, ES6 class is an ordinary sugar (for example, babeljs, the Typescript compiler that generates the prototype).  But it‚Äôs not about the runtime, it‚Äôs about IDE support and millions of programmers thinking more about OOP, not about Functional style. <br><br>  Example 1: <br><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">a</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">b</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">d</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{} } } }</code> </pre><br>  Suppose that this code is written in the OOP style, where is the module, where is the class, and where is the class method?  Or maybe it's all a class in the private method b in which inside it?  Maybe an example and contrived, but sometimes so also make out the code, as well as through prototype. <br><br>  Example 2: <br><br><pre> <code class="javascript hljs"><span class="hljs-built_in"><span class="hljs-built_in">module</span></span> a{ <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">b</span></span></span></span>{ c(){ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> d = <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">=&gt;</span></span>{}; } } }</code> </pre><br>  Here the levels in OOP terms are already clear without explanation.  Moreover, they are clear not only to the person but also to the IDE.  And the IDE already knows exactly what it is. <br>  Readability is several times higher, although it is compiled into all the same nested functions. <br><br>  Also, unlike GWT, Typescript is compiled file-by-file, with all indents and comments preserved (in WebStorm, to save the file).  I do not turn on source-maps in Chrome when viewing the Typescript file - the generated JS file is not much different. <br><br>  Also in our Backend team, everyone knows C # and OOP.  And using Typescript makes it possible to rotate them on the Frontend (CSS knowledge and layout is not critical, I repeat, we have a corporate application). <br><br><h4>  Structure and implementation </h4><br>  The project structure looks like this: <br><br><ul><li>  framework </li><li>  business <ul><li>  security <ul><li>  dto <ul><li>  UserDto.ts </li><li>  GroupDto.ts </li></ul></li><li>  dal <ul><li>  SecurityAdapter.ts </li><li>  SecurityOfflineAdapter.ts </li></ul></li><li>  SecurityFacade.ts </li></ul></li></ul></li><li>  ui <ul><li>  security <ul><li>  SecurityController.ts </li><li>  Security.html </li><li>  SecurityMobile.html </li></ul></li></ul></li><li>  routing <ul><li>  routingStates.ts </li></ul></li></ul><br>  The framework "sees" the library, the business "sees" the framework and the library, ui and routing see everything. <br><br>  This structure and agreements was not chosen by chance, it resembles our ASP.Net project to which everyone in the backend team is used to.  It may seem like a strange thing from the backend to the SPA, but for me the parallels and the convenience of the developers are obvious. <br><br>  Standard Typescript module support is used (although there are many options available): import (s) at the beginning of the file and _references.d.ts files.  Not a very convenient solution, but understandable IDE, I think that we will move on to something else if the IDE understands it. <br><br>  Ui layer is accessed by business only through * Facade classes. <br><br>  A typical Facade is a class in which almost all methods return promises.  Facade inside is responsible for calling Adapters. <br><br><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">///&lt;reference path="../_references.d.ts"/&gt; module business.security { export class SecurityFacade { loadUsers():ng.IPromise&lt;Array&lt;UserDto&gt;&gt;{} loadGroups():ng.IPromise&lt;Array&lt;GroupDto&gt;&gt;{} renameUser(userId:string, name:string):ng.IPromise&lt;void&gt;{} } }</span></span></code> </pre><br>  Offline support is simple, for example, SecurityFacade.loadUsers is implemented as follows: call SecurityAdapter.loadUsers ‚Äî if promise returns an error ‚Äî load SecurityOffineAdapter.loadUsers from IndexedDb, if successful, we cache a successful result in IndexedDb - UserOffineAdapter.saveUsers.  There are many details (for example, the queue to save, the limit Indexed DB and TP), but roughly works like this. <br><br><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">///&lt;reference path="../_references.d.ts"/&gt; module business.security { export class SecurityFacade { loadUsers():ng.IPromise&lt;Array&lt;UserDto&gt;&gt;{ SecurityAdapter.loadUsers().then(data =&gt; { SecurityOffineAdapter.saveUsers(data); return data; }).catch(ex =&gt; { if (isOffline()) { return SecurityOffineAdapter.loadUsers();} throw ex }); } } }</span></span></code> </pre><br>  The decision not to use Angular DI is possible, outside the box.  Even without a special need for Angular in business, we have to wrap all promise types (for example jQuery) and difference onSuccess / onError in Angular promise. <br>  Using Angular promise is extremely necessary - it will automatically cause $ apply at the end.  Otherwise, you yourself will need to flood your $ apply code with calls, and also make sure that you are not in the digest cycle.  Fortunately, $ q, like any other provider, is easy to get outside of Angular DI, for example, to use Angular promise in business: <br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> $q = angular.element(<span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.body).injector().get(<span class="hljs-string"><span class="hljs-string">"$q"</span></span>);</code> </pre><br>  Any objects stored in Json after downloading and before sending are always checked by the Adapter.  Typescript will not help you with this.  Therefore, in each Dto class, we have a copyAndVerify static method that can internally check and clean each property of the object and also call it on the sub-objects, and also can do an ‚Äúupgrade‚Äù of the object to the higher version (for example, renaming the field and changing the type).  Calling copyAndVerify makes an Adapter for each object in the collection.  When saving it is also necessary - Angular hangs its methods on the object that needs to be cleaned before serialization, and Angular directives can change the type - for example, save the number as text. <br><br>  UI: SecurityController is also an ordinary class, only it is registered in Angular, and also selects the desired view. <br><br><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">///&lt;reference path="../_references.d.ts"/&gt; module ui.security { import SecurityFacade = business.shared.SecurityFacade; export class SecurityController { users:Array&lt;User&gt;; constructor(public $scope:IScope, public $window:ng.IWindowService) { new SecurityFacade().loadUsers().then(users=&gt;this.users); //Arrow-functions    var _this=this; } } // @ngInject function SecurityDirective ():ng.IDirective { return { scope: {}, templateUrl: routing.isMobile() ? 'ui/security/Security.html' : 'app/security/SecurityMobile.html', controller:SecurityController , controllerAs: 'securityCtrl' } } angular.module('app').directive('securityDirective', SecurityDirective); }</span></span></code> </pre><br><h4>  One year later </h4><br>  A bunch of satisfied.  In the production is already half a year.  Already about 23k LoC and at the same time the project easily experienced 7 medium refactorings, team change.  It continues to be easily maintained, soon we plan to add another big feature.  Recently changed IndexedDb on the.  Code-review is easy to conduct. <br><br>  I had to tinker with offline support, but 200Mb is easily stored on all iPhones, iPads, Chome, IE10.  Plus, the entire SPA (2.5Mb) is loaded from the local cache, so it starts smartly regardless of the Internet connection. <br><br>  Performance on Angular does come to periodically pay attention - remove the watch and replace it with events, revise the directives and the views code. <br><br>  Autotests, by the way, are also written in Typescript using the Protractor and PageObject approach. <br><br>  Now Typescript is supported perfectly in WebStorm, Visual Studio (already good in 2015) and some others probably.  If they chose now, they could have chosen React instead of Angular.  I also think to partially use Typescript in ASP.Net on heavy UI controls. </div><p>Source: <a href="https://habr.com/ru/post/274591/">https://habr.com/ru/post/274591/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../274575/index.html">IBM continues to work with Apache Spark: corporation launches Spark-as-a-service</a></li>
<li><a href="../274577/index.html">Some modern approaches to natural language processing</a></li>
<li><a href="../274581/index.html">Docker compose and merge projects using mixer-a</a></li>
<li><a href="../274585/index.html">Eddystone and Physical Web: Beacon Evolution</a></li>
<li><a href="../274587/index.html">Java web platform in 30 minutes</a></li>
<li><a href="../274593/index.html">Universal Memcomputing Machines as an alternative to Turing Machine</a></li>
<li><a href="../274595/index.html">Next week, Microsoft stops supporting all versions of IE, except 11</a></li>
<li><a href="../274597/index.html">Overview of the example application of reinforcement learning using TensorFlow</a></li>
<li><a href="../274601/index.html">Tips for novice microcontroller programmers</a></li>
<li><a href="../274603/index.html">PROLOG for programmers</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>