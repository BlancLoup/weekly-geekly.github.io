<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>KitchenCI + Ansible for Windows and Linux</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="My colleague wrote an excellent blog about local testing of Ansible roles using KitchenCI . A very fast and simple tool consisting of ruby ‚Äã‚Äãgems, ava...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>KitchenCI + Ansible for Windows and Linux</h1><div class="post__text post__text-html js-mediator-article">  My colleague wrote an excellent <a href="https://hodgkins.io/testing-ansible-roles-windows-test-kitchen">blog</a> about local testing of Ansible roles using <a href="http://kitchen.ci/">KitchenCI</a> .  A very fast and simple tool consisting of ruby ‚Äã‚Äãgems, available on each OS, which also works with different testing tools (for example, Serverspec and Pester).  A colleague developed this solution for the needs of his projects (provision and deploy exclusively for Windows), which at first glance became a problem, because: <br><br><ul><li>  I love Ansible too </li><li>  I need ansible to manage linux </li><li>  I don‚Äôt want to create another repository on GitHub for a separate testing of Linux roles, because I don‚Äôt want to create entities (Occam's razor is everything) </li></ul><br>  Who cares what happened next, please under the cat. <br><a name="habracut"></a><br>  After a bit of discussion, we agreed that I would adapt his tool for both environments, and the end user of the tool (be it an engineer or a developer) would be able to use all of its components or only a part.  But first, a brief description of what is working now. <br><br>  And now we have the standard Ansible role, in a separate directory is the kitchen, in which the Pester tests are located to test the WinServer configuration and the settings of the kitchen itself.  In the .kitchen file there are 2 configurations for Vagrant boxes (Ansible + Winserver), deployment scripts and paths to tests.  Who cares, the source <a href="https://github.com/MattHodge/ansible-testkitchen-windows">here</a> . 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      According to 4 teams in the kitchen directory, we will pass our testing from the beginning to the end. <br><br><ul><li>  kitchen create - will create our local virtual infrastructure </li><li>  kitchen converge - apply the role of ansible </li><li>  kitchen verifiy - apply the test suite from the verifier </li><li>  kitchen destroy - removes it. </li></ul><br>  The first time will be performed for an incredibly long time (the Windows box is very hard), so you need to be patient. <br><br>  An important point I forgot to mention is that this configuration is the skeleton of a role that a developer can learn in order to understand how to develop and test his role.  I can‚Äôt imagine a case when a developer develops one role that should work on both ecosystems. <br><br>  Nevertheless, the corporate GitHub is not rubber, so you need to save a little. <br>  To begin with, we will configure the playbook role to be universal for both OSs.  Banal facts Ansible will help us here. <br><br><pre><code class="bash hljs">--- <span class="hljs-comment"><span class="hljs-comment"># This play installs IIS, if you run it on windows box - name: install web-server feature win_feature: name: Web-Server state: present when: ansible_os_family == "Windows" - name: deploy iis start page template template: src: iisstart.j2 dest: C:\inetpub\wwwroot\iisstart.htm when: ansible_os_family == "Windows" # This play installs Nginx, if you run it on linux box - name: install nginx yum: name=nginx state=latest when: ansible_os_family == "RedHat" - name: start nginx service: name=nginx state=started enabled=True when: ansible_os_family == "RedHat"</span></span></code> </pre> <br>  As you can see, in the first case we install the IIS role in Windows, in the second we install and run Nginx. <br><br>  Now to the tests.  Create a new directory in kitchen / tests / integration / default (default is the name of our test suit'a) called serverspec.  In it we will have only one file defailt_spec.rb <br><br>  <i>I'm not very good at ruby, so I did it dirty without a spec helper.</i> <br><br><pre> <code class="ruby hljs"><span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">'rubygems'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">'bundler/setup'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">'serverspec'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">'pathname'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">'net/ssh'</span></span> RSpec.configure <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-params"><span class="hljs-params">|config|</span></span> set <span class="hljs-symbol"><span class="hljs-symbol">:host</span></span>, ENV[<span class="hljs-string"><span class="hljs-string">'KITCHEN_HOSTNAME'</span></span>] <span class="hljs-comment"><span class="hljs-comment"># ssh options at http://net-ssh.github.io/net-ssh/Net/SSH.html#method-c-start # ssh via ssh key (only) set :ssh_options, :user =&gt; ENV['KITCHEN_USERNAME'], :port =&gt; ENV['KITCHEN_PORT'], :auth_methods =&gt; [ 'publickey' ], :keys =&gt; [ ENV['KITCHEN_SSH_KEY'] ], :keys_only =&gt; true, :paranoid =&gt; false, :verbose =&gt; :error set :backend, :ssh set :request_pty, true end describe package('nginx'), :if =&gt; os[:family] == 'redhat' do it { should be_installed } end describe service('nginx'), :if =&gt; os[:family] == 'redhat' do it { should be_enabled } it { should be_running } end describe port(80) do it { should be_listening } end</span></span></code> </pre><br>  Here we have only three checks: the package is installed, the service is running both on autostart and on port 80 someone is listening. <br><br>  A little advice for those who, like me, do not know how to use Ruby - according to the serverspec-init <a href="http://serverspec.org/">documentation, it</a> will generate a default test for you, as in the example above. <br><br>  So, the role is, there are tests.  Now you need to configure the kitchen itself.  A colleague is forced to raise two machines, because deploying a small ansible server is much easier than installing it on Windows.  In my case, installing the ansible role will be the kitchen itself, so one machine will suffice for me.  My kitchen script will be smaller. <br><br><pre> <code class="hljs cs">--- driver: name: vagrant gui: <span class="hljs-literal"><span class="hljs-literal">true</span></span> linked_clone: <span class="hljs-literal"><span class="hljs-literal">true</span></span> platforms: - name: centos_box driver_plugin: vagrant driver_config: box: centos/<span class="hljs-number"><span class="hljs-number">7</span></span> network: - [ <span class="hljs-string"><span class="hljs-string">'private_network'</span></span>, { ip: <span class="hljs-string"><span class="hljs-string">'172.28.128.13'</span></span> } ] transport: max_ssh_sessions: <span class="hljs-number"><span class="hljs-number">1</span></span> provisioner: name: ansible_playbook roles_path: ../ role_name: kitchen_test_role ansible_inventory: inventory/hosts require_windows_support: <span class="hljs-literal"><span class="hljs-literal">true</span></span> require_chef_for_busser: <span class="hljs-literal"><span class="hljs-literal">false</span></span> ansible_host_key_checking: <span class="hljs-literal"><span class="hljs-literal">false</span></span> ansible_verbose: <span class="hljs-literal"><span class="hljs-literal">true</span></span> ansible_verbosity: <span class="hljs-number"><span class="hljs-number">4</span></span> playbook: default_linux.yml verifier: name: serverspec remote_exec: <span class="hljs-literal"><span class="hljs-literal">false</span></span> suites: - name: <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> verifier: patterns: - tests/integration/<span class="hljs-keyword"><span class="hljs-keyword">default</span></span>/serverspec/default_spec.rb</code> </pre> <br><br>  I have a separate ansible_playbook, because in it the role is performed only for the linux machine in the inventory file. <br><br>  With the development in general, and done.  And to explain to the kitchen what configuration to use is quite easy.  Before executing the kitchen command, you need to pass the environment variable KITCHEN_YAML = "our_configuration_name" to it. <br><br>  For example: <br><br><pre> <code class="bash hljs">KITCHEN_YAML=<span class="hljs-string"><span class="hljs-string">".kitchen_linux.yml"</span></span> kitchen create/converge/verify/destroy.</code> </pre><br>  Thank you for attention. </div><p>Source: <a href="https://habr.com/ru/post/316700/">https://habr.com/ru/post/316700/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../316686/index.html">Gitlab flow</a></li>
<li><a href="../316688/index.html">‚ÄúDemand for Visual Studio for Mac is big‚Äù - an interview with Alex Thissen</a></li>
<li><a href="../316690/index.html">How IT professionals work. Andrei Shorin, Deputy Director of Operations HeadHunter</a></li>
<li><a href="../316692/index.html">Monolithic Message-Oriented Application (MMOA)</a></li>
<li><a href="../316698/index.html">VKontakte will sell advertising under the new scheme and share revenue with community owners.</a></li>
<li><a href="../316702/index.html">Interesting IT-vacancies on My Circle for the week, November 7-13</a></li>
<li><a href="../316706/index.html">The implementation of multiplayer in the game. Comparison of Game Center, Steamworks and GameSparks features</a></li>
<li><a href="../316708/index.html">Function length</a></li>
<li><a href="../316714/index.html">Xamarin Modular Application</a></li>
<li><a href="../316716/index.html">New Year's Eve Prank Using SSH Tunnel</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>