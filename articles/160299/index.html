<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Himself cellular roaming. Creating a GSM gate on asterisk + dongle from a cellular operator</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="It happened that I go on business trips and vacations not so often to use some kind of international telephony or virtual provider, but not so rarely ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Himself cellular roaming. Creating a GSM gate on asterisk + dongle from a cellular operator</h1><div class="post__text post__text-html js-mediator-article">  It happened that I go on business trips and vacations not so often to use some kind of international telephony or virtual provider, but not so rarely that I don‚Äôt bother with it at all and use roaming without bothering about expenses. <br>  I go not to those countries and not so long to buy a SIM card from a local operator, but to those countries where Wi-Fi is almost everywhere. <br>  It just so happened that lately I had a close acquaintance with the asterisk software PBX and before the next trip I thought about how cool it would be to insert my SIM card as an incoming trunk in asterisk standing in the snowy Moscow that was left behind, and to cling to it sip client on the Internet.  I don‚Äôt want to call it myself, there would be internet, and take calls to your own number, which is important for those who have many contacts (you don‚Äôt inform everyone, and half will forget) - the cellular phone with a SIM card is actually at home region. <br><br>  How it is implemented - under the cut. <br><a name="habracut"></a><br><h4>  The first thing you need to do is: </h4><br><h5>  from intangible </h5><br>  - At least some basic knowledge of Linux.  yes, it is necessary to a little bit from sources. <br>  - Real ip address right on Linux, well, or port forwarding to it.  Still, to join from the Internet to an asterisk is necessary somewhere.  What, if you put it behind a home router, which itself stands behind the provider‚Äôs masquerade, or even more than one, will not work. <br>  Ports that uses an asterisk and which should be forwarded: udp 5000-31000.  Here is a whole pool. <br><br><h5>  from quite material </h5><br>  - Modem from cellular provider.  Almost all of them - huawey 3G E-series repainted in ‚Äúcorporate colors‚Äù.  Megaphone does not even hesitate to call them exactly in accordance with the encoding of the manufacturer.  I found myself like this: <a href="http://moscow.megafon.ru/devices/usbModem/e173/">moscow.megafon.ru/devices/usbModem/e173</a> .  This is a Huawey 3G E173. <br>  - Server on Linux 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h5>  necessary software: </h5><br>  - asterisk: <a href="http://www.asterisk.org/downloads">www.asterisk.org/downloads</a> <br>  I will tell about version 11 of the sources, if there is an asterisk package of any version in your distribution kit - put the package, there is not much difference. <br>  - usb-modeswitch: <a href="http://www.draisberghof.de/usb_modeswitch/">www.draisberghof.de/usb_modeswitch/#download</a> <br>  both archives <a href="">www.draisberghof.de/usb_modeswitch/usb-modeswitch-1.2.5.tar.bz2</a> and <a href="">www.draisberghof.de/usb_modeswitch/usb-modeswitch-data-20121109.tar.bz2</a> <br>  If there is such a package in your distribution kit - put the package <br>  - chan_dongle: <a href="">github.com/jstasiak/asterisk-chan-dongle/archive/asterisk11.zip</a> for the 11th asterisk in question, or <a href="http://code.google.com/p/asterisk-chan-dongle/downloads/list">code.google.com/p/asterisk-chan-dongle/downloads/list</a> if you put an asterisk from packages and you have an earlier version.  This is the same version of the driver, just into the one that is integrated for the 11th version of the patch that drives it under the 11th asterisk with its modified dependencies. <br><br><h4>  So. </h4><br>  You have Linux, you have a dongle. <br>  For those who have a self-assembly core - it needs an item <br><blockquote>  Device Drivers -&gt; USB Support -&gt; USB Serial Converter Support -&gt; USB Generic Serial Driver </blockquote><br><br>  Vtykate one to another, do lsusb. <br>  Find there a line similar to <br><blockquote>  Bus 001 Device 004: ID <b>12d1</b> : <b>1446</b> Huawei Technologies Co., Ltd. </blockquote><br>  12d1 is a vendor (huawey) <br>  1446 is a device (E173 in my case) <br>  But not everything is so simple. <br>  These extremely user-friendly modems are designed so that after you plug them into usb, this is a flash drive.  Which autorun installs drivers that, in turn, are either installed or skipped, if they already are, then switch the device to modem mode.  Very user friendly and user friendly.  Under Windows.  We have the same case and this device sticks out in flash drive mode.  With what usb_modeswitch will help us. <br>  Run (after the standard installation ./configure &amp;&amp; make &amp;&amp; make install if from sources) <br><blockquote>  usb_modeswitch -v 0x12d1 -p 0x1446 -H -s 5 -M5553424300000000000000000000110600000000000000000000000000 </blockquote><br>  don't forget to change 12d1 and 1446 to your lsusb numbers! <br>  Run lsusb again and you'll see about the same thing as before, but the second 4 digits of your dongle will be different. <br>  This means that everything went well and now your modem is a modem. <br>  This is where the USB Serial Driver for the kernel should work and several devices / dev / ttyUSB0 / dev / ttyUSB1, etc. should appear in / dev. <br>  These are interfaces to the modem, some sound, some controls, as far as I understood which one of them depends on the modem. <br><br><h4>  We have done a third of the case, we have a digital interface to the cellular network, we go to an asterisk. </h4><br>  I will not describe its installation, we will assume that it is installed (not configured, just installed).  If from the source, then good.  If the package is needed, you will also need -dev, because we will build a chan_ module for it. <br><br>  Namely that chan_dongle. <br>  Everything is standard, unpack, ./configure &amp;&amp; make &amp;&amp; make install <br>  Copy the file etc / dongle.conf to / etc / asterisk / <br><br>  Run asterisk directly without setting. <br>  Run asterisk -rv and get into the console. <br>  We write module load chan_dongle.so. <br>  The module will load and most likely start swearing about something. <br>  But when you run the dongle command, show devices will show something like <br><br><blockquote>  ID Group State RSSI Mode Submode Provider Name Model Firmware IMEI IMSI Number <br>  dc_4823_7851 0 Free 11 0 0 MegaFon RUS E173 11.126.15.00.209 xxxxxxxxxxxxxxxx xxxxxxxxxxxxxxx xxxxxxxxxxxxx <br></blockquote><br>  we leave <br><br>  We open for editing the file /etc/asterisk/dongle.conf and at the very bottom, where the device [dongle0] is described <br>  We comment on everything except the imei line, where we enter the imei of your modem from the line shown by dongle show devices <br>  and append <br><blockquote>  [dongle0] <br>  imei = xxxxxxxxxxxxxxxx <br>  context = dongle-incoming;  context <br>  group = 0 <br>  rxgain = 3;  volume up <br>  txgain = 3;  volume up <br>  resetdongle = yes;  reset card upon initialization <br>  u2diag = -1 <br>  usecallingpres = yes <br>  callingpres = allowed_passed_screen </blockquote><br>  Now the chan_dongle module can be entered into /etc/asterisk/modules.conf as a load =&gt; chan_dongle.so line. <br>  so that it loads itself when running asterisk. <br>  Restart asterisk. <br>  Now, with the correct imei, chan_dongle should correctly find everything itself - and which of the devices are command, and which audio, and so on. <br>  Run asterisk -rv, run the dongle show devices and see your modem.  Everything is good. <br><br><h4>  Now to set up an asterisk. </h4><br>  All we need is in the files sip.conf and extensions.conf <br>  Let's start with sip.conf <br>  Find the [general] section and add: <br><blockquote>  [general] <br>  externip = x.xxx;  an external IP address of an asterisk, no matter what it‚Äôs or the gate that passes ports to it, this is an external IP address whose address will contain packets going to the asterisk and it will consider them as its own <br>  externaddr = xhhh;  same <br>  localnet = 192.168.0.0 / 255.255.0.0;  a network that the asterisk will consider to be internal and not to arrange difficult dances with a masquerade for it <br>  nat = force_rport, comedia;  the necessary mode of operation if the asterisk is after nat and ports are prokibyvayutsya to it <br>  context = public;  The context in which calls arrive by default.  it is important that there was some context in which the plan of calls will be completely undefined, so that all calls by default will not get anywhere!  the internet is full of bots that scan day and night for badly tuned asterisks to call for free via them <br>  allowguest = no;  Do not take calls unknown from anyone. </blockquote><br>  With the default setting completed, now in the same file we describe one client (our softphone) <br><blockquote>  [me] <br>  type = friend <br>  host = dynamic <br>  secret = <b>password</b> <br>  context = default <br>  canreinvite = yes <br>  dtmfmode = rfc2833 <br>  permit = 0.0.0.0 / 0.0.0.0 <br>  qualify = yes </blockquote><br>  me - this will be the login, the password where to set is clear <br><br>  We write down sip.conf.  It's all here. <br><br>  Open extensions.conf - this is a plan of calls, a description of where and how calls are transmitted. <br><br>  What we need is to describe two contexts: [dongle-incoming] - what to do with calls coming to the modem and [default] - what to do with calls coming from the software.  phone. <br>  We start with a simple: <br><blockquote>  [default] <br>  exten =&gt; _7X., 1, Dial (Dongle / dongle0 / holdother: + $ {FILTER (0-9, $ {EXTEN})}) <br>  exten =&gt; _ + 7X., 1, Dial (Dongle / dongle0 / holdother: + $ {FILTER (0-9, $ {EXTEN})}) <br>  exten =&gt; _8X., 1, Dial (Dongle / dongle0 / holdother: + $ 7 {FILTER (0-9, $ {EXTEN: 1})}) <br>  exten =&gt; _007X., 1, Dial (Dongle / dongle0 / holdother: + $ 7 {FILTER (0-9, $ {EXTEN: 3})}) <br>  exten =&gt; h, 1, Hangup () </blockquote><br><br>  These are actually 4 lines that do the same thing, only the first one when the destination phone matches the 7 digit pattern, the second one when + 7 digits, third 8 digits and 4 th 007 digits (many soft phones have the option to send ‚Äú+‚Äù as ‚Äú00‚Äù ). <br>  And each line does the same thing - it transfers the call to the dongle0 channel (our modem) in the form of + 7 digits. <br>  Well, the last line will be called up at the ‚Äúhang up‚Äù event and simply hangs up.  But you can not even write it, this is a formality. <br><br>  So that it is understandable how it works - any incoming call from the phone registered on an asterisk under the me account will be processed in the context of [default], as specified in the context option for [me].  In the context of [default], the destination number will be matched with the template and, if it falls under one of the templates, the action ‚ÄúDial (Dongle ...)‚Äù will be executed.  By the way, if the destination number in the template does not fall, the call will be dropped as it is not known where it is directed, you can try to call somewhere like +4 ... if you are interested.  Also, there is no way to protect against telephone scams, though they will not call to Uganda if they somehow make it through. <br><br>  Now the context [dongle-incoming], for calls arriving at the cellular number: <br><blockquote> [dongle-incoming-sms] <br>  exten =&gt; sms, 1, Noop (Incoming SMS from $ {CALLERID (num)} $ {BASE64_DECODE ($ {SMS_BASE64})}) <br>  exten =&gt; sms, n, System (echo '$ {STRFTIME ($ {EPOCH} ,,% Y-% m-% d% H:% M:% S)} - $ {DONGLENAME} - $ {CALLERID (num )}: $ {BASE64_DECODE ($ {SMS_BASE64})} '&gt;&gt; /var/log/asterisk/sms.txt) <br>  exten =&gt; sms, n, hangup () <br><br>  [dongle-incoming-ussd] <br>  exten =&gt; ussd, 1, Noop (Incoming USSD: $ {BASE64_DECODE ($ {USSD_BASE64})}) <br>  exten =&gt; ussd, n, System (echo '$ {STRFTIME ($ {EPOCH} ,,% Y-% m-% d% H:% M:% S)} - $ {DONGLENAME}: $ {BASE64_DECODE ($ {USSD_BASE64})} '&gt;&gt; /var/log/asterisk/ussd.txt) <br>  exten =&gt; ussd, n, hangup () <br><br>  [dongle-incoming] <br>  include =&gt; dongle-incoming-sms <br>  include =&gt; dongle-incoming-ussd <br><br>  exten =&gt; _X., 1, Dial (SIP / me) <br>  exten =&gt; h, 1, Hangup () </blockquote><br><br>  It is still easier here - any incoming call is transmitted as a call for the client [me]. <br>  The top two sections included as include =&gt; dongle-incoming-sms accept sms and ussd respectively, and write them to plain text files /var/log/asterisk/sms.txt and /var/log/asterisk/ussd.txt where they can be then read (UTF-8 encoding). <br><br><h4>  Epilogue </h4><br>  Here is a brief and all.  But this is only the very basis, if someone really wonders how, or if it doesn‚Äôt work out for itself (after all, those who can repeat it all, I am 95% sure, they can do it all themselves, without instructions, and even add to everything not enough), I can continue to develop this topic - how to set up sms so that they are received and sent to the soft client as well as calls;  how to change dialplan so that the number was busy when the SIP client is not connected, or the caller got into Voicemail. <br><br>  Ps.  As a result of just one day of setting up, I received my own phone number abroad where I could not spend 200 rubles of money put before departure, although I used it constantly, and I called and received calls from my relatives.  Incomparable experience with roaming where money could be thrown into the locomotive's furnace. <br><br>  Pps.  WARNING, DISCLAIMER: Received information: <br>  ‚ÄúThe fact is that the use of any gateways is expressly prohibited by all mobile operators.  Here are the "Terms of MTS communication services": <br>  <a href="http://static.mts.ru/uploadmsk/contents/1656/uslovia_msk_06042012.pdf">static.mts.ru/uploadmsk/contents/1656/uslovia_msk_06042012.pdf</a> <br><br>  Clause 1.3 MTS communication services cannot be used by the Subscriber without additional written approval from the Operator for ... installation of gateways for network access <br>  telecommunications and Internet telephony ... <br><br>  The same points are in terms of other mobile operators, because the margin on roaming is going off scale, and operators will not refuse such a lot of money.  For the use of such a gateway can simply block the SIM card. " </div><p>Source: <a href="https://habr.com/ru/post/160299/">https://habr.com/ru/post/160299/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../160285/index.html">Hackberry Review - Miniand Single Board Computer</a></li>
<li><a href="../160287/index.html">Asus PadFone 2 video review</a></li>
<li><a href="../160289/index.html">Cyber ‚Äã‚ÄãMonday @ O'Reilly: 50% discount on all e-books and videos</a></li>
<li><a href="../160293/index.html">Java Native Interface. C ++. Linux. The first steps</a></li>
<li><a href="../160295/index.html">XenDesktop - everything is simple (part 1)</a></li>
<li><a href="../160301/index.html">Work with time in Google</a></li>
<li><a href="../160303/index.html">Life and death of information technology</a></li>
<li><a href="../160305/index.html">Who uses Node.js: Trello (Part 1)</a></li>
<li><a href="../160307/index.html">Increase the reliability of the data center! (photo from the thermal imager inside)</a></li>
<li><a href="../160309/index.html">What online dictionaries / translators do you use?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>