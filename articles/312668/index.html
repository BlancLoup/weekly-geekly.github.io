<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚ÄúHi, Siri. Turn on the heaters "- Integration of NooLite smart home with Apple HomeKit</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In my first article I described the background to the emergence of a remote heating control system in a country house through a Telegram bot, which my...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>‚ÄúHi, Siri. Turn on the heaters "- Integration of NooLite smart home with Apple HomeKit</h1><div class="post__text post__text-html js-mediator-article"><div style="text-align:center;"><img src="https://habrastorage.org/files/25c/3f6/591/25c3f659133d44728e54bf51a8a3e49c.png" alt="image"></div><br><p>  In my <a href="https://habrahabr.ru/post/312328/">first article</a> I described the background to the emergence of a remote heating control system in a country house through a Telegram bot, which my family and I have used for a long time. </p><br><p>  With the release of iOS 10, Apple introduced the <a href="http://www.apple.com/ru/ios/home/">Home</a> application to users - its implementation of the smart home control interface via <a href="https://developer.apple.com/homekit/">HomeKit</a> .  I was very interested in this topic and, having spent several evenings studying the available material, I decided to implement the integration of this product with my system.  In the article I will detail the process of its installation and configuration, as well as share the video with the results of what happened in the end. </p><a name="habracut"></a><br><h1>  Content </h1><br><ol><li>  <a href="https://habr.com/ru/post/312668/">Introduction</a> </li><li>  <a href="https://habr.com/ru/post/312668/">Installing and configuring OpenHab</a> </li><li>  <a href="https://habr.com/ru/post/312668/">Connecting NooLite to OpenHab</a> </li><li>  <a href="https://habr.com/ru/post/312668/">Install and configure HomeKit for OpenHab</a> </li><li>  <a href="https://habr.com/ru/post/312668/">Setting up the Home application</a> </li><li>  <a href="https://habr.com/ru/post/312668/">Result</a> </li><li>  <a href="https://habr.com/ru/post/312668/">Conclusion</a> </li></ol><br><a name="vvedenie"></a><br><h1>  Introduction </h1><br><blockquote>  <i>To understand the source data and the initial configuration of the smart home, I advise you to read the <a href="https://habrahabr.ru/post/312328/">first article</a> .</i> </blockquote><p>  The first task was the search for ready-made free solutions in home automation with the support of HomeKit.  Then I immediately remembered several articles on the open source product OpenHab.  After reading the documentation and a little googling, I really found an addon to support the HomeKit protocol.  At the moment, the second version of OpenHab is being prepared for release and active beta testing is underway.  The latest available version at that time was <a href="https://community.openhab.org/t/openhab-2-0-beta4-has-been-released/14110">beta4</a> , which I decided to use. </p><br><p>  The integration process can be divided into 4 stages: </p><br><ol><li>  Installing and configuring OpenHab </li><li>  Connecting NooLite to OpenHab </li><li>  Install and configure HomeKit for OpenHab </li><li>  Customize the Home app </li></ol><br><p>  The result would be the following scheme: <br> <a href=""><img src="https://habrastorage.org/files/e8d/e27/5ae/e8de275ae30a44bbb092f4c1389206db.png" alt="image"></a> </p><br><hr><br><a name="OpenHab_install"></a><br><h1>  Installing and configuring OpenHab </h1><br><p>  OpenHab 2 has quite detailed <a href="http://docs.openhab.org/index.html">documentation</a> , where in addition to the main platforms there is also a <a href="http://docs.openhab.org/installation/rasppi.html">tutorial</a> on installing on the Raspberry Pi.  I will not copy all the steps here, since there were no problems with the installation. </p><br><p>  After installation, the OpenHab web interface was available in the browser at the address: <em>http: // &lt;device_address_c_openhab&gt;: 8080</em> . </p><br><p> <a href=""><img src="https://habrastorage.org/files/35e/ed5/051/35eed5051764495da69060f46a63a8a6.png" alt="image"></a> </p><br><p>  Immediately available: </p><br><ol><li>  Basic UI, Classic UI - control panels for devices connected to OpenHab </li><li>  Rest API - rest API itself </li><li>  Paper UI - OpenHab admin interface, through which it can be configured </li></ol><br><p>  While the Basic UI was empty: </p><br><p> <a href=""><img src="https://habrastorage.org/files/01b/695/aab/01b695aab85b4a1baab0052a5ad391b6.png" alt="image"></a> </p><br><hr><br><a name="NooLite_OpenHab"></a><br><h1>  Connecting NooLite to OpenHab </h1><br><p>  Based on the documentation, to connect a new device to OpenHab, it was necessary: </p><br><ol><li>  Add it to <a href="https://github.com/openhab/openhab/wiki/Explanation-of-items">items</a> </li><li>  Add to <a href="https://github.com/openhab/openhab/wiki/Explanation-of-Sitemaps">sitemap</a> so that it is displayed in the OpenHab smart home control panel (Basic UI, Classic UI).  <em>You can skip this step, it does not apply to working with HomeKit, but with its help you can check that OpenHab sees NooLite and works with it correctly.</em> </li><li>  Add rules to <a href="https://github.com/openhab/openhab/wiki/Rules">rules</a> if you need automation or additional event processing logic </li></ol><br><h4>  Items </h4><br><p>  In items, we describe the final managed devices, for example, the NooLite power unit and "teach" OpenHab to work with it: </p><br><pre><code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">itemtype</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">itemname</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">["labeltext"]</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[&lt;iconname&gt;]</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[(group1, group2, ...)]</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[{bindingconfig}]</span></span></code> </pre> <br><p>  Where: </p><br><ul><li>  itemtype - device type (Switch, Dimmer, etc.) </li><li>  itemname - device name </li><li>  labeltext - text display.  For example, for the sensor: "Temperature [% .1f ¬∞ C]", for the unit simply "Heaters" </li><li>  iconname - the displayed icon </li><li>  group1 - groups </li><li>  bindingconfig - how to manage this device </li></ul><br><p>  The most interesting thing here is binding.  How the interaction with the managed device will be performed.  After a bit of searching for information on how OpenHab works with NooLite, I found a ready <a href="https://github.com/Pshatsillo/OpenHABNoolite">-</a> made <a href="https://github.com/Pshatsillo/OpenHABNoolite">version</a> .  But it was written to work with the <a href="http://www.noo.com.by/adapter-noolite-pc.html">NooLite USB adapters of the</a> PC and RX series.  In my own system, the management of the power units worked through the PR1132 ethernet gateway, so it was necessary to look for other options for work. </p><br><p>  Looking at the available binders, I found universal <a href="https://github.com/openhab/openhab/wiki/Http-Binding">Http binding</a> and <a href="https://github.com/openhab/openhab/wiki/Exec-Binding">Exec binding</a> , with the help of which it was possible to realize communication with NooLite: </p><br><ol><li>  Http binding allows you to perform a network request when an event occurs (on / off, receiving information from the sensor).  Using the <a href="http://www.noo.com.by/assets/files/PDF/PR1132.pdf">API in PR1132</a> , you could implement OpenHab direct communication with NooLite. </li><li>  Exec binding - any command is executed for the event. </li></ol><br><p>  At that time, I thought that additional pre / post processing logic for requests to NooLite would be needed, so I chose the second option. </p><br><h4>  NooLite CLI </h4><br><p>  When developing a Telegram bot, a previous implementation of the interface for communicating with a smart home, I already wrote a simple wrapper class above the API calls to NooLite: </p><br><div class="spoiler">  <b class="spoiler_title">noolite_api.py</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-string"><span class="hljs-string">""" NooLite API wrapper """</span></span> <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> requests <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> requests.auth <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> HTTPBasicAuth <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> requests.exceptions <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ConnectTimeout, ConnectionError <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> xml.etree.ElementTree <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ET <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NooLiteSens</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-string"><span class="hljs-string">"""    ,         """</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, temperature, humidity, state)</span></span></span><span class="hljs-function">:</span></span> self.temperature = float(temperature.replace(<span class="hljs-string"><span class="hljs-string">','</span></span>, <span class="hljs-string"><span class="hljs-string">'.'</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> temperature != <span class="hljs-string"><span class="hljs-string">'-'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">None</span></span> self.humidity = int(humidity) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> humidity != <span class="hljs-string"><span class="hljs-string">'-'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">None</span></span> self.state = state <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NooLiteApi</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-string"><span class="hljs-string">"""     NooLite"""</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, login, password, base_api_url, request_timeout=</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">10</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">:</span></span> self.login = login self.password = password self.base_api_url = base_api_url self.request_timeout = request_timeout <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_sens_data</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">"""   xml    :return:  NooLiteSens     :rtype: list """</span></span> response = self._send_request(<span class="hljs-string"><span class="hljs-string">'{}/sens.xml'</span></span>.format(self.base_api_url)) sens_states = { <span class="hljs-number"><span class="hljs-number">0</span></span>: <span class="hljs-string"><span class="hljs-string">' ,   '</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>: <span class="hljs-string"><span class="hljs-string">'  '</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>: <span class="hljs-string"><span class="hljs-string">'   '</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>: <span class="hljs-string"><span class="hljs-string">'     '</span></span> } response_xml_root = ET.fromstring(response.text) sens_list = [] <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> sens_number <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(<span class="hljs-number"><span class="hljs-number">4</span></span>): sens_list.append(NooLiteSens( response_xml_root.find(<span class="hljs-string"><span class="hljs-string">'snst{}'</span></span>.format(sens_number)).text, response_xml_root.find(<span class="hljs-string"><span class="hljs-string">'snsh{}'</span></span>.format(sens_number)).text, sens_states.get(int(response_xml_root.find(<span class="hljs-string"><span class="hljs-string">'snt{}'</span></span>.format(sens_number)).text)) )) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> sens_list <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">send_command_to_channel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, data)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">"""   NooLite    NooLite  url   data :param data: url  :type data: dict :return: response """</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> self._send_request(<span class="hljs-string"><span class="hljs-string">'{}/api.htm'</span></span>.format(self.base_api_url), params=data) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_send_request</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, url, **kwargs)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">"""   NooLite        url    kwargs :param url: url   :type url: str :return: response  NooLite   """</span></span> <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: response = requests.get(url, auth=HTTPBasicAuth(self.login, self.password), timeout=self.request_timeout, **kwargs) <span class="hljs-keyword"><span class="hljs-keyword">except</span></span> ConnectTimeout <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> e: print(e) <span class="hljs-keyword"><span class="hljs-keyword">raise</span></span> NooLiteConnectionTimeout(<span class="hljs-string"><span class="hljs-string">'Connection timeout: {}'</span></span>.format(self.request_timeout)) <span class="hljs-keyword"><span class="hljs-keyword">except</span></span> ConnectionError <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> e: print(e) <span class="hljs-keyword"><span class="hljs-keyword">raise</span></span> NooLiteConnectionError(<span class="hljs-string"><span class="hljs-string">'Connection timeout: {}'</span></span>.format(self.request_timeout)) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> response.status_code != <span class="hljs-number"><span class="hljs-number">200</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">raise</span></span> NooLiteBadResponse(<span class="hljs-string"><span class="hljs-string">'Bad response: {}'</span></span>.format(response)) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> response <span class="hljs-comment"><span class="hljs-comment">#   NooLiteConnectionTimeout = type('NooLiteConnectionTimeout', (Exception,), {}) NooLiteConnectionError = type('NooLiteConnectionError', (Exception,), {}) NooLiteBadResponse = type('NooLiteBadResponse', (Exception,), {}) NooLiteBadRequestMethod = type('NooLiteBadRequestMethod', (Exception,), {})</span></span></code> </pre></div></div><br><p>  Using it, in a few lines of python code, I sketched the <a href="https://github.com/AlekseevAV/NooLite-PR1132-CLI">NooLite CLI</a> , with the help of which the opportunity to manage NooLite from the command line appeared: </p><br><div class="spoiler">  <b class="spoiler_title">noolite_cli.py</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-string"><span class="hljs-string">""" NooLite PR1132 command line interface """</span></span> <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> os <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> json <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> logging <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> argparse <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> yaml <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> noolite_api <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> NooLiteApi SCRIPT_PATH = os.path.dirname(os.path.realpath(__file__)) <span class="hljs-comment"><span class="hljs-comment"># Logging config logger = logging.getLogger() formatter = logging.Formatter( '%(asctime)s - %(filename)s:%(lineno)s - %(levelname)s - %(message)s' ) stream_handler = logging.StreamHandler() stream_handler.setFormatter(formatter) logger.addHandler(stream_handler) def get_args(): """   :return:   {: }   . :rtype: dict """ parser = argparse.ArgumentParser() parser.add_argument('-sns', type=int, help='    ') parser.add_argument('-ch', type=int, help=' ') parser.add_argument('-cmd', type=int, help='') parser.add_argument('-br', type=int, help=' ') parser.add_argument('-fmt', type=int, help='') parser.add_argument('-d0', type=int, help='  0') parser.add_argument('-d1', type=int, help='  1') parser.add_argument('-d2', type=int, help='  2') parser.add_argument('-d3', type=int, help='  3') return {key: value for key, value in vars(parser.parse_args()).items() if value is not None} if __name__ == '__main__': #     config = yaml.load(open(os.path.join(SCRIPT_PATH, 'conf_cli.yaml'))) #      NooLite noolite_api = NooLiteApi( config['noolite']['login'], config['noolite']['password'], config['noolite']['api_url'] ) #    args = get_args() logger.debug('Args: {}'.format(args)) #    sns,      if 'sns' in args: sens_list = noolite_api.get_sens_data() send_data = sens_list[args['sns']] print(json.dumps({ 'temperature': send_data.temperature, 'humidity': send_data.humidity, 'state': send_data.state, })) else: logger.info('Send command to noolite: {}'.format(args)) print(noolite_api.send_command_to_channel(args))</span></span></code> </pre></div></div><br><p>  The arguments have the same names as in the <a href="http://www.noo.com.by/assets/files/PDF/PR1132.pdf">API of the PR1132 ethernet gateway</a> , the only thing added is the <code>sns</code> argument for receiving information from the sensors. </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#  $ python noolite_cli.py -h usage: noolite_cli.py [-h] [-sns SNS] [-ch CH] [-cmd CMD] [-br BR] [-fmt FMT] [-d0 D0] [-d1 D1] [-d2 D2] [-d3 D3] optional arguments: -h, --help show this help message and exit -sns SNS      -ch CH   -cmd CMD  -br BR   -fmt FMT  -d0 D0   0 -d1 D1   1 -d2 D2   2 -d3 D3   3 #   ,   0  $ python noolite_cli.py -ch 0 -cmd 2 OK #   ,   0  $ python noolite_cli.py -ch 0 -cmd 0 OK #    ,   0  $ python noolite_cli.py -sns 0 {"state": " ,   ", "temperature": 21.1, "humidity": 56} #  -  RGB- SD111-180 (3 )   #     : d0 - , d1 - , d2 -  $ python noolite_cli.py -ch 3 -cmd 6 -fmt 3 -d0 247 -d1 255 -d2 247</span></span></code> </pre> <br><p>  Now I could describe all the NooLite power units in items: </p><br><pre> <code class="hljs objectivec"><span class="hljs-meta"><span class="hljs-meta"># /etc/openhab2/items/noolite.items Number FFTemperature </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">" [%.1f ¬∞C]"</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;temperature&gt;</span></span></span><span class="hljs-meta"> {exec=</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"&lt;[python noolite_cli.py -sns 0:5000:JSONPATH($.temperature)]"</span></span></span><span class="hljs-meta">} Number FFHumidity </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">" [%d %%]"</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;temperature&gt;</span></span></span><span class="hljs-meta"> {exec=</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"&lt;[python noolite_cli.py -sns 0:5000:JSONPATH($.humidity)]"</span></span></span><span class="hljs-meta">} Switch Heaters1 </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">""</span></span></span><span class="hljs-meta"> { exec=</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"&gt;[OFF:python noolite_cli.py -ch 0 -cmd 0] &gt;[ON:python noolite_cli.py -ch 0 -cmd 2]"</span></span></span><span class="hljs-meta">} Switch Light1 </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">""</span></span></span><span class="hljs-meta"> { exec=</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"&gt;[OFF:python noolite_cli.py -ch 2 -cmd 0] &gt;[ON:python noolite_cli.py -ch 2 -cmd 2]"</span></span></span><span class="hljs-meta">} Color RGBLight </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">" "</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;slider&gt;</span></span></span></span></code> </pre> <br><p>  Where: </p><br><ul><li>  FFTemperature, FFHumidity - temperature and humidity of the sensor of the first floor.  OpenHab performs <code>python noolite_cli.py</code> every 5 seconds with the -sns 0 parameter and extracts temperature values ‚Äã‚Äãfrom the json response.  Similarly for moisture </li><li>  Heaters1 is a ground floor heater line.  To enable (the "ON" command) OpenHab should execute <code>python noolite_cli.py -ch 0 -cmd 2</code> , to disable (the "OFF" command) <code>python noolite_cli.py -ch 0 -cmd 0</code> . </li><li>  Light1 - outdoor searchlight, commands similar to heaters, only on the second channel-ch 2 </li><li>  RGBLight - LED strip. </li></ul><br><h4>  Rules </h4><br><p>  The LED strip control no longer fit into one command, as additional logic was needed to obtain the brightness values ‚Äã‚Äãof each of the RGB channels.  Therefore, I described the handling of state changes in rules: </p><br><pre> <code class="hljs kotlin"># /etc/openhab2/rules/noolite.rules <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.openhab.core.library.types.* <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> HSBType hsbValue <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> String redValue <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> String greenValue <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> String blueValue rule <span class="hljs-string"><span class="hljs-string">"Set RGB value"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> Item RGBLight changed then <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> hsbValue = RGBLight.state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> HSBType <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> brightness = hsbValue.brightness.intValue <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> redValue = ((((hsbValue.red.intValue * <span class="hljs-number"><span class="hljs-number">255</span></span>) / <span class="hljs-number"><span class="hljs-number">100</span></span>) * brightness) / <span class="hljs-number"><span class="hljs-number">100</span></span>).toString <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> greenValue = ((((hsbValue.green.intValue * <span class="hljs-number"><span class="hljs-number">255</span></span>) / <span class="hljs-number"><span class="hljs-number">100</span></span>) * brightness) / <span class="hljs-number"><span class="hljs-number">100</span></span>).toString <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> blueValue = ((((hsbValue.blue.intValue *<span class="hljs-number"><span class="hljs-number">255</span></span>) / <span class="hljs-number"><span class="hljs-number">100</span></span>) * brightness) / <span class="hljs-number"><span class="hljs-number">100</span></span>).toString <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> String cmd = <span class="hljs-string"><span class="hljs-string">"python noolite_cli.py -ch 3 -cmd 6 -fmt 3 -d0 "</span></span> + redValue + <span class="hljs-string"><span class="hljs-string">" -d1 "</span></span> + greenValue + <span class="hljs-string"><span class="hljs-string">" -d2 "</span></span> + blueValue executeCommandLine(cmd) end</code> </pre> <br><p>  I described one rule that worked when the state of RGBLight changed, where I got the values ‚Äã‚Äãof each channel (0-255), formed the string <code>python noolite_cli.py -ch 3 -cmd 6 -fmt 3 -d0 redValue -d1 greenValue -d2 blueValue</code> and executed it . </p><br><h4>  Sitemap </h4><br><p>  Now, when OpenHab "saw" all my power units and knew how to control them, it remained to describe how to display them in the OpenHab control panel (Basic UI, Classic UI).  This is done in the sitemap: </p><br><pre> <code class="hljs pgsql"># /etc/openhab2/sitemap/noolite.sitemap sitemap noolite label="" { Frame label=" " { <span class="hljs-type"><span class="hljs-type">Text</span></span> item=FFTemperature <span class="hljs-type"><span class="hljs-type">Text</span></span> item=FFHumidity Switch item=Heaters1 Switch item=Light1 } Frame label=" " { Colorpicker item=RGBLight icon="colorwheel" label=" " } }</code> </pre> <br><p>  After saving this file, all devices appeared in the Basic UI: </p><br><p> <a href=""><img src="https://habrastorage.org/files/a5f/3b9/d38/a5f3b9d38e4545fdaf5335251adc4eef.png" alt="image"></a> <br><br></p><br><p>  I also tested working with a smart home through the OpenHab application for iOS devices, where everything also worked fine: </p><br><p> <a href=""><img src="https://habrastorage.org/files/d19/8a9/4c4/d198a94c458e4e6688236cb1804566a3.PNG" alt="image"></a> <a href=""><img src="https://habrastorage.org/files/b5c/047/209/b5c04720978246eaac40c543c64c66ef.PNG" alt="image"></a> </p><br><hr><br><a name="HomeKit_OpenHab"></a><br><h1>  Install and configure HomeKit for OpenHab </h1><br><p>  I installed the <a href="http://docs.openhab.org/addons/io/homekit/readme.html">HomeKit add-on</a> for OpenHab in a couple of clicks through the Paper UI (administration interface): </p><br><p> <a href=""><img src="https://habrastorage.org/files/4fb/8ce/d47/4fb8ced4735d4f2a895013623b2aff60.png" alt="image"></a> <br><br></p><br><p>  For its correct operation, following the documentation, for each element of the items I registered the type (Lighting, Switchable, CurrentTemperature, CurrentHumidity, Thermostat).  After that, the noolite.items file had the following form: </p><br><pre> <code class="hljs perl">Number FFTemperature <span class="hljs-string"><span class="hljs-string">" [%.1f ¬∞C]"</span></span> &lt;temperature&gt; [ <span class="hljs-string"><span class="hljs-string">"CurrentTemperature"</span></span> ] {<span class="hljs-keyword"><span class="hljs-keyword">exec</span></span>=<span class="hljs-string"><span class="hljs-string">"&lt;[python noolite_cli.py -sns 0:5000:JSONPATH($.temperature)]"</span></span>} Number FFHumidity <span class="hljs-string"><span class="hljs-string">" [%d %%]"</span></span> &lt;temperature&gt; [ <span class="hljs-string"><span class="hljs-string">"CurrentHumidity"</span></span> ] {<span class="hljs-keyword"><span class="hljs-keyword">exec</span></span>=<span class="hljs-string"><span class="hljs-string">"&lt;[python noolite_cli.py -sns 0:5000:JSONPATH($.humidity)]"</span></span>} Switch Heaters1 <span class="hljs-string"><span class="hljs-string">""</span></span> [ <span class="hljs-string"><span class="hljs-string">"Switchable"</span></span> ] { <span class="hljs-keyword"><span class="hljs-keyword">exec</span></span>=<span class="hljs-string"><span class="hljs-string">"&gt;[OFF:python noolite_cli.py -ch 0 -cmd 0] &gt;[ON:python noolite_cli.py -ch 0 -cmd 2]"</span></span>} Switch Light1 <span class="hljs-string"><span class="hljs-string">""</span></span> [ <span class="hljs-string"><span class="hljs-string">"Switchable"</span></span> ] { <span class="hljs-keyword"><span class="hljs-keyword">exec</span></span>=<span class="hljs-string"><span class="hljs-string">"&gt;[OFF:python noolite_cli.py -ch 2 -cmd 0] &gt;[ON:python noolite_cli.py -ch 2 -cmd 2]"</span></span>} Color RGBLight <span class="hljs-string"><span class="hljs-string">" "</span></span> &lt;slider&gt; [ <span class="hljs-string"><span class="hljs-string">"Lighting"</span></span> ]</code> </pre> <br><p>  Then, in the add-on settings, I registered the local address of the device with OpenHab (in my case, Raspberry Pi) and looked at the pairing pin-code: </p><br><p> <a href=""><img src="https://habrastorage.org/files/b13/a21/6e7/b13a216e7ce54268b5c1cf1f2f69317a.png" alt="image"></a> </p>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p> <a href=""><img src="https://habrastorage.org/files/76e/f92/2d3/76ef922d3c924a8c9c299391c7576b47.png" alt="image"></a> <br><br>  After that, the OpenHab settings were completed, and I proceeded to configure the smart home on the iphone in the application "Home". </p><br><hr><br><a name="apple_Home_app"></a><br><h1>  Setting up the Home application </h1><br><p> <a href=""><img src="https://habrastorage.org/files/d8d/e9f/f74/d8de9ff741fc4884914e8e8d6c54fecb.PNG" alt="image"></a> <br>  <em>The first launch of the application "Home"</em> </p><br><p> <a href=""><img src="https://habrastorage.org/files/cbc/fc6/db6/cbcfc6db6b2a4a43bc74502340b5f7ee.PNG" alt="image"></a> <br>  <em>Clicked "Add Accessory"</em> </p><br><p> <a href=""><img src="https://habrastorage.org/files/d97/3ab/751/d973ab751c2347fd862f7bec0f81d88a.PNG" alt="image"></a> <br>  <em>iPhone saw a device on the local network with HomeKit support</em> </p><br><p> <a href=""><img src="https://habrastorage.org/files/7c1/d7e/9c1/7c1d7e9c19a54d21b3fc31ec977a4d48.PNG" alt="image"></a> <br>  <em>Enter code manually</em> </p><br><p> <a href=""><img src="https://habrastorage.org/files/d8e/b9d/272/d8eb9d2720bc445f970ffae9be29ce60.PNG" alt="image"></a> <br>  <em>When adding the specified pin code from the settings of HomeKit addon</em> </p><br><p> <a href=""><img src="https://habrastorage.org/files/3e5/802/4c5/3e58024c5f90449db228f9cac36976ef.PNG" alt="image"></a> <br>  <em>All devices</em> </p><br><p>  The iPhone saw all of my devices described in items.  Next, I renamed some devices, created "rooms" (first floor, second floor, street) and scattered all the devices on them. </p><br><p>  Here I want to clarify one point.  In the screenshot above, you can see the element "Outdoor temperature" (the first element with a 2 degrees index), located in the "Street" room.  This element is implemented using the YahooWeather Binding Binding - essentially just a yahoo weather forecast for a specific location. </p><br><p> <a href=""><img src="https://habrastorage.org/files/902/7b8/a6d/9027b8a6d0674effaebbac16d2970e46.png" alt="image"></a> <br><br></p><br><p>  It does not belong to NooLite, so I did not mention the details of its installation and configuration.  This can be done again through Paper UI, all described in detail in the <a href="http://docs.openhab.org/addons/bindings/yahooweather/readme.html">documentation</a> . </p><br><h4>  Remote access and automation </h4><br><p>  In my local network was Apple TV, which, without additional settings, was itself defined as the "Home Center".  As I later found out, the home center is needed for remote access to the smart home and automation settings (scheduled actions, actions based on your geo-location, etc.).  Apple TV of the 3rd or 4th generation can act as a home center (in the 3rd generation only remote access works, 4th generation is necessary for automation) or an iPad with iOS 10. This device must be constantly turned on and located in the local network of the smart home. <br>  It was pleasantly pleased that I did not make any additional settings with Apple TV.  All you need is to log in to iCloud with your account. </p><br><hr><br><a name="results"></a><br><h1>  Result </h1><br><p>  Most clearly the work process can be shown using video.  Below are some examples of the work of the application "Home" and voice control via Siri: </p><br><iframe width="560" height="315" src="https://www.youtube.com/embed/fFwPJIowzIY" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><iframe width="560" height="315" src="https://www.youtube.com/embed/czJIEu3BpIE" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><iframe width="560" height="315" src="https://www.youtube.com/embed/gQjiUQXqO3w" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><p>  In the dashboard 2 extreme right places are hired contactors, controlled by power units NooLite series SL.  Through them are connected lines of heaters on the first and second floor of the house.  On the video you can hear them click on / off.  Unfortunately, there is no more visual indication of their work. </p><br><p>  At the beginning of the next video, I disconnect from the dacha Wi-Fi network and all further work with the smart home takes place via 3G mobile Internet. </p><br><iframe width="560" height="315" src="https://www.youtube.com/embed/ZAXCyw5s8iQ" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><iframe width="560" height="315" src="https://www.youtube.com/embed/J2vucKcEVhU" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><iframe width="560" height="315" src="https://www.youtube.com/embed/KILJt_xBqpo" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><hr><br><a name="zakluchenie"></a><br><h1>  Conclusion </h1><br><p>  Integration with HomeKit allowed us to add to the smart home a convenient management interface with iOS devices through the Home application, and also expanded its functionality: </p><br><ul><li>  full remote control of all devices at home, instead of Telegram-bot </li><li>  voice control </li><li>  automation based on: time of day, geolocation, sensor readings (for example, motion detection) </li><li>  Convenient addition of users to smart home management via invitations (you need an iOS device and an Apple account) with differentiated access rights </li></ul><br><p>  A detailed overview of the Home application itself and its applications for home automation is already beyond the scope of this topic and I think it deserves a separate article.  But for me the most interesting is geolocation, on the basis of which you can implement interesting automation scenarios.  For example, when all users at home leave it, you can turn off the light everywhere.  If users have retired even further (left for the city), then turn off some consumers, for example, sockets and electricity in the basement (I have a pump station there). </p><br><p>  The work on this article allowed to look at the country house management system from the side and note the places that will be refined in the near future: </p><br><ul><li>  To simplify the system, instead of using the PR1132 ethernet gateway and managing NooLite blocks via the HTTP API, you can use RX and PC series USB adapters and issue commands directly </li><li>  as far as I know, in the near future NooLite plans to release a new USB receiving-transmitting adapter and power blocks with feedback.  It will be very interesting to try them in action. </li></ul><br><p>  References: </p><br><ul><li>  <a href="https://github.com/AlekseevAV/NooLite-PR1132-CLI">NooLite CLI GitHub</a> </li><li>  <a href="http://www.noo.com.by/sistema-noolite.html">NooLite system</a> </li><li>  <a href="http://docs.openhab.org/">OpenHab 2 documentation</a> </li><li>  <a href="http://www.apple.com/ru/ios/home/">Promo page</a> home application </li></ul></div><p>Source: <a href="https://habr.com/ru/post/312668/">https://habr.com/ru/post/312668/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../312658/index.html">Why is it important to check the values ‚Äã‚Äãreturned by the function?</a></li>
<li><a href="../312660/index.html">Free seminar "Operation of the data center: what you need to do yourself", October 27, Moscow</a></li>
<li><a href="../312662/index.html">PHP multithreaded server implementation</a></li>
<li><a href="../312664/index.html">Moscow part of the hackathon TADHack: tomorrow</a></li>
<li><a href="../312666/index.html">5 reasons why employers do not like remote workers (and 4 ways to get a job anyway)</a></li>
<li><a href="../312670/index.html">Promises 101</a></li>
<li><a href="../312672/index.html">As an Android developer, time management got carried away, and what came of it</a></li>
<li><a href="../312674/index.html">Python-crib. Part 1 - Language and Object Types</a></li>
<li><a href="../312676/index.html">1990 Great Hacker War</a></li>
<li><a href="../312680/index.html">Scrum from a military pilot: The art of doing twice the work twice as fast</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>