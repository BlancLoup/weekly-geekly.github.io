<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Linux containers at home: why and how</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Reasoning 
 At the mention of the phrase "container virtualization", many immediately come to mind Virtuozzo and OpenVZ , as well as Docker . All this...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Linux containers at home: why and how</h1><div class="post__text post__text-html js-mediator-article"><br><img src="https://habrastorage.org/getpro/habr/post_images/53a/6a2/273/53a6a22737462ac8612a9e0f3e1e7ef7.jpg"><br><br><h2>  Reasoning </h2><br>  At the mention of the phrase "container virtualization", many immediately come to mind <a href="http://www.odin.com/products/virtuozzo">Virtuozzo</a> and <a href="https://openvz.org/">OpenVZ</a> , as well as <a href="https://www.docker.com/">Docker</a> .  All this is associated, first of all, with hosting, VPS and other similar things. <br><br>  At home, on personal computers, many use virtual machines: basically, perhaps, Virtualbox.  As a rule, in order to work under Linux, have Windows on hand or vice versa.  However, with a lot of related Linux operating systems, I began to notice that using virtual machines is, to put it mildly, irrational. <br><a name="habracut"></a><br>  First of all, disk space is consumed very quickly.  Each virtual machine needs a place, even if several of them differ only in configs.  This is especially critical on the small size of the SSD laptop.  In principle, Virtualbox is able to work with raw-devices and, in theory, machines can be assigned rw LVM snapshots, but here again there are issues with changing the size of the file system in the future, automating cloning, moving, deleting, and the like. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In the second - this is a greater consumption of RAM.  The third is not the most convenient interaction tools ... <br><br>  Therefore, there was an idea to test container virtualization at home.  OpenVZ dismissed immediately, because of the need to mess with the custom kernel.  The choice fell on <a href="https://linuxcontainers.org/">LXC</a> , supplied in the stable Debian repository. <br><br>  What are containers and how does this all differ from virtualization?  In the case of containers, a virtual hardware environment is not created, but an isolated process space and network stack are used.  Let's just say, it turns out chroot with advanced features. <br><br>  Why do you need it: <br><br>  - To build software with the reluctance to clutter up the main working system with unsuited * -dev packages. <br>  - The need for another distribution to run any specific programs and, again, build. <br>  - Isolation of potentially unsafe software, like the same Skype, <a href="http://www.linux.org.ru/news/security/2106643/page1">performs various incomprehensible actions in the user's home directory</a> and all sorts of dubious web technologies: <a href="http://habrahabr.ru/company/eset/blog/262319/">vulnerability in a flash</a> , in <a href="http://habrahabr.ru/company/eset/blog/262511/">java</a> , <a href="https://www.opennet.ru/openforum/vsluhforumID3/104076.html">in a pdf handler</a> is just what floats on the surface. <br>  - Anonymity.  The commercial can simply be logged in to his favorite social network, forget to clean up the cookie or be unfamiliar with another new web technology like this <a href="https://diafygi.github.io/webrtc-ips/">webrtc</a> .  You can, of course, keep several browser profiles, but this will not protect against the holes and technologies listed above. <br><br>  So, consider the pros and cons of the LXC: <br><br>  + Powered by vanilla core <br>  + Easy forwarding of devices and host directories, since it works all through cgroups <br>  + Very undemanding to resources, unlike virtual machines like Virtualbox or qemu <br><br>  ‚ÄúThe containers will work on the same core as the host, although this is rather a feature of container virtualization as a whole. <br>  - Some unfinished utility bundles. <br><br><h2>  Deploy and configure the container </h2><br><br>  First of all, we install the lxc package and all the necessary utilities: <br><pre><code class="hljs swift">sudo apt-<span class="hljs-keyword"><span class="hljs-keyword">get</span></span> install lxc bridge-utils</code> </pre> <br><br>  We look at the available LVM volume groups: <br><pre> <code class="bash hljs"><span class="hljs-variable"><span class="hljs-variable">$sudo</span></span> vgs VG <span class="hljs-comment"><span class="hljs-comment">#PV #LV #SN Attr VSize VFree nethack-vg 1 6 0 wz--n- 119,00g 7,36g</span></span></code> </pre><br><br><pre> <code class="hljs pgsql">sudo lxc-<span class="hljs-keyword"><span class="hljs-keyword">create</span></span> -t debian -B lvm <span class="hljs-comment"><span class="hljs-comment">--vgname nethack-vg --fssize 2G -n deb_test</span></span></code> </pre> <br><br><br><br>  Specify using LVM as the storage system, Volume Group (in my case, nethack-vg) and a size of 2 gigabytes, otherwise a single-gig volume will be created by default.  Although, if suddenly it became cramped, you can make lvresize. <br><br>  We look: <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/651/070/73a/65107073a7215506fd8af4f3e0e1b9a2.png"></a> <br><br><pre> <code class="bash hljs"><span class="hljs-variable"><span class="hljs-variable">$sudo</span></span> lvs LV VG Attr LSize Pool Origin Data% Meta% Move Log Cpy%Sync Convert deb_test nethack-vg -wi-ao---- 2,00g home nethack-vg -wi-ao---- 93,09g root nethack-vg -wi-ao---- 8,38g tmp nethack-vg -wi-ao---- 380,00m var nethack-vg -wi-ao---- 2,79g vm nethack-vg -wi-ao---- 5,00g</code> </pre><br><br>  We see that we have a deb_test volume. <br><br>  Typical configuration created by the script: <br><div class="spoiler">  <b class="spoiler_title">/ var / lib / lxc / deb_test / config</b> <div class="spoiler_text"><br><pre> <code class="hljs pgsql"># <span class="hljs-keyword"><span class="hljs-keyword">Template</span></span> used <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> this container: /usr/<span class="hljs-keyword"><span class="hljs-keyword">share</span></span>/lxc/templates/lxc-debian # Parameters passed <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> the <span class="hljs-keyword"><span class="hljs-keyword">template</span></span>: # <span class="hljs-keyword"><span class="hljs-keyword">For</span></span> additional config <span class="hljs-keyword"><span class="hljs-keyword">options</span></span>, please look at lxc.container.conf(<span class="hljs-number"><span class="hljs-number">5</span></span>) lxc.rootfs = /dev/nethack-vg/deb_test # Common <span class="hljs-keyword"><span class="hljs-keyword">configuration</span></span> lxc.<span class="hljs-keyword"><span class="hljs-keyword">include</span></span> = /usr/<span class="hljs-keyword"><span class="hljs-keyword">share</span></span>/lxc/config/debian.common.conf # Container specific <span class="hljs-keyword"><span class="hljs-keyword">configuration</span></span> lxc.mount = /var/lib/lxc/deb_test/fstab lxc.utsname = deb_test lxc.arch = amd64 lxc.autodev = <span class="hljs-number"><span class="hljs-number">1</span></span> lxc.kmsg = <span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre><br><br></div></div><br><br>  We start: <br><pre> <code class="hljs pgsql">sudo lxc-<span class="hljs-keyword"><span class="hljs-keyword">start</span></span> -n deb_test</code> </pre> <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/863/6ff/17e/8636ff17e2e01003971b9d6f8ec6bcaa.png"></a> <br>  Log in with the specified password.  To run in headless mode, the -d switch is used, and the root console can be obtained using the command <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">sudo</span></span> lxc-attach -n deb_test</code> </pre> <br><br>  So far we have neither the network nor the programs necessary for the work.  To do this, we raise a bridge on the host, set the IP, wrap the traffic from the virtual subnet, and if we turn off the interface, we destroy the bridge. <br><br>  On the host, write in / etc / network / interfaces <br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">auto</span></span> lo br0 iface br0 inet static address <span class="hljs-number"><span class="hljs-number">172.20.0.1</span></span> netmask <span class="hljs-number"><span class="hljs-number">255.255.255.0</span></span> pre-up /sbin/brctl addbr br0 post-up /sbin/brctl setfd br0 <span class="hljs-number"><span class="hljs-number">0</span></span> post-up iptables -t nat -A POSTROUTING -s <span class="hljs-number"><span class="hljs-number">172.20.0.0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> -j MASQUERADE post-up echo <span class="hljs-number"><span class="hljs-number">1</span></span> &gt; /proc/sys/net/ipv4/ip_forward pre-down /sbin/brctl delbr br0</code> </pre><br><br>  In the configuration of the container we add: <br><pre> <code class="hljs haskell"><span class="hljs-title"><span class="hljs-title">lxc</span></span>.network.<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> = veth lxc.network.flags = up lxc.network.link = br0 lxc.network.hwaddr = 00:01:02:03:04:05</span></span></code> </pre><br><br>  It is clear that the mac-address is arbitrary, for every taste. <br>  To immediately get a working network and the ability to install packages apt'om, we add <br><pre> <code class="hljs">lxc.network.ipv4 = 172.20.0.3 lxc.network.ipv4.gateway = 172.20.0.1</code> </pre><br>  And execute <pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">echo</span></span> <span class="hljs-string"><span class="hljs-string">"nameserver 192.168.18.1"</span></span>&gt;/etc/resolv.conf</code> </pre> <br><br>  It is clear that 192.168.18.1 is the IP of my DNS. <br><br>  Install the necessary packages: <br><pre> <code class="hljs vala"><span class="hljs-meta"><span class="hljs-meta">#apt-get install vim openvpn zsh iftop</span></span></code> </pre> <br><br>  Further, either on the host or on another working virtual, you can get a list of installed packages and install them all in our new container: <br><pre> <code class="hljs ruby">scp user@172.<span class="hljs-number"><span class="hljs-number">20.0</span></span>.<span class="hljs-number"><span class="hljs-number">2</span></span><span class="hljs-symbol"><span class="hljs-symbol">:/etc/apt/sources</span></span>.list /etc/apt/ scp -r user@172.<span class="hljs-number"><span class="hljs-number">20.0</span></span>.<span class="hljs-number"><span class="hljs-number">2</span></span><span class="hljs-symbol"><span class="hljs-symbol">:/etc/apt/sources</span></span>.list.d /etc/apt/ apt-get update ssh user@172.<span class="hljs-number"><span class="hljs-number">20.0</span></span>.<span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-string"><span class="hljs-string">'dpkg --get-selections|grep -v deinstall'</span></span><span class="hljs-params"><span class="hljs-params">|dpkg --set-selections apt-get dselect-upgrade</span></span></code> </pre><br><br>  Now you can customize the network interface in the container using your favorite text editor: <br><br>  / etc / network / interfaces: <br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">auto</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">lo</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">eth0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">iface</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">lo</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">inet</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">loopback</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">iface</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">eth0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">inet</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">static</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">address</span></span> 172<span class="hljs-selector-class"><span class="hljs-selector-class">.20</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.3</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">netmask</span></span> 255<span class="hljs-selector-class"><span class="hljs-selector-class">.255</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.255</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">gateway</span></span> 172<span class="hljs-selector-class"><span class="hljs-selector-class">.20</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.1</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dns-nameservers</span></span> 192<span class="hljs-selector-class"><span class="hljs-selector-class">.168</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.18</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.1</span></span></code> </pre><br><br>  However, this could be done from the host system, for example, by mounting a logical volume.  There are many ways. <br><br>  In principle, as a DNS, you can specify any public, if you do not fear for their privacy.  For example, Google 8.8.8.8 and 8.8.4.4. <br><br>  As regards access to the devices of the host system, I adhere to the policy ‚Äúeverything that is not allowed is prohibited‚Äù.  Add the following line to the config for this: <br><pre> <code class="hljs">lxc.cgroup.devices.deny = a</code> </pre><br><br>  Delete <pre> <code class="hljs ruby">lxc.<span class="hljs-keyword"><span class="hljs-keyword">include</span></span> = <span class="hljs-regexp"><span class="hljs-regexp">/usr/share</span></span><span class="hljs-regexp"><span class="hljs-regexp">/lxc/config</span></span><span class="hljs-regexp"><span class="hljs-regexp">/debian.common.conf</span></span></code> </pre> <br><br>  Let's try to connect via OpenVPN.  Immediately we get the error: <br><pre> <code class="hljs vbscript">Thu <span class="hljs-built_in"><span class="hljs-built_in">Oct</span></span> <span class="hljs-number"><span class="hljs-number">15</span></span> <span class="hljs-number"><span class="hljs-number">16</span></span>:<span class="hljs-number"><span class="hljs-number">39</span></span>:<span class="hljs-number"><span class="hljs-number">33</span></span> <span class="hljs-number"><span class="hljs-number">2015</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ERROR</span></span>: Cannot open TUN/TAP dev /dev/net/tun: No such file <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> directory (errno=<span class="hljs-number"><span class="hljs-number">2</span></span>) Thu <span class="hljs-built_in"><span class="hljs-built_in">Oct</span></span> <span class="hljs-number"><span class="hljs-number">15</span></span> <span class="hljs-number"><span class="hljs-number">16</span></span>:<span class="hljs-number"><span class="hljs-number">39</span></span>:<span class="hljs-number"><span class="hljs-number">33</span></span> <span class="hljs-number"><span class="hljs-number">2015</span></span> Exiting due <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> fatal <span class="hljs-keyword"><span class="hljs-keyword">error</span></span></code> </pre><br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/d8c/3c1/3de/d8c3c13de22474b7fa96e7b684a1d796.png"></a> <br><br>  The system writes that the TUN / TAP interfaces are not available due to their absence.  Obviously, you need to allow the guest system to use host devices.  Open the container configuration file, / var / lib / lxc / deb_test / config and add the line there: <br><pre> <code class="hljs swift">lxc.cgroup.devices.allow = <span class="hljs-built_in"><span class="hljs-built_in">c</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span>:<span class="hljs-number"><span class="hljs-number">200</span></span> rwm</code> </pre><br><br>  In the container we execute: <br><pre> <code class="hljs ruby">root@deb_test<span class="hljs-symbol"><span class="hljs-symbol">:/</span></span><span class="hljs-comment"><span class="hljs-comment"># mkdir /dev/net; mknod /dev/net/tun c 10 200</span></span></code> </pre><br><br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/549/08f/7e2/54908f7e23550a2a55be51559564c318.png"></a> <br><br>  Pay attention to 10: 200 - this is the device type identifier.  If we execute on the host: <br><pre> <code class="hljs dos">$ls -l /dev/<span class="hljs-built_in"><span class="hljs-built_in">net</span></span>/tun crw-rw-rw- <span class="hljs-number"><span class="hljs-number">1</span></span> root root <span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-number"><span class="hljs-number">200</span></span>  <span class="hljs-number"><span class="hljs-number">13</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span>:<span class="hljs-number"><span class="hljs-number">30</span></span> /dev/<span class="hljs-built_in"><span class="hljs-built_in">net</span></span>/tun</code> </pre><br><br>  Then we will see identifiers 10, 200. We will be guided by them, allowing access to the device, for example, camera - video0. <br><br><pre> <code class="hljs swift">lxc.cgroup.devices.allow = <span class="hljs-built_in"><span class="hljs-built_in">c</span></span> <span class="hljs-number"><span class="hljs-number">81</span></span>:* rwm</code> </pre><br><br>  In the same way we add other necessary devices: <br><br><pre> <code class="hljs swift"># /dev/null and zero lxc.cgroup.devices.allow = <span class="hljs-built_in"><span class="hljs-built_in">c</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>:<span class="hljs-number"><span class="hljs-number">3</span></span> rwm lxc.cgroup.devices.allow = <span class="hljs-built_in"><span class="hljs-built_in">c</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>:<span class="hljs-number"><span class="hljs-number">5</span></span> rwm # consoles lxc.cgroup.devices.allow = <span class="hljs-built_in"><span class="hljs-built_in">c</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span> rwm lxc.cgroup.devices.allow = <span class="hljs-built_in"><span class="hljs-built_in">c</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span> rwm lxc.cgroup.devices.allow = <span class="hljs-built_in"><span class="hljs-built_in">c</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span> rwm lxc.cgroup.devices.allow = <span class="hljs-built_in"><span class="hljs-built_in">c</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span> rwm # /dev/{,u}random lxc.cgroup.devices.allow = <span class="hljs-built_in"><span class="hljs-built_in">c</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>:<span class="hljs-number"><span class="hljs-number">9</span></span> rwm lxc.cgroup.devices.allow = <span class="hljs-built_in"><span class="hljs-built_in">c</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>:<span class="hljs-number"><span class="hljs-number">8</span></span> rwm lxc.cgroup.devices.allow = <span class="hljs-built_in"><span class="hljs-built_in">c</span></span> <span class="hljs-number"><span class="hljs-number">136</span></span>:* rwm lxc.cgroup.devices.allow = <span class="hljs-built_in"><span class="hljs-built_in">c</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span>:<span class="hljs-number"><span class="hljs-number">2</span></span> rwm # rtc lxc.cgroup.devices.allow = <span class="hljs-built_in"><span class="hljs-built_in">c</span></span> <span class="hljs-number"><span class="hljs-number">254</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span> rm #usb passthrough lxc.cgroup.devices.allow = <span class="hljs-built_in"><span class="hljs-built_in">c</span></span> <span class="hljs-number"><span class="hljs-number">189</span></span>:* rwm #video lxc.cgroup.devices.allow = <span class="hljs-built_in"><span class="hljs-built_in">c</span></span> <span class="hljs-number"><span class="hljs-number">81</span></span>:* rwm #sound lxc.cgroup.devices.allow = <span class="hljs-built_in"><span class="hljs-built_in">c</span></span> <span class="hljs-number"><span class="hljs-number">116</span></span>:* rwm lxc.cgroup.devices.allow = <span class="hljs-built_in"><span class="hljs-built_in">c</span></span> <span class="hljs-number"><span class="hljs-number">14</span></span>:* rwm</code> </pre><br><br>  In order for X to function and allow them to pass through ssh, you must add a mount point: <br><pre> <code class="hljs swift">lxc.mount.entry = /tmp/.<span class="hljs-type"><span class="hljs-type">X11</span></span>-unix/<span class="hljs-type"><span class="hljs-type">X0</span></span> tmp/.<span class="hljs-type"><span class="hljs-type">X11</span></span>-unix/<span class="hljs-type"><span class="hljs-type">X0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">none</span></span> bind,<span class="hljs-keyword"><span class="hljs-keyword">optional</span></span>,create=file</code> </pre><br><br>  By analogy, you can mount other, necessary directories and files: <br><pre> <code class="hljs pgsql">lxc.mount.entry = /home/<span class="hljs-keyword"><span class="hljs-keyword">user</span></span>/.vim home/<span class="hljs-keyword"><span class="hljs-keyword">user</span></span>/.vim <span class="hljs-keyword"><span class="hljs-keyword">none</span></span> bind,optional,<span class="hljs-keyword"><span class="hljs-keyword">create</span></span>=dir <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> lxc.mount.entry = /home/<span class="hljs-keyword"><span class="hljs-keyword">user</span></span>/.vimrc home/<span class="hljs-keyword"><span class="hljs-keyword">user</span></span>/.vimrc <span class="hljs-keyword"><span class="hljs-keyword">none</span></span> bind,optional,<span class="hljs-keyword"><span class="hljs-keyword">create</span></span>=file <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre><br><br>  To play the sound, you can allow access to the sound device if the card is multi-threaded (with single-line dmix problems with blocking occur): <br><pre> <code class="hljs swift">lxc.cgroup.devices.allow = <span class="hljs-built_in"><span class="hljs-built_in">c</span></span> <span class="hljs-number"><span class="hljs-number">116</span></span>:* rwm lxc.cgroup.devices.allow = <span class="hljs-built_in"><span class="hljs-built_in">c</span></span> <span class="hljs-number"><span class="hljs-number">14</span></span>:* rwm lxc.mount.entry = /dev/snd dev/snd <span class="hljs-keyword"><span class="hljs-keyword">none</span></span> bind,<span class="hljs-keyword"><span class="hljs-keyword">optional</span></span>,create=dir <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre><br><br>  And you can set up pulseaudio to play audio over the network, as described <a href="https://wiki.archlinux.org/index.php/PulseAudio/Examples">here</a> .  Briefly: <br><br>  Edit /etc/pulse/default.pa on the host by adding there: <br><pre> <code class="hljs sql"><span class="hljs-keyword"><span class="hljs-keyword">load</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">module</span></span> <span class="hljs-keyword"><span class="hljs-keyword">module</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">native</span></span>-protocol-tcp auth-ip-acl=<span class="hljs-number"><span class="hljs-number">127.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>;172.20.0.3 auth-anonymous=1</code> </pre><br><br>  As a result, we get this config: <br><div class="spoiler">  <b class="spoiler_title">/ var / lib / lxc / deb_test / config</b> <div class="spoiler_text"><br><pre> <code class="hljs swift">lxc.rootfs = /dev/nethack-vg/deb_test lxc.mount = /<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>/lib/lxc/deb_test/fstab lxc.utsname = deb_test lxc.arch = amd64 lxc.autodev = <span class="hljs-number"><span class="hljs-number">1</span></span> lxc.kmsg = <span class="hljs-number"><span class="hljs-number">0</span></span> lxc.network.type = veth lxc.network.flags = up lxc.network.link = br0 lxc.network.hwaddr = <span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">01</span></span>:<span class="hljs-number"><span class="hljs-number">02</span></span>:<span class="hljs-number"><span class="hljs-number">03</span></span>:<span class="hljs-number"><span class="hljs-number">04</span></span>:<span class="hljs-number"><span class="hljs-number">05</span></span> lxc.network.ipv4 = <span class="hljs-number"><span class="hljs-number">172.20</span></span>.<span class="hljs-number"><span class="hljs-number">0.3</span></span> lxc.network.ipv4.gateway = <span class="hljs-number"><span class="hljs-number">172.20</span></span>.<span class="hljs-number"><span class="hljs-number">0.1</span></span> #deny acces <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> all devices lxc.cgroup.devices.deny = a # /dev/null and zero lxc.cgroup.devices.allow = <span class="hljs-built_in"><span class="hljs-built_in">c</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>:<span class="hljs-number"><span class="hljs-number">3</span></span> rwm lxc.cgroup.devices.allow = <span class="hljs-built_in"><span class="hljs-built_in">c</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>:<span class="hljs-number"><span class="hljs-number">5</span></span> rwm # consoles lxc.cgroup.devices.allow = <span class="hljs-built_in"><span class="hljs-built_in">c</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span> rwm lxc.cgroup.devices.allow = <span class="hljs-built_in"><span class="hljs-built_in">c</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span> rwm lxc.cgroup.devices.allow = <span class="hljs-built_in"><span class="hljs-built_in">c</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span> rwm lxc.cgroup.devices.allow = <span class="hljs-built_in"><span class="hljs-built_in">c</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span> rwm # /dev/{,u}random lxc.cgroup.devices.allow = <span class="hljs-built_in"><span class="hljs-built_in">c</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>:<span class="hljs-number"><span class="hljs-number">9</span></span> rwm lxc.cgroup.devices.allow = <span class="hljs-built_in"><span class="hljs-built_in">c</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>:<span class="hljs-number"><span class="hljs-number">8</span></span> rwm lxc.cgroup.devices.allow = <span class="hljs-built_in"><span class="hljs-built_in">c</span></span> <span class="hljs-number"><span class="hljs-number">136</span></span>:* rwm lxc.cgroup.devices.allow = <span class="hljs-built_in"><span class="hljs-built_in">c</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span>:<span class="hljs-number"><span class="hljs-number">2</span></span> rwm # rtc lxc.cgroup.devices.allow = <span class="hljs-built_in"><span class="hljs-built_in">c</span></span> <span class="hljs-number"><span class="hljs-number">254</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span> rm #sound lxc.cgroup.devices.allow = <span class="hljs-built_in"><span class="hljs-built_in">c</span></span> <span class="hljs-number"><span class="hljs-number">116</span></span>:* rwm lxc.mount.entry = /dev/snd dev/snd <span class="hljs-keyword"><span class="hljs-keyword">none</span></span> bind,<span class="hljs-keyword"><span class="hljs-keyword">optional</span></span>,create=dir <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> #tun/tap adapters lxc.cgroup.devices.allow = <span class="hljs-built_in"><span class="hljs-built_in">c</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span>:<span class="hljs-number"><span class="hljs-number">200</span></span> rwm #video0 lxc.cgroup.devices.allow = <span class="hljs-built_in"><span class="hljs-built_in">c</span></span> <span class="hljs-number"><span class="hljs-number">81</span></span>:* rwm lxc.mount.entry = /dev/video0 dev/video0 <span class="hljs-keyword"><span class="hljs-keyword">none</span></span> bind,<span class="hljs-keyword"><span class="hljs-keyword">optional</span></span>,create=file lxc.mount.entry = /dev/dri dev/dri <span class="hljs-keyword"><span class="hljs-keyword">none</span></span> bind,<span class="hljs-keyword"><span class="hljs-keyword">optional</span></span>,create=dir lxc.mount.entry = /tmp/.<span class="hljs-type"><span class="hljs-type">X11</span></span>-unix/<span class="hljs-type"><span class="hljs-type">X0</span></span> tmp/.<span class="hljs-type"><span class="hljs-type">X11</span></span>-unix/<span class="hljs-type"><span class="hljs-type">X0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">none</span></span> bind,<span class="hljs-keyword"><span class="hljs-keyword">optional</span></span>,create=file</code> </pre><br><br></div></div><br><br>  The container is ready to use. <br><br><h2>  Using </h2><br><br>  Install, for example, i2p with Tor, if you have not done this before, and immediately configure privoxy: <br><pre> <code class="hljs pgsql">wget -q https://geti2p.net/_static/i2p-debian-repo.key.<span class="hljs-keyword"><span class="hljs-keyword">asc</span></span> -O- | sudo apt-key <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> - echo "deb http://deb.i2p2.no/ jessie main" &gt;/etc/apt/sources.list.d/i2p.list echo "deb-src http://deb.i2p2.no/ jessie main" &gt;&gt;/etc/apt/sources.list.d/i2p.list apt-<span class="hljs-keyword"><span class="hljs-keyword">get</span></span> <span class="hljs-keyword"><span class="hljs-keyword">update</span></span> apt-<span class="hljs-keyword"><span class="hljs-keyword">get</span></span> install privoxy i2p tor</code> </pre><br><div class="spoiler">  <b class="spoiler_title">/ etc / privoxy / config</b> <div class="spoiler_text"><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">user</span></span>-manual /usr/<span class="hljs-keyword"><span class="hljs-keyword">share</span></span>/doc/privoxy/<span class="hljs-keyword"><span class="hljs-keyword">user</span></span>-manual confdir /etc/privoxy logdir /var/<span class="hljs-keyword"><span class="hljs-keyword">log</span></span>/privoxy actionsfile <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>.action # <span class="hljs-keyword"><span class="hljs-keyword">User</span></span> customizations filterfile <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">filter</span></span> filterfile <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">filter</span></span> # <span class="hljs-keyword"><span class="hljs-keyword">User</span></span> customizations logfile logfile <span class="hljs-keyword"><span class="hljs-keyword">listen</span></span>-address localhost:<span class="hljs-number"><span class="hljs-number">8118</span></span> toggle <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enable</span></span>-remote-toggle <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enable</span></span>-remote-http-toggle <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enable</span></span>-edit-actions <span class="hljs-number"><span class="hljs-number">1</span></span> enforce-blocks <span class="hljs-number"><span class="hljs-number">0</span></span> buffer-<span class="hljs-keyword"><span class="hljs-keyword">limit</span></span> <span class="hljs-number"><span class="hljs-number">4096</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enable</span></span>-proxy-authentication-forwarding <span class="hljs-number"><span class="hljs-number">0</span></span> forwarded-<span class="hljs-keyword"><span class="hljs-keyword">connect</span></span>-retries <span class="hljs-number"><span class="hljs-number">0</span></span> accept-intercepted-requests <span class="hljs-number"><span class="hljs-number">0</span></span> allow-cgi-request-crunching <span class="hljs-number"><span class="hljs-number">0</span></span> split-<span class="hljs-keyword"><span class="hljs-keyword">large</span></span>-forms <span class="hljs-number"><span class="hljs-number">0</span></span> keep-alive-timeout <span class="hljs-number"><span class="hljs-number">5</span></span> tolerate-pipelining <span class="hljs-number"><span class="hljs-number">1</span></span> socket-timeout <span class="hljs-number"><span class="hljs-number">300</span></span> forward .i2p localhost:<span class="hljs-number"><span class="hljs-number">4444</span></span> forward-socks5 .onion localhost:<span class="hljs-number"><span class="hljs-number">9050</span></span> .</code> </pre><br><br></div></div><br><br>  It is most convenient to launch graphical applications like a browser via ssh: <br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">ssh</span></span> -Y <span class="hljs-number"><span class="hljs-number">172.20.0.2</span></span> <span class="hljs-string"><span class="hljs-string">"PULSE_SERVER=172.20.0.1 http_proxy=127.0.0.1:8118 chromium"</span></span></code> </pre><br><br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/59a/eb5/818/59aeb58186a769847929e54881c8fb4b.png"></a> <br><br>  Also, of course, LXC provides tools for cloning containers and removing snapshots. <br><br>  So, for example, you can clone a container whose file system will be LVM snapshot with the command: <br><pre> <code class="hljs php">sudo lxc-<span class="hljs-keyword"><span class="hljs-keyword">clone</span></span> -s -H -o deb_test -L <span class="hljs-number"><span class="hljs-number">200</span></span>M --<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> deb_test2</code> </pre><br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/98a/4df/ed3/98a4dfed316b9ef6a16e303420622797.png"></a> <br><br>  A deb_test2 container will be created with a file system hosted on a 200MB LVM snapshot (for storage of diffs).  This will be an exact copy of deb_test, on which you can conduct a couple of experiments and, for example, painlessly remove. <br><br>  But lxc-snapshot with LVM as storage, for some reason does not work on the lxc-1.0.6 version: <br><pre> <code class="hljs rust">-&gt;sudo lxc-snapshot -n deb_test lxc_container: deb_test<span class="hljs-symbol"><span class="hljs-symbol">'s</span></span> backing store cannot <span class="hljs-keyword"><span class="hljs-keyword">be</span></span> backed up. lxc_container: Your container must <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> another backing store <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class">. </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">lxc_container</span></span></span></span>: Error creating a snapshot</code> </pre><br><br>  The problem is described and discussed <a href="https://lists.linuxcontainers.org/pipermail/lxc-users/2015-February/008513.html">here</a> .  Therefore, it is necessary to do pictures in the old manner: <br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">sudo</span></span> lvcreate -L100M -s -n deb_test_before_rm_rf -pr /dev/nethack-vg/deb_test</code> </pre><br><br>  In this case, we created a read-only snapshot with the name deb_test_before_rm_rf with a size of 100MB.  What to do with it next?  For example, you can dump it using dd, transfer it to another machine together with the container configs, create a volume of the required size there and shed the same dd (cp, cat, etc.) - a kind of ‚Äúlive migration‚Äù. <br><br>  As stated above, the areas of use for containers can be found mass.  But the main, at home use, in my opinion, is the isolation of applications. <br><br>  That's all for now. </div><p>Source: <a href="https://habr.com/ru/post/269423/">https://habr.com/ru/post/269423/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../269407/index.html">This is not paranoia: sources of threats in the GSM system and protection from them.</a></li>
<li><a href="../269411/index.html">10 apps to learn Python on Android devices</a></li>
<li><a href="../269415/index.html">Unreal vs. Unity: what is the best way to develop mobile games?</a></li>
<li><a href="../269417/index.html">Introduction to RxJava: Why Rx?</a></li>
<li><a href="../269419/index.html">Why Mobile First?</a></li>
<li><a href="../269425/index.html">Code hiding and refactoring areas</a></li>
<li><a href="../269427/index.html">Introduction to RapidMiner</a></li>
<li><a href="../269429/index.html">Conveyor production of Android applications</a></li>
<li><a href="../269431/index.html">Pivoting Everywhere - Local Area Network Techniques</a></li>
<li><a href="../269435/index.html">Hot on the heels of DroidCon Moscow 2015</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>