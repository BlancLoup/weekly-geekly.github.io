<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>"Calls" in the Odnoklassniki iPhone application</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="On Friday, we launched a new version of our iPhone application . In this post, we would like to share with you the experience of developing such servi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>"Calls" in the Odnoklassniki iPhone application</h1><div class="post__text post__text-html js-mediator-article">  On Friday, we launched a new version of <a href="http://itunes.apple.com/ru/app/odnoklassniki/id398465290">our <nobr>iPhone application</nobr></a> .  In this post, we would like to share with you the experience of developing such services. <br><br>  Service "Calls" - video chat on the site Odnoklassniki implemented by means of Flash.  But not all of our users come to Odnoklassniki from a computer / laptop.  To expand the video chat audience, we decided to support it also in smartphones. <br><br>  This article will discuss the experience of implementing video calls in an iOS application. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Scheme of the application: <br><a name="habracut"></a><br><img src="https://habrastorage.org/storage1/f3358e9c/74e21cb9/21bf3ddc/3d735fa8.jpg"><br><br><h1>  Audio / video encoders and decoders </h1><br>  Since it is possible to compile <nobr>C / C ++</nobr> code <nobr>for</nobr> iPhone, there were no problems with the choice of codecs - you can take any open <nobr>source codec</nobr> , provided that the license allows use in commercial applications.  For the sound, they took Speex, and for H.263 video, from the Android OS code (I had to modify it a bit to be compatible with the flash). <br><br><h1>  Video capture module </h1><br>  Starting with version 4.0, iOS has an API for capturing raw video (AVCaptureSession).  But this API has its limitations - in particular, no arbitrary resolution can be set (several fixed presets are supported).  It is also impossible to change the orientation of the video when turning the device.  In order to circumvent these restrictions, we capture video frames larger than we need, and then we cut and rotate the video in accordance with the orientation of the device.  This takes quite a lot of processor resources and has an undesirable effect of approximation (‚Äúzoom‚Äù), but all that remains is to say thanks to Apple for such an implementation of the API. <br><br>  The video is captured in the native YUV codec format.  In this regard, there is the problem of "drawing" frames to display "their" pictures on the screen.  We also solved it, but more on that later, in the section ‚ÄúVideo output to the screen‚Äù. <br><br>  Another worth mentioning is the camera selection algorithm: if the device has a front camera, the application selects it.  If there is no front camera, the video is captured from the camera on the back cover.  If there is no camera at all (for example, iPad), the ‚ÄúEnable video‚Äù button is not displayed. <br><br><h1>  Video output </h1><br>  The video decoder, as well as the video capture module from the camera, output frames in the YUV format.  In order to display the frame on the device screen, you need to convert it to RGB format and bring it to the desired size.  Since the main processor is busy at this time with other tasks, we transferred these operations to a graphics processor using OpenGL ES 2.0.  A frame in YUV format is loaded into the OpenGL texture, after which the fragment shader recalculates the color components for each point.  To support older devices that do not support OpenGL ES 2.0 (younger than 3GS), the application has a code branch that performs all calculations without using shaders.  On such devices, it is necessary to compensate for the lack of computing power by lowering the video frame rate. <br><br><h1>  Capture and play sound </h1><br>  The AudioSession API is used to capture sound from a microphone and play through the speaker. This is the lowest-level API that can be accessed from an iOS application.  The sound that comes from the server is decoded and goes into a buffer that smoothes the network jitter.  The depth of the buffer varies depending on the quality of the connection - the worse the network, the deeper the buffer.  For the user, this is manifested by the fact that the sound delay increases on a bad network. <br><br>  There are several ways to play sound on the iPhone - it can be played through the phone speaker, through the speakerphone (the speaker on the bottom of the device) or through a connected headset.  If a headset is not connected, the speakerphone route is selected by default.  The phone speaker is connected when a distance sensor is triggered (proximity sensor). <br><br><h1>  Multitasking </h1><br>  Starting with version <nobr>4</nobr> in iOS, multitasking support has been added.  The video chat call can be continued even when our application is running in the background.  In order to maximally free up resources when switching to the background mode, the application stops receiving and sending video, and also does not update the graphical interface until the application becomes active again.  At the same time, the capture and playback of the sound continues, and a red ‚Äúband‚Äù with the inscription ‚Äúodnoklassniki‚Äù is displayed on the screen - an indication that the application is ‚Äúlistening‚Äù to the microphone.  When you click on this panel, the application returns to the active state. <br><br><h1>  Using the proximity sensor </h1><br>  The proximity sensor is a sensor mounted on the top of the front of the phone that detects the proximity of <nobr>an</nobr> object to the device.  The idea is to determine when the user brings the phone to his ear.  During a video call, the application monitors the status of this sensor.  In the case of sensor triggering, the application suppresses the screen, turns off the reception and sending of video, and switches the sound to the telephone speaker.  This is convenient for those users who just want to ‚Äúfollow the old fashioned way‚Äù by phone. <br><br>  Adaptation to the quality of the connection <br><br>  Video calls in the application can be used on both WIFI and 3G / EDGE networks.  During a call, the state of the network connection is constantly monitored and in case of a deterioration in the quality of communication, the frame rate and video quality are reduced. <br><br><h1>  What I would like to improve </h1><ul><li>  Make it possible to use the other functions of the classmates application during a conversation </li><li>  Automatic reconnection in case of a break (for example, when switching between <nobr>Wi-Fi / 3G</nobr> networks) </li><li>  More widely use code optimization for an ARM processor to reduce processor utilization and battery drain during a call. </li></ul><br><br>  We will be glad to hear your comments and recommendations for improving the service. <br>  Development team of the service "Calls". </div><p>Source: <a href="https://habr.com/ru/post/128328/">https://habr.com/ru/post/128328/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../128322/index.html">Steam in rubles</a></li>
<li><a href="../128323/index.html">Yandex begins to struggle with re-optimized texts</a></li>
<li><a href="../128324/index.html">The path of the freelancer. The road to success or gaining customer confidence</a></li>
<li><a href="../128325/index.html">Congratulations on the holiday programmer and programmer!</a></li>
<li><a href="../128327/index.html">GIF Steganography</a></li>
<li><a href="../128329/index.html">How can I learn more, or why I will participate in the school CSEDays</a></li>
<li><a href="../128330/index.html">Creating a server infrastructure in a small business in a modest budget</a></li>
<li><a href="../128331/index.html">A pack of hungry wolves</a></li>
<li><a href="../128332/index.html">EU Neighbors Three Years Later</a></li>
<li><a href="../128333/index.html">Anti-prize Runet 2 and ¬Ω: Do you have a good attendance? Be our info sponsor!</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>