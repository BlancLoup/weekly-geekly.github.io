<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Announced hardware support for transactional memory in Haswell</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Haswell will be a very innovative tock . Last year, a description of new operations with integers in AVX became available. And this week another exten...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Announced hardware support for transactional memory in Haswell</h1><div class="post__text post__text-html js-mediator-article">  Haswell will be a very innovative <a href="http://en.wikipedia.org/wiki/Intel_Tick-Tock">tock</a> .  Last year, a description of new operations with integers in AVX became available.  And this week another extension of the X86 architecture was <a href="http://software.intel.com/file/41417">published</a> .  Haswell will have hardware support for transactional memory!  On the English-language sites discussion boils.  <a href="http://software.intel.com/en-us/blogs/2012/02/07/transactional-synchronization-in-haswell/">ISN</a> <a href="">Arstechnica</a> <a href="https://lwn.net/Articles/480018/">LWN</a> <a href="http://www.engadget.com/2012/02/09/intel-teaches-haswell-the-core-value-of-teamwork/">Engadget</a> <br><br>  I think this is the most non-trivial extension of the X86 architecture in many, many years.  The feature is called Transactional Synchronization Extensions (hereinafter TSX), and consists of two parts - Hardware Lock Elision (HLE) and Restricted Transactional Memory (RTM).  Pay attention to the word "Restricted".  That's right, there are some limitations on the volume, granularity and level of transaction nesting. <br><br>  About these restrictions and how it all will work in more detail under a cat.  (No pictures, boring technical text) <br><a name="habracut"></a><br>  <a href="http://ru.wikipedia.org/wiki/%25D0%259F%25D1%2580%25D0%25BE%25D0%25B3%25D1%2580%25D0%25B0%25D0%25BC%25D0%25BC%25D0%25BD%25D0%25B0%25D1%258F_%25D1%2582%25D1%2580%25D0%25B0%25D0%25BD%25D0%25B7%25D0%25B0%25D0%25BA%25D1%2586%25D0%25B8%25D0%25BE%25D0%25BD%25D0%25BD%25D0%25B0%25D1%258F_%25D0%25BF%25D0%25B0%25D0%25BC%25D1%258F%25D1%2582%25D1%258C">Software Transactional Memory</a> (STM) is a fairly well-known concept.  In a nutshell, its essence is that transactions are defined, within which all changes to any parts of memory are atomically committed if there are no conflicts with other threads, or are completely canceled in the event of a conflict.  STM has two key advantages over concurrency with locks ‚Äî the potentially better scalability and programming convenience (using transactions is much simpler than locks, and, unlike locks, transactions can easily be composite). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      There are a lot of software implementations, for example, <a href="http://software.intel.com/en-us/articles/intel-c-stm-compiler-prototype-edition/">Intel STM compiler</a> or TBoost.STM.  There is a <a href="https://sites.google.com/site/tmforcplusplus/C%252B%252BTransactionalConstructs-1.1.pdf%3Fattredirects%3D0">proposal</a> to add support for transactional memory in C ++.  My favorite Clojure STM is generally the only idiomatic multi-threaded shared memory mechanism. <br><br>  Unfortunately, mainly due to performance issues, STM for imperative languages ‚Äã‚Äãhas not gained much popularity. <br><br>  Processor manufacturers have long licked at the support of Transactional Memory in the gland.  This would potentially solve performance problems.  For example, there was such an UltraSPARC Rock processor with hardware support for transactional memory, but, unfortunately, it did not take off.  Azul and IBM also have working hardware that supports transactional memory. <br><br>  How is everything in Haswell?  Usually they begin to explain with HLE, then RTM goes, and then how it is arranged inside.  I'll start with the insides, then go to RTM, and leave HLE for the last, so it will be more interesting. <br><br>  In the implementation of the cache in Haswell, some magic will appear, which for each cache line will determine its membership in the read-set and write-set active transactions.  Also, there are several new u-ops needed to start and complete a transaction, find out the reason for the rollback and to diagnose. <br><br>  RTM is simply the use of these new instructions by the programmer.  The XBEGIN instruction starts a transaction and sets a handler for the interrupted transaction, XEND terminates, and XABORT terminates.  Naturally, if a program with RTM runs on an X86 processor that does not support TSX, #UD will occur. <br><br>  HLE is much trickier inside, but just for the programmer.  Imagine that there is such a TZ: using the implementation of the above-described primitives, to achieve an improvement in the performance of the already written multithreaded software with locks (you can recompile, you can not change anything.) At the same time, unlike RTM, it is required that the resulting binary be executed correctly as on processors with TSX, and without. <br><br>  How was this done?  In a sense, HLE can be considered a variant of rw-lock for the variable used for blocking + transaction :).  XAQUIRE and XRELEASE prefixes are entered.  These are not instructions, they are prefixes (like LOCK, REP)!  They are ignored by a processor that does not support TSX.  These prefixes are recommended to be used before taking a lock and releasing it, respectively.  When taking a lock, writing to a variable does not occur; instead, it is placed in the read-set process, and the transaction begins.  Thanks to this magic (or hack, if it so pleases), other processes can also execute the locked code until there is a conflict over the write-set.  Then at XRELEASE and writing to the lock (which is also ignored), the transaction commits if executed without conflicts.  If there were conflicts, then a return to the usual semantics takes place. <br><br>  I will list the limitations of TSX. <br>  1. Since granularity is 64 bytes, inaccurate data placement in memory along with false sharing will now cause false transaction abort ... Since read-sets and write-sets are defined in the cache, this limits the amount of memory with which the transaction can work successfully. <br>  2. There is a bunch of conditions when transactions break off.  (When an interrupt arrives, using PAUSE, X87 type instructions, context switching, debugging, etc.) <br>  3. Nesting.  There is a limit on the level of nesting.  (Sorry can not say what) Interruption of a transaction for any reason at any nesting level resets all nested transactions! <br>  If you interrupt a transaction, you can see the reason.  But still it will be very fun to debug and profile all this!  Of course, for performance analysis, new CPUs will appear, counting TSX related events. <br><br>  Support in the software has already begun to appear, for example, Binutils is already <a href="http://article.gmane.org/gmane.comp.gnu.binutils/56264">commited</a> .  Next HLE in pthreads :), and then, I hope, use RTM in STM implementations. <br>  As I wrote above, the details are available in a <a href="http://software.intel.com/file/41417">document</a> on the Intel site. </div><p>Source: <a href="https://habr.com/ru/post/137567/">https://habr.com/ru/post/137567/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../137562/index.html">We test the browser for support of CSS3</a></li>
<li><a href="../137563/index.html">Last year in ITMO or writing a diploma at the Faculty of IT & P</a></li>
<li><a href="../137564/index.html">Cut the Rope: how we make updates to the game</a></li>
<li><a href="../137565/index.html">Fantasy or reality? Samsung concept hit parade</a></li>
<li><a href="../137566/index.html">The Little Redis Book Translation</a></li>
<li><a href="../137569/index.html">Image design on CSS3. Part 2</a></li>
<li><a href="../137571/index.html">EX.UA, LOIC and helpless Ukrainian police</a></li>
<li><a href="../137577/index.html">Ruby on rails to the masses: webvybory2012.ru issue a standard error page for the development of the Rails environment</a></li>
<li><a href="../137578/index.html">Opera Mini update - even if it is not installed</a></li>
<li><a href="../137581/index.html">Dynamic Access Control for ASP.NET MVC</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>