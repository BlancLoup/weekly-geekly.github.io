<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Mikrotik OS and automatic switching to the backup channel</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the recent past, in connection with the transition from ADSL to Ethernet, there was an excellent opportunity to try Mikrotik equipment. In this con...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Mikrotik OS and automatic switching to the backup channel</h1><div class="post__text post__text-html js-mediator-article">  In the recent past, in connection with the transition from ADSL to Ethernet, there was an excellent opportunity to try Mikrotik equipment.  In this connection, the router <a href="http://routerboard.com/RB750GL">RB750GL</a> was purchased.  The piece of iron turned out to be excellent both externally and in terms of functionality and reliability. <br>  As a result, I still had both channels and it was decided to set up a reservation with automatic switching.  Standard means of switching gateways do not cover all the variety of failures, so you need to write your own scripts. <br><a name="habracut"></a><br><h1>  Network configuration </h1><br>  1. The Ehernet channel from NLink is plugged into the first port of the router, receives IP via DHCP and raises the pptp connection, called nlink.  This will be the main connection. <br>  2. The ADSL channel from the Domolink provider passes through the DLink-2500 in bridge mode and is plugged into the second port of the router, the pppoe connection called domolink rises.  This will be a backup connection. <br>  3. Ports 3-5 of the router are used to connect devices to the local network. <br><br><h1>  Router settings </h1><br>  Setting up connections and masquerading for computers on the local network is trivial and is described in detail in the <a href="http://wiki.mikrotik.com/wiki/Manual:TOC">official wiki</a> . <br><br>  When configuring ppp connections, you need to disable adding routes by default, and then create static routes with different metrics and appropriate comments: <br> <code>/ip route <br> add comment=MainGW disabled=no distance=1 dst-address=0.0.0.0/0 gateway=nlink scope=30 target-scope=10 <br> add comment=RsrvGW disabled=no distance=2 dst-address=0.0.0.0/0 gateway=domolink scope=30 target-scope=10 <br></code> <br>  Now to switch channels it is enough to change the distance parameter.  Traffic will go through the channel with a smaller value for this parameter. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h1>  Scripts </h1><br><h2>  Setting global parameters when starting a router </h2><br>  The script is called set_global_parameters <br> <code>#Main interface name <br> :global MainIf nlink <br> #Reserve interface name <br> :global RsrvIf domolink <br> #Main interface ip address <br> :global MainIfAddress "" <br> #Reserve interface ip address <br> :global RsrvIfAddress "" <br></code> <br><h2>  Determination of interface IP addresses </h2><br><h3>  Determining the IP address of the main interface </h3><br>  The script is called define_main_if_ip <br> <code>:global MainIf <br> :global MainIfAddress "" <br> :set MainIfAddress [/ip address get [find interface=$MainIf] address] <br></code> <br>  This script defines the IP address of the main interface for Internet access.  If this interface is missing, the script will fail with an error, and the MainIfAddress variable will contain an empty string. <br><h3>  Determining the IP Address of the Backup Interface </h3><br>  The script is called define_reserved_if_ip <br> <code>:global RsrvIf <br> :global RsrvIfAddress "" <br> :set RsrvIfAddress [/ip address get [find interface=$RsrvIf] address] <br></code> <br>  The definition of these addresses is rendered into separate scripts, since  I use these values ‚Äã‚Äãin a number of scripts on the router (for example, updating records in DynDNS), and user functions cannot be created here.  It should be noted that direct address determination commands cannot be used in other scripts, since  in case of problems with the interface, they generate an error and lead to the completion of the script. <br><h2>  Channel switching </h2><br>  The script is called connection_check <br> <code>:global MainIf <br> :global RsrvIf <br> :global MainIfAddress <br> :global RsrvIfAddress <br> <br> :local PingCount 3 <br> <br> #www.ru <br> :local PingTarget1 194.87.0.50 <br> <br> #ya.ru <br> :local PingTarget2 87.250.250.203 <br> <br> #google dns <br> :local PingTarget3 8.8.8.8 <br> <br> #Check main internet connection <br> :local MainIfInetOk false; <br> <br> if ($MainIfAddress="") do={delay 5} <br> <br> if ($MainIfAddress!="") do={ <br> :local PingResult1 [/ping $PingTarget1 count=$PingCount interface=$MainIf] <br> :local PingResult2 [/ping $PingTarget2 count=$PingCount interface=$MainIf] <br> :local PingResult3 [/ping $PingTarget3 count=$PingCount interface=$MainIf] <br> <br> :set MainIfInetOk (($PingResult1 + $PingResult2 + $PingResult3) &gt;= (2 * $PingCount)) <br> } <br> <br> #Check reserved internet connection <br> :local RsrvIfInetOk false; <br> <br> if ($RsrvIfAddress="") do={delay 5} <br> <br> if ($RsrvIfAddress!="") do={ <br> :local PingResult1 [/ping $PingTarget1 count=$PingCount interface=$RsrvIf] <br> :local PingResult2 [/ping $PingTarget2 count=$PingCount interface=$RsrvIf] <br> :local PingResult3 [/ping $PingTarget3 count=$PingCount interface=$RsrvIf] <br> <br> :set RsrvIfInetOk (($PingResult1 + $PingResult2 + $PingResult3) &gt;= (2 * $PingCount)) <br> } <br> <br> :put "MainIfInetOk=$MainIfInetOk" <br> :put "RsrvIfInetOk=$RsrvIfInetOk" <br> <br> if (!$MainIfInetOk) do={ <br> /log error "Main internet connection error" <br> } <br> <br> if (!$RsrvIfInetOk) do={ <br> /log error "Reserve internet connection error" <br> } <br> <br> :local MainGWDistance [/ip route get [find comment="MainGW"] distance] <br> :local RsrvGWDistance [/ip route get [find comment="RsrvGW"] distance] <br> :put "MainGWDistance=$MainGWDistance" <br> :put "RsrvGWDistance=$RsrvGWDistance" <br> <br> #SetUp gateways <br> if ($MainIfInetOk &amp;&amp; ($MainGWDistance &gt;= $RsrvGWDistance)) do={ <br> /ip route set [find comment="MainGW"] distance=1 <br> /ip route set [find comment="RsrvGW"] distance=2 <br> /log info "Switch to main internet connection" <br> } <br> <br> if (!$MainIfInetOk &amp;&amp; $RsrvIfInetOk &amp;&amp; ($MainGWDistance &lt;= $RsrvGWDistance)) do={ <br> /ip route set [find comment="MainGW"] distance=2 <br> /ip route set [find comment="RsrvGW"] distance=1 <br> /log warning "Switch to reserve internet connection" <br> } <br></code> <br><br>  Pay attention to the ping through a specific interface, as well as the criterion for the recognition of a channel as faulty.  I ping three different sites and I believe that the Internet on this interface does not work if less than 2/3 of the responses arrive. <br><br><h1>  Scheduler </h1><br>  1. The set_global_parameters script is run once when the router is started. <br>  2. IP address detection scripts run every 27 seconds.  This value is chosen to minimize the number of simultaneous starts with the main script. <br>  3. The connection_check script runs every minute. <br><br><h1>  findings </h1><br>  The resulting solution at a minimum cost significantly increased the reliability of my home network and successfully copes with the most sophisticated failures of local providers, while it is sufficiently protected from failures of external network nodes. </div><p>Source: <a href="https://habr.com/ru/post/141785/">https://habr.com/ru/post/141785/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../141780/index.html">Useful links for learning CSS animations</a></li>
<li><a href="../141781/index.html">The domain Xakep.Ru is divided</a></li>
<li><a href="../141782/index.html">Non-traditional project development path</a></li>
<li><a href="../141783/index.html">Workflow organization: engine state management</a></li>
<li><a href="../141784/index.html">How to behave in open space</a></li>
<li><a href="../141786/index.html">I don't understand how they did it.</a></li>
<li><a href="../141787/index.html">DrupalConf conference materials</a></li>
<li><a href="../141788/index.html">Client analytics: Big Brother knows what you will buy tomorrow and when you change provider</a></li>
<li><a href="../141789/index.html">A simple and enjoyable video about Linux.</a></li>
<li><a href="../141790/index.html">Left brain needed</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>