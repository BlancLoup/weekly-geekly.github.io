<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>There is an error in almost all implementations of binary search and merge sort</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This is a translation of Joshua Bloch's 2006 Extra, Extra - Read All About It: Nearly All Binary Searches and Mergesorts are Broken . 

 I vividly rem...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>There is an error in almost all implementations of binary search and merge sort</h1><div class="post__text post__text-html js-mediator-article"> <i>This is a translation of Joshua Bloch's 2006 <a href="http://googleresearch.blogspot.ru/2006/06/extra-extra-read-all-about-it-nearly.html">Extra, Extra - Read All About It: Nearly All Binary Searches and Mergesorts are Broken</a> .</i> <br><br>  I vividly remember the first lecture of John Bentley at Carnegie Mellon University, in which he asked us, freshly baked graduate students, to write a binary search function.  He took one of the solutions and put it on the board, and, of course, there was a mistake in it, as in many of our other attempts.  This case became for me a clear demonstration to his book ‚ÄúThe Pearls of Programming‚Äù.  The moral is to carefully arrange invariants in the program. <br><br>  And now, now in 2006.  I was shocked to learn that the binary search program, the correctness of which Bentley was formally proving with tests, contains an error.  Do not think that I am carping;  in truth, such an error may well elude testers for decades.  Moreover, the binary search I wrote for the JDK was also nine years old.  And just now, when she broke someone's program, they reported her in Sun. <br><a name="habracut"></a><br>  So what is the mistake?  Here is the standard binary search in Java, one of the ones I wrote for <code>java.util.Arrays</code> : 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">binarySearch</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] a, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> key)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> low = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> high = a.length - <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (low &lt;= high) { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> mid = (low + high) / <span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> midVal = a[mid]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (midVal &lt; key) low = mid + <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (midVal &gt; key) high = mid - <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> mid; <span class="hljs-comment"><span class="hljs-comment">// key found } return -(low + 1); // key not found. }</span></span></code> </pre><br>  Error in the sixth line: <br><br><pre> <code class="java hljs"> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> mid = (low + high) / <span class="hljs-number"><span class="hljs-number">2</span></span>;</code> </pre><br>  In ‚ÄúThe Pearls of Programming‚Äù, Bentley writes at the expense of a similar line that she ‚Äúsets m equal to the average of these numbers, rounded to the nearest smaller integer‚Äù.  At first glance, everything is in order, but for sufficiently large <code>low</code> and <code>high</code> (namely, if their sum is more than 2 <sup>31</sup> -1) an error occurs.  Their sum becomes a negative number, and <code>mid</code> also turns out negative.  In C, this would result in unpredictable memory access outside the array, and Java throws an <code>ArrayIndexOutOfBoundsException</code> exception. <br><br>  This error appears only on very large arrays, more than 2 <sup>30</sup> (about a billion) elements.  In the 80s, when the book saw the light, it would have been impossible, but now with us at Google (and indeed with any project) this is a common thing.  In The Pearls of Programming, Bentley writes: ‚Äúalthough the first version of the binary search was published in 1946, the correct code processing all n values ‚Äã‚Äãappeared only in 1962.‚Äù  In fact, the correct code is still almost never met even in the most popular implementations of languages. <br><br>  So how to write this code correctly?  The sixth line can be rewritten as: <br><br><pre> <code class="java hljs"> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> mid = low + ((high - low) / <span class="hljs-number"><span class="hljs-number">2</span></span>);</code> </pre><br>  Although perhaps this option is faster and easier: <br><br><pre> <code class="java hljs"> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> mid = (low + high) &gt;&gt;&gt; <span class="hljs-number"><span class="hljs-number">1</span></span>;</code> </pre><br>  In C / C ++ there is no &gt;&gt;&gt; operator, but you can write this: <br><br><pre> <code class="cpp hljs"> mid = ((<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)low + (<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)high)) &gt;&gt; <span class="hljs-number"><span class="hljs-number">1</span></span>;</code> </pre><br>  Well, now we know for sure that there are no more errors, right?  Well ... most likely.  To absolutely strictly prove the correctness of the program, it needs to be tested on absolutely all possible input data, but in practice it is almost never feasible.  And for parallel computing, it is still worse: you have to test the program for all possible internal states.  Don't even try. <br><br>  This error can come out in merge sorting in other algorithms of the ‚Äúdivide and conquer‚Äù type.  If you implemented such algorithms, recheck them until the error has led to unpleasant consequences.  Personally, this mistake taught me to be a little more modest and not to rely on the obviousness of even a small and familiar piece of code, not to mention the really complex systems that we use every day. <br><br>  We, programmers, should improve our code by any means.  Neat architecture design is good.  Testing and formal analysis of algorithms is even better.  Static analysis and code revision is just great.  But none of this alone will save us from elusive bugs that will live for half a century, despite all our efforts.  We must practice careful defensive programming and be vigilantly vigilant. <br><br>  <b>Update February 17, 2008.</b> Antoine Trux <b>,</b> chief engineer at Nokia‚Äôs Finnish research center, reported that the proposed fix for C and C ++ does not guarantee correct operation, because by the standards of these languages, arithmetic overflow when added gives an uncertain result.  Now that we have fixed this bug, we <i>are</i> sure that the program is working correctly.  ;) <br><br>  References: <br><ul><li>  ‚Äú <a href="http://netlib.bell-labs.com/cm/cs/pearls/">Programming Pearls</a> ‚Äù - highly recommended, definitely buy it!  <i>(From the translator: the book was quoted in <a href="http://www.ozon.ru/context/detail/id/1039964/">Russian translation</a> )</i> <br></li><li>  <a href="http://bugs.sun.com/bugdatabase/view_bug.do%3Fbug_id%3D5045582">JDK Bug Tracker Error Message</a> <br></li><li>  <a href="http://www.di.unipi.it/~ruggieri/Papers/semisum.pdf">The</a> 2003 Salvatore Ruggieri <a href="http://www.di.unipi.it/~ruggieri/Papers/semisum.pdf">article</a> on a more general, but perhaps less interesting, problem: finding the average of two entire arbitrary signs.  The article does not address performance issues, and the proposed solution is not fast enough for an internal merge sort loop. <br></li></ul></div><p>Source: <a href="https://habr.com/ru/post/203398/">https://habr.com/ru/post/203398/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../203374/index.html">Someone made a $ 160 million bitcoin transaction</a></li>
<li><a href="../203376/index.html">Home all-in-one server - success story</a></li>
<li><a href="../203386/index.html">Query optimization. Basics of EXPLAIN in PostgreSQL (Part 2)</a></li>
<li><a href="../203394/index.html">Achiver: what's what</a></li>
<li><a href="../203396/index.html">Preparing video for sound design. Which codec to choose</a></li>
<li><a href="../203400/index.html">The digest of interesting materials from the world of web development and IT for the last week No. 84 (November 16 - 23, 2013)</a></li>
<li><a href="../203402/index.html">ThL W8s - a powerful smartphone with glass protection Gorilla Glass 3</a></li>
<li><a href="../203406/index.html">How Stack Overflow Works - Iron</a></li>
<li><a href="../203408/index.html">From idea to App Store: 24 hours, 2 applications</a></li>
<li><a href="../203410/index.html">US police caught a "gift"</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>