<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Lantern "Magic Lamp"</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This is a story about the redesign of the LED flashlight. An unconventional highlight is present :) - warm tube analog solutions are applied! 

 A few...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Lantern "Magic Lamp"</h1><div class="post__text post__text-html js-mediator-article"> This is a story about the redesign of the LED flashlight.  An unconventional highlight is present :) - warm tube analog solutions are applied! <br><br>  A few years ago, when LED lights just started to appear in stores, I bought an LED digger at Okey.  Large, with a pistol grip, conveniently lying in the hand, balanced.  It had one 3-volt LED, a lead battery, and, as described, could stand on recharging without restrictions.  It was what you need in the country.  As we all know, in spite of the 21st century and the space ships plying the cosmos (C) - at a distance of more than 30 km from Moscow, the power supply becomes unreliable.  Power networks disconnect electricity at any opportunity - in the rain, thunderstorm, heat and just like that.  Usually on Saturday-Sunday for an hour or two, the electricity is cut off.  Probably to train the population to survive in all conditions. <br><br>  Therefore, the presence of a powerful, convenient flashlight, constantly charged and ready to go is practical. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <a name="habracut"></a><br><br>  Unfortunately, lead batteries have a limited service life of about three years, especially in standby mode with constant drip recharging.  My flashlight was no exception, at some point I found that the battery does not hold a charge, but after a short time the voltage fell below the threshold of the LED. <br><br>  Of course you could go to any store of radio components and buy a replacement battery.  But a cursory study of the prices of such batteries did not arouse my enthusiasm.  Having considered the question, I decided that in such a lamp it is reasonable to use lithium batteries of type 18650, remaining from the replacement of elements in the battery of the ancient (more than 10 years) Compaq NC6220 laptop, valuable by the presence of a hardware serial of the port. <br><br>  Promer six old elements showed that four elements are quite suitable, one - so-so and one suitable only for emission.  The four elements of 18650, assembled in a battery with parallel inclusion in size were like the old lead battery.  I was surprised that the lithium cells from the old ten-year battery still have a capacity of about 1500 mAh with an initial 2200. <br><br>  If we are already engaged in remaking a flashlight to a different type of battery, which automatically means changing the control board, then we can also dream it up.  The body is large, you can place a lot.  Personally, I had the idea that controlling the brightness of the flashlight would be the correct variable resistor.  In fig.  1 shows a method for smoothly controlling the brightness of a LED lamp with a variable resistor. <br><br><img src="https://habrastorage.org/files/a31/332/0ae/a313320aed8b401aaee80fcf9723bccf.JPG" alt="image"><br><br>  Fig.  1. The method of smooth control of the brightness of the LED lamp variable resistor. <br><br>  To replace the lead battery, I made a holder for four 18650 elements: <br><br><img src="https://habrastorage.org/files/638/1d8/94d/6381d894d4bb47b692a7167da9bb1054.JPG"><br>  Fig.  2 Holder for four elements 18650 <br><br>  Elements 18650 are placed on a rectangular base of foiled fiberglass, in which Dremel cut 1.5 mm thick grooves for contact holders from springy bronze.  All parts are connected by soldering, a 200 watt soldering iron made in USSR was used.  The holders are soldered to the contacts from the solder, the thickness of the contacts is adjusted so that the 18650 held tightly with force.  The battery pack is attached to the top of the case through two plastic insulation racks.  Racks have a pin with an external M3 thread at one end and a recess with an internal M3 thread at the other end.  The plastic nut is secured in the hole on the base of the battery assembly, and the entire assembly is screwed with an M3 bolt through the upper part of the housing.  The design is folding, allows you to unscrew the two M3 screws and remove the entire battery pack.  Elements 18650 are removed from the holders without the use of tools. <br><br>  Directly from a lithium source, the LED can not be powered.  The LED is powered by a stabilized current of 700 mA, while the voltage drop across it is about 3.7 volts.  The lithium battery in a fully charged state gives a voltage of 4.2 volts, and in a discharged 2.7 volts.  The current source for the LED must be able to work in the specified input voltage range (2.7 - 4.2 volts), providing a stable current of 700 mA in the LED.  It is clear that this should be a pulse converter capable of operating in both voltage reduction and boost mode.  Such converters are called BUCK-BOOST and there is some choice of chips in the market for building converters. <br><br>  Since I decided to control the brightness of the diode with a variable resistor, I must convert the angle of the knob to a brightness control signal.  Brightness control requires a PWM signal, the duty ratio (fill factor) of which will determine the integral brightness of the LED.  Smoothly changing the duty cycle, you can smoothly change the brightness.  At the same time will be reduced power consumption, prolonging the work of the lamp.  In existing lamps, dimming modes are activated by successive button presses (usually the power button, sometimes a separate button).  This way seems to me unergonomic, inconvenient.  I am an adherent of the old-school analog control style with smoothly varying parameters with a round knob that can be rotated in both directions.  Therefore, the best in this case is a variable resistor, the handle of which can be operated with the thumb.  There are variable resistors with a switch that can additionally be used to switch the power of the flashlight.  If you consistently turn on the nominal button and switch on the resistor, you will get a new quality - you can turn on the lamp by turning the resistor knob, while the brightness will gradually increase from the MOONLIGHT mode to the maximum.  Or you can put the resistor knob to the desired position and turn the lamp off by pressing the button on the handle, each time getting the preset brightness.  The position of the risks on the handle of the variable resistor uniquely determines the brightness of the lamp and can be set before switching on.  With one button, you never know in which mode the lamp turns on.  Yes, I read the descriptions of standard lamps and I know what they write there ‚Äúthe lamp should turn on in the same mode‚Äù.  But all my lights of this type are included in a random mode. <br><br>  It was interesting for me to make a converter that would be as economical as possible, would have the ability to dim the LED, would be able to switch off when the lithium battery voltage drops below 2.7 volts.  Unfortunately, life is like this: ‚ÄúI want cheap, good and fast - of course, choose two of the three!‚Äù.  I did not manage to find an inexpensive microcircuit that was at the same time economical, knew how to raise and lower the voltage and could dim from a variable resistor.  As a result of reviewing the options, I chose the <a href="http://www.onsemi.ru.com/PowerSolutions/product.do%3Fid%3DNCP5030">NCP5030</a> chip.  It is inexpensive (~ 65 p), has a BUCK-BOOST mode and is quite economical, i.e.  conversion losses are small. <br><br>  Chip Parameters: <br><br>  ‚Ä¢ Efficiency of 87% at a load current of 500 mA and an input voltage of 3.3 V <br>  ‚Ä¢ Internal synchronous rectifier <br>  ‚Ä¢ Maximum current per load - 900 mA <br>  ‚Ä¢ 0.3 ¬µA off current consumption <br>  ‚Ä¢ Input voltage range 2.7 - 5.5 volts <br>  ‚Ä¢ 200 mV feedback voltage to stabilize the output current <br>  ‚Ä¢ Protection against overvoltage and overheating. <br>  ‚Ä¢ Automatic transition between BUCK and BOOST modes <br><br>  The conversion frequency is fixed and is 700 kHz.  Such a fairly high conversion frequency on the one hand allows the use of inductance of a small nominal value, but on the other hand, it requires careful installation and the use of correct parts on the manual to prevent parasitic generation. <br><br>  A built-in synchronous rectifier on field-effect transistors with a low channel resistance in the open state (voltage drop of about 0.1 volts) allows to significantly increase the efficiency compared to a rectifier even on Schottky diodes (voltage drop on a Schottky diode - 0.5 volts). <br><br>  A very valuable feature of the NCP5030 chip is the automatic switching between the low and high modes of the input voltage.  The battery voltage varies from 4.2 to 2.7 volts, and the LED should be about 3.7 volts.  This means that as the battery discharges, you must first lower the input voltage, and then increase it.  The NCP5030 automatically switches between the buck (buck) and boost (boost) modes, transparently to the user. <br><br>  The wiring diagram of the NCP5030 is shown in fig.  3: <br><br><img src="https://habrastorage.org/files/5a9/780/b19/5a9780b19e4a425496e28db9efb6cb83.png"><br>  Fig.  3 Wiring diagram for the NCP5030 <br><br>  The disadvantage of the solution based on this chip is the presence of only digital dimming control - a discrete PWM signal must be sent to the CTRL input to control the brightness with a frequency of no more than 1000 Hz.  Also, the chip does not have the means to control the battery voltage and shutdown when the voltage drops below the threshold of 2.7 volts. <br><br>  When selecting parts, some difficulties are caused by the search for resistor R3.  Its nominal is 220 milliohm or 0.22 ohm.  The voltage from this resistor (directly proportional to the current through the LED) is used by the microcircuit to adjust the current of the LED.  I did not find such a resistor for reasonable time and money, so I decided to make it out of several resistors connected in parallel with a larger nominal (1 ohm and so).  In addition to the low price and availability of resistors of such ratings, it additionally becomes possible to easily adjust the LED current by installing different numbers of resistors in parallel.  In my case, we got three resistors for 1 st and in parallel a 2 ohm resistor from two for 1 ohm.  The total resistance of these resistors (R11, R13-R16) is 0.285 ohm, which at a feedback voltage of 200 millivolts gives a current in the LED of 700 mA. <br><br><img src="https://habrastorage.org/files/0f8/268/6e7/0f82686e77f04a35a24b4538917003d5.png"><br>  Fig.  4 Pinout NCP5030 <br><br>  The NCP5030 chip is made in a 3-by-4-mm WFDN package with 12 pins and is obviously designed for mounting onto a printed circuit board.  The distance between the terminals is 0.5 mm, the terminal thickness is 0.3 mm, plus it requires the connection of terminal 13 ‚Äúunder the abdomen‚Äù to the common terminal of the printed circuit board for the heat sink.  In fig.  Figure 4 shows the pinout of the NCP5030. <br><br>  I consider it unreasonable to make printed circuit boards for individual products for a number of reasons, one of which is the difficulty of finalizing the product.  If some idea came to mind, then at the stage when the printed circuit board is implemented, it is difficult to finish.  It is possible to put additional jumpers or a pair of elements, but it is difficult to add a node. <br><br>  Therefore, I consider optimal for myself the technology of manufacturing boards from double-sided foil fiberglass by cutting through the tracks with a clerical knife.  Taking a fee of sufficient size, one can always, as new ideas emerge, complete the new part without touching the already made.  The advantage of the method is the minimum time for the manufacture of such a board; no harmful reagents such as ferric chloride or other corrosive substances are needed for etching the board.  This method of ‚Äúadvanced prototyping‚Äù proved its suitability - the devices made in this way lived in my house for about 30 years and were decommissioned due to obsolescence and replacement with more advanced modern devices. <br><br>  However, it is difficult or even impossible to make a teething board for such a small chip.  But you can cut the tracks of a reasonable size, which is easily done, for example, in increments of about 1 mm, install the chip upside down and unsolder it under a microscope.  Terminal 13 should be soldered with 0.5 mm copper wire to the common wire of the board, the other terminals should be connected with a 0.12 mm wire, and the power terminals - with a pigtail of 3-4 such wires.  The result is shown in Fig.  five. <br><br><img src="https://habrastorage.org/files/70a/b6d/209/70ab6d20926e4891bddae53e9eeef3dc.JPG"><br>  Fig.  5 Soldered NCP5030 Chip <br><br>  Scheme earned immediately.  It took only the adjustment of the LED current by soldering additional resistors in 1 ohm to get 700 mA. <br><br>  The chip during long operation (hours) is barely warm, the finger feels weak heat and only.  This means that the heat sink soldering solution of the copper wire is correct and ensures the normal operation of the heat.  A thorough study of the waveforms of the oscilloscope showed perfect forms, exactly according to the manual. <br><br>  For the full implementation of all the ideas put, it is necessary to realize something with a PWM signal that will control the LED brightness and monitor the battery voltage in order to turn off the system when the voltage drops below a critical level. <br><br>  Analysis of possible solutions led to the conclusion that the cheapest (35 p.) And universal in terms of capabilities is the use of a simple microcontroller of the type <a href="http://www.atmel.com/Images/doc8126.pdf">ATTINY13A</a> .  This microcontroller does not require any strapping, except for the filter capacitor for power. <br><br>  Key parameters ATTINY13A <br><br>  ‚Ä¢ Supply voltage 1.8-5.5 volts <br>  ‚Ä¢ 4 ADC channels with internal or external reference signal <br>  ‚Ä¢ Current consumption less than 1 mA <br>  ‚Ä¢ 6 programmable I / O lines (5, if you do not use the reset leg) <br>  ‚Ä¢ 2 hardware PWM channels. <br><br>  A certain role in the choice of this controller was played by the ability to program it in the Arduino environment and flash the program through Arduino. <br><br>  The capabilities of the built-in ADC are quite enough for removing the position of the variable resistor's engine and measuring the battery voltage.  The microcontroller includes its own reference voltage source (1.1 volts), which makes it possible to measure the battery voltage.  You can programmatically include either an internal reference source (if you need to measure the battery voltage), or an external one - if you need to measure the position of the slider of the resistor.  There are also a couple of free outputs that I used to control two LEDs of different colors and an analog measuring head.  Two LEDs allow you to evaluate the battery status at a glance: green means more than half the charge, red means less than half the charge. <br><br>  For programming, it is required to disconnect 4 outputs from the circuit and connect them from to the programmer.  Pulling the microcontroller for programming from the cot is inconvenient, so I installed 6 pin connectors on the board (4 signal + 1 power + 1 common).  They are two pins on which a standard jumper is worn.  If the jumper is in place, the circuit is functioning normally.  For programming, jumpers need to be removed and connected to the free pins of the programmer pin.  In programming mode, the power to the ATTINY13A is supplied from the programmer. <br><br>  There are enough resources on the ATTINY13A programming topic through the Arduino board and creating programs in the Arduino IDE.  I used these sources <a href="http://forum.arduino.cc/index.php%3Ftopic%3D89781.0">1</a> and <a href="http://bigbarrel.ru/%25D0%25BF%25D1%2580%25D0%25BE%25D1%2588%25D0%25B8%25D0%25B2%25D0%25B0%25D0%25B5%25D0%25BC-attiny-c-%25D0%25BF%25D0%25BE%25D0%25BC%25D0%25BE%25D1%2589%25D1%258C%25D1%258E-arduino/">2</a> . <br><br>  From the subtleties - you need a file boards.txt, in which the parameters that control the clocking of the processor and the settings of the internal divider are correctly defined. <br><br>  Without this, the PWM signal frequency will be incorrect and the software delays will not be processed correctly. <br>  I also had to correct the name ATTINY13 on ATTINY13A, the programmer at the beginning of the process interrogates the microcontroller and gives an error if it cannot find a section with exactly that name. <br><br>  The circuit diagram of the flashlight is shown in fig.  6 <br><br><img src="https://habrastorage.org/files/de4/b5c/681/de4b5c68138c4fe386b7ceaef4a8fbd5.JPG"><br>  Fig.  6 Schematic diagram of the lamp <br><br>  The battery voltage is supplied to the ADC2 ATTINY13A input through a resistor divider.  When measuring the battery voltage, the internal reference source for the 1.1-volt ADC is programmatically turned on and therefore the maximum allowable voltage at the input should not exceed 1.1 volts.  Proceeding from this limitation, the nominal values ‚Äã‚Äãof the divider R1-R2 are calculated with a certain margin. <br><br>  The voltage from the slider of the variable resistor is fed to the ADC3 input and when reading this input an external support is used - the battery voltage.  In this mode, the data from the ADC is proportional to the rotation angle of the potentiometer slider and does not depend on the battery voltage.  This data varies in the range of 0-1023. <br><br>  In fig.  7 shows the flashlight board in its entirety with all the details. <br><br><img src="https://habrastorage.org/files/da8/cba/f63/da8cbaf63a414fbd8efc29e2b7223d50.JPG"><br>  Fig.  7 Lantern charge entirely <br><br>  Considering the issue of analog LED brightness control, I decided that since the organs of hearing and human vision perceive the signal logarithmically, it would be correct to use a resistor with the inverse logarithmic dependence of the output signal on the angle of rotation ‚Äî so that it seemed that the signal (LED brightness) changes smoothly and evenly the entire range of rotation of the handle.  When buying such a resistor, it is necessary to take into account the peculiarities of marking domestic and foreign resistors - domestic ones are labeled as type "B", and foreign ones - as type "A". <br><br>  Unfortunately, I could not buy a small-sized variable resistor with anti-logarithmic (sonic) dependency and with a switch.  Therefore, I bought a resistor with a linear dependence of a small size and with a switch and applied a hardware hack (resistor R4 on a circuit diagram), long known to hams.  This method is described for example, <a href="http://www.cqham.ru/forum/showthread.php%3F16563-%25C8%25E7%25EC%25E5%25ED%25E5%25ED%25E8%25E5-%25F5%25E0%25F0%25E0%25EA%25F2%25E5%25F0%25E8%25F1%25F2%25E8%25EA%25E8-%25F0%25E5%25E3%25F3%25EB%25E8%25F0%25EE%25E2%25E0%25ED%25E8%25FF-%25F0%25E5%25E7%25E8%25F1%25F2%25EE%25F0%25EE%25E2">here</a> . <br><br>  Place for the installation of a resistor in the lamp housing is chosen experimentally - so that it is convenient to turn it with your thumb and so that it does not interfere with other components inside (see. Fig. 8) <br><br><img src="https://habrastorage.org/files/03d/082/f8d/03d082f8d3334a7daf6095a8ba6ab59c.JPG"><br>  Fig.  8 The location of the variable resistor <br><br>  When testing a flashlight with large currents (700-800 mA), poor contact appeared in the standard push-button switch.  At small currents, the defect did not manifest itself, and at large currents the flashlight began to blink randomly. <br><br>  I disassembled the flashlight, looked at the button, read the name, looked in the internet for the parameters and realized that this button is not suitable for switching such currents in principle, as it is designed for 100 mA.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I had to take from the "stocks of the General Staff" button KMA 1-IV, released in 1973 in the USSR, capable of switching the current to 3A and put it in place of a regular misunderstanding.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In the process of testing, it turned out that in the maximum power mode, the aluminum radiator on which the LED is mounted heats up to about 60 degrees. </font><font style="vertical-align: inherit;">Not surprisingly, the casing is completely enclosed, thick plastic, no heat sink. </font><font style="vertical-align: inherit;">He considered, drilled holes in the housing so that the outside air cooled the radiator. </font><font style="vertical-align: inherit;">It has become much better - now the heating is barely noticeable with long work in a few hours. </font><font style="vertical-align: inherit;">I fixed the flashlight in a vice and inserted a mercury laboratory thermometer into the hole on top so that it touched the aluminum plate. </font><font style="vertical-align: inherit;">After long work at full power (more than a couple of hours), the temperature stabilized at around 40 degrees C. In my opinion, it is quite satisfactory.</font></font> In fig.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 9 shows the holes in the lamp housing. </font></font><br><br><img src="https://habrastorage.org/files/ba9/44a/615/ba944a61565248e3ac7f0a73ceccbd79.JPG"><br>  Fig.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">9 Holes in the case for cooling the radiator of the LED </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The test lamp when operating at full power lasted more than 8 hours before shutting down when the voltage drops below 2.7 volts. This gives the total capacity of the four elements 18650 approximately 6000 mAh or 1500 mAh per element. Not bad for 10 year old items! </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">When discussing the project with my friend, a water tourist, the idea of ‚Äã‚Äãanalog indication of battery charge was born. Approximately the way it was done in the first wearable tape cassette recorders - there was a built-in dial gauge for the battery charge level and recording level. Then it was necessary to set the recording level manually!</font></font> :) <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Having before your eyes an indication of the balance of the charge, you can decide how to expend energy: to save the charge or you can turn on the full, not sparing. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Soon after, I accidentally hit the Quartz shop on the street. </font><font style="vertical-align: inherit;">Buzheninova and, looking at the shop windows in anticipation of the completion of his wife‚Äôs affairs, came across such a wonderful </font></font><a href="http://www.quartz1.com/price/model.php%3Fgroup%3D7207%26ext%3D6216"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">analog indicator</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (Fig. 10):</font></font><br><br><img src="https://habrastorage.org/files/b10/b47/76c/b10b4776c6bc47f093a6d148594e7214.png"><br>  Fig.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">10 Analogue Battery Level Indicator </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Having estimated the dimensions, I decided that I would be able to insert it into the cover. </font><font style="vertical-align: inherit;">On the back of the indicator rested on the board and had to slightly push out of the cover. </font><font style="vertical-align: inherit;">The indicator is fixed with hot melt glue.</font></font><br><br><img src="https://habrastorage.org/files/ed6/636/464/ed6636464ff3465388bb4474c40391eb.JPG"><br>  Fig.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">11 Analog battery level indicator in the lid The </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">red and green LEDs are located above the level indicator. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">To control the indicator, I applied the second PWM channel in ATTINY13A. The calculation of the additional resistance and the PWM parameters was made so that the maximum deviation of the indicator arrow occurs when charging is connected, and the minimum - at a cutoff voltage of 2.7 volts. This is the digital equivalent of the ‚Äústretched scale‚Äù. Successfully it turned out that half of the battery discharge fell just on the yellow zone of the indicator.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">To control the two LEDs (red and green), I still had one conclusion. </font><font style="vertical-align: inherit;">I had to think a little :). </font><font style="vertical-align: inherit;">The solution, see the schematic diagram, the elements of R5 - R7 and HL1 - HL2. </font><font style="vertical-align: inherit;">A minor drawback of such a decision is the impossibility to turn off the LEDs altogether, even if you turn the ATTINY13A output into the third state - the LEDs will dimly glow.</font></font><br><br><img src="https://habrastorage.org/files/765/48e/496/76548e4961494c8d8c06129a32b6faa3.JPG"><br>  Fig.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 12 Lithium battery charge board </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The last thing I attached to the lamp is the charge board for lithium batteries (Fig. 12). I once bought a dilextstream, tempted by cheapness, but here it was used. The charge is current of the order of an amp and goes quite a long time - up to 10 hours. However, with a capacity of about 6000 mAh and a charge current of 1A, something like this should be. In the process of charging, the board shines with a blue diode, after it ends it turns green. In principle, it would be possible not to use this charge, but to disassemble the lamp and charge the elements in a separate external charger. I planned to do so at first, considering that 6000 mAh would be enough for the whole season. But laziness - the engine of progress - won and I built in the charger. Now it is enough to connect the miniUSB - USB cable from any 5v source. For charging purposes, charging from a network with a current of 1-2 A is better; a computer port with a current of 500 mA is worse;but also acceptable. I do not give references to the board, a search for the words "1a lithium board charger" will give you a sea of ‚Äã‚Äãreferences. An additional bonus - the need to ensure easy disassembly of the flashlight to remove the battery pack has disappeared, this block can be fixed permanently.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The board is placed in the lamp cover, so that when the cover is closed, the board will enter the free space in the body of the lamp. </font><font style="vertical-align: inherit;">The board is fixed with hot melt in place. </font><font style="vertical-align: inherit;">MiniUSB connector available outside. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Control of the analog indicator was reduced to the calculation of the parameters of the PWM signal depending on the battery voltage. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The control program for ATTINY13A is small and I quote it directly here:</font></font><br><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Management software for ATTINY13A</font></font></b> <div class="spoiler_text">  void setup () { <br> pinMode(0, OUTPUT); <br> pinMode(1, OUTPUT); <br> pinMode(2, OUTPUT); <br><br>  / * <br> Setting Divisor Frequency PWM on 9.6, 4.8, 1.2 MHz CPU <br> 0x01 divisor is 1 37500, 18750, 4687 Hz <br> 0x02 divisor is 8 4687, 2344, 586 Hz <br> 0x03 divisor is 64 586, 293, 73 Hz <br> 0x04 divisor is 256 146, 73, 18 Hz <br> 0x05 divisor is 1024 36, 17, 5 Hz <br>  * / <br><br> TCCR0B = TCCR0B &amp; 0b11111000 | 0x02; // 0x02 divisor is 8 586 Hz <br><br>  } <br><br><br> void loop(void) { <br><br> analogReference(INTERNAL); <br> int batt=analogRead(3); <br> delay(25); <br> batt=analogRead(3); <br> analogReference(EXTERNAL); <br> int resistor=analogRead(2); <br> delay(25); <br> resistor=analogRead(2); <br> int r=(resistor*32); <br> r=r/147+33; <br><br> if (r &gt; 255) {r=255;} //led starts to light at 13.8% PWM <br><br> if (batt &gt; 440) { <br> analogWrite(0, r); <br>  } <br>  else <br>  { <br> analogWrite(0, 0); <br>  } <br><br> if(batt&lt;560) { <br> digitalWrite(2, HIGH); <br>  } <br>  else <br>  { <br> digitalWrite(2, LOW); <br>  } <br><br> if(batt&lt;440) {batt=440;} <br> if(batt&gt;(440+255)) {batt=440+255;} <br><br> analogWrite(1, batt-440); <br><br><br>  } <br></div></div><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">To obtain the desired frequency for dimming the LED, we had to change the timer divider to get the frequency of 586 Hz. In reality, the measured frequency of the PWM signal turned out to be 555 Hz, which is close enough to the calculated one, taking into account the accuracy of the built-in clock generator. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Double reading from the ADC is applied as by some assertions the first conversion after switching the support gives an inadequate result. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The rest of the code in my opinion is trivial and does not require explanation. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tests showed</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> that the assigned tasks were completed: </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A lantern with continuous brightness adjustment from moonlite to full brightness was obtained, with a battery of about 6000 mache, which is enough for 11 hours of operation with full brightness and probably for a week in MOONLITE mode according to calculations.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The power source - lithium cells 18650 from the old battery from the laptop, found a second life. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The LED does not overheat, is in the correct thermal mode. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dimming frequency of about 550 Hz provides a more or less safe mode for the eyes. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">There are both an analog battery voltage indicator and a discrete indication on two different-colored LEDs.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The accuracy of the microcontroller's ADC is enough for surely shutting down the system at the critical voltage when the battery is discharged, the residual current consumption in the region of several milliamperes is not dangerous for a battery of this capacity, even if the user does not turn off the flashlight right away, but does so with a delay. In principle, you can change the program code so that at a critically low battery level, the LEDs also go out completely. Then the remaining current consumption of a microcontroller in a hundred microamperes will not be enough to cause appreciable damage to batteries. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Built-in charging allows you to use the lamp in standby mode with a permanently connected source, which ensures a constant 100% charge of the lamp, which is convenient at the dacha in case of accidental blackouts. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Project's budget.</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Parts cost 660 r for three sets, i.e. </font><font style="vertical-align: inherit;">220 r for one lantern. </font><font style="vertical-align: inherit;">Lithium elements, etc. </font><font style="vertical-align: inherit;">- is free. </font><font style="vertical-align: inherit;">Analog measuring device cost 550 p, but it is not necessary. </font><font style="vertical-align: inherit;">Time spent on the development and manufacture of course much more than it would take to simply replace the lead battery, but the pleasure of creativity is priceless :) </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">When buying items, I sought to unify. </font><font style="vertical-align: inherit;">So, for example, if filter capacitors of 10-22 microfarads are required in the circuit, then it makes sense to buy not different pieces of a pair, but 10 of the largest nominal (22 microfarads in this case). </font><font style="vertical-align: inherit;">The price for 10 pieces will be less than for single capacitors of different capacities, and an increase in the capacity of the filter capacitors will only have a positive effect on the functioning of the circuit.</font></font></div><p>Source: <a href="https://habr.com/ru/post/368137/">https://habr.com/ru/post/368137/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../368127/index.html">Experiment: What does restaurant lighting affect?</a></li>
<li><a href="../368129/index.html">Farewell to Philae</a></li>
<li><a href="../368131/index.html">"We sit well" or a fairy tale that needs to be told not only to children</a></li>
<li><a href="../368133/index.html">Smarthalo - a system that will turn the life of a cyclist into a paradise</a></li>
<li><a href="../368135/index.html">Apple lured away another Tesla engineer</a></li>
<li><a href="../368139/index.html">RZD has released a new mobile application for buying tickets - now without commission</a></li>
<li><a href="../368141/index.html">Efficient interoperability between native Arduino and Linux processes</a></li>
<li><a href="../368145/index.html">Russia and the United States are jointly creating a new type of fusion reactor</a></li>
<li><a href="../368147/index.html">An overview of current bb-mobile tablets in 2016: ‚Äútablets‚Äù for every taste with 8 cores, Android, Windows and LTE</a></li>
<li><a href="../368151/index.html">Perfect gadget backpack for father family</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>