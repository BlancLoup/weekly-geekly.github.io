<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Creating a chain of behaviors</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello! In the first note, I rather superficially mentioned the creation of a chain of behaviors. In this, I want to give an example of a simple chain ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Creating a chain of behaviors</h1><div class="post__text post__text-html js-mediator-article">  Hello!  In the first note, I rather superficially mentioned the creation of a chain of behaviors.  In this, I want to give an example of a simple chain with explanations. <br><br>  For my part, I will be happy to receive criticism and comments about the code. <br><a name="habracut"></a><br>  So let's imagine that our goal is a universal interface for storing key-value pairs, without going into implementation details.  All we want to do in the first stage is to determine which interface the ‚Äúworking‚Äù part will have: <br><br><pre><code class="erlang hljs">-callback list_items<span class="hljs-params"><span class="hljs-params">()</span></span> -&gt; [term<span class="hljs-params"><span class="hljs-params">()</span></span>]. -callback add_item(Id :: term(), Value :: any() )-&gt;ok|{error, any() }. -callback get_item(Id :: term()) -&gt; {ok, Value::any()}|{error, not_found}. -callback del_item(Id :: term()) -&gt; ok|{error, not_found}.</code> </pre> <br>  The interface is very simple and in no way determines where values ‚Äã‚Äãare stored - in a tree, a hash table, or a simple list. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The next moment is no matter what implementation we are going to determine, it will necessarily have an internal state - the same tree, table or list.  And to store it, we will use the standard gen_server.  That is, we will have a code that implements the interface, based on the state provided by the module to implement the gen_server.  Here it is a chain. <br><br>  Now the moment of initialization.  When the implementation module starts, we must start the interface module instead, and it in turn will turn to gen_server. <br><br>  Somewhere like this: <br><br>  Implementation: <br><br><pre> <code class="erlang hljs"><span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">start_link</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(_Params)</span></span></span><span class="hljs-function">-&gt;</span></span> storage:start_link(example_storage, []).</code> </pre><br>  Interface: <br><br><pre> <code class="erlang hljs"><span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">start_link</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Module, ModArgs)</span></span></span><span class="hljs-function"> -&gt;</span></span> gen_server:start_link({local, ?SERVER}, ?MODULE, {Module, ModArgs}, []).</code> </pre> <br>  The next step in the call chain is the init function in the interface module.  She, in turn, would like to call the corresponding function in the implementation module.  Besides, we need to save all this information.  Total: <br><br>  Interface: <br><br><pre> <code class="erlang hljs"><span class="hljs-keyword"><span class="hljs-keyword">-record</span></span><span class="hljs-params"><span class="hljs-params">(state, {mod :: atom(), mod_state :: term() })</span></span>. init({Mod, ModArgs}) -&gt; process_flag(trap_exit, <span class="hljs-literal"><span class="hljs-literal">true</span></span>), {ok, ModState} = Mod:init_storage(ModArgs), {ok, #state{mod = Mod, mod_state = ModState}}.</code> </pre><br>  Implementation: <br><br><pre> <code class="erlang hljs"><span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">init_storage</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">([])</span></span></span><span class="hljs-function">-&gt;</span></span> Table = [], {ok, [{table, Table }]}.</code> </pre> <br>  Yes Yes!  This implementation stores data in a simple list.  Horror. <br><br>  It's all about initialization.  Now back to the working part.  Our data is stored within the status of the interface.  So let's call it and ask to process: <br><br>  Implementation: <br><br><pre> <code class="erlang hljs"><span class="hljs-keyword"><span class="hljs-keyword">-spec</span></span> list_items<span class="hljs-params"><span class="hljs-params">()</span></span> -&gt; [term<span class="hljs-params"><span class="hljs-params">()</span></span>]. list_items()-&gt; storage:do_action(list_items, {}).</code> </pre> <br>  Interface: <br><br><pre> <code class="erlang hljs"><span class="hljs-keyword"><span class="hljs-keyword">-spec</span></span> do_action<span class="hljs-params"><span class="hljs-params">(atom(), tuple())</span></span>-&gt; term<span class="hljs-params"><span class="hljs-params">()</span></span>. do_action(Command, Command_params)-&gt; gen_server:call(?MODULE, {Command, Command_params}). handle_call({Command, Command_params}, _From, State = #state{mod = Mod, mod_state = ModState}) -&gt; {Reply, UpdatedState} = Mod:execute_action(ModState, Command, Command_params), {reply, Reply, State#state{mod_state = UpdatedState}}.</code> </pre><br>  We receive a call, receive an internal state and call the function that will process the request. <br><br>  Implementation: <br><br><pre> <code class="erlang hljs"><span class="hljs-keyword"><span class="hljs-keyword">-spec</span></span> execute_action<span class="hljs-params"><span class="hljs-params">(State::term(), Action::atom(), ActionParams :: tuple() )</span></span> -&gt; {term<span class="hljs-params"><span class="hljs-params">()</span></span>, term<span class="hljs-params"><span class="hljs-params">()</span></span>}. execute_action(State = [{table, Table }], list_items, {}) -&gt; {Table, State}.</code> </pre><br>  Now let's put it all together: <br><br>  Interface: <br><br><pre> <code class="erlang hljs"><span class="hljs-keyword"><span class="hljs-keyword">-module</span></span><span class="hljs-params"><span class="hljs-params">(storage)</span></span>. -behaviour(gen_server). -callback start_link(Params :: [term()])-&gt; {ok, pid() }. -callback init_storage(Args :: list())-&gt; {ok, State :: term()}. -callback list_items() -&gt; [term()]. -callback add_item(Id :: term(), Value :: any() )-&gt;ok|{error, any() }. -callback get_item(Id :: term()) -&gt; {ok, Value::any()}|{error, not_found}. -callback del_item(Id :: term()) -&gt; ok|{error, not_found}. -callback execute_action(State::term(), Action::atom(), ActionParams :: tuple() ) -&gt; {term(), term()}. -export([start_link/<span class="hljs-number"><span class="hljs-number">2</span></span>]). -export([init/<span class="hljs-number"><span class="hljs-number">1</span></span>, handle_call/<span class="hljs-number"><span class="hljs-number">3</span></span>, handle_cast/<span class="hljs-number"><span class="hljs-number">2</span></span>, handle_info/<span class="hljs-number"><span class="hljs-number">2</span></span>, terminate/<span class="hljs-number"><span class="hljs-number">2</span></span>, code_change/<span class="hljs-number"><span class="hljs-number">3</span></span>]). -export([do_action/<span class="hljs-number"><span class="hljs-number">2</span></span>]). -define(SERVER, ?MODULE). -record(state, {mod :: atom(), mod_state :: term() }). start_link(Module, ModArgs) -&gt; gen_server:start_link({local, ?SERVER}, ?MODULE, {Module, ModArgs}, []). -spec do_action(atom(), tuple())-&gt; term(). do_action(Command, Command_params)-&gt; gen_server:call(?MODULE, {Command, Command_params}). init({Mod, ModArgs}) -&gt; process_flag(trap_exit, <span class="hljs-literal"><span class="hljs-literal">true</span></span>), {ok, ModState} = Mod:init_storage(ModArgs), {ok, #state{mod = Mod, mod_state = ModState}}. handle_call({Command, Command_params}, _From, State = #state{mod = Mod, mod_state = ModState}) -&gt; {Reply, UpdatedState} = Mod:execute_action(ModState, Command, Command_params), {reply, Reply, State#state{mod_state = UpdatedState}}. handle_cast(_Msg, State) -&gt; {noreply, State}. handle_info(_Info, State) -&gt; {noreply, State}. terminate(_Reason, _State) -&gt; ok. code_change(_OldVsn, State, _Extra) -&gt; {ok, State}.</code> </pre><br>  And implementation: <br><br><pre> <code class="erlang hljs"><span class="hljs-keyword"><span class="hljs-keyword">-module</span></span><span class="hljs-params"><span class="hljs-params">(example_storage)</span></span>. -behaviour(storage). -export([start_link/<span class="hljs-number"><span class="hljs-number">1</span></span>, init_storage/<span class="hljs-number"><span class="hljs-number">1</span></span>, list_items/<span class="hljs-number"><span class="hljs-number">0</span></span>, add_item/<span class="hljs-number"><span class="hljs-number">2</span></span>, get_item/<span class="hljs-number"><span class="hljs-number">1</span></span>, del_item/<span class="hljs-number"><span class="hljs-number">1</span></span>, execute_action/<span class="hljs-number"><span class="hljs-number">3</span></span>]). -spec start_link(Params :: list())-&gt; {ok, pid() }. start_link(_Params)-&gt; storage:start_link(example_storage, []). -spec init_storage(Args :: list())-&gt; {ok, State :: term()}. init_storage([])-&gt; Table = [], {ok, [{table, Table }]}. -spec list_items() -&gt; [term()]. list_items()-&gt; storage:do_action(list_items, {}). -spec add_item(Id :: term(), Value :: any() )-&gt;ok|{error, any() }. add_item(Id, Value)-&gt; storage:do_action(add_item, {Id, Value}). -spec get_item(Id :: term()) -&gt; {ok, Value::any()}|{error, not_found}. get_item(Id)-&gt; storage:do_action(get_item, {Id}). -spec del_item(Id :: term()) -&gt; ok|{error, not_found}. del_item(Id)-&gt; storage:do_action(del_item, {Id}). -spec execute_action(State::term(), Action::atom(), ActionParams :: tuple() ) -&gt; {term(), term()}. execute_action(State = [{table, Table }], list_items, {}) -&gt; {Table, State}; execute_action(_State = [{table, Table }], add_item, {Id, Value}) -&gt; UpdatedTable = lists:keystore(Id, <span class="hljs-number"><span class="hljs-number">1</span></span>, Table, {Id, Value}), {ok, [{table, UpdatedTable }]}; execute_action(State = [{table, Table }], get_item, {Id}) -&gt; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> lists:keyfind(Id, <span class="hljs-number"><span class="hljs-number">1</span></span>, Table) <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span> -&gt; { {error, not_found}, State}; {Id, Value} -&gt; {Value, State} <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; execute_action(State = [{table, Table }], del_item, {Id}) -&gt; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> lists:keymember(Id, <span class="hljs-number"><span class="hljs-number">1</span></span>, Table) <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span> -&gt; UpdatedTable = lists:keydelete(Id, <span class="hljs-number"><span class="hljs-number">1</span></span>, Table), {ok, [{table, UpdatedTable }] }; <span class="hljs-literal"><span class="hljs-literal">false</span></span> -&gt; { {error, not_found}, State} <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>. -ifdef(TEST). -include_lib(<span class="hljs-string"><span class="hljs-string">"eunit/include/eunit.hrl"</span></span>). simple_test()-&gt; {ok, Pid} = example_storage:start_link([]), [] = example_storage:list_items(), ok = example_storage:add_item(key1, <span class="hljs-number"><span class="hljs-number">2</span></span>), [{key1,<span class="hljs-number"><span class="hljs-number">2</span></span>}] = example_storage:list_items(), ok = example_storage:add_item(key2, <span class="hljs-number"><span class="hljs-number">4</span></span>), [{key1,<span class="hljs-number"><span class="hljs-number">2</span></span>}, {key2, <span class="hljs-number"><span class="hljs-number">4</span></span>}] = example_storage:list_items(), ok = example_storage:del_item(key1), [{key2, <span class="hljs-number"><span class="hljs-number">4</span></span>}] = example_storage:list_items(), {error, not_found} = example_storage:del_item(key1), {error, not_found} = example_storage:get_item(key1), <span class="hljs-number"><span class="hljs-number">4</span></span> = example_storage:get_item(key2), ok = example_storage:del_item(key2), [] = example_storage:list_items(). -endif.</code> </pre><br>  This is a simple and very naive implementation.  In real life, the interface module contains common for different solutions code and auxiliary functions.  The generalized approach makes the code more flexible and simplifies testing. </div><p>Source: <a href="https://habr.com/ru/post/347370/">https://habr.com/ru/post/347370/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../347360/index.html">How we built the data infrastructure in Wish</a></li>
<li><a href="../347362/index.html">Avito in the Russian-speaking PostgreSQL community: open 2018, remember 2017</a></li>
<li><a href="../347364/index.html">The book "Angular and TypeScript. Website building for professionals ¬ª</a></li>
<li><a href="../347366/index.html">The third invasion of the Martians</a></li>
<li><a href="../347368/index.html">Call Tracing Anatomy: Setup Guide</a></li>
<li><a href="../347374/index.html">Apache Ignite.NET 2.4: Slim and Cross Platform</a></li>
<li><a href="../347376/index.html">Automatic assessment of the quality of Wikipedia articles in different languages</a></li>
<li><a href="../347378/index.html">What is common in the interview coder and the game "Snake"?</a></li>
<li><a href="../347380/index.html">7 Steps to a Xamarin Developer Career</a></li>
<li><a href="../347382/index.html">How did I manage to hack and unpack the resources of the old game for PSX</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>