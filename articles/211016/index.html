<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Pocket PaaS with Dokku</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In my last article I mentioned Dokku as an important component of our infrastructure and today I want to reveal this topic in more detail. 

 Dokku is...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Pocket PaaS with Dokku</h1><div class="post__text post__text-html js-mediator-article">  In my <a href="http://habrahabr.ru/company/likeastore/blog/210000/">last article</a> I mentioned Dokku as an important component of our infrastructure and today I want to reveal this topic in more detail. <br><br>  <a href="https://github.com/progrium/dokku">Dokku</a> is a simple Ubuntu server transformation tool in mini-Heroku.  After installing dokku, you get the opportunity to do: <br><br><pre><code class="bash hljs">$ git push production master</code> </pre> <br>  for many popular platforms (Node.js, Java, PHP, Python etc).  As a result of the deployment process, there is a running application, which you can immediately access via <code>http/https</code> . 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  How it works? </h4><br>  If you open <a href="https://github.com/progrium/dokku">the project repository</a> , you can see in the description the line <i>‚ÄúDocker powered mini-Heroku in around 100 lines of Bash‚Äù</i> - about 100 lines of bash code that imitates the work of Heroku.  This is a rather ‚Äúeasy‚Äù implementation, as for such a big problem that it solves. <br><br>  Everything is explained by the fact that Dokku is standing on the shoulders of such technologies as: <a href="https://www.docker.io/">Docker</a> , <a href="https://devcenter.heroku.com/articles/buildpacks">Heroku Buildpacks</a> , <a href="http://nginx.org/">Nginx</a> , <a href="http://git-scm.com/">Git</a> . <br><a name="habracut"></a><br><h5>  Docker </h5><br>  The first and perhaps the most important component is Docker. <br><br>  Docker solves the problem of containers. <br><br>  Containers are a fresh look at application deployment, in which virtualization is considered a classic.  Docker containers have a number of advantages compared to virtual machines, such as the machine's bootstrap time, the size of the image to run, the versioning of the images (with incremental changes), as well as the overall <a href="https://index.docker.io/">index</a> , with the images available for use. <br><br>  Inside the container, you can start a process that will be completely isolated from the external environment, with its operating system, file system and network interface.  At the same time, from the same image, you can run arbitrarily (as long as the machine has enough resources) processes.  You can ‚Äúinherit‚Äù images from each other, for example, if we have an Ubuntu server image, say 1GB, but we want to make our own with MongoDB, the size of the new image will not be 1.3GB but 300MB. <br><br>  <a href="http://docs.docker.io/en/latest/use/builder/">Docker files</a> allow you to ‚Äúconstruct‚Äù the desired image in a declarative form, which you can ‚Äúassemble‚Äù, put into an index, then distribute it to the necessary machines and run them there.  At the same time, Docker ensures that the processes launched inside the container will work in exactly the same way, regardless of the specific machine. <br><br>  Docker images are immutable.  Those.  any, even the most destructive action of the type <code>rm -rf /</code> , will not bring him harm, if the changes are not zakomichny. <br><br>  Docker gathered a very productive community around itself, as well as many large companies like <a href="http://yandex.ru/">Yandex</a> , <a href="http://redhat.com/">Red Hat</a> , <a href="http://facebook.com/">Facebook</a> , <a href="http://spotify.com/">Spotify</a> are adopting this technology. <br><br><h6>  How does Dokku use it? </h6><br>  First of all, Dokku uses its base image, the so-called.  <a href="https://github.com/progrium/buildstep">Buildstep</a> .  From his <a href="https://github.com/progrium/buildstep/blob/master/Dockerfile">docker file</a> , it is clear that this is <code>ubuntu:quantal</code> , on which a number of necessary <a href="https://github.com/progrium/buildstep/blob/master/stack/packages.txt">packages</a> are installed, as well as <a href="https://github.com/progrium/buildstep/blob/master/stack/buildpacks.txt">build packs</a> mainly from Heroku, but also some from the community (for example, for Perl, Dart, Static Apache etc.) <br><br>  Inside the base image there is a script <a href="https://github.com/progrium/buildstep/blob/master/stack/builder">builder</a> , whose task is to ‚Äúsearch‚Äù for the appropriate build for your application and launch it. <br><br><h5>  Heroku Buildpacks </h5><br>  Build packs, this is a set of walking or ruby ‚Äã‚Äãscripts, typically consisting of several files, <a href="https://github.com/heroku/heroku-buildpack-ruby/blob/master/bin/detect">detect</a> , <a href="https://github.com/heroku/heroku-buildpack-ruby/blob/master/bin/compile">compile</a> , <a href="https://github.com/heroku/heroku-buildpack-ruby/blob/master/bin/release">release</a> .  The task of which is to detect whether the application corresponds to the specified type (usually according to the files in the project root, Gemfile - Ruby, package.json - Node.js, etc.), compile and release the application, respectively. <br><br>  The build pack launched inside the container creates all the necessary runtime (downloads the correct Node.js version, or OpenJDK ..), installs all the dependencies needed by the application (npm, maven, pip ..) By the time it finishes, the application will be ready to start . <br><br>  If you used Heroku, then all this output, which is visible on the screen when you push the application in Heroku, is the result of the buildpack. <br><br><h5>  Nginx </h5><br>  Docker has the ability to map network ports that the application uses inside the container to the machine‚Äôs external port.  Dokku passes the port number 5000 into the application. The external one is taken from the port range above 49200. <br><br><pre> <code class="bash hljs">ONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES a60c2af71770 app/app:latest /bin/bash -c /start 30 hours ago Up 30 hours 0.0.0.0:49264-&gt;5000/tcp prickly_curie 9c3c58b649df app/likeastore.com:latest /bin/bash -c /start 47 hours ago Up 47 hours 0.0.0.0:49253-&gt;5000/tcp sad_lumiere 1b55d9087d23 app/tour:latest /bin/bash -c /start 8 days ago Up 8 days 0.0.0.0:49228-&gt;5000/tcp suspicious_wozniak f700b5db1100 app/demo:latest /bin/bash -c /start 2 weeks ago Up 2 weeks 0.0.0.0:49159-&gt;5000/tcp sleepy_heisenberg 4df87e09611d app/analytics:latest /bin/bash -c /start 2 weeks ago Up 2 weeks 0.0.0.0:49153-&gt;5000/tcp tender_curie</code> </pre><br><br>  Traffic from / to the container proxies <a href="http://nginx.org/">Nginx</a> .  It does not need to be configured, Dokku will do it himself.  For all applications, it creates a configuration file, something like this: <br><br><pre> <code class="nginx hljs"><span class="hljs-attribute"><span class="hljs-attribute">upstream</span></span> app { <span class="hljs-attribute"><span class="hljs-attribute">server</span></span> <span class="hljs-number"><span class="hljs-number">127.0.0.1:49264</span></span>; } <span class="hljs-section"><span class="hljs-section">server</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">listen</span></span> [::]:<span class="hljs-number"><span class="hljs-number">80</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">listen</span></span> <span class="hljs-number"><span class="hljs-number">80</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">server_name</span></span> app.likeastore.com; <span class="hljs-attribute"><span class="hljs-attribute">return</span></span> <span class="hljs-number"><span class="hljs-number">301</span></span> https://<span class="hljs-variable"><span class="hljs-variable">$host</span></span><span class="hljs-variable"><span class="hljs-variable">$request_uri</span></span>; }</code> </pre><br><br>  Those.  uses the <a href="http://wiki.nginx.org/HttpUpstreamModule">upstream</a> module for traffic from the container to port 80 of the server. <br><br><h5>  Git </h5><br>  Many people know Git as an excellent version control system.  The range of using Git is wider than just version control, many people call Git a new FTP.  It is git that is used as a source transport to the server. <br><br>  Dokku uses <code>git-hooks</code> , and after the sources are ‚Äúpushed‚Äù to the server, it runs the <code>dokku</code> script.  This is actually the same ‚Äúaround 100 lines of bash‚Äù script, whose task is to create a new docker image from the base (buildstep), launch the ‚Äúbuilder‚Äù script to initialize the environment, launch the application itself and restart nginx. <br><br>  Paying attention to the fact that with each push the application is deployed in a ‚Äúclean‚Äù environment, in a new container created specifically for it. <br><br><h4>  Installation </h4><br>  Everything is described in some detail in the project <a href="https://github.com/progrium/dokku">documentation</a> .  The Bootstrap script will install the necessary dependencies - git, nginx, docker, etc ... And also install the base <code>buildback</code> image. <br><br><h5>  Configuration </h5><br>  After installing Dokku on the server, you need to do 3 things. <br><br>  1. Upload your ssh public key to the server so that you can do git push. <br><br><pre> <code class="bash hljs">$ cat ~/.ssh/id_rsa.pub | ssh root@yourserver.com <span class="hljs-string"><span class="hljs-string">"sudo sshcommand acl-add dokku progrium"</span></span></code> </pre><br><br>  2. In the .git / config of the application you need to configure the remote brunch <br><br><pre> <code class="bash hljs">[remote <span class="hljs-string"><span class="hljs-string">"staging"</span></span>] url = dokku@stage.likeastore.com:app-stage.likeastore.com fetch = +refs/heads/*:refs/remotes/deploy/* [remote <span class="hljs-string"><span class="hljs-string">"production"</span></span>] url = dokku@likeastore.com:app fetch = +refs/heads/*:refs/remotes/deploy/*</code> </pre><br><br>  Note that the names - with a fully qualified name, such as <code>app-stage.likeastore.com</code> , the application will run on <code><a href="http://app-stage.likeastore.com/"></a> app-stage.likeastore.com</code>  <code><a href="http://app-stage.likeastore.com/"></a> app-stage.likeastore.com</code> , and the base name, such as <code>app</code> , on <code><a href="http://app.likeastore.com/"></a> app.likeastore.com</code>  <code><a href="http://app.likeastore.com/"></a> app.likeastore.com</code> . <br><br>  3. In the project root, make a <code>Procfile</code> file that contains instructions for launching the application for Node.js <br><br> <code>web: node app.js</code> <br> <br>  After this, the application is ready for deployment. <br><br><h5>  Deployment </h5><br>  Everything is simple, as stated above: <br><br><pre> <code class="bash hljs">$ git push production master</code> </pre><br><br>  As a result, you will see what looks like the following output: <br><br><pre> <code class="bash hljs">‚Ä∫ git push staging development:master -----&gt; Cleaning up ... -----&gt; Building app-stage.likeastore.com ... Node.js app detected -----&gt; Requested node range: 0.10.x -----&gt; Resolved node version: 0.10.25 -----&gt; Downloading and installing node -----&gt; Restoring node_modules directory from cache -----&gt; Pruning cached dependencies not specified <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> package.json -----&gt; Installing dependencies -----&gt; Caching node_modules directory <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> future builds -----&gt; Cleaning up node-gyp and npm artifacts -----&gt; Building runtime environment -----&gt; Discovering process types Procfile declares types -&gt; web -----&gt; Releasing app-stage.likeastore.com ... -----&gt; Deploying app-stage.likeastore.com ... =====&gt; Application deployed: https://app-stage.likeastore.com To dokku@stage.likeastore.com:app-stage.likeastore.com 77008a6..99dfe55 development -&gt; master</code> </pre><br><br>  After the first deployment, on demand, you can set up <a href="https://github.com/progrium/dokku">environment variables</a> for the application and <a href="https://github.com/progrium/dokku">support SSL</a> . <br><br><h4>  Plugins </h4><br>  The basic Dokku can be considered rather limited, but it expands perfectly with plug-ins. <br><br>  Plugins are divided into several types, <a href="https://github.com/progrium/dokku/wiki/Plugins">datastores</a> - with ready-made storage deployment solutions (MariaDB, PostgreSQL, MongoDB etc.), <a href="https://github.com/progrium/dokku/wiki/Plugins">process managers</a> - to support <a href="https://github.com/progrium/dokku/wiki/Plugins">process managers</a> (Circus, Shoreman etc.) and <a href="https://github.com/progrium/dokku/wiki/Plugins">other</a> - all sorts of useful things (Bower, Grunt, Elasticsearch, SSH Deployment keys). <br><br>  Our experience of using <a href="https://github.com/progrium/dokku">Dokku</a> in <a href="https://likeastore.com/">Likeastore</a> turned out to be very positive, which I sincerely wish you! <br><br>  Shl.  The network has a <a href="http://www.youtube.com/watch%3Fv%3DwoONOr0VXuk">video of</a> my speech on the topic of Dokku, there are some details. </div><p>Source: <a href="https://habr.com/ru/post/211016/">https://habr.com/ru/post/211016/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../211002/index.html">About security in Meteor and not only (part 1)</a></li>
<li><a href="../211004/index.html">E-commerce trends: What is most important for an online store? Part 1</a></li>
<li><a href="../211008/index.html">Impact of Motorola Mobility Absorption by IBM-Lenovo Alliance</a></li>
<li><a href="../211012/index.html">Transparent encryption of network folders in the corporate space</a></li>
<li><a href="../211014/index.html">HGST HelioSeal - a promising platform for the next decade</a></li>
<li><a href="../211018/index.html">Probability in algorithms. Yandex lecture</a></li>
<li><a href="../211020/index.html">About security in Meteor and not only (part 2)</a></li>
<li><a href="../211022/index.html">Use EXPLAIN. Query enhancement</a></li>
<li><a href="../211024/index.html">Proxmox API. Introduction</a></li>
<li><a href="../211026/index.html">You like to read exciting books - love and wear a vest ...</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>