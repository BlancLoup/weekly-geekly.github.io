<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Gazer: backdoor of the second stage of the ART group Turla</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="ESET analyzed the new, previously undocumented backdoor, which is most likely used by the ART group Turla. The backdoor is seen in attacks on governme...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Gazer: backdoor of the second stage of the ART group Turla</h1><div class="post__text post__text-html js-mediator-article">  ESET analyzed the new, previously undocumented backdoor, which is most likely used by the ART group Turla.  The backdoor is seen in attacks on government and diplomatic institutions in Europe.  Turla is a cyber group that specializes in cyber espionage operations.  Typical methods of Turla hackers are <a href="https://habrahabr.ru/company/eset/blog/330446/">watering hole</a> attacks and targeted phishing.  The new backdoor has been actively used since at least 2016.  Based on the lines found in the studied samples, we called it Gazer. <br><br><img src="https://habrastorage.org/web/856/fde/226/856fde226b684510952829d3b5b9ab05.jpg"><br><br><a name="habracut"></a>  Recently, the press remembered the hackers Turla, which has not happened for a long time.  <a href="https://theintercept.com/2017/08/02/white-house-says-russias-hackers-are-too-good-to-be-caught-but-nsa-partner-called-them-morons/">The Intercept</a> reporters recalled the presentation of the Office of Communications Protection Canada (CSE - Communication Security Establishment), which lists the errors of Turla operators.  The presentation authors call the MAKERSMARK cyber group, a summary on the slide below: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/web/fa9/5d8/f26/fa95d8f26e9746bd81be44867b34c412.png"><br><br>  Gazer, like other Turla tools, uses advanced methods of espionage and sustainability in target systems.  We talk about attacks using Gazer and present a technical analysis of the functionality of the backdoor. <br><br><h3>  Summary </h3><br>  According to ESET telemetry, Gazer infected computers in several countries around the world, but mainly in Europe.  The techniques, tactics and procedures ( <a href="http://www.forensicswiki.org/wiki/Cyber_Threat_Intelligence">TTPs</a> ) correspond to the indicators that we usually see in Turla: the first stage backdoor (such as the <a href="https://download.bitdefender.com/resources/media/materials/white-papers/en/Bitdefender-Whitepaper-PAC-A4-en_EN1.pdf">Skipper</a> ), probably delivered by targeted phishing;  the appearance of the second stage backdoor in the infected system, in this case Gazer.  According to our research, the main goals of Gazer are in South-Eastern Europe and the former Soviet republics. <br><br>  Currently, we do not have exhaustive evidence of Gazer‚Äôs belonging to the Turla group, but several clues indicate this.  First, the targets correspond to the area of ‚Äã‚Äãinterest of Turla - the ministry of foreign affairs and the embassy.  Secondly, Turla is indicated by methods - targeted phishing, installation of the backdoor of the first stage, hidden backdoor of the second stage.  In most cases, along with Gazer, the backdoor of the first stage Skipper, also associated with Turla, is found.  Thirdly, there are a number of common features of Gazer and other second-stage backdoors used by Turla, such as <a href="https://www.welivesecurity.com/2017/03/30/carbon-paper-peering-turlas-second-stage-backdoor/">Carbon</a> and <a href="https://researchcenter.paloaltonetworks.com/2017/05/unit42-kazuar-multiplatform-espionage-backdoor-api-access/">Kazuar</a> . <br><br>  As usual, the Turla team seeks to avoid detecting tools by safely deleting files, changing strings, and randomizing.  In the last version studied, the authors of Gazer modified most of the lines by adding sentences related to video games to the code.  The example in the figure below: <br><br><img src="https://habrastorage.org/web/2b5/fd2/367/2b5fd2367d93465b9319769ad69114c6.png"><br><br><h3>  Similarities with other Turla tools </h3><br>  Gazer is written in C ++ and has common features with other Turla tools.  Gazer, Carbon and Kazuar backdoors receive encrypted tasks from a remote C &amp; C server that can be performed on the infected system or on another machine on the network.  All of them use encrypted storage for malware components and configuration, and also record operations in a file. <br><br>  The list of C &amp; C servers is encrypted and built into the resources of PE Gazer.  These are legitimate compromised sites (mostly on Wordpress), which act as a first-level proxy.  Tactics are typical for the Turla group. <br><br>  Another interesting connection is that one of the C &amp; C servers built into the Gazer sample was used by the backdoor in JScript <a href="https://securelist.com/kopiluwak-a-new-javascript-payload-from-turla/77429/">KopiLuwak</a> , which was disassembled by Kaspersky Lab. <br><br>  Last but not least.  The three families of malicious programs (Gazer, Carbon and Kazuar) have a similar list of processes that can be used as a target for implementing a module for communicating with a C &amp; C server.  A resource containing this list may vary from one sample to another.  It is most likely adapted to what is installed on the system (for example, in some samples the safari.exe process appears in the list). <br><br><h3>  Custom encryption </h3><br>  Gazer authors are actively using encryption.  It seems that instead of the Windows Crypto API and other public libraries, they use their own library for 3DES and RSA. <br><br>  The RSA keys embedded in the resources contain the attacker's public key, which is used to encrypt data sent to the C &amp; C server and the private key to decrypt the resources in a binary file.  Each sample has its own unique keys. <br><br>  These resources are structured in the same way as <a href="https://wiki.openssl.org/index.php/Manual:Rsa(3)">RSA from OpenSSL</a> , but their values ‚Äã‚Äã(p, q, etc.) are calculated in a custom implementation of the authors Gazer. <br><br><h3>  Global architecture </h3> <br>  In the section we describe in detail the components of Gazer - its architecture is shown in the figure below: <br><br><img src="https://habrastorage.org/web/716/3e7/a8a/7163e7a8af8748d197e3defc5c3b70e3.png"><br><br>  <b>Loader</b> <br><br>  The loader is the first component of the malware that runs on the system.  Two resources are stored unencrypted in a binary file: <br>  101: name of the process in which the orchestrator is embedded <br>  102: orchestrator <br><br>  The following mutex ensures that only one instance of the malware is executed: <br> <code>{531511FA-190D-5D85-8A4A-279F2F592CC7}</code> <br> <br>  <b>Creating a named pipe</b> <br><br>  To establish a communication channel between Gazer components, a named pipe has been launched.  It is created from this line: <br> <code>\\\\.\\pipe\\Winsock2\\CatalogChangeListener-FFFF-F <br></code> <br>  The FFFF-F pattern is replaced by the values ‚Äã‚Äãcalculated from the security identifier (SID) of the current user and the timestamp. <br><br>  Consider, for example, the current date 2017/04/24 and SID: <code>S-1-5-21-84813077-3085987743-2510664113-1000</code> <br><br>  To create a pattern at the end of a named pipe, the following calculations are performed: <br><br> <code>time = SystemTime.wDay * Systemtime.wMonth * SystemTime.wYear = 24 * 04 * 2017 = 0x2f460 <br> xsid = (1 * 21 * 84813077 * 3085987743 * 2510664113 * 1000) &amp; 0xFFFFFFFF = 0xefa252d8 <br> <br> ((time &gt;&gt; 20) + (time &amp; 0xFFF) + ((time &gt;&gt; 12) &amp; 0xFFF)) % 0xFF = 0x93 <br> ((xsid &gt;&gt; 20) + (xsid &amp; 0xFFF) + ((xsid &gt;&gt; 12) &amp; 0xFFF)) % 0xFF = 0x13 <br> <br> ((time * xsid &gt;&gt; 24) + (uint8_t)(time * xsid) + ((uint16_t)(time * xsid) &gt;&gt; 8) + (uint8_t)(time * xsid &gt;&gt; 16)) % 0xf) = 0xa</code> <br> <br>  Named channel in this case: <br> <code>\\\\.\\pipe\\Winsock2\\CatalogChangeListener-9313-a <br></code> <br>  If the current user‚Äôs SID cannot be recovered, the default named pipe is used by default: <br> <code>\\\\.\\pipe\\\Winsock2\\CatalogChangeListener-FFFE-D</code> <br> <br>  <b>Code injection through stream capture</b> <br><br>  To introduce the orchestrator into the remote process, a not too common method is used. <br><br>  The executing thread from the remote process is intercepted to launch the shellcode, which will execute the entry point of the communication module. <br><br>  1. The module and shellcode are copied to the remote process; <br>  2. The <code>ZwQuerySystemInformation</code> function <code>ZwQuerySystemInformation</code> used to retrieve the total number of threads executed in the target process; <br>  3. The following operations are performed in each stream: <br><br><ul><li>  thread suspended by the <code>OpenThread/SuspendThread</code> ; </li><li>  the thread context is retrieved using <code>GetThreadContext</code> ; </li><li>  The stream command pointer is saved and modified to point to the shellcode (via <code>SetThreadContext</code> ); </li><li>  the thread is resumed using <code>ResumeThread</code> . </li></ul><br>  4. If one of the previous operations is not performed, the flow is resumed and the same operations are performed in another flow. <br><br> <code>launcher: <br> push rax <br> sub rsp, 38h <br> movabs rax, 5D20092 ; @ end of payload <br> mov qword ptr ss:[rsp+28], rax ; lpThreadId <br> mov qword ptr ss:[rsp+20], 0 ; dwCreationFlags <br> xor r9d, r9d ; lpParameter <br> movabs r8, 5D20046 ; lpStartAddress =&gt; @payload <br> xor edx, edx ; dwStackSize = 0 <br> xor ecx, ecx ; lpThreadAttributes = NULL <br> call qword ptr ds:[CreateThread] <br> movabs rax, 90A7FACE90A7FACE ; replaced by the saved instruction pointer from thread context ;) <br> add rsp, 38h <br> xchg qword ptr ss:[rsp], rax <br> ret <br> <br> payload: <br> sub rsp, 28 <br> movabs r8, 5D20096 <br> mov edx, 1 <br> movabs rcx, 4000000000000000 <br> call qword ptr ds: [DllEntryPoint] <br> xor ecx, ecx <br> call ExitThread <br> int 3 <br> xxxx; @DllEntryPoint <br> xxxx ; @CreateThread <br> xxxx; @ExitThread <br> xxxx <br> xxxx <br> xxxx <br> xxxx ; TID</code> <br> <br>  The shellcode is the loader that will execute the entry point of the module in the new stream. <br><br>  <b>Saving data</b> <br><br>  The loader sends binary data through the named pipe to the orchestrator.  Blob contains: <br><br><ul><li>  team ID: <code>CMC_TAKE_LOADER_BODY</code> </li><li>  bootloader file path </li><li>  PE loader </li></ul><br>  When the message is received by the orchestrator, the loader is safely removed by overwriting the contents of the file and using the <code>DeleteFile</code> function. <br><br>  Information on persistence is extracted from resource 105 and stored in Gazer.  Among these data is the value of <code>dword</code> , which is used to select the mode of saving data. <br><br>  Resource 105 is structured as follows: <br><br><ul><li>  <code>dword</code> value indicates data saving mode </li><li>  <code>dword</code> value indicates the amount of data </li><li>  data storage information </li></ul><br>  There are six different data storage modes. <br><br>  <b>0: ShellAutorun</b> <br>  Persistence is achieved through the Windows registry by adding a Shell parameter with the value of <code>explorer.exe, %malware_pathfile%</code> for the following key: <br> <code>HKCU\Software\Microsoft\Windows NT\CurrentVersion\Winlogon</code> <br> <br>  <b>1: HiddenTaskAutorun</b> <br>  Very similar to the TaskScheduler Autorun (4) method, described below.  The main difference is that the task is hidden from the user with the help of the <code>TASK_FLAG_HIDDEN</code> attribute (set via the <code>SetFlags</code> method from the <code>Itask</code> interface). <br><br>  <b>2: ScreenSaverAutorun</b> <br>  In this mode, Gazer provides persistence by installing in the Windows system registry an executable file used as a screensaver. <br><br>  Most of the parameters are created in the registry branch <code>HKCU\Control Panel\Desktop</code> : <br><br><ul><li>  <code>SCRNSAVE.exe</code> path to the malicious executable file </li><li>  <code>ScreenSaveActive</code> value - 1: enable screensaver </li><li>  <code>ScreenSaverIsSecure</code> value - 0: the screensaver is not password protected </li><li>  <code>ScreenSaveTimeout</code> set to the value specified in the resource.  Indicates how long the system remains in standby mode before launching the screensaver (in this case, malware). </li></ul><br>  <b>3: StartupAutorun</b> <br>  If resource 105 starts with <code>dword</code> 3, an LNK file will be created in the Start menu.  The resource also provides the label file description, path and file name for LNK. <br><br>  The <code>IshellLink</code> interface <code>IshellLink</code> used to create a shell reference. <br><br>  <b>4: TaskSchedulerAutorun</b> <br>  The method is used to achieve persistence by creating a scheduled task. <br>  A task is created and configured via COM-related task interfaces ( <code>ITaskService, ITaskSettings, ‚Ä¶</code> ). <br><br>  Some information, in particular, the name of the task and its description, is extracted from the resource.  For example, in one of the sample resources, the data saving mode is set to 04 ( <code>TaskSchedulerAutorun</code> ) with data: <br><br> <code>%APPDATA%\Adobe\adobeup.exe Adobe Acrobat Reader Updater. This task was generated by Adobe Systems, Inc to keep your Adobe Software up-to-data. \Adobe\AcrobatReader.Adobe <br></code> <br>  In this example, a scheduled task is created and configured as follows: <br><br>  1. Task name: <code>"Adobe Acrobat Reader Updater"</code> <br>  2. Executable file: <code>"%APPDATA%\Adobe\adobeup.exe"</code> <br>  The orchestrator will copy the bootloader obtained via the named pipe in this location. <br>  3. Task description: <code>"  Adobe Systems, Inc      Adobe"</code> <br>  4. Task folder: <code>\Adobe\AcrobatReader.Adobe <br></code> <code>\Adobe\AcrobatReader.Adobe <br></code> <br>  Finally, the task is configured to run by the task scheduler at any time after the scheduled one.  The task will be started when the current user is logged in. <br><br>  <b>5: LinkAutorun</b> <br>  The method modifies existing LNK files to execute malware through cmd.exe. <br>  For each LNK file in the folder specified in the resource, the icon and arguments are deleted.  The path to cmd.exe is set with an argument: <br> <code>/q /c start "%s" &amp;&amp; start "%s"</code> <br> <br>  In most of the samples we studied, the configuration file indicates that the TaskSchedulerAutorun method should be used. <br><br>  <b>Magazines</b> <br><br>  All three Gazer components record actions in log files.  They are encrypted using the same algorithm - 3DES. <br><br>  In some versions of Gazer, these files are easy to get, because their names are hard-coded in binary files: <br><br><ul><li>  <code>%TEMP%\CVRG72B5.tmp.cvr</code> : bootloader logs </li><li>  <code>%TEMP%\CVRG1A6B.tmp.cvr</code> : Orchestrator Journals </li><li>  <code>%TEMP%\CVRG38D9.tmp.cvr</code> : Communications Module Logs </li></ul><br>  Each log file is structured as follows: <br>  [LOGSIZE] [DECRYPTION_KEY] [ENCRYPTED_LOG] <br><br><ul><li>  logsize: when this value (2 bytes) is subtracted from the magic number 0xf18b, we get the size of the encrypted log. </li><li>  decryption_key: when this 12-byte blob is encrypted using HOR with another 12-byte hard-coded key, we get the 3DES key, which can be used to decrypt the log </li><li>  encrypted_log: the log is encrypted using the 3DES algorithm in CBC mode </li></ul><br>  After decryption, each log entry is formatted as follows: <br>  | Hour: Min: Sec: Ms |  [log ID] [log] <br><br>  Below is an example with the decrypted log file of the orchestrator: <br><br> <code>|10:29:56:197| [1556] <br> |10:29:56:197| [1557] ****************************************************************************************** <br> |10:29:56:197| [1558] DATE: 25.05.2017 <br> |10:29:56:197| [1559] PID=900 TID=2324 Heaps=32 C:\Windows\Explorer.EXE <br> |10:29:56:197| [1565] DLL_PROCESS_ATTACH <br> |10:29:56:197| [1574] 4164 <br> |10:29:58:197| [0137] ========================================================================== <br> |10:29:58:197| [0138] Current thread = 2080 <br> |10:29:58:197| [0183] Heap aff0000 [34] <br> |10:29:58:197| [0189] ### PE STORAGE ### <br> |10:29:58:197| [0215] ### PE CRYPTO ### <br> |10:29:58:197| [0246] ### EXTERNAL STORAGE ### <br> |10:29:58:197| [1688] Ok <br> |10:29:58:197| [0279] Path = \HKCU\Software\Microsoft\Windows\CurrentVersion\Explorer\ScreenSaver <br> |10:29:58:197| [0190] \HKCU\Software\Microsoft\Windows\CurrentVersion\Explorer\ScreenSaver <br> |10:29:58:197| [0338] ---FAILED <br> |10:29:58:197| [0346] Initializing standart reg storage... <br> |10:29:58:197| [0190] Software\Microsoft\Windows\CurrentVersion\Explorer\ScreenSaver <br> |10:29:58:197| [2605] Storage is empty! <br> |10:29:58:197| [0392] ### EXTERNAL CRYPTO ### <br> |10:29:59:666| [1688] Ok <br> |10:29:59:713| [1473] Ok <br> |10:29:59:760| [1688] Ok <br> |10:29:59:775| [1473] Ok <br> |10:29:59:775| [1688] Ok <br> |10:29:59:775| [1473] Ok <br> |10:29:59:791| [1688] Ok <br> |10:29:59:791| [1473] Ok <br> |10:29:59:806| [1688] Ok <br> |10:29:59:806| [1473] Ok <br> |10:29:59:806| [0270] 08-00-27-90-05-2A <br> |10:29:59:806| [0286] _GETSID_METHOD_1_ <br> |10:29:59:806| [0425] 28 7 8 122 <br> |10:29:59:806| [0463] S-1-5-21-84813077-3085987743-2510664113-1000 <br> |10:29:59:806| [0471] <br> |10:29:59:806| [0787] Ok <br> |10:29:59:806| [1473] Ok <br> |10:29:59:822| [0514] ### QUEUES ### <br> |10:29:59:822| [0370] T Empty <br> |10:29:59:822| [0482] R Empty <br> |10:29:59:822| [1754] Ok <br> |10:29:59:822| [1688] Ok <br> |10:29:59:822| [1473] Ok <br> |10:29:59:838| [0505] R #4294967295 PR_100 TR_00000000 SZ_172 SC_0(50) --+- EX_0 <br> |10:29:59:838| [0625] ### TRANSPORT ### <br> |10:29:59:838| [0286] _GETSID_METHOD_1_ <br> |10:29:59:838| [0425] 28 7 25 122 <br> |10:29:59:838| [0463] S-1-5-21-84813077-3085987743-2510664113-1000 <br> |10:29:59:838| [0471] <br> |10:29:59:838| [0165] \\.\pipe\Winsock2\CatalogChangeListener-2313-4 <br> |10:29:59:838| [0131] PipeName = \\.\pipe\Winsock2\CatalogChangeListener-2313-4 <br> |10:29:59:838| [0041] true <br> [...]</code> <br> <br>  Note that in older versions of Gazer, the ‚Äúlog ID‚Äù is replaced with the name of the current function. <br><br><h3>  Working directory </h3><br>  <b>Using the Windows Registry</b> <br><br>  All files related to Gazer (except logs) are stored in an encrypted form in the registry. <br>  The resource of the orchestrator 109 contains the root path of the repository (in the report it is called <code>%RootStoragePath%</code> ).  In each sample we studied, this resource indicated the same storage path: <br> <code>HKCU\Software\Microsoft\Windows\CurrentVersion\Explorer\ScreenSaver</code> <br> <br>  If this resource is empty, the registry key is used by default.  With the exception of RSA keys, all data in the vault is encrypted. <br><br>  Several subdirectories are created (their names are hardcoded in binary format): <br><br> <code>%RootStoragePath%{119D263D-68FC-1942-3CA3-46B23FA652A0}</code> <br>  Object ID: a unique ID to identify the victim <br><br> <code>%RootStoragePath%{1DC12691-2B24-2265-435D-735D3B118A70}</code> <br>  Task Queue: a linked list of running tasks <br><br> <code>%RootStoragePath%{28E74BDA-4327-31B0-17B9-56A66A818C1D}</code> <br>  Plugins <br><br> <code>%RootStoragePath%{31AC34A1-2DE2-36AC-1F6E-86F43772841F}</code> <br>  Communication Module: DLL to communicate with the C &amp; C server <br><br> <code>%RootStoragePath%{3CDC155D-398A-646E-1021-23047D9B4366}</code> <br>  Autorun: persistence method <br><br> <code>%RootStoragePath%{4A3130BD-2608-730F-31A7-86D16CE66100}</code> <br>  Local Transport Settings: IP addresses of computers on the same network <br><br> <code>%RootStoragePath%{56594FEA-5774-746D-4496-6361266C40D0}</code> <br>  Last Connection: time of the last connection with the C &amp; C server (SYSTEMTIME) <br><br> <code>%RootStoragePath%{629336E3-58D6-633B-5182-576588CF702A}</code> <br>  RSA Private Key: generated in process, used to decrypt Gazer data <br><br> <code>%RootStoragePath%{6CEE6FE1-10A2-4C33-7E7F-855A51733C77}</code> <br>  Result Queue: a linked list of task results <br><br> <code>%RootStoragePath%{81A03BF8-60AA-4A56-253C-449121D61CAF}</code> <br>  Inject Settings: a list of processes that are used to implement the communication module <br><br> <code>%RootStoragePath%{8E9810C5-3014-4678-27EE-3B7A7AC346AF}</code> <br>  C &amp; C Servers <br><br>  <b>Using alternative data streams</b> <br><br>  If registry access is not available, these configuration items are retained using alternative data streams. <br><br>  The <code>GetVolumeInformation()</code> function is <code>GetVolumeInformation()</code> to ensure that the C: \\ drive supports named streams for ADS use. <br><br>  The same GUIDs as above are used to hide data in ADS for a file (hardcoded in binary format): <br> <code>"%TEMP%\\KB943729.log" <br></code> <br>  For example, here is the full path to access the object ID: <br> <code>%TEMP%\KB943729.log:{1DC12691-2B24-2265-435D-735D3B118A70}</code> <br> <br><h3>  Orchestrator </h3><br>  <b>Gazer Resources</b> <br><br>  Files associated with Gazer are stored in the resources of the orchestrator. <br><br>  <b>File format</b> <br><br>  A total of 11 resources (from 101 to 111) are structured as follows: <br>  DATATYPE |  SIZE |  DATA |  Padding <br><br>  DATATYPE: <code>dword</code> specifies the data type of the resource: <br><br><ul><li>  0: primary data </li><li>  0xFFFFFFFF: empty </li><li>  0x4: not defined </li><li>  0x1030001: array of strings </li><li>  0x1: binary format </li></ul><br>  SIZE: the amount of data (without filling) <br><br>  <b>Encryption</b> <br><br>  With the exception of resources 101 and 102, which are RSA keys, each resource is packed using Bzip and encrypted with 3DES. <br><br>  [RSAEncryptedBlob] [SignatureBlob] [3DESBlob] <br><br><ul><li>  RSAEncryptedBlob: The first 1024 bits of data represent a blob that contains the 3DES key.  Blob is encrypted using RSA and can be decrypted using resource 101. </li><li>  SignatureBlob: the second part of the data is a 1024-bit blob containing the signature of the last part of the data that was decrypted. </li><li>  3DESBlob: the last part is the actual data that is encrypted with the 3DES key from the first blob. </li></ul><br>  Each resource is decrypted dynamically.  The signature is checked against the decrypted data to verify integrity.  Further, the resource will be encrypted with the new RSA key, which was randomly created in the orchestrator code.  The private key and the encrypted resource are stored in the registry under a certain subkey GUID. <br><br>  <b>Resource List:</b> <br><br><ul><li>  101: The resource contains a private RSA key.  It is used to decrypt other resources. </li><li>  102: RSA public key. </li><li>  103: empty </li><li>  104: not determined </li><li>  105: data saving information </li><li>  106: List of processes used to implement a communication module. </li><li>  107: DLL for communicating with C &amp; C servers </li><li>  108: list of C &amp; C servers </li><li>  109: Gazer Work Directory Path </li><li>  110: list of plugins </li><li>  111: local data transfer information </li></ul><br>  <b>Task performance</b> <br><br>  The task received from the C &amp; C server is performed by the infected machine or another computer on the network through the P2P mechanism (as in Carbon and Snake). <br><br>  Possible tasks: <br><br><ul><li>  send file </li><li>  upload file </li><li>  update configuration </li><li>  execute the command </li></ul><br>  The result is stored in the queue and will be sent to the module, which will contact the C &amp; C server when the Internet is available. <br><br>  <b>Class hierarchy</b> <br><br>  The malicious program is written in C ++ and <a href="https://en.wikipedia.org/wiki/Run-time_type_information">RTTI</a> , which contains information about the objects used in the code, is not overwritten. <br><br>  There are five abstract classes: <br><br><img src="https://habrastorage.org/web/77d/a15/23b/77da1523b0014aa9873439e909e1b742.png"><br><img src="https://habrastorage.org/web/147/594/d59/147594d59cfd4d9b88619c72521ab3eb.png"><br><br><h3>  Communication module </h3><br>  The communication module is used to retrieve tasks from the C &amp; C server and transfer them to the orchestrator. <br><br>  The library is being introduced into a process that can legitimately access the Internet.  The library is the same as in the bootloader, which is used to enter the orchestrator in <code>explorer.exe</code> . <br><br>  <b>Communication initialization</b> <br><br>  If a proxy server exists, it is retrieved and used by Gazer to execute HTTP requests.  There are two methods for obtaining this value: <br>  query this registry <code>HKCU\Software\Microsoft\Windows\CurrentVersion\Internet Settings</code> or use the <code>InternetQueryOption</code> function with the <code>INTERNET_OPTION_PROXY</code> flag if the proxy server cannot be obtained through the registry. <br><br>  Next, the system user agent is configured: <br><br><ul><li>  retrieves the value of the User Agent data key for the <code>HKCU\Software\Microsoft\Windows\Current Version\Internet Settings</code> key; </li><li>  lists the key values ‚Äã‚Äãin the <code>HKLM\Software\Microsoft\Windows\Current Version\Internet Settings\5.0\User Agent\Post Platform</code> section;  those that have IEAK as data are connected to a user agent; </li><li>  if a user agent is not found in the registry, then <code>Mozilla/4.0 (compatible; MSIE 6.0)</code> hard-coded UA is used </li></ul><br>  Before attempting to access the C &amp; C server, the Internet connection is checked.  One by one, the following servers are requested: <br><br><ul><li> <code>update.microsoft.com</code> </li> <li> <code>microsoft.com</code> </li> <li> <code>windowsupdate.microsoft.com</code> </li> <li> <code>yahoo.com</code> </li> <li> <code>google.com</code> </li> </ul><br>  <b>Communication with the C &amp; C server</b> <br><br>  The malicious program interacts with the C &amp; C server to retrieve tasks (via HTTP GET requests) and send execution results (via HTTP POST requests). <br><br>  Before sending a request to the server, the <code>CMC_GIVE_SETTINGS</code> command is transmitted to the <code>CMC_GIVE_SETTINGS</code> via the communication channel (named pipe, more details in the next section).  The message ( <code>MSG</code> ) contained in the packet, in this case, is the one byte set by the orchestrator for the status <br><br>  Before sending a request for C &amp; C, the CMC_GIVE_SETTINGS team is sent to the orchestra through their communication channel (named pipe, more on this in the next section).  The CMC_GIVE_SETTINGS message contained in the packet, in this case, is one byte set by the orchestra for the status of the result of the command. <br><br>  The orchestrator responds in the same channel with the settings obtained from the working directory with the object identifier, the list of C &amp; C servers and the date of the last connection. <br>  To receive the task from the C &amp; C server, a GET request is made. <br><br>  GET request parameters are selected from a hard-coded list of keywords that does not look suspicious.  Values ‚Äã‚Äãare generated randomly in [a-z0-9] encoding with a random size for each parameter: <br>  ‚Ä¢ <code>id</code> [6-12] <br>  ‚Ä¢ <code>hash</code> [10-15] <br>  ‚Ä¢ <code>session</code> [10-15] <br>  ‚Ä¢ <code>photo</code> [6-10] <br>  ‚Ä¢ <code>video</code> [6-10] <br>  ‚Ä¢ <code>album</code> [6-10] <br>  ‚Ä¢ <code>client</code> [5-10] <br>  ‚Ä¢ <code>key</code> [5-10] <br>  ‚Ä¢ <code>account</code> [6-12] <br>  ‚Ä¢ <code>member</code> [6-12] <br>  ‚Ä¢ <code>partners</code> [5-10] <br>  ‚Ä¢ <code>adm</code> [6-12] <br>  ‚Ä¢ <code>author</code> [6-12] <br>  ‚Ä¢ <code>contact</code> [6-12] <br>  ‚Ä¢ <code>content</code> [6-12] <br>  ‚Ä¢ <code>user</code> [6-12] <br><br>  Here are some examples of such queries: <br> <code>xxx.php?album=2ildzq&amp;key=hdr2a&amp;partners=d2lic33f&amp;session=nurvxd2x0z8bztz&amp;video=sg508tujm&amp;photo=4d4idgk <br> xxx.php?photo=he29zms5fc&amp;user=hvbc2a&amp;author=xvfj5r0q9c&amp;client=7mvvc&amp;partners=t4mgmuy&amp;adm=lo3r6v4 <br> xxx.php?member=ectwzo820&amp;contact=2qwi15&amp;album=f1qzoxuef4&amp;session=x0z8bztz8hrs65f&amp;id=t3x0ftu9 <br> xxx.php?partners=ha9hz9sn12&amp;hash=5740kptk3acmu&amp;album=uef4nm5d&amp;session=dpeb67ip65f&amp;member=arj6x3ljj <br> xxx.php?video=nfqsz570&amp;client=28c7lu2&amp;partners=818eguh70&amp;contact=ibj3xch&amp;content=1udm9t799ixr&amp;session=5fjjt61qred9uo</code> <br> <br>  For each request (send, receive, connect) a ten minute timeout is set using <code>InternetSetOption</code> . <br><br>  After sending the request, the response is processed only if the returned HTTP status identifier is 404. <br><br>  The content of the response is encrypted and can be decrypted using a private RSA key generated by the orchestrator.  It contains blob and md5 data hash. <br><br>  If the response size is 20 bytes (4-byte blob + hash), there are no tasks to retrieve. <br>  The <code>CMC_TAKE_TASK</code> team <code>CMC_TAKE_TASK</code> sent to the orchestra with an encrypted task received from the C &amp; C server and its size.  The orchestrator will be responsible for the task and will send the results to the communication module.  The resulting execution result (encrypted by the orchestrator) will be transmitted to the C &amp; C server using the POST request in the same way as for the GET request (using parameters with random values). <br><br>  <b>Messages between components</b> <b><br></b> <br>  The global named pipe is used for communication between various components.  Data sent through it is formatted as follows: <br><br><img src="https://habrastorage.org/web/c89/032/db3/c89032db37c1413e9add9f49c08fa3ac.png"><br>  Figure 4. Message Format <br><br>  DATATYPE: the same constants are used for resources (the File Format section in the ‚ÄúResources‚Äù chapter) <br>  ID_CMD: command name (see below) <br>  MSG: data to send <br><br>  List of messages: <br><br> <code>CMC_TAKE_TASK (ID_CMD: 1)</code> <br>  The task received from the C &amp; C server is sent to the orchestrator, which stores it in the task queue. <br><br> <code>CMC_TAKE_LOADER_BODY (ID_CMD: 2)</code> <br>  Delete the Gazer loader file, set up a copy of the loader and permanently store it in accordance with one of the resources <br><br> <code>CMC_GIVE_RESULT (ID_CMD: 4)</code> <br>  After receiving the message, the orchestrator will extract the result of the task from the results queue, package and encrypt it with the RSA public key (resource 102) and send a blob to the communication module, which will send it to the server (POST request). <br><br> <code>CMC_GIVE_SETTINGS (ID_CMD: 5)</code> <br>  The communication module sends this message to the orchestrator to request the information needed to contact the server (list of C &amp; C servers, last connection time, victim ID). <br><br> <code>CMC_TAKE_CONFIRM_RESULT (ID_CMD: 6)</code> <br>  When the communication module sends the result of the task to the server, a message is sent to the orchestrator instructing to remove the result from the queue. <br><br> <code>CMC_TAKE_CAN_NOT_WORK (ID_CMD: 7)</code> <br>  If the operation fails (for example, if the communication module cannot correctly interpret the data received from the orchestrator), a message with the last error code is sent to the orchestrator.  Code can be added to the log file. <br><br> <code>CMC_TAKE_UNINSTALL (ID_CMD: 8)</code> <br>  Used to delete files from disk. <br><br> <code>CMC_TAKE_NOP (ID_CMD: 9)</code> <br>  No operations <br><br> <code>CMC_NO_CONNECT_TO_GAZER (ID_CMD: 0xA)</code> <br>  A team is sent to the orchestra when the communication module cannot communicate with any server.  In this case, if the results of the task are in the queue, they will be encrypted and saved to the Gazer system. <br><br> <code>CMC_TAKE_LAST_CONNECTION (ID_CMD: 0xB)</code> <br>  The team is sent from the communication module to the orchestrator each time the attackers contact the controller server.  Contains a SystemTime structure (with current system time).  When messages are received by the orchestrator, the time of the last connection will be packed and encrypted in the Gazer storage (in the registry or in ADS). <br><br> <code>CMC_GIVE_CACHE / CMC_TAKE_CACHE (ID_CMD: 0xC / 0xD)</code> <br>  Not implemented <br><br><h3>  Versions of Gazer </h3><br><br>  Four versions of the malware have been detected. <br><br>  In the first version, the function used to write logs has the real name of the function as a parameter.  There are various methods of code injection. <br><br>  In the second version, the function names used as parameters are replaced by an identifier.  Only one method is used for code injection. <br><br>  Some samples from the first versions are signed with a valid Comodo certificate issued by Solid Loop Ltd.  The compilation is dated 2002, but may be forged since the certificate was issued in 2015.  Below are the certificates used to sign Gazer versions: <br><br><img src="https://habrastorage.org/web/62b/978/2e5/62b9782e563f4642864639fc93f601aa.png"><br><br>  Latest versions are signed with another certificate - Ultimate Computer Support Ltd.  Some efforts have been made to obfuscate strings, which can be used as indicators of compromise.  The name of the mutex and the named pipe are no longer displayed in clear text, it is now encoded with the XOR key. <br><br>  In previous versions, the log file names were hardcoded in a binary file.  Now to generate a random file name, the function GetTempFileNameA is used. <br>  The latest versions compiled in 2017 differ in journal messages (although they have the same meaning).  For example, <code>PE STORAGE</code> replaced by <code>EXE SHELTER</code> , <code>PE CRYPTO</code> to <code>EXE CIPHER</code> and others. <br><br>  Finally, the fake compile time stamp is no longer used. <br><br>  <i>A complete list of compromise indicators is available in our <a href="https://github.com/eset/malware-ioc/tree/master/turla">account</a> on GitHub.</i>  <i>For any questions regarding Turla / Gazer, email threatintel@eset.com.</i> <br><br><h3>  Iocs </h3><br>  <b>File Names:</b> <br> <code>%TEMP%\KB943729.log <br> %TEMP%\CVRG72B5.tmp.cvr <br> %TEMP%\CVRG1A6B.tmp.cvr <br> %TEMP%\CVRG38D9.tmp.cvr <br> %TEMP%\~DF1E06.tmp <br> %HOMEPATH%\ntuser.dat.LOG3 <br> %HOMEPATH%\AppData\Local\Adobe\AdobeUpdater.exe</code> <br> <br>  <b>Registry keys:</b> <br> <code>HKCU\Software\Microsoft\Windows\CurrentVersion\Explorer\ScreenSaver <br> HKCU\Software\Microsoft\Windows NT\CurrentVersion\Explorer\ScreenSaver</code> <br> <br>  <b>C &amp; C:</b> <br> <code>daybreakhealthcare.co.uk/wp-includes/themees.php <br> simplecreative.design/wp-content/plugins/calculated-fields-form/single.php <br> 169.255.137.203/rss_0.php <br> outletpiumini.springwaterfeatures.com/wp-includes/pomo/settings.php <br> zerogov.com/wp-content/plugins.deactivate/paypal-donations/src/PaypalDonations/SimpleSubsribe. <br> php <br> ales.ball-mill.es/ckfinder/core/connector/php/php4/CommandHandler/CommandHandler.php <br> dyskurs.com.ua/wp-admin/includes/map-menu.php <br> warrixmalaysia.com.my/wp-content/plugins/jetpack/modules/contact-form/grunion-table-form.php <br> 217.171.86.137/config.php <br> 217.171.86.137/rss_0.php <br> shinestars-lifestyle.com/old_shinstar/includes/old/front_footer.old.php <br> www.aviasiya.com/murad.by/life/wp-content/plugins/wp-accounting/inc/pages/page-search.php <br> baby.greenweb.co.il/wp-content/themes/san-kloud/admin.php <br> soligro.com/wp-includes/pomo/db.php <br> giadinhvabe.net/wp-content/themes/viettemp/out/css/class.php <br> tekfordummies.com/wp-content/plugins/social-auto-poster/includes/libraries/delicious/Delicious.php <br> kennynguyen.esy.es/wp-content/plugins/wp-statistics/vendor/maxmind-db/reader/tests/MaxMind/Db/ <br> test/Reader/BuildTest.php <br> sonneteck.com/wp-content/plugins/yith-woocommerce-wishlist/plugin-fw/licence/templates/panel/ <br> activation/activation.php <br> chagiocaxuanson.esy.es/wp-content/plugins/nextgen-gallery/products/photocrati_nextgen/modules/ <br> ngglegacy/admin/templates/manage_gallery/gallery_preview_page_field.old.php <br> hotnews.16mb.com/wp-content/themes/twentysixteen/template-parts/content-header.php <br> zszinhyosz.pe.hu/wp-content/themes/twentyfourteen/page-templates/full-hight.php <br> weandcats.com/wp-content/plugins/broken-link-checker/modules/checkers/http-module.php <br></code> <br>  <b>Mutexes:</b> <br> <code>{531511FA-190D-5D85-8A4A-279F2F592CC7}</code> </div><p>Source: <a href="https://habr.com/ru/post/336804/">https://habr.com/ru/post/336804/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../336790/index.html">The practice of forming requirements for IT projects from A to Z. Part 2. Objectives and Needs</a></li>
<li><a href="../336792/index.html">Social media mining at ITMO University</a></li>
<li><a href="../336796/index.html">Low branch trees</a></li>
<li><a href="../336798/index.html">Kotlin: combat use experience</a></li>
<li><a href="../336800/index.html">Education from Mail.Ru Group: telling live on Tehnostrim about training opportunities</a></li>
<li><a href="../336810/index.html">How to earn on ICO? And how to do it is not necessary</a></li>
<li><a href="../336812/index.html">Lazy Loading in Entity Framework</a></li>
<li><a href="../336814/index.html">Hanami Getting Started</a></li>
<li><a href="../336816/index.html">Spring MVC - the basic principles</a></li>
<li><a href="../336818/index.html">XBRL: just about the complex - Chapter 6. Immersion in XBRL - Part 6. Multidimensionality</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>