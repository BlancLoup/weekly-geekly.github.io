<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Microsoft Workflow - antimarketing</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi, Habr. 

 I think many of you have heard of this technology - Microsoft Workflow . It is pretty well promoted, there are posts on Habr√© , there are...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Microsoft Workflow - antimarketing</h1><div class="post__text post__text-html js-mediator-article">  Hi, Habr. <br><br>  I think many of you have heard of this technology - <a href="http://msdn.microsoft.com/en-us/vstudio/jj684582.aspx">Microsoft Workflow</a> .  It is pretty well promoted, there are <a href="http://habrahabr.ru/post/125008/">posts on Habr√©</a> , there are books <a href="http://www.amazon.com/Essential-Windows-Workflow-Foundation-Dharma/dp/0321399838">in English</a> and <a href="http://www.ozon.ru/context/detail/id/3847911/">in Russian</a> .  Yes, and <a href="http://msdn.microsoft.com/en-us/library/ee342461.aspx">Microsoft publishes beautiful pictures</a> . <br><br>  The essence of technology is that programmers create an API, and a business analyst creates the business process himself.  Without intermediaries. <br>  For example, a client has requested such a business process: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     <a href="http://msdn.microsoft.com/en-us/library/aa480215.aspx"><img src="https://habrastorage.org/getpro/habr/post_images/138/233/4fe/1382334fe8723664203808a8a04e04f0.gif" alt="image"></a> <br><br>  And then the business analyst draws him.  Programmers need only implement the procedures Accept, Reject and other similar cubes.  Cool, yeah? <br>  I was not particularly lucky that I heard about this technology only from books and from marketing publications.  And of course from the presentations of the form ‚ÄúWe looked at MS WF six months ago, we‚Äôve been using a little for a month already - the flight is normal!‚Äù.  I have been working with a product in which Workflow has been implemented for 6 years (I myself have worked with him for only a couple of years), which has a fairly high load, and therefore I would like to show the main bases and ambushes of this library.  I hope the post will help to avoid the same rake, which we attacked. <br><a name="habracut"></a><br><br><h5>  How does it work? </h5><br>  The idea is extremely simple: the programmer creates cubes - Activity.  Each Activity can have parameters.  For example, you can create RejectActivity with the User property.  Most often this will mean that Reject will occur for this User.  Each Activity, in fact, has an external view (that is, how a business analyst sees it) and an implementation.  By the way, here we immediately get ambush # 1: this is the same class.  Well, that is, our beautiful designer should link to the implementation.  But this is solved very simply with the help of IoC, because we call it only a warm-up. <br>  When a business analyst made a design (that is, he drew a bunch of activity, connected them with arrows), you can save it as a Xaml view.  Which will be able to download Microsoft Workflow Runtime and start performing. <br>  On some Activities you can pause (for example, Delay Activity).  In this case, the working state is serialized to the database.  Well, after a certain time (as we ourselves indicated), our working process will wake up again and move on.  To save, we need a base or a written <a href="http://msdn.microsoft.com/en-us/library/vstudio/ms741725(v%3Dvs.90).aspx">preserver</a> .  Everything is cool, right? <br><br><h5>  Stand up with serialization </h5><br>  As you understand from the text above, sometimes the business process should be paused.  A typical example: we are waiting for a response from the user (that is, using the Event Activity).  In this case, ordinary serialization occurs (xml serialization for Workflow 4.0+, binary for older versions).  I think the readers immediately realized that it‚Äôs very easy to save too much or make a little mistake when saving in release A, and loading in release B. A typical example from Workflow 3.0 - You subscribed to the Event using the lyamb / anonymous method.  Well, if you know, you have created a new class field, which is stored in the database.  And your load will drop because deserialization will fall.  From here, a big tip: <b>All working code should be strictly imposed outside of your Activity.</b>  <b>All fields must be saved somewhere far away from workflow.</b>  <b>In Activity we store the very minimum and the simplest types.</b>  <b>Let internal design suffer better than stability</b> . <br>  In fact, the setup has not ended here.  The best thing starts when you need to change the set of fields.  For example, in our RejectActivity from the example, we need to add Reason.  And here the code should be ready for the fact that the old RejectActivity does not contain this field.  For Workflow 4.0+, you can still change the serialized representation in the database, but for Workflow 3.0 this method is not always suitable (since the compressed binary representation is stored), because this is not quickly updated. <br><br><h5>  Performance ambush </h5><br>  In fact, Microsoft Workflow has a whole series of flaws.  Moreover, the problems relate to both single execution (that is, a number of operations are not done efficiently) and load distribution.  However, first things first. <br><br><h6>  When to save? </h6><br>  Imagine we have a business process in which there are zero expectations.  It does not matter how they turned out.  What matters is that they are.  Workflow treats any wait as an excellent reason to continue, well, that is, to do serialization, and then download our work again (though not immediately, but not important).  Naturally, this affects the reaction time in the most unfavorable way.  Hence the advice: <b>use the Delay Activity as rarely as possible, and even better - in conjunction with If Activity, which will verify that it is not necessary to wait</b> .  Another unpleasant moment is connected with the fact that if you said ‚Äúto wait for 5 days‚Äù, then in simple ways you will not force Workflow to still not wait for anything if our instance is already in the database.  Moreover, if Workflow Runtime loads your work into memory, and sees that there is still a lot of time to wait, then, oddly enough, it will simply leave it in memory.  And it will wait a lot of time.  Hence, another tip: <b>because of these problems do not use a long wait.</b>  <b>It is best to use a lot of short ones or to wake up due to an external Event, and already your external service will wake up the process when necessary</b> . <br><br><h6>  Distributed execution </h6><br>  If you believe the same articles from Microsoft, Workflow perfectly knows how to distribute work.  Well, that is, you can have several independent servers, each of which will take a few tasks, perform them, take the following, and so on.  There is only one drawback: this is fiction.  The whole point is that the distributed implementation of Workflow is an extremely strange product.  It works according to the following algorithm: <br><ol><li>  Take from the database ALL unlocked workflows that can now be executed And put them on the lock for five minutes </li><li>  After two minutes: repeat paragraph 1 </li></ol><br>  Yes, numbers 2 and 5 can be changed.  Another thing is important: the very first lucky guy will take away all the work from the base.  By the way, in two minutes he will again clean the base, even if he has something to do.  If it does not fit within five minutes for some workflow, then a strange thing will happen: it will still execute the workflow (it will call all WCF connections, etc.), try to save it to the database, but it will not work ( there is no lock!).  As a result, this broken object will now forever remain in the memory of this Workflow Runtime.  And he will not leave it voluntarily until you physically stop the process.  The workflow runtime will not stop itself, it will not be able to do anything.  Great implementation.  A more beautiful scenario will happen if you set up a lock not for five minutes, but for a longer time.  In this case, after stopping the process, these records will be blocked.  Well, that is, you can no longer just stop the process, which can have a very negative impact on the Production platform.  This problem is solved extremely easily: <b>for correct distributed work you should write the procedures for working with the database yourself (that is, implement all the procedures for parallel and distributed work, make your own implementation of <a href="http://msdn.microsoft.com/en-us/library/vstudio/system.workflow.runtime.hosting.workflowpersistenceservice(v%3Dvs.90).aspx">WorkflowPersistenceService</a> ).</b>  By the way, there is one feature here: you don‚Äôt have to work with MS Sql database, you can experiment with other methods.  In fact, the problem is solved with the help of simple file balls, it works quickly and correctly, however this is not fashionable. <br><br><h5>  Successful work under load </h5><br>  In fact, it is not.  Of course, <a href="http://msdn.microsoft.com/en-us/library/gg281645(v%3Dvs.110).aspx">Microsoft claims that everything was fine</a> , but they forgot about one small graph: the dependence of the amount of Activity in memory on the total operating time (and earlier <a href="http://msdn.microsoft.com/en-us/library/aa973808.aspx">it was like this</a> ).  In fact, it has not changed: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/02b/df1/207/02bdf12079cb07753a2dd2de9ad45182.jpg" alt="image"><br><br>  This is a quadratic graph.  It is not the absolute values ‚Äã‚Äãof time that are important here, but the dependency: how long will everything work for you if the complexity of the business process grows.  Moreover, in practice, it is precisely this dependence of Execute time on the total Activity in memory, and it does not matter whether one is a workflow or several.  For example, if you have 10 parallel workflows, then more resources will be spent on processing each small Activity than if there was one workflow.  Or differently: 10 parallel tasks are processed longer than 10 consecutive tasks.  Moreover, with nonlinear dependence. <br>  In the previous part, I wrote how Persistence Service works: it takes everything from the database.  In fact, such a focus of 5,000 parallel complex workflows is detrimental to the system: it starts working at an extremely low speed: 1-10 Activity per minute (!!!).  And this provided that the processor will be loaded almost 100%.  The problem is clear, but how to solve it?  Solution: <b>make your Activity handler, reuse Activity, make emulation of your workflows.</b>  <b>In fact, you will have to quickly implement the basic component of Workflow, which is engaged in starting and stopping the Activity.</b>  <b>This will be required in the first place to prevent a large number of launched Activities on the workflow (because everything slows down), and secondly, to speed up the time of serialization / deserialization (quickly remove the extra ones from memory)</b> .  Microsoft Workflow never removes a spent Activity.  You will have to implement everything in such a way that the completed Activity is not in memory. <br><br><h5>  Summary </h5><br>  I tried to describe some of the problems that await you when working with Microsoft Workflow.  In fact, there are a large number of nuances, but they are more or less solvable, and I am sure that you will manage.  In fact, if you have a task at work to make your own custom business process, then it‚Äôs better to start using Microsoft Workflow.  For the prototype come down.  Moreover, with a weak load, this whole system can work.  The main bases are known - they are higher, they are completely solvable.  In addition, it is much better to work with a system from which it is known what to expect, than with the one about which there is only marketing information.  Well, if the load starts to grow, you can transfer module by module to your effective implementation. </div><p>Source: <a href="https://habr.com/ru/post/229723/">https://habr.com/ru/post/229723/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../229713/index.html">Smart alarm clock based on motion sensor or IP camera</a></li>
<li><a href="../229715/index.html">[survey] What negotiating situations should be dealt with in the "Negotiator Handbook"</a></li>
<li><a href="../229717/index.html">Some mathematical problems of information security</a></li>
<li><a href="../229719/index.html">Encryption of cloud services in companies and organizations</a></li>
<li><a href="../229721/index.html">Do not read books</a></li>
<li><a href="../229727/index.html">New Windows Phone 8.1. What should an application developer do?</a></li>
<li><a href="../229729/index.html">Epson Print Factory - A4 and A3 + Photo Prints</a></li>
<li><a href="../229731/index.html">Using Percona XtraBackup in daily life</a></li>
<li><a href="../229733/index.html">14 mpps SYN floods or 14 V load fork</a></li>
<li><a href="../229735/index.html">Private space truck "Cygnus" successfully launched to the ISS</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>