<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How to add a new diagnostic rule in PVS-Studio? Everyday developers ...</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The question of how to add our own diagnostic rule to our static analyzer PVS-Studio is often asked to us. And we always answer that it is very simple...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How to add a new diagnostic rule in PVS-Studio? Everyday developers ...</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/19b/b19/71d/19bb1971d3afd35fb9d057a56bd820b1.png" align="left"><br>  The question of how to add our own diagnostic rule to our static analyzer PVS-Studio is often asked to us.  And we always answer that it is very simple to do this: ‚ÄúWe just need to write us a letter, and we will add this rule to the analyzer‚Äù.  Such an interface for adding new rules is convenient for the user.  This is the best and most convenient interface.  To do the most similar work is not as easy as it seems.  In this article, I will show the underwater part of the iceberg, which is hidden behind the concept of ‚Äúadded this simple rule‚Äù. <br><br><a name="habracut"></a><br><br>  Let's go straight to the cleanliness.  There is no mechanism in PVS-Studio for the user to write his own rules himself.  This is primarily an architectural constraint.  And this can upset some users.  However, in fact, such users do not understand what they want.  Because in life the process of adding a new rule is quite complicated. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Here, for example, is the rule <a href="http://www.viva64.com/ru/d/0125/">V536</a> : Be advised that the ‚Äúutilized octal constant‚Äù is used.  It is designed to detect errors such as this in Miranda IM: <br><pre>  static const struct _tag_cpltbl
 {
   unsigned cp;
   const char * mimecp;
 } cptbl [] =
 {
   {037, "IBM037"}, // IBM EBCDIC US-Canada 
   {437, "IBM437"}, // OEM United States 
   {500, "IBM500"}, // IBM EBCDIC International 
   {708, "ASMO-708"}, // Arabic (ASMO 708) 
   ...
 } </pre><br>  It says 037 instead of 37 just for alignment, although it turned out to be decimal 31, since 037, according to the rules of C ++, is octal.  The error is pretty simple to diagnose, right?  In fact, we are looking for a constant, see if it starts from 0 and issue a diagnostic message.  This diagnostic rule can be implemented in an hour.  And the user of the static analyzer (a professional in programming, but a beginner in the development of such tools) is ready in theory to implement such a rule. <br><br>  However, he will not be able to do it.  Rather, it will work, but he will not be satisfied with the result due to the large number of false positives. <br><br>  We (the developers of PVS-Studio) do the following.  Before implementing a rule, we first write unit tests on it, where we mark in a special way the lines to which it should work, and also leave lines in the unit test, where the rule should not issue anything.  Then the first version of the diagnostic code is written.  Having achieved the passage of unit tests written for this new rule, we run already complete unit tests.  After all, the new rule could break something.  Full unit tests pass in a few tens of minutes.  Of course, from the first time ‚Äúbreaking nothing‚Äù is not always possible, so the iterations are repeated until the unit passes the complete tests. <br><br>  After unit tests, the next stage is launched on real projects.  There are about 70 projects in our test base (for 2011).  These are well-known and not very open source projects on which we test our analyzer.  We have our own samopisnaya launcher, which opens projects in Visual Studio, starts the analyzer, saves the log, compares it with the standard and shows the differences (which messages were lost, which were added, and which changed).  One run cycle of all projects for Visual Studio 2005 lasts 4 hours on a machine with four cores and eight gigabytes of memory (analysis is parallelized).  According to the results of the analysis, we see the results of the introduction of the new rule.  Usually, we begin to look at the differences without waiting for the analysis to be completed, because sometimes it is immediately obvious that ‚Äúeverything is broken‚Äù.  However, even if everything works and nothing is broken, the tests often stop earlier.  The reason for this is false positives.  If we see that the diagnostic rule has too many positives, then exceptions appear in the rule. <br><br>  Let us return to the search for incorrect octal numbers - rule V536.  There are a number of exceptions.  Here are the situations when the diagnosis is not issued: <br><ol><li>  Constant value is less than 8. </li><li>  The number is declared via #define. </li><li>  In one block there are more than two octal numbers (the rule worked more than two times), except for 0, of type char. </li><li>  This number is used as an argument in functions: _open, mknod, open, wxMkdir, wxFileName :: Mkdir, wxFileName :: AppendDir, chmod. </li><li>  This is a nested block of numbers.  We check only the top one.  Example: {{090}, {091}, {092}, {093}}. </li><li>  This number &lt;= 0777 and is part of the statement, where there is a word: file, File. </li><li>  The number is a function argument, one of the parameters of which contains the string "% o". </li></ol><br>  It is not always possible to predict exceptions before launch on real projects.  Therefore, the iteration "exception - test run - analysis of results" can be repeated many times. <br><br>  Then, when all exceptions are implemented, and the number of false positives is adequate, the test results (the safe log files of detected errors) are declared reference.  Then run the same tests for other versions of Visual Studio.  Now (2011) we have three versions of Visual Studio 2005/2008/2010 supported, tests are performed in them, respectively, 4 / 4.5 / 5 hours, which gives a total of 14-15 hours of time.  According to the results of a run in a different version of Visual Studio, it may be found that a different number of diagnostic messages are issued for the same code depending on the version of Visual Studio.  This is usually due to differences in the header files of different SDKs.  We try to eliminate the differences so that the test run in all versions of Visual Studio gives the same results. <br><br>  Why is it so important to drive away all these tiresome tests?  Is it only because of false positives?  No, it's not just the false positives.  The point is also that implementing the rules it is very difficult to take into account all possible types of structures and write the rule so that it works correctly and moreover does not lead to the fall of the analyzer.  That's what this huge amount of tests is for! <br><br>  What strange constructions are we talking about?  I will give a couple of examples. <br><br>  Do you know that you can declare a variable, for example, something like this: <br><pre>  int const unsigned static a22 = 0; </pre><br>  Do you know that __int64 can be a variable name? <br><pre>  int __identifier (__ int64); </pre><br>  Do you know that after the switch braces are not required? <br><pre>  switch (0)
   if (x) foo (); </pre><br>  Even if you yourself do not use such constructs in your code, they are in used libraries. <br><br>  Finally, after passing all the tests you can take up the documentation.  For each diagnostic rule we write a certificate in Russian and English.  Translation to English also takes time.  Now (when the code is debugged, the tests are passed, the documentation is written) the rule will fall into the next release of PVS-Studio. <br><br>  So, the development cycle of the new diagnostic rule can be briefly presented as follows: <br><ol><li>  The idea of ‚Äã‚Äãa new rule.  Or we come up with, or users suggest, or pry somewhere. </li><li>  Formulation rules. </li><li>  The implementation of the rule. </li><li>  All sorts of testing. </li><li>  Analysis of the results.  Possible options: <ol><li>  Revision of the rule formulation, introduction of exceptions, go to item 2. </li><li>  The implementation of the rule is considered established, you can write and translate documentation. </li></ol></li></ol>  The total time for the implementation of one rule is several days.  As a rule, it is from 2 to 5 days.  Naturally, with experience, we can already predict what exceptions to the rule will be needed and immediately implement them.  And the number of test runs can be reduced.  However, in any case, the key point is that only on the basis of test runs, exceptions can be formulated and most of the false positives can be overcome. <br><br>  Now back to the question of how to add the rule to the user himself.  As you can see, it is difficult to do it yourself for two simple reasons.  The user does not have the qualifications sufficient to come up with successful exceptions and there is no good test base to run the rule on the tests. <br><br>  Then the question arises: ‚ÄúWhy, in some well-known and respected static analyzers, are there ways to set our own user rules?‚Äù Maybe we just can't do this?  Partly yes.  But only the mechanism for setting your own rules serves one simple purpose - to create ‚Äúcomparison matrices with competitors‚Äù: <br><img src="https://habrastorage.org/getpro/habr/post_images/dce/c0d/11e/dcec0d11e83d10d542b4c0cddd6a046b.png"><br>  And what, the reader will ask, will there never be a user rule in PVS-Studio?  Someday we will have the strength to realize this and not to lose in the comparison matrices :-).  In the meantime, we will all who want to create a new rule give a link to this text and say: ‚ÄúWe have the best interface for adding custom rules - just write us a letter!‚Äù </div><p>Source: <a href="https://habr.com/ru/post/128437/">https://habr.com/ru/post/128437/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../128429/index.html">Extreme data recovery from degraded 5th raid</a></li>
<li><a href="../128431/index.html">Daemon for remote control of a computer via e-mail</a></li>
<li><a href="../128432/index.html">The dark side of programming for beginners, including php</a></li>
<li><a href="../128433/index.html">Hidden in the foliage</a></li>
<li><a href="../128434/index.html">The government loved Wi-Fi. Gorky Park, metro, universities. Calculating the cost of the network at the university</a></li>
<li><a href="../128438/index.html">The basic theory of collision objects, sprites on Javascript</a></li>
<li><a href="../128439/index.html">We get lists of mac-addresses on ports of managed switches in Zabbix</a></li>
<li><a href="../128440/index.html">Where's the lawyer: reload legal services</a></li>
<li><a href="../128441/index.html">Non-WYSIWYG diagrams on the wiki</a></li>
<li><a href="../128445/index.html">Mail.Ru Mail Support: Past, Present, Future</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>