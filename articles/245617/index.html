<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Macros in haxe: execute the code right at compile time (and this is normal)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the previous article, I talked a little about haxe - a simple and convenient general purpose language. However, besides simplicity and clarity, the...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Macros in haxe: execute the code right at compile time (and this is normal)</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/cb0/198/fb8/cb0198fb8c874476b3f46e96c9299943.png" align="left">  In the <a href="https://habr.com/post/243199/">previous article,</a> I talked a little about haxe - a simple and convenient general purpose language.  However, besides simplicity and clarity, there are deep things in it - such as the concept of macros - code that is executed during the compilation process.  Why in haxe there are no traditional C-like macros and what possibilities we tear off haxe-macros, and the article will be discussed. <br><a name="habracut"></a><br><br><h1>  Why are there no C-like macros in haxe? </h1><br>  In C, macros are used quite widely: this is for you and constants, these are definitions for conditional compilation, these are inline functions.  They greatly increase the flexibility of the language.  However, as a result of mixing, you will agree, quite different functionalities in one concept, macros with C carry with them difficulties in understanding the source text.  It seems to me that this is why haxe creator <a href="https://plus.google.com/%2BNicolasCannasse/">Nicolas Kanassier</a> decided to divide this concept into components.  Thus, in the language appeared separately: constants (static inline var), definitions for conditional compilation (defines) and inline-methods. <br><br><h1>  Meanwhile, macros in haxe ... </h1><br>  Macros in haxe stand apart - I have not seen this in other languages.  Briefly about them you can say the following: <br><ul><li>  written in haxe; </li><li>  formally, they are static and non-static methods of ordinary classes; </li><li>  these methods can have input parameters, and return an arbitrary expression; </li><li>  this expression is substituted in the place where the macro is called; </li><li>  inside: compiled into neko, and then executed before starting the compilation of the rest of the program code; </li><li>  therefore, everything can neko (read / write arbitrary files, access the database, etc.). </li></ul><br>  What exactly can you do with macros?  The following moments come to mind: <br><ul><li>  change class contents ‚Äî insert new variables and methods, change data types, and so on. </li><li>  deploy code to something more complicated; </li><li>  change meta-information - mark classes / methods / variables to use this later for reflection; </li><li>  change definitions of conditional compilation (i.e., your program, for example, may be assembled differently depending on external conditions; for example, you can build a development or production version depending on the value in the configuration file); </li><li>  add new data types, delete existing ones, process all types (for example, this allows the documentation generator); </li><li>  macros in the form of static methods can be called from the command line options of the compiler (for example, there are already ready macros for importing specified folders with classes, for excluding certain files from compilation and a few more more specific functions). </li></ul>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h1>  Macros in practice </h1><br>  The author has repeatedly resorted to using macros in real-world tasks.  One has only to remember that macros add complexity to the code, which means they should be used only where it is really needed.  In the standard haxe libraries, they have built a system for interacting with <a href="http://old.haxe.org/doc/sys/db/spod">SPOD</a> databases.  The macros in it allow you to write queries to the database using a hard syntax with auto-completion (like LINQ in C #). <br><br><h2>  Example: clone () method with adjustable return type </h2><br>  In a typical situation, the clone () method is defined on the base class and then redefined in descendants.  The problem with this method is the formal return type.  On the one hand, the method defined in the base class should return an object of the ‚Äúbase‚Äù type, on the other hand, it should ideally return an object of the type ‚Äúdescendant‚Äù redefined in descendants.  Thus, the method signature is broken and all typed languages ‚Äã‚Äãknown to me (including haxe) will stop trying to override the method with a different return type.  But it would be nice if you could write such code: <br><pre><code class="actionscript hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Base</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">new</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">clone</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> : Base </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Base(); } } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Child</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Base</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">new</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(); } <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">clone</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> : Base </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Child(); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">childMethod</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">return</span></span></span><span class="hljs-function"> "</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">childMethod</span></span></span><span class="hljs-function">"</span></span>; } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Main</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//  ,       trace(new Child().clone().childMethod()); } }</span></span></code> </pre> <br>  Let's write a macro method that will return the correct type.  It is better to immediately place it in a separate file (this will make it easier for the compiler to separate the macro code from the usual one and thus avoid a number of problems, especially since cloning is usually needed in different places and therefore it would be good to have a macro method without being tied to the class to be cloned).  A class with a macro will look like this: <br><pre> <code class="actionscript hljs"><span class="hljs-comment"><span class="hljs-comment">//  Clonable.hx import haxe.macro.Expr; import haxe.macro.Context; import haxe.macro.Type; class Clonable { //         //  ,       macro public function cloneTyped(ethis:Expr) { var tpath = Context.toComplexType(Context.typeof(ethis)); //  ,         -; //   ,   -   - $      return macro (cast $ethis.clone():$tpath); } }</span></span></code> </pre><br>  Now it's enough to examine Base from Clonable and we will be able to use the cloneTyped () method: <br><pre> <code class="actionscript hljs"><span class="hljs-comment"><span class="hljs-comment">//  Main.hx class Base extends Clonable { public function new() { } public function clone() return new Base(); } class Child extends Base { public function new() super(); override function clone() return new Child(); public function childMethod() return "childMethod"; } class Main { static function main() { // ,   ,  Child.clone()    Base, // , ,    childMethod(),      clone()   Child trace(new Child().cloneTyped().childMethod()); } }</span></span></code> </pre><br>  A few notes: <br><ol><li>  In the code, I removed the optional (for the case of a single expression) braces around the bodies of the methods and returnable data types for the methods (since the compiler will output them itself). </li><li>  Unfortunately, I did not manage to make it so that instead of ‚ÄúcloneTyped‚Äù we could write just ‚Äúclone‚Äù (perhaps this point can be corrected). </li><li>  The cloneTyped () method will not be in the result code, nor will its calls (instead of cloneTyped () calls, there will be clone () calls with reduction to the required type without a drop in the program operation speed). </li><li>  For those who are interested in macros, after the first acquaintance, I recommend reading about reification (‚Äúmaterialization‚Äù) - ways to create a haxe-code from a macro for substitution instead of a call, directly writing it down. </li></ol><br><h1>  findings </h1><br>  Macros in the haxe language are quite a unique and powerful thing that should be used where conventional methods do not work.  It is relatively easy to create / use macros yourself, but don't forget about ready-made libraries (see <a href="http://lib.haxe.org/t/macro">http://lib.haxe.org/t/macro</a> ).  Hope the material was interesting to you. </div><p>Source: <a href="https://habr.com/ru/post/245617/">https://habr.com/ru/post/245617/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../245605/index.html">Agile bothers me and I want to talk about it</a></li>
<li><a href="../245609/index.html">Improving mobile sites with Google Developers in Russian</a></li>
<li><a href="../245611/index.html">We invite you to GDG DevFest Voronezh 2014</a></li>
<li><a href="../245613/index.html">The dark side of parking</a></li>
<li><a href="../245615/index.html">Software integration. Process description by business consultant</a></li>
<li><a href="../245619/index.html">C # 6, Roslyn, smart homes and control application design at an online DevLabs meeting</a></li>
<li><a href="../245621/index.html">From the avoidable to the inevitable. Again about goals and about IT</a></li>
<li><a href="../245623/index.html">VarDumper - a new component in symfony 2.6</a></li>
<li><a href="../245625/index.html">An example of writing functional requirements for an Enterprise system</a></li>
<li><a href="../245629/index.html">How we taught the swim button</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>