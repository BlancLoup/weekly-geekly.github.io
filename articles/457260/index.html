<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>LUKS container decryption at boot time</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good day to all, night! This post will be useful to those who use LUKS data encryption and want to decrypt decrypt disks under Linux (Debian, Ubuntu) ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>LUKS container decryption at boot time</h1><div class="post__text post__text-html js-mediator-article">  Good day to all, night!  This post will be useful to those who use LUKS data encryption and want to <s>decrypt</s> decrypt disks under Linux (Debian, Ubuntu) at the <b>stage of decrypting the root partition</b> .  And I could not find such information on the Internet. <br><br>  More recently, with an increase in the number of disks in the shelves, I encountered the problem of decrypting disks using a more than well-known method through / etc / crypttab.  Personally, I highlight a few problems using this method, namely that the file is read <b>only after loading (mount) the root partition</b> , which adversely affects the import of ZFS, in particular if they were collected from partitions on a * _crypt device, or mdadm raids collected from the same sections.  <i>We all know that you can use parted on LUKS containers?</i>  And also the problem of early start of other services, when there are no arrays yet, and <b>you</b> already need to <b>use</b> something (I work with clustered Proxmox VE 5.x and ZFS over iSCSI). <br><br><div class="spoiler">  <b class="spoiler_title">A bit about ZFSoverISCSI</b> <div class="spoiler_text">  iSCSI works for me through LIO, and actually when the iscsi target starts and doesn‚Äôt see ZVOL devices, it simply removes them from the configuration, which prevents guest systems from loading.  From here either restore json file backup, or manually add devices with identifiers of each VM, which is terrible when there are dozens of such machines and there are more than 1 disk in each configuration. <br></div></div><br>  And the second question that I will consider is how to decrypt it (this is the key point of the article).  And we will talk about it below, come under kat! <br><a name="habracut"></a><br>  Most often, a key file is used on the Internet (self-added before it to the slot with the command - cryptsetup luksAddKey), or in rare exceptions (very little information in the Russian-language Internet) - the script decrypt_derived, which is located in / lib / cryptsetup / script / (Of course, there are more ways, but I used these two, which formed the basis of the article).  I also wanted to be fully autonomous after reboots, without any additional commands in the console, so that everything would ‚Äúfly up‚Äù right away.  So why wait?  - 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Getting started! <br><br>  We assume a system, for example, Debian, installed on the sda3_crypt crypto partition and a dozen disks ready to encrypt and create anything your heart desires.  We have a passphrase for unlocking sda3_crypt and it is from this section that we will remove the password hash on the running (decrypted) system and add it to other disks.  Everything is elementary, in the console we execute: <br><br><pre><code class="plaintext hljs">/lib/cryptsetup/scripts/decrypt_derived sda3_crypt | cryptsetup luksFormat /dev/sdX</code> </pre> <br>  where X is our disks, partitions, etc. <br><br>  After encrypting the disks with the ‚Äúhash‚Äù from our key phrase, you need to know the UUID, or ID - depending on who got used to it.  Take the data from / dev / disk / by-uuid and by-id respectively. <br><br>  The next stage is the preparation of files and mini-scripts for the work we need functions, proceed: <br><br><pre> <code class="plaintext hljs">cp -p /usr/share/initramfs-tools/hooks/cryptroot /etc/initramfs-tools/hooks/ cp -p /usr/share/initramfs-tools/scripts/local-top/cryptroot /etc/initramfs-tools/scripts/local-top/</code> </pre> <br>  Further <br><br><pre> <code class="plaintext hljs">touch /etc/initramfs-tools/hooks/decrypt &amp;&amp; chmod +x /etc/initramfs-tools/hooks/decrypt</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">Content ../decrypt</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh cp -p /lib/cryptsetup/scripts/decrypt_derived "$DESTDIR/bin/decrypt_derived"</span></span></code> </pre> <br></div></div><br>  Further <br><br><pre> <code class="plaintext hljs">touch /etc/initramfs-tools/hooks/partcopy &amp;&amp; chmod +x /etc/initramfs-tools/hooks/partcopy</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">Content ../partcopy</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh cp -p /sbin/partprobe "$DESTDIR/bin/partprobe" cp -p /lib/x86_64-linux-gnu/libparted.so.2 "$DESTDIR/lib/x86_64-linux-gnu/libparted.so.2" cp -p /lib/x86_64-linux-gnu/libreadline.so.7 "$DESTDIR/lib/x86_64-linux-gnu/libreadline.so.7"</span></span></code> </pre> <br></div></div><br>  a bit more <br><br><pre> <code class="plaintext hljs">touch /etc/initramfs-tools/scripts/local-bottom/partprobe &amp;&amp; chmod +x /etc/initramfs-tools/scripts/local-bottom/partprobe</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">Content ../partprobe</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh $DESTDIR/bin/partprobe</span></span></code> </pre> <br></div></div><br>  and last, before update-initramfs, you need to edit the / etc / initramfs-tools / scripts / local-top / cryptroot file, starting with the line ~ 360, a piece of code below <br><br><div class="spoiler">  <b class="spoiler_title">Original</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># decrease $count by 1, apparently last try was successful. count=$(( $count - 1 )) message "cryptsetup ($crypttarget): set up successfully" break</span></span></code> </pre><br></div></div><br>  and lead to this form <br><br><div class="spoiler">  <b class="spoiler_title">Edited</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># decrease $count by 1, apparently last try was successful. count=$(( $count - 1 )) /bin/decrypt_derived $crypttarget | cryptsetup luksOpen /dev/disk/by-uuid/ *CRYPT_MAP* /bin/decrypt_derived $crypttarget | cryptsetup luksOpen /dev/disk/by-id/ *CRYPT_MAP* message "cryptsetup ($crypttarget): set up successfully" break</span></span></code> </pre> <br></div></div><br>  Please note that you can use either a UUID or an ID here.  The main thing is that the necessary drivers for HDD / SSD devices were added to / etc / initramfs-tools / modules.  You can find out which driver is used with the command <i>udevadm info -a -n / dev / sdX |</i>  <i>egrep 'looking | DRIVER'</i> . <br><br>  Now that we have finished and all the files are in place, we run <i>update-initramfs -u -k all -v</i> , <b>there should be no</b> errors in the execution of our scripts in the logging.  Reboot, enter the key phrase and wait a bit, depending on the number of disks.  Next, the system will start and at the final stage of the launch, namely after the ‚Äúroot‚Äù partition ‚Äúrun‚Äù, the partprobe command will be executed - it will find and pick up all created partitions on LUKS devices and any arrays, whether it is ZFS or mdadm, will assemble without problems!  And all this <b>before loading the</b> main services and services that need these disks / arrays. <br><br>  <b>update1</b> : As <a href="https://habr.com/ru/post/457260/">noted by</a> <a href="https://habr.com/ru/users/aep/" class="user_link">AEP</a> , this method only works for LUKS1. </div><p>Source: <a href="https://habr.com/ru/post/457260/">https://habr.com/ru/post/457260/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../457250/index.html">Dark day for Vue.js</a></li>
<li><a href="../457254/index.html">The digest of interesting materials for the mobile developer # 303 (June 17 - 23)</a></li>
<li><a href="../457256/index.html">Internet history: ARPANET - package</a></li>
<li><a href="../457258/index.html">The Pirate Bay for 15 years and could not kill</a></li>
<li><a href="../45726/index.html">CorePy: programming in assembler in Python</a></li>
<li><a href="../457262/index.html">Analysis of qualifications of the programming championship among backend developers</a></li>
<li><a href="../457266/index.html">Agile crisis. What to do?</a></li>
<li><a href="../45727/index.html">Peter Nalitch - new album on the system "Pay What You Want"</a></li>
<li><a href="../457270/index.html">Prisma-CMS as an engine for quickly creating MVP</a></li>
<li><a href="../457276/index.html">Seven threats from bots to your site</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>