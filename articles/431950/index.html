<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How to forecast demand and automate purchases using machine learning: Ozon case</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the online store Ozon there is just about everything: refrigerators, baby food, laptops for 100 thousand, etc. It means that all this is in the com...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How to forecast demand and automate purchases using machine learning: Ozon case</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/webt/rl/bh/0z/rlbh0zbeah9dcpem3uio1wdstxs.png" alt="image"><br>  In the online store Ozon there is just about everything: refrigerators, baby food, laptops for 100 thousand, etc.  It means that all this is in the company's warehouses - and the longer the goods are there, the more expensive the company is.  To find out how much and what people want to order, and Ozon will need to be purchased, we used machine learning. <br><a name="habracut"></a><br><h3>  Sales forecast: challenges </h3><br>  Before we delve into the formulation of the problem, we begin with an example.  This is a real schedule of sales of goods on Ozon for some time.  Question: where will he go next? <br><br><img src="https://habrastorage.org/webt/jl/nk/1j/jlnk1jejwxtqka-skph4hjccxno.png" alt="image"><br><br>  A person with a near-technical education to this formulation of the problem will have questions: And where are the axes?  And what kind of product?  And in what units?  What institute graduated from?  - and many others not included in this article for ethical reasons. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In fact, no one can answer the question correctly in such a statement, and if someone can, he is most likely mistaken. <br><br>  Add some more information to this graphic: axles and price changes on the Ozon website (blue) and on the competitor's website (orange). <br><br><img src="https://habrastorage.org/webt/n1/m8/ap/n1m8apunf5mos5bid2xs4qsq1ka.png" alt="image"><br><br>  At some point, the price at our place has decreased, while the competitors have remained the same - and sales at Ozon have gone up.  We know pricing plans: our price will remain at the same level, but the competitor, following Ozon, lowered the price to almost ours. <br><br>  This data is enough to make a sensible assumption - for example, that sales will return to their previous level.  And if you look at the chart, it turns out that it will be so. <br><br><img src="https://habrastorage.org/webt/rk/mb/aw/rkmbawctxwb2hf4lhs7l025c9y4.png" alt="image"><br><br>  The problem is that in fact the demand for this product is not so much affected by the price, and sales growth was caused, among other things, by the absence of most of the competitors of this product in our store.  There are still many factors that we did not take into account: was the product advertised on TV?  or maybe it's candy, and soon March 8? <br><br>  One thing is clear: make a forecast "on the knee" will not work.  We went along the standard path of the <s>rake and crutches for</s> building any ML algorithm.  And that's how it was. <br><br><h3>  Metric selection </h3><br>  Choosing a metric is where to start if your forecast will be used by at least one other person besides you. <br><br>  Consider an example: we have three projections.  Which is better? <br><img src="https://habrastorage.org/webt/ix/zg/gp/ixzggpclvbgaqpmkzaeehzhamb0.png" alt="image"><br>  From the point of view of specialists in the warehouse, we need a blue forecast - buy a little less, and let us miss the peak in mid-October, but nothing is left in the warehouse.  The experts, whose KPI are tied to sales, have the opposite opinion: even the turquoise forecast is not quite correct, not all demand spikes reflected - go and modify.  And from the point of view of a person from the outside, something in between is generally better - so that everyone is good, or vice versa bad. <br><br>  Therefore, before building a forecast, it is necessary to determine who will use it and why.  That is, choose a metric and understand what to expect from the forecast based on such a metric.  And wait for just that. <br><br>  We chose MAE - the average absolute error.  This metric is suitable for our highly unbalanced training set.  Since the range is very wide (1.5 million items), each product individually in a particular region is sold in small quantities.  And if in total we sell hundreds of green dresses, then a particular green dress with cats sells for 2-3 per day.  As a result, the sample is shifted towards small values.  On the other hand, there are iPhones, spinners, a new book by Olga Buzova (joke), etc.  - and they are sold in any city in large quantities.  MAE allows you not to receive huge fines on conditional iPhones and generally work well on the bulk of the goods. <br><br><h3>  The first steps </h3><br>  We began by building the stupidest prediction that could be: a random number from 0 to 1000 will be sold over the next week - and we got the metric MAE = 496. Probably, it can be worse, but this is already very bad.  So we got a guideline: if we get such a metric value, then obviously we are doing something wrong. <br><br>  Then we started to play people who know how to make a forecast without machine learning, and tried to predict the sale of goods for the next week equal to the average sales for all the past weeks, and received the MAE metric = 1.45 - which is much better. <br><br>  Continuing to argue, we decided that the more relevant for the forecast of sales for the next week would not be the average, but sales for the last week.  In this forecast, MAE was equal to 1.26.  In the next round of predictive thinking, we decided to take both factors into account and predict sales for the next week as the sum of 50% of average sales and 50% of sales over the last week - we received MAE = 1.23. <br><br>  But this seemed too simple to us, and we decided to make everything more complicated.  We collected a small training sample in which the signs were past and average sales, and the targets were sales for the next week, and we trained on it a simple linear regression.  We obtained weights of 0.46 and 0.55 for the average and last weeks and MAE on the test sample, equal to 1.2. <br>  Conclusion: our data has a prognostic potential. <br><br><h3>  Feature engineering </h3><br>  Deciding that building a forecast on two grounds is not our level, we sat down to generate new complex features.  This and information about past sales - for 1, 2, 3, 4 weeks ago, a week exactly a year ago, etc.  And views over the past weeks, adding to the cart, converting views and adding to the cart in orders - and all this for different periods. <br><br>  We needed to give the model knowledge of how the product as a whole is sold, how the dynamics of its sales has changed recently, how interest in it evolves, how its sales depend on price and other factors that we think can be useful. <br><br>  When our ideas ran out, we went to the sales department experts.  There, for example, we learned that the next year is the year of the pig, therefore goods, even remotely resembling pigs, will enjoy increased popularity.  Or, for example, that our people do not buy the ‚Äúfreeze-up‚Äù in advance, but on the very day of the first frost - so please, take into account the weather forecast.  In general, everyone was happy.  We have got a lot of new ideas that we would never have thought of ourselves, and merchants that we can soon be doing something more interesting than the sales forecast. <br><br>  But it is still too simple - and we added combined features: <br><br><ul><li>  conversion from views to sales - what it was, how it changed; </li><li>  the ratio of sales for 4 weeks to sales for the last week (if this figure is very different from 4, at the moment the demand for this product is subject to "turbulence"); </li><li>  the ratio of sales of goods to sales in the whole category - if this figure is close to one, then the product is a ‚Äúmonopolist‚Äù. </li></ul><br>  At this stage, you need to come up with as much as possible - throw out non-informative signs at the training stage. <br><br>  As a result, we got 170 signs.  Looking ahead, the greatest <br><br><ul><li>  Sales last week (for two, three and four). </li><li>  The availability of the product last week - the percentage of time when the product was present on the site. </li><li>  Angular coefficient of the sales schedule for the last 7 days. </li><li>  The ratio of past price to future - with a huge discount to start buying goods more actively. </li><li>  The number of direct competitors within our site.  If, for example, this pen is unique in its category, sales will be fairly stationary. </li><li>  The dimensions of the product - it turned out that the length and width significantly affect the predictability of sales.  For some reason, for long and narrow objects - umbrellas or fishing rods, for example - the schedule is much more volatile.  We do not yet know how to explain it. </li><li>  The number of the day in the year - it shows whether the New Year is coming soon, March 8, the start of a seasonal increase in sales, etc. </li></ul><br><h3>  Sampling collection </h3><br>  Teaching sample is pain.  We collected it for about 4 weeks, two of which simply went to different data keepers and asked to see what they have.  This happens every time you need data for a long period.  Even in an ideal data collection system, something like this would happen in a long time, ‚Äúwe used to think this thing like this, but then we started to think differently and write data in the same column.‚Äù  Or a year or two ago the server fell, but no one recorded exactly when - and the zeros no longer mean that there was no sales. <br><br>  As a result, we had at our disposal information about what people were doing on the site, what they added to their favorites and the basket, and how much they bought.  We collected a sample of about 15 million samples of 170 features each, the target was the number of sales for the next week. <br><br>  We wrote 2 thousand lines of code on Spark.  He worked slowly, but allowed to chew through huge amounts of data.  It only seems that to calculate the angular coefficient of a straight line is simple.  And to do this 10kk times, when sales are drawn from several bases - the task is not for the faint of heart. <br><br>  For another week, we cleaned the data so that the model was not distracted by outliers and local sampling features, but extracted only the true dependencies inherent in Ozon sales.  Here will go both 3 sigma and more cunning methods of search for anomalies.  The most difficult case is to restore sales during periods when the product is out of stock.  The simplest solution is to throw away the weeks when the product was absent during the ‚Äútargeted‚Äù week. <br><br><img src="https://habrastorage.org/webt/kk/li/_z/kkli_zozkhocyxgrkur-eocnq3g.png" alt="image"><br><br>  As a result, 10 million of 15 million samples remained. Here it is important not to get carried away and not lose the completeness of the sample (in fact, the lack of goods in the warehouse is an indirect characteristic of its importance for the company; to remove such products from the sample is not the same as throwing random samples ). <br><br><h3>  ML time </h3><br>  On a clean sample and began to train the model.  Naturally, we started with linear regression and got MAE = 1.15.  It seems that this is a very small increase, but when you have a sample of 10 million in which the average values ‚Äã‚Äãare 5-10, even a small change in the value of the metric gives a disproportionate increase in the visual quality of the forecast.  And since in the end you will have to present the solution to business customers, raising their level of joy is an important factor. <br><br>  Next was sklearn.ensemble.RandomForestRegressor, which after a short selection of hyper parameters showed MAE = 1.10.  Next we tried XGBoost (where without it) - everything would be fine and MAE = 1.03 - only for a very long time.  Unfortunately, we did not have access to the GPU for learning XGBoost, and on the processors one model was trained for a very long time.  We tried to find something faster, and stopped at LightGBM - he studied twice as fast and showed MAE even a little less - 1.01. <br><br>  We have broken all products into 13 categories, just like in the catalog on the site: tables, laptops, bottles, and for each of the categories we trained models with different depths of the forecast - from 5 to 16 days. <br><br>  The training took about five days, and for this we raised huge computing clusters.  We have developed such a pipeline: random search works for a long time, gives the top 10 sets of hyperparameters, and then the scientist works the date with them manually - builds additional quality metrics (we considered MAE for different ranges of targets), builds learning curves (for example, we threw out some of the training sampling and trained again, checking whether new data reduces loss on the test sample) and other graphs. <br><br>  An example of a detailed analysis for one of the sets of hyperparameters: <br><br><div class="spoiler">  <b class="spoiler_title">Detailed quality metric</b> <div class="spoiler_text"><table><tbody><tr><td><p>  Train set: </p><br></td><td><p>  Test set: </p><br></td></tr><tr><td>  For target = 0, MAE = 0.142222484602 </td><td>  For 0 MAE = 0.141900737761 </td></tr><tr><td>  For target&gt; 0 MAPE = 45.168530676 </td><td>  For&gt; 0, MAPE = 45.5771812826 </td></tr><tr><td>  More errors than 0 - 67.931341691% </td><td>  More errors 0 - 51.6405939896% </td></tr><tr><td>  Errors greater than 1 - 19.0346986379% </td><td>  Errors greater than 1 - 12.1977096603% </td></tr><tr><td>  Errors greater than 2 - 8.94313926245% </td><td>  Errors greater than 2 - 5.16977226441% </td></tr><tr><td>  Errors greater than 3 - 5.42406856507% </td><td>  Errors greater than 3 - 3.12760834969% </td></tr><tr><td>  More than 4 errors - 3.67938161595% <br></td><td>  More than 4 errors - 2.10263125679% </td></tr><tr><td>  More than 5 errors - 2.67322988948% <br></td><td>  More than 5 errors - 1.56473158807% <br></td></tr><tr><td>  More than 6 errors - 2.0618556701% <br></td><td>  More than 6 errors - 1.19599209102% <br></td></tr><tr><td>  More than 7 errors - 1.65887701209% </td><td>  More than 7 errors - 0.949300173983% <br></td></tr><tr><td>  There are more than 8 errors - 1.36821095777% <br></td><td>  More than 8 errors - 0.78310772461% </td></tr><tr><td>  More than 9 errors - 1.15368611519% </td><td>  More than 9 errors - 0.659205318158% <br></td></tr><tr><td>  More than 10 errors - 0.99199395014% </td><td>  More than 10 errors - 0.554593106723% </td></tr><tr><td>  More errors than 11 - 0.863969667827% </td><td>  More errors than 11 - 0.490045146476% <br></td></tr><tr><td>  There are more than 12 errors - 0.764347266082% <br></td><td>  There are more than 12 errors - 0.428835873827% <br></td></tr><tr><td>  More than 13 errors - 0.68086818247% </td><td>  Errors greater than 13 - 0.386545830907% <br></td></tr><tr><td>  More than 14 errors - 0.613446089087% </td><td>  More than 14 errors - 0.343884822697% <br></td></tr><tr><td>  More than 15 errors - 0.556297016335% <br></td><td>  There are more than 15 errors - 0.316433391328% <br></td></tr><tr><td>  For target = 0, MAE = 0.142222484602 <br></td><td>  For target = 0, MAE = 0.141900737761 <br></td></tr><tr><td>  For target = 1, MAE = 0.63978556493 <br></td><td>  For target = 1, MAE = 0.660823509405 </td></tr><tr><td>  For target = 2, MAE = 1.01528075312 </td><td>  For target = 2, MAE = 1.01098070566 </td></tr><tr><td>  For target = 3, MAE = 1.43762342295 </td><td>  For target = 3, MAE = 1.44836233499 </td></tr><tr><td>  For target = 4, MAE = 1.82790678437 <br></td><td>  For target = 4, MAE = 1.86539223382 <br></td></tr><tr><td>  For target = 5, MAE = 2.15369976552 <br></td><td>  For target = 5, MAE = 2.16017884573 </td></tr><tr><td>  For target = 6, MAE = 2.51629758129 <br></td><td>  For target = 6, MAE = 2.51987403661 <br></td></tr><tr><td>  For target = 7, MAE = 2.80225497415 <br></td><td>  For target = 7, MAE = 2.97580015564 <br></td></tr><tr><td>  For target = 8, MAE = 3.09405048248 <br></td><td>  For target = 8, MAE = 3.21914648525 <br></td></tr><tr><td>  For target = 9, MAE = 3.39256765159 <br></td><td>  For target = 9, MAE = 3.54572928241 <br></td></tr><tr><td>  For target = 10, MAE = 3.6640339953 </td><td>  For target = 10, MAE = 3.84409605282 <br></td></tr><tr><td>  For target = 11, MAE = 4.02797747118 <br></td><td>  For target = 11, MAE = 4.21828735273 <br></td></tr><tr><td>  For target = 12, MAE = 4.17163467899 <br></td><td>  For target = 12, MAE = 3.92536509115 <br></td></tr><tr><td>  For target = 14, MAE = 4.78590364522 <br></td><td>  For target = 14, MAE = 5.11290428675 </td></tr><tr><td>  For target = 15, MAE = 4.89409916994 <br></td><td>  For target = 15, MAE = 5.20892023117 <br></td></tr></tbody></table><br>  Train loss = 0.535842111392 <br>  Test loss = 0.895529959873 <br></div></div><br><div class="spoiler">  <b class="spoiler_title">Graph prediction (target) for the training sample</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/3m/o6/ho/3mo6hoqfklfc69z55btog7e6q_w.png" alt="image"><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Graph prediction (target) for the test sample</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/hq/q6/bm/hqq6bm7aqcbngqum8mgdyhjibna.png" alt="image"><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Prediction error from time to time</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/in/mu/be/inmubedyg9b6hzyttimdneuh5-s.png" alt="image"><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Sorted in ascending error on the test sample</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/74/h3/kt/74h3ktebx43a9mhmie6sgp5ua_i.png" alt="image"><br></div></div><br>  If none is suitable - again random search.  This is how we trained a model for five or four days at an industrial rate.  We were on duty, someone at night, someone woke up in the morning, looked at the top 10 parameters, restarted or saved the model, and went to sleep.  In this mode, we worked for a week and trained 130 models - 13 types of goods and 10 forecast depths, each had 170 features.  The average MAE value for a 5-fold time series cv was equal to 1. <br><br>  It may seem that this is not very cool - and this is true, if only you have not a large part of the sample in the sample.  As the analysis of the results shows, the units are predicted worst of all - the fact that a product bought once a week does not say whether there is a demand for it.  One time, anything can be sold - there is a person who buys a porcelain figurine in the form of a dentist, and this does not say anything about future sales or about the past.  In general, we did not get very upset about this. <br><br><h3>  Tips and tricks </h3><br>  What went wrong and how can you avoid it? <br><br>  The first problem is the selection of parameters.  We started using RandomizedSearchCV - this is the famous sklearn tool for iterating over hyper parameters.  This is where the first surprise awaited us. <br><br><div class="spoiler">  <b class="spoiler_title">Like this</b> <div class="spoiler_text"><code>from sklearn.model_selection import ParameterSampler <br> from sklearn.model_selection import RandomizedSearchCV <br> <br> estimator = lightgbm.LGBMRegressor(application='regression_l1', is_training_metric = True, objective = 'regression_l1', num_threads=72) <br> param_grid = {'boosting_type': boosting_type, 'num_leaves': num_leaves, 'max_depth': max_depth, 'learning_rate':learning_rate, 'n_estimators': n_estimators, 'subsample_for_bin': subsample_for_bin, 'min_child_samples': min_child_samples, 'colsample_bytree': colsample_bytree, 'reg_alpha': reg_alpha, 'max_bin': max_bin} <br> <br> rscv = RandomizedSearchCV(estimator, param_grid, refit=False, n_iter=100, scoring='neg_mean_absolute_error', n_jobs=1, cv=10, verbose=3, pre_dispatch='1*n_jobs', error_score=-1, return_train_score='warn') <br> <br> rscv .fit(X_train.values, y_train['target'].values) <br> print('Best parameters found by grid search are:', rscv.best_params_)</code> <br> </div></div><br>  The calculation simply stalls (which is important, it does not fall, but continues to work, but at an ever smaller number of cores and at some point simply stops). <br><br><div class="spoiler">  <b class="spoiler_title">I had to parallelize the process by RandomizedSearchCV</b> <div class="spoiler_text"> <code>estimator = lightgbm.LGBMRegressor(application='regression_l1', is_training_metric = True, objective = 'regression_l1', num_threads=1) <br> <br> rscv = RandomizedSearchCV(estimator, param_grid, refit=False, n_iter=100, scoring='neg_mean_absolute_error', n_jobs=72, cv=10, verbose=3, pre_dispatch='1*n_jobs', error_score=-1, return_train_score='warn') <br> <br> rscv .fit(X_train.values, y_train['target'].values) <br> print('Best parameters found by grid search are:', rscv.best_params_)</code> <br> </div></div><br>  But RandomizedSearchCV for every job, almost the entire datas rambles.  Accordingly, it is necessary to greatly expand the amount of RAM, perhaps sacrificing the number of cores. <br><br>  Who would tell us then about such beautiful things as hyperopt!  Since we learned, we only use it. <br><br>  Another trick that came to our mind closer to the end of the project was to choose models that had the colsample_bytree parameter (this is the LightGBM parameter that says what percentage of features to give to each lerner) around 0.2-0.3, because when the machine It works in production, some tables may not exist, and individual features may not be calculated correctly.  Such a regularization allows us to make these uncalculated features affect at least not all Lerners within the model. <br>  Empirically, we came to the conclusion that we need to do more estimators and tighten the regularization more strongly.  This is not the rule for working with LightGBM, but this scheme worked for us. <br><br>  And, of course, Spark.  For example, there is a bug that Spark himself knows: if you take several columns from a table and make a new one, and then take another one from the same table and make a new one, and then bake the resulting tables, everything will break, although it should not.  You can escape only by getting rid of all the lazy calculations.  We even wrote a special function - bumb_df, it turns the Data Frame into an RDD back into a Data Frame.  That is, resets all lazy calculations.  This can protect yourself against most Spark problems. <br><br><div class="spoiler">  <b class="spoiler_title">bumb_df</b> <div class="spoiler_text"> <code>def bump_df(df): <br> # to avoid problem: AnalysisException: resolved attribute(s) <br> df_rdd = df.rdd <br> if df_rdd.isEmpty(): <br> df = df_rdd.toDF(schema=df.schema) <br> return df <br> else: <br> return df_rdd.toDF(schema=df.schema) <br></code> <br></div></div><br><h3>  The forecast is ready: how much will we order? </h3><br>  The sales forecast is a purely mathematical task, and if the normal distribution of an error with a zero average for a mathematician is a victory, then for merchants who have every ruble in their account is unacceptable. <br><br>  If one extra iPhone or one fashionable dress in the warehouse is not a problem, but rather an insurance stock, then the absence of the same iPhone in the warehouse is a loss of at least margin, and as a maximum - an image, and this cannot be allowed. <br><br>  To teach the algorithm to buy as much as necessary, we had to calculate the cost of over- and under-purchasing each product and train a simple model to minimize possible losses in money. <br><br>  The model receives a sales forecast at the input, adds random, normally distributed noise to it (we simulate the imperfection of suppliers) and learns to add only enough to the forecast for each particular product in order to minimize money losses. <br><br>  Thus, an order is a forecast + safety stock guaranteeing coverage of the error of the forecast itself and the nonideality of the outside world. <br><br><h3>  As in the sale </h3><br>  Ozon has its own rather large computing cluster, on which the pipeline starts every night (we use airflow) from more than 15 jobs.  It looks like this: <br><br><img src="https://habrastorage.org/webt/cc/sq/gb/ccsqgbj2p2xztr9qlllahzgr_4c.png" alt="image"><br><br>  Every night, the algorithm runs, delays in local hdfs about 20 GB of data from various sources, selects a supplier for each product, collects features for each product, makes a sales forecast and generates bids based on the delivery schedule.  By 6-7 in the morning we give the table to the people who are responsible for working with suppliers, ready-made tables, which at the touch of a button fly away to the suppliers. <br><br><h3>  Not a single forecast </h3><br>  The trained model is aware of the dependence of the forecast on any feature and, as a result, if you freeze the N-1 signs and start changing one, you can observe how it affects the forecast.  Of course, the most interesting thing about this is how sales depend on price. <br><br>  It is important to note that demand depends not only on price.  For example, if in the summer to make small discounts on the sled, it still does not help them sell.  We make a discount more, and there are people who "prepare a sleigh in the summer."  But to a certain level of discounts, we still will not be able to reach the part of the brain that is responsible for planning.  In winter, it works like for any product - you make a discount, and it sells faster. <br><br><img src="https://habrastorage.org/webt/zp/by/jg/zpbyjgawjuxfa0pfm3rrp0sb4f0.png" alt="image"><br><br><h3>  Plans </h3><br>  Now we are actively studying the clustering of time series in order to distribute products into clusters based on the nature of the curve describing their sales.  For example, seasonal, traditionally popular in the summer or, on the contrary, in the winter.  When we learn to separate products with a long history of sales, we plan to highlight item-based features that will tell you what the sales pattern for a new, just-appeared product will be - for now this is our main task. <br><br>  Then there will definitely be neural networks, parametric models of time series, and all this in an ensemble. <br><br>  Including thanks to the new forecasting system, Ozon has moved from purchasing goods with a margin to cyclical deliveries, when we buy from one delivery to another and do not store stock in the warehouse. <br><br>  Now we have to decide how to teach the algorithm to predict sales of new products and whole categories.  Next year, the company plans x10 sales growth in categories and x2.5 in fulfillment areas.  And we need to tell the model that this old data is relevant, but for another, past store.  And while we are still thinking how to do it. <br><br>  The second by nature irrational thing that we have to learn to predict - fashion.  How was it possible to predict that the spinner would sell like that?  How to predict sales of a new book by Dan Brown, if one of his books is bought up and another is not?  While we are working on it. <br><br>  If you know how it was possible to do better, or you have stories about using machine learning in battle in a comment, we will discuss. </div><p>Source: <a href="https://habr.com/ru/post/431950/">https://habr.com/ru/post/431950/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../431940/index.html">People burn out if they don‚Äôt feel their importance. What to do with it?</a></li>
<li><a href="../431942/index.html">Hierarchical dependency injection in React and MobX State Tree as a domain model</a></li>
<li><a href="../431944/index.html">Yealink Meeting Server 2.0 - New Video Conferencing Features</a></li>
<li><a href="../431946/index.html">Security Week 49: Hacking Dell and Marriott</a></li>
<li><a href="../431948/index.html">Deep Mind taught your AI to predict protein structure</a></li>
<li><a href="../431954/index.html">Former vice president of Sun and DEC became president of MIPS / Wave, talks about Russia and RISC / V</a></li>
<li><a href="../431956/index.html">Logic, Explainability and Future of Understanding</a></li>
<li><a href="../431958/index.html">Tesla's Virtual Power Station with rechargeable batteries (Powerwall) expands to 1,000 homes in Australia</a></li>
<li><a href="../431960/index.html">Nvidia went crazy and opens up PhysX under BSD-3</a></li>
<li><a href="../431962/index.html">Orbit Fab plans to refuel satellites right in orbit</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>