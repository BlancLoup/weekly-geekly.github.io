<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Git rebase "by button"</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="When we talk about automating the development and testing process, we mean that this is a very large-scale action, and it really is. And if we decompo...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Git rebase "by button"</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage3/3d3/c2d/ec2/3d3c2dec2ab36689ee599e4142d06802.png" align="left"><br>  When we talk about automating the development and testing process, we mean that this is a very large-scale action, and it really is.  And if we decompose it in parts, then separate fragments of the whole picture will become visible - this fragmentation of the process is very important in two cases: <br><ul><li>  actions are performed manually, which requires concentration and accuracy; </li><li>  hard time frame. </li></ul><br>  In our case, there is a time limit: releases are formed, tested and rolled out to the production server twice a day.  With limited deadlines in the life cycle of a release, the process of removing (rolling back) from the release branch of a task containing an error is important.  To do this, we use git rebase.  Since git rebase is a completely manual operation that requires attentiveness and thoroughness and takes a long time, we have automated the process of deleting a task from the release branch. <br><a name="habracut"></a><br><img src="https://habrastorage.org/storage3/3c3/d6f/1ec/3c3d6f1ecd527f1fb8cbe01c862e88a4.png" align="right"><br><h4>  Git flow </h4><br>  At the moment, Git is one of the most common version control systems, and we successfully use it in Badoo. <br>  The process of working with Git is quite simple. <br><img src="https://habrastorage.org/storage3/ade/ee6/1f0/adeee61f094fa0de5cf105ebb032c669.png"><br><br>  The peculiarity of our model is that we develop and test every task in a separate branch.  The name of this branch consists of a ticket number in JIRA and a free description of the task.  For example: <br><br><blockquote>  BFG-9000_All_developers_should_be_given_a_years_holiday_ (paid) </blockquote><br>  We collect the release and test it from a separate branch (release), into which completed and tested tasks on a devel environment are merged.  Since we post the code to the production server twice a day, we create two new release branches every day, respectively. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/storage3/b6c/ead/dab/b6ceaddabc24db9686f4e254263acbb4.png"><br><br>  The release is formed by merging tasks into the release branch using the automerge tool.  We also have a master branch, which is a copy of the production server.  After the integration testing stage of the release and each individual task, the code is sent to the production server and merged into the master branch. <br>  When a release is tested on a staging environment and an error is detected in one of the tasks, and there is no time to fix it, we simply remove this task from the release using git rebase. <br><br><img src="https://habrastorage.org/storage3/eab/7ba/dff/eab7badff746e0c6a179cfdc2931bac8.png"><br><br>  <i>Note.</i>  We do not use the git revert function in the release branch, because if you delete the task from the release branch with git revert and the release branch merges into master, from which the developer then pulls the fresh code into the branch where the error occurred, he will have to revert to revert to return your changes. <br><br>  At the next stage, we compile a new version of the release, roll it out to the staging environment, check for errors, run autotests and, with a positive result, upload the code to the production server. <br>  The main points of this scheme are fully automated and work in the process of continuous integration (until now, only the removal of the task from the release branch was done manually). <br><br><img src="https://habrastorage.org/storage3/bd9/d87/de2/bd9d87de242bb1a68d0eed4007394c4c.png"><br><br><img src="https://habrastorage.org/storage3/e94/f81/a28/e94f81a287a1e0057c8b483c83035f93.png" align="left"><br><h4>  Formulation of the problem </h4><br>  Consider what can be used to automate the process: <br>  1. The release branch, from which we are going to roll back the ticket, consists of commits of two categories: <br><ul><li>  The merge commit, which is obtained when merging a task branch into a release branch, contains the name of the ticket in the commit message, since the branches are named with the task prefix; </li><li>  merge commit, which is obtained by merging the master branch into the release branch in automatic mode.  On the master, we apply patches in semi-automatic mode through our special tool DeployDashboard.  The patches are attached to the corresponding ticket, while the commit message indicates the number of this ticket and the description of the patch. </li></ul>  2. Built-in git rebase tool, which is best used interactively thanks to convenient visualization. <br><br>  <u>Problems you may encounter</u> : <br><br>  1. When the git rebase operation is performed, all commits in the branch are overclocked, starting with the one that is rolled back. <br>  2. If during the formation of a branch any merge conflict was resolved manually, then Git will not save the solution of this conflict in memory, therefore, when performing the git rebase operation, you will need to re-fix the merge conflicts manually. <br>  3. Conflicts in a particular algorithm are divided into two types: <br><ul><li>  simple - such conflicts arise due to the fact that the functionality of the version control system does not allow memorizing previously resolved merge conflicts; </li><li>  complex - arise due to the fact that the code was corrected in a particular line (file) not only in the commit that is removed from the branch, but also in subsequent commits, which are peremerzhivayutsya in the git rebase process.  At the same time, the developer corrected this conflict manually and performed a push to the release branch. </li></ul><br><blockquote>  Git has an interesting feature called git rerere, which remembers the resolution of conflicts when merzh.  It turns on automatically, but, unfortunately, cannot help us in this case.  This function only works when there are two long-lived branches that are constantly merging - Git remembers such conflicts without problems. <br>  We have only one branch, and if the -force function is not used when performing git push changes to the repository, then after each git rebase you will have to create a new branch with a new trunk of changes.  For example, we write the postfix _r1, r2, r3 ... after each successful git rebase operation and execute git push of the new release branch to the repository.  Thus, the history of conflict resolution is not saved. </blockquote><br><br>  <u>What do we want to end up with</u> ? <br><br>  By pressing a certain button in our bugtracker: <br>  1. The task will be automatically removed from the release. <br>  2. A new release branch will be created. <br>  3. The status of the task will be transferred to Reopen. <br>  4. In the process of removing the task from the release, all simple merge conflicts will be resolved. <br><br>  Unfortunately, in any of the schemes it is impossible to resolve complex merge conflicts, so if such a conflict arises, we will notify the developer and the release engineer. <br><img src="https://habrastorage.org/storage3/749/c98/a25/749c98a252912bf72d66202c0f9fdbd9.png" align="right"><br><h4>  Main functions </h4><br>  1. Our script uses interactive rebase and catches commits with the number of the task to be rolled back in the release branch. <br>  2. When finding the necessary commits, it deletes them, while remembering the names of the files that were changed in them. <br>  3. Next, he peremerzhivaet all commits, starting with the last remote in the trunk of the branch. <br>  4. If a conflict occurs, it checks the files that are involved in the conflict.  If these files coincide with the files of remote committees, then we notify the developer and release engineer that a complex conflict has arisen that needs to be resolved manually. <br>  5. If the files do not match, but a conflict has occurred, then this is a simple conflict.  Then we take the code of files from the commit in which the developer has already solved this conflict, from the origin repository. <br><br>  So "run to the head of the branch." <br><br>  The probability that we will end up in a complex conflict is negligible, that is, 99% of the process‚Äôs accomplishments will be automatic. <br><img src="https://habrastorage.org/storage3/d78/e0d/16e/d78e0d16eecf37f175ff7fa46b874323.png" align="right"><br><h4>  Implementation </h4><br>  Now let's take a look at what our script will do (the example uses only automatic rebase and you can use the script just in the console): <br>  <b>1.</b> Clear the repository and pull out the latest version of the release branch. <br>  <b>2.</b> We get the top commit in the trunk with the merging into the release of the branch that we want to roll back. <br>  but.  If there is no commit, then we inform you that there is nothing to roll back. <br>  <b>3. We</b> generate a script editor, which only removes merge commies hashes from the trunk, thus removing them from the history. <br>  <b>4.</b> In the environment of the script-inverter set the script editor (EDITOR), which we generated in the previous step. <br>  <b>5.</b> Run git rebase -ip for release.  Check the error code. <br>  but.  If 0, then everything went well.  Go to step 2 to find possible previous commits of the deleted branch of the task. <br>  b. If not 0, then a conflict has occurred.  We are trying to solve: <br>  i.  We memorize the commit hash that could not be imposed. <br>  It is in the .git / rebase-merge / stopped-sha file. <br>  ii.  Parse the output of the rebase command to find out what is wrong. <br>  1. If Git tells us ‚ÄúCONFLICT (content): Merge conflict in‚Äù, then we compare this file with the previous revision from the deleted one, and if it does not differ (the file did not change in the commit), then simply take this file from the head of the build branch and commit  If it is different, then we exit, and the developer resolves the conflict manually. <br>  2. If Git says ‚Äúfatal: Commit is a merge but no-m option was given‚Äù, then just repeat the rebase with the - continue flag.  The merge commit will be skipped, but the changes will not be lost.  This usually happens with the master branch, but it has already been pulled to the branch head and this merge commit is not needed. <br>  3. If Git says ‚Äúerror: couldn‚Äôt apply ...‚Äù When you have resolved this problem run ‚Äúgit rebase - continue‚Äù, then do git status to get a list of files.  If at least one file from the status is in the commit that we roll back, then skip the commit (rebase --skip), which we memorized at step 5.bi, writing about this in the log so that the release engineer will see it and decide if this is necessary commit or not. <br>  4. If none of the above happened, then exit the script and say that something inexplicable happened. <br>  <b>6.</b> Repeat point 5 until exit code 0 appears at the output, or the counter in the cycle will not be&gt; 5 to avoid looping errors. <br><br><div class="spoiler">  <b class="spoiler_title">Script code</b> <div class="spoiler_text"><pre><code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">/** *     ,     . *   . */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runBuildRevert</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($args)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (count($args) != <span class="hljs-number"><span class="hljs-number">2</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;commandUsage(<span class="hljs-string"><span class="hljs-string">"&lt;build-name&gt; &lt;ticket-key&gt;"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;error(<span class="hljs-string"><span class="hljs-string">"Unknown build!"</span></span>);; } $build_name = array_shift($args); $ticket_key = array_shift($args); $build = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;Deploy-&gt;buildForNameOrBranch($build_name); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!$build) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;directSystem(<span class="hljs-string"><span class="hljs-string">"git reset --hard &amp;&amp; git clean -fdx"</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;error(<span class="hljs-string"><span class="hljs-string">"Can't clean directory!"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;directSystem(<span class="hljs-string"><span class="hljs-string">"git fetch"</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;error(<span class="hljs-string"><span class="hljs-string">"Can't fetch from origin!"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;directSystem(<span class="hljs-string"><span class="hljs-string">"git checkout "</span></span> . $build[<span class="hljs-string"><span class="hljs-string">'branch_name'</span></span>])) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;error(<span class="hljs-string"><span class="hljs-string">"Can't checkout build branch!"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;directSystem(<span class="hljs-string"><span class="hljs-string">"git pull origin "</span></span> . $build[<span class="hljs-string"><span class="hljs-string">'branch_name'</span></span>])) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;error(<span class="hljs-string"><span class="hljs-string">"Can't pull build branch!"</span></span>); } $commit = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_getTopBranchToBuildMergeCommit($build[<span class="hljs-string"><span class="hljs-string">'branch_name'</span></span>], $ticket_key); $in_stream_count = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>($commit)) { $in_stream_count += <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($in_stream_count &gt;= <span class="hljs-number"><span class="hljs-number">5</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;error(<span class="hljs-string"><span class="hljs-string">"Seems rebase went to infinite loop!"</span></span>); $editor = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_generateEditor($build[<span class="hljs-string"><span class="hljs-string">'branch_name'</span></span>], $ticket_key); $output = <span class="hljs-string"><span class="hljs-string">''</span></span>; $code = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;exec( <span class="hljs-string"><span class="hljs-string">'git rebase -ip '</span></span> . $commit . <span class="hljs-string"><span class="hljs-string">'^^'</span></span>, $output, $code, <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> ($code) { $output = implode(<span class="hljs-string"><span class="hljs-string">"\n"</span></span>, $output); $conflicts_result = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_resolveRevertConflicts($output, $build[<span class="hljs-string"><span class="hljs-string">'branch_name'</span></span>], $commit); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::FLAG_REBASE_STOP !== $conflicts_result) { $command = <span class="hljs-string"><span class="hljs-string">'--continue'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::FLAG_REBASE_SKIP === $conflicts_result) { $command = <span class="hljs-string"><span class="hljs-string">'--skip'</span></span>; } $output = <span class="hljs-string"><span class="hljs-string">''</span></span>; $code = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;exec( <span class="hljs-string"><span class="hljs-string">'git rebase '</span></span> . $command, $output, $code, <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> ); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { unlink($editor); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;error(<span class="hljs-string"><span class="hljs-string">"Giving up, can't resolve conflicts! Do it manually.. Output was:\n"</span></span> . var_export($output, <span class="hljs-number"><span class="hljs-number">1</span></span>)); } } unlink($editor); $commit = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_getTopBranchToBuildMergeCommit($build[<span class="hljs-string"><span class="hljs-string">'branch_name'</span></span>], $ticket_key); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>($in_stream_count)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;error(<span class="hljs-string"><span class="hljs-string">"Can't find ticket merge in branchdiff with master!"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_resolveRevertConflicts</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($output, $build_branch, $commit)</span></span></span><span class="hljs-function"> </span></span>{ $res = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::FLAG_REBASE_STOP; $stopped_sha = trim(file_get_contents(<span class="hljs-string"><span class="hljs-string">'.git/rebase-merge/stopped-sha'</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (preg_match_all(<span class="hljs-string"><span class="hljs-string">'/^CONFLICT\s\(content\)\:\sMerge\sconflict\sin\s(.*)$/m'</span></span>, $output, $m)) { $conflicting_files = $m[<span class="hljs-number"><span class="hljs-number">1</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($conflicting_files <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $file) { $output = <span class="hljs-string"><span class="hljs-string">''</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;exec( <span class="hljs-string"><span class="hljs-string">'git diff '</span></span> . $commit . <span class="hljs-string"><span class="hljs-string">'..'</span></span> . $commit . <span class="hljs-string"><span class="hljs-string">'^ -- '</span></span> . $file, $output ); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>($output)) { <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;exec(<span class="hljs-string"><span class="hljs-string">'git show '</span></span> . $build_branch . <span class="hljs-string"><span class="hljs-string">':'</span></span> . $file . <span class="hljs-string"><span class="hljs-string">' &gt; '</span></span> . $file); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;exec(<span class="hljs-string"><span class="hljs-string">'git add '</span></span> . $file); $res = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::FLAG_REBASE_CONTINUE; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;error(<span class="hljs-string"><span class="hljs-string">"Can't resolve conflict, because file was changed in reverting branch!"</span></span>); } } } <span class="hljs-keyword"><span class="hljs-keyword">elseif</span></span> (preg_match(<span class="hljs-string"><span class="hljs-string">'/fatal\:\sCommit\s'</span></span> . $stopped_sha . <span class="hljs-string"><span class="hljs-string">'\sis\sa\smerge\sbut\sno\s\-m\soption\swas\sgiven/m'</span></span>, $output)) { $res = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::FLAG_REBASE_CONTINUE; } <span class="hljs-keyword"><span class="hljs-keyword">elseif</span></span> (preg_match(<span class="hljs-string"><span class="hljs-string">'/error\:\scould\snot\sapply.*When\syou\shave\sresolved\sthis\sproblem\srun\s"git\srebase\s\-\-continue"/sm'</span></span>, $output)) { $files_status = <span class="hljs-string"><span class="hljs-string">''</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;exec( <span class="hljs-string"><span class="hljs-string">'git status -s|awk \'{print $2;}\''</span></span>, $files_status ); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($files_status <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $file) { $diff_in_reverting = <span class="hljs-string"><span class="hljs-string">''</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;exec( <span class="hljs-string"><span class="hljs-string">'git diff '</span></span> . $commit . <span class="hljs-string"><span class="hljs-string">'..'</span></span> . $commit . <span class="hljs-string"><span class="hljs-string">'^ -- '</span></span> . $file, $diff_in_reverting ); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>($diff_in_reverting)) { <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;warning(<span class="hljs-string"><span class="hljs-string">"Skipping commit "</span></span> . $stopped_sha . <span class="hljs-string"><span class="hljs-string">" because it touches files we are reverting!"</span></span>); $res = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::FLAG_REBASE_SKIP; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $res; } <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_getTopBranchToBuildMergeCommit</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($build_branch, $ticket)</span></span></span><span class="hljs-function"> </span></span>{ $commit = <span class="hljs-string"><span class="hljs-string">''</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;exec( <span class="hljs-string"><span class="hljs-string">'git log '</span></span> . $build_branch . <span class="hljs-string"><span class="hljs-string">' ^origin/master --merges --grep '</span></span> . $ticket . <span class="hljs-string"><span class="hljs-string">' -1 --pretty=format:%H'</span></span>, $commit ); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> array_shift($commit); } <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_generateEditor</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($build_branch, $ticket, array $exclude_commits = array</span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">()</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ $filename = PHPWEB_PATH_TEMPORARY . uniqid($build_branch) . <span class="hljs-string"><span class="hljs-string">'.php'</span></span>; $content = &lt;&lt;&lt;<span class="hljs-string"><span class="hljs-string">'CODE'</span></span> <span class="hljs-comment"><span class="hljs-comment">#!/local/php5/bin/php &lt;?php $build = '%s'; $ticket = '%s'; $commits = %s; $file = $_SERVER['argv'][1]; if (!empty($file)) { $content = file_get_contents($file); $build = preg_replace('/_r\d+$/', '', $build); $new = preg_replace('/^.*Merge.*branch.*' . $ticket . '.*into\s' . $build . '.*$/m', '', $content); foreach ($commits as $exclude) { $new = preg_replace('/^.*' . preg_quote($exclude, '/') . '$/m', '', $new); } file_put_contents($file, $new); } CODE; $content = sprintf($content, $build_branch, $ticket, var_export($exclude_commits, 1)); file_put_contents($filename, $content); $this-&gt;exec('chmod +x ' . $filename); putenv("EDITOR=" . $filename); return $filename; }</span></span></code> </pre> <br></div></div><br><img src="https://habrastorage.org/storage3/5f0/c3a/c4c/5f0c3ac4c4e3f8fb53179510e2e2315a.png" align="left"><br><h4>  Conclusion </h4><br>  As a result, we received a script that deletes the task from the release branch in automatic mode.  We saved time in the process of forming and testing the release, while almost completely eliminating the human factor. <br>  Of course, our script is not suitable for all Git users.  In some cases it is easier to use git revert, but it‚Äôs better not to get carried away (revert to revert to revert ...).  We hope that not the easiest git rebase operation has become more understandable to you, and those who constantly use git rebase in the development and release generation process will also use our script. <br><br>  <b>Ilya Ageev</b> , QA Lead and <b>Vladislav Chernov</b> , Release engineer </div><p>Source: <a href="https://habr.com/ru/post/193258/">https://habr.com/ru/post/193258/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../193244/index.html">SPM Conf - 3. Competently on IT project management</a></li>
<li><a href="../193248/index.html">Loc Kit: localization of games and two-step quality control</a></li>
<li><a href="../193250/index.html">Cloud storage for backup sites</a></li>
<li><a href="../193254/index.html">Meeting Ruby Lovers</a></li>
<li><a href="../193256/index.html">KiB, Kib, KB, Kb</a></li>
<li><a href="../193262/index.html">Yes, you can make money selling OpenStack</a></li>
<li><a href="../193264/index.html">The first computer bug was found 66 years ago.</a></li>
<li><a href="../193266/index.html">Apple introduced the iPhone 5S, iPhone 5C and the release of iOS 7</a></li>
<li><a href="../193270/index.html">PHP IPC - Interprocess Communication in PHP</a></li>
<li><a href="../193272/index.html">Mathematical model Lego Segway</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>