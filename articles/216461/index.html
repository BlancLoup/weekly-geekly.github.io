<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Samba4 + GlusterFS</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Many have already encountered such a thing as GlusterFS, someone is still not in the know, today I invite you all to get acquainted with this project,...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Samba4 + GlusterFS</h1><div class="post__text post__text-html js-mediator-article"><img align="right" src="https://habrastorage.org/getpro/habr/post_images/65e/782/01c/65e78201ccc6bb0e18edc7cce4a1834a.png">  Many have already encountered such a thing as GlusterFS, someone is still not in the know, today I invite you all to get acquainted with this project, or rather the possibility of using GlusterFS together with Samba4 to build a distributed, linearly scalable file storage with protection against failures . <br><br>  This article will discuss several possibilities of using GlusterFS with Samba4, as well as analyzing the performance of each option. <br><a name="habracut"></a><br>  I use SLES11 SP3, all the examples will be based on it, but I think in other distributions everything is done in much the same way.  GlusterFS can be downloaded from the <a href="http://download.gluster.org/pub/gluster/glusterfs/3.4/LATEST/">official website of the</a> project, there are already compiled assemblies for all major Linux server distributions. <br><hr>  The example uses GlusterFS 3.4.2 and Samba 4.1.6. <br><hr>  With samba4, it's not that simple.  You can build samba4 yourself, but then do not forget to build a package with the vfs glusterfs module when building.  I went a simpler way, namely I recompiled the assembly from Sernet, since  In this case, it is not necessary to write init scripts, and the structure of the samba files is right, it is not required when compiling to specify the script what and where to put.  The assembly can be obtained on <a href="https://portal.enterprisesamba.com/">the Sernet portal</a> after registration. <br><br>  And so, we need to ultimately get samba4 with the vfs glusterfs module, install sernet-samba-4.1.6-7.src.rpm, edit the spec file sernet-samba-4.1.spec, in which you need to do the following: <br>  Looking for a string <br><pre><code class="bash hljs">%define vfs_modules_common vfs_audit,vfs_cap,vfs_catia,vfs_cacheprime,vfs_expand_msdfs,vfs_extd_audit,vfs_fake_perms,vfs_netatalk,vfs_recycle,vfs_streams_depot,vfs_aio_fork</code> </pre>  add at the end <br><pre> <code class="bash hljs">,vfs_glusterfs</code> </pre>  Looking for a column <br><pre> <code class="bash hljs">CONF_OPTS=<span class="hljs-string"><span class="hljs-string">"\</span></span></code> </pre>  Add to it <br><pre> <code class="bash hljs">--<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>-glusterfs \</code> </pre>  Next, run the rpm build on our spec file. <br><pre> <code class="bash hljs">rpmbuild -bb sernet-samba-4.1.spec</code> </pre>  At the output, we get the rpm sernet-samba we need, which already include the module we need. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Samba4 can be used with glusterfs in any role, be it a domain controller or just a classic file server.  There are several ways to use these two products in conjunction, with one of the two paths being for some reason much more popular, although slower than the other. <br><br>  I will not consider in this material a step-by-step plan for creating a storage facility for glusterfs, this has already been done more than once before me at Habr√©, and there is nothing difficult in this process.  You can refer to the <a href="http://gluster.org/community/documentation/index.php/Gluster_3.1:_Creating_New_Volumes">official instructions</a> or search for material on <a href="http://habrahabr.ru/search/%3Fq%3Dglusterfs%26target_type%3Dposts">habrahabr</a> .  We assume that you already have a local volume called samba4_volume. <br><br>  And so, the first option, the easiest, but also the slowest, just mount the glusterfs volume allow in / data and point the ball to this path in smb.conf. <br>  In the file / etc / fstab add <br><pre> <code class="bash hljs">localhost:/samba4_volume /data glusterfs defaults,_netdev 0 0</code> </pre>  How to add the ball in smb.conf I think no need to explain. <br>  In this case, by the way, you don‚Äôt need a vfs module at all, and what is described at the beginning of the article can be avoided. <br><br>  Option two, more productive. <br>  Use the vfs module and connect the volume directly to samba4. <br>  An example of the smb.conf part we need <br><pre> <code class="bash hljs">[data] comment = For samba <span class="hljs-built_in"><span class="hljs-built_in">export</span></span> of volume <span class="hljs-built_in"><span class="hljs-built_in">test</span></span> vfs objects = glusterfs glusterfs:volfile_server = localhost glusterfs:volume = samba4_volume kernel share modes = no path = / <span class="hljs-built_in"><span class="hljs-built_in">read</span></span> only = no guest ok = yes</code> </pre>  Accordingly, if you have samba4 compiled without this module, this option will not work. <br><br>  It's time to check the speed of each option.  At first, I checked the speed of copying over the network to the ball of one large file, then I checked the copying of the windows folder (a bunch of small files), I did not notice the percentage difference in speed between different options, so I decided not to take screenshots, steady speed when copying one large file more visual in my opinion. <br><br>  First we test the speed of work directly with the ext4 file system, without glusterfs. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/45b/2b3/67d/45b2b367d02acb897dc080b8898c3750.png"><br><br>  The speed of about 50 MB / s on a gigabit network is quite a normal result. <br><br>  Check the speed when using the first option.  Volume glusterfs is simply mounted via / etc / fstab <br><br><img src="https://habrastorage.org/getpro/habr/post_images/d28/c73/fce/d28c73fce3723b61466d84f26ed95a99.png"><br><br>  The speed immediately collapsed twice from the standard, a terrible result in general ... <br><br>  Check the speed when using the vfs module <br><br><img src="https://habrastorage.org/getpro/habr/post_images/981/7ba/fd1/9817bafd1803f8652eff1fad1ce00692.png"><br><br>  The speed sags one and a half times from the standard. <br><br>  In fact, as we see a problem with the performance of GlusterFS at the moment there are anyway, if you decide to transfer your corporate storage to GlusterFS having one or more replication nodes, bear in mind that the performance of such storage will in any case decrease.  Yes, the speed can be raised if you add Striped nodes, but this requires iron resources, which not everyone has.  In my case, I wanted to use replication to another server for fault tolerance, seeing the state of affairs while I paused this project. <br><br>  The developers promise to increase productivity in the new version 3.5, it remains only to wait ... </div><p>Source: <a href="https://habr.com/ru/post/216461/">https://habr.com/ru/post/216461/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../216445/index.html">Infographic Voyager 1: 36 years on the road, distance from the Earth 19'010'023'115 km</a></li>
<li><a href="../216449/index.html">Parsing formulas in 40 lines</a></li>
<li><a href="../216453/index.html">Autotest without pain</a></li>
<li><a href="../216455/index.html">As a programmer from Russia to enter Stanford University in California</a></li>
<li><a href="../216457/index.html">MirrorMoon EP - in search of the cherished planet</a></li>
<li><a href="../216463/index.html">Habr, hello!</a></li>
<li><a href="../216465/index.html">Use of the developer RAWTherapee in applied tasks of the amateur photographer</a></li>
<li><a href="../216467/index.html">Data mining in music. We define a musical instrument with the help of Classification Trees.</a></li>
<li><a href="../216469/index.html">AngularJS - splitting an application into modules and loading components using RequireJS</a></li>
<li><a href="../216471/index.html">We are testing the ARM platform Marvel Armada XP as a hosting for the Python project</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>