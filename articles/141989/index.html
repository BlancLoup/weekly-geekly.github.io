<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Nginx module to combat DDoS, put a cookie through Flash</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="After publishing an article about the nginx module designed to combat bots, I received a lot of feedback in which people asked for Flash support. 
 I ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Nginx module to combat DDoS, put a cookie through Flash</h1><div class="post__text post__text-html js-mediator-article">  After publishing an <a href="http://habrahabr.ru/post/139931/">article about the nginx module</a> designed to combat bots, I received a lot of feedback in which people asked for Flash support. <br>  I was sure that with due effort anyone could implement these functions on their own, as third-party applications, without changing the code of the module itself, but no one did, so I had to do PoC. <br><a name="habracut"></a><br>  Initially, I wanted the module to be in the form of a designer, and no one has canceled the KISS principle, so it was decided to implement the entire client-side in the form of third-party applications.  Nginx is doing well with proxying, so the easiest way is to write them as separate HTTP services. <br>  This provides the following benefits: <br><ul><li>  We write in any convenient language (I prefer Python) </li><li>  We are not tied to nginx, the quality of the code is not so important - it can be blocked, etc. etc. </li><li>  We can use the whole range of caching functionality nginx </li><li>  <b>Even if the service is lying, all legitimate users who have already received their cookie are not aware of this - the main resource is available for them</b> . </li></ul><br><br><h2>  What had to add </h2><br>  For the main directive of <a href="https://github.com/kyprizel/testcookie-nginx-module">the testcookie-filter module</a> , besides the previous values ‚Äã‚Äãof ‚Äúon‚Äù and ‚Äúoff‚Äù, now another one has been added - ‚Äúvar‚Äù.  If the module works in the ‚Äúvar‚Äù mode, then for this location: <br><ul><li>  cookie check will be performed; </li><li>  nginx variables (all but $ testcookie_nexturl) are set; </li><li>  <b>redirects, setting cookies and intercepting the request will not occur</b> . </li></ul><br><br><h2>  What is it for </h2><br>  Thus, you can now pass the correct cookie value to your application via the HTTP header: <br><pre><code class="bash hljs">location = /testcookie.swf { testcookie var; proxy_pass http://127.0.0.1:1234/; proxy_set_header Testcookie-Value <span class="hljs-variable"><span class="hljs-variable">$testcookie_set</span></span>; proxy_set_header Testcookie-Valid <span class="hljs-variable"><span class="hljs-variable">$testcookie_ok</span></span>; proxy_set_header Testcookie-Name <span class="hljs-string"><span class="hljs-string">"BPC"</span></span>; }</code> </pre> <br>  Why through the header, and not through param in the case of Flash? <br>  So the value does not appear in clear form in the client part, it can not be extracted, for example, by regexp. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h2>  And yet, Flash? </h2><br>  I believe that the method of installing cookies via Flash is not the most correct, but since users want it - why not do it. <br>  I dismissed the idea to make a static SWF and substitute values ‚Äã‚Äãinto it, like it was done in <a href="https://github.com/yuri-gushin/Roboo/">Roboo</a> , right away - easy to disassemble, difficult to modify, and so on. <br>  Therefore, it was decided to give the user the opportunity to make life harder for the attacker. <br>  For this, there are 2 files in the project: <br>  <b>cookie_encoder.py</b> (Python): <br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">encode_cookie</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(cookie_value)</span></span></span><span class="hljs-function">:</span></span> key = <span class="hljs-number"><span class="hljs-number">42</span></span> res = <span class="hljs-string"><span class="hljs-string">''</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> x <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> cookie_value: res += chr(ord(x) ^ key) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> res</code> </pre><br>  <b>cookie_decoder.as</b> (ActionScript): <br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">flash_cookie_crypt_routine</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">str</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> result; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; str.length; i++) { result += <span class="hljs-built_in"><span class="hljs-built_in">String</span></span>.fromCharCode(str.charCodeAt(i) ^ <span class="hljs-number"><span class="hljs-number">42</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; } getURL(<span class="hljs-string"><span class="hljs-string">"javascript:void(document.cookie='#TESTCOOKIE_NAME#="</span></span> + flash_cookie_crypt_routine(<span class="hljs-string"><span class="hljs-string">"#TESTCOOKIE_VALUE#"</span></span>) + <span class="hljs-string"><span class="hljs-string">"');void(location.href='"</span></span> + nexturl + <span class="hljs-string"><span class="hljs-string">"');"</span></span>);</code> </pre><br>  As it is not difficult to guess, the first one is for encoding the value (in the example xory is 42), the second is for decoding on the client side (again xory is 42). <br><br>  ActionScript is dynamically built into SWF using <a href="http://github.com/kyprizel/libming">libming</a> .  By the way, I had to patch it up a bit, so the project will work only with my fork, at least until the maintainers stop finding fault with the names of the functions and approve of my pull. <br><br>  The service framework uses <a href="http://github.com/william-os4y/fapws3">fapws3</a> , a fast asynchronous web server for Python. <br><br>  All together on the old coreduo, in one process, gives its ~ 3k req / s with concurency 1k, without any optimization and caching.  In production, you can use the nginx proxy cache, so the SWF will be generated for each client only once, distributed by nginx and the service itself will be quite difficult to put. <br><br><h2>  Together </h2><br>  Configuration example: <br><pre> <code class="bash hljs">server { listen 80; server_name domain.com; testcookie off; testcookie_name BPC; testcookie_secret keepmescret; testcookie_session <span class="hljs-variable"><span class="hljs-variable">$remote_addr</span></span>; testcookie_arg attempt; testcookie_max_attempts 3; testcookie_fallback /cookies.html?backurl=http://<span class="hljs-variable"><span class="hljs-variable">$host</span></span><span class="hljs-variable"><span class="hljs-variable">$request_uri</span></span>; testcookie_get_only on; testcookie_redirect_via_refresh on;</code> </pre><br>  # connect testcookie.swf via swfobject (yes, I'm lazy) <br>  # use testcookie_refresh_template directive, <br>  # pass the value of $ testcookie_nexturl through param <br><pre> <code class="bash hljs"> testcookie_refresh_template <span class="hljs-string"><span class="hljs-string">'&lt;html&gt;&lt;body&gt;&lt;script type="text/javascript" src="/swfobject.js"&gt;&lt;/script&gt;&lt;script type="text/javascript"&gt;swfobject.embedSWF("/testcookie.swf", "cookie_installer", "100", "100", "9.0.0", "/expressInstall.swf", {"nexturl":"$testcookie_nexturl"});&lt;/script&gt;&lt;div id="cookie_installer"&gt;welcome screen&lt;/div&gt;&lt;/body&gt;&lt;/html&gt;'</span></span>;</code> </pre><br>  # disable cookies <br>  # for fallback URL, swfobject.js and expressInstall.swf <br><pre> <code class="bash hljs"> location = /cookies.html { root /var/www/public_html; } location = /swfobject.js { gzip on; gzip_min_length 1000; gzip_types text/plain; root /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/nginx/root; } location = /expressInstall.swf { testcookie off; gzip on; gzip_min_length 1000; gzip_types text/plain; root /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/nginx/root; }</code> </pre><br>  # by this location the service dynamically generates SWF <br><pre> <code class="bash hljs"> location = /testcookie.swf { <span class="hljs-comment"><span class="hljs-comment">#  testcookie   var testcookie var; #  testcookie-flash-processor proxy_pass http://127.0.0.1:1234/; #    cookies proxy_set_header Testcookie-Value $testcookie_set; #    ? #    SWF  , #      cookie proxy_set_header Testcookie-Valid $testcookie_ok; #  cookie -     #   testcookie_name proxy_set_header Testcookie-Name "BPC"; }</span></span></code> </pre><br>  # basic location with backend address <br><pre> <code class="bash hljs"> location / { testcookie on; proxy_set_header Host <span class="hljs-variable"><span class="hljs-variable">$host</span></span>; proxy_set_header X-Real-IP <span class="hljs-variable"><span class="hljs-variable">$remote_addr</span></span>; proxy_pass http://127.0.0.1:8080; } }</code> </pre><br>  Captcha is screwed in the same way. <br><br><h2>  Source texts </h2><br>  Source texts with installation instructions and documentation are available on <a href="http://github.com/kyprizel/testcookie-flash-processor">github</a> under the BSD license. <br>  Patches, add-ons, tests and bug reports are welcome. </div><p>Source: <a href="https://habr.com/ru/post/141989/">https://habr.com/ru/post/141989/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../141983/index.html">Signals and Slots in Qt5</a></li>
<li><a href="../141984/index.html">Japanese are developing ATM with biometrics</a></li>
<li><a href="../141986/index.html">Do you consider yourself a jack of all trades in the household?</a></li>
<li><a href="../141987/index.html">Work with Command Line in .Net</a></li>
<li><a href="../141988/index.html">Guess the movie on the trailer</a></li>
<li><a href="../141991/index.html">Hide USB-Flash to 3.5 "diskette</a></li>
<li><a href="../141994/index.html">Webinar: How to write the first test on Selenium</a></li>
<li><a href="../141995/index.html">The Magic Repository: Integrating Spring Data-JPA and Google Guice</a></li>
<li><a href="../141996/index.html">Cache + jQuery. Fast start</a></li>
<li><a href="../141997/index.html">Area for Moscow</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>