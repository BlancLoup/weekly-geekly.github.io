<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>DHCP + Mysql server in Python</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The purpose of this project was: 



- Learning DHCP when using IPv4 
- Learning Python (a little more than zero;)) 
- replacing the DB2DHCP server (m...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>DHCP + Mysql server in Python</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/webt/ju/n4/fb/jun4fbrj-eabxfgou112uxc5lac.png"><br><br>  The purpose of this project was: <br><br><ul><li>  Learning DHCP when using IPv4 </li><li>  Learning Python (a little more than zero;)) </li><li>  replacing the <a href="https://xn--90acbu5aj5f.xn--p1ai/%3Fpage_id%3D2680">DB2DHCP</a> server (my fork), the original is <a href="http://www.netpatch.ru/devel/db2dhcp/">here</a> , which is harder and harder to build for a new OS.  And I don‚Äôt like that binary, which is not possible to ‚Äúchange right now‚Äù </li><li>  getting a workable DHCP server with the option of fetching the subscriber‚Äôs IP address by subscriber's mac or a bunch of mac switches + port (Option 82) </li><li>  writing the next bike (Oh! this is my favorite activity) </li><li>  getting lyuley about his kosorukost on Habrahabr (and better invite);) </li></ul><br>  Result: works;) Tested on FreeBSD OS and Ubuntu.  Theoretically, the code can be asked to work under any OS, since  There are no specific bindings in the code. <br>  Caution!  Then a lot. <br><a name="habracut"></a><br>  Link to the repository for fans of <a href="https://github.com/donpadlo/dhcp2dbpy">"touch alive</a> . <a href="https://github.com/donpadlo/dhcp2dbpy">"</a> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The process of installing, configuring, and using the result of ‚Äústudying the materiel‚Äù is much lower, and then a little bit of theory using the DHCP protocol.  For myself.  And for the story;) <br><br><h1>  Little theory </h1><br><h2>  What is DHCP? </h2><br>  This is a network protocol that allows a device to find out its IP address (well, other parameters like a gateway, DNS, etc.) from a DHCP server.  Packet exchange is via UDP protocol.  The general principle of operation of the device when requesting network parameters is as follows: <br><br><ol><li>  The device (client) sends a broadcast UDP request (DHCPDISCOVER) throughout the network with the request "well, someone, give me an IP address."  And usually (but not always) the request occurs from port 68 (source), and the destination is port 67 (destination).  Some devices also send packets from port 67.  Inside the DHCPDISCOVER packet, the MAC address of the client device is included. </li><li>  All DHCP servers that are on the network (and there may be several) form the DHCPOFFER offer with network settings for the device that sent the DHCPDISCOVER, and also broadcast it over the network.  Identification to whom this packet is intended goes to the MAC address of the client provided earlier in the DHCPDISCOVER request. </li><li>  The client accepts packets with network settings, selects the most attractive (criteria may be different, for example, including packet delivery time, number of intermediate routes), and makes the DHCPREQUEST ‚Äúofficial request‚Äù with network settings for the DHCP server you like.  In this case, the packet goes to a specific DHCP server. </li><li>  The server that received the DHCPREQUEST sends a packet in the DHCPACK format, in which it once again lists the network settings intended for this client </li></ol><br><img src="https://habrastorage.org/webt/ki/vj/cn/kivjcno-qcqpx8jgqxra1rnspvi.png"><br><br>  In addition, there are DHCPINFORM packages that come from the client, and the purpose of which is to inform the DHCP server that the ‚Äúclient is alive‚Äù and uses the issued network settings.  In the implementation of this server, these packages are ignored. <br><br><h2>  Package format </h2><br><br>  In general, an Ethernet packet frame looks like this: <br><br><img src="https://habrastorage.org/webt/x6/uj/n0/x6ujn0ood0nch96zosj6ldkjt4s.png"><br><br>  In our case, we consider only the data directly from the contents of the UDP packet, without the protocol headers of the OSI layers, namely the DHCP structure: <br><br><h3>  DHCPDISCOVER </h3><br>  So, the process of obtaining an IP address for a device begins with the fact that a DHCP client sends a broadcast request from port 68 to 255.255.255.255:67.  In this package, the client includes its MAC address, as well as what exactly it wants to receive from the DHCP server.  The package structure is described in the table below. <br><br><div class="spoiler">  <b class="spoiler_title">DHCPDISCOVER package structure table</b> <div class="spoiler_text"><table border="1"><tbody><tr><td align="left">  Package Position </td><td align="left">  Name of the value </td><td align="right">  Example </td><td align="center">  Representation </td><td align="center">  Byte </td><td align="left">  Explanation </td></tr><tr><td align="right">  one </td><td align="left">  Boot request </td><td align="right">  one </td><td align="center">  Hex </td><td align="right">  one </td><td align="left">  Message type  1 - request from client to server, 2 - response from server to client </td></tr><tr><td align="right">  2 </td><td align="left">  Hardware type </td><td align="right">  one </td><td align="center">  Hex </td><td align="right">  one </td><td align="left">  Type of hardware address in this protocol 1 - MAC </td></tr><tr><td align="right">  3 </td><td align="left">  Hardware adrees length </td><td align="right">  6 </td><td align="center">  Hex </td><td align="right">  one </td><td align="left">  MAC address length </td></tr><tr><td align="right">  four </td><td align="left">  Hops </td><td align="right">  one </td><td align="center">  Hex </td><td align="right">  one </td><td align="left">  Number of intermediate routes </td></tr><tr><td align="right">  five </td><td align="left">  Transaction ID </td><td align="right">  23: cf: de: 1d </td><td align="center">  Hex </td><td align="right">  four </td><td align="left">  The unique identifier of the transaction.  Generates the client at the beginning of the request operation </td></tr><tr><td align="right">  7 </td><td align="left">  Second elapsed </td><td align="right">  0 </td><td align="center">  Hex </td><td align="right">  four </td><td align="left">  Time in seconds since the beginning of the process of obtaining the address </td></tr><tr><td align="right">  9 </td><td align="left">  Bootp flags </td><td align="right">  0 </td><td align="center">  Hex </td><td align="right">  2 </td><td align="left">  Some flags that can be set, as an indication of the parameters of the protocol </td></tr><tr><td align="right">  eleven </td><td align="left">  Client IP address </td><td align="right">  0.0.0.0 </td><td align="center">  Line </td><td align="right">  four </td><td align="left">  Client IP address (if any) </td></tr><tr><td align="right">  15 </td><td align="left">  Your client IP address </td><td align="right">  0.0.0.0 </td><td align="center">  Line </td><td align="right">  four </td><td align="left">  IP address offered by the server (if any) </td></tr><tr><td align="right">  nineteen </td><td align="left">  Next server IP address </td><td align="right">  0.0.0.0 </td><td align="center">  Line </td><td align="right">  four </td><td align="left">  Server IP (if known) </td></tr><tr><td align="right">  23 </td><td align="left">  Relay agent IP address </td><td align="right">  172.16.114.41 </td><td align="center">  Line </td><td align="right">  four </td><td align="left">  IP address of relay agent (for example, switch) </td></tr><tr><td align="right">  27 </td><td align="left">  Client MAC address </td><td align="right">  14: d6: 4d: a7: c9: 55 </td><td align="center">  Hex </td><td align="right">  6 </td><td align="left">  MAC address of the sender of the packet (client) </td></tr><tr><td align="right">  31 </td><td align="left">  Client hardware address padding </td><td align="right"></td><td align="center">  Hex </td><td align="right">  ten </td><td align="left">  Reserved place.  Usually filled with zeros </td></tr><tr><td align="right">  41 </td><td align="left">  Server host name </td><td align="right"></td><td align="center">  Line </td><td align="right">  64 </td><td align="left">  The name of the DHCP server.  Normally not transmitted </td></tr><tr><td align="right">  105 </td><td align="left">  Boot file name </td><td align="right"></td><td align="center">  Line </td><td align="right">  128 </td><td align="left">  The file name on the server used by diskless stations when booting </td></tr><tr><td align="right">  235 </td><td align="left">  Magic cookie </td><td align="right">  63: 82: 53: 63 </td><td align="center">  Hex </td><td align="right">  four </td><td align="left">  The "magic" number by which including  it can be determined that this packet belongs to the DHCP protocol </td></tr><tr><td colspan="7" align="center">  DHCP options.  Can go in any order </td></tr><tr><td align="right">  236 </td><td align="left">  Option number </td><td align="right">  53 </td><td align="center">  Dec </td><td align="right">  one </td><td rowspan="3" align="left">  Option 53 defining the type of DHCP packet <br><br>  1 - DHCPDISCOVER <br>  3 - DHCPREQUEST <br>  2 - DHCPOFFER <br>  5 - DHCPACK <br>  8 - DHCPINFORM </td></tr><tr><td align="left"></td><td align="left">  Option length </td><td align="right">  one </td><td align="center">  Dec </td><td align="right">  one </td></tr><tr><td align="left"></td><td align="left">  Option value </td><td align="right">  one </td><td align="center">  Dec </td><td align="right">  one </td></tr><tr><td align="left"></td><td align="left">  Option number </td><td align="right">  50 </td><td align="center">  Dec </td><td align="right">  one </td><td rowspan="3" align="left">  What IP address does the client want to receive </td></tr><tr><td align="left"></td><td align="left">  Option length </td><td align="right">  four </td><td align="center">  Dec </td><td align="right">  one </td></tr><tr><td align="left"></td><td align="left">  Option value </td><td align="right">  172.16.134.61 </td><td align="center">  Line </td><td align="right">  four </td></tr><tr><td align="left"></td><td align="left">  Option number </td><td align="right">  55 </td><td align="center"></td><td align="right">  one </td><td rowspan="3" align="left">  The network parameters requested by the client.  The composition may be different <br><br>  01 - net mask <br>  03 - Gateway <br>  06 - DNS <br>  oc - Host Name <br>  0f - network domain name <br>  1c - address of the broadcast request (Broadcast) <br>  42 - TFTP server name <br>  79 - Classless Static Route </td></tr><tr><td align="left"></td><td align="left">  Option length </td><td align="right">  eight </td><td align="center"></td><td align="right">  one </td></tr><tr><td align="left"></td><td align="left">  Option value </td><td align="right">  01: 03: 06: 0c: 0f: 1c: 42: 79 </td><td align="center"></td><td align="right">  eight </td></tr><tr><td align="left"></td><td align="left">  Option number </td><td align="right">  82 </td><td align="center">  Dec </td><td align="left"></td><td rowspan="3" align="left">  Option 82, in which the MAC address of the repeater device and some additional values ‚Äã‚Äãare transmitted. <br><br>  Most often, the switch port on which the final DHCP client is running. This option is ‚Äúnested‚Äù with additional parameters. The first byte is the ‚Äúsuboption‚Äù number, the second is its length, then its value. <br><br>  In this case, in option 82, the suboptions are nested: <br>  Agent Circuit ID = 00: 04: 00: 01: 00: 04, where the last two bytes are the DHCP client port from which the request came <br><br>  Agent Remote ID = 00: 06: c8: be: 19: 93: 11: 48 - the MAC address of the device of the DHCP relay </td></tr><tr><td align="left"></td><td align="left">  Option length </td><td align="right">  18 </td><td align="center">  Dec </td><td align="left"></td></tr><tr><td align="left"></td><td align="left">  Option value </td><td align="right">  01:06 <br>  00: 04: 00: 01: 00: 04 <br>  02:08 <br>  00: 06: c8: be: 19: 93: 11: 48 </td><td align="center">  Hex </td><td align="left"></td></tr><tr><td align="left"></td><td align="left">  End of package </td><td align="right">  255 </td><td align="center">  Dec </td><td align="right">  one </td><td align="left">  255 symbolizes the end of the pack. </td></tr></tbody></table><br></div></div><br><h3>  DHCPOFFER </h3><br>  As soon as the server receives the DHCPDISCOVER packet and if it sees that it can offer the client something from the requested one, then it forms the answer for it - DHCPOFFER.  The answer is sent to the port ‚Äúfrom where it came‚Äù, by Broadcast, since  At this moment, the client does not yet have an IP address, therefore he can only accept the packet if he has been sent by broadcast.  The client recognizes that this is a package for him by his MAC address inside the package, as well as the transaction number that he generates at the time of the creation of the first package. <br><br><div class="spoiler">  <b class="spoiler_title">DHCPOFFER packet structure table</b> <div class="spoiler_text"><table border="1"><tbody><tr><td align="left">  Package Position </td><td align="left">  Name of value (common) </td><td align="right">  Example </td><td align="center">  Representation </td><td align="center">  Byte </td><td align="left">  Explanation </td></tr><tr><td align="right">  one </td><td align="left">  Boot request </td><td align="right">  one </td><td align="center">  Hex </td><td align="right">  one </td><td align="left">  Message type  1 - request from client to server, 2 - response from server to client </td></tr><tr><td align="right">  2 </td><td align="left">  Hardware type </td><td align="right">  one </td><td align="center">  Hex </td><td align="right">  one </td><td align="left">  Type of hardware address in this protocol 1 - MAC </td></tr><tr><td align="right">  3 </td><td align="left">  Hardware adrees length </td><td align="right">  6 </td><td align="center">  Hex </td><td align="right">  one </td><td align="left">  MAC address length </td></tr><tr><td align="right">  four </td><td align="left">  Hops </td><td align="right">  one </td><td align="center">  Hex </td><td align="right">  one </td><td align="left">  Number of intermediate routes </td></tr><tr><td align="right">  five </td><td align="left">  Transaction ID </td><td align="right">  23: cf: de: 1d </td><td align="center">  Hex </td><td align="right">  four </td><td align="left">  The unique identifier of the transaction.  Generates the client at the beginning of the request operation </td></tr><tr><td align="right">  7 </td><td align="left">  Second elapsed </td><td align="right">  0 </td><td align="center">  Hex </td><td align="right">  four </td><td align="left">  Time in seconds since the beginning of the process of obtaining the address </td></tr><tr><td align="right">  9 </td><td align="left">  Bootp flags </td><td align="right">  0 </td><td align="center">  Hex </td><td align="right">  2 </td><td align="left">  Some flags that can be set, as an indication of the parameters of the protocol.  In this case, 0 indicates the type of Unicast request. </td></tr><tr><td align="right">  eleven </td><td align="left">  Client IP address </td><td align="right">  0.0.0.0 </td><td align="center">  Line </td><td align="right">  four </td><td align="left">  Client IP address (if any) </td></tr><tr><td align="right">  15 </td><td align="left">  Your client IP address </td><td align="right">  172.16.134.61 </td><td align="center">  Line </td><td align="right">  four </td><td align="left">  IP address offered by the server (if any) </td></tr><tr><td align="right">  nineteen </td><td align="left">  Next server IP address </td><td align="right">  0.0.0.0 </td><td align="center">  Line </td><td align="right">  four </td><td align="left">  Server IP (if known) </td></tr><tr><td align="right">  23 </td><td align="left">  Relay agent IP address </td><td align="right">  172.16.114.41 </td><td align="center">  Line </td><td align="right">  four </td><td align="left">  IP address of relay agent (for example, switch) </td></tr><tr><td align="right">  27 </td><td align="left">  Client MAC address </td><td align="right">  14: d6: 4d: a7: c9: 55 </td><td align="center">  Hex </td><td align="right">  6 </td><td align="left">  MAC address of the sender of the packet (client) </td></tr><tr><td align="right">  31 </td><td align="left">  Client hardware address padding </td><td align="right"></td><td align="center">  Hex </td><td align="right">  ten </td><td align="left">  Reserved place.  Usually filled with zeros </td></tr><tr><td align="right">  41 </td><td align="left">  Server host name </td><td align="right"></td><td align="center">  Line </td><td align="right">  64 </td><td align="left">  The name of the DHCP server.  Normally not transmitted </td></tr><tr><td align="right">  105 </td><td align="left">  Boot file name </td><td align="right"></td><td align="center">  Line </td><td align="right">  128 </td><td align="left">  The file name on the server used by diskless stations when booting </td></tr><tr><td align="right">  235 </td><td align="left">  Magic cookie </td><td align="right">  63: 82: 53: 63 </td><td align="center">  Hex </td><td align="right">  four </td><td align="left">  The "magic" number by which including  it can be determined that this packet belongs to the DHCP protocol </td></tr><tr><td colspan="6" align="center">  DHCP options.  Can go in any order </td></tr><tr><td align="right">  236 </td><td align="left">  Option number </td><td align="right">  53 </td><td align="center">  Dec </td><td align="right">  one </td><td rowspan="3" align="left">  Option 53 defining DHCP 2 packet type - DHCPOFFER </td></tr><tr><td align="left"></td><td align="left">  Option length </td><td align="right">  one </td><td align="center">  Dec </td><td align="right">  one </td></tr><tr><td align="left"></td><td align="left">  Option value </td><td align="right">  2 </td><td align="center">  Dec </td><td align="right">  one </td></tr><tr><td align="left"></td><td align="left">  Option number </td><td align="right">  one </td><td align="center">  Dec </td><td align="right">  one </td><td rowspan="3" align="left">  Option offering DHCP client network mask </td></tr><tr><td align="left"></td><td align="left">  Option length </td><td align="right">  four </td><td align="center">  Dec </td><td align="right">  one </td></tr><tr><td align="left"></td><td align="left">  Option value </td><td align="right">  255.255.224.0 </td><td align="center">  Line </td><td align="right">  four </td></tr><tr><td align="left"></td><td align="left">  Option number </td><td align="right">  3 </td><td align="center">  Dec </td><td align="right">  one </td><td rowspan="3" align="left">  Option offering DHCP client default gateway </td></tr><tr><td align="left"></td><td align="left">  Option length </td><td align="right">  four </td><td align="center">  Dec </td><td align="right">  one </td></tr><tr><td align="left"></td><td align="left">  Option value </td><td align="right">  172.16.12.1 </td><td align="center">  Line </td><td align="right">  four </td></tr><tr><td align="left"></td><td align="left">  Option number </td><td align="right">  6 </td><td align="center">  Dec </td><td align="right">  one </td><td rowspan="3" align="left">  Option offering DHCP client DNS </td></tr><tr><td align="left"></td><td align="left">  Option length </td><td align="right">  four </td><td align="center">  Dec </td><td align="right">  one </td></tr><tr><td align="left"></td><td align="left">  Option value </td><td align="right">  8.8.8.8 </td><td align="center">  Line </td><td align="right">  four </td></tr><tr><td align="left"></td><td align="left">  Option number </td><td align="right">  51 </td><td align="center">  Dec </td><td align="right">  one </td><td rowspan="3" align="left">  The lifetime of the issued network parameters in seconds after which the DHCP client must request them again </td></tr><tr><td align="left"></td><td align="left">  Option length </td><td align="right">  four </td><td align="center">  Dec </td><td align="right">  one </td></tr><tr><td align="left"></td><td align="left">  Option value </td><td align="right">  86400 </td><td align="center">  Dec </td><td align="right">  four </td></tr><tr><td align="left"></td><td align="left">  Option number </td><td align="right">  82 </td><td align="center">  Dec </td><td align="right">  one </td><td rowspan="3" align="left">  Option 82, repeats what came in DHCPDISCOVER </td></tr><tr><td align="left"></td><td align="left">  Option length </td><td align="right">  18 </td><td align="center">  Dec </td><td align="right">  one </td></tr><tr><td align="left"></td><td align="left">  Option value </td><td align="right">  01: 08: 00: 06: 00 <br>  01: 01: 00: 00: 01 <br>  02: 06: 00: 03: 0f <br>  26: 4d: ec </td><td align="center">  Dec </td><td align="right">  18 </td></tr><tr><td align="left"></td><td align="left">  End of package </td><td align="right">  255 </td><td align="center">  Dec </td><td align="right">  one </td><td align="left">  255 symbolizes the end of the pack. </td></tr></tbody></table><br></div></div><br><h3>  DHCPREQUEST </h3><br>  After the client receives a DHCPOFFER, it forms a packet requesting the network parameters not to all DHCP servers on the network, but only to one specific one, the DHCPOFFER offer of which he liked the most.  The ‚Äúliked‚Äù criteria may be different and depend on the implementation of the DHCP client.  The recipient of the request is indicated by the MAC address of the DHCP server.  Also, the DHCPREQUEST packet can be sent by the client without having previously formed a DHCPDISCOVER if the server‚Äôs IP address was previously received. <br><br><div class="spoiler">  <b class="spoiler_title">DHCPREQUEST packet structure table</b> <div class="spoiler_text"><table border="1"><tbody><tr><td align="left">  Package Position </td><td align="left">  Name of value (common) </td><td align="right">  Example </td><td align="center">  Representation </td><td align="center">  Byte </td><td align="left">  Explanation </td></tr><tr><td align="right">  one </td><td align="left">  Boot request </td><td align="right">  one </td><td align="center">  Hex </td><td align="right">  one </td><td align="left">  Message type  1 - request from client to server, 2 - response from server to client </td></tr><tr><td align="right">  2 </td><td align="left">  Hardware type </td><td align="right">  one </td><td align="center">  Hex </td><td align="right">  one </td><td align="left">  Type of hardware address in this protocol 1 - MAC </td></tr><tr><td align="right">  3 </td><td align="left">  Hardware adrees length </td><td align="right">  6 </td><td align="center">  Hex </td><td align="right">  one </td><td align="left">  MAC address length </td></tr><tr><td align="right">  four </td><td align="left">  Hops </td><td align="right">  one </td><td align="center">  Hex </td><td align="right">  one </td><td align="left">  Number of intermediate routes </td></tr><tr><td align="right">  five </td><td align="left">  Transaction ID </td><td align="right">  23: cf: de: 1d </td><td align="center">  Hex </td><td align="right">  four </td><td align="left">  The unique identifier of the transaction.  Generates the client at the beginning of the request operation </td></tr><tr><td align="right">  7 </td><td align="left">  Second elapsed </td><td align="right">  0 </td><td align="center">  Hex </td><td align="right">  four </td><td align="left">  Time in seconds since the beginning of the process of obtaining the address </td></tr><tr><td align="right">  9 </td><td align="left">  Bootp flags </td><td align="right">  8,000 </td><td align="center">  Hex </td><td align="right">  2 </td><td align="left">  Some flags that can be set, as an indication of the protocol parameters.  In this case, ‚ÄúBroadcast‚Äù is set. </td></tr><tr><td align="right">  eleven </td><td align="left">  Client IP address </td><td align="right">  0.0.0.0 </td><td align="center">  Line </td><td align="right">  four </td><td align="left">  Client IP address (if any) </td></tr><tr><td align="right">  15 </td><td align="left">  Your client IP address </td><td align="right">  172.16.134.61 </td><td align="center">  Line </td><td align="right">  four </td><td align="left">  IP address offered by the server (if any) </td></tr><tr><td align="right">  nineteen </td><td align="left">  Next server IP address </td><td align="right">  0.0.0.0 </td><td align="center">  Line </td><td align="right">  four </td><td align="left">  Server IP (if known) </td></tr><tr><td align="right">  23 </td><td align="left">  Relay agent IP address </td><td align="right">  172.16.114.41 </td><td align="center">  Line </td><td align="right">  four </td><td align="left">  IP address of relay agent (for example, switch) </td></tr><tr><td align="right">  27 </td><td align="left">  Client MAC address </td><td align="right">  14: d6: 4d: a7: c9: 55 </td><td align="center">  Hex </td><td align="right">  6 </td><td align="left">  MAC address of the sender of the packet (client) </td></tr><tr><td align="right">  31 </td><td align="left">  Client hardware address padding </td><td align="right"></td><td align="center">  Hex </td><td align="right">  ten </td><td align="left">  Reserved place.  Usually filled with zeros </td></tr><tr><td align="right">  41 </td><td align="left">  Server host name </td><td align="right"></td><td align="center">  Line </td><td align="right">  64 </td><td align="left">  The name of the DHCP server.  Normally not transmitted </td></tr><tr><td align="right">  105 </td><td align="left">  Boot file name </td><td align="right"></td><td align="center">  Line </td><td align="right">  128 </td><td align="left">  The file name on the server used by diskless stations when booting </td></tr><tr><td align="right">  235 </td><td align="left">  Magic cookie </td><td align="right">  63: 82: 53: 63 </td><td align="center">  Hex </td><td align="right">  four </td><td align="left">  The "magic" number by which including  it can be determined that this packet belongs to the DHCP protocol </td></tr><tr><td colspan="6" align="center">  DHCP options.  Can go in any order </td></tr><tr><td align="right">  236 </td><td align="left">  Option number </td><td align="right">  53 </td><td align="center">  Dec </td><td align="right">  3 </td><td rowspan="3" align="left">  Option 53 defining DHCP 3 packet type - DHCPREQUEST </td></tr><tr><td align="left"></td><td align="left">  Option length </td><td align="right">  one </td><td align="center">  Dec </td><td align="right">  one </td></tr><tr><td align="left"></td><td align="left">  Option value </td><td align="right">  3 </td><td align="center">  Dec </td><td align="right">  one </td></tr><tr><td align="left"></td><td align="left">  Option number </td><td align="right">  61 </td><td align="center">  Dec </td><td align="right">  one </td><td rowspan="3" align="left">  Client ID: 01 (for Ehernet) + client MAC address </td></tr><tr><td align="left"></td><td align="left">  Option length </td><td align="right">  7 </td><td align="center">  Dec </td><td align="right">  one </td></tr><tr><td align="left"></td><td align="left">  Option value </td><td align="right">  01: 2c: ab: 25: ff: 72: a6 </td><td align="center">  Hex </td><td align="right">  7 </td></tr><tr><td align="left"></td><td align="left">  Option number </td><td align="right">  60 </td><td align="center">  Dec </td><td align="left"></td><td rowspan="3" align="left">  "Vendor class identifier".  In my case, it reports the DHCP client version.  Perhaps other devices return something else.  Windows for example reports MSFT 5.0 </td></tr><tr><td align="left"></td><td align="left">  Option length </td><td align="right">  eleven </td><td align="center">  Dec </td><td align="left"></td></tr><tr><td align="left"></td><td align="left">  Option value </td><td align="right">  udhcp 0.9.8 </td><td align="center">  Line </td><td align="left"></td></tr><tr><td align="left"></td><td align="left">  Option number </td><td align="right">  55 </td><td align="center"></td><td align="right">  one </td><td rowspan="3" align="left">  The network parameters requested by the client.  The composition may be different <br><br>  01 - net mask <br>  03 - Gateway <br>  06 - DNS <br>  oc - Host Name <br>  0f - network domain name <br>  1c - address of the broadcast request (Broadcast) <br>  42 - TFTP server name <br>  79 - Classless Static Route </td></tr><tr><td align="left"></td><td align="left">  Option length </td><td align="right">  eight </td><td align="center"></td><td align="right">  one </td></tr><tr><td align="left"></td><td align="left">  Option value </td><td align="right">  01: 03: 06: 0c: 0f: 1c: 42: 79 </td><td align="center"></td><td align="right">  eight </td></tr><tr><td align="left"></td><td align="left">  Option number </td><td align="right">  82 </td><td align="center">  Dec </td><td align="right">  one </td><td rowspan="3" align="left">  Option 82, repeats what came in DHCPDISCOVER </td></tr><tr><td align="left"></td><td align="left">  Option length </td><td align="right">  18 </td><td align="center">  Dec </td><td align="right">  one </td></tr><tr><td align="left"></td><td align="left">  Option value </td><td align="right">  01: 08: 00: 06: 00 <br>  01: 01: 00: 00: 01 <br>  02: 06: 00: 03: 0f <br>  26: 4d: ec </td><td align="center">  Dec </td><td align="right">  18 </td></tr><tr><td align="left"></td><td align="left">  End of package </td><td align="right">  255 </td><td align="center">  Dec </td><td align="right">  one </td><td align="left">  255 symbolizes the end of the pack. </td></tr></tbody></table><br></div></div><br>
<h3>  DHCPACK </h3><br>  As a confirmation of the fact that ‚Äúyes for sure, this is your IP address, and I will not give it out to anyone else‚Äù from a DHCP server, the packet is in DHCPACK format from the server to the client.  He is the same as the rest of the packages sent to the broadcast.  Although, in the code below, the DHCP server is implemented in Python, I just in case duplicate any broadcast request by sending a packet to a specific client IP, if it is already known.  Moreover, the DHCP server does not care at all whether the DHCPACK packet reached the client.  If the client does not receive a DHCPACK, then after a while it simply repeats the DHCPREQUEST <br><br><div class="spoiler">  <b class="spoiler_title">DHCPACK packet structure table</b> <div class="spoiler_text"><table border="1"><tbody><tr><td align="left">  Package Position </td><td align="left">  Name of value (common) </td><td align="right">  Example </td><td align="center">  Representation </td><td align="center">  Byte </td><td align="left">  Explanation </td></tr><tr><td align="right">  one </td><td align="left">  Boot request </td><td align="right">  2 </td><td align="center">  Hex </td><td align="right">  one </td><td align="left">  Message type  1 - request from client to server, 2 - response from server to client </td></tr><tr><td align="right">  2 </td><td align="left">  Hardware type </td><td align="right">  one </td><td align="center">  Hex </td><td align="right">  one </td><td align="left">  Type of hardware address in this protocol 1 - MAC </td></tr><tr><td align="right">  3 </td><td align="left">  Hardware adrees length </td><td align="right">  6 </td><td align="center">  Hex </td><td align="right">  one </td><td align="left">  MAC address length </td></tr><tr><td align="right">  four </td><td align="left">  Hops </td><td align="right">  one </td><td align="center">  Hex </td><td align="right">  one </td><td align="left">  Number of intermediate routes </td></tr><tr><td align="right">  five </td><td align="left">  Transaction ID </td><td align="right">  23: cf: de: 1d </td><td align="center">  Hex </td><td align="right">  four </td><td align="left">  The unique identifier of the transaction.  Generates the client at the beginning of the request operation </td></tr><tr><td align="right">  7 </td><td align="left">  Second elapsed </td><td align="right">  0 </td><td align="center">  Hex </td><td align="right">  four </td><td align="left">  Time in seconds since the beginning of the process of obtaining the address </td></tr><tr><td align="right">  9 </td><td align="left">  Bootp flags </td><td align="right">  8,000 </td><td align="center">  Hex </td><td align="right">  2 </td><td align="left">  Some flags that can be set, as an indication of the protocol parameters.  In this case, ‚ÄúBroadcast‚Äù is set. </td></tr><tr><td align="right">  eleven </td><td align="left">  Client IP address </td><td align="right">  0.0.0.0 </td><td align="center">  Line </td><td align="right">  four </td><td align="left">  Client IP address (if any) </td></tr><tr><td align="right">  15 </td><td align="left">  Your client IP address </td><td align="right">  172.16.134.61 </td><td align="center">  Line </td><td align="right">  four </td><td align="left">  IP address offered by the server (if any) </td></tr><tr><td align="right">  nineteen </td><td align="left">  Next server IP address </td><td align="right">  0.0.0.0 </td><td align="center">  Line </td><td align="right">  four </td><td align="left">  Server IP (if known) </td></tr><tr><td align="right">  23 </td><td align="left">  Relay agent IP address </td><td align="right">  172.16.114.41 </td><td align="center">  Line </td><td align="right">  four </td><td align="left">  IP address of relay agent (for example, switch) </td></tr><tr><td align="right">  27 </td><td align="left">  Client MAC address </td><td align="right">  14: d6: 4d: a7: c9: 55 </td><td align="center">  Hex </td><td align="right">  6 </td><td align="left">  MAC address of the sender of the packet (client) </td></tr><tr><td align="right">  31 </td><td align="left">  Client hardware address padding </td><td align="right"></td><td align="center">  Hex </td><td align="right">  ten </td><td align="left">  Reserved place.  Usually filled with zeros </td></tr><tr><td align="right">  41 </td><td align="left">  Server host name </td><td align="right"></td><td align="center">  Line </td><td align="right">  64 </td><td align="left">  The name of the DHCP server.  Normally not transmitted </td></tr><tr><td align="right">  105 </td><td align="left">  Boot file name </td><td align="right"></td><td align="center">  Line </td><td align="right">  128 </td><td align="left">  The file name on the server used by diskless stations when booting </td></tr><tr><td align="right">  235 </td><td align="left">  Magic cookie </td><td align="right">  63: 82: 53: 63 </td><td align="center">  Hex </td><td align="right">  four </td><td align="left">  The "magic" number by which including  it can be determined that this packet belongs to the DHCP protocol </td></tr><tr><td colspan="6" align="center">  DHCP options.  Can go in any order </td></tr><tr><td align="right">  236 </td><td align="left">  Option number </td><td align="right">  53 </td><td align="center">  Dec </td><td align="right">  3 </td><td rowspan="3" align="left">  Option 53 defining the type of DHCP packet 5 - DHCPACK </td></tr><tr><td align="left"></td><td align="left">  Option length </td><td align="right">  one </td><td align="center">  Dec </td><td align="right">  one </td></tr><tr><td align="left"></td><td align="left">  Option value </td><td align="right">  five </td><td align="center">  Dec </td><td align="right">  one </td></tr><tr><td align="left"></td><td align="left">  Option number </td><td align="right">  one </td><td align="center">  Dec </td><td align="right">  one </td><td rowspan="3" align="left">  Option offering DHCP client network mask </td></tr><tr><td align="left"></td><td align="left">  Option length </td><td align="right">  four </td><td align="center">  Dec </td><td align="right">  one </td></tr><tr><td align="left"></td><td align="left">  Option value </td><td align="right">  255.255.224.0 </td><td align="center">  Line </td><td align="right">  four </td></tr><tr><td align="left"></td><td align="left">  Option number </td><td align="right">  3 </td><td align="center">  Dec </td><td align="right">  one </td><td rowspan="3" align="left">  Option offering DHCP client default gateway </td></tr><tr><td align="left"></td><td align="left">  Option length </td><td align="right">  four </td><td align="center">  Dec </td><td align="right">  one </td></tr><tr><td align="left"></td><td align="left">  Option value </td><td align="right">  172.16.12.1 </td><td align="center">  Line </td><td align="right">  four </td></tr><tr><td align="left"></td><td align="left">  Option number </td><td align="right">  6 </td><td align="center">  Dec </td><td align="right">  one </td><td rowspan="3" align="left">  Option offering DHCP client DNS </td></tr><tr><td align="left"></td><td align="left">  Option length </td><td align="right">  four </td><td align="center">  Dec </td><td align="right">  one </td></tr><tr><td align="left"></td><td align="left">  Option value </td><td align="right">  8.8.8.8 </td><td align="center">  Line </td><td align="right">  four </td></tr><tr><td align="left"></td><td align="left">  Option number </td><td align="right">  51 </td><td align="center">  Dec </td><td align="right">  one </td><td rowspan="3" align="left">  The lifetime of the issued network parameters in seconds after which the DHCP client must request them again </td></tr><tr><td align="left"></td><td align="left">  Option length </td><td align="right">  four </td><td align="center">  Dec </td><td align="right">  one </td></tr><tr><td align="left"></td><td align="left">  Option value </td><td align="right">  86400 </td><td align="center">  Dec </td><td align="right">  four </td></tr><tr><td align="left"></td><td align="left">  Option number </td><td align="right">  82 </td><td align="center">  Dec </td><td align="right">  one </td><td rowspan="3" align="left">  Option 82, repeats what came in DHCPDISCOVER </td></tr><tr><td align="left"></td><td align="left">  Option length </td><td align="right">  18 </td><td align="center">  Dec </td><td align="right">  one </td></tr><tr><td align="left"></td><td align="left">  Option value </td><td align="right">  01: 08: 00: 06: 00 <br>  01: 01: 00: 00: 01 <br>  02: 06: 00: 03: 0f <br>  26: 4d: ec </td><td align="center">  Dec </td><td align="right">  18 </td></tr><tr><td align="left"></td><td align="left">  End of package </td><td align="right">  255 </td><td align="center">  Dec </td><td align="right">  one </td><td align="left">  255 symbolizes the end of the pack. </td></tr></tbody></table><br></div></div><br><br><h1>  Installation </h1><br>  Installation actually consists in installation of the python modules necessary for work.  It is assumed that MySQL is already installed and configured. <br><br><h2>  Freebsd </h2><br><pre>  pkg install python3
 python3 -m ensurepip
 pip3 install mysql-connector </pre><br><h2>  Ubuntu </h2><br><pre>  sudo apt-get install python3
 sudo apt-get install pip3
 sudo pip3 install mysql-connector </pre><br>  We create a MySQL database, upload the pydhcp.sql dump into it, configure the configuration file. <br><br><h1>  Configuration </h1><br>  All server settings are in the xml file.  Reference file: <br><br><pre>  &lt;? xml version = "1.0"?&gt;
 &lt;config&gt;
     &lt;dhcpserver&gt;
	 &lt;host&gt; 0.0.0.0 &lt;/ host&gt;
         &lt;broadcast&gt; 255.255.255.255 &lt;/ broadcast&gt;
         &lt;DHCPServer&gt; 192.168.0.71 &lt;/ DHCPServer&gt;
	 &lt;LeaseTime&gt; 8600 &lt;/ LeaseTime&gt;
	 &lt;ThreadLimit&gt; 1 &lt;/ ThreadLimit&gt;
         &lt;defaultMask&gt; 255.255.255.0 &lt;/ defaultMask&gt;
         &lt;defaultRouter&gt; 192.168.0.1 &lt;/ defaultRouter&gt;
         &lt;defaultDNS&gt; 8.8.8.8 &lt;/ defaultDNS&gt;
     &lt;/ dhcpserver&gt;
     &lt;mysql&gt;
         &lt;host&gt; localhost &lt;/ host&gt;
	 &lt;username&gt; test &lt;/ username&gt;
	 &lt;password&gt; test &lt;/ password&gt;
	 &lt;basename&gt; pydhcp &lt;/ basename&gt;
     &lt;/ mysql&gt;
     &lt;options&gt;
        &lt;option&gt; option_82_hex: sw_port1: 20: 22 &lt;/ option&gt;       
        &lt;option&gt; option_82_hex: sw_port2: 16: 18 &lt;/ option&gt;       
        &lt;option&gt; option_82_hex: sw_mac: 26: 40 &lt;/ option&gt;
     &lt;/ options&gt;    
     &lt;query&gt;
         &lt;offer_count&gt; 3 &lt;/ offer_count&gt;
	 &lt;offer_1&gt; select ip, mask, router, dns from users where upper (mac) = upper ('{option_82_AgentRemoteId_hex}') and upper (port) = upper ('{option_82_AgentCircuitId_port_hex}') &lt;/ offer_1&gt;
         &lt;offer_2&gt; select ip, mask, router, dns from users where upper (mac) = upper ('{sw_mac}') and upper (port) = upper ('{sw_port2}') &lt;/ offer_2&gt;
         &lt;offer_3&gt; select ip, mask, router, dns from users where upper (mac) = upper ('{ClientMacAddress}') &lt;/ offer_3&gt;
	 &lt;history_sql&gt; insert into history (id, dt, mac, ip, comment) values ‚Äã‚Äã(null, now (), '{ClientMacAddress}', '{RequestedIpAddress}', 'DHCPACK / INFORM') &lt;/ history_sql&gt;
     &lt;/ query&gt;
 &lt;/ config&gt; </pre><br>  Now more detail on the tags: <br><br>  The dhcpserver section describes the basic settings for running the server, namely: <br><ul><li>  host - what ip address is listening to the server on port 67 </li><li>  broadcast - what ip is Broadcast for DHCPOFFER and DHCPACK </li><li>  DHCPServer - what ip at DHCP server </li><li>  LeaseTime rental time given ip address </li><li>  ThreadLimit - how many threads are simultaneously running to process incoming UDP packets on port 67. It is assumed that it will help on high-load projects;) </li><li>  defaultMask, defaultRouter, defaultDNS - what is offered to the subscriber by default, if the IP is found in the database, but no additional parameters are specified for it </li></ul><br>  Mysql section: <br><br>  host, username, password, basename - everything speaks for itself.  Sample database structure is laid out on <a href="https://github.com/donpadlo/dhcp2dbpy">GitHub</a> <br><br>  Query section: requests for getting OFFER / ACK are described here: <br><br><ul><li>  offer_count - the number of rows with queries that return a result of the form ip, mask, router, dns </li><li>  offer_n - request string.  If the return is empty, then the following request is performed. </li><li>  history_sql - write request, for example, to the "authorization history" by subscriber </li></ul><br>  Requests can include any variables from the options section or options from the DHCP protocol. <br><br>  Section options.  Here it is more interesting.  Here we can create variables that can be used later in the query section. <br><br>  For example: <br><br><pre><code class="plaintext hljs">option_82_hex:sw_port1:20:22</code> </pre> <br>  , this line is a command to take the entire line that came in option 82 DHCP request, in hex format, in the range from 20 to 22 bytes inclusively and put it in the new variable sw_port1 (switch port where the request came from) <br><br><pre> <code class="plaintext hljs">option_82_hex:sw_mac:26:40</code> </pre> <br>  , we define the variable sw_mac, taking hex from the range 26:40 <br><br>  You can see all possible options that can be used in queries by starting the server with the -d switch.  We will see something like this log: <br><br><pre>  - the DHCPINFORM package came to port 67, from 0025224ad764, b '\ x91 \ xa5 \ xe0 \ xa3 \ xa5 \ xa9- \ x8f \ x8a', ('172.30.114.25', 68)
 {'ClientMacAddress': '0025224ad764',
  'ClientMacAddressByte': b '\ x00%' J \ xd7d ',
  'HType': 'Ethernet',
  'HostName': b '\ x91 \ xa5 \ xe0 \ xa3 \ xa5 \ xa9- \ x8f \ x8a',
  'ReqListDNS': True,
  'ReqListDomainName': True,
  'ReqListPerfowmRouterDiscover': True,
  'ReqListRouter': True,
  'ReqListStaticRoute': True,
  'ReqListSubnetMask': True,
  'ReqListVendorSpecInfo': 43,
  'RequestedIpAddress': '0.0.0.0',
  'Vendor': b'MSFT 5.0 ',
  'chaddr': '0025224ad764',
  'ciaddr': '172.30.128.13',
  'flags': b '\ x00 \ x00',
  'giaddr': '172.30.114.25',
  'gpoz': 308,
  'hlen': 6,
  'hops': 1,
  'htype': 'MAC',
  'magic_cookie': b'c \ x82Sc ',
  'op': 'DHCPINFORM',
  'option12': 12,
  'option53': 53,
  'option55': 55,
  'option60': 60,
  'option61': 61,
  'option82': 82,
  'option_82_byte': b '\ x12 \ x01 \ x06 \ x00 \ x04 \ x00 \ x01 \ x00 \ x06 \ x02 \ x08 \ x00'
                    b '\ x06 \ x00 \ x1eX \ x9e \ xb2 \ xad',
  'option_82_hex': '12010600040001000602080006001e589eb2ad',
  'option_82_len': 18,
  'option_82_str': "b '\\ x12 \\ x01 \\ x06 \\ x00 \\ x04 \\ x00 \\ x01 \\ x00 \\ x06 \\ x02 \\ x08 \\ x00 \\ x06 \\ x00 \ \ x1eX \\ x9e \\ xb2 \\ xad '",
  'result': False,
  'secs': 768,
  'siaddr': '0.0.0.0',
  'sw_mac': '001e589eb2ad',
  'sw_port1': '06',
  'xidbyte': b '&lt;\ x89} \ x8c',
  'xidhex': '3c897d8c',
  'yiaddr': '0.0.0.0'} </pre><br>  Accordingly, we can wrap any variable in {} and it will be used in the SQL query. <br><br>  Let's record for the history that the client‚Äôs IP address was: <br><br><img src="https://habrastorage.org/webt/mc/le/bu/mclebuj5du2u4mjtlaf9-a2ibo0.png"><br><br><img src="https://habrastorage.org/webt/eo/1q/lt/eo1qltnt_1ewtf0uwkenwywme3m.png"><br><br><h1>  Server startup </h1><br>  ./pydhcpdb.py -d -c config.xml <br><br>  - d. DEBUG console output mode <br>  - c &lt;file_name&gt; configuration file <br><br><h1>  Debriefing </h1><br>  And now more about the implementation of the server in Python.  It is a pain.  Python was studied on the fly.  Many moments are made in the style: ‚Äúwow, somehow did what works.‚Äù  Not optimized at all, and left in this form mainly due to the small experience of development in python.  I will dwell on the most interesting points of the server implementation in the ‚Äúcode‚Äù. <br><br><h2>  XML configuration file parser </h2><br>  The standard Python xml.dom module is used.  It seems to be simple, but the implementation did not have enough sensible documentation and examples on the network using this module. <br><br><pre>  tree = minidom.parse (gconfig ["config_file"])
     mconfig = tree.getElementsByTagName ("mysql")
     for elem in mconfig:        
         gconfig ["mysql_host"] = elem.getElementsByTagName ("host") [0] .firstChild.data      
         gconfig ["mysql_username"] = elem.getElementsByTagName ("username") [0] .firstChild.data      
         gconfig ["mysql_password"] = elem.getElementsByTagName ("password") [0] .firstChild.data      
         gconfig ["mysql_basename"] = elem.getElementsByTagName ("basename") [0] .firstChild.data      
     dconfig = tree.getElementsByTagName ("dhcpserver")
     for elem in dconfig:        
         gconfig ["broadcast"] = elem.getElementsByTagName ("broadcast") [0] .firstChild.data      
         gconfig ["dhcp_host"] = elem.getElementsByTagName ("host") [0] .firstChild.data      
         gconfig ["dhcp_LeaseTime"] = elem.getElementsByTagName ("LeaseTime") [0] .firstChild.data      
         gconfig ["dhcp_ThreadLimit"] = int (elem.getElementsByTagName ("ThreadLimit") [0] .firstChild.data)              
         gconfig ["dhcp_Server"] = elem.getElementsByTagName ("DHCPServer") [0] .firstChild.data              
         gconfig ["dhcp_defaultMask"] = elem.getElementsByTagName ("defaultMask") [0] .firstChild.data              
         gconfig ["dhcp_defaultRouter"] = elem.getElementsByTagName ("defaultRouter") [0] .firstChild.data              
         gconfig ["dhcp_defaultDNS"] = elem.getElementsByTagName ("defaultDNS") [0] .firstChild.data              
     qconfig = tree.getElementsByTagName ("query")
     for elem in qconfig:  
         gconfig ["offer_count"] = elem.getElementsByTagName ("offer_count") [0] .firstChild.data                          
         for num in range (int (gconfig ["offer_count"])):
             gconfig ["offer _" + str (num + 1)] = elem.getElementsByTagName ("offer _" + str (num + 1)) [0] .firstChild.data      
         gconfig ["history_sql"] = elem.getElementsByTagName ("history_sql") [0] .firstChild.data                          
     options = tree.getElementsByTagName ("options")       
     for elem in options:          
         node = elem.getElementsByTagName ("option")
         for options in node:
             optionsMod.append (options.firstChild.data) </pre><br><h2>  Multithreading </h2><br>  Oddly enough, multithreading in Python is implemented very clearly and simply. <br><br><pre>  def PacketWork (data, addr): 
 ...
 # implementation of parsing the incoming packet, and the answer to it
 ...


 while true:
     data, addr = udp_socket.recvfrom (1024) # waiting for the UDP packet
     thread = threading. Thread (target = PacketWork, args = (data, addr,)). start () # how come - run in the background the previously defined PacketWork function with parameters
     while threading.active_count ()&gt; gconfig ["dhcp_ThreadLimit"]:
        time.sleep (1) # if the number of threads already running is greater than in the settings, wait until they become fewer </pre><br><br><h2>  Receive / Send DHCP Package </h2><br>  In order to intercept UDP packets going through a network card, you need to "raise" the socket: <br><pre>  udp_socket = socket.socket (socket.AF_INET, socket.SOCK_DGRAM, socket.IPPROTO_UDP)
 udp_socket.bind ((gconfig ["dhcp_host"], 67)) </pre><br>  where flags are: <br><br><ul><li>  AF_INET - means that the address format will be IP: port.  Maybe even AF_UNIX - where the address is specified by the file name. </li><li>  SOCK_DGRAM - means that we are accepting not a ‚Äúraw packet‚Äù, but already passing through a firewall, and with a partially trimmed packet.  Those.  we receive only a UDP packet without the ‚Äúphysical‚Äù component of the UDP packet wrapper.  If you use the SOCK_RAW flag, you will need to parse again and this is a ‚Äúwrapper‚Äù. </li></ul><br>  Sending a package can be as Broadcast: <br><br><pre>  udp_socket.setsockopt (socket.SOL_SOCKET, socket.SO_BROADCAST, 1) # switch the socket to send broadcast mode
                     rz = udp_socket.sendto (packetack, (gconfig ["broadcast"], 68)) </pre><br>  , and to the address, "where the package came from": <br><pre>  udp_socket.setsockopt (socket.SOL_SOCKET, socket.SO_REUSEADDR, 1) # switch the socket to the "many listeners" mode
                         rz = udp_socket.sendto (packetack, addr) </pre><br>  where SOL_SOCKET means ‚Äúprotocol level‚Äù for setting options, <br><br>  , SO_BROADCAST option that package helmet "Broadcast" <br><br>  The SO_REUSEADDR option switches the socket to the multi-listener mode.  In theory, it is unnecessary in this case, but on one of the FreeBSD servers on which it was tested, the code did not work without this option. <br><br><h2>  DHCP packet parsing </h2><br>  This is where I really liked Python.  It turns out from the "box", he allows quite freely with the byte-code.  Allowing it to be very simple to translate into decimal values, strings and hex ‚Äî that is,  what we actually need to understand the package structure.  So for example you can get a range of bytes in HEX and just bytes: <br><br><pre>  res ["xidhex"] = data [4: 8] .hex ()
     res ["xidbyte"] = data [4: 8] </pre><br>  , pack bytes into a structure: <br><br><pre>  res ["flags"] = pack ('BB', data [10], data [11]) </pre><br>  Get IP from structure: <br><br><pre>  res ["ciaddr"] = socket.inet_ntoa (pack ('BBBB', data [12], data [13], data [14], data [15])); </pre><br><br>  And vice versa: <br><br><pre>  res = res + socket.inet_pton (socket.AF_INET, gconfig ["dhcp_Server"]) </pre><br>  That's all ;) </div><p>Source: <a href="https://habr.com/ru/post/445338/">https://habr.com/ru/post/445338/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../445326/index.html">Ruthless automation. Director's cut</a></li>
<li><a href="../445328/index.html">Rethinking child robotics</a></li>
<li><a href="../445330/index.html">Cryptography in Java. Signature class</a></li>
<li><a href="../445334/index.html">We have DevOps. Let's dismiss all testers</a></li>
<li><a href="../445336/index.html">FlexiRemap¬Æ vs. RAID</a></li>
<li><a href="../445340/index.html">Increase network security by using a cloud analyzer</a></li>
<li><a href="../445344/index.html">OpenVox Unified Communications Platform</a></li>
<li><a href="../445346/index.html">How to write a bad API</a></li>
<li><a href="../445348/index.html">SNA Hackathon 2019: we complicate architecture - we simplify features</a></li>
<li><a href="../445350/index.html">Sonata - SIP provisioning server</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>