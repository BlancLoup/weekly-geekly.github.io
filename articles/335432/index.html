<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Timebug part 2: interesting solutions from EA Black Box</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi, Habr! In my previous article, I talked about an interesting bug in an old toy, clearly demonstrated the accumulation of rounding error and just sh...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Timebug part 2: interesting solutions from EA Black Box</h1><div class="post__text post__text-html js-mediator-article">  Hi, Habr!  In my <a href="https://habrahabr.ru/post/333676/">previous</a> article, I talked about an interesting bug in an old toy, clearly demonstrated the accumulation of rounding error and just shared my experience in reverse engineering.  I was hoping that this could put an end, but I was very wrong.  Therefore, under the cut, I will tell the continuation of the story about the beast called Timebug, about 60 frames per second and about very interesting decisions when developing games. <br><br><img src="https://habrastorage.org/web/5ce/1ee/251/5ce1ee2515334495b7d64f0fca0662a8.jpg"><br><a name="habracut"></a><br><h3>  Prehistory </h3><br>  While writing the previous part of this epic around the incorrectly calculated times of the tracks, I involuntarily tried to touch on as many games as possible.  It was too lazy to do extra work, so I was looking for symptoms in all the NFS games that I had at that time.  Underground 2 came under the distribution, but I did not find the initial symptoms there: <br><br> <a href=""><img src="https://habrastorage.org/web/b2e/b34/ce4/b2eb34ce419d4650a38f56673b83d07f.png"></a> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      As can be seen from the picture (it is clickable, by the way), IGT is calculated in another way, which is clearly tied to int, and therefore there should not have been an accumulation of error.  I happily announced this in our community and planned to forget about it already, but no: Ewil manually counted some videos and again discovered the time difference.  We decided that so far we have no time to deal with this and I concentrated on the problem that was already known then, but now I was able to set aside time for myself and take up this particular game. <br><br><h3>  Symptoms </h3><br>  I studied the behavior of the global timer and found that it was ‚Äúdumped‚Äù with each restart of the race, with each exit in the menu, and in general at any convenient time.  This was not part of my plans, because the connection with the already known problem was completely lost, and this timer simply should not break.  Out of desperation, I recorded the passage of 10 laps and counted the time with my hands.  To my surprise, the times of the circle there were 100% accurate. <br><br><div class="spoiler">  <b class="spoiler_title">Interesting Facts</b> <div class="spoiler_text">  In fact, another timer was also detected, which also counted the time during the float, but it turned out to be a little useless.  By changing it, I did not achieve any visible results. <br>  For some reason, this int timer is not reset to 0, but set to 4000. <br></div></div><br><br>  The only thing left was to disassemble and watch what was wrong there.  Without going into details, I'll show the pseudo-code of the procedure that considers this unfortunate IGT: <br><br><pre><code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( g_fFrameLength != <span class="hljs-number"><span class="hljs-number">0.0</span></span> ) { <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> v0 = g_fFrameDiff + g_fFrameLength; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> v1 = FltToDword(v0); g_dwUnknown0 += v1; g_dwUnknown1 = v1; g_dwUnknown2 = g_dwUnknown0; g_fFrameDiff = v0 - v1 * <span class="hljs-number"><span class="hljs-number">0.016666668</span></span>; g_dwIGT += FltToDword(g_fFrameLength * <span class="hljs-number"><span class="hljs-number">4000.0</span></span> + <span class="hljs-number"><span class="hljs-number">0.5</span></span>); LODWORD(g_fFrameLength) = <span class="hljs-number"><span class="hljs-number">0</span></span>; ++g_dwFrameCount; g_fIGT = (<span class="hljs-keyword"><span class="hljs-keyword">double</span></span>)g_dwIGT * <span class="hljs-number"><span class="hljs-number">0.00025000001</span></span>; <span class="hljs-comment"><span class="hljs-comment">// Divides IGT by 4000 to get time in seconds }</span></span></code> </pre> <br>  Firstly: <br><br><pre> <code class="cpp hljs">g_dwIGT += FltToDword(g_fFrameLength * <span class="hljs-number"><span class="hljs-number">4000.0</span></span> + <span class="hljs-number"><span class="hljs-number">0.5</span></span>);</code> </pre><br><img src="https://habrastorage.org/web/8a1/4c5/572/8a14c557260746009a0da4ed0db9ec4a.png"><br><br>  Initially, this code seemed completely meaningless to me.  Why multiply this by 4000, and then add another half? <br><br>  In fact, this is very tricky magic.  4000 is just a constant that came up with someone from the developers ... But +0.5 is such an interesting way of rounding up according to the laws of mathematics.  Add a half to 4.7 and when chopping up to an int get 5, and when adding and rounding 4.3 we get 4, as wanted.  The method is not the most accurate, but it probably works faster.  Personally, I will take note. <br><br>  And now, dear readers, I want to play a game with you.  Look at the full pseudocode above and try to find an error there.  If you get tired or you are just not interested, go to the next part. <br><br><h3>  Mistake </h3><br><div class="spoiler">  <b class="spoiler_title">Line</b> <div class="spoiler_text">  g_fFrameDiff = v0 - (double) v1 * 0.016666668; <br></div></div><br>  Error under the spoiler, so you do not accidentally peep.  I will explain a little: 0.01 (6) is 1/60 of a second.  All the code above seems to be an attempt to count and compensate for the engine jams, but they did not take into account the fact that not everyone plays at 60fps.  This is where the most interesting result came out, when in my video all circles coincided with reality, but Ewil doesn‚Äôt.  He plays with the vertical synchronization turned off, and the game is blocked to a maximum of 120 fps and, accordingly, the code for his computer did not work correctly.  I slightly modified the code above and brought it into a human form: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( g_fFrameLength != <span class="hljs-number"><span class="hljs-number">0.0</span></span> ) { <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> tmpDiff = g_fFrameDiff + g_fFrameLength; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> diffTime = FltToDword(v0); g_dwUnknown0 += diffTime; <span class="hljs-comment"><span class="hljs-comment">// Some unknown vars g_dwUnknown1 = diffTime; g_dwUnknown2 = g_dwUnknown0; g_fFrameDiff = tmpDiff - diffTime * 1.0/60; g_dwIGT += FltToDword(g_fFrameLength * 4000 + 0.5); g_fFrameLength = 0; ++g_dwFrameCount; g_fIGT = (float)g_dwIGT / 4000; // Divides IGT by 4000 to get time in seconds }</span></span></code> </pre><br>  Here you can see that when calculating the lag, the actual frame time is initially used, and later on, the hard-times 60 fps are used.  <b>SUSPICIOUS</b> ! <br>  I turn off vsync and get 120 frames per second.  I‚Äôm going to record a video and get about 0.3 second lap difference.  Bingo! <br><br>  It remains for the small, patch hardcore 60fps hardcore 120fps.  To do this, we look at the assembler code and find the address at which this magic constant is located: 0x007875BC. <br><br><div class="spoiler">  <b class="spoiler_title">Spoiler</b> <div class="spoiler_text">  In fact, it is known that this constant of type float / double will be loaded on the FPU.  FPU can not load from the register, so that it was destined to be somewhere in the memory.  It‚Äôs good that she wasn‚Äôt on the stack, otherwise I wouldn‚Äôt get off so easily.  I would have to make changes to the game code itself, which I did not want to do. <br></div></div><br>  This time I didn‚Äôt write any special programs, but I just changed the value of this variable to the necessary ones in the Cheat Engine.  After that, I once again recorded 10 laps and counted the time - IGT and RTA finally matched. <br><br>  In fact, they did not match 100%.  But for the most part, due to the fact that the video recording dragged me a frame rate very strongly, because of which the game stopped adequately calculating the difference of times.  But in general, the difference was in the region of 0.02 seconds. <br><br>  I looked around a bit more in the code for what those variables affect that were so zealously calculated in the time counting procedure.  I found not very much, but g_fDiffTime is used somewhere in the engine next to g_fFrameTime.  Most likely, my assumption about the compensation of scams turned out to be true.  But who knows these developers? <br><br><h3>  Afterword </h3><br>  I do not even know how many times I come across a game that assumes 60 frames per second.  This is a very bad style of writing games, and I strongly recommend that you, the readers, take into account the difference in iron.  Especially if you are an indie developer.  And very especially if you are developing on a PC.  For consoles to achieve different capacities of iron will not work, but on the PC because of this, problems constantly pop up.  And there are also monitors with 120 / 144Hz refresh rate, and even more.  And g-sync has already arrived. <br><br>  But NFS are ports from consoles, so solutions often have a purely console approach: suppose that the FPS does not rise above 60 (30, 25, any number), and many solutions sharpen precisely for this number of frames per second.  Alas, it has become more apparent in the new parts of the series. <br><br>  This time the article was not so voluminous, although there is a lot of research space here.  I hope there is still something interesting in these games, which can be talked about. </div><p>Source: <a href="https://habr.com/ru/post/335432/">https://habr.com/ru/post/335432/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../335420/index.html">Automate it: How the market for the destruction of routine is formed</a></li>
<li><a href="../335424/index.html">Turkey Mobile Market Review</a></li>
<li><a href="../335426/index.html">System prisoners</a></li>
<li><a href="../335428/index.html">Let's learn tcpdump with Julia Evans</a></li>
<li><a href="../335430/index.html">IT-school SAMSUNG on behalf of the student</a></li>
<li><a href="../335434/index.html">Authentication in Node.js. Tutorials and possible mistakes</a></li>
<li><a href="../335436/index.html">Autonomous way to bypass DPI and effective way to bypass site blocking by IP address</a></li>
<li><a href="../335438/index.html">Digest MBLTdev - fresh for iOS developers</a></li>
<li><a href="../335440/index.html">Backup mysql database and files to remote FTP - Python 3</a></li>
<li><a href="../335442/index.html">How to make websites more accessible for users with visual impairments</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>