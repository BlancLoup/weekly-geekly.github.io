<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Techniques for using mask registers in the AVX512 code</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In Intel processors, AVX2 replaces AVX512 instructions, in which the concept of mask registers has appeared. The author of this article has been devel...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Techniques for using mask registers in the AVX512 code</h1><div class="post__text post__text-html js-mediator-article">  In Intel processors, AVX2 replaces <a href="https://software.intel.com/en-us/isa-extensions/intel-avx">AVX512</a> instructions, in which the concept of mask registers has appeared.  The author of this article has been developing the version of the <a href="https://software.intel.com/en-us/intel-ipp">Intel Integrated Performance Primitives</a> library optimized for AVX512 for several years and has gained quite a lot of experience using AVX512 instructions with masks, which was decided to be combined into one separate article, since the use of such instructions with masks allows you to simplify and speed up code in addition to acceleration from double increasing the width of registers. <br><a name="habracut"></a><br><h1>  Example 1. We apply instructions with masks "before and after" the main loop </h1><br>  Consider the addition function of two images. <br><div class="spoiler">  <b class="spoiler_title">Sheet 1.1</b> <div class="spoiler_text"><pre><code class="hljs cs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">add_ref</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">* pSrc1, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> src1Step, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">* pSrc2, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> src2Step, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">* pDst, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> dstStep, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> width, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> height</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> h, i; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>( h = <span class="hljs-number"><span class="hljs-number">0</span></span>; h &lt; height; h++ ) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>( i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; width; i++ ) { pDst[i] = pSrc1[i] + pSrc2[i]; } pSrc1 = pSrc1 + src1Step; pSrc2 = pSrc2 + src2Step; pDst = pDst + dstStep; } }</code> </pre> <br></div></div><br>  The function code is very simple and in principle the icl compiler is quite capable of vectorizing this code.  However, our goal is to demonstrate the use of masked avx512 registers, so we will write the first and obvious version of the avx512 code. <br><div class="spoiler">  <b class="spoiler_title">Sheet 1.2</b> <div class="spoiler_text"><pre> <code class="hljs matlab">void add_avx512( const float* pSrc1, int src1Step, const float* pSrc2, int src2Step, float* pDst, int dstStep, int width, int height) { int h, <span class="hljs-built_in"><span class="hljs-built_in">i</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>( h = <span class="hljs-number"><span class="hljs-number">0</span></span>; h&lt;height; h++ ) { <span class="hljs-built_in"><span class="hljs-built_in">i</span></span> = <span class="hljs-number"><span class="hljs-number">0</span></span>; __m512 zmm0, zmm1; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">i</span></span>=<span class="hljs-built_in"><span class="hljs-built_in">i</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">i</span></span> &lt; (width&amp;(~<span class="hljs-number"><span class="hljs-number">15</span></span>)); <span class="hljs-built_in"><span class="hljs-built_in">i</span></span>+=<span class="hljs-number"><span class="hljs-number">16</span></span> ) { zmm0 = _mm512_loadu_ps(pSrc1+<span class="hljs-built_in"><span class="hljs-built_in">i</span></span> ); zmm1 = _mm512_loadu_ps(pSrc2+<span class="hljs-built_in"><span class="hljs-built_in">i</span></span> ); zmm0 = _mm512_add_ps(zmm0, zmm1); _mm512_storeu_ps (pDst+<span class="hljs-built_in"><span class="hljs-built_in">i</span></span>, zmm0 ); } <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">i</span></span>=<span class="hljs-built_in"><span class="hljs-built_in">i</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">i</span></span> &lt; width; <span class="hljs-built_in"><span class="hljs-built_in">i</span></span>++ ) { pDst[<span class="hljs-built_in"><span class="hljs-built_in">i</span></span>] = pSrc1[<span class="hljs-built_in"><span class="hljs-built_in">i</span></span>] + pSrc2[<span class="hljs-built_in"><span class="hljs-built_in">i</span></span>]; } pSrc1 = pSrc1 + src1Step; pSrc2 = pSrc2 + src2Step; pDst = pDst + dstStep; } }</code> </pre><br></div></div><br>  In this code, a loop is added, which adds up to 16 elements at a time per iteration.  Since the width of the image can be arbitrary and not a multiple of 16, then in the next cycle the elements remaining until the end of the line are added.  The number of such elements can reach 15, and the effect of this cycle on the overall performance can be quite large.  Using the same mask registers can significantly accelerate the processing of the "tail". <br><div class="spoiler">  <b class="spoiler_title">Sheet 1.3</b> <div class="spoiler_text"><pre> <code class="hljs matlab">__mmask16 len2mask[] = { <span class="hljs-number"><span class="hljs-number">0x0000</span></span>, <span class="hljs-number"><span class="hljs-number">0x0001</span></span>, <span class="hljs-number"><span class="hljs-number">0x0003</span></span>, <span class="hljs-number"><span class="hljs-number">0x0007</span></span>, <span class="hljs-number"><span class="hljs-number">0x000F</span></span>, <span class="hljs-number"><span class="hljs-number">0x001F</span></span>, <span class="hljs-number"><span class="hljs-number">0x003F</span></span>, <span class="hljs-number"><span class="hljs-number">0x007F</span></span>, <span class="hljs-number"><span class="hljs-number">0x00FF</span></span>, <span class="hljs-number"><span class="hljs-number">0x01FF</span></span>, <span class="hljs-number"><span class="hljs-number">0x03FF</span></span>, <span class="hljs-number"><span class="hljs-number">0x07FF</span></span>, <span class="hljs-number"><span class="hljs-number">0x0FFF</span></span>, <span class="hljs-number"><span class="hljs-number">0x1FFF</span></span>, <span class="hljs-number"><span class="hljs-number">0x3FFF</span></span>, <span class="hljs-number"><span class="hljs-number">0x7FFF</span></span>, <span class="hljs-number"><span class="hljs-number">0xFFFF</span></span> }; void add_avx512_2( float* pSrc1, int src1Step, const float* pSrc2, int src2Step, float* pDst, int dstStep, int width, int height) { int h, <span class="hljs-built_in"><span class="hljs-built_in">i</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>( h = <span class="hljs-number"><span class="hljs-number">0</span></span>; h &lt; height; h++ ) { <span class="hljs-built_in"><span class="hljs-built_in">i</span></span> = <span class="hljs-number"><span class="hljs-number">0</span></span>; __m512 zmm0, zmm1; __mmask16 msk; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">i</span></span>=<span class="hljs-built_in"><span class="hljs-built_in">i</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">i</span></span> &lt; (width&amp;(~<span class="hljs-number"><span class="hljs-number">15</span></span>)); <span class="hljs-built_in"><span class="hljs-built_in">i</span></span>+=<span class="hljs-number"><span class="hljs-number">16</span></span> ) { zmm0 = _mm512_loadu_ps(pSrc1+<span class="hljs-built_in"><span class="hljs-built_in">i</span></span> ); zmm1 = _mm512_loadu_ps(pSrc2+<span class="hljs-built_in"><span class="hljs-built_in">i</span></span> ); zmm0 = _mm512_add_ps (zmm0, zmm1); _mm512_storeu_ps (pDst+<span class="hljs-built_in"><span class="hljs-built_in">i</span></span>, zmm0 ); } msk = len2mask[width - <span class="hljs-built_in"><span class="hljs-built_in">i</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(msk){ zmm0 = _mm512_mask_loadu_ps(_mm512_setzero_ps(),msk,pSrc1+<span class="hljs-built_in"><span class="hljs-built_in">i</span></span> ); zmm1 = _mm512_mask_loadu_ps(_mm512_setzero_ps(),msk,pSrc2+<span class="hljs-built_in"><span class="hljs-built_in">i</span></span> ); zmm0 = _mm512_add_ps (zmm0, zmm1); _mm512_mask_storeu_ps (pDst+<span class="hljs-built_in"><span class="hljs-built_in">i</span></span>, msk, zmm0 ); } pSrc1 = pSrc1 + src1Step; pSrc2 = pSrc2 + src2Step; pDst = pDst + dstStep; } }</code> </pre><br></div></div><br>  The array len2mask is used to convert the number to the corresponding number of bits in a row.  And instead of a scalar loop, we get only one if, which in principle is also not necessary, since in the case of a mask consisting of only zeros, reading and writing will not be performed. <br><br>  In order to achieve maximum performance, it is recommended to align the data with the width of the cache line, and downloads to the address aligned to the register width.  In Skylake, the width of the cache line is still 64 bytes, therefore, in our code, we can add this alignment with pDst again using mask operations, but only before the main loop. <br><div class="spoiler">  <b class="spoiler_title">Sheet 1.4</b> <div class="spoiler_text"><pre> <code class="hljs pgsql"><span class="hljs-type"><span class="hljs-type">void</span></span> add_avx512_3(<span class="hljs-type"><span class="hljs-type">float</span></span>* pSrc1, <span class="hljs-type"><span class="hljs-type">int</span></span> src1Step, const <span class="hljs-type"><span class="hljs-type">float</span></span>* pSrc2, <span class="hljs-type"><span class="hljs-type">int</span></span> src2Step, <span class="hljs-type"><span class="hljs-type">float</span></span>* pDst, <span class="hljs-type"><span class="hljs-type">int</span></span> dstStep, <span class="hljs-type"><span class="hljs-type">int</span></span> width, <span class="hljs-type"><span class="hljs-type">int</span></span> height) { <span class="hljs-type"><span class="hljs-type">int</span></span> h, i, t; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>( h = <span class="hljs-number"><span class="hljs-number">0</span></span>; h &lt; height; h++ ) { i = <span class="hljs-number"><span class="hljs-number">0</span></span>; __m512 zmm0, zmm1; __mmask16 msk; t = ((((<span class="hljs-type"><span class="hljs-type">int</span></span>)pDst) &amp; (<span class="hljs-number"><span class="hljs-number">63</span></span>)) &gt;&gt; <span class="hljs-number"><span class="hljs-number">2</span></span>); msk = len2mask[t]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(msk){ zmm0 = _mm512_mask_loadu_ps(_mm512_setzero_ps(),msk,pSrc1+i ); zmm1 = _mm512_mask_loadu_ps(_mm512_setzero_ps(),msk,pSrc2+i ); zmm0 = _mm512_add_ps (zmm0, zmm1); _mm512_mask_storeu_ps (pDst+i, msk, zmm0 ); } i += t; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(i=i; i &lt; (width&amp;(~<span class="hljs-number"><span class="hljs-number">15</span></span>)); i+=<span class="hljs-number"><span class="hljs-number">16</span></span> ) { zmm0 = _mm512_loadu_ps(pSrc1+i ); zmm1 = _mm512_loadu_ps(pSrc2+i ); zmm0 = _mm512_add_ps (zmm0, zmm1); _mm512_storeu_ps (pDst+i, zmm0 ); } msk = len2mask[width - i]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(msk){ zmm0 = _mm512_mask_loadu_ps(_mm512_setzero_ps(),msk,pSrc1+i ); zmm1 = _mm512_mask_loadu_ps(_mm512_setzero_ps(),msk,pSrc2+i ); zmm0 = _mm512_add_ps (zmm0, zmm1); _mm512_mask_storeu_ps (pDst+i, msk, zmm0 ); } pSrc1 = pSrc1 + src1Step; pSrc2 = pSrc2 + src2Step; pDst = pDst + dstStep; } } &lt;source&gt; &lt;/spoiler&gt;   <span class="hljs-keyword"><span class="hljs-keyword">add</span></span>               .    ,        ,                       .            .              . . <span class="hljs-number"><span class="hljs-number">1.5</span></span>    &lt;spoiler title="  1.5"&gt; &lt;source lang="C++"&gt; #define min(a,b) ((a)&lt;(b)?(a):(b)) <span class="hljs-type"><span class="hljs-type">void</span></span> add_avx512_4( const <span class="hljs-type"><span class="hljs-type">float</span></span>* pSrc1, <span class="hljs-type"><span class="hljs-type">int</span></span> src1Step, const <span class="hljs-type"><span class="hljs-type">float</span></span>* pSrc2, <span class="hljs-type"><span class="hljs-type">int</span></span> src2Step, <span class="hljs-type"><span class="hljs-type">float</span></span>* pDst, <span class="hljs-type"><span class="hljs-type">int</span></span> dstStep, <span class="hljs-type"><span class="hljs-type">int</span></span> width, <span class="hljs-type"><span class="hljs-type">int</span></span> height) { <span class="hljs-type"><span class="hljs-type">int</span></span> h, i; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>( h = <span class="hljs-number"><span class="hljs-number">0</span></span>; h &lt; height; h++ ) { i = <span class="hljs-number"><span class="hljs-number">0</span></span>; __m512 zmm0, zmm1; __mmask16 msk; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(i=i; i &lt; width; i+=<span class="hljs-number"><span class="hljs-number">16</span></span> ) { msk = len2mask[min(<span class="hljs-number"><span class="hljs-number">16</span></span>, width - i)]; zmm0 = _mm512_mask_loadu_ps(_mm512_setzero_ps(),msk,pSrc1+i ); zmm1 = _mm512_mask_loadu_ps(_mm512_setzero_ps(),msk,pSrc2+i ); zmm0 = _mm512_add_ps (zmm0, zmm1); <span class="hljs-comment"><span class="hljs-comment">/*THE LONG PIPELINE HERE*/</span></span> _mm512_mask_storeu_ps (pDst+i, msk, zmm0 ); } pSrc1 = pSrc1 + src1Step; pSrc2 = pSrc2 + src2Step; pDst = pDst + dstStep; } }</code> </pre><br></div></div><br>  The code began to look shorter, and with a sufficiently long sequence of calculations, the cost of calculating the mask in each iteration against such a background may be insignificant. <br><br><h1>  Example 2. Mask as an immediate part of the implemented algorithm. </h1><br>  In various image processing algorithms, a binary mask may be one of the input parameters.  For example, such a mask is used in image morphology operations. <br><div class="spoiler">  <b class="spoiler_title">Sheet 2.1</b> <div class="spoiler_text"><pre> <code class="hljs cs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">morph_3x3_ref</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">* pSrc1, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> src1Step, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params">* pMask, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">* pDst, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> dstStep, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> width, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> height</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> h, i; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>( h = <span class="hljs-number"><span class="hljs-number">0</span></span>; h &lt; height; h++ ) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(i=<span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; width; i++ ) { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> x, y; <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>* pm = pMask; <span class="hljs-comment"><span class="hljs-comment">/*we assume that pMask is not zero total*/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> m = <span class="hljs-number"><span class="hljs-number">3.402823466e+38</span></span>f; <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> val = <span class="hljs-number"><span class="hljs-number">0.0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (y = <span class="hljs-number"><span class="hljs-number">0</span></span>; y &lt; <span class="hljs-number"><span class="hljs-number">3</span></span>;y++){ <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (x = <span class="hljs-number"><span class="hljs-number">0</span></span>; x &lt; <span class="hljs-number"><span class="hljs-number">3</span></span>; x++){ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (*pm){ val = pSrc1[i + src1Step*y + x]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (val &lt; m) { m = val; } } pm++; } } pDst[i] = m; } pSrc1 = pSrc1 + src1Step; pDst = pDst + dstStep; } }</code> </pre><br></div></div><br>  The function searches for the smallest pixel inside a 3x3 square.  The pMask input mask is an array of 3x3 = 9 bytes.  If the value of the byte is not zero, then the input pixel from the 3x3 square participates in the search; if it is equal, it does not participate. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      We write avx512 code. <br><div class="spoiler">  <b class="spoiler_title">Sheet 2.2</b> <div class="spoiler_text"><pre> <code class="hljs pgsql"><span class="hljs-type"><span class="hljs-type">void</span></span> morph_3x3_avx512( const <span class="hljs-type"><span class="hljs-type">float</span></span>* pSrc1, <span class="hljs-type"><span class="hljs-type">int</span></span> src1Step, <span class="hljs-type"><span class="hljs-type">char</span></span>* pMask, <span class="hljs-type"><span class="hljs-type">float</span></span>* pDst, <span class="hljs-type"><span class="hljs-type">int</span></span> dstStep, <span class="hljs-type"><span class="hljs-type">int</span></span> width, <span class="hljs-type"><span class="hljs-type">int</span></span> height) { <span class="hljs-type"><span class="hljs-type">int</span></span> h, i; __mmask msk[<span class="hljs-number"><span class="hljs-number">9</span></span>], tail_msk; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> ( i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">9</span></span>; i++){ msk[i] = (!pMask[i]) ? <span class="hljs-number"><span class="hljs-number">0</span></span> : <span class="hljs-number"><span class="hljs-number">0xFFFF</span></span>;//<span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">load</span></span> mask } tail_msk = len2mask[width &amp; <span class="hljs-number"><span class="hljs-number">15</span></span>]; //tail mask <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>( h = <span class="hljs-number"><span class="hljs-number">0</span></span>; h &lt; height; h++ ) { __m512 zmm0, zmmM; <span class="hljs-type"><span class="hljs-type">int</span></span> x, y; i = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(i=i; i &lt; (width&amp;(~<span class="hljs-number"><span class="hljs-number">15</span></span>)); i+=<span class="hljs-number"><span class="hljs-number">16</span></span> ) { zmmM = _mm512_set1_ps(<span class="hljs-number"><span class="hljs-number">3.402823466e+38</span></span>f); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (y = <span class="hljs-number"><span class="hljs-number">0</span></span>; y &lt; <span class="hljs-number"><span class="hljs-number">3</span></span>;y++){ <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (x = <span class="hljs-number"><span class="hljs-number">0</span></span>; x &lt; <span class="hljs-number"><span class="hljs-number">3</span></span>; x++){ zmm0 = _mm512_mask_loadu_ps(zmmM, msk[<span class="hljs-number"><span class="hljs-number">3</span></span>*y+x], &amp;pSrc1[i + src1Step*y + x]); zmmM = _mm512_min_ps(zmm0, zmmM); } } _mm512_storeu_ps (pDst+i, zmmM ); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(tail_msk) { zmmM = _mm512_set1_ps(<span class="hljs-number"><span class="hljs-number">3.402823466e+38</span></span>f); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (y = <span class="hljs-number"><span class="hljs-number">0</span></span>; y &lt; <span class="hljs-number"><span class="hljs-number">3</span></span>;y++){ <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (x = <span class="hljs-number"><span class="hljs-number">0</span></span>; x &lt; <span class="hljs-number"><span class="hljs-number">3</span></span>; x++){ zmm0=_mm512_mask_loadu_ps(zmmM,msk[<span class="hljs-number"><span class="hljs-number">3</span></span>*y+x]&amp;tail_msk,&amp;pSrc1[i+src1Step*y+x]); zmmM=_mm512_min_ps(zmm0, zmmM); } } _mm512_mask_storeu_ps (pDst+i, tail_msk, zmmM ); } pSrc1 = pSrc1 + src1Step; pDst = pDst + dstStep; } }</code> </pre><br></div></div><br>  First, an array of masks __mmask msk [9] is formed.  Each mask is obtained by replacing a byte from pMask with a bit (0 with 0, all other values ‚Äã‚Äãwith 1) and this bit is multiplied by 16 elements.  The main loop loads 16 elements on this mask.  Moreover, if the item is not involved in the search, then it will not be loaded.  In this code, the tail is also processed using masks, we simply perform the &amp; operation on the mask of the morphology operation and the tail mask. <br><br>  Of course, the demonstrated code is not entirely optimal, but it demonstrates the idea itself, and complicating the code would lead to a loss of clarity. <br><br><h1>  Example 3. Expand / compress family instructions </h1><br>  Even in the first 256-bit instruction set AVX, the registers were divided by a barrier into 2 parts, called lane.  Most vector instructions independently process these parts.  It looks like 2 parallel SSE instructions.  In avx512, the register is already divided into four 128-bit parts of four float / int elements.  And in many image processing algorithms three channels are used and combining them in 4 is quite problematic.  In this case, you can consider using the instructions of the form expand / compress <br><br>  __m512 _mm512_mask_expandloadu_ps (__m512 src, __mmask16 k, void const * mem_addr) <br>  void _mm512_mask_compressstoreu_ps (void * base_addr, __mmask16 k, __m512 a) <br><br>  The _mm512_mask_expandloadu_ps instruction loads from memory a continuous block of data float length equal to the number of 1 bits in the mask.  Thus a block with a length of 0 to 16 elements can be loaded.  In the register-receiver data is placed as follows.  Since the least significant bit of the mask is checked, if the bit is 1, then the memory element is written to the register, if 0, then we proceed to consider the next bit and the same element, fig.  3.1 <br><br>  Fig.  3.1 Demonstration of _mm512_mask_expandloadu_ps <br><img src="https://habrastorage.org/files/232/13a/ba8/23213aba8a0b4588b9ab018e0b1765e5.jpg"><br><br>  It can be seen that the memory region is ‚Äústretched‚Äù (expand) over the entire 512-bit register.  The _mm512_mask_compressstoreu_ps instruction works in the opposite direction - it ‚Äúcompresses‚Äù (compress) the register by mask and writes it into a continuous memory area. <br><br>  So, let's say we need to go from the RGB color space to XYZ. <br><div class="spoiler">  <b class="spoiler_title">Sheet 3.1</b> <div class="spoiler_text"><pre> <code class="hljs matlab">void rgb_ref( const float* pSrc1, int src1Step, float* pDst, int dstStep, int width, int height) { int h, <span class="hljs-built_in"><span class="hljs-built_in">i</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>( h = <span class="hljs-number"><span class="hljs-number">0</span></span>; h &lt; height; h++ ) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">i</span></span>=<span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">i</span></span> &lt; width; <span class="hljs-built_in"><span class="hljs-built_in">i</span></span>++ ) { pDst[<span class="hljs-number"><span class="hljs-number">3</span></span>*<span class="hljs-built_in"><span class="hljs-built_in">i</span></span>+<span class="hljs-number"><span class="hljs-number">0</span></span>]=(<span class="hljs-number"><span class="hljs-number">0.412</span></span>f*pSrc1[<span class="hljs-number"><span class="hljs-number">3</span></span>*<span class="hljs-built_in"><span class="hljs-built_in">i</span></span>]+<span class="hljs-number"><span class="hljs-number">0.357</span></span>f*pSrc1[<span class="hljs-number"><span class="hljs-number">3</span></span>*<span class="hljs-built_in"><span class="hljs-built_in">i</span></span>+<span class="hljs-number"><span class="hljs-number">1</span></span>]+<span class="hljs-number"><span class="hljs-number">0.180</span></span>f*pSrc1[<span class="hljs-number"><span class="hljs-number">3</span></span>*<span class="hljs-built_in"><span class="hljs-built_in">i</span></span>+<span class="hljs-number"><span class="hljs-number">2</span></span>]); pDst[<span class="hljs-number"><span class="hljs-number">3</span></span>*<span class="hljs-built_in"><span class="hljs-built_in">i</span></span>+<span class="hljs-number"><span class="hljs-number">1</span></span>]=(<span class="hljs-number"><span class="hljs-number">0.212</span></span>f*pSrc1[<span class="hljs-number"><span class="hljs-number">3</span></span>*<span class="hljs-built_in"><span class="hljs-built_in">i</span></span>]+<span class="hljs-number"><span class="hljs-number">0.715</span></span>f*pSrc1[<span class="hljs-number"><span class="hljs-number">3</span></span>*<span class="hljs-built_in"><span class="hljs-built_in">i</span></span>+<span class="hljs-number"><span class="hljs-number">1</span></span>]+<span class="hljs-number"><span class="hljs-number">0.072</span></span>f*pSrc1[<span class="hljs-number"><span class="hljs-number">3</span></span>*<span class="hljs-built_in"><span class="hljs-built_in">i</span></span>+<span class="hljs-number"><span class="hljs-number">2</span></span>]); pDst[<span class="hljs-number"><span class="hljs-number">3</span></span>*<span class="hljs-built_in"><span class="hljs-built_in">i</span></span>+<span class="hljs-number"><span class="hljs-number">2</span></span>]=(<span class="hljs-number"><span class="hljs-number">0.019</span></span>f*pSrc1[<span class="hljs-number"><span class="hljs-number">3</span></span>*<span class="hljs-built_in"><span class="hljs-built_in">i</span></span>]+<span class="hljs-number"><span class="hljs-number">0.119</span></span>f*pSrc1[<span class="hljs-number"><span class="hljs-number">3</span></span>*<span class="hljs-built_in"><span class="hljs-built_in">i</span></span>+<span class="hljs-number"><span class="hljs-number">1</span></span>]+<span class="hljs-number"><span class="hljs-number">0.950</span></span>f*pSrc1[<span class="hljs-number"><span class="hljs-number">3</span></span>*<span class="hljs-built_in"><span class="hljs-built_in">i</span></span>+<span class="hljs-number"><span class="hljs-number">2</span></span>]); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pDst[<span class="hljs-number"><span class="hljs-number">3</span></span> * <span class="hljs-built_in"><span class="hljs-built_in">i</span></span> + <span class="hljs-number"><span class="hljs-number">2</span></span>] &lt; <span class="hljs-number"><span class="hljs-number">0.0</span></span>){ pDst[<span class="hljs-number"><span class="hljs-number">3</span></span> * <span class="hljs-built_in"><span class="hljs-built_in">i</span></span> + <span class="hljs-number"><span class="hljs-number">2</span></span>] = <span class="hljs-number"><span class="hljs-number">0.0</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pDst[<span class="hljs-number"><span class="hljs-number">3</span></span> * <span class="hljs-built_in"><span class="hljs-built_in">i</span></span> + <span class="hljs-number"><span class="hljs-number">2</span></span>] &gt; <span class="hljs-number"><span class="hljs-number">1.0</span></span>){ pDst[<span class="hljs-number"><span class="hljs-number">3</span></span> * <span class="hljs-built_in"><span class="hljs-built_in">i</span></span> + <span class="hljs-number"><span class="hljs-number">2</span></span>] = <span class="hljs-number"><span class="hljs-number">1.0</span></span>; } } pSrc1 = pSrc1 + src1Step; pDst = pDst + dstStep; } }</code> </pre><br></div></div><br>  Using the expand / compress avx512 code may look like this. <br><div class="spoiler">  <b class="spoiler_title">Sheet 3.2</b> <div class="spoiler_text"><pre> <code class="hljs go">void rgb_avx512( <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> float* pSrc1, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> src1Step, float* pDst, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> dstStep, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> width, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> height) { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> h, i; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>( h = <span class="hljs-number"><span class="hljs-number">0</span></span>; h &lt; height; h++ ) { __m512 zmm0, zmm1, zmm2, zmm3; i = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(i=i; i &lt; (width&amp;(~<span class="hljs-number"><span class="hljs-number">3</span></span>)); i+=<span class="hljs-number"><span class="hljs-number">4</span></span> ) { zmm0 = _mm512_mask_expandloadu_ps(_mm512_setzero_ps(), <span class="hljs-number"><span class="hljs-number">0x7777</span></span>, &amp;pSrc1[<span class="hljs-number"><span class="hljs-number">3</span></span>*i ]); zmm1 = _mm512_mul_ps(_mm512_set4_ps(<span class="hljs-number"><span class="hljs-number">0.0f</span></span>, <span class="hljs-number"><span class="hljs-number">0.019f</span></span>, <span class="hljs-number"><span class="hljs-number">0.212f</span></span>, <span class="hljs-number"><span class="hljs-number">0.412f</span></span>), _mm512_shuffle_ps(zmm0, zmm0, <span class="hljs-number"><span class="hljs-number">0x00</span></span>)); zmm2 = _mm512_mul_ps(_mm512_set4_ps(<span class="hljs-number"><span class="hljs-number">0.0f</span></span>, <span class="hljs-number"><span class="hljs-number">0.119f</span></span>, <span class="hljs-number"><span class="hljs-number">0.715f</span></span>, <span class="hljs-number"><span class="hljs-number">0.357f</span></span>), _mm512_shuffle_ps(zmm0, zmm0, <span class="hljs-number"><span class="hljs-number">0x55</span></span>)); zmm3 = _mm512_mul_ps(_mm512_set4_ps(<span class="hljs-number"><span class="hljs-number">0.0f</span></span>, <span class="hljs-number"><span class="hljs-number">0.950f</span></span>, <span class="hljs-number"><span class="hljs-number">0.072f</span></span>, <span class="hljs-number"><span class="hljs-number">0.180f</span></span>), _mm512_shuffle_ps(zmm0, zmm0, <span class="hljs-number"><span class="hljs-number">0xAA</span></span>)); zmm0 = _mm512_add_ps(zmm1, zmm2); zmm0 = _mm512_add_ps(zmm0, zmm3); zmm0 = _mm512_mask_max_ps(zmm0, <span class="hljs-number"><span class="hljs-number">0x4444</span></span>,_mm512_set1_ps(<span class="hljs-number"><span class="hljs-number">0.0f</span></span>), zmm0); zmm0 = _mm512_mask_min_ps(zmm0, <span class="hljs-number"><span class="hljs-number">0x4444</span></span>,_mm512_set1_ps(<span class="hljs-number"><span class="hljs-number">1.0f</span></span>), zmm0); _mm512_mask_compressstoreu_ps (pDst+<span class="hljs-number"><span class="hljs-number">3</span></span>*i, <span class="hljs-number"><span class="hljs-number">0x7777</span></span>, zmm0 ); } pSrc1 = pSrc1 + src1Step; pDst = pDst + dstStep; } }</code> </pre><br></div></div><br>  With the help of _mm512_mask_expandloadu_ps we put 4 pixels in different lane, after which we consistently form r3r3r3r3 ... r0r0r0, ... g0g0g0, b0b0b0 and multiply by the conversion factors.  To check the overflow, mask operations _mm512_mask_max / min_ps are also used.  Writing the converted data back to memory is done with the _mm512_mask_compressstoreu_ps command.  In this function, masks can also be used for tail processing, depending on the length of the tail. <br><br><h1>  Example 4. Branching vectorization </h1><br>  If you have read this far, then you are already prepared for the most interesting, in my opinion, area of ‚Äã‚Äãapplication of mask registers.  This is a vectoring of cycles with conditions.  We are talking about some kind of predicate register, available in processors of the Itanium family.  Consider a simple function that has an if inside a for loop. <br><div class="spoiler">  <b class="spoiler_title">Sheet 4.1</b> <div class="spoiler_text"><pre> <code class="hljs mel">#define ABS(A) (A)&gt;=<span class="hljs-number"><span class="hljs-number">0.0</span></span>f?(A):(-(A)) void avg_ref( <span class="hljs-keyword"><span class="hljs-keyword">float</span></span>* pSrc1, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> src1Step, <span class="hljs-keyword"><span class="hljs-keyword">float</span></span>* pDst, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> dstStep, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> width, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> height) { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> h, i; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>( h = <span class="hljs-number"><span class="hljs-number">0</span></span>; h &lt; height; h++ ) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(i=<span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; width; i++ ) { <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> dv, dh; <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> valU = pSrc1[src1Step*(h - <span class="hljs-number"><span class="hljs-number">1</span></span>) + i ]; <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> valD = pSrc1[src1Step*(h + <span class="hljs-number"><span class="hljs-number">1</span></span>) + i ]; <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> valL = pSrc1[src1Step*( h ) + (i<span class="hljs-number"><span class="hljs-number">-1</span></span>)]; <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> valR = pSrc1[src1Step*( h ) + (i+<span class="hljs-number"><span class="hljs-number">1</span></span>)]; dv = ABS(valU - valD); dh = ABS(valL - valR); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(dv&lt;=dh){ pDst[i] = (valU + valD) * <span class="hljs-number"><span class="hljs-number">0.5</span></span>f; <span class="hljs-comment"><span class="hljs-comment">//A branch } else { pDst[i] = (valL + valR) * 0.5f; //B branch } } pDst = pDst + dstStep; } }</span></span></code> </pre><br></div></div><br>  The function interpolates in adjacent horizontal or vertical elements, between which the difference is minimal.  The main thing here is that inside the cycle there is a division into two branches, when the if-condition is true, and when not.  But, we can calculate the values ‚Äã‚Äãon avx512 registers in either case, and then combine them by mask. <br><div class="spoiler">  <b class="spoiler_title">Sheet 4.2</b> <div class="spoiler_text"><pre> <code class="hljs django"><span class="xml"><span class="xml">void avg_avx512( const float* pSrc1, int src1Step, float* pDst, int dstStep, int width, int height) { int h, i; for( h = 0; h </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">height</span></span></span></span><span class="xml"><span class="hljs-tag">; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">h</span></span></span></span><span class="xml"><span class="hljs-tag">++ ) { </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">0;</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">for</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">i;</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span></span><span class="xml"><span class="hljs-tag"> &lt; (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">width</span></span></span></span><span class="xml"><span class="hljs-tag">&amp;(~</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">15</span></span></span></span><span class="xml"><span class="hljs-tag">)); </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span></span><span class="xml"><span class="hljs-tag">+=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">16</span></span></span></span><span class="xml"><span class="hljs-tag"> ) { </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">__m512</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">zvU</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">zvD</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">zvL</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">zvR</span></span></span></span><span class="xml"><span class="hljs-tag">; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">__m512</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">zdV</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">zdH</span></span></span></span><span class="xml"><span class="hljs-tag">; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">__m512</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">zavgV</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">zavgH</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">zavg</span></span></span></span><span class="xml"><span class="hljs-tag">; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">__mmask16</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">mskV</span></span></span></span><span class="xml"><span class="hljs-tag">; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">zvU</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">_mm512_loadu_ps(pSrc1+src1Step*(h</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">-</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">1</span></span></span></span><span class="xml"><span class="hljs-tag">) + </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span></span><span class="xml"><span class="hljs-tag"> ); </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">zvD</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">_mm512_loadu_ps(pSrc1+src1Step*(h</span></span></span></span><span class="xml"><span class="hljs-tag"> + </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">1</span></span></span></span><span class="xml"><span class="hljs-tag">) + </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span></span><span class="xml"><span class="hljs-tag"> ); </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">zvL</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">_mm512_loadu_ps(pSrc1+src1Step*(</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">h</span></span></span></span><span class="xml"><span class="hljs-tag"> ) + (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">i-1</span></span></span></span><span class="xml"><span class="hljs-tag">)); </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">zvR</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">_mm512_loadu_ps(pSrc1+src1Step*(</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">h</span></span></span></span><span class="xml"><span class="hljs-tag"> ) + (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span></span><span class="xml"><span class="hljs-tag">+</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">1</span></span></span></span><span class="xml"><span class="hljs-tag">)); </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">zdV</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">_mm512_sub_ps(zvU,</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">zvD</span></span></span></span><span class="xml"><span class="hljs-tag">); </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">zdH</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">_mm512_sub_ps(zvL,</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">zvR</span></span></span></span><span class="xml"><span class="hljs-tag">); </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">zdV</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">_mm512_abs_ps(zdV);</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">zdH</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">_mm512_abs_ps(zdH);</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">mskV</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">_mm512_cmp_ps_mask(zdV,</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">zdH</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">_CMP_LE_OS</span></span></span></span><span class="xml"><span class="hljs-tag">); </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">zavgV</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">_mm512_mul_ps(_mm512_set1_ps(0.5f),</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">_mm512_add_ps</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">zvU</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">zvD</span></span></span></span><span class="xml"><span class="hljs-tag">)); </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">zavgH</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">_mm512_mul_ps(_mm512_set1_ps(0.5f),</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">_mm512_add_ps</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">zvL</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">zvR</span></span></span></span><span class="xml"><span class="hljs-tag">)); </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">zavg</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">_mm512_mask_or_ps(zavgH,</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">mskV</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">zavgV</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">zavgV</span></span></span></span><span class="xml"><span class="hljs-tag">); </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">_mm512_storeu_ps</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">pDst</span></span></span></span><span class="xml"><span class="hljs-tag"> + </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">zavg</span></span></span></span><span class="xml"><span class="hljs-tag">); } //</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">remainder</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">skipped</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">pDst</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">pDst</span></span></span></span><span class="xml"><span class="hljs-tag"> + </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">dstStep</span></span></span></span><span class="xml"><span class="hljs-tag">; } }</span></span></span></span></code> </pre><br></div></div><br>  There can be several such if in the implemented algorithm, for them it is possible to start new masks as long as the code is faster than the scalar. <br><br>  In fact, the icc compiler is quite capable of vectorizing code 4.1. To do this, it suffices to add the restrict keyword to the pointers pSrc1 and pDst and the ‚ÄìQrestrict key. <br><pre> <code class="hljs pgsql"><span class="hljs-type"><span class="hljs-type">void</span></span> avg_ref( <span class="hljs-type"><span class="hljs-type">float</span></span>* <span class="hljs-keyword"><span class="hljs-keyword">restrict</span></span> pSrc1, <span class="hljs-type"><span class="hljs-type">int</span></span> src1Step, <span class="hljs-type"><span class="hljs-type">float</span></span>* <span class="hljs-keyword"><span class="hljs-keyword">restrict</span></span> pDst, <span class="hljs-type"><span class="hljs-type">int</span></span> dstStep, <span class="hljs-type"><span class="hljs-type">int</span></span> width, <span class="hljs-type"><span class="hljs-type">int</span></span> height)</code> </pre><br>  Recall that the restrict modifier indicates to the compiler that access to the object is carried out only through this pointer, and thus the pSrc1 and pDst vectors do not overlap, which makes vectorization possible. <br><br>  Measurements on the internal CPU simulator with avx512 support show that the performance is almost equal to the performance of our avx512 code.  Ie the compiler also knows how to effectively use masks <br><br>  It would seem that this is all.  But let's see what happens if we slightly modify our function and add the dependency between iterations to it. <br><div class="spoiler">  <b class="spoiler_title">Sheet 4.3</b> <div class="spoiler_text"><pre> <code class="hljs pgsql"><span class="hljs-type"><span class="hljs-type">void</span></span> avg_ref( <span class="hljs-type"><span class="hljs-type">float</span></span>* <span class="hljs-keyword"><span class="hljs-keyword">restrict</span></span> pSrc1, <span class="hljs-type"><span class="hljs-type">int</span></span> src1Step, <span class="hljs-type"><span class="hljs-type">float</span></span>* <span class="hljs-keyword"><span class="hljs-keyword">restrict</span></span> pDst, <span class="hljs-type"><span class="hljs-type">int</span></span> dstStep, <span class="hljs-type"><span class="hljs-type">int</span></span> width, <span class="hljs-type"><span class="hljs-type">int</span></span> height) { <span class="hljs-type"><span class="hljs-type">int</span></span> h, i; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>( h = <span class="hljs-number"><span class="hljs-number">0</span></span>; h &lt; height; h++ ) { <span class="hljs-type"><span class="hljs-type">int</span></span> t = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(i=<span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; width; i++ ) { <span class="hljs-type"><span class="hljs-type">float</span></span> dv, dh; <span class="hljs-type"><span class="hljs-type">float</span></span> valU = pSrc1[src1Step*(h - <span class="hljs-number"><span class="hljs-number">1</span></span>) + i ]; <span class="hljs-type"><span class="hljs-type">float</span></span> valD = pSrc1[src1Step*(h + <span class="hljs-number"><span class="hljs-number">1</span></span>) + i ]; <span class="hljs-type"><span class="hljs-type">float</span></span> valL = pSrc1[src1Step*( h ) + (i<span class="hljs-number"><span class="hljs-number">-1</span></span>)]; <span class="hljs-type"><span class="hljs-type">float</span></span> valR = pSrc1[src1Step*( h ) + (i+<span class="hljs-number"><span class="hljs-number">1</span></span>)]; dv = ABS(valU - valD); dh = ABS(valL - valR); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(dv&lt;dh){ pDst[i] = (valU + valD) * <span class="hljs-number"><span class="hljs-number">0.5</span></span>f; t = <span class="hljs-number"><span class="hljs-number">1</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (dv&gt;dh){ pDst[i] = (valL + valR) * <span class="hljs-number"><span class="hljs-number">0.5</span></span>f; t = <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (t == <span class="hljs-number"><span class="hljs-number">1</span></span>) { pDst[i] = (valU + valD) * <span class="hljs-number"><span class="hljs-number">0.5</span></span>f; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { pDst[i] = (valL + valR) * <span class="hljs-number"><span class="hljs-number">0.5</span></span>f; } } pDst = pDst + dstStep; } }</code> </pre><br></div></div><br>  The function also performs interpolation on neighboring pixels, and if the difference in vertical and horizontal is the same, then the interpolation direction used in the previous iteration is used.  On algorithms of this kind, the effect of the out of order mechanism implemented in modern cpu is reduced due to the fact that a long sequence of dependent operations is formed.  The compiler also now can not vectorize the cycle and performance is 17 times slower.  Those.  just about the width of 16 float elements in the AVX512 register.  Now let's try to somehow modify our avx512 code to get at least some kind of acceleration. <br><br>  We introduce the following binary variable masks <br><br>  mskV (n) - the difference is minimal for the nth element of V <br><br>  mskE (n) - for the n-th element of V and H the differences are the same <br><br>  mskD (n) - V interpolation is used for the nth element. <br><br>  Now we will build a truth table, how mskD (n) is formed depending on mskV (n), mskE (n) and the previous mask used - mskD (n-1) <br><img src="https://habrastorage.org/files/a31/830/17c/a3183017c02c4ac690aa7f004b98c289.jpg"><br>  From the table it follows that <br>  mskD (n) = mskV (n) |  (mskE (n) &amp; mskD (n-1)), <br>  which in general was so obvious.  So our avx512 code will look like this. <br><div class="spoiler">  <b class="spoiler_title">Sheet 4.4</b> <div class="spoiler_text"><pre> <code class="hljs django"><span class="xml"><span class="xml">void avg_avx512( const float* pSrc1, int src1Step, float* pDst, int dstStep, int width, int height) { int h, i; for( h = 0; h </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">height</span></span></span></span><span class="xml"><span class="hljs-tag">; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">h</span></span></span></span><span class="xml"><span class="hljs-tag">++ ) { </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">__mmask16</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">mskD</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">0xFFFF;</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">0;</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">for</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">i;</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span></span><span class="xml"><span class="hljs-tag"> &lt; (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">width</span></span></span></span><span class="xml"><span class="hljs-tag">&amp;(~</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">15</span></span></span></span><span class="xml"><span class="hljs-tag">)); </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span></span><span class="xml"><span class="hljs-tag">+=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">16</span></span></span></span><span class="xml"><span class="hljs-tag"> ) { </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">__m512</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">zvU</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">zvD</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">zvL</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">zvR</span></span></span></span><span class="xml"><span class="hljs-tag">; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">__m512</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">zdV</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">zdH</span></span></span></span><span class="xml"><span class="hljs-tag">; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">__m512</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">zavgV</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">zavgH</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">zavg</span></span></span></span><span class="xml"><span class="hljs-tag">; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">__mmask16</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">mskV</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">mskE</span></span></span></span><span class="xml"><span class="hljs-tag">; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">zvU</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">_mm512_loadu_ps(pSrc1+src1Step*(h</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">-</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">1</span></span></span></span><span class="xml"><span class="hljs-tag">) + </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span></span><span class="xml"><span class="hljs-tag"> ); </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">zvD</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">_mm512_loadu_ps(pSrc1+src1Step*(h</span></span></span></span><span class="xml"><span class="hljs-tag"> + </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">1</span></span></span></span><span class="xml"><span class="hljs-tag">) + </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span></span><span class="xml"><span class="hljs-tag"> ); </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">zvL</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">_mm512_loadu_ps(pSrc1+src1Step*(</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">h</span></span></span></span><span class="xml"><span class="hljs-tag"> ) + (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">i-1</span></span></span></span><span class="xml"><span class="hljs-tag">)); </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">zvR</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">_mm512_loadu_ps(pSrc1+src1Step*(</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">h</span></span></span></span><span class="xml"><span class="hljs-tag"> ) + (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span></span><span class="xml"><span class="hljs-tag">+</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">1</span></span></span></span><span class="xml"><span class="hljs-tag">)); </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">zdV</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">_mm512_sub_ps(zvU,</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">zvD</span></span></span></span><span class="xml"><span class="hljs-tag">); </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">zdH</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">_mm512_sub_ps(zvL,</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">zvR</span></span></span></span><span class="xml"><span class="hljs-tag">); </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">zdV</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">_mm512_abs_ps(zdV);</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">zdH</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">_mm512_abs_ps(zdH);</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">mskV</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">_mm512_cmp_ps_mask(zdV,</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">zdH</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">_CMP_LT_OS</span></span></span></span><span class="xml"><span class="hljs-tag">); </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">mskE</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">_mm512_cmp_ps_mask(zdV,</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">zdH</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">_CMP_EQ_OS</span></span></span></span><span class="xml"><span class="hljs-tag">); </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">mskD</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">mskV</span></span></span></span><span class="xml"><span class="hljs-tag"> | (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">mskE</span></span></span></span><span class="xml"><span class="hljs-tag"> &amp; (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">mskD</span></span></span></span><span class="xml"><span class="hljs-tag"> &gt;</span></span></span><span class="xml">&gt;15) &amp; (1</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;&lt;</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0</span></span></span></span><span class="xml"><span class="hljs-tag">)); // </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">bit</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">mskD</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">mskD</span></span></span></span><span class="xml"><span class="hljs-tag"> | (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">mskE</span></span></span></span><span class="xml"><span class="hljs-tag"> &amp; (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">mskD</span></span></span></span><span class="xml"><span class="hljs-tag"> &lt;&lt; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">1</span></span></span></span><span class="xml"><span class="hljs-tag">) &amp; (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">1</span></span></span></span><span class="xml"><span class="hljs-tag">&lt;&lt;</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">1</span></span></span></span><span class="xml"><span class="hljs-tag">)); // </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">1</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">bit</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">mskD</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">mskD</span></span></span></span><span class="xml"><span class="hljs-tag"> | (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">mskE</span></span></span></span><span class="xml"><span class="hljs-tag"> &amp; (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">mskD</span></span></span></span><span class="xml"><span class="hljs-tag"> &lt;&lt; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">1</span></span></span></span><span class="xml"><span class="hljs-tag">) &amp; (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">1</span></span></span></span><span class="xml"><span class="hljs-tag">&lt;&lt;</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">2</span></span></span></span><span class="xml"><span class="hljs-tag">)); // </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">2</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">bit</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">mskD</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">mskD</span></span></span></span><span class="xml"><span class="hljs-tag"> | (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">mskE</span></span></span></span><span class="xml"><span class="hljs-tag"> &amp; (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">mskD</span></span></span></span><span class="xml"><span class="hljs-tag"> &lt;&lt; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">1</span></span></span></span><span class="xml"><span class="hljs-tag">) &amp; (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">1</span></span></span></span><span class="xml"><span class="hljs-tag">&lt;&lt;</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">3</span></span></span></span><span class="xml"><span class="hljs-tag">)); // </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">3</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">bit</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">mskD</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">mskD</span></span></span></span><span class="xml"><span class="hljs-tag"> | (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">mskE</span></span></span></span><span class="xml"><span class="hljs-tag"> &amp; (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">mskD</span></span></span></span><span class="xml"><span class="hljs-tag"> &lt;&lt; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">1</span></span></span></span><span class="xml"><span class="hljs-tag">) &amp; (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">1</span></span></span></span><span class="xml"><span class="hljs-tag">&lt;&lt;</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">4</span></span></span></span><span class="xml"><span class="hljs-tag">)); // </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">4</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">bit</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">mskD</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">mskD</span></span></span></span><span class="xml"><span class="hljs-tag"> | (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">mskE</span></span></span></span><span class="xml"><span class="hljs-tag"> &amp; (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">mskD</span></span></span></span><span class="xml"><span class="hljs-tag"> &lt;&lt; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">1</span></span></span></span><span class="xml"><span class="hljs-tag">) &amp; (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">1</span></span></span></span><span class="xml"><span class="hljs-tag">&lt;&lt;</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">5</span></span></span></span><span class="xml"><span class="hljs-tag">)); // </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">5</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">bit</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">mskD</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">mskD</span></span></span></span><span class="xml"><span class="hljs-tag"> | (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">mskE</span></span></span></span><span class="xml"><span class="hljs-tag"> &amp; (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">mskD</span></span></span></span><span class="xml"><span class="hljs-tag"> &lt;&lt; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">1</span></span></span></span><span class="xml"><span class="hljs-tag">) &amp; (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">1</span></span></span></span><span class="xml"><span class="hljs-tag">&lt;&lt;</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">6</span></span></span></span><span class="xml"><span class="hljs-tag">)); // </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">6</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">bit</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">mskD</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">mskD</span></span></span></span><span class="xml"><span class="hljs-tag"> | (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">mskE</span></span></span></span><span class="xml"><span class="hljs-tag"> &amp; (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">mskD</span></span></span></span><span class="xml"><span class="hljs-tag"> &lt;&lt; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">1</span></span></span></span><span class="xml"><span class="hljs-tag">) &amp; (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">1</span></span></span></span><span class="xml"><span class="hljs-tag">&lt;&lt;</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">7</span></span></span></span><span class="xml"><span class="hljs-tag">)); // </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">7</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">bit</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">mskD</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">mskD</span></span></span></span><span class="xml"><span class="hljs-tag"> | (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">mskE</span></span></span></span><span class="xml"><span class="hljs-tag"> &amp; (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">mskD</span></span></span></span><span class="xml"><span class="hljs-tag"> &lt;&lt; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">1</span></span></span></span><span class="xml"><span class="hljs-tag">) &amp; (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">1</span></span></span></span><span class="xml"><span class="hljs-tag">&lt;&lt;</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">8</span></span></span></span><span class="xml"><span class="hljs-tag">)); // </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">8</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">bit</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">mskD</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">mskD</span></span></span></span><span class="xml"><span class="hljs-tag"> | (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">mskE</span></span></span></span><span class="xml"><span class="hljs-tag"> &amp; (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">mskD</span></span></span></span><span class="xml"><span class="hljs-tag"> &lt;&lt; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">1</span></span></span></span><span class="xml"><span class="hljs-tag">) &amp; (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">1</span></span></span></span><span class="xml"><span class="hljs-tag">&lt;&lt;</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">9</span></span></span></span><span class="xml"><span class="hljs-tag">)); // </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">9</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">bit</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">mskD</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">mskD</span></span></span></span><span class="xml"><span class="hljs-tag"> | (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">mskE</span></span></span></span><span class="xml"><span class="hljs-tag"> &amp; (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">mskD</span></span></span></span><span class="xml"><span class="hljs-tag"> &lt;&lt; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">1</span></span></span></span><span class="xml"><span class="hljs-tag">) &amp; (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">1</span></span></span></span><span class="xml"><span class="hljs-tag">&lt;&lt;</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">10</span></span></span></span><span class="xml"><span class="hljs-tag">)); // </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">10</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">bit</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">mskD</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">mskD</span></span></span></span><span class="xml"><span class="hljs-tag"> | (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">mskE</span></span></span></span><span class="xml"><span class="hljs-tag"> &amp; (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">mskD</span></span></span></span><span class="xml"><span class="hljs-tag"> &lt;&lt; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">1</span></span></span></span><span class="xml"><span class="hljs-tag">) &amp; (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">1</span></span></span></span><span class="xml"><span class="hljs-tag">&lt;&lt;</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">11</span></span></span></span><span class="xml"><span class="hljs-tag">)); // </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">11</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">bit</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">mskD</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">mskD</span></span></span></span><span class="xml"><span class="hljs-tag"> | (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">mskE</span></span></span></span><span class="xml"><span class="hljs-tag"> &amp; (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">mskD</span></span></span></span><span class="xml"><span class="hljs-tag"> &lt;&lt; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">1</span></span></span></span><span class="xml"><span class="hljs-tag">) &amp; (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">1</span></span></span></span><span class="xml"><span class="hljs-tag">&lt;&lt;</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">12</span></span></span></span><span class="xml"><span class="hljs-tag">)); // </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">12</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">bit</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">mskD</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">mskD</span></span></span></span><span class="xml"><span class="hljs-tag"> | (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">mskE</span></span></span></span><span class="xml"><span class="hljs-tag"> &amp; (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">mskD</span></span></span></span><span class="xml"><span class="hljs-tag"> &lt;&lt; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">1</span></span></span></span><span class="xml"><span class="hljs-tag">) &amp; (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">1</span></span></span></span><span class="xml"><span class="hljs-tag">&lt;&lt;</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">13</span></span></span></span><span class="xml"><span class="hljs-tag">)); // </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">13</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">bit</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">mskD</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">mskD</span></span></span></span><span class="xml"><span class="hljs-tag"> | (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">mskE</span></span></span></span><span class="xml"><span class="hljs-tag"> &amp; (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">mskD</span></span></span></span><span class="xml"><span class="hljs-tag"> &lt;&lt; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">1</span></span></span></span><span class="xml"><span class="hljs-tag">) &amp; (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">1</span></span></span></span><span class="xml"><span class="hljs-tag">&lt;&lt;</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">14</span></span></span></span><span class="xml"><span class="hljs-tag">)); // </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">14</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">bit</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">mskD</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">mskD</span></span></span></span><span class="xml"><span class="hljs-tag"> | (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">mskE</span></span></span></span><span class="xml"><span class="hljs-tag"> &amp; (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">mskD</span></span></span></span><span class="xml"><span class="hljs-tag"> &lt;&lt; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">1</span></span></span></span><span class="xml"><span class="hljs-tag">) &amp; (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">1</span></span></span></span><span class="xml"><span class="hljs-tag"> &lt;&lt; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">15</span></span></span></span><span class="xml"><span class="hljs-tag">)); // </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">15</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">bit</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">zavgV</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">_mm512_mul_ps(_mm512_set1_ps(0.5f),</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">_mm512_add_ps</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">zvU</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">zvD</span></span></span></span><span class="xml"><span class="hljs-tag">)); </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">zavgH</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">_mm512_mul_ps(_mm512_set1_ps(0.5f),</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">_mm512_add_ps</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">zvL</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">zvR</span></span></span></span><span class="xml"><span class="hljs-tag">)); </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">zavg</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">_mm512_mask_or_ps(zavgH,</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">mskD</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">zavgV</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">zavgV</span></span></span></span><span class="xml"><span class="hljs-tag">); </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">_mm512_storeu_ps</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">pDst</span></span></span></span><span class="xml"><span class="hljs-tag"> + </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">zavg</span></span></span></span><span class="xml"><span class="hljs-tag">); } </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">pDst</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">pDst</span></span></span></span><span class="xml"><span class="hljs-tag"> + </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">dstStep</span></span></span></span><span class="xml"><span class="hljs-tag">; } }</span></span></span></span></code> </pre><br></div></div><br>  In it all 16 bits of the mask are sequentially sorted.  At 64x64, it works <b>~ 1.7X</b> times faster than C-shny.  Well, at least I managed to get something.  The next possible optimization is that you can pre-calculate all the combinations of masks.  At each iteration of 16 elements, we have 16 bits mskV, 16 bits mskE, and 1 bit from the previous iteration.  Total 2 ^ 33 degrees of options for mskD.  It's a lot.  And what if we process not by 16, but by 8 elements per iteration?  We get 2 ^ (8 + 8 + 1) = 128kbyte table.  And this is quite sane size.  Create an initialization function. <br><div class="spoiler">  <b class="spoiler_title">Sheet 4.5</b> <div class="spoiler_text"><pre> <code class="hljs pgsql">unsigned <span class="hljs-type"><span class="hljs-type">char</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span>[<span class="hljs-number"><span class="hljs-number">2</span></span>*<span class="hljs-number"><span class="hljs-number">256</span></span> * <span class="hljs-number"><span class="hljs-number">256</span></span>]; extern init_table_mask() { <span class="hljs-type"><span class="hljs-type">int</span></span> mskV, mskE, mskD=<span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (mskD = <span class="hljs-number"><span class="hljs-number">0</span></span>; mskD &lt; <span class="hljs-number"><span class="hljs-number">2</span></span>; mskD++){ <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (mskV = <span class="hljs-number"><span class="hljs-number">0</span></span>; mskV &lt; <span class="hljs-number"><span class="hljs-number">256</span></span>; mskV++){ <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (mskE = <span class="hljs-number"><span class="hljs-number">0</span></span>; mskE &lt; <span class="hljs-number"><span class="hljs-number">256</span></span>; mskE++){ <span class="hljs-type"><span class="hljs-type">int</span></span> msk; msk = mskV | (mskE &amp; (mskD ) &amp; (<span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; <span class="hljs-number"><span class="hljs-number">0</span></span>)); // <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-type"><span class="hljs-type">bit</span></span> msk = msk | (mskE &amp; (msk &lt;&lt; <span class="hljs-number"><span class="hljs-number">1</span></span>) &amp; (<span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; <span class="hljs-number"><span class="hljs-number">1</span></span>)); // <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-type"><span class="hljs-type">bit</span></span> msk = msk | (mskE &amp; (msk &lt;&lt; <span class="hljs-number"><span class="hljs-number">1</span></span>) &amp; (<span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; <span class="hljs-number"><span class="hljs-number">2</span></span>)); // <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-type"><span class="hljs-type">bit</span></span> msk = msk | (mskE &amp; (msk &lt;&lt; <span class="hljs-number"><span class="hljs-number">1</span></span>) &amp; (<span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; <span class="hljs-number"><span class="hljs-number">3</span></span>)); // <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-type"><span class="hljs-type">bit</span></span> msk = msk | (mskE &amp; (msk &lt;&lt; <span class="hljs-number"><span class="hljs-number">1</span></span>) &amp; (<span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; <span class="hljs-number"><span class="hljs-number">4</span></span>)); // <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-type"><span class="hljs-type">bit</span></span> msk = msk | (mskE &amp; (msk &lt;&lt; <span class="hljs-number"><span class="hljs-number">1</span></span>) &amp; (<span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; <span class="hljs-number"><span class="hljs-number">5</span></span>)); // <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-type"><span class="hljs-type">bit</span></span> msk = msk | (mskE &amp; (msk &lt;&lt; <span class="hljs-number"><span class="hljs-number">1</span></span>) &amp; (<span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; <span class="hljs-number"><span class="hljs-number">6</span></span>)); // <span class="hljs-number"><span class="hljs-number">6</span></span> <span class="hljs-type"><span class="hljs-type">bit</span></span> msk = msk | (mskE &amp; (msk &lt;&lt; <span class="hljs-number"><span class="hljs-number">1</span></span>) &amp; (<span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; <span class="hljs-number"><span class="hljs-number">7</span></span>)); // <span class="hljs-number"><span class="hljs-number">7</span></span> <span class="hljs-type"><span class="hljs-type">bit</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span>[<span class="hljs-number"><span class="hljs-number">256</span></span>*<span class="hljs-number"><span class="hljs-number">256</span></span>*mskD+<span class="hljs-number"><span class="hljs-number">256</span></span> * mskE + mskV] = (unsigned <span class="hljs-type"><span class="hljs-type">char</span></span>)msk; } } } }</code> </pre><br></div></div><br>  Rewrite the code. <br><div class="spoiler">  <b class="spoiler_title">Sheet 4.6</b> <div class="spoiler_text"><pre> <code class="hljs django"><span class="xml"><span class="xml">void avg_avx512( const float* pSrc1, int src1Step, float* pDst, int dstStep, int width, int height) { int h, i; for( h = 0; h </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">height</span></span></span></span><span class="xml"><span class="hljs-tag">; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">h</span></span></span></span><span class="xml"><span class="hljs-tag">++ ) { </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">__mmask16</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">mskD</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">0xFFFF;</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">0;</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">mskD</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">0x00FF;</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">for</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">i;</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span></span><span class="xml"><span class="hljs-tag"> &lt; (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">width</span></span></span></span><span class="xml"><span class="hljs-tag">&amp;(~</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">7</span></span></span></span><span class="xml"><span class="hljs-tag">)); </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span></span><span class="xml"><span class="hljs-tag">+=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">8</span></span></span></span><span class="xml"><span class="hljs-tag"> ) { </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">__m512</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">Z</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">_mm512_setzero_ps();</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">__m512</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">zvU</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">zvD</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">zvL</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">zvR</span></span></span></span><span class="xml"><span class="hljs-tag">; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">__m512</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">zdV</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">zdH</span></span></span></span><span class="xml"><span class="hljs-tag">; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">__m512</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">zavgV</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">zavgH</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">zavg</span></span></span></span><span class="xml"><span class="hljs-tag">; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">__mmask16</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">mskV</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">mskE</span></span></span></span><span class="xml"><span class="hljs-tag">; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">zvU</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">_mm512_mask_loadu_ps(Z,0xFF,</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">pSrc1</span></span></span></span><span class="xml"><span class="hljs-tag">+</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">src1Step</span></span></span></span><span class="xml"><span class="hljs-tag">*(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">h</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">-</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">1</span></span></span></span><span class="xml"><span class="hljs-tag">) + </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span></span><span class="xml"><span class="hljs-tag"> ); </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">zvD</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">_mm512_mask_loadu_ps(Z,0xFF,</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">pSrc1</span></span></span></span><span class="xml"><span class="hljs-tag">+</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">src1Step</span></span></span></span><span class="xml"><span class="hljs-tag">*(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">h</span></span></span></span><span class="xml"><span class="hljs-tag"> + </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">1</span></span></span></span><span class="xml"><span class="hljs-tag">) + </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span></span><span class="xml"><span class="hljs-tag"> ); </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">zvL</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">_mm512_mask_loadu_ps(Z,0xFF,</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">pSrc1</span></span></span></span><span class="xml"><span class="hljs-tag">+</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">src1Step</span></span></span></span><span class="xml"><span class="hljs-tag">*( </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">h</span></span></span></span><span class="xml"><span class="hljs-tag"> ) + (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">i-1</span></span></span></span><span class="xml"><span class="hljs-tag">)); </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">zvR</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">_mm512_mask_loadu_ps(Z,0xFF,</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">pSrc1</span></span></span></span><span class="xml"><span class="hljs-tag">+</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">src1Step</span></span></span></span><span class="xml"><span class="hljs-tag">*( </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">h</span></span></span></span><span class="xml"><span class="hljs-tag"> ) + (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span></span><span class="xml"><span class="hljs-tag">+</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">1</span></span></span></span><span class="xml"><span class="hljs-tag">)); </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">zdV</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">_mm512_sub_ps(zvU,</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">zvD</span></span></span></span><span class="xml"><span class="hljs-tag">); </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">zdH</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">_mm512_sub_ps(zvL,</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">zvR</span></span></span></span><span class="xml"><span class="hljs-tag">); </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">zdV</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">_mm512_abs_ps(zdV);</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">zdH</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">_mm512_abs_ps(zdH);</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">mskV</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">_mm512_cmp_ps_mask(zdV,</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">zdH</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">_CMP_LT_OS</span></span></span></span><span class="xml"><span class="hljs-tag">)&amp;</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0xFF</span></span></span></span><span class="xml"><span class="hljs-tag">; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">mskE</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">_mm512_cmp_ps_mask(zdV,</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">zdH</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">_CMP_EQ_OS</span></span></span></span><span class="xml"><span class="hljs-tag">)&amp;</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0xFF</span></span></span></span><span class="xml"><span class="hljs-tag">; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">mskD</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">table[256</span></span></span></span><span class="xml"><span class="hljs-tag"> * </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">256</span></span></span></span><span class="xml"><span class="hljs-tag"> * (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">mskD</span></span></span></span><span class="xml"><span class="hljs-tag"> &gt;</span></span></span><span class="xml">&gt; 7) + 256 * mskE + mskV]; zavgV = _mm512_mul_ps(_mm512_set1_ps(0.5f), _mm512_add_ps(zvU, zvD)); zavgH = _mm512_mul_ps(_mm512_set1_ps(0.5f), _mm512_add_ps(zvL, zvR)); zavg = _mm512_mask_or_ps(zavgH, mskD, zavgV, zavgV); _mm512_mask_storeu_ps(pDst + i, 0xFF, zavg); } pDst = pDst + dstStep; } }</span></span></code> </pre><br></div></div><br>  The code began to work <b>~ 4.1X</b> times faster.  You can add processing for 16 elements, but the table will have to turn twice for the iteration. <br><div class="spoiler">  <b class="spoiler_title">Sheet 4.7</b> <div class="spoiler_text"><pre> <code class="hljs django"><span class="xml"><span class="xml">void avg_avx512( const float* pSrc1, int src1Step, float* pDst, int dstStep, int width, int height) { int h, i; for( h = 0; h </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">height</span></span></span></span><span class="xml"><span class="hljs-tag">; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">h</span></span></span></span><span class="xml"><span class="hljs-tag">++ ) { </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">__mmask16</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">mskD</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">0xFFFF;</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">0;</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">for</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">i;</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span></span><span class="xml"><span class="hljs-tag"> &lt; (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">width</span></span></span></span><span class="xml"><span class="hljs-tag">&amp;(~</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">15</span></span></span></span><span class="xml"><span class="hljs-tag">)); </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span></span><span class="xml"><span class="hljs-tag">+=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">16</span></span></span></span><span class="xml"><span class="hljs-tag"> ) { </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">__m512</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">zvU</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">zvD</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">zvL</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">zvR</span></span></span></span><span class="xml"><span class="hljs-tag">; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">__m512</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">zdV</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">zdH</span></span></span></span><span class="xml"><span class="hljs-tag">; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">__m512</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">zavgV</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">zavgH</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">zavg</span></span></span></span><span class="xml"><span class="hljs-tag">; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">__mmask16</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">mskV</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">mskE</span></span></span></span><span class="xml"><span class="hljs-tag">; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">ushort</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">mskD_0_7</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">0,</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">mskD_8_15</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">0;</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">zvU</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">_mm512_loadu_ps(pSrc1+src1Step*(h</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">-</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">1</span></span></span></span><span class="xml"><span class="hljs-tag">) + </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span></span><span class="xml"><span class="hljs-tag"> ); </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">zvD</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">_mm512_loadu_ps(pSrc1+src1Step*(h</span></span></span></span><span class="xml"><span class="hljs-tag"> + </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">1</span></span></span></span><span class="xml"><span class="hljs-tag">) + </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span></span><span class="xml"><span class="hljs-tag"> ); </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">zvL</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">_mm512_loadu_ps(pSrc1+src1Step*(</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">h</span></span></span></span><span class="xml"><span class="hljs-tag"> ) + (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">i-1</span></span></span></span><span class="xml"><span class="hljs-tag">)); </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">zvR</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">_mm512_loadu_ps(pSrc1+src1Step*(</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">h</span></span></span></span><span class="xml"><span class="hljs-tag"> ) + (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span></span><span class="xml"><span class="hljs-tag">+</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">1</span></span></span></span><span class="xml"><span class="hljs-tag">)); </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">zdV</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">_mm512_sub_ps(zvU,</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">zvD</span></span></span></span><span class="xml"><span class="hljs-tag">); </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">zdH</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">_mm512_sub_ps(zvL,</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">zvR</span></span></span></span><span class="xml"><span class="hljs-tag">); </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">zdV</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">_mm512_abs_ps(zdV);</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">zdH</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">_mm512_abs_ps(zdH);</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">mskV</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">_mm512_cmp_ps_mask(zdV,</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">zdH</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">_CMP_LT_OS</span></span></span></span><span class="xml"><span class="hljs-tag">); </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">mskE</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">_mm512_cmp_ps_mask(zdV,</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">zdH</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">_CMP_EQ_OS</span></span></span></span><span class="xml"><span class="hljs-tag">); </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">mskD_0_7</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">table[256</span></span></span></span><span class="xml"><span class="hljs-tag"> * </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">256</span></span></span></span><span class="xml"><span class="hljs-tag"> * (((</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">ushort</span></span></span></span><span class="xml"><span class="hljs-tag">)</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">mskD</span></span></span></span><span class="xml"><span class="hljs-tag">) &gt;</span></span></span><span class="xml">&gt; 15) + 256 * (((ushort)mskE) &amp; 0xFF) + (((ushort)mskV) &amp; 0xFF)]; mskD_8_15 = table[256 * 256 * (((ushort)mskD_0_7) &gt;&gt; 7) + 256 * (((ushort)mskE)&gt;&gt; 8 ) + (((ushort)mskV) &gt;&gt;8 )]; mskD = (mskD_8_15 </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;&lt; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">8</span></span></span></span><span class="xml"><span class="hljs-tag">) | </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">mskD_0_7</span></span></span></span><span class="xml"><span class="hljs-tag">; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">zavgV</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">_mm512_mul_ps(_mm512_set1_ps(0.5f),</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">_mm512_add_ps</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">zvU</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">zvD</span></span></span></span><span class="xml"><span class="hljs-tag">)); </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">zavgH</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">_mm512_mul_ps(_mm512_set1_ps(0.5f),</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">_mm512_add_ps</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">zvL</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">zvR</span></span></span></span><span class="xml"><span class="hljs-tag">)); </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">zavg</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">_mm512_mask_or_ps(zavgH,</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">mskD</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">zavgV</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">zavgV</span></span></span></span><span class="xml"><span class="hljs-tag">); </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">_mm512_storeu_ps</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">pDst</span></span></span></span><span class="xml"><span class="hljs-tag"> + </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">zavg</span></span></span></span><span class="xml"><span class="hljs-tag">); } </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">pDst</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">pDst</span></span></span></span><span class="xml"><span class="hljs-tag"> + </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">dstStep</span></span></span></span><span class="xml"><span class="hljs-tag">; } }</span></span></span></span></code> </pre><br></div></div><br>  Now the acceleration is <b>~ 5.6X</b> compared to the original C code, which is very good for the algorithm with feedback.  Thus, the combination of a mask register and a pre-computed table allows for a significant performance increase.  Code of this kind is not specifically selected for the article and is found for example in photo processing algorithms, when converting images from a RAW format.  True, integer values ‚Äã‚Äãare used there, but such a table method can also be applied to them. <br><br><h1>  Total </h1><br>  This article shows only some of the ways to apply the AVX 512's mask instructions. You can use them in your applications or invent your own tricks.  Or you can use the <a href="https://software.intel.com/en-us/intel-ipp">IPP</a> library, which already contains code optimized specifically for Intel processors with avx512 support, an important part of which is the instructions with mask registers. <br></div><p>Source: <a href="https://habr.com/ru/post/266055/">https://habr.com/ru/post/266055/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../266043/index.html">The ability to restore physical machines from backups using Veeam Endpoint Backup FREE</a></li>
<li><a href="../266045/index.html">Mobile application design patterns. Command processor</a></li>
<li><a href="../266047/index.html">Private mode and list of entered addresses in the new build Vivaldi 1.0.264.3</a></li>
<li><a href="../266051/index.html">RailsClub 2015: Interview with Timofey Tsvetkov</a></li>
<li><a href="../266053/index.html">How to become a partner Host-Tracker</a></li>
<li><a href="../266059/index.html">First look at Scaleway</a></li>
<li><a href="../266061/index.html">Dangerous world of malicious extensions and protection from them. Experience Yandex Browser</a></li>
<li><a href="../266065/index.html">Tehnokniga, Part 2: Literature on DBMS, Frontend Development, Interface Design and In-depth Java Programming</a></li>
<li><a href="../266067/index.html">The action "Good deed" - eliminating digital inequality</a></li>
<li><a href="../266069/index.html">Why CIOs must ‚Äúwork in the field‚Äù</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>