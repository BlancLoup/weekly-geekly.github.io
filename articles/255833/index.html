<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Multiuser chat using WebRTC</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="WebRTC is an API provided by the browser that allows you to organize P2P connection and data transfer directly between browsers. There are quite a few...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Multiuser chat using WebRTC</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/012/34e/5a4/01234e5a4fb44e168d171390a1ab73ed.png" alt="image"><br><br>  WebRTC is an API provided by the browser that allows you to organize P2P connection and data transfer directly between browsers.  There are quite a few tutorials on how to write your own video chat with WebRTC.  For example, <a href="http://habrahabr.ru/post/198632/">here is</a> an article on Habr√©.  However, they are all limited to connecting two clients.  In this article I will try to talk about how to use WebRTC to connect and exchange messages between three or more users. <br><a name="habracut"></a><br>  The RTCPeerConnection interface is a peer-to-peer connection between two browsers.  To connect three or more users, we will have to organize a mesh network (a network in which each node is connected to all other nodes). <br>  We will use the following scheme: <br><ol><li>  When you open the page, check the availability of room ID in <b>location.hash</b> </li><li>  If no room ID is specified, generate a new one. </li><li>  We send a message to the signaling server that we want to join the specified room. </li><li>  The signaling server sends out a notification about a new user to the other clients in this room. </li><li>  Clients already in the room are sending to the newcomer SDP offer </li><li>  Newbie responds to offers </li></ol><br><h4>  0. Signaling server </h4><br>  As you know, although WebRTC provides P2P connectivity between browsers, it still requires additional transport to exchange service messages.  In this example, the WebSocket server written on Node.JS using socket.io is used as such a transport: <br><br><pre><code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> socket_io = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">"socket.io"</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">server</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> users = {}; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> io = socket_io(server); io.on(<span class="hljs-string"><span class="hljs-string">"connection"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">socket</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//       socket.on("room", function(message) { var json = JSON.parse(message); //      users[json.id] = socket; if (socket.room !== undefined) { //      - ,    socket.leave(socket.room); } //     socket.room = json.room; socket.join(socket.room); socket.user_id = json.id; //            socket.broadcast.to(socket.room).emit("new", json.id); }); // ,   WebRTC (SDP offer, SDP answer  ICE candidate) socket.on("webrtc", function(message) { var json = JSON.parse(message); if (json.to !== undefined &amp;&amp; users[json.to] !== undefined) { //          ,    ... users[json.to].emit("webrtc", message); } else { // ...    socket.broadcast.to(socket.room).emit("webrtc", message); } }); // -  socket.on("disconnect", function() { //   ,     socket.broadcast.to(socket.room).emit("leave", socket.user_id); delete users[socket.user_id]; }); }); };</span></span></code> </pre> <br><h4>  1. index.html </h4><br>  The source code of the page itself is quite simple.  I deliberately did not pay attention to the layout and other beautiful, as this article is not about that.  If someone wants to make it beautiful, it will not make much effort. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">head</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">title</span></span></span><span class="hljs-tag">&gt;</span></span>WebRTC Chat Demo<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">title</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"/socket.io/socket.io.js"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">head</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span>Connected to <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">span</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"connection_num"</span></span></span><span class="hljs-tag">&gt;</span></span>0<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">span</span></span></span><span class="hljs-tag">&gt;</span></span> peers<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">textarea</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"message"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">textarea</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">br</span></span></span><span class="hljs-tag">/&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">button</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">onclick</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"sendMessage();"</span></span></span><span class="hljs-tag">&gt;</span></span>Send<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">button</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"room_link"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"chatlog"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text/javascript"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"/javascripts/main.js"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><h4>  2. main.js </h4><br><h5>  2.0.  Getting links to page elements and WebRTC interfaces </h5><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> chatlog = <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.getElementById(<span class="hljs-string"><span class="hljs-string">"chatlog"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> message = <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.getElementById(<span class="hljs-string"><span class="hljs-string">"message"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> connection_num = <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.getElementById(<span class="hljs-string"><span class="hljs-string">"connection_num"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> room_link = <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.getElementById(<span class="hljs-string"><span class="hljs-string">"room_link"</span></span>);</code> </pre><br>  We still have to use browser prefixes to access the WebRTC interfaces. <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> PeerConnection = <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.mozRTCPeerConnection || <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.webkitRTCPeerConnection; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> SessionDescription = <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.mozRTCSessionDescription || <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.RTCSessionDescription; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> IceCandidate = <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.mozRTCIceCandidate || <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.RTCIceCandidate;</code> </pre><br><h5>  2.1.  Room ID Definition </h5><br>  Here we need a function to generate a unique identifier for the room and the user.  We will use for these purposes UUID. <br><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">uuid</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> s4 = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.floor(<span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.random() * <span class="hljs-number"><span class="hljs-number">0x10000</span></span>).toString(<span class="hljs-number"><span class="hljs-number">16</span></span>); }; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> s4() + s4() + <span class="hljs-string"><span class="hljs-string">"-"</span></span> + s4() + <span class="hljs-string"><span class="hljs-string">"-"</span></span> + s4() + <span class="hljs-string"><span class="hljs-string">"-"</span></span> + s4() + <span class="hljs-string"><span class="hljs-string">"-"</span></span> + s4() + s4() + s4(); }</code> </pre><br>  Now let's try to get the room ID from the address.  If not specified, generate a new one.  We will display the link to the current room on the page, and in one, we will generate the identifier of the current user. <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ROOM = location.hash.substr(<span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!ROOM) { ROOM = uuid(); } room_link.innerHTML = <span class="hljs-string"><span class="hljs-string">"&lt;a href='#"</span></span>+ROOM+<span class="hljs-string"><span class="hljs-string">"'&gt;Link to the room&lt;/a&gt;"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ME = uuid();</code> </pre><br><h5>  2.2.  Websocket </h5><br>  Immediately upon opening the page, we connect to our signaling server, send a request to enter the room and specify message handlers. <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// ,           var socket = io.connect("", {"sync disconnect on unload": true}); socket.on("webrtc", socketReceived); socket.on("new", socketNewPeer); //        socket.emit("room", JSON.stringify({id: ME, room: ROOM})); //      ,   WebRTC function sendViaSocket(type, message, to) { socket.emit("webrtc", JSON.stringify({id: ME, to: to, type: type, data: message})); }</span></span></code> </pre><br><h5>  2.3.  PeerConnection Settings </h5><br>  Most providers provide internet connection through NAT.  Because of this, a direct connection becomes not so trivial.  When creating a connection, we need to specify a list of STUN and TURN servers that the browser will try to use to bypass NAT.  We also indicate a couple of additional options for connecting. <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> server = { <span class="hljs-attr"><span class="hljs-attr">iceServers</span></span>: [ {<span class="hljs-attr"><span class="hljs-attr">url</span></span>: <span class="hljs-string"><span class="hljs-string">"stun:23.21.150.121"</span></span>}, {<span class="hljs-attr"><span class="hljs-attr">url</span></span>: <span class="hljs-string"><span class="hljs-string">"stun:stun.l.google.com:19302"</span></span>}, {<span class="hljs-attr"><span class="hljs-attr">url</span></span>: <span class="hljs-string"><span class="hljs-string">"turn:numb.viagenie.ca"</span></span>, <span class="hljs-attr"><span class="hljs-attr">credential</span></span>: <span class="hljs-string"><span class="hljs-string">"your password goes here"</span></span>, <span class="hljs-attr"><span class="hljs-attr">username</span></span>: <span class="hljs-string"><span class="hljs-string">"example@example.com"</span></span>} ] }; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> options = { <span class="hljs-attr"><span class="hljs-attr">optional</span></span>: [ {<span class="hljs-attr"><span class="hljs-attr">DtlsSrtpKeyAgreement</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>}, <span class="hljs-comment"><span class="hljs-comment">//     Chrome  Firefox {RtpDataChannels: true} //   Firefox   DataChannels API ] }</span></span></code> </pre><br><h5>  2.4.  Connect new user </h5><br>  When a new peer is added to the room, the server sends us a message <b>new</b> .  According to the message handlers mentioned above, the socketNewPeer function is <b>called</b> . <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> peers = {}; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">socketNewPeer</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">data</span></span></span><span class="hljs-function">) </span></span>{ peers[data] = { <span class="hljs-attr"><span class="hljs-attr">candidateCache</span></span>: [] }; <span class="hljs-comment"><span class="hljs-comment">//    var pc = new PeerConnection(server, options); //   initConnection(pc, data, "offer"); //      peers[data].connection = pc; //  DataChannel        var channel = pc.createDataChannel("mychannel", {}); channel.owner = data; peers[data].channel = channel; //     bindEvents(channel); //  SDP offer pc.createOffer(function(offer) { pc.setLocalDescription(offer); }); } function initConnection(pc, id, sdpType) { pc.onicecandidate = function (event) { if (event.candidate) { //    ICE         peers[id].candidateCache.push(event.candidate); } else { //    ,     ,    //        SDP offer  SDP answer (    )... sendViaSocket(sdpType, pc.localDescription, id); // ...     ICE  for (var i = 0; i &lt; peers[id].candidateCache.length; i++) { sendViaSocket("candidate", peers[id].candidateCache[i], id); } } } pc.oniceconnectionstatechange = function (event) { if (pc.iceConnectionState == "disconnected") { connection_num.innerText = parseInt(connection_num.innerText) - 1; delete peers[id]; } } } function bindEvents (channel) { channel.onopen = function () { connection_num.innerText = parseInt(connection_num.innerText) + 1; }; channel.onmessage = function (e) { chatlog.innerHTML += "&lt;div&gt;Peer says: " + e.data + "&lt;/div&gt;"; }; }</span></span></code> </pre><br><h5>  2.5.  SDP offer, SDP answer, ICE Cand </h5><br>  When one of these messages is received, we call the handler of the corresponding message. <br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">socketReceived</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">data</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> json = <span class="hljs-built_in"><span class="hljs-built_in">JSON</span></span>.parse(data); <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (json.type) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">"candidate"</span></span>: remoteCandidateReceived(json.id, json.data); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">"offer"</span></span>: remoteOfferReceived(json.id, json.data); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">"answer"</span></span>: remoteAnswerReceived(json.id, json.data); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } }</code> </pre><br><h6>  2.5.0 SDP offer </h6><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">remoteOfferReceived</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">id, data</span></span></span><span class="hljs-function">) </span></span>{ createConnection(id); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> pc = peers[id].connection; pc.setRemoteDescription(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SessionDescription(data)); pc.createAnswer(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">answer</span></span></span><span class="hljs-function">) </span></span>{ pc.setLocalDescription(answer); }); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createConnection</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">id</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (peers[id] === <span class="hljs-literal"><span class="hljs-literal">undefined</span></span>) { peers[id] = { <span class="hljs-attr"><span class="hljs-attr">candidateCache</span></span>: [] }; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> pc = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PeerConnection(server, options); initConnection(pc, id, <span class="hljs-string"><span class="hljs-string">"answer"</span></span>); peers[id].connection = pc; pc.ondatachannel = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e</span></span></span><span class="hljs-function">) </span></span>{ peers[id].channel = e.channel; peers[id].channel.owner = id; bindEvents(peers[id].channel); } } }</code> </pre><br><h6>  2.5.1 SDP answer </h6><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">remoteAnswerReceived</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">id, data</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> pc = peers[id].connection; pc.setRemoteDescription(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SessionDescription(data)); }</code> </pre><br><h6>  2.5.2 ICE candidate </h6><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">remoteCandidateReceived</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">id, data</span></span></span><span class="hljs-function">) </span></span>{ createConnection(id); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> pc = peers[id].connection; pc.addIceCandidate(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IceCandidate(data)); }</code> </pre><br><h5>  2.6.  Posting a message </h5><br>  When you click on the <b>Send</b> button, the <b>sendMessage</b> function is <b>called</b> .  All she does is go through the peer list and try to send the specified message to everyone. <br><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sendMessage</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> msg = message.value; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> peer <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> peers) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (peers.hasOwnProperty(peer)) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (peers[peer].channel !== <span class="hljs-literal"><span class="hljs-literal">undefined</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { peers[peer].channel.send(msg); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (e) {} } } } chatlog.innerHTML += <span class="hljs-string"><span class="hljs-string">"&lt;div&gt;Peer says: "</span></span> + msg + <span class="hljs-string"><span class="hljs-string">"&lt;/div&gt;"</span></span>; message.value = <span class="hljs-string"><span class="hljs-string">""</span></span>; }</code> </pre><br><h5>  2.7.  Disconnect </h5><br>  Well, in the end, when you close the page, it would be good to close all open connections. <br><br><pre> <code class="javascript hljs"><span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.addEventListener(<span class="hljs-string"><span class="hljs-string">"beforeunload"</span></span>, onBeforeUnload); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onBeforeUnload</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> peer <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> peers) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (peers.hasOwnProperty(peer)) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (peers[peer].channel !== <span class="hljs-literal"><span class="hljs-literal">undefined</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { peers[peer].channel.close(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (e) {} } } } }</code> </pre><br><h4>  3. List of sources </h4><br><ol><li>  <a href="http://www.html5rocks.com/en/tutorials/webrtc/basics/">http://www.html5rocks.com/en/tutorials/webrtc/basics/</a> </li><li>  <a href="https://www.webrtc-experiment.com/docs/WebRTC-PeerConnection.html">https://www.webrtc-experiment.com/docs/WebRTC-PeerConnection.html</a> </li><li>  <a href="https://developer.mozilla.org/en-US/docs/Web/Guide/API/WebRTC/WebRTC_basics">https://developer.mozilla.org/en-US/docs/Web/Guide/API/WebRTC/WebRTC_basics</a> </li></ol></div><p>Source: <a href="https://habr.com/ru/post/255833/">https://habr.com/ru/post/255833/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../255823/index.html">Laboratory penetration testing "Test lab v.7". Challenge thrown</a></li>
<li><a href="../255825/index.html">SQL Language Tutorial (DDL, DML) on the example of MS SQL Server dialect. Part three</a></li>
<li><a href="../255827/index.html">3D MC3 Wizard v1.1 or how I assembled my first 3D printer</a></li>
<li><a href="../255829/index.html">Spring + Hibernate for beginners</a></li>
<li><a href="../255831/index.html">Free VID PID pairs for open source projects</a></li>
<li><a href="../255835/index.html">Zhelezyachniki vs. Programmers</a></li>
<li><a href="../255837/index.html">Debugging javascript build in IntelliJ IDEA / PHPStorm / WebStorm</a></li>
<li><a href="../255839/index.html">Fast detection of MIB modules supported by an SNMP device</a></li>
<li><a href="../255843/index.html">HP BURA (HP BackUp, Recovery and Archiving) - HP's offer for organizing data backup and archiving systems</a></li>
<li><a href="../255845/index.html">Systemd in five minutes</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>