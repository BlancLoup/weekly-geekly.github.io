<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>[admin outline] Less admins for everyone</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Let's continue with the security of operating systems - this time the ‚Äúvictim‚Äù will be MS Windows and the principle of providing minimum rights for sy...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>[admin outline] Less admins for everyone</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://habrastorage.org/web/f3a/609/4c6/f3a6094c670f42b9a6827ba3f404cca7.jpg"></p><br><p>  Let's continue with the security of operating systems - this time the ‚Äúvictim‚Äù will be MS Windows and the principle of providing minimum rights for system administration tasks. </p><br><p>  Employees responsible for certain servers and workstations do not need to be granted ‚Äúdomain administrator‚Äù rights.  Although not by malicious intent, by mistake, but it can spoil the lives of all, and even cost someone's weekend.  Under the cat we will examine in detail the principle of granting minimal rights as one of the technologies of granting minimal rights. <a name="habracut"></a></p><br><h1 id="ogranichennye-gruppy">  Limited groups </h1><br><p>  As an example from practice, I can cite a sad story with a happy ending.  In organizations, historically, the <a href="https://habrahabr.ru/company/pc-administrator/blog/332600/">print server</a> was located on a domain controller.  At one point, an IT officer needed to reflash a printer, which he did by running a Chinese utility on the server.  The printer earned, but the utility during the process of flashing transferred the time a few years ago.  Active directory does not like time travelers very much, and the domain controller safely went to the ‚Äútombstone‚Äù ( <a href="https://msdn.microsoft.com/en-us/library/ms680306(v%3Dvs.85).aspx">tombstone</a> ). </p><br><p>  The incident added gray hair, but the second domain controller saved the situation: the roles of FSMO were transferred to it, and the time traveler was again made a domain controller.  Since then, the company has to earn the rights of "domain administrator". </p><br><blockquote>  To prevent such situations, it would be nice to give those who want exactly as many rights as necessary: ‚Äã‚Äãif you only need to administer workstations, you only need to issue rights to users' computers. </blockquote><p>  When there are not many computers, you can also manually turn on the helpdesk domain security group into the local group ‚Äúadministrators‚Äù.  But on a large volume come to the aid of group policies.  There are two convenient ways. </p><br><p>  The first way: through Restricted groups located in group policies at <strong>Computer Configuration - Policies - Security Settings</strong> . </p><br><p><img src="https://habrastorage.org/web/b78/042/a6d/b78042a6d20344d39da5e8d1eb8d7b97.jpg"></p><br><p>  <em>The location of the Restricted groups policy.</em> </p><br><p>  Next, you need to create the Administrators group and add the necessary group to it.  There is only one caveat - if done this way, then everything will disappear from the local group ‚ÄúAdministrators‚Äù, except for the built-in administrator and the group itself.  Even Domain Admins: </p><br><p><img src="https://habrastorage.org/web/f19/4e5/bd1/f194e5bd1c2645ca9f5b3ed7d91a9d10.jpg"></p><br><p>  <em>We add the group ‚ÄúAdministrators‚Äù to which we add the group helpdesk.</em> </p><br><p><img src="https://habrastorage.org/web/e30/4b7/1f9/e304b71f94554633a2ab2763b55b5683.jpg"></p><br><p>  <em>And we get the local group "Administrators" without Domain admins.</em> </p><br><p>  Of course, this opportunity can be used to the benefit of - clean up local groups from unnecessary participants.  If you want to avoid such a sweep, then you can create a domain group in the ‚ÄúRestricted Groups‚Äù and assign it to the Administrators group: </p><br><p><img src="https://habrastorage.org/web/005/5a0/cf6/0055a0cf65c24a128fc1f5b1403340c8.jpg"></p><br><p>  <em>With this setting, the local group "Administrators" will not be cleaned.</em> </p><br><p>  The second way is to set up Group Policy Preferences (Group Policy Preference, hereinafter GPP).  You should search in <strong>Computer Configuration - Settings - Local Users and Groups</strong> . </p><br><p><img src="https://habrastorage.org/web/016/462/3c2/0164623c2faa430a9b69add200f4e419.jpg"></p><br><p>  <em>Configure security group via GPP.</em> </p><br><p>  Like all settings in GPP, this one is easier to understand and has a more user-friendly interface.  But if your infrastructure contains not updated Windows XP or even Windows 2000, then only the first option remains. </p><br><p>  In the same way, you can give rights to certain servers to the right employees.  For example, give rights to a group of developers on a test stand. </p><br><h1 id="ispolzovanie-vstroennyh-grupp-bezopasnosti">  Using built-in security groups </h1><br><p>  Of course, IT staff and system accounts (for example, under which backup tasks are performed) are easier to immediately include in the ‚ÄúEnterprise Admins‚Äù group and don‚Äôt know grief. </p><br><p>  But for security reasons, it‚Äôs better not to.  On Windows, there is a set of built-in accounts with a set of typical rights.  Groups are slightly different for the computer and for the domain, and a number of services introduce their groups. </p><br><div class="spoiler">  <b class="spoiler_title">Under the spoiler, I propose to get acquainted with a set of basic security groups.</b> <div class="spoiler_text"><table><tbody><tr><td width="150">  Group </td><td>  Description </td></tr><tr><td>  Administrators </td><td>  Full system rights. </td></tr><tr><td>  Users </td><td>  The ability to use without changing the system parameters and without writing to the system partitions.  In fact, the user is a full-fledged owner only in his profile folder. </td></tr><tr><td>  Archive operators </td><td>  The group to perform the backup and restore.  Team members can shut down the system on servers and override access rights for backup purposes. </td></tr><tr><td>  Power Users </td><td>  Members of this group can administer local accounts and groups (except administrators), create network resources and control access to them, change the NTFS ACL (except changing the owner of the folder). </td></tr><tr><td>  Remote Desktop Users </td><td>  Membership allows you to connect to a computer via RDP </td></tr><tr><td>  Print operators </td><td>  Operators can install and remove printers, change their drivers and settings, stop and clean the print queue. </td></tr><tr><td>  Network Setup Operators </td><td>  Can change network interface settings.  This is a useful group in case you need to reassign the receipt of an address from a network card from automatic to static.  Mobile users will thank you if you add them to this group. </td></tr><tr><td>  Accounting Operators </td><td>  Users in this group can create / delete / edit / move accounts in Active Directory.  It is convenient to give these rights to the service, which automatically starts the account of employees after being hired. </td></tr></tbody></table><br><p>  You can get acquainted with all groups and a more complete description in the official <a href="https://technet.microsoft.com/en-us/library/a328fe83-b2f6-441b-b2f8-52cfd9e81aef">documentation</a> . </p></div></div><br><p>  If there are not enough standard groups, then Windows allows you to configure permissions more finely.  For example, to give a separate user group the right to change the time or the ability to forcibly shut down a server on the network.  For this, there is a mechanism for ‚Äúassigning user rights‚Äù.  You can search in the local security policy - <strong>secpol.msc</strong> or in the group policy at <strong>Computer Configuration - Windows Configuration - Security Settings - Local Policies - User Rights Assignment</strong> . </p><br><p><img src="https://habrastorage.org/web/cc7/a97/1c7/cc7a971c7fd8411d851a570670cb3892.jpg"></p><br><p>  <em>Setting permissions through group policies.</em> </p><br><p>  I recommend using this setting in extreme cases, and it should be documented.  Remember that sometime someone will replace you and will understand why it works this way and not otherwise. </p><br><blockquote>  In general, it is always better to document everything.  Imagine the situation that you quit the organization and a man came from the street instead of you.  Put yourself in that person‚Äôs place.  If your eyes began to twitch or your hair began to move, take the time to write documentation.  You are welcome! </blockquote><p>  There is another good method for restricting access to objects - delegation.  About this technology <a href="https://habrahabr.ru/post/174437/">on Habr√© already written</a> , so I just add that with the help of delegation conveniently given the right to enter a new computer into the domain. </p><br><p>  All these technologies have been around for a long time in Windows systems.  With the advent of Windows 10 \ 2016, there was another interesting opportunity to restrict accounts - it will be discussed later. </p><br><h1 id="dostatochno-administrirovaniya">  Enough administration </h1><br><p>  Just Enough Administration (JEA) is a technology for providing access to PowerShell cmdlets.  Works on operating systems up to Windows 7 when installing the Windows Management Framework 5.1 (although, in the oldest operating systems support is limited).  The work is done through the so-called "virtual accounts" and specially prepared configuration files.  An example of using JEA is issuing limited rights to manage certain virtual machines ‚Äî for example, for your developers. </p><br><p>  You can read more about JEA in the <a href="https://docs.microsoft.com/en-us/powershell/jea/overview">official documentation</a> , so we‚Äôll analyze a specific example of how a virtual machine can be restarted. </p><br><p>  First, we need to allow remote connection to the server using the <strong>Enable-PSRemoting cmdlet</strong> , and at the same time make sure that we have the Windows Management Framework of the required version using the <strong>$ PSVersionTable.PSVersion</strong> cmdlet. </p><br><p><img src="https://habrastorage.org/web/da7/f4c/c0f/da7f4cc0fded431fad1ef37ae74b8808.jpg"></p><br><p>  <em>Check the version and resolution of remote connections using PS.</em> </p><br><p>  Create a security group and special user: </p><br><pre><code class="hljs php">$VMOperatorGroup = <span class="hljs-keyword"><span class="hljs-keyword">New</span></span>-ADGroup -Name <span class="hljs-string"><span class="hljs-string">"VM-operators"</span></span> -GroupScope DomainLocal -PassThru $OperatorUser = <span class="hljs-keyword"><span class="hljs-keyword">New</span></span>-ADUser -Name <span class="hljs-string"><span class="hljs-string">"VMOperator"</span></span> -AccountPassword (ConvertTo-SecureString <span class="hljs-string"><span class="hljs-string">'P@ssword1'</span></span> -AsPlainText -Force) -PassThru Enable-ADAccount -Identity $OperatorUser Add-ADGroupMember -Identity $VMOperatorGroup -Members $OperatorUser</code> </pre> <br><p>  Now we will create the necessary configuration files and folders.  First common: </p><br><pre> <code class="hljs tex">New-Item -Path "C:<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Program</span></span></span></span> Files<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">WindowsPowerShell</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Modules</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Demo</span></span></span></span>_Module" -ItemType Directory New-ModuleManifest -Path "C:<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Program</span></span></span></span> Files<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">WindowsPowerShell</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Modules</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Demo</span></span></span></span>_Module<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Demo</span></span></span></span>_Module.psd1" New-Item -Path "C:<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Program</span></span></span></span> Files<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">WindowsPowerShell</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Modules</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Demo</span></span></span></span>_Module<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">RoleCapabilities</span></span></span></span>" -ItemType Directory</code> </pre> <br><p>  And then create a specific configuration file for our virtual machine operator named win.  For example, let's allow a virtual machine to start and stop: </p><br><pre> <code class="hljs perl">$VMRoleCapabilityParams = @{ Author = <span class="hljs-string"><span class="hljs-string">' '</span></span> Description = <span class="hljs-string"><span class="hljs-string">'VM Role Capability File'</span></span> CompanyName = <span class="hljs-string"><span class="hljs-string">'ServerMall'</span></span> VisibleCmdlets= <span class="hljs-string"><span class="hljs-string">'Get-VM'</span></span>, @{ Name=<span class="hljs-string"><span class="hljs-string">'Start-VM'</span></span>; Parameters=@{ Name=<span class="hljs-string"><span class="hljs-string">'Name'</span></span>; ValidateSet=<span class="hljs-string"><span class="hljs-string">'win'</span></span> } }, @{ Name = <span class="hljs-string"><span class="hljs-string">'Stop-VM'</span></span>; Parameters = @{ Name = <span class="hljs-string"><span class="hljs-string">'Name'</span></span>; ValidateSet = <span class="hljs-string"><span class="hljs-string">'win'</span></span>}} New-PSRoleCapabilityFile -Path <span class="hljs-string"><span class="hljs-string">"$ENV:ProgramFiles\WindowsPowerShell\Modules\Demo_Module\RoleCapabilities\VMRoleCapability.psrc"</span></span> @VMRoleCapabilityParams</code> </pre> <br><p>  Now you need to prepare the PowerShell session file: </p><br><pre> <code class="hljs perl">$NonAdministrator = <span class="hljs-string"><span class="hljs-string">"DOMAIN\VM-win-Operators"</span></span> $ConfParams = @{ SessionType = <span class="hljs-string"><span class="hljs-string">'RestrictedRemoteServer'</span></span> RunAsVirtualAccount = $true RoleDefinitions = @{ $NonAdministrator = @{ RoleCapabilities = <span class="hljs-string"><span class="hljs-string">'VMRoleCapability'</span></span>} } TranscriptDirectory = <span class="hljs-string"><span class="hljs-string">"$env:ProgramData\JEAConfiguration\Transcripts"</span></span> } New-Item -Path <span class="hljs-string"><span class="hljs-string">"$env:ProgramData\JEAConfiguration"</span></span> -ItemType Directory $SessionName = <span class="hljs-string"><span class="hljs-string">'VM_OperatorSession'</span></span> New-PSSessionConfigurationFile -Path <span class="hljs-string"><span class="hljs-string">"$env:ProgramData\JEAConfiguration\VM.pssc"</span></span> @ConfParams</code> </pre> <br><p>  Register the session file: </p><br><pre> <code class="hljs pgsql">Register-PSSessionConfiguration -<span class="hljs-type"><span class="hljs-type">Name</span></span> <span class="hljs-string"><span class="hljs-string">'VM_OperatorSession'</span></span> -<span class="hljs-type"><span class="hljs-type">Path</span></span> "$env:ProgramData\JEAConfiguration\VM.pssc"</code> </pre> <br><p>  Now everything is ready for verification.  Let's try to connect to the server with the credentials of the user created by the cmdlet: </p><br><pre> <code class="hljs lisp">Enter-PSSession -ComputerName SERVERNAME -ConfigurationName VM_OperatorSession -Credential (<span class="hljs-name"><span class="hljs-name">Get-Credential</span></span>)</code> </pre> <br><p>  Check the list of available commands with <strong>get-command</strong> and try to stop our virtual machine win and then another machine win2. </p><br><p><img src="https://habrastorage.org/web/e8a/8d9/131/e8a8d9131f054dd4ac78cbfcd3b246cd.jpg"></p><br><p>  <em>Access to the server is limited to managing one virtual machine.</em> </p><br><p>  To make it easier for the community to create configuration files, a utility called the <a href="https://gallery.technet.microsoft.com/JEA-Helper-Tool-20-6f9c49dd">JEA Toolkit Helper</a> was created, where a graphical interface will help you create files with the necessary parameters. </p><br><p><img src="https://habrastorage.org/web/003/657/590/003657590e0f4d38ad398b5093e251da.jpg"></p><br><p>  <em>Interface JEA Toolkit Helper.</em> </p><br><p>  If necessary, it is possible through group policies to enable auditing of module execution at <strong>Computer Configuration - Administrative Templates - Windows Powershell - Enable module journaling</strong> .  Then the Windows log will display entries about what, where and when. </p><br><p><img src="https://habrastorage.org/web/e50/e96/4fa/e50e964fafa24580a47f1c780208a34e.jpg"></p><br><p>  <em>PowerShell runtime log.</em> </p><br><p>  An alternative would be to include an entry in the file.  Also through the group policy, the option " <strong>Enable PowerShell transcriptions</strong> " is configured.  The path can be set both in the policy itself (and then the entry will be kept there for all modules), or in the JEA session configuration file in the <strong>TranscriptDirectory</strong> parameter. </p><br><p><img src="https://habrastorage.org/web/bb4/f63/8c0/bb4f638c0f4e4c8aa31d54ed69cf9c84.jpg"></p><br><p>  <em>JEA file log.</em> </p><br><p>  With the help of delegation, assignment of rights and JEA, you can avoid using accounts with administrative rights in your daily work.  In the end, they are also used to UAC in Windows, and we don‚Äôt turn them off simply because ‚Äúshut up, I already know what to do with my files!‚Äù. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/335568/">https://habr.com/ru/post/335568/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../335558/index.html">The market for uninterruptible power supplies has grown for the first time in four years.</a></li>
<li><a href="../335560/index.html">Dive into F #. Handbook for C # Developers</a></li>
<li><a href="../335562/index.html">The digest of fresh materials from the world of the frontend for the last week ‚Ññ275 (August 7 - 13, 2017)</a></li>
<li><a href="../335564/index.html">Continuous integration / deployment of a symfony application using docker-compose and GitLab CI</a></li>
<li><a href="../335566/index.html">Chromebook for remote work. Configure VPN and RDP</a></li>
<li><a href="../335570/index.html">New Safari tools for debugging WebRTC</a></li>
<li><a href="../335572/index.html">Record of the webinar "How to securely protect the company from unknown threats and cryptographers"</a></li>
<li><a href="../335574/index.html">Do-it-yourself chat bot: the story of one bike</a></li>
<li><a href="../335576/index.html">Digital economy and ecosystem R</a></li>
<li><a href="../335578/index.html">DLP and the Law: how to properly arrange the introduction of a system to protect against leaks</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>