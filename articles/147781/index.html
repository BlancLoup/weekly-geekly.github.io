<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Canvas hardware acceleration in Android</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Suppose we decided to write a new Android application. Due to design considerations, standard UI components do not suit us and we will draw a lot of g...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Canvas hardware acceleration in Android</h1><div class="post__text post__text-html js-mediator-article">  Suppose we decided to write a new Android application.  Due to design considerations, standard UI components do not suit us and we will draw a lot of graphics via Canvas or OpenGL ES.  The latter method is somewhat more laborious, so we will not consider it yet.  We are interested in graphics performance on Canvas.  Can I speed it up?  If you go to the official <a href="http://developer.android.com/guide/topics/graphics/hardware-accel.html">website of the</a> android or the developers' <a href="http://android-developers.blogspot.com/2011/03/android-30-hardware-acceleration.html">blog</a> , then you will notice that starting with Android 3.0 (API level 11), the platform now has the ability to enable Canvas hardware acceleration to output 2D graphics. <br><br>  You might think: ‚Äú <i>Super! I‚Äôll add a hardware acceleration flag to my app now!</i> ‚Äù.  Moreover, some <a href="http://stackoverflow.com/questions/10339277/turn-on-hardware-acceleration-if-available-such-android-3-with-android-apk-2">sites</a> claim that the application will work quietly on Android 2.x - such applications will simply ignore the acceleration flag.  Other <a href="http://android-developers.blogspot.com/2011/11/android-40-graphics-and-animations.html">sites</a> say hardware acceleration is enabled by default since Android 4.0.  In fact, everything is not so. <br><br>  And of course, we are interested in the question of how much the application performance will increase when hardware acceleration is enabled. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/getpro/habr/post_images/7b6/671/486/7b6671486783d7527c61d69e69797c57.png" alt="image"><br><a name="habracut"></a><br><br><br>  The first thing I came across when turning on the hardware acceleration flag is that the application completely refused to start on Android 2.x.  "Syntax error.  There was a problem analyzing the package. ‚ÄùAt the same time, the application normally starts on Android 3.x. <br><br><pre><code class="java hljs">android:hardwareAccelerated=<span class="hljs-string"><span class="hljs-string">"true"</span></span></code> </pre> <br><br>  Go ahead.  In applications with dynamic graphics, as a rule, a loop is created (app / game loop), in which the application logic and drawing graphics are executed.  On android, the cycle can be implemented through a timer with a delay of 1 ms with a call to postInvalidate () or for this purpose you can create a new stream.  However, as it turned out, Canvas hardware acceleration does not support operation in a separate thread. <br><br><pre> <code class="java hljs">Canvas canvas = surfaceHolder.lockCanvas(); <span class="hljs-comment"><span class="hljs-comment">// no hardware acceleration in this case</span></span></code> </pre><br><br>  Interestingly, how much does the speed increase when you turn on the acceleration?  To answer this question, I wrote a simple Android application that draws a 128x128 image on Canvas 100 times in a random place, plus shows <a href="http://en.wikipedia.org/wiki/Frame_rate">FPS</a> .  Additionally, the user can choose to draw in the main stream or in the additional stream, and also to enable or disable the setting of the hardware acceleration flag. <br><br>  First of all, the code was modified so that it could run on Android 2.x.  The hardware acceleration flag was removed from AndroidManifest.xml and added to the activity, i.e.  we will enable acceleration programmatically by setting the flag FLAG_HARDWARE_ACCELERATED. <br><br><pre> <code class="java hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onCreate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Bundle savedInstanceState)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.onCreate(savedInstanceState); <span class="hljs-keyword"><span class="hljs-keyword">boolean</span></span> enableAccelerationFlag = getIntent().getExtras() .getBoolean(MainActivity.HW_ENABLED_KEY); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (enableAccelerationFlag) { <span class="hljs-comment"><span class="hljs-comment">// Build target in AndroidManifest.xml and/or Eclipse must be 11 or // higher to compile this code. getWindow().setFlags(WindowManager.LayoutParams.FLAG_HARDWARE_ACCELERATED, WindowManager.LayoutParams.FLAG_HARDWARE_ACCELERATED); } setContentView(R.layout.single_thread); surfaceView = (SingleThreadSurfaceView) findViewById(R.id.single_thread_view); // Enable calling onDraw() method that is switched off by default. surfaceView.setWillNotDraw(false); }</span></span></code> </pre><br><br>  The next block shows how the pictures are being drawn.  It also contains a block for Android 3.x or higher with the isHardwareAccelerated () call.  This method cannot be called on a lower version, t.ch.  check for the operating system version. <br><br><pre> <code class="java hljs"> <span class="hljs-meta"><span class="hljs-meta">@SuppressLint</span></span>(<span class="hljs-string"><span class="hljs-string">"NewApi"</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">draw</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Canvas canvas)</span></span></span><span class="hljs-function"> </span></span>{ canvas.drawColor(Color.RED); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; IMAGES_PER_FRAME; i++) { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> x = (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>) (Math.random() * (canvas.getWidth() - bitmap.getWidth())); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> y = (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>) (Math.random() * (canvas.getHeight() - bitmap.getHeight())); canvas.drawBitmap(bitmap, x, y, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); } canvas.drawText(<span class="hljs-string"><span class="hljs-string">"fps="</span></span> + fps, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">30</span></span>, paint); <span class="hljs-keyword"><span class="hljs-keyword">boolean</span></span> isViewAccelerated = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">boolean</span></span> isCanvasAccelerated = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.HONEYCOMB) { <span class="hljs-comment"><span class="hljs-comment">// This code must not be executed on a device with API // level less than 11 (Android 2.x, 1.x) isViewAccelerated = surfaceView.isHardwareAccelerated(); isCanvasAccelerated = canvas.isHardwareAccelerated(); } canvas.drawText("isViewAccelerated=" + isViewAccelerated, 0, 60, paint); canvas.drawText("isCanvasAccelerated=" + isCanvasAccelerated, 0, 75, paint); }</span></span></code> </pre><br><br>  FPS is calculated quite simply and is called before drawing pictures. <br><br><pre> <code class="java hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">measureFps</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ frameCounter++; <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> now = SystemClock.uptimeMillis(); <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> delta = now - lastFpsCalcUptime; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (delta &gt; FPS_CALC_INTERVAL) { fps = frameCounter * FPS_CALC_INTERVAL / delta; frameCounter = <span class="hljs-number"><span class="hljs-number">0</span></span>; lastFpsCalcUptime = now; } }</code> </pre><br><br>  Below is a summary table of performance testing for 3 available devices and an emulator.  The last two columns are the result of executing the isHardwareAccelerated () methods for View and Canvas, respectively. <br><br><table><tbody><tr><th>  <strong>Platform / Device</strong> </th><th>  <strong>Graphic Model</strong> </th><th>  <strong>FPS</strong> </th><th>  <strong>View sped up?</strong> </th><th>  <strong>Canvas accelerated?</strong> </th></tr><tr><td rowspan="2">  Android 2.2 <br>  Emulator <br>  800x480 </td><td>  1. Main flow, no acceleration </td><td>  <strong><font color="red">four</font></strong> </td><td>  not </td><td>  not </td></tr><tr><td>  2. Additional flow, no acceleration </td><td>  <strong><font color="green">20</font></strong> </td><td>  not </td><td>  not </td></tr><tr><td rowspan="2">  Android 2.2.2 <br>  HTC Desire <br>  800x480 </td><td>  1. Main flow, no acceleration </td><td>  <strong><font color="red">7</font></strong> </td><td>  not </td><td>  not </td></tr><tr><td>  2. Additional flow, no acceleration </td><td>  <strong><font color="green">50</font></strong> </td><td>  not </td><td>  not </td></tr><tr><td rowspan="4">  Android 3.2.1 <br>  Acer A500 <br>  1280x800 </td><td>  1. Main stream, default acceleration </td><td>  20 </td><td>  not </td><td>  not </td></tr><tr><td>  2. Main stream, acceleration flag set </td><td>  28 </td><td>  Yes </td><td>  <strong><font color="green">Yes</font></strong> </td></tr><tr><td>  3. Extra flow, default acceleration </td><td>  thirty </td><td>  not </td><td>  not </td></tr><tr><td>  4. Extra flow, acceleration flag set </td><td>  thirty </td><td>  Yes </td><td>  not </td></tr><tr><td rowspan="4">  Android 4.0.3 <br>  HTC Sensation XE <br>  960x540 </td><td>  1. Main stream, default acceleration </td><td>  26 </td><td>  not </td><td>  not </td></tr><tr><td>  2. Main stream, acceleration flag set </td><td>  <strong><font color="green">39</font></strong> </td><td>  Yes </td><td>  <strong><font color="green">Yes</font></strong> </td></tr><tr><td>  3. Extra flow, default acceleration </td><td>  26 </td><td>  not </td><td>  not </td></tr><tr><td>  4. Extra flow, acceleration flag set </td><td>  26 </td><td>  Yes </td><td>  not </td></tr></tbody></table><br><br>  The results are impressive!  Honestly, I did not expect this. <br><ol><li>  If you need support for Android 2.x, you should use an additional stream for the logic / drawing loop. </li><li>  Setting the hardware support flag on Android 3.x using the main thread shows the same results as without acceleration, but in an additional stream. </li><li>  Hardware acceleration is turned off by default on Android 4.x, and shows a significant acceleration of graphics output in the main stream when it is turned on. </li><li>  The emulator runs 5 times faster when drawing is performed in a separate stream. </li></ol><br><br><br>  The source code of the project is available for download <a href="">here</a> . <br><img src="http://habr.habrastorage.org/post_images/afa/19d/045/afa19d045b2bce238895a5f2856f9174.gif" alt="image"></div><p>Source: <a href="https://habr.com/ru/post/147781/">https://habr.com/ru/post/147781/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../147772/index.html">Debug kits</a></li>
<li><a href="../147774/index.html">Unix Birth and Development</a></li>
<li><a href="../147775/index.html">Win the Galaxy S III and other smartphones in the game quest!</a></li>
<li><a href="../147776/index.html">How OneTwoTrip fools SkyScanner and its customers</a></li>
<li><a href="../147780/index.html">The digest of interesting news and materials from the world of ayti for the last week ‚Ññ14 (July 7 - 13, 2012)</a></li>
<li><a href="../147783/index.html">Answers to questions with PyObject. Part 2</a></li>
<li><a href="../147784/index.html">Paradise for the gamer - a game room for 30 thousand</a></li>
<li><a href="../147786/index.html">New Internet Bank Tinkoff Credit Systems</a></li>
<li><a href="../147787/index.html">Be creative! Or MCC from Raspberry Pi</a></li>
<li><a href="../147788/index.html">Google has started shipping tablets Nexus 7</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>