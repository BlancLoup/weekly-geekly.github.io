<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>PubSub in a browser using webboxes and the WAMP protocol</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Studying the methods of implementing real-time data refresh in the browser, I discovered " WAMP ", an application-level messaging protocol based on we...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>PubSub in a browser using webboxes and the WAMP protocol</h1><div class="post__text post__text-html js-mediator-article">  Studying the methods of implementing real-time data refresh in the browser, I discovered " <a href="http://wamp.ws/">WAMP</a> ", an application-level messaging protocol based on web-based software. <br>  The protocol implements two common high-level templates for data exchange: PubSub and RPC (Remote Procedure Call). <br><br>  These templates are well known and widely used in various areas of programming and interprocess communication: <br><br><ul><li>  RPC - remote procedure call.  In the process involved the client and server.  The first sends requests for a procedure call on the server, and the second executes them and sends the result to the client.  In a typical web application, this could be, for example, a request to create a comment or to add a post to favorites. </li><li>  Publish / Subscribe (PubSub) is a messaging method in which clients ‚Äúsubscribe‚Äù to events of interest to them and can generate such events themselves.  Sending information to subscribers is engaged in a third party - "broker".  In WAMP, a PubSub template is implemented on the basis of "topics", or channels.  For example, on the site such channels can be ‚Äúcomments‚Äù, ‚Äúnews‚Äù, ‚Äúprivate messages‚Äù. </li></ul><br>  In the context of web development, the most interesting use of the WAMP protocol is to use the PubSub template.  With it, you can easily solve the problem of updating information on a page of a site opened by a user: for example, to display a comment just added or to show a notification of receipt of a new message. <br>  WAMP implementation exists in the form of libraries <a href="http://wamp.ws/implementations/">for many languages ‚Äã‚Äãand platforms</a> , including, of course, javascript as an <a href="http://autobahn.ws/js/">autobahn</a> project. <br><a name="habracut"></a><br>  As an example of using the protocol, let's try to develop an abstract web application in which the browser will subscribe to the channel with new comments, and the server will send them.  On the server, PHP will work with the wonderful <a href="http://socketo.me/">Ratchet</a> library, which, in addition to implementing the web sockets, is able to work with the WAMP protocol. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      When planning methods of interaction between the client and the server on such a website, it should be remembered that there <a href="http://caniuse.com/">are</a> still browsers that do not support web-sites.  Although some of the problems with them can be solved by <a href="https://github.com/gimite/web-socket-js">polyfills</a> , 100% of work in any environment (for example, on android) cannot be achieved with their help.  Therefore, it is reasonable, in my opinion, to limit the use of the PubSub template on the client to a subscription to events.  The same events will be generated by the server receiving the ‚Äúold school‚Äù ajax requests to create a new comment on behalf of its author.  Thus, all clients will be able to add comments (or, in general, generate events), but only those who support web-sites will receive updates in real time. <br><br><h5>  The client part of the site. </h5><br>  The autobahn library exports the <b>ab</b> object to the global scope, a full list of methods of which can be found in the <a href="http://autobahn.ws/js/reference/">documentation</a> .  We are also interested in the <b>connect</b> method: <br><br><pre><code class="javascript hljs">ab.connect( <span class="hljs-comment"><span class="hljs-comment">//  'ws://site.com:8080', //     . //    session, //          function (session) { //   .    - , //     . session.subscribe('comments', onNewComment); }, //     . //   ,    , //        . function onClose() { alert('   '); }, { //     'maxRetries': 100, 'retryDelay': 5000 } ); //     comments function onNewComment(topic, data) { //topic -  ,     // data  ,  . //       content  author. console.log(' ', data.author, data.content); }</span></span></code> </pre> <br><br>  For simplicity, the line ‚Äúcomments‚Äù was chosen as the name of the channel, but according to the protocol specification such naming is not correct.  Channels must be in URI format, that is, in our case the channel may be called <code><a href="http://site.com/comments"></a> site.com/comments</code>  <code><a href="http://site.com/comments"></a> site.com/comments</code> .  In turn, the channel URIs can be reduced to ‚Äúcompact URIs‚Äù - CURIE.  These details are described in more detail on the <a href="http://wamp.ws/spec">specification</a> page. <br><br>  It is logical that the user doesn‚Äôt need all new comments at once on a real site, but only those appearing on the current page are needed.  In this case, you can create for example such a channel: <code><a href="http://site.com/comments/page/1"></a> site.com/comments/page/1</code>  <code><a href="http://site.com/comments/page/1"></a> site.com/comments/page/1</code> .  Of course, there are no restrictions on the formation of URIs: you can dynamically create channels with any parameters, depending on the tasks. <br><br><h5>  Server part of the site. </h5><br>  In the example of PHP, ZMQ is responsible for delivering messages from the http server to the server responsible for sending messages to the <a href="http://zeromq.org/">websockets</a> .  When a new comment is received, the server saves it to the database and sends the message to the ZMQ queue, from which it in turn will be retrieved by the daemon using the Ratchet library mentioned above. <br>  Here is how the implementation of such a function looks like: <br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">//  ,   ajax     $comment=array('author'=&gt;'', 'content'=&gt;', !'); //   ... $commentModel-&gt;save($comment); //       $loop = React\EventLoop\Factory::create(); $context = new React\ZMQ\Context($loop); $push = $context-&gt;getSocket(\ZMQ::SOCKET_PUSH); //   ZMQ   ,   ,    $push-&gt;connect('tcp://127.0.0.1:8081'); //     json $push-&gt;send(json_encode($comment)); //tick     . //     -  . $loop-&gt;tick();</span></span></code> </pre><br><br>  To handle client connections and events from the ZMQ server, we need a process that will receive messages and process them.  The documentation for the Ratchet library already contains <a href="http://socketo.me/docs/push">detailed examples</a> .  In particular, you need to pay attention to the Pusher class (in our example, I called it WampProcessor, which seems to be more relevant) - it contains the business logic of the application and sends messages subscribed to the corresponding channels to customers. <br><br>  The code to start such a process would be something like this: <br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">//websocket-   React $loop = React\EventLoop\Factory::create(); //processor -     WAMP,     . //    WampServerInterface. //       //        http-. $processor = new WampProcessor(); //    http-  ZMQ   8081... $context = new React\ZMQ\Context($loop); $pull = $context-&gt;getSocket(ZMQ::SOCKET_PULL); $pull-&gt;bind('tcp://127.0.0.1:8081'); //        'onComment'  'processor' $pull-&gt;on('message', array($processor, 'onComment')); //     -    8080   IP $app = new \components\SocketServer\App('site.com', 8080, '0.0.0.0', $loop); //          , //     (Ratchet    Symfony). //     ,    . //  ""     WampProcessor. $app-&gt;route('/', $processor, array('*')); //... $app-&gt;run();</span></span></code> </pre><br><br>  All methods of the WampProcessor class will be almost identical to what can be seen in the Ratchet documentation;  one of them is to select only the event handler - the " <b>onComment</b> " method: <br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> string   JSON,   ZeroMQ */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onComment</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($json)</span></span></span><span class="hljs-function"> </span></span>{ $comment = json_decode($json, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); <span class="hljs-comment"><span class="hljs-comment">//  ,         if (!array_key_exists('comments', $this-&gt;subscribedTopics)) { return; } $topic = $this-&gt;subscribedTopics['comments']; //     . $topic-&gt;broadcast($comment); }</span></span></code> </pre><br><br>  Thus, when creating a new comment, all connected browsers will receive an object with the author and content fields, which it expects to receive a javascript handler. <br><br>  The messaging process can be observed in the chrome console (‚Äúwebsocket‚Äù filter in the ‚Äúnetwork‚Äù tab) or another browser.  It can be seen that when connecting to the server, the browser sends a greeting message, and then a list of channels to subscribe. <br><br><h5>  Conclusion </h5><br>  So, using the WebSockets technology and the WAMP protocol, you can implement a real-time update of information on a web page using the PubSub method. <br>  It can be argued that using nodejs and the library of socket.io would be easier to do this, but in our reality, where PHP is the dominant server platform, the described version is quite viable and even more convenient than other, more ‚Äúcrutch‚Äù methods (such as periodic server polling using ajax).  It is also relatively easy to implement on an existing site: changes will only need to be made to those parts where any events are generated, and the handler daemon itself can be completely independent. <br><br>  Key links: <br><br><ul><li>  <a href="http://wamp.ws/">Wamp</a> - websocket application messaging protocol. </li><li>  <a href="http://autobahn.ws/">Authobahn</a> - WAMP implementation on javascript. </li><li>  <a href="http://socketo.me/">Ratchet</a> - implementation of web sockets and WAMP for PHP. </li></ul></div><p>Source: <a href="https://habr.com/ru/post/201658/">https://habr.com/ru/post/201658/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../201648/index.html">Easy way to add geolocation to your Android project</a></li>
<li><a href="../201650/index.html">Geopolitical simulator - the history of creation and development</a></li>
<li><a href="../201652/index.html">How to quickly and accurately assess the project without TK</a></li>
<li><a href="../201654/index.html">What does it mean to be a junior developer</a></li>
<li><a href="../201656/index.html">Shortest Common Superstring Problem</a></li>
<li><a href="../201660/index.html">Java and iCalendar work</a></li>
<li><a href="../201662/index.html">Oracle Certification Manual</a></li>
<li><a href="../201666/index.html">AMD hell or how I was tormented with a graphics card from AMD on Linux</a></li>
<li><a href="../201668/index.html">Use external Windows Azure Mobile Services authentication in a WPF desktop application</a></li>
<li><a href="../201670/index.html">SassyStudio - SCSS / SASS / Compass support in Visual Studio</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>