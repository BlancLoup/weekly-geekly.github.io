<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Unchangeable objects in PHP</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this short article, we will look at what immutable objects are and why we should use them. Objects whose state remains constant from the moment of ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Unchangeable objects in PHP</h1><div class="post__text post__text-html js-mediator-article"> In this short article, we will look at what immutable objects are and why we should use them.  Objects whose state remains constant from the moment of their creation are called immutable.  Usually such objects are very simple.  You are probably already familiar with enum types or primitives like <code>DateTimeImmutable</code> .  Below, we will see that if you make simple objects immutable, this will help avoid certain errors and save a lot of time. <br><a name="habracut"></a><br>  When implementing immutable objects, you must: <br><br><ul><li>  Declare a class as <code>final</code> so that it cannot be overridden when adding methods that change the internal state. </li><li>  Declare properties as <code>private</code> so that they cannot be changed again. </li><li>  Avoid setters and use a constructor to set parameters. </li><li>  Do not store links to editable objects or collections.  If you store a collection inside an immutable object, it must also be immutable. </li><li>  Check that if you need to modify an immutable object, you made a copy of it, rather than reuse the existing one. </li></ul><br>  If in one place to change the object, then in the other unwanted side effects may appear, which are difficult to debug.  This can happen anywhere: in third-party libraries, in language structures, etc. The use of immutable objects will avoid such troubles. <br><br>  So, what are the advantages of correctly implemented immutable objects: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ul><li>  The state of the program becomes more predictable, because fewer objects change their own states. </li><li>  Due to the fact that situations with shared references (shared references) become impossible, debugging is simplified. </li><li>  Immutable objects are conveniently used to create parallel executable programs (this article is not considered). </li></ul><br>  Note: immutability can still be broken using reflections, serialization / deserialization, binding of anonymous functions or magic methods.  However, all this is quite difficult to implement and is unlikely to be used by chance. <br><br>  Let's move on to an example of an immutable object: <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Address</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $city; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $house; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $flat; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($city, $house, $flat)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;city = (string)$city; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;house = (string)$house; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;flat = (string)$flat; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getCity</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;city; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getHouse</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;house; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getFlat</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;flat; } }</code> </pre><br>  Once created, this object does not change the state, so it can be considered immutable. <br><br><h1>  Example </h1><br>  Let us now analyze the situation with the transfer of money in the accounts, in which the absence of immutability leads to erroneous results.  We have a class of <code>Money</code> , which represents a certain amount of money. <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Money</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $amount; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getAmount</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;amount; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">add</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($amount)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;amount += $amount; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>; } }</code> </pre><br>  We use it as follows: <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> $userAmount = Money::USD(<span class="hljs-number"><span class="hljs-number">2</span></span>); <span class="hljs-comment"><span class="hljs-comment">/** *     2 .   3%, *       . */</span></span> $processedAmount = $userAmount-&gt;add($userAmount-&gt;getAmount() * <span class="hljs-number"><span class="hljs-number">0.03</span></span>); <span class="hljs-comment"><span class="hljs-comment">/** *        2  + 3%  */</span></span> $markCard-&gt;withdraw($processedAmount); <span class="hljs-comment"><span class="hljs-comment">/** *   2  */</span></span> $alexCard-&gt;deposit($userAmount);</code> </pre><br>  Note: the float type here is used only for the sake of simplicity.  In real life, to perform the operation with the necessary accuracy, you will need to use the bcmath extension or some other vendor libraries. <br><br>  Should be fine.  But due to the fact that the <code>Money</code> class is changeable, instead of two dollars, Alex will receive $ 2 and 6 cents (3% commission).  The reason is that <code>$userAmount</code> and <code>$processedAmount</code> refer to the same object.  In this case, it is recommended to use an immutable object. <br><br>  Instead of modifying an existing object, you must create a new one or make a copy of an existing object.  Let's change the code above by adding another object to it: <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Money</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $amount; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getAmount</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;amount; } }</code> </pre><br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> $userAmount = Money::USD(<span class="hljs-number"><span class="hljs-number">2</span></span>); $commission = $userAmount-&gt;val() * <span class="hljs-number"><span class="hljs-number">3</span></span> / <span class="hljs-number"><span class="hljs-number">100</span></span>; $processedAmount = Money::USD($userAmount-&gt;getAmount() + $commission); $markCard-&gt;withdraw($processedAmount); $alexCard-&gt;deposit($userAmount);</code> </pre><br>  This works well for simple objects, but in the case of complex initialization, it is better to start by copying an existing object: <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Money</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $amount; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getAmount</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;amount; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">add</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($amount)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;amount + $amount, <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;currency); } }</code> </pre><br>  It is used in the same way: <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> $userAmount = Money::USD(<span class="hljs-number"><span class="hljs-number">2</span></span>); <span class="hljs-comment"><span class="hljs-comment">/** *     2 .   3%, *       . */</span></span> $processedAmount = $userAmount-&gt;add($userAmount-&gt;val() * <span class="hljs-number"><span class="hljs-number">0.03</span></span>); <span class="hljs-comment"><span class="hljs-comment">/** *        2  + 3%  */</span></span> $markCard-&gt;withdraw($processedAmount); <span class="hljs-comment"><span class="hljs-comment">/** *   2  */</span></span> $alexCard-&gt;deposit($userAmount);</code> </pre><br>  This time, Alex will receive his two dollars without a commission, and Mark will correctly write off this amount and commission. <br><br><h1>  Random variability </h1><br>  When implementing modifiable objects, programmers may make mistakes that cause objects to become variable.  It is very important to know and understand. <br><br><h3>  Internal reference link leak </h3><br>  We have a mutable class, and we want it to be used by an immutable object. <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MutableX</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $y; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setY</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($y)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;y = $y; } } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Immutable</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $x; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($x)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;x = $x; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getX</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;x; } }</code> </pre><br>  An immutable class has only getters, and a single property is assigned by the constructor.  At first glance, everything is in order, right?  Now let's use this: <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> $immutable = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Immutable(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MutableX()); var_dump(md5(serialize($immutable))); <span class="hljs-comment"><span class="hljs-comment">// f48ac85e653586b6a972251a85dd6268 $immutable-&gt;getX(); var_dump(md5(serialize($immutable))); // f48ac85e653586b6a972251a85dd6268</span></span></code> </pre><br>  The object remains the same, the state has not changed.  Perfectly! <br><br>  Now let's play a little with X: <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> $immutable-&gt;getX()-&gt;setY(<span class="hljs-number"><span class="hljs-number">5</span></span>); var_dump(md5(serialize($immutable))); <span class="hljs-comment"><span class="hljs-comment">// 8d390a0505c85aea084c8c0026c1621e</span></span></code> </pre><br>  The state of the immutable object has changed, so that it actually turned out to be changeable, although everything was to the contrary.  This happened because the implementation ignored the rule ‚Äúdo not store references to mutable objects‚Äù given at the beginning of this article.  Remember: <i>immutable objects must contain only immutable data or objects.</i> <br><br><h3>  Collections </h3><br>  The use of collections is a common phenomenon.  But what if instead of constructing an immutable object with another object, we construct it with a collection of objects? <br><br>  First, let's implement the collection: <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Collection</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $elements = []; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(array $elements)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;elements = $elements; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">add</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($element)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;elements[] = $element; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($key)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;elements[$key]) ? <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;elements[$key] : <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> ; } }</code> </pre><br>  Now use this: <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> $immutable = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Immutable(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Collection([<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> XMutable(), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> XMutable()])); var_dump(md5(serialize($immutable))); <span class="hljs-comment"><span class="hljs-comment">// 9d095d565a96740e175ae07f1192930f $immutable-&gt;getX(); var_dump(md5(serialize($immutable))); // 9d095d565a96740e175ae07f1192930f $immutable-&gt;getX()-&gt;get(0)-&gt;setY(5); var_dump(md5(serialize($immutable))); // 803b801abfa2a9882073eed4efe72fa0</span></span></code> </pre><br>  As we already know, it‚Äôs better not to keep mutable objects inside unchangeable.  Therefore, we replace replaceable objects with scalars. <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> $immutable = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Immutable(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Collection([<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>])); var_dump(md5(serialize($immutable))); <span class="hljs-comment"><span class="hljs-comment">// 24f1de7dc42cfa14ff46239b0274d54d $immutable-&gt;getX(); var_dump(md5(serialize($immutable))); // 24f1de7dc42cfa14ff46239b0274d54d $immutable-&gt;getX()-&gt;add(10); var_dump(md5(serialize($immutable))); // 70c0a32d7c82a9f52f9f2b2731fdbd7f</span></span></code> </pre><br>  Since our collection provides a method for adding new elements, we can indirectly change the state of an immutable object.  So when working with a collection inside an immutable object, make sure that it itself is not changeable.  For example, make sure that it contains only immutable data.  And that there are no methods that add new elements, remove them or otherwise change the state of the collection. <br><br><h3>  Inheritance </h3><br>  Another common situation is related to inheritance.  We know what you need: <br><br><ul><li>  use only getters </li><li>  create instances through the constructor, </li><li>  within objects of immutable objects store only immutable data. </li></ul><br>  Let's modify the <code>Immutable</code> class to accept only <code>Immutable</code> objects. <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Immutable</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $x; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Immutable $x)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;x = $x; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getX</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;x; } }</code> </pre><br>  It looks good ... until someone expands your class: <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Mutant</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Immutable</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getX</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> rand(<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1000000</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setX</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($x)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;x = $x; } }</code> </pre><br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> $mutant = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Mutant(); $immutable = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Immutable($mutant); var_dump(md5(serialize($immutable-&gt;getX()-&gt;getX()))); <span class="hljs-comment"><span class="hljs-comment">// c52903b4f0d531b34390c281c400abad var_dump(md5(serialize($immutable-&gt;getX()-&gt;getX()))); // 6c0538892dc1010ba9b7458622c2d21d var_dump(md5(serialize($immutable-&gt;getX()-&gt;getX()))); // ef2c2964dbc2f378bd4802813756fa7d var_dump(md5(serialize($immutable-&gt;getX()-&gt;getX()))); // 143ecd4d85771ee134409fd62490f295</span></span></code> </pre><br>  Everything went wrong again.  That is why immutable objects must be declared <code>final</code> so that they cannot be expanded. <br><br><h1>  Conclusion </h1><br>  We have learned what an immutable object is, where it can be useful and what rules need to be observed when it is implemented: <br><br><ul><li>  Declare a class as <code>final</code> so that it cannot be overridden when adding methods that change the internal state. </li><li>  Declare properties as <code>private</code> so that they cannot be changed again. </li><li>  Avoid setters and use a constructor to set parameters. </li><li>  Do not store links to editable objects or collections.  If you store a collection inside an immutable object, it must also be immutable. </li><li>  Check that if you need to modify an immutable object, you made a copy of it, rather than reuse the existing one. </li></ul></div><p>Source: <a href="https://habr.com/ru/post/301004/">https://habr.com/ru/post/301004/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../300990/index.html">Is Tesseract recognizes slow?</a></li>
<li><a href="../300992/index.html">The main rules of communication technician in a web studio with a client</a></li>
<li><a href="../300994/index.html">Process approach to management: a tribute to fashion or success?</a></li>
<li><a href="../300998/index.html">Trees without leaves</a></li>
<li><a href="../301000/index.html">Separation of control and data plane in network equipment</a></li>
<li><a href="../301006/index.html">C ++ compiler warnings: cannot be refused</a></li>
<li><a href="../301008/index.html">Racing in the sky: an interview with a professional drone pilot</a></li>
<li><a href="../301016/index.html">Vulnerabilities in the proxy connection: how antiviruses reduce the security of the Internet browser</a></li>
<li><a href="../301018/index.html">Compress and stream TCP video over OpenCV</a></li>
<li><a href="../301020/index.html">The foundation of scalability javascript application</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>