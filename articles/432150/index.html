<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Retrospective of automation and changes in the development processes of Timeweb</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="On November 1, 2017, I became the head of the development team in the Timeweb software development department. And on November 12, 2018, the head of t...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Retrospective of automation and changes in the development processes of Timeweb</h1><div class="post__text post__text-html js-mediator-article">  On November 1, 2017, I became the head of the development team in the Timeweb software development department.  And on November 12, 2018, the head of the department asked when the article would be ready for Habrahabr, because the marketing department asks, the volunteers are over, and the content plan requires something else) <br><br>  Therefore, I want to give a retrospective of how the processes of development, testing and supply of our products have changed over the past year.  About inherited processes and tools, docker, gitlab and how we are developing. <br><a name="habracut"></a><br>  Hosts Timeweb exists since 2006.  All this time, the company has invested a lot of effort to provide customers with a unique and convenient service that would distinguish it from competitors.  Timeweb has its own mobile applications, a web-based email interface, virtual hosting control panels, VDS, an affiliate program, its own support tools and much more. <br><br>  <b>There are about 250 projects in our gitlab:</b> these are client applications, internal tools, libraries, configuration storage.  Dozens of them are actively developed and supported: they commit during the week, test, collect, release. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In addition to the large amount of inherited code, all this pulls the corresponding number of inherited processes and related tools.  Like any legacy, they also need to be maintained, optimized, refactored, and sometimes replaced. <br><br>  From all this abundance of projects are closest to the clients hosting the control panel.  And it is in the ‚ÄúControl Panel‚Äù project that we often run in various infrastructure improvements and make a lot of effort to keep the connected infrastructure in shape.  Spreading the experience and favorite practices in other products and their teams. <br><br>  I will tell you about different changes in tools and processes over the past year. <br><br><h2>  Vagrant ‚Üí docker-compose </h2><br><h3>  Problem </h3><br>  On the first working day, I tried to raise the control panel locally.  At that time, there were five web applications in one repository: <br><br>  - PU shared hosting 3.0, <br>  - PU VDS 2.0, <br>  - PU webmasters, <br>  - STAFF (supports tool), <br>  - Guidelines (demo standardized front-line components). <br><br>  Vagrant was used locally to run.  In Vagrant, it was run ansible.  To start and configure it took the help of colleagues and about a day clean time.  I had to install a special version of the Virtual Box (there were problems on the current stable one), the work from the console inside the virtual machine was unnerving: trivial commands like npm / composer install slowed down noticeably. <br><br>  The performance of the applications themselves in the virtual machine was far from possible, given the technology stack used and the power of the machine.  Not to mention that a virtual machine is a virtual machine, and by definition it occupies a significant part of the resources of your PC. <br><br><h3>  Decision </h3><br>  The local development environment was rewritten to run in docker containers.  Docker-based containerization is the most common solution for isolating the application environment at all stages of its life cycle.  Therefore, there are no special alternatives. <br><br><h3>  findings </h3><br>  Of the benefits: <br><br>  - locally the application has become more responsive, containers require less than a VM, <br>  - the launch of a new instance, as practice has shown, takes only a few minutes and requires only docker (-compose) not lower than certain versions.  After cloning, just run: <br><br><pre><code class="bash hljs">make install-dev make run-dev</code> </pre> <br>  Not without compromise: <br><br>  - I had to write shell-binding for the docked commands (composer, npm, etc.).  They, like docker-compose.yml, are not completely cross-platform, in comparison with Vagrant.  For example, launching on a Mac requires additional efforts, and on Windows, it will probably be easier to run the linux distribution with docker in the virtual machine.  But this is an acceptable compromise, because  the team uses only debian-based distributions, this is a valid limit for commercial development, <br>  - a container based on <a href="https://github.com/jwilder/nginx-proxy">github.com/jwilder/nginx-proxy is</a> launched locally to support virtual hosts.  Not that a crutch, but additional software, which sometimes must be remembered, although it does not cause problems. <br><br>  Yes, everyone in the team had to realize a little bit what a docker is.  Although thanks to the above shell scripts and Makefile, developers perform 95% of their tasks without thinking about containers, but in guaranteed identical environments. <br><br><h2>  newcp-dev ‚Üí cp-stands </h2><br>  These strange phrases are the names of the machines with test panels of the control panels, new and old, respectively. <br><br><h3>  Problem </h3><br>  The ansible recipes were used exclusively inside Vagrant, so the main advantage was not achieved: the versions of the packages in the sale and on the stands differed from what the developers worked. <br><br>  The inconsistency of the versions of the server software packages on the old stands with what the developers had led to problems.  Synchronization was complicated by the fact that system administrators use a different configuration management system, and it is not possible to integrate it with the developers repository. <br><br><h3>  Decision </h3><br>  After containerization, it was not too difficult to expand the docker-compose configuration for use on test benches.  A new machine was created to deploy the stands on DOCKER_HOST. <br><br><h3>  findings </h3><br>  Developers are now confident in the relevance of local and test environments. <br><br><h2>  TeamCity ‚Üí gitlab-ci </h2><br><h3>  Problems </h3><br>  Configuring projects in TeamCity is a painstaking and ungrateful process.  The CI configuration was stored separately from the code, in xml, to which normal versioning is not applicable, and an overview of the changes.  We also experienced problems with the stability of the build process on TeamCity agents. <br><br><h3>  Decision </h3><br>  Since gitlab was already used as a repository repository, starting to use its CI was not only logical, but also easy and pleasant.  Now the entire CI / CD configuration is right in the repository. <br><br><h3>  Result </h3><br>  For the year, almost all the projects gathered by TeamCity successfully moved to gitlab-ci.  We were able to quickly implement a variety of features for automating CI / CD processes. <br>  The clearest screenshots are pipelines: <br><br><img src="https://habrastorage.org/webt/st/v2/il/stv2ileqimz3apyuvtkowk2gad8.png" alt="Ill. 1. feature-branch: includes all available automatic checks and tests. Upon completion, sends a comment referring to the pipeline to the redmine task. Manual tasks for the assembly and launch of the stand with this branch."><br>  <i>Ill.</i>  <i>1. feature-branch: includes all available automatic checks and tests.</i>  <i>Upon completion, sends a comment referring to the pipeline to the redmine task.</i>  <i>Manual tasks for the assembly and launch of the stand with this branch.</i> <br><br><img src="https://habrastorage.org/webt/yz/tp/ud/yztpudorntvx4ffl3es47l5ihti.png" alt="Ill. 2. develop a scheduled build with code freeze (checkout: rc): build develop on a schedule with code freeze. The assembly of the images for the stands of individual control panels takes place in parallel."><br>  <i>Ill.</i>  <i>2. develop a scheduled build with code freeze (checkout: rc): build develop on a schedule with code freeze.</i>  <i>The assembly of the images for the stands of individual control panels takes place in parallel.</i> <br><br><img src="https://habrastorage.org/webt/d4/-t/wt/d4-twtogb-re2pl9gl0i6j4qzz8.png" alt="Ill. 3. tag pipeline: release of one of the control panels. Manual task for rollback release."><br>  <i>Ill.</i>  <i>3. tag pipeline: release of one of the control panels.</i>  <i>Manual task for rollback release.</i> <br><br>  In addition, from gitlab-ci, there is a change of status and the assignment of a person responsible in redmine at the stages In Progress ‚Üí Review ‚Üí QA, notification in Slack about releases and updates of staging and rollbacks. <br><br>  This is convenient, but we did not take into account one methodological point.  Having implemented similar automation in one project, people quickly get used to it.  And in the case of switching to another project where there is no such thing yet, or the process is different, you can forget to move and reassign the puzzle to redmine or leave a comment with a link to the Merge Request (which also gitlab-ci does), thus causing the reviewer to look for the desired MR yourself.  At the same time, you simply don‚Äôt want to copy pieces of .gitlab-ci.yml and the accompanying shell code between projects, because you have to support copy-paste. <br><br>  <b>Conclusion:</b> automation is good, but when it is the same at the level of all teams and projects, it is even better.  I would be grateful to the respected public for ideas on how to organize a reuse of this configuration beautifully. <br><br><h3>  Pipeline duration: 80 min ‚Üí 8 min </h3><br>  Gradually, our CI began to occupy indecently a lot of time.  Testers suffered a lot from this: every fix in the master had to wait an hour for a release.  It looked like this: <br><br><img src="https://habrastorage.org/webt/zg/pc/xf/zgpcxfwroial8l7dkg2gikodlms.png" alt="Ill. 4. pipeline 80 lvl min duration."><br>  <i>Ill.</i>  <i>4. pipeline 80 <s>lvl</s> min duration.</i> <br><br>  It took a few days to dive into the analysis of slow places and search for ways to accelerate while maintaining functionality. <br><br>  The most lengthy places in the process were installing npm-packages.  Without any problems, they replaced it with yarn and saved up to 7 minutes in several places. <br><br>  Abandoned automatic staging updates, preferred manual control of the state of this stand. <br><br>  We also added several runners and divided into parallel tasks the assembly of application images and all the checks.  After these optimizations, the pipeline of the main branch with the update of all the stands began to occupy in most cases 7-8 minutes. <br><br><h2>  Capistrano ‚Üí deployer </h2><br>  For deployment in production and on the qa-booth, Capistrano was used (and continues to be used at the time of this writing).  The main scenario for this tool: cloning the repository to the target server and performing all the tasks there. <br><br>  Previously, the deployment was started by the hands of a QA-engineer who has the necessary ssh keys from Vagrant.  Then, as Vagrant was abandoned, Capistrano moved to a separate container.  Now the deployment is made from a container with Capistrano with gitlab-runners, marked with special tags and having the necessary keys, automatically when the necessary tags appear. <br><br>  The problem here is that the whole build process: <br><br>  a) significantly consumes combat server resources (especially node / gulp), <br>  b) there is no possibility to keep up to date composer version, npm.  node, etc. <br><br>  It is more logical to build on a build server (in our case, this is gitlab-runner), and to put ready-made artifacts on the target server.  This will save the combat server from the assembly utilities and alien responsibility. <br><br>  Now we are considering deployer as a replacement for capistrano (since we don‚Äôt have rubies, and neither do we have a desire to work with its DSL) and plan to transfer the assembly to the gitlab side.  In some non-critical projects, we have already managed to try it and are satisfied so far: it looks simpler, we have not encountered restrictions. <br><br><h2>  Gitflow: rc-branches ‚Üí tags </h2><br>  The development is carried out in weekly cycles.  Over the course of five days, a new version is being developed: improvements and corrections are scheduled for release, scheduled for release next week.  On Friday evening, code freeze automatically occurs.  On Monday, testing of the new version begins, improvements are made, and by the mid-end of the working week, a release takes place. <br><br>  Previously, we used branches with names like rc18-47, which means the release of the candidate of the 47th week of 2018.  Code freeze consisted in checkout rc-branches from develop.  But in October of this year they switched to tags.  Tags have been set before, but after the fact, after the release and merger of rc with master.  Now the appearance of the tag leads to automatic deployment, and freezing this merge develop into master. <br><br>  So we got rid of unnecessary entities in git and variables in the process. <br>  Now we are ‚Äúpulling‚Äù projects that are lagging behind in the process to a similar workflow. <br><br><h2>  Conclusion </h2><br>  Automation of processes, their optimization, as well as development, is a permanent matter: while the product is actively developing and the team is working, there will be corresponding tasks.  There are new ideas how to get rid of routine actions: features are implemented in gitlab-ci. <br><br>  With the growth of applications, CI processes start to take a prohibitively long time - it's time to work on their performance.  As approaches and tools become obsolete, it is necessary to devote time to refactoring, revising them, and updating them. <br><br> <a href="https://timeweb.com/ru/services/vds/%3Futm_source%3Dhabr%26utm_medium%3Dsmo%26utm_campaign%3Ddev_promo"><img src="https://habrastorage.org/webt/7s/ep/wa/7sepwab6lc2aunuzcyjfcothxeu.png" alt="image"></a> </div><p>Source: <a href="https://habr.com/ru/post/432150/">https://habr.com/ru/post/432150/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../432138/index.html">Let's talk about metrics as a way to evaluate a programmer‚Äôs work.</a></li>
<li><a href="../432142/index.html">Hive monitoring and open project</a></li>
<li><a href="../432144/index.html">How we integrated for SAP stores in Europe with cash registers in Russia through 1C</a></li>
<li><a href="../432146/index.html">Zimbra Collaboration Suite as a worthy replacement for Microsoft Exchange</a></li>
<li><a href="../432148/index.html">Features of testing credits: how one bug affects thousands of dollars in revenue</a></li>
<li><a href="../432152/index.html">Conclusions about the future of retail after the ‚ÄúBlack Friday‚Äù</a></li>
<li><a href="../432154/index.html">Conditional Access as an access control mechanism</a></li>
<li><a href="../432156/index.html">New 2GIS - connect to public testing</a></li>
<li><a href="../432158/index.html">Using JIRA and Confluence in a large project</a></li>
<li><a href="../432160/index.html">Android Kolesa Mobile video: modular development, backend driven UI and continuous integration</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>