<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Half the fire did not happen: how we moved to a new data center</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Two moves are equivalent to one fire. 
 (Popular wisdom) 

 Instead of the preface 
 A well-known cardiac surgeon arrives at the car service and rents...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Half the fire did not happen: how we moved to a new data center</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage2/541/a14/4a7/541a144a784e4805afcf422392714f61.png" alt="image" align="left">  <em>Two moves are equivalent to one fire.</em> <em><br></em>  <em>(Popular wisdom)</em> <br><br><h2>  Instead of the preface </h2><br>  A well-known cardiac surgeon arrives at the car service and rents his car for repair.  The mechanic working in the workshop took this opportunity to call the doctor and ask him a question: <br><br>  - Doctor!  In fact, we are doing the same thing: I take out the "hearts" of cars, pull the valves out of them, put new ones.  And I can replace the whole engine.  Anyway, after my work, the car continues to live with a new ‚Äúheart‚Äù.  But you row the money with a shovel, and I get a penny for my work.  Why is that?! 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      What the doctor reasonably remarked: <br><br>  - And you, dear, try to make a major overhaul of a working engine! <br><br><img src="https://habrastorage.org/storage2/eed/8e9/9b2/eed8e99b2b8a525b3752955e7fedc9ac.jpg" alt="image" align="right">  We are growing rapidly, and we constantly need new capacities to house our equipment.  At the same time, the growth of our volumes in no case should result in a decrease in the quality of our services.  This is a strategic task. <br><br>  Summer is the time of vacations, the most ‚Äúcalm‚Äù period for most webmasters: an extraordinary planned ‚Äúreset‚Äù of the server is perceived more calmly. <br><br>  We waited for the summer - and moved to our new <acronym>data center</acronym> ! <br><br><h2>  Task </h2><br>  It would seem, what can I tell?  After all, at first glance, there is nothing tricky in moving: having certain accuracy, you can easily transport anything and anywhere - especially when it comes to transporting boxes of iron, which by their nature are server and network equipment.  In fact, the task of transporting hosting to a new technical platform, and even in St. Petersburg (this is an important point!), Has spicy features - in particular, it is highly desirable for hosting to continue to work during the move.  Thus, the main problem that had to be solved in the process of moving was <strong>minimization of downtime in the provision of services</strong> .  Based on this goal, the means were chosen. <br><a name="habracut"></a><br>  Relocation planning was carried out based on the following data: <br><br><ul><li>  Place actions - St. Petersburg.  The old and new data centers are located on different banks of the Neva River at a distance of 12 kilometers from each other.  For reference: in the summer at night, bridges in the city are divorced. </li><li>  It is required to transfer from the old data center to new servers and other equipment, through which virtual hosting services (shared, premium) are provided for several tens of thousands of sites, VDS rental services, dedicated servers of dedicated customers. </li><li>  The completion of the operation of the old technical site and the commencement of full operation at the new site was planned for three weeks. </li></ul><br><h2>  Solutions </h2><br>  The task before us could be solved in various ways, each of which was carefully analyzed.  Three main groups of solutions were identified. <br><br><h3>  Simple, cheap, clumsy </h3><br>  The simplest solution would look like this: <br><br><ul><li>  Remove all hardware. </li><li>  To load it in the truck, to bring on a new technical platform. </li><li>  Mount it there, run it and see what happens. </li><li>  While the servers are going from place to place, make a change to the announcement of networks and continue the work of all sites at the new place using the old IP addresses. </li></ul><br>  Pros: <br><br><ul><li>  It would be very cheap. </li><li>  The solution is relatively simple to implement. </li><li>  It would turn out very quickly in terms of the duration of the process of the entire move. </li><li>  There would be no need to make changes to the zones hosted on the hosting domain. </li></ul><br>  Minuses: <br><br><ul><li>  The enormous risk of damage to equipment (including, all at once, as well as without the possibility of recovery) during transport. </li><li>  Significant downtime: dismantling and installation of all equipment would take several hours, which is absolutely unacceptable. </li></ul><br>  The quantitative predominance of the advantages of such a scenario of relocation could not outweigh the materiality of its disadvantages, and did not accept the option. <br><br><h3>  Laborious, expensive, elegant </h3><br>  An elegant solution would be to deploy a completely new technical platform in the new location - new equipment in the amount available in the old data center, new networks of IP addresses.  After the readiness of the new site, it would be possible to: <br><br><ul><li>  Manually transfer each site from the old server to the corresponding new one (copy files, database, mail). </li><li>  By reducing the TTL for the domain zones in advance, change the values ‚Äã‚Äãof the corresponding records. </li><li>  At the time of the DNS update, organize proxying, so that for visitors who, for one reason or another, have DNS information cached, sites will be opened from old addresses. </li></ul><br>  Pros: <br><br><ul><li>  Low downtime in the work sites.  For many, the move would have occurred completely unnoticed. </li></ul><br>  Minuses: <br><br><ul><li>  To transfer several tens of thousands of sites, requires an indefinitely large amount of time work of qualified professionals.  Given the need to do ongoing work, the move would have lasted for months. </li><li>  Not all domains of sites hosted by us are delegated to our NS servers.  For those who independently maintain the zones of their domains, no elegance in this solution would be revealed, strictly the opposite. </li><li>  The time for updating the DNS information cannot be predicted or somehow influenced by it - this process does not depend on the hosting provider (for more, see the article <a href="http://zoneli.ru/2011/07/07/all-about-domain-registration/">All about domain registration and transfer</a> ). </li><li>  Not only sites in the usual sense of the word are hosted on our hosting: a number of clients use our computing power to host specialized software, and the described approach for transferring such services would simply not be applicable. </li><li>  It would take an impressive investment in the purchase of an excess amount of new equipment, time to configure it, the cost of its maintenance. </li></ul><br>  The number of disadvantages seriously outweighs the advantages, and this decision was also considered not appropriate: no one has the opportunity to use uncontrolled processes as a tool for solving their problems. <br><br><h3>  Life </h3><br>  After analyzing the factors that determine the duration of a break in the provision of services, we have developed a solution that we are proud of in our depths. <br><br><h3>  Technical factors </h3><br><img src="https://habrastorage.org/storage2/94f/199/55c/94f19955c3ac18dee314ca1e4b0a3285.jpg" alt="image" align="right"><ul><li>  Our company has the status of a local Internet registry ( <a href="http://en.wikipedia.org/wiki/Local_Internet_registry">LIR</a> ) and exploits its own address space.  In this regard, we do not depend on Internet providers, which significantly helped us when moving.  In order to avoid the need to make changes to the records of the domain zones of the sites we host, we decided to continue to work in the current address space.  In order to ensure the possibility of its simultaneous use at both technical sites, the data centers were connected by a virtual network ( <a href="http://en.wikipedia.org/wiki/VLAN">VLAN</a> ).  In practical terms, this gave us the opportunity to turn off the server on the old technical platform and turn it on on the new one without changing the IP addresses and without having to make changes to the routing. </li><li>  Before moving the server with the company's own services (billing, the main NS server, etc.), the operation of the backup NS server, which is located physically outside the main technical site, was additionally verified. </li></ul><br><h3>  Organizational factors </h3><br><ul><li>  Transportation of hard drives was carried out separately from the servers themselves, in the new data center they were installed in new servers: this saved time for dismantling and installing equipment and SCS;  In addition, it is much easier to transport hard disks at night, which is invisible to an external observer, than to transport multiple servers in the collection. </li><li>  In order to minimize the likelihood of being stopped by traffic police officers, the transportation of disks was carried out in an ordinary passenger car that was driving without any traffic violations (speed limit, etc.). </li><li>  Shared and premium servers were shipped on weekends at night - right after the bridges were closed.  The time of transportation of dedicated servers was previously agreed with the clients. </li></ul><br>  Upon completion of the physical transfer of equipment to the new data center, we had only to ‚Äúextinguish‚Äù the network in the old data center and make changes to the routing of our networks, which was successfully done.  From the break in the work site could not be noticed.  For those who, for technical reasons, noticed him, the site‚Äôs visibility ‚Äúdisappeared‚Äù for no more than 10 minutes. <br><br>  Of the minuses of the decision adopted and enforced in life, only significant labor intensity and some overhead costs should be noted (for example, for the purchase of ‚Äúbuffer‚Äù equipment for a new technical platform).  But these moments did not affect the qualitative side of the process, therefore, they turned out to be acceptable. <br><br><h2>  Organizational Conclusions </h2><br>  Of course, we didn‚Äôt succeed in ‚Äúoverhauling a working engine‚Äù - for objective reasons, it‚Äôs impossible to change the physical position of the equipment without interrupting its operation.  But we are glad that we managed to prevent the occurrence of ‚Äúhalf the fire‚Äù - the physical relocation of equipment by the user of the virtual hosting and most of the VDS or dedicated rental services clients looked completely indistinguishable from the ordinary full server reboot, performed, for example, to update hardware or system software : Instead of the planned two hours of downtime, which we warned customers in the mailing lists, the average time of site unavailability was 1 hour and 20 minutes. </div><p>Source: <a href="https://habr.com/ru/post/147955/">https://habr.com/ru/post/147955/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../147946/index.html">Subscriber safety - the work of the subscribers themselves, even for money?</a></li>
<li><a href="../147947/index.html">First steps in robocode</a></li>
<li><a href="../147950/index.html">Access to the French Internet alternative has been closed: Minitel has fizzled out</a></li>
<li><a href="../147951/index.html">Israel invites you to get acquainted with the industry of innovation</a></li>
<li><a href="../147952/index.html">QJson as a library for working with JSON in Qt</a></li>
<li><a href="../147956/index.html">Physics Robocode</a></li>
<li><a href="../147957/index.html">Summer promotion "Quick start!"</a></li>
<li><a href="../147958/index.html">Basics of programming for children and the humanities - no computers in the classroom!</a></li>
<li><a href="../147959/index.html">Attack on Steve Mann due to augmented reality glasses</a></li>
<li><a href="../147960/index.html">Blackberry jam for green men</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>