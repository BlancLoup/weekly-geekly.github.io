<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Research and improvement of IP video server based on Orange Pi PC</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="About six months ago, I got a miniature video server, the application of which I found in a garage rented for a motorcycle, where he worked safely all...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Research and improvement of IP video server based on Orange Pi PC</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/b6d/e48/6a2/b6de486a22e84d8fb5027074cb52953a.JPG"><br><br>  About six months ago, I got a miniature video server, the application of which I found in a garage rented for a motorcycle, where he worked safely all this time in conjunction with two Chinese NoName IP cameras, at least supporting ONVIF, and a 3G modem, which allowed me to remotely Watch the video from the cameras with motion detection alerts, which fortunately coincided so far only with my arrival in the garage.  I didn‚Äôt let this microserver work further on myself, since, when I had just got it in my hands, I took it out of curiosity and unexpectedly discovered that it was built on the Orange Pi PC single board, which, shortly before that, due to its low price, was widely reported on the Internet, including on Geektimes, therefore I approximately represented its opportunities. <br><br>  Actually, after six months of use, in addition to the basic functions of the video server, I wanted to use the GPIO comb on its board to connect a smoke sensor, a door opening sensor and a relay to turn on the siren.  The most interesting and, in my opinion, difficult stage of this hobby project, I decided to share with the community, hoping to get advice on further development.  Attention: the actions described further, most likely, deprived me of guarantees for the device, I produced them at my own risk and risk and cite only as food for the mind, but not a guide to action. <a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h2>  Firmware study </h2><br>  First of all, in the hope that the video server uses a full distribution kit, I tried to connect the monitor and keyboard to the board, but there was no HDMI output signal, it seems the port is simply not involved in the firmware, which, however, the developers say, stating that this device is a class MicroNVR (Network Video Recorder), does not imply any user interaction with the server, except for remote access.  The second goal is ssh, the port of which is open on the device, but the server only supports authorization by key, which I could not get at all. <br><br>  Fortunately for me, the device is based on the version of the single-board device that comes without an eMMC, and the download is done from a standard MicroSD card that runs from the end of the board.  Actually, all you need to get access to the contents of the firmware is to insert the card into the card reader.  On 8Gb SanDisk there are 3 sections: <br><br><pre><code class="bash hljs">/dev/sdb1 on /media/user/disk <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> squashfs /dev/sdb2 on /media/user/UBOOT <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> vfat /dev/sdb3 on /media/user/07836191-ddf8-45ab-b02b-1103320c2e5b <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> ext4</code> </pre> <br>  Sizes of sections: <br><br><pre> <code class="bash hljs">/dev/sdb1 25M 25M 0 100% /media/user/disk /dev/sdb2 16M 2.2M 14M 14% /media/user/UBOOT /dev/sdb3 58M 9.4M 45M 18% /media/user/07836191-ddf8-45ab-b02b-1103320c2e5b</code> </pre> <br>  The ‚ÄúUBOOT‚Äù section seems to be used only by the U-Boot bootloader.  The ext4 section contains logs (/ log) of the main subsystems (kern, lighttpd, line, netcfgd, syslog) and the video surveillance server settings that can be changed by the user (/ lib / line).  And on the section ‚Äúdisk‚Äù with squashfs (compressed read-only) all the OS files and programs are already located.  It turns out that the operating system and the logical part with all the "Analysts" and "Clouds" are fit for developers in 25 MB, which coincides with the size of the updates on their website, i.e.  the entire firmware is being replaced, not just the video surveillance software. <br><br>  The main section contains the usual set of directories: <br><br><pre> <code class="bash hljs">bin dev factory media root sbin tmp var boot etc lib proc run sys usr</code> </pre> <br>  In general, there is nothing unusual in the directory tree, everything is in place.  Runit services are running in / etc / service: <br><br><pre> <code class="bash hljs">dropbear hwclock-fix lighttpd line netcfgd socklog-klog socklog-unix</code> </pre> <br>  Seeing the list lighttpd, I decided to check whether I can use it for their own purposes.  It runs with the configuration: <br><br><pre> <code class="bash hljs">server.modules += ( <span class="hljs-string"><span class="hljs-string">"mod_cgi"</span></span> ) <span class="hljs-variable"><span class="hljs-variable">$SERVER</span></span>[<span class="hljs-string"><span class="hljs-string">"socket"</span></span>] == <span class="hljs-string"><span class="hljs-string">":19587"</span></span> { include_shell <span class="hljs-string"><span class="hljs-string">"/usr/share/adm/lighttpd-gencert"</span></span> server.document-root = <span class="hljs-string"><span class="hljs-string">"/usr/share/adm/www"</span></span> cgi.execute-x-only = <span class="hljs-string"><span class="hljs-string">"enable"</span></span> cgi.assign = ( <span class="hljs-string"><span class="hljs-string">""</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">""</span></span> ) }</code> </pre><br>  Content / usr / share / adm / www: <br><br><pre> <code class="bash hljs">datetime firmware password profiles sysinfo timezones factory-reset locale profile settings timezone</code> </pre> <br>  By the set of scripts, it is clear that the HTTP server provides opportunities for the utility that allows you to change the system settings of the device and update the firmware, it turns out, all this can be done without its participation via the HTTP protocol.  For example, you can get an archive with system information via a browser: <br><br><pre> <code class="bash hljs">https://192.168.1.2:19587/sysinfo</code> </pre> <br>  The server uses the generated self-signed certificate and standard authorization with the ability to change the password (only hash is stored on the device).  A ready HTTPS server with authorization and a very simple option to add my script saved me a lot of time and I proceeded directly to GPIO. <br><br><h2>  Firmware upgrade </h2><br>  A simple query in Google "Orange Pi PC GPIO" immediately led me to the commands: <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> 0 &gt; /sys/class/gpio_sw/PA1/data <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> 1 &gt; /sys/class/gpio_sw/PA1/data</code> </pre> <br>  Finding port names was also not a problem: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/41d/554/885/41d554885ca14024b58c90cad3ad2b74.png"></div><br>  Looking at the existing scripts, I created a new one with the name alarm and content: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh set -e . ../lib/devline/http.sh . ../lib/devline/auth.sh is_auth || http_err_unauth [ "$REQUEST_METHOD" = "PUT" ] || http_err_method PUT value="$(head -c "$CONTENT_LENGTH" | tr -d '.')" echo $value &gt; /sys/class/gpio_sw/PA3/data echo "Content-Type: text/plain" echo echo OK</span></span></code> </pre><br><h2>  Firmware upgrade </h2><br>  It only remained for me to add a new file to the device, which cannot be done by regular copying, since  target file system is read only.  Probably, there are different ways to make changes to squashfs, but I went the easiest, in my opinion.  First of all, I considered the image of the section to file: <br><br><pre> <code class="bash hljs">dd <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>=/dev/sdb2 of=sdb2.img</code> </pre> <br>  Then I unpacked the squashfs in a regular directory: <br><br><pre> <code class="bash hljs">unsquashfs sdb2.img</code> </pre> <br>  I copied the alarm script along the necessary path to squashfs-root and collected a new squashfs image from it: <br><br><pre> <code class="bash hljs">mksquashfs squashfs-root sdb2-new.img</code> </pre> <br>  Which then flooded back to the USB flash drive: <br><br><pre> <code class="bash hljs">dd <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>=sdb2-new.img of=/dev/sdb2</code> </pre> <br><h2>  Total </h2><br>  At the moment I can close the relay through a protected channel: <br><br><pre> <code class="bash hljs">curl -X PUT -k --data <span class="hljs-string"><span class="hljs-string">'1'</span></span> https://admin:j3ks92ls8f@192.168.1.2:19587/alarm</code> </pre> <br>  and open it: <br><br><pre> <code class="bash hljs">curl -X PUT -k --data <span class="hljs-string"><span class="hljs-string">'0'</span></span> https://admin:j3ks92ls8f@192.168.1.2:19587/alarm</code> </pre> <br>  By and large, for me personally, it was just an assessment of the technical feasibility of the implementation of the idea.  The rating is positive: I have access to I / O ports and I can add my logic to the device firmware.  As a bonus, I received a ready-to-use HTTPS server. <br><br>  In my opinion, this was the most interesting part of the development, then for the most part there is only routine left, and I‚Äôm not sure if I‚Äôll finish all my plans in full.  In any case, if someone decides to repeat something similar, here are a couple of ideas for the further development of the current result: <br><br><ol><li>  Write a script service that will monitor the status of the inputs with sensors and respond to the triggering (notify, turn on the siren).  Everything is clear here, there are no difficulties with the service or with the notification, even the curl executable file is already on the device, i.e.  There are several options for notifications: SMTP and receiving messages via IMAP, ready SMS sending services, own server; <br><br></li><li>  Achieve work over the Internet without a direct IP address.  The fact is that only the main video server software works through the cloud, and the lighttp server that implements the system settings is accessible only directly, which, of course, is not bad for itself.  On this point, I'm not so sure of the simplicity of implementation, my ideas are limited to two options so far: ssh-tunnel (you need to add your public key to the device) or your server and long polling from the device side. </li></ol><br>  I would be grateful for your ideas. </div><p>Source: <a href="https://habr.com/ru/post/310090/">https://habr.com/ru/post/310090/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../310078/index.html">The project from the CIS became the winner of the annual battle of startups on TechCrunch</a></li>
<li><a href="../310082/index.html">Overview of decentralized crypto platforms. Part 1: Waves</a></li>
<li><a href="../310084/index.html">Features of the use of machine learning in the protection against DDoS attacks</a></li>
<li><a href="../310086/index.html">Blend4Web vs Unity. Battle in the ring. Round 2</a></li>
<li><a href="../310088/index.html">Java resources to subscribe to</a></li>
<li><a href="../310092/index.html">HPE Synergy Pro Part II - Chassis and Server</a></li>
<li><a href="../310094/index.html">Microsoft has released updates for its products.</a></li>
<li><a href="../310096/index.html">Experiment. How we violated the speed of the mobile Internet</a></li>
<li><a href="../310098/index.html">Magento 2: Grid Creation in adminhtml</a></li>
<li><a href="../310100/index.html">Was there a boy? Our servers and hacker attack on the US Democratic Party</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>