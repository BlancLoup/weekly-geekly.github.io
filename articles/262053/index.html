<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We collect people base from open data WhatsApp and VK</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="scene from the movie Mission Impossible II 

 This story began a couple of months ago, on the first birthday of my son. An SMS was sent to my phone wi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We collect people base from open data WhatsApp and VK</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/c81/bd0/50f/c81bd050fad3430c93457492af40111a.png" alt="Etan hunt"><br>  <i>scene from the movie Mission Impossible II</i> <br><br>  This story began a couple of months ago, on the first birthday of my son.  An SMS was sent to my phone with congratulations and wishes from an unknown number.  I think if it was my birthday I would have had the audacity to send back, not quite cultural, in my opinion, ‚ÄúThank you, and who are you?‚Äù.  However, my birthday is not mine, but it was interesting to find out who sends the congratulations. <br><br><h3>  First success </h3><br>  It was decided to try the following option: <br><ul><li>  Add an unknown number to the phone‚Äôs address book; </li><li>  Go one by one to the applications associated with the number (Viber, WhatsApp); </li><li>  Open a new chat with the newly created contact and identify the sender from the photo. </li></ul><br>  I was lucky and in my case, a miniature of a photo appeared on the Viber contact list next to the newly created contact, by which I, without opening it completely, recognized the sender and satisfied with the ‚Äúinvestigation‚Äù I wrote sms with gratitude for the congratulations. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Immediately after the second interval of euphoria from a successful search in my head, the idea appeared to search the base of the list of mobile phone numbers [phone_number =&gt; photo].  In another second, the idea is to skip these photos through the face recognition system and link it with other open data, such as photos from social networks. <br><a name="habracut"></a><br>  Naturally, at point 3 (from the photo to determine the sender), we can overtake failure and this failure has 6 options: <br><ul><li>  Number is not attached to whatsapp or viber </li><li>  The user is, but he did not install himself </li><li>  The photo is set, but the ‚Äúprivacy‚Äù or ‚Äúprivacy‚Äù settings are configured (‚ÄúShow photos only to my contacts‚Äù, but you are not on this list) </li><li>  You have a photo available, but it shows a cat </li><li>  In the photo is a man, but the features and / or body features cannot be disassembled (lack of sharpness, low resolution, dark glasses, hats, caps, make-up) </li><li>  In the photo the owner of the room;  full face;  high definition but remember this person you can't </li></ul><br>  The fourth item (in the photo cat) has many options: this and photos of celebrities, and cartoon characters, and photos of food, cars, weapons, etc. <br><br><h4>  Tests on small orders. </h4><br>  As a sample of the pen, it was decided to experiment on his contact list.  On Android phones, Viber stores photos of contacts in the <i>/ sdcard / viber / media / User photos</i> folder as <i>[Hash] .jpg</i> .  Files are saved only if you have communicated with this contact or at least opened its profile and deleted after some time.  For the experiment, manually open / close the profiles of 20 users. <br><br>  Some of the acquaintances for whom files were found were also found on social networks are uploaded to Picasa with the option ‚ÄúFace Recognition Automatically‚Äù enabled.  The persons recognized by the program were then named according to their owners.  In the next step we feed Picas'e folder with photos from Viber.  For similar persons, icons with a question mark appear in the ‚ÄúUsers‚Äù window. <br><br>  In my case, for the original 20 Viber users, Picasa found only two matches.  At the same time, these two cases quite comically coincided: in each pair the photographs differed from each other, but were taken on the same day (for the first person, the two photos differed in head and presence / absence of a smile, for the second only a smile differed) <br><br><img src="https://habrastorage.org/files/e4d/482/905/e4d4829052924f7a825bd4b3bfcc265e.png" alt="image"><br><br>  The intermediate result is quite successful: <br>  Sample from Viber: 20 (all in a row with cats and food) <br>  Sample from VK: 5 (only if you can visually recognize someone in the photo) <br>  Matches true: 2 <br>  False Matches: 0 <br><br><h5>  Getting bust </h5><br>  Let's try to get data using the phone.  Viber takes contacts from the phone book, which in turn in the Android OS is associated with Google Contacts, which have a limit of 25,000 numbers per account.  At the moment, the number of mobile operators assigned to Moscow is 93 311 000. So the idea of ‚Äã‚Äãgetting a base with such a ‚Äúhead-on solution‚Äù is no longer relevant.  Moreover, even if Viber takes at least the first pack of 25,000 numbers, you still need to go into each profile, and then also associate the resulting file <i>[Hash] .jpg</i> with a specific number (which can probably be tracked by file creation date , but it is still very time consuming and long). <br><br>  The solution was found quickly: the network has a software implementation of another popular service - WhatsApp.  All calls go through php.  There is a ready script for registering a new user and an example of a call to <i>getProfilePicture</i> .  To start the process, you need a * nix server and you need to understand how much you can take in with the frequency and speed of requests.  For the experiment, php code was written, which is authorized in Whatsapp and in an infinite loop it receives / does not receive for numbers + 7XXXXXXXXXX <i>getProfilePicture</i> and displays a timestamp on the screen.  During the first and subsequent launches this code reached 220-250 numbers and left at <i>timeout</i> - we try to pause after every 200th <i>sleep (5)</i> - it does not help, <i>timeout</i> is still.  We try to complete the process and immediately start again - success.  Accordingly, we deal with either a restriction on the server (it is necessary to reauthorize after 200 requests), or an error in this php implementation.  I did not experiment, but killed two birds with one stone, rewriting the php script so that it would process only 200 numbers and add a control script to Bash, which in the loop starts php with the <i>$ startPhoneNumber</i> parameter and waits for it to complete. <br><br>  Thus, we got a working search circuit with a speed of 5.7 numbers per second. <br>  To handle the entire Moscow capacity, we need: <br><br>  93,311,000 (numbers) / 5.7 (numbers per second) / 60 (seconds) / 60 (minutes) / 24 (hours) ~ <b>190 days</b> . <br><br><h3>  Multithreading </h3><br>  Authorization in WhatsApp goes through a bunch <br><br>  <b>username</b> - phone numbers in the format + 7XXXXXXXXXXX <br>  <b>password</b> - received through the registration script (for registration, you need a working sim card to get a confirmation code) <br>  <b>nickname</b> - can be any <br><br>  WhatsApp prohibits&gt; 1 authorization for one username at one time.  In this connection, the official store purchased three SIM-cards of the operator Megaphone for 200 rubles each.  each  From the same server on Centos OS, all three numbers were registered in WhatsApp and all three were launched using a script with a piece of Beeline Business capacity.  The ratio of the number of rooms to the stored photos kept around 10 to the 1st;  then the difference increased due to ‚Äúhundreds‚Äù and ‚Äúthousands‚Äù, which are apparently not yet distributed and do not give a single image for the whole range. <br><br><h3>  Lock </h3><br>  The license agreement WhatsApp (with which I agree when I go through registration) says: <br><br><div class="spoiler">  <b class="spoiler_title">Extract from the ENG agreement</b> <div class="spoiler_text"><blockquote> If you are not a limiting system, including "robots," "spiders," "offline readers," etc.  or "load testers" such as wget, apache bench, mswebstress, httpload, blitz, Xcode Automator, Android Monkey, etc., that is, If you are not allowed to use it.  If you are not a victim of the materials, you must be able to find out what kind of materials you need.  WhatsApp reserves for revoke these exceptions either generally or in specific cases.  If you‚Äôre looking for something like a snooper, it‚Äôs not a problem.  We have to disallow your request using the tools such as fiddler or whisker.  You must be secured  It is not a problem to use any information.  For commercial purposes, or for users of the Service. </blockquote><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Extract from the agreement;</b>  <b class="spoiler_title">approximate translation</b> <div class="spoiler_text"><blockquote>  "You agree not to use or not to run automated systems that send more requests to the WhatsApp service than a person is capable of ..." </blockquote><br></div></div><br>  All my SIM cards were blocked on the third day without explanation.  The logs show that the disconnection occurred at 00:22 Moscow time on all the cards at the same time (about 500,000 numbers each managed to process the cards).  What is interesting is that the WhatsApp server first began to respond to requests for a very long time, and then stopped authorizing altogether.  At the attempt to register the number anew, the server responds with " <i>Failed; Reason: Blocked;</i> ".  When I try to register WhatsApp in a human way, a message pops up from the phone: ‚ÄúSorry, you can no longer use the WhatsApp service.‚Äù <br><br>  Besides the fact that all three running scripts did the same at the same speed, they had much in common to block them simultaneously, namely: they all logged in with the same nickname "V" and worked from the same IP addresses. <br><br><h5>  Complicate the scheme </h5><br><img src="https://habrastorage.org/files/12f/8cc/39d/12f8cc39d1054565873c9f5014594cbd.png"><br><br>  We believe that they have become slightly (namely, at 600 rubles spent on those three SIMs) smarter.  At this time we buy 10 SIM cards in the "unofficial store" at the metro at 100 rubles.  a piece.  Complicate the script, create an array of sim cards and give each our own nickname according to the list of actors of a remarkable movie: <br><br><div class="spoiler">  <b class="spoiler_title">Array declaration</b> <div class="spoiler_text"><pre><code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// username,"password","nickname" $SIMDict = array( &lt;br&gt; "SIM1" =&gt; array(7969XXXXXXX,"123123211231231231231231231=","Zooey"), "SIM2" =&gt; array(7916XXXXXXX,"123123211231231231231231231=","Martin"), "SIM3" =&gt; array(7985XXXXXXX,"123123211231231231231231231=","Sam"), "SIM4" =&gt; array(7916XXXXXXX,"123123211231231231231231231=","Bill"), "SIM5" =&gt; array(7985XXXXXXX,"123123211231231231231231231=","Mos"), "SIM6" =&gt; array(7985XXXXXXX,"123123123211231231231231231=","Warwick"), "SIM7" =&gt; array(7916XXXXXXX,"123123211231231231231231231=","Anna"), "SIM8" =&gt; array(7985XXXXXXX,"123123123123123123123123121=","John"), "SIM9" =&gt; array(7,"","Kelly"), "SIM10" =&gt; array(7,"","Jason") );</span></span></code> </pre> <br></div></div><br><div class="spoiler">  <b class="spoiler_title">We force each SIM card to exit through a separate IP address.</b> <div class="spoiler_text">  Our Centos is a virtual server running under the Hyper-V hypervisor, which allows us to add 7 more Ethernet adapters to it (Hyper-v restriction: 8 Ethernet adapters + 4 legacy).  It only remains to make the php processes go to the Internet each with a different ip address. <br><br>  The system has a default subsystem ip namespaces (ip netns), which allows you to fully virtualize the network stack.  This means that you can create so-called namespacs (ns), and within each individual ns there will be your own addresses, routes, rules, dns, etc. There are not so many articles on ip netns on the Internet, and those that have different readings on using physical interfaces - some people write that it is impossible to add a physical interface to the namespace that is different from default, some that can be, but only connected via a tap interface, some that can be done without tap. <br><br>  I did not manage to create seven secondary ip (alias) and scatter them in different namespace, either directly or through tap interfaces.  But the option to create 7 namespaces and to attach a separate physical interface to each, despite assurances from the Internet community, was possible without problems. <br><div class="spoiler">  <b class="spoiler_title">Setup Commands</b> <div class="spoiler_text">  LINUX <br><pre> <code class="bash hljs">ip netns add net1 &amp;&amp; ip link <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> netns net1 dev eth1 ip netns <span class="hljs-built_in"><span class="hljs-built_in">exec</span></span> net1 ip addr add YYY71/24 dev eth1 ip netns <span class="hljs-built_in"><span class="hljs-built_in">exec</span></span> net1 ip link <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> up dev eth1 ip netns <span class="hljs-built_in"><span class="hljs-built_in">exec</span></span> net1 ip route add default via YYY1 ip netns add net2 &amp;&amp; ip link <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> netns net2 dev eth2 ip netns <span class="hljs-built_in"><span class="hljs-built_in">exec</span></span> net2 ip addr add YYY72/24 dev eth2 ip netns <span class="hljs-built_in"><span class="hljs-built_in">exec</span></span> net2 ip link <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> up dev eth2 ip netns <span class="hljs-built_in"><span class="hljs-built_in">exec</span></span> net2 ip route add default via YYY1</code> </pre><br>  CISCO <br><pre> <code class="bash hljs">ip nat inside <span class="hljs-built_in"><span class="hljs-built_in">source</span></span> static YYY71 XXX71 ip nat inside <span class="hljs-built_in"><span class="hljs-built_in">source</span></span> static YYY72 XXX72</code> </pre><br></div></div><br><br>  Legacy adapter did not work at all, so we‚Äôll stop on 8 cards. <br><br>  Now the Bash script takes as input startNumber, endNumber, SIM, NS, where SIM is the name of the sim card in the array, NS is the name of the namespace in which to start the php process.  Call example: <br><pre> <code class="bash hljs">./run.sh 79671380000 79671780000 SIM1 net1 &amp;</code> </pre><br><div class="spoiler">  <b class="spoiler_title">Script itself run.sh</b> <div class="spoiler_text"><pre> <code class="bash hljs">... start=<span class="hljs-variable"><span class="hljs-variable">$1</span></span> last=<span class="hljs-variable"><span class="hljs-variable">$2</span></span> net=<span class="hljs-variable"><span class="hljs-variable">$4</span></span> startParam=<span class="hljs-string"><span class="hljs-string">"ip netns exec </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$net</span></span></span><span class="hljs-string">"</span></span> ./pushme.sh <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$3</span></span></span><span class="hljs-string"> </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$4</span></span></span><span class="hljs-string">"</span></span> <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$start</span></span></span><span class="hljs-string"> begins"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> [ <span class="hljs-variable"><span class="hljs-variable">$start</span></span> -lt <span class="hljs-variable"><span class="hljs-variable">$last</span></span> ] <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-variable"><span class="hljs-variable">$startParam</span></span> php ./getProfiles.php instance=<span class="hljs-variable"><span class="hljs-variable">$start</span></span> prefix=<span class="hljs-variable"><span class="hljs-variable">$start</span></span> count=50 sim=<span class="hljs-variable"><span class="hljs-variable">$3</span></span> net=<span class="hljs-variable"><span class="hljs-variable">$4</span></span> <span class="hljs-comment"><span class="hljs-comment">#&gt; $3.log start=$(( $start + 50 )) done ...</span></span></code> </pre><br></div></div><br></div></div><br>  We divide the capacity into pieces smaller than 2 000 numbers.  We also add push notifications via Pushover to Bash and php ("7XXXXX start", "7XXXXX finish", "Houston we have a problem") <br><br>  The last one is sent with non-standard WhatsApp server responses, or with very long (&gt; 5 seconds) non-response. <br><br>  Looking ahead, I want to say that WhatsApp is smarter than me and all these sim cards were also blocked after a while and also almost simultaneously.  In any case, the 8,000,000 phone numbers of the scripts did work successfully, and we have 411,279 photos in our hands.  Ratio of 20 to 1. Which is already quite good. <br><br><img src="https://habrastorage.org/files/e5d/d8e/915/e5dd8e915a9d42cea0edbf0026664daf.png"><br>  <i>Sampling of the results of processing in Moscow</i> <br><br><h3>  Nenets Autonomous Okrug </h3><br>  For a long time it was not possible to activate the remaining SIM cards and run scripts.  Finally, a free minute appeared, and with it the strength to admit that starting the search from Moscow (population 12,197,596 people) is smart.  Therefore, we hide our youthful maximalism more deeply and take a less populated subject, for example, the Nenets Autonomous District.  Why not.  We launch the script - and after 12 hours, the search of all tanks of the Nenetsky Okrug is completed.  For 169,995 numbers, a total of 2,208 photos were found in WhatsApp.  Go to the next step. <br><br><h4>  In contact with </h4><br>  Task: get all photos of VK users who have the city of interest. <br><br>  A considerable amount of time was spent to deal with the VK API.  And it turned out that the getuser request can be executed without problems without having an access-token.  But the search request (to take only people from a particular city) will work only with the token, and received by the user, and not by the standalone application.  This article will help us <a href="http://habrahabr.ru/sandbox/80273/">How do I get access token to interact with vk api</a> .  But even when we received this token - we stick to the restriction - you can only get 1000 users (not 1000 for one request, but 1000 in total), despite the fact that, for example, the city of Naryan-Mar (Nenets Autonomous Region) is listed at 15,660 people . <br><br>  We try to go through get_users through brute force: we iterate over all users of VKontakte from $ id = 1 to N with the following query: <br><pre> <code class="bash hljs">response=$(curl --silent <span class="hljs-string"><span class="hljs-string">"https:// api.vk.com /method/users.get?user_id=</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$id</span></span></span><span class="hljs-string">&amp;fields=photo_max_orig,country,city"</span></span>)</code> </pre><br>  On the VKontakte network at the time of this writing, there were N = 300,000,000 users.  One such request without downloading a photo took 1 second. <br><br>  300,000,000 (users) / 1 (per second) / 60 (seconds) / 60 (minutes) / 24 (hours) ~ 3472 days. <br><br>  Total about 3472 days in one stream, provided that VK will not block our IP addresses.  Option discarded. <br><br>  We return to users.search with a limit on the number of issue, but not on the "quality" of the request.  I explain.  In the request, you can infinitely specify the parameters: for example, take only women or men, reducing the issue by half, or take only those who have a photo, and what is most convenient is to take only people of a specific age, naturally in a cycle of $ age = 14 up to 80. A total of 66 runs of 1,000, with the observation that if for some ages we pass over 1000, we will repeat such requests with additional division by gender. <br><br><img src="https://habrastorage.org/files/335/16d/cbe/33516dcbe71c470696941db701c68c49.png"><br>  <i>VK user distribution by city of Naryan-Mar by age</i> <br><br><div class="spoiler">  <b class="spoiler_title">The script is a gradual download from VK</b> <div class="spoiler_text"><pre> <code class="bash hljs">01: acc_token=<span class="hljs-string"><span class="hljs-string">"abc123abc123abc123abc123abc123abc123abc123abc123"</span></span> 02: vk_url=<span class="hljs-string"><span class="hljs-string">"api.vk.com/method/users.search?has_photo=1&amp;count=1000&amp;city=2487&amp;country=1&amp;access_token=</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$acc_token</span></span></span><span class="hljs-string">&amp;fields=photo_max_orig"</span></span> 03: 04: <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> age <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> {14..80} 05: <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> 06: <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> -n <span class="hljs-variable"><span class="hljs-variable">$id</span></span> <span class="hljs-string"><span class="hljs-string">" "</span></span> &gt;&gt;vk.log 07: date +<span class="hljs-string"><span class="hljs-string">"%T"</span></span> &gt;&gt;vk.log 08: mkdir photos/<span class="hljs-variable"><span class="hljs-variable">$id</span></span> 09: list=$(curl --silent <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$vk_url</span></span></span><span class="hljs-string">&amp;age_from=</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$age</span></span></span><span class="hljs-string">&amp;age_to=</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$age</span></span></span><span class="hljs-string">"</span></span> | jq <span class="hljs-string"><span class="hljs-string">'.response | .[] | (.uid|tostring) + " " + .photo_max_orig'</span></span> | \ sed <span class="hljs-string"><span class="hljs-string">'s/^"\(.*\)"$/\1/'</span></span>) 10: counter=0 11: <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-built_in"><span class="hljs-built_in">read</span></span> -r line; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> 12: <span class="hljs-built_in"><span class="hljs-built_in">let</span></span> counter++ 13: arr=(<span class="hljs-variable"><span class="hljs-variable">$line</span></span>) 14: <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> -n <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$counter</span></span></span><span class="hljs-string">."</span></span> &gt;&gt;vk.log 15: photo=<span class="hljs-variable"><span class="hljs-variable">${arr[1]}</span></span> 16: filename=<span class="hljs-variable"><span class="hljs-variable">${arr[0]}</span></span>$(<span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-variable"><span class="hljs-variable">$photo</span></span> | sed <span class="hljs-string"><span class="hljs-string">"s/.*\(\..*\).*$/\1/"</span></span>) 17: wget <span class="hljs-variable"><span class="hljs-variable">$photo</span></span> -O photos/<span class="hljs-variable"><span class="hljs-variable">$id</span></span>/<span class="hljs-variable"><span class="hljs-variable">$filename</span></span> 18: <span class="hljs-keyword"><span class="hljs-keyword">done</span></span> &lt;&lt;&lt; <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$list</span></span></span><span class="hljs-string">"</span></span> 19:<span class="hljs-keyword"><span class="hljs-keyword">done</span></span></code> </pre><br><br>  Actually, the script, using the previously obtained (from the same IP) access_token, requests through the VK API in a cycle a list of all people of a specific age from a particular city (city = 2487). <br>  The most interesting thing here is line number 9: <br>  It turns the JSON response from VKontakte ({"response": [COUNT, {"uid": XXXXXXX, "first_name": "Ivan", "last_name": "Ivanov", "photo_max_orig": "http: \ / \ / QQQ.vk.me \ / ZZZ \ /YYY.jpg ¬ª}) to list <br>  id photo_url (XXXXX http: // QQQ.vk.me / zzz / yyy, etc.) <br>  There are lots of ways to realize this and surely there is a nicer option.  But in search of how to do this, I came across the so-called ‚Äújq is a lightweight and flexible command-line JSON processor‚Äù, the syntax of which I liked: <br>  jq '.response |  . [] |  (.uid | tostring) + "" + .photo_max_orig ' <br><br>  If read from the end, then: take the text user id (.uid | tostring) with a link to the photo .photo_max_orig for all elements of the array. [] Within the scope of the response object <br></div></div><br><br>  At 19 years old VK was suspicious of something, and began to respond very slowly to requests.  An hour and a half later 13,967 images were downloaded.  For the remaining 1,700 people, the age was apparently not indicated at all.  Another 400 downloaded images were, for some reason, broken, or very small (&lt;10 kb). <br><br><h4>  Face Recognition and Comparison </h4><br>  Among the obtained images, as we have already found out, there are a lot of cats and cars, so first we want to filter them.  OpenCV (Open Source Computer Vision Library, open source computer vision library) will help us with this. <br><br>  There are many implementations in various programming languages ‚Äã‚Äãbased on this library.  For example, facedetect, which determines the coordinates for which the person is in the photo.  She, along with ImageMagick, will cut the recognized face into coordinates in a separate file. <br><br>  On face recognition in the photo, there is an interesting implementation from the company Betaface.  They have a paid API for a large number of images, but there is a great <a href="http://betaface.com/demo.html">demo</a> that recognizes all those present in the uploaded photo and among other things determines the gender, the presence of whiskers, glasses, smiles and (women will not like it) shows the estimated age (gives me 27, a plush rabbit on the fridge - 42). <br><img src="https://habrastorage.org/files/688/040/684/68804068405c427998ef50518fc1e8f3.jpg"><br><br>  We will take ready python scripts from the English developer Terence Eden.  He wrote them in a very <a href="https://shkspr.mobi/blog/2014/06/which-painting-do-you-look-like-comparing-faces-using-python-and-opencv/">interesting project</a> .  His task was to download an open collection of paintings from the London Museum Tate Britain, and recognize images of people on it.  Then with the help of the resulting database of people and your photo you can find a picture that depicts a person as close as possible to you.  Unfortunately, the Web API does not give it, but all the sources are on github. <br><br>  Correct Terens script - turn off the download from the British Gallery and delete the processing by folders. <br><div class="spoiler">  <b class="spoiler_title">Python script</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> sys, os <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> cv2 <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> urllib <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> urlparse <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> urlparse <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">detect</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(path)</span></span></span><span class="hljs-function">:</span></span> img = cv2.imread(path) cascade = cv2.CascadeClassifier(<span class="hljs-string"><span class="hljs-string">"haarcascade_frontalface_alt.xml"</span></span>) rects = cascade.detectMultiScale(img, <span class="hljs-number"><span class="hljs-number">1.3</span></span>, <span class="hljs-number"><span class="hljs-number">4</span></span>, cv2.cv.CV_HAAR_SCALE_IMAGE, (<span class="hljs-number"><span class="hljs-number">20</span></span>,<span class="hljs-number"><span class="hljs-number">20</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> len(rects) == <span class="hljs-number"><span class="hljs-number">0</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [], img rects[:, <span class="hljs-number"><span class="hljs-number">2</span></span>:] += rects[:, :<span class="hljs-number"><span class="hljs-number">2</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> rects, img <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">box</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(rects, img, file_name)</span></span></span><span class="hljs-function">:</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-comment"><span class="hljs-comment"># Track how many faces found for x1, y1, x2, y2 in rects: print "Found " + str(i) + " face!" # Tell us what's going on cut = img[y1:y2, x1:x2] # Defines the rectangle containing a face file_name = file_name.replace('.jpg','_') # Prepare the filename file_name = file_name + str(i) + '.jpg' file_name = file_name.replace('\n','') print 'Writing ' + file_name cv2.imwrite('detected/' + str(file_name), cut) # Write the file i += 1 # Increment the face counter def main(): for filename in os.listdir('whphotos'): print filename + " " rects, img = detect("whphotos/" + filename) box(rects, img, filename) os.remove("whphotos/" + filename) if __name__ == "__main__": main()</span></span></code> </pre><br></div></div><br><br>  <b>Processing result:</b> <br>  13,500 images from VK =&gt; 6,427 / 5,446 faces.  (including / excluding cases with several persons in one photo) <br>  2,208 of WhatsApp =&gt; 963/876 individuals <br><br>  An interesting pattern is peeped out - every second user does not put a photo on the profile. <br><br>  Following recognition comes the creation of the model <i>eigenfaces.xml</i> .  The script provides for a folder of source photos to form an XML file, which will be searched in the future.  Therefore, we prepare such a file for one set, and then take one element from the second and look for a match.  The technics decided for me which of the kits to take for the main one: the script could not process 6,400 photos from VK with the error " <i>Couldn't allocate over 4GB</i> " with an error in memory.  The time is 11 nights - it's not a hunt to understand - we skip 963 photos from WhatsApp through a script and after 20 minutes we have <i>eigenfaces.xml with a</i> size of 1.6 GB.  You can imagine what size it was in the case of VK.  Later it turned out, reworking the script for myself, I accidentally deleted the identification string in the model, instead all elements had the identifier "0".  It would be ridiculous to wait a few days to run the script and only then discover it.  We correct the error and wait another 20 minutes. <br><br>  Then for each file from VK we run the check script. <br><pre> <code class="bash hljs">find detectedVK/ -name *.jpg -<span class="hljs-built_in"><span class="hljs-built_in">exec</span></span> ./myscript.sh {} \; <span class="hljs-comment"><span class="hljs-comment">#myscript.sh python recognise.py detectedWH $1 100000 &gt;&gt; result</span></span></code> </pre><br>  `100000` here - the accuracy of the match, with 100 - a perfect match. <br>  For one comparison, we have 40 seconds.  6,400 * 40 ~ 3 days on one processor.  Leave overnight;  we go to sleep tomorrow monday. <br><br>  I must say that I had thoughts that for such a small sample of coincidences there would be zero.  While the scripts were working, I periodically looked at coincidences.  With the accuracy indicated by me, there were many results, but upon closer examination, even on coincidences of the order of `3500`, there were many boy-girl results.  Moreover, the feeling was that these two were relatives.  The result is interesting, but this is not exactly what we were looking for. <br><br>  The first hit happened at the end of the first thousand accounts.  Yana's girlfriend from the city of Naryan-Mar put the same photo in both WhatsApp and VK.  Despite the fact that the photos are the same (only the resolution is different), the accuracy of the match is ~ 3,000. For all the results with an accuracy of &lt;6000, using <i>convert we</i> combine the matched images to finally make a visual decision <br><br><pre> <code class="bash hljs">... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [ <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$precise</span></span></span><span class="hljs-string">"</span></span> -lt 6000 ] <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-variable"><span class="hljs-variable">$precise</span></span> <span class="hljs-variable"><span class="hljs-variable">$whIMG</span></span> <span class="hljs-variable"><span class="hljs-variable">$vkIMG</span></span> convert detectedWH.bak/<span class="hljs-variable"><span class="hljs-variable">$whIMG</span></span> detectedVK.bak/<span class="hljs-variable"><span class="hljs-variable">$vkIMG</span></span> -append convertResults/<span class="hljs-variable"><span class="hljs-variable">${precise}</span></span>_<span class="hljs-variable"><span class="hljs-variable">$whIMG</span></span><span class="hljs-variable"><span class="hljs-variable">$vkIMG</span></span> <span class="hljs-keyword"><span class="hljs-keyword">fi</span></span> ...</code> </pre><br><br><img src="https://habrastorage.org/files/544/5fe/f1d/5445fef1dc8743809adcb7e8c242f9a1.png"><br><br>  In total, by the end of the second day, 25 VK accounts were successfully recognized and tied to the phone number. <br><br>  These are 2% of the number of faces found by WhatsApp, or 1% of all images. <br><br><img src="https://habrastorage.org/files/31b/cec/353/31bcec3534b74217a79de91bbb151065.png"><br>  <i>Analysis results for Naryan-Mar</i> <br><br>  I believe that this is an excellent result, and this is why: <br><br><ul><li>  We have small samples, with a big difference between them (16 600 VK vs. 2 000 WhatsApp); </li><li>  To search for matches, we used only the Eigenfaces algorithm, and you can add, for example, Fisherfaces; </li><li>  You can increase the chances of recognition by adding by analogy brute force through Viber; </li><li>  From VK you can take not only the last profile photo, but also several previous ones; </li><li>  Finally, Facebook, Odnoklassniki, etc. can be added to the list of social networks. </li></ul><br>  It is difficult to talk about specific numbers, but it can be said for sure that the percentage of successful hits will increase significantly if all points are observed.  Processor power for this, of course, also need to be increased several times. <br><br><h3>  Conclusion </h3><br>  What is it all about?  I have not yet thought of a practical application of the obtained data for society.  It turned out a little research for the sake of research. <br><br>  The OpenCV library is an excellent tool, using which on the data obtained, you can conduct a number of interesting experiments. <br><br>  As a reward read to the end, such, for example, is a fun option: Collect the model <i>eigenfaces.xml</i> from photographs of famous actresses, Russian and foreign, and do a search for compliance using the Muscovites' database obtained from WhatsApp (we currently have ~ 400,000).  Without taking into account the moral component (namely, the question: is it cultural to call strangers), dial the number and invite you to the cinema.  It's fun to go to the movies with a girl who, with an accuracy of 3000 to 100, looks like the main character. <br><br><img src="https://habrastorage.org/files/895/abb/2d5/895abb2d52f04cc9bbfd5daca079c0de.jpg"><br><br>  Even as a conclusion, one could say: "Do not forget to tick the privacy settings."  But I am not a big supporter of paranoid moods (‚Äú <i>They</i> know where I am,‚Äù ‚ÄúThe Internet provider knows everything about me,‚Äù ‚ÄúBig Brother is watching us,‚Äù etc.).  For example, I am amused when my wife turns off the collection of anonymous geodata on the phone, with the words that she will be ‚Äúfound‚Äù (who, and most importantly, why she has not thought of it yet). <br><br>  I don‚Äôt know if anyone will ever look for me - I didn‚Äôt seem to break anything in my life (except for the WhatsApp license agreement). </div><p>Source: <a href="https://habr.com/ru/post/262053/">https://habr.com/ru/post/262053/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../262043/index.html">Permanent loss of EC2 instance, EBS volumes and all snapshots</a></li>
<li><a href="../262045/index.html">Processing 1 million requests per minute with Go</a></li>
<li><a href="../262047/index.html">How to steal a control plane or cooking EIGRP for Juniper</a></li>
<li><a href="../262049/index.html">OpenStack - deployed "hands" Kilo</a></li>
<li><a href="../262051/index.html">Development of trainings in the grocery company</a></li>
<li><a href="../262055/index.html">The word ‚ÄúM‚Äù, or Monads, is already here.</a></li>
<li><a href="../262057/index.html">Twelve simple initial steps to developing a module for Node.js</a></li>
<li><a href="../262061/index.html">Malefactors actively use 0day vulnerability of Flash Player for cyber attacks</a></li>
<li><a href="../262063/index.html">Almost duplicate search and geometry</a></li>
<li><a href="../262065/index.html">Combining offices in 3CX (Part 2. Use Session Boarder Controller)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>