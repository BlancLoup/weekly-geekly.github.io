<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Removing a key from a token with a non-recoverable key</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Quite often, when issuing certificates for electronic signature keys, it is possible to observe intrusive PR tokens with an non-recoverable key. Vendo...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Removing a key from a token with a non-recoverable key</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/601/c18/1ef/601c181ef1184408994f73cd5a54650c.jpg"><br><br>  Quite often, when issuing certificates for electronic signature keys, it is possible to observe intrusive PR tokens with an non-recoverable key.  Vendors from certifying centers assure that by purchasing a <a href="http://www.cryptopro.ru/products/csp">CryptoPRO CSP SKPI</a> from them and a key with a non-recoverable key ( <a href="http://www.rutoken.ru/products/all/rutoken-ecp/">Rutoken EDS</a> or <a href="http://www.aladdin-rd.ru/catalog/jacarta/gost/">JaCarta GOST</a> ), we will receive certified SKZI providing 100% protection against theft of keys from the token.  But is it really?  To answer this question, we will conduct a simple experiment ... <a name="habracut"></a><br><br><h2>  Testbed Configuration </h2><br>  Let's assemble a test stand with a configuration typical for machines participating in an electronic document management (EDM): <br><ol><li>  OS MS Windows 7 SP1 </li><li>  SKZI CryptoPRO CSP 3.9.8423 </li><li>  Rutoken drivers for Windows (x86 and x64).  Version: v.4.1.0.0 of 06/20/2016, WHQL-certified </li><li>  JaCarta and JaCarta SecurLogon Single Client.  Version 2.9.0 build 1531 </li><li>  CryptoARM Standard Plus 5. Version 5.2.0.8847. </li></ol><br>  For testing, tokens with a non-tracked key will be used: <br><ol><li>  Rutoken EDS.  Version 2/19/14/00 (02) </li><li>  JaCarta GOST.  Model Number JC001-2.F09 v2.1 </li></ol><br><h2>  Testing method </h2><br>  Let's model the typical process of preparation by the Information Security Administrator of key documents for the organization of the EDM: <br><ol><li>  a private key container and a request for a public key certificate are generated; </li><li>  after passing the certification procedure in the certification authority, the certificate is obtained from the request; </li><li>  The certificate in combination with the container of the private key forms ready-to-use key information.  This key information recorded on the media will be called the <i>original key document</i> ; </li><li>  from the <i>original key document</i> , copies are made, which are written to the alienable media (hereinafter we will call them <i>working key documents</i> ) and transferred to the authorized users; </li><li>  after the production of the required number of <i>working key documents, the</i> <i>original key document is</i> destroyed or deposited with the cryptographic protection authority. </li></ol><br>  In our case, we will not use the services of certification authorities, but generate a key container with a self-signed certificate and place it in the computer registry (AWP for generating key information), this will be the <i>original key document</i> .  Then we will copy the key information on Rutoken EDS and JaCarta GOST, having produced <i>working key documents</i> .  After that, we will destroy the <i>original key document</i> , deleting the key container from the registry.  And finally, let's try to copy key information from working key documents back to the registry. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h2>  Testing </h2><br>  1. Create the <i>source key document</i> . <div class="spoiler">  <b class="spoiler_title">Description</b> <div class="spoiler_text">  To do this, using CryptoARM, create in the registry a private key container test-key-reestr, containing a self-signed certificate (CN = test) <br><img src="https://habrastorage.org/files/be7/500/5f3/be75005f386d4d22ba3b8135c1b18be6.jpg"><br><img src="https://habrastorage.org/files/5aa/637/412/5aa6374123aa4d9d8c0bf892877dace0.jpg"><br><img src="https://habrastorage.org/files/2bd/a38/1ef/2bda381ef3da48c58891c0c9ef6c73eb.jpg"><br><img src="https://habrastorage.org/files/e4b/5ac/1e1/e4b5ac1e16fb470286bf95f4f2737927.jpg"><br><img src="https://habrastorage.org/files/bcf/073/a3f/bcf073a3ffcf412d86e7a9c1a8ab293a.jpg"><br><img src="https://habrastorage.org/files/b83/f86/fa9/b83f86fa9cf14d1885ed2e1faea4aea8.jpg"><br><img src="https://habrastorage.org/files/b64/b3a/a6b/b64b3aa6b8404687b3b26e43a1f815d4.jpg"><br><img src="https://habrastorage.org/files/f87/231/2ea/f872312ea7b0487383004a9ff0cab701.jpg"><br><img src="https://habrastorage.org/files/0d2/5d2/10e/0d25d210ecd649038c8f1061d857e942.jpg"><br></div></div><br>  2. Form the <i>working key documents</i> . <br><div class="spoiler">  <b class="spoiler_title">Description</b> <div class="spoiler_text">  With the help of standard tools of CryptoPRO CSP (Start -&gt; Control Panel -&gt; CryptoPro CSP), we copy the key container test-key-reestr onto Rutoken EDS and JaCarta GOST key carriers.  Assign the key containers on the key carriers to the names test-key-rutoken and test-key-jacarta, respectively. <br>  The description is given in relation to JaCarta GOST (for Rutoken EDS, the actions are similar): <br><img src="https://habrastorage.org/files/238/2a0/fdd/2382a0fdd3f643d9b36157bafb985774.jpg"><br><img src="https://habrastorage.org/files/b93/59b/14b/b9359b14bfea43958c1804dcb2d9a4d3.jpg"><br><img src="https://habrastorage.org/files/e4c/025/6cd/e4c0256cd38545b39fc30d98b163d1e6.jpg"><br><img src="https://habrastorage.org/files/cac/e50/ed4/cace50ed4f2846a8b7062ad04d7af8b0.jpg"><br><img src="https://habrastorage.org/files/0c6/108/fac/0c6108fac3dc4d37ac62b631d8311ffe.jpg"><br>  Thus, we obtained <i>working key documents</i> on JaCarta GOST (container test-key-jacarta) and Rutoken EDS (container test-key-rutoken). </div></div><br>  3. Destroy the original key document. <br><div class="spoiler">  <b class="spoiler_title">Description</b> <div class="spoiler_text">  With the standard tools of CryptoPRO CSP, we delete the key container test-key-reestr from the registry. <br></div></div><br>  4. Copy the key information from the <i>working key documents.</i> <br><div class="spoiler">  <b class="spoiler_title">Description</b> <div class="spoiler_text">  Let's try to copy the key containers test-key-rutoken and test-key-jacarta back to the registry. <br>  The description is given for JaCarta GOST (for Rutoken EDS, the actions are similar). <br><img src="https://habrastorage.org/files/6fe/2b1/35e/6fe2b135e98d41ce883d6e9ac9e79bc6.jpg"><br><img src="https://habrastorage.org/files/8f8/2af/07b/8f82af07b85b47cfbb2e42d2cb7fc4ea.jpg"><br><img src="https://habrastorage.org/files/2e0/51f/64e/2e051f64e8944834b1186623fb9fefe7.jpg"><br><img src="https://habrastorage.org/files/136/50d/a5f/13650da5f6b44d52ba03f745fa19df94.jpg"><br><img src="https://habrastorage.org/files/2e8/788/da5/2e8788da593542fabe94c024987180c6.jpg"><br><img src="https://habrastorage.org/files/ef1/348/7b0/ef13487b0aa04058afbe7d89d9a65ef5.jpg"><br><img src="https://habrastorage.org/files/7ed/fa0/ddd/7edfa0ddde9a4e4b8b5bee594c1fbf66.jpg"><br><img src="https://habrastorage.org/files/e97/9b2/e8a/e979b2e8ad074a0bba5945f55bcf03b1.jpg"></div></div><br>  As we see, the key information was successfully copied or, in another language, extracted from tokens with an unrecoverable key.  It turns out that the manufacturers of tokens and SKZI lie?  In fact, no, and the situation is more complicated than it seems at first glance.  Investigate materiel by tokens. <br><br><h2>  Materiel </h2><br>  The fact that the market is called a token with an unrecoverable key, properly called <a href="http://www.cryptopro.ru/products/fkc/info">functional key carrier (FKN)</a> ( <a href="http://www.cryptopro.ru/blog/2014/12/04/semnye-nositeli-i-bezopasnoe-khranenie-klyuchei">additional info</a> ). <br><br>  The main difference between PCFs and ordinary tokens ( <a href="http://www.rutoken.ru/products/all/rutoken-s/">Rutoken S</a> , <a href="http://www.aladdin-rd.ru/catalog/jacarta/pki/">JaCarta PKI</a> , ...) is that when performing cryptographic transformations (for example, generating an electronic signature), the private key does not leave the device.  While using regular tokens, the private key is copied from the token to the computer's memory. <br><br>  The use of PCF requires a special organization of interaction between the applied cryptographic software and the CIPS library (cryptographic provider or, in a different way, CSP). <br><br><img src="https://habrastorage.org/files/107/28a/779/10728a77944d45ff97bf1659bf200e43.jpg"><br><br>  Here it is important to see that the software part of the SKZI library must know about the existence of an applet on the token that implements cryptographic functionality (for example, key generation, data signature, etc.) and be able to work with it. <br><br><h2>  Take a fresh look at our test bench </h2><br>  Rutoken EDS was used as one of the key carriers.  Through the "Rutoken Control Panel" you can get the following information about it: <br><br><img src="https://habrastorage.org/files/b24/832/ed9/b24832ed92c8472bb70c7c157e320f67.jpg"><br><br>  The last line contains the phrase ‚ÄúSupport for CryptoPRO FKN: No‚Äù, which means that there is no applet on the token with which the CryptoPRO CSP can work.  Thus, the implementation of PCF technology using SKZI and tokens described in the test bench configuration is impossible. <br><br>  The situation is similar with JaCarta GOST.  Moreover, the CryptoPRO CSP CPSS, at least the version used in the test bench, uses these key carriers as ‚Äúordinary tokens‚Äù, which, in turn, are just key carriers. <br><br>  This statement is very simple to confirm.  To do this, you need to put the CryptoPRO CSP SKZI on a clean machine without drivers from tokens and connect the JaCarta GOST token.  Windows 7 will detect the JaCarta GOST token as "Microsoft Usbccid Smart Card Reader (WUDF)".  Now you can try to create a key on the token and copy it to the computer‚Äôs registry.  All the functionality of SKZI will successfully work. <br><br>
<h2>  How to make everything good? </h2><br>  In order to realize the FKN technology with the help of CRIPTO-PRO LLC products: <br><br>  1. Buy a special version of the library SKZI: <br>  - for Rutoken EDS - <a href="http://www.cryptopro.ru/products/fkc/rutoken">SKZI CryptoPRO Rutoken CSP</a> . <br>  - for JaCarta GOST - <a href="http://www.cryptopro.ru/products/fkc/etoken">SKZI CryptoPro FKN CSP</a> . <br><br>  2. Simultaneously with the SKZI library, it is necessary to purchase specially prepared tokens containing software parts (applets) with which CryptoPRO Rutoken CSP or CryptoPro FCC CSP can work with, respectively. <br><br><h2>  It turns out that Rutoken EDS and JaCarta GOST are not tokens with non-recoverable keys? </h2><br>  Again, no.  These devices can implement the functional FKN (but, perhaps, in a smaller volume than when used in conjunction with CryptoPRO), but for this you need software that can work with applets placed on tokens.  Such software can be <a href="http://www.trusted.ru/products/desktop/">CryptoARM Standard 5 Plus</a> .  He <a href="http://www.trusted.ru/wp-content/uploads/comparison.pdf">knows how</a> .  When generating a key pair in the CryptoARM wizard, you can select a cryptographic provider to be used, for example, Rutoken ECP or eToken GOST.  This will allow to use the token as a PCF. <br><br><img src="https://habrastorage.org/files/d1b/1bc/d54/d1b1bcd5488c4839a5be5965c4ad9d8e.jpg"><br><br><h4>  findings </h4><br><ul><li>  Do not believe the sellers, nonsense to you the city.  The use of conventional versions of the crypto-provider <a href="http://www.cryptopro.ru/products/csp">CryptoPRO CSP</a> and the usual Rutoken EDS or JaCarta STOS do not allow the implementation of PCF technology. </li><li>  To use the PCF technology in conjunction with the products of CRIPTO-PRO LLC, both specially prepared tokens containing an applet with which the CPSM is able to work, and <a href="http://www.cryptopro.ru/products/fkc">special versions of the crypto-provider CryptoPRO CSP</a> that can work with the applet on tokens are necessary. </li><li>  Rutoken EDS and JaCarta GOST are able to independently implement the FKN technology, but this requires special software. </li></ul></div><p>Source: <a href="https://habr.com/ru/post/306034/">https://habr.com/ru/post/306034/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../306024/index.html">Self-employment is not freedom. The myth of the happy life of an entrepreneur</a></li>
<li><a href="../306026/index.html">Connect the HP tape library via Fiber Channel to an ESXi 5.5 host</a></li>
<li><a href="../306028/index.html">CLion 2016.2 release: remote debugging, Doxygen format support, new code generation features and much more</a></li>
<li><a href="../306030/index.html">Software update and initial setup instructions for Nokia 7210 SAS-M</a></li>
<li><a href="../306032/index.html">Introduction to Veeam Agent for Linux</a></li>
<li><a href="../306036/index.html">How to make the next bot in Telegram</a></li>
<li><a href="../306038/index.html">Webinar: Meet Asterisk</a></li>
<li><a href="../306040/index.html">Hiring technicians sank by 40% - and no one talks about it</a></li>
<li><a href="../306044/index.html">Why doesn't Wi-Fi based positioning take off</a></li>
<li><a href="../306046/index.html">Interview with mom, bank programmer on COBOL</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>