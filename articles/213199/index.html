<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>A little note on how to make friends with Heroku, Kraken.js and Sockjs</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Some time ago, in search of new tools for the implementation of the next ‚Äúhome‚Äù project, I came across Kraken.js - an Open Source project from PayPal....">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>A little note on how to make friends with Heroku, Kraken.js and Sockjs</h1><div class="post__text post__text-html js-mediator-article">  Some time ago, in search of new tools for the implementation of the next ‚Äúhome‚Äù project, I came across <a href="http://krakenjs.com/">Kraken.js</a> - an Open Source project from PayPal.  Kraken.js is a regular Node.js framework based on express.  Searching on Habr√©, I did not find, absolutely, nothing.  I met only one mention as a link to the main site <a href="http://habrahabr.ru/post/204130/">here</a> . <br><br>  What did he attract me with, and how does he differ from the famous <a href="http://derbyjs.com/">Derby.js</a> , <a href="https://www.meteor.com/">Meteor.js</a> , <a href="http://sailsjs.org/">Sails.js</a> , and others? <br><br>  And I liked it primarily because it does not impose on the developer very severe restrictions (primarily on data sources, package managers, ...), and at the same time introduces some structuredness in the code, offering to follow the MVC model.  I don‚Äôt want to dwell on all its buns and features here, since all is well written on the project‚Äôs website, but I‚Äôll go straight to ‚Äúmy sheep‚Äù. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      So, the task is to upload the Kraken.js application to the Heroku service, make it work there, and, for sweetness, screw the Sockjs. <br><a name="habracut"></a><br>  I will make a reservation that I performed all the actions described below on Ubuntu 13.10, but I think that for other OS there should not be any strong differences.  To start, go to <a href="https://id.heroku.com/signup/devcenter">heroku.com</a> , register and download the <a href="https://toolbelt.heroku.com/">Heroku Toolbelt</a> - a console client for working with Heroku.  Enter in the command line: <br><pre><code class="bash hljs">$ heroku login</code> </pre> <br>  Now we are ready to deploy applications on Heroku.  The next step is to install Kraken.js, to do this: <br><pre> <code class="bash hljs">$ sudo npm install -g generator-kraken</code> </pre><br>  Then we go to the directory with the projects and type the command <code>$ yo kraken</code> and interactively answer the questions of the generator: <br><pre>      , "" "`.
     / _ _ \
     | (@) (@) |  Release the Kraken!
     ) __ (
    /, ')) ((`. \
   (((())))
    `\`) ('/'

 [?] Application name: Kraken-Sockets
 [?] Description: A test kraken application with socks.js
 [?] Author: &lt;your name&gt;
 [?] Use RequireJS?  (Y / n) n
</pre><br>  The generator created the directory of the same name to the application and the basic structure of the Kraken.js application.  Consider the structure in more detail: <br><pre> <code class="bash hljs">/config        json /controllers      /lib        /locales   /models  /public Web-,  /public/templates    /tests   - index.js     ()</code> </pre><br>  We type the <code>npm start</code> command and at localhost: 8000 we can admire a working Kraken.js application.  Well, now it's time to pour it on Heroku.  But first you need to bring the application into compliance with the <a href="https://devcenter.heroku.com/articles/getting-started-with-nodejs">requirements</a> .  We already have the <code>package.json</code> file, now we need to create a <code>Procfile</code> file with the following content: <br><pre> <code class="bash hljs">web: node index.js</code> </pre><br>  This file is a guide for Heroku how to run our application.  In addition to these files, Heroku requires the application to listen to the port specified in the <code>PORT</code> environment variable.  We cannot do this through json-configs.  Especially for these cases, Kraken.js provides a software configuration mechanism.  The method responsible for the software configuration is in the <code>index.js</code> file.  We must give it the following form: <br><pre> <code class="javascript hljs">app.configure = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">configure</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">nconf, next</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// Async method run on startup. nconf.set('port', Number(process.env.PORT || 5000)); next(null); };</span></span></code> </pre><br>  And now let's create a project git repository: <br><pre> <code class="bash hljs">$ git init $ git add . $ git commit -m <span class="hljs-string"><span class="hljs-string">"init"</span></span></code> </pre><br>  And execute: <br><pre> <code class="bash hljs">$ heroku create kraken-test-socksjs</code> </pre><br>  Heroku will create us an application available at <a href="http://kraken-test-socksjs.herokuapp.com/">kraken-test-socksjs.herokuapp.com</a> and immediately connect us to a remote repository, push which installs the application on the server. <br>  We try: <br><pre> <code class="bash hljs">$ git push heroku master</code> </pre><br>  We go on <a href="http://kraken-test-socksjs.herokuapp.com/">kraken-test-socksjs.herokuapp.com</a> and make sure that everything works.  But we are not in a hurry to rejoice;  The very first commit (for example, add something to the template of the main page) breaks the entire application.  Then it took me many hours to view the logs ( <code>$ heroku logs</code> ) and google.  And everything turned out to be very simple.  Heroku, for some reason, loses some dependencies of the second level (dependencies of dependencies of the application - it sounds horrible, I will give an example: in our case it loses the <code>formidable</code> module, on which the <code>kraken-js</code> module depends).  And he also doesn‚Äôt perform grunt tasks for resource preparation (compiling less, templates, etc.). <br><br>  To eliminate these problems, do the following: in the <code>package.json</code> file, we transfer all <code>devDependencies</code> to <code>dependencies</code> and add the <code>"grunt-cli": "~0.1.13"</code> module to <code>dependencies</code> <code>"grunt-cli": "~0.1.13"</code> .  This will allow us to call grunt manually during the application deployment.  After all changes, the <code>package.json</code> file should look like this: <br><pre> <code class="javascript hljs">{ <span class="hljs-string"><span class="hljs-string">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"kraken-sockets"</span></span>, <span class="hljs-string"><span class="hljs-string">"version"</span></span>: <span class="hljs-string"><span class="hljs-string">"0.1.0"</span></span>, <span class="hljs-string"><span class="hljs-string">"description"</span></span>: <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-string"><span class="hljs-string">"author"</span></span>: <span class="hljs-string"><span class="hljs-string">"Your Name"</span></span>, <span class="hljs-string"><span class="hljs-string">"main"</span></span>: <span class="hljs-string"><span class="hljs-string">"index.js"</span></span>, <span class="hljs-string"><span class="hljs-string">"scripts"</span></span>: { <span class="hljs-string"><span class="hljs-string">"test"</span></span>: <span class="hljs-string"><span class="hljs-string">"grunt test"</span></span>, <span class="hljs-string"><span class="hljs-string">"start"</span></span>: <span class="hljs-string"><span class="hljs-string">"node index.js"</span></span>, <span class="hljs-string"><span class="hljs-string">"postinstall"</span></span>: <span class="hljs-string"><span class="hljs-string">"./node_modules/grunt-cli/bin/grunt build --force"</span></span> }, <span class="hljs-string"><span class="hljs-string">"engines"</span></span>: { <span class="hljs-string"><span class="hljs-string">"node"</span></span>: <span class="hljs-string"><span class="hljs-string">"&gt;=0.10.0"</span></span> }, <span class="hljs-string"><span class="hljs-string">"dependencies"</span></span>: { <span class="hljs-string"><span class="hljs-string">"kraken-js"</span></span>: <span class="hljs-string"><span class="hljs-string">"~0.7.0"</span></span>, <span class="hljs-string"><span class="hljs-string">"express"</span></span>: <span class="hljs-string"><span class="hljs-string">"~3.4.4"</span></span>, <span class="hljs-string"><span class="hljs-string">"adaro"</span></span>: <span class="hljs-string"><span class="hljs-string">"~0.1.x"</span></span>, <span class="hljs-string"><span class="hljs-string">"nconf"</span></span>: <span class="hljs-string"><span class="hljs-string">"~0.6.8"</span></span>, <span class="hljs-string"><span class="hljs-string">"less"</span></span>: <span class="hljs-string"><span class="hljs-string">"~1.6.1"</span></span>, <span class="hljs-string"><span class="hljs-string">"dustjs-linkedin"</span></span>: <span class="hljs-string"><span class="hljs-string">"~2.0.3"</span></span>, <span class="hljs-string"><span class="hljs-string">"dustjs-helpers"</span></span>: <span class="hljs-string"><span class="hljs-string">"~1.1.1"</span></span>, <span class="hljs-string"><span class="hljs-string">"makara"</span></span>: <span class="hljs-string"><span class="hljs-string">"~0.3.0"</span></span>, <span class="hljs-string"><span class="hljs-string">"mocha"</span></span>: <span class="hljs-string"><span class="hljs-string">"~1.17.0"</span></span>, <span class="hljs-string"><span class="hljs-string">"supertest"</span></span>: <span class="hljs-string"><span class="hljs-string">"~0.8.2"</span></span>, <span class="hljs-string"><span class="hljs-string">"grunt"</span></span>: <span class="hljs-string"><span class="hljs-string">"~0.4.1"</span></span>, <span class="hljs-string"><span class="hljs-string">"grunt-cli"</span></span>: <span class="hljs-string"><span class="hljs-string">"~0.1.13"</span></span>, <span class="hljs-string"><span class="hljs-string">"grunt-contrib-less"</span></span>: <span class="hljs-string"><span class="hljs-string">"~0.9.0"</span></span>, <span class="hljs-string"><span class="hljs-string">"grunt-dustjs"</span></span>: <span class="hljs-string"><span class="hljs-string">"~1.2.0"</span></span>, <span class="hljs-string"><span class="hljs-string">"grunt-contrib-clean"</span></span>: <span class="hljs-string"><span class="hljs-string">"~0.5.0"</span></span>, <span class="hljs-string"><span class="hljs-string">"grunt-contrib-jshint"</span></span>: <span class="hljs-string"><span class="hljs-string">"~0.6.4"</span></span>, <span class="hljs-string"><span class="hljs-string">"grunt-mocha-cli"</span></span>: <span class="hljs-string"><span class="hljs-string">"~1.5.0"</span></span>, <span class="hljs-string"><span class="hljs-string">"grunt-copy-to"</span></span>: <span class="hljs-string"><span class="hljs-string">"0.0.10"</span></span> }, <span class="hljs-string"><span class="hljs-string">"devDependencies"</span></span>: { } }</code> </pre><br>  Pay attention to the <code>"postinstall"</code> script, which is just preparing application resources.  We coped with the problem of resources, and what to do with the missing modules?  This is apparently a bug of the new module caching system Heroku.  I'll write a ticket to them the other day, but for now I cope with the help of the <a href="https://github.com/heroku/heroku-repo">heroku-repo</a> plugin.  Just before each ‚Äúpush‚Äù release, I clean the modules cache with the command: <br><pre> <code class="bash hljs">$ heroku repo:purge_cache -a kraken-test-socksjs</code> </pre><br>  Wow, with the friendship of Heroku and Kraken.js managed, now the most pleasant thing: let's tie Sockjs to the <a href="https://github.com/sockjs/sockjs-node">Kraken</a> . <br><br>  Sockjs is distributed as an npm-module and is perfectly screwed to the express-application, but in order to fasten it you need access to the server (the one represented by the http module, on which express.js is hung).  So in Kraken.js it is well hidden from the developer.  But, rummaging through the source code of the Kraken, I found how to get it out.  I will cite immediately the ready code, which should be inserted into index.js in the place of this site: <br><pre> <code class="javascript hljs">kraken.create(app).listen(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">err</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (err) { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.error(err.stack); } });</code> </pre><br>  Here he is: <br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> k = kraken.create(app); k.listen(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">err</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (err) { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.error(err.stack); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> http = k.app.get(<span class="hljs-string"><span class="hljs-string">'kraken:server'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> sockjs_opts = {<span class="hljs-attr"><span class="hljs-attr">sockjs_url</span></span>: <span class="hljs-string"><span class="hljs-string">'http://cdn.sockjs.org/sockjs-0.3.min.js'</span></span>}; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> sockjs_echo = sockjs.createServer(sockjs_opts); sockjs_echo.on(<span class="hljs-string"><span class="hljs-string">'connection'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">conn</span></span></span><span class="hljs-function">) </span></span>{ hub.sockjs_pool.push(conn); conn.on(<span class="hljs-string"><span class="hljs-string">'data'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">message</span></span></span><span class="hljs-function">) </span></span>{ hub.sockjs_pool.forEach(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">con</span></span></span><span class="hljs-function">) </span></span>{ con.write(message); }); }); }); sockjs_echo.installHandlers(http, {<span class="hljs-attr"><span class="hljs-attr">prefix</span></span>:<span class="hljs-string"><span class="hljs-string">'/echo'</span></span>}); } });</code> </pre><br>  At this point I am rounding out.  All project code can be viewed on <a href="https://github.com/rodenis/kraken-sockjs">github</a> .  Play with the deployed application <a href="http://kraken-test-socksjs.herokuapp.com/">here</a> . <br><br>  I really hope that this article will help someone save time when debugging Kraken.js applications on Heroku and screwing all sorts of goodies to them. <br>  PS This is my first article, so constructive criticism is very welcome. </div><p>Source: <a href="https://habr.com/ru/post/213199/">https://habr.com/ru/post/213199/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../213187/index.html">How to delete 1,500,000 entries from Yahoo database</a></li>
<li><a href="../213191/index.html">Investigating the obfuscation of the Linksys WRT120N firmware</a></li>
<li><a href="../213193/index.html">Very simple screen slider</a></li>
<li><a href="../213195/index.html">Fitbit for the brain: a cognitive activity tracker</a></li>
<li><a href="../213197/index.html">BigRep One: A New 3D Printer That Can Print Entire Furniture</a></li>
<li><a href="../213201/index.html">Another money transfer protection</a></li>
<li><a href="../213205/index.html">Filling the stack in fprintf on Linksys WRT120N</a></li>
<li><a href="../213209/index.html">Control Information, or Three Fun Letters - DLP</a></li>
<li><a href="../213213/index.html">Synchronize a web page with Google Docs</a></li>
<li><a href="../213215/index.html">Warm tube sound</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>