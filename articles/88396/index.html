<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Use SQLCLR to improve performance</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Starting with MS SQL Server 2005, very powerful SQL CLR technology has been added to database developers. 

 This technology allows you to extend the ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Use SQLCLR to improve performance</h1><div class="post__text post__text-html js-mediator-article">  Starting with MS SQL Server 2005, very powerful <a href="http://en.wikipedia.org/wiki/SQL_CLR">SQL CLR</a> technology has been added to database developers. <br><br>  This technology allows you to extend the functionality of SQL Server using .NET languages, such as C # or VB.NET. <br><br>  Using SQL CLR, you can create your own stored procedures, triggers, custom types and functions, as well as aggregates, written in high-performance languages.  This allows you to seriously improve performance and extend the functionality of the server to unimaginable boundaries. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Consider a simple example: we will write a custom function for cutting a string through a separator using SQL syntax and SQL CLR based on C # and compare the results. <br><a name="habracut"></a><br><h3>  User function returning a table </h3><br><blockquote><code><font color="black"><font color="#0000ff">CREATE</font> <font color="#0000ff">FUNCTION</font> SplitString (@text NVARCHAR( <font color="#0000ff">max</font> ), @delimiter <font color="#0000ff">nchar</font> (1)) <br> <font color="#0000ff">RETURNS</font> @Tbl <font color="#0000ff">TABLE</font> (part nvarchar( <font color="#0000ff">max</font> ), ID_ORDER <font color="#0000ff">integer</font> ) <font color="#0000ff">AS</font> <br> <font color="#0000ff">BEGIN</font> <br> <font color="#0000ff">declare</font> @ <font color="#0000ff">index</font> <font color="#0000ff">integer</font> <br> <font color="#0000ff">declare</font> @part  nvarchar( <font color="#0000ff">max</font> ) <br> <font color="#0000ff">declare</font> @i <font color="#0000ff">integer</font> <br> <font color="#0000ff">set</font> @ <font color="#0000ff">index</font> = -1 <br> <font color="#0000ff">set</font> @i=1 <br> <font color="#0000ff">while</font> (LEN(@text) &gt; 0) <font color="#0000ff">begin</font> <br> <font color="#0000ff">set</font> @ <font color="#0000ff">index</font> = CHARINDEX(@delimiter, @text) <br> <font color="#0000ff">if</font> (@ <font color="#0000ff">index</font> = 0) <font color="#0000ff">AND</font> (LEN(@text) &gt; 0) <font color="#0000ff">BEGIN</font> <br> <font color="#0000ff">set</font> @part = @text <br> <font color="#0000ff">set</font> @text = <font color="#A31515">''</font> <br> <font color="#0000ff">end</font> <font color="#0000ff">else</font> <font color="#0000ff">if</font> (@ <font color="#0000ff">index</font> &gt; 1) <font color="#0000ff">begin</font> <br> <font color="#0000ff">set</font> @part = <font color="#0000ff">LEFT</font> (@text, @ <font color="#0000ff">index</font> - 1) <br> <font color="#0000ff">set</font> @text = <font color="#0000ff">RIGHT</font> (@text, (LEN(@text) - @ <font color="#0000ff">index</font> )) <br> <font color="#0000ff">end</font> <font color="#0000ff">else</font> <font color="#0000ff">begin</font> <br> <font color="#0000ff">set</font> @text = <font color="#0000ff">RIGHT</font> (@text, (LEN(@text) - @ <font color="#0000ff">index</font> )) <br> <font color="#0000ff">end</font> <br> <font color="#0000ff">insert</font> <font color="#0000ff">into</font> @Tbl(part, ID_ORDER) <font color="#0000ff">values</font> (@part, @i) <br> <font color="#0000ff">set</font> @i=@i+1 <br> <font color="#0000ff">end</font> <br> <font color="#0000ff">RETURN</font> <br> <font color="#0000ff">END</font> <br> <font color="#0000ff">go</font></font> <br></code> </blockquote><br>  This function cuts the input string using a delimiter and returns a table.  It is very convenient to use such a function, for example, to quickly fill a temporary table with records. <br><blockquote> <code><font color="black"><font color="#0000ff">select</font> part <font color="#0000ff">into</font> #tmpIDs <font color="#0000ff">from</font> SplitString( <font color="#A31515">'11,22,33,44'</font> , <font color="#A31515">','</font> )</font></code> </blockquote> <br>  As a result, the #tmpIDs table will contain <br><blockquote> <code><font color="black">11 <br> 22 <br> 33 <br> 44</font></code> </blockquote> <br><h3>  CLR Module written in C # </h3><br>  Create a SplitString.cs file with the following contents: <br><blockquote> <code><font color="black"><font color="#0000ff">using</font> System; <br> <font color="#0000ff">using</font> System.Collections; <br> <font color="#0000ff">using</font> System.Collections. <font color="#2B91AF">Generic</font> ; <br> <font color="#0000ff">using</font> System.Data.SqlTypes; <br> <font color="#0000ff">using</font> Microsoft.SqlServer.Server; <br> <br> <font color="#0000ff">public</font> <font color="#0000ff">class</font> UserDefinedFunctions { <br> [SqlFunction(FillRowMethodName = <font color="#A31515">"SplitStringFillRow"</font> , TableDefinition = <font color="#A31515">"part NVARCHAR(MAX), ID_ORDER INT"</font> )] <br> <br> <font color="#0000ff">static</font> <font color="#0000ff">public</font> IEnumerator SplitString(SqlString text, <font color="#0000ff">char</font> [] delimiter) <br> { <br> <font color="#0000ff">if</font> (text.IsNull) <font color="#0000ff">yield</font> <font color="#0000ff">break</font> ; <br> <br> <font color="#0000ff">int</font> valueIndex = 1; <br> <font color="#0000ff">foreach</font> ( <font color="#0000ff">string</font> s <font color="#0000ff">in</font> text.Value.Split(delimiter, StringSplitOptions.RemoveEmptyEntries)) { <br> <font color="#0000ff">yield</font> <font color="#0000ff">return</font> <font color="#0000ff">new</font> KeyValuePair&lt; <font color="#0000ff">int</font> , <font color="#0000ff">string</font> &gt;(valueIndex++, s.Trim()); <br> } <br> } <br> <br> <font color="#0000ff">static</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> SplitStringFillRow( <font color="#0000ff">object</font> oKeyValuePair, <font color="#0000ff">out</font> SqlString <font color="#0000ff">value</font> , <font color="#0000ff">out</font> SqlInt32 valueIndex) <br> { <br> KeyValuePair&lt; <font color="#0000ff">int</font> , <font color="#0000ff">string</font> &gt; keyValuePair = (KeyValuePair&lt; <font color="#0000ff">int</font> , <font color="#0000ff">string</font> &gt;) oKeyValuePair; <br> <br> valueIndex = keyValuePair.Key; <br> <font color="#0000ff">value</font> = keyValuePair.Value; <br> } <br> } <br></font></code> </blockquote><br>  Compile the module: <br><blockquote> <code><font color="black">%SYSTEMROOT%\Microsoft.NET\Framework\v2.0.50727\csc.exe /target:library c:\SplitString.cs</font></code> </blockquote> <br>  At the output we get SplitString.dll <br><br>  Now, you need to enable CLR usage in SQL Server. <br><blockquote> <code><font color="black">sp_configure <font color="#A31515">'clr enabled'</font> , 1 <br> <font color="#0000ff">go</font> <br> <font color="#0000ff">reconfigure</font> <br> go</font></code> </blockquote> <br>  Everything, it is possible to connect the module. <br><br><blockquote> <code><font color="black"><font color="#0000ff">CREATE</font> ASSEMBLY CLRFunctions <font color="#0000ff">FROM</font> <font color="#A31515">'C:\SplitString.dll'</font> <br> go</font></code> </blockquote> <br>  And create a custom function. <br><blockquote> <code><font color="black"><font color="#0000ff">CREATE</font> <font color="#0000ff">FUNCTION</font> [dbo].SplitStringCLR(@text [nvarchar]( <font color="#0000ff">max</font> ), @delimiter [ <font color="#0000ff">nchar</font> ](1)) <br> <font color="#0000ff">RETURNS</font> <font color="#0000ff">TABLE</font> ( <br> part nvarchar( <font color="#0000ff">max</font> ), <br> ID_ODER <font color="#0000ff">int</font> <br> ) <font color="#0000ff">WITH</font> <font color="#0000ff">EXECUTE</font> <font color="#0000ff">AS</font> CALLER <br> <font color="#0000ff">AS</font> <br> <font color="#0000ff">EXTERNAL</font> NAME CLRFunctions.UserDefinedFunctions.SplitString</font> <br></code> </blockquote><br><h3>  More about CLR </h3><br>  1. The build is uploaded to the server and stored there.  Functions that reference the assembly are already stored in the database.  Therefore, it is necessary that the assembly be loaded on the server where the base is being transferred. <br><br>  2. When creating an assembly, if necessary, the PERMISSION_SET argument is specified, which defines the permissions for the assembly.  I advise you to look at <a href="http://msdn.microsoft.com/ru-ru/library/ms189524.aspx">MSDN</a> .  Briefly: SAFE - allows to work only with the base;  EXTERNAL_ACCESS - allows to work with other servers, file system and network resources;  UNSAFE - anything, including WinAPI. <br><br>  3. There are features when debugging, which ones are specified in <a href="http://msdn.microsoft.com/ru-ru/library/ms165050(en-us,VS.80).aspx">MSDN</a> . <br><br><h3>  results </h3><br>  To compare the speed of the usual <i>SplitString</i> and <i>SplitStringCLR,</i> I called these functions 1000 times with an input string consisting of 100 comma-separated numbers. <br><br>  The average working time for <i>SplitString</i> was <b>6.152</b> ms, and for <i>SplitStringCLR</i> <b>1.936</b> ms. <br><br>  The difference is more than 3 times. <br><br>  I hope it will be useful to someone. </div><p>Source: <a href="https://habr.com/ru/post/88396/">https://habr.com/ru/post/88396/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../88386/index.html">twitter2vk - from Twitter to VKontakte</a></li>
<li><a href="../88389/index.html">elFinder - file manager for the site. New taste</a></li>
<li><a href="../88392/index.html">Wow Mobile and other news from U'tel</a></li>
<li><a href="../88393/index.html">Design pattern "Fitter" / "Flyweight"</a></li>
<li><a href="../88394/index.html">LINQ to SQL and concurrent access conflicts</a></li>
<li><a href="../88398/index.html">Is placing SSH on a port other than 22 justified?</a></li>
<li><a href="../88399/index.html">Soyuz-Telecom mobile WiMAX will appear in forty-two settlements of the Moscow region. (Terms not yet named.)</a></li>
<li><a href="../88403/index.html">The epic of personal data continues</a></li>
<li><a href="../88404/index.html">Startup: compilation of tourist routes</a></li>
<li><a href="../88405/index.html">Installing and configuring rTorrent in Debian</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>