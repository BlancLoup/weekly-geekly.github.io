<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Calling Windows functions in kernel mode</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Many of you, dear habrovchane, use the functions of the Windows kernel. However, not everyone is aware of how these functions are called. And knowledg...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Calling Windows functions in kernel mode</h1><div class="post__text post__text-html js-mediator-article">  Many of you, dear habrovchane, use the functions of the Windows kernel.  However, not everyone is aware of how these functions are called.  And knowledge of some of the mechanisms of the kernel can be very useful. <br><br>  <sup><i>This text is not intended for drivers who (in theory) know this even at a deeper level.</i></sup> <br><a name="habracut"></a><br>  We begin with the fact that in kernel mode there are much more functions than in the well-known WinAPI.  This is due to the fact that the core contains a lot of undocumented functions (although the situation has improved with the release of Win7 and Win8, many such functions fall on MSDN).  A list of such functions can be found, for example, <a href="http://undocumented.ntinternals.net/">here.</a> <br><br>  These functions can be divided into several groups: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ul><li>  <b>Kernel API</b> - functions are in ntoskrnl.exe (in fact, the usual dll), the main functions of the kernel. </li><li>  <b>Windowing API</b> - functions are in gdi32.dll, functions for working with windows and graphics. </li><li>  <b>Messaging API</b> - functions are in user32.dll, message handling functions. </li></ul><br>  How is all this caused? <br><br>  <i>Let's start with a call from user mode.</i> <br><br>  ‚ÄúFirst of all, we will turn to <b>NtDll.dll</b> , the‚Äú interlayer ‚Äùbetween the user mode and the kernel mode.  It contains the kernel function we need.  This function places its number in the <b>EAX</b> register.  It is an index in two tables known to the kernel: ServiceTable and ArgumentTable.  Characteristically, this number is specific to each OS version.  Often it changes not just when moving from, say, WinXP to Vista, but even when moving from Vista to Vista SP1. <br>  ‚ÄúNext, the <b>EDX</b> address of the top of the parameter stack is placed; in most cases, this is the value of the <b>ESP</b> register.  It would seem, why copy the existing value?  The fact is that after performing an interrupt, all the processor state will be reset to the stack, and ESP will no longer be what we need. <br>  - Finally, switching to kernel mode.  On older processors and systems, this is done using the 0x2e interrupt; on modern ones, there is a special processor instruction for this: <b>SysEnter</b> for Intel, <b>SysCall</b> for AMD. <br>  - The result of the call is the execution by the processor of a code whose address is in the global interrupt table in a specific cell.  This code calls either <b>KiSystemService (),</b> in the case of an interrupt, or <b>KiFastCallEntry (),</b> in the case of a special instruction to the processor.  By the way, the second one is registered in the MSR register, which provides quick access to it. <br>  - Further, the code that runs in the kernel is executed a little differently, depending on where the function call came from, from kernel mode or from user mode.  The task of the kernel code: on the internal table of functions to perform a function call from EAX.  This table is called <b>KiServiceDescriptorTable</b> .  This is a structure with three fields: <br><br><ul><li>  Address to the table ServiceTable (nt! KiServiceTable) - an array of functions </li><li>  Address on ArgumentTable (nt! KiArgumentTable) - the number of bytes that the parameters occupy </li><li>  number of elements in these tables </li></ul><br><br>  When the SysEnter and SysCall functions are called, they need to be dispatched to the OS functions.  Each thread has a stack of user mode and kernel mode.  The OS takes a cell value in the ArgumentTable table, which shows how many bytes the parameters occupy on the stack (for this we memorized EDX).  Then it copies this number of bytes onto the kernel stack.  And after that performs a function call via the ServiceTable.  All this confusion with two stacks is needed, of course, to ensure that no changes in user mode will harm the function in the kernel. <br><br>  - After the function is called and executed, and its work is completed, the return from kernel mode is done with the help of <b>iret</b> or <b>SysExit / SysRet.</b> <br><br>  <i>Calling kernel functions in kernel mode.</i> <br><br>  In principle, we have all the same, but ... <br>  If you carefully review the list of kernel functions, you can see that there are functions that are completely analogous to the <b>nt</b> functions, but with the prefix <b>zw-</b> .  All of them are uniquely mapped to nt functions.  However, they work differently in kernel mode. <br><br>  The difference is that in the zw- functions, the parameters are not validated.  In other words, when calling from user mode, the system carefully monitors the parameters passed to the function - God forbid the programmer will miss something, and hello, blue screen.  In kernel mode, they mostly work with drivers, and there the system already assumes that you check all the parameters yourself and guarantee their validity, because additional checks will eat up valuable time.  It works like this: if zw is called, it loads the number of the function in EAX, puts the pointer to the kernel stack in EDX, and then calls the nt option, which does not validate. <br><br>  In this connection, the question arises - what if I vyhovu zw-function from user mode?  System forgive everything?  Not really.  If zw is called in usermode, then it will simply call its nt-twin. <br><br>  <sub><i>Here, in general, and all the basic information about calls to kernel functions.</i></sub>  <sub><i>I hope you were interested.</i></sub> </div><p>Source: <a href="https://habr.com/ru/post/160569/">https://habr.com/ru/post/160569/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../160551/index.html">Sony Xperia V will appear in Russia in December</a></li>
<li><a href="../160553/index.html">Linux to server with Windows Server, or Vbox \ VmWare as a service</a></li>
<li><a href="../160555/index.html">Short and clear: Flex VPN</a></li>
<li><a href="../160557/index.html">Presentation of the FRUCT Team</a></li>
<li><a href="../160567/index.html">Simple Business Seminar at Sberbank: how to cut costs and attract new customers</a></li>
<li><a href="../160571/index.html">Runetology (175): Sergey Rumyantsev, general director of Enter.ru</a></li>
<li><a href="../160573/index.html">Opera, together with TIM Brazil, presented a new mobile application store</a></li>
<li><a href="../160575/index.html">Curiosity found organics on Mars</a></li>
<li><a href="../160577/index.html">LinguaLeo extension for Opera and Internet Explorer: translate words in one click and improve your English!</a></li>
<li><a href="../160579/index.html">Centralized package update system in Ubuntu</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>