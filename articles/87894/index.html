<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>I'll cut you into tiles. Part one</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Despite all my attempts to correct the situation with the technology of loading data onto a map, people all continue and continue to work the old-fash...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>I'll cut you into tiles. Part one</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/geektimes/post_images/9cf/142/6a4/9cf1426a4a25e65b42267c22185ee447.jpg" alt="image" align="left">  Despite all <a href="http://habrahabr.ru/blogs/google/38408/">my attempts</a> to correct the situation with the technology of loading data onto a map, people all continue and continue to work the old-fashioned way, either downloading all the viewport data at the slightest movement of the map, or simply downloading all the data in general. <br>  As long as the directional meters rasterizes markers into pictures, build super systems of groupings and clusterings and tremble over every extra kilobyte in the scripts, let me tell you the easiest, stable, and most common way to make your life, your users, your cards and your server a little more beautiful. <br>  As will be said later, the conquest of cards consists of 5 steps. <br>  The first one is loading a map (not everything is as simple as it seems), but the second one is downloading data to these same maps. <br>  He is interesting to us. <br><a name="habracut"></a><br>  Currently, there are two common approaches to loading this marker onto a map. <br>  1. We load all data through ajax, or immediately their javascript <br>  2. We pull the server for ‚Äúwhat are the objects in our current viewport?‚Äù <br>  The first option has the right to life, especially if there are few markers, and the markermanager helps here (to hide the invisible ones), but the second one let's forget as a bad dream. <br><br><h4>  So, we will consider </h4>  that we have a function for loading coordinate box data <br><blockquote><code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">$.get( <font color="#A31515">"ajax/load-map-data?SE="</font> +MySECorner.toString()+ <font color="#A31515">"&amp;NE="</font> +MyNECorner.toString()+ <font color="#A31515">"&amp;zoom="</font> +currentZoom, <font color="#0000ff">function</font> (data){ <font color="#008000">//wow! i got the data for map!</font> <font color="#008000">//for whole visible viewport( and just for it)</font> });</font> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> <ol><li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> $.get( <font color="#A31515">"ajax/load-map-data?SE="</font> +MySECorner.toString()+ <font color="#A31515">"&amp;NE="</font> +MyNECorner.toString()+ <font color="#A31515">"&amp;zoom="</font> +currentZoom, <font color="#0000ff">function</font> (data){ <font color="#008000">//wow! i got the data for map!</font> <font color="#008000">//for whole visible viewport( and just for it)</font> }); <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> $.get( <font color="#A31515">"ajax/load-map-data?SE="</font> +MySECorner.toString()+ <font color="#A31515">"&amp;NE="</font> +MyNECorner.toString()+ <font color="#A31515">"&amp;zoom="</font> +currentZoom, <font color="#0000ff">function</font> (data){ <font color="#008000">//wow! i got the data for map!</font> <font color="#008000">//for whole visible viewport( and just for it)</font> }); <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><font color="#008000"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> $.get( <font color="#A31515">"ajax/load-map-data?SE="</font> +MySECorner.toString()+ <font color="#A31515">"&amp;NE="</font> +MyNECorner.toString()+ <font color="#A31515">"&amp;zoom="</font> +currentZoom, <font color="#0000ff">function</font> (data){ //wow! i got the data for map! <font color="#008000">//for whole visible viewport( and just for it)</font> }); <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><font color="#008000"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> $.get( <font color="#A31515">"ajax/load-map-data?SE="</font> +MySECorner.toString()+ <font color="#A31515">"&amp;NE="</font> +MyNECorner.toString()+ <font color="#A31515">"&amp;zoom="</font> +currentZoom, <font color="#0000ff">function</font> (data){ <font color="#008000">//wow! i got the data for map!</font> //for whole visible viewport( and just for it) }); <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> $.get( <font color="#A31515">"ajax/load-map-data?SE="</font> +MySECorner.toString()+ <font color="#A31515">"&amp;NE="</font> +MyNECorner.toString()+ <font color="#A31515">"&amp;zoom="</font> +currentZoom, <font color="#0000ff">function</font> (data){ <font color="#008000">//wow! i got the data for map!</font> <font color="#008000">//for whole visible viewport( and just for it)</font> }); <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> </ol> <code><font color="gray"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">$.get( <font color="#A31515">"ajax/load-map-data?SE="</font> +MySECorner.toString()+ <font color="#A31515">"&amp;NE="</font> +MyNECorner.toString()+ <font color="#A31515">"&amp;zoom="</font> +currentZoom, <font color="#0000ff">function</font> (data){ <font color="#008000">//wow! i got the data for map!</font> <font color="#008000">//for whole visible viewport( and just for it)</font> });</font> * This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  Using it, we kill our server with the impossibility of caching, and the user delays at the slightest map shift (fi 4 <b>aroundme</b> number of times). <br><br>  <i>How does this crap google work so fast!</i> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      He seems to be loading pictures of his cards ... in small pieces, 256x256 pixels. <br><br><h4>  Think%% username%, why not do the same? </h4><br>  If we loaded our data in this way then: <br><ul><li>  one could just cache on the server </li><li>  Moving the map by less than 256 pixels would most likely not result in the loading of new data blocks. </li><li>  And since a normal browser supports 4-6 parallel requests to one server (or even more, use jsonp luke! For a couple of subdomains), then we would receive the same amount of data in a couple of streams and, as a result, fry faster </li></ul><br><br>  Personally, I belong to the category of perverts, and my implementation of such clever queries, plus the marker manager &amp; clustering takes about 6000 lines. <br>  I will not torment you now with what I will tell you about in subsequent articles. <br><br>  And just tell <br><h4>  How to make it simple </h4><br>  <i>The implementation is presented for google maps v3, if desired, it is remade in seconds under the yandex card (we take the tiles under Google and <a href="">display them on Yandex maps</a> , or we implement the described interface initially on Yandex ITile and use their coverter), or, having worked with a file, under google maps v2</i> <i><br></i>  <i>In any case, there is a wonderful <a href="">SparseTileLayer,</a> which can be dismantled from both the api cards and the rest (and which we are using now, since at the time of the end of the development of maps, there were no user options in v3)</i> <br><br>  So create your card type <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a></code> <ol><li>  <font color="#0000ff">function</font> ServerFetchMapType () { </li><li>  } </li><li></li><li>  ServerFetchMapType.prototype.tileSize = <font color="#0000ff">new</font> google.maps.Size (256,256); </li><li>  ServerFetchMapType.prototype.maxZoom = 32; </li><li>  ServerFetchMapType.prototype.name = <font color="#A31515">"Server Tile #s"</font> ; </li><li>  ServerFetchMapType.prototype.alt = <font color="#A31515">"Server Data Tile Map Type"</font> ; </li><li></li><li></li><li>  ServerFetchMapType.prototype.getTile = <font color="#0000ff">function</font> (coord, zoom, ownerDocument) { </li><li>  <font color="#0000ff">var</font> addr = <font color="#0000ff">this</font> .getAddr (coord, zoom); </li><li>  <font color="#008000">// test - may be we all load this block?</font> </li><li>  <font color="#0000ff">if</font> (ServerFetchedTiles [addr]) { </li><li>  <font color="#0000ff">return</font> </li><li>  } </li><li></li><li>  $ .get ( <font color="#A31515">"ajax / load-map-tile?"</font> + addr, </li><li>  <font color="#0000ff">function</font> (data) { </li><li>  ServerFetchedTiles [addr] = data; </li><li>  <font color="#008000">// wow!</font>  <font color="#008000">i got the data just for this tile</font> </li><li>  }); </li><li></li><li>  }; </li><li></li><li></li><li>  <font color="#008000">// and add this tile overlay to current map type</font> </li><li>  map.overlayMapTypes.insertAt (0, <font color="#0000ff">new</font> ServerFetchMapType ()); </li></ol>  <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font> </blockquote><br>  How not strange - <b>that's all</b> :) <br>  We have created our own card type, only instead of images we are performing requests to the server. <br>  And requests are of two options - Google like, when we address a tile by its x, y, z or standard ones, by bounding boxing. <br>  The implementation of these methods: <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a></code> <ol><li>  <font color="#008000">// we can request tile as tile (x, y, z)</font> </li><li>  ServerFetchMapType.prototype.getAddrXY = <font color="#0000ff">function</font> (coord, zoom) { </li><li>  <font color="#0000ff">return</font> <font color="#A31515">"x ="</font> + coord.x + <font color="#A31515">"&amp; y ="</font> + coor.y + <font color="#A31515">"&amp; z ="</font> + zoom; </li><li>  } </li><li></li><li>  <font color="#008000">// or as latlng box</font> </li><li>  ServerFetchMapType.prototype.getAddrLatLng = <font color="#0000ff">function</font> (coord, zoom) { </li><li></li><li>  <font color="#008000">// helper function for mercator projection</font> </li><li>  <font color="#0000ff">var</font> mercator = <font color="#0000ff">function</font> (point) { </li><li>  <font color="#008000">//</font> </li><li>  <font color="#0000ff">var</font> numtiles = Math.pow (2, point.zoom); </li><li>  <font color="#0000ff">var</font> bitmapsize = numtiles * 256; </li><li>  <font color="#0000ff">var</font> bitmaporigo = bitmapsize / 2; </li><li>  <font color="#0000ff">var</font> pixelsperlondegree = bitmapsize / 360; </li><li>  <font color="#0000ff">var</font> pixelsperlonradian = bitmapsize / (2 * Math.PI); </li><li></li><li>  <font color="#0000ff">var</font> lat = bitmaporigo + (pixelsperlondegree * point.x); </li><li>  <font color="#0000ff">var</font> ged2rad = ((point.t * Math.PI) /180.0); </li><li>  <font color="#0000ff">var</font> sn = Math.sin (deg2rad); </li><li>  <font color="#0000ff">var</font> lng = ((bitmaporigo - 0.5 * log ((1 + sn) / (1-sn)) * pixelsperlonradian)); </li><li>  <font color="#0000ff">return</font> <font color="#0000ff">new</font> google.maps.LatLng (lat, lng); </li><li>  } </li><li>  <font color="#0000ff">var</font> point1 = {x: coord.x * 256, y: coord.y * 256, z: zoom}; </li><li>  <font color="#0000ff">var</font> point2 = {x: (coord.x + 1) * 256, y: (coord.y + 1) * 256, z: zoom}; </li><li>  <font color="#0000ff">var</font> ne = mercator (point1); </li><li>  <font color="#0000ff">var</font> sw = mercator (point2); </li><li>  <font color="#0000ff">return</font> <font color="#A31515">"NE ="</font> + ne.toString () + <font color="#A31515">"&amp; SW ="</font> + sw.toString () + <font color="#A31515">"&amp; z ="</font> + zoom; </li><li>  } </li></ol>  <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font> </blockquote><br>  * In this case, we didn‚Äôt very well realize our mercator function, it‚Äôs much better to use the built-in converters (yandex.converter) and projectors (overlay.projection) of the API cards. <br><br><h4>  What remains </h4><br>  It remains to answer the question - what will happen if you do not have data for downloadable tiles (you are in the middle of the Ural mountains) and why do you need to load the data in this case? <br><br>  I gave the answer to this question a year and a half ago. <br>  Well, at the end, <a href="http://www.esosedi.ru/">let's</a> compare how data loading works on <a href="http://wikimapia.org/">wikimapia</a> , <a href="http://www.esosedi.ru/">esosedi</a> , <a href="http://www.gdeetotdom.ru/map/">gdeetotdom</a> and (shame and disgrace to programmers!) <a href="http://aroundme.ru/">Aroundme</a> <br><br>  By the way, it should be clarified that the three specified ‚Äúsmart‚Äù sites use the z-tile encoding, in fact, the path in the quadtree, but wikimapia, through its API, allows you to request data in xzy addressing. <br><br><h4>  That's all </h4><br>  I hope that my thoughts will reach people in these thoughts of people in need, if you have questions - ask. <br>  If there are just questions about cartography - also ask, since I had to start <a href="http://www.kashey.ru/maps/">my blog</a> ( <a href="http://thekashey.blogspot.com/">blogspot</a> mirror) in my clumsy English, I will always be happy to write about the problems of exciting masses. <br><br>  Well, I will go to finish the second article in which I will tell a lot of new secrets, not previously announced in Habr√©.  And you stock up on coffee and chat </div><p>Source: <a href="https://habr.com/ru/post/87894/">https://habr.com/ru/post/87894/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../87879/index.html">Windows Phone 7: Goodbye, support copy-paste</a></li>
<li><a href="../87880/index.html">Why Habra Barbados</a></li>
<li><a href="../87887/index.html">Canon wants its own domain zone</a></li>
<li><a href="../87891/index.html">Not a single iphone - AlterGeo for Android has been released!</a></li>
<li><a href="../87892/index.html">Search for applications under Maemo</a></li>
<li><a href="../87895/index.html">Brainstorming on marker boards</a></li>
<li><a href="../87898/index.html">An open letter to the Yandex.Mail team</a></li>
<li><a href="../87903/index.html">On the issue of copy-paste in Windows Phone</a></li>
<li><a href="../87904/index.html">Font using CSS</a></li>
<li><a href="../87905/index.html">How to choose the diagonal and screen resolution?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>