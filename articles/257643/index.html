<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Setting up a Mikrotik router to work with 3CX Phone System</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Mikrotik has long been producing highly flexible and inexpensive routing devices under the general name Mikrotik Routerboard. Despite the extensive li...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Setting up a Mikrotik router to work with 3CX Phone System</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/128/e2c/dfb/128e2cdfbd290e73b5bd5e7def505b02.jpg" alt="image"><br><br>  Mikrotik has long been producing highly flexible and inexpensive routing devices under the general name Mikrotik Routerboard.  Despite the extensive line of these devices, they are united by a single operating system - Mikrotik RouterOS.  Setting up Mikrotik routers to work with 3CX Phone System is not at all as difficult as it may seem at first glance.  Consider the setting on the example of Wi-Fi router RB2011UiAS-2HnD-IN.  This router is perfect for organizing access to the Internet for a small and medium-sized company. <br><br>  <strong>Attention!</strong>  Different Mikrotik models may have different presets.  In particular, the models for the SMB segment are preinstalled in such a way as to provide Internet access via the first port of the Eth1 router with minimal settings.  We will take advantage of this. <a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Basic configuration of the router to access the Internet </h4><br>  If you have a new router, download the <a href="">Winbox</a> utility and connect to the device at <strong>192.168.88.1</strong> with the username <strong>admin</strong> .  After connection, click on the <strong>Quick Set</strong> menu button in the upper left corner. <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/a5c/b27/396/a5cb27396a03fd8e9a2d8c911c5d97ff.png" alt="image [1]" width="779" height="768"></a> <br><br>  Here: <br><ol><li>  Upgrade the firmware of the router.  From there, start and continue after the device is rebooted. </li><li>  Wi-Fi settings of the router module (if your model has it). </li><li>  Internet access settings.  In this case, PPPoE access is used through the Ethernet1 port. </li><li>  LAN settings and DHCP server.  <strong>Attention!</strong>  Setting up a DHCP server requires additional steps, as described below. </li><li>  Password access to the management interface of the router. </li></ol><br>  The settings are fairly obvious.  After setting the parameters, click the <strong>Apply</strong> or <strong>OK</strong> button <strong>.</strong>  . <br><br><h4>  Setting up a DHCP server </h4><br>  Go to <strong>IP</strong> &gt; <strong>DHCP Server</strong> &gt; <strong>Options</strong> . <br><br>  Here you need to create a new DHCP option 66 and its value to specify the HTTP link for auto-tuning your IP phones.  This link needs to be copied from the <strong>Settings</strong> &gt; <strong>Auto-tune your phone</strong> section of the 3CX control console.  In this case, the string must be taken in single quotes, for example, <strong>'http://192.168.0.2/provisioning/hwz44ph6o9'</strong> . <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/d0a/733/1ff/d0a7331ff85b4eff781acd6de0ac28ee.png" alt="SNAGHTML5474749b [1]" width="790" height="240"></a> <br><br>  To complete the configuration, go to <strong>IP</strong> &gt; <strong>DHCP Server</strong> &gt; <strong>Networks</strong> and configure the DHCP server.  In this example, the DNS server, the domain name, the time server, and the option 66 created earlier in the DHCP are installed. <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/fd0/8d9/485/fd08d9485f8ca6f097abcd0355daef32.png" alt="image1 [1]" width="569" height="364"></a> <br><br><h4>  Disable SIP ALG </h4><br>  In order to avoid any problems in the work of remote connections in 3CX Phone System, you should disable the built-in SIP Application Layer Gateway router.  To do this, go to <strong>IP</strong> &gt; <strong>Firewall Service Ports</strong> and disable the SIP ALG service by clicking the button with the red cross on top. <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/dc4/7cd/ba1/dc47cdba1035b5182af33bba597bd23f.png" alt="image2 [1]" width="422" height="204"></a> <br><br><h4>  Creating firewall and NAT rules </h4><br>  In order to implement the Mikrotik Full Cone NAT router, or, in other words, publish the necessary ports of the 3CX Phone System server on the external interface, you should create a set of firewall rules.  All rules are created uniformly. <br><br>  Go to <strong>IP</strong> &gt; <strong>Firewall</strong> &gt; <strong>NAT</strong> and click the plus button to add a new rule.  In this example, rules are created for two SIP providers with IP addresses <strong>62.64.127.43</strong> and <strong>69.167.178.6</strong> .  Also, rules were created for external HTTPS connections (port 443 ‚Äî status of additional numbers, indication of the presence of 3CXPhone clients and remote server administration) and rules for 3CX Tunnel (ports 5090 UDP and TCP). <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/f76/1ff/1c2/f761ff1c20722ff6afc74c6852d9d8c1.png" alt="image3 [1]" width="766" height="248"></a> <br><br><h5>  Rule for SIP server </h5><br>  Parameters are set in the <strong>General</strong> and <strong>Action</strong> tabs. <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/18f/a72/0a9/18fa720a96506e3a0665287286a29db1.png" alt="image4 [1]" width="609" height="280"></a> <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/b1d/533/152/b1d5331529d02981a548d0b40421abf6.png" alt="image5 [2]" width="609" height="272"></a> <br><br>  Here: <br><ol><li>  Direction of the rule </li><li>  External address for which this rule is effective.  In this case, this is the IP address of the SIP provider.  <strong>Attention!</strong>  It is recommended to allow external incoming SIP and RTP traffic only for the necessary IP addresses, and not for the entire Internet! </li><li>  Protocol type </li><li>  The service port that is published </li><li>  The interface for which this rule is effective.  In this case, this is the PPPoE interface for connecting the router to the ISP </li><li>  The action that the rule performs </li><li>  Local 3CX Phone System Server Address </li><li>  Local port of the published service </li></ol><br><br><h5>  Rules for 3CX Tunnel and HTTPS </h5><br>  The rules are configured similarly, but the source address is not specified.  That is, the rule applies to any host on the Internet. <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/254/37f/fec/25437ffecb2e9e9033d5d528d657dfdd.png" alt="image6 [1]" width="609" height="272"></a> <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/114/203/536/11420353662d45b6b2dbe6770d87b938.png" alt="image7 [1]" width="609" height="272"></a> <br><br><h4>  Optional: Configure NTP Time Server </h4><br>  If you want the Mikrotik router to also be a time server for IP phones on your network, you need to download and install the package that runs the NTP server in the router.  The package archive for the current version of RouterOS can be downloaded <a href="">here</a> (relevant only for <strong>RouterOS 6.24</strong> !).  After downloading, unzip the archive and drag the <strong>ntp-6.24-mipsbe.npk file</strong> to the <strong>File List</strong> window, called up the <strong>Files</strong> side menu. <br><br>  <strong>Attention!</strong>  Upload the package file to the root of the file system.  After that, reboot the router in the <strong>System</strong> &gt; <strong>Reboot</strong> menu. <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/893/400/846/893400846ae9ab942e14ec86af214447.png" alt="image8 [1]" width="547" height="185"></a> <br><br>  After reboot, enable the NTP server in the <strong>System</strong> &gt; <strong>NTP Server</strong> menu. <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/d90/08c/e37/d9008ce370a27c3be3354e80a72c7246.png" alt="image9 [1]" width="271" height="138"></a> <br><br>  In the <strong>System</strong> &gt; <strong>NTP Client</strong> menu, set the IP address of your preferred NTP server to the Internet to set the exact time on the router. <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/006/781/46f/00678146f5e434e405d9c2fed733beaa.png" alt="image10 [1]" width="307" height="174"></a> <br><br>  It is also recommended to set the current time in the <strong>System</strong> &gt; <strong>Clock</strong> menu. <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/bb2/813/c5e/bb2813c5e4b3468dfe0e636881d8e426.png" alt="image11 [1]" width="295" height="217"></a> <br><br>  This completes the setup of the Mikrotik router to work with the 3CX Phone System. <br><br>  Of course, Mikrotik routers have many other important settings that can be used on your network, but they are beyond the scope of this article. </div><p>Source: <a href="https://habr.com/ru/post/257643/">https://habr.com/ru/post/257643/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../257633/index.html">LeakCanary - an assistant in the search for memory leaks</a></li>
<li><a href="../257635/index.html">The digest of interesting materials from the world of web development and IT for the last week ‚Ññ159 (May 4 - 10, 2015)</a></li>
<li><a href="../257637/index.html">Top 5 reports of the .NEXT 2014 Moscow conference (video inside)</a></li>
<li><a href="../257639/index.html">Free Data Recovery Test. Version of Habr's readers</a></li>
<li><a href="../257641/index.html">Hello, SaaS | Remote to all</a></li>
<li><a href="../257651/index.html">Announcement of the conference ThinkJava # 2</a></li>
<li><a href="../257653/index.html">Yii 2.0.4</a></li>
<li><a href="../257657/index.html">Game Exhibitions 2015</a></li>
<li><a href="../257659/index.html">OLED watch on arduino</a></li>
<li><a href="../257661/index.html">The digest of interesting materials for the mobile developer # 102 (on May 5-11)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>