<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Not quite a normal VPN connection using conventional tools.</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I was looking for an interesting topic that deserves attention in order to get an invite to Habrohabre and I found it. I had to implement such a speci...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Not quite a normal VPN connection using conventional tools.</h1><div class="post__text post__text-html js-mediator-article">  I was looking for an interesting topic that deserves attention in order to get an invite to Habrohabre and I found it.  I had to implement such a special case recently. <br><br><h4>  Task setting: Get access to the nodes of the remote network. </h4><br>  Here we will talk about two networks that need to be combined, one of which I will call ‚Äúmy office network‚Äù, and the other ‚Äúremote network‚Äù. <br>  The system administrator of the remote network refuses to make the smallest changes to connect, and the only thing that can be done is to place its equipment in the remote network.  Internet access from this network is made through the gateway, which natit into the world.  It is necessary to build a tunnel, between the two offices, so that the nodes of my office network can access the nodes of the remote network, with minimal changes from both sides. <br><br>  To perform the task of combining two networks and building a virtual tunnel you need to use the Virtual Private Network.  In the search for a suitable connection option, for myself I divided the VPN into two types: client-server option and peer.  The following points are the fundamental difference: <br><ul><li>  In a peer VPN using the global Internet, you need to have one real IP address for each of the nodes (at least 2 nodes).  Here the connection can be initiated by each of the parties (that is why I called him, equal), there can be more than two of them. </li><li>  In the client-server version using the global Internet, you need only one real IP address for the server.  The connection here occurs at the request of the client, the server always expects, there can be more than one client. </li></ul><br>  Note1: In both options, one of the conditions must be met (for the client-server option, only for the server): <br><ul><li>  A. VPN peer, must be located directly on the gateway (additional software must be installed, or the device must be able to establish the necessary type of VPN connections). </li><li>  B. If it is not possible to start the VPN peer directly on the gateway, you need to configure it so that it can pass the port to another device configured as a VPN peer. </li></ul>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <a name="habracut"></a><br>  Examples of VPN protocols: <br><br>  Client-server VPN: <br><ul><li>  PPTP; </li><li>  L2TP; </li><li>  OpenVPN; </li><li>  PPPoE; </li><li>  ... </li></ul><br>  Peer VPN: <br><ul><li>  IPSec; </li><li>  ... </li></ul><br>  Thus, the choice of the option - <i>Client-server VPN</i> becomes obvious.  So how to change from the client does not need anything in this version. <br><br><h4>  Which client-server options to choose? </h4><br>  And the first thing that comes to mind is the good old PPTP.  He has a lot of security flaws, although there are more advanced, newer versions.  Despite security flaws, PPTP has another very unpleasant feature - the GRE protocol used by the PPTP client to establish a connection to the server.  If a connection is established according to the scheme specified in Note1.B, the equipment that performs port forwarding (Port Forwarding) must be able to pass a PPTP connection (often located in the Application Level Gateway section) through itself (The function is often called pass through PPTP). and translates to skip PPTP through itself).  This is due to the peculiarities of the protocol and the fact that PPTP was not originally designed to work through NAT.  If there is no such function, then in this scheme the VPN channel will not be established for the simple reason that the server will not see the incoming connection request. <br>  PPPoE, L2TP and PPTP use the far from perfect authorization protocols pap, chap, mscap1 and mscap2. <br><br>  Fortunately, the OpenVPN protocol is devoid of most of the above drawbacks, does not use the GRE protocol and was specifically designed taking into account the characteristics of networks using NAT. <br>  A little about Open VPN: Works on port 1194, can use both TCP and UDP protocols.  Application level protocol, based on OSI model. <br>  Thus, the choice of these protocols has also become obvious - <i>OpenVPN</i> .  Of course, it is not perfect and not a panacea, but for this case it will work best. <br><br><h5>  Let's summarize a bit. </h5><br>  We will use the OpenVPN server from my office network (where I can change something, by and large I can change everything, I just don‚Äôt want to) the server, and from the remote network there will be a client.  In order not to greatly change the scheme of your office network, in which the firewall is a hardware device (and which does not have a built-in OpenVPN server), you need to put a device with an OpenVPN server behind it and forward port 1194 to it. <br>  Now we present how the connection between the client and the server will be established, but how will the nodes of the network of my office be able to see the nodes of the remote network? <br>  In order not to make changes to the remote network routers, we will hide the network of my office by NAT.  From my office, on the router, we will write down the route to the remote network through the VPN tunnel. <br>  The disadvantage of masking, in this case, may be, not being able to gain access from the nodes of the remote network to the nodes of my office, which in this case is rather an advantage. <br><br><h5>  Matured scheme. </h5><br><br> <a href=""><img src="https://habrastorage.org/storage2/ca6/6e1/0d2/ca66e10d266c523bbb1ab4dd5021eebe.png" alt="image"></a> <br><br>  The diagram in red shows the tunnel established by the client to the server, the black dotted line shows the packet route from the node from my office to the node from the remote office through the tunnel. <br><br>  On the proxy server 192.168.0.1-192.168.100.3 the following routes were added: <br> <code>Route 10.0.0.0/8 192.168.100.2 <br> Route 192.168.1.0/30 192.168.100.2</code> <br> <br>  Here we wrap all the packets addressed to the 192.168.1.0/30 and 10.0.0.0/8 networks on the 192.168.100.2-192.168.1.1 router.  OpenVPN Server runs on the same router.  All packets by default are sent to the Internet through the gateway 192.168.100.1-Real_1, and for the network 10.0.0.0/8 are sent via a virtual channel built on the Internet to the OpenVPN Client 192.168.1.2-10.1.1.2. <br><br>  For the normal operation of OpenVPN Server, on port 192.168.100.1-Real_1, port 1194 is forwarded to it. <br>  The address from the remote subnet 10.1.1.2 is registered on the OpenVPN Client.  The default gateway for it is 10.1.1.1.  The client establishes a connection to the Internet through the real IP address Real_1.  For the network 192.168.100.0/24, the route through 192.168.1.1-192.168.100.2 is registered in order for the packets that come from my office to return safely.  Here, on the client, a rule is set in the firewall (NAT table): packets that come from the 192.168.100.0/24 network are masked (masquerading) as an address from this subnet (10.1.1.2). <br><br><h4>  Theoretical packet check </h4><br>  So the packets from my network will get to the remote network and back according to the rules: <br>  Packets sent by node 192.168.0.123 from my office to the remote network 10.0.0.0/8 to node 10.0.0.123 will be masked by the gateway 192.168.0.1-192.168.100.3 under the address 192.168.100.3 and will be directed to the router 192.168.100.2-192.168. 1.1, from where they will be redirected through the address 192.168.1.1 to the address of the router 192.168.1.2-10.1.1.2, where they will again be disguised as the address 10.1.1.2, from where they will safely reach the addressee 10.0.0.123.  The address 10.0.0.123 will send the answer 10.1.1.2-192.168.1.2, which will send the answer from the address 192.168.1.2 to the address 192.168.1.1-192.168.100.2, which will return the packet from the address 192.168.100.2 to the server 192.168.100.3-192.168.0.1, which will transfer the packet back to 192.168.0.123 from the address 192.168.0.1. <br>  This detailed packet tracing procedure was needed to make sure that all the settings were made correctly and nothing was missed. <br><br><h5>  What equipment to choose as an OpenVPN server and client? </h5><br>  You can use a regular computer with an installed * nix system and an OpenVPN software package. <br>  And you can use specialized equipment.  It so happened that I had two Mikrotik RB450. <br><br><h4>  Configure RB450 or why I have not tested PPTP. </h4><br>  The fact is that the first time I tried to test everything on PPTP, but the client could not connect to the server, although it was possible to establish a connection from a Windows computer. <br><br><h5>  The Mikrotik RB450 update from version 3.22 to 4.20: </h5><br>  Only from version 3.25 or higher you can upgrade to 4.20, as it is written on the official website <a href="http://www.mikrotik.com/download.html">www.mikrotik.com/download.html#2.php</a> . <br>  Therefore, in the download section, select our system, and in the Software section, select Legacy.  Here I chose the latest release 3.30, which is placed on top of 3.22 without any questions: <br>  Made by analogy with the article <a href="http://www.asp24antenna.com.ua/obnovlenie-s-328-os-na-routeros-40/">www.asp24antenna.com.ua/obnovlenie-s-328-os-na-routeros-40</a> . <br>  Open WinBOX go to files, drag the firmware file 3.30 there, reboot and wait for a double peak - all the firmware is already there.  Then we go to System&gt; License and click update (the router must be connected to the Internet with configured DNS at this time).  After the update, we download again only the new firmware and throw it into the router, reboot - all of us have the newest firmware!  I was busy with updating both RB450 microtics from version 3.22 to 3.30 and then at 4.20, but this did not help and did not fix the situation with PPTP :( <br><br><h5>  Decided to build immediately on OpenVPN. </h5><br>  According to the leadership of this <a href="http://wiki.mikrotik.com/wiki/OpenVPN">article, wiki.mikrotik.com/wiki/OpenVPN</a> I created certificates and imported them.  For details, see this article.  I will describe only the key points or those that caused difficulties. <br>  Created an account on <a href="http://cacert.org/">CAcert.org</a> , although it is not at all necessary, you can issue a self-signed certificate. <br>  On the router, which will be an OpenVPN server, we execute the commands: <br><br> <code>/certificate create-certificate-request <br> #   : <br> passphrase: <br> (Your name) common name: <br> <br> #    <br> certificate-request.pem <br> private-key.pem</code> <br> <br>  Open the certificate-request.pem file, copy its contents (copy to a computer, for example, via FTP or drag to the desktop from WinBOX) and paste into a form on the <a href="http://cacert.org/">CAcert.org</a> website (registration is required) Server Certificates&gt; New, received answer we copy in the file certificate-response.pem (it is necessary to fill in on OpenVPN server). <br>  Now import certificates into WinBOX: <br><br> <code>System&gt; Certificates&gt; Import <br>   certificate-response.pem <br>  private-key.pem</code> <br> <br>  After that, the added certificate will be marked KR.  If instead you see QR, import private-key.pem again (it helped me). <br>  Now we are starting to create a server (do not forget to change it for your needs): <br><br> <code>/ interface ethernet <br> set ether1 name="ether1" <br> #     <br> <br> / interface bridge <br> add name="lan" arp=proxy-arp <br> #,    arp=proxy-arp! <br> <br> / interface bridge port <br> add interface=ether1 bridge=lan <br> <br> / ip address <br> add address=192.168.1.1/24 interface=lan <br> #   <br> <br> / ip pool <br> add name="ovpn-pool" ranges=192.168.1.2-192.168.1.2 <br> #     . <br> <br> / ppp profile <br> add name="ovpn-profile" local-address=192.168.1.1 remote-address=ovpn-pool use-encryption=yes only-one=yes change-tcp-mss=default <br> #,     / ppp %) <br> <br> /interface ovpn-server server <br> set enabled=yes auth=sha1 netmask=24 certificate=cert1 max-mtu=1500 port=1194 cipher=aes256 keepalive-timeout=60 mode=ip require-client-certificate=no default-profile=ovpn-profile <br> #       <br> #  mode=ip ! <br> <br> / ppp secret <br> add name="user-1" service=pptp password="123456" profile=ovpn-profile <br> #       ! <br></code> <br><br><h5>  On the router that will be OpenVPN Client we perform: </h5><br><br> <code>/interface ovpn-client <br> add name="ovpn-out1" connect-to=Real_1 port=1194 mode=ip user="user-1" password="123456" profile=default certificate=none cipher=aes256 add-default-route=no <br> # Real_1   IP  OpenVPN . <br> #      ! <br> #  mode=ip ! <br> <br> /ip firewall nat <br> chain=srcnat out-interface=ether1 src-address=192.168.100.0/24 action=masquerade <br> #    192.168.100.0/24 <br> #   :)</code> <br> <br><h4>  Lyrical digression </h4><br>  It is interesting to note that, theoretically, it is possible to establish a VPN connection, without having a single real IP address.  The analogue of such a connection is installed by voice Internet messenger like Skype.  The essence of such a connection is that there are several nodes and one server.  Each node is connected to the server, but when node1 wants to establish a communication session with node2, it requests the parameters of the established connection to the server of node2, from the server, after which it ‚Äúwedges in‚Äù instead of the server until the connection is broken and establishes it directly.  This is implemented using SIP (Session Initiation Protocol).  That is why Skype servers are not loaded with intermediate traffic generated by clients.  The result of such surveys of the installation of the VPN connection of the tunnel using SIP control resulted in the link <a href="http://www.ietf.org/mail-archive/web/sipping/current/msg10092.html">www.ietf.org/mail-archive/web/sipping/current/msg10092.html</a> .  Unfortunately, this idea did not become widespread, despite the fact that there are <a href="https://datatracker.ietf.org/drafts/draft-saito-mmusic-sdp-ike/">sketches of VPN-SIP from IETF</a> and there is also a description from <a href="http://pda.etsi.org/pda/queryform.asp">ETSI TS 185 010 V2.1.1 (2009-07)</a> (It is necessary to enter "TS 185 010" and be registered member of ETSI to read the document). <br><br>  Example of setting up a VPN connection using SIP control: <br> <a href=""><img src="https://habrastorage.org/storage2/c07/2ef/0a8/c072ef0a89747b63991d5bbe4b931d40.png" alt="image"></a> <br>  <b>Fig.1 Remote access to the home network.</b> <br><br>  Still, there are closed, programs with similar functionality, such as <a href="http://www.logmeinhamachi.com/">Hamachi</a> , <a href="http://www.teamviewer.com/">Teamviewer</a> , which, quite possibly, use exactly this idea. <br>  Just imagine how the world would be transformed if it had a common and standardized protocol through which a VPN connection could be established using SIP control! </div><p>Source: <a href="https://habr.com/ru/post/80883/">https://habr.com/ru/post/80883/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../80874/index.html">How I searched for the post office phone number</a></li>
<li><a href="../80875/index.html">Lenovo Skylight Smartbook - history of creation</a></li>
<li><a href="../80876/index.html">Apple has demanded that the blog Valleywag cancel the offer for information about the tablet</a></li>
<li><a href="../80881/index.html">Friends, Shukh leaves TM and Habr</a></li>
<li><a href="../80882/index.html">First tablet</a></li>
<li><a href="../80885/index.html">Rails 2.3.5 + mod_rails + MAMP on OSX Tiger</a></li>
<li><a href="../80887/index.html">Visual Studio "Myth Busting Matrix"</a></li>
<li><a href="../80891/index.html">MVC 2: Validation Model</a></li>
<li><a href="../80893/index.html">Programming in tables is a new concept of recording conditional (and not only) constructions.</a></li>
<li><a href="../80894/index.html">Corbina / Beeline - delayed payments by cards per day</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>