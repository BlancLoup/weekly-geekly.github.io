<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Balancing two providers based on BGP and EEM</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This article discusses how to manage BPG announcements on Cisco routers, running IOS XE, using Cisco Embedded Event Manager (EEM) for balancing incomi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Balancing two providers based on BGP and EEM</h1><div class="post__text post__text-html js-mediator-article"><p>  This article discusses how to manage BPG announcements on Cisco routers, running IOS XE, using Cisco Embedded Event Manager (EEM) for balancing incoming traffic and reserving uplink from several upstream providers. </p><br><a name="habracut"></a><br><h1>  Introduction </h1><br><p>  Often, in a small provider‚Äôs network, one can encounter a situation where an uplink is a BGP connection to two or more operators.  Moreover, the second provider is not used as a reserve, but together with the first one.  In addition, the situation is complicated by the fact that these channels may not be symmetrical in speed.  For example, with a total uplink requirement of 2 Gbps, two channels are purchased from two different providers: 1500 Mbps and 500 Mbps.  BGP protocol, in this case, perfectly solves the problem of reservation.  Of course, there is no full reserve.  It is obvious that it is impossible to reserve two gigabits by five hundred megabits without degrading the service for subscribers, however, a complete failure of the service will not occur.  And if the failure occurs not in the CNN (hours of maximum load), then the service may not suffer at all. </p><br><p>  Significantly more problems in this situation arise not with redundancy, but with balancing.  Especially because of the asymmetry of the channels in speed.  Moreover, balancing outgoing traffic (which we can, more or less, control) is not so important.  But controlling incoming traffic is much more difficult. </p><br><p>  Consider, as an example, the following scheme: </p><br><p><img src="https://habrastorage.org/files/b62/593/441/b62593441599476a878fadb0420631b3.png" alt="Network layout"></p><br><p>  ‚ÄúOur‚Äù AS65000 is connected to two providers: ISP # 1 (AS65001) and ISP # 2 (AS65002) on channels 1.5 Gbps wide and 500 Mbps, respectively.  Subscribers in our network are behind three local routers R7, R8 and R9 and use, respectively, three subnets: </p><br><ul><li>  172.16.7.0/24 </li><li>  172.16.8.0/24 </li><li>  172.16.9.0/24 </li></ul><br><p>  The ‚Äúresources of the global Internet‚Äù are three routers: </p><br><ul><li>  R5 (AS65050, 10.0.5.0/24) - has accession to both providers; </li><li>  R10 (AS65100, 10.0.10.0/24) - attached only to ISP # 1; </li><li>  R11 (AS65110, 10.0.11.0/24) - attached only to ISP # 2. </li></ul><br><p>  Providers have between themselves a peering joint (between R12 and R13). </p><br><p>  Unlike the client connection, the download of which is directly related to the revenue of the provider, the peer-to-peer junction may not bring the provider direct income, or even altogether, to be consumable.  Therefore, it is normal practice to increase the <a href="http://xgu.ru/wiki/BGP_local_preference"><em>BPG Local Preference</em></a> for client attachments, and reduce it for peers.  On our scheme, local preference values ‚Äã‚Äãare indicated by red markers: at peering, both providers have a value of 100 (default), and connections with us, as a client, increased 120. This option allows the provider, when receiving the same BPG route from the client and other provider to explicitly give preference to client interconnection.  At the same time, this is one of the reasons for the difficulties with balancing uplink with standard BGP tools. </p><br><h1>  Badassing </h1><br><p>  As I already wrote, balancing outgoing traffic, for most providers, is not so critical, so the topic of the article is the management of incoming traffic.  We need to decompose our traffic in two non-symmetrical channels: </p><br><ul><li>  1500 Mbps via ISP # 1; </li><li>  500 Mbps via ISP # 2. </li></ul><br><p>  Empirically, we establish two ranges of IP addresses that ‚Äúconsume‚Äù traffic in the proportion we need.  For simplicity of a situation (the principle of the method does not change from this) let us assume that subscribers behind routers R7 and R8 consume approximately three quarters of the total incoming traffic, and the remaining quarter accounts for subscribers of router R9.  In this case, using BGP announcements, we need to ensure that traffic for 172.16.7.0/24 and 172.16.8.0/24 networks goes through ISP # 1, and for 172.16.9.0/24 networks - through ISP # 2. </p><br><p>  We form two prefix lists and consider the methods by which we can divide traffic for them by channels: </p><br><pre><code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">ip</span></span> prefix-list isp-<span class="hljs-number"><span class="hljs-number">1</span></span>-out seq <span class="hljs-number"><span class="hljs-number">5</span></span> permit <span class="hljs-number"><span class="hljs-number">172.16.7.0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> ip prefix-list isp-<span class="hljs-number"><span class="hljs-number">1</span></span>-out seq <span class="hljs-number"><span class="hljs-number">10</span></span> permit <span class="hljs-number"><span class="hljs-number">172.16.8.0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> ip prefix-list isp-<span class="hljs-number"><span class="hljs-number">2</span></span>-out seq <span class="hljs-number"><span class="hljs-number">5</span></span> permit <span class="hljs-number"><span class="hljs-number">172.16.9.0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span></code> </pre> <br><h2>  AS-PATH Prepend </h2><br><p>  As a standard solution to this problem, BGP proposes the <a href="http://www.noction.com/blog/as-path-and-as-path-prepending"><em>AS-PATH Prepend mechanism</em></a> .  Its essence is that when choosing the best route from several possible, BGP protocol uses the value of the AS-PATH attribute, which sequentially lists the numbers of all autonomous systems through which the BGP announcement passed.  The route with the shortest AS-PATH is preferred.  The AS-PATH prepend method artificially lengthens the attribute value for some routes. </p><br><p>  Let's try to apply this method in our network.  To do this, create two route-maps on the CSR and use them: </p><br><pre> <code class="hljs sql">route-map isp-1-out permit 10 match ip address prefix-list isp-1-out route-map isp-1-out permit 20 match ip address prefix-list isp-2-out <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">path</span></span> prepend <span class="hljs-number"><span class="hljs-number">65000</span></span> <span class="hljs-number"><span class="hljs-number">65000</span></span> <span class="hljs-number"><span class="hljs-number">65000</span></span> route-<span class="hljs-keyword"><span class="hljs-keyword">map</span></span> isp<span class="hljs-number"><span class="hljs-number">-2</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">out</span></span> permit <span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-keyword"><span class="hljs-keyword">match</span></span> ip address prefix-<span class="hljs-keyword"><span class="hljs-keyword">list</span></span> isp<span class="hljs-number"><span class="hljs-number">-1</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">out</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">path</span></span> prepend <span class="hljs-number"><span class="hljs-number">65000</span></span> <span class="hljs-number"><span class="hljs-number">65000</span></span> <span class="hljs-number"><span class="hljs-number">65000</span></span> route-<span class="hljs-keyword"><span class="hljs-keyword">map</span></span> isp<span class="hljs-number"><span class="hljs-number">-2</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">out</span></span> permit <span class="hljs-number"><span class="hljs-number">20</span></span> <span class="hljs-keyword"><span class="hljs-keyword">match</span></span> ip address prefix-<span class="hljs-keyword"><span class="hljs-keyword">list</span></span> isp<span class="hljs-number"><span class="hljs-number">-2</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">out</span></span> router bgp <span class="hljs-number"><span class="hljs-number">65000</span></span> address-family ipv4 neighbor <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.101</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> route-<span class="hljs-keyword"><span class="hljs-keyword">map</span></span> isp<span class="hljs-number"><span class="hljs-number">-1</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">out</span></span> <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> neighbor <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.103</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span> route-<span class="hljs-keyword"><span class="hljs-keyword">map</span></span> isp<span class="hljs-number"><span class="hljs-number">-2</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">out</span></span> <span class="hljs-keyword"><span class="hljs-keyword">out</span></span></code> </pre> <br><p>  Now, in the direction of ISP # 1, the prefix 172.16.9.0/24 will be announced with AS-PATH extended to three AS65000 numbers, and in the direction of ISP # 2, the same will be done for the prefixes 172.16.7.0/24 and 172.16.8.0/24. </p><br><p>  Now, ideally, traffic for each group of prefixes should come through its provider, and in the event of one of the uplink crashes, an announcement will start working with prepend.  For example, if ISP # 2 is dropped, traffic for 172.16.9.0/24 will not be interrupted, since the whole world still ‚Äúsees‚Äù this prefix through ISP # 1, even with an extended AS-PATH. </p><br><p>  This method would work, but here various local preferences interfere with the game, which providers use for clients and peering.  Since, while choosing a route, the LOCAL PREFERENCE attribute has a higher priority than AS-PATH, within each provider our prepend will not play a role and traffic will always be sent through the client channel.  In our network, this method will work only for AS65050, as it is connected to both providers. </p><br><p>  Let's look in more detail. </p><br><p>  Indeed, on the R5 everything is fine: </p><br><pre> <code class="hljs markdown">R5#sh ip bgp ... <span class="hljs-bullet"><span class="hljs-bullet">* 172.16.7.0/24 192.168.45.4 0 65002 65000 65000 65000 65000 ? *</span></span>&gt; 192.168.25.2 0 65001 65000 ? <span class="hljs-bullet"><span class="hljs-bullet">* 172.16.8.0/24 192.168.45.4 0 65002 65000 65000 65000 65000 ? *</span></span>&gt; 192.168.25.2 0 65001 65000 ? <span class="hljs-emphasis"><span class="hljs-emphasis">*&gt; 172.16.9.0/24 192.168.45.4 0 65002 65000 ? *</span></span> 192.168.25.2 0 65001 65000 65000 65000 65000 ? R5#sh ip route ... 172.16.0.0/24 is subnetted, 3 subnets B 172.16.7.0 [20/0] via 192.168.25.2, 1d00h B 172.16.8.0 [20/0] via 192.168.25.2, 1d00h B 172.16.9.0 [20/0] via 192.168.45.4, 1d00h R5#traceroute 172.16.7.1 source 10.0.5.1 ... 1 192.168.25.2 0 msec 0 msec 1 msec 2 192.168.12.1 0 msec 1 msec 0 msec 3 192.168.101.100 3 msec 3 msec 3 msec 4 192.168.107.7 2 msec <span class="hljs-bullet"><span class="hljs-bullet">* 2 msec R5#traceroute 172.16.9.1 source 10.0.5.1 ... 1 192.168.45.4 1 msec 0 msec 1 msec 2 192.168.34.3 0 msec 1 msec 0 msec 3 192.168.103.100 3 msec 3 msec 3 msec 4 192.168.109.9 2 msec *</span></span> 3 msec</code> </pre> <br><p>  Based on the AS-PATH attribute for each group of prefixes, the optimal route through its provider is selected, which is confirmed by the trace. </p><br><p>  But on R11 (AS65110) everything is not so rosy. </p><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">R11</span></span><span class="hljs-selector-id"><span class="hljs-selector-id">#traceroute</span></span> 172<span class="hljs-selector-class"><span class="hljs-selector-class">.16</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.7</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.1</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">source</span></span> 10<span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.11</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.1</span></span> ... 1 192<span class="hljs-selector-class"><span class="hljs-selector-class">.168</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.114</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.4</span></span> 0 <span class="hljs-selector-tag"><span class="hljs-selector-tag">msec</span></span> 1 <span class="hljs-selector-tag"><span class="hljs-selector-tag">msec</span></span> 4 <span class="hljs-selector-tag"><span class="hljs-selector-tag">msec</span></span> 2 192<span class="hljs-selector-class"><span class="hljs-selector-class">.168</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.34</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.3</span></span> 1 <span class="hljs-selector-tag"><span class="hljs-selector-tag">msec</span></span> 0 <span class="hljs-selector-tag"><span class="hljs-selector-tag">msec</span></span> 0 <span class="hljs-selector-tag"><span class="hljs-selector-tag">msec</span></span> 3 192<span class="hljs-selector-class"><span class="hljs-selector-class">.168</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.103</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.100</span></span> 3 <span class="hljs-selector-tag"><span class="hljs-selector-tag">msec</span></span> 3 <span class="hljs-selector-tag"><span class="hljs-selector-tag">msec</span></span> 3 <span class="hljs-selector-tag"><span class="hljs-selector-tag">msec</span></span> 4 192<span class="hljs-selector-class"><span class="hljs-selector-class">.168</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.107</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.7</span></span> 2 <span class="hljs-selector-tag"><span class="hljs-selector-tag">msec</span></span> * 2 <span class="hljs-selector-tag"><span class="hljs-selector-tag">msec</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">R11</span></span><span class="hljs-selector-id"><span class="hljs-selector-id">#traceroute</span></span> 172<span class="hljs-selector-class"><span class="hljs-selector-class">.16</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.9</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.1</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">source</span></span> 10<span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.11</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.1</span></span> ... 1 192<span class="hljs-selector-class"><span class="hljs-selector-class">.168</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.114</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.4</span></span> 0 <span class="hljs-selector-tag"><span class="hljs-selector-tag">msec</span></span> 1 <span class="hljs-selector-tag"><span class="hljs-selector-tag">msec</span></span> 0 <span class="hljs-selector-tag"><span class="hljs-selector-tag">msec</span></span> 2 192<span class="hljs-selector-class"><span class="hljs-selector-class">.168</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.34</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.3</span></span> 0 <span class="hljs-selector-tag"><span class="hljs-selector-tag">msec</span></span> 0 <span class="hljs-selector-tag"><span class="hljs-selector-tag">msec</span></span> 0 <span class="hljs-selector-tag"><span class="hljs-selector-tag">msec</span></span> 3 192<span class="hljs-selector-class"><span class="hljs-selector-class">.168</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.103</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.100</span></span> 3 <span class="hljs-selector-tag"><span class="hljs-selector-tag">msec</span></span> 2 <span class="hljs-selector-tag"><span class="hljs-selector-tag">msec</span></span> 3 <span class="hljs-selector-tag"><span class="hljs-selector-tag">msec</span></span> 4 192<span class="hljs-selector-class"><span class="hljs-selector-class">.168</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.109</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.9</span></span> 2 <span class="hljs-selector-tag"><span class="hljs-selector-tag">msec</span></span> * 2 <span class="hljs-selector-tag"><span class="hljs-selector-tag">msec</span></span></code> </pre> <br><p>  Traffic to both hosts goes to us through the same five hundred megabit interface. </p><br><p>  The reason is just in local preference.  We look at the ISP # 2 provider R13: </p><br><pre> <code class="hljs markdown">R13&gt;sh ip bgp ... <span class="hljs-bullet"><span class="hljs-bullet">* 172.16.7.0/24 192.168.200.12 0 65001 65000 ? *</span></span>&gt;i 192.168.103.100 0 120 0 65000 65000 65000 65000 ? <span class="hljs-bullet"><span class="hljs-bullet">* 172.16.8.0/24 192.168.200.12 0 65001 65000 ? *</span></span>&gt;i 192.168.103.100 0 120 0 65000 65000 65000 65000 ? <span class="hljs-bullet"><span class="hljs-bullet">* 172.16.9.0/24 192.168.200.12 0 65001 65000 65000 65000 65000 ? *</span></span>&gt;i 192.168.103.100 0 120 0 65000 ? R13#sh ip route ... 172.16.0.0/24 is subnetted, 3 subnets B 172.16.7.0 [200/0] via 192.168.103.100, 1d00h B 172.16.8.0 [200/0] via 192.168.103.100, 1d00h B 172.16.9.0 [200/0] via 192.168.103.100, 1d00h</code> </pre> <br><p>  On the router all the BGP announcements of our networks in two copies: </p><br><ul><li>  received through client connection (next-hop 192.168.103.100); </li><li>  received through peering (next-hop 192.168.200.12). </li></ul><br><p>  But, despite the long AS-PATH, for prefixes 172.16.7.0/24 and 172.16.8.0/24, the best route is the route with local preference 120 through the client, i.e.  through us, not through peering.  It turns out that ISP # 2 will send all traffic of our subscribers through the channel 500Mbps.  And, if the data center of some large content provider (for example VK.com) turns out to be behind this provider, it will lead to overload on the channel and problems with the service. </p><br><p>  It turns out that the standard AS-PATH prepend does not help us. </p><br><h2>  Exclude Announcements </h2><br><p>  Another way to split traffic is simply to exclude from the BGP announcements in the direction of the operator those prefixes for which we do not want to receive traffic through this provider. </p><br><p>  Let's try. </p><br><p>  Instead of a route-map, we configure a filtering prefix-list for each neighbor. </p><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">router</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">bgp</span></span> 65000 <span class="hljs-selector-tag"><span class="hljs-selector-tag">address-family</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ipv4</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">neighbor</span></span> 192<span class="hljs-selector-class"><span class="hljs-selector-class">.168</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.101</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.1</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">prefix-list</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">isp-1-out</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">out</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">neighbor</span></span> 192<span class="hljs-selector-class"><span class="hljs-selector-class">.168</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.103</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.3</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">prefix-list</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">isp-2-out</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">out</span></span></code> </pre> <br><p>  Now, in the direction of each provider, only those routes that should receive traffic through this junction are announced: </p><br><pre> <code class="hljs vhdl">CSR#sh ip bgp neighbors <span class="hljs-number"><span class="hljs-number">192.168</span></span>.<span class="hljs-number"><span class="hljs-number">101.1</span></span> advertised-routes ... Network <span class="hljs-keyword"><span class="hljs-keyword">Next</span></span> Hop Metric LocPrf Weight Path *&gt; <span class="hljs-number"><span class="hljs-number">172.16</span></span>.<span class="hljs-number"><span class="hljs-number">7.0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> <span class="hljs-number"><span class="hljs-number">192.168</span></span>.<span class="hljs-number"><span class="hljs-number">107.7</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">32768</span></span> ? *&gt; <span class="hljs-number"><span class="hljs-number">172.16</span></span>.<span class="hljs-number"><span class="hljs-number">8.0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> <span class="hljs-number"><span class="hljs-number">192.168</span></span>.<span class="hljs-number"><span class="hljs-number">108.8</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">32768</span></span> ? Total number <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> prefixes <span class="hljs-number"><span class="hljs-number">2</span></span> CSR#sh ip bgp neighbors <span class="hljs-number"><span class="hljs-number">192.168</span></span>.<span class="hljs-number"><span class="hljs-number">103.3</span></span> advertised-routes ... Network <span class="hljs-keyword"><span class="hljs-keyword">Next</span></span> Hop Metric LocPrf Weight Path *&gt; <span class="hljs-number"><span class="hljs-number">172.16</span></span>.<span class="hljs-number"><span class="hljs-number">9.0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> <span class="hljs-number"><span class="hljs-number">192.168</span></span>.<span class="hljs-number"><span class="hljs-number">109.9</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">32768</span></span> ? Total number <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> prefixes <span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre> <br><p>  With this approach, the operator builds its routing table exactly as we need: </p><br><pre> <code class="hljs swift"><span class="hljs-type"><span class="hljs-type">R13</span></span>&gt;sh ip route ... <span class="hljs-number"><span class="hljs-number">172.16</span></span>.<span class="hljs-number"><span class="hljs-number">0.0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> subnetted, <span class="hljs-number"><span class="hljs-number">3</span></span> subnets <span class="hljs-type"><span class="hljs-type">B</span></span> <span class="hljs-number"><span class="hljs-number">172.16</span></span>.<span class="hljs-number"><span class="hljs-number">7.0</span></span> [<span class="hljs-number"><span class="hljs-number">20</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>] via <span class="hljs-number"><span class="hljs-number">192.168</span></span>.<span class="hljs-number"><span class="hljs-number">200.12</span></span>, <span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">04</span></span>:<span class="hljs-number"><span class="hljs-number">53</span></span> <span class="hljs-type"><span class="hljs-type">B</span></span> <span class="hljs-number"><span class="hljs-number">172.16</span></span>.<span class="hljs-number"><span class="hljs-number">8.0</span></span> [<span class="hljs-number"><span class="hljs-number">20</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>] via <span class="hljs-number"><span class="hljs-number">192.168</span></span>.<span class="hljs-number"><span class="hljs-number">200.12</span></span>, <span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">04</span></span>:<span class="hljs-number"><span class="hljs-number">53</span></span> <span class="hljs-type"><span class="hljs-type">B</span></span> <span class="hljs-number"><span class="hljs-number">172.16</span></span>.<span class="hljs-number"><span class="hljs-number">9.0</span></span> [<span class="hljs-number"><span class="hljs-number">200</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>] via <span class="hljs-number"><span class="hljs-number">192.168</span></span>.<span class="hljs-number"><span class="hljs-number">103.100</span></span>, <span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">05</span></span>:<span class="hljs-number"><span class="hljs-number">13</span></span></code> </pre> <br><p>  Now traces from R11 go through different providers: </p><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">R11</span></span><span class="hljs-selector-id"><span class="hljs-selector-id">#traceroute</span></span> 172<span class="hljs-selector-class"><span class="hljs-selector-class">.16</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.7</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.1</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">source</span></span> 10<span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.11</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.1</span></span> ... 1 192<span class="hljs-selector-class"><span class="hljs-selector-class">.168</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.114</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.4</span></span> 4 <span class="hljs-selector-tag"><span class="hljs-selector-tag">msec</span></span> 4 <span class="hljs-selector-tag"><span class="hljs-selector-tag">msec</span></span> 4 <span class="hljs-selector-tag"><span class="hljs-selector-tag">msec</span></span> 2 192<span class="hljs-selector-class"><span class="hljs-selector-class">.168</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.134</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.13</span></span> 1 <span class="hljs-selector-tag"><span class="hljs-selector-tag">msec</span></span> 0 <span class="hljs-selector-tag"><span class="hljs-selector-tag">msec</span></span> 1 <span class="hljs-selector-tag"><span class="hljs-selector-tag">msec</span></span> 3 192<span class="hljs-selector-class"><span class="hljs-selector-class">.168</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.200</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.12</span></span> 0 <span class="hljs-selector-tag"><span class="hljs-selector-tag">msec</span></span> 1 <span class="hljs-selector-tag"><span class="hljs-selector-tag">msec</span></span> 0 <span class="hljs-selector-tag"><span class="hljs-selector-tag">msec</span></span> 4 192<span class="hljs-selector-class"><span class="hljs-selector-class">.168</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.121</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.1</span></span> 0 <span class="hljs-selector-tag"><span class="hljs-selector-tag">msec</span></span> 1 <span class="hljs-selector-tag"><span class="hljs-selector-tag">msec</span></span> 1 <span class="hljs-selector-tag"><span class="hljs-selector-tag">msec</span></span> 5 192<span class="hljs-selector-class"><span class="hljs-selector-class">.168</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.101</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.100</span></span> 2 <span class="hljs-selector-tag"><span class="hljs-selector-tag">msec</span></span> 4 <span class="hljs-selector-tag"><span class="hljs-selector-tag">msec</span></span> 3 <span class="hljs-selector-tag"><span class="hljs-selector-tag">msec</span></span> 6 192<span class="hljs-selector-class"><span class="hljs-selector-class">.168</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.107</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.7</span></span> 2 <span class="hljs-selector-tag"><span class="hljs-selector-tag">msec</span></span> * 2 <span class="hljs-selector-tag"><span class="hljs-selector-tag">msec</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">R11</span></span><span class="hljs-selector-id"><span class="hljs-selector-id">#traceroute</span></span> 172<span class="hljs-selector-class"><span class="hljs-selector-class">.16</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.9</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.1</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">source</span></span> 10<span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.11</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.1</span></span> ... 1 192<span class="hljs-selector-class"><span class="hljs-selector-class">.168</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.114</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.4</span></span> 0 <span class="hljs-selector-tag"><span class="hljs-selector-tag">msec</span></span> 4 <span class="hljs-selector-tag"><span class="hljs-selector-tag">msec</span></span> 0 <span class="hljs-selector-tag"><span class="hljs-selector-tag">msec</span></span> 2 192<span class="hljs-selector-class"><span class="hljs-selector-class">.168</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.34</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.3</span></span> 0 <span class="hljs-selector-tag"><span class="hljs-selector-tag">msec</span></span> 1 <span class="hljs-selector-tag"><span class="hljs-selector-tag">msec</span></span> 0 <span class="hljs-selector-tag"><span class="hljs-selector-tag">msec</span></span> 3 192<span class="hljs-selector-class"><span class="hljs-selector-class">.168</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.103</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.100</span></span> 3 <span class="hljs-selector-tag"><span class="hljs-selector-tag">msec</span></span> 3 <span class="hljs-selector-tag"><span class="hljs-selector-tag">msec</span></span> 3 <span class="hljs-selector-tag"><span class="hljs-selector-tag">msec</span></span> 4 192<span class="hljs-selector-class"><span class="hljs-selector-class">.168</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.109</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.9</span></span> 2 <span class="hljs-selector-tag"><span class="hljs-selector-tag">msec</span></span> * 2 <span class="hljs-selector-tag"><span class="hljs-selector-tag">msec</span></span></code> </pre> <br><p>  However, there is a problem with the reservation.  Indeed, when ISP # 2 drops, subscribers from the 172.16.9.0/24 network lose service, as the whole world no longer ‚Äúsees‚Äù the route to them.  Usually, this can be solved by announcing an aggregation of the prefix for the reserve.  For example, if we had an address range from 172.16.6.0 to 172.16.9.255, then we could additionally announce to both providers the enlarged subnets 172.16.6.0/23 and 172.16.8.0/23, which include our prefixes.  Then, if one of the providers fell and the ‚Äúspecificity‚Äù of the / 24 routes disappeared on the Internet, it would still remain / 23, and the service would work for all subscribers even on one uplink.  But in our example this is impossible.  Our client networks cannot be aggregated into one or two prefixes.  Of course, the networks in the example were chosen specially, but, precisely, the collision with such a situation in practice prompted me to write a note. </p><br><h2>  Reservation </h2><br><p>  We solved the problem of balancing incoming traffic.  It remains to achieve redundancy.  The general solution is clear: if one of the peers falls, change the outgoing announcements filter on the peer that is still ‚Äúalive‚Äù.  This could be implemented ‚Äúoutside‚Äù, changing the settings of our border router with a script via SSH or SNMP.  However, the purpose of the note is to make everything integrated with Cisco. </p><br><h3>  BGP Conditional Advertisement </h3><br><p>  One of the options for managing BGP announcements depending on the state of the BGP neighborhood is the <em>Conditional Advertisement</em> , which allows you to announce certain prefixes towards the neighbor, depending on the presence or absence of "control" prefixes in the BGP table. </p><br><p>  Prefixes that need to be announced or, conversely, removed from the announcement are determined by a special route-map: <strong>advertise-map</strong> , which can be in <strong>withdraw</strong> mode (prefixes corresponding to the route-map are excluded from the announcement) or <strong>advertise</strong> (prefixes participate in the announcement).  ‚ÄúControl‚Äù prefixes are defined by a separate <strong>condition-map</strong> , which can be declared as <strong>exist-map</strong> or <strong>non-exist-map</strong> .  In the first case, prefixes from the advertise-map are announced only if there are prefixes in the BGP table that correspond to exist-map.  In the case of a non-exist-map, vice versa: if a non-exist-map returns an empty list of prefixes, then the adfix-map prefixes are announced, and if not, they are excluded from the announcement. </p><br><p>  In our case, the option with non-exist-map.  The route-map configuration here has several features: </p><br><ol><li>  the route-map should contain only the permit sections; </li><li>  in each section, the match must contain a prefix-list (can not be filtered only by as-path or community); </li><li>  The prefix-list should be "exact match", i.e.  no parameters <em>le</em> or <em>ge</em> ; </li><li>  <em>next-hop</em> or <em>interface</em> filtering is not supported. </li></ol><br><p>  So we need a control prefix.  You can choose something from what providers announce to us (or even tell them that you are using conditional advertisement and ask them to add a prefix to which you can orient yourself).  But in most cases (if there are no other providers among your clients), instead of full-view, you will receive a default prefix of 0.0.0.0/0 from your upstream provider.  We will use it as a control.  And to distinguish the default of one provider from another, add to non-exist-map a filter by AS-PATH. </p><br><p>  Create a prefix-list and two as-path ACLs: </p><br><pre> <code class="hljs pgsql">ip prefix-list <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> seq <span class="hljs-number"><span class="hljs-number">5</span></span> permit <span class="hljs-number"><span class="hljs-number">0.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span> ip <span class="hljs-keyword"><span class="hljs-keyword">as</span></span>-<span class="hljs-type"><span class="hljs-type">path</span></span> <span class="hljs-keyword"><span class="hljs-keyword">access</span></span>-list <span class="hljs-number"><span class="hljs-number">1</span></span> permit ^<span class="hljs-number"><span class="hljs-number">65001.</span></span>* ip <span class="hljs-keyword"><span class="hljs-keyword">as</span></span>-<span class="hljs-type"><span class="hljs-type">path</span></span> <span class="hljs-keyword"><span class="hljs-keyword">access</span></span>-list <span class="hljs-number"><span class="hljs-number">2</span></span> permit ^<span class="hljs-number"><span class="hljs-number">65002.</span></span>*</code> </pre> <br><p>  Add two condition-maps, each of which will return a non-empty list only if the connection with the corresponding ISP is established: </p><br><pre> <code class="hljs swift">route-<span class="hljs-built_in"><span class="hljs-built_in">map</span></span> isp-<span class="hljs-number"><span class="hljs-number">1</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">is</span></span>-alive permit <span class="hljs-number"><span class="hljs-number">10</span></span> match ip address <span class="hljs-keyword"><span class="hljs-keyword">prefix</span></span>-list <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> match <span class="hljs-keyword"><span class="hljs-keyword">as</span></span>-path <span class="hljs-number"><span class="hljs-number">1</span></span> route-<span class="hljs-built_in"><span class="hljs-built_in">map</span></span> isp-<span class="hljs-number"><span class="hljs-number">2</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">is</span></span>-alive permit <span class="hljs-number"><span class="hljs-number">10</span></span> match ip address <span class="hljs-keyword"><span class="hljs-keyword">prefix</span></span>-list <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> match <span class="hljs-keyword"><span class="hljs-keyword">as</span></span>-path <span class="hljs-number"><span class="hljs-number">2</span></span></code> </pre> <br><p>  Create two route-maps, which will be advertise-map for the corresponding destinations: </p><br><pre> <code class="hljs swift">route-<span class="hljs-built_in"><span class="hljs-built_in">map</span></span> isp-<span class="hljs-number"><span class="hljs-number">1</span></span>-adv permit <span class="hljs-number"><span class="hljs-number">10</span></span> match ip address <span class="hljs-keyword"><span class="hljs-keyword">prefix</span></span>-list isp-<span class="hljs-number"><span class="hljs-number">2</span></span>-out route-<span class="hljs-built_in"><span class="hljs-built_in">map</span></span> isp-<span class="hljs-number"><span class="hljs-number">2</span></span>-adv permit <span class="hljs-number"><span class="hljs-number">10</span></span> match ip address <span class="hljs-keyword"><span class="hljs-keyword">prefix</span></span>-list isp-<span class="hljs-number"><span class="hljs-number">1</span></span>-out</code> </pre> <br><p>  We will use another route-map to filter all outgoing announcements: </p><br><pre> <code class="hljs pgsql">route-map <span class="hljs-keyword"><span class="hljs-keyword">full</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">out</span></span> permit <span class="hljs-number"><span class="hljs-number">10</span></span> match ip address prefix-list isp<span class="hljs-number"><span class="hljs-number">-1</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">out</span></span> isp<span class="hljs-number"><span class="hljs-number">-2</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">out</span></span></code> </pre> <br><p>  Now apply them in the configuration of the BGP neighbors: </p><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">router</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">bgp</span></span> 65000 <span class="hljs-selector-tag"><span class="hljs-selector-tag">address-family</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ipv4</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">neighbor</span></span> 192<span class="hljs-selector-class"><span class="hljs-selector-class">.168</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.101</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.1</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">advertise-map</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">isp-1-adv</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">non-exist-map</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">isp-2-is-alive</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">neighbor</span></span> 192<span class="hljs-selector-class"><span class="hljs-selector-class">.168</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.101</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.1</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">route-map</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">full-out</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">out</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">neighbor</span></span> 192<span class="hljs-selector-class"><span class="hljs-selector-class">.168</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.103</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.3</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">advertise-map</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">isp-2-adv</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">non-exist-map</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">isp-1-is-alive</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">neighbor</span></span> 192<span class="hljs-selector-class"><span class="hljs-selector-class">.168</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.103</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.3</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">route-map</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">full-out</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">out</span></span></code> </pre> <br><p>  Let's take a closer look at the neighbor 192.168.103.3 configuration: </p><br><ol><li>  prefixes for the announcement are selected by the route-map <em>full-out</em> ; </li><li>  additionally checked non-exist-map <em>isp-1-is-alive</em> : <br><ul><li>  if <em>isp-1-is-alive</em> returns a non-empty list, prior to advertise-map <em>isp-1-adv is</em> assigned a status of <em>withdraw</em> and its prefixes are excluded from the announcement; </li><li>  if <em>isp-1-is-alive</em> returns an empty list, before the advertise-map <em>isp-1-adv is</em> given the status <em>advertise</em> and its prefixes are announced. </li></ul></li></ol><br><p>  Let's see what happened.  Initially, ‚Äúcontrol‚Äù prefixes for both non-exist-maps are in the BGP table and the corresponding advertise-map are in withdraw status: </p><br><pre> <code class="hljs swift"><span class="hljs-type"><span class="hljs-type">CSR</span></span>#sh ip bgp neighbors <span class="hljs-number"><span class="hljs-number">192.168</span></span>.<span class="hljs-number"><span class="hljs-number">101.1</span></span> | i <span class="hljs-type"><span class="hljs-type">Condition</span></span> <span class="hljs-type"><span class="hljs-type">Condition</span></span>-<span class="hljs-built_in"><span class="hljs-built_in">map</span></span> isp-<span class="hljs-number"><span class="hljs-number">2</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">is</span></span>-alive, <span class="hljs-type"><span class="hljs-type">Advertise</span></span>-<span class="hljs-built_in"><span class="hljs-built_in">map</span></span> isp-<span class="hljs-number"><span class="hljs-number">1</span></span>-adv, status: <span class="hljs-type"><span class="hljs-type">Withdraw</span></span> <span class="hljs-type"><span class="hljs-type">CSR</span></span>#sh ip bgp neighbors <span class="hljs-number"><span class="hljs-number">192.168</span></span>.<span class="hljs-number"><span class="hljs-number">103.3</span></span> | i <span class="hljs-type"><span class="hljs-type">Condition</span></span> <span class="hljs-type"><span class="hljs-type">Condition</span></span>-<span class="hljs-built_in"><span class="hljs-built_in">map</span></span> isp-<span class="hljs-number"><span class="hljs-number">1</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">is</span></span>-alive, <span class="hljs-type"><span class="hljs-type">Advertise</span></span>-<span class="hljs-built_in"><span class="hljs-built_in">map</span></span> isp-<span class="hljs-number"><span class="hljs-number">2</span></span>-adv, status: <span class="hljs-type"><span class="hljs-type">Withdraw</span></span></code> </pre> <br><p>  Since both providers are "alive", only part of the prefixes are announced in the direction of each of them: </p><br><pre> <code class="hljs vhdl">CSR#sh ip bgp neighbors <span class="hljs-number"><span class="hljs-number">192.168</span></span>.<span class="hljs-number"><span class="hljs-number">101.1</span></span> advertised-routes ... Network <span class="hljs-keyword"><span class="hljs-keyword">Next</span></span> Hop Metric LocPrf Weight Path *&gt; <span class="hljs-number"><span class="hljs-number">172.16</span></span>.<span class="hljs-number"><span class="hljs-number">7.0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> <span class="hljs-number"><span class="hljs-number">192.168</span></span>.<span class="hljs-number"><span class="hljs-number">107.7</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">32768</span></span> i *&gt; <span class="hljs-number"><span class="hljs-number">172.16</span></span>.<span class="hljs-number"><span class="hljs-number">8.0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> <span class="hljs-number"><span class="hljs-number">192.168</span></span>.<span class="hljs-number"><span class="hljs-number">108.8</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">32768</span></span> i Total number <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> prefixes <span class="hljs-number"><span class="hljs-number">2</span></span> CSR#sh ip bgp neighbors <span class="hljs-number"><span class="hljs-number">192.168</span></span>.<span class="hljs-number"><span class="hljs-number">103.3</span></span> advertised-routes ... Network <span class="hljs-keyword"><span class="hljs-keyword">Next</span></span> Hop Metric LocPrf Weight Path *&gt; <span class="hljs-number"><span class="hljs-number">172.16</span></span>.<span class="hljs-number"><span class="hljs-number">9.0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> <span class="hljs-number"><span class="hljs-number">192.168</span></span>.<span class="hljs-number"><span class="hljs-number">109.9</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">32768</span></span> i Total number <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> prefixes <span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre> <br><p>  In case of disconnecting the BGP neighborhood with ISP # 1, the prefixes for the route-map isp-1-is-alive and advertise-map isp-2-adv for ISP # 2 go to <em>advertise</em> status disappear from the BGP table: </p><br><pre> <code class="hljs swift"><span class="hljs-type"><span class="hljs-type">CSR</span></span>#sh ip bgp neighbors <span class="hljs-number"><span class="hljs-number">192.168</span></span>.<span class="hljs-number"><span class="hljs-number">103.3</span></span> | i <span class="hljs-type"><span class="hljs-type">Condition</span></span> <span class="hljs-type"><span class="hljs-type">Condition</span></span>-<span class="hljs-built_in"><span class="hljs-built_in">map</span></span> isp-<span class="hljs-number"><span class="hljs-number">1</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">is</span></span>-alive, <span class="hljs-type"><span class="hljs-type">Advertise</span></span>-<span class="hljs-built_in"><span class="hljs-built_in">map</span></span> isp-<span class="hljs-number"><span class="hljs-number">2</span></span>-adv, status: <span class="hljs-type"><span class="hljs-type">Advertise</span></span></code> </pre> <br><p>  Now route-map prefixes isp-2-adv are not excluded from the announcement and the full set of prefixes are announced in the direction of ISP # 2: </p><br><pre> <code class="hljs vhdl">CSR#sh ip bgp neighbors <span class="hljs-number"><span class="hljs-number">192.168</span></span>.<span class="hljs-number"><span class="hljs-number">103.3</span></span> advertised-routes ... Network <span class="hljs-keyword"><span class="hljs-keyword">Next</span></span> Hop Metric LocPrf Weight Path *&gt; <span class="hljs-number"><span class="hljs-number">172.16</span></span>.<span class="hljs-number"><span class="hljs-number">7.0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> <span class="hljs-number"><span class="hljs-number">192.168</span></span>.<span class="hljs-number"><span class="hljs-number">107.7</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">32768</span></span> i *&gt; <span class="hljs-number"><span class="hljs-number">172.16</span></span>.<span class="hljs-number"><span class="hljs-number">8.0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> <span class="hljs-number"><span class="hljs-number">192.168</span></span>.<span class="hljs-number"><span class="hljs-number">108.8</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">32768</span></span> i *&gt; <span class="hljs-number"><span class="hljs-number">172.16</span></span>.<span class="hljs-number"><span class="hljs-number">9.0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> <span class="hljs-number"><span class="hljs-number">192.168</span></span>.<span class="hljs-number"><span class="hljs-number">109.9</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">32768</span></span> i Total number <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> prefixes <span class="hljs-number"><span class="hljs-number">3</span></span></code> </pre> <br><p>  When the BGP neighborhood is restored, the status changes to advertise-map back to <em>withdraw</em> , and the prefixes are again distributed to the providers for balancing. </p><br><p>  Another option for using Conditional Advertismement is to localize the problem on the provider‚Äôs side or even above its area of ‚Äã‚Äãresponsibility.  In the case of our test scheme, it can be imagined that the AS65110 has a datacenter for a large content provider, access to which is critical for our subscribers.  In the case of a peer-to-peer connection between two providers, some subscribers whose prefixes are advertised only in the direction of ISP # 1 will lose access to AS65110.  At the same time, there is a connection with the provider, there are prefixes and default from it, but the subscriber service suffers.  In this case, we can use a configuration similar to that described above, only as an "control" prefix to use the addresses of our critical resources in AS65110. </p><br><h3>  Cisco Embedded Event Manager </h3><br><p>  <em>The method described further, considering the possibilities of BGP Conditional Advertismement, looks a bit artificial for solving such a simple task.</em>  <em>The reason for this is that in the original version of the article he was the only one, since the story about the Cisco EEM was the purpose of writing the note.</em>  <em>In this case, the problem of balancing was chosen as the simplest and most understandable version of the illustration.</em>  <em>However, later in the comments, it was rightly pointed out to me that describing the problem of managing BGP announcements without mentioning a tool that is not exactly intended for this purpose.</em>  <em>So the article appeared a paragraph about BGP Conditional Advertisment, against which the use of Cisco EEM seems cumbersome and redundant.</em>  <em>However, this is a very powerful tool that has a huge field of application, so it‚Äôs still worth getting to know it.</em> </p><br><p>  We solved the problem of balancing incoming traffic.  It remains to achieve redundancy.  The general solution is clear: if one of the peers falls, change the outgoing announcements filter on the peer that is still ‚Äúalive‚Äù.  This could be implemented ‚Äúoutside‚Äù, changing the settings of our border router with a script via SSH or SNMP.  However, the purpose of the note is to make everything integrated with Cisco. </p><br><p>  This is where the <a href="http://www.cisco.com/c/en/us/td/docs/ios-xml/ios/eem/configuration/xe-3s/eem-xe-3s-book/eem-overview.html"><em>Cisco Embedded Event Manager (EEM)</em></a> mechanism comes in handy.  This is a very flexible mechanism for managing the router and troubleshooting problems on the network, the possibilities of which go far beyond the limits of the described task.  We need from him his ability to catch the occurrence of a certain event (the fall or the restoration of the BGP-neighborhood) and execute a given set of commands. </p><br><p>  First, create a prefix list that includes all of our prefixes. </p><br><pre> <code class="hljs pgsql">ip prefix-list <span class="hljs-keyword"><span class="hljs-keyword">full</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">out</span></span> seq <span class="hljs-number"><span class="hljs-number">5</span></span> permit <span class="hljs-number"><span class="hljs-number">172.16</span></span><span class="hljs-number"><span class="hljs-number">.7</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> ip prefix-list <span class="hljs-keyword"><span class="hljs-keyword">full</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">out</span></span> seq <span class="hljs-number"><span class="hljs-number">10</span></span> permit <span class="hljs-number"><span class="hljs-number">172.16</span></span><span class="hljs-number"><span class="hljs-number">.8</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> ip prefix-list <span class="hljs-keyword"><span class="hljs-keyword">full</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">out</span></span> seq <span class="hljs-number"><span class="hljs-number">15</span></span> permit <span class="hljs-number"><span class="hljs-number">172.16</span></span><span class="hljs-number"><span class="hljs-number">.9</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span></code> </pre> <br><p>  Now we will configure the EEM applet that will be launched when a change in the status of the BGP-neighborhood appears in the log (defined by a regular expression).  Applet: </p><br><ol><li>  Parses the message in the log and determines: <br><ul><li>  The router-id of the BGP neighbor that provoked the message </li><li>  his status; </li></ul></li><li>  depending on the IP address and status, applies one or another prefix list for another BGP neighbor; </li><li>  ‚ÄúSoftly‚Äù dumps the announcements in the direction of the second neighbor, which would speed up the distribution of route information and the application of the changes made. </li></ol><br><p>  Applet Configuration: </p><br><pre> <code class="hljs bash">event manager applet isp event syslog pattern <span class="hljs-string"><span class="hljs-string">"neighbor 192.168.10[13].[13] (Up|Down|reset)"</span></span> action 01.0 regexp <span class="hljs-string"><span class="hljs-string">"(192.168.10[13].[13])"</span></span> <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$_syslog_msg</span></span></span><span class="hljs-string">"</span></span> _match _ip action 02.0 <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-variable"><span class="hljs-variable">$_ip</span></span> eq <span class="hljs-string"><span class="hljs-string">"192.168.101.1"</span></span> action 03.0 <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> _name <span class="hljs-string"><span class="hljs-string">"ISP #1"</span></span> action 04.0 <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> _target_ip <span class="hljs-string"><span class="hljs-string">"192.168.103.3"</span></span> action 05.0 <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> _list <span class="hljs-string"><span class="hljs-string">"isp-2-out"</span></span> action 06.0 elseif <span class="hljs-variable"><span class="hljs-variable">$_ip</span></span> eq <span class="hljs-string"><span class="hljs-string">"192.168.103.3"</span></span> action 07.0 <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> _name <span class="hljs-string"><span class="hljs-string">"ISP #2"</span></span> action 08.0 <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> _target_ip <span class="hljs-string"><span class="hljs-string">"192.168.101.1"</span></span> action 09.0 <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> _list <span class="hljs-string"><span class="hljs-string">"isp-1-out"</span></span> action 10.0 <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> action 11.0 <span class="hljs-built_in"><span class="hljs-built_in">exit</span></span> action 12.0 end action 13.0 regexp <span class="hljs-string"><span class="hljs-string">"(Up|Down|reset)"</span></span> <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$_syslog_msg</span></span></span><span class="hljs-string">"</span></span> _match _state action 14.0 <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-variable"><span class="hljs-variable">$_state</span></span> eq <span class="hljs-string"><span class="hljs-string">"Up"</span></span> action 15.0 <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> _status <span class="hljs-string"><span class="hljs-string">"UP"</span></span> action 16.0 <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> action 17.0 <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> _status <span class="hljs-string"><span class="hljs-string">"DOWN"</span></span> action 18.0 <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> _list <span class="hljs-string"><span class="hljs-string">"full-list"</span></span> action 19.0 end action 20.0 syslog priority warnings msg <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$_name</span></span></span><span class="hljs-string"> now is </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$_status</span></span></span><span class="hljs-string"> !"</span></span> action 21.0 syslog priority warnings msg <span class="hljs-string"><span class="hljs-string">"Applying prefix list '</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$_list</span></span></span><span class="hljs-string">' to the neighbor </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$_target_ip</span></span></span><span class="hljs-string">"</span></span> action 22.0 cli <span class="hljs-built_in"><span class="hljs-built_in">command</span></span> <span class="hljs-string"><span class="hljs-string">"enable"</span></span> action 23.0 cli <span class="hljs-built_in"><span class="hljs-built_in">command</span></span> <span class="hljs-string"><span class="hljs-string">"configure terminal"</span></span> action 24.0 cli <span class="hljs-built_in"><span class="hljs-built_in">command</span></span> <span class="hljs-string"><span class="hljs-string">"router bgp 65000"</span></span> action 25.0 cli <span class="hljs-built_in"><span class="hljs-built_in">command</span></span> <span class="hljs-string"><span class="hljs-string">"address-family ipv4"</span></span> action 26.0 cli <span class="hljs-built_in"><span class="hljs-built_in">command</span></span> <span class="hljs-string"><span class="hljs-string">"neighbor </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$_target_ip</span></span></span><span class="hljs-string"> prefix-list </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$_list</span></span></span><span class="hljs-string"> out"</span></span> action 27.0 cli <span class="hljs-built_in"><span class="hljs-built_in">command</span></span> <span class="hljs-string"><span class="hljs-string">"end"</span></span> action 28.0 syslog priority warnings msg <span class="hljs-string"><span class="hljs-string">"Soft clear BGP session </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$_target_ip</span></span></span><span class="hljs-string">"</span></span> action 29.0 cli <span class="hljs-built_in"><span class="hljs-built_in">command</span></span> <span class="hljs-string"><span class="hljs-string">"clear ip bgp </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$_target_ip</span></span></span><span class="hljs-string"> soft out"</span></span></code> </pre> <br><p>  Initially, both BGP sessions are active and the announcements are as follows: </p><br><pre> <code class="hljs vhdl">CSR#show ip bgp summary ... Neighbor V AS MsgRcvd MsgSent TblVer InQ OutQ Up/Down State/PfxRcd <span class="hljs-number"><span class="hljs-number">192.168</span></span>.<span class="hljs-number"><span class="hljs-number">101.1</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-number"><span class="hljs-number">65001</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-number"><span class="hljs-number">7</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">19</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-number"><span class="hljs-number">192.168</span></span>.<span class="hljs-number"><span class="hljs-number">103.3</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-number"><span class="hljs-number">65002</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-number"><span class="hljs-number">7</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">24</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> CSR#show ip bgp neighbors <span class="hljs-number"><span class="hljs-number">192.168</span></span>.<span class="hljs-number"><span class="hljs-number">101.1</span></span> advertised-routes ... Network <span class="hljs-keyword"><span class="hljs-keyword">Next</span></span> Hop Metric LocPrf Weight Path *&gt; <span class="hljs-number"><span class="hljs-number">172.16</span></span>.<span class="hljs-number"><span class="hljs-number">7.0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> <span class="hljs-number"><span class="hljs-number">192.168</span></span>.<span class="hljs-number"><span class="hljs-number">107.7</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">32768</span></span> ? *&gt; <span class="hljs-number"><span class="hljs-number">172.16</span></span>.<span class="hljs-number"><span class="hljs-number">8.0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> <span class="hljs-number"><span class="hljs-number">192.168</span></span>.<span class="hljs-number"><span class="hljs-number">108.8</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">32768</span></span> ? Total number <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> prefixes <span class="hljs-number"><span class="hljs-number">2</span></span> CSR#show ip bgp neighbors <span class="hljs-number"><span class="hljs-number">192.168</span></span>.<span class="hljs-number"><span class="hljs-number">103.3</span></span> advertised-routes ... Network <span class="hljs-keyword"><span class="hljs-keyword">Next</span></span> Hop Metric LocPrf Weight Path *&gt; <span class="hljs-number"><span class="hljs-number">172.16</span></span>.<span class="hljs-number"><span class="hljs-number">9.0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> <span class="hljs-number"><span class="hljs-number">192.168</span></span>.<span class="hljs-number"><span class="hljs-number">109.9</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">32768</span></span> ? Total number <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> prefixes <span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre> <br><p>  On the ISP # 2 network, our announcements are as follows: </p><br><pre> <code class="hljs matlab">R13&gt;show ip bgp ... Network Next Hop Metric LocPrf Weight Path *&gt; <span class="hljs-number"><span class="hljs-number">172.16</span></span><span class="hljs-number"><span class="hljs-number">.7</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.200</span></span><span class="hljs-number"><span class="hljs-number">.12</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">65001</span></span> <span class="hljs-number"><span class="hljs-number">65000</span></span> ? *&gt; <span class="hljs-number"><span class="hljs-number">172.16</span></span><span class="hljs-number"><span class="hljs-number">.8</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.200</span></span><span class="hljs-number"><span class="hljs-number">.12</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">65001</span></span> <span class="hljs-number"><span class="hljs-number">65000</span></span> ? *&gt;<span class="hljs-built_in"><span class="hljs-built_in">i</span></span> <span class="hljs-number"><span class="hljs-number">172.16</span></span><span class="hljs-number"><span class="hljs-number">.9</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.103</span></span><span class="hljs-number"><span class="hljs-number">.100</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">120</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">65000</span></span> ?</code> </pre> <br><p>  Traces from R11 go to our network as we need: </p><br><pre> <code class="hljs pgsql">R11#traceroute <span class="hljs-number"><span class="hljs-number">172.16</span></span><span class="hljs-number"><span class="hljs-number">.7</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> source <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.11</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Type</span></span> <span class="hljs-keyword"><span class="hljs-keyword">escape</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sequence</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abort</span></span>. Tracing the route <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-number"><span class="hljs-number">172.16</span></span><span class="hljs-number"><span class="hljs-number">.7</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> VRF <span class="hljs-keyword"><span class="hljs-keyword">info</span></span>: (vrf <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-type"><span class="hljs-type">name</span></span>/id, vrf <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> <span class="hljs-type"><span class="hljs-type">name</span></span>/id) <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.114</span></span><span class="hljs-number"><span class="hljs-number">.4</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> msec <span class="hljs-number"><span class="hljs-number">1</span></span> msec <span class="hljs-number"><span class="hljs-number">0</span></span> msec <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.134</span></span><span class="hljs-number"><span class="hljs-number">.13</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> msec <span class="hljs-number"><span class="hljs-number">0</span></span> msec <span class="hljs-number"><span class="hljs-number">1</span></span> msec <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.200</span></span><span class="hljs-number"><span class="hljs-number">.12</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> msec <span class="hljs-number"><span class="hljs-number">0</span></span> msec <span class="hljs-number"><span class="hljs-number">1</span></span> msec <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.121</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> msec <span class="hljs-number"><span class="hljs-number">1</span></span> msec <span class="hljs-number"><span class="hljs-number">1</span></span> msec <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.101</span></span><span class="hljs-number"><span class="hljs-number">.100</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> msec <span class="hljs-number"><span class="hljs-number">3</span></span> msec <span class="hljs-number"><span class="hljs-number">3</span></span> msec <span class="hljs-number"><span class="hljs-number">6</span></span> <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.107</span></span><span class="hljs-number"><span class="hljs-number">.7</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> msec * <span class="hljs-number"><span class="hljs-number">3</span></span> msec R11#traceroute <span class="hljs-number"><span class="hljs-number">172.16</span></span><span class="hljs-number"><span class="hljs-number">.9</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> source <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.11</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Type</span></span> <span class="hljs-keyword"><span class="hljs-keyword">escape</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sequence</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abort</span></span>. Tracing the route <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-number"><span class="hljs-number">172.16</span></span><span class="hljs-number"><span class="hljs-number">.9</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> VRF <span class="hljs-keyword"><span class="hljs-keyword">info</span></span>: (vrf <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-type"><span class="hljs-type">name</span></span>/id, vrf <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> <span class="hljs-type"><span class="hljs-type">name</span></span>/id) <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.114</span></span><span class="hljs-number"><span class="hljs-number">.4</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> msec <span class="hljs-number"><span class="hljs-number">0</span></span> msec <span class="hljs-number"><span class="hljs-number">1</span></span> msec <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.34</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> msec <span class="hljs-number"><span class="hljs-number">1</span></span> msec <span class="hljs-number"><span class="hljs-number">0</span></span> msec <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.103</span></span><span class="hljs-number"><span class="hljs-number">.100</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> msec <span class="hljs-number"><span class="hljs-number">3</span></span> msec <span class="hljs-number"><span class="hljs-number">3</span></span> msec <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.109</span></span><span class="hljs-number"><span class="hljs-number">.9</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> msec * <span class="hljs-number"><span class="hljs-number">2</span></span> msec</code> </pre> <br><p>  Now let's try to disable the peer with ISP # 1 from the provider.  As a result, one of the BGP sessions on our border goes to IDLE: </p><br><pre> <code class="hljs objectivec">CSR<span class="hljs-meta"><span class="hljs-meta">#show ip bgp summary ... Neighbor V AS MsgRcvd MsgSent TblVer InQ OutQ Up/Down State/PfxRcd 192.168.101.1 4 65001 0 0 1 0 0 00:00:10 Idle 192.168.103.3 4 65002 26 26 9 0 0 00:16:31 3</span></span></code> </pre> <br><p>  At the same time, in the log we see that as soon as the event <em>% BGP-5-NBR_RESET arose: Neighbor 192.168.101.1 reset (Peer closed the session)</em> , our applet worked and changed the prefix list: </p><br><pre> <code class="hljs pgsql">*Jul <span class="hljs-number"><span class="hljs-number">20</span></span> <span class="hljs-number"><span class="hljs-number">09</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">58.208</span></span>: %BGP<span class="hljs-number"><span class="hljs-number">-5</span></span>-NBR_RESET: Neighbor <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.101</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">reset</span></span> (Peer closed the <span class="hljs-keyword"><span class="hljs-keyword">session</span></span>) *Jul <span class="hljs-number"><span class="hljs-number">20</span></span> <span class="hljs-number"><span class="hljs-number">09</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">58.208</span></span>: %BGP<span class="hljs-number"><span class="hljs-number">-5</span></span>-ADJCHANGE: neighbor <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.101</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> Down Peer closed the <span class="hljs-keyword"><span class="hljs-keyword">session</span></span> *Jul <span class="hljs-number"><span class="hljs-number">20</span></span> <span class="hljs-number"><span class="hljs-number">09</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">58.214</span></span>: %HA_EM<span class="hljs-number"><span class="hljs-number">-4</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">LOG</span></span>: isp: ISP #<span class="hljs-number"><span class="hljs-number">1</span></span> now <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> DOWN ! *Jul <span class="hljs-number"><span class="hljs-number">20</span></span> <span class="hljs-number"><span class="hljs-number">09</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">58.214</span></span>: %HA_EM<span class="hljs-number"><span class="hljs-number">-4</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">LOG</span></span>: isp: Applying prefix list <span class="hljs-string"><span class="hljs-string">'full-list'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> the neighbor <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.103</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span> *Jul <span class="hljs-number"><span class="hljs-number">20</span></span> <span class="hljs-number"><span class="hljs-number">09</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">58.778</span></span>: %SYS<span class="hljs-number"><span class="hljs-number">-5</span></span>-CONFIG_I: Configured <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> console <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> vty0 (EEM:isp) *Jul <span class="hljs-number"><span class="hljs-number">20</span></span> <span class="hljs-number"><span class="hljs-number">09</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">58.879</span></span>: %HA_EM<span class="hljs-number"><span class="hljs-number">-4</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">LOG</span></span>: isp: Soft clear BGP <span class="hljs-keyword"><span class="hljs-keyword">session</span></span> <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.103</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span></code> </pre> <br><p>  Let's see what we are now announcing in the direction of ISP # 2: </p><br><pre> <code class="hljs vhdl">CSR#show ip bgp neighbors <span class="hljs-number"><span class="hljs-number">192.168</span></span>.<span class="hljs-number"><span class="hljs-number">103.3</span></span> advertised-routes ... Network <span class="hljs-keyword"><span class="hljs-keyword">Next</span></span> Hop Metric LocPrf Weight Path *&gt; <span class="hljs-number"><span class="hljs-number">172.16</span></span>.<span class="hljs-number"><span class="hljs-number">7.0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> <span class="hljs-number"><span class="hljs-number">192.168</span></span>.<span class="hljs-number"><span class="hljs-number">107.7</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">32768</span></span> ? *&gt; <span class="hljs-number"><span class="hljs-number">172.16</span></span>.<span class="hljs-number"><span class="hljs-number">8.0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> <span class="hljs-number"><span class="hljs-number">192.168</span></span>.<span class="hljs-number"><span class="hljs-number">108.8</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">32768</span></span> ? *&gt; <span class="hljs-number"><span class="hljs-number">172.16</span></span>.<span class="hljs-number"><span class="hljs-number">9.0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> <span class="hljs-number"><span class="hljs-number">192.168</span></span>.<span class="hljs-number"><span class="hljs-number">109.9</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">32768</span></span> ? Total number <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> prefixes <span class="hljs-number"><span class="hljs-number">3</span></span></code> </pre> <br><p>  Those.  now we announce through ISP # 2 all our prefixes.  Here is what it looks like now on R13: </p><br><pre> <code class="hljs matlab">R13&gt;show ip bgp ... Network Next Hop Metric LocPrf Weight Path *&gt;<span class="hljs-built_in"><span class="hljs-built_in">i</span></span> <span class="hljs-number"><span class="hljs-number">172.16</span></span><span class="hljs-number"><span class="hljs-number">.7</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.103</span></span><span class="hljs-number"><span class="hljs-number">.100</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">120</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">65000</span></span> ? *&gt;<span class="hljs-built_in"><span class="hljs-built_in">i</span></span> <span class="hljs-number"><span class="hljs-number">172.16</span></span><span class="hljs-number"><span class="hljs-number">.8</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.103</span></span><span class="hljs-number"><span class="hljs-number">.100</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">120</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">65000</span></span> ? *&gt;<span class="hljs-built_in"><span class="hljs-built_in">i</span></span> <span class="hljs-number"><span class="hljs-number">172.16</span></span><span class="hljs-number"><span class="hljs-number">.9</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.103</span></span><span class="hljs-number"><span class="hljs-number">.100</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">120</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">65000</span></span> ?</code> </pre> <br><p>  And all traces to our network go through one provider. </p><br><p>  When restoring a BGP session with IPS # 1, the applet will again return the prefix list for ISP # 2 to its original position. </p><br><h1>  Conclusion </h1><br><p>  The purpose of this article was to briefly review the use of Cisco EEM to manage incoming traffic while balancing several uplinks, and hopefully it did.  Of course, this method can hardly be called optimal.  Rather, this decision is "in the forehead."  However, it works and provides a certain degree of fault tolerance.  For writing a note, the entire scheme was collected in <a href="http://www.unetlab.com/"><em>UNELAB</em></a> on Cisco IOL and Cisco CSRv1000 images.  Configurations of all devices from the considered example can be downloaded <a href="">here</a> . </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/306178/">https://habr.com/ru/post/306178/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../306164/index.html">App Intro using YouTube videos</a></li>
<li><a href="../306166/index.html">Effective use of Github</a></li>
<li><a href="../306168/index.html">Software update and initial setup instructions for Nokia 7750 (SR-7 | SR-12)</a></li>
<li><a href="../306170/index.html">Mango CRM System Overview</a></li>
<li><a href="../306176/index.html">HTTPoxy vulnerability can redirect web application http requests</a></li>
<li><a href="../306180/index.html">Networks For The Littlest. Micro issue ‚Ññ6. MPLS L3VPN and Internet Access</a></li>
<li><a href="../306182/index.html">Safety of railways from open sources</a></li>
<li><a href="../306184/index.html">Top Machine Learning Packages in R, Part 2</a></li>
<li><a href="../306186/index.html">How to represent your own company</a></li>
<li><a href="../306188/index.html">Development for SailfishOS: Basics</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>