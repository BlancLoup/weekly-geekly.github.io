<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>MQTT, smart home, ESP-8266 and Plug & Play</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Creating a smart home involves a lot of different sensors that monitor the situation in the house - motion, lighting, temperature and other sensors. I...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>MQTT, smart home, ESP-8266 and Plug & Play</h1><div class="post__text post__text-html js-mediator-article">  Creating a smart home involves a lot of different sensors that monitor the situation in the house - motion, lighting, temperature and other sensors.  If the ‚Äúsmart home‚Äù is small, then everything looks simple even with home-made systems based on open solutions (MQTT, OpenHAB, etc.) - they hooked up the sensor, registered it in the OpenHAB or HomeAssistant program and started working.  But if there are many sensors, a lot of routine and thankless work appears on prescribing each of them in the control system. <br><br>  The proposed solution (‚Äúcrutch‚Äù) allows to manage a minimum of manual operations at this stage.  The sensor controller connects to the MQTT broker and tells about its sensors and devices in a specific format in special topics, then a small script on the smart home server creates configuration files corresponding to these sensors, then you only need to manually define them in the home-specific groups and start creating management scripts. <br><br>  Specifically, this firmware works on modules with ESP-8266 (including the Sonoff Basic Switch and Sonoff Touch Wallswitch) with P &amp; P scripts for OpenHAB and HomeAssistant, but the way of issuing plug &amp; play information can be used in other projects. <br><a name="habracut"></a><br>  When a device is connected to the MQTT broker, topic views are created (in this case, for the FLASH button on ESP-8266 with the serial number 0023CB541): 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ul><li>  / myhome / PNP / ESPX-0023CB541 / BUTTON / name ‚Äî name / description (‚ÄúFLASH button‚Äù - so it will be displayed in the web interface) </li><li>  / myhome / PNP / ESPX-0023CB541 / BUTTON / type - the type of variable and the direction of data flow for it, ‚ÄúO: Switch‚Äù denotes a sensor that provides information, and, for example, ‚ÄúI: Dimmer‚Äù - an incoming dimmer channel </li><li>  / myhome / PNP / ESPX-0023CB541 / BUTTON / groups - groups in which this variable will appear by default ("Switches Builtin Buttons") </li><li>  / myhome / PNP / ESPX-0023CB541 / BUTTON / min - the minimum value (for numeric variables, for the button it will be empty) </li><li>  / myhome / PNP / ESPX-0023CB541 / BUTTON / max - maximum value (similarly) </li></ul><br>  Script running on the server (by cron or manually, after connecting the device) - downloads a list of topics from / myhome / PNP, searches for devices missing in OpenHAB and creates configuration files for them.  If there is already a configuration file for such a device, then the P &amp; P information is completely ignored, but you can delete this file, if necessary, re-create the file for a device with a changed set of sensors. <br><br>  So this is a simple and transparent way - we get rid of a rather big headache if you need to connect a large number of network-controlled devices in our homemade smart home. <br><br>  A little more detail will tell about the actual firmware for ESP-8266.  Its source codes (and support scripts for OpenHAB and HomeAssistant) can be found <a href="https://github.com/vasimv/esp-sensors">on Github</a> (specifically the support scripts are <a href="https://github.com/vasimv/esp-sensors/tree/master/PnP-scripts">here</a> ). <br><br>  It works on standard ESP-8266 modules (as well as Sonoff Basic Switch and Sonoff Touch Wallswitch), supports firmware upgrade on the fly (ArduinoOTA), and also has a simple web server for initial configuration of WiFi network parameters and setting the MQTT IP address -broker. <br><br>  The firmware structure is modular and you can add your sensors / devices quite easily.  The current list includes: <br><br><ul><li>  Infrared motion sensors and radio motion sensor Parallax X-band motion detector (up to 3 pieces per module) </li><li>  Temperature / humidity sensor DHT22 or equivalent </li><li>  <a href="https://habr.com/post/402155/">My Modbus / RS-485 4 Channel Dimmer</a> </li><li>  Sonars HC-SR04 and MaxBotix sonars with sequential output </li><li>  Relays on the Sonoff Basic Switch and Sonoff Touch (the latter can be switched both to the relay control mode by a button, and only through OpenHAB / HomeAssistant) </li><li>  Built-in ADC, LED and Flash button (for Sonoff Touch, this is a touch-sensitive button) </li><li>  A simple thermostat with two relays for controlling a fan (indoor unit) and a compressor (outdoor unit) </li></ul><br>  It should be noted that due to the lack of pins on the ESP-8266, the modules may conflict with each other (for example, a dimmer with a sonar can not be connected at the same time, unless you redistribute the pins yourself). <br><br>  After selecting the necessary devices in esp-sensors.h, compilation and firmware - the module will switch to configuration mode - will raise its WiFi network with a name like ‚Äúespx-0023cb541‚Äù to which you need to connect (you can use any smartphone) with a password from the same file then go to 192.168.4.1 and set the network login and password, as well as the broker's IP address.  These parameters will remain in the flush, so that you do not need to do this a second time.  If it is impossible to connect to the specified network for one minute, it will switch back to the configuration mode for three minutes and then repeat this cycle until a successful connection. <br><br>  For those who are going to edit this firmware, I will mention that each sensor / device module is divided into six functions: <br><br><ul><li>  setup _ * () - pin configuration </li><li>  loop _ * () - polling the sensor on each program cycle </li><li>  refresh _ * (forceSend) - refreshing sensor status information on MQTT (200 ms by default, and every two seconds - forced refresh) </li><li>  pnp _ * () - sending P &amp; P information </li><li>  subscribe _ * () - a subscription to the necessary incoming topics </li><li>  mqtt _ * () - processing incoming mqtt messages </li></ul><br>  These functions need to be defined in the file of your module, then add their call to the appropriate locations of esp-sensors.ino. </div><p>Source: <a href="https://habr.com/ru/post/432730/">https://habr.com/ru/post/432730/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../432720/index.html">China banned Apple</a></li>
<li><a href="../432722/index.html">Check out, 70% ready turbojet hoverboard</a></li>
<li><a href="../432724/index.html">Shining 3D EinScan Pro 2X Plus 3D Scanner Review</a></li>
<li><a href="../432726/index.html">Processor Design (CPU Design) RAM Machine</a></li>
<li><a href="../432728/index.html">Vulnerability in the API API reveals 52.5 million private data.</a></li>
<li><a href="../432732/index.html">My experience in implementing 1C (part 1. Introduction)</a></li>
<li><a href="../432734/index.html">Twisted in the clouds: prospects for development and the reverse side of cloud-services</a></li>
<li><a href="../432736/index.html">Devops, JUnit5 and microservice testing: a subjective view of Moscow ‚ÄúHeisenbag‚Äù</a></li>
<li><a href="../432740/index.html">"CMS" based on Google Spreadsheets for static sites</a></li>
<li><a href="../432742/index.html">Corporate time trouble</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>