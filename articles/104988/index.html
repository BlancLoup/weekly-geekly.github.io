<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Writing Your OS: Release 2</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello. This again we, iley and pehat , with the long-awaited second article from the series ‚ÄúWriting our OS‚Äù (the first article is here ). We apologiz...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Writing Your OS: Release 2</h1><div class="post__text post__text-html js-mediator-article">  Hello.  This again we, <a href="https://habrahabr.ru/users/iley/" class="user_link">iley</a> and <a href="https://habrahabr.ru/users/pehat/" class="user_link">pehat</a> , with the long-awaited second article from the series ‚ÄúWriting our OS‚Äù (the first article is <a href="http://habrahabr.ru/blogs/system_programming/101810/">here</a> ).  We apologize for the big pause after the first article, it took us some time to determine the future direction of our work.  In this release, we will briefly review the protected mode of 32-bit Intel processors.  Once again, we emphasize that we are not aiming at giving exhaustive theoretical data. <br><a name="habracut"></a><br>  Let's remember for a moment our program from the previous issue.  It was launched instead of the operating system and displayed the message ‚ÄúHello world‚Äù.  The program was written in a 16-bit assembler and worked in the so-called <strong>real mode</strong> .  As you probably know, when addressing in real mode, the physical address is formed using a <strong>segment</strong> and <strong>offset</strong> and has a dimension of 20 bits.  Simple math tells us that this way you can access the entire megabyte of RAM. <br><br>  The small amount of available memory is not the only problem in real mode.  Imagine a situation where the operating system and several application programs are in memory at the same time.  In real mode, nothing prevents any of the application programs from contacting an address belonging to another program or even an operating system.  Thus, an error in one program can lead to the collapse of the entire system. <br><br>  To solve these two problems, Intel at one time developed a new, much more complicated way of addressing RAM.  More precisely, Intel developed even several ways of addressing, and all of them are known under the collective name of <strong>protected mode</strong> . 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      So, addressing in protected mode can occur in one of three modes (sorry for tautology) - in segment, page and segment-page.  In this issue, we will look at segment mode only. <br><br>  In the <strong>segment mode</strong> in memory are allocated, oddly enough, segments.  These segments are significantly different from the simple and familiar segments of the real mode.  In this case, a segment is a continuous memory area, which is characterized by a base, a limit (that is, roughly speaking, size) and some additional attributes.  The base is, roughly speaking, the physical address from which the segment begins (in fact, this is not a physical address, but the so-called linear address, but more on that later).  It is important to note that, unlike the real mode segments, our segments can be of arbitrary size.  The base, size and attributes of each segment are stored in the <strong>descriptor</strong> .  The descriptors are stored in special tables, and <strong>selectors</strong> are used to select a specific descriptor from the table.  Do not be alarmed by such a heap of new scary words, we will now sort everything out. <br><br>  So, each time a memory is accessed, the processor takes a register (for example, CS), a selector, finds the desired descriptor in the table, extracts the segment start address from the descriptor, adds an offset to the start address and gets a linear address (note that and the physical address is different things, but at this stage it can be assumed that they are one and the same).  In addition, the processor checks whether the received address is out of the segment boundary and whether segment attributes allow access to it at the moment.  The scheme for calculating the linear address looks like this: <br><br><img src="https://habrastorage.org/storage/c3694475/106b05ae/58a6a11b/cabff4cb.png"><br><br>  So, as we have already said, the base (base address), the size (segment limit) and any additional segment attributes are stored in the descriptor.  Let's take a look at the descriptor scheme. <br><br><img src="https://habrastorage.org/storage/8e529fd3/84a5ec8e/5524c950/b35ef29c.png"><br><br>  Please note that under the base 32 bits are allocated, and under the limit of only 20. How is it - you ask - is it impossible to create a segment whose size will be larger than a megabyte?  Can.  To do this, use a simple trick.  If the <strong>G</strong> bit is set to one, then the limit is considered not in bytes, but in blocks of 4 KB.  It should be noted that the limit contains the size of the segment minus one in units of granularity, i.e.  if the limit is 0, then the segment has a size of 1 byte or 4 KB.  In addition, as you can see, the descriptor includes several more fields.  Their detailed description can be found, for example, <a href="http://wasm.ru/publist.php%3Flist%3D24">here</a> . <br><br>  As mentioned, the descriptors are stored in special tables.  There may be several tables, but in any case <strong>GDT</strong> is required in the memory - a global table of descriptors.  It is one for the entire operating system.  In turn, each task, that is, a process, can have zero, one, or several <strong>LDT</strong> ‚Äî local descriptor tables.  The address and size of the GDT is stored in the <strong>GDTR register</strong> , the current LDT is in the <strong>LDTR</strong> register.  For now, LDT is not needed.  In addition, there are still <strong>IDT</strong> - tables of interrupt descriptors, but we will postpone their consideration until the next release. <br><br>  To select a descriptor from a table, a data structure called a selector is used.  Here is what it looks like: <br><br><img src="https://habrastorage.org/storage/cf3e4385/0e9d66b7/8916afe5/7cc66d40.png"><br><br>  The selector contains a bit that indicates in which table to search for a descriptor, local or global (L / G) and the actual descriptor number (descriptor number).  In addition, the selector has an RPL field, but it does not interest us yet. <br><br>  So let's get down to business! <br><br><blockquote><code><font color="#666666">;16- ,      </font> <br> <font color="#000000">use16</font> <br> <font color="#000000">org</font> <font color="#0000ff">0x7c00</font> <br> start <font color="#339933">:</font> <br> <font color="#00007f">jmp</font> <font color="#0000ff">0x0000</font> <font color="#339933">:</font> entry <font color="#666666">; CS=0, IP=0x7c00</font> <br> entry <font color="#339933">:</font> <br> <font color="#00007f">mov</font> <font color="#00007f">ax</font> <font color="#339933">,</font> <font color="#00007f">cs</font> <br> <font color="#00007f">mov</font> <font color="#00007f">ds</font> <font color="#339933">,</font> <font color="#00007f">ax</font> <br> <br> <font color="#666666">; </font> <br> <font color="#00007f">mov</font> <font color="#00007f">ax</font> <font color="#339933">,</font> <font color="#0000ff">0x0003</font> <br> <font color="#00007f">int</font> <font color="#0000ff">0x10</font> <br> <br> <font color="#666666">; A20</font> <br> <font color="#00007f">in</font> <font color="#00007f">al</font> <font color="#339933">,</font> <font color="#0000ff">0x92</font> <br> <font color="#00007f">or</font> <font color="#00007f">al</font> <font color="#339933">,</font> <font color="#0000ff">2</font> <br> <font color="#00007f">out</font> <font color="#0000ff">0x92</font> <font color="#339933">,</font> <font color="#00007f">al</font> <br> <br> <font color="#666666">;    GDT  GDTR</font> <br> <font color="#00007f">lgdt</font> <font color="#009900">[</font> gdtr <font color="#009900">]</font> <br> <font color="#666666">; </font> <br> <font color="#00007f">cli</font> <br> <font color="#666666">;  </font> <br> <font color="#00007f">in</font> <font color="#00007f">al</font> <font color="#339933">,</font> <font color="#0000ff">0x70</font> <br> <font color="#00007f">or</font> <font color="#00007f">al</font> <font color="#339933">,</font> <font color="#0000ff">0x80</font> <br> <font color="#00007f">out</font> <font color="#0000ff">0x70</font> <font color="#339933">,</font> <font color="#00007f">al</font> <br> <br> <font color="#666666">;   </font> <br> <font color="#00007f">mov</font> <font color="#00007f">eax</font> <font color="#339933">,</font> <font color="#00007f">cr0</font> <br> <font color="#00007f">or</font> <font color="#00007f">al</font> <font color="#339933">,</font> <font color="#0000ff">1</font> <br> <font color="#00007f">mov</font> <font color="#00007f">cr0</font> <font color="#339933">,</font> <font color="#00007f">eax</font> <br> <br> <font color="#666666">;  CS:EIP     </font> <br> O32 <font color="#00007f">jmp</font> <font color="#0000ff">00001000b</font> <font color="#339933">:</font> pm_entry <br> <br> <font color="#666666">;32- </font> <br> <font color="#000000">use32</font> <br> <font color="#666666">;    </font> <br> pm_entry <font color="#339933">:</font> <br> <font color="#666666">;   ( SS)</font> <br> <font color="#00007f">mov</font> <font color="#00007f">ax</font> <font color="#339933">,</font> <font color="#00007f">cs</font> <br> <font color="#00007f">mov</font> <font color="#00007f">ds</font> <font color="#339933">,</font> <font color="#00007f">ax</font> <br> <font color="#00007f">mov</font> <font color="#00007f">es</font> <font color="#339933">,</font> <font color="#00007f">ax</font> <br> <br> <font color="#00007f">mov</font> <font color="#00007f">edi</font> <font color="#339933">,</font> <font color="#0000ff">0xB8000</font> <font color="#666666">;    0x3</font> <br> <font color="#00007f">mov</font> <font color="#00007f">esi</font> <font color="#339933">,</font> msg <font color="#666666">; </font> <br> <font color="#00007f">cld</font> <br> <font color="#339933">.</font> <font color="#00007f">loop</font> <font color="#666666">;  </font> <br> <font color="#00007f">lodsb</font> <font color="#666666">;   </font> <br> <font color="#00007f">test</font> <font color="#00007f">al</font> <font color="#339933">,</font> <font color="#00007f">al</font> <font color="#666666">;  0</font> <br> <font color="#00007f">jz</font> <font color="#339933">.</font> <font color="#000000">exit</font> <font color="#666666">; </font> <br> <font color="#00007f">stosb</font> <font color="#666666">;   </font> <br> <font color="#00007f">mov</font> <font color="#00007f">al</font> <font color="#339933">,</font> <font color="#0000ff">7</font> <font color="#666666">;    </font> <br> <font color="#00007f">stosb</font> <br> <font color="#00007f">jmp</font> <font color="#339933">.</font> <font color="#00007f">loop</font> <br> <font color="#339933">.</font> <font color="#000000">exit</font> <br> <br> <font color="#00007f">jmp</font> $ <font color="#666666">;</font> <br> <br> msg <font color="#339933">:</font> <br> <font color="#000000">db</font> <font color="#7f007f">'Hello World!'</font> <font color="#339933">,</font> <font color="#0000ff">0</font> <br> <br> <font color="#666666">;  .</font> <br> <font color="#666666">;   !</font> <br> gdt <font color="#339933">:</font> <br> <font color="#000000">db</font> <font color="#0000ff">0x00</font> <font color="#339933">,</font> <font color="#0000ff">0x00</font> <font color="#339933">,</font> <font color="#0000ff">0x00</font> <font color="#339933">,</font> <font color="#0000ff">0x00</font> <font color="#339933">,</font> <font color="#0000ff">0x00</font> <font color="#339933">,</font> <font color="#0000ff">0x00</font> <font color="#339933">,</font> <font color="#0000ff">0x00</font> <font color="#339933">,</font> <font color="#0000ff">0x00</font> <br> <font color="#000000">db</font> <font color="#0000ff">0xFF</font> <font color="#339933">,</font> <font color="#0000ff">0xFF</font> <font color="#339933">,</font> <font color="#0000ff">0x00</font> <font color="#339933">,</font> <font color="#0000ff">0x00</font> <font color="#339933">,</font> <font color="#0000ff">0x00</font> <font color="#339933">,</font> <font color="#0000ff">10011010b</font> <font color="#339933">,</font> <font color="#0000ff">11001111b</font> <font color="#339933">,</font> <font color="#0000ff">0x00</font> <br> gdt_size <font color="#000000">equ</font> $ <font color="#339933">-</font> gdt <br> <br> <font color="#666666">;,    GDTR</font> <br> gdtr <font color="#339933">:</font> <br> <font color="#000000">dw</font> gdt_size <font color="#339933">-</font> <font color="#0000ff">1</font> <br> <font color="#000000">dd</font> gdt <br> <br> finish <font color="#339933">:</font> <br> times <font color="#0000ff">0x1FE</font> <font color="#339933">-</font> finish <font color="#339933">+</font> start <font color="#000000">db</font> <font color="#0000ff">0</font> <br> <font color="#000000">db</font> <font color="#0000ff">0x55</font> <font color="#339933">,</font> <font color="#0000ff">0xAA</font> <font color="#666666">;   </font></code> </blockquote> <br><br>  Now we will explain the code a little. <br><br>  In the rows: <br><blockquote> <code><font color="#00007f">in</font> <font color="#00007f">al</font> <font color="#339933">,</font> <font color="#0000ff">0x92</font> &lt;br/&gt; <br> <font color="#00007f">or</font> <font color="#00007f">al</font> <font color="#339933">,</font> <font color="#0000ff">2</font> &lt;br/&gt; <br> <font color="#00007f">out</font> <font color="#0000ff">0x92</font> <font color="#339933">,</font> <font color="#00007f">al</font></code> </blockquote> <br>  The A20 address line is unlocked.  What does it mean?  Recall that in real mode you can address 1 MB of memory in the <code>:</code> format (20 bits per address).  However, if you contact, for example, <code>FFFF:FFFF</code> , you can jump a little higher than this bar, and the resulting address will be 21 bits long.  In processors up to 80286, the older one (the twentieth, if counted from zero) was dropped, and therefore, for compatibility with old programs, they introduced blocking of the address line A20.  Currently, all operating systems operate in a secure mode, and therefore for the needs of addressing it is necessary to unblock this bit as soon as possible.  So it goes. <br><br>  After loading the address and the limit of the global table of descriptors in the GDTR register, there is a general ban on interruptions.  This is explained by the fact that all interrupt handlers work in real mode, and problems with addressing will start in protected mode.  So while strictly forbid interrupts. <br><br>  Enabling protected mode is done by setting the low-order bit of the <code>CR0</code> register.  Immediately after the transition to the protected mode, a certain uncertainty arises: in <code>CS:EIP</code> you need to set the entry point to the protected mode in the <code>:</code> format <code>:</code> , and we still have vestiges of the real mode there.  Therefore we execute the following instruction: <br><blockquote> <code>O32 <font color="#00007f">jmp</font> <font color="#0000ff">00001000b</font> <font color="#339933">:</font> pm_entry</code> </blockquote> <br>  Here, the prefix is ‚Äã‚Äãused to convert the bitness of the operand <code>O32</code> , which allows you to make a far unconditional transition with 32-bit offset.  Hurray, we can finally take advantage of the charms of protected mode! <br><br>  To run the program, you need to do the manipulations that completely coincide with those described in the <a href="http://habrahabr.ru/blogs/system_programming/101810/">first article</a> .  There you will find a list of references in case you want to learn more about protected mode. <br><br>  We didn‚Äôt have enough imagination for anything that demonstrates the real possibilities of protected mode, so again we output ‚ÄúHello, World!‚Äù, But using direct access to the video memory.  To make something beautiful, it would be convenient to use interrupts.  How to use them in protected mode will be the next article in our cycle.  And the second article ends here.  We will be glad to see your feedback and wishes. </div><p>Source: <a href="https://habr.com/ru/post/104988/">https://habr.com/ru/post/104988/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../104981/index.html">Pseudographics in Unix / Linux console. A little more user friendly than you could afford</a></li>
<li><a href="../104982/index.html">Free use of the designer for useful sites</a></li>
<li><a href="../104984/index.html">Mechanical arm is too easy to use.</a></li>
<li><a href="../104985/index.html">Patents for the ‚Äúservice‚Äù of the motherland</a></li>
<li><a href="../104986/index.html">In the English Wikipedia, the system reviews the article.</a></li>
<li><a href="../104989/index.html">By contra or worm principle</a></li>
<li><a href="../104991/index.html">IT quest</a></li>
<li><a href="../104992/index.html">Happy birthday google</a></li>
<li><a href="../104995/index.html">I warn users of Zver assembly and Radmin software</a></li>
<li><a href="../104997/index.html">Hexagonal Tetris</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>