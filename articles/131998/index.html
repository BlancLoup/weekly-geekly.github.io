<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Introduction to Template Haskell. Part 1. Required minimum</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This text is a translation of the Template Haskell documentation written by Bulat Ziganshin. Translation of the entire text is divided into several lo...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Introduction to Template Haskell. Part 1. Required minimum</h1><div class="post__text post__text-html js-mediator-article"><p>  <i>This text is a translation of the <a href="http://docs.google.com/uc%3Fid%3D0B4BgTwf_ng_TM2MxZjJjZjctMTQ0OS00YzcwLWE5N2QtMDI0YzE4NGUwZDM3">Template Haskell documentation</a> written by Bulat Ziganshin.</i>  <i>Translation of the entire text is divided into several logical parts to facilitate perception.</i>  <i>Further italics in the text - notes of the translator.</i> </p><br><br>  <a href="http://www.haskell.org/haskellwiki/Template_Haskell">Template Haskell</a> (further TH) is an extension of Haskell language intended for meta-programming.  It enables algorithmic construction of the program at the compilation stage.  This allows the developer to use various programming techniques that are not available in Haskell itself, such as macro-like extensions, user-directed optimization (for example, inlining), generalized programming (polytypic programming), generation of auxiliary data structures and functions from existing ones.  For example, the code <br><pre><code class="bash hljs">yell file line = fail ($(<span class="hljs-built_in"><span class="hljs-built_in">printf</span></span> <span class="hljs-string"><span class="hljs-string">"Error in file %s line %d"</span></span>) file line)</code> </pre> <br>  can be converted using th in <pre> <code class="bash hljs">yell file line = fail ((\x1 x2 -&gt; <span class="hljs-string"><span class="hljs-string">"Error in file "</span></span>++x1++<span class="hljs-string"><span class="hljs-string">" line "</span></span>++show x2) file line)</code> </pre> <br>  Another example is code <br><pre> <code class="bash hljs">data T = A Int String | B Integer | C $(deriveShow <span class="hljs-string"><span class="hljs-string">''</span></span>T)</code> </pre><br>  can be converted to <pre> <code class="bash hljs">data T = A Int String | B Integer | C instance Show T show (A x1 x2) = <span class="hljs-string"><span class="hljs-string">"A "</span></span>++show x1++<span class="hljs-string"><span class="hljs-string">" "</span></span>++show x2 show (B x1) = <span class="hljs-string"><span class="hljs-string">"B "</span></span>++show x1 show C = <span class="hljs-string"><span class="hljs-string">"C"</span></span></code> </pre><br>  In TH, Haskell code is generated by ordinary Haskell functions <i>(which I will call templates for clarity)</i> .  The minimum you need to know to use TH are the following topics: <br><ol><li>  How Haskell code is represented in templates (TH functions) </li><li>  How the citation monad is used to unify names </li><li>  How the generated TH code is inserted into the program </li></ol><a name="habracut"></a><br><br><h2>  How Haskell code is presented in templates </h2><br>  In Template Haskell, Haskell code fragments are represented using ordinary <a href="http://ru.wikipedia.org/wiki/%25D0%2590%25D0%25BB%25D0%25B3%25D0%25B5%25D0%25B1%25D1%2580%25D0%25B0%25D0%25B8%25D1%2587%25D0%25B5%25D1%2581%25D0%25BA%25D0%25B8%25D0%25B9_%25D1%2582%25D0%25B8%25D0%25BF_%25D0%25B4%25D0%25B0%25D0%25BD%25D0%25BD%25D1%258B%25D1%2585">algebraic data types</a> .  These types are built according to Haskell syntax and represent the <a href="http://ru.wikipedia.org/wiki/%25D0%2590%25D0%25B1%25D1%2581%25D1%2582%25D1%2580%25D0%25B0%25D0%25BA%25D1%2582%25D0%25BD%25D0%25BE%25D0%25B5_%25D1%2581%25D0%25B8%25D0%25BD%25D1%2582%25D0%25B0%25D0%25BA%25D1%2581%25D0%25B8%25D1%2587%25D0%25B5%25D1%2581%25D0%25BA%25D0%25BE%25D0%25B5_%25D0%25B4%25D0%25B5%25D1%2580%25D0%25B5%25D0%25B2%25D0%25BE">abstract syntax tree</a> (AST - abstract syntax tree) of a particular code.  There is an <a href="http://www.haskell.org/ghc/docs/latest/html/libraries/template-haskell-2.6.0.0/Language-Haskell-TH-Syntax.html"><code>Exp</code></a> type for expressions, <a href="http://www.haskell.org/ghc/docs/latest/html/libraries/template-haskell-2.6.0.0/Language-Haskell-TH-Syntax.html"><code>Pat</code></a> for samples, <a href="http://www.haskell.org/ghc/docs/latest/html/libraries/template-haskell-2.6.0.0/Language-Haskell-TH-Syntax.html"><code>Lit</code></a> for literals, <a href="http://www.haskell.org/ghc/docs/latest/html/libraries/template-haskell-2.6.0.0/Language-Haskell-TH-Syntax.html"><code>Dec</code></a> for declarations, <a href="http://www.haskell.org/ghc/docs/latest/html/libraries/template-haskell-2.6.0.0/Language-Haskell-TH-Syntax.html"><code>Type</code></a> for types, etc.  Definitions of all these types can be found in the documentation for the <a href="http://www.haskell.org/ghc/docs/latest/html/libraries/template-haskell-2.6.0.0/Language-Haskell-TH-Syntax.html"><code>Language.Haskell.TH.Syntax</code></a> module.  They are interconnected according to Haskell syntax rules, so using them you can construct values ‚Äã‚Äãrepresenting any Haskell code fragments.  Here are some simple examples: <br><ul><li><pre> <code class="haskell hljs"><span class="hljs-title"><span class="hljs-title">varx</span></span> = <span class="hljs-type"><span class="hljs-type">VarE</span></span> (mkName <span class="hljs-string"><span class="hljs-string">"x"</span></span>)</code> </pre>  represents the expression <code>x</code> , i.e.  simple variable ‚Äú <code>x</code> ‚Äù </li><li><pre> <code class="bash hljs">patx = VarP (mkName <span class="hljs-string"><span class="hljs-string">"x"</span></span>)</code> </pre>  represents sample <code>x</code> , i.e.  the same variable ‚Äú <code>x</code> ‚Äù used in the sample </li><li><pre> <code class="bash hljs">str = LitE (StringL <span class="hljs-string"><span class="hljs-string">"str"</span></span>)</code> </pre>  represents the constant expression <code>"str"</code> </li><li><pre> <code class="bash hljs">tuple = TupE [varx, str]</code> </pre>  represents a pair expression (tuple) <code>(x,"str")</code> </li><li><pre> <code class="bash hljs">LamE [patx] tuple</code> </pre>  represents the lambda expression <code>\x -&gt; (x,"str")</code> </li></ul>  To make our lives easier, the names of all <a href="http://www.haskell.org/ghc/docs/latest/html/libraries/template-haskell-2.6.0.0/Language-Haskell-TH-Syntax.html"><code>Exp</code></a> type constructors end with <code>E</code> , the names of <a href="http://www.haskell.org/ghc/docs/latest/html/libraries/template-haskell-2.6.0.0/Language-Haskell-TH-Syntax.html"><code>Pat</code></a> -type constructors end with <code>P</code> , etc.  The <code>mkName</code> function used above creates a value of type <a href="http://www.haskell.org/ghc/docs/latest/html/libraries/template-haskell-2.6.0.0/Language-Haskell-TH-Syntax.html"><code>Name</code></a> (representing identifiers) from a normal string ( <code>String</code> ), with its contents as a name. <br>  So, to create a Haskell code, the TH function must simply construct and return a value of type <a href="http://www.haskell.org/ghc/docs/latest/html/libraries/template-haskell-2.6.0.0/Language-Haskell-TH-Syntax.html"><code>Exp</code></a> <i>(you can also use <code>Dec</code> , <code>Pat</code> or <code>Type</code> )</i> , which is a representation for a given code fragment.  In fact, you do not need to thoroughly study the device of these types in order to know how to submit the Haskell code you need into them. In the section on debugging, I will tell you how to get a TH-representation of a specific Haskell code fragment. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h2>  How the citation monad is used to unify names </h2><br>  However, patterns are not pure functions that return a simple value of type <a href="http://www.haskell.org/ghc/docs/latest/html/libraries/template-haskell-2.6.0.0/Language-Haskell-TH-Syntax.html"><code>Exp</code></a> .  Instead, they are calculations in a special <a href="http://www.haskell.org/ghc/docs/latest/html/libraries/template-haskell-2.6.0.0/Language-Haskell-TH-Syntax.html"><code>Q</code></a> monad (called the qadtation monad citation monad), which allows you to automatically generate unique names for variables using the monadic function <a href="http://www.haskell.org/ghc/docs/latest/html/libraries/template-haskell-2.6.0.0/Language-Haskell-TH-Syntax.html"><code>newName</code></a> <code>:: String -&gt; Q Name</code> .  Each time it is called, a new unique name is generated with the given prefix.  This name can be used as part of a pattern (using the constructor <a href="http://www.haskell.org/ghc/docs/latest/html/libraries/template-haskell-2.6.0.0/Language-Haskell-TH-Syntax.html"><code>VarP</code></a> <code>:: Name -&gt; Pat</code> ) or an expression ( <a href="http://www.haskell.org/ghc/docs/latest/html/libraries/template-haskell-2.6.0.0/Language-Haskell-TH-Syntax.html"><code>VarE</code></a> <code>:: Name -&gt; Exp</code> ). <br>  Let's write a simple example - the <code>tupleReplicate</code> template, which, when used as follows: <code>‚Äú$(tupleReplicate n) x"</code> , returns an n-tuple with <code>x</code> at all positions (similar to the <code>replicate</code> function for lists). Note that <code>n</code> Is the template argument, and <code>x</code> is the argument of the generated anonymous function (lambda expression). I provide the code for the module containing the definition of this template (the <a href="http://www.haskell.org/ghc/docs/latest/html/libraries/template-haskell-2.6.0.0/Language-Haskell-TH.html"><code>Language.Haskell.TH</code></a> module provides all the tools needed for working with TH): <br><br><pre> <code class="bash hljs">module TupleReplicate <span class="hljs-built_in"><span class="hljs-built_in">where</span></span> import Language.Haskell.TH tupleReplicate :: Int -&gt; Q Exp tupleReplicate n = <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> id &lt;- newName <span class="hljs-string"><span class="hljs-string">"x"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> $ LamE [VarP id] (TupE $ replicate n $ VarE id)</code> </pre><br>  For example, calling ‚Äú <code>tupleReplicate 3</code> ‚Äù will return an <code>Exp</code> value equivalent to the Haskell expression ‚Äú <code>(\x -&gt; (x,x,x))</code> ‚Äù. <br><br><h2>  How the generated TH code is inserted into the program </h2><br>  A splice is written in the form of ‚Äú <code>$x</code> ‚Äù, where <code>x</code> is an identifier, or in the form of <code>$(...)</code> , where the ellipsis implies the corresponding expression.  It is important that there is no space between the <code>$</code> character and the identifier or brackets.  This use of <code>$</code> overrides the value of this symbol as an infix operator, as well as the qualified name <code>Mx</code> overrides the value of the function composition operator ‚Äú <code>.</code>  ".  If you need an operator, then the character must be surrounded by spaces. <br>  Insertion may appear in <br><ul><li>  expressions;  the pasted expression must be of type <code>Q Exp</code> . </li><li>  top level ads;  the pasted expression must be of type <code>Q [Dec]</code> .  Ads generated by the insert have access only to those identifiers that were previously declared in the code (which is not typical of regular Haskell programs, in which the order of ads does not matter). </li><li>  type;  the pasted expression must be of type <code>Q Type</code> . </li></ul><br>  You should also know that <br><ul><li>  When running GHC, you must use the <code>-XTemplateHakell</code> flag to enable the special TH syntax;  or you can include the directive <code>{-# LANGUAGE TemplateHaskell #-}</code> in the source code. </li><li>  You can only use the template from the outside.  That is, it is impossible to define a template in one module and immediately use it (paste it).  <i>(this is due to the fact that the template is not compiled by this moment)</i> </li></ul><br>  An example of a module that uses our <code>tupleReplicate</code> template: <br><br><pre> <code class="bash hljs">{-<span class="hljs-comment"><span class="hljs-comment"># LANGUAGE TemplateHaskell #-} module Test where import TupleReplicate main = do print ($(tupleReplicate 2) 1) --  (1,1) print ($(tupleReplicate 5) "x") --  ("x","x","x","x","x")</span></span></code> </pre><br><h2>  To be continued </h2><br>  The following sections will highlight more interesting and advanced topics: <br><ol><li>  Citation monad </li><li>  Quote brackets </li><li>  Materialization (reification) </li><li>  Error messages and recovery </li><li>  Debugging </li></ol>  and the examples of <code>printf</code> and <code>deriveShow</code> mentioned at the beginning are <code>deriveShow</code> . <br><br>  <i>PS This is my first translation, so I hope for constructive criticism and informative discussion on the topic of the article.</i> <br><br>  <b>UPDATE:</b> <br>  <a href="http://habrahabr.ru/blogs/Haskell/132679/">Part 2. Citation Tools</a> <br>  <a href="http://habrahabr.ru/blogs/Haskell/133009/">Part 3. Other aspects of TH</a> </div><p>Source: <a href="https://habr.com/ru/post/131998/">https://habr.com/ru/post/131998/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../131992/index.html">Inversion compact skin v2</a></li>
<li><a href="../131993/index.html">IoC, DI, IoC-container - Just a simple</a></li>
<li><a href="../131994/index.html">PHP and Aspect-oriented programming</a></li>
<li><a href="../131995/index.html">FireFox 8.0 Released</a></li>
<li><a href="../131996/index.html">New day - new language!</a></li>
<li><a href="../132000/index.html">Natural Docs + GitHub Pages = online auto-documentation for free (almost)</a></li>
<li><a href="../132004/index.html">RedBeanPHP - another ORM library</a></li>
<li><a href="../132006/index.html">Videos from our Qt-training for beginners</a></li>
<li><a href="../132008/index.html">Section "My things"</a></li>
<li><a href="../132009/index.html">Experience using the ThinkPad Tablet</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>