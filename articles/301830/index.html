<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Using the ceiling clock as an information board</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Preamble 


 At the end of 2013, our company moved to a new office in one of the towers of the Moscow-City complex. Inheritance from the past tenant o...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Using the ceiling clock as an information board</h1><div class="post__text post__text-html js-mediator-article"><h2>  Preamble </h2><br><p>  At the end of 2013, our company moved to a new office in one of the towers of the Moscow-City complex.  Inheritance from the past tenant of the premises we got a ceiling clock, designed to display the time in different time zones.  Apparently, the tenant was tied to the financial or banking sector. </p><br><p>  At first we tried to reconfigure the clock (to adjust the time and change the displayed cities), but we could not do it - there was a monolithic aluminum box on the ceiling without any controls.  In consequence, the clock was de-energized and remained hanging without signs of life.  Two years later, got the idea to revive the clock and use them as something more. </p><br><p><img src="https://habrastorage.org/files/213/98b/904/21398b90436049559cbef74b5c5fe18d.png" alt=" " title="Ceiling clock"></p><a name="habracut"></a><br><h2>  Device identification </h2><br><p>  The first problem on the way was the need to identify the device - we didn‚Äôt know neither the watch model nor their manufacturer.  No identification marks, stickers and engravings on the case of the device could not be found.  Documentation for the device was also missing. </p><br><p>  At this point, we concluded that to identify the device it is necessary to open the box, starting from the sides.  The heads of the bolts were damaged even during the first attempt of an autopsy two years ago.  One of the bolts could not be unscrewed - I had to break the corner of the panel.  Fortunately, it is made of soft aluminum, so that we managed to inflict minimal visual and structural damage to the structure. </p><br><p><img src="https://habrastorage.org/files/be4/86c/80d/be486c80db584357987e585b7adbe5ce.png" alt="Broken corner of the clock"><br>  <em>Broken corner</em> </p><br><p>  Inside was a web of wires and a scattering of control boards.  At one of them we were able to identify the name of the manufacturer of watches Wharton, on the site of which <a href="https://www.wharton.co.uk/time_zone_clocks/474_050.htm">our specimen</a> was identified by visual signs. </p><br><p><img src="https://habrastorage.org/files/9f0/071/659/9f0071659f754772bde3033a11206f0c.png" alt="Watch interiors"><br>  <em>Watch interiors</em> </p><br><p>  The manufacturer‚Äôs consumer support section is limited to the contact details of an organization headquartered in the UK.  After ten minutes of talking on the phone with the second line of support, we were sent instructions to the clock, where the procedure for setting the clock using the remote control was described in detail.  Remote tenants have not left us. </p><br><p>  After another ten minutes of conversation with the support service, they sent us a proprietary utility designed to adjust the clock, set time zones, set the signature over the sections, and also to synchronize the time.  The program communicates with the clock through the usual COM-port, which was kindly hidden by the installers under the false ceiling above the clock.  For our copy of the program has worked "with a bang." </p><br><p><img src="https://habrastorage.org/files/e4f/d31/b1c/e4fd31b1cac84995b26eb94895e8b6f0.png" alt="Wharton ZoneControl 1.7" title="Wharton ZoneControl 1.7"></p><br><p>  In the process of studying the insides of the clock, a set of jumpers was noticed on the control board of each section.  Having played with the utility and jumpers, we found out that they control the internal number of the section, which allows displaying the same information and time on different sections.  This feature is relevant to our bilateral sample - time and text are duplicated on both sides. </p><br><h2>  Watch management program </h2><br><p>  It's time to move on to the entertaining part of the exercise: an analysis of the algorithm of the setup program in order to write your own control program.  This task can be approached in several ways.  At first we considered the option of disassembling the official utility.  After several attempts to understand the assembler code, we decided to follow the path of reverse engineering of the data transfer protocol: to study and understand the data that is transmitted via the COM cable. </p><br><p><img src="https://habrastorage.org/files/d6c/1a5/d38/d6c1a5d388784bf1ae5d6e82bdd52b2a.png" alt="Wharton ZoneControl: HABR test 1"><br><img src="https://habrastorage.org/files/8c8/ad7/01f/8c8ad701fc5647559d9cca6e3ff29f30.png" alt="Wharton ZoneControl: HABR test 2"></p><br><p>  To study the commands transmitted via the COM port, we used the software HDD Software Device Monitoring Studio.  The program clings to the COM port installed in the system without disrupting its operation, removes the data transmitted on the port and automatically breaks it into data packets based on the delays between transmissions.  With the running studio, we removed the traffic from the tuning program to the clock: </p><br><p><img src="https://habrastorage.org/files/279/84f/e61/27984fe61be740d8ade214533f9dc0ce.png" alt="Traffic on the COM port"></p><br><p>  For the purposes of the project, the change of the time zone is not required, because only the first part of the request was studied in detail.  The trial and error method was able to parse the structure of the first part of the query in more detail: </p><br><p><img src="https://habrastorage.org/files/058/8af/5a2/0588af5a2dc24d53a1d612a9d6966eb1.png" alt="Breakdown of the data package"></p><br><p> The beginning and end of a command are constant values ‚Äã‚Äãfor all commands.  In the ASCII table, these codes correspond to the characters "beginning of the text" and "end of the text."  The board code makes sense if several boards are chained together.  In our case, the scoreboard is only one, because for us the meaning is constant.  There are several command codes (‚Äúset text‚Äù, ‚Äúset time zone‚Äù, ‚Äúsynchronize time‚Äù), for our project only ‚Äú <code>0x83</code> - set text‚Äù is used.  For the section number, use the value according to the formula: <code>0x80 + _ ‚Äì 1</code> . </p><br><p>  For section text, the conversion rule is used: <code>0x80 | ord()</code>  <code>0x80 | ord()</code> .  The clock supports a small set of characters to display: numbers, Latin lowercase and uppercase characters, a space, special characters and punctuation.  The Cyrillic alphabet is not sewn into the system.  The length of the text is limited to ten characters and is constant.  If the length of the displayed string is less than ten characters, it is necessary to ‚Äúfinish‚Äù the string to the full length with spaces.  When displaying text on a clock, spaces at the beginning and end of a line are ignored, and the text itself is centered when rendering.  If the character code is not supported, the ‚Äú!‚Äù Symbol is displayed. </p><br><p>  The check digit is present at the end of each command.  For the team we are interested in, the formula for calculating the check digit is a character XOR for the text and the section number (already encoded).  For the received value, the high and low octets are written into separate bytes of the control bit of the message.  Visual example: </p><br><p><img src="https://habrastorage.org/files/2fa/e2c/446/2fae2c4468ea4bd0a025fb326ac63655.png" alt="formation of the check digit"></p><br><p>  Checking the correctness of the algorithm was carried out through a proof-of-concept script written in PHP, which writes the appropriate commands directly to the COM port.  Using this script, we clarified the minimum allowable delays between commands, in particular, managed to minimize the delay between commands from one second (standard in the program from the supplier) to 300 ms, and also checked the alphabet supported by the clock. </p><br><h2>  Access to the clock on the network </h2><br><p>  Interaction with the watch program was only one part of the problem, albeit the most difficult.  To ensure the success of the project, it was necessary to be able to send control commands to the watch via the network.  In the end, we could not leave the test notebook connected to the 24x7 clock. <br>  To implement a network connection, it was decided to create a simple C # program that opens a TCP port and waits for a connection from the outside.  When receiving a command over the network, the program performs the following operations: </p><br><ol><li>  sets a lock (to avoid parallel work with the clock); </li><li>  opens a local COM port on which the clock hangs; </li><li>  sends the command; </li><li>  closes the port; </li><li>  waiting for the preset time (as set above - 300 ms); </li><li>  removes the lock; </li><li>  sends confirmation of command execution. </li></ol><br><p>  Initially, the idea was to provide a direct connection to the COM port over the network (that is, to implement a <a href="http://tcp2com.sourceforge.net/">tcp2com solution</a> ).  This approach could allow you to send any commands to the clock and experiment with the device.  But in the end, this idea was abandoned in favor of the implementation of a service program that implements all the logic of encoding and controlling the clock. </p><br><p><img src="https://habrastorage.org/files/463/eb9/ad9/463eb9ad929c4b7b85d681f5d48d0abb.png" alt="  " title="Samopisnaya management program"></p><br><p>  The compiled program implements the XML interface, accepts requests through the standard for C # <code>HttpListener</code> .  The format of messages over the network implies the indication of the section for setting and the displayed text: </p><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">setTextXML</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">section</span></span></span><span class="hljs-tag">&gt;</span></span>[section number]<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">section</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">text</span></span></span><span class="hljs-tag">&gt;</span></span>[section text]<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">text</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">setTextXML</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><p>  The written program was installed on a Windows server locked in a technical office room.  Since the server is at some distance, we dragged 10 meters of CAT5-wires under the false ceiling from the clock to the utility room.  CAT5 cable was used as a signal COM cable (only two wires were used).  There were worries that ten meters of wire for a watch is too much, but, fortunately, the connection worked without problems.  The Windows server itself is connected to the company's internal network and has a static address.  Simple testing from a browser on the internal network confirmed the connection and correct operation of both the program and the connection with the clock. </p><br><h2>  Display of useful information </h2><br><p>  The clock is connected and is now available on the network as a web service.  It's time to display useful information! </p><br><p>  To integrate with external data sources, we took SAP Process Integration 7.4 corporate bus deployed in our office.  At the time of launching the project, we took three data sources: </p><br><ol><li>  Central Bank of Russia; </li><li>  Weather Russia; </li><li>  Yandex.Probki. </li></ol><br><p>  The SAP PI system polls external sources on a schedule, converts data, and then transmits the result to the clock. </p><br><p>  For the Central Bank, we take away once an hour the latest published data on the euro and US dollars.  For the Hydrometeorological Center, once every 15 minutes, we retrieve information from a weather station located near the Kievskaya metro station - the closest weather station in open access to our office.  Of the available attributes, we display only the temperature and relative humidity of the air.  For the Yandex.Traffic service, an update occurs every 15 minutes and displays the current state of congestion for Moscow as a whole. </p><br><p>  And now - photo finish! </p><br><p><img src="https://habrastorage.org/files/b08/d86/83b/b08d8683bd4945a1b498a4ca4e2bb9c6.jpeg" alt="Information table"></p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/301830/">https://habr.com/ru/post/301830/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../301816/index.html">Are the "top" sites safe: exploring Alexa ranking</a></li>
<li><a href="../301820/index.html">Postgres in Chinese or setting Full Text Search in Postgres for Chinese</a></li>
<li><a href="../301822/index.html">Websocket in production</a></li>
<li><a href="../301826/index.html">Dropbox explained why it is embedded in the operating system kernel</a></li>
<li><a href="../301828/index.html">DevConf :: Hackathon by Yii at TASS June 18-19, 2016</a></li>
<li><a href="../301834/index.html">Semantic gap "The Semantic Gap"</a></li>
<li><a href="../301836/index.html">A piece of space in your pocket: the results of the experiment</a></li>
<li><a href="../301838/index.html">Reversing the Android client of the music service Zaycev.net and implementing api on go</a></li>
<li><a href="../301840/index.html">Autofill: what web developers don't know, although they should know</a></li>
<li><a href="../301842/index.html">Urban design: 4 lectures on the creation of navigation schemes in the subway and not only</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>