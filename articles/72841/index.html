<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Trivialities that make life easier</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Postgresql is without a doubt a great DBMS. It has extensive features, excellent documentation, and with all this is free. However, there is always so...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Trivialities that make life easier</h1><div class="post__text post__text-html js-mediator-article">  Postgresql is without a doubt a great DBMS.  It has extensive features, excellent documentation, and with all this is free.  However, there is always something that the user will not miss.  And in postgresql it is easily fixed, because it allows you to create functions in languages ‚Äã‚Äãfor every taste, be it Plpgsql, Perl, or even Java. <br><br>  I will give an example.  I have always lacked the function that receives the selected table's DDL.  In oracle, for example, you can use the dbms_metadata package for this.  But for some reason, there is no analogue in postgresql.  That is, you can certainly use pgdump, but this is a bit different, I would like to have the function of the database.  And so on, I think everyone will find several such small "Wishlist". <br><br>  In any of my databases, I create in the ‚Äúpublic‚Äù scheme a specific set of functions that facilitate my life.  In this topic I want to share them.  I invite everyone to also share their comments in the comments. <br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h3>  Array to table </h3><br>  It is not always convenient to work with an array, often there is a desire to ‚Äúselect from an array with a SELECT‚Äù.  In postgresql this is possible. <br><br> <code>CREATE OR REPLACE FUNCTION explode_array(IN in_array anyarray) <br> RETURNS SETOF anyelement AS <br> $$ <br> SELECT ($1)[s] from generate_series(1,array_upper($1, 1)) as s; <br> $$ LANGUAGE 'sql' IMMUTABLE; <br></code> <br>  Used like this: <br><br> <code>SELECT num FROM explode_array('{1,2,3}'::INTEGER[]) num WHERE num = 2; <br></code> <br>  Do not scold for example, at two o'clock in the morning nothing smarter comes to mind :). <br><br><h3>  Getting the DDL table </h3><br>  Just what I said at the beginning of the topic. <br><br> <code>CREATE OR REPLACE FUNCTION extract_ddl(IN table_name text, IN db_name text, <br> IN host text, IN user_name text) <br> RETURNS text AS <br> $$ <br> my $table_name = $_[0]; <br> my $db_name = $_[1]; <br> my $host = $_[2]; <br> my $user_name = $_[3]; <br> my $str = `pg_dump -s -t $table_name -h $host -U $user_name $db_name`; <br> return $str; <br> $$ LANGUAGE 'plperlu'; <br></code> <br>  This is the full version of the function, it can be greatly reduced in volume by removing parameters that you will not use.  For example: <br><br> <code>CREATE OR REPLACE FUNCTION extract_ddl(IN table_name text, IN db_name text) <br> RETURNS text AS <br> $$ <br> my $table_name = $_[0]; <br> my $db_name = $_[1]; <br> my $str = `pg_dump -s -t $table_name $db_name`; <br> return $str; <br> $$ LANGUAGE 'plperlu'; <br></code> <br><br><h3>  urldecode / urlencode </h3><br>  Actually there is 1000 and one way to encode / decode url.  My way is suitable only for a small circle of tasks.  Some kind of auxiliary request or something like that. <br><br> <code>CREATE OR REPLACE FUNCTION urlencode (IN url text, IN encoding text) <br> RETURNS text AS <br> $$ <br> use URI::Escape; <br> use Encode; <br> my $url=$_[0]; <br> my $encoding=$_[1]; <br> return uri_escape(encode($encoding, $url)); <br> $$ LANGUAGE plperlu IMMUTABLE; <br> <br> CREATE OR REPLACE FUNCTION urldecode (IN url text, IN encoding text) <br> RETURNS text AS <br> $$ <br> use Encode; <br> use URI::Escape; <br> my $str = uri_unescape($_[0]); <br> my $encoding = $_[1]; <br> <br> eval { <br> $str = decode($encoding, $str); <br> }; <br> if ($@){ <br> return $str; <br> }; <br> <br> return $str; <br> $$ LANGUAGE plperlu IMMUTABLE; <br></code> <br><br><h3>  Get domain name from URL </h3><br>  Surely not the best solution, but, nevertheless, proven and working. <br><br> <code>CREATE OR REPLACE FUNCTION extract_domain(IN url text, IN domain_level INTEGER) <br> RETURNS text AS <br> $$ <br> DECLARE <br> v_domain_full text; <br> v_domain text; <br> v_matches text[]; <br> v_level INTEGER := 1; <br> v_url_levels INTEGER := 0; <br> rec record; <br> BEGIN <br> SELECT regexp_matches(lower(url), E'https?://(www\\.)?([-a-zA-Z0-9.]*\\.[az]{2,5})', 'gi') INTO v_matches LIMIT 1; <br> <br> IF v_matches IS NULL OR v_matches[2] IS NULL THEN <br> RETURN NULL; <br> END IF; <br> <br> v_domain_full := v_matches[2]; <br> <br> v_matches := regexp_split_to_array(v_domain_full, E'\\.'); <br> SELECT count(*) INTO v_url_levels FROM regexp_split_to_table(v_domain_full, E'\\.'); <br> <br> IF v_url_levels = domain_level THEN <br> RETURN v_domain_full; <br> END IF; <br> <br> IF v_url_levels &lt; domain_level THEN <br> RETURN NULL; <br> END IF; <br> <br> v_domain := v_matches[v_url_levels]; <br> <br> IF (domain_level &gt; 1) THEN <br> FOR i IN 1..domain_level-1 LOOP <br> v_domain := v_matches[v_url_levels - i] || '.' || v_domain; <br> END LOOP; <br> END IF; <br> <br> RETURN v_domain; <br> END; <br> $$ LANGUAGE 'plpgsql' IMMUTABLE; <br></code> <br><br>  Used for example: <br><br> <code>SELECT * FROM extract_domain('http://www.google.com/search?q=postgresql+is+great', 2); <br> <br> Result: <br> ----------------- <br> google.com <br></code> <br><br><h3>  Fin </h3><br>  That's all, the inspiration for today is over).  Again, I urge everyone to share their experiences that make life easier.  I will be glad to any comments / remarks to my decisions. </div><p>Source: <a href="https://habr.com/ru/post/72841/">https://habr.com/ru/post/72841/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../72834/index.html">Starcraft 2 - Battle Report 4</a></li>
<li><a href="../72835/index.html">The 13th StartupPoint and Investor Community Meeting StartupPoint (Moscow, October 25)</a></li>
<li><a href="../72836/index.html">Discogs - put your collection in order</a></li>
<li><a href="../72837/index.html">Access to a computer disk via WiFi / Internet using the built-in Symbian client (using the example of Nokia N86, Win7 and IIS6.1)</a></li>
<li><a href="../72839/index.html">Version 1.0.10</a></li>
<li><a href="../72842/index.html">Do you specify the default cursor style on a web page?</a></li>
<li><a href="../72843/index.html">HTML 5 and Video in Email</a></li>
<li><a href="../72844/index.html">Snow Leopard vs. Windows 7 - so what do you think is better?</a></li>
<li><a href="../72845/index.html">Reception of citizens: on-line document readiness check</a></li>
<li><a href="../72855/index.html">Logo change</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>