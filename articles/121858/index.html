<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Competitive access to relational databases</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The issues of concurrency in computer computing are very complex! The reasons for the great complexity are the huge amount of details that need to be ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Competitive access to relational databases</h1><div class="post__text post__text-html js-mediator-article"><img alt="Scheme" src="https://habrastorage.org/storage/f392f9dd/80f7c8d5/fd4c5de4/e5facdea.png" align="left">  The issues of concurrency in computer computing are very complex!  The reasons for the great complexity are the huge amount of details that need to be considered when developing parallel programs.  In programming, there are already a large number of details that create grounds for errors; concurrency adds more. <br><br>  The issues of competitive access to relational databases are confronted practically by any developers of application software and not only by them.  The result of this demand for this area is the presence of a large number of created architectural patterns.  This allows you to successfully cope with the great complexity of developing such programs.  Below we will talk about these recipes, as well as the mechanisms on which their implementation is based.  The narration will be illustrated with examples of Java code, but most of the material is not language bound.  The purpose of the article is to describe the problems of competitive access to relational databases, as an introduction to the subject, rather than a full coverage of the topic. <a name="habracut"></a><br><br><h4>  Competitive Access Issues </h4><br>  Consider the situation.  In a certain accounting system, it is necessary to reflect the change in the remnants of the goods when carrying out documents.  To make the discussion more substantive, I will provide it with examples working on PostgreSQL.  Here is the database structure for our accounting system and test data. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> stocks ( <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span> PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">name</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">256</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, quantity <span class="hljs-built_in"><span class="hljs-built_in">decimal</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-number"><span class="hljs-number">0.0</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> documents ( <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span> PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span>, quantity <span class="hljs-built_in"><span class="hljs-built_in">decimal</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-number"><span class="hljs-number">0.0</span></span>, processed <span class="hljs-built_in"><span class="hljs-built_in">boolean</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>, stock <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REFERENCES</span></span> stocks ); <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> stocks (<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>, quantity) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-number"><span class="hljs-number">56.4</span></span>), (<span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-number"><span class="hljs-number">26.8</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> documents (<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, quantity, stock) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">15.6</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>), (<span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">26.1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>);</code> </pre> <br>  Suppose our document is responsible for writing off goods from the warehouse.  The application code loads the document and residual data, performs calculations, and saves the data to the database.  If this action is performed by one application, then everything is in order. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> quantity, processed, stock <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> documents <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> = <span class="hljs-number"><span class="hljs-number">1</span></span>;</code> </pre><br><pre> <code class="bash hljs"> quantity | processed | stock ----------+-----------+------- 15.60 | f | 1</code> </pre><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>, quantity <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> stocks <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> = <span class="hljs-number"><span class="hljs-number">1</span></span>;</code> </pre><br><pre> <code class="bash hljs"> name | quantity ------+----------  | 56.40</code> </pre><br>  Loaded document data with ID 1 and the remainder corresponding to it.  The new value of the remainder is calculated by writing off 56.40 - 15.60 = 40.80 and the data is saved back with a note about the processing of the document. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">UPDATE</span></span> stocks <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> quantity = <span class="hljs-number"><span class="hljs-number">40.80</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">UPDATE</span></span> documents <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> processed = <span class="hljs-literal"><span class="hljs-literal">true</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> = <span class="hljs-number"><span class="hljs-number">1</span></span>;</code> </pre><br>  But single-user systems have a long history.  Now it is impossible to imagine a business application to work with which users must line up.  Therefore, let's consider the situation when two documents are processed simultaneously.  As in the first case, applications read data from the database. <br><br>  first application <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> quantity, processed, stock <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> documents <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> = <span class="hljs-number"><span class="hljs-number">1</span></span>;</code> </pre><br><pre> <code class="bash hljs"> quantity | processed | stock ----------+-----------+------- 15.60 | f | 1</code> </pre><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>, quantity <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> stocks <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> = <span class="hljs-number"><span class="hljs-number">1</span></span>;</code> </pre><br><pre> <code class="bash hljs"> name | quantity ------+----------  | 56.40</code> </pre><br>  second application <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> quantity, processed, stock <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> documents <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> = <span class="hljs-number"><span class="hljs-number">2</span></span>;</code> </pre><br><pre> <code class="bash hljs"> quantity | processed | stock ----------+-----------+------- 26.10 | f | 1</code> </pre><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>, quantity <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> stocks <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> = <span class="hljs-number"><span class="hljs-number">1</span></span>;</code> </pre><br><pre> <code class="bash hljs"> name | quantity ------+----------  | 56.40</code> </pre><br>  And then there is an obvious problem: the first application calculates 56.40 - 15.60 = 40.80, and the second 56.40 - 26.10 = 30.30.  And any of these results will be written into the database.  The one for which the last update request will be executed.  This is clearly not the behavior that the user expects to see.  Problems of this type are well known in parallel programming and are called race conditions (race conditions).  This case is a compound action under the general name read-modify-write (read-modify-write). <br><br>  If we checked the document for processing (the processed field), and in a real application we would have to do this, a situation could occur in which, despite the verification, the document could be processed twice.  All the same condition of the race, but a different type of operation check-then-act (check-then-act).  In addition, in the intervals between update requests, the database is in an inconsistent state, that is, the action on the document has already been executed, but the document is not marked as processed. <br><br>  As a result, we have two of the most common problems that manifest themselves with incorrect competitive access to databases.  This is a loss of changes occurring in the event of a race read-modify-write.  And the inconsistent state of the data in the interval between update requests. <br><br><h4>  DBMS mechanisms </h4><br>  In order to discuss specific recipes for competitive access to relational databases, you need to be familiar with the lower-level mechanisms that DBMS and programming tools provide.  These are the technical elements on which the implementation is based.  The main such elements are transactions and locks.  About them and will be discussed further. <br><br><h4>  Transactions and isolation levels </h4><br>  A transaction is a single sequence of operations for interacting with a database, which is perceived as a single whole, which has the ability to roll back or confirm the completion of operations.  A transaction may be a means of resolving the problem of consistency of changes, as well as to prevent the situation of racing.  The suitability of transactions to solve the first or both problems depends on the isolation level.  Isolation is a property that determines how / when changes made by a single operation will be visible to a competitive operation. <br><br>  The SQL standard defines four isolation levels: Read uncommitted, Read committed, Repeatable read, Serializable.  All of them differ in the minimum acceptable insulation level.  The basic properties of these levels should be clear from the title.  Different DBMSs can implement support for isolation types in different ways.  The main thing that each implementation does not allow isolation, less strict than prescribed for the level.  For example, PostgreSQL supports only two levels of isolation, Read committed and Serializable, internally.  Consider using these isolation levels to solve the problems described in the examples above. <br><br>  Using the Read committed isolation level (used by default in PostgreSQL) allows us to solve the inconsistent data state problem.  This is achieved due to the fact that all changes made within the transaction become visible to competitive transactions after the current one. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> quantity, processed, stock <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> documents <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>, quantity <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> stocks <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-comment"><span class="hljs-comment">--    UPDATE stocks SET quantity = 40.80 WHERE id = 1; UPDATE documents SET processed = true WHERE id = 1; COMMIT;</span></span></code> </pre><br>  But such a transaction does not solve the problem with the state of races in the competitive execution of operations.  In such situations, another level of isolation can help - Serializable.  This is a possible solution, but it is not the only one.  The behavior of the implementation of the Serializable isolation level in PostgreSQL does not fully match the name.  That is, all transactions with a Serializable isolation level are not performed sequentially.  Instead, when committing a transaction, the conflict is checked when the data is changed and if the data has already been changed by a competitive transaction, the current transaction fails. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ISOLATION</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LEVEL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SERIALIZABLE</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> quantity, processed, stock <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> documents <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>, quantity <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> stocks <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-comment"><span class="hljs-comment">--    UPDATE stocks SET quantity = 40.80 WHERE id = 1; UPDATE documents SET processed = true WHERE id = 1; COMMIT;</span></span></code> </pre><br>  The above transaction solves the problem with the race situation and data consistency.  A distinctive feature of this approach is that the code performing this transaction learns about success only after the completion of the transaction.  And as a result of failure, it will be necessary to repeat all actions and calculations until the transaction is completed successfully or the decision is made to refuse to perform the action.  This behavior is unsatisfactory with a large competitive load, because a large amount of resources will be consumed to perform repetitions.  This behavior is called optimistic concurrency control. <br><br>  The examples above are based on the assumption that business logic is fully implemented in the application code, and the database acts only as a repository. <br>  An important detail in the use of transactions affecting performance is their length.  Transactions should not be too long; the faster they are made, the more efficient the system will be.  This note may not be critical for code that edits a document in an application with a small number of users.  But it is critical, for example, in a web service situation that interacts with a database and is used by a large number of clients. <br><br><h4>  Locks </h4><br>  In parallel programming, a blocking mechanism is used to control execution threads.  Locks allow you to serialize access to specific areas.  DBMS also supports locking mechanisms to control access to data.  Consider the possibilities of this mechanism on the example of PostgreSQL. <br><br>  PostgreSQL supports many types of locks.  Their main distinguishing feature is the set of types of locks with which the current type of lock conflicts.  Conflict means that the current lock cannot be captured together with the locks of any of the conflicting types.  In addition, locks are divided into explicit and implicit.  Explicit locks are those that are executed in the query using the lock keyword and query modifiers for update or for share, in other words, specified by the user.  Implicit locks are those that are captured while executing various queries (select, update, insert, alter, and others).  PostgerSQL also supports a separate type of lock called advisory lock. <br><br>  Locks are captured from the time the request is executed to the end of the current transaction.  For example, in our hypothetical accounting system, it was possible to capture an exclusive lock on the row of the stocks table corresponding to the balance with which the operation is performed and on the row of the documents table, thereby ensuring that only the current transaction has access to this data. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> quantity, processed, stock <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> documents <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FOR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">UPDATE</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>, quantity <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> stocks <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FOR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">UPDATE</span></span>; <span class="hljs-comment"><span class="hljs-comment">--    UPDATE stocks SET quantity = 40.80 WHERE id = 1; UPDATE documents SET processed = true WHERE id = 1; COMMIT;</span></span></code> </pre><br>  In the code above, locks are captured on lines in the documents and stocks tables.  In this case, the for update keywords are added to the select data request.  This is an explicit blocking of the update string.  Locking a whole table in this case is not effective.  In general, it is necessary to block the table only for large-scale operations with data in it, but these are quite rare cases.  Otherwise, you get a performance problem with competitive access, because all calls to it are serialized. <br><br>  When attempting to lock a lock on an area, the lock on which has already been captured, blocking the request (by default) until the lock is released, or in the case of a dead lock, an error message is returned.  It is possible to set the interval for returning control from a blocked request, or immediately receive a message about the impossibility of blocking the lock (nowait). <br><br><h4>  Types of competitive control </h4><br>  Competitive control is the rules by which parallel execution threads interact at competitive sites.  Competitive controls should ensure the correctness of the calculated result.  An additional goal is to get the result as quickly as possible in a particular case.  Competitive control is usually divided into types according to the time of conflict handling: optimistic (optimistic), pessimistic (pessimistic) and partially optimistic (semi-optimistic). <br><br>  <i>Optimistic competitive control</i> involves checking for a possible conflict when committing an action.  For example, a user requests some data from the repository and modifies it, after which he tries to save his changes.  If the current version of the data stored in the repository matches the version of the data on the basis of which the changes occurred, then there is no conflict and the data can be saved.  In the opposite case, a conflict arises, which is processed either by repeating the actions or refusing them.  Optimistic competitive control provides good performance with relatively little competition for competitive access. <br><br>  <i>Pessimistic competitive control</i> involves checking for a possible conflict before performing an action.  That is, competitive execution threads are serialized on the protected area.  This provides greater performance with high competition for competitive access. <br><br>  <i>Partially optimistic</i> is a mixed type in which both approaches are used simultaneously. <br><br><h4>  Architectural patterns </h4><br>  At this point, the reader should have a general idea of ‚Äã‚Äãthe problems with competitive access and the mechanisms for DBMS to solve them.  This section focuses on architectural patterns that present a solution to the problems of competitive access to databases.  Below is not a complete description, only a general idea and an example.  For a full description refer to the links at the bottom of the article. <br><br>  When working with a DBMS, the data is loaded into the application's memory, actions are performed on or over them, and the result of the actions, as a rule, should be saved back.  All this time, it is necessary to store information about changes over the data in order to know what has changed.  In addition, you must store information about the created and deleted objects.  Of course, you can reflect all changes in the database as soon as they occur.  In this case, the following problems arise: a system transaction takes a very long time, which leads to conflicts during competitive access, since locks over changes in the database are held for the entire transaction;  interaction with the database is divided into many small parts, which is also ineffective.  To solve data change tracking problems, the Unit of Work pattern is described.  This pattern describes an object that tracks all changes and can apply them to the database in order to reconcile its state with the changes made. <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UnitOfWork</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> List&lt;DomainObject&gt; newObjects; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> List&lt;DomainObject&gt; updatedObjects; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> List&lt;DomainObject&gt; deletedObjects; <span class="hljs-comment"><span class="hljs-comment">/** *   * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment">     */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> DomainObject </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">create</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ DomainObject domainObject = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DomainObject(); newObjects.add(domainObject); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> domainObject; } <span class="hljs-comment"><span class="hljs-comment">/** *     * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> domainObject   */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">update</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(DomainObject domainObject)</span></span></span><span class="hljs-function"> </span></span>{ updatedObjects.add(domainObject); } <span class="hljs-comment"><span class="hljs-comment">/** *     * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> domainObject   */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">remove</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(DomainObject domainObject)</span></span></span><span class="hljs-function"> </span></span>{ deletedObjects.add(domainObject); } <span class="hljs-comment"><span class="hljs-comment">/** *      */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">commit</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// SQL     INSERT insert(newObjects); // SQL     UPDATE udpate(updatedObjects); // SQL     DELETE delete(deletedObjects); } //  insert, update, delete   }</span></span></code> </pre><br>  Above is the simplest implementation of the Unit of Work pattern.  DomainObject objects can be registered in the UnitOfWork object when they are acted upon.  After completing a business transaction, the application calls the commit method on the UnitOfWork object. <br>  A business transaction usually takes a long time.  As a rule, it extends to several system transactions.  The reason for this has already been mentioned above - problems with a long lock seizure.  It follows from this that it is necessary to implement its own synchronization mechanism, which will work on top of several system transactions, since the DBMS synchronization mechanisms work only within one system transaction.  To solve this problem, two patterns of Optimistic Offline Lock and Pessimistic Offline Lock are described, which implement optimistic and pessimistic types of competitive control. <br><br>  Suppose the user opens the edit form, he works on the document for several minutes and saves the result.  This is a typical example of a business transaction. <br><br>  Consider the situation with optimistic competitive control.  In case of detection of a conflict when saving the result of editing, the user will be notified with the changed data and a dialogue with the choice of further actions.  The Optimistic Offline Lock pattern describes the change control mechanism, which, in general, relies on the data versioning mechanism.  Each time a change is saved, a comparison is made of the version of the data in the database and the version based on which the changes were made.  If these versions are equal, then the current version changes and the result is saved, otherwise a conflict occurs and it is processed either by repeating actions or canceling. <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DomainObject</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Integer id; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Integer version; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Object data; <span class="hljs-comment"><span class="hljs-comment">//   } public class UnitOfWork { // ,   public void update(List&lt;DomainObject&gt; updatedObjects) throws SQLException { PreparedStatement ps = connection.prepareStatement( "update domain_objects set data = ?, version = version + 1 " + "where id = ? and version = ?" ); for (DomainObject domainObject: updatedObjects) { ps.setObject(1, domainObject.getData()); ps.setInt(2, domainObject.getId()); ps.setInt(3, domainObject.getVersion()); if (ps.executeUpdate() == 0) { throw new RuntimeException(" "); } } } }</span></span></code> </pre><br>  The above code represents the implementation of the update method with the Optimistic Offline Lock pattern described above.  In this implementation, the list of changed objects is saved with version checking.  If the version has changed, then no entry in the table will be updated and in this example an exception is thrown.  This exception corresponds to a conflict in which a record has already been updated by a competitive thread of execution. <br>  In the case of pessimistic competitive control, the implementation of the Pessimistic Offline Lock pattern is presented below. <br><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DomainObject</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Integer id; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Boolean blocked; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Object data; <span class="hljs-comment"><span class="hljs-comment">//   } public class UnitOfWork { // ,   public void update(List&lt;DomainObject&gt; updatedObjects) throws SQLException { PreparedStatement updateStatement = connection.prepareStatement( "update domain_objects set data = ?, blocked = false " + "where id = ? and blocked = true" ); for (DomainObject domainObject: updatedObjects) { updateStatement.setObject(1, domainObject.getData()); updateStatement.setInt(2, domainObject.getId()); updateStatement.executeUpdate(); } } public DomainObject get(Integer id) throws SQLException { PreparedStatement updateStatement = connection.prepareStatement( "update domain_objects set blocked = true " + "where id = ? and blocked = false" ); updateStatement.setInt(1, id); if (updateStatement.executeUpdate() == 1) { PreparedStatement selectStatement = connection.prepareStatement( "select * from domain_objects where id = ?" ); selectStatement.setInt(1, id); ResultSet result = selectStatement.executeQuery(); //result    //  DomainObject    result return new DomainObject(); } else { throw new RuntimeException("  "); } } }</span></span></code> </pre><br>  In the presented code, when receiving data from the database, a lock is set on the blocked field.  If it is already set, an exception is thrown, otherwise the result is returned.  Then, when the object is updated, the lock is reset.  This implementation will work with all levels of transaction isolation.  Provided that the data will be saved after lock seizure. <br><br>  <i>The presented implementations only illustrate the description and are not intended for use in real-world applications!</i> <br><br><h4>  Business Level Locking Policy </h4><br>  Blocking policies are rules that regulate competitive access to data.  This paragraph deals with the policy of locking at the business level, and not at the level of implementing queries to the DBMS and platform synchronization mechanisms.  It is necessary to take into account that the blocking policy must be related to business logic.  And you can not leave the issue with competitive access for later.  For example, in a system where the field of application indicates that a certain document must be edited individually, it is necessary that the business logic has knowledge of this requirement.       ,     ,          ,    .  ,      ,           .  ,      ,            ,    .          .             . <br><br><h4>   (en) </h4><br> <a href="http://www.amazon.com/Patterns-Eterprise-Application-Architecture-Martin/dp/0321127420/">Patterns of Enterprise Application Architecture (Martin Fowler, David Rice, Matthew Foemmel, Edward Hieatt, Robert Mee, Randy Stafford)</a> <br> <a href="http://www.postgresql.org/docs/9.0/static/mvcc.html">PostgreSQL Concurrency Control</a> <br> <a href="http://en.wikipedia.org/wiki/Concurrency_control">Concurrency control</a> <br> <a href="http://en.wikipedia.org/wiki/Isolation_level">Isolation level</a> </div><p>Source: <a href="https://habr.com/ru/post/121858/">https://habr.com/ru/post/121858/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../121852/index.html">Check GUNNARS points</a></li>
<li><a href="../121853/index.html">We write web service using gSOAP</a></li>
<li><a href="../121854/index.html">Review of the official VKontakte application for Android</a></li>
<li><a href="../121855/index.html">New search features: voice, image, instant result discovery</a></li>
<li><a href="../121856/index.html">Mikogo 4.0 - a utility for screen sharing, webinars, online conferences and remote access</a></li>
<li><a href="../121860/index.html">"Acceleration" of the Internet or a crazy feature for browsers</a></li>
<li><a href="../121864/index.html">GPS Video Surveillance</a></li>
<li><a href="../121865/index.html">Apple will pay Nokia patent fees - patent disputes terminated</a></li>
<li><a href="../121867/index.html">Google invests $ 280 million in alternative energy</a></li>
<li><a href="../121870/index.html">The reasons for the migration of IT people from Russia or the top vacancies with the need to move</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>