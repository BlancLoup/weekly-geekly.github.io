<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>LINQ for SQL emulation on Delphi</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Formulation of the problem. 
 There is a large Client-Server project. The client programmatically builds dynamic SQL queries for execution on the SQL ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>LINQ for SQL emulation on Delphi</h1><div class="post__text post__text-html js-mediator-article">  Formulation of the problem. <br>  There is a large Client-Server project.  The client programmatically builds dynamic SQL queries for execution on the SQL server.  It is a lot of requests, the logic of creation is spread on all client code.  The project develops in time, it is necessary to modify the structure of the database.  How to make the compiler show all the places where fields that no longer exist are used in the code?  How to make the compiler check that an integer field is not assigned a string parameter?  At the same time, Pascal code should be close to SQL syntax. <br><a name="habracut"></a><br>  Example. <br>  Suppose we have a database in which there are two tables: <br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> PERSON ( <span class="hljs-keyword"><span class="hljs-keyword">ID</span></span> <span class="hljs-built_in"><span class="hljs-built_in">INTEGER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, SURNAME <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">100</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, EMPLOYMENT <span class="hljs-built_in"><span class="hljs-built_in">INTEGER</span></span>, MOTHER <span class="hljs-built_in"><span class="hljs-built_in">INTEGER</span></span>, FATHER <span class="hljs-built_in"><span class="hljs-built_in">INTEGER</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> EMPLOYMENT ( <span class="hljs-keyword"><span class="hljs-keyword">ID</span></span> <span class="hljs-built_in"><span class="hljs-built_in">INTEGER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, DESCRIPTION <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">100</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> );</code> </pre> <br>  We really want to generate a SQL query on pascal (you should not look for logic in it): <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> P.ID,P.SURNAME <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> Person P,Person F,Employment E <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> P.FATHER=F.ID <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> P.EMPLOYMENT=E.ID <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> (F.SURNAME&lt;&gt;P.SURNAME <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> E.Description=<span class="hljs-string"><span class="hljs-string">'US President'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> P.MOTHER&lt;&gt;<span class="hljs-number"><span class="hljs-number">20</span></span></code> </pre><br><br>  Decision. <br>  It was tested on Delphi 2007. I suggest using this syntax for building an SQL query: <br><pre> <code class="delphi hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetTestSql</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">String</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> aBulder: TSuperBaseSqlBulder; P: TPersonTable; F: TPersonTable; E: TEmploymentTable; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> aBulder := TSuperBaseSqlBulder.Create; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> P := aBulder.AddPersonTable(<span class="hljs-string"><span class="hljs-string">'P'</span></span>); F := aBulder.AddPersonTable(<span class="hljs-string"><span class="hljs-string">'F'</span></span>); E := aBulder.AddEmploymentTable(<span class="hljs-string"><span class="hljs-string">'E'</span></span>); Result := ( (P.Father = F.ID) <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> (P.Employment = E.ID) <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> ( (F.Surname &lt;&gt; P.Surname) <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> (E.Description = <span class="hljs-string"><span class="hljs-string">'US President'</span></span>) ) <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> (P.Mother &lt;&gt; <span class="hljs-number"><span class="hljs-number">20</span></span>) ).Select([P.ID, P.Surname]); <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> aBulder.Free; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>;</code> </pre><br>  As you can see, the syntax after ‚ÄúResult: =‚Äù is very similar to LINQ.  The compiler checks for the presence of columns, catches type incompatibility errors.  Those.  won't miss anything from: <br><pre> <code class="delphi hljs">E.UnknownFiled = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-comment"><span class="hljs-comment">//   E.Description = E.ID //    P.Mother = 'Miss World' //   </span></span></code> </pre> <br>  What was it all for?  Now let's persuade the compiler to digest GetTestSql.  First we need to explain to the compiler the structure of our database.  In the future, you will write a program that, looking at the database structure, will generate in our case the following: <br><pre> <code class="delphi hljs"><span class="hljs-keyword"><span class="hljs-keyword">uses</span></span> UKSqlBulder; <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> <span class="hljs-title"><span class="hljs-title">TPersonTable</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">class</span></span>(TSqlTable) <span class="hljs-keyword"><span class="hljs-keyword">property</span></span> ID: TCondField_Integer <span class="hljs-keyword"><span class="hljs-keyword">index</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">read</span></span> GetCondFields_Integer; <span class="hljs-keyword"><span class="hljs-keyword">property</span></span> Surname: TCondField_String <span class="hljs-keyword"><span class="hljs-keyword">index</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">read</span></span> GetCondFields_String; <span class="hljs-keyword"><span class="hljs-keyword">property</span></span> Employment: TCondField_Integer <span class="hljs-keyword"><span class="hljs-keyword">index</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">read</span></span> GetCondFields_Integer; <span class="hljs-keyword"><span class="hljs-keyword">property</span></span> Mother: TCondField_Integer <span class="hljs-keyword"><span class="hljs-keyword">index</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-keyword"><span class="hljs-keyword">read</span></span> GetCondFields_Integer; <span class="hljs-keyword"><span class="hljs-keyword">property</span></span> Father: TCondField_Integer <span class="hljs-keyword"><span class="hljs-keyword">index</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-keyword"><span class="hljs-keyword">read</span></span> GetCondFields_Integer; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-title"><span class="hljs-title">TEmploymentTable</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">class</span></span>(TSqlTable) <span class="hljs-keyword"><span class="hljs-keyword">property</span></span> ID: TCondField_Integer <span class="hljs-keyword"><span class="hljs-keyword">index</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">read</span></span> GetCondFields_Integer; <span class="hljs-keyword"><span class="hljs-keyword">property</span></span> Description: TCondField_String <span class="hljs-keyword"><span class="hljs-keyword">index</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">read</span></span> GetCondFields_String; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-title"><span class="hljs-title">TSuperBaseSqlBulder</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">class</span></span>(TSqlBulder) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AddPersonTable</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> aAlias: </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">String</span></span></span></span><span class="hljs-function"><span class="hljs-params"> = </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">''</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">:</span></span> TPersonTable; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AddEmploymentTable</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> aAlias: </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">String</span></span></span></span><span class="hljs-function"><span class="hljs-params"> = </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">''</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">:</span></span> TEmploymentTable; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">implementation</span></span> <span class="hljs-comment"><span class="hljs-comment">{ TSuperBaseSqlBulder }</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TSuperBaseSqlBulder</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AddPersonTable</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> aAlias: </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">String</span></span></span></span><span class="hljs-function"><span class="hljs-params"> = </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">''</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">:</span></span> TPersonTable; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> Result := TPersonTable.Create; Result.<span class="hljs-keyword"><span class="hljs-keyword">Name</span></span> := <span class="hljs-string"><span class="hljs-string">'Person'</span></span>; Result.<span class="hljs-keyword"><span class="hljs-keyword">Alias</span></span> := aAlias; Result.Add(TSqlField_Integer.Create(<span class="hljs-string"><span class="hljs-string">'ID'</span></span>)); Result.Add(TSqlField_String.Create(<span class="hljs-string"><span class="hljs-string">'SURNAME'</span></span>)); Result.Add(TSqlField_Integer.Create(<span class="hljs-string"><span class="hljs-string">'EMPLOYMENT'</span></span>)); Result.Add(TSqlField_Integer.Create(<span class="hljs-string"><span class="hljs-string">'MOTHER'</span></span>)); Result.Add(TSqlField_Integer.Create(<span class="hljs-string"><span class="hljs-string">'FATHER'</span></span>)); Add(Result); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TSuperBaseSqlBulder</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AddEmploymentTable</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> aAlias: </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">String</span></span></span></span><span class="hljs-function"><span class="hljs-params"> = </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">''</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">:</span></span> TEmploymentTable; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> Result := TEmploymentTable.Create; Result.<span class="hljs-keyword"><span class="hljs-keyword">Name</span></span> := <span class="hljs-string"><span class="hljs-string">'Employment'</span></span>; Result.<span class="hljs-keyword"><span class="hljs-keyword">Alias</span></span> := aAlias; Result.Add(TSqlField_Integer.Create(<span class="hljs-string"><span class="hljs-string">'ID'</span></span>)); Result.Add(TSqlField_String.Create(<span class="hljs-string"><span class="hljs-string">'Description'</span></span>)); Add(Result); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>;</code> </pre><br><br>  And finally, the UKSqlBulder source code: <br><pre> <code class="delphi hljs"><span class="hljs-keyword"><span class="hljs-keyword">unit</span></span> UKSqlBulder; <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uses</span></span> Contnrs; <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> TSqlBulder = <span class="hljs-keyword"><span class="hljs-keyword">class</span></span>; TSqlTable = <span class="hljs-keyword"><span class="hljs-keyword">class</span></span>; TSqlField = <span class="hljs-keyword"><span class="hljs-keyword">class</span></span>; TSqlField_Integer = <span class="hljs-keyword"><span class="hljs-keyword">class</span></span>; TSqlField_String = <span class="hljs-keyword"><span class="hljs-keyword">class</span></span>; TRCondition = <span class="hljs-keyword"><span class="hljs-keyword">record</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> AsSql: <span class="hljs-keyword"><span class="hljs-keyword">String</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-keyword"><span class="hljs-keyword">operator</span></span> LogicalAnd(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> A, B: TRCondition): TRCondition; <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-keyword"><span class="hljs-keyword">operator</span></span> LogicalOr(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> A, B: TRCondition): TRCondition; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Select</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> aFields: </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">array</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">of</span></span></span></span><span class="hljs-function"><span class="hljs-params"> TSqlField)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">String</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; TCondField_Integer = <span class="hljs-keyword"><span class="hljs-keyword">record</span></span> Field: TSqlField_Integer; <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-keyword"><span class="hljs-keyword">operator</span></span> Equal(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> A, B: TCondField_Integer): TRCondition; <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-keyword"><span class="hljs-keyword">operator</span></span> NotEqual(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> A, B: TCondField_Integer): TRCondition; <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-keyword"><span class="hljs-keyword">operator</span></span> Equal(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> A: TCondField_Integer; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> aArg: Integer): TRCondition; <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-keyword"><span class="hljs-keyword">operator</span></span> NotEqual(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> A: TCondField_Integer; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> aArg: Integer): TRCondition; <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-keyword"><span class="hljs-keyword">operator</span></span> Implicit(A: TCondField_Integer): TSqlField; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; TCondField_String = <span class="hljs-keyword"><span class="hljs-keyword">record</span></span> Field: TSqlField_String; <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-keyword"><span class="hljs-keyword">operator</span></span> Equal(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> A, B: TCondField_String): TRCondition; <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-keyword"><span class="hljs-keyword">operator</span></span> NotEqual(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> A, B: TCondField_String): TRCondition; <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-keyword"><span class="hljs-keyword">operator</span></span> Equal(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> A: TCondField_String; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> aArg: <span class="hljs-keyword"><span class="hljs-keyword">String</span></span>): TRCondition; <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-keyword"><span class="hljs-keyword">operator</span></span> NotEqual(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> A: TCondField_String; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> aArg: <span class="hljs-keyword"><span class="hljs-keyword">String</span></span>): TRCondition; <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-keyword"><span class="hljs-keyword">operator</span></span> Implicit(A: TCondField_String): TSqlField; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-title"><span class="hljs-title">TSqlBulder</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">class</span></span>(TObjectList) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetTables</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(aIndex: Integer)</span></span></span><span class="hljs-function">:</span></span> TSqlTable; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Add</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(aTable: TSqlTable)</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">property</span></span> Tables[aIndex: Integer]: TSqlTable <span class="hljs-keyword"><span class="hljs-keyword">read</span></span> GetTables; <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; TSqlField = <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> Table: TSqlTable; <span class="hljs-keyword"><span class="hljs-keyword">Name</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">String</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">FullName</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">String</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">constructor</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Create</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> aName: </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">String</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-title"><span class="hljs-title">TSqlField_Integer</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">class</span></span>(TSqlField) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-title"><span class="hljs-title">TSqlField_String</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">class</span></span>(TSqlField) <span class="hljs-comment"><span class="hljs-comment">// MaxLength: Integer; not used end; TSqlTable = class(TObjectList) private Bulder: TSqlBulder; function GetFields(aIndex: Integer): TSqlField; protected Alias: String; Name: String; function GetCondFields_Integer(aIndex: Integer): TCondField_Integer; function GetCondFields_String(aIndex: Integer): TCondField_String; procedure Add(aField: TSqlField); public property Fields[aIndex: Integer]: TSqlField read GetFields; default; end; implementation uses SysUtils; { TSqlTable } procedure TSqlTable.Add(aField: TSqlField); begin inherited Add(aField); aField.Table := self; end; function TSqlTable.GetFields(aIndex: Integer): TSqlField; begin Result := TSqlField(inherited Items[aIndex]); end; function TSqlTable.GetCondFields_Integer(aIndex: Integer): TCondField_Integer; begin Result.Field := Fields[aIndex] as TSqlField_Integer; end; function TSqlTable.GetCondFields_String(aIndex: Integer): TCondField_String; begin Result.Field := Fields[aIndex] as TSqlField_String; end; { TSqlField } constructor TSqlField.Create(const aName: String); begin inherited Create; Name := aName; end; function TSqlField.FullName: String; begin Result := Table.Alias + '.' + Name; end; { TCondField_Integer } class operator TCondField_Integer.Implicit(A: TCondField_Integer): TSqlField; begin Result := A.Field; end; class operator TCondField_Integer.Equal(const A, B: TCondField_Integer): TRCondition; begin Result.AsSql := A.Field.FullName + '=' + B.Field.FullName; end; class operator TCondField_Integer.NotEqual(const A, B: TCondField_Integer): TRCondition; begin Result.AsSql := A.Field.FullName + '&lt;&gt;' + B.Field.FullName; end; class operator TCondField_Integer.Equal(const A: TCondField_Integer; const aArg: Integer): TRCondition; begin Result.AsSql := A.Field.FullName + '=' + IntToStr(aArg); end; class operator TCondField_Integer.NotEqual(const A: TCondField_Integer; const aArg: Integer): TRCondition; begin Result.AsSql := A.Field.FullName + '&lt;&gt;' + IntToStr(aArg); end; { TCondField_String } class operator TCondField_String.Implicit(A: TCondField_String): TSqlField; begin Result := A.Field; end; class operator TCondField_String.Equal(const A, B: TCondField_String): TRCondition; begin Result.AsSql := A.Field.FullName + '=' + B.Field.FullName; end; class operator TCondField_String.NotEqual(const A, B: TCondField_String): TRCondition; begin Result.AsSql := A.Field.FullName + '&lt;&gt;' + B.Field.FullName; end; class operator TCondField_String.Equal(const A: TCondField_String; const aArg: String): TRCondition; begin Result.AsSql := A.Field.FullName + '=''' + aArg + ''''; end; class operator TCondField_String.NotEqual(const A: TCondField_String; const aArg: String): TRCondition; begin Result.AsSql := A.Field.FullName + '&lt;&gt;''' + aArg + ''''; end; { TRCondition } function TRCondition.Select(const aFields: array of TSqlField): String; var i: Integer; aSelect, aFrom: String; aBulder: TSqlBulder; aTable: TSqlTable; begin if Length(aFields) &lt;= 0 then raise Exception.Create('Invalid argument'); aBulder := aFields[0].Table.Bulder; aFrom := ''; for i := 0 to aBulder.Count - 1 do begin aTable := aBulder[i]; aFrom := aFrom + aTable.Name + ' ' + aTable.Alias + ','; end; aFrom[Length(aFrom)] := ' '; aSelect := ''; for i := 0 to Length(aFields) - 1 do begin aSelect := aSelect + aFields[i].FullName + ','; end; aSelect[Length(aSelect)] := ' '; Result := Format('select %sfrom %swhere %s', [aSelect, aFrom, AsSql]); end; class operator TRCondition.LogicalAnd(const A, B: TRCondition): TRCondition; begin Result.AsSql := A.AsSql + ' and ' + B.AsSql; end; class operator TRCondition.LogicalOr(const A, B: TRCondition): TRCondition; begin Result.AsSql := '(' + A.AsSql + ' or ' + B.AsSql + ')'; end; { TSqlBulder } procedure TSqlBulder.Add(aTable: TSqlTable); var aPrefix: String; begin if aTable.Alias = '' then begin if Count &gt; 0 then aPrefix := 'T' + IntToStr(Count + 1) + '_' else aPrefix := 'T_'; aTable.Alias := aPrefix + aTable.Name; end; aTable.Bulder := self; inherited Add(aTable); end; function TSqlBulder.GetTables(aIndex: Integer): TSqlTable; begin Result := TSqlTable(inherited Items[aIndex]); end; end.</span></span></code> </pre><br></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/203970/">https://habr.com/ru/post/203970/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../203958/index.html">Sites for kids - is it easy to make a serious product ‚Äútoy‚Äù</a></li>
<li><a href="../203960/index.html">JavaFX and Spring. It's more fun together</a></li>
<li><a href="../203964/index.html">Snake on PLC? Easy!</a></li>
<li><a href="../203966/index.html">UEFI - Aah, I heard ... but still, what is it?</a></li>
<li><a href="../203968/index.html">Grid control</a></li>
<li><a href="../203972/index.html">Universal way to quickly take a screenshot in linux</a></li>
<li><a href="../203974/index.html">Why do many banks and payment systems worry little about the safety of their customers?</a></li>
<li><a href="../203980/index.html">XCP for those who want but are afraid</a></li>
<li><a href="../203984/index.html">It is a little about neutrino, cosmology and domestic projects</a></li>
<li><a href="../203986/index.html">How we accelerated the search on hh.ru</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>