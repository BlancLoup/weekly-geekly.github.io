<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Getting started in STM32CubeMX. Part 1</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Part 2 
 Part 3 

 I welcome the audience of Habr, and I want to bring to your attention the first post devoted to using the development environment S...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Getting started in STM32CubeMX. Part 1</h1><div class="post__text post__text-html js-mediator-article">  <a href="https://habrahabr.ru/post/312810/">Part 2</a> <br>  <a href="https://habrahabr.ru/post/323674/">Part 3</a> <br><br>  I welcome the audience of Habr, and I want to bring to your attention the first post devoted to using the development environment STM32CubeMX, written for those who want to start learning STM32 from scratch. <br><br><img src="https://habrastorage.org/files/415/7f6/a5d/4157f6a5d81a4e92b8415df382e1117c.png">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      I planned to write several posts, having considered several peripheral devices of the microcontroller and their configuration in STM32CubeMX.  But these posts do not replace the company documentation and do not claim to be complete.  They will consider only some, most, in my opinion, typical examples of the use of STM32 peripherals. <br>  I hope this material will be useful to someone. <br><a name="habracut"></a><br><h3>  1. Small introduction </h3><br>  First, I will do a little explanation.  To study this material, you will need a debug board with an STM32 microcontroller.  I use the STM32F746G Discovery board, which today is one of the best, and, accordingly, expensive Discovery boards. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/1df/87e/fe5/1df87efe5c6147e5b2c8e4e8f03e38a7.png"></div><br>  However, for the development of most of the material will be enough of any, even the most simple board on the STM32.  I recommend the Discovery boards.  they already contain the ST-Link debugger, and you only need a MiniUSB cable to work.  To begin with, even the power supply is not needed, the board is powered through the same cable. <br><br>  Naturally, when using a microcontroller other than the STM32F746G, it will be necessary to make corrections in projects for another clock frequency, another pinout, etc., but the essence remains the same.  I recommend immediately download the documentation for your board with a schematic diagram and pdf on the microcontroller. <br><br>  For further work it will be nice to have an oscilloscope, almost any, but you can start without it. <br><br>  Again, anticipating questions about the purchase of the board, I bought on aliexpress, and it was much cheaper than from domestic sellers. <br><br>  We also need STM32CubeMX itself (downloaded for free), and any IDE to work with the project on C and ST-Link support.  There are many of them, there are commercial ones, there are free ones, and I will deliberately not give any names.  Everyone chooses for himself. <br><br><h3>  2. Hello World, or LED control </h3><br>  First you need to download and install the STM32CubeMX.  You can download it for free from st.com.  I have to say, STM32CubeMX exists only in the Windows version.  They write that it works fine under wine, I personally have not tried it. <br><br>  Go to the File / New Project, select the desired microcontroller.  For this it is convenient to use filters in the upper part of the window. <br><br><img src="https://habrastorage.org/files/f62/1d0/44d/f621d044d14442f194be26bd91e51a7f.jpg"><br><br>  In our case, this is STM32F746NGHx. <br><br>  Next, set up the clock generator.  In the Pinout tab, select work with external quartz: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/885/d7e/fe2/885d7efe261346a0a0190cbc76e2cbce.jpg"></div><br>  In the Clock Configuration tab, in the HCLK (MHz) field, we write 216. In response, we receive the message ‚ÄúNo solution found using the current selected sources.  Do you want to use other sources? ‚ÄùWe answer‚Äú OK ‚Äùand select the HSE source in the PLL Source Mux multiplexer.  The values ‚Äã‚Äãof PLLM, PLLN and PLLP are set as shown in the figure.  Check that HCLK = 216MHz. <br><br><img src="https://habrastorage.org/files/98a/be9/1c7/98abe91c76ab4f808cef38e67b7f130d.jpg"><br><br>  Now you need to configure the GPIO that controls the LED.  This is a PI1 port.  On the Pinout tab, we find the output of PI1, click on it and set it to GPIO_Output. <br><br><img src="https://habrastorage.org/files/2a9/b69/745/2a9b69745d604bfb8aa56d767dc3bcd7.jpg"><br><br>  For further convenience, you can assign a pin name.  It is not necessary to do this, but let's do it to make the code more readable.  To do this, on the Configuration tab in the System column, click the GPIO button. <br><br><img src="https://habrastorage.org/files/046/99d/1f9/04699d1f9c1149a4a360d6246306e6ba.jpg"><br><br>  We fall into the window ‚ÄúPin Configuration‚Äù and in the field User Label we write ‚ÄúLed‚Äù. <br><br><img src="https://habrastorage.org/files/967/f69/1ec/967f691ec99947ec90abfe633dc69608.jpg"><br><br>  Now you can generate a code (Project / Generate Code).  STM32CubeMX generates not only source code, but project files for a number of popular IDEs.  Note that the code contains comments like: <br><br><pre><code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/* USER CODE BEGIN 3 */</span></span> <span class="hljs-comment"><span class="hljs-comment">/* USER CODE END 3 */</span></span></code> </pre> <br>  You can only write your code in them, otherwise when you regenerate the source code, your code will be overwritten. <br><br>  So, we find the while (1) loop in main () and write the following in it: <br><br><pre> <code class="cpp hljs">HAL_GPIO_TogglePin(Led_GPIO_Port, Led_Pin); <span class="hljs-comment"><span class="hljs-comment">//Toggle the state of pin HAL_Delay(500); //  </span></span></code> </pre> <br>  Now you can run the project.  We connect the board and download the firmware.  The LED on the board should flash at 1 Hz. <br><br>  However, the above approach is not perfect.  The HAL_Delay function contains an empty loop inside, and our program cannot do something else at this time.  There are two ways to solve the problem: using interrupts and using a real-time operating system.  I will write about the operating system another time, and we will learn to work with interruptions now. <br><br><h3>  3. Timer and interrupts </h3><br>  Set the timer, for example TIM1.  To do this, in the Pinout tab, select the clock source for this timer: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/afe/401/cdf/afe401cdfcc9443c984432b2a8a7827a.jpg"></div><br>  The source of clocking was the internal clock frequency of the periphery, which is 108MHz in our case.  You can refine this value or change it by dividing the main clock frequency on the Clock Configuration tab. <br><br>  Now go to the Configuration tab and configure the frequency of the timer.  We press the TIM1 button and in the appeared window in the Parameter Settings tab we set the values ‚Äã‚ÄãPrescaler and Counter Period. <br><br><img src="https://habrastorage.org/files/1f2/76e/8fc/1f276e8fca4b4e88aef2303d2b4c0dc4.jpg"><br><br>  Note that the division factors must be reduced by 1 from the desired values.  In fact, the timer interrupt frequency can be found by the formula: <br><br><blockquote>  Update_event = TIM_CLK / ((PSC + 1) * (ARR + 1) * (RCR + 1)) </blockquote><br>  In our case, the frequency will be equal to 216e6 / ((53999 + 1) * (1999 + 1)) = 2 Hz.  The flashing frequency of the LED will be 1Hz, as in the previous example. <br><br>  Now on the tab of the interrupt controller (NVIC Settings) you need to enable the TIM1 Update interrupt: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/d19/aeb/4da/d19aeb4da6974a24b6265f27e1b125ca.jpg"></div><br><br>  At this work in the STM32CubeMX finished, you can generate the code.  In the source code, we first need to start the timer itself, and then insert an interrupt handler that will flash the LED: <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/* USER CODE BEGIN 0 */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">HAL_TIM_PeriodElapsedCallback</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(TIM_HandleTypeDef *htim)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (htim-&gt;Instance==TIM1) <span class="hljs-comment"><span class="hljs-comment">//check if the interrupt comes from TIM1 { HAL_GPIO_TogglePin(Led_GPIO_Port, Led_Pin); //Toggle the state of pin } } /* USER CODE END 0 */ int main(void) { ... /* USER CODE BEGIN 2 */ //  HAL_TIM_Base_Start_IT(&amp;htim1); /* USER CODE END 2 */ /* Infinite loop */ /* USER CODE BEGIN WHILE */ while (1) { /* USER CODE END WHILE */ /* USER CODE BEGIN 3 */ //  ,      . } /* USER CODE END 3 */ }</span></span></code> </pre><br>  Compile and fill the firmware.  As expected, the LED flashes in the same way as in the previous example.  However, since it is now interrupted, the processor is free to perform any other tasks. <br><br><h3>  4. What's next? </h3><br>  On this I finish the first part.  What is planned next?  In the next part, I plan to describe the work with the built-in DAC and touch on the topic of DMA.  As a small announcement: we will learn to generate such a beautiful sine wave: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/b46/4b3/457/b464b34579a14e81ac5f4dce7aebacc0.jpg"></div><br>  <em>(This sinusoid is not very beautiful, in fact, but it will be better).</em> <br><br>  Future plans: work with USB controllers (for starters in VCP mode, virtual COM port), Ethernet controller, ADC, and, perhaps, we will touch on the use of FreeRTOS. <br><br><h3>  PS </h3><br>  The examples given in the article were also implemented on the Nucleo F767ZI (microcontroller STM32F767ZI) board, in IDE Atollic TrueStudio.  They can be downloaded here: <a href="https://github.com/arktur04/stm32-habr">https://github.com/arktur04/stm32-habr</a> </div><p>Source: <a href="https://habr.com/ru/post/310742/">https://habr.com/ru/post/310742/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../310732/index.html">Looking for errors in Mono: hundreds of them</a></li>
<li><a href="../310734/index.html">Lecture by Jimmy Wales, founder of Wikipedia, in Yandex</a></li>
<li><a href="../310736/index.html">BGP protocol in Quagga</a></li>
<li><a href="../310738/index.html">Logging Git revision in Java using Maven</a></li>
<li><a href="../310740/index.html">How to rewrite the SDK in TypeScript, upgrade the platform and do not regret anything</a></li>
<li><a href="../310744/index.html">Techniques in Elixir for Beginners: Trial and Error (Translation)</a></li>
<li><a href="../310748/index.html">Y Combinator: female programmers answer sensitive questions</a></li>
<li><a href="../310756/index.html">5 Fellowships in Computer Science</a></li>
<li><a href="../310770/index.html">We connect log4net. Step-by-step instruction</a></li>
<li><a href="../310774/index.html">Yahoo user accounts are compromised.</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>