<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>CombGuid. Generating SQL-Friendly Guid Server Values ‚Äã‚Äãin .net Applications</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Using uuid as a primary key for tables has many advantages, one of which is the ability to get identifiers for objects created in the client applicati...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>CombGuid. Generating SQL-Friendly Guid Server Values ‚Äã‚Äãin .net Applications</h1><div class="post__text post__text-html js-mediator-article">  Using <a href="http://ru.wikipedia.org/wiki/UUID">uuid</a> as a primary key for tables has many advantages, one of which is the ability to get identifiers for objects created in the client application without having to contact the database server.  But using uuid as a primary key also has a drawback: guids generated by the client application may not be ‚Äúfriendly‚Äù to the SQL server, which in turn can lead to an overhead when adding a new record.  The possible increase in the cost of the insert operation results from the fact that the SQL server for storing the tables for which the primary key is specified usually uses structures known as <a href="http://ru.wikipedia.org/wiki/B-%25D0%25B4%25D0%25B5%25D1%2580%25D0%25B5%25D0%25B2%25D0%25BE">b-trees</a> .  When adding a new record to a table, the SQL server, in accordance with the sorting according to the primary key, searches for the sheet on which the inserted record should be placed.  Given the pseudo-random algorithm for generating uuid, the sorting order of the new record is also random and it is possible that the sheet on which the record should be placed is completely filled.  In such cases, the SQL server has to split the sheet in two and rebuild the branches of the b-tree leading to this sheet.  In order not to push the SQL server with the need to constantly rebuild the cluster index when adding new records, you can generate the primary key values ‚Äã‚Äãin an incremental sequence.  One of the options for generating Guid in increasing order is to tie the sorting order generated by Guid to the current time.  The similarly generated identifiers are often called CombGuid, hinting that they are made up of two halves ‚Äî a pseudo-random part, like the usual Guid, and a string tied to time. <br><a name="habracut"></a><br><h5>  How SQL Server compares uuids </h5><br>  SQL Server sorts uuid values ‚Äã‚Äãin a way other than .net.  Comparison is conducted by byte groups from right to left.  Inside the byte group, the comparison is already left-to-right.  (A byte group is a sequence bounded by the '-' character.) If you compare the two uuid values, <br>  @ u1 = '206AEBE7-ABF0-47A8-8AA5-6FDDF39B9E4F' <br>  and <br>  @ u2 = '0F8257A1-B40C-4DA0-8A37-8BBC55183CAE', the output is that @ u2&gt; @ u1, because, as mentioned above, the SQL server starts the comparison with the rightmost byte groups, where 6FDDF39B9E4F &lt;8BBC55183CAE.  More technically, bytes 9 through 15 have the greatest effect on the sorting order of uuid in databases, in descending order. <br><br><h5>  Implementing CombGuid in the Magnum Library </h5><br>  In our project, we use the <a href="http://magnum-project.net/">Magnum</a> library, part of which is the static CombGuid class with the only Generate () method that creates time-bound Guids.  Magnum is an open source library hosted on <a href="https://github.com/phatboyg/Magnum">GitHub</a> .  I was not lazy and looked at how the implementation of the Guid creation method looks in this library. <br><br><pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">CombGuid</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> DateTime _baseDate = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DateTime(<span class="hljs-number"><span class="hljs-number">1900</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> Guid </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Generate</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] guidArray = Guid.NewGuid().ToByteArray(); DateTime now = DateTime.Now; <span class="hljs-comment"><span class="hljs-comment">// Get the days and milliseconds which will be used to build the byte string var days = new TimeSpan(now.Ticks - _baseDate.Ticks); TimeSpan msecs = now.TimeOfDay; // Convert to a byte array // Note that SQL Server is accurate to 1/300th of a millisecond so we divide by 3.333333 byte[] daysArray = BitConverter.GetBytes(days.Days); byte[] msecsArray = BitConverter.GetBytes((long)(msecs.TotalMilliseconds/3.333333)); // Reverse the bytes to match SQL Servers ordering Array.Reverse(daysArray); Array.Reverse(msecsArray); // Copy the bytes into the guid Array.Copy(daysArray, daysArray.Length - 2, guidArray, guidArray.Length - 6, 2); Array.Copy(msecsArray, msecsArray.Length - 4, guidArray, guidArray.Length - 4, 4); return new Guid(guidArray); } }</span></span></code> </pre> <br>  The algorithm is pretty simple. <br>  The number of days since January 1, 1900 is encoded in 9-10 bytes.  <s>We must not forget to re-compile the source in 2079, when the number of past days will no longer fit into two bytes.</s>  11-15 bytes are used to encode milliseconds from the beginning of the day, for some reason divided into 3.333333.  The comments in the code indicate that this operation is related to the fact that the accuracy of storing timestamps in SQL Server is 1/300 of a second.  A rather strange decision, considering that in the process of generating uuid, it doesn‚Äôt matter how much the SQL server stores timestamps, we use milliseconds only to create uuid.  I googled this question a little, but I understood only that Magnum library author Chris Patterson copied the CombGuid generation code from Nhibernate.  As you can see <a href="">here</a> , the GenerateComb method contains the same code.  To be fair, it should be noted that the division of milliseconds by 3.333333 does not have a special effect on the operation of the algorithm, it is just an extra, optional step. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h5>  Guid vs CombGuid.  Compare the speed of insertion in the database </h5><br>  Finally, we came to what it all was about, compared to how many uuids generated by the Guid.NewGuid () method are slower than their counterparts created through CombGuid.Generate () in the context of inserting records into the SQL server table. <br>  For the test, I created two scripts that create tables on the SQL server and insert 100000 rows into these tables.  The first script inserts rows with Id created using the CombGuid.Generate () method into the database, the second using the Guid.NewGuid () method. <br><br>  A piece of test script. <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">USE</span></span> [CombIdTest] <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-comment"><span class="hljs-comment">--   DBCC DROPCLEANBUFFERS; DBCC FREEPROCCACHE; CREATE TABLE [dbo].[CombId]( [ID] [uniqueidentifier] NOT NULL, [Value] [varchar](4000) NOT NULL, CONSTRAINT [PK_CombId] PRIMARY KEY CLUSTERED ( [ID] ASC )WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY] ) ON [PRIMARY] GO --      begin transaction insert into CombId Values ('5cb31d3d-3793-428e-beb0-a2e4047e255c','somevalue'); insert into CombId Values ('1e905fa1-e4d4-4a2c-a185-a2e4047e255d','somevalue'); --  99998  insert commit transaction</span></span></code> </pre><br>  Before performing the insertion, the buffer caches are reset and the insertion itself is performed in one transaction in order to reduce the number of accesses to the transaction log.  Each script was launched three times, the ‚ÄúTotal execution time‚Äù parameter from the client statistics was taken as the runtime.  Measurements were made on MSSQL Server 2012. <br><br>  Measurement results (in milliseconds). <br><table><tbody><tr><td></td><td>  one </td><td>  2 </td><td>  3 </td><td>  The average </td></tr><tr><td>  Combguid </td><td>  2795 </td><td>  2882 </td><td>  2860 </td><td>  2845,667 </td></tr><tr><td>  Randomguid </td><td>  3164 </td><td>  3129 </td><td>  3111 </td><td>  3134,667 </td></tr></tbody></table><br>  The advantage of a script that inserts records containing CombGuid is just over 10 percent over a script with ‚Äúregular‚Äù uuid.  The use of CombGuid also had a positive effect on the size of the table - its size was almost one and a half times smaller: 3.75 MB vs. 5.25 MB. <br><br><h5>  Well, a couple of questions for last </h5><br>  <b>What do you use as primary keys in your databases?</b> <b><br></b>  <b>If you use uuid or similar byte structures, how do you generate them?</b> <br></div><p>Source: <a href="https://habr.com/ru/post/214667/">https://habr.com/ru/post/214667/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../214653/index.html">As we Russian firms investigated</a></li>
<li><a href="../214655/index.html">Sports robotics: an interview with a member of RobotChallenge 2014</a></li>
<li><a href="../214657/index.html">Facebook is going to cover Africa with a network of "atmospheric satellites"</a></li>
<li><a href="../214663/index.html">The logic of thinking. Part 5. Waves of the brain</a></li>
<li><a href="../214665/index.html">Business card on the Arduino with Tetris on board</a></li>
<li><a href="../214669/index.html">Central Bank refutes "immediate ban on cryptocurrency" in Russia</a></li>
<li><a href="../214673/index.html">Yandex considered when different organizations work and do not work</a></li>
<li><a href="../214677/index.html">Tesla Motors Announces European Expansion Plan</a></li>
<li><a href="../214679/index.html">New Yandex.Disk interface. How did we do it and why in general do it</a></li>
<li><a href="../214681/index.html">FineReader 12: new in the interface and the complexity of converting achievements to percentages</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>