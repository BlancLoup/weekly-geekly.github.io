<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Windows Azure Management Libraries - managing cloud infrastructure from .NET applications</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This article describes the recently released Windows Azure Management Libraries for managing .NET applications from the cloud infrastructure, services...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Windows Azure Management Libraries - managing cloud infrastructure from .NET applications</h1><div class="post__text post__text-html js-mediator-article"> <a href="http://www.windowsazure.com/en-us/pricing/free-trial/%3FWT.mc_id%3DA398D1F7B"><img alt="image" src="https://habrastorage.org/getpro/habr/post_images/5d6/f02/fa8/5d6f02fa8263beb3e216389a9397974e.jpg"></a> <br><br>  This article describes the recently released Windows Azure Management Libraries for managing .NET applications from the cloud infrastructure, services and storage elements hosted in <a href="http://www.windowsazure.com/ru-ru/pricing/free-trial/%3FWT.mc_id%3DAF078DAA2">Windows Azure</a> .  A description of the capabilities of the libraries is given on examples of the code of a WPF application. <br><br><h3>  What are Windows Azure Management Libraries? </h3><br>  With the release of the Windows Azure Management Libraries, a wide part of the Windows Azure cloud infrastructure can be accessed and automated from .NET applications.  These libraries run on top of the open REST API functions of the platform and their release is intended to facilitate the developer‚Äôs work with cloud infrastructure. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The library preview available today includes support for cloud services (Cloud Services), virtual machines and networks, web sites (Web Sites), storage accounts and infrastructure elements such as accessibility groups (Affinity Groups). <br><br>  We spent a lot of time designing the natural .NET Framework API, which transparently represents the underlying open REST API.  It was very important for us to present these services with the help of modern familiar to developers approaches used on the .NET platform: <br><br><ul><li>  Portable Class Library (PCL) support for .NET Framework 4.5, Windows Phone 8, Windows Store and Silverlight; </li><li>  distributed as NuGet packages with a minimum of dependencies to facilitate versioning; </li><li>  support for asynchronous and asynchronous operations based on async / await platform elements (with an easy option to implement synchronous overloaded methods); </li><li>  common infrastructure for unified error handling, tracing, configuration, and management of the HTTP pipeline; </li><li>  designed for ease of testing and mocking; </li><li>  built on popular libraries like HttpClient and Json.NET. </li></ul><br>  These packages offer you rich possibilities and ease of management, automation, deployment and testing of WIndows Azure cloud infrastructure.  With them, you can manage virtual machines, cloud services, virtual networks, websites and key infrastructure components of the platform. <br><a name="habracut"></a><br><h3>  Beginning of work </h3><br>  As with any other SDK, in order to find out how we work with it is best to learn a little bit of code.  No code should be written to solve a problem that actually does not exist, so let's first formulate what problem the Windows Azure Management Libraries libraries solve: <br><blockquote>  <em>I have a process that I run on Windows Azure as a Worker Role.</em>  <em>Everything works great, but this process, in fact, needs to be run only a few times a week.</em>  <em>It would be great to be able to start a new service, place my code in it and then start its execution.</em>  <em>It would be very good if after the execution of the service, the code reported this back, so that we could delete it automatically.</em>  <em>Sometimes, I forget to turn off this service manually, so I may have extra expenses when it remains on after executing the code.</em>  <em>It would be great to be able to automate the creation of the infrastructure I need, its launch and subsequent self-destruction.</em> <br></blockquote>  Prior to the release of the Windows Azure Management Libraries (abbreviated, though not officially, WAML), the solution to the described problem was not an easy task.  True, there are already a number of excellent opensource libraries from the community that offer a .NET layer for managing Windows Azure services, however, none of them has the full implementation of the Windows Azure Management REST API functions or the full-fledged implementation of C # features.  When creating your own layer for managing the power of your Windows Azure cloud, you will definitely have to write your own HTTP / XML code to exchange requests with the REST API.  This is not the most interesting thing to do in life.  Tedious and boring work, especially after you implement your second dozen of the hundreds of API methods. <br><br><h3>  Installing Management Libraries </h3><br>  I decided to implement the task in the form of a simple WPF application that will run on my desktop.  Since I will have a cloud service with a working role running in the cloud, I have combined all three projects into a single solution, which you can see below: <br><br> <a href=""><img title="a123" alt="a123" src="https://habrastorage.org/getpro/habr/post_images/bb4/f65/815/bb4f658154eb412160b99070e19d9276.png" width="800" height="484"></a> <br><br>  You probably noticed that I was preparing to add some NuGet packages to my application.  This is due to the fact that Windows Azure Management Libraries are distributed as separate NuGet packages.  I‚Äôm going to select the <a href="http://www.nuget.org/packages/Microsoft.WindowsAzure.Management.Libraries">Microsoft.WindowsAzure.Management.Libraries</a> package <a href="http://www.nuget.org/packages/Microsoft.WindowsAzure.Management.Libraries">,</a> and it alone will install all the libraries available in Management Libraries.  If I want to manage only one aspect of Windows Azure, then instead of adding all the libraries, I can install only one specific package, for example, <a href="http://www.nuget.org/packages/Microsoft.WindowsAzure.Management.WebSites">Microsoft.WindowsAzure.Management.WebSites</a> , which offers functionality to manage only the Windows Azure Web Sites infrastructure. <br><br> <a href=""><img title="a124" alt="a124" src="https://habrastorage.org/getpro/habr/post_images/b80/0e8/159/b800e81595c6ebfc4854876de72248f1.png" width="800" height="533"></a> <br><br>  After adding the link to the package, I have everything I need to configure client authentication between my WPF application and the Windows Azure REST API. <br><br><h3>  Client authentication </h3><br>  The first user authentication implementation we wrote for WAML and Windows Azure was based on the X509 certificate mechanism.  Recently, Windows Azure for .NET SDK 2.2, Visual Studio, and PowerShell added built-in authentication based on user accounts.  We are currently working on its support in WAML.  The currently available release of WAML only supports certificate-based authentication; however, stay tuned, we are working to add account-based authentication support to the library. <br><br>  I will not focus on discussing the use of certificate-based authentication.  On the contrary, I intend to proceed as soon as possible to the discussion of functional things in our article.  I need information about just two elements to connect to the Windows Azure REST API: <br><br><ul><li>  Subscription ID (Subscription ID); </li><li>  Management Certificate (Management Certificate). </li></ul><br>  I got these values ‚Äã‚Äãfrom one of my publish settings files.  Below you can see the XML content of such a file: <br><br> <a href=""><img title="a125" alt="a125" src="https://habrastorage.org/getpro/habr/post_images/8c0/43d/314/8c043d314705ea0bc995cb53482bf766.png" width="800" height="391"></a> <br><br>  Using the key and subscription identifier later in my code, I can call the GetCredentials method, which returns an instance of the abstract <strong>SubscriptionCloudCredentials</strong> class, which we use in the code of the Library Library to represent data about user access parameters.  With this approach, if I want to add account-based authentication in the future, it will be much easier for me to replace the authentication mechanism.  The code for the <strong>CertificateAuthenticationHelper</strong> class from my example is shown below: <br><br><pre><code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Microsoft.WindowsAzure; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Security.Cryptography.X509Certificates; <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">MyCloudServiceManager</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">internal</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">CertificateAuthenticationHelper</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> SubscriptionCloudCredentials </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetCredentials</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> subscrtionId, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> base64EncodedCert</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CertificateCloudCredentials(subscrtionId, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> X509Certificate2(Convert.FromBase64String(base64EncodedCert))); } } }</code> </pre> <br>  Now, I'll write a controller class that will work on the interaction between a WPF application and Management Libraries libraries. <br><br><h3>  Control layer </h3><br>  In order to take into account all the possible parameters that will be used in my service, I created the class <strong>ManagementControllerParameters.</strong>  This class contains all the data that I need to create services and place in the cloud of my code. <br><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">MyCloudServiceManager</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">internal</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ManagementControllerParameters</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">internal</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Region { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">internal</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> StorageAccountName { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">internal</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> CloudServiceName { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">internal</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> PackageFilePath { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">internal</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ConfigurationFilePath { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> SubscriptionId { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Base64EncodedCertificate { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } } }</code> </pre> <br>  Then I created a class that contains convenient functionality for the interaction between the user interface and the Management Library layer.  This class is created for cleaner code in the UX layer later on.  Pay attention to the constructor code.  It creates two clients.  First, the <strong>StorageManagementClient is</strong> designed to manage storage accounts.  The second <strong>ComputeManagementClient</strong> offers the opportunity to work with the computing power of Windows Azure - cloud services and virtual machines, their locations, and so on. <br><br>  In order to divide the code between the files into different functional parts, I created the <strong>ManagementCont</strong> -partial-class <strong>, the</strong> code of which is available to you in a <a href="https://gist.github.com/bradygaster/4822fc0beebb7226af22">public Gist</a> , so that you can use it in your own projects. <br><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Microsoft.WindowsAzure; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Microsoft.WindowsAzure.Management.Compute; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Microsoft.WindowsAzure.Management.Storage; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System; <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">MyCloudServiceManager</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">internal</span></span> <span class="hljs-keyword"><span class="hljs-keyword">partial</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ManagementController</span></span> : <span class="hljs-title"><span class="hljs-title">IDisposable</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> StorageManagementClient _storageManagementClient; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> ManagementControllerParameters _parameters; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> ComputeManagementClient _computeManagementClient; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ManagementController</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ManagementControllerParameters parameters</span></span></span><span class="hljs-function">)</span></span> { _parameters = parameters; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> credential = CertificateAuthenticationHelper.GetCredentials( parameters.SubscriptionId, parameters.Base64EncodedCertificate); _storageManagementClient = CloudContext.Clients.CreateStorageManagementClient(credential); _computeManagementClient = CloudContext.Clients.CreateComputeManagementClient(credential); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Dispose</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_storageManagementClient != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) _storageManagementClient.Dispose(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_computeManagementClient != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) _computeManagementClient.Dispose(); } } }</code> </pre> <br>  Now, let's create some clients to manage the cloud and do some work. <br><br><h3>  Creating a new storage account </h3><br>  The first thing we need to implement the strategy of our service is the storage account.  The service will use the .cspkg package file created in Visual Studio based on the cloud service project.  It must be placed as a blob in the Windows Azure storage.  Before I can do this, I need to create an account in which the package file can be downloaded to the repository.  The code below is intended to create a storage account in the specified region: <br><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Microsoft.WindowsAzure.Management.Storage; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Microsoft.WindowsAzure.Management.Storage.Models; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Threading.Tasks; <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">MyCloudServiceManager</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">internal</span></span> <span class="hljs-keyword"><span class="hljs-keyword">partial</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ManagementController</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> Task </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CreateStorageAccount</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> _storageManagementClient.StorageAccounts.CreateAsync( <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StorageAccountCreateParameters { Location = _parameters.Region, ServiceName = _parameters.StorageAccountName }); } } }</code> </pre> <br>  After the storage account is created, I can use it.  I need a connection string to connect my application (and my ‚Äúsoon-to-be-created‚Äù cloud service) to the repository.  I wrote a method that is responsible for obtaining connection keys to the Windows Azure storage through the REST API.  Then, I form a connection string and return it to the calling code. <br><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Microsoft.WindowsAzure.Management.Storage; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Globalization; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Threading.Tasks; <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">MyCloudServiceManager</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">internal</span></span> <span class="hljs-keyword"><span class="hljs-keyword">partial</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ManagementController</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> Task&lt;</span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function">&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetStorageAccountConnectionString</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> keys = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> _storageManagementClient.StorageAccounts.GetKeysAsync(_parameters.StorageAccountName); <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> connectionString = <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Format( CultureInfo.InvariantCulture, <span class="hljs-string"><span class="hljs-string">"DefaultEndpointsProtocol=https;AccountName={0};AccountKey={1}"</span></span>, _parameters.StorageAccountName, keys.SecondaryKey); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> connectionString; } } }</code> </pre> <br>  Now, after creating a storage account, I can create a cloud service and publish my package to Windows Azure. <br><br><h3>  Creation and deployment of a new cloud service </h3><br>  The code needed for a cloud service is surprisingly simple.  All we need is to specify the name of the service and the region in which it should be created. <br><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Microsoft.WindowsAzure.Management.Compute; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Microsoft.WindowsAzure.Management.Compute.Models; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Threading.Tasks; <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">MyCloudServiceManager</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">internal</span></span> <span class="hljs-keyword"><span class="hljs-keyword">partial</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ManagementController</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> Task </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CreateCloudService</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> _computeManagementClient.HostedServices.CreateAsync(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HostedServiceCreateParameters { Location = _parameters.Region, ServiceName = _parameters.CloudServiceName }); } } }</code> </pre> <br>  Finally, all that remains for me to host a cloud service is to load the service package file created in Visual Studio into a blob, and then call the REST API.  This call will consist of the blob address in which the package is located and the XML data obtained from the configuration file of the cloud project.  This code uses the <a href="http://www.nuget.org/packages/windowsazure.storage">Windows Azure Storage SDK</a> library, which is available as a NuGet package. <br><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Microsoft.WindowsAzure.Management.Compute; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Microsoft.WindowsAzure.Management.Compute.Models; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Microsoft.WindowsAzure.Storage; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Microsoft.WindowsAzure.Storage.Blob; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.IO; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Threading.Tasks; <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">MyCloudServiceManager</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">internal</span></span> <span class="hljs-keyword"><span class="hljs-keyword">partial</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ManagementController</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> Task </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DeployCloudService</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> storageConnectionString = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> GetStorageAccountConnectionString(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> account = CloudStorageAccount.Parse(storageConnectionString); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> blobs = account.CreateCloudBlobClient(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> container = blobs.GetContainerReference(<span class="hljs-string"><span class="hljs-string">"deployments"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> container.CreateIfNotExistsAsync(); <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> container.SetPermissionsAsync( <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BlobContainerPermissions() { PublicAccess = BlobContainerPublicAccessType.Container }); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> blob = container.GetBlockBlobReference( Path.GetFileName(_parameters.PackageFilePath)); <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> blob.UploadFromFileAsync(_parameters.PackageFilePath, FileMode.Open); <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> _computeManagementClient.Deployments.CreateAsync(_parameters.CloudServiceName, DeploymentSlot.Production, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DeploymentCreateParameters { Label = _parameters.CloudServiceName, Name = _parameters.CloudServiceName + <span class="hljs-string"><span class="hljs-string">"Prod"</span></span>, PackageUri = blob.Uri, Configuration = File.ReadAllText(_parameters.ConfigurationFilePath), StartDeployment = <span class="hljs-literal"><span class="hljs-literal">true</span></span> }); } } }</code> </pre> <br>  All code needed to create an application in Windows Azure is created.  Finally, it remains to write some code to destroy the application in the cloud. <br><br><h3>  Deleting items in the Windows Azure cloud </h3><br>  Removing items in Windows Azure using the Windows Azure Management Libraries libraries is as easy as creating them.  The code below clears the created storage, then it simultaneously removes the placed code and the cloud service itself. <br><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Microsoft.WindowsAzure.Management.Storage; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Microsoft.WindowsAzure.Management.Compute; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Microsoft.WindowsAzure.Management.Compute.Models; <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">MyCloudServiceManager</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">internal</span></span> <span class="hljs-keyword"><span class="hljs-keyword">partial</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ManagementController</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Cleanup</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { _computeManagementClient.Deployments.DeleteBySlot(_parameters.CloudServiceName, DeploymentSlot.Production); _computeManagementClient.HostedServices.Delete(_parameters.CloudServiceName); _storageManagementClient.StorageAccounts.Delete(_parameters.StorageAccountName); } } }</code> </pre> <br>  Given all the convenience of writing the previous code, the code for the user interface should be relatively simple. <br><br><h3>  User interface </h3><br>  The user interface for our application is relatively simplified.  I just placed a couple of buttons on a WPF form.  The first allows you to create the necessary elements in Windows Azure and to place the code.  The second removes elements from the cloud.  Below is the XAML code: <br><br><pre> <code class="hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Window</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">x:Class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"MyCloudServiceManager.MainWindow"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://schemas.microsoft.com/winfx/2006/xaml/presentation"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:x</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://schemas.microsoft.com/winfx/2006/xaml"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Title</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Deploy Service"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Height</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"166"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Width</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"308"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Grid</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Grid.ColumnDefinitions</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ColumnDefinition</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Width</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"112*"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ColumnDefinition</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Width</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"125*"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Grid.ColumnDefinitions</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Button</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">x:Name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"_createButton"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Content</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Create"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">HorizontalAlignment</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Left"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">VerticalAlignment</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Top"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Width</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"75"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Margin</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"73,80,0,0"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Grid.Column</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"1"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Click</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"_createButton_Click"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Button</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">x:Name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"_deleteButton"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Content</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Delete"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">HorizontalAlignment</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Left"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">VerticalAlignment</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Top"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Width</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"75"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Margin</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"73,105,0,0"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Grid.Column</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"1"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Click</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"_deleteButton_Click"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Grid</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Window</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  The control code is also very simple.  In the event handler for clicking on the <strong>Create</strong> button, I create an instance of <strong>ManagementController</strong> , passing it all the necessary parameters to create application components in Windows Azure.  Then I call the controller methods to create items in the cloud. <br><br>  I also handle the event of pressing the <strong>Delete</strong> button <strong>,</strong> deleting and clearing all the elements created earlier in the cloud. <br><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Microsoft.WindowsAzure.Management.Models; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.IO; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Windows; <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">MyCloudServiceManager</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">partial</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">MainWindow</span></span> : <span class="hljs-title"><span class="hljs-title">Window</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> ManagementController _controller; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MainWindow</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { InitializeComponent(); } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> _createButton_Click(<span class="hljs-keyword"><span class="hljs-keyword">object</span></span> sender, RoutedEventArgs e) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_controller == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { _controller = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ManagementController( <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ManagementControllerParameters { Base64EncodedCertificate = <span class="hljs-string"><span class="hljs-string">"MIIKXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX"</span></span>, SubscriptionId = <span class="hljs-string"><span class="hljs-string">"66c15fe5-XXXX-XXXX-XXXX-XXXXXXXXXX"</span></span>, CloudServiceName = <span class="hljs-string"><span class="hljs-string">"ManagementLibraryDemoSvc01"</span></span>, ConfigurationFilePath = <span class="hljs-string"><span class="hljs-string">"ServiceConfiguration.Cloud.cscfg"</span></span>, PackageFilePath = <span class="hljs-string"><span class="hljs-string">"MyCloudService.cspkg"</span></span>, Region = LocationNames.WestUS, StorageAccountName = Path.GetFileNameWithoutExtension(Path.GetRandomFileName()) }); } <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> _controller.CreateStorageAccount(); <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> _controller.CreateCloudService(); <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> _controller.DeployCloudService(); } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> _deleteButton_Click(<span class="hljs-keyword"><span class="hljs-keyword">object</span></span> sender, RoutedEventArgs e) { _controller.Cleanup(); } } }</code> </pre> <br>  You can modify this code to use the capabilities of the Windows Storage SDK to monitor on the client side the message queue in the cloud storage.  After the cloud service has completed its work, it will send a message to the queue in the cloud.  The message will be received by the client, who will call the Cleanup method and remove all application components from the cloud. <br><br><h3>  Endless automation </h3><br>  Windows Azure Management Libraries offer a great layer of automation between your code and Windows Azure.  You can use these libraries to automate the entire spectrum of processes for creating and deleting Windows Azure components.  In the current version, we offer libraries for managing computing capacity and cloud storage, as well as Windows Azure Web Sites components.  Over time, we will add more functions to the libraries.  Our goal is to provide you with the ability to automate the execution of any task in Windows Azure. <br><br>  We look forward to your feedback on working with libraries.  Please try, experiment with Management Libraries and let us know to facilitate what tasks you use them.  We are open to any of your ideas or questions.  The library code is open, like the code for many other libraries for Windows Azure, you can find it in our <a href="https://github.com/WindowsAzure/azure-sdk-for-net">repository on GitHub</a> . </div><p>Source: <a href="https://habr.com/ru/post/201566/">https://habr.com/ru/post/201566/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../201554/index.html">Video lectures on 3D bioprinting (conducted by Dr. B. Novoselov, Ph.D., by MD, Ph.D., V. Mironov)</a></li>
<li><a href="../201556/index.html">Unique Carnegie Mellon University Password Database Study</a></li>
<li><a href="../201558/index.html">Zend's new ZCPE certificate based on PHP 5.5</a></li>
<li><a href="../20156/index.html">My computer. More often mine.</a></li>
<li><a href="../201564/index.html">Unite extension overview and setup</a></li>
<li><a href="../201568/index.html">Create backup copies of SQL Server 2014 CTP2 database in Windows Azure</a></li>
<li><a href="../201572/index.html">Sprite Lamp: dynamic lighting of 2D objects</a></li>
<li><a href="../201574/index.html">Smart Resize and other winners of Nokia Future / Capture</a></li>
<li><a href="../201576/index.html">OllyDbg 2.01</a></li>
<li><a href="../201578/index.html">How to make a contribution to Kickstarter, get the goods + pick up your money? The story of one deception</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>