<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Decreased SharePoint performance while increasing unique Security Scopes on large lists</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello! 

 In this article, we decided to share our life observations on the performance problem of large lists in SharePoint. 

 So, we quite often co...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Decreased SharePoint performance while increasing unique Security Scopes on large lists</h1><div class="post__text post__text-html js-mediator-article">  Hello! <br><br>  In this article, we decided to share our life observations on the performance problem of large lists in SharePoint. <br><br>  So, we quite often come across situations where there is a list on the SharePoint portal in which, for example, user requests are stored and processed.  In addition, there is always a desire to ensure that all applications are stored in one place, on the other hand, only the user who submitted the application and the group or groups of users who participate in its processing have rights to these elements. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <a name="habracut"></a>  First, some terminology: <br><br>  <a href="http://technet.microsoft.com/en-us/library/cc962007.aspx">ACL (Access Control List)</a> is an ordered list of principals that define the rights to an element or group of elements. <br><br>  <a href="http://sharingthepoint.blogspot.ru/2010/09/sharepoint-security-model.html">Security Scopes</a> - a set of pairs of groups or user + ACL. <br><br><h5>  Microsoft recommendations </h5><br>  Microsoft <a href="http://technet.microsoft.com/en-us/library/cc262787.aspx">recommends</a> following fairly simple rules: avoid the number of simultaneous Security Scopes of more than 5,000 per document library or per list. <br><br>  Why is that?  Where did the restriction come from?  First, let's answer the question of how MS SharePoint handles the request to the list. <br><br><ol><li>  Makes a call to the database content and reads: <br>  a.  List metadata, i.e.  definition of field lists, etc. <br>  b.  Computed fields, event handler definitions, and more. <br>  c.  All scope of the list (more precisely the presentation). </li><li>  On the side, the front-end determines: the user falls into scope. </li><li>  Pulls already directly data. </li></ol><br>  There are explanations for this approach, and they are associated with supporting the model of external membership providers and roles in the first place (AD, that is, AD is the most widely distributed membership and role provider). <br><br>  In practice, it can be seen that problems start already with 1000 elements with unique rights. <br><br>  Using <a href="http://reality-tech.com/2012/03/19/clarifying-the-security-scope-limits-in-sharepoint-lists/">these</a> SQL queries, you can calculate how much Security Scopes you currently have: <br><br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> [SiteId], [ScopeId], [RoleDefWebId], [WebId], [ScopeUrl], [Acl] <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> [your <span class="hljs-keyword"><span class="hljs-keyword">Content</span></span> DB].[dbo].[Perms] <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> scopeurl</code> </pre> <br><br>  An even better query exposes the web URL <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> [fullurl],perms.[SiteId] , perms.[ScopeId], [RoleDefWebId], [WebId], [ScopeUrl], [Acl] <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> [dbo].[Perms],[dbo].allwebs <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> perms.WebId = allwebs.id <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> scopeurl</code> </pre><br><br>  As an aside, you can see the number of security principals per scope using this SQL: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COUNT</span></span>(ra.PrincipalId) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">Count</span></span>],p.ScopeUrl <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> RoleAssignment ra <span class="hljs-keyword"><span class="hljs-keyword">with</span></span>(nolock) <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> Perms p <span class="hljs-keyword"><span class="hljs-keyword">with</span></span>(nolock) <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> p.SiteId = ra.SiteId <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> p.ScopeId = ra.ScopeId <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> p.ScopeUrl <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> p.ScopeUrl <span class="hljs-keyword"><span class="hljs-keyword">desc</span></span></code> </pre><br><br>  How Microsoft proposes to solve the problem: <br><br><ol><li>  Use folders to encapsulate permissions on groups of elements with similar rights. </li><li>  Split into different lists or document libraries and use inherited rights. </li><li>  Never go beyond the limit of 5,000 unique rights to the sheet. </li></ol><br>  What causes the violation of these recommendations: <br><br><ol><li>  20% decrease in performance for every 1,000 unique rights on a sheet. </li><li>  Software errors when attempting to sever rights on an element and issue unique ones. </li></ol><br>  For MS SharePoint-based solutions, it is critical that the farm has a load, and here's why. <br><br>  For the developer there is no transaction support.  And a set of operations of the form (create an element, break rights, issue rights to it in MS SharePoint): <br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> item = list.AddItem(...); <span class="hljs-comment"><span class="hljs-comment">// ... item.Update(); item.BreakRoleInheritance(false); item.RoleAssignments.Add(new SPRoleAssignment(...));</span></span></code> </pre><br>  will be interrupted in unexpected places, simply because the farm does not withstand the load (ie, not because of logical errors). <br><br>  It is clear that recommendations 2 and 3 are of a more intimate nature and do not solve the problem of storing elements together and unique rights, so we‚Äôll look at the first as the most effective way - using folders. <br><br><h5>  Our example </h5><br>  For example, let's take a list of a really working system, in which currently there are 132,073 elements: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/85b/044/11d/85b04411d0aa9ada895d3db4aaabe700.png"><br><br>  There are 3 590 Security Scopes - it looks like this: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/70d/155/154/70d155154db1c83c5adf282e1ae979a9.png"><br><br>  Inside the list 721 folder ...: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/e26/1e0/738/e261e073867e2093295224c7c1589249.png"><br><br>  ... for which rights are granted as follows: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/9c1/ce5/afd/9c1ce5afd55fa6940aaeeaab8f6b9d7c.png"><br><br>  According to Google Analytics, the average page load time is less than a second - at the level of visits to this particular list for this period, about 968 per day, during working hours. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/d48/11b/a3a/d4811ba3a353f8808965b6182bbfef0c.png"><br><br><h5>  Our approach </h5><br>  In accordance with our approach, rights are distributed like this: <br><br><pre> <code class="cs hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ProcessItem</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">SPListItem item, SPFolder folder</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> file = item.Web.GetFile(item.UniqueId); <span class="hljs-comment"><span class="hljs-comment">//    item.File ..      null // http://msdn.microsoft.com/ru-ru/library/microsoft.sharepoint.splistitem.file.aspx file.MoveTo(string.Format("{0}/{1}", folder.Url, item[SPBuiltInFieldId.LinkFilename])); }</span></span></code> </pre><br>  I would also like to add that if the sets of rights do not differ in permissions to read visibility, but in the possibility of change, you can use an Event Handler, which will prohibit changes. <br><br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">PermissionEventHandler</span></span> : <span class="hljs-title"><span class="hljs-title">SPItemEventReceiver</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ItemUpdating</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">SPItemEventProperties properties</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> updatingAllowed = CheckUserHasPermission(properties.Web.CurrentUser, properties.ListItem); <span class="hljs-comment"><span class="hljs-comment">//       if (!updatingAllowed) { properties.Cancel = true; properties.ErrorMessage = "Access denied"; } } public override void ItemAdding(SPItemEventProperties properties) { //... } //... }</span></span></code> </pre><br>  Before the invention of this approach, we had to engage in SharePoint for 5 years, eat a lot of dogs and cacti.  It has its own nuances, but it works absolutely exactly - it has already been tested on two portals. <br><br>  As always, we were glad to share our experience! </div><p>Source: <a href="https://habr.com/ru/post/211735/">https://habr.com/ru/post/211735/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../211725/index.html">6 concepts that should finally make me work</a></li>
<li><a href="../211727/index.html">LibRaw, Coverity SCAN, PVS-Studio</a></li>
<li><a href="../211729/index.html">Exit school of programming: what can be done with students in three days in a dark forest</a></li>
<li><a href="../211731/index.html">Wozniak: Apple needs to make a smartphone on Android</a></li>
<li><a href="../211733/index.html">Poll. How do you deploy the production server (s)?</a></li>
<li><a href="../211739/index.html">Proper Use of Yii</a></li>
<li><a href="../211741/index.html">6 things that Satya Nadella has to do right now</a></li>
<li><a href="../211743/index.html">Using CRTP Pattern in C #</a></li>
<li><a href="../211747/index.html">Do you know arrays?</a></li>
<li><a href="../211751/index.html">Just about make</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>