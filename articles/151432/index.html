<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Installing Kernel Tube Video Sharing 2.4.3 on Ubuntu 12.04</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introduction: 

 I'll try to share the installation of the tube script for uploading the video. 

 We decided not to go by writing our own script, but...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Installing Kernel Tube Video Sharing 2.4.3 on Ubuntu 12.04</h1><div class="post__text post__text-html js-mediator-article"><h4>  <b>Introduction:</b> </h4><br><br>  I'll try to share the installation of the tube script for uploading the video. <br><a name="habracut"></a><br>  We decided not to go by writing our own script, but to use third-party solutions. <br><br>  The case began back in 2010.  Then we considered the existing solutions, paid and free. <br>  <a href="http://www.master-x.com/forum/postings/1675981/">Here</a> I considered <a href="http://www.master-x.com/forum/postings/1675981/">such a list</a> like at that time.  I suppose that I could not post everything then. <br>  As a result, we stopped at Kernel Tube Video Sharing.  Product paid.  If you have not considered it yet, then I think you should at least glance at it and its possibilities (initially it seems to be focused on adult content). <br>  Do not think in any way for advertising.  Installation costs $ 40, maybe my post will help you save them and slightly reduce the time needed for installation :) <br>  Now I‚Äôm working on installing KVS on the server and decided to share my instructions.  On the Internet, I have not seen this. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Project page - <a href="http://www.kernel-video-sharing.com/ru/">www.kernel-video-sharing.com/ru</a> <br>  Demo site - <a href="http://kvs-demo.com/">kvs-demo.com</a> <br>  Demo admin - <a href="http://kvs-demo.com/admin/">kvs-demo.com/admin</a> <br><br><h4>  <b>Features of our installation</b> </h4><br>  1. Use suexec module mod_ruid2 - for greater security.  Previously, I set everything up without it. <br>  2. We have a KVS source package (since version 1.5) - therefore, we do not use the ionCube loader.  Check this point with the developers. <br><br><h4>  <b>Installing Kernel Tube Video Sharing 2.4.3 on Ubuntu 12.04</b> </h4><br>  <a href="http://www.kernel-video-sharing.com/en/requirements/">Server requirements</a> <br><br><h5>  <b>Minimum server requirements</b> </h5><br><ul><li>  PHP 5.2 or higher </li><li>  Mysql 5.0 or higher and support it in PHP </li><li>  FFmpeg 0.8 or higher with support for libfaac, libx264, libavfilter </li><li>  Yamdi </li><li>  Qt-faststart </li><li>  Imagemagick </li><li>  Curl and PHP support </li><li>  Apache + mod_rewrite + (MultiViews disabled) </li><li>  ionCube loader </li><li>  Perl &amp; CGI 3.15 or higher (not required when using Nginx) </li><li>  Not a Cyrillic domain name </li></ul><br><br><h5>  <b>Requirements for PHP</b> </h5><br><ul><li>  zlib library </li><li>  XML extension </li><li>  GD2 with true type font support (required!) </li><li>  Ability to run PHP from CLI using exec () </li><li>  PHP register_globals off </li><li>  Php magic_quotes_gpc off </li><li>  PHP safe_mode off </li><li>  PHP file_uploads on </li><li>  PHP allow_url_fopen on </li></ul><br><br><h5>  <b>Recommended options (highly desirable)</b> </h5><br><ul><li>  Memcache and PHP support </li><li>  Nginx + Apache (via reverse proxy) + NginxHttpUploadProgressModule </li></ul><br><br><h4>  <b>Installing the necessary components</b> </h4><br><br><h5>  <b>Yamdi, Imagemagick</b> </h5><br><pre><code class="bash hljs">sudo apt-get install yamdi imagemagick</code> </pre> <br><h5>  <b>Memcache, MySQL, Apache, Php</b> </h5><br><pre> <code class="bash hljs">sudo apt-get install memcached mysql-server-5.5 apache2 libapache2-mod-rpaf php5 php5-mysql php5-curl php5-cli php5-memcache php5-gd</code> </pre> <br><h5>  <b>Build tools</b> </h5><br><pre> <code class="bash hljs">sudo apt-get install build-essential checkinstall subversion git unzip</code> </pre> <br><br><h5>  <b>Install Exim</b> </h5><br><pre> <code class="bash hljs">sudo apt-get install exim</code> </pre> <br><br><h4>  <b>Exim Setup</b> </h4><br><pre> <code class="bash hljs">sudo dpkg-reconfigure exim4-config</code> </pre> <br><br><h5>  <b>Nginx installation</b> </h5><br><h6>  <b>Installing dependencies</b> </h6><br><pre> <code class="bash hljs">sudo apt-get install libssl-dev zlib1g-dev</code> </pre> <br><h6>  <b>Download Nginx sources</b> </h6><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/src/ wget http://nginx.org/download/nginx-1.2.4.tar.gz tar -zxvf nginx-1.2.4.tar.gz <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> nginx-1.2.4</code> </pre> <br><br><h6>  <b>Download additional modules</b> </h6><br><pre> <code class="bash hljs">mkdir modules <span class="hljs-comment"><span class="hljs-comment"># nginx-upload-progress-module git clone https://github.com/masterzen/nginx-upload-progress-module.git modules/nginx-upload-progress-module # nginx_mod_h264_streaming wget http://www.kernel-video-sharing.com/files/nginx_mod_h264_streaming-2.3.2.zip unzip nginx_mod_h264_streaming-2.3.2.zip -d modules/ rm -f nginx_mod_h264_streaming-2.3.2.zip</span></span></code> </pre><br><br><h6>  <b>Run the build configuration script</b> </h6><br><pre> <code class="bash hljs">./configure \ --conf-path=/etc/nginx/nginx.conf \ --error-log-path=/var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/nginx/error.log \ --pid-path=/var/run/nginx.pid \ --lock-path=/var/lock/nginx.lock \ --http-log-path=/var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/nginx/access.log \ --http-client-body-temp-path=/var/lib/nginx/body \ --http-proxy-temp-path=/var/lib/nginx/proxy \ --http-fastcgi-temp-path=/var/lib/nginx/fastcgi \ --with-debug \ --with-http_stub_status_module \ --with-http_secure_link_module \ --with-http_gzip_static_module \ --with-http_realip_module \ --with-http_mp4_module \ --with-http_flv_module \ --with-http_ssl_module \ --with-http_dav_module \ --with-md5=/usr/lib \ --add-module=modules/nginx-upload-progress-module \ --add-module=modules/nginx_mod_h264_streaming-2.3.2</code> </pre><br><br><h6>  <b>Solution to build h264 to gcc-4.6</b> </h6><br>  <a href="http://forum.nginx.org/read.php%3F21,203200,203331">Re: NGINX1.0.2 + H264 streaming-2.2.7 + Fedora 15</a> <br><pre> <code class="bash hljs">vi auto/cc/gcc</code> </pre> <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#    CFLAGS="$CFLAGS -Werror"</span></span></code> </pre> <br><br><h6>  <b>We start assembly of Nginx</b> </h6><br><pre> <code class="bash hljs">make</code> </pre> <br><br><h6>  <b>Run the build and install the deb package</b> </h6><br><pre> <code class="bash hljs">checkinstall --pkgname=nginx --pkgversion <span class="hljs-string"><span class="hljs-string">"1.2.4-1.relase.`date +%Y%m%d`"</span></span> --backup=no --install=yes --default</code> </pre> <br><br><h6>  <b>We create the user for Nginx</b> </h6><br><pre> <code class="bash hljs">sudo useradd --shell /bin/<span class="hljs-literal"><span class="hljs-literal">false</span></span> --no-create-home nginx</code> </pre> <br><br><h6>  <b>Create the necessary symlinks and folders.</b> </h6><br><pre> <code class="bash hljs">ln -s /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/nginx/sbin/nginx /usr/sbin/nginx mkdir -p /var/lib/nginx/body mkdir /var/lib/nginx/proxy mkdir /var/lib/nginx/fastcgi chown -R nginx:root /var/lib/nginx/</code> </pre><br><br><h6>  <b>Install the initialization script</b> </h6><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># http://wiki.nginx.org/Nginx-init-ubuntu wget http://nginx-init-ubuntu.googlecode.com/files/nginx-init-ubuntu_v2.0.0-RC2.tar.bz2 tar -jxvf nginx-init-ubuntu_v2.0.0-RC2.tar.bz2 -C /etc/init.d/ chmod 715 /etc/init.d/nginx /usr/sbin/update-rc.d -f nginx defaults rm -f nginx-init-ubuntu_v2.0.0-RC2.tar.bz2</span></span></code> </pre> <br><pre> <code class="bash hljs">vi /etc/init.d/nginx</code> </pre> <br><pre> <code class="bash hljs">DAEMON=/usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/nginx/sbin/nginx NGINX_CONF_FILE=<span class="hljs-string"><span class="hljs-string">"/etc/nginx/nginx.conf"</span></span></code> </pre> <br><br><h5>  <b>Installing video components</b> </h5><br><br><h6>  <b>Installing dependencies</b> </h6><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># sudo apt-get -y install build-essential checkinstall git # sudo apt-get -y install libfaac-dev libjack-jackd2-dev libmp3lame-dev libopencore-amrnb-dev libopencore-amrwb-dev libsdl1.2-dev libtheora-dev libva-dev libvdpau-dev libvorbis-dev libx11-dev libxfixes-dev texi2html yasm zlib1g-dev libgsm1 libgsm1-dev libxvidcore4 libxvidcore-dev libdc1394-22 libdc1394-22-dev</span></span></code> </pre> <br><br>  <b>Install x264</b> <br>  <b>Delete existing x264</b> <br><pre> <code class="bash hljs">sudo apt-get remove x264 libx264-dev</code> </pre> <br>  <b>Download source x264</b> <br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/src git <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> git://git.videolan.org/x264.git x264_`date +<span class="hljs-string"><span class="hljs-string">"%Y%m%d"</span></span>` <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> x264_`date +<span class="hljs-string"><span class="hljs-string">"%Y%m%d"</span></span>`</code> </pre> <br>  <b>Run the x264 build configuration script</b> <br><pre> <code class="bash hljs">./configure --<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>-static</code> </pre> <br>  <b>Run the x264 assembly</b> <br><pre> <code class="bash hljs">make</code> </pre> <br>  <b>Run the build and install deb package x264</b> <br><pre> <code class="bash hljs">sudo checkinstall --pkgname=x264 --pkgversion=<span class="hljs-string"><span class="hljs-string">"3:</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$(./version.sh | awk -F'[" ]' '/POINT/{print $4"+git"$5}')</span></span></span><span class="hljs-string">"</span></span> --backup=no --deldoc=yes --fstrans=no --install=yes --default</code> </pre> <br><br>  <b>Install libvpx</b> <br>  <b>Delete existing libvpx</b> <br><pre> <code class="bash hljs">sudo apt-get remove libvpx-dev</code> </pre> <br>  <b>Download the libvpx sources</b> <br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/src git <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> http://git.chromium.org/webm/libvpx.git libvpx_`date +<span class="hljs-string"><span class="hljs-string">"%Y%m%d"</span></span>` <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> libvpx_`date +<span class="hljs-string"><span class="hljs-string">"%Y%m%d"</span></span>`</code> </pre> <br>  <b>Run the libvpx build configuration script</b> <br><pre> <code class="bash hljs">./configure</code> </pre> <br>  <b>Run the libvpx build</b> <br><pre> <code class="bash hljs">make</code> </pre> <br>  <b>Run the build and install deb package libvpx</b> <br><pre> <code class="bash hljs">sudo checkinstall --pkgname=libvpx --pkgversion=<span class="hljs-string"><span class="hljs-string">"1:</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$(date +%Y%m%d%H%M)</span></span></span><span class="hljs-string">-git"</span></span> --backup=no --install=yes --deldoc=yes --fstrans=no --default</code> </pre> <br><br>  <b>Install ffmpeg</b> <br>  I installed ffmpeg 0.8.x because the versions above do not support presets and there were problems with the imposition of watermarks on the video (the syntax of the parameters in ffmpeg often changes).  In version 0.8.12, everything works fine. <br>  <b>Delete existing ffmpeg</b> <br><pre> <code class="bash hljs">sudo apt-get remove ffmpeg</code> </pre> <br>  <b>Download the source code ffmpeg</b> <br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/src wget https://ffmpeg.org/releases/ffmpeg-0.8.12.tar.gz tar -zxvf ffmpeg-0.8.12.tar.gz <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ffmpeg-0.8.12</code> </pre> <br>  <b>Run the ffmpeg build configuration script</b> <br><pre> <code class="bash hljs">./configure \ --<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>-gpl \ --<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>-postproc \ --<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>-pthreads \ --<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>-swscale \ --<span class="hljs-built_in"><span class="hljs-built_in">disable</span></span>-debug \ --<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>-nonfree \ --<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>-libopencore-amrnb \ --<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>-libopencore-amrwb \ --<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>-version3 \ --<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>-libdc1394 \ --<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>-libfaac \ --<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>-libgsm \ --<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>-libmp3lame \ --<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>-libtheora \ --<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>-libvorbis \ --<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>-libx264 \ --<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>-libxvid \ --<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>-libvpx</code> </pre> <br>  <b>Run the ffmpeg build</b> <br><pre> <code class="bash hljs">make</code> </pre> <br>  <b>Run the build and install deb package ffmpeg</b> <br><pre> <code class="bash hljs">sudo checkinstall --pkgname=ffmpeg --pkgversion=<span class="hljs-string"><span class="hljs-string">"0.11.1-release-`date +%Y%m%d%H%M`"</span></span> --backup=no --deldoc=yes --fstrans=no --install=yes --default</code> </pre> <br><br>  <b>Install qt-faststart</b> <br>  <b>Go to the source folder ffmpeg</b> <br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/src <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ffmpeg-0.8.12</code> </pre> <br>  <b>Run the assembly qt-faststart</b> <br><pre> <code class="bash hljs">make tools/qt-faststart</code> </pre> <br>  <b>Run the build and install deb package qt-faststart</b> <br><pre> <code class="bash hljs">sudo checkinstall --pkgname=qt-faststart --pkgversion=<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$(date +%Y%m%d%H%M)</span></span></span><span class="hljs-string">-git"</span></span> --backup=no --deldoc=yes --fstrans=no --default install -Dm755 tools/qt-faststart /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/bin/qt-faststart</code> </pre> <br><br>  <b>Checking the installed video components</b> <br><pre> <code class="bash hljs">x264 ffmpeg ffplay ffprobe qt-faststart</code> </pre> <br><br><h6>  <b>Setting up Web servers</b> </h6><br><br>  <b>Create a user for the KVS website</b> <br><pre> <code class="bash hljs">useradd --shell /bin/<span class="hljs-literal"><span class="hljs-literal">false</span></span> --no-create-home www-kvs</code> </pre> <br><br>  <b>Create a working directory for the KVS site</b> <br><pre> <code class="bash hljs">mkdir /home/kvs/</code> </pre> <br><br>  <b>Apache setup</b> <br>  <b>Configuring Apache Listening Ports</b> <br><pre> <code class="bash hljs">vi /etc/apache2/ports.conf</code> </pre> <br><pre> <code class="bash hljs">NameVirtualHost *:8080 Listen 8080</code> </pre><br>  <b>Install Apache Modules</b> <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># mod_ruid2 cd /usr/local/src # wget http://mirror.pnl.gov/ubuntu/pool/universe/liba/libapache2-mod-ruid2/libapache2-mod-ruid2_0.9.7-1_amd64.deb # dpkg -i libapache2-mod-ruid2_0.9.7-1_amd64.deb</span></span></code> </pre><br>  <b>Configuring Apache Modules</b> <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># mod_rpaf vi /etc/apache2/mods-available/rpaf.conf</span></span></code> </pre> <br><pre> <code class="bash hljs">&lt;IfModule rpaf_module&gt; RPAFenable On RPAFsethostname On RPAFproxy_ips 192.168.1.2 127.0.0.1 RPAFheader X-Real-IP &lt;/IfModule&gt;</code> </pre><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># mod_ruid2 vi /etc/apache2/mods-available/ruid2.conf</span></span></code> </pre><br><pre> <code class="bash hljs">&lt;IfModule mod_ruid2.c&gt; RMode config RDefaultUidGid www-data www-data RUidGid www-data www-data RGroups www-data &lt;/IfModule&gt;</code> </pre> <br><br>  <b>We include the necessary Apache modules</b> <br><pre> <code class="bash hljs">a2enmod rpaf a2enmod ruid2 a2enmod rewrite</code> </pre> <br><br>  <b>Create a folder for KVS logs</b> <br><pre> <code class="bash hljs">mkdir -p /var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/www/kvs</code> </pre> <br><br>  <b>Create a site for KVS in Apache</b> <br><pre> <code class="bash hljs">vi /etc/apache2/sites-available/kvs.conf</code> </pre> <br><br><pre> <code class="bash hljs">&lt;VirtualHost 127.0.0.1:8080&gt; ServerAdmin admin@domain.com Servername video.domain.com ServerAlias tube.domain.com RMode config RUidGid www-kvs www-kvs RGroups www-kvs RewriteEngine on RewriteCond %{HTTP_HOST} ^tube.domain.com$ RewriteRule (.*) http://video.domain.com<span class="hljs-variable"><span class="hljs-variable">$1</span></span> [R=301,L] DocumentRoot /home/kvs/ <span class="hljs-comment"><span class="hljs-comment"># AddType text/css css php_admin_value open_basedir /home/kvs php_admin_value upload_tmp_dir /home/kvs/tmp php_admin_value session.save_path /home/kvs/tmp &lt;Directory /home/kvs&gt; Options -Indexes FollowSymLinks -MultiViews AllowOverride All Order allow,deny Allow from all &lt;/Directory&gt; ErrorLog /var/log/www/kvs/kvs-apache-error.log # Possible values include: debug, info, notice, warn, error, crit, # alert, emerg. LogLevel debug CustomLog /var/log/www/kvs/kvs-apache-access.log combined &lt;/VirtualHost&gt;</span></span></code> </pre><br><br>  <b>Activate the created site</b> <br><pre> <code class="bash hljs">a2ensite kvs.conf a2dissite default</code> </pre> <br><br>  <b>Restart Apache</b> <br><pre> <code class="bash hljs">service apache2 restart</code> </pre> <br><br>  <b>Php Setup</b> <br>  <b>Editing Php config for Apache</b> <br><pre> <code class="bash hljs">vi /etc/php5/apache2/php.ini</code> </pre> <br><pre> <code class="php hljs">register_globals = Off magic_quotes_gpc = off safe_mode = Off max_execution_time = <span class="hljs-number"><span class="hljs-number">9999</span></span> allow_url_fopen = On file_uploads = On upload_tmp_dir = /tmp upload_max_filesize = <span class="hljs-number"><span class="hljs-number">1024</span></span>M post_max_size = <span class="hljs-number"><span class="hljs-number">1024</span></span>M memory_limit = <span class="hljs-number"><span class="hljs-number">1024</span></span>M session.gc_maxlifetime = <span class="hljs-number"><span class="hljs-number">86400</span></span> sendmail_path = <span class="hljs-string"><span class="hljs-string">"/usr/sbin/sendmail -t -i"</span></span></code> </pre> <br><br>  <b>Editing Php CLI config</b> <br><pre> <code class="bash hljs">vi /etc/php5/cli/php.ini</code> </pre> <br><pre> <code class="php hljs">memory_limit = <span class="hljs-number"><span class="hljs-number">1024</span></span>M safe_mode = Off allow_url_fopen = On sendmail_path = <span class="hljs-string"><span class="hljs-string">"/usr/sbin/sendmail -t -i"</span></span></code> </pre> <br><br>  <b>We configure Php logging</b> <br><pre> <code class="bash hljs">vi /etc/php5/apache2/php.ini</code> </pre> <br><pre> <code class="bash hljs">error_reporting = E_COMPILE_ERROR|E_RECOVERABLE_ERROR|E_ERROR|E_CORE_ERROR display_errors = Off display_startup_errors = Off log_errors = On log_errors_max_len = 102400 error_log = /var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/www/php.log</code> </pre> <br><br>  <b>Restart Apache</b> <br><pre> <code class="bash hljs">service apache2 reload</code> </pre> <br><br>  <b>Nginx setup</b> <br><br>  <b>The user, from under which works, nginx is placed in the group www-kvs</b> <br><pre> <code class="bash hljs">usermod -a -G www-kvs nginx</code> </pre> <br><br>  <b>Moving the default Nginx config</b> <br><pre> <code class="bash hljs">mv /etc/nginx/nginx.conf /etc/nginx/nginx.conf.bk</code> </pre> <br><br>  <b>Create a new Nginx config</b> <br><pre> <code class="bash hljs">vi /etc/nginx/nginx.conf</code> </pre> <br><pre> <code class="bash hljs">user nginx; worker_processes 16; error_log /var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/nginx/error.log info; <span class="hljs-comment"><span class="hljs-comment">#error_log logs/error.log notice; pid /var/run/nginx.pid; events { worker_connections 1024; #multi_accept on; } http { include /etc/nginx/mime.types; default_type application/octet-stream; server_tokens off; server_names_hash_bucket_size 128; log_format main '$remote_addr - $remote_user [$time_local] "$request" ' '$status $body_bytes_sent "$http_referer" ' '"$http_user_agent" "$http_x_forwarded_for"'; access_log /var/log/nginx/access.log main; sendfile on; tcp_nopush on; tcp_nodelay on; #keepalive_timeout 0; keepalive_timeout 65; gzip on; gzip_disable "MSIE [1-6]\.(?!.*SV1)"; include /etc/nginx/conf.d/*.conf; include /etc/nginx/sites-enabled/*; server { listen 192.168.1.2:80; server_name default; #charset koi8-r; #access_log logs/host.access.log main; location = /stat { stub_status on; access_log off; allow all; deny all; } location / { root html; index index.html index.htm; } #error_page 404 /404.html; # redirect server error pages to the static page /50x.html # error_page 500 502 503 504 /50x.html; location = /50x.html { root html; } } }</span></span></code> </pre><br><br>  <b>Create a config for KVS</b> <br><pre> <code class="bash hljs">mkdir /etc/nginx/sites-available/ mkdir /etc/nginx/sites-enabled/ vi /etc/nginx/sites-available/kvs.conf</code> </pre> <br><pre> <code class="bash hljs"> upload_progress proxied 1m; proxy_buffering off; server { listen 192.168.1.3:80; server_name video.domain.com *.video.domain.com tube.domain.com ; access_log /var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/www/kvs/kvs-nginx-access.log; error_log /var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/www/kvs/kvs-nginx-error.log; location / { index index.php; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (-f /etc/nginx/maintenance.file) { <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> 503; } proxy_pass http://127.0.0.1:8080/; proxy_redirect http://video.domain.com:8080/ /; proxy_set_header Host <span class="hljs-variable"><span class="hljs-variable">$host</span></span>; proxy_set_header X-Real-IP <span class="hljs-variable"><span class="hljs-variable">$remote_addr</span></span>; proxy_set_header X-Forwarded-For <span class="hljs-variable"><span class="hljs-variable">$proxy_add_x_forwarded_for</span></span>; client_max_body_size 1024m; client_body_buffer_size 128k; proxy_connect_timeout 90; proxy_send_timeout 900; proxy_read_timeout 900; proxy_buffer_size 4k; proxy_buffers 4 32k; proxy_busy_buffers_size 64k; proxy_temp_file_write_size 64k; charset off; track_uploads proxied 30s; } location ~* ^.+\.(gif|jpg|png|mpg|mp3|mpeg|avi|ico|txt|css|js|html)$ { <span class="hljs-comment"><span class="hljs-comment">#valid_referers none blocked video.domain.com; #if ($invalid_referer) { # return 403; #} root /home/kvs/; expires 30d; gzip on; gzip_min_length 100; gzip_comp_level 9; gzip_types text/plain text/css text/javascript application/x-javascript; gzip_disable "MSIE [1-6]\.(?!.*SV1)"; } location ^~ /admin/include/get_upload_status.php { report_uploads proxied; } location ^~ /contents/videos/ { flv; mp4; root /home/kvs; internal; expires max; } location ^~ /contents/private/ { flv; mp4; root /home/kvs; internal; expires max; } location ^~ /contents/videos_sources/ { root /home/kvs; internal; } location ^~ /contents/albums/sources/ { root /home/kvs; internal; } # deny access to .htaccess files, if Apache's document root concurs with nginx's one # location ~ /\.ht { deny all; } }</span></span></code> </pre> <br><br>  <b>Activate the created site</b> <br><pre> <code class="bash hljs">ln -s /etc/nginx/sites-available/kvs.conf /etc/nginx/sites-enabled/kvs.conf</code> </pre> <br><br>  <b>We test KVS config</b> <br><pre> <code class="bash hljs">service nginx configtest</code> </pre> <br><br>  <b>Run Nginx</b> <br><pre> <code class="bash hljs">service nginx start</code> </pre> <br><br><h4>  <b>Customize KVS</b> </h4><br><h5>  <b>Unpacking KVS content</b> </h5><br><pre> <code class="bash hljs">unzip KVS_2.4.3_20120426.zip -d /home/kvs <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /home/kvs cat /home/kvs/_INSTALL/install_EN.txt</code> </pre> <br><br><h5>  <b>Create a base for KVS</b> </h5><br><pre> <code class="bash hljs">mysql -uroot -p</code> </pre> <br><br><pre> <code class="hljs sql"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DATABASE</span></span> kvs <span class="hljs-built_in"><span class="hljs-built_in">CHARACTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> utf8 <span class="hljs-keyword"><span class="hljs-keyword">COLLATE</span></span> utf8_general_ci; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">USER</span></span> <span class="hljs-string"><span class="hljs-string">'kvs'</span></span>@<span class="hljs-string"><span class="hljs-string">'localhost'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IDENTIFIED</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-string"><span class="hljs-string">'*******'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">GRANT</span></span> ALL <span class="hljs-keyword"><span class="hljs-keyword">PRIVILEGES</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> kvs.* <span class="hljs-keyword"><span class="hljs-keyword">TO</span></span> <span class="hljs-string"><span class="hljs-string">'kvs'</span></span>@<span class="hljs-string"><span class="hljs-string">'localhost'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">FLUSH</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PRIVILEGES</span></span>; QUIT;</code> </pre> <br><br><pre> <code class="bash hljs">mysql -uroot -p kvs &lt; _INSTALL/install_db.sql</code> </pre> <br><br><h5>  <b>Rule configs KVS</b> </h5><br><pre> <code class="bash hljs">vi admin/include/setup_db.php</code> </pre> <br><br><pre> <code class="php hljs">define(<span class="hljs-string"><span class="hljs-string">'DB_HOST'</span></span>,<span class="hljs-string"><span class="hljs-string">'localhost'</span></span>); define(<span class="hljs-string"><span class="hljs-string">'DB_LOGIN'</span></span>,<span class="hljs-string"><span class="hljs-string">'kvs'</span></span>); define(<span class="hljs-string"><span class="hljs-string">'DB_PASS'</span></span>,<span class="hljs-string"><span class="hljs-string">'*******'</span></span>); define(<span class="hljs-string"><span class="hljs-string">'DB_DEVICE'</span></span>,<span class="hljs-string"><span class="hljs-string">'kvs'</span></span>);</code> </pre> <br><br><pre> <code class="bash hljs">vi admin/include/setup_db.php</code> </pre> <br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// a.  "/PATH"                 (, /usr/path/to/domain.com) $config['project_path']="/home/kvs"; $config['temporary_path']="/home/kvs/tmp"; $config['content_path_videos_sources']="/home/kvs/contents/videos_sources"; $config['content_path_videos_screenshots']="/home/kvs/contents/videos_screenshots"; $config['content_path_categories']="/home/kvs/contents/categories"; $config['content_path_models']="/home/kvs/contents/models"; $config['content_path_dvds']="/home/kvs/contents/dvds"; $config['content_path_avatars']="/home/kvs/contents/avatars"; $config['content_path_content_sources']="/home/kvs/contents/content_sources"; $config['content_path_advertisement']="/home/kvs/contents/advertisement"; $config['content_path_albums']="/home/kvs/contents/albums"; $config['content_path_referers']="/home/kvs/contents/referers"; $config['content_path_other']="/home/kvs/contents/other"; // // b.   $config['is_nginx']   "false",       nginx $config['is_nginx']="true"; // // c.   $config['server_type']   "apache",      apache  nginx $config['server_type']="nginx"; // // d.   $config['is_translit_directories']   "true",           $config['is_translit_directories']="true"; // // e.   $config['php_path']    php () $config['php_path']="/usr/bin/php"; // // f.   $config['ffmpeg_path']    ffmpeg () $config['ffmpeg_path']="/usr/local/bin/ffmpeg"; // // g.   $config['image_magick_path']    imagemagick () $config['image_magick_path']="/usr/bin"; // // h.   $config['mysqldump_path']     mysqldump () $config['mysqldump_path']="/usr/bin/mysqldump"; // // i.   $config['memcache_server']  $config['memcache_port'],      memcache</span></span></code> </pre><br>  See below for your configuration. <br><br><h5>  <b>We set the rights to the KVS files</b> </h5><br><pre> <code class="bash hljs">kvsroot=/home/kvs kvsuser=www-kvs kvsgroup=www-kvs <span class="hljs-comment"><span class="hljs-comment"># chmod 750 $kvsroot chown -R $kvsuser:$kvsgroup $kvsroot # find $kvsroot/ -type f -exec chmod 444 {} \; find $kvsroot/ -type d -exec chmod 555 {} \; # # # 5)        777,       666: # # a. /tmp find $kvsroot/tmp -type d -exec chmod 777 {} \; find $kvsroot/tmp -type f -not -name ".htaccess" -exec chmod 666 {} \; # b. /template (  777    666     .htaccess) find $kvsroot/template -type d -exec chmod 777 {} \; find $kvsroot/template -type f -not -name ".htaccess" -exec chmod 666 {} \; # c. /contents (   /contents  , 777  ) find $kvsroot/contents -mindepth 1 -type d -exec chmod 777 {} \; find $kvsroot/contents -type f -not -name ".htaccess" -exec chmod 666 {} \; # d. /admin/smarty/cache find $kvsroot/admin/smarty/cache -type d -exec chmod 777 {} \; find $kvsroot/admin/smarty/cache -type f -not -name ".htaccess" -exec chmod 666 {} \; # e. /admin/smarty/template-c find $kvsroot/admin/smarty/template-c -type d -exec chmod 777 {} \; find $kvsroot/admin/smarty/template-c -type f -not -name ".htaccess" -exec chmod 666 {} \; # f. /admin/smarty/template-c-site find $kvsroot/admin/smarty/template-c-site -type d -exec chmod 777 {} \; find $kvsroot/admin/smarty/template-c-site -type f -not -name ".htaccess" -exec chmod 666 {} \; # g. /admin/logs (  777  ) find $kvsroot/admin/logs -type d -exec chmod 777 {} \; find $kvsroot/admin/logs -type f -not -name ".htaccess" -exec chmod 666 {} \; # h. /admin/data (   /admin/data  , 777    666     .htaccess  /admin/data/conversion/remote_cron.php) find $kvsroot/admin/data -mindepth 1 -type d -exec chmod 777 {} \; find $kvsroot/admin/data -type f -not -name ".htaccess" -not -name "remote_cron\.php" -exec chmod 666 {} \;</span></span></code> </pre><br><br><h4>  <b>Post-installation settings</b> </h4><br><h5>  <b>Add a task to cron</b> </h5><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># 6)   /admin/include/cron.php       .      ,    .       : # # cd /PATH/admin/include/ &amp;&amp; /usr/local/bin/php cron.php &gt; /dev/null 2&gt;&amp;1</span></span></code> </pre> <br><br><pre> <code class="bash hljs">crontab -e -u www-kvs</code> </pre> <br><pre> <code class="bash hljs">*/1 * * * * <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /home/kvs/admin/include/ &amp;&amp; /usr/bin/php cron.php &gt; /dev/null 2&gt;&amp;1</code> </pre> <br><br><h5>  <b>Check the paths in the file admin / data / conversion / remote_cron.php</b> </h5><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># 8)   /admin/data/conversion/remote_cron.php     ffmpeg, yamdi  qt-faststart.     .</span></span></code> </pre> <br><pre> <code class="bash hljs">vi admin/data/conversion/remote_cron.php</code> </pre> <br><pre> <code class="php hljs">$ffmpeg_path=<span class="hljs-string"><span class="hljs-string">"/usr/local/bin/ffmpeg"</span></span>; $yamdi_path=<span class="hljs-string"><span class="hljs-string">"/usr/bin/yamdi"</span></span>; $qtf_path=<span class="hljs-string"><span class="hljs-string">"/usr/local/bin/qt-faststart"</span></span>; $imagemagick_path=<span class="hljs-string"><span class="hljs-string">"/usr/bin/convert"</span></span>;</code> </pre> <br><br><h5>  <b>Change the default admin password</b> </h5><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># 7)      (http://video.domain.com/admin). #    : admin / 123.       - ,         : # -   777      /admin/smarty/ (.  5d, 5e, 5f) # -     memcache,      memcache  /admin/include/setup.php (.  4i) # -           /admin/include/setup.php (.  4a)</span></span></code> </pre> <br><br>  Go to the administrative part of the site: <br>  <a href="http://video.domain.com/admin/">video.domain.com/admin</a> <br>  admin: 123 <br><pre> <code class="hljs erlang-repl"> --&gt;   --&gt;   --&gt; : ********** --&gt;  </code> </pre> <br><br><h5>  <b>Add a conversion server</b> </h5><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># 9)        .     : # # : ,  Local # :  #  :  (   ) # :      /admin/data/conversion # #        ,      6  8,    .</span></span></code> </pre> <br><pre> <code class="hljs delphi"> --&gt;   --&gt;    <span class="hljs-comment"><span class="hljs-comment">(*):    :  .  (*)</span></span>: <span class="hljs-number"><span class="hljs-number">5</span></span>   :   :   <span class="hljs-comment"><span class="hljs-comment">(*): /home/kvs/admin/data/conversion --&gt;  </span></span></code> </pre><br><br><h5>  <b>Add a storage server</b> </h5><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># 10)           .   ,      embed       .           .        .                 ,       : # a.    (..       ,   KVS): # - : ,  Local # -  :  ,      # - URL: http://video.domain.com/contents/videos # -  :   ,        (nginx  apache) # -  :  # - :      /contents/videos # b.    (..      ): #           nginx.      , : video.domain.com.      , : storage.       ,       internal  nginx: # location ^~ /storage/ { # flv; # root /usr/path/to/video.domain.com/html; # internal; # } # #       /admin/tools/remote_control.php  ,          "connected": # http://video.domain.com/remote_control.php #        : # - : ,  Remote # -  :  ,      # - URL: http://video.domain.com/storage # -  : nginx # -  :   mount  FTP # - :       NFS,     NFS mount # - FTP xxx:           FTP # c. Reflected Networks CDN: # - : ,  CDN # -  :  ,      # - URL: CDN ,     Reflected Networks # -  : Reflected Networks CDN # -  :  ,     Reflected Networks # -  :   mount  FTP # - :       NFS,     NFS mount # - FTP xxx:           FTP #        ,     ,    ,        .</span></span></code> </pre> <br><br><pre> <code class="hljs erlang-repl">  --&gt;    --&gt;  (*):    --&gt; C  </code> </pre> <br><br><pre> <code class="hljs delphi">  --&gt;   --&gt;  <span class="hljs-comment"><span class="hljs-comment">(*):      (*)</span></span>:    URL <span class="hljs-comment"><span class="hljs-comment">(*): http://video.domain.com/contents/videos  : Nginx (x-accel-redirect)  :   (*)</span></span>: /home/kvs/contents/videos --&gt;  </code> </pre> <br><br><h5>  <b>Check whether everything is correctly installed and configured in KVS</b> </h5><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># 11)            .       .         -   .</span></span></code> </pre> <br><br><pre> <code class="hljs markdown"> --&gt;   --&gt; <span class="hljs-bullet"><span class="hljs-bullet">*   (   ) *</span></span>    <span class="hljs-bullet"><span class="hljs-bullet">*   *</span></span>      <span class="hljs-bullet"><span class="hljs-bullet">*    (   ) # *</span></span>    (  ) *     --&gt;  </code> </pre> <br><br><h5>  <b>We load the video and make sure that it has been successfully converted and can be viewed on the website.</b> </h5><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># 12)    ,       .</span></span></code> </pre> <br><pre> <code class="hljs erlang-repl"> --&gt;   --&gt;</code> </pre> <br><br><h5>  <b>Delete the _INISTALL folder</b> </h5><br><pre> <code class="bash hljs">rm -rf _INSTALL</code> </pre> <br><br><h5>  <b>Next, your personal settings</b> </h5><br>  Video formats, their size, the imposition of watermark, showing time-lines.  All this can be customized if desired. <br>  Read the dock and customize for yourself. <br><br><h5>  <b>What did not like</b> </h5><br>  1. There is no support for html5 - right now we are sitting here and we are trying to figure out how to show videos for Apple players and the latest androids. <br>  2. I will replenish as memories ... <br><br><h4>  <b>Conclusion</b> </h4><br>  The instruction turned out big and a bit tedious. <br>  I hope this post will be useful to anyone when creating a video streaming service if the choice falls on Kernel Video Sharing. </div><p>Source: <a href="https://habr.com/ru/post/151432/">https://habr.com/ru/post/151432/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../151426/index.html">Review of 7 TechCrunch Disrupt SF 2012 finalists</a></li>
<li><a href="../151428/index.html">Convenient file sharing from scratch</a></li>
<li><a href="../151429/index.html">Podcast news "On the wave of knowledge and trends" - the two hundredth edition</a></li>
<li><a href="../151430/index.html">Wi-Fi in the metro: look at the cable in the wall of the tunnel</a></li>
<li><a href="../151431/index.html">Google Pluto Switch</a></li>
<li><a href="../151433/index.html">‚ÄúAndroid for programmers: create applications‚Äù - a new book from Daytelov</a></li>
<li><a href="../151434/index.html">Ozon.ru: The Russian answer to Amazon is ready for the clouds, but the Kindle is too tough</a></li>
<li><a href="../151436/index.html">How is going to the new iPhone5 at Foxconn factory</a></li>
<li><a href="../151438/index.html">Podcast Appprofessionals - Promotion of mobile applications: one of the most difficult issues of the industry</a></li>
<li><a href="../151439/index.html">Badoo office</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>