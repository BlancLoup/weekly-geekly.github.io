<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Lightweight development of WP7 applications using the Caliburn.Micro framework (Part 1)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello! 

 As the title suggests, this article will be enlightened on the Caliburn.Micro framework. I will try to show that the use of this framework b...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Lightweight development of WP7 applications using the Caliburn.Micro framework (Part 1)</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage2/388/e68/3f3/388e683f3fe45f8bd218bededea68287.jpg"><br><br>  Hello! <br><br>  As the title suggests, this article will be enlightened on the <b>Caliburn.Micro</b> framework.  I will try to show that the use of this framework by the developer for the WP7 platform can give what is useful, what tasks it solves, its advantages and disadvantages. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      But the most important question that I will try to answer throughout the entire article is why we need another intermediate layer, in the form of a framework, in the rather established kingdom of WP7. <br><br>  If you are interested in this topic, then welcome under cat. <br><a name="habracut"></a><br><h4>  Training </h4><br>  I assume that the materials of this article will be of interest mainly to people already familiar with the development under WP7.  Therefore, I will not tell you how to create a project in VS, etc., but I will assume that you already know this or can learn from many other open sources. <br><br>  For independent experiments you will need: <br><ol><li>  VS 2010 SP1 </li><li>  <a href="http://www.microsoft.com/en-us/download/details.aspx%3Fid%3D27570">Windows Phone SDK 7.1</a> </li><li>  <a href="http://caliburnmicro.codeplex.com/">Caliburn.Micro</a> </li></ol><br>  Create a <b>Windows Phone Application</b> project that we will use for testing. <br><br><h4>  MVVM or Chapter instead of the preface </h4><br>  WP7 application consists of a set of screens / pages (Windows Phone Page), these screens represent some data, for example, records in the DB.  The question arises how to link this data and UI elements on the screen. <br><br>  Suppose we want to show a list of users in an AD group.  The screen title will be the name of the group, and the body will be a ListBox with a list of users.  How could this be done?  A simple but not the best solution, right in the body of the page (* .xaml.cs) to write something ala: <br><pre><code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">// PageTitle - TextBlock PageTitle.Text = GroupConnector(GroupId).Name; // Users - ListBox Users.ItemsSource = GroupConnector(GroupId).Users;</span></span></code> </pre> <br>  This will work, but this approach has many drawbacks, here are some of them: <br><ol><li>  Difficult to design and maintain.  Code and UI elements are in close connection, and this complicates the development process because  requires additional resources to synchronize the UI and the code supporting it.  Also, such code is hard for third-party people, especially if it contains many elements, and not two, as in our example. </li><li>  It is badly parallelized.  Those.  the programmer, knowing what data he is working with, cannot verify the performance of his code without a ready implementation of the UI.  If different people are involved in the creation of the UI and the functional code, then this problem is amplified even more. </li><li>  Difficult to write unit tests.  The code tied to the elements of the UI is difficult to unit-test, because  requires xaml and all the infrastructure around, which is not fast, problematic if the unit tests are in another project or the UI is not ready yet (hello to the TDD adepts). </li></ol><br>  The <b>Model-View-ViewModel</b> pattern serves to solve the above problem.  Much has been written about him and I will not dwell on the details.  In more detail you can read about this approach, for example, <a href="http://msdn.microsoft.com/ru-ru/magazine/dd419663.aspx">here</a> or a little on <a href="http://habrahabr.ru/post/136886/">habr</a> . <br><br>  In short, the meaning of the MVVM approach is to explode the View from its presentation.  Those.  in a well-designed system, no matter what your final UI looks like, the view will remain the same, because  reflects a high-level view of data that is not tied to a specific implementation. <br><br>  When developing WP7 applications, the MVVM approach is applied everywhere.  Some make their own <a href="http://habrahabr.ru/post/137541/">solutions</a> , others use ready-made developments in the form of one of the frameworks (for example, <a href="http://compositewpf.codeplex.com/">Prism</a> and <a href="http://mvvmlight.codeplex.com/">MVVM Light Toolkit</a> ).  <b>Caliburn.Micro</b> is just such a framework.  Those.  This is the implementation of the MVVM-approach with a set of nice buns. <br><br><h4>  Beginning of work </h4><br>  Ok, we have created a project, let's connect the necessary CMs there (hereinafter I will use this abbreviation so that I do not write Caliburn.Micro) libraries every time.  For this: <br><ol><li>  Create a CaliburnMicro folder (or with any other name) inside the project and copy the <b>Caliburn.Micro.dll</b> , <b>Caliburn.Micro.Extensions.dll</b> and <b>System.Windows.Interactivity.dll</b> files from the CM distribution package (bin \ WP71 \ Release) there. </li><li>  Add new files to the references. </li></ol><br>  For CM to work, you need to install your own wrapper ( <b>Bootstrapper</b> ) over the main application class.  This wrapper will be responsible for all changes in the application state (activation, deactivation, transitions, etc.) and most importantly, all our ViewModel classes will be described here, but more on that later. <br><br>  Create a class <b>SampleBootstrapper</b> , the successor of <b>PhoneBootstrapper</b> and add it to our project: <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">SampleBootstrapper</span></span> : <span class="hljs-title"><span class="hljs-title">PhoneBootstrapper</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> PhoneContainer _container; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Configure</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { _container = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PhoneContainer(RootFrame); _container.RegisterPhoneServices(); AddCustomConventions(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AddCustomConventions</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">object</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetInstance</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Type service, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> key</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _container.GetInstance(service, key); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> IEnumerable&lt;</span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">object</span></span></span><span class="hljs-function">&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetAllInstances</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Type service</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _container.GetAllInstances(service); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">BuildUp</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> instance</span></span></span><span class="hljs-function">)</span></span> { _container.BuildUp(instance); } }</code> </pre><br>  Do not be confused by this class; in the future we will only need the <b>Configure</b> method from it. <br><br>  Now you need to tell the application to use <b>SampleBootstrapper</b> .  To do this, edit the <b>App.xaml</b> file, removing everything from there except for the link to our Bootstrapper: <br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Application</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">x:Class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"CaliburnMicroSamples.App"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://schemas.microsoft.com/winfx/2006/xaml/presentation"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:x</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://schemas.microsoft.com/winfx/2006/xaml"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:CaliburnMicroSamples</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"clr-namespace:CaliburnMicroSamples"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Application.Resources</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">CaliburnMicroSamples:SampleBootstrapper</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">x:Key</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"bootstrapper"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Application.Resources</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Application</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  Because  processing events like <b>Launching</b> , <b>Activated</b> , etc., is now taken by <b>SampleBootstrapper</b> , then the old methods that are responsible for this before can be removed from <b>App.xaml.cs.</b>  Those.  The <b>App</b> class will now look much simpler: <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">partial</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">App</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">App</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { InitializeComponent(); } }</code> </pre><br>  Compile and run if everything looks as before, i.e.  before the changes associated with CM, then you did everything right and you can go on, if the application crashes, then there was a mistake and you need to fix it before continuing the following experiments. <br><br><h4>  First ViewModel </h4><br>  Without using third-party frameworks and using the ViewModel, this ViewModel is created as follows.  A class that implements the ViewModel is created, then the link to it is passed to the <b>DataContext</b> inside the <b>PhoneApplicationPage</b> page ala: <br><pre> <code class="cs hljs">DataContext = ViewModelsConstructor.GetViewModel(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>);</code> </pre><br>  The same can be done using xaml.  All this is necessary so that the binding of ViewModel and View elements (UI controls) works. <br><br>  In CM, this approach is slightly different.  It does not need to set the context on its own; the framework takes over.  Also, there is no need to work with the <b>DataContext</b> and <b>* .xaml.cs</b> files in general, which allows you to get even closer to the ideal MVVM, further away from View and xaml in particular.  In CM, a declarative approach is used to describe a VM (ViewModel), which I will try to demonstrate further. <br><br>  After creating the application, you already have a default screen: <b>MainPage</b> .  Let's try to create for it a class that implements ViewModel using CM.  To do this, create a class <b>with the same</b> name as the file name with the <b>xaml</b> extension, with the end of the <b>ViewModel</b> (ie, the <b>MainPageViewModel</b> class), put it into a separate file with the same name and inherit from the <b>Screen</b> class CM (in this class all the methods for working with the current page, but I'll write about that later).  Those.  the class should look like this: <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">MainPageViewModel</span></span> : <span class="hljs-title"><span class="hljs-title">Screen</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MainPageViewModel</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { } }</code> </pre><br>  The last thing left to do is register our VM with Bootstrapper.  To do this, in the <b>SampleBootstrapper</b> class, add the following code to the <b>Configure</b> method: <br><pre> <code class="cs hljs">_container.PerRequest&lt;MainPageViewModel&gt;();</code> </pre><br>  And that's it!  Our ViewModel is created and will be linked by CM to the MainPage page when it is created.  <b>PerRequest</b> means that the MainPageViewModel class will be created each time a MainPage page is requested.  If you use the Singleton method, then the MainPageViewModel class will reuse on all subsequent queries. <br><br>  Let's see how binding properties work.  To do this, add the <b>PageTitle</b> property to our VM class and assign it some value, for example, ‚Äúsample page‚Äù: <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">MainPageViewModel</span></span> : <span class="hljs-title"><span class="hljs-title">Screen</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> PageTitle { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MainPageViewModel</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { PageTitle = <span class="hljs-string"><span class="hljs-string">"sample app"</span></span>; } }</code> </pre><br>  And run the application.  Page title has changed!  This happened because the CM took all the questions on the ViewModel and View connection to itself and linked the PageTitle property by its name (in xaml it is also called). <br><br>  The familiar binding through specifying the link directly (ala <code>Text="{Binding PageTitle, Mode=TwoWay}"</code> ) in xaml also works, but agree, without it is much easier. <br><br>  It was a fairly simple example, I will explain more advanced options for binding and CM capabilities in this regard later, but for now we will continue. <br><br><h4>  Navigation </h4><br>  Remember our example with users and a group from AD?  It is logical to assume that in order to show information about a group, it is necessary to transfer information somewhere about what group it is.  For simplicity, let it be her name.  This is ‚Äúsomewhere‚Äù of course VM, since  she needs to know what kind of group it is to return the necessary data to the View. <br><br>  The standard way to solve this problem is navigation with parameters.  Those.  we say that we want to go to such a screen (in this case with a list of users), and we pass the group identifier as a parameter.  This is usually done like this: <br><pre> <code class="cs hljs">NavigationService.Navigate(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Uri(<span class="hljs-string"><span class="hljs-string">"/GroupPage.xaml?name=Administrators"</span></span>, UriKind.Relative));</code> </pre><br>  And further in the OnNavigatedTo of the GroupPage.xaml page <b>,</b> this parameter is extracted by the construction: <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> name = NavigationContext.QueryString[<span class="hljs-string"><span class="hljs-string">"name"</span></span>];</code> </pre><br>  Then it is transmitted (for example, through the constructor) to the class implementing the model, and then it is passed to the DataContext. <br><br>  Agree, not the most beautiful solution for such a simple task. <br><br>  Another popular way to use this is <b>PhoneApplicationService.Current.State</b> , for exchanging spun data: <br><pre> <code class="cs hljs">PhoneApplicationService.Current.State[<span class="hljs-string"><span class="hljs-string">"name"</span></span>] = <span class="hljs-string"><span class="hljs-string">"Administrators"</span></span>;</code> </pre><br>  Or simply through global variables inside the Application class, the benefit of which can be obtained anywhere through <b>Application.Current</b> . <br><br>  In general, all this is quite crooked.  The last two examples are bad in that it‚Äôs ridiculous to use swash data to exchange between screens, especially when there is a standard way to do this.  The first example is bad because it is very easy to make a typo on the way, and the ‚Äúhusk‚Äù with pulling out this value (even worse if there are a lot of them) from NavigationContext, with the subsequent transfer of all this somewhere, is also not happy. <br><br>  And this is how it is done in CM: <br><pre> <code class="cs hljs">_navigationService.UriFor&lt;GroupPageViewModel&gt;() .WithParam(x =&gt; x.Name, <span class="hljs-string"><span class="hljs-string">"Administrators"</span></span>) .Navigate();</code> </pre><br>  <b>GroupPageViewModel</b> - VM, made by analogy as we did MainPageViewModel, with the public property <b>Name</b> : <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">GroupPageViewModel</span></span> : <span class="hljs-title"><span class="hljs-title">Screen</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Name { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> </pre><br>  And <b>_navigationService</b> is an object that implements an <b>INavigationService</b> , which can be obtained inside any VM inherited from the <b>Screen</b> class and used to navigate between screens.  Through the <b>WithParam</b> method, <b>you</b> can set the VM properties on the destination page.  INavigationService is a wrapper over standard NavigationService, which includes all its functionality and expands with additional possibilities. <br><br>  This is how an INavigationService instance is obtained for the MainPageViewModel class, the CM simply passes the INavigationService object to the MainPageViewModel constructor: <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">MainPageViewModel</span></span> : <span class="hljs-title"><span class="hljs-title">Screen</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> INavigationService _navigationService; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> PageTitle { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MainPageViewModel</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">INavigationService navigationService</span></span></span><span class="hljs-function">)</span></span> { PageTitle = <span class="hljs-string"><span class="hljs-string">"sample app"</span></span>; _navigationService = navigationService; } }</code> </pre><br>  Pluses are obvious: <br><ol><li>  Very little code to write to the developer to pass the parameter to the VM. </li><li>  Because  Since the INavigationService is specialized in the destination VM class and the parameters are set in relation to this class, it is impossible to make a mistake / be sealed when setting these parameters, since  such code simply will not compile. </li><li>  Because  the interface is transmitted, then the behavior of the INavigationService is well moked, which is very convenient when writing unit-tests. </li><li>  The code is completely untied from UI. </li></ol><br>  Minuses: <br><ol><li>  Complex types cannot be passed like this.  There is no magic here, CM can not do what is not in WP7, because  based on its capabilities.  The implementation is based on the standard implementation of the NavigationService (the one in the first example).  But this can be bypassed if you use serialization and slightly tweak the CM source. </li></ol><br><h4>  INotifyPropertyChanged </h4><br>  Let's leave users from AD, and present another example.  Suppose we have a mail program, on one of the pages of which there is a list of available mailboxes with a badge of unread messages. <br><br>  The main difference from the previous examples is that the data are no longer static, but may change over time (unread message counter).  Those.  if we imagine that we have a property responsible for the number of unread messages, then we need a mechanism to notify View that it has changed.  For this purpose, a notification mechanism is used based on the implementation of the <b>INotifyPropertyChanged</b> interface.  The standard way of implementing this approach would look like this: <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">MailboxPageViewModel</span></span> : <span class="hljs-title"><span class="hljs-title">INotifyPropertyChanged</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> _unreadCount; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> UnreadCount { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _unreadCount; } <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { _unreadCount = <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>; NotifyPropertyChanged(<span class="hljs-string"><span class="hljs-string">"UnreadCount"</span></span>); } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">event</span></span> PropertyChangedEventHandler PropertyChanged; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">NotifyPropertyChanged</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> propertyName</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (PropertyChanged != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) PropertyChanged(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PropertyChangedEventArgs(propertyName)); } }</code> </pre><br>  As you can see, here the Event <b>PropertyChanged is</b> <b>signaled</b> when the <b>UnreadCount</b> property <b>changes</b> , which will lead to a re-reading of the View value. <br><br>  This code has two drawbacks: <br><ol><li>  The property name is set by name, and this is fraught with errors. </li><li>  When updating a property from a non-UI thread, the application will fall with the Invalid cross-thread access exception. </li></ol><br>  The first is solved using Expression, the second is checking whether the operation can be performed in the current thread via Dispatcher.CheckAccess () and if the operation cannot be performed, then restart it, but in the UI stream.  It‚Äôs not difficult, but nevertheless your bike, especially in CM, we thought about it.  Here is the code that can replace the example above: <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">MailboxPageViewModel</span></span> : <span class="hljs-title"><span class="hljs-title">Screen</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> _unreadCount; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> UnreadCount { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _unreadCount; } <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { _unreadCount = <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>; NotifyOfPropertyChange(() =&gt; UnreadCount); } } }</code> </pre><br>  The CM method <b>NotifyOfPropertyChange</b> solves the problems described and is available immediately out of the box. <br><br>  In CM, you can also find a <b>BindableCollection</b> class that solves similar problems with access from non-UI threads of another class that implements INotifyPropertyChanged and is used to store collections of objects, the <b>ObservableCollection</b> class.  Those.  When using the BindableCollection, you can not worry about the thread in which the collection methods are called. <br><br><h4>  Tombstone </h4><br>  One of the problems that developers face when writing applications for WP7 is the need to restore the state of the application after exiting the <b>Tombstone</b> state. <br><br>  In WP7, <b>PhoneApplicationService.State</b> , <b>IsolatedStorage</b> and other solutions are used for this.  Working with what is without additional wrappers is not so convenient.  CM offers an elegant solution.  If you need VM data to survive tombstone, then just create a class with the name VM and the end of Storage.  The class for our example with the list of users will be called <b>GroupPageViewModelStorage</b> and will look like this: <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">GroupPageViewModelStorage</span></span> : <span class="hljs-title"><span class="hljs-title">StorageHandler</span></span>&lt;<span class="hljs-title"><span class="hljs-title">GroupPageViewModel</span></span>&gt; { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Configure</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { Property(x =&gt; x.Name) .InPhoneState() .RestoreAfterActivation(); } }</code> </pre><br>  <b>StorageHandler</b> is a CM class that implements a strategy for storing data inside a VM.  In this example, we say that we want to keep the <b>Name</b> property inside PhoneApplicationService.State and that the data needs to be restored along with the page activation. <br><br>  Because  CM does not know anything and can not know about the data stored in the Model, then they need to be stored separately.  To do this, add the necessary code for serialization / deserialization, which corresponds to the logic of your application, inside the appropriate Bootstapper methods (Launching, Closing, Deactivated, etc.). <br><br><h4>  The end of the first part </h4><br>  Here I realized that the article turns out more than I expected at the beginning and that it is necessary to write as many more.  This is more than enough for an introductory review article, so I decided to split it into two parts. <br><br>  <b><i>To be continued...</i></b> </div><p>Source: <a href="https://habr.com/ru/post/144600/">https://habr.com/ru/post/144600/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../144595/index.html">Gfranq.com</a></li>
<li><a href="../144596/index.html">London google office</a></li>
<li><a href="../144597/index.html">KVIS - Critical Information Segments</a></li>
<li><a href="../144598/index.html">Object-oriented function approach in Scheme</a></li>
<li><a href="../144599/index.html">Steve Blank about business, the nature of startups and entrepreneurship in Russia</a></li>
<li><a href="../144601/index.html">Red Hat enhances PaaS OpenShift by JRuby developers</a></li>
<li><a href="../144603/index.html">Let's program the vacancy</a></li>
<li><a href="../144604/index.html">Full length documentary on the demoscene: The Art Of The Algorithms</a></li>
<li><a href="../144605/index.html">SmartTripod - Robot Operator</a></li>
<li><a href="../144606/index.html">MetaWatch smart watches for gadget lovers</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>