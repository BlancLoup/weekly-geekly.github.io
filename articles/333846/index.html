<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Photographing objects in C #: Chronicle and comparison of images, reconstruction of the state of the image</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="When developing applications, the following scenario is often encountered: there is some set of data available for viewing and editing, for example, t...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Photographing objects in C #: Chronicle and comparison of images, reconstruction of the state of the image</h1><div class="post__text post__text-html js-mediator-article">  When developing applications, the following scenario is often encountered: there is some set of data available for viewing and editing, for example, these can be business entities or application settings.  At the moment when the user decides to edit something, a special form with the necessary I / O fields and other controls usually becomes available to him.  If he makes any adjustments to the data, then when processing the form, it is good practice to request confirmation before final application of the changes made.  If the user consents, the data is updated in the source and on the interface, and the cancellation uses the old values. <br><br>  This task includes two subtasks: <br><br>  1) when the user leaves the editing form, it is necessary to understand whether he really made the changes in order not to ask a confirmation question for nothing and not to overwrite identical data; 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      2) if the original entity is subjected to editing, and not its copy, then in the case of cancellation, it is necessary to preserve the possibility of rolling back to the original values. <br><br>  In this article, we will look at the generalized and very laconic [several lines of code!] Approach to solving such problems, based on the use of the <a href="https://www.nuget.org/packages/Art.ReplicationFramework.Trial/">Replication Framework</a> library. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/cb4/bec/1cd/cb4bec1cde8e695b2b449a4dfb179668.png" alt="image"></div><a name="habracut"></a><br><br>  Consider <a href="https://1drv.ms/u/s!AvvcPQX44tbIhc8tYEOIZjuocJ3srA">an example application</a> .  Let the list of entities be given, among which the user can select any and click on the edit button [in the original or copy mode]. <br><br><img src="https://habrastorage.org/web/968/2a4/e3a/9682a4e3a5404cd7b2917b69ba69ff05.png"><br><br>  In the mode of editing the original, when the entity changes in the dialog box, the corresponding values ‚Äã‚Äãare immediately updated in the main one, which is not happening in the copy mode. <br><br><img src="https://habrastorage.org/web/a0b/ef2/1ea/a0bef21ea96443f1a0e488543c45b09d.png"><br><br>  After confirming the changes, a list of all the differences found is displayed, if the <i>Show detailed changes</i> flag is raised, or a message is displayed that detects at least one difference [in real situations, sometimes this behavior is enough]. <br><br><img src="https://habrastorage.org/web/78a/ee7/6ea/78aee76eac2a408b86aacb23fa7d8159.png"><br><br>  Undo uses old values. <br><br><img src="https://habrastorage.org/web/850/572/2de/8505722de748462f923f181368e3d9a2.png"><br><br>  Now take a look at the code of the method that is responsible for this behavior. <br><br><pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> Edit&lt;T&gt;(T sourceEntry, <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> useCopy, <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> showChanges, ReplicationProfile replicationProfile) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> cache = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ReconstructionCache(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> sourceSnapshot = sourceEntry.CreateSnapshot(cache, replicationProfile); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> editableEntry = useCopy ? sourceSnapshot.ReplicateGraph() : sourceEntry; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (GetView(editableEntry).ShowDialog() == <span class="hljs-literal"><span class="hljs-literal">true</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> resultSnapshot = editableEntry.CreateSnapshot(<span class="hljs-literal"><span class="hljs-literal">null</span></span>, replicationProfile); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> changes = sourceSnapshot.Juxtapose(resultSnapshot) .Where(j =&gt; j.State != Etalon.State.Identical); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (changes.Any()) { MessageBox.Show(showChanges ? changes.Aggregate(<span class="hljs-string"><span class="hljs-string">""</span></span>, (x, y) =&gt; x + y + Environment.NewLine) : <span class="hljs-string"><span class="hljs-string">"Any changes has been detected!"</span></span>); UpdateSourceData(editableEntry); UpdateUserInterface(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> MessageBox.Show(<span class="hljs-string"><span class="hljs-string">"There are no any changes."</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!useCopy) sourceSnapshot.ReconstructGraph(cache); }</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">Entity entity</b> <div class="spoiler_text"><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Person</span></span> : <span class="hljs-title"><span class="hljs-title">INotifyPropertyChanged</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> _id; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> _name; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> _birthday; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> _phone; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> _mail; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">event</span></span> PropertyChangedEventHandler PropertyChanged = (o, e) =&gt; { }; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> Set&lt;T&gt;(<span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> T target, T <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>, [CallerMemberName]<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> caller = <span class="hljs-string"><span class="hljs-string">""</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Equals(target, <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; target = <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>; PropertyChanged(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PropertyChangedEventArgs(caller)); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> Id { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> =&gt; _id; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> =&gt; Set(<span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> _id, <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Name { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> =&gt; _name; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> =&gt; Set(<span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> _name, <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Birthday { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> =&gt; _birthday; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> =&gt; Set(<span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> _birthday, <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Phone { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> =&gt; _phone; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> =&gt; Set(<span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> _phone, <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Mail { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> =&gt; _mail; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> =&gt; Set(<span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> _mail, <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>); } }</code> </pre> <br></div></div><br><div class="spoiler">  <b class="spoiler_title">Replication profile for the Person entity</b> <div class="spoiler_text"><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> ReplicationProfile PersonRepicationProfile = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ReplicationProfile { MemberProviders = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;MemberProvider&gt; { <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CoreMemberProviderForKeyValuePair(), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CoreMemberProvider(BindingFlags.Public | BindingFlags.Instance, Member.CanReadWrite), } };</code> </pre> <br></div></div><br>  As you can see, the method is quite generalized and can be used for entities of other types. <br><br>  Now pay attention to the key points.  The work of the Replication Framework library is based on the use of snapshots of objects at arbitrary points in time, that is, using the Snapshot extension method, you can easily chronicle the mutations [change history] of an arbitrary object or graph. <br><br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> cache = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ReconstructionCache(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> sourceSnapshot = sourceEntry.CreateSnapshot(cache, replicationProfile); ... <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> resultSnapshot = editableEntry.CreateSnapshot(<span class="hljs-literal"><span class="hljs-literal">null</span></span>, replicationProfile);</code> </pre> <br>  You can then compare two snapshots to identify differences in the state of the graph between any two control points. <br><br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> changes = sourceSnapshot.Juxtapose(resultSnapshot) .Where(j =&gt; j.State != Etalon.State.Identical);</code> </pre> <br>  By calling the ReplicateGraph method, you can recreate a new copy of the graph that is identical to the one recorded in the snapshot, and with the help of ReconstructGraph, if you have a replication cache, you can reconstruct the graph, that is, return the old instance to its previous state. <br><br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> editableEntry = useCopy ? sourceSnapshot.ReplicateGraph() : sourceEntry;</code> </pre> <br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> cache = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ReconstructionCache(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> sourceSnapshot = sourceEntry.CreateSnapshot(cache, replicationProfile); ... <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!useCopy) sourceSnapshot.ReconstructGraph(cache);</code> </pre> <br>  More information about using the library can be found in previous publications: <br><br>  1) <a href="https://habrahabr.ru/post/330294/">Replication Framework ‚Ä¢ deep copying and generalized comparison of connected object graphs</a> <br>  2) <a href="https://habrahabr.ru/post/332516/">Generalized copying of connected graphs of objects in C # and nuances of their serialization</a> <br><br>  The library is free for non-commercial and educational projects, and on Nuget a <a href="https://www.nuget.org/packages/Art.ReplicationFramework.Trial/">trial version</a> is available, which is functional until the end of summer.  To obtain a licensed version with an unlimited period of validity and access to the source code, you must send a request to <a href="http://makeman%40tut.by/">makeman@tut.by</a> . <br><br>  The external simplicity of use and good library functionality make for a great and painstaking work on its creation and debugging, therefore any material support and the purchase of a commercial license are very welcome! <br><br>  Inspiration to you, reader! </div><p>Source: <a href="https://habr.com/ru/post/333846/">https://habr.com/ru/post/333846/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../333836/index.html">Doom 3 source code analysis</a></li>
<li><a href="../333838/index.html">Antivirus on batch file in the past „Ö° it's time to PowerShell sniffer</a></li>
<li><a href="../333840/index.html">The need to regulate the Internet of things</a></li>
<li><a href="../333842/index.html">Monitoring the work of production web studio</a></li>
<li><a href="../333844/index.html">PostgreSQL multi-tiered backup with Barman and synchronous transfer of transaction logs</a></li>
<li><a href="../333848/index.html">What is the power of Redux?</a></li>
<li><a href="../333850/index.html">Security in the era of the Internet of Things: stories of hacking video-babies, pacemakers and supercars</a></li>
<li><a href="../333852/index.html">SwiftyBeaver iOS Guide: Logging Platform for Swift</a></li>
<li><a href="../333854/index.html">Overview-rating providers virtual servers Windows: 2017</a></li>
<li><a href="../333856/index.html">MVC on pure javascript</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>