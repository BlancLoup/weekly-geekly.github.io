<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Create installation media with multiple versions of Windows NT 6.0+ without using third-party software</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello. Today I will tell you how to create a single installation media with many different versions of Windows without resorting to using third-party ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Create installation media with multiple versions of Windows NT 6.0+ without using third-party software</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://habrastorage.org/files/c6a/dde/abb/c6addeabb3cf4ce097f4fe663668bb04.png" alt="KDPV" width="40%" align="left">  Hello.  Today I will tell you how to create a single installation media with many different versions of Windows without resorting to using third-party software.  Thus, you will fully understand what kind of manipulations we perform. </p><br><p>  I will also focus on making as little as possible. <del>  entropy bring into this world </del>  change the structure of the original installation distributions. </p><br><p>  Who cares - I ask under the cat. <br><br clear="left"></p><a name="habracut"></a><br><p></p><br><h1>  Prehistory </h1><br><p>  For the last couple of years I have installed the <abbr title="6.0 - Vista; 6.1 - 7; 6.2 - 8; 6.3 - 8.1; 10.0 - 10">Windows NT 6.0+</abbr> line of <abbr title="Operating Systems">OS</abbr> exclusively from USB media.  Sometimes it was a flash drive, more often - USB-HDD.  (Further, for simplicity, I will call the installation USB drive simply - a <em>USB flash drive</em> ). <br>  But in the Windows installation media there is an unpleasant feature - the paths to the installation files are <abbr title="hardcoded">hard-coded</abbr> .  Those.  At least in the root of the flash drive should be: <br></p><br><pre><code class="dos hljs">[boot] [sources] bootmgr</code> </pre> <br><p>  If you need a <abbr title="Unified Extensible Firmware Interface">UEFI</abbr> boot (for example, to install the system on a disk with a <abbr title="GUID Partition Table">GPT-</abbr> style partition), then plus <code>[efi]</code> . </p><br><p>  Without hacking, these names do not change.  What can it be needed for?  Yes, in order to have several Windows distributions on one flash drive!  After all, someone does not digest Win8, put Win7 on him, and someone wants a newer and more fun system ... </p><br><p>  Before, I didn‚Äôt bother much and just copied these files and folders from the same ISO-shnik (say, Win 8.1 x64).  Renamed <code>[sources]</code> to <code>[sources_w8x64]</code> .  Then I copied only the <code>[sources]</code> from the rest of the ISO-shnik, renaming them in passing.  And that's all.  No more gestures other than recording the boot sector and activating the flash drive partition I did not.  As a result, I had approximately the following file structure on a flash drive: <br></p><br><pre> <code class="dos hljs">[boot] [sources] [sources_w7x86] [sources_w8x64] [sources_w8x86] bootmgr</code> </pre> <br><p>  When it was necessary to install one of the systems, I simply renamed the corresponding folders so that the files of the required Windows were in the <code>[sources]</code> folder. </p><br><p>  This went on for a couple of years.  Well, that did not have to do it often.  But the day came when it was necessary to drive one-group laptop for disc malfunctions.  Among other things, information has been carried out indiscriminately - sequential overwriting of sectors according to <abbr title="Logical block address">LBA</abbr> , regardless of such trifles as <abbr title="Master boot record">MBR</abbr> , partitions, etc.  Naturally, after all the tortures, it would be necessary to prepare the computer for use: partition the disk, install the system, applications, etc.  But you have to install nothing more than Windows 10!  Otherwise, it will definitely reject it!  It is not surprising: if you have already used 10, then you will not return to the old Windows.  I downloaded the <em>Media Creation Tool</em> and started downloading images of 10 with it.  Downloaded.  I put her system, drivers and some of the most necessary applications.  Visual Studio and the rest will deliver.  But the mess on the flash drive was not at all pleased: <br></p><br><pre> <code class="dos hljs">[boot] [sources] [sources_w7x64] [sources_w7x86] [sources_w8x64] [sources_w8x86] [sources_w10x86] bootmgr</code> </pre> <br><p>  These circumstances triggered the decision: </p><br><blockquote>  Enough tolerating this! </blockquote><br><p>  After reading a few articles on the Internet on how to organize this, some of the decisions seemed to me too perverse. <br>  For example: using Grub4Dos to copy the answer file, write the path to the required ISO to the file, mount this ISO, boot into <abbr title="Windows Preinstallation Environment">WinPE</abbr> , then mount the same ISO again (since the previous one is lost due to the transition from real mode to protected), then look for the drive letter with the installation files ... Oh, yes!  If the installation media is a USB-HDD, and not a USB flash drive, then you need to also connect a USB flash drive, in the root of which is the answer file ... In a word, horror. </p><br><p>  Of course, in this you can find a certain logic: this approach allows you not to unpack the ISO-shki, and put them in a separate folder on the flash drive ... But you need to support a bunch of other files ... <br>  In short, this is not our way. </p><br><p></p><br><h1>  Create </h1><br><h2>  Plan </h2><br><p>  We will not play with the ISO mount, but simply place the files for download on the installation media.  But let's not just transfer these files from the installation ISO (as it was before), but slightly alter their structure so that you can simply choose the version of Windows to install without doing any more routine actions (see background). <br><br>  Also, we will not consider here the creation of a Windows <abbr title="All-in-one">AiO</abbr> distribution (when there are many different versions of the system in one <code>sources\install.wim</code> ), since this method has many disadvantages, including: </p><br><ul><li>  one huge file <br><ul><li>  <abbr title="File allocation table">FAT32</abbr> cannot be used, and therefore <abbr title="Unified Extensible Firmware Interface">UEFI</abbr> </li><li>  it is impossible to subsequently use a smaller flash drive skipping copying unnecessary distributions </li></ul></li><li>  Difficulties with updating a specific distribution (you need to remove the old one from the image, and add a new one) </li><li>  It‚Äôs not a fact that you can settle in one image at all, for example, Win7 and Win10 (did not check) </li></ul><br><p><img src="https://habrastorage.org/files/261/fc6/311/261fc631125e4d5aa242efac34eb3ba4.png" alt="One more thing" width="16%" align="left">  We will do everything with our hands and, as promised, without third-party software.  And that is, a bunch of different progs to create super mega cool multiboot disks, but it's not really clear what they do and how.  And we have a plan - without third-party software and with minimal intervention! <br clear="left"><br></p><br><h2>  Preparing a flash drive </h2><br><h3>  Decide on the file system </h3><br><p>  The choice is not great: </p><br><ul><li>  <abbr title="File allocation table">FAT32</abbr> </li><li>  <abbr title="Extended File Allocation Table">exFAT</abbr> </li><li>  <abbr title="New Technology File System">NTFS</abbr> </li></ul><br><p>  <strong>FAT32</strong> : this is your choice if you need a <abbr title="Unified Extensible Firmware Interface">UEFI</abbr> download.  But remember: in this FS, the maximum file size is 4 <abbr title="Gibibayt">GiB</abbr> . <br>  <strong>exFAT</strong> : there is no so tangible limit on file size, but loading by UEFI is impossible.  In addition, some downloaders <del>  (e.g. Grub4Dos) </del>  can not work with it correctly.  But BOOTMGR works.  <strong>Upd:</strong> <em>At least some Live Linux ISO <a href="https://habr.com/ru/post/395629/">does not start</a> .</em> <br>  <strong>NTFS</strong> : everything is fine, except that not all computers support UEFI booting from this file system. </p><br><p>  So it turns out: <br>  necessarily need UEFI - <em>FAT32</em> , not necessarily or not needed at all - <em>NTFS</em> . </p><br><p>  Format the USB flash drive in your chosen file system. <br>  <em>Note: if your flash drive already has the required filesystem, then formatting it is optional.</em>  <em>But I would still formatted;)</em> <br><br></p><br><h3>  Make the partition active </h3><br><p>  This is necessary so that the computer can boot from it (well, or at least try ...). <br>  There is a difference between <abbr title="Fixed disk">USB-HDD</abbr> and <abbr title="Removable disk">flash drives</abbr> . </p><br><p>  For USB-HDD, you can do this: <br>  Open <em>the Disk Management</em> snap-in (diskmgmt.msc).  Right-click on the desired section of your USB-HDD and select "Make partition active".  If this context menu item is inactive, then the section is already active. </p><br><p>  For a flash drive, this option will not work.  Here the context menu item "Make section active" will always be inactive.  Therefore, you need to use a universal method: <br>  Open <em>Command Prompt</em> (cmd.exe).  Run the following commands: <br></p><br><pre> <code class="dos hljs">DiskPart list disk select disk &lt;   (      )&gt; list part select part &lt; ,     ( <span class="hljs-number"><span class="hljs-number">1</span></span>)&gt; active <span class="hljs-keyword"><span class="hljs-keyword">exit</span></span></code> </pre> <br><div class="spoiler">  <b class="spoiler_title">Example</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/542/0a9/6c2/5420a96c213c4d8f9c1339aa67fa0ed3.png" alt="Example of partition activation using DiskPart"></div></div><br><p>  Now your flash drive is bootable.  But it is still empty.  It's time to fill it <del>  meaning </del>  . 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    </p><br><h2>  Filling with distros </h2><br><a name="BootMgrFiles"></a><br><h3>  Windows boot manager files </h3><br><p>  We need a set of boot manager files.  It: <br></p><br><pre> <code class="dos hljs">[boot] [efi] -      UEFI (    FAT32! (      NTFS)) bootmgr bootmgr.efi -      UEFI (    FAT32! (      NTFS))</code> </pre> <br><p>  I copied these files from the most recent distribution - Windows 10 x64 (Threshold 2). </p><br><p>  After that, you can already test how the flash drive is loaded. <br>  If everything is done correctly, you will see the Windows Boot Manager screen with an error message.  Error - due to the fact that we have not yet copied <code>[sources]</code> .  But the fact that <code>bootmgr</code> gets control is just important to us. <br>  If you do not see the Windows Boot Manager screen, then perhaps the fact is that when formatting the system did not record the boot sector compatible with BOOTMGR.  To do this manually, execute the command <code>bootsect /nt60 &lt;_&gt;:</code> where &lt;drive letter&gt; is your flash drive. <br><br></p><br><h3>  Distributions </h3><br><p>  Distribution files are in <code>[sources]</code> .  So you need to create a folder structure containing <code>[sources]</code> from different versions of Windows under different names.  This structure can be done as you like.  But it is important then to observe the conformity of the paths.  I did this: <br></p><br><pre> <code class="dos hljs">[WinDists] |- [Win_7_ia32] |- [Win_7_x64] |- [Win_8.<span class="hljs-number"><span class="hljs-number">1</span></span>_ia32] |- [Win_8.<span class="hljs-number"><span class="hljs-number">1</span></span>_x64] |- [Win_10_ia32] |- [Win_10_x64]</code> </pre> <br><p>  Now in each of these folders you need to copy the <em>contents of</em> <code>[sources]</code> from the corresponding ISO-Schnick.  Until now, only a few dozen MiBs were occupied on the flash drive.  And now - a few <abbr title="Gibibayt">GiB</abbr> . <br><br></p><br><h2>  Customization </h2><br><h3>  Menu </h3><br><p>  We want to be able to choose any of these systems simply from the menu.  Without renaming folders, etc.  routine  So, you need to add a menu item for each of Windows. </p><br><p>  Remember, we <a href="https://habr.com/ru/post/395629/">used</a> to copy the download manager files?  Now you need to edit the boot configuration data files.  It: <br></p><br><pre> <code class="dos hljs">[boot] |- bcd [efi] |- [microsoft] |- [boot] |- bcd -      UEFI (    FAT32! (      NTFS))</code> </pre> <br><a name="EditBCD"></a><br><h4>  Editing <abbr title="Boot configuration data">BCD</abbr> </h4><br><p>  First turn on the display menu.  And we‚Äôll remove the timeout so that it appears so long before the user makes a choice (we‚Äôre not just loading, we‚Äôre installing the system! The choice must be conscious). <br>  To do this, run the commands: <br></p><br><pre> <code class="dos hljs">bcdedit /store &lt;_&gt;:\boot\bcd /<span class="hljs-built_in"><span class="hljs-built_in">set</span></span> {bootmgr} DisplayBootMenu True bcdedit /store &lt;_&gt;:\boot\bcd /deletevalue {bootmgr} Timeout</code> </pre> <br><p>  where &lt;letter of the disc&gt; hereinafter is your flash drive. </p><br><p>  Next we will add installation points for each of the systems.  First run the command <br> <code>bcdedit /store &lt;_&gt;:\boot\bcd /enum {default}</code> <br>  to find out the value of the <code>device</code> and <code>osdevice</code> item by default.  They will be approximately as follows: </p><br><pre> <code class="dos hljs">device ramdisk=[boot]\sources\boot.wim,{&lt;GUID  ramdisk&gt;} osdevice ramdisk=[boot]\sources\boot.wim,{&lt;GUID  ramdisk&gt;}</code> </pre> <br><p>  As a rule, the values ‚Äã‚Äãof these parameters in the same loading point are the same. <br>  For each Windows distribution we will change the path to the image with <em><abbr title="Windows Preinstallation Environment">WinPE</abbr></em> ( <code>boot.wim</code> ), while keeping the <em>&lt;GUID of the ramdisk&gt; parameters the</em> same.  These will be the only differences between the download points of different distributions. <br></p><br><div class="spoiler">  <b class="spoiler_title">More about these options.</b> <div class="spoiler_text"><p>  The <code>device</code> parameter specifies the device on which <code>\windows\system32\boot\winload.exe</code> (this value is specified in the <code>path</code> parameter). <br>  The <code>osdevice</code> parameter specifies the device on which <code>\windows</code> <code>osdevice</code> (this value is specified in the <code>systemroot</code> parameter). </p><br><p>  In our case, the <code>device</code> and <code>osdevice</code> consist of the path to the WIM image of the system (in this case, <em>WinPE</em> ), which is loaded into RAM (ramdisk).  After the comma, the GUID of the entry is specified, which determines the parameters of the device from which <em>WinPE</em> will be loaded (in our case, ramdisk).  You can look at it in more detail: </p><br><pre> <code class="dos hljs">bcdedit /store &lt;_&gt;:\boot\bcd /enum {&lt;GUID  ramdisk&gt;}   -------------------  {&lt;GUID  ramdisk&gt;} ramdisksdidevice boot ramdisksdipath \boot\boot.sdi</code> </pre> <br><p>  Nothing special.  We will use the same device parameters for other loading points. </p><br><p>  <code>boot.sdi</code> - This is essentially an image of an empty NTFS volume.  And in this volume is already mounted image from <code>boot.wim</code> . </p></div></div><br><p>  Since the default item is already fully configured (except for the <code>device</code> and <code>osdevice</code> ), we will simply copy and modify it. <br></p><br><h5>  Adding Items </h5><br><ol><li>  Copy item by default: <br> <code>bcdedit /store &lt;_&gt;:\boot\bcd /copy {Default} /d "&lt;  &gt;"</code> <br>  A message will be displayed with the GUID of the new item.  Something like this: <br>  <abbr title="The entry was successfully copied to"><code>   </code></abbr> <code>{&lt;GUID  &gt;}</code> <br></li><li>  Change the above parameters in it: <br>  <code>bcdedit /store &lt;_&gt;:\boot\bcd /set {&lt;GUID  &gt;}</code> <strong><code>device</code></strong> <code>ramdisk=[boot]\&lt;  &gt;\boot.wim,{&lt;GUID  ramdisk&gt;}</code> <br><br>  <code>bcdedit /store &lt;_&gt;:\boot\bcd /set {&lt;GUID  &gt;}</code> <strong><code>osdevice</code></strong> <code>ramdisk=[boot]\&lt;  &gt;\boot.wim,{&lt;GUID  ramdisk&gt;}</code> <br><br>  These two commands differ only in one word (highlighted). </li></ol><br><div class="spoiler">  <b class="spoiler_title">Examples</b> <div class="spoiler_text"><p>  Here are some examples of creating new download points based on the default item. <br>  <em>Do not stupidly copy the commands from here!</em>  <em>You will have other GUIDs.</em>  <em>These examples are just to understand what's what.</em> </p><br><pre> <code class="dos hljs">bcdedit /store &lt;_&gt;:\boot\bcd /<span class="hljs-built_in"><span class="hljs-built_in">copy</span></span> {Default} /d "Windows <span class="hljs-number"><span class="hljs-number">7</span></span> (<span class="hljs-number"><span class="hljs-number">32</span></span>-bit) Setup"     {<span class="hljs-number"><span class="hljs-number">90</span></span>fff3ef-<span class="hljs-number"><span class="hljs-number">3</span></span>b91-<span class="hljs-number"><span class="hljs-number">11</span></span>e6-<span class="hljs-number"><span class="hljs-number">839</span></span>b-d850e607fea0}. bcdedit /store &lt;_&gt;:\boot\bcd /<span class="hljs-built_in"><span class="hljs-built_in">set</span></span> {<span class="hljs-number"><span class="hljs-number">90</span></span>fff3ef-<span class="hljs-number"><span class="hljs-number">3</span></span>b91-<span class="hljs-number"><span class="hljs-number">11</span></span>e6-<span class="hljs-number"><span class="hljs-number">839</span></span>b-d850e607fea0} device ramdisk=[boot]\WinDists\Win_7_ia32\boot.wim,{<span class="hljs-number"><span class="hljs-number">7619</span></span>dcc8-fafe-<span class="hljs-number"><span class="hljs-number">11</span></span>d9-b411-<span class="hljs-number"><span class="hljs-number">000476</span></span>eba25f} bcdedit /store &lt;_&gt;:\boot\bcd /<span class="hljs-built_in"><span class="hljs-built_in">set</span></span> {<span class="hljs-number"><span class="hljs-number">90</span></span>fff3ef-<span class="hljs-number"><span class="hljs-number">3</span></span>b91-<span class="hljs-number"><span class="hljs-number">11</span></span>e6-<span class="hljs-number"><span class="hljs-number">839</span></span>b-d850e607fea0} osdevice ramdisk=[boot]\WinDists\Win_7_ia32\boot.wim,{<span class="hljs-number"><span class="hljs-number">7619</span></span>dcc8-fafe-<span class="hljs-number"><span class="hljs-number">11</span></span>d9-b411-<span class="hljs-number"><span class="hljs-number">000476</span></span>eba25f}</code> </pre> <br><pre> <code class="dos hljs">bcdedit /store &lt;_&gt;:\boot\bcd /<span class="hljs-built_in"><span class="hljs-built_in">copy</span></span> {Default} /d "Windows <span class="hljs-number"><span class="hljs-number">7</span></span> (<span class="hljs-number"><span class="hljs-number">64</span></span>-bit) Setup"     {e5f9b9b7-<span class="hljs-number"><span class="hljs-number">3</span></span>bb1-<span class="hljs-number"><span class="hljs-number">11</span></span>e6-<span class="hljs-number"><span class="hljs-number">839</span></span>b-d850e607fea0}. bcdedit /store &lt;_&gt;:\boot\bcd /<span class="hljs-built_in"><span class="hljs-built_in">set</span></span> {e5f9b9b7-<span class="hljs-number"><span class="hljs-number">3</span></span>bb1-<span class="hljs-number"><span class="hljs-number">11</span></span>e6-<span class="hljs-number"><span class="hljs-number">839</span></span>b-d850e607fea0} device ramdisk=[boot]\WinDists\Win_7_x64\boot.wim,{<span class="hljs-number"><span class="hljs-number">7619</span></span>dcc8-fafe-<span class="hljs-number"><span class="hljs-number">11</span></span>d9-b411-<span class="hljs-number"><span class="hljs-number">000476</span></span>eba25f} bcdedit /store &lt;_&gt;:\boot\bcd /<span class="hljs-built_in"><span class="hljs-built_in">set</span></span> {e5f9b9b7-<span class="hljs-number"><span class="hljs-number">3</span></span>bb1-<span class="hljs-number"><span class="hljs-number">11</span></span>e6-<span class="hljs-number"><span class="hljs-number">839</span></span>b-d850e607fea0} osdevice ramdisk=[boot]\WinDists\Win_7_x64\boot.wim,{<span class="hljs-number"><span class="hljs-number">7619</span></span>dcc8-fafe-<span class="hljs-number"><span class="hljs-number">11</span></span>d9-b411-<span class="hljs-number"><span class="hljs-number">000476</span></span>eba25f}</code> </pre> <br><pre> <code class="dos hljs">bcdedit /store &lt;_&gt;:\boot\bcd /<span class="hljs-built_in"><span class="hljs-built_in">copy</span></span> {Default} /d "Windows <span class="hljs-number"><span class="hljs-number">8</span></span>.<span class="hljs-number"><span class="hljs-number">1</span></span> (<span class="hljs-number"><span class="hljs-number">32</span></span>-bit) Setup"     {cda5bc88-<span class="hljs-number"><span class="hljs-number">3</span></span>bb4-<span class="hljs-number"><span class="hljs-number">11</span></span>e6-<span class="hljs-number"><span class="hljs-number">839</span></span>b-d850e607fea0}. bcdedit /store &lt;_&gt;:\boot\bcd /<span class="hljs-built_in"><span class="hljs-built_in">set</span></span> {cda5bc88-<span class="hljs-number"><span class="hljs-number">3</span></span>bb4-<span class="hljs-number"><span class="hljs-number">11</span></span>e6-<span class="hljs-number"><span class="hljs-number">839</span></span>b-d850e607fea0} device ramdisk=[boot]\WinDists\Win_8.<span class="hljs-number"><span class="hljs-number">1</span></span>_ia32\boot.wim,{<span class="hljs-number"><span class="hljs-number">7619</span></span>dcc8-fafe-<span class="hljs-number"><span class="hljs-number">11</span></span>d9-b411-<span class="hljs-number"><span class="hljs-number">000476</span></span>eba25f} bcdedit /store &lt;_&gt;:\boot\bcd /<span class="hljs-built_in"><span class="hljs-built_in">set</span></span> {cda5bc88-<span class="hljs-number"><span class="hljs-number">3</span></span>bb4-<span class="hljs-number"><span class="hljs-number">11</span></span>e6-<span class="hljs-number"><span class="hljs-number">839</span></span>b-d850e607fea0} osdevice ramdisk=[boot]\WinDists\Win_8.<span class="hljs-number"><span class="hljs-number">1</span></span>_ia32\boot.wim,{<span class="hljs-number"><span class="hljs-number">7619</span></span>dcc8-fafe-<span class="hljs-number"><span class="hljs-number">11</span></span>d9-b411-<span class="hljs-number"><span class="hljs-number">000476</span></span>eba25f}</code> </pre> <br><pre> <code class="dos hljs">bcdedit /store &lt;_&gt;:\boot\bcd /<span class="hljs-built_in"><span class="hljs-built_in">copy</span></span> {Default} /d "Windows <span class="hljs-number"><span class="hljs-number">8</span></span>.<span class="hljs-number"><span class="hljs-number">1</span></span> (<span class="hljs-number"><span class="hljs-number">64</span></span>-bit) Setup"     {<span class="hljs-number"><span class="hljs-number">330</span></span>e8636-<span class="hljs-number"><span class="hljs-number">3</span></span>bb5-<span class="hljs-number"><span class="hljs-number">11</span></span>e6-<span class="hljs-number"><span class="hljs-number">839</span></span>b-d850e607fea0}. bcdedit /store &lt;_&gt;:\boot\bcd /<span class="hljs-built_in"><span class="hljs-built_in">set</span></span> {<span class="hljs-number"><span class="hljs-number">330</span></span>e8636-<span class="hljs-number"><span class="hljs-number">3</span></span>bb5-<span class="hljs-number"><span class="hljs-number">11</span></span>e6-<span class="hljs-number"><span class="hljs-number">839</span></span>b-d850e607fea0} device ramdisk=[boot]\WinDists\Win_8.<span class="hljs-number"><span class="hljs-number">1</span></span>_x64\boot.wim,{<span class="hljs-number"><span class="hljs-number">7619</span></span>dcc8-fafe-<span class="hljs-number"><span class="hljs-number">11</span></span>d9-b411-<span class="hljs-number"><span class="hljs-number">000476</span></span>eba25f} bcdedit /store &lt;_&gt;:\boot\bcd /<span class="hljs-built_in"><span class="hljs-built_in">set</span></span> {<span class="hljs-number"><span class="hljs-number">330</span></span>e8636-<span class="hljs-number"><span class="hljs-number">3</span></span>bb5-<span class="hljs-number"><span class="hljs-number">11</span></span>e6-<span class="hljs-number"><span class="hljs-number">839</span></span>b-d850e607fea0} osdevice ramdisk=[boot]\WinDists\Win_8.<span class="hljs-number"><span class="hljs-number">1</span></span>_x64\boot.wim,{<span class="hljs-number"><span class="hljs-number">7619</span></span>dcc8-fafe-<span class="hljs-number"><span class="hljs-number">11</span></span>d9-b411-<span class="hljs-number"><span class="hljs-number">000476</span></span>eba25f}</code> </pre> <br><pre> <code class="dos hljs">bcdedit /store &lt;_&gt;:\boot\bcd /<span class="hljs-built_in"><span class="hljs-built_in">copy</span></span> {Default} /d "Windows <span class="hljs-number"><span class="hljs-number">10</span></span> (<span class="hljs-number"><span class="hljs-number">32</span></span>-bit) Setup"     {<span class="hljs-number"><span class="hljs-number">87</span></span>c0826c-<span class="hljs-number"><span class="hljs-number">3</span></span>bb5-<span class="hljs-number"><span class="hljs-number">11</span></span>e6-<span class="hljs-number"><span class="hljs-number">839</span></span>b-d850e607fea0}. bcdedit /store &lt;_&gt;:\boot\bcd /<span class="hljs-built_in"><span class="hljs-built_in">set</span></span> {<span class="hljs-number"><span class="hljs-number">87</span></span>c0826c-<span class="hljs-number"><span class="hljs-number">3</span></span>bb5-<span class="hljs-number"><span class="hljs-number">11</span></span>e6-<span class="hljs-number"><span class="hljs-number">839</span></span>b-d850e607fea0} device ramdisk=[boot]\WinDists\Win_10_ia32\boot.wim,{<span class="hljs-number"><span class="hljs-number">7619</span></span>dcc8-fafe-<span class="hljs-number"><span class="hljs-number">11</span></span>d9-b411-<span class="hljs-number"><span class="hljs-number">000476</span></span>eba25f} bcdedit /store &lt;_&gt;:\boot\bcd /<span class="hljs-built_in"><span class="hljs-built_in">set</span></span> {<span class="hljs-number"><span class="hljs-number">87</span></span>c0826c-<span class="hljs-number"><span class="hljs-number">3</span></span>bb5-<span class="hljs-number"><span class="hljs-number">11</span></span>e6-<span class="hljs-number"><span class="hljs-number">839</span></span>b-d850e607fea0} osdevice ramdisk=[boot]\WinDists\Win_10_ia32\boot.wim,{<span class="hljs-number"><span class="hljs-number">7619</span></span>dcc8-fafe-<span class="hljs-number"><span class="hljs-number">11</span></span>d9-b411-<span class="hljs-number"><span class="hljs-number">000476</span></span>eba25f}</code> {87c0826c-3bb5-11e6-839b-d850e607fea0} device ramdisk = [boot] \ WinDists \ Win_10_ia32 \ boot.wim, {7619dcc8-fafe-11d9-b411-000476eba25f} <code class="dos hljs">bcdedit /store &lt;_&gt;:\boot\bcd /<span class="hljs-built_in"><span class="hljs-built_in">copy</span></span> {Default} /d "Windows <span class="hljs-number"><span class="hljs-number">10</span></span> (<span class="hljs-number"><span class="hljs-number">32</span></span>-bit) Setup"     {<span class="hljs-number"><span class="hljs-number">87</span></span>c0826c-<span class="hljs-number"><span class="hljs-number">3</span></span>bb5-<span class="hljs-number"><span class="hljs-number">11</span></span>e6-<span class="hljs-number"><span class="hljs-number">839</span></span>b-d850e607fea0}. bcdedit /store &lt;_&gt;:\boot\bcd /<span class="hljs-built_in"><span class="hljs-built_in">set</span></span> {<span class="hljs-number"><span class="hljs-number">87</span></span>c0826c-<span class="hljs-number"><span class="hljs-number">3</span></span>bb5-<span class="hljs-number"><span class="hljs-number">11</span></span>e6-<span class="hljs-number"><span class="hljs-number">839</span></span>b-d850e607fea0} device ramdisk=[boot]\WinDists\Win_10_ia32\boot.wim,{<span class="hljs-number"><span class="hljs-number">7619</span></span>dcc8-fafe-<span class="hljs-number"><span class="hljs-number">11</span></span>d9-b411-<span class="hljs-number"><span class="hljs-number">000476</span></span>eba25f} bcdedit /store &lt;_&gt;:\boot\bcd /<span class="hljs-built_in"><span class="hljs-built_in">set</span></span> {<span class="hljs-number"><span class="hljs-number">87</span></span>c0826c-<span class="hljs-number"><span class="hljs-number">3</span></span>bb5-<span class="hljs-number"><span class="hljs-number">11</span></span>e6-<span class="hljs-number"><span class="hljs-number">839</span></span>b-d850e607fea0} osdevice ramdisk=[boot]\WinDists\Win_10_ia32\boot.wim,{<span class="hljs-number"><span class="hljs-number">7619</span></span>dcc8-fafe-<span class="hljs-number"><span class="hljs-number">11</span></span>d9-b411-<span class="hljs-number"><span class="hljs-number">000476</span></span>eba25f}</code> </pre> <br><pre> <code class="dos hljs">bcdedit /store &lt;_&gt;:\boot\bcd /<span class="hljs-built_in"><span class="hljs-built_in">copy</span></span> {Default} /d "Windows <span class="hljs-number"><span class="hljs-number">10</span></span> (<span class="hljs-number"><span class="hljs-number">64</span></span>-bit) Setup"     {dd7288b2-<span class="hljs-number"><span class="hljs-number">3</span></span>bb8-<span class="hljs-number"><span class="hljs-number">11</span></span>e6-<span class="hljs-number"><span class="hljs-number">839</span></span>b-d850e607fea0}. bcdedit /store &lt;_&gt;:\boot\bcd /<span class="hljs-built_in"><span class="hljs-built_in">set</span></span> {dd7288b2-<span class="hljs-number"><span class="hljs-number">3</span></span>bb8-<span class="hljs-number"><span class="hljs-number">11</span></span>e6-<span class="hljs-number"><span class="hljs-number">839</span></span>b-d850e607fea0} device ramdisk=[boot]\WinDists\Win_10_x64\boot.wim,{<span class="hljs-number"><span class="hljs-number">7619</span></span>dcc8-fafe-<span class="hljs-number"><span class="hljs-number">11</span></span>d9-b411-<span class="hljs-number"><span class="hljs-number">000476</span></span>eba25f} bcdedit /store &lt;_&gt;:\boot\bcd /<span class="hljs-built_in"><span class="hljs-built_in">set</span></span> {dd7288b2-<span class="hljs-number"><span class="hljs-number">3</span></span>bb8-<span class="hljs-number"><span class="hljs-number">11</span></span>e6-<span class="hljs-number"><span class="hljs-number">839</span></span>b-d850e607fea0} osdevice ramdisk=[boot]\WinDists\Win_10_x64\boot.wim,{<span class="hljs-number"><span class="hljs-number">7619</span></span>dcc8-fafe-<span class="hljs-number"><span class="hljs-number">11</span></span>d9-b411-<span class="hljs-number"><span class="hljs-number">000476</span></span>eba25f}</code> </pre> <br><pre> <code class="dos hljs">bcdedit /store &lt;_&gt;:\boot\bcd /<span class="hljs-built_in"><span class="hljs-built_in">copy</span></span> {Default} /d "Other Windows Setup (from \sources)" The entry was successfully copied to {c9ff9b3a-<span class="hljs-number"><span class="hljs-number">3</span></span>c53-<span class="hljs-number"><span class="hljs-number">11</span></span>e6-<span class="hljs-number"><span class="hljs-number">839</span></span>c-d850e607fea0}.</code> </pre> </div></div><br><p></p><br><h5>  Finishing BCD Editing </h5><br><p>  After all items are added, we delete the item by default: <br> <code>bcdedit /store &lt;_&gt;:\boot\bcd /delete {default}</code> </p> <br><p></p><br><h4>  Editing BCD for UEFI </h4><br><p>  If you need a <em>UEFI</em> boot, then you also need to edit another boot configuration repository (the one that guides <code>BootMgFw.efi</code> ). </p><br><p>  Everything is exactly the same as <a href="https://habr.com/ru/post/395629/">there</a> , except for the path to the <code>BCD</code> file. <br>  Those.  instead <br> <code>bcdedit /store &lt;_&gt;:\boot\bcd</code> <br>  should use <br>  <code>bcdedit /store &lt;_&gt;:\efi\microsoft\boot\bcd</code> . </p><br><p><img src="https://habrastorage.org/files/31e/e74/74c/31ee7474c9894a8ea6da445b32eb6e93.png" alt="You can not just take" width="10%" align="left">  <em>Note.</em>  You <strong><em>can</em></strong> not just take and copy <code>\boot\bcd</code> to <code>\efi\microsoft\boot\bcd</code> !  They should differ at least with <code>path</code> parameters in all points, including <code>{memdiag}</code> . </p><br><blockquote>  <code>\windows\system32\boot\winload.exe</code> vs <code>\windows\system32\boot\winload.efi</code> <br>  <code>\boot\memtest.exe</code> vs <code>\efi\microsoft\boot\memtest.efi</code> </blockquote><br><p>  <strong>Update</strong> <br>  With <em>UEFI</em> , all <em>64-bit</em> versions of Windows NT 6.0+ can be loaded, and from <em>32-bit</em> <em>versions,</em> only <em>Windows 8+</em> can be loaded. <br>  In addition, <strong>there</strong> should <strong>not</strong> be an <em>IsolatedContext</em> parameter with the value <em>Yes</em> in the OS installation points prior to <em>Windows 8</em> .  Otherwise, you simply will not start the environment of the pre-installation of this system (ie, you can not install, for example, <em>Windows 7 x64</em> <em>UEFI</em> mode). </p><br><p></p><br><h3>  Windows PE </h3><br><p>  So, when booting from a flash drive, we already have a working menu where we can choose the necessary version of Windows.  Boot and make sure that when you select a specific menu item loads the corresponding <em>Windows PE</em> . </p><br><p></p><br><h4>  Problem </h4><br><p>  We have not done everything yet.  After all, if you try to install some of the systems, you get an unpleasant surprise: </p><br><p><img src="https://habrastorage.org/files/e8c/bdf/e68/e8cbdfe686e34acf816d2cd8003d9521.png" alt="No Sources Error"></p><br><p>  Why did this happen?  The fact is that the installer is looking for an <code>install.</code> image <code>install.</code>  <abbr title="Windows Imaging Format"><code>wim</code></abbr> or compressed <code>install.</code>  <abbr title="Electronic Software Download / Distribution"><code>esd</code></abbr> in the <code>sources</code> folder on all available volumes.  In case of failure, <em>Windows 10</em> still tries to search in <code>x64\sources</code> or <code>x86\sources</code> folders, depending on the bit depth.  In our case, it does not find anywhere. <br>  She thinks that there is probably no driver from the installation media and offers to download it. </p><br><p></p><br><h4>  Solution options </h4><br><p>  You can already install Windows from your flash drive manually by correctly running the installer.  There are several options. <br></p><br><ul><li>  Answer file <br>  Using an answer file, you can specify many installation options.  Including the image from where to install the system. <br>  The path to the image is specified in the element <a href="https://technet.microsoft.com/en-us/library/cc766265(v%3Dws.10).aspx"><code>Microsoft-Windows-Setup | ImageInstall | OSImage | InstallFrom | Path</code></a> <a href="https://technet.microsoft.com/en-us/library/cc766265(v%3Dws.10).aspx"><code>Microsoft-Windows-Setup | ImageInstall | OSImage | InstallFrom | Path</code></a>  <a href="https://technet.microsoft.com/en-us/library/cc766265(v%3Dws.10).aspx"><code>Microsoft-Windows-Setup | ImageInstall | OSImage | InstallFrom | Path</code></a> . <br>  You can make the installer use the response file either explicitly: <br> <code>setup.exe /unattend:&lt;   &gt;</code> <br>  Or by placing it on one of the <a href="https://technet.microsoft.com/ru-ru/library/dd744269(v%3Dws.10).aspx" title="Answer File Search Order">predetermined paths</a> . <br>  But in this way there is a problem.  The answer file must have an absolute path.  Convenient when you need to install from the network.  But not practical for our case.  Computers are different - the letter of the flash drive will change.  Not our option.  And also explicitly specify the path to the response file - well, not at all an option. <br></li><li>  Run the installer with the parameter <br>  You can find the image using the <code>cmd.exe</code> script.  And then run the installer, clearly telling him where to look: <br> <code>X:\sources\setup.exe /installFrom:&lt;  install.wim  install.esd&gt;</code> <br>  This option is suitable.  You will be able to install the system as with the usual ISO ISO. <br>  But there is an option even better. <br></li><li>  Running the installer from a flash drive <br>  You can start the installation not from <code>X:</code> (mounted <code>boot.wim</code> image), but directly from the flash drive!  Thus, it is not necessary to explicitly specify the path to <code>install.wim</code> or <code>install.esd</code> .  The installer will find this file next to itself (in the launch folder)! <br>  So, for example, to install Win 10 x64 you need to run: <br> <code>&lt; &gt;:\WinDists\Win_10_x64\setup.exe</code> <br>  This method has many advantages.  After all, we actually completely refuse to use anything from <code>X:\sources</code> , in favor of the corresponding folder on the flash drive.  This means that we can subsequently modify it without making changes to the <code>boot.wim</code> image.  Conveniently!  For example, you can put here an individual (for this particular distribution) answer file (next to <code>setup.exe</code> ) and it will be picked up according to the 6th paragraph <a href="https://technet.microsoft.com/ru-ru/library/dd744269(v%3Dws.10).aspx" title="Answer File Search Order">from here</a> . </li></ul><br><p></p><br><h4>  Decision </h4><br><p>  That's all well and good, but we don‚Äôt want to start the installation manually, right?  We want it to itself.  It means that it should be made so that it starts the installation from where it is necessary. </p><br><p></p><br><h5>  Automation options </h5><br><p>  Consider running <em>Windows PE</em> to figure out how to get it to do what we need with minimal intervention. <br>  The registry <code>HKLM\SYSTEM\Setup\CmdLine</code> indicates the first application that runs after running WinPE.  This is <code>winpeshl.exe</code> .  It does all sorts of useful things, like this: </p><br><ol><li>  Includes a background image (running <code>WallpaperHost.exe</code> ) </li><li>  Checks if there is a <code>winpeshl.ini</code> file <code>winpeshl.ini</code> .  If there is - executes commands from it. </li><li>  Initializes <abbr title="Plug and play">PNP</abbr> </li><li>  If there was no <code>winpeshl.ini</code> file, it tries to start <em>one</em> of the applications (in order of priority): <br><ul><li>  X: \ $ Windows. ~ BT \ sources \ setup.exe </li><li>  X: \ setup.exe </li><li>  X: \ windows \ system32 \ cmd.exe / k startnet.cmd </li></ul></li></ol><br><p>  We need to run our script, which will find the file on the flash drive and run it.  As you can see, we have more than one option: </p><br><ul><li>  add a script file and <code>winpeshl.ini</code> with the command to run <code>cmd.exe</code> to execute our script </li><li>  remove / rename <code>X:\setup.exe</code> and edit <code>startnet.cmd</code> </li></ul><br><p>  I will demonstrate the option only with the addition of files (minimal intervention, yes). <br></p><br><a name="EditBootWIM"></a><br><h5>  Modify <code>boot.wim</code> </h5><br><p>  The example distribution Windows 10 x64. <br>  So, we need to edit the contents of volume <code>X:</code> which is mounted from <code>boot.wim</code> .  First, find out the index of the image to mount: <br></p><br><pre> <code class="dos hljs">dism /get-wimInfo /wimFile:&lt;_&gt;:\WinDists\Win_10_x64\boot.wim C DISM : <span class="hljs-number"><span class="hljs-number">6</span></span>.<span class="hljs-number"><span class="hljs-number">3</span></span>.<span class="hljs-number"><span class="hljs-number">9600</span></span>.<span class="hljs-number"><span class="hljs-number">17031</span></span>    : &lt;_&gt;:\WinDists\Win_10_x64\boot.wim : <span class="hljs-number"><span class="hljs-number">1</span></span>  : Microsoft Windows PE (x64)  : Microsoft Windows PE (x64)  (): <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">357</span></span> <span class="hljs-number"><span class="hljs-number">917</span></span> <span class="hljs-number"><span class="hljs-number">901</span></span> : <span class="hljs-number"><span class="hljs-number">2</span></span>  : Microsoft Windows Setup (x64)  : Microsoft Windows Setup (x64)  (): <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">540</span></span> <span class="hljs-number"><span class="hljs-number">370</span></span> <span class="hljs-number"><span class="hljs-number">231</span></span>   .</code> </pre> <br><p>  We need not clean <em>Windows PE</em> , and the installation - <em>Windows Setup</em> .  Those.  index - 2. <br>  We also need to create a folder where we will mount the image.  I created <code>C:\mnt</code> . <br></p><br><pre> <code class="dos hljs">dism /mount-wim /wimFile:&lt;_&gt;:\WinDists\Win_10_x64\boot.wim /index:<span class="hljs-number"><span class="hljs-number">2</span></span> /mountDir:C:\mnt C DISM : <span class="hljs-number"><span class="hljs-number">6</span></span>.<span class="hljs-number"><span class="hljs-number">3</span></span>.<span class="hljs-number"><span class="hljs-number">9600</span></span>.<span class="hljs-number"><span class="hljs-number">17031</span></span>   [==========================<span class="hljs-number"><span class="hljs-number">100</span></span>.<span class="hljs-number"><span class="hljs-number">0</span></span>%==========================]   .</code> </pre> <br><p>  Now, as planned, we copy the <code>winpeshl.ini</code> files and our script file (I called it <code>runsetup.cmd</code> ) to <code>C:\mnt\Windows\System32\</code> . <br></p><br><div class="spoiler">  <b class="spoiler_title">Content winpeshl.ini</b> <div class="spoiler_text"><pre> <code class="dos hljs">[LaunchApps] <span class="hljs-built_in"><span class="hljs-built_in">cmd</span></span>.exe, "/k runsetup.<span class="hljs-built_in"><span class="hljs-built_in">cmd</span></span>"</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">Contents of runsetup.cmd</b> <div class="spoiler_text"><pre> <code class="dos hljs">@<span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> off <span class="hljs-built_in"><span class="hljs-built_in">Title</span></span> TishSerg Windows Setup Bootstrapper v1.<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-built_in"><span class="hljs-built_in">color</span></span> <span class="hljs-number"><span class="hljs-number">9</span></span>f <span class="hljs-built_in"><span class="hljs-built_in">ver</span></span> <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span>. <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> [<span class="hljs-variable"><span class="hljs-variable">%time%</span></span>] Initializing Windows PE... Wpeinit <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span>. Wpeutil UpdateBootInfo &gt; <span class="hljs-built_in"><span class="hljs-built_in">nul</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> /f "tokens=<span class="hljs-number"><span class="hljs-number">3</span></span>" <span class="hljs-variable"><span class="hljs-variable">%%a</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> ( 'reg query "HKLM\System\CurrentControlSet\Control" /v PEBootRamdiskSourceDrive' ) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> RamdiskSourceDrive=<span class="hljs-variable"><span class="hljs-variable">%%a</span></span> <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> [<span class="hljs-variable"><span class="hljs-variable">%time%</span></span>] Detected setup media: <span class="hljs-variable"><span class="hljs-variable">%RamdiskSourceDrive%</span></span> <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span>. :: Windows dist <span class="hljs-built_in"><span class="hljs-built_in">path</span></span> Affix <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> WinDistAfx=WinDists\Win :: <span class="hljs-built_in"><span class="hljs-built_in">Find</span></span> Windows arch Affix <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> "<span class="hljs-variable"><span class="hljs-variable">%PROCESSOR_ARCHITECTURE%</span></span>" == "x86" ( <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> WinArchAfx=ia32 ) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> ( <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> WinArchAfx=x64 ) :: <span class="hljs-built_in"><span class="hljs-built_in">Find</span></span> Windows version Affix <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> /f "tokens=<span class="hljs-number"><span class="hljs-number">3</span></span>" <span class="hljs-variable"><span class="hljs-variable">%%b</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> ( 'reg query "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion" /v CurrentBuildNumber' ) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> /a CurrentBuildNumber=<span class="hljs-variable"><span class="hljs-variable">%%b</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-variable"><span class="hljs-variable">%CurrentBuildNumber%</span></span> <span class="hljs-keyword"><span class="hljs-keyword">lss</span></span> <span class="hljs-number"><span class="hljs-number">6100</span></span> ( :: Build &lt; <span class="hljs-number"><span class="hljs-number">6100</span></span> is Vista <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> WinVerAfx=Vista <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> [<span class="hljs-variable"><span class="hljs-variable">%time%</span></span>] Determined version of Windows: Vista (build <span class="hljs-variable"><span class="hljs-variable">%CurrentBuildNumber%</span></span>^) <span class="hljs-variable"><span class="hljs-variable">%PROCESSOR_ARCHITECTURE%</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-variable"><span class="hljs-variable">%CurrentBuildNumber%</span></span> <span class="hljs-keyword"><span class="hljs-keyword">lss</span></span> <span class="hljs-number"><span class="hljs-number">7700</span></span> ( :: Build &lt; <span class="hljs-number"><span class="hljs-number">7700</span></span> is <span class="hljs-number"><span class="hljs-number">7</span></span> <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> WinVerAfx=<span class="hljs-number"><span class="hljs-number">7</span></span> <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> [<span class="hljs-variable"><span class="hljs-variable">%time%</span></span>] Determined version of Windows: <span class="hljs-number"><span class="hljs-number">7</span></span> (build <span class="hljs-variable"><span class="hljs-variable">%CurrentBuildNumber%</span></span>^) <span class="hljs-variable"><span class="hljs-variable">%PROCESSOR_ARCHITECTURE%</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-variable"><span class="hljs-variable">%CurrentBuildNumber%</span></span> <span class="hljs-keyword"><span class="hljs-keyword">lss</span></span> <span class="hljs-number"><span class="hljs-number">9300</span></span> ( :: Build &lt; <span class="hljs-number"><span class="hljs-number">9300</span></span> is <span class="hljs-number"><span class="hljs-number">8</span></span> <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> WinVerAfx=<span class="hljs-number"><span class="hljs-number">8</span></span> <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> [<span class="hljs-variable"><span class="hljs-variable">%time%</span></span>] Determined version of Windows: <span class="hljs-number"><span class="hljs-number">8</span></span> (build <span class="hljs-variable"><span class="hljs-variable">%CurrentBuildNumber%</span></span>^) <span class="hljs-variable"><span class="hljs-variable">%PROCESSOR_ARCHITECTURE%</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-variable"><span class="hljs-variable">%CurrentBuildNumber%</span></span> <span class="hljs-keyword"><span class="hljs-keyword">lss</span></span> <span class="hljs-number"><span class="hljs-number">9700</span></span> ( :: Build &lt; <span class="hljs-number"><span class="hljs-number">9700</span></span> is <span class="hljs-number"><span class="hljs-number">8</span></span>.<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> WinVerAfx=<span class="hljs-number"><span class="hljs-number">8</span></span>.<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> [<span class="hljs-variable"><span class="hljs-variable">%time%</span></span>] Determined version of Windows: <span class="hljs-number"><span class="hljs-number">8</span></span>.<span class="hljs-number"><span class="hljs-number">1</span></span> (build <span class="hljs-variable"><span class="hljs-variable">%CurrentBuildNumber%</span></span>^) <span class="hljs-variable"><span class="hljs-variable">%PROCESSOR_ARCHITECTURE%</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> ( :: Build &gt; <span class="hljs-number"><span class="hljs-number">9700</span></span> is <span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> WinVerAfx=<span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> [<span class="hljs-variable"><span class="hljs-variable">%time%</span></span>] Determined version of Windows: <span class="hljs-number"><span class="hljs-number">10</span></span> (build <span class="hljs-variable"><span class="hljs-variable">%CurrentBuildNumber%</span></span>^) <span class="hljs-variable"><span class="hljs-variable">%PROCESSOR_ARCHITECTURE%</span></span> ) <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span>. <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> [<span class="hljs-variable"><span class="hljs-variable">%time%</span></span>] Launching Windows Setup (<span class="hljs-variable"><span class="hljs-variable">%RamdiskSourceDrive%</span></span>\<span class="hljs-variable"><span class="hljs-variable">%WinDistAfx%</span></span>_<span class="hljs-variable"><span class="hljs-variable">%WinVerAfx%</span></span>_<span class="hljs-variable"><span class="hljs-variable">%WinArchAfx%</span></span>\setup.exe^) <span class="hljs-variable"><span class="hljs-variable">%RamdiskSourceDrive%</span></span>\<span class="hljs-variable"><span class="hljs-variable">%WinDistAfx%</span></span>_<span class="hljs-variable"><span class="hljs-variable">%WinVerAfx%</span></span>_<span class="hljs-variable"><span class="hljs-variable">%WinArchAfx%</span></span>\setup.exe :: When closed Windows Setup <span class="hljs-built_in"><span class="hljs-built_in">color</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>e <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span>. <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> [<span class="hljs-variable"><span class="hljs-variable">%time%</span></span>] Windows Setup closed <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> WScript.Quit MsgBox("You have closed Windows Setup."+vbCrlf+"Run 'System <span class="hljs-built_in"><span class="hljs-built_in">restore</span></span>' instead? Or reboot?"+vbCrlf+vbCrlf+"Yes - Run 'System <span class="hljs-built_in"><span class="hljs-built_in">restore</span></span>'"+vbCrlf+"No - Reboot"+vbCrlf+"Cancel - 'Just give me a Command line!'", vbQuestion+vbYesNoCancel, "Setup cancelled") &gt; msgdlg.vbs cscript msgdlg.vbs &gt; <span class="hljs-built_in"><span class="hljs-built_in">nul</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-variable"><span class="hljs-variable">%errorLevel%</span></span> == <span class="hljs-number"><span class="hljs-number">6</span></span> ( <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> [<span class="hljs-variable"><span class="hljs-variable">%time%</span></span>] Here is Task Manager <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> you :^) <span class="hljs-built_in"><span class="hljs-built_in">start</span></span> taskmgr <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> [<span class="hljs-variable"><span class="hljs-variable">%time%</span></span>] Run 'System <span class="hljs-built_in"><span class="hljs-built_in">restore</span></span>' (<span class="hljs-variable"><span class="hljs-variable">%SystemDrive%</span></span>\Sources\recovery\RecEnv.exe^) <span class="hljs-variable"><span class="hljs-variable">%SystemDrive%</span></span>\Sources\recovery\RecEnv.exe ) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-variable"><span class="hljs-variable">%errorLevel%</span></span> == <span class="hljs-number"><span class="hljs-number">7</span></span> ( <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> [<span class="hljs-variable"><span class="hljs-variable">%time%</span></span>] Will reboot now... Wpeutil Reboot )</code> </pre> </div></div><br><div class="spoiler"> <b class="spoiler_title">   `runsetup.cmd`?</b> <div class="spoiler_text"><p>   ,   <code>winpeshl.ini</code>  <code>runsetup.cmd</code>      <em>Windows NT 6.0+</em> .  Those.        Win7, Win8  ..      . </p><br><p>      <em> </em> , .. -   <code>\sources\setup.exe</code>  <code>X:\setup.exe</code>   : <br><img src="https://habrastorage.org/files/f82/089/fe3/f82089fe340441d6bbcad378c708562e.png" alt="image"></p><br><p>    ,            Windows  <em> </em> .   ISO  <code>X:\setup.exe</code>       . </p></div></div><br><p>  <strong><em>Attention!</em></strong>    <code>runsetup.cmd</code>        <code>&lt;_&gt;:\\&lt;_____&gt;_&lt;&gt;_&lt;&gt;\setup.exe</code> <br> ( <code>%RamdiskSourceDrive%\%WinDistAfx%_%WinVerAfx%_%WinArchAfx%\setup.exe</code> ).  Those.        (   ,     ) : </p><br><ul><li> D:\WinDists\Win_7_ia32\setup.exe </li><li> D:\WinDists\Win_10_x64\setup.exe </li></ul><br><p>            ‚Äî   . </p><br><p>      : <br></p><br><pre> <code class="dos hljs">dism /unmount-wim /mountDir:C:\mnt /commit C DISM : <span class="hljs-number"><span class="hljs-number">6</span></span>.<span class="hljs-number"><span class="hljs-number">3</span></span>.<span class="hljs-number"><span class="hljs-number">9600</span></span>.<span class="hljs-number"><span class="hljs-number">17031</span></span>  : &lt;_&gt;:\WinDists\Win_10_x64\boot.wim  : <span class="hljs-number"><span class="hljs-number">2</span></span>   [==========================<span class="hljs-number"><span class="hljs-number">100</span></span>.<span class="hljs-number"><span class="hljs-number">0</span></span>%==========================]   [==========================<span class="hljs-number"><span class="hljs-number">100</span></span>.<span class="hljs-number"><span class="hljs-number">0</span></span>%==========================]   .</code> </pre> <br><p> <strong>!</strong>    <a href="https://habr.com/ru/post/395629/"> </a>   <code>boot.wim</code> .          ,                  Windows! </p><br><p></p><br><h2>   ? </h2><br><p>         . </p><br><p></p><br><h3>         Windows </h3><br><p>      <code>ei.cfg</code>     </p><br><div class="spoiler"> <b class="spoiler_title"> `ei.cfg`</b> <div class="spoiler_text"><p> [Channel] <br> Retail </p></div></div><br><p>       <code>setup.exe</code> .       ,    ramdisk- ( <code>boot.wim</code> ),    <code>ei.cfg</code>     . (+1       ,    ramdisk-   <code>/installFrom</code> ). </p><br><p></p><br><h3>       <em>  Windows</em> </h3><br><div class="spoiler"> <b class="spoiler_title">  `Grub4Dos`</b> <div class="spoiler_text"><pre> <code class="dos hljs">bcdedit /store &lt;_&gt;:\boot\bcd /create /d "Grub4Dos Menu" /application BootSector  {b3923807-<span class="hljs-number"><span class="hljs-number">3</span></span>ebb-<span class="hljs-number"><span class="hljs-number">11</span></span>e6-<span class="hljs-number"><span class="hljs-number">83</span></span>a0-d850e607fea0}  . bcdedit /store &lt;_&gt;:\boot\bcd /<span class="hljs-built_in"><span class="hljs-built_in">set</span></span> {b3923807-<span class="hljs-number"><span class="hljs-number">3</span></span>ebb-<span class="hljs-number"><span class="hljs-number">11</span></span>e6-<span class="hljs-number"><span class="hljs-number">83</span></span>a0-d850e607fea0} device boot bcdedit /store &lt;_&gt;:\boot\bcd /<span class="hljs-built_in"><span class="hljs-built_in">set</span></span> {b3923807-<span class="hljs-number"><span class="hljs-number">3</span></span>ebb-<span class="hljs-number"><span class="hljs-number">11</span></span>e6-<span class="hljs-number"><span class="hljs-number">83</span></span>a0-d850e607fea0} <span class="hljs-built_in"><span class="hljs-built_in">path</span></span> \grldr bcdedit /store &lt;_&gt;:\boot\bcd /DisplayOrder {b3923807-<span class="hljs-number"><span class="hljs-number">3</span></span>ebb-<span class="hljs-number"><span class="hljs-number">11</span></span>e6-<span class="hljs-number"><span class="hljs-number">83</span></span>a0-d850e607fea0} /AddFirst</code> </pre> <br><p>               .          : <code>BOOTMGR</code>  <code>GRLDR</code> . </p></div></div><br><p></p><br><h3>    <code>boot.wim</code>  ramdisk </h3><br><p>   <code>BootMgr</code>    <code>boot.wim</code>  ramdisk  .  Those.     Windows  , .   ,   .         WinPE   . <br></p><br><pre> <code class="dos hljs">bcdedit /store &lt;_&gt;:\boot\bcd /<span class="hljs-built_in"><span class="hljs-built_in">set</span></span> {&lt;GUID   Windows&gt;} BootMenuPolicy Legacy</code> </pre> <br><p> ,               (  ,    ),    (^ÃÆ^) </p><br><p></p><br><h3>     </h3><br><p>      .   <em>Windows 7</em> .  <em>Windows 8+</em>    - (  ). <br></p><br><pre> <code class="dos hljs">bcdedit /store &lt;_&gt;:\boot\bcd /<span class="hljs-built_in"><span class="hljs-built_in">set</span></span> {&lt;GUID   Windows&gt;} Sos True</code> </pre> <br><p>        <em>Windows 7</em> .    ‚Äî . </p><br><p></p><br><h1>  Total </h1><br><p> ,   : </p><br><ol><li>        </li><li>     <em>  Windows</em> (    ISO-) </li><li>       Windows ( <code>[sources]</code>   ISO-) </li><li>   <em>  Windows</em> </li><li>   <code>boot.wim</code>       </li></ol><br><p>  That's all. ,     ( ò‚Äø ò) </p></div><p>Source: <a href="https://habr.com/ru/post/395629/">https://habr.com/ru/post/395629/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../395617/index.html">The history of vinyl in the car</a></li>
<li><a href="../395621/index.html">Bitcoin can make offshore companies unnecessary</a></li>
<li><a href="../395623/index.html">The Virtus.Pro organization dismisses three game teams.</a></li>
<li><a href="../395625/index.html">Why bend the track?</a></li>
<li><a href="../395627/index.html">The book "Project Eye" came to crowdfunding</a></li>
<li><a href="../395635/index.html">The first batch of Blocks Wearables modular smart watches will be delivered in September 2016</a></li>
<li><a href="../395637/index.html">The self-taught Russian robot IR77 again ‚Äúran away‚Äù to freedom</a></li>
<li><a href="../395639/index.html">Streamers, Twitch and Total eSports organization (part 4)</a></li>
<li><a href="../395643/index.html">Removing the hardware key of full disk protection in Android phones on Qualcomm processors</a></li>
<li><a href="../395645/index.html">StartUps, IT and the rest of the world ...</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>