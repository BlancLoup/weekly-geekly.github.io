<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Centralized logging in MongoDB</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="From philosophy to materiel. 
 We are developing an ERP system optimized for high loads . As a result, clustering is present in the system. And each o...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Centralized logging in MongoDB</h1><div class="post__text post__text-html js-mediator-article">  From philosophy to materiel. <br>  We are developing an <a href="http://www.ultimabusinessware.com/">ERP system</a> optimized for <a href="http://www.ultimabusinessware.com/performance/">high loads</a> .  As a result, clustering is present in the system.  And each of the cluster nodes maintains its own log.  The log contains error messages, various progress messages from application developers, and so on. <br>  How we implemented journaling - under the cut. <br><a name="habracut"></a><br>  To begin with, according to the precepts of the ancestors they walked around the rake. <br>  We had <br>  - Multiple clusters <br>  - In each of which several nodes <br>  - Crowd of developers <br>  - Hundreds of client desktop applications. <br>  - 20-30mb application and system code with trace and data dump. <br>  All applications through NLog wrote to the files. <br>  Logging to a file had only one advantage ‚Äî it was very easy to administer, and that dubious one ‚Äî log files also need to be rotated. <br>  In all other respects it is a failure: <br><ul><li>  Structured data <br>  Often, to debug an application, you need to save an object.  In addition to him, keep clarifying messages and other information.  For example: <br><pre><code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> parameters = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Dictionary&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>&gt;(); parameters[<span class="hljs-string"><span class="hljs-string">"id"</span></span>] = id; parameters[<span class="hljs-string"><span class="hljs-string">"limit"</span></span>] = maxValues; ... Logger.Verbose(<span class="hljs-string"><span class="hljs-string">"Executing command: {SQL} with parameters: {@Parameters}"</span></span>, sqlCommand, parameters);  NLog       ,      .</code> </pre> <br></li><li>  Availability of information <br>  Logging in files forces log files on all servers to look for bits of information.  Multiplied by the number of developers, this leads to the fact that everyone has access to all servers and becomes a permanent headache for administrators. <br></li></ul><br>  So, we needed a journaling solution that would make it easy to search for messages from various sources, easy to understand the message, save objects in an easily readable structured format, and lastly, the solution should be easy to install, maintain, be convenient. <br><br>  After going through several options (Elasticsearch and other similar mechanisms), they stopped at a bunch of <a href="http://serilog.net/">SeriLog</a> and <a href="http://www.mongodb.org/">MongoDB</a> . <br>  SeriLog perfectly solved the problem of structured event storage.  MongoDB is an easy-to-admin base, with enough popularity, a user-friendly interface and support for C #, is actively developing. <br>  In MongoDB, the quality of documenting the driver for C # was somewhat upsetting, so I had to tinker in search of support for ad-hoc requests.  However, it is not critical. <br><br>  As a result, we received such an interface for viewing events, which is available to any developer: <br><img src="https://habrastorage.org/files/9be/acb/4bc/9beacb4bc8da4e399a319a22a7e367b5.png"><br>  For simple cases, you can use the filter on the first tab.  And on the second - a full query window, where you can write arbitrary queries. <br>  A nice feature is that SeriLog saves the message template, which allows (having the program code before your eyes) to find all the relevant messages. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Well, SourceContext allows you to filter by message source - from a server, client, or SQL queries. <br>  The latter is the most convenient means of tracking which SQL queries are executed to the database in order to optimize them. <br><br>  A small digression. <br>  In general, there are 2 tools for tracing SQL queries in our platform. <br><ul><li>  Tracing Sessions Online <br>  Messages will be received online in the corresponding window.  You can connect to any session in the cluster. <br>  Looks like that: <br><img src="https://habrastorage.org/files/799/991/7c8/7999917c880449c3a91c95ab61f3fd3b.png"><br>  on the second tab, all parameters are listed in the table: <br><img src="https://habrastorage.org/files/0c6/56a/8c4/0c656a8c4f6c486e86b9387bc81fad64.png"><br></li><li>  Centralized log with all SQL queries along with parameters <br>  All messages are available in the centralized log viewer in SourceContext SqlStatement <br></li></ul><br><br>  Let's go back to the above example: <br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> parameters = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Dictionary&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>&gt;(); parameters[<span class="hljs-string"><span class="hljs-string">"id"</span></span>] = id; parameters[<span class="hljs-string"><span class="hljs-string">"limit"</span></span>] = maxValues; ... Logger.Verbose(<span class="hljs-string"><span class="hljs-string">"Executing command: {SQL} with parameters: {@Parameters}"</span></span>, sqlCommand, parameters);</code> </pre><br>  In this case, the entire list of parameters will be attached to the journal event, <br>  and in the log you can find a record about the execution of the command with a specific value <br>  the desired parameter. <br>  The example is somewhat contrived, since all SQL queries are already logged. <br>  Here is a more real one: <br><pre> <code class="hljs pgsql">Logger.<span class="hljs-keyword"><span class="hljs-keyword">Debug</span></span>("Brand #{BrandID} contents: {@Brand}", brand.ID, brand);</code> </pre><br>  And the type of entries in the log: <br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">Brand</span></span> <span class="hljs-selector-id"><span class="hljs-selector-id">#12</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">contents</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">Brand</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">ID</span></span>: <span class="hljs-number"><span class="hljs-number">12</span></span>, Name: <span class="hljs-string"><span class="hljs-string">"Pineapple"</span></span> }</code> </pre><br>  When logging the state of a document or other difficult object, it is better not to save its contents in the message: <br><pre> <code class="hljs perl">Logger.Debug(<span class="hljs-string"><span class="hljs-string">"Document #{DocumentID} is saved. Document contents: {@Document}"</span></span>, doc.ID, doc); ....</code> </pre><br>  The message will look like this: <br><pre> <code class="hljs vbscript">Document #<span class="hljs-number"><span class="hljs-number">101187</span></span> <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> saved. Document contents: SaleDocument { ActualInvoiceDocumentID: <span class="hljs-literal"><span class="hljs-literal">null</span></span>, AgentID: <span class="hljs-number"><span class="hljs-number">636</span></span>, AllowPartialRelease: <span class="hljs-literal"><span class="hljs-literal">False</span></span>, Amount: <span class="hljs-number"><span class="hljs-number">5500</span></span>, AmountDistributionTypeID: <span class="hljs-literal"><span class="hljs-literal">null</span></span>, ArticlesQuantity: <span class="hljs-number"><span class="hljs-number">3</span></span>, ClientDueOnDelivery: <span class="hljs-number"><span class="hljs-number">5500</span></span>, Comments: <span class="hljs-string"><span class="hljs-string">"noreply"</span></span>, Convertation: <span class="hljs-literal"><span class="hljs-literal">null</span></span>, CreationDate: <span class="hljs-number"><span class="hljs-number">02</span></span>/<span class="hljs-number"><span class="hljs-number">06</span></span>/<span class="hljs-number"><span class="hljs-number">2015</span></span> <span class="hljs-number"><span class="hljs-number">22</span></span>:<span class="hljs-number"><span class="hljs-number">21</span></span>:<span class="hljs-number"><span class="hljs-number">53</span></span>, CreatorID: <span class="hljs-number"><span class="hljs-number">7</span></span>, CustomerSupplyContractID: <span class="hljs-literal"><span class="hljs-literal">null</span></span>, DeadDate: <span class="hljs-number"><span class="hljs-number">02</span></span>/<span class="hljs-number"><span class="hljs-number">11</span></span>/<span class="hljs-number"><span class="hljs-number">2015</span></span> <span class="hljs-number"><span class="hljs-number">22</span></span>:<span class="hljs-number"><span class="hljs-number">21</span></span>:<span class="hljs-number"><span class="hljs-number">53</span></span>, Deleted: <span class="hljs-literal"><span class="hljs-literal">False</span></span>, DeliveryActive: <span class="hljs-literal"><span class="hljs-literal">False</span></span>, Description: <span class="hljs-string"><span class="hljs-string">"Sales (Picking) #101187, 2/6/2015"</span></span> ... <span class="hljs-number"><span class="hljs-number">50</span></span>kb of JSON follows</code> </pre><br>  It would be more correct to display only the document number in the message, and pass the contents in the parameters.  All parameters can be viewed in JSON: <br><img src="https://habrastorage.org/files/a78/dde/2e1/a78dde2e193e44bc9163577137d4f3f1.png"><br>  or in a structured form in a property grid: <br><img src="https://habrastorage.org/files/f2a/4b4/2cd/f2a4b42cdf2c4e21ae6c6c22cd4197f1.png"><br><br>  When exceptions are logged, their internal structure will be preserved, including <br>  including the HResult, CallStack properties and the whole InnerException chain (unfortunately, this <br>  the functionality is not built into Serilog, and it had to be implemented independently). <br>  To log an exception, it is enough to pass it as the first parameter to the methods. <br>  journaling: <br><pre> <code class="hljs sql">Logger.Error(ex, "Cannot <span class="hljs-keyword"><span class="hljs-keyword">execute</span></span> <span class="hljs-keyword"><span class="hljs-keyword">user</span></span> task: {Message}<span class="hljs-string"><span class="hljs-string">", ex.Message);</span></span></code> </pre><br>  The log analysis tool allows you to view the message structure in the PropertyGrid: <br><img src="https://habrastorage.org/files/697/bac/642/697bac64298e48c88fe283e04408cb69.png"><br>  All unhandled exceptions will be logged automatically.  By the way, all such incidents should be considered, and, if there really is a mistake, corrected.  A good way to improve the quality of the application. <br><br><h4>  Finally. </h4><br>  The described functionality is the best that we could choose for our tasks.  Flexibility, ease of administration, ease of use, saving events with objects in a structured way. <br>  I hope this article will help other developers of desktop applications to choose their own version of the implementation of journaling. </div><p>Source: <a href="https://habr.com/ru/post/253367/">https://habr.com/ru/post/253367/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../253353/index.html">CompTIA certifications for IT professionals. Part 4 of 7. CompTIA Security +</a></li>
<li><a href="../253357/index.html">We program robots - free robosimulator V-REP. The first steps</a></li>
<li><a href="../253359/index.html">Handbook of console methods in JS</a></li>
<li><a href="../253361/index.html">Intel¬Æ RealSense ‚Ñ¢. Work with raw data streams</a></li>
<li><a href="../253365/index.html">Working with MS SQL Database with Go Tools for Beginners</a></li>
<li><a href="../253371/index.html">Price drop came: servers in the Netherlands at the premium data center are several times cheaper, 2 x Intel Quad Core E5504 / 16GB DDR3 / 12x1TB SATA / 1Gbps 100TB for $ 99.99 just now</a></li>
<li><a href="../253373/index.html">Building an Ethernet network for IP video surveillance</a></li>
<li><a href="../253379/index.html">Simple ticket system for customer support: open beta and launch history</a></li>
<li><a href="../253381/index.html">Not everyone can write their name in Unicode.</a></li>
<li><a href="../253383/index.html">Invisible interface</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>