<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Expressive JavaScript: Project: Experience Sharing Website</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Content 


- Introduction 
- Values, Types and Operators 
- Program structure 
- Functions 
- Data Structures: Objects and Arrays 
- Higher order func...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Expressive JavaScript: Project: Experience Sharing Website</h1><div class="post__text post__text-html js-mediator-article"><h4>  Content </h4><br><ul><li>  <a href="http://habrahabr.ru/post/240219/">Introduction</a> </li><li>  <a href="http://habrahabr.ru/post/240223/">Values, Types and Operators</a> </li><li>  <a href="http://habrahabr.ru/post/240225/">Program structure</a> </li><li>  <a href="http://habrahabr.ru/post/240349/">Functions</a> </li><li>  <a href="http://habrahabr.ru/post/240813/">Data Structures: Objects and Arrays</a> </li><li>  <a href="http://habrahabr.ru/post/241155/">Higher order functions</a> </li><li>  <a href="http://habrahabr.ru/post/241587/">The secret life of objects</a> </li><li>  <a href="http://habrahabr.ru/post/241776/">Project: e-life</a> </li><li>  <a href="http://habrahabr.ru/post/242609/">Search and error handling</a> </li><li>  <a href="http://habrahabr.ru/post/242695/">Regular expressions</a> </li><li>  <a href="http://habrahabr.ru/post/243273/">Modules</a> </li><li>  <a href="http://habrahabr.ru/post/243277/">Project: programming language</a> </li><li>  <a href="http://habrahabr.ru/post/243311/">Javascript and browser</a> </li><li>  <a href="http://habrahabr.ru/post/243815/">Document Object Model</a> </li><li>  <a href="http://habrahabr.ru/post/244041/">Event handling</a> </li><li>  <a href="http://habrahabr.ru/post/244405/">Project: Platform Game</a> </li><li>  <a href="http://habrahabr.ru/post/244545/">Drawing on canvas</a> </li><li>  <a href="http://habrahabr.ru/post/245145/">HTTP</a> </li><li>  <a href="http://habrahabr.ru/post/245731/">Forms and form fields</a> </li><li>  <a href="http://habrahabr.ru/post/245767/">Project: Paint</a> </li><li>  <a href="http://habrahabr.ru/post/245775/">Node.js</a> </li><li>  <a href="http://habrahabr.ru/post/246331/">Project: website sharing experience</a> </li><li>  <a href="http://eloquentjavascript.net/code">Sandbox for code</a> </li></ul><br><br>  At experience sharing meetings, people with common interests meet and make small informal presentations on their knowledge.  At a meeting on the exchange of experience among farmers, anyone can tell about the cultivation of celery.  At a meeting of programmers you can make a story about Node.js <br><br>  Such meetings are a great way to expand your horizons, find out about new products in the region, or just chat with people with similar interests.  In many cities there are meetings of fans of JavaScript.  Usually their visit is free, and I found those I visited, friendly and hospitable. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/files/597/169/8a7/5971698a71ae43bdb44fc2fa84b9eb33.png"><br><br>  In the final chapter of the project, we will arrange a website for servicing the speeches that are made at such meetings.  Imagine a group of people who meet regularly in the office of one of the participants to talk about monocycles.  The problem is that when the previous meeting organizer moved to another city, no one took his place.  We need a system that allows participants to propose and discuss topics with each other, without the participation of the organizer. <br><a name="habracut"></a><br><h4>  Monocyclist meetings </h4><br>  As in the previous chapter, the code is written for Node.js and will not work in the browser.  The full code is available <a href="">here</a> . <br><br><h4>  Design </h4><br>  The project has a server part written for Node.js, and a client part written for the browser.  The server stores system data and transfers it to the client.  It also provides HTML and JavaScript files that create the system on the client side. <br><br>  The server has a list of topics for the next meeting, and the client shows them.  Each topic has a speaker name, a title, a description, and a list of comments.  The client allows you to suggest new topics (add them to the list), delete topics and comment on existing ones.  When a user makes this change, the client makes an HTTP request to inform the server of this. <br><br><img src="https://habrastorage.org/files/655/24e/c83/65524ec835e0400697af0e61e64a768f.png"><br><br>  An application will be created to display the current topic suggestions and comments on them.  When someone adds a new topic somewhere or leaves a comment, all people who open the page in the browser, changes should occur instantly.  This is not an easy task, because the web server cannot open a connection to the client, and because there is no suitable way to find out which client is currently browsing this website. <br><br>  A common solution to the problem is long queries (long polling), which served as one of the motivations for the development of Node. <br><br><h4>  Long queries </h4><br>  To instantly notify the client about the changes, we need a connection to the client.  Browsers traditionally do not accept connection requests, and clients are still hidden behind devices that these connections would not accept, so there is no point in starting a connection from the server. <br><br>  You can make the client open the connection and hold it so that the server can send information through it as needed. <br><br>  But the HTTP request allows only simple information exchange - the client sends the request, the server returns a response, that's all.  There is a technology called web sockets, which is supported by modern browsers, which allows you to open connections to exchange arbitrary data.  But they are quite difficult to use. <br><br>  In this chapter, we turn to relatively simple technology, long requests, when customers constantly request the server for new information via regular HTTP requests, and the server is just slow in responding when it has nothing to say. <br><br>  As long as the client constantly keeps an open request, it will receive information from the server immediately.  For example, if Alice has an application for sharing experience open in the browser, the browser will make a request for updates and will wait for a response.  When Bob sends the ‚ÄúExtreme descent on a monocycle from the mountain‚Äù theme from his browser, the server will notice that Alice is waiting for updates and will send information on a new topic in response to her pending request.  Alice's browser will receive the data and refresh the page by displaying a new topic. <br><br>  To prevent connections from terminating by timeout (inactive connections are terminated after the time expires), the technology of long queries usually sets the maximum time for each request after which the server will respond in any case, even if it has nothing to inform, and then the client will launch a new request.  Periodic updating of the request makes the technique more reliable, allowing clients to recover from temporary breaks or server problems. <br><br>  A busy server that uses long requests can have thousands of requests open, and therefore TCP connections.  Node is well suited for such a system, because it allows you to easily manage many connections without creating separate streams. <br><br><h4>  HTTP interface </h4><br>  Before we start making the server or client, let's think about their point of contact: the HTTP interface through which they interact. <br><br>  The interface will be based on JSON, and, as in the file server in Chapter 20, we will profitably use HTTP methods.  The interface is centered around the way / talks.  Paths that do not begin with / talks will be used to upload static files - HTML and JavaScript, defining the client part. <br><br>  A GET request to / talks returns a JSON document like this: <br><br><pre><code class="javascript hljs">{<span class="hljs-string"><span class="hljs-string">"serverTime"</span></span>: <span class="hljs-number"><span class="hljs-number">1405438911833</span></span>, <span class="hljs-string"><span class="hljs-string">"talks"</span></span>: [{<span class="hljs-string"><span class="hljs-string">"title"</span></span>: <span class="hljs-string"><span class="hljs-string">"Unituning "</span></span>, <span class="hljs-string"><span class="hljs-string">"presenter"</span></span>: <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-string"><span class="hljs-string">"summary"</span></span>: <span class="hljs-string"><span class="hljs-string">"  "</span></span>, <span class="hljs-string"><span class="hljs-string">"comment"</span></span>: []}]}</code> </pre> <br><br>  The serverTime field is used to make long requests reliable.  Let's return to it later. <br><br>  Creating a new topic occurs through a PUT request to the URL of the form / talks / Unituning, where the part after the second slash is the name of the topic.  The body of the PUT request must contain a JSON object, which describes the properties of the presenter and summary. <br><br>  Since the subject headings may contain spaces and other characters that cannot be inserted into the URL, they must be encoded using the encodeURIComponent function when creating the URL. <br><br><pre> <code class="javascript hljs"><span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">"/talks/"</span></span> + <span class="hljs-built_in"><span class="hljs-built_in">encodeURIComponent</span></span>(<span class="hljs-string"><span class="hljs-string">"How to Idle"</span></span>)); <span class="hljs-comment"><span class="hljs-comment">// ‚Üí /talks/How%20to%20Idle</span></span></code> </pre><br><br>  A request to create a topic might look like <br><br>  PUT / talks / How% 20to% 20Idle HTTP / 1.1 <br>  Content-Type: application / json <br>  Content-Length: 92 <br><br>  {"Presenter": "Dasha", <br>  "Summary": "Standing still on the monocycle"} <br><br>  These URLs support GET requests to get a JSON representation of a topic and a DELETE to delete a topic. <br><br>  Adding a comment occurs through a POST request to the URL of the form / talks / Unituning / comments, with a JSON object containing the author and message properties in the request body. <br><br>  POST / talks / Unituning / comments HTTP / 1.1 <br>  Content-Type: application / json <br>  Content-Length: 72 <br><br>  {"Author": "Alice", <br>  "Message": "Will you talk about raising a cycle?"} <br><br>  To support long requests, GET requests to / talks can include a parameter called changesSince, indicating that the client needs updates that have occurred after a given point in time.  When updates appear, they are immediately returned.  When there are none, the request is delayed until something happens, or until a specified period of time passes (we set 90 seconds). <br><br>  Time is used in the format of the number of milliseconds since the beginning of 1970, in the same format that Date.now () returns.  To make sure that the client receives all updates, and does not receive the same update twice, the client must transmit the time at which he last received information from the server.  The server clock may not coincide with the client, and even if they coincided, the client would not know the exact time at which the server sent the response, because data transmission over the network takes time. <br><br>  Therefore, in responses to GET requests to / talks, there is a serverTime property.  It tells the client the exact time on the server‚Äôs clock when the transmitted data was created.  The client simply saves the time and sends it along with the following request to make sure that he receives only those updates that he has not yet received. <br><br>  GET / talks? ChangesSince = 1405438911833 HTTP / 1.1 <br><br>  (time passed) <br><br>  HTTP / 1.1 200 OK <br>  Content-Type: application / json <br>  Content-Length: 95 <br><br>  {"ServerTime": 1405438913401, <br>  "Talks": [{"title": "Unituning", <br>  "Deleted": true}]} <br><br>  When a topic changes, is created or commented, in response to the next request, full information about the topic is included.  When a topic is deleted, only the name and property of the deleted are included.  The client can add topics with headers that he has not yet seen to the page, update topics that he already shows, and delete topics that have been deleted. <br><br>  The protocol described in this chapter does not control access.  Everyone can comment, change and delete topics.  Since the Internet is full of hooligans, placing such a system online without protection is likely to end badly. <br><br>  A simple solution would be to place the system behind a reverse proxy ‚Äî this is an HTTP server that accepts connections from outside the system and redirects them to HTTP servers that are running locally.  Such a proxy can be configured to ask the user name and password, and you could arrange that only members of your group have the password. <br><br><h4>  Server </h4><br>  Let's start by writing the server part of the program.  The code works on Node.js <br><br><h4>  Routing </h4><br>  To start the server will be used http.createServer.  In the function that processes the new request, we must distinguish between the requests (determined by the method and the way) that we support.  This can be done through a long if / else chain, but it can also be more beautiful. <br><br>  A router is a component that helps distribute a request to a function that can process it.  You can tell the router that PUT requests with a path that matches the regular schedule / ^ \ / talks \ / ([^ \ /] +) $ / (which is the same as / talks /, followed by the name of the topic) can be processed by a given function .  In addition, it can help extract meaningful parts of the path, in our case - the name of the topic, enclosed in quotes, and pass them to the auxiliary function. <br><br>  There are many good routing modules in NPM, but here we will write this ourselves to demonstrate how it works. <br><br>  Here is the file router.js, which will be requested through require from the server module: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> Router = <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.routes = []; }; Router.prototype.add = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">method, url, handler</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.routes.push({<span class="hljs-attr"><span class="hljs-attr">method</span></span>: method, <span class="hljs-attr"><span class="hljs-attr">url</span></span>: url, <span class="hljs-attr"><span class="hljs-attr">handler</span></span>: handler}); }; Router.prototype.resolve = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">request, response</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> path = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">"url"</span></span>).parse(request.url).pathname; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.routes.some(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">route</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> match = route.url.exec(path); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!match || route.method != request.method) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> urlParts = match.slice(<span class="hljs-number"><span class="hljs-number">1</span></span>).map(<span class="hljs-built_in"><span class="hljs-built_in">decodeURIComponent</span></span>); route.handler.apply(<span class="hljs-literal"><span class="hljs-literal">null</span></span>, [request, response] .concat(urlParts)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; }); };</code> </pre><br><br>  The module exports the Router constructor.  The router object allows you to register new handlers with the add method, and distribute requests with the resolve method. <br><br>  The latter returns a boolean value indicating whether a handler was found.  The some method of the array of paths will try them in turn (in the order in which they were specified), and stop with returning true if the path is found. <br><br>  Handler functions are called with request and response objects.  When the regular URL checker returns groups, the strings representing them are passed to the handler as additional arguments.  These lines need to be decoded from the URL-style% 20. <br><br><h4>  File delivery </h4><br>  When the type of request does not match any of the types that the router processes, the server should interpret it as a file request from a common directory.  It would be possible to use the file server from Chapter 20 for issuing these files, but we do not need PUT and DELETE support, but we need additional functions such as caching support.  Therefore, let's use a proven and tested NPM file server. <br><br>  I chose ecstatic.  This is not the only NPM server, but it works well and meets our requirements.  The ecstatic module exports a function that can be called with a configuration object so that it issues a handler function.  We use the root option to tell the server where to look for files.  The handler takes the request and response parameters, and you can pass it directly to createServer to create a server that gives only files.  But first we need to check the requests that we process especially - so we wrap it in another function. <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> http = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">"http"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> Router = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">"./router"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ecstatic = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">"ecstatic"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> fileServer = ecstatic({<span class="hljs-attr"><span class="hljs-attr">root</span></span>: <span class="hljs-string"><span class="hljs-string">"./public"</span></span>}); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> router = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Router(); http.createServer(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">request, response</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!router.resolve(request, response)) fileServer(request, response); }).listen(<span class="hljs-number"><span class="hljs-number">8000</span></span>);  respond  respondJSON    ,        . function respond(response, status, data, type) { response.writeHead(status, { <span class="hljs-string"><span class="hljs-string">"Content-Type"</span></span>: type || <span class="hljs-string"><span class="hljs-string">"text/plain"</span></span> }); response.end(data); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">respondJSON</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">response, status, data</span></span></span><span class="hljs-function">) </span></span>{ respond(response, status, <span class="hljs-built_in"><span class="hljs-built_in">JSON</span></span>.stringify(data), <span class="hljs-string"><span class="hljs-string">"application/json"</span></span>); }</code> </pre><br><br><h4>  Topics as resources </h4><br>  The server stores the proposed topics in the talks object, in which the names of the properties are the names of the topics.  They will look like HTTP resources at / talks / [title], so we need to add to the router handlers that implement various methods that clients can use to work with them. <br><br>  The handler for GET requests for one topic should find it and either return the data to JSON or generate a 404 error. <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> talks = <span class="hljs-built_in"><span class="hljs-built_in">Object</span></span>.create(<span class="hljs-literal"><span class="hljs-literal">null</span></span>); router.add(<span class="hljs-string"><span class="hljs-string">"GET"</span></span>, /^\/talks\/([^\/]+)$/, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">request, response, title</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (title <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> talks) respondJSON(response, <span class="hljs-number"><span class="hljs-number">200</span></span>, talks[title]); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> respond(response, <span class="hljs-number"><span class="hljs-number">404</span></span>, <span class="hljs-string"><span class="hljs-string">"No talk '"</span></span> + title + <span class="hljs-string"><span class="hljs-string">"' found"</span></span>); });       talks. router.add(<span class="hljs-string"><span class="hljs-string">"DELETE"</span></span>, /^\/talks\/([^\/]+)$/, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">request, response, title</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (title <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> talks) { <span class="hljs-keyword"><span class="hljs-keyword">delete</span></span> talks[title]; registerChange(title); } respond(response, <span class="hljs-number"><span class="hljs-number">204</span></span>, <span class="hljs-literal"><span class="hljs-literal">null</span></span>); });</code> </pre><br><br>  The registerChange function, which we will define later, notifies long requests for changes. <br><br>  To make it easy to receive the content of request bodies encoded with JSON, we define the readStreamAsJSON function, which reads the entire contents of the stream, parses it according to JSON rules, and then makes a callback. <br><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">readStreamAsJSON</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">stream, callback</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> data = <span class="hljs-string"><span class="hljs-string">""</span></span>; stream.on(<span class="hljs-string"><span class="hljs-string">"data"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">chunk</span></span></span><span class="hljs-function">) </span></span>{ data += chunk; }); stream.on(<span class="hljs-string"><span class="hljs-string">"end"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> result, error; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { result = <span class="hljs-built_in"><span class="hljs-built_in">JSON</span></span>.parse(data); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (e) { error = e; } callback(error, result); }); stream.on(<span class="hljs-string"><span class="hljs-string">"error"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">error</span></span></span><span class="hljs-function">) </span></span>{ callback(error); }); }</code> </pre><br><br>  One of the handlers that needs to read responses in JSON is the PUT handler, which is used to create new topics.  It must check if the data has the properties presenter and summary, which should be strings.  Data coming from outside can always turn out to be garbage, and we don‚Äôt want our system to be broken due to a bad query. <br><br>  If the data looks acceptable, the handler stores the object representing the new topic in the talks object, while possibly overwriting the existing topic with the same title, and then calls registerChange again. <br><br><pre> <code class="javascript hljs">router.add(<span class="hljs-string"><span class="hljs-string">"PUT"</span></span>, /^\/talks\/([^\/]+)$/, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">request, response, title</span></span></span><span class="hljs-function">) </span></span>{ readStreamAsJSON(request, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">error, talk</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (error) { respond(response, <span class="hljs-number"><span class="hljs-number">400</span></span>, error.toString()); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!talk || <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span> talk.presenter != <span class="hljs-string"><span class="hljs-string">"string"</span></span> || <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span> talk.summary != <span class="hljs-string"><span class="hljs-string">"string"</span></span>) { respond(response, <span class="hljs-number"><span class="hljs-number">400</span></span>, <span class="hljs-string"><span class="hljs-string">"Bad talk data"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { talks[title] = {<span class="hljs-attr"><span class="hljs-attr">title</span></span>: title, <span class="hljs-attr"><span class="hljs-attr">presenter</span></span>: talk.presenter, <span class="hljs-attr"><span class="hljs-attr">summary</span></span>: talk.summary, <span class="hljs-attr"><span class="hljs-attr">comments</span></span>: []}; registerChange(title); respond(response, <span class="hljs-number"><span class="hljs-number">204</span></span>, <span class="hljs-literal"><span class="hljs-literal">null</span></span>); } }); });</code> </pre><br><br>  Adding a comment to a topic works in a similar way.  We use readStreamAsJSON to get the content of the message, check the resulting data and save it as a comment if it is acceptable. <br><br><pre> <code class="javascript hljs">router.add(<span class="hljs-string"><span class="hljs-string">"POST"</span></span>, /^\/talks\/([^\/]+)\/comments$/, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">request, response, title</span></span></span><span class="hljs-function">) </span></span>{ readStreamAsJSON(request, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">error, comment</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (error) { respond(response, <span class="hljs-number"><span class="hljs-number">400</span></span>, error.toString()); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!comment || <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span> comment.author != <span class="hljs-string"><span class="hljs-string">"string"</span></span> || <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span> comment.message != <span class="hljs-string"><span class="hljs-string">"string"</span></span>) { respond(response, <span class="hljs-number"><span class="hljs-number">400</span></span>, <span class="hljs-string"><span class="hljs-string">"Bad comment data"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (title <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> talks) { talks[title].comments.push(comment); registerChange(title); respond(response, <span class="hljs-number"><span class="hljs-number">204</span></span>, <span class="hljs-literal"><span class="hljs-literal">null</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { respond(response, <span class="hljs-number"><span class="hljs-number">404</span></span>, <span class="hljs-string"><span class="hljs-string">"No talk '"</span></span> + title + <span class="hljs-string"><span class="hljs-string">"' found"</span></span>); } }); });</code> </pre><br><br>  Attempting to add a comment to a non-existent topic should return a 404 error. <br><br><h4>  Long query support </h4><br>  The most interesting aspect of the server is the part that supports long queries.  When a GET request is sent to the address / talks, it can be a simple request for all topics, or an update request with the changeSince parameter. <br><br>  There are many different situations in which we need to send a list of topics to the client, so we first define a helper function that attaches the serverTime field to such answers. <br><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sendTalks</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">talks, response</span></span></span><span class="hljs-function">) </span></span>{ respondJSON(response, <span class="hljs-number"><span class="hljs-number">200</span></span>, { <span class="hljs-attr"><span class="hljs-attr">serverTime</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">Date</span></span>.now(), <span class="hljs-attr"><span class="hljs-attr">talks</span></span>: talks }); }</code> </pre><br><br>  The handler should look at all the request parameters in its URL in order to check if the changesSince parameter is set.  If you give the parse function of the ‚Äúurl‚Äù module the second argument of the value true, it also parses the second part of the URL - query, part of the query.  The returned object will have a query property, in which there will be another object with the names and values ‚Äã‚Äãof the parameters. <br><br><pre> <code class="javascript hljs">router.add(<span class="hljs-string"><span class="hljs-string">"GET"</span></span>, /^\/talks$/, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">request, response</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> query = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">"url"</span></span>).parse(request.url, <span class="hljs-literal"><span class="hljs-literal">true</span></span>).query; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (query.changesSince == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> list = []; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> title <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> talks) list.push(talks[title]); sendTalks(list, response); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> since = <span class="hljs-built_in"><span class="hljs-built_in">Number</span></span>(query.changesSince); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">isNaN</span></span>(since)) { respond(response, <span class="hljs-number"><span class="hljs-number">400</span></span>, <span class="hljs-string"><span class="hljs-string">"Invalid parameter"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> changed = getChangedTalks(since); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (changed.length &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) sendTalks(changed, response); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> waitForChanges(since, response); } } });</code> </pre><br><br>  If there is no changesSince parameter, the handler simply builds a list of all the themes and returns it. <br><br>  Otherwise, you first need to check the changeSince parameter to see if it is a number.  The getChangedTalks function, which we will soon define, returns an array of modified topics from a certain specified time.  If it returns an empty array, then the server has nothing to return to the client, so it saves the response object (with waitForChanges) to respond later. <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> waiting = []; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">waitForChanges</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">since, response</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> waiter = {<span class="hljs-attr"><span class="hljs-attr">since</span></span>: since, <span class="hljs-attr"><span class="hljs-attr">response</span></span>: response}; waiting.push(waiter); setTimeout(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> found = waiting.indexOf(waiter); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (found &gt; <span class="hljs-number"><span class="hljs-number">-1</span></span>) { waiting.splice(found, <span class="hljs-number"><span class="hljs-number">1</span></span>); sendTalks([], response); } }, <span class="hljs-number"><span class="hljs-number">90</span></span> * <span class="hljs-number"><span class="hljs-number">1000</span></span>); }</code> </pre><br><br>  The splice method is used to cut a piece of an array.  It is given an index and the number of elements, and it changes the array, removing this number of elements after a given index.  In this case, we delete one element - the object waiting for an answer, whose index we learned through indexOf.  If you pass additional arguments in splice, their values ‚Äã‚Äãwill be inserted into the array at the specified position, and will replace the removed elements. <br><br>  When the response object is stored in the waiting array, a timeout is set.  After 90 seconds, it checks to see if another request is waiting, and if so, it sends an empty response and removes it from the waiting array. <br><br>  To find exactly those topics that have changed after a given time, we need to track the history of changes.  Registering a change with registerChange will remember this change, along with the current time, in the changes array.  When a change happens, it means that there is new data, so you can immediately respond to all pending requests. <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> changes = []; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">registerChange</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">title</span></span></span><span class="hljs-function">) </span></span>{ changes.push({<span class="hljs-attr"><span class="hljs-attr">title</span></span>: title, <span class="hljs-attr"><span class="hljs-attr">time</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">Date</span></span>.now()}); waiting.forEach(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">waiter</span></span></span><span class="hljs-function">) </span></span>{ sendTalks(getChangedTalks(waiter.since), waiter.response); }); waiting = []; }</code> </pre><br><br>  Finally, getChangedTalks uses the changes array to build an array of changed topics, including objects with the deleted property for those that no longer exist.  When building an array, getChangedTalks must make sure that the same topic is not included twice, since the topic could have changed several times from a given point in time. <br><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getChangedTalks</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">since</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> found = []; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">alreadySeen</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">title</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> found.some(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">f</span></span></span><span class="hljs-function">) </span></span>{<span class="hljs-keyword"><span class="hljs-keyword">return</span></span> f.title == title;}); } <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i = changes.length - <span class="hljs-number"><span class="hljs-number">1</span></span>; i &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span>; i--) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> change = changes[i]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (change.time &lt;= since) <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (alreadySeen(change.title)) <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (change.title <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> talks) found.push(talks[change.title]); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> found.push({<span class="hljs-attr"><span class="hljs-attr">title</span></span>: change.title, <span class="hljs-attr"><span class="hljs-attr">deleted</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>}); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> found; }</code> </pre><br><br>  That's it with the server code.  Running the written code will give you a server running on port 8000, which issues files from a public subdirectory and manages the interface on the / talks address. <br><br><h4>  Customer </h4><br>  The client side of the theme management website consists of three files: an HTML page, a style sheet, and a JavaScript file. <br><br><h4>  HTML </h4><br>  Servers according to the standard scheme in the case of a request for the path corresponding to the directory, give the file under the name index.html from this directory.  The ecstatic file server module supports this convention.  When a path is requested, the server looks for the ./public/index.html file (where ./public is the root directory) and returns it if it is there. <br><br>  So, if you need to show the page, when the browser requests our server, it should be put in public / index.html.  Here is the beginning of the index file: <br><br><pre> <code class="html hljs xml"><span class="hljs-meta"><span class="hljs-meta">&lt;!doctype html&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">title</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">title</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">link</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">rel</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"stylesheet"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"skillsharing.css"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h1</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h1</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span> : <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"name"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"talks"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><br>  The title is determined and a style sheet is included, where styles are defined ‚Äî among other things, a frame around topics.  Then the title and the name field are added.  The user must enter his name so that it is attached to his topics and comments. <br><br>  Element <pre> <code class="hljs lua"><code class="html">  ID ‚Äútalks‚Äù    .   ,      . <br> <br>       . <br> <br> &lt;form id=<span class="hljs-string"><span class="hljs-string">"newtalk"</span></span>&gt; &lt;h3&gt;Submit a talk&lt;/h3&gt; : &lt;<span class="hljs-built_in"><span class="hljs-built_in">input</span></span> <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=<span class="hljs-string"><span class="hljs-string">"text"</span></span> style=<span class="hljs-string"><span class="hljs-string">"width: 40em"</span></span> name=<span class="hljs-string"><span class="hljs-string">"title"</span></span>&gt; &lt;br&gt; Summary: &lt;<span class="hljs-built_in"><span class="hljs-built_in">input</span></span> <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=<span class="hljs-string"><span class="hljs-string">"text"</span></span> style=<span class="hljs-string"><span class="hljs-string">"width: 40em"</span></span> name=<span class="hljs-string"><span class="hljs-string">"summary"</span></span>&gt; &lt;button <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=<span class="hljs-string"><span class="hljs-string">"submit"</span></span>&gt; &lt;/button&gt; &lt;/form&gt;</code> <br> <br>     ‚Äúsubmit‚Äù  ,      HTTP-,    . <br> <br>    ,    display   none,       . ,   ? <br> <br> <code class="html">&lt;div id=<span class="hljs-string"><span class="hljs-string">"template"</span></span> style=<span class="hljs-string"><span class="hljs-string">"display: none"</span></span>&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"talk"</span></span>&gt; &lt;h2&gt;{{title}}&lt;/h2&gt; &lt;div&gt;by &lt;span class=<span class="hljs-string"><span class="hljs-string">"name"</span></span>&gt;{{presenter}}&lt;/span&gt;&lt;/div&gt; &lt;p&gt;{{summary}}&lt;/p&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"comments"</span></span>&gt;&lt;/div&gt; &lt;form&gt; &lt;<span class="hljs-built_in"><span class="hljs-built_in">input</span></span> <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=<span class="hljs-string"><span class="hljs-string">"text"</span></span> name=<span class="hljs-string"><span class="hljs-string">"comment"</span></span>&gt; &lt;button <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=<span class="hljs-string"><span class="hljs-string">"submit"</span></span>&gt; &lt;/button&gt; &lt;button <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=<span class="hljs-string"><span class="hljs-string">"button"</span></span> class=<span class="hljs-string"><span class="hljs-string">"del"</span></span>&gt; &lt;/button&gt; &lt;/form&gt; &lt;/div&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"comment"</span></span>&gt; &lt;span class=<span class="hljs-string"><span class="hljs-string">"name"</span></span>&gt;{{author}}&lt;/span&gt;: {{message}} &lt;/div&gt; &lt;/div&gt;</code> <br> <br>    DOM  JavaScript    .          elt   <span class="hljs-number"><span class="hljs-number">13</span></span>,       ,  HTML,   -      DOM-. <br> <br>   DOM-   ,      ,    ,   ,     ‚Äì             . <br> <br>  , HTML   ,   . <br> <br> <code class="html">&lt;script src=<span class="hljs-string"><span class="hljs-string">"skillsharing_client.js"</span></span>&gt;&lt;/script&gt;</code> <br> <br>  <br> ,       ,       .       HTTP-,      XMLHttpRequest,            . <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">request</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(options, callback)</span></span></span></span> { var req = new XMLHttpRequest(); req.<span class="hljs-built_in"><span class="hljs-built_in">open</span></span>(options.method || <span class="hljs-string"><span class="hljs-string">"GET"</span></span>, options.pathname, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); req.addEventListener(<span class="hljs-string"><span class="hljs-string">"load"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (req.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> &lt; <span class="hljs-number"><span class="hljs-number">400</span></span>) callback(null, req.responseText); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> callback(new Error(<span class="hljs-string"><span class="hljs-string">"Request failed: "</span></span> + req.statusText)); }); req.addEventListener(<span class="hljs-string"><span class="hljs-string">"error"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { callback(new Error(<span class="hljs-string"><span class="hljs-string">"Network error"</span></span>)); }); req.send(options.body || null); }</code> <br> <br>            ,  waitForChanges. <br> <br> <code class="javascript">var lastServerTime = <span class="hljs-number"><span class="hljs-number">0</span></span>; request({pathname: <span class="hljs-string"><span class="hljs-string">"talks"</span></span>}, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(error, response)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>) { reportError(<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { response = JSON.parse(response); displayTalks(response.talks); lastServerTime = response.serverTime; waitForChanges(); } });</code> <br> <br>  lastServerTime      ,   .   ,        ,       .  ,  serverTime,   ,     lastServerTime. <br> <br>    ,   ,        .       reportError,      ,   . <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">reportError</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(error)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>) alert(<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>.toString()); }</code> <br> <br>  ,   ,       .  ,           ,     .      ,      . <br> <br>   <br>         ,    ,    . ,     ,     ,        .  ,      ,   DOM    . <br> <br>  displayTalks      ,       .     shownTalks,      DOM,   ,     . <br> <br> <code class="javascript">var talkDiv = document.querySelector(<span class="hljs-string"><span class="hljs-string">"#talks"</span></span>); var shownTalks = Object.<span class="hljs-built_in"><span class="hljs-built_in">create</span></span>(null); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">displayTalks</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(talks)</span></span></span></span> { talks.forEach(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(talk)</span></span></span></span> { var shown = shownTalks[talk.title]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (talk.deleted) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (shown) { talkDiv.removeChild(shown); delete shownTalks[talk.title]; } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { var node = drawTalk(talk); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (shown) talkDiv.replaceChild(node, shown); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> talkDiv.appendChild(node); shownTalks[talk.title] = node; } }); }</code> <br> <br>  DOM     ,   HTML .    instantiateTemplate,     . <br> <br>  name ‚Äì  .    ,   ,        ,       ID ‚Äútemplate‚Äù.  querySelector   .     ‚Äútalk‚Äù  ‚Äúcomment‚Äù. <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">instantiateTemplate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(name, values)</span></span></span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">instantiateText</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(text)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> text.replace(/\{\{(\w+)\}\}/g, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(_, name)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> values[name]; }); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">instantiate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(node)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (node.nodeType == document.ELEMENT_NODE) { var copy = node.cloneNode(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (var i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; node.childNodes.length; i++) copy.appendChild(instantiate(node.childNodes[i])); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> copy; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (node.nodeType == document.TEXT_NODE) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> document.createTextNode( instantiateText(node.nodeValue)); } } var template = document.querySelector(<span class="hljs-string"><span class="hljs-string">"#template ."</span></span> + name); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> instantiate(template); }</code> <br> <br>  cloneNode,      DOM,   .     ,       <span class="hljs-literal"><span class="hljs-literal">true</span></span>.  instantiate    ,     . <br> <br>   instantiateTemplate   ,    ,     .   {{title}}     ‚Äútitle‚Äù. <br> <br>      ,    drawTalk   . <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">drawTalk</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(talk)</span></span></span></span> { var node = instantiateTemplate(<span class="hljs-string"><span class="hljs-string">"talk"</span></span>, talk); var comments = node.querySelector(<span class="hljs-string"><span class="hljs-string">".comments"</span></span>); talk.comments.forEach(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(comment)</span></span></span></span> { comments.appendChild( instantiateTemplate(<span class="hljs-string"><span class="hljs-string">"comment"</span></span>, comment)); }); node.querySelector(<span class="hljs-string"><span class="hljs-string">"button.del"</span></span>).addEventListener( <span class="hljs-string"><span class="hljs-string">"click"</span></span>, deleteTalk.bind(null, talk.title)); var form = node.querySelector(<span class="hljs-string"><span class="hljs-string">"form"</span></span>); form.addEventListener(<span class="hljs-string"><span class="hljs-string">"submit"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(event)</span></span></span></span> { event.preventDefault(); addComment(talk.title, form.elements.comment.value); form.reset(); }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> node; }</code> <br> <br>     ‚Äútalk‚Äù    . -,   ,     ‚Äúcomment‚Äù       <span class="hljs-string"><span class="hljs-string">"comments"</span></span>. ,      ,      ,  . <br> <br>   <br>  ,   drawTalk,   deleteTalk  addComment   ,       .      URL,       ,       talkURL. <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">talkURL</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(title)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"talks/"</span></span> + encodeURIComponent(title); }</code> <br> <br>  deleteTalk   DELETE       . <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">deleteTalk</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(title)</span></span></span></span> { request({pathname: talkURL(title), method: <span class="hljs-string"><span class="hljs-string">"DELETE"</span></span>}, reportError); }</code> <br> <br>          JSON      POST-. <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">addComment</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(title, comment)</span></span></span></span> { var comment = {author: nameField.value, message: comment}; request({pathname: talkURL(title) + <span class="hljs-string"><span class="hljs-string">"/comments"</span></span>, body: JSON.stringify(comment), method: <span class="hljs-string"><span class="hljs-string">"POST"</span></span>}, reportError); }</code> <br> <br>  nameField,      author,    <code><code class="javascript">  ,      .       localStorage,          . <br> <br> var nameField = document.querySelector(<span class="hljs-string"><span class="hljs-string">"#name"</span></span>); nameField.value = localStorage.getItem(<span class="hljs-string"><span class="hljs-string">"name"</span></span>) || <span class="hljs-string"><span class="hljs-string">""</span></span>; nameField.addEventListener(<span class="hljs-string"><span class="hljs-string">"change"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { localStorage.setItem(<span class="hljs-string"><span class="hljs-string">"name"</span></span>, nameField.value); });           ‚Äúsubmit‚Äù.       (     ),     PUT-   . var talkForm = document.querySelector(<span class="hljs-string"><span class="hljs-string">"#newtalk"</span></span>); talkForm.addEventListener(<span class="hljs-string"><span class="hljs-string">"submit"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(event)</span></span></span></span> { event.preventDefault(); request({pathname: talkURL(talkForm.elements.title.value), method: <span class="hljs-string"><span class="hljs-string">"PUT"</span></span>, body: JSON.stringify({ presenter: nameField.value, summary: talkForm.elements.summary.value })}, reportError); talkForm.reset(); });</code> <br> <br>   <br>  ,   ,   ,    ,     ,     ,       .    -       ,     . <br> <br>       ,    displayTalks    ,     ,       . <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">waitForChanges</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { request({pathname: <span class="hljs-string"><span class="hljs-string">"talks?changesSince="</span></span> + lastServerTime}, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(error, response)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>) { setTimeout(waitForChanges, <span class="hljs-number"><span class="hljs-number">2500</span></span>); console.<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>.stack); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { response = JSON.parse(response); displayTalks(response.talks); lastServerTime = response.serverTime; waitForChanges(); } }); }</code> <br> <br>    ,   ,     ,  ,    .    ,    reportError,             .       (  ),      <span class="hljs-number"><span class="hljs-number">2.5</span></span> . <br> <br>   ,     ,  lastServerTime ,    ,           .    ,    . <br> <br>    ,        localhost:<span class="hljs-number"><span class="hljs-number">8000</span></span>,  ,  ,     ,    . <br> <br>  <br>      ,    .    , ,   <a href=""> </a>   <a href="http://nodejs.org/">Node.js</a> . <br> <br>     <br>      .     ,      . <br> <br>     ,            .    ,    . <br> <br>    <br>      ,       DOM   ,   .   .     -         ,          ,      ,      ,  . <br> <br>   ,        ,    .    ,   ? <br> <br>   <br>    ,     .         ,   <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>,    ,  . <br> <br>           ,   (<span class="hljs-string"><span class="hljs-string">"comment"</span></span>)     .      ‚Äútalk‚Äù,     ,    comments,    ,   ,    . <br> <br>     : <br> <br> <code class="html">&lt;div class=<span class="hljs-string"><span class="hljs-string">"comments"</span></span>&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"comment"</span></span> template-<span class="hljs-keyword"><span class="hljs-keyword">repeat</span></span>=<span class="hljs-string"><span class="hljs-string">"comments"</span></span>&gt; &lt;span class=<span class="hljs-string"><span class="hljs-string">"name"</span></span>&gt;{{author}}&lt;/span&gt;: {{message}} &lt;/div&gt; &lt;/div&gt;</code> <br> <br>   :       template-<span class="hljs-keyword"><span class="hljs-keyword">repeat</span></span>,  ,     ,   ,   ,   .   ( values  instantiateTemplate)          ,   {{author}}     comment,    . <br> <br>  instantiateTemplate ,    ,    ,     ,          drawTalk. <br> <br>       ,      ,     <span class="hljs-literal"><span class="hljs-literal">true</span></span>  <span class="hljs-literal"><span class="hljs-literal">false</span></span>? <br> <br>    ? <br>  -       JavaScript,     .   - . <br> <br>   -     JavaScript.       ,      .         . <br> <br>   ,   -          JavaScript.     ,       .       ,     . <br> <br>     .    .          ,  ,    ?</code></code> </pre> <code><code class="html">  ID ‚Äútalks‚Äù    .   ,      . <br> <br>       . <br> <br> &lt;form id="newtalk"&gt; &lt;h3&gt;Submit a talk&lt;/h3&gt; : &lt;input type="text" style="width: 40em" name="title"&gt; &lt;br&gt; Summary: &lt;input type="text" style="width: 40em" name="summary"&gt; &lt;button type="submit"&gt; &lt;/button&gt; &lt;/form&gt;</code> <br> <br>     ‚Äúsubmit‚Äù  ,      HTTP-,    . <br> <br>    ,    display   none,       . ,   ? <br> <br> <code class="html">&lt;div id="template" style="display: none"&gt; &lt;div class="talk"&gt; &lt;h2&gt;{{title}}&lt;/h2&gt; &lt;div&gt;by &lt;span class="name"&gt;{{presenter}}&lt;/span&gt;&lt;/div&gt; &lt;p&gt;{{summary}}&lt;/p&gt; &lt;div class="comments"&gt;&lt;/div&gt; &lt;form&gt; &lt;input type="text" name="comment"&gt; &lt;button type="submit"&gt; &lt;/button&gt; &lt;button type="button" class="del"&gt; &lt;/button&gt; &lt;/form&gt; &lt;/div&gt; &lt;div class="comment"&gt; &lt;span class="name"&gt;{{author}}&lt;/span&gt;: {{message}} &lt;/div&gt; &lt;/div&gt;</code> <br> <br>    DOM  JavaScript    .          elt   13,       ,  HTML,   -      DOM-. <br> <br>   DOM-   ,      ,    ,   ,     ‚Äì             . <br> <br>  , HTML   ,   . <br> <br> <code class="html">&lt;script src="skillsharing_client.js"&gt;&lt;/script&gt;</code> <br> <br>  <br> ,       ,       .       HTTP-,      XMLHttpRequest,            . <br> <br> <code class="javascript">function request(options, callback) { var req = new XMLHttpRequest(); req.open(options.method || "GET", options.pathname, true); req.addEventListener("load", function() { if (req.status &lt; 400) callback(null, req.responseText); else callback(new Error("Request failed: " + req.statusText)); }); req.addEventListener("error", function() { callback(new Error("Network error")); }); req.send(options.body || null); }</code> <br> <br>            ,  waitForChanges. <br> <br> <code class="javascript">var lastServerTime = 0; request({pathname: "talks"}, function(error, response) { if (error) { reportError(error); } else { response = JSON.parse(response); displayTalks(response.talks); lastServerTime = response.serverTime; waitForChanges(); } });</code> <br> <br>  lastServerTime      ,   .   ,        ,       .  ,  serverTime,   ,     lastServerTime. <br> <br>    ,   ,        .       reportError,      ,   . <br> <br> <code class="javascript">function reportError(error) { if (error) alert(error.toString()); }</code> <br> <br>  ,   ,       .  ,           ,     .      ,      . <br> <br>   <br>         ,    ,    . ,     ,     ,        .  ,      ,   DOM    . <br> <br>  displayTalks      ,       .     shownTalks,      DOM,   ,     . <br> <br> <code class="javascript">var talkDiv = document.querySelector("#talks"); var shownTalks = Object.create(null); function displayTalks(talks) { talks.forEach(function(talk) { var shown = shownTalks[talk.title]; if (talk.deleted) { if (shown) { talkDiv.removeChild(shown); delete shownTalks[talk.title]; } } else { var node = drawTalk(talk); if (shown) talkDiv.replaceChild(node, shown); else talkDiv.appendChild(node); shownTalks[talk.title] = node; } }); }</code> <br> <br>  DOM     ,   HTML .    instantiateTemplate,     . <br> <br>  name ‚Äì  .    ,   ,        ,       ID ‚Äútemplate‚Äù.  querySelector   .     ‚Äútalk‚Äù  ‚Äúcomment‚Äù. <br> <br> <code class="javascript">function instantiateTemplate(name, values) { function instantiateText(text) { return text.replace(/\{\{(\w+)\}\}/g, function(_, name) { return values[name]; }); } function instantiate(node) { if (node.nodeType == document.ELEMENT_NODE) { var copy = node.cloneNode(); for (var i = 0; i &lt; node.childNodes.length; i++) copy.appendChild(instantiate(node.childNodes[i])); return copy; } else if (node.nodeType == document.TEXT_NODE) { return document.createTextNode( instantiateText(node.nodeValue)); } } var template = document.querySelector("#template ." + name); return instantiate(template); }</code> <br> <br>  cloneNode,      DOM,   .     ,       true.  instantiate    ,     . <br> <br>   instantiateTemplate   ,    ,     .   {{title}}     ‚Äútitle‚Äù. <br> <br>      ,    drawTalk   . <br> <br> <code class="javascript">function drawTalk(talk) { var node = instantiateTemplate("talk", talk); var comments = node.querySelector(".comments"); talk.comments.forEach(function(comment) { comments.appendChild( instantiateTemplate("comment", comment)); }); node.querySelector("button.del").addEventListener( "click", deleteTalk.bind(null, talk.title)); var form = node.querySelector("form"); form.addEventListener("submit", function(event) { event.preventDefault(); addComment(talk.title, form.elements.comment.value); form.reset(); }); return node; }</code> <br> <br>     ‚Äútalk‚Äù    . -,   ,     ‚Äúcomment‚Äù       "comments". ,      ,      ,  . <br> <br>   <br>  ,   drawTalk,   deleteTalk  addComment   ,       .      URL,       ,       talkURL. <br> <br> <code class="javascript">function talkURL(title) { return "talks/" + encodeURIComponent(title); }</code> <br> <br>  deleteTalk   DELETE       . <br> <br> <code class="javascript">function deleteTalk(title) { request({pathname: talkURL(title), method: "DELETE"}, reportError); }</code> <br> <br>          JSON      POST-. <br> <br> <code class="javascript">function addComment(title, comment) { var comment = {author: nameField.value, message: comment}; request({pathname: talkURL(title) + "/comments", body: JSON.stringify(comment), method: "POST"}, reportError); }</code> <br> <br>  nameField,      author,    <code><code class="javascript">  ,      .       localStorage,          . <br> <br> var nameField = document.querySelector("#name"); nameField.value = localStorage.getItem("name") || ""; nameField.addEventListener("change", function() { localStorage.setItem("name", nameField.value); });           ‚Äúsubmit‚Äù.       (     ),     PUT-   . var talkForm = document.querySelector("#newtalk"); talkForm.addEventListener("submit", function(event) { event.preventDefault(); request({pathname: talkURL(talkForm.elements.title.value), method: "PUT", body: JSON.stringify({ presenter: nameField.value, summary: talkForm.elements.summary.value })}, reportError); talkForm.reset(); });</code> <br> <br>   <br>  ,   ,   ,    ,     ,     ,       .    -       ,     . <br> <br>       ,    displayTalks    ,     ,       . <br> <br> <code class="javascript">function waitForChanges() { request({pathname: "talks?changesSince=" + lastServerTime}, function(error, response) { if (error) { setTimeout(waitForChanges, 2500); console.error(error.stack); } else { response = JSON.parse(response); displayTalks(response.talks); lastServerTime = response.serverTime; waitForChanges(); } }); }</code> <br> <br>    ,   ,     ,  ,    .    ,    reportError,             .       (  ),      2.5 . <br> <br>   ,     ,  lastServerTime ,    ,           .    ,    . <br> <br>    ,        localhost:8000,  ,  ,     ,    . <br> <br>  <br>      ,    .    , ,   <a href=""> </a>   <a href="http://nodejs.org/">Node.js</a> . <br> <br>     <br>      .     ,      . <br> <br>     ,            .    ,    . <br> <br>    <br>      ,       DOM   ,   .   .     -         ,          ,      ,      ,  . <br> <br>   ,        ,    .    ,   ? <br> <br>   <br>    ,     .         ,   if,    ,  . <br> <br>           ,   ("comment")     .      ‚Äútalk‚Äù,     ,    comments,    ,   ,    . <br> <br>     : <br> <br> <code class="html">&lt;div class="comments"&gt; &lt;div class="comment" template-repeat="comments"&gt; &lt;span class="name"&gt;{{author}}&lt;/span&gt;: {{message}} &lt;/div&gt; &lt;/div&gt;</code> <br> <br>   :       template-repeat,  ,     ,   ,   ,   .   ( values  instantiateTemplate)          ,   {{author}}     comment,    . <br> <br>  instantiateTemplate ,    ,    ,     ,          drawTalk. <br> <br>       ,      ,     true  false? <br> <br>    ? <br>  -       JavaScript,     .   - . <br> <br>   -     JavaScript.       ,      .         . <br> <br>   ,   -          JavaScript.     ,       .       ,     . <br> <br>     .    .          ,  ,    ?</code></code> <pre> <code class="hljs lua"><code class="html">  ID ‚Äútalks‚Äù    .   ,      . <br> <br>       . <br> <br> &lt;form id=<span class="hljs-string"><span class="hljs-string">"newtalk"</span></span>&gt; &lt;h3&gt;Submit a talk&lt;/h3&gt; : &lt;<span class="hljs-built_in"><span class="hljs-built_in">input</span></span> <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=<span class="hljs-string"><span class="hljs-string">"text"</span></span> style=<span class="hljs-string"><span class="hljs-string">"width: 40em"</span></span> name=<span class="hljs-string"><span class="hljs-string">"title"</span></span>&gt; &lt;br&gt; Summary: &lt;<span class="hljs-built_in"><span class="hljs-built_in">input</span></span> <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=<span class="hljs-string"><span class="hljs-string">"text"</span></span> style=<span class="hljs-string"><span class="hljs-string">"width: 40em"</span></span> name=<span class="hljs-string"><span class="hljs-string">"summary"</span></span>&gt; &lt;button <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=<span class="hljs-string"><span class="hljs-string">"submit"</span></span>&gt; &lt;/button&gt; &lt;/form&gt;</code> <br> <br>     ‚Äúsubmit‚Äù  ,      HTTP-,    . <br> <br>    ,    display   none,       . ,   ? <br> <br> <code class="html">&lt;div id=<span class="hljs-string"><span class="hljs-string">"template"</span></span> style=<span class="hljs-string"><span class="hljs-string">"display: none"</span></span>&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"talk"</span></span>&gt; &lt;h2&gt;{{title}}&lt;/h2&gt; &lt;div&gt;by &lt;span class=<span class="hljs-string"><span class="hljs-string">"name"</span></span>&gt;{{presenter}}&lt;/span&gt;&lt;/div&gt; &lt;p&gt;{{summary}}&lt;/p&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"comments"</span></span>&gt;&lt;/div&gt; &lt;form&gt; &lt;<span class="hljs-built_in"><span class="hljs-built_in">input</span></span> <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=<span class="hljs-string"><span class="hljs-string">"text"</span></span> name=<span class="hljs-string"><span class="hljs-string">"comment"</span></span>&gt; &lt;button <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=<span class="hljs-string"><span class="hljs-string">"submit"</span></span>&gt; &lt;/button&gt; &lt;button <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=<span class="hljs-string"><span class="hljs-string">"button"</span></span> class=<span class="hljs-string"><span class="hljs-string">"del"</span></span>&gt; &lt;/button&gt; &lt;/form&gt; &lt;/div&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"comment"</span></span>&gt; &lt;span class=<span class="hljs-string"><span class="hljs-string">"name"</span></span>&gt;{{author}}&lt;/span&gt;: {{message}} &lt;/div&gt; &lt;/div&gt;</code> <br> <br>    DOM  JavaScript    .          elt   <span class="hljs-number"><span class="hljs-number">13</span></span>,       ,  HTML,   -      DOM-. <br> <br>   DOM-   ,      ,    ,   ,     ‚Äì             . <br> <br>  , HTML   ,   . <br> <br> <code class="html">&lt;script src=<span class="hljs-string"><span class="hljs-string">"skillsharing_client.js"</span></span>&gt;&lt;/script&gt;</code> <br> <br>  <br> ,       ,       .       HTTP-,      XMLHttpRequest,            . <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">request</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(options, callback)</span></span></span></span> { var req = new XMLHttpRequest(); req.<span class="hljs-built_in"><span class="hljs-built_in">open</span></span>(options.method || <span class="hljs-string"><span class="hljs-string">"GET"</span></span>, options.pathname, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); req.addEventListener(<span class="hljs-string"><span class="hljs-string">"load"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (req.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> &lt; <span class="hljs-number"><span class="hljs-number">400</span></span>) callback(null, req.responseText); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> callback(new Error(<span class="hljs-string"><span class="hljs-string">"Request failed: "</span></span> + req.statusText)); }); req.addEventListener(<span class="hljs-string"><span class="hljs-string">"error"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { callback(new Error(<span class="hljs-string"><span class="hljs-string">"Network error"</span></span>)); }); req.send(options.body || null); }</code> <br> <br>            ,  waitForChanges. <br> <br> <code class="javascript">var lastServerTime = <span class="hljs-number"><span class="hljs-number">0</span></span>; request({pathname: <span class="hljs-string"><span class="hljs-string">"talks"</span></span>}, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(error, response)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>) { reportError(<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { response = JSON.parse(response); displayTalks(response.talks); lastServerTime = response.serverTime; waitForChanges(); } });</code> <br> <br>  lastServerTime      ,   .   ,        ,       .  ,  serverTime,   ,     lastServerTime. <br> <br>    ,   ,        .       reportError,      ,   . <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">reportError</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(error)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>) alert(<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>.toString()); }</code> <br> <br>  ,   ,       .  ,           ,     .      ,      . <br> <br>   <br>         ,    ,    . ,     ,     ,        .  ,      ,   DOM    . <br> <br>  displayTalks      ,       .     shownTalks,      DOM,   ,     . <br> <br> <code class="javascript">var talkDiv = document.querySelector(<span class="hljs-string"><span class="hljs-string">"#talks"</span></span>); var shownTalks = Object.<span class="hljs-built_in"><span class="hljs-built_in">create</span></span>(null); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">displayTalks</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(talks)</span></span></span></span> { talks.forEach(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(talk)</span></span></span></span> { var shown = shownTalks[talk.title]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (talk.deleted) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (shown) { talkDiv.removeChild(shown); delete shownTalks[talk.title]; } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { var node = drawTalk(talk); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (shown) talkDiv.replaceChild(node, shown); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> talkDiv.appendChild(node); shownTalks[talk.title] = node; } }); }</code> <br> <br>  DOM     ,   HTML .    instantiateTemplate,     . <br> <br>  name ‚Äì  .    ,   ,        ,       ID ‚Äútemplate‚Äù.  querySelector   .     ‚Äútalk‚Äù  ‚Äúcomment‚Äù. <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">instantiateTemplate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(name, values)</span></span></span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">instantiateText</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(text)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> text.replace(/\{\{(\w+)\}\}/g, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(_, name)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> values[name]; }); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">instantiate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(node)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (node.nodeType == document.ELEMENT_NODE) { var copy = node.cloneNode(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (var i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; node.childNodes.length; i++) copy.appendChild(instantiate(node.childNodes[i])); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> copy; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (node.nodeType == document.TEXT_NODE) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> document.createTextNode( instantiateText(node.nodeValue)); } } var template = document.querySelector(<span class="hljs-string"><span class="hljs-string">"#template ."</span></span> + name); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> instantiate(template); }</code> <br> <br>  cloneNode,      DOM,   .     ,       <span class="hljs-literal"><span class="hljs-literal">true</span></span>.  instantiate    ,     . <br> <br>   instantiateTemplate   ,    ,     .   {{title}}     ‚Äútitle‚Äù. <br> <br>      ,    drawTalk   . <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">drawTalk</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(talk)</span></span></span></span> { var node = instantiateTemplate(<span class="hljs-string"><span class="hljs-string">"talk"</span></span>, talk); var comments = node.querySelector(<span class="hljs-string"><span class="hljs-string">".comments"</span></span>); talk.comments.forEach(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(comment)</span></span></span></span> { comments.appendChild( instantiateTemplate(<span class="hljs-string"><span class="hljs-string">"comment"</span></span>, comment)); }); node.querySelector(<span class="hljs-string"><span class="hljs-string">"button.del"</span></span>).addEventListener( <span class="hljs-string"><span class="hljs-string">"click"</span></span>, deleteTalk.bind(null, talk.title)); var form = node.querySelector(<span class="hljs-string"><span class="hljs-string">"form"</span></span>); form.addEventListener(<span class="hljs-string"><span class="hljs-string">"submit"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(event)</span></span></span></span> { event.preventDefault(); addComment(talk.title, form.elements.comment.value); form.reset(); }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> node; }</code> <br> <br>     ‚Äútalk‚Äù    . -,   ,     ‚Äúcomment‚Äù       <span class="hljs-string"><span class="hljs-string">"comments"</span></span>. ,      ,      ,  . <br> <br>   <br>  ,   drawTalk,   deleteTalk  addComment   ,       .      URL,       ,       talkURL. <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">talkURL</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(title)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"talks/"</span></span> + encodeURIComponent(title); }</code> <br> <br>  deleteTalk   DELETE       . <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">deleteTalk</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(title)</span></span></span></span> { request({pathname: talkURL(title), method: <span class="hljs-string"><span class="hljs-string">"DELETE"</span></span>}, reportError); }</code> <br> <br>          JSON      POST-. <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">addComment</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(title, comment)</span></span></span></span> { var comment = {author: nameField.value, message: comment}; request({pathname: talkURL(title) + <span class="hljs-string"><span class="hljs-string">"/comments"</span></span>, body: JSON.stringify(comment), method: <span class="hljs-string"><span class="hljs-string">"POST"</span></span>}, reportError); }</code> <br> <br>  nameField,      author,    <code><code class="javascript">  ,      .       localStorage,          . <br> <br> var nameField = document.querySelector(<span class="hljs-string"><span class="hljs-string">"#name"</span></span>); nameField.value = localStorage.getItem(<span class="hljs-string"><span class="hljs-string">"name"</span></span>) || <span class="hljs-string"><span class="hljs-string">""</span></span>; nameField.addEventListener(<span class="hljs-string"><span class="hljs-string">"change"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { localStorage.setItem(<span class="hljs-string"><span class="hljs-string">"name"</span></span>, nameField.value); });           ‚Äúsubmit‚Äù.       (     ),     PUT-   . var talkForm = document.querySelector(<span class="hljs-string"><span class="hljs-string">"#newtalk"</span></span>); talkForm.addEventListener(<span class="hljs-string"><span class="hljs-string">"submit"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(event)</span></span></span></span> { event.preventDefault(); request({pathname: talkURL(talkForm.elements.title.value), method: <span class="hljs-string"><span class="hljs-string">"PUT"</span></span>, body: JSON.stringify({ presenter: nameField.value, summary: talkForm.elements.summary.value })}, reportError); talkForm.reset(); });</code> <br> <br>   <br>  ,   ,   ,    ,     ,     ,       .    -       ,     . <br> <br>       ,    displayTalks    ,     ,       . <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">waitForChanges</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { request({pathname: <span class="hljs-string"><span class="hljs-string">"talks?changesSince="</span></span> + lastServerTime}, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(error, response)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>) { setTimeout(waitForChanges, <span class="hljs-number"><span class="hljs-number">2500</span></span>); console.<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>.stack); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { response = JSON.parse(response); displayTalks(response.talks); lastServerTime = response.serverTime; waitForChanges(); } }); }</code> <br> <br>    ,   ,     ,  ,    .    ,    reportError,             .       (  ),      <span class="hljs-number"><span class="hljs-number">2.5</span></span> . <br> <br>   ,     ,  lastServerTime ,    ,           .    ,    . <br> <br>    ,        localhost:<span class="hljs-number"><span class="hljs-number">8000</span></span>,  ,  ,     ,    . <br> <br>  <br>      ,    .    , ,   <a href=""> </a>   <a href="http://nodejs.org/">Node.js</a> . <br> <br>     <br>      .     ,      . <br> <br>     ,            .    ,    . <br> <br>    <br>      ,       DOM   ,   .   .     -         ,          ,      ,      ,  . <br> <br>   ,        ,    .    ,   ? <br> <br>   <br>    ,     .         ,   <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>,    ,  . <br> <br>           ,   (<span class="hljs-string"><span class="hljs-string">"comment"</span></span>)     .      ‚Äútalk‚Äù,     ,    comments,    ,   ,    . <br> <br>     : <br> <br> <code class="html">&lt;div class=<span class="hljs-string"><span class="hljs-string">"comments"</span></span>&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"comment"</span></span> template-<span class="hljs-keyword"><span class="hljs-keyword">repeat</span></span>=<span class="hljs-string"><span class="hljs-string">"comments"</span></span>&gt; &lt;span class=<span class="hljs-string"><span class="hljs-string">"name"</span></span>&gt;{{author}}&lt;/span&gt;: {{message}} &lt;/div&gt; &lt;/div&gt;</code> <br> <br>   :       template-<span class="hljs-keyword"><span class="hljs-keyword">repeat</span></span>,  ,     ,   ,   ,   .   ( values  instantiateTemplate)          ,   {{author}}     comment,    . <br> <br>  instantiateTemplate ,    ,    ,     ,          drawTalk. <br> <br>       ,      ,     <span class="hljs-literal"><span class="hljs-literal">true</span></span>  <span class="hljs-literal"><span class="hljs-literal">false</span></span>? <br> <br>    ? <br>  -       JavaScript,     .   - . <br> <br>   -     JavaScript.       ,      .         . <br> <br>   ,   -          JavaScript.     ,       .       ,     . <br> <br>     .    .          ,  ,    ?</code></code> </pre> <code><code class="html">  ID ‚Äútalks‚Äù    .   ,      . <br> <br>       . <br> <br> &lt;form id="newtalk"&gt; &lt;h3&gt;Submit a talk&lt;/h3&gt; : &lt;input type="text" style="width: 40em" name="title"&gt; &lt;br&gt; Summary: &lt;input type="text" style="width: 40em" name="summary"&gt; &lt;button type="submit"&gt; &lt;/button&gt; &lt;/form&gt;</code> <br> <br>     ‚Äúsubmit‚Äù  ,      HTTP-,    . <br> <br>    ,    display   none,       . ,   ? <br> <br> <code class="html">&lt;div id="template" style="display: none"&gt; &lt;div class="talk"&gt; &lt;h2&gt;{{title}}&lt;/h2&gt; &lt;div&gt;by &lt;span class="name"&gt;{{presenter}}&lt;/span&gt;&lt;/div&gt; &lt;p&gt;{{summary}}&lt;/p&gt; &lt;div class="comments"&gt;&lt;/div&gt; &lt;form&gt; &lt;input type="text" name="comment"&gt; &lt;button type="submit"&gt; &lt;/button&gt; &lt;button type="button" class="del"&gt; &lt;/button&gt; &lt;/form&gt; &lt;/div&gt; &lt;div class="comment"&gt; &lt;span class="name"&gt;{{author}}&lt;/span&gt;: {{message}} &lt;/div&gt; &lt;/div&gt;</code> <br> <br>    DOM  JavaScript    .          elt   13,       ,  HTML,   -      DOM-. <br> <br>   DOM-   ,      ,    ,   ,     ‚Äì             . <br> <br>  , HTML   ,   . <br> <br> <code class="html">&lt;script src="skillsharing_client.js"&gt;&lt;/script&gt;</code> <br> <br>  <br> ,       ,       .       HTTP-,      XMLHttpRequest,            . <br> <br> <code class="javascript">function request(options, callback) { var req = new XMLHttpRequest(); req.open(options.method || "GET", options.pathname, true); req.addEventListener("load", function() { if (req.status &lt; 400) callback(null, req.responseText); else callback(new Error("Request failed: " + req.statusText)); }); req.addEventListener("error", function() { callback(new Error("Network error")); }); req.send(options.body || null); }</code> <br> <br>            ,  waitForChanges. <br> <br> <code class="javascript">var lastServerTime = 0; request({pathname: "talks"}, function(error, response) { if (error) { reportError(error); } else { response = JSON.parse(response); displayTalks(response.talks); lastServerTime = response.serverTime; waitForChanges(); } });</code> <br> <br>  lastServerTime      ,   .   ,        ,       .  ,  serverTime,   ,     lastServerTime. <br> <br>    ,   ,        .       reportError,      ,   . <br> <br> <code class="javascript">function reportError(error) { if (error) alert(error.toString()); }</code> <br> <br>  ,   ,       .  ,           ,     .      ,      . <br> <br>   <br>         ,    ,    . ,     ,     ,        .  ,      ,   DOM    . <br> <br>  displayTalks      ,       .     shownTalks,      DOM,   ,     . <br> <br> <code class="javascript">var talkDiv = document.querySelector("#talks"); var shownTalks = Object.create(null); function displayTalks(talks) { talks.forEach(function(talk) { var shown = shownTalks[talk.title]; if (talk.deleted) { if (shown) { talkDiv.removeChild(shown); delete shownTalks[talk.title]; } } else { var node = drawTalk(talk); if (shown) talkDiv.replaceChild(node, shown); else talkDiv.appendChild(node); shownTalks[talk.title] = node; } }); }</code> <br> <br>  DOM     ,   HTML .    instantiateTemplate,     . <br> <br>  name ‚Äì  .    ,   ,        ,       ID ‚Äútemplate‚Äù.  querySelector   .     ‚Äútalk‚Äù  ‚Äúcomment‚Äù. <br> <br> <code class="javascript">function instantiateTemplate(name, values) { function instantiateText(text) { return text.replace(/\{\{(\w+)\}\}/g, function(_, name) { return values[name]; }); } function instantiate(node) { if (node.nodeType == document.ELEMENT_NODE) { var copy = node.cloneNode(); for (var i = 0; i &lt; node.childNodes.length; i++) copy.appendChild(instantiate(node.childNodes[i])); return copy; } else if (node.nodeType == document.TEXT_NODE) { return document.createTextNode( instantiateText(node.nodeValue)); } } var template = document.querySelector("#template ." + name); return instantiate(template); }</code> <br> <br>  cloneNode,      DOM,   .     ,       true.  instantiate    ,     . <br> <br>   instantiateTemplate   ,    ,     .   {{title}}     ‚Äútitle‚Äù. <br> <br>      ,    drawTalk   . <br> <br> <code class="javascript">function drawTalk(talk) { var node = instantiateTemplate("talk", talk); var comments = node.querySelector(".comments"); talk.comments.forEach(function(comment) { comments.appendChild( instantiateTemplate("comment", comment)); }); node.querySelector("button.del").addEventListener( "click", deleteTalk.bind(null, talk.title)); var form = node.querySelector("form"); form.addEventListener("submit", function(event) { event.preventDefault(); addComment(talk.title, form.elements.comment.value); form.reset(); }); return node; }</code> <br> <br>     ‚Äútalk‚Äù    . -,   ,     ‚Äúcomment‚Äù       "comments". ,      ,      ,  . <br> <br>   <br>  ,   drawTalk,   deleteTalk  addComment   ,       .      URL,       ,       talkURL. <br> <br> <code class="javascript">function talkURL(title) { return "talks/" + encodeURIComponent(title); }</code> <br> <br>  deleteTalk   DELETE       . <br> <br> <code class="javascript">function deleteTalk(title) { request({pathname: talkURL(title), method: "DELETE"}, reportError); }</code> <br> <br>          JSON      POST-. <br> <br> <code class="javascript">function addComment(title, comment) { var comment = {author: nameField.value, message: comment}; request({pathname: talkURL(title) + "/comments", body: JSON.stringify(comment), method: "POST"}, reportError); }</code> <br> <br>  nameField,      author,    <code><code class="javascript">  ,      .       localStorage,          . <br> <br> var nameField = document.querySelector("#name"); nameField.value = localStorage.getItem("name") || ""; nameField.addEventListener("change", function() { localStorage.setItem("name", nameField.value); });           ‚Äúsubmit‚Äù.       (     ),     PUT-   . var talkForm = document.querySelector("#newtalk"); talkForm.addEventListener("submit", function(event) { event.preventDefault(); request({pathname: talkURL(talkForm.elements.title.value), method: "PUT", body: JSON.stringify({ presenter: nameField.value, summary: talkForm.elements.summary.value })}, reportError); talkForm.reset(); });</code> <br> <br>   <br>  ,   ,   ,    ,     ,     ,       .    -       ,     . <br> <br>       ,    displayTalks    ,     ,       . <br> <br> <code class="javascript">function waitForChanges() { request({pathname: "talks?changesSince=" + lastServerTime}, function(error, response) { if (error) { setTimeout(waitForChanges, 2500); console.error(error.stack); } else { response = JSON.parse(response); displayTalks(response.talks); lastServerTime = response.serverTime; waitForChanges(); } }); }</code> <br> <br>    ,   ,     ,  ,    .    ,    reportError,             .       (  ),      2.5 . <br> <br>   ,     ,  lastServerTime ,    ,           .    ,    . <br> <br>    ,        localhost:8000,  ,  ,     ,    . <br> <br>  <br>      ,    .    , ,   <a href=""> </a>   <a href="http://nodejs.org/">Node.js</a> . <br> <br>     <br>      .     ,      . <br> <br>     ,            .    ,    . <br> <br>    <br>      ,       DOM   ,   .   .     -         ,          ,      ,      ,  . <br> <br>   ,        ,    .    ,   ? <br> <br>   <br>    ,     .         ,   if,    ,  . <br> <br>           ,   ("comment")     .      ‚Äútalk‚Äù,     ,    comments,    ,   ,    . <br> <br>     : <br> <br> <code class="html">&lt;div class="comments"&gt; &lt;div class="comment" template-repeat="comments"&gt; &lt;span class="name"&gt;{{author}}&lt;/span&gt;: {{message}} &lt;/div&gt; &lt;/div&gt;</code> <br> <br>   :       template-repeat,  ,     ,   ,   ,   .   ( values  instantiateTemplate)          ,   {{author}}     comment,    . <br> <br>  instantiateTemplate ,    ,    ,     ,          drawTalk. <br> <br>       ,      ,     true  false? <br> <br>    ? <br>  -       JavaScript,     .   - . <br> <br>   -     JavaScript.       ,      .         . <br> <br>   ,   -          JavaScript.     ,       .       ,     . <br> <br>     .    .          ,  ,    ?</code></code> <pre> <code class="hljs lua"><code class="html"><code class="html">  ID ‚Äútalks‚Äù    .   ,      . <br> <br>       . <br> <br> &lt;form id=<span class="hljs-string"><span class="hljs-string">"newtalk"</span></span>&gt; &lt;h3&gt;Submit a talk&lt;/h3&gt; : &lt;<span class="hljs-built_in"><span class="hljs-built_in">input</span></span> <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=<span class="hljs-string"><span class="hljs-string">"text"</span></span> style=<span class="hljs-string"><span class="hljs-string">"width: 40em"</span></span> name=<span class="hljs-string"><span class="hljs-string">"title"</span></span>&gt; &lt;br&gt; Summary: &lt;<span class="hljs-built_in"><span class="hljs-built_in">input</span></span> <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=<span class="hljs-string"><span class="hljs-string">"text"</span></span> style=<span class="hljs-string"><span class="hljs-string">"width: 40em"</span></span> name=<span class="hljs-string"><span class="hljs-string">"summary"</span></span>&gt; &lt;button <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=<span class="hljs-string"><span class="hljs-string">"submit"</span></span>&gt; &lt;/button&gt; &lt;/form&gt;</code> <br> <br>     ‚Äúsubmit‚Äù  ,      HTTP-,    . <br> <br>    ,    display   none,       . ,   ? <br> <br> <code class="html">&lt;div id=<span class="hljs-string"><span class="hljs-string">"template"</span></span> style=<span class="hljs-string"><span class="hljs-string">"display: none"</span></span>&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"talk"</span></span>&gt; &lt;h2&gt;{{title}}&lt;/h2&gt; &lt;div&gt;by &lt;span class=<span class="hljs-string"><span class="hljs-string">"name"</span></span>&gt;{{presenter}}&lt;/span&gt;&lt;/div&gt; &lt;p&gt;{{summary}}&lt;/p&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"comments"</span></span>&gt;&lt;/div&gt; &lt;form&gt; &lt;<span class="hljs-built_in"><span class="hljs-built_in">input</span></span> <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=<span class="hljs-string"><span class="hljs-string">"text"</span></span> name=<span class="hljs-string"><span class="hljs-string">"comment"</span></span>&gt; &lt;button <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=<span class="hljs-string"><span class="hljs-string">"submit"</span></span>&gt; &lt;/button&gt; &lt;button <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=<span class="hljs-string"><span class="hljs-string">"button"</span></span> class=<span class="hljs-string"><span class="hljs-string">"del"</span></span>&gt; &lt;/button&gt; &lt;/form&gt; &lt;/div&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"comment"</span></span>&gt; &lt;span class=<span class="hljs-string"><span class="hljs-string">"name"</span></span>&gt;{{author}}&lt;/span&gt;: {{message}} &lt;/div&gt; &lt;/div&gt;</code> <br> <br>    DOM  JavaScript    .          elt   <span class="hljs-number"><span class="hljs-number">13</span></span>,       ,  HTML,   -      DOM-. <br> <br>   DOM-   ,      ,    ,   ,     ‚Äì             . <br> <br>  , HTML   ,   . <br> <br> &lt;script src=<span class="hljs-string"><span class="hljs-string">"skillsharing_client.js"</span></span>&gt;&lt;/script&gt; <br> <br>  <br> ,       ,       .       HTTP-,      XMLHttpRequest,            . <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">request</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(options, callback)</span></span></span></span> { var req = new XMLHttpRequest(); req.<span class="hljs-built_in"><span class="hljs-built_in">open</span></span>(options.method || <span class="hljs-string"><span class="hljs-string">"GET"</span></span>, options.pathname, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); req.addEventListener(<span class="hljs-string"><span class="hljs-string">"load"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (req.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> &lt; <span class="hljs-number"><span class="hljs-number">400</span></span>) callback(null, req.responseText); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> callback(new Error(<span class="hljs-string"><span class="hljs-string">"Request failed: "</span></span> + req.statusText)); }); req.addEventListener(<span class="hljs-string"><span class="hljs-string">"error"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { callback(new Error(<span class="hljs-string"><span class="hljs-string">"Network error"</span></span>)); }); req.send(options.body || null); }</code> <br> <br>            ,  waitForChanges. <br> <br> <code class="javascript">var lastServerTime = <span class="hljs-number"><span class="hljs-number">0</span></span>; request({pathname: <span class="hljs-string"><span class="hljs-string">"talks"</span></span>}, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(error, response)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>) { reportError(<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { response = JSON.parse(response); displayTalks(response.talks); lastServerTime = response.serverTime; waitForChanges(); } });</code> <br> <br>  lastServerTime      ,   .   ,        ,       .  ,  serverTime,   ,     lastServerTime. <br> <br>    ,   ,        .       reportError,      ,   . <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">reportError</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(error)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>) alert(<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>.toString()); }</code> <br> <br>  ,   ,       .  ,           ,     .      ,      . <br> <br>   <br>         ,    ,    . ,     ,     ,        .  ,      ,   DOM    . <br> <br>  displayTalks      ,       .     shownTalks,      DOM,   ,     . <br> <br> <code class="javascript">var talkDiv = document.querySelector(<span class="hljs-string"><span class="hljs-string">"#talks"</span></span>); var shownTalks = Object.<span class="hljs-built_in"><span class="hljs-built_in">create</span></span>(null); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">displayTalks</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(talks)</span></span></span></span> { talks.forEach(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(talk)</span></span></span></span> { var shown = shownTalks[talk.title]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (talk.deleted) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (shown) { talkDiv.removeChild(shown); delete shownTalks[talk.title]; } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { var node = drawTalk(talk); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (shown) talkDiv.replaceChild(node, shown); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> talkDiv.appendChild(node); shownTalks[talk.title] = node; } }); }</code> <br> <br>  DOM     ,   HTML .    instantiateTemplate,     . <br> <br>  name ‚Äì  .    ,   ,        ,       ID ‚Äútemplate‚Äù.  querySelector   .     ‚Äútalk‚Äù  ‚Äúcomment‚Äù. <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">instantiateTemplate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(name, values)</span></span></span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">instantiateText</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(text)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> text.replace(/\{\{(\w+)\}\}/g, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(_, name)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> values[name]; }); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">instantiate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(node)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (node.nodeType == document.ELEMENT_NODE) { var copy = node.cloneNode(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (var i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; node.childNodes.length; i++) copy.appendChild(instantiate(node.childNodes[i])); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> copy; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (node.nodeType == document.TEXT_NODE) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> document.createTextNode( instantiateText(node.nodeValue)); } } var template = document.querySelector(<span class="hljs-string"><span class="hljs-string">"#template ."</span></span> + name); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> instantiate(template); }</code> <br> <br>  cloneNode,      DOM,   .     ,       <span class="hljs-literal"><span class="hljs-literal">true</span></span>.  instantiate    ,     . <br> <br>   instantiateTemplate   ,    ,     .   {{title}}     ‚Äútitle‚Äù. <br> <br>      ,    drawTalk   . <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">drawTalk</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(talk)</span></span></span></span> { var node = instantiateTemplate(<span class="hljs-string"><span class="hljs-string">"talk"</span></span>, talk); var comments = node.querySelector(<span class="hljs-string"><span class="hljs-string">".comments"</span></span>); talk.comments.forEach(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(comment)</span></span></span></span> { comments.appendChild( instantiateTemplate(<span class="hljs-string"><span class="hljs-string">"comment"</span></span>, comment)); }); node.querySelector(<span class="hljs-string"><span class="hljs-string">"button.del"</span></span>).addEventListener( <span class="hljs-string"><span class="hljs-string">"click"</span></span>, deleteTalk.bind(null, talk.title)); var form = node.querySelector(<span class="hljs-string"><span class="hljs-string">"form"</span></span>); form.addEventListener(<span class="hljs-string"><span class="hljs-string">"submit"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(event)</span></span></span></span> { event.preventDefault(); addComment(talk.title, form.elements.comment.value); form.reset(); }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> node; }</code> <br> <br>     ‚Äútalk‚Äù    . -,   ,     ‚Äúcomment‚Äù       <span class="hljs-string"><span class="hljs-string">"comments"</span></span>. ,      ,      ,  . <br> <br>   <br>  ,   drawTalk,   deleteTalk  addComment   ,       .      URL,       ,       talkURL. <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">talkURL</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(title)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"talks/"</span></span> + encodeURIComponent(title); }</code> <br> <br>  deleteTalk   DELETE       . <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">deleteTalk</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(title)</span></span></span></span> { request({pathname: talkURL(title), method: <span class="hljs-string"><span class="hljs-string">"DELETE"</span></span>}, reportError); }</code> <br> <br>          JSON      POST-. <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">addComment</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(title, comment)</span></span></span></span> { var comment = {author: nameField.value, message: comment}; request({pathname: talkURL(title) + <span class="hljs-string"><span class="hljs-string">"/comments"</span></span>, body: JSON.stringify(comment), method: <span class="hljs-string"><span class="hljs-string">"POST"</span></span>}, reportError); }</code> <br> <br>  nameField,      author,    <code><code class="javascript">  ,      .       localStorage,          . <br> <br> var nameField = document.querySelector(<span class="hljs-string"><span class="hljs-string">"#name"</span></span>); nameField.value = localStorage.getItem(<span class="hljs-string"><span class="hljs-string">"name"</span></span>) || <span class="hljs-string"><span class="hljs-string">""</span></span>; nameField.addEventListener(<span class="hljs-string"><span class="hljs-string">"change"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { localStorage.setItem(<span class="hljs-string"><span class="hljs-string">"name"</span></span>, nameField.value); });           ‚Äúsubmit‚Äù.       (     ),     PUT-   . var talkForm = document.querySelector(<span class="hljs-string"><span class="hljs-string">"#newtalk"</span></span>); talkForm.addEventListener(<span class="hljs-string"><span class="hljs-string">"submit"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(event)</span></span></span></span> { event.preventDefault(); request({pathname: talkURL(talkForm.elements.title.value), method: <span class="hljs-string"><span class="hljs-string">"PUT"</span></span>, body: JSON.stringify({ presenter: nameField.value, summary: talkForm.elements.summary.value })}, reportError); talkForm.reset(); });</code> <br> <br>   <br>  ,   ,   ,    ,     ,     ,       .    -       ,     . <br> <br>       ,    displayTalks    ,     ,       . <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">waitForChanges</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { request({pathname: <span class="hljs-string"><span class="hljs-string">"talks?changesSince="</span></span> + lastServerTime}, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(error, response)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>) { setTimeout(waitForChanges, <span class="hljs-number"><span class="hljs-number">2500</span></span>); console.<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>.stack); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { response = JSON.parse(response); displayTalks(response.talks); lastServerTime = response.serverTime; waitForChanges(); } }); }</code> <br> <br>    ,   ,     ,  ,    .    ,    reportError,             .       (  ),      <span class="hljs-number"><span class="hljs-number">2.5</span></span> . <br> <br>   ,     ,  lastServerTime ,    ,           .    ,    . <br> <br>    ,        localhost:<span class="hljs-number"><span class="hljs-number">8000</span></span>,  ,  ,     ,    . <br> <br>  <br>      ,    .    , ,   <a href=""> </a>   <a href="http://nodejs.org/">Node.js</a> . <br> <br>     <br>      .     ,      . <br> <br>     ,            .    ,    . <br> <br>    <br>      ,       DOM   ,   .   .     -         ,          ,      ,      ,  . <br> <br>   ,        ,    .    ,   ? <br> <br>   <br>    ,     .         ,   <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>,    ,  . <br> <br>           ,   (<span class="hljs-string"><span class="hljs-string">"comment"</span></span>)     .      ‚Äútalk‚Äù,     ,    comments,    ,   ,    . <br> <br>     : <br> <br> <code class="html">&lt;div class=<span class="hljs-string"><span class="hljs-string">"comments"</span></span>&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"comment"</span></span> template-<span class="hljs-keyword"><span class="hljs-keyword">repeat</span></span>=<span class="hljs-string"><span class="hljs-string">"comments"</span></span>&gt; &lt;span class=<span class="hljs-string"><span class="hljs-string">"name"</span></span>&gt;{{author}}&lt;/span&gt;: {{message}} &lt;/div&gt; &lt;/div&gt;</code> <br> <br>   :       template-<span class="hljs-keyword"><span class="hljs-keyword">repeat</span></span>,  ,     ,   ,   ,   .   ( values  instantiateTemplate)          ,   {{author}}     comment,    . <br> <br>  instantiateTemplate ,    ,    ,     ,          drawTalk. <br> <br>       ,      ,     <span class="hljs-literal"><span class="hljs-literal">true</span></span>  <span class="hljs-literal"><span class="hljs-literal">false</span></span>? <br> <br>    ? <br>  -       JavaScript,     .   - . <br> <br>   -     JavaScript.       ,      .         . <br> <br>   ,   -          JavaScript.     ,       .       ,     . <br> <br>     .    .          ,  ,    ?</code></code></code> </pre> <code><code class="html">  ID ‚Äútalks‚Äù    .   ,      . <br> <br>       . <br> <br> &lt;form id="newtalk"&gt; &lt;h3&gt;Submit a talk&lt;/h3&gt; : &lt;input type="text" style="width: 40em" name="title"&gt; &lt;br&gt; Summary: &lt;input type="text" style="width: 40em" name="summary"&gt; &lt;button type="submit"&gt; &lt;/button&gt; &lt;/form&gt;</code> <br> <br>     ‚Äúsubmit‚Äù  ,      HTTP-,    . <br> <br>    ,    display   none,       . ,   ? <br> <br> <code class="html">&lt;div id="template" style="display: none"&gt; &lt;div class="talk"&gt; &lt;h2&gt;{{title}}&lt;/h2&gt; &lt;div&gt;by &lt;span class="name"&gt;{{presenter}}&lt;/span&gt;&lt;/div&gt; &lt;p&gt;{{summary}}&lt;/p&gt; &lt;div class="comments"&gt;&lt;/div&gt; &lt;form&gt; &lt;input type="text" name="comment"&gt; &lt;button type="submit"&gt; &lt;/button&gt; &lt;button type="button" class="del"&gt; &lt;/button&gt; &lt;/form&gt; &lt;/div&gt; &lt;div class="comment"&gt; &lt;span class="name"&gt;{{author}}&lt;/span&gt;: {{message}} &lt;/div&gt; &lt;/div&gt;</code> <br> <br>    DOM  JavaScript    .          elt   13,       ,  HTML,   -      DOM-. <br> <br>   DOM-   ,      ,    ,   ,     ‚Äì             . <br> <br>  , HTML   ,   . <br> <br> <code class="html">&lt;script src="skillsharing_client.js"&gt;&lt;/script&gt;</code> <br> <br>  <br> ,       ,       .       HTTP-,      XMLHttpRequest,            . <br> <br> <code class="javascript">function request(options, callback) { var req = new XMLHttpRequest(); req.open(options.method || "GET", options.pathname, true); req.addEventListener("load", function() { if (req.status &lt; 400) callback(null, req.responseText); else callback(new Error("Request failed: " + req.statusText)); }); req.addEventListener("error", function() { callback(new Error("Network error")); }); req.send(options.body || null); }</code> <br> <br>            ,  waitForChanges. <br> <br> <code class="javascript">var lastServerTime = 0; request({pathname: "talks"}, function(error, response) { if (error) { reportError(error); } else { response = JSON.parse(response); displayTalks(response.talks); lastServerTime = response.serverTime; waitForChanges(); } });</code> <br> <br>  lastServerTime      ,   .   ,        ,       .  ,  serverTime,   ,     lastServerTime. <br> <br>    ,   ,        .       reportError,      ,   . <br> <br> <code class="javascript">function reportError(error) { if (error) alert(error.toString()); }</code> <br> <br>  ,   ,       .  ,           ,     .      ,      . <br> <br>   <br>         ,    ,    . ,     ,     ,        .  ,      ,   DOM    . <br> <br>  displayTalks      ,       .     shownTalks,      DOM,   ,     . <br> <br> <code class="javascript">var talkDiv = document.querySelector("#talks"); var shownTalks = Object.create(null); function displayTalks(talks) { talks.forEach(function(talk) { var shown = shownTalks[talk.title]; if (talk.deleted) { if (shown) { talkDiv.removeChild(shown); delete shownTalks[talk.title]; } } else { var node = drawTalk(talk); if (shown) talkDiv.replaceChild(node, shown); else talkDiv.appendChild(node); shownTalks[talk.title] = node; } }); }</code> <br> <br>  DOM     ,   HTML .    instantiateTemplate,     . <br> <br>  name ‚Äì  .    ,   ,        ,       ID ‚Äútemplate‚Äù.  querySelector   .     ‚Äútalk‚Äù  ‚Äúcomment‚Äù. <br> <br> <code class="javascript">function instantiateTemplate(name, values) { function instantiateText(text) { return text.replace(/\{\{(\w+)\}\}/g, function(_, name) { return values[name]; }); } function instantiate(node) { if (node.nodeType == document.ELEMENT_NODE) { var copy = node.cloneNode(); for (var i = 0; i &lt; node.childNodes.length; i++) copy.appendChild(instantiate(node.childNodes[i])); return copy; } else if (node.nodeType == document.TEXT_NODE) { return document.createTextNode( instantiateText(node.nodeValue)); } } var template = document.querySelector("#template ." + name); return instantiate(template); }</code> <br> <br>  cloneNode,      DOM,   .     ,       true.  instantiate    ,     . <br> <br>   instantiateTemplate   ,    ,     .   {{title}}     ‚Äútitle‚Äù. <br> <br>      ,    drawTalk   . <br> <br> <code class="javascript">function drawTalk(talk) { var node = instantiateTemplate("talk", talk); var comments = node.querySelector(".comments"); talk.comments.forEach(function(comment) { comments.appendChild( instantiateTemplate("comment", comment)); }); node.querySelector("button.del").addEventListener( "click", deleteTalk.bind(null, talk.title)); var form = node.querySelector("form"); form.addEventListener("submit", function(event) { event.preventDefault(); addComment(talk.title, form.elements.comment.value); form.reset(); }); return node; }</code> <br> <br>     ‚Äútalk‚Äù    . -,   ,     ‚Äúcomment‚Äù       "comments". ,      ,      ,  . <br> <br>   <br>  ,   drawTalk,   deleteTalk  addComment   ,       .      URL,       ,       talkURL. <br> <br> <code class="javascript">function talkURL(title) { return "talks/" + encodeURIComponent(title); }</code> <br> <br>  deleteTalk   DELETE       . <br> <br> <code class="javascript">function deleteTalk(title) { request({pathname: talkURL(title), method: "DELETE"}, reportError); }</code> <br> <br>          JSON      POST-. <br> <br> <code class="javascript">function addComment(title, comment) { var comment = {author: nameField.value, message: comment}; request({pathname: talkURL(title) + "/comments", body: JSON.stringify(comment), method: "POST"}, reportError); }</code> <br> <br>  nameField,      author,    <code><code class="javascript">  ,      .       localStorage,          . <br> <br> var nameField = document.querySelector("#name"); nameField.value = localStorage.getItem("name") || ""; nameField.addEventListener("change", function() { localStorage.setItem("name", nameField.value); });           ‚Äúsubmit‚Äù.       (     ),     PUT-   . var talkForm = document.querySelector("#newtalk"); talkForm.addEventListener("submit", function(event) { event.preventDefault(); request({pathname: talkURL(talkForm.elements.title.value), method: "PUT", body: JSON.stringify({ presenter: nameField.value, summary: talkForm.elements.summary.value })}, reportError); talkForm.reset(); });</code> <br> <br>   <br>  ,   ,   ,    ,     ,     ,       .    -       ,     . <br> <br>       ,    displayTalks    ,     ,       . <br> <br> <code class="javascript">function waitForChanges() { request({pathname: "talks?changesSince=" + lastServerTime}, function(error, response) { if (error) { setTimeout(waitForChanges, 2500); console.error(error.stack); } else { response = JSON.parse(response); displayTalks(response.talks); lastServerTime = response.serverTime; waitForChanges(); } }); }</code> <br> <br>    ,   ,     ,  ,    .    ,    reportError,             .       (  ),      2.5 . <br> <br>   ,     ,  lastServerTime ,    ,           .    ,    . <br> <br>    ,        localhost:8000,  ,  ,     ,    . <br> <br>  <br>      ,    .    , ,   <a href=""> </a>   <a href="http://nodejs.org/">Node.js</a> . <br> <br>     <br>      .     ,      . <br> <br>     ,            .    ,    . <br> <br>    <br>      ,       DOM   ,   .   .     -         ,          ,      ,      ,  . <br> <br>   ,        ,    .    ,   ? <br> <br>   <br>    ,     .         ,   if,    ,  . <br> <br>           ,   ("comment")     .      ‚Äútalk‚Äù,     ,    comments,    ,   ,    . <br> <br>     : <br> <br> <code class="html">&lt;div class="comments"&gt; &lt;div class="comment" template-repeat="comments"&gt; &lt;span class="name"&gt;{{author}}&lt;/span&gt;: {{message}} &lt;/div&gt; &lt;/div&gt;</code> <br> <br>   :       template-repeat,  ,     ,   ,   ,   .   ( values  instantiateTemplate)          ,   {{author}}     comment,    . <br> <br>  instantiateTemplate ,    ,    ,     ,          drawTalk. <br> <br>       ,      ,     true  false? <br> <br>    ? <br>  -       JavaScript,     .   - . <br> <br>   -     JavaScript.       ,      .         . <br> <br>   ,   -          JavaScript.     ,       .       ,     . <br> <br>     .    .          ,  ,    ?</code></code> <h4> <code><code class="html">  ID ‚Äútalks‚Äù    .   ,      . <br> <br>       . <br> <br> &lt;form id="newtalk"&gt; &lt;h3&gt;Submit a talk&lt;/h3&gt; : &lt;input type="text" style="width: 40em" name="title"&gt; &lt;br&gt; Summary: &lt;input type="text" style="width: 40em" name="summary"&gt; &lt;button type="submit"&gt; &lt;/button&gt; &lt;/form&gt;</code> <br> <br>     ‚Äúsubmit‚Äù  ,      HTTP-,    . <br> <br>    ,    display   none,       . ,   ? <br> <br> <code class="html">&lt;div id="template" style="display: none"&gt; &lt;div class="talk"&gt; &lt;h2&gt;{{title}}&lt;/h2&gt; &lt;div&gt;by &lt;span class="name"&gt;{{presenter}}&lt;/span&gt;&lt;/div&gt; &lt;p&gt;{{summary}}&lt;/p&gt; &lt;div class="comments"&gt;&lt;/div&gt; &lt;form&gt; &lt;input type="text" name="comment"&gt; &lt;button type="submit"&gt; &lt;/button&gt; &lt;button type="button" class="del"&gt; &lt;/button&gt; &lt;/form&gt; &lt;/div&gt; &lt;div class="comment"&gt; &lt;span class="name"&gt;{{author}}&lt;/span&gt;: {{message}} &lt;/div&gt; &lt;/div&gt;</code> <br> <br>    DOM  JavaScript    .          elt   13,       ,  HTML,   -      DOM-. <br> <br>   DOM-   ,      ,    ,   ,     ‚Äì             . <br> <br>  , HTML   ,   . <br> <br> <code class="html">&lt;script src="skillsharing_client.js"&gt;&lt;/script&gt;</code> <br> <br>  <br> ,       ,       .       HTTP-,      XMLHttpRequest,            . <br> <br> <code class="javascript">function request(options, callback) { var req = new XMLHttpRequest(); req.open(options.method || "GET", options.pathname, true); req.addEventListener("load", function() { if (req.status &lt; 400) callback(null, req.responseText); else callback(new Error("Request failed: " + req.statusText)); }); req.addEventListener("error", function() { callback(new Error("Network error")); }); req.send(options.body || null); }</code> <br> <br>            ,  waitForChanges. <br> <br> <code class="javascript">var lastServerTime = 0; request({pathname: "talks"}, function(error, response) { if (error) { reportError(error); } else { response = JSON.parse(response); displayTalks(response.talks); lastServerTime = response.serverTime; waitForChanges(); } });</code> <br> <br>  lastServerTime      ,   .   ,        ,       .  ,  serverTime,   ,     lastServerTime. <br> <br>    ,   ,        .       reportError,      ,   . <br> <br> <code class="javascript">function reportError(error) { if (error) alert(error.toString()); }</code> <br> <br>  ,   ,       .  ,           ,     .      ,      . <br> <br>   <br>         ,    ,    . ,     ,     ,        .  ,      ,   DOM    . <br> <br>  displayTalks      ,       .     shownTalks,      DOM,   ,     . <br> <br> <code class="javascript">var talkDiv = document.querySelector("#talks"); var shownTalks = Object.create(null); function displayTalks(talks) { talks.forEach(function(talk) { var shown = shownTalks[talk.title]; if (talk.deleted) { if (shown) { talkDiv.removeChild(shown); delete shownTalks[talk.title]; } } else { var node = drawTalk(talk); if (shown) talkDiv.replaceChild(node, shown); else talkDiv.appendChild(node); shownTalks[talk.title] = node; } }); }</code> <br> <br>  DOM     ,   HTML .    instantiateTemplate,     . <br> <br>  name ‚Äì  .    ,   ,        ,       ID ‚Äútemplate‚Äù.  querySelector   .     ‚Äútalk‚Äù  ‚Äúcomment‚Äù. <br> <br> <code class="javascript">function instantiateTemplate(name, values) { function instantiateText(text) { return text.replace(/\{\{(\w+)\}\}/g, function(_, name) { return values[name]; }); } function instantiate(node) { if (node.nodeType == document.ELEMENT_NODE) { var copy = node.cloneNode(); for (var i = 0; i &lt; node.childNodes.length; i++) copy.appendChild(instantiate(node.childNodes[i])); return copy; } else if (node.nodeType == document.TEXT_NODE) { return document.createTextNode( instantiateText(node.nodeValue)); } } var template = document.querySelector("#template ." + name); return instantiate(template); }</code> <br> <br>  cloneNode,      DOM,   .     ,       true.  instantiate    ,     . <br> <br>   instantiateTemplate   ,    ,     .   {{title}}     ‚Äútitle‚Äù. <br> <br>      ,    drawTalk   . <br> <br> <code class="javascript">function drawTalk(talk) { var node = instantiateTemplate("talk", talk); var comments = node.querySelector(".comments"); talk.comments.forEach(function(comment) { comments.appendChild( instantiateTemplate("comment", comment)); }); node.querySelector("button.del").addEventListener( "click", deleteTalk.bind(null, talk.title)); var form = node.querySelector("form"); form.addEventListener("submit", function(event) { event.preventDefault(); addComment(talk.title, form.elements.comment.value); form.reset(); }); return node; }</code> <br> <br>     ‚Äútalk‚Äù    . -,   ,     ‚Äúcomment‚Äù       "comments". ,      ,      ,  . <br> <br>   <br>  ,   drawTalk,   deleteTalk  addComment   ,       .      URL,       ,       talkURL. <br> <br> <code class="javascript">function talkURL(title) { return "talks/" + encodeURIComponent(title); }</code> <br> <br>  deleteTalk   DELETE       . <br> <br> <code class="javascript">function deleteTalk(title) { request({pathname: talkURL(title), method: "DELETE"}, reportError); }</code> <br> <br>          JSON      POST-. <br> <br> <code class="javascript">function addComment(title, comment) { var comment = {author: nameField.value, message: comment}; request({pathname: talkURL(title) + "/comments", body: JSON.stringify(comment), method: "POST"}, reportError); }</code> <br> <br>  nameField,      author,    <code><code class="javascript">  ,      .       localStorage,          . <br> <br> var nameField = document.querySelector("#name"); nameField.value = localStorage.getItem("name") || ""; nameField.addEventListener("change", function() { localStorage.setItem("name", nameField.value); });           ‚Äúsubmit‚Äù.       (     ),     PUT-   . var talkForm = document.querySelector("#newtalk"); talkForm.addEventListener("submit", function(event) { event.preventDefault(); request({pathname: talkURL(talkForm.elements.title.value), method: "PUT", body: JSON.stringify({ presenter: nameField.value, summary: talkForm.elements.summary.value })}, reportError); talkForm.reset(); });</code> <br> <br>   <br>  ,   ,   ,    ,     ,     ,       .    -       ,     . <br> <br>       ,    displayTalks    ,     ,       . <br> <br> <code class="javascript">function waitForChanges() { request({pathname: "talks?changesSince=" + lastServerTime}, function(error, response) { if (error) { setTimeout(waitForChanges, 2500); console.error(error.stack); } else { response = JSON.parse(response); displayTalks(response.talks); lastServerTime = response.serverTime; waitForChanges(); } }); }</code> <br> <br>    ,   ,     ,  ,    .    ,    reportError,             .       (  ),      2.5 . <br> <br>   ,     ,  lastServerTime ,    ,           .    ,    . <br> <br>    ,        localhost:8000,  ,  ,     ,    . <br> <br>  <br>      ,    .    , ,   <a href=""> </a>   <a href="http://nodejs.org/">Node.js</a> . <br> <br>     <br>      .     ,      . <br> <br>     ,            .    ,    . <br> <br>    <br>      ,       DOM   ,   .   .     -         ,          ,      ,      ,  . <br> <br>   ,        ,    .    ,   ? <br> <br>   <br>    ,     .         ,   if,    ,  . <br> <br>           ,   ("comment")     .      ‚Äútalk‚Äù,     ,    comments,    ,   ,    . <br> <br>     : <br> <br> <code class="html">&lt;div class="comments"&gt; &lt;div class="comment" template-repeat="comments"&gt; &lt;span class="name"&gt;{{author}}&lt;/span&gt;: {{message}} &lt;/div&gt; &lt;/div&gt;</code> <br> <br>   :       template-repeat,  ,     ,   ,   ,   .   ( values  instantiateTemplate)          ,   {{author}}     comment,    . <br> <br>  instantiateTemplate ,    ,    ,     ,          drawTalk. <br> <br>       ,      ,     true  false? <br> <br>    ? <br>  -       JavaScript,     .   - . <br> <br>   -     JavaScript.       ,      .         . <br> <br>   ,   -          JavaScript.     ,       .       ,     . <br> <br>     .    .          ,  ,    ?</code></code> </h4> <code><code class="html">  ID ‚Äútalks‚Äù    .   ,      . <br> <br>       . <br> <br> &lt;form id="newtalk"&gt; &lt;h3&gt;Submit a talk&lt;/h3&gt; : &lt;input type="text" style="width: 40em" name="title"&gt; &lt;br&gt; Summary: &lt;input type="text" style="width: 40em" name="summary"&gt; &lt;button type="submit"&gt; &lt;/button&gt; &lt;/form&gt;</code> <br> <br>     ‚Äúsubmit‚Äù  ,      HTTP-,    . <br> <br>    ,    display   none,       . ,   ? <br> <br> <code class="html">&lt;div id="template" style="display: none"&gt; &lt;div class="talk"&gt; &lt;h2&gt;{{title}}&lt;/h2&gt; &lt;div&gt;by &lt;span class="name"&gt;{{presenter}}&lt;/span&gt;&lt;/div&gt; &lt;p&gt;{{summary}}&lt;/p&gt; &lt;div class="comments"&gt;&lt;/div&gt; &lt;form&gt; &lt;input type="text" name="comment"&gt; &lt;button type="submit"&gt; &lt;/button&gt; &lt;button type="button" class="del"&gt; &lt;/button&gt; &lt;/form&gt; &lt;/div&gt; &lt;div class="comment"&gt; &lt;span class="name"&gt;{{author}}&lt;/span&gt;: {{message}} &lt;/div&gt; &lt;/div&gt;</code> <br> <br>    DOM  JavaScript    .          elt   13,       ,  HTML,   -      DOM-. <br> <br>   DOM-   ,      ,    ,   ,     ‚Äì             . <br> <br>  , HTML   ,   . <br> <br> <code class="html">&lt;script src="skillsharing_client.js"&gt;&lt;/script&gt;</code> <br> <br>  <br> ,       ,       .       HTTP-,      XMLHttpRequest,            . <br> <br> <code class="javascript">function request(options, callback) { var req = new XMLHttpRequest(); req.open(options.method || "GET", options.pathname, true); req.addEventListener("load", function() { if (req.status &lt; 400) callback(null, req.responseText); else callback(new Error("Request failed: " + req.statusText)); }); req.addEventListener("error", function() { callback(new Error("Network error")); }); req.send(options.body || null); }</code> <br> <br>            ,  waitForChanges. <br> <br> <code class="javascript">var lastServerTime = 0; request({pathname: "talks"}, function(error, response) { if (error) { reportError(error); } else { response = JSON.parse(response); displayTalks(response.talks); lastServerTime = response.serverTime; waitForChanges(); } });</code> <br> <br>  lastServerTime      ,   .   ,        ,       .  ,  serverTime,   ,     lastServerTime. <br> <br>    ,   ,        .       reportError,      ,   . <br> <br> <code class="javascript">function reportError(error) { if (error) alert(error.toString()); }</code> <br> <br>  ,   ,       .  ,           ,     .      ,      . <br> <br>   <br>         ,    ,    . ,     ,     ,        .  ,      ,   DOM    . <br> <br>  displayTalks      ,       .     shownTalks,      DOM,   ,     . <br> <br> <code class="javascript">var talkDiv = document.querySelector("#talks"); var shownTalks = Object.create(null); function displayTalks(talks) { talks.forEach(function(talk) { var shown = shownTalks[talk.title]; if (talk.deleted) { if (shown) { talkDiv.removeChild(shown); delete shownTalks[talk.title]; } } else { var node = drawTalk(talk); if (shown) talkDiv.replaceChild(node, shown); else talkDiv.appendChild(node); shownTalks[talk.title] = node; } }); }</code> <br> <br>  DOM     ,   HTML .    instantiateTemplate,     . <br> <br>  name ‚Äì  .    ,   ,        ,       ID ‚Äútemplate‚Äù.  querySelector   .     ‚Äútalk‚Äù  ‚Äúcomment‚Äù. <br> <br> <code class="javascript">function instantiateTemplate(name, values) { function instantiateText(text) { return text.replace(/\{\{(\w+)\}\}/g, function(_, name) { return values[name]; }); } function instantiate(node) { if (node.nodeType == document.ELEMENT_NODE) { var copy = node.cloneNode(); for (var i = 0; i &lt; node.childNodes.length; i++) copy.appendChild(instantiate(node.childNodes[i])); return copy; } else if (node.nodeType == document.TEXT_NODE) { return document.createTextNode( instantiateText(node.nodeValue)); } } var template = document.querySelector("#template ." + name); return instantiate(template); }</code> <br> <br>  cloneNode,      DOM,   .     ,       true.  instantiate    ,     . <br> <br>   instantiateTemplate   ,    ,     .   {{title}}     ‚Äútitle‚Äù. <br> <br>      ,    drawTalk   . <br> <br> <code class="javascript">function drawTalk(talk) { var node = instantiateTemplate("talk", talk); var comments = node.querySelector(".comments"); talk.comments.forEach(function(comment) { comments.appendChild( instantiateTemplate("comment", comment)); }); node.querySelector("button.del").addEventListener( "click", deleteTalk.bind(null, talk.title)); var form = node.querySelector("form"); form.addEventListener("submit", function(event) { event.preventDefault(); addComment(talk.title, form.elements.comment.value); form.reset(); }); return node; }</code> <br> <br>     ‚Äútalk‚Äù    . -,   ,     ‚Äúcomment‚Äù       "comments". ,      ,      ,  . <br> <br>   <br>  ,   drawTalk,   deleteTalk  addComment   ,       .      URL,       ,       talkURL. <br> <br> <code class="javascript">function talkURL(title) { return "talks/" + encodeURIComponent(title); }</code> <br> <br>  deleteTalk   DELETE       . <br> <br> <code class="javascript">function deleteTalk(title) { request({pathname: talkURL(title), method: "DELETE"}, reportError); }</code> <br> <br>          JSON      POST-. <br> <br> <code class="javascript">function addComment(title, comment) { var comment = {author: nameField.value, message: comment}; request({pathname: talkURL(title) + "/comments", body: JSON.stringify(comment), method: "POST"}, reportError); }</code> <br> <br>  nameField,      author,    <code><code class="javascript">  ,      .       localStorage,          . <br> <br> var nameField = document.querySelector("#name"); nameField.value = localStorage.getItem("name") || ""; nameField.addEventListener("change", function() { localStorage.setItem("name", nameField.value); });           ‚Äúsubmit‚Äù.       (     ),     PUT-   . var talkForm = document.querySelector("#newtalk"); talkForm.addEventListener("submit", function(event) { event.preventDefault(); request({pathname: talkURL(talkForm.elements.title.value), method: "PUT", body: JSON.stringify({ presenter: nameField.value, summary: talkForm.elements.summary.value })}, reportError); talkForm.reset(); });</code> <br> <br>   <br>  ,   ,   ,    ,     ,     ,       .    -       ,     . <br> <br>       ,    displayTalks    ,     ,       . <br> <br> <code class="javascript">function waitForChanges() { request({pathname: "talks?changesSince=" + lastServerTime}, function(error, response) { if (error) { setTimeout(waitForChanges, 2500); console.error(error.stack); } else { response = JSON.parse(response); displayTalks(response.talks); lastServerTime = response.serverTime; waitForChanges(); } }); }</code> <br> <br>    ,   ,     ,  ,    .    ,    reportError,             .       (  ),      2.5 . <br> <br>   ,     ,  lastServerTime ,    ,           .    ,    . <br> <br>    ,        localhost:8000,  ,  ,     ,    . <br> <br>  <br>      ,    .    , ,   <a href=""> </a>   <a href="http://nodejs.org/">Node.js</a> . <br> <br>     <br>      .     ,      . <br> <br>     ,            .    ,    . <br> <br>    <br>      ,       DOM   ,   .   .     -         ,          ,      ,      ,  . <br> <br>   ,        ,    .    ,   ? <br> <br>   <br>    ,     .         ,   if,    ,  . <br> <br>           ,   ("comment")     .      ‚Äútalk‚Äù,     ,    comments,    ,   ,    . <br> <br>     : <br> <br> <code class="html">&lt;div class="comments"&gt; &lt;div class="comment" template-repeat="comments"&gt; &lt;span class="name"&gt;{{author}}&lt;/span&gt;: {{message}} &lt;/div&gt; &lt;/div&gt;</code> <br> <br>   :       template-repeat,  ,     ,   ,   ,   .   ( values  instantiateTemplate)          ,   {{author}}     comment,    . <br> <br>  instantiateTemplate ,    ,    ,     ,          drawTalk. <br> <br>       ,      ,     true  false? <br> <br>    ? <br>  -       JavaScript,     .   - . <br> <br>   -     JavaScript.       ,      .         . <br> <br>   ,   -          JavaScript.     ,       .       ,     . <br> <br>     .    .          ,  ,    ?</code></code> <pre> <code class="hljs lua"><code class="html">  ID ‚Äútalks‚Äù    .   ,      . <br> <br>       . <br> <br> &lt;form id=<span class="hljs-string"><span class="hljs-string">"newtalk"</span></span>&gt; &lt;h3&gt;Submit a talk&lt;/h3&gt; : &lt;<span class="hljs-built_in"><span class="hljs-built_in">input</span></span> <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=<span class="hljs-string"><span class="hljs-string">"text"</span></span> style=<span class="hljs-string"><span class="hljs-string">"width: 40em"</span></span> name=<span class="hljs-string"><span class="hljs-string">"title"</span></span>&gt; &lt;br&gt; Summary: &lt;<span class="hljs-built_in"><span class="hljs-built_in">input</span></span> <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=<span class="hljs-string"><span class="hljs-string">"text"</span></span> style=<span class="hljs-string"><span class="hljs-string">"width: 40em"</span></span> name=<span class="hljs-string"><span class="hljs-string">"summary"</span></span>&gt; &lt;button <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=<span class="hljs-string"><span class="hljs-string">"submit"</span></span>&gt; &lt;/button&gt; &lt;/form&gt;</code> <br> <br>     ‚Äúsubmit‚Äù  ,      HTTP-,    . <br> <br>    ,    display   none,       . ,   ? <br> <br> <code class="html">&lt;div id=<span class="hljs-string"><span class="hljs-string">"template"</span></span> style=<span class="hljs-string"><span class="hljs-string">"display: none"</span></span>&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"talk"</span></span>&gt; &lt;h2&gt;{{title}}&lt;/h2&gt; &lt;div&gt;by &lt;span class=<span class="hljs-string"><span class="hljs-string">"name"</span></span>&gt;{{presenter}}&lt;/span&gt;&lt;/div&gt; &lt;p&gt;{{summary}}&lt;/p&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"comments"</span></span>&gt;&lt;/div&gt; &lt;form&gt; &lt;<span class="hljs-built_in"><span class="hljs-built_in">input</span></span> <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=<span class="hljs-string"><span class="hljs-string">"text"</span></span> name=<span class="hljs-string"><span class="hljs-string">"comment"</span></span>&gt; &lt;button <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=<span class="hljs-string"><span class="hljs-string">"submit"</span></span>&gt; &lt;/button&gt; &lt;button <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=<span class="hljs-string"><span class="hljs-string">"button"</span></span> class=<span class="hljs-string"><span class="hljs-string">"del"</span></span>&gt; &lt;/button&gt; &lt;/form&gt; &lt;/div&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"comment"</span></span>&gt; &lt;span class=<span class="hljs-string"><span class="hljs-string">"name"</span></span>&gt;{{author}}&lt;/span&gt;: {{message}} &lt;/div&gt; &lt;/div&gt;</code> <br> <br>    DOM  JavaScript    .          elt   <span class="hljs-number"><span class="hljs-number">13</span></span>,       ,  HTML,   -      DOM-. <br> <br>   DOM-   ,      ,    ,   ,     ‚Äì             . <br> <br>  , HTML   ,   . <br> <br> <code class="html">&lt;script src=<span class="hljs-string"><span class="hljs-string">"skillsharing_client.js"</span></span>&gt;&lt;/script&gt;</code> <br> <br>  <br> ,       ,       .       HTTP-,      XMLHttpRequest,            . <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">request</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(options, callback)</span></span></span></span> { var req = new XMLHttpRequest(); req.<span class="hljs-built_in"><span class="hljs-built_in">open</span></span>(options.method || <span class="hljs-string"><span class="hljs-string">"GET"</span></span>, options.pathname, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); req.addEventListener(<span class="hljs-string"><span class="hljs-string">"load"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (req.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> &lt; <span class="hljs-number"><span class="hljs-number">400</span></span>) callback(null, req.responseText); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> callback(new Error(<span class="hljs-string"><span class="hljs-string">"Request failed: "</span></span> + req.statusText)); }); req.addEventListener(<span class="hljs-string"><span class="hljs-string">"error"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { callback(new Error(<span class="hljs-string"><span class="hljs-string">"Network error"</span></span>)); }); req.send(options.body || null); }</code> <br> <br>            ,  waitForChanges. <br> <br> <code class="javascript">var lastServerTime = <span class="hljs-number"><span class="hljs-number">0</span></span>; request({pathname: <span class="hljs-string"><span class="hljs-string">"talks"</span></span>}, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(error, response)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>) { reportError(<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { response = JSON.parse(response); displayTalks(response.talks); lastServerTime = response.serverTime; waitForChanges(); } });</code> <br> <br>  lastServerTime      ,   .   ,        ,       .  ,  serverTime,   ,     lastServerTime. <br> <br>    ,   ,        .       reportError,      ,   . <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">reportError</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(error)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>) alert(<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>.toString()); }</code> <br> <br>  ,   ,       .  ,           ,     .      ,      . <br> <br>   <br>         ,    ,    . ,     ,     ,        .  ,      ,   DOM    . <br> <br>  displayTalks      ,       .     shownTalks,      DOM,   ,     . <br> <br> <code class="javascript">var talkDiv = document.querySelector(<span class="hljs-string"><span class="hljs-string">"#talks"</span></span>); var shownTalks = Object.<span class="hljs-built_in"><span class="hljs-built_in">create</span></span>(null); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">displayTalks</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(talks)</span></span></span></span> { talks.forEach(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(talk)</span></span></span></span> { var shown = shownTalks[talk.title]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (talk.deleted) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (shown) { talkDiv.removeChild(shown); delete shownTalks[talk.title]; } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { var node = drawTalk(talk); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (shown) talkDiv.replaceChild(node, shown); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> talkDiv.appendChild(node); shownTalks[talk.title] = node; } }); }</code> <br> <br>  DOM     ,   HTML .    instantiateTemplate,     . <br> <br>  name ‚Äì  .    ,   ,        ,       ID ‚Äútemplate‚Äù.  querySelector   .     ‚Äútalk‚Äù  ‚Äúcomment‚Äù. <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">instantiateTemplate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(name, values)</span></span></span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">instantiateText</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(text)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> text.replace(/\{\{(\w+)\}\}/g, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(_, name)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> values[name]; }); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">instantiate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(node)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (node.nodeType == document.ELEMENT_NODE) { var copy = node.cloneNode(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (var i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; node.childNodes.length; i++) copy.appendChild(instantiate(node.childNodes[i])); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> copy; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (node.nodeType == document.TEXT_NODE) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> document.createTextNode( instantiateText(node.nodeValue)); } } var template = document.querySelector(<span class="hljs-string"><span class="hljs-string">"#template ."</span></span> + name); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> instantiate(template); }</code> <br> <br>  cloneNode,      DOM,   .     ,       <span class="hljs-literal"><span class="hljs-literal">true</span></span>.  instantiate    ,     . <br> <br>   instantiateTemplate   ,    ,     .   {{title}}     ‚Äútitle‚Äù. <br> <br>      ,    drawTalk   . <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">drawTalk</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(talk)</span></span></span></span> { var node = instantiateTemplate(<span class="hljs-string"><span class="hljs-string">"talk"</span></span>, talk); var comments = node.querySelector(<span class="hljs-string"><span class="hljs-string">".comments"</span></span>); talk.comments.forEach(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(comment)</span></span></span></span> { comments.appendChild( instantiateTemplate(<span class="hljs-string"><span class="hljs-string">"comment"</span></span>, comment)); }); node.querySelector(<span class="hljs-string"><span class="hljs-string">"button.del"</span></span>).addEventListener( <span class="hljs-string"><span class="hljs-string">"click"</span></span>, deleteTalk.bind(null, talk.title)); var form = node.querySelector(<span class="hljs-string"><span class="hljs-string">"form"</span></span>); form.addEventListener(<span class="hljs-string"><span class="hljs-string">"submit"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(event)</span></span></span></span> { event.preventDefault(); addComment(talk.title, form.elements.comment.value); form.reset(); }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> node; }</code> <br> <br>     ‚Äútalk‚Äù    . -,   ,     ‚Äúcomment‚Äù       <span class="hljs-string"><span class="hljs-string">"comments"</span></span>. ,      ,      ,  . <br> <br>   <br>  ,   drawTalk,   deleteTalk  addComment   ,       .      URL,       ,       talkURL. <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">talkURL</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(title)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"talks/"</span></span> + encodeURIComponent(title); }</code> <br> <br>  deleteTalk   DELETE       . <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">deleteTalk</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(title)</span></span></span></span> { request({pathname: talkURL(title), method: <span class="hljs-string"><span class="hljs-string">"DELETE"</span></span>}, reportError); }</code> <br> <br>          JSON      POST-. <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">addComment</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(title, comment)</span></span></span></span> { var comment = {author: nameField.value, message: comment}; request({pathname: talkURL(title) + <span class="hljs-string"><span class="hljs-string">"/comments"</span></span>, body: JSON.stringify(comment), method: <span class="hljs-string"><span class="hljs-string">"POST"</span></span>}, reportError); }</code> <br> <br>  nameField,      author,    <code><code class="javascript">  ,      .       localStorage,          . <br> <br> var nameField = document.querySelector(<span class="hljs-string"><span class="hljs-string">"#name"</span></span>); nameField.value = localStorage.getItem(<span class="hljs-string"><span class="hljs-string">"name"</span></span>) || <span class="hljs-string"><span class="hljs-string">""</span></span>; nameField.addEventListener(<span class="hljs-string"><span class="hljs-string">"change"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { localStorage.setItem(<span class="hljs-string"><span class="hljs-string">"name"</span></span>, nameField.value); });           ‚Äúsubmit‚Äù.       (     ),     PUT-   . var talkForm = document.querySelector(<span class="hljs-string"><span class="hljs-string">"#newtalk"</span></span>); talkForm.addEventListener(<span class="hljs-string"><span class="hljs-string">"submit"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(event)</span></span></span></span> { event.preventDefault(); request({pathname: talkURL(talkForm.elements.title.value), method: <span class="hljs-string"><span class="hljs-string">"PUT"</span></span>, body: JSON.stringify({ presenter: nameField.value, summary: talkForm.elements.summary.value })}, reportError); talkForm.reset(); });</code> <br> <br>   <br>  ,   ,   ,    ,     ,     ,       .    -       ,     . <br> <br>       ,    displayTalks    ,     ,       . <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">waitForChanges</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { request({pathname: <span class="hljs-string"><span class="hljs-string">"talks?changesSince="</span></span> + lastServerTime}, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(error, response)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>) { setTimeout(waitForChanges, <span class="hljs-number"><span class="hljs-number">2500</span></span>); console.<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>.stack); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { response = JSON.parse(response); displayTalks(response.talks); lastServerTime = response.serverTime; waitForChanges(); } }); }</code> <br> <br>    ,   ,     ,  ,    .    ,    reportError,             .       (  ),      <span class="hljs-number"><span class="hljs-number">2.5</span></span> . <br> <br>   ,     ,  lastServerTime ,    ,           .    ,    . <br> <br>    ,        localhost:<span class="hljs-number"><span class="hljs-number">8000</span></span>,  ,  ,     ,    . <br> <br>  <br>      ,    .    , ,   <a href=""> </a>   <a href="http://nodejs.org/">Node.js</a> . <br> <br>     <br>      .     ,      . <br> <br>     ,            .    ,    . <br> <br>    <br>      ,       DOM   ,   .   .     -         ,          ,      ,      ,  . <br> <br>   ,        ,    .    ,   ? <br> <br>   <br>    ,     .         ,   <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>,    ,  . <br> <br>           ,   (<span class="hljs-string"><span class="hljs-string">"comment"</span></span>)     .      ‚Äútalk‚Äù,     ,    comments,    ,   ,    . <br> <br>     : <br> <br> <code class="html">&lt;div class=<span class="hljs-string"><span class="hljs-string">"comments"</span></span>&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"comment"</span></span> template-<span class="hljs-keyword"><span class="hljs-keyword">repeat</span></span>=<span class="hljs-string"><span class="hljs-string">"comments"</span></span>&gt; &lt;span class=<span class="hljs-string"><span class="hljs-string">"name"</span></span>&gt;{{author}}&lt;/span&gt;: {{message}} &lt;/div&gt; &lt;/div&gt;</code> <br> <br>   :       template-<span class="hljs-keyword"><span class="hljs-keyword">repeat</span></span>,  ,     ,   ,   ,   .   ( values  instantiateTemplate)          ,   {{author}}     comment,    . <br> <br>  instantiateTemplate ,    ,    ,     ,          drawTalk. <br> <br>       ,      ,     <span class="hljs-literal"><span class="hljs-literal">true</span></span>  <span class="hljs-literal"><span class="hljs-literal">false</span></span>? <br> <br>    ? <br>  -       JavaScript,     .   - . <br> <br>   -     JavaScript.       ,      .         . <br> <br>   ,   -          JavaScript.     ,       .       ,     . <br> <br>     .    .          ,  ,    ?</code></code> </pre> <code><code class="html">  ID ‚Äútalks‚Äù    .   ,      . <br> <br>       . <br> <br> &lt;form id="newtalk"&gt; &lt;h3&gt;Submit a talk&lt;/h3&gt; : &lt;input type="text" style="width: 40em" name="title"&gt; &lt;br&gt; Summary: &lt;input type="text" style="width: 40em" name="summary"&gt; &lt;button type="submit"&gt; &lt;/button&gt; &lt;/form&gt;</code> <br> <br>     ‚Äúsubmit‚Äù  ,      HTTP-,    . <br> <br>    ,    display   none,       . ,   ? <br> <br> <code class="html">&lt;div id="template" style="display: none"&gt; &lt;div class="talk"&gt; &lt;h2&gt;{{title}}&lt;/h2&gt; &lt;div&gt;by &lt;span class="name"&gt;{{presenter}}&lt;/span&gt;&lt;/div&gt; &lt;p&gt;{{summary}}&lt;/p&gt; &lt;div class="comments"&gt;&lt;/div&gt; &lt;form&gt; &lt;input type="text" name="comment"&gt; &lt;button type="submit"&gt; &lt;/button&gt; &lt;button type="button" class="del"&gt; &lt;/button&gt; &lt;/form&gt; &lt;/div&gt; &lt;div class="comment"&gt; &lt;span class="name"&gt;{{author}}&lt;/span&gt;: {{message}} &lt;/div&gt; &lt;/div&gt;</code> <br> <br>    DOM  JavaScript    .          elt   13,       ,  HTML,   -      DOM-. <br> <br>   DOM-   ,      ,    ,   ,     ‚Äì             . <br> <br>  , HTML   ,   . <br> <br> <code class="html">&lt;script src="skillsharing_client.js"&gt;&lt;/script&gt;</code> <br> <br>  <br> ,       ,       .       HTTP-,      XMLHttpRequest,            . <br> <br> <code class="javascript">function request(options, callback) { var req = new XMLHttpRequest(); req.open(options.method || "GET", options.pathname, true); req.addEventListener("load", function() { if (req.status &lt; 400) callback(null, req.responseText); else callback(new Error("Request failed: " + req.statusText)); }); req.addEventListener("error", function() { callback(new Error("Network error")); }); req.send(options.body || null); }</code> <br> <br>            ,  waitForChanges. <br> <br> <code class="javascript">var lastServerTime = 0; request({pathname: "talks"}, function(error, response) { if (error) { reportError(error); } else { response = JSON.parse(response); displayTalks(response.talks); lastServerTime = response.serverTime; waitForChanges(); } });</code> <br> <br>  lastServerTime      ,   .   ,        ,       .  ,  serverTime,   ,     lastServerTime. <br> <br>    ,   ,        .       reportError,      ,   . <br> <br> <code class="javascript">function reportError(error) { if (error) alert(error.toString()); }</code> <br> <br>  ,   ,       .  ,           ,     .      ,      . <br> <br>   <br>         ,    ,    . ,     ,     ,        .  ,      ,   DOM    . <br> <br>  displayTalks      ,       .     shownTalks,      DOM,   ,     . <br> <br> <code class="javascript">var talkDiv = document.querySelector("#talks"); var shownTalks = Object.create(null); function displayTalks(talks) { talks.forEach(function(talk) { var shown = shownTalks[talk.title]; if (talk.deleted) { if (shown) { talkDiv.removeChild(shown); delete shownTalks[talk.title]; } } else { var node = drawTalk(talk); if (shown) talkDiv.replaceChild(node, shown); else talkDiv.appendChild(node); shownTalks[talk.title] = node; } }); }</code> <br> <br>  DOM     ,   HTML .    instantiateTemplate,     . <br> <br>  name ‚Äì  .    ,   ,        ,       ID ‚Äútemplate‚Äù.  querySelector   .     ‚Äútalk‚Äù  ‚Äúcomment‚Äù. <br> <br> <code class="javascript">function instantiateTemplate(name, values) { function instantiateText(text) { return text.replace(/\{\{(\w+)\}\}/g, function(_, name) { return values[name]; }); } function instantiate(node) { if (node.nodeType == document.ELEMENT_NODE) { var copy = node.cloneNode(); for (var i = 0; i &lt; node.childNodes.length; i++) copy.appendChild(instantiate(node.childNodes[i])); return copy; } else if (node.nodeType == document.TEXT_NODE) { return document.createTextNode( instantiateText(node.nodeValue)); } } var template = document.querySelector("#template ." + name); return instantiate(template); }</code> <br> <br>  cloneNode,      DOM,   .     ,       true.  instantiate    ,     . <br> <br>   instantiateTemplate   ,    ,     .   {{title}}     ‚Äútitle‚Äù. <br> <br>      ,    drawTalk   . <br> <br> <code class="javascript">function drawTalk(talk) { var node = instantiateTemplate("talk", talk); var comments = node.querySelector(".comments"); talk.comments.forEach(function(comment) { comments.appendChild( instantiateTemplate("comment", comment)); }); node.querySelector("button.del").addEventListener( "click", deleteTalk.bind(null, talk.title)); var form = node.querySelector("form"); form.addEventListener("submit", function(event) { event.preventDefault(); addComment(talk.title, form.elements.comment.value); form.reset(); }); return node; }</code> <br> <br>     ‚Äútalk‚Äù    . -,   ,     ‚Äúcomment‚Äù       "comments". ,      ,      ,  . <br> <br>   <br>  ,   drawTalk,   deleteTalk  addComment   ,       .      URL,       ,       talkURL. <br> <br> <code class="javascript">function talkURL(title) { return "talks/" + encodeURIComponent(title); }</code> <br> <br>  deleteTalk   DELETE       . <br> <br> <code class="javascript">function deleteTalk(title) { request({pathname: talkURL(title), method: "DELETE"}, reportError); }</code> <br> <br>          JSON      POST-. <br> <br> <code class="javascript">function addComment(title, comment) { var comment = {author: nameField.value, message: comment}; request({pathname: talkURL(title) + "/comments", body: JSON.stringify(comment), method: "POST"}, reportError); }</code> <br> <br>  nameField,      author,    <code><code class="javascript">  ,      .       localStorage,          . <br> <br> var nameField = document.querySelector("#name"); nameField.value = localStorage.getItem("name") || ""; nameField.addEventListener("change", function() { localStorage.setItem("name", nameField.value); });           ‚Äúsubmit‚Äù.       (     ),     PUT-   . var talkForm = document.querySelector("#newtalk"); talkForm.addEventListener("submit", function(event) { event.preventDefault(); request({pathname: talkURL(talkForm.elements.title.value), method: "PUT", body: JSON.stringify({ presenter: nameField.value, summary: talkForm.elements.summary.value })}, reportError); talkForm.reset(); });</code> <br> <br>   <br>  ,   ,   ,    ,     ,     ,       .    -       ,     . <br> <br>       ,    displayTalks    ,     ,       . <br> <br> <code class="javascript">function waitForChanges() { request({pathname: "talks?changesSince=" + lastServerTime}, function(error, response) { if (error) { setTimeout(waitForChanges, 2500); console.error(error.stack); } else { response = JSON.parse(response); displayTalks(response.talks); lastServerTime = response.serverTime; waitForChanges(); } }); }</code> <br> <br>    ,   ,     ,  ,    .    ,    reportError,             .       (  ),      2.5 . <br> <br>   ,     ,  lastServerTime ,    ,           .    ,    . <br> <br>    ,        localhost:8000,  ,  ,     ,    . <br> <br>  <br>      ,    .    , ,   <a href=""> </a>   <a href="http://nodejs.org/">Node.js</a> . <br> <br>     <br>      .     ,      . <br> <br>     ,            .    ,    . <br> <br>    <br>      ,       DOM   ,   .   .     -         ,          ,      ,      ,  . <br> <br>   ,        ,    .    ,   ? <br> <br>   <br>    ,     .         ,   if,    ,  . <br> <br>           ,   ("comment")     .      ‚Äútalk‚Äù,     ,    comments,    ,   ,    . <br> <br>     : <br> <br> <code class="html">&lt;div class="comments"&gt; &lt;div class="comment" template-repeat="comments"&gt; &lt;span class="name"&gt;{{author}}&lt;/span&gt;: {{message}} &lt;/div&gt; &lt;/div&gt;</code> <br> <br>   :       template-repeat,  ,     ,   ,   ,   .   ( values  instantiateTemplate)          ,   {{author}}     comment,    . <br> <br>  instantiateTemplate ,    ,    ,     ,          drawTalk. <br> <br>       ,      ,     true  false? <br> <br>    ? <br>  -       JavaScript,     .   - . <br> <br>   -     JavaScript.       ,      .         . <br> <br>   ,   -          JavaScript.     ,       .       ,     . <br> <br>     .    .          ,  ,    ?</code></code> <pre> <code class="hljs lua"><code class="html">  ID ‚Äútalks‚Äù    .   ,      . <br> <br>       . <br> <br> &lt;form id=<span class="hljs-string"><span class="hljs-string">"newtalk"</span></span>&gt; &lt;h3&gt;Submit a talk&lt;/h3&gt; : &lt;<span class="hljs-built_in"><span class="hljs-built_in">input</span></span> <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=<span class="hljs-string"><span class="hljs-string">"text"</span></span> style=<span class="hljs-string"><span class="hljs-string">"width: 40em"</span></span> name=<span class="hljs-string"><span class="hljs-string">"title"</span></span>&gt; &lt;br&gt; Summary: &lt;<span class="hljs-built_in"><span class="hljs-built_in">input</span></span> <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=<span class="hljs-string"><span class="hljs-string">"text"</span></span> style=<span class="hljs-string"><span class="hljs-string">"width: 40em"</span></span> name=<span class="hljs-string"><span class="hljs-string">"summary"</span></span>&gt; &lt;button <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=<span class="hljs-string"><span class="hljs-string">"submit"</span></span>&gt; &lt;/button&gt; &lt;/form&gt;</code> <br> <br>     ‚Äúsubmit‚Äù  ,      HTTP-,    . <br> <br>    ,    display   none,       . ,   ? <br> <br> <code class="html">&lt;div id=<span class="hljs-string"><span class="hljs-string">"template"</span></span> style=<span class="hljs-string"><span class="hljs-string">"display: none"</span></span>&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"talk"</span></span>&gt; &lt;h2&gt;{{title}}&lt;/h2&gt; &lt;div&gt;by &lt;span class=<span class="hljs-string"><span class="hljs-string">"name"</span></span>&gt;{{presenter}}&lt;/span&gt;&lt;/div&gt; &lt;p&gt;{{summary}}&lt;/p&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"comments"</span></span>&gt;&lt;/div&gt; &lt;form&gt; &lt;<span class="hljs-built_in"><span class="hljs-built_in">input</span></span> <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=<span class="hljs-string"><span class="hljs-string">"text"</span></span> name=<span class="hljs-string"><span class="hljs-string">"comment"</span></span>&gt; &lt;button <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=<span class="hljs-string"><span class="hljs-string">"submit"</span></span>&gt; &lt;/button&gt; &lt;button <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=<span class="hljs-string"><span class="hljs-string">"button"</span></span> class=<span class="hljs-string"><span class="hljs-string">"del"</span></span>&gt; &lt;/button&gt; &lt;/form&gt; &lt;/div&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"comment"</span></span>&gt; &lt;span class=<span class="hljs-string"><span class="hljs-string">"name"</span></span>&gt;{{author}}&lt;/span&gt;: {{message}} &lt;/div&gt; &lt;/div&gt;</code> <br> <br>    DOM  JavaScript    .          elt   <span class="hljs-number"><span class="hljs-number">13</span></span>,       ,  HTML,   -      DOM-. <br> <br>   DOM-   ,      ,    ,   ,     ‚Äì             . <br> <br>  , HTML   ,   . <br> <br> <code class="html">&lt;script src=<span class="hljs-string"><span class="hljs-string">"skillsharing_client.js"</span></span>&gt;&lt;/script&gt;</code> <br> <br>  <br> ,       ,       .       HTTP-,      XMLHttpRequest,            . <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">request</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(options, callback)</span></span></span></span> { var req = new XMLHttpRequest(); req.<span class="hljs-built_in"><span class="hljs-built_in">open</span></span>(options.method || <span class="hljs-string"><span class="hljs-string">"GET"</span></span>, options.pathname, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); req.addEventListener(<span class="hljs-string"><span class="hljs-string">"load"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (req.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> &lt; <span class="hljs-number"><span class="hljs-number">400</span></span>) callback(null, req.responseText); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> callback(new Error(<span class="hljs-string"><span class="hljs-string">"Request failed: "</span></span> + req.statusText)); }); req.addEventListener(<span class="hljs-string"><span class="hljs-string">"error"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { callback(new Error(<span class="hljs-string"><span class="hljs-string">"Network error"</span></span>)); }); req.send(options.body || null); }</code> <br> <br>            ,  waitForChanges. <br> <br> <code class="javascript">var lastServerTime = <span class="hljs-number"><span class="hljs-number">0</span></span>; request({pathname: <span class="hljs-string"><span class="hljs-string">"talks"</span></span>}, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(error, response)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>) { reportError(<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { response = JSON.parse(response); displayTalks(response.talks); lastServerTime = response.serverTime; waitForChanges(); } });</code> <br> <br>  lastServerTime      ,   .   ,        ,       .  ,  serverTime,   ,     lastServerTime. <br> <br>    ,   ,        .       reportError,      ,   . <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">reportError</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(error)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>) alert(<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>.toString()); }</code> <br> <br>  ,   ,       .  ,           ,     .      ,      . <br> <br>   <br>         ,    ,    . ,     ,     ,        .  ,      ,   DOM    . <br> <br>  displayTalks      ,       .     shownTalks,      DOM,   ,     . <br> <br> <code class="javascript">var talkDiv = document.querySelector(<span class="hljs-string"><span class="hljs-string">"#talks"</span></span>); var shownTalks = Object.<span class="hljs-built_in"><span class="hljs-built_in">create</span></span>(null); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">displayTalks</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(talks)</span></span></span></span> { talks.forEach(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(talk)</span></span></span></span> { var shown = shownTalks[talk.title]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (talk.deleted) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (shown) { talkDiv.removeChild(shown); delete shownTalks[talk.title]; } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { var node = drawTalk(talk); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (shown) talkDiv.replaceChild(node, shown); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> talkDiv.appendChild(node); shownTalks[talk.title] = node; } }); }</code> <br> <br>  DOM     ,   HTML .    instantiateTemplate,     . <br> <br>  name ‚Äì  .    ,   ,        ,       ID ‚Äútemplate‚Äù.  querySelector   .     ‚Äútalk‚Äù  ‚Äúcomment‚Äù. <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">instantiateTemplate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(name, values)</span></span></span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">instantiateText</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(text)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> text.replace(/\{\{(\w+)\}\}/g, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(_, name)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> values[name]; }); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">instantiate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(node)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (node.nodeType == document.ELEMENT_NODE) { var copy = node.cloneNode(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (var i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; node.childNodes.length; i++) copy.appendChild(instantiate(node.childNodes[i])); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> copy; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (node.nodeType == document.TEXT_NODE) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> document.createTextNode( instantiateText(node.nodeValue)); } } var template = document.querySelector(<span class="hljs-string"><span class="hljs-string">"#template ."</span></span> + name); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> instantiate(template); }</code> <br> <br>  cloneNode,      DOM,   .     ,       <span class="hljs-literal"><span class="hljs-literal">true</span></span>.  instantiate    ,     . <br> <br>   instantiateTemplate   ,    ,     .   {{title}}     ‚Äútitle‚Äù. <br> <br>      ,    drawTalk   . <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">drawTalk</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(talk)</span></span></span></span> { var node = instantiateTemplate(<span class="hljs-string"><span class="hljs-string">"talk"</span></span>, talk); var comments = node.querySelector(<span class="hljs-string"><span class="hljs-string">".comments"</span></span>); talk.comments.forEach(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(comment)</span></span></span></span> { comments.appendChild( instantiateTemplate(<span class="hljs-string"><span class="hljs-string">"comment"</span></span>, comment)); }); node.querySelector(<span class="hljs-string"><span class="hljs-string">"button.del"</span></span>).addEventListener( <span class="hljs-string"><span class="hljs-string">"click"</span></span>, deleteTalk.bind(null, talk.title)); var form = node.querySelector(<span class="hljs-string"><span class="hljs-string">"form"</span></span>); form.addEventListener(<span class="hljs-string"><span class="hljs-string">"submit"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(event)</span></span></span></span> { event.preventDefault(); addComment(talk.title, form.elements.comment.value); form.reset(); }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> node; }</code> <br> <br>     ‚Äútalk‚Äù    . -,   ,     ‚Äúcomment‚Äù       <span class="hljs-string"><span class="hljs-string">"comments"</span></span>. ,      ,      ,  . <br> <br>   <br>  ,   drawTalk,   deleteTalk  addComment   ,       .      URL,       ,       talkURL. <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">talkURL</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(title)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"talks/"</span></span> + encodeURIComponent(title); }</code> <br> <br>  deleteTalk   DELETE       . <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">deleteTalk</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(title)</span></span></span></span> { request({pathname: talkURL(title), method: <span class="hljs-string"><span class="hljs-string">"DELETE"</span></span>}, reportError); }</code> <br> <br>          JSON      POST-. <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">addComment</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(title, comment)</span></span></span></span> { var comment = {author: nameField.value, message: comment}; request({pathname: talkURL(title) + <span class="hljs-string"><span class="hljs-string">"/comments"</span></span>, body: JSON.stringify(comment), method: <span class="hljs-string"><span class="hljs-string">"POST"</span></span>}, reportError); }</code> <br> <br>  nameField,      author,    <code><code class="javascript">  ,      .       localStorage,          . <br> <br> var nameField = document.querySelector(<span class="hljs-string"><span class="hljs-string">"#name"</span></span>); nameField.value = localStorage.getItem(<span class="hljs-string"><span class="hljs-string">"name"</span></span>) || <span class="hljs-string"><span class="hljs-string">""</span></span>; nameField.addEventListener(<span class="hljs-string"><span class="hljs-string">"change"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { localStorage.setItem(<span class="hljs-string"><span class="hljs-string">"name"</span></span>, nameField.value); });           ‚Äúsubmit‚Äù.       (     ),     PUT-   . var talkForm = document.querySelector(<span class="hljs-string"><span class="hljs-string">"#newtalk"</span></span>); talkForm.addEventListener(<span class="hljs-string"><span class="hljs-string">"submit"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(event)</span></span></span></span> { event.preventDefault(); request({pathname: talkURL(talkForm.elements.title.value), method: <span class="hljs-string"><span class="hljs-string">"PUT"</span></span>, body: JSON.stringify({ presenter: nameField.value, summary: talkForm.elements.summary.value })}, reportError); talkForm.reset(); });</code> <br> <br>   <br>  ,   ,   ,    ,     ,     ,       .    -       ,     . <br> <br>       ,    displayTalks    ,     ,       . <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">waitForChanges</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { request({pathname: <span class="hljs-string"><span class="hljs-string">"talks?changesSince="</span></span> + lastServerTime}, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(error, response)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>) { setTimeout(waitForChanges, <span class="hljs-number"><span class="hljs-number">2500</span></span>); console.<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>.stack); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { response = JSON.parse(response); displayTalks(response.talks); lastServerTime = response.serverTime; waitForChanges(); } }); }</code> <br> <br>    ,   ,     ,  ,    .    ,    reportError,             .       (  ),      <span class="hljs-number"><span class="hljs-number">2.5</span></span> . <br> <br>   ,     ,  lastServerTime ,    ,           .    ,    . <br> <br>    ,        localhost:<span class="hljs-number"><span class="hljs-number">8000</span></span>,  ,  ,     ,    . <br> <br>  <br>      ,    .    , ,   <a href=""> </a>   <a href="http://nodejs.org/">Node.js</a> . <br> <br>     <br>      .     ,      . <br> <br>     ,            .    ,    . <br> <br>    <br>      ,       DOM   ,   .   .     -         ,          ,      ,      ,  . <br> <br>   ,        ,    .    ,   ? <br> <br>   <br>    ,     .         ,   <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>,    ,  . <br> <br>           ,   (<span class="hljs-string"><span class="hljs-string">"comment"</span></span>)     .      ‚Äútalk‚Äù,     ,    comments,    ,   ,    . <br> <br>     : <br> <br> <code class="html">&lt;div class=<span class="hljs-string"><span class="hljs-string">"comments"</span></span>&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"comment"</span></span> template-<span class="hljs-keyword"><span class="hljs-keyword">repeat</span></span>=<span class="hljs-string"><span class="hljs-string">"comments"</span></span>&gt; &lt;span class=<span class="hljs-string"><span class="hljs-string">"name"</span></span>&gt;{{author}}&lt;/span&gt;: {{message}} &lt;/div&gt; &lt;/div&gt;</code> <br> <br>   :       template-<span class="hljs-keyword"><span class="hljs-keyword">repeat</span></span>,  ,     ,   ,   ,   .   ( values  instantiateTemplate)          ,   {{author}}     comment,    . <br> <br>  instantiateTemplate ,    ,    ,     ,          drawTalk. <br> <br>       ,      ,     <span class="hljs-literal"><span class="hljs-literal">true</span></span>  <span class="hljs-literal"><span class="hljs-literal">false</span></span>? <br> <br>    ? <br>  -       JavaScript,     .   - . <br> <br>   -     JavaScript.       ,      .         . <br> <br>   ,   -          JavaScript.     ,       .       ,     . <br> <br>     .    .          ,  ,    ?</code></code> </pre> <code><code class="html">  ID ‚Äútalks‚Äù    .   ,      . <br> <br>       . <br> <br> &lt;form id="newtalk"&gt; &lt;h3&gt;Submit a talk&lt;/h3&gt; : &lt;input type="text" style="width: 40em" name="title"&gt; &lt;br&gt; Summary: &lt;input type="text" style="width: 40em" name="summary"&gt; &lt;button type="submit"&gt; &lt;/button&gt; &lt;/form&gt;</code> <br> <br>     ‚Äúsubmit‚Äù  ,      HTTP-,    . <br> <br>    ,    display   none,       . ,   ? <br> <br> <code class="html">&lt;div id="template" style="display: none"&gt; &lt;div class="talk"&gt; &lt;h2&gt;{{title}}&lt;/h2&gt; &lt;div&gt;by &lt;span class="name"&gt;{{presenter}}&lt;/span&gt;&lt;/div&gt; &lt;p&gt;{{summary}}&lt;/p&gt; &lt;div class="comments"&gt;&lt;/div&gt; &lt;form&gt; &lt;input type="text" name="comment"&gt; &lt;button type="submit"&gt; &lt;/button&gt; &lt;button type="button" class="del"&gt; &lt;/button&gt; &lt;/form&gt; &lt;/div&gt; &lt;div class="comment"&gt; &lt;span class="name"&gt;{{author}}&lt;/span&gt;: {{message}} &lt;/div&gt; &lt;/div&gt;</code> <br> <br>    DOM  JavaScript    .          elt   13,       ,  HTML,   -      DOM-. <br> <br>   DOM-   ,      ,    ,   ,     ‚Äì             . <br> <br>  , HTML   ,   . <br> <br> <code class="html">&lt;script src="skillsharing_client.js"&gt;&lt;/script&gt;</code> <br> <br>  <br> ,       ,       .       HTTP-,      XMLHttpRequest,            . <br> <br> <code class="javascript">function request(options, callback) { var req = new XMLHttpRequest(); req.open(options.method || "GET", options.pathname, true); req.addEventListener("load", function() { if (req.status &lt; 400) callback(null, req.responseText); else callback(new Error("Request failed: " + req.statusText)); }); req.addEventListener("error", function() { callback(new Error("Network error")); }); req.send(options.body || null); }</code> <br> <br>            ,  waitForChanges. <br> <br> <code class="javascript">var lastServerTime = 0; request({pathname: "talks"}, function(error, response) { if (error) { reportError(error); } else { response = JSON.parse(response); displayTalks(response.talks); lastServerTime = response.serverTime; waitForChanges(); } });</code> <br> <br>  lastServerTime      ,   .   ,        ,       .  ,  serverTime,   ,     lastServerTime. <br> <br>    ,   ,        .       reportError,      ,   . <br> <br> <code class="javascript">function reportError(error) { if (error) alert(error.toString()); }</code> <br> <br>  ,   ,       .  ,           ,     .      ,      . <br> <br>   <br>         ,    ,    . ,     ,     ,        .  ,      ,   DOM    . <br> <br>  displayTalks      ,       .     shownTalks,      DOM,   ,     . <br> <br> <code class="javascript">var talkDiv = document.querySelector("#talks"); var shownTalks = Object.create(null); function displayTalks(talks) { talks.forEach(function(talk) { var shown = shownTalks[talk.title]; if (talk.deleted) { if (shown) { talkDiv.removeChild(shown); delete shownTalks[talk.title]; } } else { var node = drawTalk(talk); if (shown) talkDiv.replaceChild(node, shown); else talkDiv.appendChild(node); shownTalks[talk.title] = node; } }); }</code> <br> <br>  DOM     ,   HTML .    instantiateTemplate,     . <br> <br>  name ‚Äì  .    ,   ,        ,       ID ‚Äútemplate‚Äù.  querySelector   .     ‚Äútalk‚Äù  ‚Äúcomment‚Äù. <br> <br> <code class="javascript">function instantiateTemplate(name, values) { function instantiateText(text) { return text.replace(/\{\{(\w+)\}\}/g, function(_, name) { return values[name]; }); } function instantiate(node) { if (node.nodeType == document.ELEMENT_NODE) { var copy = node.cloneNode(); for (var i = 0; i &lt; node.childNodes.length; i++) copy.appendChild(instantiate(node.childNodes[i])); return copy; } else if (node.nodeType == document.TEXT_NODE) { return document.createTextNode( instantiateText(node.nodeValue)); } } var template = document.querySelector("#template ." + name); return instantiate(template); }</code> <br> <br>  cloneNode,      DOM,   .     ,       true.  instantiate    ,     . <br> <br>   instantiateTemplate   ,    ,     .   {{title}}     ‚Äútitle‚Äù. <br> <br>      ,    drawTalk   . <br> <br> <code class="javascript">function drawTalk(talk) { var node = instantiateTemplate("talk", talk); var comments = node.querySelector(".comments"); talk.comments.forEach(function(comment) { comments.appendChild( instantiateTemplate("comment", comment)); }); node.querySelector("button.del").addEventListener( "click", deleteTalk.bind(null, talk.title)); var form = node.querySelector("form"); form.addEventListener("submit", function(event) { event.preventDefault(); addComment(talk.title, form.elements.comment.value); form.reset(); }); return node; }</code> <br> <br>     ‚Äútalk‚Äù    . -,   ,     ‚Äúcomment‚Äù       "comments". ,      ,      ,  . <br> <br>   <br>  ,   drawTalk,   deleteTalk  addComment   ,       .      URL,       ,       talkURL. <br> <br> <code class="javascript">function talkURL(title) { return "talks/" + encodeURIComponent(title); }</code> <br> <br>  deleteTalk   DELETE       . <br> <br> <code class="javascript">function deleteTalk(title) { request({pathname: talkURL(title), method: "DELETE"}, reportError); }</code> <br> <br>          JSON      POST-. <br> <br> <code class="javascript">function addComment(title, comment) { var comment = {author: nameField.value, message: comment}; request({pathname: talkURL(title) + "/comments", body: JSON.stringify(comment), method: "POST"}, reportError); }</code> <br> <br>  nameField,      author,    <code><code class="javascript">  ,      .       localStorage,          . <br> <br> var nameField = document.querySelector("#name"); nameField.value = localStorage.getItem("name") || ""; nameField.addEventListener("change", function() { localStorage.setItem("name", nameField.value); });           ‚Äúsubmit‚Äù.       (     ),     PUT-   . var talkForm = document.querySelector("#newtalk"); talkForm.addEventListener("submit", function(event) { event.preventDefault(); request({pathname: talkURL(talkForm.elements.title.value), method: "PUT", body: JSON.stringify({ presenter: nameField.value, summary: talkForm.elements.summary.value })}, reportError); talkForm.reset(); });</code> <br> <br>   <br>  ,   ,   ,    ,     ,     ,       .    -       ,     . <br> <br>       ,    displayTalks    ,     ,       . <br> <br> <code class="javascript">function waitForChanges() { request({pathname: "talks?changesSince=" + lastServerTime}, function(error, response) { if (error) { setTimeout(waitForChanges, 2500); console.error(error.stack); } else { response = JSON.parse(response); displayTalks(response.talks); lastServerTime = response.serverTime; waitForChanges(); } }); }</code> <br> <br>    ,   ,     ,  ,    .    ,    reportError,             .       (  ),      2.5 . <br> <br>   ,     ,  lastServerTime ,    ,           .    ,    . <br> <br>    ,        localhost:8000,  ,  ,     ,    . <br> <br>  <br>      ,    .    , ,   <a href=""> </a>   <a href="http://nodejs.org/">Node.js</a> . <br> <br>     <br>      .     ,      . <br> <br>     ,            .    ,    . <br> <br>    <br>      ,       DOM   ,   .   .     -         ,          ,      ,      ,  . <br> <br>   ,        ,    .    ,   ? <br> <br>   <br>    ,     .         ,   if,    ,  . <br> <br>           ,   ("comment")     .      ‚Äútalk‚Äù,     ,    comments,    ,   ,    . <br> <br>     : <br> <br> <code class="html">&lt;div class="comments"&gt; &lt;div class="comment" template-repeat="comments"&gt; &lt;span class="name"&gt;{{author}}&lt;/span&gt;: {{message}} &lt;/div&gt; &lt;/div&gt;</code> <br> <br>   :       template-repeat,  ,     ,   ,   ,   .   ( values  instantiateTemplate)          ,   {{author}}     comment,    . <br> <br>  instantiateTemplate ,    ,    ,     ,          drawTalk. <br> <br>       ,      ,     true  false? <br> <br>    ? <br>  -       JavaScript,     .   - . <br> <br>   -     JavaScript.       ,      .         . <br> <br>   ,   -          JavaScript.     ,       .       ,     . <br> <br>     .    .          ,  ,    ?</code></code> <pre> <code class="hljs lua"><code class="html">  ID ‚Äútalks‚Äù    .   ,      . <br> <br>       . <br> <br> &lt;form id=<span class="hljs-string"><span class="hljs-string">"newtalk"</span></span>&gt; &lt;h3&gt;Submit a talk&lt;/h3&gt; : &lt;<span class="hljs-built_in"><span class="hljs-built_in">input</span></span> <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=<span class="hljs-string"><span class="hljs-string">"text"</span></span> style=<span class="hljs-string"><span class="hljs-string">"width: 40em"</span></span> name=<span class="hljs-string"><span class="hljs-string">"title"</span></span>&gt; &lt;br&gt; Summary: &lt;<span class="hljs-built_in"><span class="hljs-built_in">input</span></span> <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=<span class="hljs-string"><span class="hljs-string">"text"</span></span> style=<span class="hljs-string"><span class="hljs-string">"width: 40em"</span></span> name=<span class="hljs-string"><span class="hljs-string">"summary"</span></span>&gt; &lt;button <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=<span class="hljs-string"><span class="hljs-string">"submit"</span></span>&gt; &lt;/button&gt; &lt;/form&gt;</code> <br> <br>     ‚Äúsubmit‚Äù  ,      HTTP-,    . <br> <br>    ,    display   none,       . ,   ? <br> <br> <code class="html">&lt;div id=<span class="hljs-string"><span class="hljs-string">"template"</span></span> style=<span class="hljs-string"><span class="hljs-string">"display: none"</span></span>&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"talk"</span></span>&gt; &lt;h2&gt;{{title}}&lt;/h2&gt; &lt;div&gt;by &lt;span class=<span class="hljs-string"><span class="hljs-string">"name"</span></span>&gt;{{presenter}}&lt;/span&gt;&lt;/div&gt; &lt;p&gt;{{summary}}&lt;/p&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"comments"</span></span>&gt;&lt;/div&gt; &lt;form&gt; &lt;<span class="hljs-built_in"><span class="hljs-built_in">input</span></span> <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=<span class="hljs-string"><span class="hljs-string">"text"</span></span> name=<span class="hljs-string"><span class="hljs-string">"comment"</span></span>&gt; &lt;button <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=<span class="hljs-string"><span class="hljs-string">"submit"</span></span>&gt; &lt;/button&gt; &lt;button <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=<span class="hljs-string"><span class="hljs-string">"button"</span></span> class=<span class="hljs-string"><span class="hljs-string">"del"</span></span>&gt; &lt;/button&gt; &lt;/form&gt; &lt;/div&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"comment"</span></span>&gt; &lt;span class=<span class="hljs-string"><span class="hljs-string">"name"</span></span>&gt;{{author}}&lt;/span&gt;: {{message}} &lt;/div&gt; &lt;/div&gt;</code> <br> <br>    DOM  JavaScript    .          elt   <span class="hljs-number"><span class="hljs-number">13</span></span>,       ,  HTML,   -      DOM-. <br> <br>   DOM-   ,      ,    ,   ,     ‚Äì             . <br> <br>  , HTML   ,   . <br> <br> <code class="html">&lt;script src=<span class="hljs-string"><span class="hljs-string">"skillsharing_client.js"</span></span>&gt;&lt;/script&gt;</code> <br> <br>  <br> ,       ,       .       HTTP-,      XMLHttpRequest,            . <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">request</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(options, callback)</span></span></span></span> { var req = new XMLHttpRequest(); req.<span class="hljs-built_in"><span class="hljs-built_in">open</span></span>(options.method || <span class="hljs-string"><span class="hljs-string">"GET"</span></span>, options.pathname, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); req.addEventListener(<span class="hljs-string"><span class="hljs-string">"load"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (req.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> &lt; <span class="hljs-number"><span class="hljs-number">400</span></span>) callback(null, req.responseText); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> callback(new Error(<span class="hljs-string"><span class="hljs-string">"Request failed: "</span></span> + req.statusText)); }); req.addEventListener(<span class="hljs-string"><span class="hljs-string">"error"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { callback(new Error(<span class="hljs-string"><span class="hljs-string">"Network error"</span></span>)); }); req.send(options.body || null); }</code> <br> <br>            ,  waitForChanges. <br> <br> <code class="javascript">var lastServerTime = <span class="hljs-number"><span class="hljs-number">0</span></span>; request({pathname: <span class="hljs-string"><span class="hljs-string">"talks"</span></span>}, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(error, response)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>) { reportError(<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { response = JSON.parse(response); displayTalks(response.talks); lastServerTime = response.serverTime; waitForChanges(); } });</code> <br> <br>  lastServerTime      ,   .   ,        ,       .  ,  serverTime,   ,     lastServerTime. <br> <br>    ,   ,        .       reportError,      ,   . <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">reportError</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(error)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>) alert(<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>.toString()); }</code> <br> <br>  ,   ,       .  ,           ,     .      ,      . <br> <br>   <br>         ,    ,    . ,     ,     ,        .  ,      ,   DOM    . <br> <br>  displayTalks      ,       .     shownTalks,      DOM,   ,     . <br> <br> <code class="javascript">var talkDiv = document.querySelector(<span class="hljs-string"><span class="hljs-string">"#talks"</span></span>); var shownTalks = Object.<span class="hljs-built_in"><span class="hljs-built_in">create</span></span>(null); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">displayTalks</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(talks)</span></span></span></span> { talks.forEach(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(talk)</span></span></span></span> { var shown = shownTalks[talk.title]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (talk.deleted) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (shown) { talkDiv.removeChild(shown); delete shownTalks[talk.title]; } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { var node = drawTalk(talk); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (shown) talkDiv.replaceChild(node, shown); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> talkDiv.appendChild(node); shownTalks[talk.title] = node; } }); }</code> <br> <br>  DOM     ,   HTML .    instantiateTemplate,     . <br> <br>  name ‚Äì  .    ,   ,        ,       ID ‚Äútemplate‚Äù.  querySelector   .     ‚Äútalk‚Äù  ‚Äúcomment‚Äù. <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">instantiateTemplate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(name, values)</span></span></span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">instantiateText</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(text)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> text.replace(/\{\{(\w+)\}\}/g, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(_, name)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> values[name]; }); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">instantiate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(node)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (node.nodeType == document.ELEMENT_NODE) { var copy = node.cloneNode(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (var i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; node.childNodes.length; i++) copy.appendChild(instantiate(node.childNodes[i])); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> copy; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (node.nodeType == document.TEXT_NODE) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> document.createTextNode( instantiateText(node.nodeValue)); } } var template = document.querySelector(<span class="hljs-string"><span class="hljs-string">"#template ."</span></span> + name); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> instantiate(template); }</code> <br> <br>  cloneNode,      DOM,   .     ,       <span class="hljs-literal"><span class="hljs-literal">true</span></span>.  instantiate    ,     . <br> <br>   instantiateTemplate   ,    ,     .   {{title}}     ‚Äútitle‚Äù. <br> <br>      ,    drawTalk   . <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">drawTalk</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(talk)</span></span></span></span> { var node = instantiateTemplate(<span class="hljs-string"><span class="hljs-string">"talk"</span></span>, talk); var comments = node.querySelector(<span class="hljs-string"><span class="hljs-string">".comments"</span></span>); talk.comments.forEach(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(comment)</span></span></span></span> { comments.appendChild( instantiateTemplate(<span class="hljs-string"><span class="hljs-string">"comment"</span></span>, comment)); }); node.querySelector(<span class="hljs-string"><span class="hljs-string">"button.del"</span></span>).addEventListener( <span class="hljs-string"><span class="hljs-string">"click"</span></span>, deleteTalk.bind(null, talk.title)); var form = node.querySelector(<span class="hljs-string"><span class="hljs-string">"form"</span></span>); form.addEventListener(<span class="hljs-string"><span class="hljs-string">"submit"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(event)</span></span></span></span> { event.preventDefault(); addComment(talk.title, form.elements.comment.value); form.reset(); }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> node; }</code> <br> <br>     ‚Äútalk‚Äù    . -,   ,     ‚Äúcomment‚Äù       <span class="hljs-string"><span class="hljs-string">"comments"</span></span>. ,      ,      ,  . <br> <br>   <br>  ,   drawTalk,   deleteTalk  addComment   ,       .      URL,       ,       talkURL. <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">talkURL</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(title)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"talks/"</span></span> + encodeURIComponent(title); }</code> <br> <br>  deleteTalk   DELETE       . <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">deleteTalk</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(title)</span></span></span></span> { request({pathname: talkURL(title), method: <span class="hljs-string"><span class="hljs-string">"DELETE"</span></span>}, reportError); }</code> <br> <br>          JSON      POST-. <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">addComment</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(title, comment)</span></span></span></span> { var comment = {author: nameField.value, message: comment}; request({pathname: talkURL(title) + <span class="hljs-string"><span class="hljs-string">"/comments"</span></span>, body: JSON.stringify(comment), method: <span class="hljs-string"><span class="hljs-string">"POST"</span></span>}, reportError); }</code> <br> <br>  nameField,      author,    <code><code class="javascript">  ,      .       localStorage,          . <br> <br> var nameField = document.querySelector(<span class="hljs-string"><span class="hljs-string">"#name"</span></span>); nameField.value = localStorage.getItem(<span class="hljs-string"><span class="hljs-string">"name"</span></span>) || <span class="hljs-string"><span class="hljs-string">""</span></span>; nameField.addEventListener(<span class="hljs-string"><span class="hljs-string">"change"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { localStorage.setItem(<span class="hljs-string"><span class="hljs-string">"name"</span></span>, nameField.value); });           ‚Äúsubmit‚Äù.       (     ),     PUT-   . var talkForm = document.querySelector(<span class="hljs-string"><span class="hljs-string">"#newtalk"</span></span>); talkForm.addEventListener(<span class="hljs-string"><span class="hljs-string">"submit"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(event)</span></span></span></span> { event.preventDefault(); request({pathname: talkURL(talkForm.elements.title.value), method: <span class="hljs-string"><span class="hljs-string">"PUT"</span></span>, body: JSON.stringify({ presenter: nameField.value, summary: talkForm.elements.summary.value })}, reportError); talkForm.reset(); });</code> <br> <br>   <br>  ,   ,   ,    ,     ,     ,       .    -       ,     . <br> <br>       ,    displayTalks    ,     ,       . <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">waitForChanges</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { request({pathname: <span class="hljs-string"><span class="hljs-string">"talks?changesSince="</span></span> + lastServerTime}, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(error, response)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>) { setTimeout(waitForChanges, <span class="hljs-number"><span class="hljs-number">2500</span></span>); console.<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>.stack); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { response = JSON.parse(response); displayTalks(response.talks); lastServerTime = response.serverTime; waitForChanges(); } }); }</code> <br> <br>    ,   ,     ,  ,    .    ,    reportError,             .       (  ),      <span class="hljs-number"><span class="hljs-number">2.5</span></span> . <br> <br>   ,     ,  lastServerTime ,    ,           .    ,    . <br> <br>    ,        localhost:<span class="hljs-number"><span class="hljs-number">8000</span></span>,  ,  ,     ,    . <br> <br>  <br>      ,    .    , ,   <a href=""> </a>   <a href="http://nodejs.org/">Node.js</a> . <br> <br>     <br>      .     ,      . <br> <br>     ,            .    ,    . <br> <br>    <br>      ,       DOM   ,   .   .     -         ,          ,      ,      ,  . <br> <br>   ,        ,    .    ,   ? <br> <br>   <br>    ,     .         ,   <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>,    ,  . <br> <br>           ,   (<span class="hljs-string"><span class="hljs-string">"comment"</span></span>)     .      ‚Äútalk‚Äù,     ,    comments,    ,   ,    . <br> <br>     : <br> <br> <code class="html">&lt;div class=<span class="hljs-string"><span class="hljs-string">"comments"</span></span>&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"comment"</span></span> template-<span class="hljs-keyword"><span class="hljs-keyword">repeat</span></span>=<span class="hljs-string"><span class="hljs-string">"comments"</span></span>&gt; &lt;span class=<span class="hljs-string"><span class="hljs-string">"name"</span></span>&gt;{{author}}&lt;/span&gt;: {{message}} &lt;/div&gt; &lt;/div&gt;</code> <br> <br>   :       template-<span class="hljs-keyword"><span class="hljs-keyword">repeat</span></span>,  ,     ,   ,   ,   .   ( values  instantiateTemplate)          ,   {{author}}     comment,    . <br> <br>  instantiateTemplate ,    ,    ,     ,          drawTalk. <br> <br>       ,      ,     <span class="hljs-literal"><span class="hljs-literal">true</span></span>  <span class="hljs-literal"><span class="hljs-literal">false</span></span>? <br> <br>    ? <br>  -       JavaScript,     .   - . <br> <br>   -     JavaScript.       ,      .         . <br> <br>   ,   -          JavaScript.     ,       .       ,     . <br> <br>     .    .          ,  ,    ?</code></code> </pre> <code><code class="html">  ID ‚Äútalks‚Äù    .   ,      . <br> <br>       . <br> <br> &lt;form id="newtalk"&gt; &lt;h3&gt;Submit a talk&lt;/h3&gt; : &lt;input type="text" style="width: 40em" name="title"&gt; &lt;br&gt; Summary: &lt;input type="text" style="width: 40em" name="summary"&gt; &lt;button type="submit"&gt; &lt;/button&gt; &lt;/form&gt;</code> <br> <br>     ‚Äúsubmit‚Äù  ,      HTTP-,    . <br> <br>    ,    display   none,       . ,   ? <br> <br> <code class="html">&lt;div id="template" style="display: none"&gt; &lt;div class="talk"&gt; &lt;h2&gt;{{title}}&lt;/h2&gt; &lt;div&gt;by &lt;span class="name"&gt;{{presenter}}&lt;/span&gt;&lt;/div&gt; &lt;p&gt;{{summary}}&lt;/p&gt; &lt;div class="comments"&gt;&lt;/div&gt; &lt;form&gt; &lt;input type="text" name="comment"&gt; &lt;button type="submit"&gt; &lt;/button&gt; &lt;button type="button" class="del"&gt; &lt;/button&gt; &lt;/form&gt; &lt;/div&gt; &lt;div class="comment"&gt; &lt;span class="name"&gt;{{author}}&lt;/span&gt;: {{message}} &lt;/div&gt; &lt;/div&gt;</code> <br> <br>    DOM  JavaScript    .          elt   13,       ,  HTML,   -      DOM-. <br> <br>   DOM-   ,      ,    ,   ,     ‚Äì             . <br> <br>  , HTML   ,   . <br> <br> <code class="html">&lt;script src="skillsharing_client.js"&gt;&lt;/script&gt;</code> <br> <br>  <br> ,       ,       .       HTTP-,      XMLHttpRequest,            . <br> <br> <code class="javascript">function request(options, callback) { var req = new XMLHttpRequest(); req.open(options.method || "GET", options.pathname, true); req.addEventListener("load", function() { if (req.status &lt; 400) callback(null, req.responseText); else callback(new Error("Request failed: " + req.statusText)); }); req.addEventListener("error", function() { callback(new Error("Network error")); }); req.send(options.body || null); }</code> <br> <br>            ,  waitForChanges. <br> <br> <code class="javascript">var lastServerTime = 0; request({pathname: "talks"}, function(error, response) { if (error) { reportError(error); } else { response = JSON.parse(response); displayTalks(response.talks); lastServerTime = response.serverTime; waitForChanges(); } });</code> <br> <br>  lastServerTime      ,   .   ,        ,       .  ,  serverTime,   ,     lastServerTime. <br> <br>    ,   ,        .       reportError,      ,   . <br> <br> <code class="javascript">function reportError(error) { if (error) alert(error.toString()); }</code> <br> <br>  ,   ,       .  ,           ,     .      ,      . <br> <br>   <br>         ,    ,    . ,     ,     ,        .  ,      ,   DOM    . <br> <br>  displayTalks      ,       .     shownTalks,      DOM,   ,     . <br> <br> <code class="javascript">var talkDiv = document.querySelector("#talks"); var shownTalks = Object.create(null); function displayTalks(talks) { talks.forEach(function(talk) { var shown = shownTalks[talk.title]; if (talk.deleted) { if (shown) { talkDiv.removeChild(shown); delete shownTalks[talk.title]; } } else { var node = drawTalk(talk); if (shown) talkDiv.replaceChild(node, shown); else talkDiv.appendChild(node); shownTalks[talk.title] = node; } }); }</code> <br> <br>  DOM     ,   HTML .    instantiateTemplate,     . <br> <br>  name ‚Äì  .    ,   ,        ,       ID ‚Äútemplate‚Äù.  querySelector   .     ‚Äútalk‚Äù  ‚Äúcomment‚Äù. <br> <br> <code class="javascript">function instantiateTemplate(name, values) { function instantiateText(text) { return text.replace(/\{\{(\w+)\}\}/g, function(_, name) { return values[name]; }); } function instantiate(node) { if (node.nodeType == document.ELEMENT_NODE) { var copy = node.cloneNode(); for (var i = 0; i &lt; node.childNodes.length; i++) copy.appendChild(instantiate(node.childNodes[i])); return copy; } else if (node.nodeType == document.TEXT_NODE) { return document.createTextNode( instantiateText(node.nodeValue)); } } var template = document.querySelector("#template ." + name); return instantiate(template); }</code> <br> <br>  cloneNode,      DOM,   .     ,       true.  instantiate    ,     . <br> <br>   instantiateTemplate   ,    ,     .   {{title}}     ‚Äútitle‚Äù. <br> <br>      ,    drawTalk   . <br> <br> <code class="javascript">function drawTalk(talk) { var node = instantiateTemplate("talk", talk); var comments = node.querySelector(".comments"); talk.comments.forEach(function(comment) { comments.appendChild( instantiateTemplate("comment", comment)); }); node.querySelector("button.del").addEventListener( "click", deleteTalk.bind(null, talk.title)); var form = node.querySelector("form"); form.addEventListener("submit", function(event) { event.preventDefault(); addComment(talk.title, form.elements.comment.value); form.reset(); }); return node; }</code> <br> <br>     ‚Äútalk‚Äù    . -,   ,     ‚Äúcomment‚Äù       "comments". ,      ,      ,  . <br> <br>   <br>  ,   drawTalk,   deleteTalk  addComment   ,       .      URL,       ,       talkURL. <br> <br> <code class="javascript">function talkURL(title) { return "talks/" + encodeURIComponent(title); }</code> <br> <br>  deleteTalk   DELETE       . <br> <br> <code class="javascript">function deleteTalk(title) { request({pathname: talkURL(title), method: "DELETE"}, reportError); }</code> <br> <br>          JSON      POST-. <br> <br> <code class="javascript">function addComment(title, comment) { var comment = {author: nameField.value, message: comment}; request({pathname: talkURL(title) + "/comments", body: JSON.stringify(comment), method: "POST"}, reportError); }</code> <br> <br>  nameField,      author,    <code><code class="javascript">  ,      .       localStorage,          . <br> <br> var nameField = document.querySelector("#name"); nameField.value = localStorage.getItem("name") || ""; nameField.addEventListener("change", function() { localStorage.setItem("name", nameField.value); });           ‚Äúsubmit‚Äù.       (     ),     PUT-   . var talkForm = document.querySelector("#newtalk"); talkForm.addEventListener("submit", function(event) { event.preventDefault(); request({pathname: talkURL(talkForm.elements.title.value), method: "PUT", body: JSON.stringify({ presenter: nameField.value, summary: talkForm.elements.summary.value })}, reportError); talkForm.reset(); });</code> <br> <br>   <br>  ,   ,   ,    ,     ,     ,       .    -       ,     . <br> <br>       ,    displayTalks    ,     ,       . <br> <br> <code class="javascript">function waitForChanges() { request({pathname: "talks?changesSince=" + lastServerTime}, function(error, response) { if (error) { setTimeout(waitForChanges, 2500); console.error(error.stack); } else { response = JSON.parse(response); displayTalks(response.talks); lastServerTime = response.serverTime; waitForChanges(); } }); }</code> <br> <br>    ,   ,     ,  ,    .    ,    reportError,             .       (  ),      2.5 . <br> <br>   ,     ,  lastServerTime ,    ,           .    ,    . <br> <br>    ,        localhost:8000,  ,  ,     ,    . <br> <br>  <br>      ,    .    , ,   <a href=""> </a>   <a href="http://nodejs.org/">Node.js</a> . <br> <br>     <br>      .     ,      . <br> <br>     ,            .    ,    . <br> <br>    <br>      ,       DOM   ,   .   .     -         ,          ,      ,      ,  . <br> <br>   ,        ,    .    ,   ? <br> <br>   <br>    ,     .         ,   if,    ,  . <br> <br>           ,   ("comment")     .      ‚Äútalk‚Äù,     ,    comments,    ,   ,    . <br> <br>     : <br> <br> <code class="html">&lt;div class="comments"&gt; &lt;div class="comment" template-repeat="comments"&gt; &lt;span class="name"&gt;{{author}}&lt;/span&gt;: {{message}} &lt;/div&gt; &lt;/div&gt;</code> <br> <br>   :       template-repeat,  ,     ,   ,   ,   .   ( values  instantiateTemplate)          ,   {{author}}     comment,    . <br> <br>  instantiateTemplate ,    ,    ,     ,          drawTalk. <br> <br>       ,      ,     true  false? <br> <br>    ? <br>  -       JavaScript,     .   - . <br> <br>   -     JavaScript.       ,      .         . <br> <br>   ,   -          JavaScript.     ,       .       ,     . <br> <br>     .    .          ,  ,    ?</code></code> <h4> <code><code class="html">  ID ‚Äútalks‚Äù    .   ,      . <br> <br>       . <br> <br> &lt;form id="newtalk"&gt; &lt;h3&gt;Submit a talk&lt;/h3&gt; : &lt;input type="text" style="width: 40em" name="title"&gt; &lt;br&gt; Summary: &lt;input type="text" style="width: 40em" name="summary"&gt; &lt;button type="submit"&gt; &lt;/button&gt; &lt;/form&gt;</code> <br> <br>     ‚Äúsubmit‚Äù  ,      HTTP-,    . <br> <br>    ,    display   none,       . ,   ? <br> <br> <code class="html">&lt;div id="template" style="display: none"&gt; &lt;div class="talk"&gt; &lt;h2&gt;{{title}}&lt;/h2&gt; &lt;div&gt;by &lt;span class="name"&gt;{{presenter}}&lt;/span&gt;&lt;/div&gt; &lt;p&gt;{{summary}}&lt;/p&gt; &lt;div class="comments"&gt;&lt;/div&gt; &lt;form&gt; &lt;input type="text" name="comment"&gt; &lt;button type="submit"&gt; &lt;/button&gt; &lt;button type="button" class="del"&gt; &lt;/button&gt; &lt;/form&gt; &lt;/div&gt; &lt;div class="comment"&gt; &lt;span class="name"&gt;{{author}}&lt;/span&gt;: {{message}} &lt;/div&gt; &lt;/div&gt;</code> <br> <br>    DOM  JavaScript    .          elt   13,       ,  HTML,   -      DOM-. <br> <br>   DOM-   ,      ,    ,   ,     ‚Äì             . <br> <br>  , HTML   ,   . <br> <br> <code class="html">&lt;script src="skillsharing_client.js"&gt;&lt;/script&gt;</code> <br> <br>  <br> ,       ,       .       HTTP-,      XMLHttpRequest,            . <br> <br> <code class="javascript">function request(options, callback) { var req = new XMLHttpRequest(); req.open(options.method || "GET", options.pathname, true); req.addEventListener("load", function() { if (req.status &lt; 400) callback(null, req.responseText); else callback(new Error("Request failed: " + req.statusText)); }); req.addEventListener("error", function() { callback(new Error("Network error")); }); req.send(options.body || null); }</code> <br> <br>            ,  waitForChanges. <br> <br> <code class="javascript">var lastServerTime = 0; request({pathname: "talks"}, function(error, response) { if (error) { reportError(error); } else { response = JSON.parse(response); displayTalks(response.talks); lastServerTime = response.serverTime; waitForChanges(); } });</code> <br> <br>  lastServerTime      ,   .   ,        ,       .  ,  serverTime,   ,     lastServerTime. <br> <br>    ,   ,        .       reportError,      ,   . <br> <br> <code class="javascript">function reportError(error) { if (error) alert(error.toString()); }</code> <br> <br>  ,   ,       .  ,           ,     .      ,      . <br> <br>   <br>         ,    ,    . ,     ,     ,        .  ,      ,   DOM    . <br> <br>  displayTalks      ,       .     shownTalks,      DOM,   ,     . <br> <br> <code class="javascript">var talkDiv = document.querySelector("#talks"); var shownTalks = Object.create(null); function displayTalks(talks) { talks.forEach(function(talk) { var shown = shownTalks[talk.title]; if (talk.deleted) { if (shown) { talkDiv.removeChild(shown); delete shownTalks[talk.title]; } } else { var node = drawTalk(talk); if (shown) talkDiv.replaceChild(node, shown); else talkDiv.appendChild(node); shownTalks[talk.title] = node; } }); }</code> <br> <br>  DOM     ,   HTML .    instantiateTemplate,     . <br> <br>  name ‚Äì  .    ,   ,        ,       ID ‚Äútemplate‚Äù.  querySelector   .     ‚Äútalk‚Äù  ‚Äúcomment‚Äù. <br> <br> <code class="javascript">function instantiateTemplate(name, values) { function instantiateText(text) { return text.replace(/\{\{(\w+)\}\}/g, function(_, name) { return values[name]; }); } function instantiate(node) { if (node.nodeType == document.ELEMENT_NODE) { var copy = node.cloneNode(); for (var i = 0; i &lt; node.childNodes.length; i++) copy.appendChild(instantiate(node.childNodes[i])); return copy; } else if (node.nodeType == document.TEXT_NODE) { return document.createTextNode( instantiateText(node.nodeValue)); } } var template = document.querySelector("#template ." + name); return instantiate(template); }</code> <br> <br>  cloneNode,      DOM,   .     ,       true.  instantiate    ,     . <br> <br>   instantiateTemplate   ,    ,     .   {{title}}     ‚Äútitle‚Äù. <br> <br>      ,    drawTalk   . <br> <br> <code class="javascript">function drawTalk(talk) { var node = instantiateTemplate("talk", talk); var comments = node.querySelector(".comments"); talk.comments.forEach(function(comment) { comments.appendChild( instantiateTemplate("comment", comment)); }); node.querySelector("button.del").addEventListener( "click", deleteTalk.bind(null, talk.title)); var form = node.querySelector("form"); form.addEventListener("submit", function(event) { event.preventDefault(); addComment(talk.title, form.elements.comment.value); form.reset(); }); return node; }</code> <br> <br>     ‚Äútalk‚Äù    . -,   ,     ‚Äúcomment‚Äù       "comments". ,      ,      ,  . <br> <br>   <br>  ,   drawTalk,   deleteTalk  addComment   ,       .      URL,       ,       talkURL. <br> <br> <code class="javascript">function talkURL(title) { return "talks/" + encodeURIComponent(title); }</code> <br> <br>  deleteTalk   DELETE       . <br> <br> <code class="javascript">function deleteTalk(title) { request({pathname: talkURL(title), method: "DELETE"}, reportError); }</code> <br> <br>          JSON      POST-. <br> <br> <code class="javascript">function addComment(title, comment) { var comment = {author: nameField.value, message: comment}; request({pathname: talkURL(title) + "/comments", body: JSON.stringify(comment), method: "POST"}, reportError); }</code> <br> <br>  nameField,      author,    <code><code class="javascript">  ,      .       localStorage,          . <br> <br> var nameField = document.querySelector("#name"); nameField.value = localStorage.getItem("name") || ""; nameField.addEventListener("change", function() { localStorage.setItem("name", nameField.value); });           ‚Äúsubmit‚Äù.       (     ),     PUT-   . var talkForm = document.querySelector("#newtalk"); talkForm.addEventListener("submit", function(event) { event.preventDefault(); request({pathname: talkURL(talkForm.elements.title.value), method: "PUT", body: JSON.stringify({ presenter: nameField.value, summary: talkForm.elements.summary.value })}, reportError); talkForm.reset(); });</code> <br> <br>   <br>  ,   ,   ,    ,     ,     ,       .    -       ,     . <br> <br>       ,    displayTalks    ,     ,       . <br> <br> <code class="javascript">function waitForChanges() { request({pathname: "talks?changesSince=" + lastServerTime}, function(error, response) { if (error) { setTimeout(waitForChanges, 2500); console.error(error.stack); } else { response = JSON.parse(response); displayTalks(response.talks); lastServerTime = response.serverTime; waitForChanges(); } }); }</code> <br> <br>    ,   ,     ,  ,    .    ,    reportError,             .       (  ),      2.5 . <br> <br>   ,     ,  lastServerTime ,    ,           .    ,    . <br> <br>    ,        localhost:8000,  ,  ,     ,    . <br> <br>  <br>      ,    .    , ,   <a href=""> </a>   <a href="http://nodejs.org/">Node.js</a> . <br> <br>     <br>      .     ,      . <br> <br>     ,            .    ,    . <br> <br>    <br>      ,       DOM   ,   .   .     -         ,          ,      ,      ,  . <br> <br>   ,        ,    .    ,   ? <br> <br>   <br>    ,     .         ,   if,    ,  . <br> <br>           ,   ("comment")     .      ‚Äútalk‚Äù,     ,    comments,    ,   ,    . <br> <br>     : <br> <br> <code class="html">&lt;div class="comments"&gt; &lt;div class="comment" template-repeat="comments"&gt; &lt;span class="name"&gt;{{author}}&lt;/span&gt;: {{message}} &lt;/div&gt; &lt;/div&gt;</code> <br> <br>   :       template-repeat,  ,     ,   ,   ,   .   ( values  instantiateTemplate)          ,   {{author}}     comment,    . <br> <br>  instantiateTemplate ,    ,    ,     ,          drawTalk. <br> <br>       ,      ,     true  false? <br> <br>    ? <br>  -       JavaScript,     .   - . <br> <br>   -     JavaScript.       ,      .         . <br> <br>   ,   -          JavaScript.     ,       .       ,     . <br> <br>     .    .          ,  ,    ?</code></code> </h4> <code><code class="html">  ID ‚Äútalks‚Äù    .   ,      . <br> <br>       . <br> <br> &lt;form id="newtalk"&gt; &lt;h3&gt;Submit a talk&lt;/h3&gt; : &lt;input type="text" style="width: 40em" name="title"&gt; &lt;br&gt; Summary: &lt;input type="text" style="width: 40em" name="summary"&gt; &lt;button type="submit"&gt; &lt;/button&gt; &lt;/form&gt;</code> <br> <br>     ‚Äúsubmit‚Äù  ,      HTTP-,    . <br> <br>    ,    display   none,       . ,   ? <br> <br> <code class="html">&lt;div id="template" style="display: none"&gt; &lt;div class="talk"&gt; &lt;h2&gt;{{title}}&lt;/h2&gt; &lt;div&gt;by &lt;span class="name"&gt;{{presenter}}&lt;/span&gt;&lt;/div&gt; &lt;p&gt;{{summary}}&lt;/p&gt; &lt;div class="comments"&gt;&lt;/div&gt; &lt;form&gt; &lt;input type="text" name="comment"&gt; &lt;button type="submit"&gt; &lt;/button&gt; &lt;button type="button" class="del"&gt; &lt;/button&gt; &lt;/form&gt; &lt;/div&gt; &lt;div class="comment"&gt; &lt;span class="name"&gt;{{author}}&lt;/span&gt;: {{message}} &lt;/div&gt; &lt;/div&gt;</code> <br> <br>    DOM  JavaScript    .          elt   13,       ,  HTML,   -      DOM-. <br> <br>   DOM-   ,      ,    ,   ,     ‚Äì             . <br> <br>  , HTML   ,   . <br> <br> <code class="html">&lt;script src="skillsharing_client.js"&gt;&lt;/script&gt;</code> <br> <br>  <br> ,       ,       .       HTTP-,      XMLHttpRequest,            . <br> <br> <code class="javascript">function request(options, callback) { var req = new XMLHttpRequest(); req.open(options.method || "GET", options.pathname, true); req.addEventListener("load", function() { if (req.status &lt; 400) callback(null, req.responseText); else callback(new Error("Request failed: " + req.statusText)); }); req.addEventListener("error", function() { callback(new Error("Network error")); }); req.send(options.body || null); }</code> <br> <br>            ,  waitForChanges. <br> <br> <code class="javascript">var lastServerTime = 0; request({pathname: "talks"}, function(error, response) { if (error) { reportError(error); } else { response = JSON.parse(response); displayTalks(response.talks); lastServerTime = response.serverTime; waitForChanges(); } });</code> <br> <br>  lastServerTime      ,   .   ,        ,       .  ,  serverTime,   ,     lastServerTime. <br> <br>    ,   ,        .       reportError,      ,   . <br> <br> <code class="javascript">function reportError(error) { if (error) alert(error.toString()); }</code> <br> <br>  ,   ,       .  ,           ,     .      ,      . <br> <br>   <br>         ,    ,    . ,     ,     ,        .  ,      ,   DOM    . <br> <br>  displayTalks      ,       .     shownTalks,      DOM,   ,     . <br> <br> <code class="javascript">var talkDiv = document.querySelector("#talks"); var shownTalks = Object.create(null); function displayTalks(talks) { talks.forEach(function(talk) { var shown = shownTalks[talk.title]; if (talk.deleted) { if (shown) { talkDiv.removeChild(shown); delete shownTalks[talk.title]; } } else { var node = drawTalk(talk); if (shown) talkDiv.replaceChild(node, shown); else talkDiv.appendChild(node); shownTalks[talk.title] = node; } }); }</code> <br> <br>  DOM     ,   HTML .    instantiateTemplate,     . <br> <br>  name ‚Äì  .    ,   ,        ,       ID ‚Äútemplate‚Äù.  querySelector   .     ‚Äútalk‚Äù  ‚Äúcomment‚Äù. <br> <br> <code class="javascript">function instantiateTemplate(name, values) { function instantiateText(text) { return text.replace(/\{\{(\w+)\}\}/g, function(_, name) { return values[name]; }); } function instantiate(node) { if (node.nodeType == document.ELEMENT_NODE) { var copy = node.cloneNode(); for (var i = 0; i &lt; node.childNodes.length; i++) copy.appendChild(instantiate(node.childNodes[i])); return copy; } else if (node.nodeType == document.TEXT_NODE) { return document.createTextNode( instantiateText(node.nodeValue)); } } var template = document.querySelector("#template ." + name); return instantiate(template); }</code> <br> <br>  cloneNode,      DOM,   .     ,       true.  instantiate    ,     . <br> <br>   instantiateTemplate   ,    ,     .   {{title}}     ‚Äútitle‚Äù. <br> <br>      ,    drawTalk   . <br> <br> <code class="javascript">function drawTalk(talk) { var node = instantiateTemplate("talk", talk); var comments = node.querySelector(".comments"); talk.comments.forEach(function(comment) { comments.appendChild( instantiateTemplate("comment", comment)); }); node.querySelector("button.del").addEventListener( "click", deleteTalk.bind(null, talk.title)); var form = node.querySelector("form"); form.addEventListener("submit", function(event) { event.preventDefault(); addComment(talk.title, form.elements.comment.value); form.reset(); }); return node; }</code> <br> <br>     ‚Äútalk‚Äù    . -,   ,     ‚Äúcomment‚Äù       "comments". ,      ,      ,  . <br> <br>   <br>  ,   drawTalk,   deleteTalk  addComment   ,       .      URL,       ,       talkURL. <br> <br> <code class="javascript">function talkURL(title) { return "talks/" + encodeURIComponent(title); }</code> <br> <br>  deleteTalk   DELETE       . <br> <br> <code class="javascript">function deleteTalk(title) { request({pathname: talkURL(title), method: "DELETE"}, reportError); }</code> <br> <br>          JSON      POST-. <br> <br> <code class="javascript">function addComment(title, comment) { var comment = {author: nameField.value, message: comment}; request({pathname: talkURL(title) + "/comments", body: JSON.stringify(comment), method: "POST"}, reportError); }</code> <br> <br>  nameField,      author,    <code><code class="javascript">  ,      .       localStorage,          . <br> <br> var nameField = document.querySelector("#name"); nameField.value = localStorage.getItem("name") || ""; nameField.addEventListener("change", function() { localStorage.setItem("name", nameField.value); });           ‚Äúsubmit‚Äù.       (     ),     PUT-   . var talkForm = document.querySelector("#newtalk"); talkForm.addEventListener("submit", function(event) { event.preventDefault(); request({pathname: talkURL(talkForm.elements.title.value), method: "PUT", body: JSON.stringify({ presenter: nameField.value, summary: talkForm.elements.summary.value })}, reportError); talkForm.reset(); });</code> <br> <br>   <br>  ,   ,   ,    ,     ,     ,       .    -       ,     . <br> <br>       ,    displayTalks    ,     ,       . <br> <br> <code class="javascript">function waitForChanges() { request({pathname: "talks?changesSince=" + lastServerTime}, function(error, response) { if (error) { setTimeout(waitForChanges, 2500); console.error(error.stack); } else { response = JSON.parse(response); displayTalks(response.talks); lastServerTime = response.serverTime; waitForChanges(); } }); }</code> <br> <br>    ,   ,     ,  ,    .    ,    reportError,             .       (  ),      2.5 . <br> <br>   ,     ,  lastServerTime ,    ,           .    ,    . <br> <br>    ,        localhost:8000,  ,  ,     ,    . <br> <br>  <br>      ,    .    , ,   <a href=""> </a>   <a href="http://nodejs.org/">Node.js</a> . <br> <br>     <br>      .     ,      . <br> <br>     ,            .    ,    . <br> <br>    <br>      ,       DOM   ,   .   .     -         ,          ,      ,      ,  . <br> <br>   ,        ,    .    ,   ? <br> <br>   <br>    ,     .         ,   if,    ,  . <br> <br>           ,   ("comment")     .      ‚Äútalk‚Äù,     ,    comments,    ,   ,    . <br> <br>     : <br> <br> <code class="html">&lt;div class="comments"&gt; &lt;div class="comment" template-repeat="comments"&gt; &lt;span class="name"&gt;{{author}}&lt;/span&gt;: {{message}} &lt;/div&gt; &lt;/div&gt;</code> <br> <br>   :       template-repeat,  ,     ,   ,   ,   .   ( values  instantiateTemplate)          ,   {{author}}     comment,    . <br> <br>  instantiateTemplate ,    ,    ,     ,          drawTalk. <br> <br>       ,      ,     true  false? <br> <br>    ? <br>  -       JavaScript,     .   - . <br> <br>   -     JavaScript.       ,      .         . <br> <br>   ,   -          JavaScript.     ,       .       ,     . <br> <br>     .    .          ,  ,    ?</code></code> <pre> <code class="hljs lua"><code class="html">  ID ‚Äútalks‚Äù    .   ,      . <br> <br>       . <br> <br> &lt;form id=<span class="hljs-string"><span class="hljs-string">"newtalk"</span></span>&gt; &lt;h3&gt;Submit a talk&lt;/h3&gt; : &lt;<span class="hljs-built_in"><span class="hljs-built_in">input</span></span> <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=<span class="hljs-string"><span class="hljs-string">"text"</span></span> style=<span class="hljs-string"><span class="hljs-string">"width: 40em"</span></span> name=<span class="hljs-string"><span class="hljs-string">"title"</span></span>&gt; &lt;br&gt; Summary: &lt;<span class="hljs-built_in"><span class="hljs-built_in">input</span></span> <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=<span class="hljs-string"><span class="hljs-string">"text"</span></span> style=<span class="hljs-string"><span class="hljs-string">"width: 40em"</span></span> name=<span class="hljs-string"><span class="hljs-string">"summary"</span></span>&gt; &lt;button <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=<span class="hljs-string"><span class="hljs-string">"submit"</span></span>&gt; &lt;/button&gt; &lt;/form&gt;</code> <br> <br>     ‚Äúsubmit‚Äù  ,      HTTP-,    . <br> <br>    ,    display   none,       . ,   ? <br> <br> <code class="html">&lt;div id=<span class="hljs-string"><span class="hljs-string">"template"</span></span> style=<span class="hljs-string"><span class="hljs-string">"display: none"</span></span>&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"talk"</span></span>&gt; &lt;h2&gt;{{title}}&lt;/h2&gt; &lt;div&gt;by &lt;span class=<span class="hljs-string"><span class="hljs-string">"name"</span></span>&gt;{{presenter}}&lt;/span&gt;&lt;/div&gt; &lt;p&gt;{{summary}}&lt;/p&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"comments"</span></span>&gt;&lt;/div&gt; &lt;form&gt; &lt;<span class="hljs-built_in"><span class="hljs-built_in">input</span></span> <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=<span class="hljs-string"><span class="hljs-string">"text"</span></span> name=<span class="hljs-string"><span class="hljs-string">"comment"</span></span>&gt; &lt;button <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=<span class="hljs-string"><span class="hljs-string">"submit"</span></span>&gt; &lt;/button&gt; &lt;button <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=<span class="hljs-string"><span class="hljs-string">"button"</span></span> class=<span class="hljs-string"><span class="hljs-string">"del"</span></span>&gt; &lt;/button&gt; &lt;/form&gt; &lt;/div&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"comment"</span></span>&gt; &lt;span class=<span class="hljs-string"><span class="hljs-string">"name"</span></span>&gt;{{author}}&lt;/span&gt;: {{message}} &lt;/div&gt; &lt;/div&gt;</code> <br> <br>    DOM  JavaScript    .          elt   <span class="hljs-number"><span class="hljs-number">13</span></span>,       ,  HTML,   -      DOM-. <br> <br>   DOM-   ,      ,    ,   ,     ‚Äì             . <br> <br>  , HTML   ,   . <br> <br> <code class="html">&lt;script src=<span class="hljs-string"><span class="hljs-string">"skillsharing_client.js"</span></span>&gt;&lt;/script&gt;</code> <br> <br>  <br> ,       ,       .       HTTP-,      XMLHttpRequest,            . <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">request</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(options, callback)</span></span></span></span> { var req = new XMLHttpRequest(); req.<span class="hljs-built_in"><span class="hljs-built_in">open</span></span>(options.method || <span class="hljs-string"><span class="hljs-string">"GET"</span></span>, options.pathname, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); req.addEventListener(<span class="hljs-string"><span class="hljs-string">"load"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (req.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> &lt; <span class="hljs-number"><span class="hljs-number">400</span></span>) callback(null, req.responseText); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> callback(new Error(<span class="hljs-string"><span class="hljs-string">"Request failed: "</span></span> + req.statusText)); }); req.addEventListener(<span class="hljs-string"><span class="hljs-string">"error"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { callback(new Error(<span class="hljs-string"><span class="hljs-string">"Network error"</span></span>)); }); req.send(options.body || null); }</code> <br> <br>            ,  waitForChanges. <br> <br> <code class="javascript">var lastServerTime = <span class="hljs-number"><span class="hljs-number">0</span></span>; request({pathname: <span class="hljs-string"><span class="hljs-string">"talks"</span></span>}, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(error, response)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>) { reportError(<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { response = JSON.parse(response); displayTalks(response.talks); lastServerTime = response.serverTime; waitForChanges(); } });</code> <br> <br>  lastServerTime      ,   .   ,        ,       .  ,  serverTime,   ,     lastServerTime. <br> <br>    ,   ,        .       reportError,      ,   . <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">reportError</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(error)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>) alert(<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>.toString()); }</code> <br> <br>  ,   ,       .  ,           ,     .      ,      . <br> <br>   <br>         ,    ,    . ,     ,     ,        .  ,      ,   DOM    . <br> <br>  displayTalks      ,       .     shownTalks,      DOM,   ,     . <br> <br> <code class="javascript">var talkDiv = document.querySelector(<span class="hljs-string"><span class="hljs-string">"#talks"</span></span>); var shownTalks = Object.<span class="hljs-built_in"><span class="hljs-built_in">create</span></span>(null); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">displayTalks</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(talks)</span></span></span></span> { talks.forEach(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(talk)</span></span></span></span> { var shown = shownTalks[talk.title]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (talk.deleted) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (shown) { talkDiv.removeChild(shown); delete shownTalks[talk.title]; } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { var node = drawTalk(talk); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (shown) talkDiv.replaceChild(node, shown); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> talkDiv.appendChild(node); shownTalks[talk.title] = node; } }); }</code> <br> <br>  DOM     ,   HTML .    instantiateTemplate,     . <br> <br>  name ‚Äì  .    ,   ,        ,       ID ‚Äútemplate‚Äù.  querySelector   .     ‚Äútalk‚Äù  ‚Äúcomment‚Äù. <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">instantiateTemplate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(name, values)</span></span></span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">instantiateText</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(text)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> text.replace(/\{\{(\w+)\}\}/g, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(_, name)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> values[name]; }); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">instantiate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(node)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (node.nodeType == document.ELEMENT_NODE) { var copy = node.cloneNode(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (var i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; node.childNodes.length; i++) copy.appendChild(instantiate(node.childNodes[i])); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> copy; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (node.nodeType == document.TEXT_NODE) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> document.createTextNode( instantiateText(node.nodeValue)); } } var template = document.querySelector(<span class="hljs-string"><span class="hljs-string">"#template ."</span></span> + name); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> instantiate(template); }</code> <br> <br>  cloneNode,      DOM,   .     ,       <span class="hljs-literal"><span class="hljs-literal">true</span></span>.  instantiate    ,     . <br> <br>   instantiateTemplate   ,    ,     .   {{title}}     ‚Äútitle‚Äù. <br> <br>      ,    drawTalk   . <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">drawTalk</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(talk)</span></span></span></span> { var node = instantiateTemplate(<span class="hljs-string"><span class="hljs-string">"talk"</span></span>, talk); var comments = node.querySelector(<span class="hljs-string"><span class="hljs-string">".comments"</span></span>); talk.comments.forEach(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(comment)</span></span></span></span> { comments.appendChild( instantiateTemplate(<span class="hljs-string"><span class="hljs-string">"comment"</span></span>, comment)); }); node.querySelector(<span class="hljs-string"><span class="hljs-string">"button.del"</span></span>).addEventListener( <span class="hljs-string"><span class="hljs-string">"click"</span></span>, deleteTalk.bind(null, talk.title)); var form = node.querySelector(<span class="hljs-string"><span class="hljs-string">"form"</span></span>); form.addEventListener(<span class="hljs-string"><span class="hljs-string">"submit"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(event)</span></span></span></span> { event.preventDefault(); addComment(talk.title, form.elements.comment.value); form.reset(); }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> node; }</code> <br> <br>     ‚Äútalk‚Äù    . -,   ,     ‚Äúcomment‚Äù       <span class="hljs-string"><span class="hljs-string">"comments"</span></span>. ,      ,      ,  . <br> <br>   <br>  ,   drawTalk,   deleteTalk  addComment   ,       .      URL,       ,       talkURL. <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">talkURL</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(title)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"talks/"</span></span> + encodeURIComponent(title); }</code> <br> <br>  deleteTalk   DELETE       . <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">deleteTalk</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(title)</span></span></span></span> { request({pathname: talkURL(title), method: <span class="hljs-string"><span class="hljs-string">"DELETE"</span></span>}, reportError); }</code> <br> <br>          JSON      POST-. <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">addComment</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(title, comment)</span></span></span></span> { var comment = {author: nameField.value, message: comment}; request({pathname: talkURL(title) + <span class="hljs-string"><span class="hljs-string">"/comments"</span></span>, body: JSON.stringify(comment), method: <span class="hljs-string"><span class="hljs-string">"POST"</span></span>}, reportError); }</code> <br> <br>  nameField,      author,    <code><code class="javascript">  ,      .       localStorage,          . <br> <br> var nameField = document.querySelector(<span class="hljs-string"><span class="hljs-string">"#name"</span></span>); nameField.value = localStorage.getItem(<span class="hljs-string"><span class="hljs-string">"name"</span></span>) || <span class="hljs-string"><span class="hljs-string">""</span></span>; nameField.addEventListener(<span class="hljs-string"><span class="hljs-string">"change"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { localStorage.setItem(<span class="hljs-string"><span class="hljs-string">"name"</span></span>, nameField.value); });           ‚Äúsubmit‚Äù.       (     ),     PUT-   . var talkForm = document.querySelector(<span class="hljs-string"><span class="hljs-string">"#newtalk"</span></span>); talkForm.addEventListener(<span class="hljs-string"><span class="hljs-string">"submit"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(event)</span></span></span></span> { event.preventDefault(); request({pathname: talkURL(talkForm.elements.title.value), method: <span class="hljs-string"><span class="hljs-string">"PUT"</span></span>, body: JSON.stringify({ presenter: nameField.value, summary: talkForm.elements.summary.value })}, reportError); talkForm.reset(); });</code> <br> <br>   <br>  ,   ,   ,    ,     ,     ,       .    -       ,     . <br> <br>       ,    displayTalks    ,     ,       . <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">waitForChanges</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { request({pathname: <span class="hljs-string"><span class="hljs-string">"talks?changesSince="</span></span> + lastServerTime}, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(error, response)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>) { setTimeout(waitForChanges, <span class="hljs-number"><span class="hljs-number">2500</span></span>); console.<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>.stack); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { response = JSON.parse(response); displayTalks(response.talks); lastServerTime = response.serverTime; waitForChanges(); } }); }</code> <br> <br>    ,   ,     ,  ,    .    ,    reportError,             .       (  ),      <span class="hljs-number"><span class="hljs-number">2.5</span></span> . <br> <br>   ,     ,  lastServerTime ,    ,           .    ,    . <br> <br>    ,        localhost:<span class="hljs-number"><span class="hljs-number">8000</span></span>,  ,  ,     ,    . <br> <br>  <br>      ,    .    , ,   <a href=""> </a>   <a href="http://nodejs.org/">Node.js</a> . <br> <br>     <br>      .     ,      . <br> <br>     ,            .    ,    . <br> <br>    <br>      ,       DOM   ,   .   .     -         ,          ,      ,      ,  . <br> <br>   ,        ,    .    ,   ? <br> <br>   <br>    ,     .         ,   <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>,    ,  . <br> <br>           ,   (<span class="hljs-string"><span class="hljs-string">"comment"</span></span>)     .      ‚Äútalk‚Äù,     ,    comments,    ,   ,    . <br> <br>     : <br> <br> <code class="html">&lt;div class=<span class="hljs-string"><span class="hljs-string">"comments"</span></span>&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"comment"</span></span> template-<span class="hljs-keyword"><span class="hljs-keyword">repeat</span></span>=<span class="hljs-string"><span class="hljs-string">"comments"</span></span>&gt; &lt;span class=<span class="hljs-string"><span class="hljs-string">"name"</span></span>&gt;{{author}}&lt;/span&gt;: {{message}} &lt;/div&gt; &lt;/div&gt;</code> <br> <br>   :       template-<span class="hljs-keyword"><span class="hljs-keyword">repeat</span></span>,  ,     ,   ,   ,   .   ( values  instantiateTemplate)          ,   {{author}}     comment,    . <br> <br>  instantiateTemplate ,    ,    ,     ,          drawTalk. <br> <br>       ,      ,     <span class="hljs-literal"><span class="hljs-literal">true</span></span>  <span class="hljs-literal"><span class="hljs-literal">false</span></span>? <br> <br>    ? <br>  -       JavaScript,     .   - . <br> <br>   -     JavaScript.       ,      .         . <br> <br>   ,   -          JavaScript.     ,       .       ,     . <br> <br>     .    .          ,  ,    ?</code></code> </pre> <code><code class="html">  ID ‚Äútalks‚Äù    .   ,      . <br> <br>       . <br> <br> &lt;form id="newtalk"&gt; &lt;h3&gt;Submit a talk&lt;/h3&gt; : &lt;input type="text" style="width: 40em" name="title"&gt; &lt;br&gt; Summary: &lt;input type="text" style="width: 40em" name="summary"&gt; &lt;button type="submit"&gt; &lt;/button&gt; &lt;/form&gt;</code> <br> <br>     ‚Äúsubmit‚Äù  ,      HTTP-,    . <br> <br>    ,    display   none,       . ,   ? <br> <br> <code class="html">&lt;div id="template" style="display: none"&gt; &lt;div class="talk"&gt; &lt;h2&gt;{{title}}&lt;/h2&gt; &lt;div&gt;by &lt;span class="name"&gt;{{presenter}}&lt;/span&gt;&lt;/div&gt; &lt;p&gt;{{summary}}&lt;/p&gt; &lt;div class="comments"&gt;&lt;/div&gt; &lt;form&gt; &lt;input type="text" name="comment"&gt; &lt;button type="submit"&gt; &lt;/button&gt; &lt;button type="button" class="del"&gt; &lt;/button&gt; &lt;/form&gt; &lt;/div&gt; &lt;div class="comment"&gt; &lt;span class="name"&gt;{{author}}&lt;/span&gt;: {{message}} &lt;/div&gt; &lt;/div&gt;</code> <br> <br>    DOM  JavaScript    .          elt   13,       ,  HTML,   -      DOM-. <br> <br>   DOM-   ,      ,    ,   ,     ‚Äì             . <br> <br>  , HTML   ,   . <br> <br> <code class="html">&lt;script src="skillsharing_client.js"&gt;&lt;/script&gt;</code> <br> <br>  <br> ,       ,       .       HTTP-,      XMLHttpRequest,            . <br> <br> <code class="javascript">function request(options, callback) { var req = new XMLHttpRequest(); req.open(options.method || "GET", options.pathname, true); req.addEventListener("load", function() { if (req.status &lt; 400) callback(null, req.responseText); else callback(new Error("Request failed: " + req.statusText)); }); req.addEventListener("error", function() { callback(new Error("Network error")); }); req.send(options.body || null); }</code> <br> <br>            ,  waitForChanges. <br> <br> <code class="javascript">var lastServerTime = 0; request({pathname: "talks"}, function(error, response) { if (error) { reportError(error); } else { response = JSON.parse(response); displayTalks(response.talks); lastServerTime = response.serverTime; waitForChanges(); } });</code> <br> <br>  lastServerTime      ,   .   ,        ,       .  ,  serverTime,   ,     lastServerTime. <br> <br>    ,   ,        .       reportError,      ,   . <br> <br> <code class="javascript">function reportError(error) { if (error) alert(error.toString()); }</code> <br> <br>  ,   ,       .  ,           ,     .      ,      . <br> <br>   <br>         ,    ,    . ,     ,     ,        .  ,      ,   DOM    . <br> <br>  displayTalks      ,       .     shownTalks,      DOM,   ,     . <br> <br> <code class="javascript">var talkDiv = document.querySelector("#talks"); var shownTalks = Object.create(null); function displayTalks(talks) { talks.forEach(function(talk) { var shown = shownTalks[talk.title]; if (talk.deleted) { if (shown) { talkDiv.removeChild(shown); delete shownTalks[talk.title]; } } else { var node = drawTalk(talk); if (shown) talkDiv.replaceChild(node, shown); else talkDiv.appendChild(node); shownTalks[talk.title] = node; } }); }</code> <br> <br>  DOM     ,   HTML .    instantiateTemplate,     . <br> <br>  name ‚Äì  .    ,   ,        ,       ID ‚Äútemplate‚Äù.  querySelector   .     ‚Äútalk‚Äù  ‚Äúcomment‚Äù. <br> <br> <code class="javascript">function instantiateTemplate(name, values) { function instantiateText(text) { return text.replace(/\{\{(\w+)\}\}/g, function(_, name) { return values[name]; }); } function instantiate(node) { if (node.nodeType == document.ELEMENT_NODE) { var copy = node.cloneNode(); for (var i = 0; i &lt; node.childNodes.length; i++) copy.appendChild(instantiate(node.childNodes[i])); return copy; } else if (node.nodeType == document.TEXT_NODE) { return document.createTextNode( instantiateText(node.nodeValue)); } } var template = document.querySelector("#template ." + name); return instantiate(template); }</code> <br> <br>  cloneNode,      DOM,   .     ,       true.  instantiate    ,     . <br> <br>   instantiateTemplate   ,    ,     .   {{title}}     ‚Äútitle‚Äù. <br> <br>      ,    drawTalk   . <br> <br> <code class="javascript">function drawTalk(talk) { var node = instantiateTemplate("talk", talk); var comments = node.querySelector(".comments"); talk.comments.forEach(function(comment) { comments.appendChild( instantiateTemplate("comment", comment)); }); node.querySelector("button.del").addEventListener( "click", deleteTalk.bind(null, talk.title)); var form = node.querySelector("form"); form.addEventListener("submit", function(event) { event.preventDefault(); addComment(talk.title, form.elements.comment.value); form.reset(); }); return node; }</code> <br> <br>     ‚Äútalk‚Äù    . -,   ,     ‚Äúcomment‚Äù       "comments". ,      ,      ,  . <br> <br>   <br>  ,   drawTalk,   deleteTalk  addComment   ,       .      URL,       ,       talkURL. <br> <br> <code class="javascript">function talkURL(title) { return "talks/" + encodeURIComponent(title); }</code> <br> <br>  deleteTalk   DELETE       . <br> <br> <code class="javascript">function deleteTalk(title) { request({pathname: talkURL(title), method: "DELETE"}, reportError); }</code> <br> <br>          JSON      POST-. <br> <br> <code class="javascript">function addComment(title, comment) { var comment = {author: nameField.value, message: comment}; request({pathname: talkURL(title) + "/comments", body: JSON.stringify(comment), method: "POST"}, reportError); }</code> <br> <br>  nameField,      author,    <code><code class="javascript">  ,      .       localStorage,          . <br> <br> var nameField = document.querySelector("#name"); nameField.value = localStorage.getItem("name") || ""; nameField.addEventListener("change", function() { localStorage.setItem("name", nameField.value); });           ‚Äúsubmit‚Äù.       (     ),     PUT-   . var talkForm = document.querySelector("#newtalk"); talkForm.addEventListener("submit", function(event) { event.preventDefault(); request({pathname: talkURL(talkForm.elements.title.value), method: "PUT", body: JSON.stringify({ presenter: nameField.value, summary: talkForm.elements.summary.value })}, reportError); talkForm.reset(); });</code> <br> <br>   <br>  ,   ,   ,    ,     ,     ,       .    -       ,     . <br> <br>       ,    displayTalks    ,     ,       . <br> <br> <code class="javascript">function waitForChanges() { request({pathname: "talks?changesSince=" + lastServerTime}, function(error, response) { if (error) { setTimeout(waitForChanges, 2500); console.error(error.stack); } else { response = JSON.parse(response); displayTalks(response.talks); lastServerTime = response.serverTime; waitForChanges(); } }); }</code> <br> <br>    ,   ,     ,  ,    .    ,    reportError,             .       (  ),      2.5 . <br> <br>   ,     ,  lastServerTime ,    ,           .    ,    . <br> <br>    ,        localhost:8000,  ,  ,     ,    . <br> <br>  <br>      ,    .    , ,   <a href=""> </a>   <a href="http://nodejs.org/">Node.js</a> . <br> <br>     <br>      .     ,      . <br> <br>     ,            .    ,    . <br> <br>    <br>      ,       DOM   ,   .   .     -         ,          ,      ,      ,  . <br> <br>   ,        ,    .    ,   ? <br> <br>   <br>    ,     .         ,   if,    ,  . <br> <br>           ,   ("comment")     .      ‚Äútalk‚Äù,     ,    comments,    ,   ,    . <br> <br>     : <br> <br> <code class="html">&lt;div class="comments"&gt; &lt;div class="comment" template-repeat="comments"&gt; &lt;span class="name"&gt;{{author}}&lt;/span&gt;: {{message}} &lt;/div&gt; &lt;/div&gt;</code> <br> <br>   :       template-repeat,  ,     ,   ,   ,   .   ( values  instantiateTemplate)          ,   {{author}}     comment,    . <br> <br>  instantiateTemplate ,    ,    ,     ,          drawTalk. <br> <br>       ,      ,     true  false? <br> <br>    ? <br>  -       JavaScript,     .   - . <br> <br>   -     JavaScript.       ,      .         . <br> <br>   ,   -          JavaScript.     ,       .       ,     . <br> <br>     .    .          ,  ,    ?</code></code> <pre> <code class="hljs lua"><code class="html">  ID ‚Äútalks‚Äù    .   ,      . <br> <br>       . <br> <br> &lt;form id=<span class="hljs-string"><span class="hljs-string">"newtalk"</span></span>&gt; &lt;h3&gt;Submit a talk&lt;/h3&gt; : &lt;<span class="hljs-built_in"><span class="hljs-built_in">input</span></span> <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=<span class="hljs-string"><span class="hljs-string">"text"</span></span> style=<span class="hljs-string"><span class="hljs-string">"width: 40em"</span></span> name=<span class="hljs-string"><span class="hljs-string">"title"</span></span>&gt; &lt;br&gt; Summary: &lt;<span class="hljs-built_in"><span class="hljs-built_in">input</span></span> <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=<span class="hljs-string"><span class="hljs-string">"text"</span></span> style=<span class="hljs-string"><span class="hljs-string">"width: 40em"</span></span> name=<span class="hljs-string"><span class="hljs-string">"summary"</span></span>&gt; &lt;button <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=<span class="hljs-string"><span class="hljs-string">"submit"</span></span>&gt; &lt;/button&gt; &lt;/form&gt;</code> <br> <br>     ‚Äúsubmit‚Äù  ,      HTTP-,    . <br> <br>    ,    display   none,       . ,   ? <br> <br> <code class="html">&lt;div id=<span class="hljs-string"><span class="hljs-string">"template"</span></span> style=<span class="hljs-string"><span class="hljs-string">"display: none"</span></span>&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"talk"</span></span>&gt; &lt;h2&gt;{{title}}&lt;/h2&gt; &lt;div&gt;by &lt;span class=<span class="hljs-string"><span class="hljs-string">"name"</span></span>&gt;{{presenter}}&lt;/span&gt;&lt;/div&gt; &lt;p&gt;{{summary}}&lt;/p&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"comments"</span></span>&gt;&lt;/div&gt; &lt;form&gt; &lt;<span class="hljs-built_in"><span class="hljs-built_in">input</span></span> <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=<span class="hljs-string"><span class="hljs-string">"text"</span></span> name=<span class="hljs-string"><span class="hljs-string">"comment"</span></span>&gt; &lt;button <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=<span class="hljs-string"><span class="hljs-string">"submit"</span></span>&gt; &lt;/button&gt; &lt;button <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=<span class="hljs-string"><span class="hljs-string">"button"</span></span> class=<span class="hljs-string"><span class="hljs-string">"del"</span></span>&gt; &lt;/button&gt; &lt;/form&gt; &lt;/div&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"comment"</span></span>&gt; &lt;span class=<span class="hljs-string"><span class="hljs-string">"name"</span></span>&gt;{{author}}&lt;/span&gt;: {{message}} &lt;/div&gt; &lt;/div&gt;</code> <br> <br>    DOM  JavaScript    .          elt   <span class="hljs-number"><span class="hljs-number">13</span></span>,       ,  HTML,   -      DOM-. <br> <br>   DOM-   ,      ,    ,   ,     ‚Äì             . <br> <br>  , HTML   ,   . <br> <br> <code class="html">&lt;script src=<span class="hljs-string"><span class="hljs-string">"skillsharing_client.js"</span></span>&gt;&lt;/script&gt;</code> <br> <br>  <br> ,       ,       .       HTTP-,      XMLHttpRequest,            . <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">request</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(options, callback)</span></span></span></span> { var req = new XMLHttpRequest(); req.<span class="hljs-built_in"><span class="hljs-built_in">open</span></span>(options.method || <span class="hljs-string"><span class="hljs-string">"GET"</span></span>, options.pathname, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); req.addEventListener(<span class="hljs-string"><span class="hljs-string">"load"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (req.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> &lt; <span class="hljs-number"><span class="hljs-number">400</span></span>) callback(null, req.responseText); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> callback(new Error(<span class="hljs-string"><span class="hljs-string">"Request failed: "</span></span> + req.statusText)); }); req.addEventListener(<span class="hljs-string"><span class="hljs-string">"error"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { callback(new Error(<span class="hljs-string"><span class="hljs-string">"Network error"</span></span>)); }); req.send(options.body || null); }</code> <br> <br>            ,  waitForChanges. <br> <br> <code class="javascript">var lastServerTime = <span class="hljs-number"><span class="hljs-number">0</span></span>; request({pathname: <span class="hljs-string"><span class="hljs-string">"talks"</span></span>}, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(error, response)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>) { reportError(<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { response = JSON.parse(response); displayTalks(response.talks); lastServerTime = response.serverTime; waitForChanges(); } });</code> <br> <br>  lastServerTime      ,   .   ,        ,       .  ,  serverTime,   ,     lastServerTime. <br> <br>    ,   ,        .       reportError,      ,   . <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">reportError</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(error)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>) alert(<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>.toString()); }</code> <br> <br>  ,   ,       .  ,           ,     .      ,      . <br> <br>   <br>         ,    ,    . ,     ,     ,        .  ,      ,   DOM    . <br> <br>  displayTalks      ,       .     shownTalks,      DOM,   ,     . <br> <br> <code class="javascript">var talkDiv = document.querySelector(<span class="hljs-string"><span class="hljs-string">"#talks"</span></span>); var shownTalks = Object.<span class="hljs-built_in"><span class="hljs-built_in">create</span></span>(null); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">displayTalks</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(talks)</span></span></span></span> { talks.forEach(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(talk)</span></span></span></span> { var shown = shownTalks[talk.title]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (talk.deleted) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (shown) { talkDiv.removeChild(shown); delete shownTalks[talk.title]; } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { var node = drawTalk(talk); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (shown) talkDiv.replaceChild(node, shown); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> talkDiv.appendChild(node); shownTalks[talk.title] = node; } }); }</code> <br> <br>  DOM     ,   HTML .    instantiateTemplate,     . <br> <br>  name ‚Äì  .    ,   ,        ,       ID ‚Äútemplate‚Äù.  querySelector   .     ‚Äútalk‚Äù  ‚Äúcomment‚Äù. <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">instantiateTemplate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(name, values)</span></span></span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">instantiateText</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(text)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> text.replace(/\{\{(\w+)\}\}/g, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(_, name)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> values[name]; }); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">instantiate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(node)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (node.nodeType == document.ELEMENT_NODE) { var copy = node.cloneNode(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (var i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; node.childNodes.length; i++) copy.appendChild(instantiate(node.childNodes[i])); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> copy; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (node.nodeType == document.TEXT_NODE) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> document.createTextNode( instantiateText(node.nodeValue)); } } var template = document.querySelector(<span class="hljs-string"><span class="hljs-string">"#template ."</span></span> + name); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> instantiate(template); }</code> <br> <br>  cloneNode,      DOM,   .     ,       <span class="hljs-literal"><span class="hljs-literal">true</span></span>.  instantiate    ,     . <br> <br>   instantiateTemplate   ,    ,     .   {{title}}     ‚Äútitle‚Äù. <br> <br>      ,    drawTalk   . <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">drawTalk</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(talk)</span></span></span></span> { var node = instantiateTemplate(<span class="hljs-string"><span class="hljs-string">"talk"</span></span>, talk); var comments = node.querySelector(<span class="hljs-string"><span class="hljs-string">".comments"</span></span>); talk.comments.forEach(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(comment)</span></span></span></span> { comments.appendChild( instantiateTemplate(<span class="hljs-string"><span class="hljs-string">"comment"</span></span>, comment)); }); node.querySelector(<span class="hljs-string"><span class="hljs-string">"button.del"</span></span>).addEventListener( <span class="hljs-string"><span class="hljs-string">"click"</span></span>, deleteTalk.bind(null, talk.title)); var form = node.querySelector(<span class="hljs-string"><span class="hljs-string">"form"</span></span>); form.addEventListener(<span class="hljs-string"><span class="hljs-string">"submit"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(event)</span></span></span></span> { event.preventDefault(); addComment(talk.title, form.elements.comment.value); form.reset(); }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> node; }</code> <br> <br>     ‚Äútalk‚Äù    . -,   ,     ‚Äúcomment‚Äù       <span class="hljs-string"><span class="hljs-string">"comments"</span></span>. ,      ,      ,  . <br> <br>   <br>  ,   drawTalk,   deleteTalk  addComment   ,       .      URL,       ,       talkURL. <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">talkURL</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(title)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"talks/"</span></span> + encodeURIComponent(title); }</code> <br> <br>  deleteTalk   DELETE       . <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">deleteTalk</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(title)</span></span></span></span> { request({pathname: talkURL(title), method: <span class="hljs-string"><span class="hljs-string">"DELETE"</span></span>}, reportError); }</code> <br> <br>          JSON      POST-. <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">addComment</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(title, comment)</span></span></span></span> { var comment = {author: nameField.value, message: comment}; request({pathname: talkURL(title) + <span class="hljs-string"><span class="hljs-string">"/comments"</span></span>, body: JSON.stringify(comment), method: <span class="hljs-string"><span class="hljs-string">"POST"</span></span>}, reportError); }</code> <br> <br>  nameField,      author,    <code><code class="javascript">  ,      .       localStorage,          . <br> <br> var nameField = document.querySelector(<span class="hljs-string"><span class="hljs-string">"#name"</span></span>); nameField.value = localStorage.getItem(<span class="hljs-string"><span class="hljs-string">"name"</span></span>) || <span class="hljs-string"><span class="hljs-string">""</span></span>; nameField.addEventListener(<span class="hljs-string"><span class="hljs-string">"change"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { localStorage.setItem(<span class="hljs-string"><span class="hljs-string">"name"</span></span>, nameField.value); });           ‚Äúsubmit‚Äù.       (     ),     PUT-   . var talkForm = document.querySelector(<span class="hljs-string"><span class="hljs-string">"#newtalk"</span></span>); talkForm.addEventListener(<span class="hljs-string"><span class="hljs-string">"submit"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(event)</span></span></span></span> { event.preventDefault(); request({pathname: talkURL(talkForm.elements.title.value), method: <span class="hljs-string"><span class="hljs-string">"PUT"</span></span>, body: JSON.stringify({ presenter: nameField.value, summary: talkForm.elements.summary.value })}, reportError); talkForm.reset(); });</code> <br> <br>   <br>  ,   ,   ,    ,     ,     ,       .    -       ,     . <br> <br>       ,    displayTalks    ,     ,       . <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">waitForChanges</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { request({pathname: <span class="hljs-string"><span class="hljs-string">"talks?changesSince="</span></span> + lastServerTime}, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(error, response)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>) { setTimeout(waitForChanges, <span class="hljs-number"><span class="hljs-number">2500</span></span>); console.<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>.stack); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { response = JSON.parse(response); displayTalks(response.talks); lastServerTime = response.serverTime; waitForChanges(); } }); }</code> <br> <br>    ,   ,     ,  ,    .    ,    reportError,             .       (  ),      <span class="hljs-number"><span class="hljs-number">2.5</span></span> . <br> <br>   ,     ,  lastServerTime ,    ,           .    ,    . <br> <br>    ,        localhost:<span class="hljs-number"><span class="hljs-number">8000</span></span>,  ,  ,     ,    . <br> <br>  <br>      ,    .    , ,   <a href=""> </a>   <a href="http://nodejs.org/">Node.js</a> . <br> <br>     <br>      .     ,      . <br> <br>     ,            .    ,    . <br> <br>    <br>      ,       DOM   ,   .   .     -         ,          ,      ,      ,  . <br> <br>   ,        ,    .    ,   ? <br> <br>   <br>    ,     .         ,   <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>,    ,  . <br> <br>           ,   (<span class="hljs-string"><span class="hljs-string">"comment"</span></span>)     .      ‚Äútalk‚Äù,     ,    comments,    ,   ,    . <br> <br>     : <br> <br> <code class="html">&lt;div class=<span class="hljs-string"><span class="hljs-string">"comments"</span></span>&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"comment"</span></span> template-<span class="hljs-keyword"><span class="hljs-keyword">repeat</span></span>=<span class="hljs-string"><span class="hljs-string">"comments"</span></span>&gt; &lt;span class=<span class="hljs-string"><span class="hljs-string">"name"</span></span>&gt;{{author}}&lt;/span&gt;: {{message}} &lt;/div&gt; &lt;/div&gt;</code> <br> <br>   :       template-<span class="hljs-keyword"><span class="hljs-keyword">repeat</span></span>,  ,     ,   ,   ,   .   ( values  instantiateTemplate)          ,   {{author}}     comment,    . <br> <br>  instantiateTemplate ,    ,    ,     ,          drawTalk. <br> <br>       ,      ,     <span class="hljs-literal"><span class="hljs-literal">true</span></span>  <span class="hljs-literal"><span class="hljs-literal">false</span></span>? <br> <br>    ? <br>  -       JavaScript,     .   - . <br> <br>   -     JavaScript.       ,      .         . <br> <br>   ,   -          JavaScript.     ,       .       ,     . <br> <br>     .    .          ,  ,    ?</code></code> </pre> <code><code class="html">  ID ‚Äútalks‚Äù    .   ,      . <br> <br>       . <br> <br> &lt;form id="newtalk"&gt; &lt;h3&gt;Submit a talk&lt;/h3&gt; : &lt;input type="text" style="width: 40em" name="title"&gt; &lt;br&gt; Summary: &lt;input type="text" style="width: 40em" name="summary"&gt; &lt;button type="submit"&gt; &lt;/button&gt; &lt;/form&gt;</code> <br> <br>     ‚Äúsubmit‚Äù  ,      HTTP-,    . <br> <br>    ,    display   none,       . ,   ? <br> <br> <code class="html">&lt;div id="template" style="display: none"&gt; &lt;div class="talk"&gt; &lt;h2&gt;{{title}}&lt;/h2&gt; &lt;div&gt;by &lt;span class="name"&gt;{{presenter}}&lt;/span&gt;&lt;/div&gt; &lt;p&gt;{{summary}}&lt;/p&gt; &lt;div class="comments"&gt;&lt;/div&gt; &lt;form&gt; &lt;input type="text" name="comment"&gt; &lt;button type="submit"&gt; &lt;/button&gt; &lt;button type="button" class="del"&gt; &lt;/button&gt; &lt;/form&gt; &lt;/div&gt; &lt;div class="comment"&gt; &lt;span class="name"&gt;{{author}}&lt;/span&gt;: {{message}} &lt;/div&gt; &lt;/div&gt;</code> <br> <br>    DOM  JavaScript    .          elt   13,       ,  HTML,   -      DOM-. <br> <br>   DOM-   ,      ,    ,   ,     ‚Äì             . <br> <br>  , HTML   ,   . <br> <br> <code class="html">&lt;script src="skillsharing_client.js"&gt;&lt;/script&gt;</code> <br> <br>  <br> ,       ,       .       HTTP-,      XMLHttpRequest,            . <br> <br> <code class="javascript">function request(options, callback) { var req = new XMLHttpRequest(); req.open(options.method || "GET", options.pathname, true); req.addEventListener("load", function() { if (req.status &lt; 400) callback(null, req.responseText); else callback(new Error("Request failed: " + req.statusText)); }); req.addEventListener("error", function() { callback(new Error("Network error")); }); req.send(options.body || null); }</code> <br> <br>            ,  waitForChanges. <br> <br> <code class="javascript">var lastServerTime = 0; request({pathname: "talks"}, function(error, response) { if (error) { reportError(error); } else { response = JSON.parse(response); displayTalks(response.talks); lastServerTime = response.serverTime; waitForChanges(); } });</code> <br> <br>  lastServerTime      ,   .   ,        ,       .  ,  serverTime,   ,     lastServerTime. <br> <br>    ,   ,        .       reportError,      ,   . <br> <br> <code class="javascript">function reportError(error) { if (error) alert(error.toString()); }</code> <br> <br>  ,   ,       .  ,           ,     .      ,      . <br> <br>   <br>         ,    ,    . ,     ,     ,        .  ,      ,   DOM    . <br> <br>  displayTalks      ,       .     shownTalks,      DOM,   ,     . <br> <br> <code class="javascript">var talkDiv = document.querySelector("#talks"); var shownTalks = Object.create(null); function displayTalks(talks) { talks.forEach(function(talk) { var shown = shownTalks[talk.title]; if (talk.deleted) { if (shown) { talkDiv.removeChild(shown); delete shownTalks[talk.title]; } } else { var node = drawTalk(talk); if (shown) talkDiv.replaceChild(node, shown); else talkDiv.appendChild(node); shownTalks[talk.title] = node; } }); }</code> <br> <br>  DOM     ,   HTML .    instantiateTemplate,     . <br> <br>  name ‚Äì  .    ,   ,        ,       ID ‚Äútemplate‚Äù.  querySelector   .     ‚Äútalk‚Äù  ‚Äúcomment‚Äù. <br> <br> <code class="javascript">function instantiateTemplate(name, values) { function instantiateText(text) { return text.replace(/\{\{(\w+)\}\}/g, function(_, name) { return values[name]; }); } function instantiate(node) { if (node.nodeType == document.ELEMENT_NODE) { var copy = node.cloneNode(); for (var i = 0; i &lt; node.childNodes.length; i++) copy.appendChild(instantiate(node.childNodes[i])); return copy; } else if (node.nodeType == document.TEXT_NODE) { return document.createTextNode( instantiateText(node.nodeValue)); } } var template = document.querySelector("#template ." + name); return instantiate(template); }</code> <br> <br>  cloneNode,      DOM,   .     ,       true.  instantiate    ,     . <br> <br>   instantiateTemplate   ,    ,     .   {{title}}     ‚Äútitle‚Äù. <br> <br>      ,    drawTalk   . <br> <br> <code class="javascript">function drawTalk(talk) { var node = instantiateTemplate("talk", talk); var comments = node.querySelector(".comments"); talk.comments.forEach(function(comment) { comments.appendChild( instantiateTemplate("comment", comment)); }); node.querySelector("button.del").addEventListener( "click", deleteTalk.bind(null, talk.title)); var form = node.querySelector("form"); form.addEventListener("submit", function(event) { event.preventDefault(); addComment(talk.title, form.elements.comment.value); form.reset(); }); return node; }</code> <br> <br>     ‚Äútalk‚Äù    . -,   ,     ‚Äúcomment‚Äù       "comments". ,      ,      ,  . <br> <br>   <br>  ,   drawTalk,   deleteTalk  addComment   ,       .      URL,       ,       talkURL. <br> <br> <code class="javascript">function talkURL(title) { return "talks/" + encodeURIComponent(title); }</code> <br> <br>  deleteTalk   DELETE       . <br> <br> <code class="javascript">function deleteTalk(title) { request({pathname: talkURL(title), method: "DELETE"}, reportError); }</code> <br> <br>          JSON      POST-. <br> <br> <code class="javascript">function addComment(title, comment) { var comment = {author: nameField.value, message: comment}; request({pathname: talkURL(title) + "/comments", body: JSON.stringify(comment), method: "POST"}, reportError); }</code> <br> <br>  nameField,      author,    <code><code class="javascript">  ,      .       localStorage,          . <br> <br> var nameField = document.querySelector("#name"); nameField.value = localStorage.getItem("name") || ""; nameField.addEventListener("change", function() { localStorage.setItem("name", nameField.value); });           ‚Äúsubmit‚Äù.       (     ),     PUT-   . var talkForm = document.querySelector("#newtalk"); talkForm.addEventListener("submit", function(event) { event.preventDefault(); request({pathname: talkURL(talkForm.elements.title.value), method: "PUT", body: JSON.stringify({ presenter: nameField.value, summary: talkForm.elements.summary.value })}, reportError); talkForm.reset(); });</code> <br> <br>   <br>  ,   ,   ,    ,     ,     ,       .    -       ,     . <br> <br>       ,    displayTalks    ,     ,       . <br> <br> <code class="javascript">function waitForChanges() { request({pathname: "talks?changesSince=" + lastServerTime}, function(error, response) { if (error) { setTimeout(waitForChanges, 2500); console.error(error.stack); } else { response = JSON.parse(response); displayTalks(response.talks); lastServerTime = response.serverTime; waitForChanges(); } }); }</code> <br> <br>    ,   ,     ,  ,    .    ,    reportError,             .       (  ),      2.5 . <br> <br>   ,     ,  lastServerTime ,    ,           .    ,    . <br> <br>    ,        localhost:8000,  ,  ,     ,    . <br> <br>  <br>      ,    .    , ,   <a href=""> </a>   <a href="http://nodejs.org/">Node.js</a> . <br> <br>     <br>      .     ,      . <br> <br>     ,            .    ,    . <br> <br>    <br>      ,       DOM   ,   .   .     -         ,          ,      ,      ,  . <br> <br>   ,        ,    .    ,   ? <br> <br>   <br>    ,     .         ,   if,    ,  . <br> <br>           ,   ("comment")     .      ‚Äútalk‚Äù,     ,    comments,    ,   ,    . <br> <br>     : <br> <br> <code class="html">&lt;div class="comments"&gt; &lt;div class="comment" template-repeat="comments"&gt; &lt;span class="name"&gt;{{author}}&lt;/span&gt;: {{message}} &lt;/div&gt; &lt;/div&gt;</code> <br> <br>   :       template-repeat,  ,     ,   ,   ,   .   ( values  instantiateTemplate)          ,   {{author}}     comment,    . <br> <br>  instantiateTemplate ,    ,    ,     ,          drawTalk. <br> <br>       ,      ,     true  false? <br> <br>    ? <br>  -       JavaScript,     .   - . <br> <br>   -     JavaScript.       ,      .         . <br> <br>   ,   -          JavaScript.     ,       .       ,     . <br> <br>     .    .          ,  ,    ?</code></code> <pre> <code class="hljs lua"><code class="html">  ID ‚Äútalks‚Äù    .   ,      . <br> <br>       . <br> <br> &lt;form id=<span class="hljs-string"><span class="hljs-string">"newtalk"</span></span>&gt; &lt;h3&gt;Submit a talk&lt;/h3&gt; : &lt;<span class="hljs-built_in"><span class="hljs-built_in">input</span></span> <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=<span class="hljs-string"><span class="hljs-string">"text"</span></span> style=<span class="hljs-string"><span class="hljs-string">"width: 40em"</span></span> name=<span class="hljs-string"><span class="hljs-string">"title"</span></span>&gt; &lt;br&gt; Summary: &lt;<span class="hljs-built_in"><span class="hljs-built_in">input</span></span> <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=<span class="hljs-string"><span class="hljs-string">"text"</span></span> style=<span class="hljs-string"><span class="hljs-string">"width: 40em"</span></span> name=<span class="hljs-string"><span class="hljs-string">"summary"</span></span>&gt; &lt;button <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=<span class="hljs-string"><span class="hljs-string">"submit"</span></span>&gt; &lt;/button&gt; &lt;/form&gt;</code> <br> <br>     ‚Äúsubmit‚Äù  ,      HTTP-,    . <br> <br>    ,    display   none,       . ,   ? <br> <br> <code class="html">&lt;div id=<span class="hljs-string"><span class="hljs-string">"template"</span></span> style=<span class="hljs-string"><span class="hljs-string">"display: none"</span></span>&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"talk"</span></span>&gt; &lt;h2&gt;{{title}}&lt;/h2&gt; &lt;div&gt;by &lt;span class=<span class="hljs-string"><span class="hljs-string">"name"</span></span>&gt;{{presenter}}&lt;/span&gt;&lt;/div&gt; &lt;p&gt;{{summary}}&lt;/p&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"comments"</span></span>&gt;&lt;/div&gt; &lt;form&gt; &lt;<span class="hljs-built_in"><span class="hljs-built_in">input</span></span> <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=<span class="hljs-string"><span class="hljs-string">"text"</span></span> name=<span class="hljs-string"><span class="hljs-string">"comment"</span></span>&gt; &lt;button <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=<span class="hljs-string"><span class="hljs-string">"submit"</span></span>&gt; &lt;/button&gt; &lt;button <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=<span class="hljs-string"><span class="hljs-string">"button"</span></span> class=<span class="hljs-string"><span class="hljs-string">"del"</span></span>&gt; &lt;/button&gt; &lt;/form&gt; &lt;/div&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"comment"</span></span>&gt; &lt;span class=<span class="hljs-string"><span class="hljs-string">"name"</span></span>&gt;{{author}}&lt;/span&gt;: {{message}} &lt;/div&gt; &lt;/div&gt;</code> <br> <br>    DOM  JavaScript    .          elt   <span class="hljs-number"><span class="hljs-number">13</span></span>,       ,  HTML,   -      DOM-. <br> <br>   DOM-   ,      ,    ,   ,     ‚Äì             . <br> <br>  , HTML   ,   . <br> <br> <code class="html">&lt;script src=<span class="hljs-string"><span class="hljs-string">"skillsharing_client.js"</span></span>&gt;&lt;/script&gt;</code> <br> <br>  <br> ,       ,       .       HTTP-,      XMLHttpRequest,            . <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">request</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(options, callback)</span></span></span></span> { var req = new XMLHttpRequest(); req.<span class="hljs-built_in"><span class="hljs-built_in">open</span></span>(options.method || <span class="hljs-string"><span class="hljs-string">"GET"</span></span>, options.pathname, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); req.addEventListener(<span class="hljs-string"><span class="hljs-string">"load"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (req.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> &lt; <span class="hljs-number"><span class="hljs-number">400</span></span>) callback(null, req.responseText); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> callback(new Error(<span class="hljs-string"><span class="hljs-string">"Request failed: "</span></span> + req.statusText)); }); req.addEventListener(<span class="hljs-string"><span class="hljs-string">"error"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { callback(new Error(<span class="hljs-string"><span class="hljs-string">"Network error"</span></span>)); }); req.send(options.body || null); }</code> <br> <br>            ,  waitForChanges. <br> <br> <code class="javascript">var lastServerTime = <span class="hljs-number"><span class="hljs-number">0</span></span>; request({pathname: <span class="hljs-string"><span class="hljs-string">"talks"</span></span>}, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(error, response)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>) { reportError(<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { response = JSON.parse(response); displayTalks(response.talks); lastServerTime = response.serverTime; waitForChanges(); } });</code> <br> <br>  lastServerTime      ,   .   ,        ,       .  ,  serverTime,   ,     lastServerTime. <br> <br>    ,   ,        .       reportError,      ,   . <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">reportError</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(error)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>) alert(<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>.toString()); }</code> <br> <br>  ,   ,       .  ,           ,     .      ,      . <br> <br>   <br>         ,    ,    . ,     ,     ,        .  ,      ,   DOM    . <br> <br>  displayTalks      ,       .     shownTalks,      DOM,   ,     . <br> <br> <code class="javascript">var talkDiv = document.querySelector(<span class="hljs-string"><span class="hljs-string">"#talks"</span></span>); var shownTalks = Object.<span class="hljs-built_in"><span class="hljs-built_in">create</span></span>(null); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">displayTalks</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(talks)</span></span></span></span> { talks.forEach(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(talk)</span></span></span></span> { var shown = shownTalks[talk.title]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (talk.deleted) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (shown) { talkDiv.removeChild(shown); delete shownTalks[talk.title]; } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { var node = drawTalk(talk); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (shown) talkDiv.replaceChild(node, shown); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> talkDiv.appendChild(node); shownTalks[talk.title] = node; } }); }</code> <br> <br>  DOM     ,   HTML .    instantiateTemplate,     . <br> <br>  name ‚Äì  .    ,   ,        ,       ID ‚Äútemplate‚Äù.  querySelector   .     ‚Äútalk‚Äù  ‚Äúcomment‚Äù. <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">instantiateTemplate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(name, values)</span></span></span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">instantiateText</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(text)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> text.replace(/\{\{(\w+)\}\}/g, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(_, name)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> values[name]; }); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">instantiate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(node)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (node.nodeType == document.ELEMENT_NODE) { var copy = node.cloneNode(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (var i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; node.childNodes.length; i++) copy.appendChild(instantiate(node.childNodes[i])); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> copy; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (node.nodeType == document.TEXT_NODE) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> document.createTextNode( instantiateText(node.nodeValue)); } } var template = document.querySelector(<span class="hljs-string"><span class="hljs-string">"#template ."</span></span> + name); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> instantiate(template); }</code> <br> <br>  cloneNode,      DOM,   .     ,       <span class="hljs-literal"><span class="hljs-literal">true</span></span>.  instantiate    ,     . <br> <br>   instantiateTemplate   ,    ,     .   {{title}}     ‚Äútitle‚Äù. <br> <br>      ,    drawTalk   . <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">drawTalk</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(talk)</span></span></span></span> { var node = instantiateTemplate(<span class="hljs-string"><span class="hljs-string">"talk"</span></span>, talk); var comments = node.querySelector(<span class="hljs-string"><span class="hljs-string">".comments"</span></span>); talk.comments.forEach(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(comment)</span></span></span></span> { comments.appendChild( instantiateTemplate(<span class="hljs-string"><span class="hljs-string">"comment"</span></span>, comment)); }); node.querySelector(<span class="hljs-string"><span class="hljs-string">"button.del"</span></span>).addEventListener( <span class="hljs-string"><span class="hljs-string">"click"</span></span>, deleteTalk.bind(null, talk.title)); var form = node.querySelector(<span class="hljs-string"><span class="hljs-string">"form"</span></span>); form.addEventListener(<span class="hljs-string"><span class="hljs-string">"submit"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(event)</span></span></span></span> { event.preventDefault(); addComment(talk.title, form.elements.comment.value); form.reset(); }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> node; }</code> <br> <br>     ‚Äútalk‚Äù    . -,   ,     ‚Äúcomment‚Äù       <span class="hljs-string"><span class="hljs-string">"comments"</span></span>. ,      ,      ,  . <br> <br>   <br>  ,   drawTalk,   deleteTalk  addComment   ,       .      URL,       ,       talkURL. <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">talkURL</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(title)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"talks/"</span></span> + encodeURIComponent(title); }</code> <br> <br>  deleteTalk   DELETE       . <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">deleteTalk</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(title)</span></span></span></span> { request({pathname: talkURL(title), method: <span class="hljs-string"><span class="hljs-string">"DELETE"</span></span>}, reportError); }</code> <br> <br>          JSON      POST-. <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">addComment</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(title, comment)</span></span></span></span> { var comment = {author: nameField.value, message: comment}; request({pathname: talkURL(title) + <span class="hljs-string"><span class="hljs-string">"/comments"</span></span>, body: JSON.stringify(comment), method: <span class="hljs-string"><span class="hljs-string">"POST"</span></span>}, reportError); }</code> <br> <br>  nameField,      author,    <code><code class="javascript">  ,      .       localStorage,          . <br> <br> var nameField = document.querySelector(<span class="hljs-string"><span class="hljs-string">"#name"</span></span>); nameField.value = localStorage.getItem(<span class="hljs-string"><span class="hljs-string">"name"</span></span>) || <span class="hljs-string"><span class="hljs-string">""</span></span>; nameField.addEventListener(<span class="hljs-string"><span class="hljs-string">"change"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { localStorage.setItem(<span class="hljs-string"><span class="hljs-string">"name"</span></span>, nameField.value); });           ‚Äúsubmit‚Äù.       (     ),     PUT-   . var talkForm = document.querySelector(<span class="hljs-string"><span class="hljs-string">"#newtalk"</span></span>); talkForm.addEventListener(<span class="hljs-string"><span class="hljs-string">"submit"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(event)</span></span></span></span> { event.preventDefault(); request({pathname: talkURL(talkForm.elements.title.value), method: <span class="hljs-string"><span class="hljs-string">"PUT"</span></span>, body: JSON.stringify({ presenter: nameField.value, summary: talkForm.elements.summary.value })}, reportError); talkForm.reset(); });</code> <br> <br>   <br>  ,   ,   ,    ,     ,     ,       .    -       ,     . <br> <br>       ,    displayTalks    ,     ,       . <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">waitForChanges</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { request({pathname: <span class="hljs-string"><span class="hljs-string">"talks?changesSince="</span></span> + lastServerTime}, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(error, response)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>) { setTimeout(waitForChanges, <span class="hljs-number"><span class="hljs-number">2500</span></span>); console.<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>.stack); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { response = JSON.parse(response); displayTalks(response.talks); lastServerTime = response.serverTime; waitForChanges(); } }); }</code> <br> <br>    ,   ,     ,  ,    .    ,    reportError,             .       (  ),      <span class="hljs-number"><span class="hljs-number">2.5</span></span> . <br> <br>   ,     ,  lastServerTime ,    ,           .    ,    . <br> <br>    ,        localhost:<span class="hljs-number"><span class="hljs-number">8000</span></span>,  ,  ,     ,    . <br> <br>  <br>      ,    .    , ,   <a href=""> </a>   <a href="http://nodejs.org/">Node.js</a> . <br> <br>     <br>      .     ,      . <br> <br>     ,            .    ,    . <br> <br>    <br>      ,       DOM   ,   .   .     -         ,          ,      ,      ,  . <br> <br>   ,        ,    .    ,   ? <br> <br>   <br>    ,     .         ,   <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>,    ,  . <br> <br>           ,   (<span class="hljs-string"><span class="hljs-string">"comment"</span></span>)     .      ‚Äútalk‚Äù,     ,    comments,    ,   ,    . <br> <br>     : <br> <br> <code class="html">&lt;div class=<span class="hljs-string"><span class="hljs-string">"comments"</span></span>&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"comment"</span></span> template-<span class="hljs-keyword"><span class="hljs-keyword">repeat</span></span>=<span class="hljs-string"><span class="hljs-string">"comments"</span></span>&gt; &lt;span class=<span class="hljs-string"><span class="hljs-string">"name"</span></span>&gt;{{author}}&lt;/span&gt;: {{message}} &lt;/div&gt; &lt;/div&gt;</code> <br> <br>   :       template-<span class="hljs-keyword"><span class="hljs-keyword">repeat</span></span>,  ,     ,   ,   ,   .   ( values  instantiateTemplate)          ,   {{author}}     comment,    . <br> <br>  instantiateTemplate ,    ,    ,     ,          drawTalk. <br> <br>       ,      ,     <span class="hljs-literal"><span class="hljs-literal">true</span></span>  <span class="hljs-literal"><span class="hljs-literal">false</span></span>? <br> <br>    ? <br>  -       JavaScript,     .   - . <br> <br>   -     JavaScript.       ,      .         . <br> <br>   ,   -          JavaScript.     ,       .       ,     . <br> <br>     .    .          ,  ,    ?</code></code> </pre> <code><code class="html">  ID ‚Äútalks‚Äù    .   ,      . <br> <br>       . <br> <br> &lt;form id="newtalk"&gt; &lt;h3&gt;Submit a talk&lt;/h3&gt; : &lt;input type="text" style="width: 40em" name="title"&gt; &lt;br&gt; Summary: &lt;input type="text" style="width: 40em" name="summary"&gt; &lt;button type="submit"&gt; &lt;/button&gt; &lt;/form&gt;</code> <br> <br>     ‚Äúsubmit‚Äù  ,      HTTP-,    . <br> <br>    ,    display   none,       . ,   ? <br> <br> <code class="html">&lt;div id="template" style="display: none"&gt; &lt;div class="talk"&gt; &lt;h2&gt;{{title}}&lt;/h2&gt; &lt;div&gt;by &lt;span class="name"&gt;{{presenter}}&lt;/span&gt;&lt;/div&gt; &lt;p&gt;{{summary}}&lt;/p&gt; &lt;div class="comments"&gt;&lt;/div&gt; &lt;form&gt; &lt;input type="text" name="comment"&gt; &lt;button type="submit"&gt; &lt;/button&gt; &lt;button type="button" class="del"&gt; &lt;/button&gt; &lt;/form&gt; &lt;/div&gt; &lt;div class="comment"&gt; &lt;span class="name"&gt;{{author}}&lt;/span&gt;: {{message}} &lt;/div&gt; &lt;/div&gt;</code> <br> <br>    DOM  JavaScript    .          elt   13,       ,  HTML,   -      DOM-. <br> <br>   DOM-   ,      ,    ,   ,     ‚Äì             . <br> <br>  , HTML   ,   . <br> <br> <code class="html">&lt;script src="skillsharing_client.js"&gt;&lt;/script&gt;</code> <br> <br>  <br> ,       ,       .       HTTP-,      XMLHttpRequest,            . <br> <br> <code class="javascript">function request(options, callback) { var req = new XMLHttpRequest(); req.open(options.method || "GET", options.pathname, true); req.addEventListener("load", function() { if (req.status &lt; 400) callback(null, req.responseText); else callback(new Error("Request failed: " + req.statusText)); }); req.addEventListener("error", function() { callback(new Error("Network error")); }); req.send(options.body || null); }</code> <br> <br>            ,  waitForChanges. <br> <br> <code class="javascript">var lastServerTime = 0; request({pathname: "talks"}, function(error, response) { if (error) { reportError(error); } else { response = JSON.parse(response); displayTalks(response.talks); lastServerTime = response.serverTime; waitForChanges(); } });</code> <br> <br>  lastServerTime      ,   .   ,        ,       .  ,  serverTime,   ,     lastServerTime. <br> <br>    ,   ,        .       reportError,      ,   . <br> <br> <code class="javascript">function reportError(error) { if (error) alert(error.toString()); }</code> <br> <br>  ,   ,       .  ,           ,     .      ,      . <br> <br>   <br>         ,    ,    . ,     ,     ,        .  ,      ,   DOM    . <br> <br>  displayTalks      ,       .     shownTalks,      DOM,   ,     . <br> <br> <code class="javascript">var talkDiv = document.querySelector("#talks"); var shownTalks = Object.create(null); function displayTalks(talks) { talks.forEach(function(talk) { var shown = shownTalks[talk.title]; if (talk.deleted) { if (shown) { talkDiv.removeChild(shown); delete shownTalks[talk.title]; } } else { var node = drawTalk(talk); if (shown) talkDiv.replaceChild(node, shown); else talkDiv.appendChild(node); shownTalks[talk.title] = node; } }); }</code> <br> <br>  DOM     ,   HTML .    instantiateTemplate,     . <br> <br>  name ‚Äì  .    ,   ,        ,       ID ‚Äútemplate‚Äù.  querySelector   .     ‚Äútalk‚Äù  ‚Äúcomment‚Äù. <br> <br> <code class="javascript">function instantiateTemplate(name, values) { function instantiateText(text) { return text.replace(/\{\{(\w+)\}\}/g, function(_, name) { return values[name]; }); } function instantiate(node) { if (node.nodeType == document.ELEMENT_NODE) { var copy = node.cloneNode(); for (var i = 0; i &lt; node.childNodes.length; i++) copy.appendChild(instantiate(node.childNodes[i])); return copy; } else if (node.nodeType == document.TEXT_NODE) { return document.createTextNode( instantiateText(node.nodeValue)); } } var template = document.querySelector("#template ." + name); return instantiate(template); }</code> <br> <br>  cloneNode,      DOM,   .     ,       true.  instantiate    ,     . <br> <br>   instantiateTemplate   ,    ,     .   {{title}}     ‚Äútitle‚Äù. <br> <br>      ,    drawTalk   . <br> <br> <code class="javascript">function drawTalk(talk) { var node = instantiateTemplate("talk", talk); var comments = node.querySelector(".comments"); talk.comments.forEach(function(comment) { comments.appendChild( instantiateTemplate("comment", comment)); }); node.querySelector("button.del").addEventListener( "click", deleteTalk.bind(null, talk.title)); var form = node.querySelector("form"); form.addEventListener("submit", function(event) { event.preventDefault(); addComment(talk.title, form.elements.comment.value); form.reset(); }); return node; }</code> <br> <br>     ‚Äútalk‚Äù    . -,   ,     ‚Äúcomment‚Äù       "comments". ,      ,      ,  . <br> <br>   <br>  ,   drawTalk,   deleteTalk  addComment   ,       .      URL,       ,       talkURL. <br> <br> <code class="javascript">function talkURL(title) { return "talks/" + encodeURIComponent(title); }</code> <br> <br>  deleteTalk   DELETE       . <br> <br> <code class="javascript">function deleteTalk(title) { request({pathname: talkURL(title), method: "DELETE"}, reportError); }</code> <br> <br>          JSON      POST-. <br> <br> <code class="javascript">function addComment(title, comment) { var comment = {author: nameField.value, message: comment}; request({pathname: talkURL(title) + "/comments", body: JSON.stringify(comment), method: "POST"}, reportError); }</code> <br> <br>  nameField,      author,    <code><code class="javascript">  ,      .       localStorage,          . <br> <br> var nameField = document.querySelector("#name"); nameField.value = localStorage.getItem("name") || ""; nameField.addEventListener("change", function() { localStorage.setItem("name", nameField.value); });           ‚Äúsubmit‚Äù.       (     ),     PUT-   . var talkForm = document.querySelector("#newtalk"); talkForm.addEventListener("submit", function(event) { event.preventDefault(); request({pathname: talkURL(talkForm.elements.title.value), method: "PUT", body: JSON.stringify({ presenter: nameField.value, summary: talkForm.elements.summary.value })}, reportError); talkForm.reset(); });</code> <br> <br>   <br>  ,   ,   ,    ,     ,     ,       .    -       ,     . <br> <br>       ,    displayTalks    ,     ,       . <br> <br> <code class="javascript">function waitForChanges() { request({pathname: "talks?changesSince=" + lastServerTime}, function(error, response) { if (error) { setTimeout(waitForChanges, 2500); console.error(error.stack); } else { response = JSON.parse(response); displayTalks(response.talks); lastServerTime = response.serverTime; waitForChanges(); } }); }</code> <br> <br>    ,   ,     ,  ,    .    ,    reportError,             .       (  ),      2.5 . <br> <br>   ,     ,  lastServerTime ,    ,           .    ,    . <br> <br>    ,        localhost:8000,  ,  ,     ,    . <br> <br>  <br>      ,    .    , ,   <a href=""> </a>   <a href="http://nodejs.org/">Node.js</a> . <br> <br>     <br>      .     ,      . <br> <br>     ,            .    ,    . <br> <br>    <br>      ,       DOM   ,   .   .     -         ,          ,      ,      ,  . <br> <br>   ,        ,    .    ,   ? <br> <br>   <br>    ,     .         ,   if,    ,  . <br> <br>           ,   ("comment")     .      ‚Äútalk‚Äù,     ,    comments,    ,   ,    . <br> <br>     : <br> <br> <code class="html">&lt;div class="comments"&gt; &lt;div class="comment" template-repeat="comments"&gt; &lt;span class="name"&gt;{{author}}&lt;/span&gt;: {{message}} &lt;/div&gt; &lt;/div&gt;</code> <br> <br>   :       template-repeat,  ,     ,   ,   ,   .   ( values  instantiateTemplate)          ,   {{author}}     comment,    . <br> <br>  instantiateTemplate ,    ,    ,     ,          drawTalk. <br> <br>       ,      ,     true  false? <br> <br>    ? <br>  -       JavaScript,     .   - . <br> <br>   -     JavaScript.       ,      .         . <br> <br>   ,   -          JavaScript.     ,       .       ,     . <br> <br>     .    .          ,  ,    ?</code></code> <h4> <code><code class="html">  ID ‚Äútalks‚Äù    .   ,      . <br> <br>       . <br> <br> &lt;form id="newtalk"&gt; &lt;h3&gt;Submit a talk&lt;/h3&gt; : &lt;input type="text" style="width: 40em" name="title"&gt; &lt;br&gt; Summary: &lt;input type="text" style="width: 40em" name="summary"&gt; &lt;button type="submit"&gt; &lt;/button&gt; &lt;/form&gt;</code> <br> <br>     ‚Äúsubmit‚Äù  ,      HTTP-,    . <br> <br>    ,    display   none,       . ,   ? <br> <br> <code class="html">&lt;div id="template" style="display: none"&gt; &lt;div class="talk"&gt; &lt;h2&gt;{{title}}&lt;/h2&gt; &lt;div&gt;by &lt;span class="name"&gt;{{presenter}}&lt;/span&gt;&lt;/div&gt; &lt;p&gt;{{summary}}&lt;/p&gt; &lt;div class="comments"&gt;&lt;/div&gt; &lt;form&gt; &lt;input type="text" name="comment"&gt; &lt;button type="submit"&gt; &lt;/button&gt; &lt;button type="button" class="del"&gt; &lt;/button&gt; &lt;/form&gt; &lt;/div&gt; &lt;div class="comment"&gt; &lt;span class="name"&gt;{{author}}&lt;/span&gt;: {{message}} &lt;/div&gt; &lt;/div&gt;</code> <br> <br>    DOM  JavaScript    .          elt   13,       ,  HTML,   -      DOM-. <br> <br>   DOM-   ,      ,    ,   ,     ‚Äì             . <br> <br>  , HTML   ,   . <br> <br> <code class="html">&lt;script src="skillsharing_client.js"&gt;&lt;/script&gt;</code> <br> <br>  <br> ,       ,       .       HTTP-,      XMLHttpRequest,            . <br> <br> <code class="javascript">function request(options, callback) { var req = new XMLHttpRequest(); req.open(options.method || "GET", options.pathname, true); req.addEventListener("load", function() { if (req.status &lt; 400) callback(null, req.responseText); else callback(new Error("Request failed: " + req.statusText)); }); req.addEventListener("error", function() { callback(new Error("Network error")); }); req.send(options.body || null); }</code> <br> <br>            ,  waitForChanges. <br> <br> <code class="javascript">var lastServerTime = 0; request({pathname: "talks"}, function(error, response) { if (error) { reportError(error); } else { response = JSON.parse(response); displayTalks(response.talks); lastServerTime = response.serverTime; waitForChanges(); } });</code> <br> <br>  lastServerTime      ,   .   ,        ,       .  ,  serverTime,   ,     lastServerTime. <br> <br>    ,   ,        .       reportError,      ,   . <br> <br> <code class="javascript">function reportError(error) { if (error) alert(error.toString()); }</code> <br> <br>  ,   ,       .  ,           ,     .      ,      . <br> <br>   <br>         ,    ,    . ,     ,     ,        .  ,      ,   DOM    . <br> <br>  displayTalks      ,       .     shownTalks,      DOM,   ,     . <br> <br> <code class="javascript">var talkDiv = document.querySelector("#talks"); var shownTalks = Object.create(null); function displayTalks(talks) { talks.forEach(function(talk) { var shown = shownTalks[talk.title]; if (talk.deleted) { if (shown) { talkDiv.removeChild(shown); delete shownTalks[talk.title]; } } else { var node = drawTalk(talk); if (shown) talkDiv.replaceChild(node, shown); else talkDiv.appendChild(node); shownTalks[talk.title] = node; } }); }</code> <br> <br>  DOM     ,   HTML .    instantiateTemplate,     . <br> <br>  name ‚Äì  .    ,   ,        ,       ID ‚Äútemplate‚Äù.  querySelector   .     ‚Äútalk‚Äù  ‚Äúcomment‚Äù. <br> <br> <code class="javascript">function instantiateTemplate(name, values) { function instantiateText(text) { return text.replace(/\{\{(\w+)\}\}/g, function(_, name) { return values[name]; }); } function instantiate(node) { if (node.nodeType == document.ELEMENT_NODE) { var copy = node.cloneNode(); for (var i = 0; i &lt; node.childNodes.length; i++) copy.appendChild(instantiate(node.childNodes[i])); return copy; } else if (node.nodeType == document.TEXT_NODE) { return document.createTextNode( instantiateText(node.nodeValue)); } } var template = document.querySelector("#template ." + name); return instantiate(template); }</code> <br> <br>  cloneNode,      DOM,   .     ,       true.  instantiate    ,     . <br> <br>   instantiateTemplate   ,    ,     .   {{title}}     ‚Äútitle‚Äù. <br> <br>      ,    drawTalk   . <br> <br> <code class="javascript">function drawTalk(talk) { var node = instantiateTemplate("talk", talk); var comments = node.querySelector(".comments"); talk.comments.forEach(function(comment) { comments.appendChild( instantiateTemplate("comment", comment)); }); node.querySelector("button.del").addEventListener( "click", deleteTalk.bind(null, talk.title)); var form = node.querySelector("form"); form.addEventListener("submit", function(event) { event.preventDefault(); addComment(talk.title, form.elements.comment.value); form.reset(); }); return node; }</code> <br> <br>     ‚Äútalk‚Äù    . -,   ,     ‚Äúcomment‚Äù       "comments". ,      ,      ,  . <br> <br>   <br>  ,   drawTalk,   deleteTalk  addComment   ,       .      URL,       ,       talkURL. <br> <br> <code class="javascript">function talkURL(title) { return "talks/" + encodeURIComponent(title); }</code> <br> <br>  deleteTalk   DELETE       . <br> <br> <code class="javascript">function deleteTalk(title) { request({pathname: talkURL(title), method: "DELETE"}, reportError); }</code> <br> <br>          JSON      POST-. <br> <br> <code class="javascript">function addComment(title, comment) { var comment = {author: nameField.value, message: comment}; request({pathname: talkURL(title) + "/comments", body: JSON.stringify(comment), method: "POST"}, reportError); }</code> <br> <br>  nameField,      author,    <code><code class="javascript">  ,      .       localStorage,          . <br> <br> var nameField = document.querySelector("#name"); nameField.value = localStorage.getItem("name") || ""; nameField.addEventListener("change", function() { localStorage.setItem("name", nameField.value); });           ‚Äúsubmit‚Äù.       (     ),     PUT-   . var talkForm = document.querySelector("#newtalk"); talkForm.addEventListener("submit", function(event) { event.preventDefault(); request({pathname: talkURL(talkForm.elements.title.value), method: "PUT", body: JSON.stringify({ presenter: nameField.value, summary: talkForm.elements.summary.value })}, reportError); talkForm.reset(); });</code> <br> <br>   <br>  ,   ,   ,    ,     ,     ,       .    -       ,     . <br> <br>       ,    displayTalks    ,     ,       . <br> <br> <code class="javascript">function waitForChanges() { request({pathname: "talks?changesSince=" + lastServerTime}, function(error, response) { if (error) { setTimeout(waitForChanges, 2500); console.error(error.stack); } else { response = JSON.parse(response); displayTalks(response.talks); lastServerTime = response.serverTime; waitForChanges(); } }); }</code> <br> <br>    ,   ,     ,  ,    .    ,    reportError,             .       (  ),      2.5 . <br> <br>   ,     ,  lastServerTime ,    ,           .    ,    . <br> <br>    ,        localhost:8000,  ,  ,     ,    . <br> <br>  <br>      ,    .    , ,   <a href=""> </a>   <a href="http://nodejs.org/">Node.js</a> . <br> <br>     <br>      .     ,      . <br> <br>     ,            .    ,    . <br> <br>    <br>      ,       DOM   ,   .   .     -         ,          ,      ,      ,  . <br> <br>   ,        ,    .    ,   ? <br> <br>   <br>    ,     .         ,   if,    ,  . <br> <br>           ,   ("comment")     .      ‚Äútalk‚Äù,     ,    comments,    ,   ,    . <br> <br>     : <br> <br> <code class="html">&lt;div class="comments"&gt; &lt;div class="comment" template-repeat="comments"&gt; &lt;span class="name"&gt;{{author}}&lt;/span&gt;: {{message}} &lt;/div&gt; &lt;/div&gt;</code> <br> <br>   :       template-repeat,  ,     ,   ,   ,   .   ( values  instantiateTemplate)          ,   {{author}}     comment,    . <br> <br>  instantiateTemplate ,    ,    ,     ,          drawTalk. <br> <br>       ,      ,     true  false? <br> <br>    ? <br>  -       JavaScript,     .   - . <br> <br>   -     JavaScript.       ,      .         . <br> <br>   ,   -          JavaScript.     ,       .       ,     . <br> <br>     .    .          ,  ,    ?</code></code> </h4> <code><code class="html">  ID ‚Äútalks‚Äù    .   ,      . <br> <br>       . <br> <br> &lt;form id="newtalk"&gt; &lt;h3&gt;Submit a talk&lt;/h3&gt; : &lt;input type="text" style="width: 40em" name="title"&gt; &lt;br&gt; Summary: &lt;input type="text" style="width: 40em" name="summary"&gt; &lt;button type="submit"&gt; &lt;/button&gt; &lt;/form&gt;</code> <br> <br>     ‚Äúsubmit‚Äù  ,      HTTP-,    . <br> <br>    ,    display   none,       . ,   ? <br> <br> <code class="html">&lt;div id="template" style="display: none"&gt; &lt;div class="talk"&gt; &lt;h2&gt;{{title}}&lt;/h2&gt; &lt;div&gt;by &lt;span class="name"&gt;{{presenter}}&lt;/span&gt;&lt;/div&gt; &lt;p&gt;{{summary}}&lt;/p&gt; &lt;div class="comments"&gt;&lt;/div&gt; &lt;form&gt; &lt;input type="text" name="comment"&gt; &lt;button type="submit"&gt; &lt;/button&gt; &lt;button type="button" class="del"&gt; &lt;/button&gt; &lt;/form&gt; &lt;/div&gt; &lt;div class="comment"&gt; &lt;span class="name"&gt;{{author}}&lt;/span&gt;: {{message}} &lt;/div&gt; &lt;/div&gt;</code> <br> <br>    DOM  JavaScript    .          elt   13,       ,  HTML,   -      DOM-. <br> <br>   DOM-   ,      ,    ,   ,     ‚Äì             . <br> <br>  , HTML   ,   . <br> <br> <code class="html">&lt;script src="skillsharing_client.js"&gt;&lt;/script&gt;</code> <br> <br>  <br> ,       ,       .       HTTP-,      XMLHttpRequest,            . <br> <br> <code class="javascript">function request(options, callback) { var req = new XMLHttpRequest(); req.open(options.method || "GET", options.pathname, true); req.addEventListener("load", function() { if (req.status &lt; 400) callback(null, req.responseText); else callback(new Error("Request failed: " + req.statusText)); }); req.addEventListener("error", function() { callback(new Error("Network error")); }); req.send(options.body || null); }</code> <br> <br>            ,  waitForChanges. <br> <br> <code class="javascript">var lastServerTime = 0; request({pathname: "talks"}, function(error, response) { if (error) { reportError(error); } else { response = JSON.parse(response); displayTalks(response.talks); lastServerTime = response.serverTime; waitForChanges(); } });</code> <br> <br>  lastServerTime      ,   .   ,        ,       .  ,  serverTime,   ,     lastServerTime. <br> <br>    ,   ,        .       reportError,      ,   . <br> <br> <code class="javascript">function reportError(error) { if (error) alert(error.toString()); }</code> <br> <br>  ,   ,       .  ,           ,     .      ,      . <br> <br>   <br>         ,    ,    . ,     ,     ,        .  ,      ,   DOM    . <br> <br>  displayTalks      ,       .     shownTalks,      DOM,   ,     . <br> <br> <code class="javascript">var talkDiv = document.querySelector("#talks"); var shownTalks = Object.create(null); function displayTalks(talks) { talks.forEach(function(talk) { var shown = shownTalks[talk.title]; if (talk.deleted) { if (shown) { talkDiv.removeChild(shown); delete shownTalks[talk.title]; } } else { var node = drawTalk(talk); if (shown) talkDiv.replaceChild(node, shown); else talkDiv.appendChild(node); shownTalks[talk.title] = node; } }); }</code> <br> <br>  DOM     ,   HTML .    instantiateTemplate,     . <br> <br>  name ‚Äì  .    ,   ,        ,       ID ‚Äútemplate‚Äù.  querySelector   .     ‚Äútalk‚Äù  ‚Äúcomment‚Äù. <br> <br> <code class="javascript">function instantiateTemplate(name, values) { function instantiateText(text) { return text.replace(/\{\{(\w+)\}\}/g, function(_, name) { return values[name]; }); } function instantiate(node) { if (node.nodeType == document.ELEMENT_NODE) { var copy = node.cloneNode(); for (var i = 0; i &lt; node.childNodes.length; i++) copy.appendChild(instantiate(node.childNodes[i])); return copy; } else if (node.nodeType == document.TEXT_NODE) { return document.createTextNode( instantiateText(node.nodeValue)); } } var template = document.querySelector("#template ." + name); return instantiate(template); }</code> <br> <br>  cloneNode,      DOM,   .     ,       true.  instantiate    ,     . <br> <br>   instantiateTemplate   ,    ,     .   {{title}}     ‚Äútitle‚Äù. <br> <br>      ,    drawTalk   . <br> <br> <code class="javascript">function drawTalk(talk) { var node = instantiateTemplate("talk", talk); var comments = node.querySelector(".comments"); talk.comments.forEach(function(comment) { comments.appendChild( instantiateTemplate("comment", comment)); }); node.querySelector("button.del").addEventListener( "click", deleteTalk.bind(null, talk.title)); var form = node.querySelector("form"); form.addEventListener("submit", function(event) { event.preventDefault(); addComment(talk.title, form.elements.comment.value); form.reset(); }); return node; }</code> <br> <br>     ‚Äútalk‚Äù    . -,   ,     ‚Äúcomment‚Äù       "comments". ,      ,      ,  . <br> <br>   <br>  ,   drawTalk,   deleteTalk  addComment   ,       .      URL,       ,       talkURL. <br> <br> <code class="javascript">function talkURL(title) { return "talks/" + encodeURIComponent(title); }</code> <br> <br>  deleteTalk   DELETE       . <br> <br> <code class="javascript">function deleteTalk(title) { request({pathname: talkURL(title), method: "DELETE"}, reportError); }</code> <br> <br>          JSON      POST-. <br> <br> <code class="javascript">function addComment(title, comment) { var comment = {author: nameField.value, message: comment}; request({pathname: talkURL(title) + "/comments", body: JSON.stringify(comment), method: "POST"}, reportError); }</code> <br> <br>  nameField,      author,    <code><code class="javascript">  ,      .       localStorage,          . <br> <br> var nameField = document.querySelector("#name"); nameField.value = localStorage.getItem("name") || ""; nameField.addEventListener("change", function() { localStorage.setItem("name", nameField.value); });           ‚Äúsubmit‚Äù.       (     ),     PUT-   . var talkForm = document.querySelector("#newtalk"); talkForm.addEventListener("submit", function(event) { event.preventDefault(); request({pathname: talkURL(talkForm.elements.title.value), method: "PUT", body: JSON.stringify({ presenter: nameField.value, summary: talkForm.elements.summary.value })}, reportError); talkForm.reset(); });</code> <br> <br>   <br>  ,   ,   ,    ,     ,     ,       .    -       ,     . <br> <br>       ,    displayTalks    ,     ,       . <br> <br> <code class="javascript">function waitForChanges() { request({pathname: "talks?changesSince=" + lastServerTime}, function(error, response) { if (error) { setTimeout(waitForChanges, 2500); console.error(error.stack); } else { response = JSON.parse(response); displayTalks(response.talks); lastServerTime = response.serverTime; waitForChanges(); } }); }</code> <br> <br>    ,   ,     ,  ,    .    ,    reportError,             .       (  ),      2.5 . <br> <br>   ,     ,  lastServerTime ,    ,           .    ,    . <br> <br>    ,        localhost:8000,  ,  ,     ,    . <br> <br>  <br>      ,    .    , ,   <a href=""> </a>   <a href="http://nodejs.org/">Node.js</a> . <br> <br>     <br>      .     ,      . <br> <br>     ,            .    ,    . <br> <br>    <br>      ,       DOM   ,   .   .     -         ,          ,      ,      ,  . <br> <br>   ,        ,    .    ,   ? <br> <br>   <br>    ,     .         ,   if,    ,  . <br> <br>           ,   ("comment")     .      ‚Äútalk‚Äù,     ,    comments,    ,   ,    . <br> <br>     : <br> <br> <code class="html">&lt;div class="comments"&gt; &lt;div class="comment" template-repeat="comments"&gt; &lt;span class="name"&gt;{{author}}&lt;/span&gt;: {{message}} &lt;/div&gt; &lt;/div&gt;</code> <br> <br>   :       template-repeat,  ,     ,   ,   ,   .   ( values  instantiateTemplate)          ,   {{author}}     comment,    . <br> <br>  instantiateTemplate ,    ,    ,     ,          drawTalk. <br> <br>       ,      ,     true  false? <br> <br>    ? <br>  -       JavaScript,     .   - . <br> <br>   -     JavaScript.       ,      .         . <br> <br>   ,   -          JavaScript.     ,       .       ,     . <br> <br>     .    .          ,  ,    ?</code></code> <pre> <code class="hljs lua"><code class="html">  ID ‚Äútalks‚Äù    .   ,      . <br> <br>       . <br> <br> &lt;form id=<span class="hljs-string"><span class="hljs-string">"newtalk"</span></span>&gt; &lt;h3&gt;Submit a talk&lt;/h3&gt; : &lt;<span class="hljs-built_in"><span class="hljs-built_in">input</span></span> <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=<span class="hljs-string"><span class="hljs-string">"text"</span></span> style=<span class="hljs-string"><span class="hljs-string">"width: 40em"</span></span> name=<span class="hljs-string"><span class="hljs-string">"title"</span></span>&gt; &lt;br&gt; Summary: &lt;<span class="hljs-built_in"><span class="hljs-built_in">input</span></span> <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=<span class="hljs-string"><span class="hljs-string">"text"</span></span> style=<span class="hljs-string"><span class="hljs-string">"width: 40em"</span></span> name=<span class="hljs-string"><span class="hljs-string">"summary"</span></span>&gt; &lt;button <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=<span class="hljs-string"><span class="hljs-string">"submit"</span></span>&gt; &lt;/button&gt; &lt;/form&gt;</code> <br> <br>     ‚Äúsubmit‚Äù  ,      HTTP-,    . <br> <br>    ,    display   none,       . ,   ? <br> <br> <code class="html">&lt;div id=<span class="hljs-string"><span class="hljs-string">"template"</span></span> style=<span class="hljs-string"><span class="hljs-string">"display: none"</span></span>&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"talk"</span></span>&gt; &lt;h2&gt;{{title}}&lt;/h2&gt; &lt;div&gt;by &lt;span class=<span class="hljs-string"><span class="hljs-string">"name"</span></span>&gt;{{presenter}}&lt;/span&gt;&lt;/div&gt; &lt;p&gt;{{summary}}&lt;/p&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"comments"</span></span>&gt;&lt;/div&gt; &lt;form&gt; &lt;<span class="hljs-built_in"><span class="hljs-built_in">input</span></span> <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=<span class="hljs-string"><span class="hljs-string">"text"</span></span> name=<span class="hljs-string"><span class="hljs-string">"comment"</span></span>&gt; &lt;button <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=<span class="hljs-string"><span class="hljs-string">"submit"</span></span>&gt; &lt;/button&gt; &lt;button <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=<span class="hljs-string"><span class="hljs-string">"button"</span></span> class=<span class="hljs-string"><span class="hljs-string">"del"</span></span>&gt; &lt;/button&gt; &lt;/form&gt; &lt;/div&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"comment"</span></span>&gt; &lt;span class=<span class="hljs-string"><span class="hljs-string">"name"</span></span>&gt;{{author}}&lt;/span&gt;: {{message}} &lt;/div&gt; &lt;/div&gt;</code> <br> <br>    DOM  JavaScript    .          elt   <span class="hljs-number"><span class="hljs-number">13</span></span>,       ,  HTML,   -      DOM-. <br> <br>   DOM-   ,      ,    ,   ,     ‚Äì             . <br> <br>  , HTML   ,   . <br> <br> <code class="html">&lt;script src=<span class="hljs-string"><span class="hljs-string">"skillsharing_client.js"</span></span>&gt;&lt;/script&gt;</code> <br> <br>  <br> ,       ,       .       HTTP-,      XMLHttpRequest,            . <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">request</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(options, callback)</span></span></span></span> { var req = new XMLHttpRequest(); req.<span class="hljs-built_in"><span class="hljs-built_in">open</span></span>(options.method || <span class="hljs-string"><span class="hljs-string">"GET"</span></span>, options.pathname, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); req.addEventListener(<span class="hljs-string"><span class="hljs-string">"load"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (req.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> &lt; <span class="hljs-number"><span class="hljs-number">400</span></span>) callback(null, req.responseText); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> callback(new Error(<span class="hljs-string"><span class="hljs-string">"Request failed: "</span></span> + req.statusText)); }); req.addEventListener(<span class="hljs-string"><span class="hljs-string">"error"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { callback(new Error(<span class="hljs-string"><span class="hljs-string">"Network error"</span></span>)); }); req.send(options.body || null); }</code> <br> <br>            ,  waitForChanges. <br> <br> <code class="javascript">var lastServerTime = <span class="hljs-number"><span class="hljs-number">0</span></span>; request({pathname: <span class="hljs-string"><span class="hljs-string">"talks"</span></span>}, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(error, response)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>) { reportError(<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { response = JSON.parse(response); displayTalks(response.talks); lastServerTime = response.serverTime; waitForChanges(); } });</code> <br> <br>  lastServerTime      ,   .   ,        ,       .  ,  serverTime,   ,     lastServerTime. <br> <br>    ,   ,        .       reportError,      ,   . <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">reportError</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(error)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>) alert(<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>.toString()); }</code> <br> <br>  ,   ,       .  ,           ,     .      ,      . <br> <br>   <br>         ,    ,    . ,     ,     ,        .  ,      ,   DOM    . <br> <br>  displayTalks      ,       .     shownTalks,      DOM,   ,     . <br> <br> <code class="javascript">var talkDiv = document.querySelector(<span class="hljs-string"><span class="hljs-string">"#talks"</span></span>); var shownTalks = Object.<span class="hljs-built_in"><span class="hljs-built_in">create</span></span>(null); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">displayTalks</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(talks)</span></span></span></span> { talks.forEach(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(talk)</span></span></span></span> { var shown = shownTalks[talk.title]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (talk.deleted) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (shown) { talkDiv.removeChild(shown); delete shownTalks[talk.title]; } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { var node = drawTalk(talk); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (shown) talkDiv.replaceChild(node, shown); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> talkDiv.appendChild(node); shownTalks[talk.title] = node; } }); }</code> <br> <br>  DOM     ,   HTML .    instantiateTemplate,     . <br> <br>  name ‚Äì  .    ,   ,        ,       ID ‚Äútemplate‚Äù.  querySelector   .     ‚Äútalk‚Äù  ‚Äúcomment‚Äù. <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">instantiateTemplate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(name, values)</span></span></span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">instantiateText</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(text)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> text.replace(/\{\{(\w+)\}\}/g, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(_, name)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> values[name]; }); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">instantiate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(node)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (node.nodeType == document.ELEMENT_NODE) { var copy = node.cloneNode(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (var i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; node.childNodes.length; i++) copy.appendChild(instantiate(node.childNodes[i])); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> copy; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (node.nodeType == document.TEXT_NODE) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> document.createTextNode( instantiateText(node.nodeValue)); } } var template = document.querySelector(<span class="hljs-string"><span class="hljs-string">"#template ."</span></span> + name); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> instantiate(template); }</code> <br> <br>  cloneNode,      DOM,   .     ,       <span class="hljs-literal"><span class="hljs-literal">true</span></span>.  instantiate    ,     . <br> <br>   instantiateTemplate   ,    ,     .   {{title}}     ‚Äútitle‚Äù. <br> <br>      ,    drawTalk   . <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">drawTalk</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(talk)</span></span></span></span> { var node = instantiateTemplate(<span class="hljs-string"><span class="hljs-string">"talk"</span></span>, talk); var comments = node.querySelector(<span class="hljs-string"><span class="hljs-string">".comments"</span></span>); talk.comments.forEach(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(comment)</span></span></span></span> { comments.appendChild( instantiateTemplate(<span class="hljs-string"><span class="hljs-string">"comment"</span></span>, comment)); }); node.querySelector(<span class="hljs-string"><span class="hljs-string">"button.del"</span></span>).addEventListener( <span class="hljs-string"><span class="hljs-string">"click"</span></span>, deleteTalk.bind(null, talk.title)); var form = node.querySelector(<span class="hljs-string"><span class="hljs-string">"form"</span></span>); form.addEventListener(<span class="hljs-string"><span class="hljs-string">"submit"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(event)</span></span></span></span> { event.preventDefault(); addComment(talk.title, form.elements.comment.value); form.reset(); }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> node; }</code> <br> <br>     ‚Äútalk‚Äù    . -,   ,     ‚Äúcomment‚Äù       <span class="hljs-string"><span class="hljs-string">"comments"</span></span>. ,      ,      ,  . <br> <br>   <br>  ,   drawTalk,   deleteTalk  addComment   ,       .      URL,       ,       talkURL. <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">talkURL</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(title)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"talks/"</span></span> + encodeURIComponent(title); }</code> <br> <br>  deleteTalk   DELETE       . <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">deleteTalk</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(title)</span></span></span></span> { request({pathname: talkURL(title), method: <span class="hljs-string"><span class="hljs-string">"DELETE"</span></span>}, reportError); }</code> <br> <br>          JSON      POST-. <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">addComment</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(title, comment)</span></span></span></span> { var comment = {author: nameField.value, message: comment}; request({pathname: talkURL(title) + <span class="hljs-string"><span class="hljs-string">"/comments"</span></span>, body: JSON.stringify(comment), method: <span class="hljs-string"><span class="hljs-string">"POST"</span></span>}, reportError); }</code> <br> <br>  nameField,      author,    <code><code class="javascript">  ,      .       localStorage,          . <br> <br> var nameField = document.querySelector(<span class="hljs-string"><span class="hljs-string">"#name"</span></span>); nameField.value = localStorage.getItem(<span class="hljs-string"><span class="hljs-string">"name"</span></span>) || <span class="hljs-string"><span class="hljs-string">""</span></span>; nameField.addEventListener(<span class="hljs-string"><span class="hljs-string">"change"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { localStorage.setItem(<span class="hljs-string"><span class="hljs-string">"name"</span></span>, nameField.value); });           ‚Äúsubmit‚Äù.       (     ),     PUT-   . var talkForm = document.querySelector(<span class="hljs-string"><span class="hljs-string">"#newtalk"</span></span>); talkForm.addEventListener(<span class="hljs-string"><span class="hljs-string">"submit"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(event)</span></span></span></span> { event.preventDefault(); request({pathname: talkURL(talkForm.elements.title.value), method: <span class="hljs-string"><span class="hljs-string">"PUT"</span></span>, body: JSON.stringify({ presenter: nameField.value, summary: talkForm.elements.summary.value })}, reportError); talkForm.reset(); });</code> <br> <br>   <br>  ,   ,   ,    ,     ,     ,       .    -       ,     . <br> <br>       ,    displayTalks    ,     ,       . <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">waitForChanges</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { request({pathname: <span class="hljs-string"><span class="hljs-string">"talks?changesSince="</span></span> + lastServerTime}, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(error, response)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>) { setTimeout(waitForChanges, <span class="hljs-number"><span class="hljs-number">2500</span></span>); console.<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>.stack); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { response = JSON.parse(response); displayTalks(response.talks); lastServerTime = response.serverTime; waitForChanges(); } }); }</code> <br> <br>    ,   ,     ,  ,    .    ,    reportError,             .       (  ),      <span class="hljs-number"><span class="hljs-number">2.5</span></span> . <br> <br>   ,     ,  lastServerTime ,    ,           .    ,    . <br> <br>    ,        localhost:<span class="hljs-number"><span class="hljs-number">8000</span></span>,  ,  ,     ,    . <br> <br>  <br>      ,    .    , ,   <a href=""> </a>   <a href="http://nodejs.org/">Node.js</a> . <br> <br>     <br>      .     ,      . <br> <br>     ,            .    ,    . <br> <br>    <br>      ,       DOM   ,   .   .     -         ,          ,      ,      ,  . <br> <br>   ,        ,    .    ,   ? <br> <br>   <br>    ,     .         ,   <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>,    ,  . <br> <br>           ,   (<span class="hljs-string"><span class="hljs-string">"comment"</span></span>)     .      ‚Äútalk‚Äù,     ,    comments,    ,   ,    . <br> <br>     : <br> <br> <code class="html">&lt;div class=<span class="hljs-string"><span class="hljs-string">"comments"</span></span>&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"comment"</span></span> template-<span class="hljs-keyword"><span class="hljs-keyword">repeat</span></span>=<span class="hljs-string"><span class="hljs-string">"comments"</span></span>&gt; &lt;span class=<span class="hljs-string"><span class="hljs-string">"name"</span></span>&gt;{{author}}&lt;/span&gt;: {{message}} &lt;/div&gt; &lt;/div&gt;</code> <br> <br>   :       template-<span class="hljs-keyword"><span class="hljs-keyword">repeat</span></span>,  ,     ,   ,   ,   .   ( values  instantiateTemplate)          ,   {{author}}     comment,    . <br> <br>  instantiateTemplate ,    ,    ,     ,          drawTalk. <br> <br>       ,      ,     <span class="hljs-literal"><span class="hljs-literal">true</span></span>  <span class="hljs-literal"><span class="hljs-literal">false</span></span>? <br> <br>    ? <br>  -       JavaScript,     .   - . <br> <br>   -     JavaScript.       ,      .         . <br> <br>   ,   -          JavaScript.     ,       .       ,     . <br> <br>     .    .          ,  ,    ?</code></code> </pre> <code><code class="html">  ID ‚Äútalks‚Äù    .   ,      . <br> <br>       . <br> <br> &lt;form id="newtalk"&gt; &lt;h3&gt;Submit a talk&lt;/h3&gt; : &lt;input type="text" style="width: 40em" name="title"&gt; &lt;br&gt; Summary: &lt;input type="text" style="width: 40em" name="summary"&gt; &lt;button type="submit"&gt; &lt;/button&gt; &lt;/form&gt;</code> <br> <br>     ‚Äúsubmit‚Äù  ,      HTTP-,    . <br> <br>    ,    display   none,       . ,   ? <br> <br> <code class="html">&lt;div id="template" style="display: none"&gt; &lt;div class="talk"&gt; &lt;h2&gt;{{title}}&lt;/h2&gt; &lt;div&gt;by &lt;span class="name"&gt;{{presenter}}&lt;/span&gt;&lt;/div&gt; &lt;p&gt;{{summary}}&lt;/p&gt; &lt;div class="comments"&gt;&lt;/div&gt; &lt;form&gt; &lt;input type="text" name="comment"&gt; &lt;button type="submit"&gt; &lt;/button&gt; &lt;button type="button" class="del"&gt; &lt;/button&gt; &lt;/form&gt; &lt;/div&gt; &lt;div class="comment"&gt; &lt;span class="name"&gt;{{author}}&lt;/span&gt;: {{message}} &lt;/div&gt; &lt;/div&gt;</code> <br> <br>    DOM  JavaScript    .          elt   13,       ,  HTML,   -      DOM-. <br> <br>   DOM-   ,      ,    ,   ,     ‚Äì             . <br> <br>  , HTML   ,   . <br> <br> <code class="html">&lt;script src="skillsharing_client.js"&gt;&lt;/script&gt;</code> <br> <br>  <br> ,       ,       .       HTTP-,      XMLHttpRequest,            . <br> <br> <code class="javascript">function request(options, callback) { var req = new XMLHttpRequest(); req.open(options.method || "GET", options.pathname, true); req.addEventListener("load", function() { if (req.status &lt; 400) callback(null, req.responseText); else callback(new Error("Request failed: " + req.statusText)); }); req.addEventListener("error", function() { callback(new Error("Network error")); }); req.send(options.body || null); }</code> <br> <br>            ,  waitForChanges. <br> <br> <code class="javascript">var lastServerTime = 0; request({pathname: "talks"}, function(error, response) { if (error) { reportError(error); } else { response = JSON.parse(response); displayTalks(response.talks); lastServerTime = response.serverTime; waitForChanges(); } });</code> <br> <br>  lastServerTime      ,   .   ,        ,       .  ,  serverTime,   ,     lastServerTime. <br> <br>    ,   ,        .       reportError,      ,   . <br> <br> <code class="javascript">function reportError(error) { if (error) alert(error.toString()); }</code> <br> <br>  ,   ,       .  ,           ,     .      ,      . <br> <br>   <br>         ,    ,    . ,     ,     ,        .  ,      ,   DOM    . <br> <br>  displayTalks      ,       .     shownTalks,      DOM,   ,     . <br> <br> <code class="javascript">var talkDiv = document.querySelector("#talks"); var shownTalks = Object.create(null); function displayTalks(talks) { talks.forEach(function(talk) { var shown = shownTalks[talk.title]; if (talk.deleted) { if (shown) { talkDiv.removeChild(shown); delete shownTalks[talk.title]; } } else { var node = drawTalk(talk); if (shown) talkDiv.replaceChild(node, shown); else talkDiv.appendChild(node); shownTalks[talk.title] = node; } }); }</code> <br> <br>  DOM     ,   HTML .    instantiateTemplate,     . <br> <br>  name ‚Äì  .    ,   ,        ,       ID ‚Äútemplate‚Äù.  querySelector   .     ‚Äútalk‚Äù  ‚Äúcomment‚Äù. <br> <br> <code class="javascript">function instantiateTemplate(name, values) { function instantiateText(text) { return text.replace(/\{\{(\w+)\}\}/g, function(_, name) { return values[name]; }); } function instantiate(node) { if (node.nodeType == document.ELEMENT_NODE) { var copy = node.cloneNode(); for (var i = 0; i &lt; node.childNodes.length; i++) copy.appendChild(instantiate(node.childNodes[i])); return copy; } else if (node.nodeType == document.TEXT_NODE) { return document.createTextNode( instantiateText(node.nodeValue)); } } var template = document.querySelector("#template ." + name); return instantiate(template); }</code> <br> <br>  cloneNode,      DOM,   .     ,       true.  instantiate    ,     . <br> <br>   instantiateTemplate   ,    ,     .   {{title}}     ‚Äútitle‚Äù. <br> <br>      ,    drawTalk   . <br> <br> <code class="javascript">function drawTalk(talk) { var node = instantiateTemplate("talk", talk); var comments = node.querySelector(".comments"); talk.comments.forEach(function(comment) { comments.appendChild( instantiateTemplate("comment", comment)); }); node.querySelector("button.del").addEventListener( "click", deleteTalk.bind(null, talk.title)); var form = node.querySelector("form"); form.addEventListener("submit", function(event) { event.preventDefault(); addComment(talk.title, form.elements.comment.value); form.reset(); }); return node; }</code> <br> <br>     ‚Äútalk‚Äù    . -,   ,     ‚Äúcomment‚Äù       "comments". ,      ,      ,  . <br> <br>   <br>  ,   drawTalk,   deleteTalk  addComment   ,       .      URL,       ,       talkURL. <br> <br> <code class="javascript">function talkURL(title) { return "talks/" + encodeURIComponent(title); }</code> <br> <br>  deleteTalk   DELETE       . <br> <br> <code class="javascript">function deleteTalk(title) { request({pathname: talkURL(title), method: "DELETE"}, reportError); }</code> <br> <br>          JSON      POST-. <br> <br> <code class="javascript">function addComment(title, comment) { var comment = {author: nameField.value, message: comment}; request({pathname: talkURL(title) + "/comments", body: JSON.stringify(comment), method: "POST"}, reportError); }</code> <br> <br>  nameField,      author,    <code><code class="javascript">  ,      .       localStorage,          . <br> <br> var nameField = document.querySelector("#name"); nameField.value = localStorage.getItem("name") || ""; nameField.addEventListener("change", function() { localStorage.setItem("name", nameField.value); });           ‚Äúsubmit‚Äù.       (     ),     PUT-   . var talkForm = document.querySelector("#newtalk"); talkForm.addEventListener("submit", function(event) { event.preventDefault(); request({pathname: talkURL(talkForm.elements.title.value), method: "PUT", body: JSON.stringify({ presenter: nameField.value, summary: talkForm.elements.summary.value })}, reportError); talkForm.reset(); });</code> <br> <br>   <br>  ,   ,   ,    ,     ,     ,       .    -       ,     . <br> <br>       ,    displayTalks    ,     ,       . <br> <br> <code class="javascript">function waitForChanges() { request({pathname: "talks?changesSince=" + lastServerTime}, function(error, response) { if (error) { setTimeout(waitForChanges, 2500); console.error(error.stack); } else { response = JSON.parse(response); displayTalks(response.talks); lastServerTime = response.serverTime; waitForChanges(); } }); }</code> <br> <br>    ,   ,     ,  ,    .    ,    reportError,             .       (  ),      2.5 . <br> <br>   ,     ,  lastServerTime ,    ,           .    ,    . <br> <br>    ,        localhost:8000,  ,  ,     ,    . <br> <br>  <br>      ,    .    , ,   <a href=""> </a>   <a href="http://nodejs.org/">Node.js</a> . <br> <br>     <br>      .     ,      . <br> <br>     ,            .    ,    . <br> <br>    <br>      ,       DOM   ,   .   .     -         ,          ,      ,      ,  . <br> <br>   ,        ,    .    ,   ? <br> <br>   <br>    ,     .         ,   if,    ,  . <br> <br>           ,   ("comment")     .      ‚Äútalk‚Äù,     ,    comments,    ,   ,    . <br> <br>     : <br> <br> <code class="html">&lt;div class="comments"&gt; &lt;div class="comment" template-repeat="comments"&gt; &lt;span class="name"&gt;{{author}}&lt;/span&gt;: {{message}} &lt;/div&gt; &lt;/div&gt;</code> <br> <br>   :       template-repeat,  ,     ,   ,   ,   .   ( values  instantiateTemplate)          ,   {{author}}     comment,    . <br> <br>  instantiateTemplate ,    ,    ,     ,          drawTalk. <br> <br>       ,      ,     true  false? <br> <br>    ? <br>  -       JavaScript,     .   - . <br> <br>   -     JavaScript.       ,      .         . <br> <br>   ,   -          JavaScript.     ,       .       ,     . <br> <br>     .    .          ,  ,    ?</code></code> <pre> <code class="hljs lua"><code class="html">  ID ‚Äútalks‚Äù    .   ,      . <br> <br>       . <br> <br> &lt;form id=<span class="hljs-string"><span class="hljs-string">"newtalk"</span></span>&gt; &lt;h3&gt;Submit a talk&lt;/h3&gt; : &lt;<span class="hljs-built_in"><span class="hljs-built_in">input</span></span> <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=<span class="hljs-string"><span class="hljs-string">"text"</span></span> style=<span class="hljs-string"><span class="hljs-string">"width: 40em"</span></span> name=<span class="hljs-string"><span class="hljs-string">"title"</span></span>&gt; &lt;br&gt; Summary: &lt;<span class="hljs-built_in"><span class="hljs-built_in">input</span></span> <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=<span class="hljs-string"><span class="hljs-string">"text"</span></span> style=<span class="hljs-string"><span class="hljs-string">"width: 40em"</span></span> name=<span class="hljs-string"><span class="hljs-string">"summary"</span></span>&gt; &lt;button <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=<span class="hljs-string"><span class="hljs-string">"submit"</span></span>&gt; &lt;/button&gt; &lt;/form&gt;</code> <br> <br>     ‚Äúsubmit‚Äù  ,      HTTP-,    . <br> <br>    ,    display   none,       . ,   ? <br> <br> <code class="html">&lt;div id=<span class="hljs-string"><span class="hljs-string">"template"</span></span> style=<span class="hljs-string"><span class="hljs-string">"display: none"</span></span>&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"talk"</span></span>&gt; &lt;h2&gt;{{title}}&lt;/h2&gt; &lt;div&gt;by &lt;span class=<span class="hljs-string"><span class="hljs-string">"name"</span></span>&gt;{{presenter}}&lt;/span&gt;&lt;/div&gt; &lt;p&gt;{{summary}}&lt;/p&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"comments"</span></span>&gt;&lt;/div&gt; &lt;form&gt; &lt;<span class="hljs-built_in"><span class="hljs-built_in">input</span></span> <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=<span class="hljs-string"><span class="hljs-string">"text"</span></span> name=<span class="hljs-string"><span class="hljs-string">"comment"</span></span>&gt; &lt;button <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=<span class="hljs-string"><span class="hljs-string">"submit"</span></span>&gt; &lt;/button&gt; &lt;button <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=<span class="hljs-string"><span class="hljs-string">"button"</span></span> class=<span class="hljs-string"><span class="hljs-string">"del"</span></span>&gt; &lt;/button&gt; &lt;/form&gt; &lt;/div&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"comment"</span></span>&gt; &lt;span class=<span class="hljs-string"><span class="hljs-string">"name"</span></span>&gt;{{author}}&lt;/span&gt;: {{message}} &lt;/div&gt; &lt;/div&gt;</code> <br> <br>    DOM  JavaScript    .          elt   <span class="hljs-number"><span class="hljs-number">13</span></span>,       ,  HTML,   -      DOM-. <br> <br>   DOM-   ,      ,    ,   ,     ‚Äì             . <br> <br>  , HTML   ,   . <br> <br> <code class="html">&lt;script src=<span class="hljs-string"><span class="hljs-string">"skillsharing_client.js"</span></span>&gt;&lt;/script&gt;</code> <br> <br>  <br> ,       ,       .       HTTP-,      XMLHttpRequest,            . <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">request</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(options, callback)</span></span></span></span> { var req = new XMLHttpRequest(); req.<span class="hljs-built_in"><span class="hljs-built_in">open</span></span>(options.method || <span class="hljs-string"><span class="hljs-string">"GET"</span></span>, options.pathname, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); req.addEventListener(<span class="hljs-string"><span class="hljs-string">"load"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (req.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> &lt; <span class="hljs-number"><span class="hljs-number">400</span></span>) callback(null, req.responseText); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> callback(new Error(<span class="hljs-string"><span class="hljs-string">"Request failed: "</span></span> + req.statusText)); }); req.addEventListener(<span class="hljs-string"><span class="hljs-string">"error"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { callback(new Error(<span class="hljs-string"><span class="hljs-string">"Network error"</span></span>)); }); req.send(options.body || null); }</code> <br> <br>            ,  waitForChanges. <br> <br> <code class="javascript">var lastServerTime = <span class="hljs-number"><span class="hljs-number">0</span></span>; request({pathname: <span class="hljs-string"><span class="hljs-string">"talks"</span></span>}, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(error, response)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>) { reportError(<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { response = JSON.parse(response); displayTalks(response.talks); lastServerTime = response.serverTime; waitForChanges(); } });</code> <br> <br>  lastServerTime      ,   .   ,        ,       .  ,  serverTime,   ,     lastServerTime. <br> <br>    ,   ,        .       reportError,      ,   . <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">reportError</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(error)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>) alert(<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>.toString()); }</code> <br> <br>  ,   ,       .  ,           ,     .      ,      . <br> <br>   <br>         ,    ,    . ,     ,     ,        .  ,      ,   DOM    . <br> <br>  displayTalks      ,       .     shownTalks,      DOM,   ,     . <br> <br> <code class="javascript">var talkDiv = document.querySelector(<span class="hljs-string"><span class="hljs-string">"#talks"</span></span>); var shownTalks = Object.<span class="hljs-built_in"><span class="hljs-built_in">create</span></span>(null); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">displayTalks</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(talks)</span></span></span></span> { talks.forEach(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(talk)</span></span></span></span> { var shown = shownTalks[talk.title]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (talk.deleted) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (shown) { talkDiv.removeChild(shown); delete shownTalks[talk.title]; } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { var node = drawTalk(talk); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (shown) talkDiv.replaceChild(node, shown); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> talkDiv.appendChild(node); shownTalks[talk.title] = node; } }); }</code> <br> <br>  DOM     ,   HTML .    instantiateTemplate,     . <br> <br>  name ‚Äì  .    ,   ,        ,       ID ‚Äútemplate‚Äù.  querySelector   .     ‚Äútalk‚Äù  ‚Äúcomment‚Äù. <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">instantiateTemplate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(name, values)</span></span></span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">instantiateText</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(text)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> text.replace(/\{\{(\w+)\}\}/g, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(_, name)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> values[name]; }); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">instantiate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(node)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (node.nodeType == document.ELEMENT_NODE) { var copy = node.cloneNode(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (var i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; node.childNodes.length; i++) copy.appendChild(instantiate(node.childNodes[i])); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> copy; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (node.nodeType == document.TEXT_NODE) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> document.createTextNode( instantiateText(node.nodeValue)); } } var template = document.querySelector(<span class="hljs-string"><span class="hljs-string">"#template ."</span></span> + name); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> instantiate(template); }</code> <br> <br>  cloneNode,      DOM,   .     ,       <span class="hljs-literal"><span class="hljs-literal">true</span></span>.  instantiate    ,     . <br> <br>   instantiateTemplate   ,    ,     .   {{title}}     ‚Äútitle‚Äù. <br> <br>      ,    drawTalk   . <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">drawTalk</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(talk)</span></span></span></span> { var node = instantiateTemplate(<span class="hljs-string"><span class="hljs-string">"talk"</span></span>, talk); var comments = node.querySelector(<span class="hljs-string"><span class="hljs-string">".comments"</span></span>); talk.comments.forEach(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(comment)</span></span></span></span> { comments.appendChild( instantiateTemplate(<span class="hljs-string"><span class="hljs-string">"comment"</span></span>, comment)); }); node.querySelector(<span class="hljs-string"><span class="hljs-string">"button.del"</span></span>).addEventListener( <span class="hljs-string"><span class="hljs-string">"click"</span></span>, deleteTalk.bind(null, talk.title)); var form = node.querySelector(<span class="hljs-string"><span class="hljs-string">"form"</span></span>); form.addEventListener(<span class="hljs-string"><span class="hljs-string">"submit"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(event)</span></span></span></span> { event.preventDefault(); addComment(talk.title, form.elements.comment.value); form.reset(); }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> node; }</code> <br> <br>     ‚Äútalk‚Äù    . -,   ,     ‚Äúcomment‚Äù       <span class="hljs-string"><span class="hljs-string">"comments"</span></span>. ,      ,      ,  . <br> <br>   <br>  ,   drawTalk,   deleteTalk  addComment   ,       .      URL,       ,       talkURL. <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">talkURL</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(title)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"talks/"</span></span> + encodeURIComponent(title); }</code> <br> <br>  deleteTalk   DELETE       . <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">deleteTalk</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(title)</span></span></span></span> { request({pathname: talkURL(title), method: <span class="hljs-string"><span class="hljs-string">"DELETE"</span></span>}, reportError); }</code> <br> <br>          JSON      POST-. <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">addComment</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(title, comment)</span></span></span></span> { var comment = {author: nameField.value, message: comment}; request({pathname: talkURL(title) + <span class="hljs-string"><span class="hljs-string">"/comments"</span></span>, body: JSON.stringify(comment), method: <span class="hljs-string"><span class="hljs-string">"POST"</span></span>}, reportError); }</code> <br> <br>  nameField,      author,    <code><code class="javascript">  ,      .       localStorage,          . <br> <br> var nameField = document.querySelector(<span class="hljs-string"><span class="hljs-string">"#name"</span></span>); nameField.value = localStorage.getItem(<span class="hljs-string"><span class="hljs-string">"name"</span></span>) || <span class="hljs-string"><span class="hljs-string">""</span></span>; nameField.addEventListener(<span class="hljs-string"><span class="hljs-string">"change"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { localStorage.setItem(<span class="hljs-string"><span class="hljs-string">"name"</span></span>, nameField.value); });           ‚Äúsubmit‚Äù.       (     ),     PUT-   . var talkForm = document.querySelector(<span class="hljs-string"><span class="hljs-string">"#newtalk"</span></span>); talkForm.addEventListener(<span class="hljs-string"><span class="hljs-string">"submit"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(event)</span></span></span></span> { event.preventDefault(); request({pathname: talkURL(talkForm.elements.title.value), method: <span class="hljs-string"><span class="hljs-string">"PUT"</span></span>, body: JSON.stringify({ presenter: nameField.value, summary: talkForm.elements.summary.value })}, reportError); talkForm.reset(); });</code> <br> <br>   <br>  ,   ,   ,    ,     ,     ,       .    -       ,     . <br> <br>       ,    displayTalks    ,     ,       . <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">waitForChanges</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { request({pathname: <span class="hljs-string"><span class="hljs-string">"talks?changesSince="</span></span> + lastServerTime}, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(error, response)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>) { setTimeout(waitForChanges, <span class="hljs-number"><span class="hljs-number">2500</span></span>); console.<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>.stack); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { response = JSON.parse(response); displayTalks(response.talks); lastServerTime = response.serverTime; waitForChanges(); } }); }</code> <br> <br>    ,   ,     ,  ,    .    ,    reportError,             .       (  ),      <span class="hljs-number"><span class="hljs-number">2.5</span></span> . <br> <br>   ,     ,  lastServerTime ,    ,           .    ,    . <br> <br>    ,        localhost:<span class="hljs-number"><span class="hljs-number">8000</span></span>,  ,  ,     ,    . <br> <br>  <br>      ,    .    , ,   <a href=""> </a>   <a href="http://nodejs.org/">Node.js</a> . <br> <br>     <br>      .     ,      . <br> <br>     ,            .    ,    . <br> <br>    <br>      ,       DOM   ,   .   .     -         ,          ,      ,      ,  . <br> <br>   ,        ,    .    ,   ? <br> <br>   <br>    ,     .         ,   <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>,    ,  . <br> <br>           ,   (<span class="hljs-string"><span class="hljs-string">"comment"</span></span>)     .      ‚Äútalk‚Äù,     ,    comments,    ,   ,    . <br> <br>     : <br> <br> <code class="html">&lt;div class=<span class="hljs-string"><span class="hljs-string">"comments"</span></span>&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"comment"</span></span> template-<span class="hljs-keyword"><span class="hljs-keyword">repeat</span></span>=<span class="hljs-string"><span class="hljs-string">"comments"</span></span>&gt; &lt;span class=<span class="hljs-string"><span class="hljs-string">"name"</span></span>&gt;{{author}}&lt;/span&gt;: {{message}} &lt;/div&gt; &lt;/div&gt;</code> <br> <br>   :       template-<span class="hljs-keyword"><span class="hljs-keyword">repeat</span></span>,  ,     ,   ,   ,   .   ( values  instantiateTemplate)          ,   {{author}}     comment,    . <br> <br>  instantiateTemplate ,    ,    ,     ,          drawTalk. <br> <br>       ,      ,     <span class="hljs-literal"><span class="hljs-literal">true</span></span>  <span class="hljs-literal"><span class="hljs-literal">false</span></span>? <br> <br>    ? <br>  -       JavaScript,     .   - . <br> <br>   -     JavaScript.       ,      .         . <br> <br>   ,   -          JavaScript.     ,       .       ,     . <br> <br>     .    .          ,  ,    ?</code></code> </pre> <code><code class="html">  ID ‚Äútalks‚Äù    .   ,      . <br> <br>       . <br> <br> &lt;form id="newtalk"&gt; &lt;h3&gt;Submit a talk&lt;/h3&gt; : &lt;input type="text" style="width: 40em" name="title"&gt; &lt;br&gt; Summary: &lt;input type="text" style="width: 40em" name="summary"&gt; &lt;button type="submit"&gt; &lt;/button&gt; &lt;/form&gt;</code> <br> <br>     ‚Äúsubmit‚Äù  ,      HTTP-,    . <br> <br>    ,    display   none,       . ,   ? <br> <br> <code class="html">&lt;div id="template" style="display: none"&gt; &lt;div class="talk"&gt; &lt;h2&gt;{{title}}&lt;/h2&gt; &lt;div&gt;by &lt;span class="name"&gt;{{presenter}}&lt;/span&gt;&lt;/div&gt; &lt;p&gt;{{summary}}&lt;/p&gt; &lt;div class="comments"&gt;&lt;/div&gt; &lt;form&gt; &lt;input type="text" name="comment"&gt; &lt;button type="submit"&gt; &lt;/button&gt; &lt;button type="button" class="del"&gt; &lt;/button&gt; &lt;/form&gt; &lt;/div&gt; &lt;div class="comment"&gt; &lt;span class="name"&gt;{{author}}&lt;/span&gt;: {{message}} &lt;/div&gt; &lt;/div&gt;</code> <br> <br>    DOM  JavaScript    .          elt   13,       ,  HTML,   -      DOM-. <br> <br>   DOM-   ,      ,    ,   ,     ‚Äì             . <br> <br>  , HTML   ,   . <br> <br> <code class="html">&lt;script src="skillsharing_client.js"&gt;&lt;/script&gt;</code> <br> <br>  <br> ,       ,       .       HTTP-,      XMLHttpRequest,            . <br> <br> <code class="javascript">function request(options, callback) { var req = new XMLHttpRequest(); req.open(options.method || "GET", options.pathname, true); req.addEventListener("load", function() { if (req.status &lt; 400) callback(null, req.responseText); else callback(new Error("Request failed: " + req.statusText)); }); req.addEventListener("error", function() { callback(new Error("Network error")); }); req.send(options.body || null); }</code> <br> <br>            ,  waitForChanges. <br> <br> <code class="javascript">var lastServerTime = 0; request({pathname: "talks"}, function(error, response) { if (error) { reportError(error); } else { response = JSON.parse(response); displayTalks(response.talks); lastServerTime = response.serverTime; waitForChanges(); } });</code> <br> <br>  lastServerTime      ,   .   ,        ,       .  ,  serverTime,   ,     lastServerTime. <br> <br>    ,   ,        .       reportError,      ,   . <br> <br> <code class="javascript">function reportError(error) { if (error) alert(error.toString()); }</code> <br> <br>  ,   ,       .  ,           ,     .      ,      . <br> <br>   <br>         ,    ,    . ,     ,     ,        .  ,      ,   DOM    . <br> <br>  displayTalks      ,       .     shownTalks,      DOM,   ,     . <br> <br> <code class="javascript">var talkDiv = document.querySelector("#talks"); var shownTalks = Object.create(null); function displayTalks(talks) { talks.forEach(function(talk) { var shown = shownTalks[talk.title]; if (talk.deleted) { if (shown) { talkDiv.removeChild(shown); delete shownTalks[talk.title]; } } else { var node = drawTalk(talk); if (shown) talkDiv.replaceChild(node, shown); else talkDiv.appendChild(node); shownTalks[talk.title] = node; } }); }</code> <br> <br>  DOM     ,   HTML .    instantiateTemplate,     . <br> <br>  name ‚Äì  .    ,   ,        ,       ID ‚Äútemplate‚Äù.  querySelector   .     ‚Äútalk‚Äù  ‚Äúcomment‚Äù. <br> <br> <code class="javascript">function instantiateTemplate(name, values) { function instantiateText(text) { return text.replace(/\{\{(\w+)\}\}/g, function(_, name) { return values[name]; }); } function instantiate(node) { if (node.nodeType == document.ELEMENT_NODE) { var copy = node.cloneNode(); for (var i = 0; i &lt; node.childNodes.length; i++) copy.appendChild(instantiate(node.childNodes[i])); return copy; } else if (node.nodeType == document.TEXT_NODE) { return document.createTextNode( instantiateText(node.nodeValue)); } } var template = document.querySelector("#template ." + name); return instantiate(template); }</code> <br> <br>  cloneNode,      DOM,   .     ,       true.  instantiate    ,     . <br> <br>   instantiateTemplate   ,    ,     .   {{title}}     ‚Äútitle‚Äù. <br> <br>      ,    drawTalk   . <br> <br> <code class="javascript">function drawTalk(talk) { var node = instantiateTemplate("talk", talk); var comments = node.querySelector(".comments"); talk.comments.forEach(function(comment) { comments.appendChild( instantiateTemplate("comment", comment)); }); node.querySelector("button.del").addEventListener( "click", deleteTalk.bind(null, talk.title)); var form = node.querySelector("form"); form.addEventListener("submit", function(event) { event.preventDefault(); addComment(talk.title, form.elements.comment.value); form.reset(); }); return node; }</code> <br> <br>     ‚Äútalk‚Äù    . -,   ,     ‚Äúcomment‚Äù       "comments". ,      ,      ,  . <br> <br>   <br>  ,   drawTalk,   deleteTalk  addComment   ,       .      URL,       ,       talkURL. <br> <br> <code class="javascript">function talkURL(title) { return "talks/" + encodeURIComponent(title); }</code> <br> <br>  deleteTalk   DELETE       . <br> <br> <code class="javascript">function deleteTalk(title) { request({pathname: talkURL(title), method: "DELETE"}, reportError); }</code> <br> <br>          JSON      POST-. <br> <br> <code class="javascript">function addComment(title, comment) { var comment = {author: nameField.value, message: comment}; request({pathname: talkURL(title) + "/comments", body: JSON.stringify(comment), method: "POST"}, reportError); }</code> <br> <br>  nameField,      author,    <code><code class="javascript">  ,      .       localStorage,          . <br> <br> var nameField = document.querySelector("#name"); nameField.value = localStorage.getItem("name") || ""; nameField.addEventListener("change", function() { localStorage.setItem("name", nameField.value); });           ‚Äúsubmit‚Äù.       (     ),     PUT-   . var talkForm = document.querySelector("#newtalk"); talkForm.addEventListener("submit", function(event) { event.preventDefault(); request({pathname: talkURL(talkForm.elements.title.value), method: "PUT", body: JSON.stringify({ presenter: nameField.value, summary: talkForm.elements.summary.value })}, reportError); talkForm.reset(); });</code> <br> <br>   <br>  ,   ,   ,    ,     ,     ,       .    -       ,     . <br> <br>       ,    displayTalks    ,     ,       . <br> <br> <code class="javascript">function waitForChanges() { request({pathname: "talks?changesSince=" + lastServerTime}, function(error, response) { if (error) { setTimeout(waitForChanges, 2500); console.error(error.stack); } else { response = JSON.parse(response); displayTalks(response.talks); lastServerTime = response.serverTime; waitForChanges(); } }); }</code> <br> <br>    ,   ,     ,  ,    .    ,    reportError,             .       (  ),      2.5 . <br> <br>   ,     ,  lastServerTime ,    ,           .    ,    . <br> <br>    ,        localhost:8000,  ,  ,     ,    . <br> <br>  <br>      ,    .    , ,   <a href=""> </a>   <a href="http://nodejs.org/">Node.js</a> . <br> <br>     <br>      .     ,      . <br> <br>     ,            .    ,    . <br> <br>    <br>      ,       DOM   ,   .   .     -         ,          ,      ,      ,  . <br> <br>   ,        ,    .    ,   ? <br> <br>   <br>    ,     .         ,   if,    ,  . <br> <br>           ,   ("comment")     .      ‚Äútalk‚Äù,     ,    comments,    ,   ,    . <br> <br>     : <br> <br> <code class="html">&lt;div class="comments"&gt; &lt;div class="comment" template-repeat="comments"&gt; &lt;span class="name"&gt;{{author}}&lt;/span&gt;: {{message}} &lt;/div&gt; &lt;/div&gt;</code> <br> <br>   :       template-repeat,  ,     ,   ,   ,   .   ( values  instantiateTemplate)          ,   {{author}}     comment,    . <br> <br>  instantiateTemplate ,    ,    ,     ,          drawTalk. <br> <br>       ,      ,     true  false? <br> <br>    ? <br>  -       JavaScript,     .   - . <br> <br>   -     JavaScript.       ,      .         . <br> <br>   ,   -          JavaScript.     ,       .       ,     . <br> <br>     .    .          ,  ,    ?</code></code> <pre> <code class="hljs lua"><code class="html">  ID ‚Äútalks‚Äù    .   ,      . <br> <br>       . <br> <br> &lt;form id=<span class="hljs-string"><span class="hljs-string">"newtalk"</span></span>&gt; &lt;h3&gt;Submit a talk&lt;/h3&gt; : &lt;<span class="hljs-built_in"><span class="hljs-built_in">input</span></span> <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=<span class="hljs-string"><span class="hljs-string">"text"</span></span> style=<span class="hljs-string"><span class="hljs-string">"width: 40em"</span></span> name=<span class="hljs-string"><span class="hljs-string">"title"</span></span>&gt; &lt;br&gt; Summary: &lt;<span class="hljs-built_in"><span class="hljs-built_in">input</span></span> <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=<span class="hljs-string"><span class="hljs-string">"text"</span></span> style=<span class="hljs-string"><span class="hljs-string">"width: 40em"</span></span> name=<span class="hljs-string"><span class="hljs-string">"summary"</span></span>&gt; &lt;button <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=<span class="hljs-string"><span class="hljs-string">"submit"</span></span>&gt; &lt;/button&gt; &lt;/form&gt;</code> <br> <br>     ‚Äúsubmit‚Äù  ,      HTTP-,    . <br> <br>    ,    display   none,       . ,   ? <br> <br> <code class="html">&lt;div id=<span class="hljs-string"><span class="hljs-string">"template"</span></span> style=<span class="hljs-string"><span class="hljs-string">"display: none"</span></span>&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"talk"</span></span>&gt; &lt;h2&gt;{{title}}&lt;/h2&gt; &lt;div&gt;by &lt;span class=<span class="hljs-string"><span class="hljs-string">"name"</span></span>&gt;{{presenter}}&lt;/span&gt;&lt;/div&gt; &lt;p&gt;{{summary}}&lt;/p&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"comments"</span></span>&gt;&lt;/div&gt; &lt;form&gt; &lt;<span class="hljs-built_in"><span class="hljs-built_in">input</span></span> <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=<span class="hljs-string"><span class="hljs-string">"text"</span></span> name=<span class="hljs-string"><span class="hljs-string">"comment"</span></span>&gt; &lt;button <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=<span class="hljs-string"><span class="hljs-string">"submit"</span></span>&gt; &lt;/button&gt; &lt;button <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=<span class="hljs-string"><span class="hljs-string">"button"</span></span> class=<span class="hljs-string"><span class="hljs-string">"del"</span></span>&gt; &lt;/button&gt; &lt;/form&gt; &lt;/div&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"comment"</span></span>&gt; &lt;span class=<span class="hljs-string"><span class="hljs-string">"name"</span></span>&gt;{{author}}&lt;/span&gt;: {{message}} &lt;/div&gt; &lt;/div&gt;</code> <br> <br>    DOM  JavaScript    .          elt   <span class="hljs-number"><span class="hljs-number">13</span></span>,       ,  HTML,   -      DOM-. <br> <br>   DOM-   ,      ,    ,   ,     ‚Äì             . <br> <br>  , HTML   ,   . <br> <br> <code class="html">&lt;script src=<span class="hljs-string"><span class="hljs-string">"skillsharing_client.js"</span></span>&gt;&lt;/script&gt;</code> <br> <br>  <br> ,       ,       .       HTTP-,      XMLHttpRequest,            . <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">request</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(options, callback)</span></span></span></span> { var req = new XMLHttpRequest(); req.<span class="hljs-built_in"><span class="hljs-built_in">open</span></span>(options.method || <span class="hljs-string"><span class="hljs-string">"GET"</span></span>, options.pathname, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); req.addEventListener(<span class="hljs-string"><span class="hljs-string">"load"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (req.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> &lt; <span class="hljs-number"><span class="hljs-number">400</span></span>) callback(null, req.responseText); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> callback(new Error(<span class="hljs-string"><span class="hljs-string">"Request failed: "</span></span> + req.statusText)); }); req.addEventListener(<span class="hljs-string"><span class="hljs-string">"error"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { callback(new Error(<span class="hljs-string"><span class="hljs-string">"Network error"</span></span>)); }); req.send(options.body || null); }</code> <br> <br>            ,  waitForChanges. <br> <br> <code class="javascript">var lastServerTime = <span class="hljs-number"><span class="hljs-number">0</span></span>; request({pathname: <span class="hljs-string"><span class="hljs-string">"talks"</span></span>}, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(error, response)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>) { reportError(<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { response = JSON.parse(response); displayTalks(response.talks); lastServerTime = response.serverTime; waitForChanges(); } });</code> <br> <br>  lastServerTime      ,   .   ,        ,       .  ,  serverTime,   ,     lastServerTime. <br> <br>    ,   ,        .       reportError,      ,   . <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">reportError</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(error)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>) alert(<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>.toString()); }</code> <br> <br>  ,   ,       .  ,           ,     .      ,      . <br> <br>   <br>         ,    ,    . ,     ,     ,        .  ,      ,   DOM    . <br> <br>  displayTalks      ,       .     shownTalks,      DOM,   ,     . <br> <br> <code class="javascript">var talkDiv = document.querySelector(<span class="hljs-string"><span class="hljs-string">"#talks"</span></span>); var shownTalks = Object.<span class="hljs-built_in"><span class="hljs-built_in">create</span></span>(null); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">displayTalks</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(talks)</span></span></span></span> { talks.forEach(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(talk)</span></span></span></span> { var shown = shownTalks[talk.title]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (talk.deleted) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (shown) { talkDiv.removeChild(shown); delete shownTalks[talk.title]; } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { var node = drawTalk(talk); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (shown) talkDiv.replaceChild(node, shown); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> talkDiv.appendChild(node); shownTalks[talk.title] = node; } }); }</code> <br> <br>  DOM     ,   HTML .    instantiateTemplate,     . <br> <br>  name ‚Äì  .    ,   ,        ,       ID ‚Äútemplate‚Äù.  querySelector   .     ‚Äútalk‚Äù  ‚Äúcomment‚Äù. <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">instantiateTemplate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(name, values)</span></span></span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">instantiateText</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(text)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> text.replace(/\{\{(\w+)\}\}/g, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(_, name)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> values[name]; }); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">instantiate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(node)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (node.nodeType == document.ELEMENT_NODE) { var copy = node.cloneNode(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (var i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; node.childNodes.length; i++) copy.appendChild(instantiate(node.childNodes[i])); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> copy; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (node.nodeType == document.TEXT_NODE) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> document.createTextNode( instantiateText(node.nodeValue)); } } var template = document.querySelector(<span class="hljs-string"><span class="hljs-string">"#template ."</span></span> + name); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> instantiate(template); }</code> <br> <br>  cloneNode,      DOM,   .     ,       <span class="hljs-literal"><span class="hljs-literal">true</span></span>.  instantiate    ,     . <br> <br>   instantiateTemplate   ,    ,     .   {{title}}     ‚Äútitle‚Äù. <br> <br>      ,    drawTalk   . <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">drawTalk</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(talk)</span></span></span></span> { var node = instantiateTemplate(<span class="hljs-string"><span class="hljs-string">"talk"</span></span>, talk); var comments = node.querySelector(<span class="hljs-string"><span class="hljs-string">".comments"</span></span>); talk.comments.forEach(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(comment)</span></span></span></span> { comments.appendChild( instantiateTemplate(<span class="hljs-string"><span class="hljs-string">"comment"</span></span>, comment)); }); node.querySelector(<span class="hljs-string"><span class="hljs-string">"button.del"</span></span>).addEventListener( <span class="hljs-string"><span class="hljs-string">"click"</span></span>, deleteTalk.bind(null, talk.title)); var form = node.querySelector(<span class="hljs-string"><span class="hljs-string">"form"</span></span>); form.addEventListener(<span class="hljs-string"><span class="hljs-string">"submit"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(event)</span></span></span></span> { event.preventDefault(); addComment(talk.title, form.elements.comment.value); form.reset(); }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> node; }</code> <br> <br>     ‚Äútalk‚Äù    . -,   ,     ‚Äúcomment‚Äù       <span class="hljs-string"><span class="hljs-string">"comments"</span></span>. ,      ,      ,  . <br> <br>   <br>  ,   drawTalk,   deleteTalk  addComment   ,       .      URL,       ,       talkURL. <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">talkURL</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(title)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"talks/"</span></span> + encodeURIComponent(title); }</code> <br> <br>  deleteTalk   DELETE       . <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">deleteTalk</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(title)</span></span></span></span> { request({pathname: talkURL(title), method: <span class="hljs-string"><span class="hljs-string">"DELETE"</span></span>}, reportError); }</code> <br> <br>          JSON      POST-. <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">addComment</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(title, comment)</span></span></span></span> { var comment = {author: nameField.value, message: comment}; request({pathname: talkURL(title) + <span class="hljs-string"><span class="hljs-string">"/comments"</span></span>, body: JSON.stringify(comment), method: <span class="hljs-string"><span class="hljs-string">"POST"</span></span>}, reportError); }</code> <br> <br>  nameField,      author,    <code><code class="javascript">  ,      .       localStorage,          . <br> <br> var nameField = document.querySelector(<span class="hljs-string"><span class="hljs-string">"#name"</span></span>); nameField.value = localStorage.getItem(<span class="hljs-string"><span class="hljs-string">"name"</span></span>) || <span class="hljs-string"><span class="hljs-string">""</span></span>; nameField.addEventListener(<span class="hljs-string"><span class="hljs-string">"change"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { localStorage.setItem(<span class="hljs-string"><span class="hljs-string">"name"</span></span>, nameField.value); });           ‚Äúsubmit‚Äù.       (     ),     PUT-   . var talkForm = document.querySelector(<span class="hljs-string"><span class="hljs-string">"#newtalk"</span></span>); talkForm.addEventListener(<span class="hljs-string"><span class="hljs-string">"submit"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(event)</span></span></span></span> { event.preventDefault(); request({pathname: talkURL(talkForm.elements.title.value), method: <span class="hljs-string"><span class="hljs-string">"PUT"</span></span>, body: JSON.stringify({ presenter: nameField.value, summary: talkForm.elements.summary.value })}, reportError); talkForm.reset(); });</code> <br> <br>   <br>  ,   ,   ,    ,     ,     ,       .    -       ,     . <br> <br>       ,    displayTalks    ,     ,       . <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">waitForChanges</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { request({pathname: <span class="hljs-string"><span class="hljs-string">"talks?changesSince="</span></span> + lastServerTime}, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(error, response)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>) { setTimeout(waitForChanges, <span class="hljs-number"><span class="hljs-number">2500</span></span>); console.<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>.stack); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { response = JSON.parse(response); displayTalks(response.talks); lastServerTime = response.serverTime; waitForChanges(); } }); }</code> <br> <br>    ,   ,     ,  ,    .    ,    reportError,             .       (  ),      <span class="hljs-number"><span class="hljs-number">2.5</span></span> . <br> <br>   ,     ,  lastServerTime ,    ,           .    ,    . <br> <br>    ,        localhost:<span class="hljs-number"><span class="hljs-number">8000</span></span>,  ,  ,     ,    . <br> <br>  <br>      ,    .    , ,   <a href=""> </a>   <a href="http://nodejs.org/">Node.js</a> . <br> <br>     <br>      .     ,      . <br> <br>     ,            .    ,    . <br> <br>    <br>      ,       DOM   ,   .   .     -         ,          ,      ,      ,  . <br> <br>   ,        ,    .    ,   ? <br> <br>   <br>    ,     .         ,   <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>,    ,  . <br> <br>           ,   (<span class="hljs-string"><span class="hljs-string">"comment"</span></span>)     .      ‚Äútalk‚Äù,     ,    comments,    ,   ,    . <br> <br>     : <br> <br> <code class="html">&lt;div class=<span class="hljs-string"><span class="hljs-string">"comments"</span></span>&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"comment"</span></span> template-<span class="hljs-keyword"><span class="hljs-keyword">repeat</span></span>=<span class="hljs-string"><span class="hljs-string">"comments"</span></span>&gt; &lt;span class=<span class="hljs-string"><span class="hljs-string">"name"</span></span>&gt;{{author}}&lt;/span&gt;: {{message}} &lt;/div&gt; &lt;/div&gt;</code> <br> <br>   :       template-<span class="hljs-keyword"><span class="hljs-keyword">repeat</span></span>,  ,     ,   ,   ,   .   ( values  instantiateTemplate)          ,   {{author}}     comment,    . <br> <br>  instantiateTemplate ,    ,    ,     ,          drawTalk. <br> <br>       ,      ,     <span class="hljs-literal"><span class="hljs-literal">true</span></span>  <span class="hljs-literal"><span class="hljs-literal">false</span></span>? <br> <br>    ? <br>  -       JavaScript,     .   - . <br> <br>   -     JavaScript.       ,      .         . <br> <br>   ,   -          JavaScript.     ,       .       ,     . <br> <br>     .    .          ,  ,    ?</code></code> </pre> <code><code class="html">  ID ‚Äútalks‚Äù    .   ,      . <br> <br>       . <br> <br> &lt;form id="newtalk"&gt; &lt;h3&gt;Submit a talk&lt;/h3&gt; : &lt;input type="text" style="width: 40em" name="title"&gt; &lt;br&gt; Summary: &lt;input type="text" style="width: 40em" name="summary"&gt; &lt;button type="submit"&gt; &lt;/button&gt; &lt;/form&gt;</code> <br> <br>     ‚Äúsubmit‚Äù  ,      HTTP-,    . <br> <br>    ,    display   none,       . ,   ? <br> <br> <code class="html">&lt;div id="template" style="display: none"&gt; &lt;div class="talk"&gt; &lt;h2&gt;{{title}}&lt;/h2&gt; &lt;div&gt;by &lt;span class="name"&gt;{{presenter}}&lt;/span&gt;&lt;/div&gt; &lt;p&gt;{{summary}}&lt;/p&gt; &lt;div class="comments"&gt;&lt;/div&gt; &lt;form&gt; &lt;input type="text" name="comment"&gt; &lt;button type="submit"&gt; &lt;/button&gt; &lt;button type="button" class="del"&gt; &lt;/button&gt; &lt;/form&gt; &lt;/div&gt; &lt;div class="comment"&gt; &lt;span class="name"&gt;{{author}}&lt;/span&gt;: {{message}} &lt;/div&gt; &lt;/div&gt;</code> <br> <br>    DOM  JavaScript    .          elt   13,       ,  HTML,   -      DOM-. <br> <br>   DOM-   ,      ,    ,   ,     ‚Äì             . <br> <br>  , HTML   ,   . <br> <br> <code class="html">&lt;script src="skillsharing_client.js"&gt;&lt;/script&gt;</code> <br> <br>  <br> ,       ,       .       HTTP-,      XMLHttpRequest,            . <br> <br> <code class="javascript">function request(options, callback) { var req = new XMLHttpRequest(); req.open(options.method || "GET", options.pathname, true); req.addEventListener("load", function() { if (req.status &lt; 400) callback(null, req.responseText); else callback(new Error("Request failed: " + req.statusText)); }); req.addEventListener("error", function() { callback(new Error("Network error")); }); req.send(options.body || null); }</code> <br> <br>            ,  waitForChanges. <br> <br> <code class="javascript">var lastServerTime = 0; request({pathname: "talks"}, function(error, response) { if (error) { reportError(error); } else { response = JSON.parse(response); displayTalks(response.talks); lastServerTime = response.serverTime; waitForChanges(); } });</code> <br> <br>  lastServerTime      ,   .   ,        ,       .  ,  serverTime,   ,     lastServerTime. <br> <br>    ,   ,        .       reportError,      ,   . <br> <br> <code class="javascript">function reportError(error) { if (error) alert(error.toString()); }</code> <br> <br>  ,   ,       .  ,           ,     .      ,      . <br> <br>   <br>         ,    ,    . ,     ,     ,        .  ,      ,   DOM    . <br> <br>  displayTalks      ,       .     shownTalks,      DOM,   ,     . <br> <br> <code class="javascript">var talkDiv = document.querySelector("#talks"); var shownTalks = Object.create(null); function displayTalks(talks) { talks.forEach(function(talk) { var shown = shownTalks[talk.title]; if (talk.deleted) { if (shown) { talkDiv.removeChild(shown); delete shownTalks[talk.title]; } } else { var node = drawTalk(talk); if (shown) talkDiv.replaceChild(node, shown); else talkDiv.appendChild(node); shownTalks[talk.title] = node; } }); }</code> <br> <br>  DOM     ,   HTML .    instantiateTemplate,     . <br> <br>  name ‚Äì  .    ,   ,        ,       ID ‚Äútemplate‚Äù.  querySelector   .     ‚Äútalk‚Äù  ‚Äúcomment‚Äù. <br> <br> <code class="javascript">function instantiateTemplate(name, values) { function instantiateText(text) { return text.replace(/\{\{(\w+)\}\}/g, function(_, name) { return values[name]; }); } function instantiate(node) { if (node.nodeType == document.ELEMENT_NODE) { var copy = node.cloneNode(); for (var i = 0; i &lt; node.childNodes.length; i++) copy.appendChild(instantiate(node.childNodes[i])); return copy; } else if (node.nodeType == document.TEXT_NODE) { return document.createTextNode( instantiateText(node.nodeValue)); } } var template = document.querySelector("#template ." + name); return instantiate(template); }</code> <br> <br>  cloneNode,      DOM,   .     ,       true.  instantiate    ,     . <br> <br>   instantiateTemplate   ,    ,     .   {{title}}     ‚Äútitle‚Äù. <br> <br>      ,    drawTalk   . <br> <br> <code class="javascript">function drawTalk(talk) { var node = instantiateTemplate("talk", talk); var comments = node.querySelector(".comments"); talk.comments.forEach(function(comment) { comments.appendChild( instantiateTemplate("comment", comment)); }); node.querySelector("button.del").addEventListener( "click", deleteTalk.bind(null, talk.title)); var form = node.querySelector("form"); form.addEventListener("submit", function(event) { event.preventDefault(); addComment(talk.title, form.elements.comment.value); form.reset(); }); return node; }</code> <br> <br>     ‚Äútalk‚Äù    . -,   ,     ‚Äúcomment‚Äù       "comments". ,      ,      ,  . <br> <br>   <br>  ,   drawTalk,   deleteTalk  addComment   ,       .      URL,       ,       talkURL. <br> <br> <code class="javascript">function talkURL(title) { return "talks/" + encodeURIComponent(title); }</code> <br> <br>  deleteTalk   DELETE       . <br> <br> <code class="javascript">function deleteTalk(title) { request({pathname: talkURL(title), method: "DELETE"}, reportError); }</code> <br> <br>          JSON      POST-. <br> <br> <code class="javascript">function addComment(title, comment) { var comment = {author: nameField.value, message: comment}; request({pathname: talkURL(title) + "/comments", body: JSON.stringify(comment), method: "POST"}, reportError); }</code> <br> <br>  nameField,      author,    <code><code class="javascript">  ,      .       localStorage,          . <br> <br> var nameField = document.querySelector("#name"); nameField.value = localStorage.getItem("name") || ""; nameField.addEventListener("change", function() { localStorage.setItem("name", nameField.value); });           ‚Äúsubmit‚Äù.       (     ),     PUT-   . var talkForm = document.querySelector("#newtalk"); talkForm.addEventListener("submit", function(event) { event.preventDefault(); request({pathname: talkURL(talkForm.elements.title.value), method: "PUT", body: JSON.stringify({ presenter: nameField.value, summary: talkForm.elements.summary.value })}, reportError); talkForm.reset(); });</code> <br> <br>   <br>  ,   ,   ,    ,     ,     ,       .    -       ,     . <br> <br>       ,    displayTalks    ,     ,       . <br> <br> <code class="javascript">function waitForChanges() { request({pathname: "talks?changesSince=" + lastServerTime}, function(error, response) { if (error) { setTimeout(waitForChanges, 2500); console.error(error.stack); } else { response = JSON.parse(response); displayTalks(response.talks); lastServerTime = response.serverTime; waitForChanges(); } }); }</code> <br> <br>    ,   ,     ,  ,    .    ,    reportError,             .       (  ),      2.5 . <br> <br>   ,     ,  lastServerTime ,    ,           .    ,    . <br> <br>    ,        localhost:8000,  ,  ,     ,    . <br> <br>  <br>      ,    .    , ,   <a href=""> </a>   <a href="http://nodejs.org/">Node.js</a> . <br> <br>     <br>      .     ,      . <br> <br>     ,            .    ,    . <br> <br>    <br>      ,       DOM   ,   .   .     -         ,          ,      ,      ,  . <br> <br>   ,        ,    .    ,   ? <br> <br>   <br>    ,     .         ,   if,    ,  . <br> <br>           ,   ("comment")     .      ‚Äútalk‚Äù,     ,    comments,    ,   ,    . <br> <br>     : <br> <br> <code class="html">&lt;div class="comments"&gt; &lt;div class="comment" template-repeat="comments"&gt; &lt;span class="name"&gt;{{author}}&lt;/span&gt;: {{message}} &lt;/div&gt; &lt;/div&gt;</code> <br> <br>   :       template-repeat,  ,     ,   ,   ,   .   ( values  instantiateTemplate)          ,   {{author}}     comment,    . <br> <br>  instantiateTemplate ,    ,    ,     ,          drawTalk. <br> <br>       ,      ,     true  false? <br> <br>    ? <br>  -       JavaScript,     .   - . <br> <br>   -     JavaScript.       ,      .         . <br> <br>   ,   -          JavaScript.     ,       .       ,     . <br> <br>     .    .          ,  ,    ?</code></code> <pre> <code class="hljs lua"><code class="html">  ID ‚Äútalks‚Äù    .   ,      . <br> <br>       . <br> <br> &lt;form id=<span class="hljs-string"><span class="hljs-string">"newtalk"</span></span>&gt; &lt;h3&gt;Submit a talk&lt;/h3&gt; : &lt;<span class="hljs-built_in"><span class="hljs-built_in">input</span></span> <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=<span class="hljs-string"><span class="hljs-string">"text"</span></span> style=<span class="hljs-string"><span class="hljs-string">"width: 40em"</span></span> name=<span class="hljs-string"><span class="hljs-string">"title"</span></span>&gt; &lt;br&gt; Summary: &lt;<span class="hljs-built_in"><span class="hljs-built_in">input</span></span> <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=<span class="hljs-string"><span class="hljs-string">"text"</span></span> style=<span class="hljs-string"><span class="hljs-string">"width: 40em"</span></span> name=<span class="hljs-string"><span class="hljs-string">"summary"</span></span>&gt; &lt;button <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=<span class="hljs-string"><span class="hljs-string">"submit"</span></span>&gt; &lt;/button&gt; &lt;/form&gt;</code> <br> <br>     ‚Äúsubmit‚Äù  ,      HTTP-,    . <br> <br>    ,    display   none,       . ,   ? <br> <br> <code class="html">&lt;div id=<span class="hljs-string"><span class="hljs-string">"template"</span></span> style=<span class="hljs-string"><span class="hljs-string">"display: none"</span></span>&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"talk"</span></span>&gt; &lt;h2&gt;{{title}}&lt;/h2&gt; &lt;div&gt;by &lt;span class=<span class="hljs-string"><span class="hljs-string">"name"</span></span>&gt;{{presenter}}&lt;/span&gt;&lt;/div&gt; &lt;p&gt;{{summary}}&lt;/p&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"comments"</span></span>&gt;&lt;/div&gt; &lt;form&gt; &lt;<span class="hljs-built_in"><span class="hljs-built_in">input</span></span> <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=<span class="hljs-string"><span class="hljs-string">"text"</span></span> name=<span class="hljs-string"><span class="hljs-string">"comment"</span></span>&gt; &lt;button <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=<span class="hljs-string"><span class="hljs-string">"submit"</span></span>&gt; &lt;/button&gt; &lt;button <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=<span class="hljs-string"><span class="hljs-string">"button"</span></span> class=<span class="hljs-string"><span class="hljs-string">"del"</span></span>&gt; &lt;/button&gt; &lt;/form&gt; &lt;/div&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"comment"</span></span>&gt; &lt;span class=<span class="hljs-string"><span class="hljs-string">"name"</span></span>&gt;{{author}}&lt;/span&gt;: {{message}} &lt;/div&gt; &lt;/div&gt;</code> <br> <br>    DOM  JavaScript    .          elt   <span class="hljs-number"><span class="hljs-number">13</span></span>,       ,  HTML,   -      DOM-. <br> <br>   DOM-   ,      ,    ,   ,     ‚Äì             . <br> <br>  , HTML   ,   . <br> <br> <code class="html">&lt;script src=<span class="hljs-string"><span class="hljs-string">"skillsharing_client.js"</span></span>&gt;&lt;/script&gt;</code> <br> <br>  <br> ,       ,       .       HTTP-,      XMLHttpRequest,            . <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">request</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(options, callback)</span></span></span></span> { var req = new XMLHttpRequest(); req.<span class="hljs-built_in"><span class="hljs-built_in">open</span></span>(options.method || <span class="hljs-string"><span class="hljs-string">"GET"</span></span>, options.pathname, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); req.addEventListener(<span class="hljs-string"><span class="hljs-string">"load"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (req.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> &lt; <span class="hljs-number"><span class="hljs-number">400</span></span>) callback(null, req.responseText); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> callback(new Error(<span class="hljs-string"><span class="hljs-string">"Request failed: "</span></span> + req.statusText)); }); req.addEventListener(<span class="hljs-string"><span class="hljs-string">"error"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { callback(new Error(<span class="hljs-string"><span class="hljs-string">"Network error"</span></span>)); }); req.send(options.body || null); }</code> <br> <br>            ,  waitForChanges. <br> <br> <code class="javascript">var lastServerTime = <span class="hljs-number"><span class="hljs-number">0</span></span>; request({pathname: <span class="hljs-string"><span class="hljs-string">"talks"</span></span>}, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(error, response)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>) { reportError(<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { response = JSON.parse(response); displayTalks(response.talks); lastServerTime = response.serverTime; waitForChanges(); } });</code> <br> <br>  lastServerTime      ,   .   ,        ,       .  ,  serverTime,   ,     lastServerTime. <br> <br>    ,   ,        .       reportError,      ,   . <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">reportError</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(error)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>) alert(<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>.toString()); }</code> <br> <br>  ,   ,       .  ,           ,     .      ,      . <br> <br>   <br>         ,    ,    . ,     ,     ,        .  ,      ,   DOM    . <br> <br>  displayTalks      ,       .     shownTalks,      DOM,   ,     . <br> <br> <code class="javascript">var talkDiv = document.querySelector(<span class="hljs-string"><span class="hljs-string">"#talks"</span></span>); var shownTalks = Object.<span class="hljs-built_in"><span class="hljs-built_in">create</span></span>(null); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">displayTalks</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(talks)</span></span></span></span> { talks.forEach(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(talk)</span></span></span></span> { var shown = shownTalks[talk.title]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (talk.deleted) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (shown) { talkDiv.removeChild(shown); delete shownTalks[talk.title]; } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { var node = drawTalk(talk); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (shown) talkDiv.replaceChild(node, shown); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> talkDiv.appendChild(node); shownTalks[talk.title] = node; } }); }</code> <br> <br>  DOM     ,   HTML .    instantiateTemplate,     . <br> <br>  name ‚Äì  .    ,   ,        ,       ID ‚Äútemplate‚Äù.  querySelector   .     ‚Äútalk‚Äù  ‚Äúcomment‚Äù. <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">instantiateTemplate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(name, values)</span></span></span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">instantiateText</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(text)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> text.replace(/\{\{(\w+)\}\}/g, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(_, name)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> values[name]; }); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">instantiate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(node)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (node.nodeType == document.ELEMENT_NODE) { var copy = node.cloneNode(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (var i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; node.childNodes.length; i++) copy.appendChild(instantiate(node.childNodes[i])); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> copy; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (node.nodeType == document.TEXT_NODE) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> document.createTextNode( instantiateText(node.nodeValue)); } } var template = document.querySelector(<span class="hljs-string"><span class="hljs-string">"#template ."</span></span> + name); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> instantiate(template); }</code> <br> <br>  cloneNode,      DOM,   .     ,       <span class="hljs-literal"><span class="hljs-literal">true</span></span>.  instantiate    ,     . <br> <br>   instantiateTemplate   ,    ,     .   {{title}}     ‚Äútitle‚Äù. <br> <br>      ,    drawTalk   . <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">drawTalk</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(talk)</span></span></span></span> { var node = instantiateTemplate(<span class="hljs-string"><span class="hljs-string">"talk"</span></span>, talk); var comments = node.querySelector(<span class="hljs-string"><span class="hljs-string">".comments"</span></span>); talk.comments.forEach(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(comment)</span></span></span></span> { comments.appendChild( instantiateTemplate(<span class="hljs-string"><span class="hljs-string">"comment"</span></span>, comment)); }); node.querySelector(<span class="hljs-string"><span class="hljs-string">"button.del"</span></span>).addEventListener( <span class="hljs-string"><span class="hljs-string">"click"</span></span>, deleteTalk.bind(null, talk.title)); var form = node.querySelector(<span class="hljs-string"><span class="hljs-string">"form"</span></span>); form.addEventListener(<span class="hljs-string"><span class="hljs-string">"submit"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(event)</span></span></span></span> { event.preventDefault(); addComment(talk.title, form.elements.comment.value); form.reset(); }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> node; }</code> <br> <br>     ‚Äútalk‚Äù    . -,   ,     ‚Äúcomment‚Äù       <span class="hljs-string"><span class="hljs-string">"comments"</span></span>. ,      ,      ,  . <br> <br>   <br>  ,   drawTalk,   deleteTalk  addComment   ,       .      URL,       ,       talkURL. <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">talkURL</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(title)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"talks/"</span></span> + encodeURIComponent(title); }</code> <br> <br>  deleteTalk   DELETE       . <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">deleteTalk</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(title)</span></span></span></span> { request({pathname: talkURL(title), method: <span class="hljs-string"><span class="hljs-string">"DELETE"</span></span>}, reportError); }</code> <br> <br>          JSON      POST-. <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">addComment</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(title, comment)</span></span></span></span> { var comment = {author: nameField.value, message: comment}; request({pathname: talkURL(title) + <span class="hljs-string"><span class="hljs-string">"/comments"</span></span>, body: JSON.stringify(comment), method: <span class="hljs-string"><span class="hljs-string">"POST"</span></span>}, reportError); }</code> <br> <br>  nameField,      author,    <code><code class="javascript">  ,      .       localStorage,          . <br> <br> var nameField = document.querySelector(<span class="hljs-string"><span class="hljs-string">"#name"</span></span>); nameField.value = localStorage.getItem(<span class="hljs-string"><span class="hljs-string">"name"</span></span>) || <span class="hljs-string"><span class="hljs-string">""</span></span>; nameField.addEventListener(<span class="hljs-string"><span class="hljs-string">"change"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { localStorage.setItem(<span class="hljs-string"><span class="hljs-string">"name"</span></span>, nameField.value); });           ‚Äúsubmit‚Äù.       (     ),     PUT-   . var talkForm = document.querySelector(<span class="hljs-string"><span class="hljs-string">"#newtalk"</span></span>); talkForm.addEventListener(<span class="hljs-string"><span class="hljs-string">"submit"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(event)</span></span></span></span> { event.preventDefault(); request({pathname: talkURL(talkForm.elements.title.value), method: <span class="hljs-string"><span class="hljs-string">"PUT"</span></span>, body: JSON.stringify({ presenter: nameField.value, summary: talkForm.elements.summary.value })}, reportError); talkForm.reset(); });</code> <br> <br>   <br>  ,   ,   ,    ,     ,     ,       .    -       ,     . <br> <br>       ,    displayTalks    ,     ,       . <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">waitForChanges</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { request({pathname: <span class="hljs-string"><span class="hljs-string">"talks?changesSince="</span></span> + lastServerTime}, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(error, response)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>) { setTimeout(waitForChanges, <span class="hljs-number"><span class="hljs-number">2500</span></span>); console.<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>.stack); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { response = JSON.parse(response); displayTalks(response.talks); lastServerTime = response.serverTime; waitForChanges(); } }); }</code> <br> <br>    ,   ,     ,  ,    .    ,    reportError,             .       (  ),      <span class="hljs-number"><span class="hljs-number">2.5</span></span> . <br> <br>   ,     ,  lastServerTime ,    ,           .    ,    . <br> <br>    ,        localhost:<span class="hljs-number"><span class="hljs-number">8000</span></span>,  ,  ,     ,    . <br> <br>  <br>      ,    .    , ,   <a href=""> </a>   <a href="http://nodejs.org/">Node.js</a> . <br> <br>     <br>      .     ,      . <br> <br>     ,            .    ,    . <br> <br>    <br>      ,       DOM   ,   .   .     -         ,          ,      ,      ,  . <br> <br>   ,        ,    .    ,   ? <br> <br>   <br>    ,     .         ,   <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>,    ,  . <br> <br>           ,   (<span class="hljs-string"><span class="hljs-string">"comment"</span></span>)     .      ‚Äútalk‚Äù,     ,    comments,    ,   ,    . <br> <br>     : <br> <br> <code class="html">&lt;div class=<span class="hljs-string"><span class="hljs-string">"comments"</span></span>&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"comment"</span></span> template-<span class="hljs-keyword"><span class="hljs-keyword">repeat</span></span>=<span class="hljs-string"><span class="hljs-string">"comments"</span></span>&gt; &lt;span class=<span class="hljs-string"><span class="hljs-string">"name"</span></span>&gt;{{author}}&lt;/span&gt;: {{message}} &lt;/div&gt; &lt;/div&gt;</code> <br> <br>   :       template-<span class="hljs-keyword"><span class="hljs-keyword">repeat</span></span>,  ,     ,   ,   ,   .   ( values  instantiateTemplate)          ,   {{author}}     comment,    . <br> <br>  instantiateTemplate ,    ,    ,     ,          drawTalk. <br> <br>       ,      ,     <span class="hljs-literal"><span class="hljs-literal">true</span></span>  <span class="hljs-literal"><span class="hljs-literal">false</span></span>? <br> <br>    ? <br>  -       JavaScript,     .   - . <br> <br>   -     JavaScript.       ,      .         . <br> <br>   ,   -          JavaScript.     ,       .       ,     . <br> <br>     .    .          ,  ,    ?</code></code> </pre> <code><code><code class="html">  ID ‚Äútalks‚Äù    .   ,      . <br> <br>       . <br> <br> &lt;form id="newtalk"&gt; &lt;h3&gt;Submit a talk&lt;/h3&gt; : &lt;input type="text" style="width: 40em" name="title"&gt; &lt;br&gt; Summary: &lt;input type="text" style="width: 40em" name="summary"&gt; &lt;button type="submit"&gt; &lt;/button&gt; &lt;/form&gt;</code> <br> <br>     ‚Äúsubmit‚Äù  ,      HTTP-,    . <br> <br>    ,    display   none,       . ,   ? <br> <br> <code class="html">&lt;div id="template" style="display: none"&gt; &lt;div class="talk"&gt; &lt;h2&gt;{{title}}&lt;/h2&gt; &lt;div&gt;by &lt;span class="name"&gt;{{presenter}}&lt;/span&gt;&lt;/div&gt; &lt;p&gt;{{summary}}&lt;/p&gt; &lt;div class="comments"&gt;&lt;/div&gt; &lt;form&gt; &lt;input type="text" name="comment"&gt; &lt;button type="submit"&gt; &lt;/button&gt; &lt;button type="button" class="del"&gt; &lt;/button&gt; &lt;/form&gt; &lt;/div&gt; &lt;div class="comment"&gt; &lt;span class="name"&gt;{{author}}&lt;/span&gt;: {{message}} &lt;/div&gt; &lt;/div&gt;</code> <br> <br>    DOM  JavaScript    .          elt   13,       ,  HTML,   -      DOM-. <br> <br>   DOM-   ,      ,    ,   ,     ‚Äì             . <br> <br>  , HTML   ,   . <br> <br> <code class="html">&lt;script src="skillsharing_client.js"&gt;&lt;/script&gt;</code> <br> <br>  <br> ,       ,       .       HTTP-,      XMLHttpRequest,            . <br> <br> <code class="javascript">function request(options, callback) { var req = new XMLHttpRequest(); req.open(options.method || "GET", options.pathname, true); req.addEventListener("load", function() { if (req.status &lt; 400) callback(null, req.responseText); else callback(new Error("Request failed: " + req.statusText)); }); req.addEventListener("error", function() { callback(new Error("Network error")); }); req.send(options.body || null); }</code> <br> <br>            ,  waitForChanges. <br> <br> <code class="javascript">var lastServerTime = 0; request({pathname: "talks"}, function(error, response) { if (error) { reportError(error); } else { response = JSON.parse(response); displayTalks(response.talks); lastServerTime = response.serverTime; waitForChanges(); } });</code> <br> <br>  lastServerTime      ,   .   ,        ,       .  ,  serverTime,   ,     lastServerTime. <br> <br>    ,   ,        .       reportError,      ,   . <br> <br> <code class="javascript">function reportError(error) { if (error) alert(error.toString()); }</code> <br> <br>  ,   ,       .  ,           ,     .      ,      . <br> <br>   <br>         ,    ,    . ,     ,     ,        .  ,      ,   DOM    . <br> <br>  displayTalks      ,       .     shownTalks,      DOM,   ,     . <br> <br> <code class="javascript">var talkDiv = document.querySelector("#talks"); var shownTalks = Object.create(null); function displayTalks(talks) { talks.forEach(function(talk) { var shown = shownTalks[talk.title]; if (talk.deleted) { if (shown) { talkDiv.removeChild(shown); delete shownTalks[talk.title]; } } else { var node = drawTalk(talk); if (shown) talkDiv.replaceChild(node, shown); else talkDiv.appendChild(node); shownTalks[talk.title] = node; } }); }</code> <br> <br>  DOM     ,   HTML .    instantiateTemplate,     . <br> <br>  name ‚Äì  .    ,   ,        ,       ID ‚Äútemplate‚Äù.  querySelector   .     ‚Äútalk‚Äù  ‚Äúcomment‚Äù. <br> <br> <code class="javascript">function instantiateTemplate(name, values) { function instantiateText(text) { return text.replace(/\{\{(\w+)\}\}/g, function(_, name) { return values[name]; }); } function instantiate(node) { if (node.nodeType == document.ELEMENT_NODE) { var copy = node.cloneNode(); for (var i = 0; i &lt; node.childNodes.length; i++) copy.appendChild(instantiate(node.childNodes[i])); return copy; } else if (node.nodeType == document.TEXT_NODE) { return document.createTextNode( instantiateText(node.nodeValue)); } } var template = document.querySelector("#template ." + name); return instantiate(template); }</code> <br> <br>  cloneNode,      DOM,   .     ,       true.  instantiate    ,     . <br> <br>   instantiateTemplate   ,    ,     .   {{title}}     ‚Äútitle‚Äù. <br> <br>      ,    drawTalk   . <br> <br> <code class="javascript">function drawTalk(talk) { var node = instantiateTemplate("talk", talk); var comments = node.querySelector(".comments"); talk.comments.forEach(function(comment) { comments.appendChild( instantiateTemplate("comment", comment)); }); node.querySelector("button.del").addEventListener( "click", deleteTalk.bind(null, talk.title)); var form = node.querySelector("form"); form.addEventListener("submit", function(event) { event.preventDefault(); addComment(talk.title, form.elements.comment.value); form.reset(); }); return node; }</code> <br> <br>     ‚Äútalk‚Äù    . -,   ,     ‚Äúcomment‚Äù       "comments". ,      ,      ,  . <br> <br>   <br>  ,   drawTalk,   deleteTalk  addComment   ,       .      URL,       ,       talkURL. <br> <br> <code class="javascript">function talkURL(title) { return "talks/" + encodeURIComponent(title); }</code> <br> <br>  deleteTalk   DELETE       . <br> <br> <code class="javascript">function deleteTalk(title) { request({pathname: talkURL(title), method: "DELETE"}, reportError); }</code> <br> <br>          JSON      POST-. <br> <br> <code class="javascript">function addComment(title, comment) { var comment = {author: nameField.value, message: comment}; request({pathname: talkURL(title) + "/comments", body: JSON.stringify(comment), method: "POST"}, reportError); }</code> <br> <br>  nameField,      author,    <code class="javascript">  ,      .       localStorage,          . <br> <br> var nameField = document.querySelector("#name"); nameField.value = localStorage.getItem("name") || ""; nameField.addEventListener("change", function() { localStorage.setItem("name", nameField.value); });           ‚Äúsubmit‚Äù.       (     ),     PUT-   . var talkForm = document.querySelector("#newtalk"); talkForm.addEventListener("submit", function(event) { event.preventDefault(); request({pathname: talkURL(talkForm.elements.title.value), method: "PUT", body: JSON.stringify({ presenter: nameField.value, summary: talkForm.elements.summary.value })}, reportError); talkForm.reset(); });</code> <br> <br>   <br>  ,   ,   ,    ,     ,     ,       .    -       ,     . <br> <br>       ,    displayTalks    ,     ,       . <br> <br> <code class="javascript">function waitForChanges() { request({pathname: "talks?changesSince=" + lastServerTime}, function(error, response) { if (error) { setTimeout(waitForChanges, 2500); console.error(error.stack); } else { response = JSON.parse(response); displayTalks(response.talks); lastServerTime = response.serverTime; waitForChanges(); } }); }</code> <br> <br>    ,   ,     ,  ,    .    ,    reportError,             .       (  ),      2.5 . <br> <br>   ,     ,  lastServerTime ,    ,           .    ,    . <br> <br>    ,        localhost:8000,  ,  ,     ,    . <br> <br>  <br>      ,    .    , ,   <a href=""> </a>   <a href="http://nodejs.org/">Node.js</a> . <br> <br>     <br>      .     ,      . <br> <br>     ,            .    ,    . <br> <br>    <br>      ,       DOM   ,   .   .     -         ,          ,      ,      ,  . <br> <br>   ,        ,    .    ,   ? <br> <br>   <br>    ,     .         ,   if,    ,  . <br> <br>           ,   ("comment")     .      ‚Äútalk‚Äù,     ,    comments,    ,   ,    . <br> <br>     : <br> <br> <code class="html">&lt;div class="comments"&gt; &lt;div class="comment" template-repeat="comments"&gt; &lt;span class="name"&gt;{{author}}&lt;/span&gt;: {{message}} &lt;/div&gt; &lt;/div&gt;</code> <br> <br>   :       template-repeat,  ,     ,   ,   ,   .   ( values  instantiateTemplate)          ,   {{author}}     comment,    . <br> <br>  instantiateTemplate ,    ,    ,     ,          drawTalk. <br> <br>       ,      ,     true  false? <br> <br>    ? <br>  -       JavaScript,     .   - . <br> <br>   -     JavaScript.       ,      .         . <br> <br>   ,   -          JavaScript.     ,       .       ,     . <br> <br>     .    .          ,  ,    ?</code></code> <h4> <code><code><code class="html">  ID ‚Äútalks‚Äù    .   ,      . <br> <br>       . <br> <br> &lt;form id="newtalk"&gt; &lt;h3&gt;Submit a talk&lt;/h3&gt; : &lt;input type="text" style="width: 40em" name="title"&gt; &lt;br&gt; Summary: &lt;input type="text" style="width: 40em" name="summary"&gt; &lt;button type="submit"&gt; &lt;/button&gt; &lt;/form&gt;</code> <br> <br>     ‚Äúsubmit‚Äù  ,      HTTP-,    . <br> <br>    ,    display   none,       . ,   ? <br> <br> <code class="html">&lt;div id="template" style="display: none"&gt; &lt;div class="talk"&gt; &lt;h2&gt;{{title}}&lt;/h2&gt; &lt;div&gt;by &lt;span class="name"&gt;{{presenter}}&lt;/span&gt;&lt;/div&gt; &lt;p&gt;{{summary}}&lt;/p&gt; &lt;div class="comments"&gt;&lt;/div&gt; &lt;form&gt; &lt;input type="text" name="comment"&gt; &lt;button type="submit"&gt; &lt;/button&gt; &lt;button type="button" class="del"&gt; &lt;/button&gt; &lt;/form&gt; &lt;/div&gt; &lt;div class="comment"&gt; &lt;span class="name"&gt;{{author}}&lt;/span&gt;: {{message}} &lt;/div&gt; &lt;/div&gt;</code> <br> <br>    DOM  JavaScript    .          elt   13,       ,  HTML,   -      DOM-. <br> <br>   DOM-   ,      ,    ,   ,     ‚Äì             . <br> <br>  , HTML   ,   . <br> <br> <code class="html">&lt;script src="skillsharing_client.js"&gt;&lt;/script&gt;</code> <br> <br>  <br> ,       ,       .       HTTP-,      XMLHttpRequest,            . <br> <br> <code class="javascript">function request(options, callback) { var req = new XMLHttpRequest(); req.open(options.method || "GET", options.pathname, true); req.addEventListener("load", function() { if (req.status &lt; 400) callback(null, req.responseText); else callback(new Error("Request failed: " + req.statusText)); }); req.addEventListener("error", function() { callback(new Error("Network error")); }); req.send(options.body || null); }</code> <br> <br>            ,  waitForChanges. <br> <br> <code class="javascript">var lastServerTime = 0; request({pathname: "talks"}, function(error, response) { if (error) { reportError(error); } else { response = JSON.parse(response); displayTalks(response.talks); lastServerTime = response.serverTime; waitForChanges(); } });</code> <br> <br>  lastServerTime      ,   .   ,        ,       .  ,  serverTime,   ,     lastServerTime. <br> <br>    ,   ,        .       reportError,      ,   . <br> <br> <code class="javascript">function reportError(error) { if (error) alert(error.toString()); }</code> <br> <br>  ,   ,       .  ,           ,     .      ,      . <br> <br>   <br>         ,    ,    . ,     ,     ,        .  ,      ,   DOM    . <br> <br>  displayTalks      ,       .     shownTalks,      DOM,   ,     . <br> <br> <code class="javascript">var talkDiv = document.querySelector("#talks"); var shownTalks = Object.create(null); function displayTalks(talks) { talks.forEach(function(talk) { var shown = shownTalks[talk.title]; if (talk.deleted) { if (shown) { talkDiv.removeChild(shown); delete shownTalks[talk.title]; } } else { var node = drawTalk(talk); if (shown) talkDiv.replaceChild(node, shown); else talkDiv.appendChild(node); shownTalks[talk.title] = node; } }); }</code> <br> <br>  DOM     ,   HTML .    instantiateTemplate,     . <br> <br>  name ‚Äì  .    ,   ,        ,       ID ‚Äútemplate‚Äù.  querySelector   .     ‚Äútalk‚Äù  ‚Äúcomment‚Äù. <br> <br> <code class="javascript">function instantiateTemplate(name, values) { function instantiateText(text) { return text.replace(/\{\{(\w+)\}\}/g, function(_, name) { return values[name]; }); } function instantiate(node) { if (node.nodeType == document.ELEMENT_NODE) { var copy = node.cloneNode(); for (var i = 0; i &lt; node.childNodes.length; i++) copy.appendChild(instantiate(node.childNodes[i])); return copy; } else if (node.nodeType == document.TEXT_NODE) { return document.createTextNode( instantiateText(node.nodeValue)); } } var template = document.querySelector("#template ." + name); return instantiate(template); }</code> <br> <br>  cloneNode,      DOM,   .     ,       true.  instantiate    ,     . <br> <br>   instantiateTemplate   ,    ,     .   {{title}}     ‚Äútitle‚Äù. <br> <br>      ,    drawTalk   . <br> <br> <code class="javascript">function drawTalk(talk) { var node = instantiateTemplate("talk", talk); var comments = node.querySelector(".comments"); talk.comments.forEach(function(comment) { comments.appendChild( instantiateTemplate("comment", comment)); }); node.querySelector("button.del").addEventListener( "click", deleteTalk.bind(null, talk.title)); var form = node.querySelector("form"); form.addEventListener("submit", function(event) { event.preventDefault(); addComment(talk.title, form.elements.comment.value); form.reset(); }); return node; }</code> <br> <br>     ‚Äútalk‚Äù    . -,   ,     ‚Äúcomment‚Äù       "comments". ,      ,      ,  . <br> <br>   <br>  ,   drawTalk,   deleteTalk  addComment   ,       .      URL,       ,       talkURL. <br> <br> <code class="javascript">function talkURL(title) { return "talks/" + encodeURIComponent(title); }</code> <br> <br>  deleteTalk   DELETE       . <br> <br> <code class="javascript">function deleteTalk(title) { request({pathname: talkURL(title), method: "DELETE"}, reportError); }</code> <br> <br>          JSON      POST-. <br> <br> <code class="javascript">function addComment(title, comment) { var comment = {author: nameField.value, message: comment}; request({pathname: talkURL(title) + "/comments", body: JSON.stringify(comment), method: "POST"}, reportError); }</code> <br> <br>  nameField,      author,    <code class="javascript">  ,      .       localStorage,          . <br> <br> var nameField = document.querySelector("#name"); nameField.value = localStorage.getItem("name") || ""; nameField.addEventListener("change", function() { localStorage.setItem("name", nameField.value); });           ‚Äúsubmit‚Äù.       (     ),     PUT-   . var talkForm = document.querySelector("#newtalk"); talkForm.addEventListener("submit", function(event) { event.preventDefault(); request({pathname: talkURL(talkForm.elements.title.value), method: "PUT", body: JSON.stringify({ presenter: nameField.value, summary: talkForm.elements.summary.value })}, reportError); talkForm.reset(); });</code> <br> <br>   <br>  ,   ,   ,    ,     ,     ,       .    -       ,     . <br> <br>       ,    displayTalks    ,     ,       . <br> <br> <code class="javascript">function waitForChanges() { request({pathname: "talks?changesSince=" + lastServerTime}, function(error, response) { if (error) { setTimeout(waitForChanges, 2500); console.error(error.stack); } else { response = JSON.parse(response); displayTalks(response.talks); lastServerTime = response.serverTime; waitForChanges(); } }); }</code> <br> <br>    ,   ,     ,  ,    .    ,    reportError,             .       (  ),      2.5 . <br> <br>   ,     ,  lastServerTime ,    ,           .    ,    . <br> <br>    ,        localhost:8000,  ,  ,     ,    . <br> <br>  <br>      ,    .    , ,   <a href=""> </a>   <a href="http://nodejs.org/">Node.js</a> . <br> <br>     <br>      .     ,      . <br> <br>     ,            .    ,    . <br> <br>    <br>      ,       DOM   ,   .   .     -         ,          ,      ,      ,  . <br> <br>   ,        ,    .    ,   ? <br> <br>   <br>    ,     .         ,   if,    ,  . <br> <br>           ,   ("comment")     .      ‚Äútalk‚Äù,     ,    comments,    ,   ,    . <br> <br>     : <br> <br> <code class="html">&lt;div class="comments"&gt; &lt;div class="comment" template-repeat="comments"&gt; &lt;span class="name"&gt;{{author}}&lt;/span&gt;: {{message}} &lt;/div&gt; &lt;/div&gt;</code> <br> <br>   :       template-repeat,  ,     ,   ,   ,   .   ( values  instantiateTemplate)          ,   {{author}}     comment,    . <br> <br>  instantiateTemplate ,    ,    ,     ,          drawTalk. <br> <br>       ,      ,     true  false? <br> <br>    ? <br>  -       JavaScript,     .   - . <br> <br>   -     JavaScript.       ,      .         . <br> <br>   ,   -          JavaScript.     ,       .       ,     . <br> <br>     .    .          ,  ,    ?</code></code> </h4> <code><code><code class="html">  ID ‚Äútalks‚Äù    .   ,      . <br> <br>       . <br> <br> &lt;form id="newtalk"&gt; &lt;h3&gt;Submit a talk&lt;/h3&gt; : &lt;input type="text" style="width: 40em" name="title"&gt; &lt;br&gt; Summary: &lt;input type="text" style="width: 40em" name="summary"&gt; &lt;button type="submit"&gt; &lt;/button&gt; &lt;/form&gt;</code> <br> <br>     ‚Äúsubmit‚Äù  ,      HTTP-,    . <br> <br>    ,    display   none,       . ,   ? <br> <br> <code class="html">&lt;div id="template" style="display: none"&gt; &lt;div class="talk"&gt; &lt;h2&gt;{{title}}&lt;/h2&gt; &lt;div&gt;by &lt;span class="name"&gt;{{presenter}}&lt;/span&gt;&lt;/div&gt; &lt;p&gt;{{summary}}&lt;/p&gt; &lt;div class="comments"&gt;&lt;/div&gt; &lt;form&gt; &lt;input type="text" name="comment"&gt; &lt;button type="submit"&gt; &lt;/button&gt; &lt;button type="button" class="del"&gt; &lt;/button&gt; &lt;/form&gt; &lt;/div&gt; &lt;div class="comment"&gt; &lt;span class="name"&gt;{{author}}&lt;/span&gt;: {{message}} &lt;/div&gt; &lt;/div&gt;</code> <br> <br>    DOM  JavaScript    .          elt   13,       ,  HTML,   -      DOM-. <br> <br>   DOM-   ,      ,    ,   ,     ‚Äì             . <br> <br>  , HTML   ,   . <br> <br> <code class="html">&lt;script src="skillsharing_client.js"&gt;&lt;/script&gt;</code> <br> <br>  <br> ,       ,       .       HTTP-,      XMLHttpRequest,            . <br> <br> <code class="javascript">function request(options, callback) { var req = new XMLHttpRequest(); req.open(options.method || "GET", options.pathname, true); req.addEventListener("load", function() { if (req.status &lt; 400) callback(null, req.responseText); else callback(new Error("Request failed: " + req.statusText)); }); req.addEventListener("error", function() { callback(new Error("Network error")); }); req.send(options.body || null); }</code> <br> <br>            ,  waitForChanges. <br> <br> <code class="javascript">var lastServerTime = 0; request({pathname: "talks"}, function(error, response) { if (error) { reportError(error); } else { response = JSON.parse(response); displayTalks(response.talks); lastServerTime = response.serverTime; waitForChanges(); } });</code> <br> <br>  lastServerTime      ,   .   ,        ,       .  ,  serverTime,   ,     lastServerTime. <br> <br>    ,   ,        .       reportError,      ,   . <br> <br> <code class="javascript">function reportError(error) { if (error) alert(error.toString()); }</code> <br> <br>  ,   ,       .  ,           ,     .      ,      . <br> <br>   <br>         ,    ,    . ,     ,     ,        .  ,      ,   DOM    . <br> <br>  displayTalks      ,       .     shownTalks,      DOM,   ,     . <br> <br> <code class="javascript">var talkDiv = document.querySelector("#talks"); var shownTalks = Object.create(null); function displayTalks(talks) { talks.forEach(function(talk) { var shown = shownTalks[talk.title]; if (talk.deleted) { if (shown) { talkDiv.removeChild(shown); delete shownTalks[talk.title]; } } else { var node = drawTalk(talk); if (shown) talkDiv.replaceChild(node, shown); else talkDiv.appendChild(node); shownTalks[talk.title] = node; } }); }</code> <br> <br>  DOM     ,   HTML .    instantiateTemplate,     . <br> <br>  name ‚Äì  .    ,   ,        ,       ID ‚Äútemplate‚Äù.  querySelector   .     ‚Äútalk‚Äù  ‚Äúcomment‚Äù. <br> <br> <code class="javascript">function instantiateTemplate(name, values) { function instantiateText(text) { return text.replace(/\{\{(\w+)\}\}/g, function(_, name) { return values[name]; }); } function instantiate(node) { if (node.nodeType == document.ELEMENT_NODE) { var copy = node.cloneNode(); for (var i = 0; i &lt; node.childNodes.length; i++) copy.appendChild(instantiate(node.childNodes[i])); return copy; } else if (node.nodeType == document.TEXT_NODE) { return document.createTextNode( instantiateText(node.nodeValue)); } } var template = document.querySelector("#template ." + name); return instantiate(template); }</code> <br> <br>  cloneNode,      DOM,   .     ,       true.  instantiate    ,     . <br> <br>   instantiateTemplate   ,    ,     .   {{title}}     ‚Äútitle‚Äù. <br> <br>      ,    drawTalk   . <br> <br> <code class="javascript">function drawTalk(talk) { var node = instantiateTemplate("talk", talk); var comments = node.querySelector(".comments"); talk.comments.forEach(function(comment) { comments.appendChild( instantiateTemplate("comment", comment)); }); node.querySelector("button.del").addEventListener( "click", deleteTalk.bind(null, talk.title)); var form = node.querySelector("form"); form.addEventListener("submit", function(event) { event.preventDefault(); addComment(talk.title, form.elements.comment.value); form.reset(); }); return node; }</code> <br> <br>     ‚Äútalk‚Äù    . -,   ,     ‚Äúcomment‚Äù       "comments". ,      ,      ,  . <br> <br>   <br>  ,   drawTalk,   deleteTalk  addComment   ,       .      URL,       ,       talkURL. <br> <br> <code class="javascript">function talkURL(title) { return "talks/" + encodeURIComponent(title); }</code> <br> <br>  deleteTalk   DELETE       . <br> <br> <code class="javascript">function deleteTalk(title) { request({pathname: talkURL(title), method: "DELETE"}, reportError); }</code> <br> <br>          JSON      POST-. <br> <br> <code class="javascript">function addComment(title, comment) { var comment = {author: nameField.value, message: comment}; request({pathname: talkURL(title) + "/comments", body: JSON.stringify(comment), method: "POST"}, reportError); }</code> <br> <br>  nameField,      author,    <code class="javascript">  ,      .       localStorage,          . <br> <br> var nameField = document.querySelector("#name"); nameField.value = localStorage.getItem("name") || ""; nameField.addEventListener("change", function() { localStorage.setItem("name", nameField.value); });           ‚Äúsubmit‚Äù.       (     ),     PUT-   . var talkForm = document.querySelector("#newtalk"); talkForm.addEventListener("submit", function(event) { event.preventDefault(); request({pathname: talkURL(talkForm.elements.title.value), method: "PUT", body: JSON.stringify({ presenter: nameField.value, summary: talkForm.elements.summary.value })}, reportError); talkForm.reset(); });</code> <br> <br>   <br>  ,   ,   ,    ,     ,     ,       .    -       ,     . <br> <br>       ,    displayTalks    ,     ,       . <br> <br> <code class="javascript">function waitForChanges() { request({pathname: "talks?changesSince=" + lastServerTime}, function(error, response) { if (error) { setTimeout(waitForChanges, 2500); console.error(error.stack); } else { response = JSON.parse(response); displayTalks(response.talks); lastServerTime = response.serverTime; waitForChanges(); } }); }</code> <br> <br>    ,   ,     ,  ,    .    ,    reportError,             .       (  ),      2.5 . <br> <br>   ,     ,  lastServerTime ,    ,           .    ,    . <br> <br>    ,        localhost:8000,  ,  ,     ,    . <br> <br>  <br>      ,    .    , ,   <a href=""> </a>   <a href="http://nodejs.org/">Node.js</a> . <br> <br>     <br>      .     ,      . <br> <br>     ,            .    ,    . <br> <br>    <br>      ,       DOM   ,   .   .     -         ,          ,      ,      ,  . <br> <br>   ,        ,    .    ,   ? <br> <br>   <br>    ,     .         ,   if,    ,  . <br> <br>           ,   ("comment")     .      ‚Äútalk‚Äù,     ,    comments,    ,   ,    . <br> <br>     : <br> <br> <code class="html">&lt;div class="comments"&gt; &lt;div class="comment" template-repeat="comments"&gt; &lt;span class="name"&gt;{{author}}&lt;/span&gt;: {{message}} &lt;/div&gt; &lt;/div&gt;</code> <br> <br>   :       template-repeat,  ,     ,   ,   ,   .   ( values  instantiateTemplate)          ,   {{author}}     comment,    . <br> <br>  instantiateTemplate ,    ,    ,     ,          drawTalk. <br> <br>       ,      ,     true  false? <br> <br>    ? <br>  -       JavaScript,     .   - . <br> <br>   -     JavaScript.       ,      .         . <br> <br>   ,   -          JavaScript.     ,       .       ,     . <br> <br>     .    .          ,  ,    ?</code></code> <pre> <code class="hljs lua"><code class="html">  ID ‚Äútalks‚Äù    .   ,      . <br> <br>       . <br> <br> &lt;form id=<span class="hljs-string"><span class="hljs-string">"newtalk"</span></span>&gt; &lt;h3&gt;Submit a talk&lt;/h3&gt; : &lt;<span class="hljs-built_in"><span class="hljs-built_in">input</span></span> <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=<span class="hljs-string"><span class="hljs-string">"text"</span></span> style=<span class="hljs-string"><span class="hljs-string">"width: 40em"</span></span> name=<span class="hljs-string"><span class="hljs-string">"title"</span></span>&gt; &lt;br&gt; Summary: &lt;<span class="hljs-built_in"><span class="hljs-built_in">input</span></span> <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=<span class="hljs-string"><span class="hljs-string">"text"</span></span> style=<span class="hljs-string"><span class="hljs-string">"width: 40em"</span></span> name=<span class="hljs-string"><span class="hljs-string">"summary"</span></span>&gt; &lt;button <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=<span class="hljs-string"><span class="hljs-string">"submit"</span></span>&gt; &lt;/button&gt; &lt;/form&gt;</code> <br> <br>     ‚Äúsubmit‚Äù  ,      HTTP-,    . <br> <br>    ,    display   none,       . ,   ? <br> <br> <code class="html">&lt;div id=<span class="hljs-string"><span class="hljs-string">"template"</span></span> style=<span class="hljs-string"><span class="hljs-string">"display: none"</span></span>&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"talk"</span></span>&gt; &lt;h2&gt;{{title}}&lt;/h2&gt; &lt;div&gt;by &lt;span class=<span class="hljs-string"><span class="hljs-string">"name"</span></span>&gt;{{presenter}}&lt;/span&gt;&lt;/div&gt; &lt;p&gt;{{summary}}&lt;/p&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"comments"</span></span>&gt;&lt;/div&gt; &lt;form&gt; &lt;<span class="hljs-built_in"><span class="hljs-built_in">input</span></span> <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=<span class="hljs-string"><span class="hljs-string">"text"</span></span> name=<span class="hljs-string"><span class="hljs-string">"comment"</span></span>&gt; &lt;button <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=<span class="hljs-string"><span class="hljs-string">"submit"</span></span>&gt; &lt;/button&gt; &lt;button <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=<span class="hljs-string"><span class="hljs-string">"button"</span></span> class=<span class="hljs-string"><span class="hljs-string">"del"</span></span>&gt; &lt;/button&gt; &lt;/form&gt; &lt;/div&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"comment"</span></span>&gt; &lt;span class=<span class="hljs-string"><span class="hljs-string">"name"</span></span>&gt;{{author}}&lt;/span&gt;: {{message}} &lt;/div&gt; &lt;/div&gt;</code> <br> <br>    DOM  JavaScript    .          elt   <span class="hljs-number"><span class="hljs-number">13</span></span>,       ,  HTML,   -      DOM-. <br> <br>   DOM-   ,      ,    ,   ,     ‚Äì             . <br> <br>  , HTML   ,   . <br> <br> <code class="html">&lt;script src=<span class="hljs-string"><span class="hljs-string">"skillsharing_client.js"</span></span>&gt;&lt;/script&gt;</code> <br> <br>  <br> ,       ,       .       HTTP-,      XMLHttpRequest,            . <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">request</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(options, callback)</span></span></span></span> { var req = new XMLHttpRequest(); req.<span class="hljs-built_in"><span class="hljs-built_in">open</span></span>(options.method || <span class="hljs-string"><span class="hljs-string">"GET"</span></span>, options.pathname, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); req.addEventListener(<span class="hljs-string"><span class="hljs-string">"load"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (req.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> &lt; <span class="hljs-number"><span class="hljs-number">400</span></span>) callback(null, req.responseText); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> callback(new Error(<span class="hljs-string"><span class="hljs-string">"Request failed: "</span></span> + req.statusText)); }); req.addEventListener(<span class="hljs-string"><span class="hljs-string">"error"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { callback(new Error(<span class="hljs-string"><span class="hljs-string">"Network error"</span></span>)); }); req.send(options.body || null); }</code> <br> <br>            ,  waitForChanges. <br> <br> <code class="javascript">var lastServerTime = <span class="hljs-number"><span class="hljs-number">0</span></span>; request({pathname: <span class="hljs-string"><span class="hljs-string">"talks"</span></span>}, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(error, response)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>) { reportError(<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { response = JSON.parse(response); displayTalks(response.talks); lastServerTime = response.serverTime; waitForChanges(); } });</code> <br> <br>  lastServerTime      ,   .   ,        ,       .  ,  serverTime,   ,     lastServerTime. <br> <br>    ,   ,        .       reportError,      ,   . <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">reportError</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(error)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>) alert(<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>.toString()); }</code> <br> <br>  ,   ,       .  ,           ,     .      ,      . <br> <br>   <br>         ,    ,    . ,     ,     ,        .  ,      ,   DOM    . <br> <br>  displayTalks      ,       .     shownTalks,      DOM,   ,     . <br> <br> <code class="javascript">var talkDiv = document.querySelector(<span class="hljs-string"><span class="hljs-string">"#talks"</span></span>); var shownTalks = Object.<span class="hljs-built_in"><span class="hljs-built_in">create</span></span>(null); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">displayTalks</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(talks)</span></span></span></span> { talks.forEach(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(talk)</span></span></span></span> { var shown = shownTalks[talk.title]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (talk.deleted) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (shown) { talkDiv.removeChild(shown); delete shownTalks[talk.title]; } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { var node = drawTalk(talk); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (shown) talkDiv.replaceChild(node, shown); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> talkDiv.appendChild(node); shownTalks[talk.title] = node; } }); }</code> <br> <br>  DOM     ,   HTML .    instantiateTemplate,     . <br> <br>  name ‚Äì  .    ,   ,        ,       ID ‚Äútemplate‚Äù.  querySelector   .     ‚Äútalk‚Äù  ‚Äúcomment‚Äù. <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">instantiateTemplate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(name, values)</span></span></span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">instantiateText</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(text)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> text.replace(/\{\{(\w+)\}\}/g, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(_, name)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> values[name]; }); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">instantiate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(node)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (node.nodeType == document.ELEMENT_NODE) { var copy = node.cloneNode(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (var i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; node.childNodes.length; i++) copy.appendChild(instantiate(node.childNodes[i])); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> copy; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (node.nodeType == document.TEXT_NODE) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> document.createTextNode( instantiateText(node.nodeValue)); } } var template = document.querySelector(<span class="hljs-string"><span class="hljs-string">"#template ."</span></span> + name); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> instantiate(template); }</code> <br> <br>  cloneNode,      DOM,   .     ,       <span class="hljs-literal"><span class="hljs-literal">true</span></span>.  instantiate    ,     . <br> <br>   instantiateTemplate   ,    ,     .   {{title}}     ‚Äútitle‚Äù. <br> <br>      ,    drawTalk   . <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">drawTalk</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(talk)</span></span></span></span> { var node = instantiateTemplate(<span class="hljs-string"><span class="hljs-string">"talk"</span></span>, talk); var comments = node.querySelector(<span class="hljs-string"><span class="hljs-string">".comments"</span></span>); talk.comments.forEach(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(comment)</span></span></span></span> { comments.appendChild( instantiateTemplate(<span class="hljs-string"><span class="hljs-string">"comment"</span></span>, comment)); }); node.querySelector(<span class="hljs-string"><span class="hljs-string">"button.del"</span></span>).addEventListener( <span class="hljs-string"><span class="hljs-string">"click"</span></span>, deleteTalk.bind(null, talk.title)); var form = node.querySelector(<span class="hljs-string"><span class="hljs-string">"form"</span></span>); form.addEventListener(<span class="hljs-string"><span class="hljs-string">"submit"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(event)</span></span></span></span> { event.preventDefault(); addComment(talk.title, form.elements.comment.value); form.reset(); }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> node; }</code> <br> <br>     ‚Äútalk‚Äù    . -,   ,     ‚Äúcomment‚Äù       <span class="hljs-string"><span class="hljs-string">"comments"</span></span>. ,      ,      ,  . <br> <br>   <br>  ,   drawTalk,   deleteTalk  addComment   ,       .      URL,       ,       talkURL. <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">talkURL</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(title)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"talks/"</span></span> + encodeURIComponent(title); }</code> <br> <br>  deleteTalk   DELETE       . <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">deleteTalk</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(title)</span></span></span></span> { request({pathname: talkURL(title), method: <span class="hljs-string"><span class="hljs-string">"DELETE"</span></span>}, reportError); }</code> <br> <br>          JSON      POST-. <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">addComment</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(title, comment)</span></span></span></span> { var comment = {author: nameField.value, message: comment}; request({pathname: talkURL(title) + <span class="hljs-string"><span class="hljs-string">"/comments"</span></span>, body: JSON.stringify(comment), method: <span class="hljs-string"><span class="hljs-string">"POST"</span></span>}, reportError); }</code> <br> <br>  nameField,      author,    <code><code class="javascript">  ,      .       localStorage,          . <br> <br> var nameField = document.querySelector(<span class="hljs-string"><span class="hljs-string">"#name"</span></span>); nameField.value = localStorage.getItem(<span class="hljs-string"><span class="hljs-string">"name"</span></span>) || <span class="hljs-string"><span class="hljs-string">""</span></span>; nameField.addEventListener(<span class="hljs-string"><span class="hljs-string">"change"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { localStorage.setItem(<span class="hljs-string"><span class="hljs-string">"name"</span></span>, nameField.value); });           ‚Äúsubmit‚Äù.       (     ),     PUT-   . var talkForm = document.querySelector(<span class="hljs-string"><span class="hljs-string">"#newtalk"</span></span>); talkForm.addEventListener(<span class="hljs-string"><span class="hljs-string">"submit"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(event)</span></span></span></span> { event.preventDefault(); request({pathname: talkURL(talkForm.elements.title.value), method: <span class="hljs-string"><span class="hljs-string">"PUT"</span></span>, body: JSON.stringify({ presenter: nameField.value, summary: talkForm.elements.summary.value })}, reportError); talkForm.reset(); });</code> <br> <br>   <br>  ,   ,   ,    ,     ,     ,       .    -       ,     . <br> <br>       ,    displayTalks    ,     ,       . <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">waitForChanges</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { request({pathname: <span class="hljs-string"><span class="hljs-string">"talks?changesSince="</span></span> + lastServerTime}, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(error, response)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>) { setTimeout(waitForChanges, <span class="hljs-number"><span class="hljs-number">2500</span></span>); console.<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>.stack); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { response = JSON.parse(response); displayTalks(response.talks); lastServerTime = response.serverTime; waitForChanges(); } }); }</code> <br> <br>    ,   ,     ,  ,    .    ,    reportError,             .       (  ),      <span class="hljs-number"><span class="hljs-number">2.5</span></span> . <br> <br>   ,     ,  lastServerTime ,    ,           .    ,    . <br> <br>    ,        localhost:<span class="hljs-number"><span class="hljs-number">8000</span></span>,  ,  ,     ,    . <br> <br>  <br>      ,    .    , ,   <a href=""> </a>   <a href="http://nodejs.org/">Node.js</a> . <br> <br>     <br>      .     ,      . <br> <br>     ,            .    ,    . <br> <br>    <br>      ,       DOM   ,   .   .     -         ,          ,      ,      ,  . <br> <br>   ,        ,    .    ,   ? <br> <br>   <br>    ,     .         ,   <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>,    ,  . <br> <br>           ,   (<span class="hljs-string"><span class="hljs-string">"comment"</span></span>)     .      ‚Äútalk‚Äù,     ,    comments,    ,   ,    . <br> <br>     : <br> <br> <code class="html">&lt;div class=<span class="hljs-string"><span class="hljs-string">"comments"</span></span>&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"comment"</span></span> template-<span class="hljs-keyword"><span class="hljs-keyword">repeat</span></span>=<span class="hljs-string"><span class="hljs-string">"comments"</span></span>&gt; &lt;span class=<span class="hljs-string"><span class="hljs-string">"name"</span></span>&gt;{{author}}&lt;/span&gt;: {{message}} &lt;/div&gt; &lt;/div&gt;</code> <br> <br>   :       template-<span class="hljs-keyword"><span class="hljs-keyword">repeat</span></span>,  ,     ,   ,   ,   .   ( values  instantiateTemplate)          ,   {{author}}     comment,    . <br> <br>  instantiateTemplate ,    ,    ,     ,          drawTalk. <br> <br>       ,      ,     <span class="hljs-literal"><span class="hljs-literal">true</span></span>  <span class="hljs-literal"><span class="hljs-literal">false</span></span>? <br> <br>    ? <br>  -       JavaScript,     .   - . <br> <br>   -     JavaScript.       ,      .         . <br> <br>   ,   -          JavaScript.     ,       .       ,     . <br> <br>     .    .          ,  ,    ?</code></code> </pre> <code><code><code class="html">  ID ‚Äútalks‚Äù    .   ,      . <br> <br>       . <br> <br> &lt;form id="newtalk"&gt; &lt;h3&gt;Submit a talk&lt;/h3&gt; : &lt;input type="text" style="width: 40em" name="title"&gt; &lt;br&gt; Summary: &lt;input type="text" style="width: 40em" name="summary"&gt; &lt;button type="submit"&gt; &lt;/button&gt; &lt;/form&gt;</code> <br> <br>     ‚Äúsubmit‚Äù  ,      HTTP-,    . <br> <br>    ,    display   none,       . ,   ? <br> <br> <code class="html">&lt;div id="template" style="display: none"&gt; &lt;div class="talk"&gt; &lt;h2&gt;{{title}}&lt;/h2&gt; &lt;div&gt;by &lt;span class="name"&gt;{{presenter}}&lt;/span&gt;&lt;/div&gt; &lt;p&gt;{{summary}}&lt;/p&gt; &lt;div class="comments"&gt;&lt;/div&gt; &lt;form&gt; &lt;input type="text" name="comment"&gt; &lt;button type="submit"&gt; &lt;/button&gt; &lt;button type="button" class="del"&gt; &lt;/button&gt; &lt;/form&gt; &lt;/div&gt; &lt;div class="comment"&gt; &lt;span class="name"&gt;{{author}}&lt;/span&gt;: {{message}} &lt;/div&gt; &lt;/div&gt;</code> <br> <br>    DOM  JavaScript    .          elt   13,       ,  HTML,   -      DOM-. <br> <br>   DOM-   ,      ,    ,   ,     ‚Äì             . <br> <br>  , HTML   ,   . <br> <br> <code class="html">&lt;script src="skillsharing_client.js"&gt;&lt;/script&gt;</code> <br> <br>  <br> ,       ,       .       HTTP-,      XMLHttpRequest,            . <br> <br> <code class="javascript">function request(options, callback) { var req = new XMLHttpRequest(); req.open(options.method || "GET", options.pathname, true); req.addEventListener("load", function() { if (req.status &lt; 400) callback(null, req.responseText); else callback(new Error("Request failed: " + req.statusText)); }); req.addEventListener("error", function() { callback(new Error("Network error")); }); req.send(options.body || null); }</code> <br> <br>            ,  waitForChanges. <br> <br> <code class="javascript">var lastServerTime = 0; request({pathname: "talks"}, function(error, response) { if (error) { reportError(error); } else { response = JSON.parse(response); displayTalks(response.talks); lastServerTime = response.serverTime; waitForChanges(); } });</code> <br> <br>  lastServerTime      ,   .   ,        ,       .  ,  serverTime,   ,     lastServerTime. <br> <br>    ,   ,        .       reportError,      ,   . <br> <br> <code class="javascript">function reportError(error) { if (error) alert(error.toString()); }</code> <br> <br>  ,   ,       .  ,           ,     .      ,      . <br> <br>   <br>         ,    ,    . ,     ,     ,        .  ,      ,   DOM    . <br> <br>  displayTalks      ,       .     shownTalks,      DOM,   ,     . <br> <br> <code class="javascript">var talkDiv = document.querySelector("#talks"); var shownTalks = Object.create(null); function displayTalks(talks) { talks.forEach(function(talk) { var shown = shownTalks[talk.title]; if (talk.deleted) { if (shown) { talkDiv.removeChild(shown); delete shownTalks[talk.title]; } } else { var node = drawTalk(talk); if (shown) talkDiv.replaceChild(node, shown); else talkDiv.appendChild(node); shownTalks[talk.title] = node; } }); }</code> <br> <br>  DOM     ,   HTML .    instantiateTemplate,     . <br> <br>  name ‚Äì  .    ,   ,        ,       ID ‚Äútemplate‚Äù.  querySelector   .     ‚Äútalk‚Äù  ‚Äúcomment‚Äù. <br> <br> <code class="javascript">function instantiateTemplate(name, values) { function instantiateText(text) { return text.replace(/\{\{(\w+)\}\}/g, function(_, name) { return values[name]; }); } function instantiate(node) { if (node.nodeType == document.ELEMENT_NODE) { var copy = node.cloneNode(); for (var i = 0; i &lt; node.childNodes.length; i++) copy.appendChild(instantiate(node.childNodes[i])); return copy; } else if (node.nodeType == document.TEXT_NODE) { return document.createTextNode( instantiateText(node.nodeValue)); } } var template = document.querySelector("#template ." + name); return instantiate(template); }</code> <br> <br>  cloneNode,      DOM,   .     ,       true.  instantiate    ,     . <br> <br>   instantiateTemplate   ,    ,     .   {{title}}     ‚Äútitle‚Äù. <br> <br>      ,    drawTalk   . <br> <br> <code class="javascript">function drawTalk(talk) { var node = instantiateTemplate("talk", talk); var comments = node.querySelector(".comments"); talk.comments.forEach(function(comment) { comments.appendChild( instantiateTemplate("comment", comment)); }); node.querySelector("button.del").addEventListener( "click", deleteTalk.bind(null, talk.title)); var form = node.querySelector("form"); form.addEventListener("submit", function(event) { event.preventDefault(); addComment(talk.title, form.elements.comment.value); form.reset(); }); return node; }</code> <br> <br>     ‚Äútalk‚Äù    . -,   ,     ‚Äúcomment‚Äù       "comments". ,      ,      ,  . <br> <br>   <br>  ,   drawTalk,   deleteTalk  addComment   ,       .      URL,       ,       talkURL. <br> <br> <code class="javascript">function talkURL(title) { return "talks/" + encodeURIComponent(title); }</code> <br> <br>  deleteTalk   DELETE       . <br> <br> <code class="javascript">function deleteTalk(title) { request({pathname: talkURL(title), method: "DELETE"}, reportError); }</code> <br> <br>          JSON      POST-. <br> <br> <code class="javascript">function addComment(title, comment) { var comment = {author: nameField.value, message: comment}; request({pathname: talkURL(title) + "/comments", body: JSON.stringify(comment), method: "POST"}, reportError); }</code> <br> <br>  nameField,      author,    <code class="javascript">  ,      .       localStorage,          . <br> <br> var nameField = document.querySelector("#name"); nameField.value = localStorage.getItem("name") || ""; nameField.addEventListener("change", function() { localStorage.setItem("name", nameField.value); });           ‚Äúsubmit‚Äù.       (     ),     PUT-   . var talkForm = document.querySelector("#newtalk"); talkForm.addEventListener("submit", function(event) { event.preventDefault(); request({pathname: talkURL(talkForm.elements.title.value), method: "PUT", body: JSON.stringify({ presenter: nameField.value, summary: talkForm.elements.summary.value })}, reportError); talkForm.reset(); });</code> <br> <br>   <br>  ,   ,   ,    ,     ,     ,       .    -       ,     . <br> <br>       ,    displayTalks    ,     ,       . <br> <br> <code class="javascript">function waitForChanges() { request({pathname: "talks?changesSince=" + lastServerTime}, function(error, response) { if (error) { setTimeout(waitForChanges, 2500); console.error(error.stack); } else { response = JSON.parse(response); displayTalks(response.talks); lastServerTime = response.serverTime; waitForChanges(); } }); }</code> <br> <br>    ,   ,     ,  ,    .    ,    reportError,             .       (  ),      2.5 . <br> <br>   ,     ,  lastServerTime ,    ,           .    ,    . <br> <br>    ,        localhost:8000,  ,  ,     ,    . <br> <br>  <br>      ,    .    , ,   <a href=""> </a>   <a href="http://nodejs.org/">Node.js</a> . <br> <br>     <br>      .     ,      . <br> <br>     ,            .    ,    . <br> <br>    <br>      ,       DOM   ,   .   .     -         ,          ,      ,      ,  . <br> <br>   ,        ,    .    ,   ? <br> <br>   <br>    ,     .         ,   if,    ,  . <br> <br>           ,   ("comment")     .      ‚Äútalk‚Äù,     ,    comments,    ,   ,    . <br> <br>     : <br> <br> <code class="html">&lt;div class="comments"&gt; &lt;div class="comment" template-repeat="comments"&gt; &lt;span class="name"&gt;{{author}}&lt;/span&gt;: {{message}} &lt;/div&gt; &lt;/div&gt;</code> <br> <br>   :       template-repeat,  ,     ,   ,   ,   .   ( values  instantiateTemplate)          ,   {{author}}     comment,    . <br> <br>  instantiateTemplate ,    ,    ,     ,          drawTalk. <br> <br>       ,      ,     true  false? <br> <br>    ? <br>  -       JavaScript,     .   - . <br> <br>   -     JavaScript.       ,      .         . <br> <br>   ,   -          JavaScript.     ,       .       ,     . <br> <br>     .    .          ,  ,    ?</code></code> <h4> <code><code><code class="html">  ID ‚Äútalks‚Äù    .   ,      . <br> <br>       . <br> <br> &lt;form id="newtalk"&gt; &lt;h3&gt;Submit a talk&lt;/h3&gt; : &lt;input type="text" style="width: 40em" name="title"&gt; &lt;br&gt; Summary: &lt;input type="text" style="width: 40em" name="summary"&gt; &lt;button type="submit"&gt; &lt;/button&gt; &lt;/form&gt;</code> <br> <br>     ‚Äúsubmit‚Äù  ,      HTTP-,    . <br> <br>    ,    display   none,       . ,   ? <br> <br> <code class="html">&lt;div id="template" style="display: none"&gt; &lt;div class="talk"&gt; &lt;h2&gt;{{title}}&lt;/h2&gt; &lt;div&gt;by &lt;span class="name"&gt;{{presenter}}&lt;/span&gt;&lt;/div&gt; &lt;p&gt;{{summary}}&lt;/p&gt; &lt;div class="comments"&gt;&lt;/div&gt; &lt;form&gt; &lt;input type="text" name="comment"&gt; &lt;button type="submit"&gt; &lt;/button&gt; &lt;button type="button" class="del"&gt; &lt;/button&gt; &lt;/form&gt; &lt;/div&gt; &lt;div class="comment"&gt; &lt;span class="name"&gt;{{author}}&lt;/span&gt;: {{message}} &lt;/div&gt; &lt;/div&gt;</code> <br> <br>    DOM  JavaScript    .          elt   13,       ,  HTML,   -      DOM-. <br> <br>   DOM-   ,      ,    ,   ,     ‚Äì             . <br> <br>  , HTML   ,   . <br> <br> <code class="html">&lt;script src="skillsharing_client.js"&gt;&lt;/script&gt;</code> <br> <br>  <br> ,       ,       .       HTTP-,      XMLHttpRequest,            . <br> <br> <code class="javascript">function request(options, callback) { var req = new XMLHttpRequest(); req.open(options.method || "GET", options.pathname, true); req.addEventListener("load", function() { if (req.status &lt; 400) callback(null, req.responseText); else callback(new Error("Request failed: " + req.statusText)); }); req.addEventListener("error", function() { callback(new Error("Network error")); }); req.send(options.body || null); }</code> <br> <br>            ,  waitForChanges. <br> <br> <code class="javascript">var lastServerTime = 0; request({pathname: "talks"}, function(error, response) { if (error) { reportError(error); } else { response = JSON.parse(response); displayTalks(response.talks); lastServerTime = response.serverTime; waitForChanges(); } });</code> <br> <br>  lastServerTime      ,   .   ,        ,       .  ,  serverTime,   ,     lastServerTime. <br> <br>    ,   ,        .       reportError,      ,   . <br> <br> <code class="javascript">function reportError(error) { if (error) alert(error.toString()); }</code> <br> <br>  ,   ,       .  ,           ,     .      ,      . <br> <br>   <br>         ,    ,    . ,     ,     ,        .  ,      ,   DOM    . <br> <br>  displayTalks      ,       .     shownTalks,      DOM,   ,     . <br> <br> <code class="javascript">var talkDiv = document.querySelector("#talks"); var shownTalks = Object.create(null); function displayTalks(talks) { talks.forEach(function(talk) { var shown = shownTalks[talk.title]; if (talk.deleted) { if (shown) { talkDiv.removeChild(shown); delete shownTalks[talk.title]; } } else { var node = drawTalk(talk); if (shown) talkDiv.replaceChild(node, shown); else talkDiv.appendChild(node); shownTalks[talk.title] = node; } }); }</code> <br> <br>  DOM     ,   HTML .    instantiateTemplate,     . <br> <br>  name ‚Äì  .    ,   ,        ,       ID ‚Äútemplate‚Äù.  querySelector   .     ‚Äútalk‚Äù  ‚Äúcomment‚Äù. <br> <br> <code class="javascript">function instantiateTemplate(name, values) { function instantiateText(text) { return text.replace(/\{\{(\w+)\}\}/g, function(_, name) { return values[name]; }); } function instantiate(node) { if (node.nodeType == document.ELEMENT_NODE) { var copy = node.cloneNode(); for (var i = 0; i &lt; node.childNodes.length; i++) copy.appendChild(instantiate(node.childNodes[i])); return copy; } else if (node.nodeType == document.TEXT_NODE) { return document.createTextNode( instantiateText(node.nodeValue)); } } var template = document.querySelector("#template ." + name); return instantiate(template); }</code> <br> <br>  cloneNode,      DOM,   .     ,       true.  instantiate    ,     . <br> <br>   instantiateTemplate   ,    ,     .   {{title}}     ‚Äútitle‚Äù. <br> <br>      ,    drawTalk   . <br> <br> <code class="javascript">function drawTalk(talk) { var node = instantiateTemplate("talk", talk); var comments = node.querySelector(".comments"); talk.comments.forEach(function(comment) { comments.appendChild( instantiateTemplate("comment", comment)); }); node.querySelector("button.del").addEventListener( "click", deleteTalk.bind(null, talk.title)); var form = node.querySelector("form"); form.addEventListener("submit", function(event) { event.preventDefault(); addComment(talk.title, form.elements.comment.value); form.reset(); }); return node; }</code> <br> <br>     ‚Äútalk‚Äù    . -,   ,     ‚Äúcomment‚Äù       "comments". ,      ,      ,  . <br> <br>   <br>  ,   drawTalk,   deleteTalk  addComment   ,       .      URL,       ,       talkURL. <br> <br> <code class="javascript">function talkURL(title) { return "talks/" + encodeURIComponent(title); }</code> <br> <br>  deleteTalk   DELETE       . <br> <br> <code class="javascript">function deleteTalk(title) { request({pathname: talkURL(title), method: "DELETE"}, reportError); }</code> <br> <br>          JSON      POST-. <br> <br> <code class="javascript">function addComment(title, comment) { var comment = {author: nameField.value, message: comment}; request({pathname: talkURL(title) + "/comments", body: JSON.stringify(comment), method: "POST"}, reportError); }</code> <br> <br>  nameField,      author,    <code class="javascript">  ,      .       localStorage,          . <br> <br> var nameField = document.querySelector("#name"); nameField.value = localStorage.getItem("name") || ""; nameField.addEventListener("change", function() { localStorage.setItem("name", nameField.value); });           ‚Äúsubmit‚Äù.       (     ),     PUT-   . var talkForm = document.querySelector("#newtalk"); talkForm.addEventListener("submit", function(event) { event.preventDefault(); request({pathname: talkURL(talkForm.elements.title.value), method: "PUT", body: JSON.stringify({ presenter: nameField.value, summary: talkForm.elements.summary.value })}, reportError); talkForm.reset(); });</code> <br> <br>   <br>  ,   ,   ,    ,     ,     ,       .    -       ,     . <br> <br>       ,    displayTalks    ,     ,       . <br> <br> <code class="javascript">function waitForChanges() { request({pathname: "talks?changesSince=" + lastServerTime}, function(error, response) { if (error) { setTimeout(waitForChanges, 2500); console.error(error.stack); } else { response = JSON.parse(response); displayTalks(response.talks); lastServerTime = response.serverTime; waitForChanges(); } }); }</code> <br> <br>    ,   ,     ,  ,    .    ,    reportError,             .       (  ),      2.5 . <br> <br>   ,     ,  lastServerTime ,    ,           .    ,    . <br> <br>    ,        localhost:8000,  ,  ,     ,    . <br> <br>  <br>      ,    .    , ,   <a href=""> </a>   <a href="http://nodejs.org/">Node.js</a> . <br> <br>     <br>      .     ,      . <br> <br>     ,            .    ,    . <br> <br>    <br>      ,       DOM   ,   .   .     -         ,          ,      ,      ,  . <br> <br>   ,        ,    .    ,   ? <br> <br>   <br>    ,     .         ,   if,    ,  . <br> <br>           ,   ("comment")     .      ‚Äútalk‚Äù,     ,    comments,    ,   ,    . <br> <br>     : <br> <br> <code class="html">&lt;div class="comments"&gt; &lt;div class="comment" template-repeat="comments"&gt; &lt;span class="name"&gt;{{author}}&lt;/span&gt;: {{message}} &lt;/div&gt; &lt;/div&gt;</code> <br> <br>   :       template-repeat,  ,     ,   ,   ,   .   ( values  instantiateTemplate)          ,   {{author}}     comment,    . <br> <br>  instantiateTemplate ,    ,    ,     ,          drawTalk. <br> <br>       ,      ,     true  false? <br> <br>    ? <br>  -       JavaScript,     .   - . <br> <br>   -     JavaScript.       ,      .         . <br> <br>   ,   -          JavaScript.     ,       .       ,     . <br> <br>     .    .          ,  ,    ?</code></code> </h4> <code><code><code class="html">  ID ‚Äútalks‚Äù    .   ,      . <br> <br>       . <br> <br> &lt;form id="newtalk"&gt; &lt;h3&gt;Submit a talk&lt;/h3&gt; : &lt;input type="text" style="width: 40em" name="title"&gt; &lt;br&gt; Summary: &lt;input type="text" style="width: 40em" name="summary"&gt; &lt;button type="submit"&gt; &lt;/button&gt; &lt;/form&gt;</code> <br> <br>     ‚Äúsubmit‚Äù  ,      HTTP-,    . <br> <br>    ,    display   none,       . ,   ? <br> <br> <code class="html">&lt;div id="template" style="display: none"&gt; &lt;div class="talk"&gt; &lt;h2&gt;{{title}}&lt;/h2&gt; &lt;div&gt;by &lt;span class="name"&gt;{{presenter}}&lt;/span&gt;&lt;/div&gt; &lt;p&gt;{{summary}}&lt;/p&gt; &lt;div class="comments"&gt;&lt;/div&gt; &lt;form&gt; &lt;input type="text" name="comment"&gt; &lt;button type="submit"&gt; &lt;/button&gt; &lt;button type="button" class="del"&gt; &lt;/button&gt; &lt;/form&gt; &lt;/div&gt; &lt;div class="comment"&gt; &lt;span class="name"&gt;{{author}}&lt;/span&gt;: {{message}} &lt;/div&gt; &lt;/div&gt;</code> <br> <br>    DOM  JavaScript    .          elt   13,       ,  HTML,   -      DOM-. <br> <br>   DOM-   ,      ,    ,   ,     ‚Äì             . <br> <br>  , HTML   ,   . <br> <br> <code class="html">&lt;script src="skillsharing_client.js"&gt;&lt;/script&gt;</code> <br> <br>  <br> ,       ,       .       HTTP-,      XMLHttpRequest,            . <br> <br> <code class="javascript">function request(options, callback) { var req = new XMLHttpRequest(); req.open(options.method || "GET", options.pathname, true); req.addEventListener("load", function() { if (req.status &lt; 400) callback(null, req.responseText); else callback(new Error("Request failed: " + req.statusText)); }); req.addEventListener("error", function() { callback(new Error("Network error")); }); req.send(options.body || null); }</code> <br> <br>            ,  waitForChanges. <br> <br> <code class="javascript">var lastServerTime = 0; request({pathname: "talks"}, function(error, response) { if (error) { reportError(error); } else { response = JSON.parse(response); displayTalks(response.talks); lastServerTime = response.serverTime; waitForChanges(); } });</code> <br> <br>  lastServerTime      ,   .   ,        ,       .  ,  serverTime,   ,     lastServerTime. <br> <br>    ,   ,        .       reportError,      ,   . <br> <br> <code class="javascript">function reportError(error) { if (error) alert(error.toString()); }</code> <br> <br>  ,   ,       .  ,           ,     .      ,      . <br> <br>   <br>         ,    ,    . ,     ,     ,        .  ,      ,   DOM    . <br> <br>  displayTalks      ,       .     shownTalks,      DOM,   ,     . <br> <br> <code class="javascript">var talkDiv = document.querySelector("#talks"); var shownTalks = Object.create(null); function displayTalks(talks) { talks.forEach(function(talk) { var shown = shownTalks[talk.title]; if (talk.deleted) { if (shown) { talkDiv.removeChild(shown); delete shownTalks[talk.title]; } } else { var node = drawTalk(talk); if (shown) talkDiv.replaceChild(node, shown); else talkDiv.appendChild(node); shownTalks[talk.title] = node; } }); }</code> <br> <br>  DOM     ,   HTML .    instantiateTemplate,     . <br> <br>  name ‚Äì  .    ,   ,        ,       ID ‚Äútemplate‚Äù.  querySelector   .     ‚Äútalk‚Äù  ‚Äúcomment‚Äù. <br> <br> <code class="javascript">function instantiateTemplate(name, values) { function instantiateText(text) { return text.replace(/\{\{(\w+)\}\}/g, function(_, name) { return values[name]; }); } function instantiate(node) { if (node.nodeType == document.ELEMENT_NODE) { var copy = node.cloneNode(); for (var i = 0; i &lt; node.childNodes.length; i++) copy.appendChild(instantiate(node.childNodes[i])); return copy; } else if (node.nodeType == document.TEXT_NODE) { return document.createTextNode( instantiateText(node.nodeValue)); } } var template = document.querySelector("#template ." + name); return instantiate(template); }</code> <br> <br>  cloneNode,      DOM,   .     ,       true.  instantiate    ,     . <br> <br>   instantiateTemplate   ,    ,     .   {{title}}     ‚Äútitle‚Äù. <br> <br>      ,    drawTalk   . <br> <br> <code class="javascript">function drawTalk(talk) { var node = instantiateTemplate("talk", talk); var comments = node.querySelector(".comments"); talk.comments.forEach(function(comment) { comments.appendChild( instantiateTemplate("comment", comment)); }); node.querySelector("button.del").addEventListener( "click", deleteTalk.bind(null, talk.title)); var form = node.querySelector("form"); form.addEventListener("submit", function(event) { event.preventDefault(); addComment(talk.title, form.elements.comment.value); form.reset(); }); return node; }</code> <br> <br>     ‚Äútalk‚Äù    . -,   ,     ‚Äúcomment‚Äù       "comments". ,      ,      ,  . <br> <br>   <br>  ,   drawTalk,   deleteTalk  addComment   ,       .      URL,       ,       talkURL. <br> <br> <code class="javascript">function talkURL(title) { return "talks/" + encodeURIComponent(title); }</code> <br> <br>  deleteTalk   DELETE       . <br> <br> <code class="javascript">function deleteTalk(title) { request({pathname: talkURL(title), method: "DELETE"}, reportError); }</code> <br> <br>          JSON      POST-. <br> <br> <code class="javascript">function addComment(title, comment) { var comment = {author: nameField.value, message: comment}; request({pathname: talkURL(title) + "/comments", body: JSON.stringify(comment), method: "POST"}, reportError); }</code> <br> <br>  nameField,      author,    <code class="javascript">  ,      .       localStorage,          . <br> <br> var nameField = document.querySelector("#name"); nameField.value = localStorage.getItem("name") || ""; nameField.addEventListener("change", function() { localStorage.setItem("name", nameField.value); });           ‚Äúsubmit‚Äù.       (     ),     PUT-   . var talkForm = document.querySelector("#newtalk"); talkForm.addEventListener("submit", function(event) { event.preventDefault(); request({pathname: talkURL(talkForm.elements.title.value), method: "PUT", body: JSON.stringify({ presenter: nameField.value, summary: talkForm.elements.summary.value })}, reportError); talkForm.reset(); });</code> <br> <br>   <br>  ,   ,   ,    ,     ,     ,       .    -       ,     . <br> <br>       ,    displayTalks    ,     ,       . <br> <br> <code class="javascript">function waitForChanges() { request({pathname: "talks?changesSince=" + lastServerTime}, function(error, response) { if (error) { setTimeout(waitForChanges, 2500); console.error(error.stack); } else { response = JSON.parse(response); displayTalks(response.talks); lastServerTime = response.serverTime; waitForChanges(); } }); }</code> <br> <br>    ,   ,     ,  ,    .    ,    reportError,             .       (  ),      2.5 . <br> <br>   ,     ,  lastServerTime ,    ,           .    ,    . <br> <br>    ,        localhost:8000,  ,  ,     ,    . <br> <br>  <br>      ,    .    , ,   <a href=""> </a>   <a href="http://nodejs.org/">Node.js</a> . <br> <br>     <br>      .     ,      . <br> <br>     ,            .    ,    . <br> <br>    <br>      ,       DOM   ,   .   .     -         ,          ,      ,      ,  . <br> <br>   ,        ,    .    ,   ? <br> <br>   <br>    ,     .         ,   if,    ,  . <br> <br>           ,   ("comment")     .      ‚Äútalk‚Äù,     ,    comments,    ,   ,    . <br> <br>     : <br> <br> <code class="html">&lt;div class="comments"&gt; &lt;div class="comment" template-repeat="comments"&gt; &lt;span class="name"&gt;{{author}}&lt;/span&gt;: {{message}} &lt;/div&gt; &lt;/div&gt;</code> <br> <br>   :       template-repeat,  ,     ,   ,   ,   .   ( values  instantiateTemplate)          ,   {{author}}     comment,    . <br> <br>  instantiateTemplate ,    ,    ,     ,          drawTalk. <br> <br>       ,      ,     true  false? <br> <br>    ? <br>  -       JavaScript,     .   - . <br> <br>   -     JavaScript.       ,      .         . <br> <br>   ,   -          JavaScript.     ,       .       ,     . <br> <br>     .    .          ,  ,    ?</code></code> <h5> <code><code><code class="html">  ID ‚Äútalks‚Äù    .   ,      . <br> <br>       . <br> <br> &lt;form id="newtalk"&gt; &lt;h3&gt;Submit a talk&lt;/h3&gt; : &lt;input type="text" style="width: 40em" name="title"&gt; &lt;br&gt; Summary: &lt;input type="text" style="width: 40em" name="summary"&gt; &lt;button type="submit"&gt; &lt;/button&gt; &lt;/form&gt;</code> <br> <br>     ‚Äúsubmit‚Äù  ,      HTTP-,    . <br> <br>    ,    display   none,       . ,   ? <br> <br> <code class="html">&lt;div id="template" style="display: none"&gt; &lt;div class="talk"&gt; &lt;h2&gt;{{title}}&lt;/h2&gt; &lt;div&gt;by &lt;span class="name"&gt;{{presenter}}&lt;/span&gt;&lt;/div&gt; &lt;p&gt;{{summary}}&lt;/p&gt; &lt;div class="comments"&gt;&lt;/div&gt; &lt;form&gt; &lt;input type="text" name="comment"&gt; &lt;button type="submit"&gt; &lt;/button&gt; &lt;button type="button" class="del"&gt; &lt;/button&gt; &lt;/form&gt; &lt;/div&gt; &lt;div class="comment"&gt; &lt;span class="name"&gt;{{author}}&lt;/span&gt;: {{message}} &lt;/div&gt; &lt;/div&gt;</code> <br> <br>    DOM  JavaScript    .          elt   13,       ,  HTML,   -      DOM-. <br> <br>   DOM-   ,      ,    ,   ,     ‚Äì             . <br> <br>  , HTML   ,   . <br> <br> <code class="html">&lt;script src="skillsharing_client.js"&gt;&lt;/script&gt;</code> <br> <br>  <br> ,       ,       .       HTTP-,      XMLHttpRequest,            . <br> <br> <code class="javascript">function request(options, callback) { var req = new XMLHttpRequest(); req.open(options.method || "GET", options.pathname, true); req.addEventListener("load", function() { if (req.status &lt; 400) callback(null, req.responseText); else callback(new Error("Request failed: " + req.statusText)); }); req.addEventListener("error", function() { callback(new Error("Network error")); }); req.send(options.body || null); }</code> <br> <br>            ,  waitForChanges. <br> <br> <code class="javascript">var lastServerTime = 0; request({pathname: "talks"}, function(error, response) { if (error) { reportError(error); } else { response = JSON.parse(response); displayTalks(response.talks); lastServerTime = response.serverTime; waitForChanges(); } });</code> <br> <br>  lastServerTime      ,   .   ,        ,       .  ,  serverTime,   ,     lastServerTime. <br> <br>    ,   ,        .       reportError,      ,   . <br> <br> <code class="javascript">function reportError(error) { if (error) alert(error.toString()); }</code> <br> <br>  ,   ,       .  ,           ,     .      ,      . <br> <br>   <br>         ,    ,    . ,     ,     ,        .  ,      ,   DOM    . <br> <br>  displayTalks      ,       .     shownTalks,      DOM,   ,     . <br> <br> <code class="javascript">var talkDiv = document.querySelector("#talks"); var shownTalks = Object.create(null); function displayTalks(talks) { talks.forEach(function(talk) { var shown = shownTalks[talk.title]; if (talk.deleted) { if (shown) { talkDiv.removeChild(shown); delete shownTalks[talk.title]; } } else { var node = drawTalk(talk); if (shown) talkDiv.replaceChild(node, shown); else talkDiv.appendChild(node); shownTalks[talk.title] = node; } }); }</code> <br> <br>  DOM     ,   HTML .    instantiateTemplate,     . <br> <br>  name ‚Äì  .    ,   ,        ,       ID ‚Äútemplate‚Äù.  querySelector   .     ‚Äútalk‚Äù  ‚Äúcomment‚Äù. <br> <br> <code class="javascript">function instantiateTemplate(name, values) { function instantiateText(text) { return text.replace(/\{\{(\w+)\}\}/g, function(_, name) { return values[name]; }); } function instantiate(node) { if (node.nodeType == document.ELEMENT_NODE) { var copy = node.cloneNode(); for (var i = 0; i &lt; node.childNodes.length; i++) copy.appendChild(instantiate(node.childNodes[i])); return copy; } else if (node.nodeType == document.TEXT_NODE) { return document.createTextNode( instantiateText(node.nodeValue)); } } var template = document.querySelector("#template ." + name); return instantiate(template); }</code> <br> <br>  cloneNode,      DOM,   .     ,       true.  instantiate    ,     . <br> <br>   instantiateTemplate   ,    ,     .   {{title}}     ‚Äútitle‚Äù. <br> <br>      ,    drawTalk   . <br> <br> <code class="javascript">function drawTalk(talk) { var node = instantiateTemplate("talk", talk); var comments = node.querySelector(".comments"); talk.comments.forEach(function(comment) { comments.appendChild( instantiateTemplate("comment", comment)); }); node.querySelector("button.del").addEventListener( "click", deleteTalk.bind(null, talk.title)); var form = node.querySelector("form"); form.addEventListener("submit", function(event) { event.preventDefault(); addComment(talk.title, form.elements.comment.value); form.reset(); }); return node; }</code> <br> <br>     ‚Äútalk‚Äù    . -,   ,     ‚Äúcomment‚Äù       "comments". ,      ,      ,  . <br> <br>   <br>  ,   drawTalk,   deleteTalk  addComment   ,       .      URL,       ,       talkURL. <br> <br> <code class="javascript">function talkURL(title) { return "talks/" + encodeURIComponent(title); }</code> <br> <br>  deleteTalk   DELETE       . <br> <br> <code class="javascript">function deleteTalk(title) { request({pathname: talkURL(title), method: "DELETE"}, reportError); }</code> <br> <br>          JSON      POST-. <br> <br> <code class="javascript">function addComment(title, comment) { var comment = {author: nameField.value, message: comment}; request({pathname: talkURL(title) + "/comments", body: JSON.stringify(comment), method: "POST"}, reportError); }</code> <br> <br>  nameField,      author,    <code class="javascript">  ,      .       localStorage,          . <br> <br> var nameField = document.querySelector("#name"); nameField.value = localStorage.getItem("name") || ""; nameField.addEventListener("change", function() { localStorage.setItem("name", nameField.value); });           ‚Äúsubmit‚Äù.       (     ),     PUT-   . var talkForm = document.querySelector("#newtalk"); talkForm.addEventListener("submit", function(event) { event.preventDefault(); request({pathname: talkURL(talkForm.elements.title.value), method: "PUT", body: JSON.stringify({ presenter: nameField.value, summary: talkForm.elements.summary.value })}, reportError); talkForm.reset(); });</code> <br> <br>   <br>  ,   ,   ,    ,     ,     ,       .    -       ,     . <br> <br>       ,    displayTalks    ,     ,       . <br> <br> <code class="javascript">function waitForChanges() { request({pathname: "talks?changesSince=" + lastServerTime}, function(error, response) { if (error) { setTimeout(waitForChanges, 2500); console.error(error.stack); } else { response = JSON.parse(response); displayTalks(response.talks); lastServerTime = response.serverTime; waitForChanges(); } }); }</code> <br> <br>    ,   ,     ,  ,    .    ,    reportError,             .       (  ),      2.5 . <br> <br>   ,     ,  lastServerTime ,    ,           .    ,    . <br> <br>    ,        localhost:8000,  ,  ,     ,    . <br> <br>  <br>      ,    .    , ,   <a href=""> </a>   <a href="http://nodejs.org/">Node.js</a> . <br> <br>     <br>      .     ,      . <br> <br>     ,            .    ,    . <br> <br>    <br>      ,       DOM   ,   .   .     -         ,          ,      ,      ,  . <br> <br>   ,        ,    .    ,   ? <br> <br>   <br>    ,     .         ,   if,    ,  . <br> <br>           ,   ("comment")     .      ‚Äútalk‚Äù,     ,    comments,    ,   ,    . <br> <br>     : <br> <br> <code class="html">&lt;div class="comments"&gt; &lt;div class="comment" template-repeat="comments"&gt; &lt;span class="name"&gt;{{author}}&lt;/span&gt;: {{message}} &lt;/div&gt; &lt;/div&gt;</code> <br> <br>   :       template-repeat,  ,     ,   ,   ,   .   ( values  instantiateTemplate)          ,   {{author}}     comment,    . <br> <br>  instantiateTemplate ,    ,    ,     ,          drawTalk. <br> <br>       ,      ,     true  false? <br> <br>    ? <br>  -       JavaScript,     .   - . <br> <br>   -     JavaScript.       ,      .         . <br> <br>   ,   -          JavaScript.     ,       .       ,     . <br> <br>     .    .          ,  ,    ?</code></code> </h5> <code><code><code class="html">  ID ‚Äútalks‚Äù    .   ,      . <br> <br>       . <br> <br> &lt;form id="newtalk"&gt; &lt;h3&gt;Submit a talk&lt;/h3&gt; : &lt;input type="text" style="width: 40em" name="title"&gt; &lt;br&gt; Summary: &lt;input type="text" style="width: 40em" name="summary"&gt; &lt;button type="submit"&gt; &lt;/button&gt; &lt;/form&gt;</code> <br> <br>     ‚Äúsubmit‚Äù  ,      HTTP-,    . <br> <br>    ,    display   none,       . ,   ? <br> <br> <code class="html">&lt;div id="template" style="display: none"&gt; &lt;div class="talk"&gt; &lt;h2&gt;{{title}}&lt;/h2&gt; &lt;div&gt;by &lt;span class="name"&gt;{{presenter}}&lt;/span&gt;&lt;/div&gt; &lt;p&gt;{{summary}}&lt;/p&gt; &lt;div class="comments"&gt;&lt;/div&gt; &lt;form&gt; &lt;input type="text" name="comment"&gt; &lt;button type="submit"&gt; &lt;/button&gt; &lt;button type="button" class="del"&gt; &lt;/button&gt; &lt;/form&gt; &lt;/div&gt; &lt;div class="comment"&gt; &lt;span class="name"&gt;{{author}}&lt;/span&gt;: {{message}} &lt;/div&gt; &lt;/div&gt;</code> <br> <br>    DOM  JavaScript    .          elt   13,       ,  HTML,   -      DOM-. <br> <br>   DOM-   ,      ,    ,   ,     ‚Äì             . <br> <br>  , HTML   ,   . <br> <br> <code class="html">&lt;script src="skillsharing_client.js"&gt;&lt;/script&gt;</code> <br> <br>  <br> ,       ,       .       HTTP-,      XMLHttpRequest,            . <br> <br> <code class="javascript">function request(options, callback) { var req = new XMLHttpRequest(); req.open(options.method || "GET", options.pathname, true); req.addEventListener("load", function() { if (req.status &lt; 400) callback(null, req.responseText); else callback(new Error("Request failed: " + req.statusText)); }); req.addEventListener("error", function() { callback(new Error("Network error")); }); req.send(options.body || null); }</code> <br> <br>            ,  waitForChanges. <br> <br> <code class="javascript">var lastServerTime = 0; request({pathname: "talks"}, function(error, response) { if (error) { reportError(error); } else { response = JSON.parse(response); displayTalks(response.talks); lastServerTime = response.serverTime; waitForChanges(); } });</code> <br> <br>  lastServerTime      ,   .   ,        ,       .  ,  serverTime,   ,     lastServerTime. <br> <br>    ,   ,        .       reportError,      ,   . <br> <br> <code class="javascript">function reportError(error) { if (error) alert(error.toString()); }</code> <br> <br>  ,   ,       .  ,           ,     .      ,      . <br> <br>   <br>         ,    ,    . ,     ,     ,        .  ,      ,   DOM    . <br> <br>  displayTalks      ,       .     shownTalks,      DOM,   ,     . <br> <br> <code class="javascript">var talkDiv = document.querySelector("#talks"); var shownTalks = Object.create(null); function displayTalks(talks) { talks.forEach(function(talk) { var shown = shownTalks[talk.title]; if (talk.deleted) { if (shown) { talkDiv.removeChild(shown); delete shownTalks[talk.title]; } } else { var node = drawTalk(talk); if (shown) talkDiv.replaceChild(node, shown); else talkDiv.appendChild(node); shownTalks[talk.title] = node; } }); }</code> <br> <br>  DOM     ,   HTML .    instantiateTemplate,     . <br> <br>  name ‚Äì  .    ,   ,        ,       ID ‚Äútemplate‚Äù.  querySelector   .     ‚Äútalk‚Äù  ‚Äúcomment‚Äù. <br> <br> <code class="javascript">function instantiateTemplate(name, values) { function instantiateText(text) { return text.replace(/\{\{(\w+)\}\}/g, function(_, name) { return values[name]; }); } function instantiate(node) { if (node.nodeType == document.ELEMENT_NODE) { var copy = node.cloneNode(); for (var i = 0; i &lt; node.childNodes.length; i++) copy.appendChild(instantiate(node.childNodes[i])); return copy; } else if (node.nodeType == document.TEXT_NODE) { return document.createTextNode( instantiateText(node.nodeValue)); } } var template = document.querySelector("#template ." + name); return instantiate(template); }</code> <br> <br>  cloneNode,      DOM,   .     ,       true.  instantiate    ,     . <br> <br>   instantiateTemplate   ,    ,     .   {{title}}     ‚Äútitle‚Äù. <br> <br>      ,    drawTalk   . <br> <br> <code class="javascript">function drawTalk(talk) { var node = instantiateTemplate("talk", talk); var comments = node.querySelector(".comments"); talk.comments.forEach(function(comment) { comments.appendChild( instantiateTemplate("comment", comment)); }); node.querySelector("button.del").addEventListener( "click", deleteTalk.bind(null, talk.title)); var form = node.querySelector("form"); form.addEventListener("submit", function(event) { event.preventDefault(); addComment(talk.title, form.elements.comment.value); form.reset(); }); return node; }</code> <br> <br>     ‚Äútalk‚Äù    . -,   ,     ‚Äúcomment‚Äù       "comments". ,      ,      ,  . <br> <br>   <br>  ,   drawTalk,   deleteTalk  addComment   ,       .      URL,       ,       talkURL. <br> <br> <code class="javascript">function talkURL(title) { return "talks/" + encodeURIComponent(title); }</code> <br> <br>  deleteTalk   DELETE       . <br> <br> <code class="javascript">function deleteTalk(title) { request({pathname: talkURL(title), method: "DELETE"}, reportError); }</code> <br> <br>          JSON      POST-. <br> <br> <code class="javascript">function addComment(title, comment) { var comment = {author: nameField.value, message: comment}; request({pathname: talkURL(title) + "/comments", body: JSON.stringify(comment), method: "POST"}, reportError); }</code> <br> <br>  nameField,      author,    <code class="javascript">  ,      .       localStorage,          . <br> <br> var nameField = document.querySelector("#name"); nameField.value = localStorage.getItem("name") || ""; nameField.addEventListener("change", function() { localStorage.setItem("name", nameField.value); });           ‚Äúsubmit‚Äù.       (     ),     PUT-   . var talkForm = document.querySelector("#newtalk"); talkForm.addEventListener("submit", function(event) { event.preventDefault(); request({pathname: talkURL(talkForm.elements.title.value), method: "PUT", body: JSON.stringify({ presenter: nameField.value, summary: talkForm.elements.summary.value })}, reportError); talkForm.reset(); });</code> <br> <br>   <br>  ,   ,   ,    ,     ,     ,       .    -       ,     . <br> <br>       ,    displayTalks    ,     ,       . <br> <br> <code class="javascript">function waitForChanges() { request({pathname: "talks?changesSince=" + lastServerTime}, function(error, response) { if (error) { setTimeout(waitForChanges, 2500); console.error(error.stack); } else { response = JSON.parse(response); displayTalks(response.talks); lastServerTime = response.serverTime; waitForChanges(); } }); }</code> <br> <br>    ,   ,     ,  ,    .    ,    reportError,             .       (  ),      2.5 . <br> <br>   ,     ,  lastServerTime ,    ,           .    ,    . <br> <br>    ,        localhost:8000,  ,  ,     ,    . <br> <br>  <br>      ,    .    , ,   <a href=""> </a>   <a href="http://nodejs.org/">Node.js</a> . <br> <br>     <br>      .     ,      . <br> <br>     ,            .    ,    . <br> <br>    <br>      ,       DOM   ,   .   .     -         ,          ,      ,      ,  . <br> <br>   ,        ,    .    ,   ? <br> <br>   <br>    ,     .         ,   if,    ,  . <br> <br>           ,   ("comment")     .      ‚Äútalk‚Äù,     ,    comments,    ,   ,    . <br> <br>     : <br> <br> <code class="html">&lt;div class="comments"&gt; &lt;div class="comment" template-repeat="comments"&gt; &lt;span class="name"&gt;{{author}}&lt;/span&gt;: {{message}} &lt;/div&gt; &lt;/div&gt;</code> <br> <br>   :       template-repeat,  ,     ,   ,   ,   .   ( values  instantiateTemplate)          ,   {{author}}     comment,    . <br> <br>  instantiateTemplate ,    ,    ,     ,          drawTalk. <br> <br>       ,      ,     true  false? <br> <br>    ? <br>  -       JavaScript,     .   - . <br> <br>   -     JavaScript.       ,      .         . <br> <br>   ,   -          JavaScript.     ,       .       ,     . <br> <br>     .    .          ,  ,    ?</code></code> <h5> <code><code><code class="html">  ID ‚Äútalks‚Äù    .   ,      . <br> <br>       . <br> <br> &lt;form id="newtalk"&gt; &lt;h3&gt;Submit a talk&lt;/h3&gt; : &lt;input type="text" style="width: 40em" name="title"&gt; &lt;br&gt; Summary: &lt;input type="text" style="width: 40em" name="summary"&gt; &lt;button type="submit"&gt; &lt;/button&gt; &lt;/form&gt;</code> <br> <br>     ‚Äúsubmit‚Äù  ,      HTTP-,    . <br> <br>    ,    display   none,       . ,   ? <br> <br> <code class="html">&lt;div id="template" style="display: none"&gt; &lt;div class="talk"&gt; &lt;h2&gt;{{title}}&lt;/h2&gt; &lt;div&gt;by &lt;span class="name"&gt;{{presenter}}&lt;/span&gt;&lt;/div&gt; &lt;p&gt;{{summary}}&lt;/p&gt; &lt;div class="comments"&gt;&lt;/div&gt; &lt;form&gt; &lt;input type="text" name="comment"&gt; &lt;button type="submit"&gt; &lt;/button&gt; &lt;button type="button" class="del"&gt; &lt;/button&gt; &lt;/form&gt; &lt;/div&gt; &lt;div class="comment"&gt; &lt;span class="name"&gt;{{author}}&lt;/span&gt;: {{message}} &lt;/div&gt; &lt;/div&gt;</code> <br> <br>    DOM  JavaScript    .          elt   13,       ,  HTML,   -      DOM-. <br> <br>   DOM-   ,      ,    ,   ,     ‚Äì             . <br> <br>  , HTML   ,   . <br> <br> <code class="html">&lt;script src="skillsharing_client.js"&gt;&lt;/script&gt;</code> <br> <br>  <br> ,       ,       .       HTTP-,      XMLHttpRequest,            . <br> <br> <code class="javascript">function request(options, callback) { var req = new XMLHttpRequest(); req.open(options.method || "GET", options.pathname, true); req.addEventListener("load", function() { if (req.status &lt; 400) callback(null, req.responseText); else callback(new Error("Request failed: " + req.statusText)); }); req.addEventListener("error", function() { callback(new Error("Network error")); }); req.send(options.body || null); }</code> <br> <br>            ,  waitForChanges. <br> <br> <code class="javascript">var lastServerTime = 0; request({pathname: "talks"}, function(error, response) { if (error) { reportError(error); } else { response = JSON.parse(response); displayTalks(response.talks); lastServerTime = response.serverTime; waitForChanges(); } });</code> <br> <br>  lastServerTime      ,   .   ,        ,       .  ,  serverTime,   ,     lastServerTime. <br> <br>    ,   ,        .       reportError,      ,   . <br> <br> <code class="javascript">function reportError(error) { if (error) alert(error.toString()); }</code> <br> <br>  ,   ,       .  ,           ,     .      ,      . <br> <br>   <br>         ,    ,    . ,     ,     ,        .  ,      ,   DOM    . <br> <br>  displayTalks      ,       .     shownTalks,      DOM,   ,     . <br> <br> <code class="javascript">var talkDiv = document.querySelector("#talks"); var shownTalks = Object.create(null); function displayTalks(talks) { talks.forEach(function(talk) { var shown = shownTalks[talk.title]; if (talk.deleted) { if (shown) { talkDiv.removeChild(shown); delete shownTalks[talk.title]; } } else { var node = drawTalk(talk); if (shown) talkDiv.replaceChild(node, shown); else talkDiv.appendChild(node); shownTalks[talk.title] = node; } }); }</code> <br> <br>  DOM     ,   HTML .    instantiateTemplate,     . <br> <br>  name ‚Äì  .    ,   ,        ,       ID ‚Äútemplate‚Äù.  querySelector   .     ‚Äútalk‚Äù  ‚Äúcomment‚Äù. <br> <br> <code class="javascript">function instantiateTemplate(name, values) { function instantiateText(text) { return text.replace(/\{\{(\w+)\}\}/g, function(_, name) { return values[name]; }); } function instantiate(node) { if (node.nodeType == document.ELEMENT_NODE) { var copy = node.cloneNode(); for (var i = 0; i &lt; node.childNodes.length; i++) copy.appendChild(instantiate(node.childNodes[i])); return copy; } else if (node.nodeType == document.TEXT_NODE) { return document.createTextNode( instantiateText(node.nodeValue)); } } var template = document.querySelector("#template ." + name); return instantiate(template); }</code> <br> <br>  cloneNode,      DOM,   .     ,       true.  instantiate    ,     . <br> <br>   instantiateTemplate   ,    ,     .   {{title}}     ‚Äútitle‚Äù. <br> <br>      ,    drawTalk   . <br> <br> <code class="javascript">function drawTalk(talk) { var node = instantiateTemplate("talk", talk); var comments = node.querySelector(".comments"); talk.comments.forEach(function(comment) { comments.appendChild( instantiateTemplate("comment", comment)); }); node.querySelector("button.del").addEventListener( "click", deleteTalk.bind(null, talk.title)); var form = node.querySelector("form"); form.addEventListener("submit", function(event) { event.preventDefault(); addComment(talk.title, form.elements.comment.value); form.reset(); }); return node; }</code> <br> <br>     ‚Äútalk‚Äù    . -,   ,     ‚Äúcomment‚Äù       "comments". ,      ,      ,  . <br> <br>   <br>  ,   drawTalk,   deleteTalk  addComment   ,       .      URL,       ,       talkURL. <br> <br> <code class="javascript">function talkURL(title) { return "talks/" + encodeURIComponent(title); }</code> <br> <br>  deleteTalk   DELETE       . <br> <br> <code class="javascript">function deleteTalk(title) { request({pathname: talkURL(title), method: "DELETE"}, reportError); }</code> <br> <br>          JSON      POST-. <br> <br> <code class="javascript">function addComment(title, comment) { var comment = {author: nameField.value, message: comment}; request({pathname: talkURL(title) + "/comments", body: JSON.stringify(comment), method: "POST"}, reportError); }</code> <br> <br>  nameField,      author,    <code class="javascript">  ,      .       localStorage,          . <br> <br> var nameField = document.querySelector("#name"); nameField.value = localStorage.getItem("name") || ""; nameField.addEventListener("change", function() { localStorage.setItem("name", nameField.value); });           ‚Äúsubmit‚Äù.       (     ),     PUT-   . var talkForm = document.querySelector("#newtalk"); talkForm.addEventListener("submit", function(event) { event.preventDefault(); request({pathname: talkURL(talkForm.elements.title.value), method: "PUT", body: JSON.stringify({ presenter: nameField.value, summary: talkForm.elements.summary.value })}, reportError); talkForm.reset(); });</code> <br> <br>   <br>  ,   ,   ,    ,     ,     ,       .    -       ,     . <br> <br>       ,    displayTalks    ,     ,       . <br> <br> <code class="javascript">function waitForChanges() { request({pathname: "talks?changesSince=" + lastServerTime}, function(error, response) { if (error) { setTimeout(waitForChanges, 2500); console.error(error.stack); } else { response = JSON.parse(response); displayTalks(response.talks); lastServerTime = response.serverTime; waitForChanges(); } }); }</code> <br> <br>    ,   ,     ,  ,    .    ,    reportError,             .       (  ),      2.5 . <br> <br>   ,     ,  lastServerTime ,    ,           .    ,    . <br> <br>    ,        localhost:8000,  ,  ,     ,    . <br> <br>  <br>      ,    .    , ,   <a href=""> </a>   <a href="http://nodejs.org/">Node.js</a> . <br> <br>     <br>      .     ,      . <br> <br>     ,            .    ,    . <br> <br>    <br>      ,       DOM   ,   .   .     -         ,          ,      ,      ,  . <br> <br>   ,        ,    .    ,   ? <br> <br>   <br>    ,     .         ,   if,    ,  . <br> <br>           ,   ("comment")     .      ‚Äútalk‚Äù,     ,    comments,    ,   ,    . <br> <br>     : <br> <br> <code class="html">&lt;div class="comments"&gt; &lt;div class="comment" template-repeat="comments"&gt; &lt;span class="name"&gt;{{author}}&lt;/span&gt;: {{message}} &lt;/div&gt; &lt;/div&gt;</code> <br> <br>   :       template-repeat,  ,     ,   ,   ,   .   ( values  instantiateTemplate)          ,   {{author}}     comment,    . <br> <br>  instantiateTemplate ,    ,    ,     ,          drawTalk. <br> <br>       ,      ,     true  false? <br> <br>    ? <br>  -       JavaScript,     .   - . <br> <br>   -     JavaScript.       ,      .         . <br> <br>   ,   -          JavaScript.     ,       .       ,     . <br> <br>     .    .          ,  ,    ?</code></code> </h5> <code><code><code class="html">  ID ‚Äútalks‚Äù    .   ,      . <br> <br>       . <br> <br> &lt;form id="newtalk"&gt; &lt;h3&gt;Submit a talk&lt;/h3&gt; : &lt;input type="text" style="width: 40em" name="title"&gt; &lt;br&gt; Summary: &lt;input type="text" style="width: 40em" name="summary"&gt; &lt;button type="submit"&gt; &lt;/button&gt; &lt;/form&gt;</code> <br> <br>     ‚Äúsubmit‚Äù  ,      HTTP-,    . <br> <br>    ,    display   none,       . ,   ? <br> <br> <code class="html">&lt;div id="template" style="display: none"&gt; &lt;div class="talk"&gt; &lt;h2&gt;{{title}}&lt;/h2&gt; &lt;div&gt;by &lt;span class="name"&gt;{{presenter}}&lt;/span&gt;&lt;/div&gt; &lt;p&gt;{{summary}}&lt;/p&gt; &lt;div class="comments"&gt;&lt;/div&gt; &lt;form&gt; &lt;input type="text" name="comment"&gt; &lt;button type="submit"&gt; &lt;/button&gt; &lt;button type="button" class="del"&gt; &lt;/button&gt; &lt;/form&gt; &lt;/div&gt; &lt;div class="comment"&gt; &lt;span class="name"&gt;{{author}}&lt;/span&gt;: {{message}} &lt;/div&gt; &lt;/div&gt;</code> <br> <br>    DOM  JavaScript    .          elt   13,       ,  HTML,   -      DOM-. <br> <br>   DOM-   ,      ,    ,   ,     ‚Äì             . <br> <br>  , HTML   ,   . <br> <br> <code class="html">&lt;script src="skillsharing_client.js"&gt;&lt;/script&gt;</code> <br> <br>  <br> ,       ,       .       HTTP-,      XMLHttpRequest,            . <br> <br> <code class="javascript">function request(options, callback) { var req = new XMLHttpRequest(); req.open(options.method || "GET", options.pathname, true); req.addEventListener("load", function() { if (req.status &lt; 400) callback(null, req.responseText); else callback(new Error("Request failed: " + req.statusText)); }); req.addEventListener("error", function() { callback(new Error("Network error")); }); req.send(options.body || null); }</code> <br> <br>            ,  waitForChanges. <br> <br> <code class="javascript">var lastServerTime = 0; request({pathname: "talks"}, function(error, response) { if (error) { reportError(error); } else { response = JSON.parse(response); displayTalks(response.talks); lastServerTime = response.serverTime; waitForChanges(); } });</code> <br> <br>  lastServerTime      ,   .   ,        ,       .  ,  serverTime,   ,     lastServerTime. <br> <br>    ,   ,        .       reportError,      ,   . <br> <br> <code class="javascript">function reportError(error) { if (error) alert(error.toString()); }</code> <br> <br>  ,   ,       .  ,           ,     .      ,      . <br> <br>   <br>         ,    ,    . ,     ,     ,        .  ,      ,   DOM    . <br> <br>  displayTalks      ,       .     shownTalks,      DOM,   ,     . <br> <br> <code class="javascript">var talkDiv = document.querySelector("#talks"); var shownTalks = Object.create(null); function displayTalks(talks) { talks.forEach(function(talk) { var shown = shownTalks[talk.title]; if (talk.deleted) { if (shown) { talkDiv.removeChild(shown); delete shownTalks[talk.title]; } } else { var node = drawTalk(talk); if (shown) talkDiv.replaceChild(node, shown); else talkDiv.appendChild(node); shownTalks[talk.title] = node; } }); }</code> <br> <br>  DOM     ,   HTML .    instantiateTemplate,     . <br> <br>  name ‚Äì  .    ,   ,        ,       ID ‚Äútemplate‚Äù.  querySelector   .     ‚Äútalk‚Äù  ‚Äúcomment‚Äù. <br> <br> <code class="javascript">function instantiateTemplate(name, values) { function instantiateText(text) { return text.replace(/\{\{(\w+)\}\}/g, function(_, name) { return values[name]; }); } function instantiate(node) { if (node.nodeType == document.ELEMENT_NODE) { var copy = node.cloneNode(); for (var i = 0; i &lt; node.childNodes.length; i++) copy.appendChild(instantiate(node.childNodes[i])); return copy; } else if (node.nodeType == document.TEXT_NODE) { return document.createTextNode( instantiateText(node.nodeValue)); } } var template = document.querySelector("#template ." + name); return instantiate(template); }</code> <br> <br>  cloneNode,      DOM,   .     ,       true.  instantiate    ,     . <br> <br>   instantiateTemplate   ,    ,     .   {{title}}     ‚Äútitle‚Äù. <br> <br>      ,    drawTalk   . <br> <br> <code class="javascript">function drawTalk(talk) { var node = instantiateTemplate("talk", talk); var comments = node.querySelector(".comments"); talk.comments.forEach(function(comment) { comments.appendChild( instantiateTemplate("comment", comment)); }); node.querySelector("button.del").addEventListener( "click", deleteTalk.bind(null, talk.title)); var form = node.querySelector("form"); form.addEventListener("submit", function(event) { event.preventDefault(); addComment(talk.title, form.elements.comment.value); form.reset(); }); return node; }</code> <br> <br>     ‚Äútalk‚Äù    . -,   ,     ‚Äúcomment‚Äù       "comments". ,      ,      ,  . <br> <br>   <br>  ,   drawTalk,   deleteTalk  addComment   ,       .      URL,       ,       talkURL. <br> <br> <code class="javascript">function talkURL(title) { return "talks/" + encodeURIComponent(title); }</code> <br> <br>  deleteTalk   DELETE       . <br> <br> <code class="javascript">function deleteTalk(title) { request({pathname: talkURL(title), method: "DELETE"}, reportError); }</code> <br> <br>          JSON      POST-. <br> <br> <code class="javascript">function addComment(title, comment) { var comment = {author: nameField.value, message: comment}; request({pathname: talkURL(title) + "/comments", body: JSON.stringify(comment), method: "POST"}, reportError); }</code> <br> <br>  nameField,      author,    <code class="javascript">  ,      .       localStorage,          . <br> <br> var nameField = document.querySelector("#name"); nameField.value = localStorage.getItem("name") || ""; nameField.addEventListener("change", function() { localStorage.setItem("name", nameField.value); });           ‚Äúsubmit‚Äù.       (     ),     PUT-   . var talkForm = document.querySelector("#newtalk"); talkForm.addEventListener("submit", function(event) { event.preventDefault(); request({pathname: talkURL(talkForm.elements.title.value), method: "PUT", body: JSON.stringify({ presenter: nameField.value, summary: talkForm.elements.summary.value })}, reportError); talkForm.reset(); });</code> <br> <br>   <br>  ,   ,   ,    ,     ,     ,       .    -       ,     . <br> <br>       ,    displayTalks    ,     ,       . <br> <br> <code class="javascript">function waitForChanges() { request({pathname: "talks?changesSince=" + lastServerTime}, function(error, response) { if (error) { setTimeout(waitForChanges, 2500); console.error(error.stack); } else { response = JSON.parse(response); displayTalks(response.talks); lastServerTime = response.serverTime; waitForChanges(); } }); }</code> <br> <br>    ,   ,     ,  ,    .    ,    reportError,             .       (  ),      2.5 . <br> <br>   ,     ,  lastServerTime ,    ,           .    ,    . <br> <br>    ,        localhost:8000,  ,  ,     ,    . <br> <br>  <br>      ,    .    , ,   <a href=""> </a>   <a href="http://nodejs.org/">Node.js</a> . <br> <br>     <br>      .     ,      . <br> <br>     ,            .    ,    . <br> <br>    <br>      ,       DOM   ,   .   .     -         ,          ,      ,      ,  . <br> <br>   ,        ,    .    ,   ? <br> <br>   <br>    ,     .         ,   if,    ,  . <br> <br>           ,   ("comment")     .      ‚Äútalk‚Äù,     ,    comments,    ,   ,    . <br> <br>     : <br> <br> <code class="html">&lt;div class="comments"&gt; &lt;div class="comment" template-repeat="comments"&gt; &lt;span class="name"&gt;{{author}}&lt;/span&gt;: {{message}} &lt;/div&gt; &lt;/div&gt;</code> <br> <br>   :       template-repeat,  ,     ,   ,   ,   .   ( values  instantiateTemplate)          ,   {{author}}     comment,    . <br> <br>  instantiateTemplate ,    ,    ,     ,          drawTalk. <br> <br>       ,      ,     true  false? <br> <br>    ? <br>  -       JavaScript,     .   - . <br> <br>   -     JavaScript.       ,      .         . <br> <br>   ,   -          JavaScript.     ,       .       ,     . <br> <br>     .    .          ,  ,    ?</code></code> <h5> <code><code><code class="html">  ID ‚Äútalks‚Äù    .   ,      . <br> <br>       . <br> <br> &lt;form id="newtalk"&gt; &lt;h3&gt;Submit a talk&lt;/h3&gt; : &lt;input type="text" style="width: 40em" name="title"&gt; &lt;br&gt; Summary: &lt;input type="text" style="width: 40em" name="summary"&gt; &lt;button type="submit"&gt; &lt;/button&gt; &lt;/form&gt;</code> <br> <br>     ‚Äúsubmit‚Äù  ,      HTTP-,    . <br> <br>    ,    display   none,       . ,   ? <br> <br> <code class="html">&lt;div id="template" style="display: none"&gt; &lt;div class="talk"&gt; &lt;h2&gt;{{title}}&lt;/h2&gt; &lt;div&gt;by &lt;span class="name"&gt;{{presenter}}&lt;/span&gt;&lt;/div&gt; &lt;p&gt;{{summary}}&lt;/p&gt; &lt;div class="comments"&gt;&lt;/div&gt; &lt;form&gt; &lt;input type="text" name="comment"&gt; &lt;button type="submit"&gt; &lt;/button&gt; &lt;button type="button" class="del"&gt; &lt;/button&gt; &lt;/form&gt; &lt;/div&gt; &lt;div class="comment"&gt; &lt;span class="name"&gt;{{author}}&lt;/span&gt;: {{message}} &lt;/div&gt; &lt;/div&gt;</code> <br> <br>    DOM  JavaScript    .          elt   13,       ,  HTML,   -      DOM-. <br> <br>   DOM-   ,      ,    ,   ,     ‚Äì             . <br> <br>  , HTML   ,   . <br> <br> <code class="html">&lt;script src="skillsharing_client.js"&gt;&lt;/script&gt;</code> <br> <br>  <br> ,       ,       .       HTTP-,      XMLHttpRequest,            . <br> <br> <code class="javascript">function request(options, callback) { var req = new XMLHttpRequest(); req.open(options.method || "GET", options.pathname, true); req.addEventListener("load", function() { if (req.status &lt; 400) callback(null, req.responseText); else callback(new Error("Request failed: " + req.statusText)); }); req.addEventListener("error", function() { callback(new Error("Network error")); }); req.send(options.body || null); }</code> <br> <br>            ,  waitForChanges. <br> <br> <code class="javascript">var lastServerTime = 0; request({pathname: "talks"}, function(error, response) { if (error) { reportError(error); } else { response = JSON.parse(response); displayTalks(response.talks); lastServerTime = response.serverTime; waitForChanges(); } });</code> <br> <br>  lastServerTime      ,   .   ,        ,       .  ,  serverTime,   ,     lastServerTime. <br> <br>    ,   ,        .       reportError,      ,   . <br> <br> <code class="javascript">function reportError(error) { if (error) alert(error.toString()); }</code> <br> <br>  ,   ,       .  ,           ,     .      ,      . <br> <br>   <br>         ,    ,    . ,     ,     ,        .  ,      ,   DOM    . <br> <br>  displayTalks      ,       .     shownTalks,      DOM,   ,     . <br> <br> <code class="javascript">var talkDiv = document.querySelector("#talks"); var shownTalks = Object.create(null); function displayTalks(talks) { talks.forEach(function(talk) { var shown = shownTalks[talk.title]; if (talk.deleted) { if (shown) { talkDiv.removeChild(shown); delete shownTalks[talk.title]; } } else { var node = drawTalk(talk); if (shown) talkDiv.replaceChild(node, shown); else talkDiv.appendChild(node); shownTalks[talk.title] = node; } }); }</code> <br> <br>  DOM     ,   HTML .    instantiateTemplate,     . <br> <br>  name ‚Äì  .    ,   ,        ,       ID ‚Äútemplate‚Äù.  querySelector   .     ‚Äútalk‚Äù  ‚Äúcomment‚Äù. <br> <br> <code class="javascript">function instantiateTemplate(name, values) { function instantiateText(text) { return text.replace(/\{\{(\w+)\}\}/g, function(_, name) { return values[name]; }); } function instantiate(node) { if (node.nodeType == document.ELEMENT_NODE) { var copy = node.cloneNode(); for (var i = 0; i &lt; node.childNodes.length; i++) copy.appendChild(instantiate(node.childNodes[i])); return copy; } else if (node.nodeType == document.TEXT_NODE) { return document.createTextNode( instantiateText(node.nodeValue)); } } var template = document.querySelector("#template ." + name); return instantiate(template); }</code> <br> <br>  cloneNode,      DOM,   .     ,       true.  instantiate    ,     . <br> <br>   instantiateTemplate   ,    ,     .   {{title}}     ‚Äútitle‚Äù. <br> <br>      ,    drawTalk   . <br> <br> <code class="javascript">function drawTalk(talk) { var node = instantiateTemplate("talk", talk); var comments = node.querySelector(".comments"); talk.comments.forEach(function(comment) { comments.appendChild( instantiateTemplate("comment", comment)); }); node.querySelector("button.del").addEventListener( "click", deleteTalk.bind(null, talk.title)); var form = node.querySelector("form"); form.addEventListener("submit", function(event) { event.preventDefault(); addComment(talk.title, form.elements.comment.value); form.reset(); }); return node; }</code> <br> <br>     ‚Äútalk‚Äù    . -,   ,     ‚Äúcomment‚Äù       "comments". ,      ,      ,  . <br> <br>   <br>  ,   drawTalk,   deleteTalk  addComment   ,       .      URL,       ,       talkURL. <br> <br> <code class="javascript">function talkURL(title) { return "talks/" + encodeURIComponent(title); }</code> <br> <br>  deleteTalk   DELETE       . <br> <br> <code class="javascript">function deleteTalk(title) { request({pathname: talkURL(title), method: "DELETE"}, reportError); }</code> <br> <br>          JSON      POST-. <br> <br> <code class="javascript">function addComment(title, comment) { var comment = {author: nameField.value, message: comment}; request({pathname: talkURL(title) + "/comments", body: JSON.stringify(comment), method: "POST"}, reportError); }</code> <br> <br>  nameField,      author,    <code class="javascript">  ,      .       localStorage,          . <br> <br> var nameField = document.querySelector("#name"); nameField.value = localStorage.getItem("name") || ""; nameField.addEventListener("change", function() { localStorage.setItem("name", nameField.value); });           ‚Äúsubmit‚Äù.       (     ),     PUT-   . var talkForm = document.querySelector("#newtalk"); talkForm.addEventListener("submit", function(event) { event.preventDefault(); request({pathname: talkURL(talkForm.elements.title.value), method: "PUT", body: JSON.stringify({ presenter: nameField.value, summary: talkForm.elements.summary.value })}, reportError); talkForm.reset(); });</code> <br> <br>   <br>  ,   ,   ,    ,     ,     ,       .    -       ,     . <br> <br>       ,    displayTalks    ,     ,       . <br> <br> <code class="javascript">function waitForChanges() { request({pathname: "talks?changesSince=" + lastServerTime}, function(error, response) { if (error) { setTimeout(waitForChanges, 2500); console.error(error.stack); } else { response = JSON.parse(response); displayTalks(response.talks); lastServerTime = response.serverTime; waitForChanges(); } }); }</code> <br> <br>    ,   ,     ,  ,    .    ,    reportError,             .       (  ),      2.5 . <br> <br>   ,     ,  lastServerTime ,    ,           .    ,    . <br> <br>    ,        localhost:8000,  ,  ,     ,    . <br> <br>  <br>      ,    .    , ,   <a href=""> </a>   <a href="http://nodejs.org/">Node.js</a> . <br> <br>     <br>      .     ,      . <br> <br>     ,            .    ,    . <br> <br>    <br>      ,       DOM   ,   .   .     -         ,          ,      ,      ,  . <br> <br>   ,        ,    .    ,   ? <br> <br>   <br>    ,     .         ,   if,    ,  . <br> <br>           ,   ("comment")     .      ‚Äútalk‚Äù,     ,    comments,    ,   ,    . <br> <br>     : <br> <br> <code class="html">&lt;div class="comments"&gt; &lt;div class="comment" template-repeat="comments"&gt; &lt;span class="name"&gt;{{author}}&lt;/span&gt;: {{message}} &lt;/div&gt; &lt;/div&gt;</code> <br> <br>   :       template-repeat,  ,     ,   ,   ,   .   ( values  instantiateTemplate)          ,   {{author}}     comment,    . <br> <br>  instantiateTemplate ,    ,    ,     ,          drawTalk. <br> <br>       ,      ,     true  false? <br> <br>    ? <br>  -       JavaScript,     .   - . <br> <br>   -     JavaScript.       ,      .         . <br> <br>   ,   -          JavaScript.     ,       .       ,     . <br> <br>     .    .          ,  ,    ?</code></code> </h5> <code><code><code class="html">  ID ‚Äútalks‚Äù    .   ,      . <br> <br>       . <br> <br> &lt;form id="newtalk"&gt; &lt;h3&gt;Submit a talk&lt;/h3&gt; : &lt;input type="text" style="width: 40em" name="title"&gt; &lt;br&gt; Summary: &lt;input type="text" style="width: 40em" name="summary"&gt; &lt;button type="submit"&gt; &lt;/button&gt; &lt;/form&gt;</code> <br> <br>     ‚Äúsubmit‚Äù  ,      HTTP-,    . <br> <br>    ,    display   none,       . ,   ? <br> <br> <code class="html">&lt;div id="template" style="display: none"&gt; &lt;div class="talk"&gt; &lt;h2&gt;{{title}}&lt;/h2&gt; &lt;div&gt;by &lt;span class="name"&gt;{{presenter}}&lt;/span&gt;&lt;/div&gt; &lt;p&gt;{{summary}}&lt;/p&gt; &lt;div class="comments"&gt;&lt;/div&gt; &lt;form&gt; &lt;input type="text" name="comment"&gt; &lt;button type="submit"&gt; &lt;/button&gt; &lt;button type="button" class="del"&gt; &lt;/button&gt; &lt;/form&gt; &lt;/div&gt; &lt;div class="comment"&gt; &lt;span class="name"&gt;{{author}}&lt;/span&gt;: {{message}} &lt;/div&gt; &lt;/div&gt;</code> <br> <br>    DOM  JavaScript    .          elt   13,       ,  HTML,   -      DOM-. <br> <br>   DOM-   ,      ,    ,   ,     ‚Äì             . <br> <br>  , HTML   ,   . <br> <br> <code class="html">&lt;script src="skillsharing_client.js"&gt;&lt;/script&gt;</code> <br> <br>  <br> ,       ,       .       HTTP-,      XMLHttpRequest,            . <br> <br> <code class="javascript">function request(options, callback) { var req = new XMLHttpRequest(); req.open(options.method || "GET", options.pathname, true); req.addEventListener("load", function() { if (req.status &lt; 400) callback(null, req.responseText); else callback(new Error("Request failed: " + req.statusText)); }); req.addEventListener("error", function() { callback(new Error("Network error")); }); req.send(options.body || null); }</code> <br> <br>            ,  waitForChanges. <br> <br> <code class="javascript">var lastServerTime = 0; request({pathname: "talks"}, function(error, response) { if (error) { reportError(error); } else { response = JSON.parse(response); displayTalks(response.talks); lastServerTime = response.serverTime; waitForChanges(); } });</code> <br> <br>  lastServerTime      ,   .   ,        ,       .  ,  serverTime,   ,     lastServerTime. <br> <br>    ,   ,        .       reportError,      ,   . <br> <br> <code class="javascript">function reportError(error) { if (error) alert(error.toString()); }</code> <br> <br>  ,   ,       .  ,           ,     .      ,      . <br> <br>   <br>         ,    ,    . ,     ,     ,        .  ,      ,   DOM    . <br> <br>  displayTalks      ,       .     shownTalks,      DOM,   ,     . <br> <br> <code class="javascript">var talkDiv = document.querySelector("#talks"); var shownTalks = Object.create(null); function displayTalks(talks) { talks.forEach(function(talk) { var shown = shownTalks[talk.title]; if (talk.deleted) { if (shown) { talkDiv.removeChild(shown); delete shownTalks[talk.title]; } } else { var node = drawTalk(talk); if (shown) talkDiv.replaceChild(node, shown); else talkDiv.appendChild(node); shownTalks[talk.title] = node; } }); }</code> <br> <br>  DOM     ,   HTML .    instantiateTemplate,     . <br> <br>  name ‚Äì  .    ,   ,        ,       ID ‚Äútemplate‚Äù.  querySelector   .     ‚Äútalk‚Äù  ‚Äúcomment‚Äù. <br> <br> <code class="javascript">function instantiateTemplate(name, values) { function instantiateText(text) { return text.replace(/\{\{(\w+)\}\}/g, function(_, name) { return values[name]; }); } function instantiate(node) { if (node.nodeType == document.ELEMENT_NODE) { var copy = node.cloneNode(); for (var i = 0; i &lt; node.childNodes.length; i++) copy.appendChild(instantiate(node.childNodes[i])); return copy; } else if (node.nodeType == document.TEXT_NODE) { return document.createTextNode( instantiateText(node.nodeValue)); } } var template = document.querySelector("#template ." + name); return instantiate(template); }</code> <br> <br>  cloneNode,      DOM,   .     ,       true.  instantiate    ,     . <br> <br>   instantiateTemplate   ,    ,     .   {{title}}     ‚Äútitle‚Äù. <br> <br>      ,    drawTalk   . <br> <br> <code class="javascript">function drawTalk(talk) { var node = instantiateTemplate("talk", talk); var comments = node.querySelector(".comments"); talk.comments.forEach(function(comment) { comments.appendChild( instantiateTemplate("comment", comment)); }); node.querySelector("button.del").addEventListener( "click", deleteTalk.bind(null, talk.title)); var form = node.querySelector("form"); form.addEventListener("submit", function(event) { event.preventDefault(); addComment(talk.title, form.elements.comment.value); form.reset(); }); return node; }</code> <br> <br>     ‚Äútalk‚Äù    . -,   ,     ‚Äúcomment‚Äù       "comments". ,      ,      ,  . <br> <br>   <br>  ,   drawTalk,   deleteTalk  addComment   ,       .      URL,       ,       talkURL. <br> <br> <code class="javascript">function talkURL(title) { return "talks/" + encodeURIComponent(title); }</code> <br> <br>  deleteTalk   DELETE       . <br> <br> <code class="javascript">function deleteTalk(title) { request({pathname: talkURL(title), method: "DELETE"}, reportError); }</code> <br> <br>          JSON      POST-. <br> <br> <code class="javascript">function addComment(title, comment) { var comment = {author: nameField.value, message: comment}; request({pathname: talkURL(title) + "/comments", body: JSON.stringify(comment), method: "POST"}, reportError); }</code> <br> <br>  nameField,      author,    <code class="javascript">  ,      .       localStorage,          . <br> <br> var nameField = document.querySelector("#name"); nameField.value = localStorage.getItem("name") || ""; nameField.addEventListener("change", function() { localStorage.setItem("name", nameField.value); });           ‚Äúsubmit‚Äù.       (     ),     PUT-   . var talkForm = document.querySelector("#newtalk"); talkForm.addEventListener("submit", function(event) { event.preventDefault(); request({pathname: talkURL(talkForm.elements.title.value), method: "PUT", body: JSON.stringify({ presenter: nameField.value, summary: talkForm.elements.summary.value })}, reportError); talkForm.reset(); });</code> <br> <br>   <br>  ,   ,   ,    ,     ,     ,       .    -       ,     . <br> <br>       ,    displayTalks    ,     ,       . <br> <br> <code class="javascript">function waitForChanges() { request({pathname: "talks?changesSince=" + lastServerTime}, function(error, response) { if (error) { setTimeout(waitForChanges, 2500); console.error(error.stack); } else { response = JSON.parse(response); displayTalks(response.talks); lastServerTime = response.serverTime; waitForChanges(); } }); }</code> <br> <br>    ,   ,     ,  ,    .    ,    reportError,             .       (  ),      2.5 . <br> <br>   ,     ,  lastServerTime ,    ,           .    ,    . <br> <br>    ,        localhost:8000,  ,  ,     ,    . <br> <br>  <br>      ,    .    , ,   <a href=""> </a>   <a href="http://nodejs.org/">Node.js</a> . <br> <br>     <br>      .     ,      . <br> <br>     ,            .    ,    . <br> <br>    <br>      ,       DOM   ,   .   .     -         ,          ,      ,      ,  . <br> <br>   ,        ,    .    ,   ? <br> <br>   <br>    ,     .         ,   if,    ,  . <br> <br>           ,   ("comment")     .      ‚Äútalk‚Äù,     ,    comments,    ,   ,    . <br> <br>     : <br> <br> <code class="html">&lt;div class="comments"&gt; &lt;div class="comment" template-repeat="comments"&gt; &lt;span class="name"&gt;{{author}}&lt;/span&gt;: {{message}} &lt;/div&gt; &lt;/div&gt;</code> <br> <br>   :       template-repeat,  ,     ,   ,   ,   .   ( values  instantiateTemplate)          ,   {{author}}     comment,    . <br> <br>  instantiateTemplate ,    ,    ,     ,          drawTalk. <br> <br>       ,      ,     true  false? <br> <br>    ? <br>  -       JavaScript,     .   - . <br> <br>   -     JavaScript.       ,      .         . <br> <br>   ,   -          JavaScript.     ,       .       ,     . <br> <br>     .    .          ,  ,    ?</code></code> <pre> <code class="hljs lua"><code class="html">  ID ‚Äútalks‚Äù    .   ,      . <br> <br>       . <br> <br> &lt;form id=<span class="hljs-string"><span class="hljs-string">"newtalk"</span></span>&gt; &lt;h3&gt;Submit a talk&lt;/h3&gt; : &lt;<span class="hljs-built_in"><span class="hljs-built_in">input</span></span> <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=<span class="hljs-string"><span class="hljs-string">"text"</span></span> style=<span class="hljs-string"><span class="hljs-string">"width: 40em"</span></span> name=<span class="hljs-string"><span class="hljs-string">"title"</span></span>&gt; &lt;br&gt; Summary: &lt;<span class="hljs-built_in"><span class="hljs-built_in">input</span></span> <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=<span class="hljs-string"><span class="hljs-string">"text"</span></span> style=<span class="hljs-string"><span class="hljs-string">"width: 40em"</span></span> name=<span class="hljs-string"><span class="hljs-string">"summary"</span></span>&gt; &lt;button <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=<span class="hljs-string"><span class="hljs-string">"submit"</span></span>&gt; &lt;/button&gt; &lt;/form&gt;</code> <br> <br>     ‚Äúsubmit‚Äù  ,      HTTP-,    . <br> <br>    ,    display   none,       . ,   ? <br> <br> <code class="html">&lt;div id=<span class="hljs-string"><span class="hljs-string">"template"</span></span> style=<span class="hljs-string"><span class="hljs-string">"display: none"</span></span>&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"talk"</span></span>&gt; &lt;h2&gt;{{title}}&lt;/h2&gt; &lt;div&gt;by &lt;span class=<span class="hljs-string"><span class="hljs-string">"name"</span></span>&gt;{{presenter}}&lt;/span&gt;&lt;/div&gt; &lt;p&gt;{{summary}}&lt;/p&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"comments"</span></span>&gt;&lt;/div&gt; &lt;form&gt; &lt;<span class="hljs-built_in"><span class="hljs-built_in">input</span></span> <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=<span class="hljs-string"><span class="hljs-string">"text"</span></span> name=<span class="hljs-string"><span class="hljs-string">"comment"</span></span>&gt; &lt;button <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=<span class="hljs-string"><span class="hljs-string">"submit"</span></span>&gt; &lt;/button&gt; &lt;button <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=<span class="hljs-string"><span class="hljs-string">"button"</span></span> class=<span class="hljs-string"><span class="hljs-string">"del"</span></span>&gt; &lt;/button&gt; &lt;/form&gt; &lt;/div&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"comment"</span></span>&gt; &lt;span class=<span class="hljs-string"><span class="hljs-string">"name"</span></span>&gt;{{author}}&lt;/span&gt;: {{message}} &lt;/div&gt; &lt;/div&gt;</code> <br> <br>    DOM  JavaScript    .          elt   <span class="hljs-number"><span class="hljs-number">13</span></span>,       ,  HTML,   -      DOM-. <br> <br>   DOM-   ,      ,    ,   ,     ‚Äì             . <br> <br>  , HTML   ,   . <br> <br> <code class="html">&lt;script src=<span class="hljs-string"><span class="hljs-string">"skillsharing_client.js"</span></span>&gt;&lt;/script&gt;</code> <br> <br>  <br> ,       ,       .       HTTP-,      XMLHttpRequest,            . <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">request</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(options, callback)</span></span></span></span> { var req = new XMLHttpRequest(); req.<span class="hljs-built_in"><span class="hljs-built_in">open</span></span>(options.method || <span class="hljs-string"><span class="hljs-string">"GET"</span></span>, options.pathname, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); req.addEventListener(<span class="hljs-string"><span class="hljs-string">"load"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (req.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> &lt; <span class="hljs-number"><span class="hljs-number">400</span></span>) callback(null, req.responseText); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> callback(new Error(<span class="hljs-string"><span class="hljs-string">"Request failed: "</span></span> + req.statusText)); }); req.addEventListener(<span class="hljs-string"><span class="hljs-string">"error"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { callback(new Error(<span class="hljs-string"><span class="hljs-string">"Network error"</span></span>)); }); req.send(options.body || null); }</code> <br> <br>            ,  waitForChanges. <br> <br> <code class="javascript">var lastServerTime = <span class="hljs-number"><span class="hljs-number">0</span></span>; request({pathname: <span class="hljs-string"><span class="hljs-string">"talks"</span></span>}, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(error, response)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>) { reportError(<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { response = JSON.parse(response); displayTalks(response.talks); lastServerTime = response.serverTime; waitForChanges(); } });</code> <br> <br>  lastServerTime      ,   .   ,        ,       .  ,  serverTime,   ,     lastServerTime. <br> <br>    ,   ,        .       reportError,      ,   . <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">reportError</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(error)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>) alert(<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>.toString()); }</code> <br> <br>  ,   ,       .  ,           ,     .      ,      . <br> <br>   <br>         ,    ,    . ,     ,     ,        .  ,      ,   DOM    . <br> <br>  displayTalks      ,       .     shownTalks,      DOM,   ,     . <br> <br> <code class="javascript">var talkDiv = document.querySelector(<span class="hljs-string"><span class="hljs-string">"#talks"</span></span>); var shownTalks = Object.<span class="hljs-built_in"><span class="hljs-built_in">create</span></span>(null); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">displayTalks</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(talks)</span></span></span></span> { talks.forEach(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(talk)</span></span></span></span> { var shown = shownTalks[talk.title]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (talk.deleted) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (shown) { talkDiv.removeChild(shown); delete shownTalks[talk.title]; } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { var node = drawTalk(talk); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (shown) talkDiv.replaceChild(node, shown); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> talkDiv.appendChild(node); shownTalks[talk.title] = node; } }); }</code> <br> <br>  DOM     ,   HTML .    instantiateTemplate,     . <br> <br>  name ‚Äì  .    ,   ,        ,       ID ‚Äútemplate‚Äù.  querySelector   .     ‚Äútalk‚Äù  ‚Äúcomment‚Äù. <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">instantiateTemplate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(name, values)</span></span></span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">instantiateText</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(text)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> text.replace(/\{\{(\w+)\}\}/g, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(_, name)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> values[name]; }); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">instantiate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(node)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (node.nodeType == document.ELEMENT_NODE) { var copy = node.cloneNode(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (var i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; node.childNodes.length; i++) copy.appendChild(instantiate(node.childNodes[i])); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> copy; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (node.nodeType == document.TEXT_NODE) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> document.createTextNode( instantiateText(node.nodeValue)); } } var template = document.querySelector(<span class="hljs-string"><span class="hljs-string">"#template ."</span></span> + name); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> instantiate(template); }</code> <br> <br>  cloneNode,      DOM,   .     ,       <span class="hljs-literal"><span class="hljs-literal">true</span></span>.  instantiate    ,     . <br> <br>   instantiateTemplate   ,    ,     .   {{title}}     ‚Äútitle‚Äù. <br> <br>      ,    drawTalk   . <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">drawTalk</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(talk)</span></span></span></span> { var node = instantiateTemplate(<span class="hljs-string"><span class="hljs-string">"talk"</span></span>, talk); var comments = node.querySelector(<span class="hljs-string"><span class="hljs-string">".comments"</span></span>); talk.comments.forEach(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(comment)</span></span></span></span> { comments.appendChild( instantiateTemplate(<span class="hljs-string"><span class="hljs-string">"comment"</span></span>, comment)); }); node.querySelector(<span class="hljs-string"><span class="hljs-string">"button.del"</span></span>).addEventListener( <span class="hljs-string"><span class="hljs-string">"click"</span></span>, deleteTalk.bind(null, talk.title)); var form = node.querySelector(<span class="hljs-string"><span class="hljs-string">"form"</span></span>); form.addEventListener(<span class="hljs-string"><span class="hljs-string">"submit"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(event)</span></span></span></span> { event.preventDefault(); addComment(talk.title, form.elements.comment.value); form.reset(); }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> node; }</code> <br> <br>     ‚Äútalk‚Äù    . -,   ,     ‚Äúcomment‚Äù       <span class="hljs-string"><span class="hljs-string">"comments"</span></span>. ,      ,      ,  . <br> <br>   <br>  ,   drawTalk,   deleteTalk  addComment   ,       .      URL,       ,       talkURL. <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">talkURL</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(title)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"talks/"</span></span> + encodeURIComponent(title); }</code> <br> <br>  deleteTalk   DELETE       . <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">deleteTalk</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(title)</span></span></span></span> { request({pathname: talkURL(title), method: <span class="hljs-string"><span class="hljs-string">"DELETE"</span></span>}, reportError); }</code> <br> <br>          JSON      POST-. <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">addComment</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(title, comment)</span></span></span></span> { var comment = {author: nameField.value, message: comment}; request({pathname: talkURL(title) + <span class="hljs-string"><span class="hljs-string">"/comments"</span></span>, body: JSON.stringify(comment), method: <span class="hljs-string"><span class="hljs-string">"POST"</span></span>}, reportError); }</code> <br> <br>  nameField,      author,    <code><code class="javascript">  ,      .       localStorage,          . <br> <br> var nameField = document.querySelector(<span class="hljs-string"><span class="hljs-string">"#name"</span></span>); nameField.value = localStorage.getItem(<span class="hljs-string"><span class="hljs-string">"name"</span></span>) || <span class="hljs-string"><span class="hljs-string">""</span></span>; nameField.addEventListener(<span class="hljs-string"><span class="hljs-string">"change"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { localStorage.setItem(<span class="hljs-string"><span class="hljs-string">"name"</span></span>, nameField.value); });           ‚Äúsubmit‚Äù.       (     ),     PUT-   . var talkForm = document.querySelector(<span class="hljs-string"><span class="hljs-string">"#newtalk"</span></span>); talkForm.addEventListener(<span class="hljs-string"><span class="hljs-string">"submit"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(event)</span></span></span></span> { event.preventDefault(); request({pathname: talkURL(talkForm.elements.title.value), method: <span class="hljs-string"><span class="hljs-string">"PUT"</span></span>, body: JSON.stringify({ presenter: nameField.value, summary: talkForm.elements.summary.value })}, reportError); talkForm.reset(); });</code> <br> <br>   <br>  ,   ,   ,    ,     ,     ,       .    -       ,     . <br> <br>       ,    displayTalks    ,     ,       . <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">waitForChanges</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { request({pathname: <span class="hljs-string"><span class="hljs-string">"talks?changesSince="</span></span> + lastServerTime}, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(error, response)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>) { setTimeout(waitForChanges, <span class="hljs-number"><span class="hljs-number">2500</span></span>); console.<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>.stack); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { response = JSON.parse(response); displayTalks(response.talks); lastServerTime = response.serverTime; waitForChanges(); } }); }</code> <br> <br>    ,   ,     ,  ,    .    ,    reportError,             .       (  ),      <span class="hljs-number"><span class="hljs-number">2.5</span></span> . <br> <br>   ,     ,  lastServerTime ,    ,           .    ,    . <br> <br>    ,        localhost:<span class="hljs-number"><span class="hljs-number">8000</span></span>,  ,  ,     ,    . <br> <br>  <br>      ,    .    , ,   <a href=""> </a>   <a href="http://nodejs.org/">Node.js</a> . <br> <br>     <br>      .     ,      . <br> <br>     ,            .    ,    . <br> <br>    <br>      ,       DOM   ,   .   .     -         ,          ,      ,      ,  . <br> <br>   ,        ,    .    ,   ? <br> <br>   <br>    ,     .         ,   <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>,    ,  . <br> <br>           ,   (<span class="hljs-string"><span class="hljs-string">"comment"</span></span>)     .      ‚Äútalk‚Äù,     ,    comments,    ,   ,    . <br> <br>     : <br> <br> <code class="html">&lt;div class=<span class="hljs-string"><span class="hljs-string">"comments"</span></span>&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"comment"</span></span> template-<span class="hljs-keyword"><span class="hljs-keyword">repeat</span></span>=<span class="hljs-string"><span class="hljs-string">"comments"</span></span>&gt; &lt;span class=<span class="hljs-string"><span class="hljs-string">"name"</span></span>&gt;{{author}}&lt;/span&gt;: {{message}} &lt;/div&gt; &lt;/div&gt;</code> <br> <br>   :       template-<span class="hljs-keyword"><span class="hljs-keyword">repeat</span></span>,  ,     ,   ,   ,   .   ( values  instantiateTemplate)          ,   {{author}}     comment,    . <br> <br>  instantiateTemplate ,    ,    ,     ,          drawTalk. <br> <br>       ,      ,     <span class="hljs-literal"><span class="hljs-literal">true</span></span>  <span class="hljs-literal"><span class="hljs-literal">false</span></span>? <br> <br>    ? <br>  -       JavaScript,     .   - . <br> <br>   -     JavaScript.       ,      .         . <br> <br>   ,   -          JavaScript.     ,       .       ,     . <br> <br>     .    .          ,  ,    ?</code></code> </pre> <code><code><code class="html">  ID ‚Äútalks‚Äù    .   ,      . <br> <br>       . <br> <br> &lt;form id="newtalk"&gt; &lt;h3&gt;Submit a talk&lt;/h3&gt; : &lt;input type="text" style="width: 40em" name="title"&gt; &lt;br&gt; Summary: &lt;input type="text" style="width: 40em" name="summary"&gt; &lt;button type="submit"&gt; &lt;/button&gt; &lt;/form&gt;</code> <br> <br>     ‚Äúsubmit‚Äù  ,      HTTP-,    . <br> <br>    ,    display   none,       . ,   ? <br> <br> <code class="html">&lt;div id="template" style="display: none"&gt; &lt;div class="talk"&gt; &lt;h2&gt;{{title}}&lt;/h2&gt; &lt;div&gt;by &lt;span class="name"&gt;{{presenter}}&lt;/span&gt;&lt;/div&gt; &lt;p&gt;{{summary}}&lt;/p&gt; &lt;div class="comments"&gt;&lt;/div&gt; &lt;form&gt; &lt;input type="text" name="comment"&gt; &lt;button type="submit"&gt; &lt;/button&gt; &lt;button type="button" class="del"&gt; &lt;/button&gt; &lt;/form&gt; &lt;/div&gt; &lt;div class="comment"&gt; &lt;span class="name"&gt;{{author}}&lt;/span&gt;: {{message}} &lt;/div&gt; &lt;/div&gt;</code> <br> <br>    DOM  JavaScript    .          elt   13,       ,  HTML,   -      DOM-. <br> <br>   DOM-   ,      ,    ,   ,     ‚Äì             . <br> <br>  , HTML   ,   . <br> <br> <code class="html">&lt;script src="skillsharing_client.js"&gt;&lt;/script&gt;</code> <br> <br>  <br> ,       ,       .       HTTP-,      XMLHttpRequest,            . <br> <br> <code class="javascript">function request(options, callback) { var req = new XMLHttpRequest(); req.open(options.method || "GET", options.pathname, true); req.addEventListener("load", function() { if (req.status &lt; 400) callback(null, req.responseText); else callback(new Error("Request failed: " + req.statusText)); }); req.addEventListener("error", function() { callback(new Error("Network error")); }); req.send(options.body || null); }</code> <br> <br>            ,  waitForChanges. <br> <br> <code class="javascript">var lastServerTime = 0; request({pathname: "talks"}, function(error, response) { if (error) { reportError(error); } else { response = JSON.parse(response); displayTalks(response.talks); lastServerTime = response.serverTime; waitForChanges(); } });</code> <br> <br>  lastServerTime      ,   .   ,        ,       .  ,  serverTime,   ,     lastServerTime. <br> <br>    ,   ,        .       reportError,      ,   . <br> <br> <code class="javascript">function reportError(error) { if (error) alert(error.toString()); }</code> <br> <br>  ,   ,       .  ,           ,     .      ,      . <br> <br>   <br>         ,    ,    . ,     ,     ,        .  ,      ,   DOM    . <br> <br>  displayTalks      ,       .     shownTalks,      DOM,   ,     . <br> <br> <code class="javascript">var talkDiv = document.querySelector("#talks"); var shownTalks = Object.create(null); function displayTalks(talks) { talks.forEach(function(talk) { var shown = shownTalks[talk.title]; if (talk.deleted) { if (shown) { talkDiv.removeChild(shown); delete shownTalks[talk.title]; } } else { var node = drawTalk(talk); if (shown) talkDiv.replaceChild(node, shown); else talkDiv.appendChild(node); shownTalks[talk.title] = node; } }); }</code> <br> <br>  DOM     ,   HTML .    instantiateTemplate,     . <br> <br>  name ‚Äì  .    ,   ,        ,       ID ‚Äútemplate‚Äù.  querySelector   .     ‚Äútalk‚Äù  ‚Äúcomment‚Äù. <br> <br> <code class="javascript">function instantiateTemplate(name, values) { function instantiateText(text) { return text.replace(/\{\{(\w+)\}\}/g, function(_, name) { return values[name]; }); } function instantiate(node) { if (node.nodeType == document.ELEMENT_NODE) { var copy = node.cloneNode(); for (var i = 0; i &lt; node.childNodes.length; i++) copy.appendChild(instantiate(node.childNodes[i])); return copy; } else if (node.nodeType == document.TEXT_NODE) { return document.createTextNode( instantiateText(node.nodeValue)); } } var template = document.querySelector("#template ." + name); return instantiate(template); }</code> <br> <br>  cloneNode,      DOM,   .     ,       true.  instantiate    ,     . <br> <br>   instantiateTemplate   ,    ,     .   {{title}}     ‚Äútitle‚Äù. <br> <br>      ,    drawTalk   . <br> <br> <code class="javascript">function drawTalk(talk) { var node = instantiateTemplate("talk", talk); var comments = node.querySelector(".comments"); talk.comments.forEach(function(comment) { comments.appendChild( instantiateTemplate("comment", comment)); }); node.querySelector("button.del").addEventListener( "click", deleteTalk.bind(null, talk.title)); var form = node.querySelector("form"); form.addEventListener("submit", function(event) { event.preventDefault(); addComment(talk.title, form.elements.comment.value); form.reset(); }); return node; }</code> <br> <br>     ‚Äútalk‚Äù    . -,   ,     ‚Äúcomment‚Äù       "comments". ,      ,      ,  . <br> <br>   <br>  ,   drawTalk,   deleteTalk  addComment   ,       .      URL,       ,       talkURL. <br> <br> <code class="javascript">function talkURL(title) { return "talks/" + encodeURIComponent(title); }</code> <br> <br>  deleteTalk   DELETE       . <br> <br> <code class="javascript">function deleteTalk(title) { request({pathname: talkURL(title), method: "DELETE"}, reportError); }</code> <br> <br>          JSON      POST-. <br> <br> <code class="javascript">function addComment(title, comment) { var comment = {author: nameField.value, message: comment}; request({pathname: talkURL(title) + "/comments", body: JSON.stringify(comment), method: "POST"}, reportError); }</code> <br> <br>  nameField,      author,    <code class="javascript">  ,      .       localStorage,          . <br> <br> var nameField = document.querySelector("#name"); nameField.value = localStorage.getItem("name") || ""; nameField.addEventListener("change", function() { localStorage.setItem("name", nameField.value); });           ‚Äúsubmit‚Äù.       (     ),     PUT-   . var talkForm = document.querySelector("#newtalk"); talkForm.addEventListener("submit", function(event) { event.preventDefault(); request({pathname: talkURL(talkForm.elements.title.value), method: "PUT", body: JSON.stringify({ presenter: nameField.value, summary: talkForm.elements.summary.value })}, reportError); talkForm.reset(); });</code> <br> <br>   <br>  ,   ,   ,    ,     ,     ,       .    -       ,     . <br> <br>       ,    displayTalks    ,     ,       . <br> <br> <code class="javascript">function waitForChanges() { request({pathname: "talks?changesSince=" + lastServerTime}, function(error, response) { if (error) { setTimeout(waitForChanges, 2500); console.error(error.stack); } else { response = JSON.parse(response); displayTalks(response.talks); lastServerTime = response.serverTime; waitForChanges(); } }); }</code> <br> <br>    ,   ,     ,  ,    .    ,    reportError,             .       (  ),      2.5 . <br> <br>   ,     ,  lastServerTime ,    ,           .    ,    . <br> <br>    ,        localhost:8000,  ,  ,     ,    . <br> <br>  <br>      ,    .    , ,   <a href=""> </a>   <a href="http://nodejs.org/">Node.js</a> . <br> <br>     <br>      .     ,      . <br> <br>     ,            .    ,    . <br> <br>    <br>      ,       DOM   ,   .   .     -         ,          ,      ,      ,  . <br> <br>   ,        ,    .    ,   ? <br> <br>   <br>    ,     .         ,   if,    ,  . <br> <br>           ,   ("comment")     .      ‚Äútalk‚Äù,     ,    comments,    ,   ,    . <br> <br>     : <br> <br> <code class="html">&lt;div class="comments"&gt; &lt;div class="comment" template-repeat="comments"&gt; &lt;span class="name"&gt;{{author}}&lt;/span&gt;: {{message}} &lt;/div&gt; &lt;/div&gt;</code> <br> <br>   :       template-repeat,  ,     ,   ,   ,   .   ( values  instantiateTemplate)          ,   {{author}}     comment,    . <br> <br>  instantiateTemplate ,    ,    ,     ,          drawTalk. <br> <br>       ,      ,     true  false? <br> <br>    ? <br>  -       JavaScript,     .   - . <br> <br>   -     JavaScript.       ,      .         . <br> <br>   ,   -          JavaScript.     ,       .       ,     . <br> <br>     .    .          ,  ,    ?</code></code> <h5> <code><code><code class="html">  ID ‚Äútalks‚Äù    .   ,      . <br> <br>       . <br> <br> &lt;form id="newtalk"&gt; &lt;h3&gt;Submit a talk&lt;/h3&gt; : &lt;input type="text" style="width: 40em" name="title"&gt; &lt;br&gt; Summary: &lt;input type="text" style="width: 40em" name="summary"&gt; &lt;button type="submit"&gt; &lt;/button&gt; &lt;/form&gt;</code> <br> <br>     ‚Äúsubmit‚Äù  ,      HTTP-,    . <br> <br>    ,    display   none,       . ,   ? <br> <br> <code class="html">&lt;div id="template" style="display: none"&gt; &lt;div class="talk"&gt; &lt;h2&gt;{{title}}&lt;/h2&gt; &lt;div&gt;by &lt;span class="name"&gt;{{presenter}}&lt;/span&gt;&lt;/div&gt; &lt;p&gt;{{summary}}&lt;/p&gt; &lt;div class="comments"&gt;&lt;/div&gt; &lt;form&gt; &lt;input type="text" name="comment"&gt; &lt;button type="submit"&gt; &lt;/button&gt; &lt;button type="button" class="del"&gt; &lt;/button&gt; &lt;/form&gt; &lt;/div&gt; &lt;div class="comment"&gt; &lt;span class="name"&gt;{{author}}&lt;/span&gt;: {{message}} &lt;/div&gt; &lt;/div&gt;</code> <br> <br>    DOM  JavaScript    .          elt   13,       ,  HTML,   -      DOM-. <br> <br>   DOM-   ,      ,    ,   ,     ‚Äì             . <br> <br>  , HTML   ,   . <br> <br> <code class="html">&lt;script src="skillsharing_client.js"&gt;&lt;/script&gt;</code> <br> <br>  <br> ,       ,       .       HTTP-,      XMLHttpRequest,            . <br> <br> <code class="javascript">function request(options, callback) { var req = new XMLHttpRequest(); req.open(options.method || "GET", options.pathname, true); req.addEventListener("load", function() { if (req.status &lt; 400) callback(null, req.responseText); else callback(new Error("Request failed: " + req.statusText)); }); req.addEventListener("error", function() { callback(new Error("Network error")); }); req.send(options.body || null); }</code> <br> <br>            ,  waitForChanges. <br> <br> <code class="javascript">var lastServerTime = 0; request({pathname: "talks"}, function(error, response) { if (error) { reportError(error); } else { response = JSON.parse(response); displayTalks(response.talks); lastServerTime = response.serverTime; waitForChanges(); } });</code> <br> <br>  lastServerTime      ,   .   ,        ,       .  ,  serverTime,   ,     lastServerTime. <br> <br>    ,   ,        .       reportError,      ,   . <br> <br> <code class="javascript">function reportError(error) { if (error) alert(error.toString()); }</code> <br> <br>  ,   ,       .  ,           ,     .      ,      . <br> <br>   <br>         ,    ,    . ,     ,     ,        .  ,      ,   DOM    . <br> <br>  displayTalks      ,       .     shownTalks,      DOM,   ,     . <br> <br> <code class="javascript">var talkDiv = document.querySelector("#talks"); var shownTalks = Object.create(null); function displayTalks(talks) { talks.forEach(function(talk) { var shown = shownTalks[talk.title]; if (talk.deleted) { if (shown) { talkDiv.removeChild(shown); delete shownTalks[talk.title]; } } else { var node = drawTalk(talk); if (shown) talkDiv.replaceChild(node, shown); else talkDiv.appendChild(node); shownTalks[talk.title] = node; } }); }</code> <br> <br>  DOM     ,   HTML .    instantiateTemplate,     . <br> <br>  name ‚Äì  .    ,   ,        ,       ID ‚Äútemplate‚Äù.  querySelector   .     ‚Äútalk‚Äù  ‚Äúcomment‚Äù. <br> <br> <code class="javascript">function instantiateTemplate(name, values) { function instantiateText(text) { return text.replace(/\{\{(\w+)\}\}/g, function(_, name) { return values[name]; }); } function instantiate(node) { if (node.nodeType == document.ELEMENT_NODE) { var copy = node.cloneNode(); for (var i = 0; i &lt; node.childNodes.length; i++) copy.appendChild(instantiate(node.childNodes[i])); return copy; } else if (node.nodeType == document.TEXT_NODE) { return document.createTextNode( instantiateText(node.nodeValue)); } } var template = document.querySelector("#template ." + name); return instantiate(template); }</code> <br> <br>  cloneNode,      DOM,   .     ,       true.  instantiate    ,     . <br> <br>   instantiateTemplate   ,    ,     .   {{title}}     ‚Äútitle‚Äù. <br> <br>      ,    drawTalk   . <br> <br> <code class="javascript">function drawTalk(talk) { var node = instantiateTemplate("talk", talk); var comments = node.querySelector(".comments"); talk.comments.forEach(function(comment) { comments.appendChild( instantiateTemplate("comment", comment)); }); node.querySelector("button.del").addEventListener( "click", deleteTalk.bind(null, talk.title)); var form = node.querySelector("form"); form.addEventListener("submit", function(event) { event.preventDefault(); addComment(talk.title, form.elements.comment.value); form.reset(); }); return node; }</code> <br> <br>     ‚Äútalk‚Äù    . -,   ,     ‚Äúcomment‚Äù       "comments". ,      ,      ,  . <br> <br>   <br>  ,   drawTalk,   deleteTalk  addComment   ,       .      URL,       ,       talkURL. <br> <br> <code class="javascript">function talkURL(title) { return "talks/" + encodeURIComponent(title); }</code> <br> <br>  deleteTalk   DELETE       . <br> <br> <code class="javascript">function deleteTalk(title) { request({pathname: talkURL(title), method: "DELETE"}, reportError); }</code> <br> <br>          JSON      POST-. <br> <br> <code class="javascript">function addComment(title, comment) { var comment = {author: nameField.value, message: comment}; request({pathname: talkURL(title) + "/comments", body: JSON.stringify(comment), method: "POST"}, reportError); }</code> <br> <br>  nameField,      author,    <code class="javascript">  ,      .       localStorage,          . <br> <br> var nameField = document.querySelector("#name"); nameField.value = localStorage.getItem("name") || ""; nameField.addEventListener("change", function() { localStorage.setItem("name", nameField.value); });           ‚Äúsubmit‚Äù.       (     ),     PUT-   . var talkForm = document.querySelector("#newtalk"); talkForm.addEventListener("submit", function(event) { event.preventDefault(); request({pathname: talkURL(talkForm.elements.title.value), method: "PUT", body: JSON.stringify({ presenter: nameField.value, summary: talkForm.elements.summary.value })}, reportError); talkForm.reset(); });</code> <br> <br>   <br>  ,   ,   ,    ,     ,     ,       .    -       ,     . <br> <br>       ,    displayTalks    ,     ,       . <br> <br> <code class="javascript">function waitForChanges() { request({pathname: "talks?changesSince=" + lastServerTime}, function(error, response) { if (error) { setTimeout(waitForChanges, 2500); console.error(error.stack); } else { response = JSON.parse(response); displayTalks(response.talks); lastServerTime = response.serverTime; waitForChanges(); } }); }</code> <br> <br>    ,   ,     ,  ,    .    ,    reportError,             .       (  ),      2.5 . <br> <br>   ,     ,  lastServerTime ,    ,           .    ,    . <br> <br>    ,        localhost:8000,  ,  ,     ,    . <br> <br>  <br>      ,    .    , ,   <a href=""> </a>   <a href="http://nodejs.org/">Node.js</a> . <br> <br>     <br>      .     ,      . <br> <br>     ,            .    ,    . <br> <br>    <br>      ,       DOM   ,   .   .     -         ,          ,      ,      ,  . <br> <br>   ,        ,    .    ,   ? <br> <br>   <br>    ,     .         ,   if,    ,  . <br> <br>           ,   ("comment")     .      ‚Äútalk‚Äù,     ,    comments,    ,   ,    . <br> <br>     : <br> <br> <code class="html">&lt;div class="comments"&gt; &lt;div class="comment" template-repeat="comments"&gt; &lt;span class="name"&gt;{{author}}&lt;/span&gt;: {{message}} &lt;/div&gt; &lt;/div&gt;</code> <br> <br>   :       template-repeat,  ,     ,   ,   ,   .   ( values  instantiateTemplate)          ,   {{author}}     comment,    . <br> <br>  instantiateTemplate ,    ,    ,     ,          drawTalk. <br> <br>       ,      ,     true  false? <br> <br>    ? <br>  -       JavaScript,     .   - . <br> <br>   -     JavaScript.       ,      .         . <br> <br>   ,   -          JavaScript.     ,       .       ,     . <br> <br>     .    .          ,  ,    ?</code></code> </h5> <code><code><code class="html">  ID ‚Äútalks‚Äù    .   ,      . <br> <br>       . <br> <br> &lt;form id="newtalk"&gt; &lt;h3&gt;Submit a talk&lt;/h3&gt; : &lt;input type="text" style="width: 40em" name="title"&gt; &lt;br&gt; Summary: &lt;input type="text" style="width: 40em" name="summary"&gt; &lt;button type="submit"&gt; &lt;/button&gt; &lt;/form&gt;</code> <br> <br>     ‚Äúsubmit‚Äù  ,      HTTP-,    . <br> <br>    ,    display   none,       . ,   ? <br> <br> <code class="html">&lt;div id="template" style="display: none"&gt; &lt;div class="talk"&gt; &lt;h2&gt;{{title}}&lt;/h2&gt; &lt;div&gt;by &lt;span class="name"&gt;{{presenter}}&lt;/span&gt;&lt;/div&gt; &lt;p&gt;{{summary}}&lt;/p&gt; &lt;div class="comments"&gt;&lt;/div&gt; &lt;form&gt; &lt;input type="text" name="comment"&gt; &lt;button type="submit"&gt; &lt;/button&gt; &lt;button type="button" class="del"&gt; &lt;/button&gt; &lt;/form&gt; &lt;/div&gt; &lt;div class="comment"&gt; &lt;span class="name"&gt;{{author}}&lt;/span&gt;: {{message}} &lt;/div&gt; &lt;/div&gt;</code> <br> <br>    DOM  JavaScript    .          elt   13,       ,  HTML,   -      DOM-. <br> <br>   DOM-   ,      ,    ,   ,     ‚Äì             . <br> <br>  , HTML   ,   . <br> <br> <code class="html">&lt;script src="skillsharing_client.js"&gt;&lt;/script&gt;</code> <br> <br>  <br> ,       ,       .       HTTP-,      XMLHttpRequest,            . <br> <br> <code class="javascript">function request(options, callback) { var req = new XMLHttpRequest(); req.open(options.method || "GET", options.pathname, true); req.addEventListener("load", function() { if (req.status &lt; 400) callback(null, req.responseText); else callback(new Error("Request failed: " + req.statusText)); }); req.addEventListener("error", function() { callback(new Error("Network error")); }); req.send(options.body || null); }</code> <br> <br>            ,  waitForChanges. <br> <br> <code class="javascript">var lastServerTime = 0; request({pathname: "talks"}, function(error, response) { if (error) { reportError(error); } else { response = JSON.parse(response); displayTalks(response.talks); lastServerTime = response.serverTime; waitForChanges(); } });</code> <br> <br>  lastServerTime      ,   .   ,        ,       .  ,  serverTime,   ,     lastServerTime. <br> <br>    ,   ,        .       reportError,      ,   . <br> <br> <code class="javascript">function reportError(error) { if (error) alert(error.toString()); }</code> <br> <br>  ,   ,       .  ,           ,     .      ,      . <br> <br>   <br>         ,    ,    . ,     ,     ,        .  ,      ,   DOM    . <br> <br>  displayTalks      ,       .     shownTalks,      DOM,   ,     . <br> <br> <code class="javascript">var talkDiv = document.querySelector("#talks"); var shownTalks = Object.create(null); function displayTalks(talks) { talks.forEach(function(talk) { var shown = shownTalks[talk.title]; if (talk.deleted) { if (shown) { talkDiv.removeChild(shown); delete shownTalks[talk.title]; } } else { var node = drawTalk(talk); if (shown) talkDiv.replaceChild(node, shown); else talkDiv.appendChild(node); shownTalks[talk.title] = node; } }); }</code> <br> <br>  DOM     ,   HTML .    instantiateTemplate,     . <br> <br>  name ‚Äì  .    ,   ,        ,       ID ‚Äútemplate‚Äù.  querySelector   .     ‚Äútalk‚Äù  ‚Äúcomment‚Äù. <br> <br> <code class="javascript">function instantiateTemplate(name, values) { function instantiateText(text) { return text.replace(/\{\{(\w+)\}\}/g, function(_, name) { return values[name]; }); } function instantiate(node) { if (node.nodeType == document.ELEMENT_NODE) { var copy = node.cloneNode(); for (var i = 0; i &lt; node.childNodes.length; i++) copy.appendChild(instantiate(node.childNodes[i])); return copy; } else if (node.nodeType == document.TEXT_NODE) { return document.createTextNode( instantiateText(node.nodeValue)); } } var template = document.querySelector("#template ." + name); return instantiate(template); }</code> <br> <br>  cloneNode,      DOM,   .     ,       true.  instantiate    ,     . <br> <br>   instantiateTemplate   ,    ,     .   {{title}}     ‚Äútitle‚Äù. <br> <br>      ,    drawTalk   . <br> <br> <code class="javascript">function drawTalk(talk) { var node = instantiateTemplate("talk", talk); var comments = node.querySelector(".comments"); talk.comments.forEach(function(comment) { comments.appendChild( instantiateTemplate("comment", comment)); }); node.querySelector("button.del").addEventListener( "click", deleteTalk.bind(null, talk.title)); var form = node.querySelector("form"); form.addEventListener("submit", function(event) { event.preventDefault(); addComment(talk.title, form.elements.comment.value); form.reset(); }); return node; }</code> <br> <br>     ‚Äútalk‚Äù    . -,   ,     ‚Äúcomment‚Äù       "comments". ,      ,      ,  . <br> <br>   <br>  ,   drawTalk,   deleteTalk  addComment   ,       .      URL,       ,       talkURL. <br> <br> <code class="javascript">function talkURL(title) { return "talks/" + encodeURIComponent(title); }</code> <br> <br>  deleteTalk   DELETE       . <br> <br> <code class="javascript">function deleteTalk(title) { request({pathname: talkURL(title), method: "DELETE"}, reportError); }</code> <br> <br>          JSON      POST-. <br> <br> <code class="javascript">function addComment(title, comment) { var comment = {author: nameField.value, message: comment}; request({pathname: talkURL(title) + "/comments", body: JSON.stringify(comment), method: "POST"}, reportError); }</code> <br> <br>  nameField,      author,    <code class="javascript">  ,      .       localStorage,          . <br> <br> var nameField = document.querySelector("#name"); nameField.value = localStorage.getItem("name") || ""; nameField.addEventListener("change", function() { localStorage.setItem("name", nameField.value); });           ‚Äúsubmit‚Äù.       (     ),     PUT-   . var talkForm = document.querySelector("#newtalk"); talkForm.addEventListener("submit", function(event) { event.preventDefault(); request({pathname: talkURL(talkForm.elements.title.value), method: "PUT", body: JSON.stringify({ presenter: nameField.value, summary: talkForm.elements.summary.value })}, reportError); talkForm.reset(); });</code> <br> <br>   <br>  ,   ,   ,    ,     ,     ,       .    -       ,     . <br> <br>       ,    displayTalks    ,     ,       . <br> <br> <code class="javascript">function waitForChanges() { request({pathname: "talks?changesSince=" + lastServerTime}, function(error, response) { if (error) { setTimeout(waitForChanges, 2500); console.error(error.stack); } else { response = JSON.parse(response); displayTalks(response.talks); lastServerTime = response.serverTime; waitForChanges(); } }); }</code> <br> <br>    ,   ,     ,  ,    .    ,    reportError,             .       (  ),      2.5 . <br> <br>   ,     ,  lastServerTime ,    ,           .    ,    . <br> <br>    ,        localhost:8000,  ,  ,     ,    . <br> <br>  <br>      ,    .    , ,   <a href=""> </a>   <a href="http://nodejs.org/">Node.js</a> . <br> <br>     <br>      .     ,      . <br> <br>     ,            .    ,    . <br> <br>    <br>      ,       DOM   ,   .   .     -         ,          ,      ,      ,  . <br> <br>   ,        ,    .    ,   ? <br> <br>   <br>    ,     .         ,   if,    ,  . <br> <br>           ,   ("comment")     .      ‚Äútalk‚Äù,     ,    comments,    ,   ,    . <br> <br>     : <br> <br> <code class="html">&lt;div class="comments"&gt; &lt;div class="comment" template-repeat="comments"&gt; &lt;span class="name"&gt;{{author}}&lt;/span&gt;: {{message}} &lt;/div&gt; &lt;/div&gt;</code> <br> <br>   :       template-repeat,  ,     ,   ,   ,   .   ( values  instantiateTemplate)          ,   {{author}}     comment,    . <br> <br>  instantiateTemplate ,    ,    ,     ,          drawTalk. <br> <br>       ,      ,     true  false? <br> <br>    ? <br>  -       JavaScript,     .   - . <br> <br>   -     JavaScript.       ,      .         . <br> <br>   ,   -          JavaScript.     ,       .       ,     . <br> <br>     .    .          ,  ,    ?</code></code> </div><p>Source: <a href="https://habr.com/ru/post/246331/">https://habr.com/ru/post/246331/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../246313/index.html">Understanding paradigms for building domain models</a></li>
<li><a href="../246315/index.html">TeamCity 9.0: import projects, settings in VCS, background cleaning and pandas</a></li>
<li><a href="../246317/index.html">Processing NBA data for 30 years using MongoDB Aggregation</a></li>
<li><a href="../246325/index.html">Overview of graph compression algorithms</a></li>
<li><a href="../246329/index.html">New Year's draw</a></li>
<li><a href="../246339/index.html">Some interesting MySQL features</a></li>
<li><a href="../246341/index.html">IPv6, miredo, dynamic DNS AAAA</a></li>
<li><a href="../246349/index.html">Yeoman for newbies</a></li>
<li><a href="../246351/index.html">Universal messaging between pages in extensions</a></li>
<li><a href="../246353/index.html">Implementation via URL: www.site.ru/?jn=xxxxxxxx</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>