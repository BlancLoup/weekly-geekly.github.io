<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Like MooTools jQuery fence, or detective in the style of Colombo</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="As an obligation to work in Airi, I sometimes sort out website functioning errors at the network / browser level. This usually comes down to a simple ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Like MooTools jQuery fence, or detective in the style of Colombo</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/0f4/1f0/556/0f41f0556075492dba85399340d9339f.png" alt="JQuery / MooTools call stack" align="right">  As an obligation to work in Airi, I sometimes sort out website functioning errors at the network / browser level.  This usually comes down to a simple analysis of request-response headers and the reproduction of trivial conditions.  But sometimes there are interesting cases. <br><br>  It all started on a cold February evening.  The client wrote about a strange problem while speeding up the site: the slide show multiplied and blocked the site‚Äôs behavior, the pages were not available.  Two days after finding out all the details, I found out why Mootools and jQuery absolutely cannot be used together.  And it was confirmed in the thought that ‚Äúalcohol is evil‚Äù and ‚Äúeval is evil‚Äù. <br><br>  But first things first. <br><a name="habracut"></a><br><h2>  We find out the root of troubles </h2><br>  At the moment, browsers now have a sufficient number of profiling tools (even, one might say, this number is somewhat redundant), allowing to fix the problem area, reproduce the error and eliminate it.  This is primarily: <br><ul><li>  Network Toolbar in Developer Tools: it displays all requests legitimately transmitted by the browser, with all the headers and responses.  If we are not talking about some kind of traffic encryption and we need standard information about requests (headers, status, size), then it is more than enough. </li><li>  Console (bugs) in developer tools.  In the event of a problem, you can see both the cause of the error and the callback stack.  And also repeat the behavior of the browser when executing the code. </li><li>  DOM tree and site source code.  It is not always clear which properties were set, and which properties were dynamically applied to HTML elements.  But you can always see the information "first-hand" - from the browser. </li></ul><br>  If we were talking about a simple error tracing, then this article could have been completed.  But the error was not easy, but recursive.  And the browser tab ‚Äúfell‚Äù a few seconds after the page was loaded, leaving the following error in the error console: <br><div class="spoiler">  <b class="spoiler_title">Call stack</b> <div class="spoiler_text"><blockquote><pre>  c.Request.Class.send @ mootools-core.js: 182
 i.extend. $ owner @ mootools-core.js: 50
 Element.implement.load @ mootools-core.js: 187
 st.event.trigger @ jquery.js: 2989
 (anonymous function) @ jquery.js: 3639
 st.extend.each @ jquery.js: 642
 st.fn.st.each @ jquery.js: 263
 st.fn.extend.trigger @ jquery.js: 3638
 st.fn. (anonymous function) @ jquery.js: 3662
 st.fn.load @ jquery.js: 7498
 (anonymous function) @ jquery.bxslider.js: 11
 st.extend.each @ jquery.js: 642
 st.fn.st.each @ jquery.js: 263
 (anonymous function) @ jquery.bxslider.js: 11
 st.extend.each @ jquery.js: 642
 st.fn.st.each @ jquery.js: 263
 loadElements @ jquery.bxslider.js: 11
 setup @ jquery.bxslider.js: 11
 init @ jquery.bxslider.js: 6
 $ .fn.bxSlider @ jquery.bxslider.js: 52
 (anonymous function) @ VM375: 2
 f @ jquery.js: 1026
 p.fireWith @ jquery.js: 1138
 st.extend.ready @ jquery.js: 427
 xt @ jquery.js: 97 </pre></blockquote></div></div><br>  On the website, this was displayed in a repeating slider (multiple arrows on the right and left are several copies of the slider, superimposed on each other due to an error): 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/files/7b5/201/131/7b5201131071456c8101f9761e829421.png" alt="Bxslider slider error"><br><br><h2>  Lyrical digression </h2><br>  It should be said that both MooTools and jQuery came to the site in a compressed form.  However, to jQuery was <a href="http://habrahabr.ru/post/148098/">a source map (source map)</a> , which greatly facilitated the search for the last (= guilty). <br><br>  The source map is an extremely useful thing in debugging compressed code, the third specification has already been released, reducing the size of the card several times.  If you hear about the source map for the first time, I advise you to pay attention to it.  But we move on. <br><br><h2>  Digging deep </h2><br>  In any problem, it is important to highlight the minimum conditions that still lead to the occurrence of the problem (but without additional data), and analyze these conditions sequentially.  As it turned out, the minimum condition for stable reproduction of the problem was the presence of inline JavaScript code in the HTML page.  Caching mechanisms in the browser and with internet providers can prevent simple conclusions, so when working with public unencrypted HTML pages, you need to clearly formulate and re-check conditions several times to be sure of them. <br><br>  But why did the inclusion of JavaScript code in HTML lead to its recursive execution in the browser?  Yandex and Google do not know anything about such situations.  Need to help him. <br><br><h2>  Hypotheses: not enough </h2><br><img src="https://habrastorage.org/getpro/habr/post_images/4b9/0c1/819/4b90c18199c10e1760cd09f5c503ce3f.jpg" alt="Hypotheses" align="right">  On the one hand, everything is clear: JavaScript inline-code is executed recursively, it can not be used on this site.  On the other hand: what exactly leads to recursive inline-code execution? <br><br>  Understand helps call stack (listing above).  Bxslider ( <code>Written while drinking Belgian ales and listening to jazz</code> - the Belgian ale definitely prevented the author from predicting some non-standard scenarios) on each object (in our case, the picture) caused the load property, which was processed via jQuery approximately as follows: <br><br><div class="spoiler">  <b class="spoiler_title">JQuery event handling</b> <div class="spoiler_text"><blockquote><pre>  jQuery.event.triggered = type;
 try {
	 elem [type] ();
 } catch (e) {
	 // IE &lt;9 dies on focus / blur to hidden element (# 1486, # 12518)
	 // only reproducible on winXP IE8 native, not IE9 in IE8 mode
 } </pre></blockquote></div></div><br>  It seems everything is clear: jQuery calls the native method of the element, as soon as we‚Äôve finished with the rest of the wrapper.  In this case, it is <code>img["load"]()</code> .  What should lead to the completion of the load event on the image, it must rely on the browser cache, and everyone should be happy.  But the MooTools library does not agree with this situation: <br><br><div class="spoiler">  <b class="spoiler_title">Handling load MooTools</b> <div class="spoiler_text"><blockquote><pre>  Element.Properties.load = {
	 set: function (a) {
		 var b = this.get ("load"). cancel ();
		 b.setOptions (a);
		 return this;
	 },
	 get: function () {
		 var a = this.retrieve ("load");
		 if (! a) {
			 a = new Request.HTML ({data: this, link: "cancel", update: this, method: "get"});
			 this.store ("load", a);
		 }
		 return a
	 }
 }; </pre></blockquote></div></div><br>  MooTools <code>load</code> method understands its own way.  And in the absence of information about the object, the object is loaded via <code>new Request.HTML</code> .  It seems to be normal too: let's upload the image again, if MooTools has no information about it (after all, the picture has already been loaded into the browser cache, these are just operations in the memory of the local user‚Äôs computer).  But jQuery, when it calls this method on an image, for some reason forgets to pass parameters, in particular, a URL.  Probably, jQuery does not know that after it MooTools will still work, to which these parameters will be needed.  And MooTools without parameters loads an ‚Äúempty‚Äù URL (current page). <br><br>  It also seems to be a valid layout: when the page is loaded, the browser will load it 5 more times from the server (just an HTML document), if 5 pictures are loaded in the slider (this is what happened on the site).  If the page is in the server cache, then performance (almost) is not reflected in any way (and it‚Äôs also not easy to find resources in the developer‚Äôs network toolbar to find these ‚Äúextra‚Äù calls mixed with pictures and counters). <br><br>  But the problem is that by default MooTools executes the <code>eval</code> all scripts in the loaded HTML document.  And this is worse: we can survive the execution of the counter code several times on the site.  And if the DOMReady handler starts running, which loads the slider, which causes images to load, which cause loading the HTML page, which executes all the inline code that starts the DOMReady handler ... Well, you understand. <br><br><h2>  Summary </h2><br>  Do not use multiple JavaScript frameworks together.  Never (for Joomla! There is even a plugin that cuts MooTools from the system).  If suddenly there is a desire - to re-read this article.  The described problem was "on the surface" and was quickly identified.  But there may be situations where the joint behavior of the frameworks will depend on the network (delays and the order of the requests) and the browser used.  And then to find the cause of the problem and fix it is not at all possible. <br><br>  Use <code>eval</code> only in cases where you control the executable code.  If there is no control, there is no eval. <br><br>  Alcohol is evil, el is evil.  Sober lifestyle is our everything. <br><br>  Developer tools in browsers can really give you all the information you need.  You need to be able to use them. </div><p>Source: <a href="https://habr.com/ru/post/249733/">https://habr.com/ru/post/249733/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../249721/index.html">A banal XSS vulnerability on the Fidobank p2p transfer page that allows you to steal cvv2 user code</a></li>
<li><a href="../249723/index.html">Library for embedding electronic signatures in C ++ applications</a></li>
<li><a href="../249725/index.html">Browser Vivaldi - more than 400 thousand downloads</a></li>
<li><a href="../249729/index.html">We invite you to get acquainted with our new page for developers.</a></li>
<li><a href="../249731/index.html">Running Converse.js in conjunction with Bosh punjab on Apache 2.4 and a remote Openfire server or how to tie it to the jabber page from the box</a></li>
<li><a href="../249735/index.html">The problem of diagonal boarders and Firefox</a></li>
<li><a href="../249737/index.html">Possibilities of outdoor 3G / 4G antennas for increasing data transfer speed in mobile networks</a></li>
<li><a href="../249739/index.html">Twitter Bootstrap and SharePoint. How to make Bootstrap work correctly under SP</a></li>
<li><a href="../249743/index.html">Intel¬Æ Graphics Technology. Part I: Almost Gran Turismo</a></li>
<li><a href="../249747/index.html">Yandex.Metro is watching you</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>