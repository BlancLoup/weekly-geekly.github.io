<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Forwarding VLANs over the Internet</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Once the leadership of our organization set the task to include an office in another city in the main corporate network. At the same time, several vir...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Forwarding VLANs over the Internet</h1><div class="post__text post__text-html js-mediator-article">  Once the leadership of our organization set the task to include an office in another city in the main corporate network.  At the same time, several virtual networks (VLANs) were used inside the corporate network - for telephony, database access, equipment management, etc.  For some reason, it was not possible to rent a direct channel for forwarding these VLANs. <br><br>  Since CentOS 6-based machines acted as external routers in both offices, it was decided to use OpenVPN for the transit of internal traffic.  The initial idea of ‚Äã‚Äãa separate tunnel for each VLAN was quickly abandoned due to the low scalability of the solution. <br><br>  The <a href="http://openvswitch.org/">Open vSwitch</a> project came to the rescue - a soft switch with VLAN support (IEEE 802.1q). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/files/fe6/b61/613/fe6b616133454badaefc9d4030a80591.png"><br>  <i>The scheme of the virtual network.</i> <br><a name="habracut"></a><br><h3>  OpenVPN Tuning Configuration </h3><br>  There is a lot of information on setting up OpenVPN on the <a href="https://www.google.com/search%3Fq%3Dopenvpn%2Bcentos%2B6">network</a> and on <a href="http://habrahabr.ru/search/%3Fq%3Dopenvpn">Habr√©</a> , so I‚Äôll immediately provide a configuration with some comments. <br><br><div class="spoiler">  <b class="spoiler_title">OpenVPN Server Configuration</b> <div class="spoiler_text">  local WXYZ <br>  dev tap <br><br>  ca /etc/openvpn/keys/ca.crt <br>  cert /etc/openvpn/keys/server.crt <br>  key /etc/openvpn/keys/server.key <br>  dh /etc/openvpn/keys/dh1024.pem <br><br>  tls-server <br>  tls-auth /etc/openvpn/keys/ta.key 0 <br><br>  keepalive 10 60 <br>  ping-timer-rem <br>  persist tun <br>  persist-key <br>  daemon <br><br>  user nobody <br>  group nobody <br><br>  up /etc/openvpn/bridge.sh </div></div><div class="spoiler">  <b class="spoiler_title">OpenVPN client configuration</b> <div class="spoiler_text">  client <br>  dev tap <br>  remote WXYZ <br><br>  nobind <br><br>  ca /etc/openvpn/keys/ca.crt <br>  cert /etc/openvpn/keys/client.crt <br>  key /etc/openvpn/keys/client.key <br>  tls-auth /etc/openvpn/keys/ta.key 1 <br><br>  keepalive 10 60 <br>  ping-timer-rem <br>  persist tun <br>  persist-key <br>  daemon <br>  resolv-retry infinite <br><br>  user nobody <br>  group nobody <br><br>  up /etc/openvpn/bridge.sh </div></div><div class="spoiler">  <b class="spoiler_title">Script bridge.sh</b> <div class="spoiler_text">  #! / bin / bash <br><br>  / usr / bin / ovs-vsctl del-port ovs0 $ 1 <br>  / usr / bin / ovs-vsctl add-port ovs0 $ 1 trunks = 1996,1997,1998,1999 <br>  / sbin / ip link set $ 1 up </div></div><br>  A tap device is used to transmit ethernet frames. <br><br>  The bridge.sh script is used to make a network tap device into a virtual switch (ovs).  When restarting an OpenVPN daemon, it is necessary to bring the tap device into the switch and re-enter it; without this crutch, the traffic from the virtual switch does not reach it.  This problem has not yet been resolved beautifully. <br>  As it is not difficult to guess, the tunks parameter describes the ability of the virtual port to transmit the tagged traffic of the specified vlans. <br><br><h3>  Configure open vSwitch </h3><br>  In most modern distros open vSwitch is already present entirely.  At CentOS 6, there is only a kernel module.  You will have to search for a package with a virtual switch daemon in third-party repositories, or build it yourself.  Information on <a href="http://n40lab.wordpress.com/2013/06/03/centos-6-4-openvswitch-installation/">assembling the package</a> in the network is sufficient; this process should not cause any difficulties.  After installing and running the daemon, you need to create a virtual switch device.  For this, a configuration file of the ifcfg-ovs0 interface is created: <br><br><pre><code class="hljs pgsql">DEVICE=ovs0 ONBOOT=yes DEVICETYPE=ovs <span class="hljs-keyword"><span class="hljs-keyword">TYPE</span></span>=OVSBridge BOOTPROTO=static HOTPLUG=<span class="hljs-keyword"><span class="hljs-keyword">no</span></span></code> </pre> <br>  what corresponds to the team <br><pre> <code class="hljs cs">ovs-vsctl <span class="hljs-keyword"><span class="hljs-keyword">add</span></span>-br ovs0</code> </pre> <br><br><h3>  Interface Configuration </h3><br>  Configuring the ports of the virtual switch is practically no different from the settings of conventional system network interfaces.  To add the interface to the switch, the ifcfg-eth0.197 interface configuration file is created: <br><br><pre> <code class="hljs pgsql">PHYSDEVICE=eth0 DEVICE=eth0<span class="hljs-number"><span class="hljs-number">.197</span></span> ONBOOT=yes DEVICETYPE=ovs <span class="hljs-keyword"><span class="hljs-keyword">TYPE</span></span>=OVSPort OVS_BRIDGE=ovs0 OVS_OPTIONS="tag=197" BOOTPROTO=<span class="hljs-keyword"><span class="hljs-keyword">none</span></span> HOTPLUG=<span class="hljs-keyword"><span class="hljs-keyword">no</span></span></code> </pre><br>  What corresponds to the command: <br><br><pre> <code class="hljs cs">ovs-vsctl <span class="hljs-keyword"><span class="hljs-keyword">add</span></span>-port ovs0 eth0<span class="hljs-number"><span class="hljs-number">.197</span></span></code> </pre> <br>  I note that when adding an interface to a virtual switch, the ip-address of this interface is no longer accessible.  If you need to use the ip address on this VLAN interface in the north, you need to transfer it to the virtual internal port of the switch.  The configuration file ifcfg-vi197 in this case will look like this: <br><br><pre> <code class="hljs pgsql">DEVICE=vi197 ONBOOT=<span class="hljs-keyword"><span class="hljs-keyword">no</span></span> DEVICETYPE=ovs <span class="hljs-keyword"><span class="hljs-keyword">TYPE</span></span>=OVSIntPort BOOTPROTO=static IPADDR=<span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.120</span></span><span class="hljs-number"><span class="hljs-number">.253</span></span> NETMASK=<span class="hljs-number"><span class="hljs-number">255.255</span></span><span class="hljs-number"><span class="hljs-number">.255</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> OVS_BRIDGE=ovs0 OVS_OPTIONS="tag=197" HOTPLUG=<span class="hljs-keyword"><span class="hljs-keyword">no</span></span> ARPCHECK=<span class="hljs-keyword"><span class="hljs-keyword">no</span></span></code> </pre> <br>  What corresponds to the command: <br><br><pre> <code class="hljs cs">ovs-vsctl <span class="hljs-keyword"><span class="hljs-keyword">add</span></span>-port ovs0 vi197 tag=<span class="hljs-number"><span class="hljs-number">197</span></span> -- <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> Interface vi197 type=<span class="hljs-keyword"><span class="hljs-keyword">internal</span></span></code> </pre> <br>  By analogy, the remaining interfaces of VLANs are created. <br><br>  You can view the current state of the virtual switch ports with the command: <br><br><pre> <code class="hljs pgsql">ovs-vsctl <span class="hljs-keyword"><span class="hljs-keyword">show</span></span></code> </pre> <br>  In my case, the configuration was as follows: <br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="hljs vhdl"> Bridge <span class="hljs-string"><span class="hljs-string">"ovs0"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Port</span></span> <span class="hljs-string"><span class="hljs-string">"eth0.198"</span></span> tag: <span class="hljs-number"><span class="hljs-number">198</span></span> Interface <span class="hljs-string"><span class="hljs-string">"eth0.198"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Port</span></span> <span class="hljs-string"><span class="hljs-string">"eth0.197"</span></span> tag: <span class="hljs-number"><span class="hljs-number">197</span></span> Interface <span class="hljs-string"><span class="hljs-string">"eth0.197"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Port</span></span> <span class="hljs-string"><span class="hljs-string">"vi198"</span></span> tag: <span class="hljs-number"><span class="hljs-number">198</span></span> Interface <span class="hljs-string"><span class="hljs-string">"vi198"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">type</span></span>: internal <span class="hljs-keyword"><span class="hljs-keyword">Port</span></span> <span class="hljs-string"><span class="hljs-string">"eth0.199"</span></span> tag: <span class="hljs-number"><span class="hljs-number">199</span></span> Interface <span class="hljs-string"><span class="hljs-string">"eth0.199"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Port</span></span> <span class="hljs-string"><span class="hljs-string">"ovs0"</span></span> Interface <span class="hljs-string"><span class="hljs-string">"ovs0"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">type</span></span>: internal <span class="hljs-keyword"><span class="hljs-keyword">Port</span></span> <span class="hljs-string"><span class="hljs-string">"tap0"</span></span> trunks: [<span class="hljs-number"><span class="hljs-number">1996</span></span>, <span class="hljs-number"><span class="hljs-number">1997</span></span>, <span class="hljs-number"><span class="hljs-number">1998</span></span>, <span class="hljs-number"><span class="hljs-number">1999</span></span>] Interface <span class="hljs-string"><span class="hljs-string">"tap0"</span></span> ovs_version: <span class="hljs-string"><span class="hljs-string">"2.3.0"</span></span></code> </pre> </div></div><br><br><h3>  Conclusion </h3><br>  As a result, we get the passage of tagged traffic over an encrypted channel via the Internet. <br><br>  The solution turned out to be easily scalable; it is easy to add both new VLANs and new remote networks. <br><br>  PS: Instead of OpenVPN, you can use the GRE tunnel built into the open vSwitch.  He has not had time to figure it out yet and I am not sure about the possibility of encrypting traffic when using it. </div><p>Source: <a href="https://habr.com/ru/post/239729/">https://habr.com/ru/post/239729/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../239703/index.html">IBM presents an alternative to x86 servers - systems based on OpenPOWER technologies.</a></li>
<li><a href="../239707/index.html">Trilateration with iBeacons, iOS security and VKontakte mobile advertising on #MBLTDev</a></li>
<li><a href="../239713/index.html">Why are Yandex and Mail.ru cheaper, and what does it mean</a></li>
<li><a href="../239719/index.html">Possible future for PHP</a></li>
<li><a href="../239723/index.html">Can IVR ruin customer experience?</a></li>
<li><a href="../239731/index.html">Android launchers. Reload ideas</a></li>
<li><a href="../239733/index.html">Links or content: what is more important for Google? Translation of Matt Cutts Video Responses (Part I)</a></li>
<li><a href="../239737/index.html">Prediction Optimization</a></li>
<li><a href="../239739/index.html">Cray Inc launches new generation of supercomputers Cray X–°40</a></li>
<li><a href="../239741/index.html">How we opened and then closed the online store</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>