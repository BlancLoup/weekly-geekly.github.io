<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Android Volley Loader. Moving toward the library</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Further experiments on crossing Volley and Loader led me to the idea of ‚Äã‚Äãcreating a library. That Loader with parameters and in one line was caused. ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Android Volley Loader. Moving toward the library</h1><div class="post__text post__text-html js-mediator-article">  Further <a href="http://habrahabr.ru/post/254801/">experiments on crossing Volley and Loader</a> led me to the idea of ‚Äã‚Äãcreating a library.  That Loader with parameters and in one line was caused.  On the similarity as it is implemented in Picaso.  After a couple of evenings, something happened ... <br><br>  Json <br><pre><code class="xml hljs">{ "1":{"name":"Samsung","price":51200.6}, "2":{"name":"Lg","price":5400.6}, "3":{"name":"Alcatel","price":4500.6}, "4":{"name":"iPhone","price":4800.3}, "7":{"name":"iPad","price":2850.1} }</code> </pre> <br>  Data <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">GoodsItem</span></span></span><span class="hljs-class"> </span></span>{ String name; <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> price; }</code> </pre><br>  Loader <br><pre> <code class="java hljs"> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String url = <span class="hljs-string"><span class="hljs-string">"http://192.168.1.103/shop.json"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> LOADER_GOODS_ID = <span class="hljs-number"><span class="hljs-number">1</span></span>; Map&lt;Integer, GoodsItem&gt; mGoodsMap; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onCreate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Bundle savedInstanceState)</span></span></span><span class="hljs-function"> </span></span>{ ... FeedLoader.with(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>).addLoader(LOADER_GOODS_ID, url, HashMap.class, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DelivererFeedLoader.Listener&lt;Map&lt;Integer, GoodsItem&gt;&gt;() { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onResponse</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> loaderId, Map&lt;Integer, GoodsItem&gt; goodsMap)</span></span></span><span class="hljs-function"> </span></span>{ mGoodsMap = goodsMap; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (Map.Entry&lt;Integer, GoodsItem&gt; entry : mGoodsMap.entrySet()) { Log.d(TAG , <span class="hljs-string"><span class="hljs-string">"Goods item : "</span></span> + entry.getKey() + <span class="hljs-string"><span class="hljs-string">" : "</span></span> + entry.getValue()); } } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onErrorResponse</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(VolleyError data)</span></span></span><span class="hljs-function"> </span></span>{ Log.d(TAG , <span class="hljs-string"><span class="hljs-string">"onErrorResponse :"</span></span> + data); } }).start(LOADER_GOODS_ID, <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>);</code> </pre><br><a name="habracut"></a><br><br>  Access to the library is provided through a simple singleton.  Everything is as simple as Picaso 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <div class="spoiler">  <b class="spoiler_title">FeedLoader.with (this)</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> FeedLoader </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">with</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Context context)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (singleton == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">synchronized</span></span> (FeedLoader.class) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (singleton == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { singleton = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FeedLoader(context); } } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> singleton; }</code> </pre><br></div></div><br>  Adding Types and Listner is done via addLoader: <br>  <b>loaderId</b> - loader ID, just a number <br>  <b>url</b> - feed address <br>  <b>loaderClazz</b> - This is the type of class that we want to parse. <br>  <b>DelivererFeedLoader.Listener</b> - Callback through which data will return or an error <br><pre> <code class="java hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> FeedLoader </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">addLoader</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> loaderId, String url, Class&lt;?&gt; loaderClazz, DispatcherData.Listener callback)</span></span></span></span>{ dispatcherData.putLoaderClazz(loaderId, loaderClazz); dispatcherData.putCallBack(loaderId, callback); dispatcherData.putUrlFeed(loaderId, url); dispatcherData.putUseCache(loaderId, <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); <span class="hljs-comment"><span class="hljs-comment">// default return singleton; }</span></span></code> </pre><br>  Launch Loader via start (...): <br><pre> <code class="java hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">start</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> loaderId, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> FragmentActivity activity)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span> activity <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> FragmentActivity : <span class="hljs-string"><span class="hljs-string">"Run possible only from FragmentActivity"</span></span>; Bundle bundle = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Bundle(); bundle.putParcelable(<span class="hljs-string"><span class="hljs-string">"dispatcherData"</span></span>, dispatcherData); activity.getSupportLoaderManager(). restartLoader(loaderId, bundle, callback); } }</code> </pre><br>  Actually four Alfa implementation files <br><div class="spoiler">  <b class="spoiler_title">FeedLoader.java</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> net.appz.feedloader; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> android.content.Context; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> android.os.Bundle; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> android.support.v4.app.FragmentActivity; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> android.support.v4.app.LoaderManager; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> android.support.v4.content.Loader; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> android.util.Log; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.android.volley.Response; <span class="hljs-comment"><span class="hljs-comment">/** * Created by App-z.net on 04.04.15. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FeedLoader</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">volatile</span></span> FeedLoader singleton = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Context context = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">boolean</span></span> DEBUG = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String TAG = getClass().getSimpleName(); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> DispatcherData dispatcherData = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DispatcherData(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">FeedLoader</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Context context)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (context == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IllegalArgumentException(<span class="hljs-string"><span class="hljs-string">"Context must not be null."</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.context = context.getApplicationContext(); } LoaderManager.LoaderCallbacks&lt;Response&lt;Object&gt;&gt; callback = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> LoaderManager.LoaderCallbacks&lt;Response&lt;Object&gt;&gt;() { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Loader&lt;Response&lt;Object&gt;&gt; onCreateLoader(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> id, Bundle args) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FeedLoaderWrapper(context , args); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onLoadFinished</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Loader&lt;Response&lt;Object&gt;&gt; loader, Response&lt;Object&gt; data)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( data.isSuccess() ) dispatcherData.onResponse(loader.getId(), data.result); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> dispatcherData.onErrorResponse(loader.getId(), data.error); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onLoaderReset</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Loader&lt;Response&lt;Object&gt;&gt; loader)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( DEBUG ) Log.d(TAG, <span class="hljs-string"><span class="hljs-string">"onLoaderReset :"</span></span> + loader.getId()); } }; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> FeedLoader </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">addLoader</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> loaderId, String url, Class&lt;?&gt; loaderClazz, DispatcherData.Listener callback)</span></span></span></span>{ dispatcherData.putLoaderClazz(loaderId, loaderClazz); dispatcherData.putCallBack(loaderId, callback); dispatcherData.putUrlFeed(loaderId, url); dispatcherData.putUseCache(loaderId, <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); <span class="hljs-comment"><span class="hljs-comment">// default return singleton; } public void start(int loaderId, final FragmentActivity activity) { assert activity instanceof FragmentActivity : "Run possible only from FragmentActivity"; Bundle bundle = new Bundle(); bundle.putParcelable("dispatcherData", dispatcherData); activity.getSupportLoaderManager(). restartLoader(loaderId, bundle, callback); } public void destroy(int loaderId, final FragmentActivity activity) { assert activity instanceof FragmentActivity : "Run possible only from FragmentActivity"; activity.getSupportLoaderManager().destroyLoader(loaderId); } public static FeedLoader with(Context context) { if (singleton == null) { synchronized (FeedLoader.class) { if (singleton == null) { singleton = new FeedLoader(context); } } } return singleton; } public FeedLoader useCache(int loaderId) { dispatcherData.putUseCache(loaderId, true); return singleton; } public FeedLoader resetCache(int loaderId) { dispatcherData.putUseCache(loaderId, false); return singleton; } }</span></span></code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">FeedLoaderWrapper.java</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> net.appz.feedloader; <span class="hljs-comment"><span class="hljs-comment">/** * Created by App-z.net on 05.04.15. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> android.content.Context; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> android.os.Bundle; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> android.support.v4.content.Loader; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> android.util.Log; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.android.volley.RequestQueue; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.android.volley.Response; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.android.volley.VolleyError; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.android.volley.toolbox.Volley; <span class="hljs-comment"><span class="hljs-comment">//http://www.androiddesignpatterns.com/2012/08/implementing-loaders.html /** * * * * @param &lt;D&gt; */ class FeedLoaderWrapper&lt;D&gt; extends Loader&lt;Response&lt;D&gt;&gt; { private boolean DEBUG = true; private String TAG = getClass().getSimpleName(); private DispatcherData dispatcherData; private RequestQueue requestQueue; private Response&lt;D&gt; mCachedResponse; /** * Stores away the application context associated with context. * Since Loaders can be used across multiple activities it's dangerous to * store the context directly; always use {@link #getContext()} to retrieve * the Loader's Context, don't use the constructor argument directly. * The Context returned by {@link #getContext} is safe to use across * Activity instances. * * @param context used to retrieve the application context. */ public FeedLoaderWrapper(Context context, Bundle bundle) { super(context); dispatcherData = bundle.getParcelable("dispatcherData"); requestQueue = Volley.newRequestQueue(context); // run only once onContentChanged(); } /** * Get Data */ private void doRequest(Class&lt;?&gt; clazz) { final boolean useCache = dispatcherData.getUseCache(getId()); if (DEBUG) Log.i(TAG, "useCache : " + getId() + " : " + useCache); final String urlFeed = dispatcherData.getUrlFeed(getId()); if ( !useCache ) requestQueue.getCache().remove(urlFeed); final GsonRequest gsonRequest = new GsonRequest(urlFeed, clazz, null, useCache, new Response.Listener&lt;D&gt;() { @Override public void onResponse(D data) { mCachedResponse = Response.success(data, null); deliverResult(mCachedResponse); } }, new Response.ErrorListener() { @Override public void onErrorResponse(VolleyError volleyError) { mCachedResponse = Response.error(volleyError); deliverResult(mCachedResponse); } }); requestQueue.add(gsonRequest); } @Override public void deliverResult(Response&lt;D&gt; data) { if (isReset()) { // The Loader has been reset; ignore the result and invalidate the data. //releaseResources(data); if (DEBUG) Log.i(TAG, "Loader deliverResult() isReset()"); return; } // Hold a reference to the old data so it doesn't get garbage collected. // We must protect it until the new data has been delivered. Response&lt;D&gt; oldData = mCachedResponse; mCachedResponse = data; if (isStarted()) { // If the Loader is in a started state, deliver the results to the // client. The superclass method does this for us. super.deliverResult(data); if (DEBUG) Log.i(TAG, "Loader deliverResult() isStarted()"); } if (DEBUG) Log.i(TAG, "Loader deliverResult()"); } @Override protected void onStartLoading() { if (takeContentChanged()) forceLoad(); } @Override protected void onStopLoading() { if (DEBUG) Log.i(TAG, "Loader onStopLoading()"); requestQueue.cancelAll(this); super.onStopLoading(); } @Override protected void onReset() { if (DEBUG) Log.i(TAG, "Loader onReset()"); requestQueue.cancelAll(this); super.onReset(); } @Override public void onForceLoad() { super.onForceLoad(); String urlFeed = dispatcherData.getUrlFeed(getId()); if (DEBUG) Log.d(TAG, "Loader onForceLoad() : feedUrl = " + urlFeed); doRequest(dispatcherData.getLoaderClazz(getId())); } }</span></span></code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">DispatcherData.java</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> net.appz.feedloader; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> android.os.Parcel; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> android.os.Parcelable; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.android.volley.VolleyError; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.HashMap; <span class="hljs-comment"><span class="hljs-comment">/** * Created by App-z.net on 05.04.15. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DispatcherData</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Parcelable</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> HashMap&lt;Integer, Class&gt; loaderClazzMap = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HashMap&lt;&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> HashMap&lt;Integer, Listener&gt; callBackMap = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HashMap&lt;&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> HashMap&lt;Integer, String&gt; urlFeeds = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HashMap&lt;&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> HashMap&lt;Integer, Boolean&gt; useCache = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HashMap&lt;&gt;(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DispatcherData</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">putUseCache</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> loaderId, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">boolean</span></span></span></span><span class="hljs-function"><span class="hljs-params"> cache)</span></span></span></span>{ useCache.put(loaderId, cache); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getUseCache</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> loaderId)</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> useCache.get(loaderId); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">putCallBack</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> loaderId, Listener callback)</span></span></span></span>{ callBackMap.put(loaderId, callback); } <span class="hljs-comment"><span class="hljs-comment">//Listener getCallBack(int loaderId){ // return callBackMap.get(loaderId); //} void onResponse(int loaderId, Object data){ callBackMap.get(loaderId).onResponse(loaderId, data); } void onErrorResponse(int loaderId, VolleyError error){ callBackMap.get(loaderId).onErrorResponse(error); } String getUrlFeed(int loaderId){ return urlFeeds.get(loaderId); } void putUrlFeed(int loaderId, String url){ urlFeeds.put(loaderId, url); } Class getLoaderClazz(int loaderId){ return loaderClazzMap.get(loaderId); } void putLoaderClazz(int loaderId, Class loaderClazz){ loaderClazzMap.put(loaderId, loaderClazz); } protected DispatcherData(Parcel in) { useCache = (HashMap) in.readValue(HashMap.class.getClassLoader()); loaderClazzMap = (HashMap) in.readValue(HashMap.class.getClassLoader()); callBackMap = (HashMap) in.readValue(HashMap.class.getClassLoader()); urlFeeds = (HashMap) in.readValue(HashMap.class.getClassLoader()); } @Override public int describeContents() { return 0; } @Override public void writeToParcel(Parcel dest, int flags) { dest.writeValue(useCache); dest.writeValue(loaderClazzMap); dest.writeValue(callBackMap); dest.writeValue(urlFeeds); } @SuppressWarnings("unused") public static final Parcelable.Creator&lt;DispatcherData&gt; CREATOR = new Parcelable.Creator&lt;DispatcherData&gt;() { @Override public DispatcherData createFromParcel(Parcel in) { return new DispatcherData(in); } @Override public DispatcherData[] newArray(int size) { return new DispatcherData[size]; } }; public interface Listener&lt;D&gt;{ void onResponse(int loaderId, D data); void onErrorResponse(VolleyError data); } }</span></span></code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">GsonRequest.java</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> net.appz.feedloader; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.android.volley.AuthFailureError; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.android.volley.Cache; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.android.volley.NetworkResponse; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.android.volley.ParseError; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.android.volley.Request; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.android.volley.Response; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.android.volley.toolbox.HttpHeaderParser; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.google.gson.Gson; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.google.gson.JsonSyntaxException; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.io.UnsupportedEncodingException; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.Map; <span class="hljs-comment"><span class="hljs-comment">/** * Created by App-z.net on 29.03.15. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">GsonRequest</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Request</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Gson gson = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Gson(); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Class&lt;T&gt; clazz; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Map&lt;String, String&gt; headers; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Response.Listener&lt;T&gt; listener; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">boolean</span></span> useCache = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; <span class="hljs-comment"><span class="hljs-comment">/** * Make a GET request and return a parsed object from JSON. * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> url URL of the request to make * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> clazz Relevant class object, for Gson's reflection * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> headers Map of request headers */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GsonRequest</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String url, Class&lt;T&gt; clazz, Map&lt;String, String&gt; headers, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">boolean</span></span></span></span><span class="hljs-function"><span class="hljs-params"> useCache, Response.Listener&lt;T&gt; listener, Response.ErrorListener errorListener )</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(Method.GET, url, errorListener); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.clazz = clazz; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.headers = headers; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.listener = listener; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.useCache = useCache; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Map&lt;String, String&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getHeaders</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> AuthFailureError </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> headers != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> ? headers : <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.getHeaders(); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">deliverResponse</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(T response)</span></span></span><span class="hljs-function"> </span></span>{ listener.onResponse(response); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> Response&lt;T&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">parseNetworkResponse</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(NetworkResponse response)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { String json = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> String( response.data, HttpHeaderParser.parseCharset(response.headers)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Response.success( gson.fromJson(json, clazz), useCache ? parseIgnoreCacheHeaders(response) : HttpHeaderParser.parseCacheHeaders(response)); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (UnsupportedEncodingException e) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Response.error(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ParseError(e)); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (JsonSyntaxException e) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Response.error(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ParseError(e)); } } <span class="hljs-comment"><span class="hljs-comment">/** * Extracts a {</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@link</span></span></span><span class="hljs-comment"> Cache.Entry} from a {</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@link</span></span></span><span class="hljs-comment"> NetworkResponse}. * Cache-control headers are ignored. SoftTtl == 3 mins, ttl == 24 hours. * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> response The network response to parse headers from * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> a cache entry for the given response, or null if the response is not cacheable. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> Cache.<span class="hljs-function"><span class="hljs-function">Entry </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">parseIgnoreCacheHeaders</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(NetworkResponse response)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> now = System.currentTimeMillis(); Map&lt;String, String&gt; headers = response.headers; <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> serverDate = <span class="hljs-number"><span class="hljs-number">0</span></span>; String serverEtag = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; String headerValue; headerValue = headers.get(<span class="hljs-string"><span class="hljs-string">"Date"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (headerValue != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { serverDate = HttpHeaderParser.parseDateAsEpoch(headerValue); } serverEtag = headers.get(<span class="hljs-string"><span class="hljs-string">"ETag"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> cacheHitButRefreshed = <span class="hljs-number"><span class="hljs-number">1</span></span> * <span class="hljs-number"><span class="hljs-number">60</span></span> * <span class="hljs-number"><span class="hljs-number">1000</span></span>; <span class="hljs-comment"><span class="hljs-comment">// in 1 minutes cache will be hit, but also refreshed on background final long cacheExpired = 24 * 60 * 60 * 1000; // in 24 hours this cache entry expires completely final long softExpire = now + cacheHitButRefreshed; final long ttl = now + cacheExpired; Cache.Entry entry = new Cache.Entry(); entry.data = response.data; entry.etag = serverEtag; entry.softTtl = softExpire; entry.ttl = ttl; entry.serverDate = serverDate; entry.responseHeaders = headers; return entry; } }</span></span></code> </pre><br></div></div><br><br>  <a href="https://github.com/app-z/FeedLoader">GitHub project</a> <br>  <a href="https://github.com/stephanenicolas/robospice">RoboSpice</a> <br><br><ul><li>  There are no checks for added parameter errors in FeedLoader yet </li><li>  Query cache added </li></ul></div><p>Source: <a href="https://habr.com/ru/post/254989/">https://habr.com/ru/post/254989/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../254975/index.html">Presentations 27 reports of our conferences on C #</a></li>
<li><a href="../254979/index.html">We write the extension for Chrome "download audio recordings from Vkontakte", part 2</a></li>
<li><a href="../254981/index.html">The digest of interesting materials from the world of web development and IT for the last week ‚Ññ154 (March 30 - April 5, 2015)</a></li>
<li><a href="../254983/index.html">Product Design Digest March 2015</a></li>
<li><a href="../254985/index.html">User videos: Windows 3.11 inside ReactOS</a></li>
<li><a href="../254991/index.html">Digital archeology: how long-lost data is saved</a></li>
<li><a href="../254993/index.html">How we "married" cloud PBX, GSM and realtors (part 4)</a></li>
<li><a href="../254995/index.html">Resuscitation of TP-LINK 3020 router</a></li>
<li><a href="../255001/index.html">Difficult times for free-to-play, a little more about Apple Watch, console revenue - and other news of the week for a mobile developer</a></li>
<li><a href="../255003/index.html">MMAS ant algorithm</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>