<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Singletons and Shared Instances</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Every time when discussing software with other developers, the topic of singletons emerges, especially in the context of WordPress development. I ofte...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Singletons and Shared Instances</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://habrastorage.org/web/edb/37f/5fc/edb37f5fc7c8457ba1ee7c7014a60789.jpg"></p><br><p>  Every time when discussing software with other developers, the topic of singletons emerges, especially in the context of WordPress development.  I often try to explain why they should be avoided, even if they are considered a standard template. </p><br><p>  In this article I will try to reveal the topic of why singletons should never be used in code, and what alternatives are there to solve similar problems. </p><a name="habracut"></a><br><h2 id="chto-takoe-singlton">  What is singleton? </h2><br><p>  Singleton is a design pattern in software development, described in the book <em><a href="http://wiki.c2.com/%3FDesignPatternsBook">Design Patterns: Elements of Reusable Object-Oriented Software</a></em> (by the <a href="http://wiki.c2.com/%3FGangOfFour">Gang of Four</a> ), thanks to which design patterns were spoken of as a software development tool. </p><br><p>  The idea is that you may need to have only one instance of the class and that you provide a global single access point to it. </p><br><p>  It‚Äôs actually just enough to explain and understand, and for many people, Singleton is an easy entry into the world <em>of design patterns</em> , making it the most popular pattern. </p><br><p>  Singleton is popular; it was one of the first templates described and standardized in the book.  How is it that some developers consider it anti-pattern?  Can it really be so bad? </p><br><p>  Yes. </p><br><p>  Yes maybe. </p><br><h2 id="no-singltony-polezny-i-vazhny">  But singletons are useful and important! </h2><br><p>  I noticed that many people confuse two related concepts.  When they say they need a singleton, they actually need to <em>use one instance of the object in different instantiations</em> .  In general, when you create an instance, you create a new instance of this class.  But for some objects you should always use the same shared instance of the object, regardless of where it is used. </p><br><p>  But singleton is <strong>not</strong> the right solution for this. </p><br><p> Confusion caused by the fact that singleton combines <strong>two functions (responsibilities) in one object</strong> .  Suppose there is a singleton to connect to the database.  Let's call it (very ingeniously) <code>DatabaseConnection</code> .  Singleton now has two main functions: </p><br><ol><li>  Connection Management. </li><li>  <code>DatabaseConnection</code> instance management. </li></ol><br><p>  It is because of the second function that people choose singleton, but this task must be solved by another object. </p><br><p>  There is nothing bad in the <em>general instance</em> .  But the object that you want to use for this is not the place for such a restriction. </p><br><p>  Below I will show a few alternatives.  But first I want to tell you what problems Singleton can cause. </p><br><h2 id="problemy-s-singltonom">  Singleton issues </h2><br><h3 id="singlton-i-solid">  Singleton and SOLID </h3><br><p>  First of all, and this may seem more like a theoretical problem, Singlelton violates many of the principles of <a href="https://ru.wikipedia.org/wiki/SOLID_(%25D0%25BE%25D0%25B1%25D1%258A%25D0%25B5%25D0%25BA%25D1%2582%25D0%25BD%25D0%25BE-%25D0%25BE%25D1%2580%25D0%25B8%25D0%25B5%25D0%25BD%25D1%2582%25D0%25B8%25D1%2580%25D0%25BE%25D0%25B2%25D0%25B0%25D0%25BD%25D0%25BD%25D0%25BE%25D0%25B5_%25D0%25BF%25D1%2580%25D0%25BE%25D0%25B3%25D1%2580%25D0%25B0%25D0%25BC%25D0%25BC%25D0%25B8%25D1%2580%25D0%25BE%25D0%25B2%25D0%25B0%25D0%25BD%25D0%25B8%25D0%25B5)">SOLID</a> . </p><br><ul><li>  <strong>S</strong> is <em>the sole responsibility principle</em> .  Obviously, <em>Singleton contradicts it</em> , as mentioned earlier. </li><li>  <strong>O</strong> - the <em>principle of openness / closeness</em> : objects should be open for expansion, but closed for change.  Singleton violates this principle because it controls the access point and returns only itself, not an extension. </li><li>  <strong>L</strong> - <em>Barbara Liskov's principle of substitution</em> : objects can be replaced by instances of their subtypes without changing the code using them.  This is not true in the case of a singleton, because the presence of several different versions of an object means that it is no longer a singleton. </li><li>  <strong>I</strong> - the <em>principle of interface separation</em> : many specialized interfaces are better than one universal.  This is the only principle that Singleton does not violate directly, but only because it does not allow the use of the interface. </li><li>  <strong>D</strong> - the <em>principle of inversion of dependencies</em> : you should depend only on abstractions, and not on something concrete.  Singleton violates it, because in this case it is only possible to depend on a specific instance of a singleton. </li></ul><br><p>  The singleton pattern violates <strong>four of the five</strong> principles of SOLID.  He might have wanted to break the fifth one, if only he could have interfaces ... </p><br><p>  It is easy to say that your code does not work only because of some theoretical principles.  And although, according to my own experience, these principles are the most valuable and reliable guidance that can be relied upon when developing software, I understand that just the words ‚Äúthis is a fact‚Äù sound unconvincing to many.  We must trace the influence of singleton on your daily practice. </p><br><h2 id="ispolzovaniya-shablona-singlton">  Use pattern singleton </h2><br><p>  Here are the shortcomings that can be encountered when dealing with a singleton: </p><br><ul><li><p>  You cannot pass / inject arguments to the constructor.  Since the first call to a singleton actually executes only the constructor and you cannot know in advance which code will first access the singleton, all consuming code needs to use the same set of arguments to pass to the constructor, which is almost impossible in the first place generally meaningless.  As a result, Singleton makes use of the main mechanism of instantiation in OOP languages. </p><br></li><li><p>  You cannot mock away a singleton when testing components that use it.  This makes it almost impossible to correctly unit test, because you will not achieve complete isolation of the code under test.  The problem is not even caused by the logic that you want to test, but by an arbitrary instantiation constraint into which you wrap it. </p><br></li><li><p>  Since singleton is a globally accessible construct that is used by your entire codebase, any encapsulation efforts are in the dust, which causes the same problems as in the case of global variables.  That is, no matter how you try to isolate a singleton in the encapsulated part of the code, any other external code can lead to side effects and bugs in the singleton.  And without proper encapsulation, the principles of the PLO are emasculated. </p><br></li><li><p>  If you have ever had a website or application that has grown so large that the <code>DatabaseConnection</code> singleton suddenly needed to connect to a second database different from the first one, it means you're in trouble.  We'll have to re-examine the architecture itself and, possibly, completely rewrite a significant part of the code. </p><br></li><li><p>  All tests that directly or indirectly use singleton cannot correctly switch from one to another.  They always save state through a singleton, which can lead to unexpected behavior where your tests depend on the launch sequence, or the remaining state will hide real bugs from you. </p><br></li><li>  Singleton instantiation is enforced by applying singleton to the current process space, which is suitable for a static scope.  This means problems with parallelization when you have multiple processes or distributed execution.  This should allude to the likelihood that singletons are just an erroneous concept that breaks down as soon as you start working in a distributed system. </li></ul><br><h2 id="alternativy-singltonu">  Alternatives to Singleton </h2><br><p>  I do not want to be the person who sees the bad in everything, but cannot offer a solution to the problem.  Although I believe that you should evaluate the entire application architecture to decide how to avoid using singleton first, I suggest some of the most common ways in WordPress, when a singleton can be easily replaced by a mechanism that meets all requirements and is free from most of the drawbacks.  But before I talk about this, I want to point out why all my proposals are just a compromise. </p><br><p>  There is an ‚Äúideal structure‚Äù for application development.  Theoretically, the best option is the only instantiating call in the boot code that creates the entire dependency tree of the application, from top to bottom.  It will work like this: </p><br><ol><li>  Instantiating the <code>App</code> (need <code>Config</code> , <code>Database</code> , <code>Controller</code> ). </li><li>  Instantiation of <code>Config</code> for implementation in the <code>App</code> . </li><li>  Instantiation of <code>Database</code> for implementation in <code>App</code> . </li><li>  Instantiation of the <code>Controller</code> for implementation in the <code>App</code> (need <code>Router</code> , <code>Views</code> ). </li><li>  Instantiating the <code>Router</code> for implementation in <code>Controller</code> (need <code>HTTPMiddleware</code> ). </li><li>  ... </li></ol><br><p>  With one call, the entire application stack will be built from top to bottom with dependency injection as needed.  The objectives of this approach are: </p><br><ul><li>  Each object has an exact list of the dependencies it needs, and only it must use them.  When something breaks, you can easily isolate the code responsible for it. </li><li>  There is no close connection between the objects; all objects, when using implemented implementations, rely only on interfaces. </li><li>  No global status.  Each individual subtree that is higher in the hierarchy will be correctly isolated from the others, so the developer does not do bugs in module B, modifying module A. </li></ul><br><p>  However, no matter how good it sounds, it‚Äôs not possible to do this in WordPress, since it does not provide a centralized container or implementation mechanism, all plugins / themes are loaded in isolation. </p><br><p>  Keep this in mind as we discuss approaches.  The ideal solution, in which the entire WordPress stack is instantiated through a centralized deployment mechanism, is not available to us, since it requires WordPress Core support.  All the approaches described below are characterized by some common shortcomings such as hiding dependencies by addressing them directly from logic instead of introducing them. </p><br><h2 id="kod-singltona">  Singleton code </h2><br><p>  Sample code using the singleton approach, which we will compare with others: </p><br><pre> <code class="hljs bash">// . final class DatabaseConnection { private static <span class="hljs-variable"><span class="hljs-variable">$instance</span></span>; private <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> <span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span></span>() {} //      . public static <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> <span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_instance</span></span></span></span>() { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( ! isset( self::<span class="hljs-variable"><span class="hljs-variable">$instance</span></span> ) ) { self::<span class="hljs-variable"><span class="hljs-variable">$instance</span></span> = new self(); } <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> self::<span class="hljs-variable"><span class="hljs-variable">$instance</span></span>; } //       . public <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> query( ...<span class="hljs-variable"><span class="hljs-variable">$args</span></span> ) { //     . } } //  . <span class="hljs-variable"><span class="hljs-variable">$database</span></span> = DatabaseConnection::get_instance(); <span class="hljs-variable"><span class="hljs-variable">$result</span></span> = <span class="hljs-variable"><span class="hljs-variable">$database</span></span>-&gt;query( <span class="hljs-variable"><span class="hljs-variable">$query</span></span> );</code> </pre> <br><p>  I didn‚Äôt include here all the implementation details with which singletones are often loaded, because they are not important for theoretical discussion. </p><br><h2 id="fabrichnyy-metod">  Factory Method </h2><br><p>  In most cases, the best way to get away from problems associated with a singleton is to use the ‚Äúfactory method‚Äù design pattern.  <em>A factory</em> is an object whose only duty is to instantiate other objects.  Instead of the <code>DatabaseConnectionManager</code> , which makes its own instance using the <code>get_instance()</code> method, you have a <code>DatabaseConnectionFactory</code> that creates instances of the <code>DatabaseConnection</code> object.  In general, the factory will always produce new copies of the desired object.  But based on the requested object and context, the factory can decide for itself whether to create a new instance or to always share one. </p><br><p>  Given the name of the template, you might think that it looks more like Java code than PHP code, so feel free to deviate from too strict (and lazy) naming conventions and call the factory more creative. </p><br><p>  <em>An example of a factory method:</em> </p><br><pre> <code class="hljs bash">// . final class Database { public <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> get_connection(): DatabaseConnection { static <span class="hljs-variable"><span class="hljs-variable">$connection</span></span> = null; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( null === <span class="hljs-variable"><span class="hljs-variable">$connection</span></span> ) { //     , ,   . <span class="hljs-variable"><span class="hljs-variable">$connection</span></span> = new MySQLDatabaseConnection(); } <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> <span class="hljs-variable"><span class="hljs-variable">$connection</span></span>; } } //    ,            (mock)  . interface DatabaseConnection { public <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> query( ...<span class="hljs-variable"><span class="hljs-variable">$args</span></span> ); } //     . final class MySQLDatabaseConnection implements DatabaseConnection { public <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> query( ...<span class="hljs-variable"><span class="hljs-variable">$args</span></span> ) { //     . } } //  . <span class="hljs-variable"><span class="hljs-variable">$database</span></span> = ( new Database )-&gt;get_connection(); <span class="hljs-variable"><span class="hljs-variable">$result</span></span> = <span class="hljs-variable"><span class="hljs-variable">$database</span></span>-&gt;query( <span class="hljs-variable"><span class="hljs-variable">$query</span></span> );</code> </pre> <br><p>  As you can see, the consuming code is not so large and simple, only there is one nuance.  We decided to call <em>the</em> <code>Database</code> <em>factory</em> instead of <code>DatabaseConnection</code> , since this is part of the API that we provide, and we should always strive for a balance between logical accuracy and elegant brevity. </p><br><p>  The above version of the factory is free from almost all the previously described shortcomings, with one exception. </p><br><ul><li>  We removed the close relationship with the <code>DatabaseConnection</code> object, but instead created a new one with a factory.  This is not problematic, because the factory is a pure abstraction, the likelihood that at some point you will need to move away from the concept of ‚Äúinstantiation‚Äù is very small.  If this happens, then you may have to reconsider the entire paradigm of the PLO. </li></ul><br><p>  You are probably starting to wonder that we can no longer forcibly confine ourselves to a single instantiation.  Although we always give away a generic instance of the <code>DatabaseConnection</code> implementation, anyone can still run <code>new MySOLDatabaseConnection</code> and gain access to the additional instance.  Yes, it is, and this is one of the reasons for the rejection of the singleton.  But this does not always give advantages in real-life tasks, since it makes impossible the observance of basic requirements such as unit testing. </p><br><h2 id="statichnye-zamestiteli">  Static alternates </h2><br><p>  Static Proxy is another design pattern for which you can change a singleton.  It implies an even closer connection than a factory, but this is at least a connection with abstraction, and not with a specific implementation.  The idea is that you have a static mapping of the interface, and these static calls are redirected to the concrete implementation transparently.  Thus, there is no direct connection with the actual implementation, and the <em>static Deputy</em> decides for himself how to choose the implementation to use. </p><br><pre> <code class="hljs bash">//  . final class Database { public static <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> get_connection(): DatabaseConnection { static <span class="hljs-variable"><span class="hljs-variable">$connection</span></span> = null; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( null === <span class="hljs-variable"><span class="hljs-variable">$connection</span></span> ) { // You can have arbitrary logic <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> here to decide what // implementation to use. <span class="hljs-variable"><span class="hljs-variable">$connection</span></span> = new MySQLDatabaseConnection(); } <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> <span class="hljs-variable"><span class="hljs-variable">$connection</span></span>; } public static <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> query( ...<span class="hljs-variable"><span class="hljs-variable">$args</span></span> ) { // Forward call to actual implementation. self::get_connection()-&gt;query( ...<span class="hljs-variable"><span class="hljs-variable">$args</span></span> ); } } //    ,            (mock)  . interface DatabaseConnection { public <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> query( ...<span class="hljs-variable"><span class="hljs-variable">$args</span></span> ); } //     . final class MySQLDatabaseConnection implements DatabaseConnection { public <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> query( ...<span class="hljs-variable"><span class="hljs-variable">$args</span></span> ) { //     . } } //  . <span class="hljs-variable"><span class="hljs-variable">$result</span></span> = Database::query( <span class="hljs-variable"><span class="hljs-variable">$query</span></span> );</code> </pre> <br><p>  As you can see, the <em>static Deputy</em> creates a very short and clean API.  The disadvantages include the fact that there is a close connection between the code and the class signature.  When used in the right place, this does not cause any special problems, since this is a connection with abstraction, which can be controlled directly, and not with a specific implementation.  You can still replace the code of one database with the code of another, which you consider necessary, and the implementation is still a completely normal object that can be tested. </p><br><h2 id="api-wordpress-plugin">  API WordPress Plugin </h2><br><p>  The WordPress Plugin API can replace singletones when they are used to enable global access via plugins.  This is the cleanest solution given the limitations of WordPress, with the proviso that the entire infrastructure and architecture of your code is tied to the WordPress Plugin API.  Do not use this method if you are going to re-use your code in different frameworks. </p><br><pre> <code class="hljs bash">//    ,            (mock)  . interface DatabaseConnection { const FILTER = <span class="hljs-string"><span class="hljs-string">'get_database_connection'</span></span>; public <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> query( ...<span class="hljs-variable"><span class="hljs-variable">$args</span></span> ); } //     . class MySQLDatabaseConnection implements DatabaseConnection { public <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> query( ...<span class="hljs-variable"><span class="hljs-variable">$args</span></span> ) { //     . } } //  . <span class="hljs-variable"><span class="hljs-variable">$database</span></span> = new MySQLDatabaseConnection(); add_filter( DatabaseConnection::FILTER, <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> () use ( <span class="hljs-variable"><span class="hljs-variable">$database</span></span> ) { <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> <span class="hljs-variable"><span class="hljs-variable">$database</span></span>; } ); //  . <span class="hljs-variable"><span class="hljs-variable">$database</span></span> = apply_filters( DatabaseConnection::FILTER ); <span class="hljs-variable"><span class="hljs-variable">$result</span></span> = <span class="hljs-variable"><span class="hljs-variable">$database</span></span>-&gt;query( <span class="hljs-variable"><span class="hljs-variable">$query</span></span> );</code> </pre> <br><p>  One of the main tradeoffs is that your architecture is directly tied to the WordPress Plugin API.  If you plan to ever provide the functionality of a plugin for Drupal-sites, then the code will have to be completely rewritten. </p><br><p>  Another possible problem is that you are now dependent on the timing of WordPress interceptors (hooks).  This can lead to timing-related bugs, which are often difficult to reproduce and fix. </p><br><h2 id="service-locator">  Service Locator </h2><br><p>  <em>The service locator</em> is one form of the <em>Inversion of Control Container</em> .  Some sites describe the method as anti-pattern.  On the one hand, this is true, but on the other, as we have already discussed above, all the recommendations proposed here can only be considered as compromises. </p><br><p>  <em>A service locator</em> is a container that provides access to <em>services</em> implemented elsewhere.  The container for the most part is a collection of instances associated with identifiers.  More complex implementations of the <em>service locator</em> can introduce features such as lazy instantiation or generation of surrogates. </p><br><pre> <code class="hljs bash">//     ,        . interface Container { public <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> has( string <span class="hljs-variable"><span class="hljs-variable">$key</span></span> ): bool; public <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> get( string <span class="hljs-variable"><span class="hljs-variable">$key</span></span> ); } //    . class ServiceLocator implements Container { protected <span class="hljs-variable"><span class="hljs-variable">$services</span></span> = []; public <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> has( string <span class="hljs-variable"><span class="hljs-variable">$key</span></span> ): bool { <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> array_key_exists( <span class="hljs-variable"><span class="hljs-variable">$key</span></span>, <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;services ); } public <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> get( string <span class="hljs-variable"><span class="hljs-variable">$key</span></span> ) { <span class="hljs-variable"><span class="hljs-variable">$service</span></span> = <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;services[ <span class="hljs-variable"><span class="hljs-variable">$key</span></span> ]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( is_callable( <span class="hljs-variable"><span class="hljs-variable">$service</span></span> ) ) { <span class="hljs-variable"><span class="hljs-variable">$service</span></span> = <span class="hljs-variable"><span class="hljs-variable">$service</span></span>(); } <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> <span class="hljs-variable"><span class="hljs-variable">$service</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> add( string <span class="hljs-variable"><span class="hljs-variable">$key</span></span>, callable <span class="hljs-variable"><span class="hljs-variable">$service</span></span> ) { <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;services[ <span class="hljs-variable"><span class="hljs-variable">$key</span></span> ] = <span class="hljs-variable"><span class="hljs-variable">$service</span></span>; } } //    ,            (mock)  . interface DatabaseConnection { public <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> query( ...<span class="hljs-variable"><span class="hljs-variable">$args</span></span> ); } //     . class MySQLDatabaseConnection implements DatabaseConnection { public <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> query( ...<span class="hljs-variable"><span class="hljs-variable">$args</span></span> ) { //     . } } //  . <span class="hljs-variable"><span class="hljs-variable">$services</span></span> = new ServiceLocator(); <span class="hljs-variable"><span class="hljs-variable">$services</span></span>-&gt;add( <span class="hljs-string"><span class="hljs-string">'Database'</span></span>, <span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">function</span></span></span></span> () { <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> new MySQLDatabaseConnection(); } ); //  . <span class="hljs-variable"><span class="hljs-variable">$result</span></span> = <span class="hljs-variable"><span class="hljs-variable">$services</span></span>-&gt;get( <span class="hljs-string"><span class="hljs-string">'Database'</span></span> )-&gt;query( <span class="hljs-variable"><span class="hljs-variable">$query</span></span> );</code> </pre> <br><p>  As you might have guessed, the problem of getting a link to the <code>$services</code> instance is not lost.  It can be solved by combining this method with any of the previous three. </p><br><ul><li>  With factory: <br><pre> <code class="hljs coffeescript"><span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">$result</span></span></span><span class="hljs-function"> = </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">new</span></span></span></span><span class="hljs-function"><span class="hljs-params"> ServiceLocator() )</span></span></span><span class="hljs-function">-&gt;</span></span>get( <span class="hljs-string"><span class="hljs-string">'Database'</span></span> )-&gt;query( $query );</code> </pre> </li><li>  With <em>static substitute</em> : <br><pre> <code class="hljs php">$result = Services::get( <span class="hljs-string"><span class="hljs-string">'Database'</span></span> )-&gt;query( $query );</code> </pre> </li><li>  With the WordPress Plugin API: <br><pre> <code class="hljs php">$services = apply_filters( <span class="hljs-string"><span class="hljs-string">'get_service_locator'</span></span> ); $result = $services-&gt;get( <span class="hljs-string"><span class="hljs-string">'Database'</span></span> )-&gt;query( $query );</code> </pre> </li></ul><br><p>  However, there is still no answer to the question of whether a <em>service locator</em> should be used instead of a singleton anti-pattern ... There is a problem with the <em>service locator</em> : it ‚Äúhides‚Äù dependencies.  Imagine a code base that uses the correct implementation of the constructor.  In this case, it is enough to look at the designer of a specific object, and you can immediately understand which object it depends on.  If the object has access to the link to the <em>service locator</em> , then you can bypass this explicit dependency resolution and extract the link (and therefore start to depend) to any object from real logic.  This is what they mean when they say that the <em>service locator</em> "hides" dependencies. </p><br><p>  But, given the context of WordPress, we must accept the fact that from the very beginning we are not able to get the perfect solution.  There is no technical ability to implement proper dependency injection across the entire code base.  This means that in any case we will have to look for a compromise.  <em>The service locator</em> is not an ideal solution, but this template fits well with the legacy context and at least allows you to collect all the ‚Äútrade-offs‚Äù in one place, rather than scatter them around the code base. </p><br><h2 id="vnedrenie-zavisimostey">  Dependency injection </h2><br><p>  If you work only in your own plugin and you do not need to provide access to your objects to other plugins, then you are lucky: you can use real dependency injection to avoid global access to dependencies. </p><br><pre> <code class="hljs bash">//    ,            (mock)  . interface DatabaseConnection { public <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> query( ...<span class="hljs-variable"><span class="hljs-variable">$args</span></span> ); } //     . class MySQLDatabaseConnection implements DatabaseConnection { public <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> query( ...<span class="hljs-variable"><span class="hljs-variable">$args</span></span> ) { //     . } } //        . class Plugin { private <span class="hljs-variable"><span class="hljs-variable">$database</span></span>; public <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> __construct( DatabaseConnection <span class="hljs-variable"><span class="hljs-variable">$database</span></span> ) { <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;database = <span class="hljs-variable"><span class="hljs-variable">$database</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> <span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span></span>() { <span class="hljs-variable"><span class="hljs-variable">$consumer</span></span> = new Consumer( <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;database ); <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> <span class="hljs-variable"><span class="hljs-variable">$consumer</span></span>-&gt;do_query(); } } //  . //         . class Consumer { private <span class="hljs-variable"><span class="hljs-variable">$database</span></span>; public <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> __construct( DatabaseConnection <span class="hljs-variable"><span class="hljs-variable">$database</span></span> ) { <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;database = <span class="hljs-variable"><span class="hljs-variable">$database</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> <span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">do_query</span></span></span></span>() { //     . //           . <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;database-&gt;query( <span class="hljs-variable"><span class="hljs-variable">$query</span></span> ); } } //        . <span class="hljs-variable"><span class="hljs-variable">$database</span></span> = new MySQLDatabaseConnection(); <span class="hljs-variable"><span class="hljs-variable">$plugin</span></span> = new Plugin( <span class="hljs-variable"><span class="hljs-variable">$database</span></span> ); <span class="hljs-variable"><span class="hljs-variable">$result</span></span> = <span class="hljs-variable"><span class="hljs-variable">$plugin</span></span>-&gt;run();</code> </pre> <br><p>   ,    ,         ,    . </p><br><p>            ,  ,   ,       . </p><br><p>   ,    (wiring)       .          <em> </em> ( <em>Dependency Injector</em> ) ( ),               . </p><br><p>   ,         <em> </em> (   /,     ): </p><br><pre> <code class="hljs haskell">//   ,      (resolving)  <span class="hljs-type"><span class="hljs-type">DatabaseConnection</span></span>. $injector-&gt;alias( <span class="hljs-type"><span class="hljs-type">DatabaseConnection</span></span>::<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>, <span class="hljs-type"><span class="hljs-type">MySQLDatabaseConnection</span></span>::<span class="hljs-keyword"><span class="hljs-keyword">class</span></span> ); //   ,    <span class="hljs-type"><span class="hljs-type">DatabaseConnection</span></span>          . $injector-&gt;share( <span class="hljs-type"><span class="hljs-type">DatabaseConnection</span></span>::<span class="hljs-keyword"><span class="hljs-keyword">class</span></span> ); //     <span class="hljs-type"><span class="hljs-type">Plugin</span></span>,          ,   . $plugin = $injector-&gt;make( <span class="hljs-type"><span class="hljs-type">Plugin</span></span>::<span class="hljs-keyword"><span class="hljs-keyword">class</span></span> );</code> </pre> <br><h2 id="kombinacii">  </h2><br><p>    ,        ,     ,      . </p><br><p> ,        ,     ,   : </p><br><ul><li>        <em> </em> . </li><li>   ‚Äî    (service provider),        <em> </em> . </li><li>    ‚Äî&gt;  . </li><li>    ‚Äî&gt;   (service location). </li><li>   ‚Äî&gt;  ,     . </li></ul><br><p>   <a href="https://www.alainschlesser.com/bright-nucleus-architecture/">Bright Nucleus Architecture</a>         . </p><br><h2 id="zaklyuchenie">  Conclusion </h2><br><p>       .          WordPress',      . </p><br><p> ,         ,   ,   ,      . </p><br><p>    ,   ‚Äî   ,   ! </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/334078/">https://habr.com/ru/post/334078/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../334064/index.html">The book "Front-end. Customer development for professionals. Node.js, ES6, REST ¬ª</a></li>
<li><a href="../334066/index.html">10 years of the School of data analysis Yandex</a></li>
<li><a href="../334068/index.html">Release Rust 1.19</a></li>
<li><a href="../334070/index.html">CRM will not save: what to do when the business has outgrown the "box"</a></li>
<li><a href="../334076/index.html">CASL. Authorization for JavaScript applications</a></li>
<li><a href="../334080/index.html">How I cooked CLion</a></li>
<li><a href="../334082/index.html">Advantages of automation: how technology corrects mistakes of store employees</a></li>
<li><a href="../334084/index.html">Getting Started with Docker Ruby on Rails</a></li>
<li><a href="../334086/index.html">PHDays VII Secure Development Section: PDUG Community Meeting Summary</a></li>
<li><a href="../334088/index.html">Student website without cost</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>