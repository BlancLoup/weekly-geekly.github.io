<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Technical recommendations for mailing lists</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="‚ÄúEven if you receive any letter, you cannot read it.‚Äù 
 (Mark Twain) 

 We have already written about how to properly do mailings, improve their quali...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Technical recommendations for mailing lists</h1><div class="post__text post__text-html js-mediator-article"><a href="http://habrahabr.ru/company/mailru/blog/239963/"><img src="https://habrastorage.org/files/cd9/119/b9b/cd9119b9bec94685ab6d1f4b89061488.jpg"></a> <br><br>  <i>‚ÄúEven if you receive any letter, you cannot read it.‚Äù</i> <br>  <i>(Mark Twain)</i> <br><br>  We have already written about how to properly do mailings, improve their quality and effectiveness.  They cited metrics, on the basis of which the reputation of the sender is built.  They <a href="http://postmaster.mail.ru/">talked</a> about the interface <a href="http://postmaster.mail.ru/">Postmaster Mail.Ru</a> , with which they can be monitored.  Many companies, both at the beginning of their development and rather large ones, neglect these rules, as a result of which problems start with the deliverability of letters, proceedings with technical support service, etc.  But we hope that you are not one of them. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      So, your project is gaining popularity and users like it, you are going to stay in touch with them.  You have read the administrative requirements (about which we <a href="http://habrahabr.ru/company/mailru/blog/216535/">wrote earlier</a> ) and are going to organize a mailing list responsibly and without spam for those users who are ready to receive it.  Or maybe you're just going to set up corporate email.  You pick up a mail server from a distribution kit, write a script, launch it and ... 70% of recipients did not deliver the letter, 15% had it in the Spam folder, and the rest cannot read what is written in it.  I will try to tell about what to do to prevent this from happening in this article. <br><a name="habracut"></a><br>  Why is it all can not work out of the box and need some additional recommendations?  E-mail is one of the oldest Internet protocols, which has survived to this day with virtually no changes, but it has acquired a huge number of related standards and no documented application practices anywhere.  The e-mail standards themselves do not include any method of authenticating the sender or preventing unwanted mailings and spam.  Therefore, any mail server performs a number of additional checks in order to weed out unwanted correspondence (which may be more than 90%). <br><br>  We have compiled a list of tips that will help pass these additional checks.  Many of the recommendations listed below are not mandatory, but the more of them you follow, the higher the likelihood that there will be no problems with the delivery of letters. <br><br>  <b>Recommendations for the mail server administrator:</b> <br><br>  We start with ... IP addresses.  You received an IP address (or a whole network) from a provider, hoster, or registrar.  What should I do to use the selected address for the mail server, and is it valid? <br><br>  <b>1.</b> Make sure the address is real and static. <br>  Most mail servers restrict the reception of mail from dynamic addresses or from networks with address translation.  The reason is that in such networks there are end-user computers that do not perform mail delivery.  Accordingly, almost all mail that comes from these networks is spam sent through bots.  Therefore, the reputation of these networks is hopelessly flawed. <br><br>  <b>2.</b> Check whois information using whois utility or online services (easy to find).  I will give a list of what you need to pay attention to: <br>  <b>2.1</b> The network must have a valid description.  If the description contains information that is dynamic or intended to be distributed to end individual users (for example, an ADSL network), you will most likely also encounter many problems when trying to use it. <br>  <b>2.2</b> For the network, abuse-contact contacts should be indicated, and these contacts should be live and responsive.  Otherwise, the network (and with it your IP) has a big chance of ‚Äúflying into‚Äù black lists if there are spam incidents from any of its hosts. <br>  <b>2.3</b> If the network is European (RIPE recorder), the status of the network must be ASSIGNED, ASSIGNED PA or ASSIGNED PI - this means that this network is in use.  Many registrars forget to mark the network as used, and some recipients prohibit receiving mail from unused networks. <br>  Ask the registrar to enter the correct information in the network description, but remember that many potential recipients already ‚Äúremember‚Äù the old information.  Therefore, it is better to initially use IP addresses from conscientiously administered networks with a good reputation. <br><br>  <b>3.</b> Check and configure the PTR record for the IP address.  The PTR record must point to the real host name.  It is desirable that <br>  <b>3.1</b> This name did not resemble the name of a dynamic host, that is, it did not contain the words dynamic, adsl, nat, long sequences of characters or groups of digits.  For example, server.example.com is a good, valid PTR record. <br>  <b>3.2</b> If a really large amount of outgoing mail from several servers is planned, then it is advisable to name the servers in accordance with the draft standard " <a href="http://tools.ietf.org/html/draft-lorenzen-marid-mxout-00">DNS Naming Convention for Outbound Internet Email Servers</a> " and create the zone and A-record mxout provided by this document. <br>  <b>3.3</b> The name of the PTR record must be resolved back to the same IP address, that is, an A or CNAME record server.example.com must exist and be resolved to the IP address of the server from the example. <br>  If the server will support multiple domains, there is no need to make PTR-records in each domain - one entry for any of the domains is enough.  When checking DNS, it is better to use a third-party DNS server to make sure that the records are really visible from the outside. <br>  PTR records are managed by an IP network operator, for example, an Internet or hosting provider.  Usually this can be done independently through the hosting control panel or the support service of the provider. <br><br>  <b>4.</b> Configure MX records for the domain from which distribution will be made.  Even if you do not plan to accept any letters for this domain.  At a minimum, you must correctly receive and process messages about the impossibility of delivering your letters and the postmaster @ address.  The use of domains without MX records in the sender's address or in the SMTP envelope negatively affects the deliverability of letters.  Some recipients validate the sender addresses from the SMTP envelope, so it is desirable that the server does not give errors when sending a letter to such an address. <br><br>  <b>5.</b> Configure <a href="https://help.mail.ru/mail-help/postmaster/work/spf">SPF record</a> .  SPF allows you to specify which servers are allowed to send mail on behalf of the domain.  SPF is configured for the address used in the envelope-from (SMTP envelope). <br><br>  <b>6.</b> Configure <a href="https://help.mail.ru/mail-help/postmaster/work/dkim">DKIM</a> : <br>  <b>6.1</b> Generate a DKIM key pair and publish the public key; <br>  <b>6.2</b> Do not forget to configure the DKIM signature for all outgoing emails (more on this later). <br>  DKIM allows you to sign emails that are sent on behalf of a specific domain.  Currently, DKIM is already a must have technology, it is the technical basis for others - FBL, DMARC, as well as for services such as Postmaster Mail.Ru. <br><br>  <b>7.</b> Post a <a href="http://habrahabr.ru/company/mailru/blog/170957/">DMARC</a> policy.  DMARC specifies exactly how to use SPF and DKIM, and allows you to completely eliminate phishing on behalf of the domain by publishing restrictive policies.  And it also gives you the opportunity to receive in the form of structured reports all the information about attempts to violate your policy. <br>  DMARC has not yet been adopted as an official standard, but it is already supported by the main players in the email market - Mail.Ru, Google, Yahoo and Microsoft.  This is a very simple to implement and yet extremely effective solution. <br>  Now you can try to raise the mail server. <br><br>  <b>8.</b> In the Mail Transfer Agent settings, configure the hostname of the server, which is sent in the HELO command.  This name must match the canonical server name from the PTR record (server.example.com).  Very often, the default HELO uses names like localhost.localdomain, and many mail servers refuse to accept mail with such a HELO.  Set up a SPF record for a name from HELO, this RFC 7208 requirement that allows you to deliver service letters with an empty SMTP envelope address. <br><br>  <b>9.</b> Enable DKIM support in your mail server.  Some servers have built-in support, some can be implemented using free software (for example, OpenDKIM), for Microsoft Exchange / IIS SMTP there are inexpensive and <a href="http://habrahabr.ru/post/229401/">free</a> plug-ins.  When setting up, do not confuse DKIM (RFC 4871 / RFC 6376) and DomainKey (RFC 4870).  DomainKey is an outdated standard that has never been adopted.  Doing his support is optional.  DKIM can be recognized by the presence of the DKIM-Signature signature in the letter headers.  To sign the headers and body of the letter it is better to use the relaxed mode. <br><br>  <b>10.</b> Configure the postmaster box. <br><br>  <b>11.</b> Avoid configurations that lead to unauthorized relay of letters, otherwise all the work will go down the drain along with the reputation of the server. <br><br>  <b>12.</b> Test your server configuration by sending emails to basic email services through a standard email client, for example, Thunderbird.  Check the headers of received emails.  Make sure to: <br>  <b>12.1</b> correctness of HELO; <br>  <b>12.2</b> availability and passage of SPF-, DKIM- and DMARC-checks on servers that support DMARC; <br>  <b>12.3</b> impossibility of unauthorized relaying through your server; <br>  <b>12.4</b> that postmaster @ and addresses for DMARC and FBL reports are received <br>  <b>12.5 The</b> server correctly generates reports about undeliverable emails. <br><br>  <b>13.</b> Subscribe to FBL (FeedBack Loop).  <a href="http://wiki.asrg.sp.am/wiki/Feedback_loop_links_for_some_email_providers">FBL are</a> provided by many major mail services.  A subscription will give you the opportunity to receive information about all complaints about spam e-mail from your domain. <br><br>  <b>Now you can customize the mailing / write scripts to send emails.</b>  Getting started. <br><br>  <b>14.</b> Handle messages about the inability to deliver letters.  Remember that there are two ways to get an error: in an SMTP session (in this case, a message about undeliverable can be generated by your server) or by a letter with a undelivered delivery report (NDR) from the recipient server.  It is necessary to process both cases.  At the same time, it is imperative to react and exclude the user from mailings with repeated or permanent (permanent) delivery errors to his address.  The presence of a large number of invalid recipients can lead to a decrease in reputation and / or triggered greylisting. <br><br>  <b>15.</b> Set the SMTP address. MAIL FROM: (envelope sender) - the sender address that is used at the SMTP protocol level.  It may not coincide with the address of the sender from the header of the letter From :.  For normal DMARC operation, it is desirable that the From: address and the envelope sender address be from the same domain.  And, of course, the letter must have a valid DKIM signature for this domain and pass SPF checks.  Incorrect sender address in the envelope (envelope) - the most common and serious error in mailings from various websites. <br><br>  <b>16.</b> Do not use public mail addresses in the From: and MAIL FROM addresses, since such mailings will not pass SPF / DKIM authentication in DMARC.  Use your own domain addresses. <br><br>  <b>17.</b> In the Content-Type headers for all text parts of the letter, specify the correct encoding.  Make sure that the actual encoding of the text matches the one specified in the header.  It is advisable to use the same encoding in all headers and parts of the letter.  Currently the recommended, most widely supported text encoding is UTF-8.  If the encoding is not specified (or is specified incorrectly), the text may be displayed differently by different services and mail programs. <br><br>  <b>18.</b> Generate From: headers, Message-ID: and Date: headers directly in the script for sending letters.  Make sure that these headers, especially Date :, are formed in the correct format.  By standards, these headers are formed together with the text of the letter.  If they are missing or formed incorrectly, one of the transit servers can add headers, which may violate the integrity of the DKIM signature. <br><br>  <b>19.</b> Make sure that in all service and other headers, including the subject line (Subject), the names of attached files (Content-Type and Content-Disposition), non-ASCII characters, in particular Cyrillic, are encoded in quoted-printable or base64.  According to the standards, non-coded eight-bit characters cannot be found in letter headers;  Some servers do not accept such letters.  If you are targeting foreign subscribers, then it is desirable that the letter does not contain uncoded 8-bit characters at all. <br><br>  <b>20.</b> Limit string length and use correct string terminators. <br>  <b>20.1 The</b> maximum allowed string length in email is 998 8-bit characters.  When using UTF-8, one displayed character may take several octets, so try to make the text in the strings shorter or encode the text in base64. <br>  <b>20.2 The</b> correct terminator of strings in email is CRLF (characters with codes 13 and 10).  In Unix, the standard line terminator is LF.  If the script or MTA being used does not replace the line terminators, this can lead to problems ‚Äî incorrect display of the letter or cutting off part of the text.  Errors can cause double replacement of terminators.  Check the documentation or test whether the configuration you are using should transcode the ends of the lines. <br>  <b>20.3</b> String terminators should not split UTF-8 characters so that there is no situation in which a terminator is added to a long string, for example, between two octets of a single Cyrillic character.  Therefore, the breakdown of the text should be made before the formation of the letter. <br>  Encoding text parts to base64 increases the size of a letter by about a third, but it saves from all the problems associated with terminators of strings in text parts. <br><br>  <b>21.</b> Try to adhere to a fairly simple letter structure, avoid deep nesting of multipart parts (that is, including one component in another).  If there are more than one multipart-parts of each type in the letter (one multipart / mixed by one multipart / alternative and one multipart / related), most likely, the letter is not optimally formed. <br><br>  <b>22.</b> Correctly put the Content-Disposition of each part as an attachment (attachment shown separately from the letter) or inline (an object displayed as part of the letter - for example, a picture in the text).  It often happens that the document attached to the letter is marked as inline, although it is intended for downloading by the user, or the logo in the text of the letter is marked as attachment, although it should not be visible in the list of attached files. <br><br>  <b>23.</b> Form the text (plaintext) part of the letter as an alternative to the HTML part.  Do not forget that the user can read the letter, for example, from a cell phone.  Correctly and beautifully convert HTML content to text is not always possible.  By adding a text part to the letter, you can be sure that the text will be displayed exactly as you expect it. <br><br>  <b>24.</b> Test your script work on test boxes from different email services.  Do not forget to download the original letter that came to the box and check: <br>  <b>24.1</b> correctness envelope sender; <br>  <b>24.2</b> passing SPF, DKIM and DMARC checks; <br>  <b>24.3</b> availability and validity of text encodings in the Content-Type headers for all text parts (including HTML); <br>  <b>24.4</b> in HTML parts - the validity of the encodings indicated in meta tags (if any); <br>  <b>24.5</b> display of various characters, including Cyrillic in text, HTML-parts and file names (if you plan to send files); <br>  <b>24.6</b> availability of proper Content-Disposition and Content-Transfer-Encoding for each part of the letter (except multipart); <br>  <b>24.7</b> display of pictures and attachments; <br>  <b>24.8</b> string terminator correctness; <br>  <b>24.9</b> correct splitting and display of long texts in HTML and plain text parts; <br>  <b>24.10</b> Make sure that the From: Date: and Message-ID headers are formed by your server, signed with DKIM-signature and valid. <br><br>  <b>Now you can go to the layout of letters.</b>  Recommendations for the coder: <br><br>  <b>25.</b> Keep it simple.  Do not forget that webmails are forced to filter some tags and attributes in order to ensure security, and they all do it differently.  Avoid using classes, minimize the use of styles, especially for positioning.  The good old layout on the tables is the most portable. <br><br>  <b>26.</b> Do not attempt to typeset for the web interface of a specific mail server.  Users often set up redirects, mail collectors, or read email in email programs. <br><br>  <b>27.</b> Think about the user.  He can open your letter both on a huge retina display and on an old phone on top of Everest, trying to grab a GPRS connection.  Accordingly, the letter should load quickly, but look beautiful even with images turned off. <br><br>  <b>28.</b> No inscriptions in small print.  They get nervous and make you suspicious.  Feel free to show the user that you know and respect their rights and their responsibilities. <br><br>  <b>29.</b> Choose the most appropriate way to embed images.  There are the following options, each with its own pros and cons: <br>  <b>29.1</b> External images: in terms of sending speed, this option is the most preferred.  External pictures do not weigh anything and do not complicate the structure of the letter.  However, many applications and email services require user permission to display such images.  In addition, the server on which they are located must be sufficiently reliable so that when opening a letter, it does not cause ‚Äúhangs‚Äù due to the inaccessibility of the picture.  Use them when having pictures is optional. <br>  <b>29.2</b> Inline Pictures.  Sent along with the contents of the letter.  Complicate the structure of the letter and increase its weight, but it can be quite large and is usually displayed by default. <br>  <b>29.3</b> Data URI.  The content of the picture is inserted directly into the tag.  Do not complicate the structure of the letter, almost always shown in the web mail, sometimes even with disabled images.  As a rule, they have a size limit, suitable for small icons. <br>  <b>29.4</b> Font pictures.  Images of Unicode characters from standard fonts or using embedded custom fonts.  Unique property - can be scaled along with the text.    .   ,         , ,    . <br><br> <b>30.</b>   URI    (http://, https://  mailto:),  URI  ,  "//example.com/"            -    ,       , ..    . <br><br> <b>31.</b>                 ¬´¬ª . <br><br>  , ,     ,  -    ?       ‚Äî  ,    .     ,   Mail.Ru,    abuse@corp.mail.ru.        ‚Äì     ,     ,      . <br><br>  ,               ,        ‚Äì       . </div><p>Source: <a href="https://habr.com/ru/post/239963/">https://habr.com/ru/post/239963/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../239951/index.html">Today CSS is 20 years old. Interview with Haakon Wium Lee (Part 1)</a></li>
<li><a href="../239953/index.html">Ultrascope: a robotic telescope from parts printed on a 3D printer with the Nokia Lumia 1020 as a ‚Äúbrain‚Äù and camera</a></li>
<li><a href="../239955/index.html">Dual review Xperia Z3 and Z3 Compact</a></li>
<li><a href="../239957/index.html">Swift Tuples</a></li>
<li><a href="../239959/index.html">Open lecture of the Android-Course from MasterUp</a></li>
<li><a href="../239969/index.html">The program Digital Editions 4 "knocks" in Adobe about all open files</a></li>
<li><a href="../239971/index.html">The first independent confirmation of LENR (in a simple way - cold synthesis)?</a></li>
<li><a href="../239975/index.html">InterSystems Enterprise Manager</a></li>
<li><a href="../239979/index.html">The hacker group Sednit has switched to using its own set of exploits.</a></li>
<li><a href="../239981/index.html">SSP-based 1-Wire interface implementations</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>