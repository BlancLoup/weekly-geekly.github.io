<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Work with memory (and yet it is)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="There is a widespread opinion that the ‚Äúordinary‚Äù PHP developer practically does not need to worry about memory management, however, ‚Äúcare‚Äù and ‚Äúknow‚Äù...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Work with memory (and yet it is)</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage1/afac9909/2f9d7132/e91c24db/a72e14e8.jpg" align="left">  There is a widespread opinion that the ‚Äúordinary‚Äù PHP developer practically does not need to worry about memory management, however, ‚Äúcare‚Äù and ‚Äúknow‚Äù are still slightly different concepts.  I will try to highlight some aspects of memory management when working with variables and arrays, as well as interesting "pitfalls" of internal PHP optimization.  As you can see, optimization is good, but if you don‚Äôt know exactly how it ‚Äúoptimizes‚Äù, then you can run into ‚Äúunobvious rakes‚Äù that can make you pretty nervous. <br><br><a name="habracut"></a><br><h4>  General information </h4><br><h6>  Small educational program </h6><br>  A variable in PHP consists of two parts: the " <b>name</b> ", which is stored in the hash_table symbol_table, and the " <b>value</b> ", which is stored in the zval container. <br>  This mechanism allows you to create several variables referring to one value, which in some cases allows you to optimize memory consumption.  How it looks in practice will be written further. <br><br>  The most frequent elements of the code, without which it is difficult to imagine a less functional script, are the following points: <br>  - creation, assignment and deletion of variables (numbers, strings, etc.), <br>  - creating arrays and traversing them (foreach will be used as an example), <br>  - transfer and return values ‚Äã‚Äãfor functions / methods. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The following description will be about these aspects of working with memory.  It turned out quite volume, but nothing mega-complex will not be and everything will be quite simple, obviously, and with examples. <br><br><h6>  The first example of working with memory </h6><br>  First, a basic example of how memory consumption will be analyzed. <br>  For this we need a couple of simple functions (the <b>func.php</b> file): <br><blockquote>  <font color="#000000">&lt;? php</font> <br>  <font color="#000000">function</font> memoryUsage <font color="#009900">(</font> <font color="#000088">$ usage</font> <font color="#339933">,</font> <font color="#000088">$ base_memory_usage</font> <font color="#009900">)</font> <font color="#009900">{</font> <br>  <font color="#990000">printf</font> <font color="#009900">(</font> <font color="#0000ff">"Bytes diff: <font color="#009933">% d</font> \ n"</font> <font color="#339933">,</font> <font color="#000088">$ usage</font> <font color="#339933">-</font> <font color="#000088">$ base_memory_usage</font> <font color="#009900">)</font> <font color="#339933">;</font> <br>  <font color="#009900">}</font> <br>  <font color="#000000">function</font> someBigValue <font color="#009900">(</font> <font color="#009900">)</font> <font color="#009900">{</font> <br>  <font color="#b1b100">return</font> <font color="#990000">str_repeat</font> <font color="#009900">(</font> <font color="#0000ff">'SOME BIG STRING'</font> <font color="#339933">,</font> <font color="#cc66cc">1024</font> <font color="#009900">)</font> <font color="#339933">;</font> <br>  <font color="#009900">}</font> <br>  <font color="#000000">?&gt;</font> </blockquote><br><br>  And a simple first example of a memory consumption test for a row: <br><blockquote>  <font color="#000000">&lt;? php</font> <br>  <font color="#b1b100">include</font> <font color="#009900">(</font> <font color="#0000ff">'func.php'</font> <font color="#009900">)</font> <font color="#339933">;</font> <br>  <font color="#b1b100">echo</font> <font color="#0000ff">"String memory usage test. \ n \ n"</font> <font color="#339933">;</font> <br>  <font color="#000088">$ base_memory_usage</font> <font color="#339933">=</font> <font color="#990000">memory_get_usage</font> <font color="#009900">(</font> <font color="#009900">)</font> <font color="#339933">;</font> <br>  <font color="#000088">$ base_memory_usage</font> <font color="#339933">=</font> <font color="#990000">memory_get_usage</font> <font color="#009900">(</font> <font color="#009900">)</font> <font color="#339933">;</font> <br><br>  <font color="#b1b100">echo</font> <font color="#0000ff">"Start \ n"</font> <font color="#339933">;</font> <br>  memoryUsage <font color="#009900">(</font> <font color="#990000">memory_get_usage</font> <font color="#009900">(</font> <font color="#009900">)</font> <font color="#339933">,</font> <font color="#000088">$ base_memory_usage</font> <font color="#009900">)</font> <font color="#339933">;</font> <br><br>  <font color="#000088">$ a</font> <font color="#339933">=</font> someBigValue <font color="#009900">(</font> <font color="#009900">)</font> <font color="#339933">;</font> <br><br>  <font color="#b1b100">echo</font> <font color="#0000ff">"String value setted \ n"</font> <font color="#339933">;</font> <br>  memoryUsage <font color="#009900">(</font> <font color="#990000">memory_get_usage</font> <font color="#009900">(</font> <font color="#009900">)</font> <font color="#339933">,</font> <font color="#000088">$ base_memory_usage</font> <font color="#009900">)</font> <font color="#339933">;</font> <br><br>  <font color="#990000">unset</font> <font color="#009900">(</font> <font color="#000088">$ a</font> <font color="#009900">)</font> <font color="#339933">;</font> <br><br>  <font color="#b1b100">echo</font> <font color="#0000ff">"String value unsetted \ n"</font> <font color="#339933">;</font> <br>  memoryUsage <font color="#009900">(</font> <font color="#990000">memory_get_usage</font> <font color="#009900">(</font> <font color="#009900">)</font> <font color="#339933">,</font> <font color="#000088">$ base_memory_usage</font> <font color="#009900">)</font> <font color="#339933">;</font> <br>  <font color="#000000">?&gt;</font> </blockquote><br>  Note: the <i>code is undoubtedly non-optimized from the point of view of efficiency, but in this case, the visibility of memory consumption for which this representation is implemented is extremely important to us.</i> <br><br>  The result of the code is quite obvious: <br><blockquote>  String memory usage test. <br><br>  Start <br>  Bytes diff: 0 <br>  String value setted <br>  Bytes diff: 15448 <br>  String value unsetted <br>  Bytes diff: 0 </blockquote><br><br>  The same example, but instead of <b>unset ($ a), we</b> use <b>$ a = null;</b>  : <br><blockquote>  Start <br>  Bytes diff: 0 <br>  String value setted <br>  Bytes diff: 15448 <br>  String value set to null <br>  Bytes diff: 76 <br></blockquote><br>  As you can see, the variable was not completely destroyed.  Another 76 bytes remain allocated for it. <br>  Sufficiently decent, if we consider that exactly the same amount is allocated for variables of type boolean, integer, float.  This is not about the amount of memory allocated for <i>the variable value</i> , but about the total memory consumption for storing information about the assigned variable (zval container with the value and the variable name itself). <br>  So if you want to free up memory with an assignment, then it is not a matter of principle to assign exactly <b>null</b> values.  The expression <b>$ a = 10,000;</b>  will give the same result for memory consumption. <br><br>  The PHP documentation says that <a href="http://ru.php.net/manual/ru/language.types.null.php">casting to <b>null will</b> destroy the variable and its value</a> , however, this script shows that it is not, which is actually <a href="https://bugs.php.net/bug.php%3Fid%3D55164">a bug (documentation)</a> . <br><br>  Why use assignment <b>null</b> if you can <b>unset ()</b> ? <br>  Assignment is an assignment, (thanks to KO), that is, the value of a variable changes, respectively, if a new value requires less memory, it is released immediately, but this requires computational resources (albeit relatively few). <br>  <b>unset ()</b> in turn frees the memory allocated for the variable name and its value. <br>  It is worth mentioning separately that <b>unset ()</b> and assignment of <b>null work</b> quite differently with variable references.  <b>Unset () will</b> destroy only the link, while assigning <b>null</b> will change the value referenced by the variable names, respectively, all variables will refer to the value <b>null</b> . <br><br>  Note: <br>  <i>There is a misconception that <b>unset ()</b> is a function, however, this is not true.</i>  <i><b>unset ()</b> is a language construct (such as <b>if</b> ), which is <a href="http://php.net/manual/en/function.unset.php">explicitly stated in the documentation</a> , so it cannot be used to access through the variable value:</i> <br><blockquote>  $ unset_func_name <font color="#000080">=</font> <font color="#FF0000">'unset'</font> <font color="#008080">;</font> <br>  $ unset_func_name <font color="#008000">(</font> $ some_var <font color="#008000">)</font> <font color="#008080">;</font> </blockquote><br><br>  Some additional information for idle thinking (when changing the example above): <br>  <b>$ a = array ();</b> <br>  allocates 164 bytes, unset ($ a) returns everything. <br><br>  <b>class A {}</b> <b><br></b>  <b>$ a = new A ();</b> <b><br></b>  allocates 184 bytes, unset ($ a) returns everything. <br><br>  <b>$ a = new stdClass ();</b> <br>  will allocate 272 bytes, but after unset ($ a) 88 bytes will ‚Äúleak‚Äù (I have not yet been able to figure out where exactly and why they have leaked). <br><br>  So far, the examples are not critical in terms of memory consumption, since string and numeric values ‚Äã‚Äãare quite obviously stored and processed.  Everything becomes much worse when arrays are used (objects also have a number of features, but this will require a separate article). <br><br><h4>  Arrays </h4><br>  Arrays in PHP "eat up" enough memory, and it is in them that usually store significant amounts of data during processing, so you should be very careful about working with them.  However, working with arrays in PHP has its own ‚Äúoptimization charm‚Äù and one of these moments related to memory consumption is worth mentioning. <br><br>  Insidious example number 1 <br><blockquote>  <font color="#000080">&lt;</font> <font color="#008080">?</font>  php <br>  include <font color="#008000">(</font> <font color="#FF0000">'func.php'</font> <font color="#008000">)</font> <font color="#008080">;</font> <br>  echo <font color="#FF0000">"Array memory usage example."</font>  <font color="#008080">;</font> <br>  $ base_memory_usage <font color="#000080">=</font> memory_get_usage <font color="#008000">(</font> <font color="#008000">)</font> <font color="#008080">;</font> <br>  $ base_memory_usage <font color="#000080">=</font> memory_get_usage <font color="#008000">(</font> <font color="#008000">)</font> <font color="#008080">;</font> <br><br>  echo <font color="#FF0000">'Base usage.'</font>  .  <font color="#007788">PHP_EOL</font> <font color="#008080">;</font> <br>  memoryUsage <font color="#008000">(</font> memory_get_usage <font color="#008000">(</font> <font color="#008000">)</font> , $ base_memory_usage <font color="#008000">)</font> <font color="#008080">;</font> <br><br>  $ a <font color="#000080">=</font> array <font color="#008000">(</font> someBigValue <font color="#008000">(</font> <font color="#008000">)</font> , someBigValue <font color="#008000">(</font> <font color="#008000">)</font> , someBigValue <font color="#008000">(</font> <font color="#008000">)</font> , someBigValue <font color="#008000">(</font> <font color="#008000">)</font> <font color="#008000">)</font> <font color="#008080">;</font> <br><br>  echo <font color="#FF0000">'Array is set.'</font>  .  <font color="#007788">PHP_EOL</font> <font color="#008080">;</font> <br>  memoryUsage <font color="#008000">(</font> memory_get_usage <font color="#008000">(</font> <font color="#008000">)</font> , $ base_memory_usage <font color="#008000">)</font> <font color="#008080">;</font> <br><br>  foreach <font color="#008000">(</font> $ a as $ k <font color="#000080">=&gt;</font> $ v <font color="#008000">)</font> <font color="#008000">{</font> <br>  $ a <font color="#008000">[</font> $ k <font color="#008000">]</font> <font color="#000080">=</font> someBigValue <font color="#008000">(</font> <font color="#008000">)</font> <font color="#008080">;</font> <br>  unset <font color="#008000">(</font> $ k, $ v <font color="#008000">)</font> <font color="#008080">;</font> <br>  echo <font color="#FF0000">'In FOREACH cycle.'</font>  .  <font color="#007788">PHP_EOL</font> <font color="#008080">;</font> <br>  memoryUsage <font color="#008000">(</font> memory_get_usage <font color="#008000">(</font> <font color="#008000">)</font> , $ base_memory_usage <font color="#008000">)</font> <font color="#008080">;</font> <br>  <font color="#008000">}</font> <br><br>  echo <font color="#FF0000">'Usage right after FOREACH.'</font>  .  <font color="#007788">PHP_EOL</font> <font color="#008080">;</font> <br>  memoryUsage <font color="#008000">(</font> memory_get_usage <font color="#008000">(</font> <font color="#008000">)</font> , $ base_memory_usage <font color="#008000">)</font> <font color="#008080">;</font> <br><br>  unset <font color="#008000">(</font> $ a <font color="#008000">)</font> <font color="#008080">;</font> <br>  echo <font color="#FF0000">'Array unset.'</font>  .  <font color="#007788">PHP_EOL</font> <font color="#008080">;</font> <br>  memoryUsage <font color="#008000">(</font> memory_get_usage <font color="#008000">(</font> <font color="#008000">)</font> , $ base_memory_usage <font color="#008000">)</font> <font color="#008080">;</font> <br>  <font color="#008080">?</font>  <font color="#000080">&gt;</font> </blockquote><br>  At first glance it may seem that the memory consumption of the $ a array will not change (except for setting the variables $ k and $ v), however PHP has a special approach when working with arrays in this case. <br><br>  Look at the output: <br><blockquote>  Array memory usage example.Base usage. <br>  Bytes diff: 0 <br>  Array is set. <br>  Bytes diff: 61940 <br>  In FOREACH cycle. <br>  Bytes diff: 77632 <br>  In FOREACH cycle. <br>  Bytes diff: 93032 <br>  In FOREACH cycle. <br>  Bytes diff: 108432 <br>  In FOREACH cycle. <br>  Bytes diff: 123832 <br>  Usage right after FOREACH. <br>  Bytes diff: 61940 <br>  Array unset. <br>  Bytes diff: 0 <br></blockquote><br>  It turns out that in the last iteration of the foreach loop in this case, the consumption by the memory array doubled, although this is not obvious from the code itself.  But immediately after the cycle, the memory consumption returned to its previous value.  Miracles and only. <br>  The reason for this is to optimize the use of an array in a loop.  At the time of the cycle, when you try to change the original array, an implicitly created copy of the array structure (but not a copy of the values) becomes available at the end of the cycle, and the original structure is destroyed.  Thus, in the above example, if you assign new values ‚Äã‚Äãto the original array, they will not be replaced immediately, but they will be allocated a separate memory, which will be returned upon exiting the loop. <br>  This point is very easy to miss, which can lead to significant memory consumption during the cycle with large data sets, for example, when sampling from the database. <br><br>  Note: <br>  <i>Inside the loop itself, after changing the value of $ a [$ k], you will not be able to get the value that is still stored in the original array if you have not saved the value of $ v.</i>  <i>Repeated reference to $ a [$ k] will produce a new value.</i> <br><br>  <a href="http://habrahabr.ru/blogs/php/134784/">Addition from the user</a> <a href="http://habrahabr.ru/users/zibada/" class="user_link">zibada</a> (in short): <br>  It is important to note that the allocation of memory for a new ‚Äútemporary array‚Äù in the event of changes, will occur simultaneously for the entire array structure, but separately for each variable element.  Thus, if there is an array with a large number of elements (but not necessarily with large values), then one-time memory consumption with such copying will be significant. <br><br>  Insidious example number 2 <br>  Slightly change the code. <br><blockquote>  echo <font color="#FF0000">'Array is set.'</font>  .  <font color="#007788">PHP_EOL</font> <font color="#008080">;</font> <br>  memoryUsage <font color="#008000">(</font> memory_get_usage <font color="#008000">(</font> <font color="#008000">)</font> , $ base_memory_usage <font color="#008000">)</font> <font color="#008080">;</font> <br>  $ b <font color="#000080">=</font> <font color="#000040">&amp;</font> $ a <font color="#008080">;</font>  <font color="#666666">// Add it</font> <br>  foreach <font color="#008000">(</font> $ a as $ k <font color="#000080">=&gt;</font> $ v <font color="#008000">)</font> <font color="#008000">{</font> <br>  $ a <font color="#008000">[</font> $ k <font color="#008000">]</font> <font color="#000080">=</font> someBigValue <font color="#008000">(</font> <font color="#008000">)</font> <font color="#008080">;</font> <br>  unset <font color="#008000">(</font> $ k, $ v <font color="#008000">)</font> <font color="#008080">;</font> <br>  echo <font color="#FF0000">'In FOREACH cycle.'</font>  .  <font color="#007788">PHP_EOL</font> <font color="#008080">;</font> <br>  memoryUsage <font color="#008000">(</font> memory_get_usage <font color="#008000">(</font> <font color="#008000">)</font> , $ base_memory_usage <font color="#008000">)</font> <font color="#008080">;</font> <br>  <font color="#008000">}</font> <br>  unset <font color="#008000">(</font> $ b <font color="#008000">)</font> <font color="#008080">;</font>  <font color="#666666">// And this</font> <br>  echo <font color="#FF0000">'Usage right after FOREACH.'</font>  .  <font color="#007788">PHP_EOL</font> <font color="#008080">;</font> <br>  memoryUsage <font color="#008000">(</font> memory_get_usage <font color="#008000">(</font> <font color="#008000">)</font> , $ base_memory_usage <font color="#008000">)</font> <font color="#008080">;</font> </blockquote><br><br>  We didn‚Äôt change the loop code itself; the only thing we changed was increased the reference count to the original array, but this radically changed the work of the loop: <br><blockquote>  Bytes diff: 0 <br>  Array is set. <br>  Bytes diff: 61940 <br>  In FOREACH cycle. <br>  Bytes diff: 61988 <br>  In FOREACH cycle. <br>  Bytes diff: 61988 <br>  In FOREACH cycle. <br>  Bytes diff: 61988 <br>  In FOREACH cycle. <br>  Bytes diff: 61988 <br>  Usage right after FOREACH. <br>  Bytes diff: 61940 <br>  Array unset. <br>  Bytes diff: 0 <br></blockquote><br>  <i>Small change: (61988 - 61940 = 48 bytes for the storage of the reference variable $ b).</i> <br>  Otherwise, we see that if the array used for the loop has more than one reference to itself, then the optimization from Example 1, for example, does not apply to it.  the assignment uses the original array. <br>  We will get exactly the same result if we use the $ b array for the loop or use the value passing by reference in the loop: <br><blockquote>  echo <font color="#FF0000">'Array is set.'</font>  .  <font color="#007788">PHP_EOL</font> <font color="#008080">;</font> <br>  memoryUsage <font color="#008000">(</font> memory_get_usage <font color="#008000">(</font> <font color="#008000">)</font> , $ base_memory_usage <font color="#008000">)</font> <font color="#008080">;</font> <br><br>  foreach <font color="#008000">(</font> $ a as $ k <font color="#000080">=&gt;</font> <font color="#000040">&amp;</font> $ v <font color="#008000">)</font> <font color="#008000">{</font> <br>  $ a <font color="#008000">[</font> $ k <font color="#008000">]</font> <font color="#000080">=</font> someBigValue <font color="#008000">(</font> <font color="#008000">)</font> <font color="#008080">;</font>  <font color="#666666">// Or $ v = someBigValue ();</font> <br>  unset <font color="#008000">(</font> $ k, $ v <font color="#008000">)</font> <font color="#008080">;</font> <br>  echo <font color="#FF0000">'In FOREACH cycle.'</font>  .  <font color="#007788">PHP_EOL</font> <font color="#008080">;</font> <br>  memoryUsage <font color="#008000">(</font> memory_get_usage <font color="#008000">(</font> <font color="#008000">)</font> , $ base_memory_usage <font color="#008000">)</font> <font color="#008080">;</font> <br>  <font color="#008000">}</font> <br><br>  echo <font color="#FF0000">'Usage right after FOREACH.'</font>  .  <font color="#007788">PHP_EOL</font> <font color="#008080">;</font> <br>  memoryUsage <font color="#008000">(</font> memory_get_usage <font color="#008000">(</font> <font color="#008000">)</font> , $ base_memory_usage <font color="#008000">)</font> <font color="#008080">;</font> </blockquote><br><br>  Result: <br><blockquote>  Bytes diff: 0 <br>  Array is set. <br>  Bytes diff: 61940 <br>  In FOREACH cycle. <br>  Bytes diff: 61940 <br>  In FOREACH cycle. <br>  Bytes diff: 61940 <br>  In FOREACH cycle. <br>  Bytes diff: 61940 <br>  In FOREACH cycle. <br>  Bytes diff: 61940 <br>  Usage right after FOREACH. <br>  Bytes diff: 61940 <br>  Array unset. <br>  Bytes diff: 0 <br></blockquote><br>  It is worth noting here that adding the $ v transfer by reference does not increase the reference count of the original array, but also turns off the "optimization". <br><br><h4>  Link transfer or copy transfer </h4><br><br>  Consider the case of "what to do" if you want to transfer (or return from them) to a method or function, a very large value.  The first obvious solution is usually to consider using a pass / return link. <br>  However, the PHP documentation says: <a href="http://www.php.net/manual/ru/language.references.return.php">Do not use return by reference for increased performance.</a>  <a href="http://www.php.net/manual/ru/language.references.return.php">The PHP core itself is engaged in optimization</a> . <br>  Let us try to understand what this ‚Äúoptimization‚Äù is. <br><br>  To begin with the simplest example (so far without passing arguments): <br><blockquote>  ... <br>  $ a <font color="#000080">=</font> someBigValue <font color="#008000">(</font> <font color="#008000">)</font> <font color="#008080">;</font> <br>  $ b <font color="#000080">=</font> $ a <font color="#008080">;</font> <br><br>  echo <font color="#FF0000">"String value setted"</font> <font color="#008080">;</font> <br>  memoryUsage <font color="#008000">(</font> memory_get_usage <font color="#008000">(</font> <font color="#008000">)</font> , $ base_memory_usage <font color="#008000">)</font> <font color="#008080">;</font> <br><br>  unset <font color="#008000">(</font> $ a, $ b <font color="#008000">)</font> <font color="#008080">;</font> <br>  ... </blockquote><br>  According to "direct logic", two blocks should be allocated in memory for the value of variables.  However, PHP optimizes this point: <br><blockquote>  Start <br>  Bytes diff: 0 <br>  String value setted <br>  Bytes diff: 15496 <br>  String value unsetted <br>  Bytes diff: 0 <br></blockquote><br>  In this case, the 15,448 bytes are occupied by the $ a variable, while the remaining 48 bytes are allocated to the $ b variable, although there is no link between them.  This memory consumption is saved until we somehow change one of these variables, or rather, we‚Äôll generally do something with its value, even if we don‚Äôt change it in fact: <br><blockquote>  $ a <font color="#000080">=</font> someBigValue <font color="#008000">(</font> <font color="#008000">)</font> <font color="#008080">;</font> <br>  $ b <font color="#000080">=</font> $ a <font color="#008080">;</font> <br>  $ b <font color="#000080">=</font> strval <font color="#008000">(</font> $ b <font color="#008000">)</font> <font color="#008080">;</font> <br><br>  echo <font color="#FF0000">"String value setted"</font> <font color="#008080">;</font> <br>  memoryUsage <font color="#008000">(</font> memory_get_usage <font color="#008000">(</font> <font color="#008000">)</font> , $ base_memory_usage <font color="#008000">)</font> <font color="#008080">;</font> <br><br>  unset <font color="#008000">(</font> $ a, $ b <font color="#008000">)</font> <font color="#008080">;</font> </blockquote><br><br>  As a result, we get the output: <br><blockquote>  Bytes diff: 0 <br>  String value setted <br>  Bytes diff: 30896 <br>  String value unsetted <br>  Bytes diff: 0 <br></blockquote><br>  As we see, an attempt to ‚Äútouch‚Äù the value of the $ b variable leads to the fact that the script now allocates a separate memory area for its storage.  The same thing happens if we try to ‚Äútouch‚Äù the value of $ a. <br><br>  This optimization is valid for specific values, which are also individual values ‚Äã‚Äãof the array. <br>  To better understand this, take a look at the example below: <br><blockquote>  $ a <font color="#000080">=</font> array <font color="#008000">(</font> someBigValue <font color="#008000">(</font> <font color="#008000">)</font> , someBigValue <font color="#008000">(</font> <font color="#008000">)</font> <font color="#008000">)</font> <font color="#008080">;</font>  <font color="#666666">// 31052 bytes</font> <br>  $ b <font color="#000080">=</font> $ a <font color="#008080">;</font>  <font color="#666666">// + 48 bytes = 31100 bytes</font> <br>  $ b <font color="#008000">[</font> <font color="#0000dd">0</font> <font color="#008000">]</font> <font color="#000080">=</font> someBigValue <font color="#008000">(</font> <font color="#008000">)</font> <font color="#008080">;</font> <br><br>  echo <font color="#FF0000">"String value setted"</font> <font color="#008080">;</font> <br>  memoryUsage <font color="#008000">(</font> memory_get_usage <font color="#008000">(</font> <font color="#008000">)</font> , $ base_memory_usage <font color="#008000">)</font> <font color="#008080">;</font> <br><br>  unset <font color="#008000">(</font> $ a, $ b <font color="#008000">)</font> <font color="#008080">;</font> </blockquote><br><br>  This example will give the output: <br><blockquote>  Bytes diff: 0 <br>  String value setted <br>  Bytes diff: 46704 <br>  String value unsetted <br>  Bytes diff: 0 <br></blockquote><br>  That is, as a result, a new memory (15k + bytes) was allocated to create only a copy of the value for the zero element of the array, and not for the entire array $ b.  The value of $ b [1] is still ‚Äúoptimized due‚Äù to $ a [1]. <br><br>  Everything described above works in the same way for transferring / returning values ‚Äã‚Äãthrough ‚Äúoptimized copying‚Äù inside / of functions and methods.  If you don‚Äôt "touch" the transferred value inside the method, then a separate memory area will not be allocated for it (memory will be allocated only under the variable name in order to associate it with the value).  If you pass ‚Äúthrough copying‚Äù and change the value inside the method, then before attempting to make the change a valid full copy of the value will be created. <br><br>  Thus, PHP really eliminates the need to use referral to optimize memory usage.  Passing by reference is only practical if the original value needs to be changed to reflect these changes from outside the method. <br><br>  Code for example: <br><blockquote>  <font color="#000080">&lt;</font> <font color="#008080">?</font>  php <br>  include <font color="#008000">(</font> <font color="#FF0000">'func.php'</font> <font color="#008000">)</font> <font color="#008080">;</font> <br><br>  function testUsageInside <font color="#008000">(</font> $ big_value, $ base_memory_usage <font color="#008000">)</font> <font color="#008000">{</font> <br>  echo <font color="#FF0000">'Usage inside function then $ big_value NOT changed.'</font>  .  <font color="#007788">PHP_EOL</font> <font color="#008080">;</font> <br>  memoryUsage <font color="#008000">(</font> memory_get_usage <font color="#008000">(</font> <font color="#008000">)</font> , $ base_memory_usage <font color="#008000">)</font> <font color="#008080">;</font> <br><br>  $ big_value <font color="#008000">[</font> <font color="#0000dd">0</font> <font color="#008000">]</font> <font color="#000080">=</font> someBigValue <font color="#008000">(</font> <font color="#008000">)</font> <font color="#008080">;</font> <br>  echo <font color="#FF0000">'Usage inside function then $ big_value [0] changed.'</font>  .  <font color="#007788">PHP_EOL</font> <font color="#008080">;</font> <br>  memoryUsage <font color="#008000">(</font> memory_get_usage <font color="#008000">(</font> <font color="#008000">)</font> , $ base_memory_usage <font color="#008000">)</font> <font color="#008080">;</font> <br><br>  $ big_value <font color="#008000">[</font> <font color="#0000dd">1</font> <font color="#008000">]</font> <font color="#000080">=</font> someBigValue <font color="#008000">(</font> <font color="#008000">)</font> <font color="#008080">;</font> <br>  echo <font color="#FF0000">'Usage inside function then also $ big_value [1] changed.'</font>  .  <font color="#007788">PHP_EOL</font> <font color="#008080">;</font> <br>  memoryUsage <font color="#008000">(</font> memory_get_usage <font color="#008000">(</font> <font color="#008000">)</font> , $ base_memory_usage <font color="#008000">)</font> <font color="#008080">;</font> <br><br>  <font color="#008000">}</font> <br><br>  echo <font color="#FF0000">"Array memory usage example."</font>  <font color="#008080">;</font> <br>  $ base_memory_usage <font color="#000080">=</font> memory_get_usage <font color="#008000">(</font> <font color="#008000">)</font> <font color="#008080">;</font> <br>  $ base_memory_usage <font color="#000080">=</font> memory_get_usage <font color="#008000">(</font> <font color="#008000">)</font> <font color="#008080">;</font> <br><br>  echo <font color="#FF0000">'Base usage.'</font>  .  <font color="#007788">PHP_EOL</font> <font color="#008080">;</font> <br>  memoryUsage <font color="#008000">(</font> memory_get_usage <font color="#008000">(</font> <font color="#008000">)</font> , $ base_memory_usage <font color="#008000">)</font> <font color="#008080">;</font> <br><br>  $ a <font color="#000080">=</font> array <font color="#008000">(</font> someBigValue <font color="#008000">(</font> <font color="#008000">)</font> , someBigValue <font color="#008000">(</font> <font color="#008000">)</font> , someBigValue <font color="#008000">(</font> <font color="#008000">)</font> , someBigValue <font color="#008000">(</font> <font color="#008000">)</font> <font color="#008000">)</font> <font color="#008080">;</font> <br><br>  echo <font color="#FF0000">'Array is set.'</font>  .  <font color="#007788">PHP_EOL</font> <font color="#008080">;</font> <br>  memoryUsage <font color="#008000">(</font> memory_get_usage <font color="#008000">(</font> <font color="#008000">)</font> , $ base_memory_usage <font color="#008000">)</font> <font color="#008080">;</font> <br><br>  testUsageInside <font color="#008000">(</font> $ a, $ base_memory_usage <font color="#008000">)</font> <font color="#008080">;</font> <br><br>  echo <font color="#FF0000">'Usage right after function call.'</font>  .  <font color="#007788">PHP_EOL</font> <font color="#008080">;</font> <br>  memoryUsage <font color="#008000">(</font> memory_get_usage <font color="#008000">(</font> <font color="#008000">)</font> , $ base_memory_usage <font color="#008000">)</font> <font color="#008080">;</font> <br><br>  unset <font color="#008000">(</font> $ a <font color="#008000">)</font> <font color="#008080">;</font> <br>  echo <font color="#FF0000">'Array unset.'</font>  .  <font color="#007788">PHP_EOL</font> <font color="#008080">;</font> <br>  memoryUsage <font color="#008000">(</font> memory_get_usage <font color="#008000">(</font> <font color="#008000">)</font> , $ base_memory_usage <font color="#008000">)</font> <font color="#008080">;</font> <br>  <font color="#008080">?</font>  <font color="#000080">&gt;</font> </blockquote><br><br>  Conclusion: <br><blockquote>  Array memory usage example. <br>  Base usage. <br>  Bytes diff: 0 <br>  Array is set. <br>  Bytes diff: 61940 <br>  Usage inside function then $ big_value NOT changed. <br>  Bytes diff: 61940 <br>  Usage inside function then $ big_value [0] changed. <br>  Bytes diff: 77632 <br>  Usage inside function then also $ big_value [1] changed. <br>  Bytes diff: 93032 <br>  Usage right after function call. <br>  Bytes diff: 61940 <br>  Array unset. <br>  Bytes diff: 0 <br></blockquote><br>  As you can see from the example, the function did not create a copy of the array, despite the fact that the value is actually transmitted through copying.  And even a partial modification of the transferred array did not create a full-fledged copy, but allocated memory only for new values. <br><br>  Solely for educational purposes, you should pay attention to these two meanings: <br><blockquote>  Array is set. <br>  Bytes diff: 61940 <br>  Usage inside function then $ big_value NOT changed. <br>  Bytes diff: 61940 <br></blockquote><br>  Memory consumption did not increase with the transfer of control to the function, although in fact a new variable $ big_value appeared.  This is due to the fact that at the script parsing stage, the interpreter determined whether this function would be used in the code and allocated space for the names of its input parameters in advance (if the function is not used, the interpreter ignores it and does not allocate memory for it).  And since ‚Äúoptimized transfer by copying‚Äù takes place, the already existing variable name $ big_value was simply implicitly ‚Äúlinked‚Äù to the large array $ a.  As a result, the value was transferred to the function ‚Äúthrough copying‚Äù without spending a single extra byte. <br><br>  Note: <br>  <i>In PHP5 (as opposed to PHP4), all objects are by default passed by reference, although in fact, this is a defective link.</i>  <i>See <a href="http://blog.golemon.com/2007/01/youre-being-lied-to.html">this article</a> .</i> <br><br><h4>  Brief conclusions </h4><br>  There are no doubt that the examples of optimizing memory usage in PHP are only a drop in the ocean, but they describe the most frequent cases when it makes sense to think about which code to choose in order to optimize memory consumption and save yourself from the headache. <br><br>  Separately, it would be worthwhile to touch on the mechanism of spending and optimizing memory when using objects, however, in view of the abundance of possible examples, this point requires a separate article.  Maybe someday. <br><br>  PS: It would be possible to break it up into several articles, but I do not see the point, since it is better to keep such information ‚Äútogether‚Äù.  I believe those to whom this information has practical meaning will be more convenient.  It was tested for PHP 5.3.2 (Ubuntu 32bit), so your values ‚Äã‚Äãfor the allocated bytes may differ. <br><br>  A lot more useful, but in English: <br>  <a href="http://nikic.github.com/2011/12/12/How-big-are-PHP-arrays-really-Hint-BIG.html">nikic.github.com/2011/12/12/How-big-are-PHP-arrays-really-Hint-BIG.html</a> <br>  <a href="http://nikic.github.com/2011/11/11/PHP-Internals-When-does-foreach-copy.html">nikic.github.com/2011/11/11/PHP-Internals-When-does-foreach-copy.html</a> <br>  <a href="http://blog.golemon.com/2007/01/youre-being-lied-to.html">blog.golemon.com/2007/01/youre-being-lied-to.html</a> <br>  <a href="http://hengrui-li.blogspot.com/2011/08/php-copy-on-write-how-php-manages.html">hengrui-li.blogspot.com/2011/08/php-copy-on-write-how-php-manages.html</a> <br>  <a href="http://sldn.softlayer.com/blog/dmcaloon/PHP-Memory-Management-Foreach">sldn.softlayer.com/blog/dmcaloon/PHP-Memory-Management-Foreach</a> <br>  <a href="http://blog.preinheimer.com/index.php%3F/archives/354-Memory-usage-in-PHP.html">blog.preinheimer.com/index.php?/archives/354-Memory-usage-in-PHP.html</a> <br>  <a href="http://derickrethans.nl/talks/phparch-php-variables-article.pdf">derickrethans.nl/talks/phparch-php-variables-article.pdf</a> <br><br>  <b>UPD</b> <br>  The main part of the article did not cover an important point. <br>  If there is a variable to which the link is created, then when it is passed to the function as an argument, it will be copied immediately, that is, the copy-on-write optimization will not be applied. <br>  Example: <br><blockquote>  <font color="#000080">&lt;</font> <font color="#008080">?</font>  php <br>  include <font color="#008000">(</font> <font color="#FF0000">'func.php'</font> <font color="#008000">)</font> <font color="#008080">;</font> <br>  function testFunc <font color="#008000">(</font> $ a, $ base_memory_usage <font color="#008000">)</font> <font color="#008000">{</font> <br>  memoryUsage <font color="#008000">(</font> memory_get_usage <font color="#008000">(</font> <font color="#008000">)</font> , $ base_memory_usage <font color="#008000">)</font> <font color="#008080">;</font> <br>  <font color="#008000">}</font> <br>  $ base_memory_usage <font color="#000080">=</font> <font color="#0000dd">0</font> <font color="#008080">;</font> <br>  $ base_memory_usage <font color="#000080">=</font> memory_get_usage <font color="#008000">(</font> <font color="#008000">)</font> <font color="#008080">;</font> <br>  memoryUsage <font color="#008000">(</font> memory_get_usage <font color="#008000">(</font> <font color="#008000">)</font> , $ base_memory_usage <font color="#008000">)</font> <font color="#008080">;</font>  <font color="#666666">// 0 bytes</font> <br>  $ a <font color="#000080">=</font> someBigValue <font color="#008000">(</font> <font color="#008000">)</font> <font color="#008080">;</font> <br>  $ b <font color="#000080">=</font> <font color="#000040">&amp;</font> $ a <font color="#008080">;</font> <br>  memoryUsage <font color="#008000">(</font> memory_get_usage <font color="#008000">(</font> <font color="#008000">)</font> , $ base_memory_usage <font color="#008000">)</font> <font color="#008080">;</font>  <font color="#666666">// 15496 bytes</font> <br>  testFunc <font color="#008000">(</font> $ a, $ base_memory_usage <font color="#008000">)</font> <font color="#008080">;</font>  <font color="#666666">// 30896 bytes</font> <br>  memoryUsage <font color="#008000">(</font> memory_get_usage <font color="#008000">(</font> <font color="#008000">)</font> , $ base_memory_usage <font color="#008000">)</font> <font color="#008080">;</font>  <font color="#666666">// 15496 bytes</font> <br>  unset <font color="#008000">(</font> $ a, $ b <font color="#008000">)</font> <font color="#008080">;</font> <br>  memoryUsage <font color="#008000">(</font> memory_get_usage <font color="#008000">(</font> <font color="#008000">)</font> , $ base_memory_usage <font color="#008000">)</font> <font color="#008080">;</font>  <font color="#666666">// 0 bytes</font> <br>  <font color="#008080">?</font>  <font color="#000080">&gt;</font> <br></blockquote></div><p>Source: <a href="https://habr.com/ru/post/134784/">https://habr.com/ru/post/134784/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../134775/index.html">Time-lapse rendering based on individual frames</a></li>
<li><a href="../134777/index.html">My first steps in SWT: A simple tabbed notebook</a></li>
<li><a href="../134778/index.html">Grand Theft Auto 3 is already available on Android and iOS</a></li>
<li><a href="../134780/index.html">The world will not see smartphones based on BlackBerry 10 until the end of 2012</a></li>
<li><a href="../134781/index.html">Scanning in 3D with a camera or 123D Catch</a></li>
<li><a href="../134785/index.html">Sony Ericsson Xperia Trio Receives Ice Cream Sandwich</a></li>
<li><a href="../134787/index.html">As in python, externally check the values ‚Äã‚Äãpassed to the function.</a></li>
<li><a href="../134788/index.html">Work with binary files in the style of STL</a></li>
<li><a href="../134789/index.html">Iria</a></li>
<li><a href="../134790/index.html">Lifemeter.ru - people against laziness</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>