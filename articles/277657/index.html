<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Your cloud hosting in 5 minutes. Part 0: Virtualization</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi Habr! I have already published three parts from a series of articles ( one , two , three ), and here part 0 is like a lot of snow. How so? The fact...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Your cloud hosting in 5 minutes. Part 0: Virtualization</h1><div class="post__text post__text-html js-mediator-article"> <a href="https://habrahabr.ru/post/277657/"><img src="https://habrastorage.org/files/927/a6b/ddd/927a6bddddd749fbbe4c6d091e0765ff.jpg"></a> <br><br>  Hi Habr!  I have already published three parts from a series of articles ( <a href="https://habrahabr.ru/post/261415/">one</a> , <a href="https://habrahabr.ru/post/262397/">two</a> , <a href="https://habrahabr.ru/post/264269/">three</a> ), and here part 0 is like a lot of snow.  How so?  The fact is that virtualization is optional when building our hosting.  This article is self-sufficient, it is not related to other parts of the cycle.  You may not read them at all if you just want to split your dedicated server into several virtual machines. <br><br>  All that I can tell can be done by an ordinary programmer within 5 minutes, simply by running a set of scripts for Ansible, which I prepared especially for you and <a href="https://github.com/vkozlovski/ansible-virtualization">uploaded to GitHub</a> . <br><a name="habracut"></a><br><h4>  <font color="#d62631">Content</font> </h4><br><ul><li>  Part 0: Virtualization </li><li>  Part 1: <a href="https://habrahabr.ru/post/261415/">Ansible, Docker, Docker Swarm</a> </li><li>  Part 2: <a href="http://habrahabr.ru/post/262397/">Service Discovery</a> </li><li>  Part 3: <a href="http://habrahabr.ru/post/264269/">Consul, Registrator, Consul-Template</a> </li><li>  ... </li></ul><br><h1>  <font color="#d62631">Training</font> </h1><br>  Download a <a href="">set of scripts</a> or clone the repository: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre><code class="bash hljs">¬ª git <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> https://github.com/vkozlovski/ansible-virtualization ¬ª git checkout v1.x ¬ª <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ansible-virtualization</code> </pre> <br>  At this preparatory work can be considered complete. <br><br>  Oh yeah, I almost forgot, you will need at least one dedicated server with authorization by key. <br><br><h1>  <font color="#d62631">Configuration</font> </h1><br>  The configuration we will perform on the example of Hetzner.  All configuration files that we will edit are in the <b>host_vars</b> directory: <br><br><ul><li>  <i>dc16-host1-vm1.yml</i> - virtual machine configuration number 1 </li><li>  <i>dc16-host1-vm2.yml</i> - virtual machine configuration ‚Ññ2 </li><li>  .. </li><li>  <i>dc16-host1.yml</i> - host configuration </li></ul><br>  In our example, we are creating 6 virtual machines, just as many single IP addresses per server can issue Hetzner.  Let's analyze what we have here in the configuration files: <br><br><h4>  <font color="#d62631">dc16-host1.yml</font> </h4><br>  Host configuration: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># Host 1 ansible_ssh_host: 5.9.45.106 # IPv4    ansible_ssh_user: root #    # net vm_bridge: virbr0 ipv4: true ipv4_address: 5.9.45.106/27 # IPv4      ipv4_gateway: 5.9.45.97 # IPv4    ipv4_dns: 213.133.100.100 213.133.98.98 213.133.99.99 # Hetzner IPv4 DNS ipv6: true ipv6_address: 2a01:4f8:163:326a::2 # IPv6    ipv6_mask: 64 ipv6_gateway: fe80::1 # IPv6    ipv6_dns: 2a01:4f8:0:a0a1::add:1010 2a01:4f8:0:a102::add:9999 2a01:4f8:0:a111::add:9898 # Hetzner IPv6 DNS # apt apt_host: ftp.de.debian.org</span></span></code> </pre><br>  Hetzner sends <i>IPv4</i> and <i>IPv6</i> addresses in a letter when ordering a server.  The remaining values ‚Äã‚Äãof the variables you can look in your account.  I took the <i>IPv4</i> and <i>IPv6</i> addresses of the <i>DNS</i> servers to Hetzner's wiki. <br><br><h4>  <font color="#d62631">dc16-host1-vm1.yml</font> </h4><br>  Virtual Machine # 1 Configuration: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># Debian 1 # kvm-host ansible_ssh_host: 5.9.45.106 # IP   ( )  ansible_ssh_user: root #   ( )  # vnc (port: 5900) vnc_password: "kBz4Yp3UyVEPMr" #     VNC  # vm vm_num: 1 # uniq 0-15 vm_name: debian1 #     vm_hdd_size: 10G #  10  vm_memory: 2048 #    vm_swap_size: 2048 #      vm_cpu: 2 #   vm_bridge: virbr0 vm_root_password: "3yMAqs3yTcuKvZ" #   root    # net vm_ipv4: true vm_ipv4_address: 5.9.244.210 # IPv4    vm_ipv4_mask: 29 vm_ipv4_gateway: 5.9.244.209 # IPv4    vm_ipv4_dns: 213.133.98.98 213.133.99.99 213.133.100.100 # Hetzner IPv4 DNS vm_ipv6: true vm_ipv6_address: 2a01:4f8:163:326a::d1 # IPv6    vm_ipv6_mask: 64 vm_ipv6_gateway: fe80::1 # IPv6    vm_ipv6_dns: 2a01:4f8:0:a0a1::add:1010 2a01:4f8:0:a102::add:9999 2a01:4f8:0:a111::add:9898 # Hetzner IPv6 DNS vm_mac: 00:52:54:56:88:88</span></span></code> </pre><br>  The values ‚Äã‚Äãof the variables <i>vm_ipv4_address</i> , <i>vm_ipv4_mask</i> and <i>vm_ipv4_gateway are</i> sent by Hetzner when ordering an additional <i>IP</i> address.  <i>The IPv4</i> and <i>IPv6</i> addresses of the <i>DNS</i> servers are the same as those of the host machine.  You can order an additional <i>IPv4</i> address in your account.  Hetzner asks to indicate the purpose for which you need an additional address, I write one word there - ‚ÄúVirtualization‚Äù. <br><br>  About <i>IPv6</i> : each server receives a / 64 subnet.  Accordingly, you can take any addresses from it.  For example, for <i>2a01: 4f8: 163: 326a :: / 64</i> : <br><br><ul><li>  <i>2a01: 4f8: 163: 326a :: d1</i> </li><li>  <i>2a01: 4f8: 163: 326a :: d2</i> </li><li>  ... </li><li>  <i>2a01: 4f8: 163: 326a :: d6</i> </li></ul><br>  To specify the value of the variable <i>vm_mac</i> , you need to get a separate <i>MAC address</i> for the specified <i>IP</i> .  This can be done in your account. <br><br>  That's all, you can start the launch. <br><br><h1>  <font color="#d62631">Launch</font> </h1><br>  The launch is done by two teams.  The first installs the necessary packages and configures the host machine: <br><br><pre> <code class="bash hljs">$ ansible-playbook -i prod kvm.yml</code> </pre><br>  The second team creates, configures and starts virtual machines: <br><br><pre> <code class="bash hljs">$ ansible-playbook -i prod guests.yml</code> </pre><br>  After running and executing these two commands, your virtual machines should be running and accessible from the outside.  Your public key was copied to all virtuals, so the authorization will be by key. <br><br><h1>  <font color="#d62631">Total</font> </h1><br>  We use this set of scripts for quite a long time and everything works as expected.  This greatly simplified life and allowed us to quickly add new computing resources to our modest cloud.  If you have any questions - welcome to the comments. <br><br>  That's all.  Thank you all for your attention.  Stable clouds and good luck to you! <br><br>  <a href="https://twitter.com/vkozlovski">Follow me on Twitter</a> , I talk about working in a startup, my mistakes and the right decisions, about python and everything related to web development. <br><br>  PS <i>I'm looking for developers to the company, the details in my <a href="http://habrahabr.ru/users/vladkozlovski/">profile</a> .</i> </div><p>Source: <a href="https://habr.com/ru/post/277657/">https://habr.com/ru/post/277657/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../277643/index.html">Load testing - product quality assurance stage</a></li>
<li><a href="../277645/index.html">Amelisa. Offline and realtime engine for React and Mongo</a></li>
<li><a href="../277649/index.html">50 shades of paranoia or how to store passwords without saving</a></li>
<li><a href="../277653/index.html">Installing a Django project on a VPS (centOS 7) [For Beginners]</a></li>
<li><a href="../277655/index.html">Access MySQL data from a UWP application without using services</a></li>
<li><a href="../277663/index.html">What we should build LVM (principle of operation, performance, Thin Provision)</a></li>
<li><a href="../277665/index.html">Alternative to native support module in JIRA</a></li>
<li><a href="../277669/index.html">Java.util.concurrent. * Synchronizer reference</a></li>
<li><a href="../277671/index.html">Math on the fingers: linear-quadratic controller</a></li>
<li><a href="../277673/index.html">Free Photoshop Script: Export Vector Layers from PSD to SVG</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>