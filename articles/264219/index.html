<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ipgeobase in nginx</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="When a problem arises, it seems to get the city and the tax (car) code of the region at the visitor‚Äôs address - it‚Äôs just that, it‚Äôs full of such piec...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>ipgeobase in nginx</h1><div class="post__text post__text-html js-mediator-article">  When a problem arises, it seems to get the city and the tax (car) code of the region at the visitor‚Äôs address - it‚Äôs just that, it‚Äôs full of such pieces in the internet! <br>  And then you look: some are paid, others cannot be deployed, others are possible, but this is resource-intensive, the fourth people do not know anything about the regions of the Russian Federation ... <br>  And here the sick brain of a programmer with an obsessive idea hurries to the rescue: <b>"Do not have the others - do it yourself"</b> <br><br><a name="habracut"></a><br><br>  As soon as you begin to think in this vein - here, nginx has an excellent geoip module, which ‚Äúis not only fast, but also optimized to the point of impossibility‚Äù.  But here is an ill luck, he does not understand any of the known database formats (MaxMind, Sypex, ipgeobase). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      A couple of hours in an embrace with a python and now there is a good converter that pulls out all we need from the site ipgeobase.ru. <br>  (Yes, there were rumors that everyone had been fired there for half a year now, but the bases are regularly updated, which is good news) <br><br>  And so that there are no concerns, I will comment on the code below (if not interested, you can immediately flip to the setting) <br><h4>  Code </h4><br><br><div class="spoiler">  <b class="spoiler_title">1. Download the database</b> <div class="spoiler_text">  There is nothing complicated, requests + zipfile: <br><pre><code class="python hljs">archive = requests.get(<span class="hljs-string"><span class="hljs-string">"http://ipgeobase.ru/files/db/Main/geo_files.zip"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> archive.status_code != <span class="hljs-number"><span class="hljs-number">200</span></span>: error(<span class="hljs-string"><span class="hljs-string">"IPGeobase no answer: %s"</span></span> % archive.status_code) extracteddata = ZipFile(StringIO(archive.content)) filelist = extracteddata.namelist() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-string"><span class="hljs-string">"cities.txt"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> filelist: error(<span class="hljs-string"><span class="hljs-string">"cities.txt not downloaded"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-string"><span class="hljs-string">"cidr_optim.txt"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> filelist: error(<span class="hljs-string"><span class="hljs-string">"cidr_optim.txt not downloaded"</span></span>)</code> </pre> <br></div></div><br><br><div class="spoiler">  <b class="spoiler_title">2. We load the dictionary of regions</b> <div class="spoiler_text"><pre> <code class="python hljs">REGIONS = dict(l.decode(<span class="hljs-string"><span class="hljs-string">"utf8"</span></span>).rstrip().split(<span class="hljs-string"><span class="hljs-string">"\t"</span></span>)[::<span class="hljs-number"><span class="hljs-number">-1</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> l <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> open(<span class="hljs-string"><span class="hljs-string">"regions.tsv"</span></span>).readlines())</code> </pre><br>  where regions.tsv is a list of automotive / tax codes of regions, of the form: <br> <code>66   <br> 77  <br> 78 - <br></code> <br></div></div><br><br><div class="spoiler">  <b class="spoiler_title">3. Get a dictionary of cities</b> <div class="spoiler_text">  For each city we need to know its id, name and region code: <br><pre> <code class="python hljs">CITIES = {} <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> line <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> extracteddata.open(<span class="hljs-string"><span class="hljs-string">"cities.txt"</span></span>).readlines(): cid, city, region_name, _, _, _ = line.decode(<span class="hljs-string"><span class="hljs-string">"cp1251"</span></span>).split(<span class="hljs-string"><span class="hljs-string">"\t"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> region_name <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> REGIONS: CITIES[cid] = {<span class="hljs-string"><span class="hljs-string">'city'</span></span>: b64encode(city.encode(<span class="hljs-string"><span class="hljs-string">"utf8"</span></span>)), <span class="hljs-string"><span class="hljs-string">'reg_id'</span></span>: REGIONS[region_name]} <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> cid == <span class="hljs-string"><span class="hljs-string">"1199"</span></span>: <span class="hljs-comment"><span class="hljs-comment"># Zelenograd fix CITIES[cid]['reg_id'] = "77"</span></span></code> </pre><br><br>  I note that here immediately, with an eye to the future, the utf-8 name of the city is encoded in base64, to expand the possibilities of use (for example, in the nginx logs), without the need to work with transliteration. <br></div></div><br><br><div class="spoiler">  <b class="spoiler_title">4. We glue the address ranges and cities</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> line <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> extracteddata.open(<span class="hljs-string"><span class="hljs-string">"cidr_optim.txt"</span></span>).readlines(): _, _, ip_range, country, cid = line.decode(<span class="hljs-string"><span class="hljs-string">"cp1251"</span></span>).rstrip().split(<span class="hljs-string"><span class="hljs-string">"\t"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> country == <span class="hljs-string"><span class="hljs-string">"RU"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> cid <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> CITIES: database[<span class="hljs-string"><span class="hljs-string">""</span></span>.join(ip_range.split())] = CITIES[cid]</code> </pre><br>  Obviously, if the country is not Russia, then there will be no regions or cities in ipgeobase, and our tasks do not need such ranges. <br></div></div><br><br><div class="spoiler">  <b class="spoiler_title">5. Generate files for geoip module</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">with</span></span> open(<span class="hljs-string"><span class="hljs-string">"region.txt"</span></span>, <span class="hljs-string"><span class="hljs-string">"w"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> reg, open(<span class="hljs-string"><span class="hljs-string">"city.txt"</span></span>, <span class="hljs-string"><span class="hljs-string">"w"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> city: <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> ip_range <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> sorted(database): info = database[ip_range] city.write(<span class="hljs-string"><span class="hljs-string">"%s %s;\n"</span></span> % (ip_range, info[<span class="hljs-string"><span class="hljs-string">'city'</span></span>])) reg.write(<span class="hljs-string"><span class="hljs-string">"%s %s;\n"</span></span> % (ip_range, info[<span class="hljs-string"><span class="hljs-string">'reg_id'</span></span>]))</code> </pre><br></div></div><br><br><h4>  Nginx configuration </h4><br><br>  For everything to work, you need to enable the <a href="http_geo_module.html">nginx.org/ru/docs/http/ngx_http_geo_module.html</a> module in nginx geo, <br>  put the generated files in a known place and add such a config to the http section: <br><pre> <code class="nginx hljs"><span class="hljs-attribute"><span class="hljs-attribute">geo</span></span> <span class="hljs-variable"><span class="hljs-variable">$region</span></span> { ranges; <span class="hljs-attribute"><span class="hljs-attribute">include</span></span> geo/region.txt; } <span class="hljs-attribute"><span class="hljs-attribute">geo</span></span> <span class="hljs-variable"><span class="hljs-variable">$city</span></span> { ranges; <span class="hljs-attribute"><span class="hljs-attribute">include</span></span> geo/city.txt; }</code> </pre><br>  After such manipulations, two variables $ city and $ region will appear in nginx, which can be used anywhere: <br><br><ul><li>  at least in the log: <pre> <code class="nginx hljs"><span class="hljs-attribute"><span class="hljs-attribute">log_format</span></span> long <span class="hljs-string"><span class="hljs-string">'</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$time_iso8601</span></span></span><span class="hljs-string">\t</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$msec</span></span></span><span class="hljs-string">\t</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$host</span></span></span><span class="hljs-string">\t</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$request_method</span></span></span><span class="hljs-string">\t</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$uri</span></span></span><span class="hljs-string">\t</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$args</span></span></span><span class="hljs-string">\t</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$http_referer</span></span></span><span class="hljs-string">\t</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$remote_addr</span></span></span><span class="hljs-string">\t</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$http_user_agent</span></span></span><span class="hljs-string">\t</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$status</span></span></span><span class="hljs-string">\t</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$request_time</span></span></span><span class="hljs-string">\t</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$request_length</span></span></span><span class="hljs-string">\t</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$upstream_addr</span></span></span><span class="hljs-string">\t</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$bytes_sent</span></span></span><span class="hljs-string">\t</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$upstream_response_time</span></span></span><span class="hljs-string">\t</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$city</span></span></span><span class="hljs-string">\t</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$region</span></span></span><span class="hljs-string">'</span></span>;</code> </pre></li><li>  at least sending in to the application: <br><pre> <code class="nginx hljs"><span class="hljs-attribute"><span class="hljs-attribute">location</span></span> / { <span class="hljs-attribute"><span class="hljs-attribute">proxy_set_header</span></span> X-City <span class="hljs-variable"><span class="hljs-variable">$city</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">proxy_set_header</span></span> X-Region <span class="hljs-variable"><span class="hljs-variable">$region</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">proxy_pass</span></span> http://backend; }</code> </pre><br>  At the same time, in the geo module, by default, all the missing addresses will return an empty string, in which case the header will simply not be installed <br></li></ul><br><br>  In fact, such a module works just instantly, does not load nginx, and due to the easy automation of database updates, it is fairly accurate (it all depends on trust in the ipgeobase.ru databases).  In this connection, there was a feeling that he might be useful to someone else.  So I propose to use and, maybe, make converters to other data providers. <br><br>  <a href="https://github.com/m-messiah/ip2geo">GitHub</a> code (ipgeobase-importer branch) <br><br>  PS After a while, after writing the article, I rewrote everything on Go and added support for MaxMind </div><p>Source: <a href="https://habr.com/ru/post/264219/">https://habr.com/ru/post/264219/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../264201/index.html">Intervals in C ++, part 1: Intervals with limiters</a></li>
<li><a href="../264207/index.html">Is there a problem with the MTS mobile traffic in some regions, or the skis do not travel?</a></li>
<li><a href="../264209/index.html">PHP library for integration with the New Mail API</a></li>
<li><a href="../264213/index.html">Are you still using CJSON?</a></li>
<li><a href="../264217/index.html">Apply correlation in retail</a></li>
<li><a href="../264221/index.html">Oracle Exadata, or About the Use of Engineered Systems (Part 2)</a></li>
<li><a href="../264223/index.html">Simple plan-fact analysis in Power BI Desktop. Part Two - Visualization</a></li>
<li><a href="../264225/index.html">Parsim pod from Perl 5 with Perl 6</a></li>
<li><a href="../264227/index.html">Underground carders market. Translation of the book "KingPIN". Chapter 1. "Key"</a></li>
<li><a href="../264229/index.html">Calque - a calculator that is more convenient than the browser console</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>