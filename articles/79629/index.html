<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We make our own NTP server Stratum-1</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The habrauser BarsMonster with his topic "About the exact time" pushed me to write this note. 
 In his article, he called on habrauser "Give more Stra...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We make our own NTP server Stratum-1</h1><div class="post__text post__text-html js-mediator-article">  The habrauser <a href="https://habrahabr.ru/users/barsmonster/" class="user_link">BarsMonster</a> with his topic <a href="http://habrahabr.ru/blogs/sysadm/79461/">"About the exact time"</a> pushed me to write this note. <br>  In his article, he called on habrauser "Give more Stratum-1 servers", but did not say how (: <br><a name="habracut"></a><br><h4>  The choice of the source of exact time </h4><br>  I did this work about three years ago, when there was much less information on this topic online.  The main source of my knowledge was the documentation from the ntp-doc package (/usr/share/doc/ntp-doc/html/refclock.html), and it can also be found on the <a href="http://www.eecis.udel.edu/~mills/ntp/html/refclock.html">web</a> . <br><br>  The name Stratum-1 itself means that our NTP server is directly connected to the exact time source. <br>  Let's see what we have options for these sources: <br><ol><li>  <b>Time radio stations</b> <br>  Nothing complicated, we take the appropriate frequency from the <a href="http://yandex.ru/yandsearch%3Ftext%3D%25D0%25A1%25D0%25BF%25D1%2580%25D0%25B0%25D0%25B2%25D0%25BE%25D1%2587%25D0%25BD%25D0%25B8%25D0%25BA%2B%25D0%25BA%25D0%25BE%25D1%2580%25D0%25BE%25D1%2582%25D0%25BA%25D0%25BE%25D0%25B2%25D0%25BE%25D0%25BB%25D0%25BD%25D0%25BE%25D0%25B2%25D0%25B8%25D0%25BA%25D0%25B0%26from%3Dos%26lr%3D213">directory</a> , solder the receiver and the converter into an interface convenient for the computer.  ^ _ ^ <br>  I abandoned this option because  Opposite of my old work, the building stood either FAPSI, or some other service, in general, the broadcast was quite noisy (-: <br></li><li>  <b>GSM or CDMA phone</b> <br>  Somehow I do not trust them, although not the worst option. <br></li><li>  <b>GPS or GLONASS receiver</b> <br>  This option seemed to me the most realistic. </li></ol><br><h4>  We connect </h4><br>  The GLONASS receiver was then difficult to get, so I went to the store and bought a GPS receiver with an RS232 interface and an external antenna.  The antenna stuck to the metal window sill outside the window, and the receiver, respectively, connected to the COM port of one of the servers. <br><br>  First of all, we need to make sure that the receiver "sees" the satellites.  My, for example, in this case begins to wink at a fun LED. <br>  A more universal way is to see what it gives to the COM port: <br><blockquote>  cat / dev / ttyS0 </blockquote><br>  Here we should see a NMEA protocol dump. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Customize </h4><br>  For ntpd to work, we need to make symbolic links: <br><blockquote>  / dev / gps0 -&gt; / dev / ttyS0 <br></blockquote><br>  If you use udev, then it will be useful to create a rule /etc/udev/rules.d/10-gps.rules with the following content: <br><blockquote>  KERNEL == "ttyS0", NAME = "% k", SYMLINK + = "gps0", MODE = "0660", GROUP = "uucp" <br></blockquote><br><br>  Modify ntp.conf: <br><blockquote>  # Local Clock - if we lose satellites, then reduce the stratum to 10 <br>  server 127.127.1.0 <br>  fudge 127.127.1.0 stratum 10 <br><br>  # NMEA GPS driver <br>  server 127.127.20.0 prefer <br><br>  driftfile /var/lib/ntp/ntp.drift <br>  restrict default nomodify notrust # Give time to everyone <br>  restrict 127.0.0.1 # Allow yourself everything <br>  disable auth <br>  logfile / var / log / ntp / messages <br></blockquote><br>  In the line server 127.127.20.0, the number 20 is the <strike>answer to the ‚Äúmain question of life, the universe and in general‚Äù the</strike> number of the corresponding <a href="http://www.eecis.udel.edu/~mills/ntp/html/drivers/driver20.html">driver of the exact time source</a> . <br><br>  Restart the NTPD and see the status.  There must be something like this: <br><blockquote><code>ntpq -p <br> remote refid st t when poll reach delay offset jitter <br> ============================================================================== <br> LOCAL(0) LOCAL(0) 10 l 52 64 377 0.000 0.000 0.002 <br> *GPS_NMEA(0) .GPS. 0 l 15 64 377 0.000 -0.018 0.004 <br></code> <br></blockquote><br>  Everything, the server can be <strike>promoted to</strike> register in the <a href="http://support.ntp.org/bin/view/Servers/StratumOneTimeServers">list of stratum-1 servers</a> . <br><br>  I hope this article will help to increase the number of good NTP servers in RuNet (-; <br><br>  <b>[Important UPD]</b> <br>  A person knocked me in IM, he does not have an account on Habr√©, asked me to clarify the situation with COM-USB adapters.  I quote: <br><blockquote>  brn: <br>  So, since in the receivers often one of the service pins of the COM connector is connected to a 1PPS signal, which indicates the beginning of the next second, in the case of USB this signal will be lost <br>  And, since the NMEA signal without PPS gives an accuracy of about 50-100 milliseconds, and for an exact time server this is unacceptable <br></blockquote><br>  This just explains why I had such a run-up with a colleague from Novosibirsk - my PPS receiver did not support. <br>  To use PPS, you need to replace NMEA with PPS in the ntp config: <br><blockquote>  # PPS driver <br>  server 127.127.22.0 prefer <br>  enable pps <br></blockquote><br>  <b>[UPD2]</b> <br>  We <a href="https://habrahabr.ru/users/brn/" class="user_link">meet</a> new habrakollegu <a href="https://habrahabr.ru/users/brn/" class="user_link">brn</a> ! <br>  He has already managed to write a <a href="http://brn.habrahabr.ru/blog/79701/">topic about NMEA</a> . <br><br>  <a href="https://habrahabr.ru/users/barsmonster/" class="user_link">BarsMonster</a> , thanks for the invite. </div><p>Source: <a href="https://habr.com/ru/post/79629/">https://habr.com/ru/post/79629/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../79612/index.html">Save HTML page as PDF, JPEG</a></li>
<li><a href="../79613/index.html">From the creators of the Rollers officials. Santa Claus Clip</a></li>
<li><a href="../79615/index.html">More xpPhone!</a></li>
<li><a href="../79619/index.html">Beeline - live on the black stripe</a></li>
<li><a href="../79621/index.html">Summing up the year. The turnover of my studio (in rubles) for 2009 compared to 2008:</a></li>
<li><a href="../79630/index.html">STI - one table and many models.</a></li>
<li><a href="../79631/index.html">Details about the hacking algorithm A5 / 1</a></li>
<li><a href="../79633/index.html">Business 160 bytes. Part Three, Educational</a></li>
<li><a href="../79635/index.html">How printbook stole christmas</a></li>
<li><a href="../79637/index.html">The magnetic pole began to move faster.</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>