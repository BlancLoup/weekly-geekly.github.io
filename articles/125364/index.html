<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>FPGA clock with Quartus II and some Verilog</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this topic I want to talk about how to FPGA you can implement the clock. Someone may find this strange, unnecessary - but one has to start somewher...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>FPGA clock with Quartus II and some Verilog</h1><div class="post__text post__text-html js-mediator-article"> In this topic I want to talk about how to FPGA you can implement the clock.  Someone may find this strange, unnecessary - but one has to start somewhere, so this topic will be useful for beginners who have blinked with LEDs and want something more interesting. <br> <a href="http://www.radikal.ru/"><img src="https://habrastorage.org/getpro/geektimes/post_images/483/ff4/90e/483ff490e77f78c43fc2549d95bba1d1.jpg"></a> <br><a name="habracut"></a><br>  It means that we have: <br>  1) Terasic DE0-Nano debug board with Cyclone IV on board. <br><img src="https://habrastorage.org/getpro/geektimes/post_images/5af/5ba/d15/5af5bad1581e7a8c74da5ab8b347290c.jpg" alt="image"><br>  2) A model with a seven-segment indicator soldered on it, to which we will output hours and minutes / <br>  For these two points, complete freedom of choice almost any FPGA will do, and even one will do the layout with the indicator as it does. <br><br>  Now about the project. <br>  We will go in order.  First of all, let us ask ourselves: what is a watch?  A clock is a device that counts time.  In order to count it, we need an exact source.  Our board has a 50 MHz clock signal generator.  Too much, so we need to divide it by 50,000,000 to get a frequency of 1 Hz (one ‚Äútick‚Äù per second).  How to share?  I did it in two stages: using PLL, divided by 50 and using a counter, divided by a million. <br>  What is a PLL?  Roughly speaking, this is such a thing that can change the clock signal: multiply, divide, shift in phase, change the duty cycle.  Cyclone IV has 4 of them, so why not use one ... <br><br>  To do this, open the MegaWizard Plugin Manager and use ALT_PLL from the IO section: <br>  1) Set the input frequency to 50 MHz: <br> <a href="http://radikal.ru/F/i014.radikal.ru/1107/d0/e725e23b8f8e.png.html"><img src="https://habrastorage.org/getpro/geektimes/post_images/548/07b/487/54807b487a392e837f7ddfd6050568f3.jpg"></a> <br>  2) Disable unnecessary inputs: <br> <a href="http://radikal.ru/F/s39.radikal.ru/i085/1107/89/a5384e7c30b4.png.html"><img src="https://habrastorage.org/getpro/geektimes/post_images/b1f/27b/2e1/b1f27b2e16130b9cac18407693931ce1.jpg"></a> <br>  3) Click Next three times and get into the window of signal parameters selection, where we set the division factor to 50: <br> <a href="http://radikal.ru/F/s013.radikal.ru/i324/1107/21/aa131c13f830.png.html"><img src="https://habrastorage.org/getpro/geektimes/post_images/b43/7b5/1ae/b437b51aea45419db32fef34051fcfd0.jpg"></a> <br>  Then you can safely click Finish, save and paste into the project. <br>  This is the beauty we received: <br> <a href="http://radikal.ru/F/s56.radikal.ru/i151/1107/76/01ce50138f70.png.html"><img src="http://s56.radikal.ru/i151/1107/76/01ce50138f70t.jpg"></a> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      On the left is the input 50 MHz, on the right 1 MHz. <br>  Now we need to divide by another million - for this we use the counter modulo 1000000. The counting module is the number of possible states of the counter. <br>  We create it using the same MegaWizard using LPM_Counter. <br>  Set the bit depth - 20 bits, and choose modulus, with a count modulus of 1,000,000. <br>  We get this: <br> <a href="http://radikal.ru/F/s53.radikal.ru/i142/1107/3c/ca0492b69eee.png.html"><img src="https://habrastorage.org/getpro/geektimes/post_images/4d7/5b7/5d6/4d75b75d6d2e98461dfcf7042f0df6bf.jpg"></a> <br><br>  Now we have neat 1 Hz, which can be obtained from the senior (19) level. <br><br>  Next, we need to implement a cascade of 3 meters: two modulo 60 (minutes and seconds), and one modulo 24 (obviously, a clock). <br>  The second counter - with asynchronous reset, which occurs when you press any button (setting hours / minutes): <br> <a href="http://radikal.ru/F/s005.radikal.ru/i209/1107/b1/250646882d4a.png.html"><img src="https://habrastorage.org/getpro/geektimes/post_images/0bb/ade/617/0bbade617f819180e3c300a6ba6eb992.jpg"></a> <br>  As you can see, the Carry Out output is used (transfer in case of overflow to the next counter), and seconds are displayed on the LEDs. <br><br>  The following 2 counters are constructed in the same way, with one exception: to set the time, it is necessary to send a clock signal faster than 1 Hz, in order not to fall asleep when setting up.  :) <br>  For this we use button-controlled multiplexers: <br> <a href="http://radikal.ru/F/s56.radikal.ru/i151/1107/7f/e9be87634c8c.png.html"><img src="http://s56.radikal.ru/i151/1107/7f/e9be87634c8ct.jpg"></a> <br><br>  The upper multiplexer is used to select which frequency to feed to the counter, and the lower one chooses what to input to cin: transfer from the cout second counter, or just the log level.  "one". <br>  The essence of the cin input is that the meter counts only if there is a logical unit level at this input.  That is, when the seconds counter overflows, it raises the cout to one.  This ‚Äú1‚Äù is fed to the cin input of the next counter and it reports one minute, and so on. <br>  Thus, when the key [0] button is released, the minute counter counts 1 time per minute (which is logical), and when it is pressed, it counts about 4 times per second. <br><br>  Similarly for an hour counter: <br> <a href="http://radikal.ru/F/s60.radikal.ru/i170/1107/60/ee688dad7482.png.html"><img src="https://habrastorage.org/getpro/geektimes/post_images/eee/36d/22d/eee36d22d1bcdbe631c7c541a23b4923.jpg"></a> <br>  The upper multiplexer controls the transfer, and the lower frequency, with the exception of one moment: when the key [0] button is pressed, the clock signals do not arrive at the meter's water (this is done so that the clock does not get lost when setting the minutes).  This is done by the AND element, to the input of which a clock signal and key [0] are supplied.  When the button is released, the key [0] is high and q [19] passes through it, while the button is pressed, the level is ‚Äú0‚Äù and the output is also ‚Äú0‚Äù.  In principle, it would be possible to enable the ‚Äúcount enable‚Äù input at the counter and disable the counter through it ‚Äî in this task it is not fundamental. <br><br>  Now we need to display data from the counters.  To do this, we need to make a binary to decimal converter.  This is a representation of the decimal number in binary code, when each decimal digit is given in separate 4 binary digits. <br>  Example: <br>  738 = 0111 0011 1000. <br><br>  For this conversion, we use the double-dabble algorithm. <br>  The essence of the algorithm: <br>  1) Move the binary number to the left by one digit. <br>  2) If 4 shifts - the number of BCD in the columns "tens" and "units".  End of algorithm <br>  3) If the number in any column is greater than 4, add 3. <br>  Go to P1. <br><br>  Here is an illustration: <br><img src="https://habrastorage.org/getpro/geektimes/post_images/5de/ce0/bf9/5dece0bf96c4d58bd5f418b72358b219.png" alt="image"><br><br>  And here is what we need to implement in order for this conversion to be done without delays: <br>  <a href="">s16.radikal.ru/i191/1107/a4/59618e3101ca.png</a> <br>  Each module C adds 3 to the input, if the input number is greater than 4. <br><br>  Here he himself and the truth of his work: <br><img src="https://habrastorage.org/getpro/geektimes/post_images/a21/0ac/88f/a210ac88fbab426f31e461a1b6c5f237.png" alt="image"><br>  To implement this whole economy, we write here two such modules on verilog: <br><br> <code>module add3(in,out); <br> input [3:0] in; <br> output [3:0] out; <br> reg [3:0] out; <br> <br> always @ (in) <br> case (in) <br> 4'b0000: out &lt;= 4'b0000; <br> 4'b0001: out &lt;= 4'b0001; <br> 4'b0010: out &lt;= 4'b0010; <br> 4'b0011: out &lt;= 4'b0011; <br> 4'b0100: out &lt;= 4'b0100; <br> 4'b0101: out &lt;= 4'b1000; <br> 4'b0110: out &lt;= 4'b1001; <br> 4'b0111: out &lt;= 4'b1010; <br> 4'b1000: out &lt;= 4'b1011; <br> 4'b1001: out &lt;= 4'b1100; <br> default: out &lt;= 4'b0000; <br> endcase <br> endmodule <br> <br> module binary_to_BCD(A,ONES,TENS); <br> input [5:0] A; <br> output [3:0] ONES, TENS; <br> <br> wire [3:0] c1,c2,c3; <br> wire [3:0] d1,d2,d3; <br> <br> assign d1 = {1'b0,A[5:3]}; <br> assign d2 = {c1[2:0],A[2]}; <br> assign d3 = {c2[2:0],A[1]}; <br> add3 m1(d1,c1); <br> add3 m2(d2,c2); <br> add3 m3(d3,c3); <br> assign ONES = {c3[2:0],A[0]}; <br> assign TENS = {1'b0,c1[3],c2[3],c3[3]}; <br> endmodule <br></code> <br>  Save and paste into the project in the amount of two pieces: <br><img src="http://i003.radikal.ru/1107/1c/7ee155661713.png" alt="image"><br>  One will be for hours, the other for minutes. <br><br>  Now it is necessary to make a lyrical digression regarding our indicator. <br>  I used Lite-On ltc-4727js. <br>  According to the datasheet, it has segments with a common cathode for each digit + inputs of the anodes of the segments of each digit combined.  This means that we can light only 1 digit at a time.  It does not matter, we will light them in turn, only we will switch very quickly.  So fast that even Chuck Norris will not notice a flicker ;-) <br>  The most interesting parts of the datasheet: <br><img src="http://s58.radikal.ru/i162/1107/37/a1f8b338648a.png" alt="image"><br>  and <br> <a href="http://radikal.ru/F/s40.radikal.ru/i090/1107/6b/acea85b89e43.png.html"><img src="http://s40.radikal.ru/i090/1107/6b/acea85b89e43t.jpg"></a> <br>  How did I connect all this? <br>  But using these pins: <br> <a href="http://radikal.ru/F/s44.radikal.ru/i104/1107/da/300fddcab566.png.html"><img src="http://s44.radikal.ru/i104/1107/da/300fddcab566t.jpg"></a> <br>  With the segments, I think, everything is clear, but what is the mysterious digit [4..0] ... Everything is simple - digit [4..1] - <br>  these are our digits, and the digit [0] is an auxiliary segment (a colon between 2 and 3 digits).  I will tell you, the most difficult thing is to correctly connect everything and correctly set the correspondence between the FPGA outputs and our pines! <br><br>  Let us now analyze the output mechanism on the indicator. <br>  This is such a monstrous design: <br> <a href="http://radikal.ru/F/s010.radikal.ru/i311/1107/7a/dc8740abf0d5.png.html"><img src="http://s010.radikal.ru/i311/1107/7a/dc8740abf0d5t.jpg"></a> <br>  On the left we have bin-to-BCD converters.  In the center of attention - a multiplexer for 5 inputs with a width of 4 bits.  The first 4 inputs are digits, the fifth input is for igniting points (which flash once a second).  Below you can see the scheme, which for this second entry serves 1111 or 1110. About why this is so - a little further.  Depending on what combination comes to the control input of the multiplexer, it outputs the necessary digit to the decoder (the device of which we will consider a little later).  Above it is a device that chooses which cathode to apply ‚Äú0‚Äù to light up the desired segment.  Here are his insides: <br><br> <code>module segment_select (in,out,sel); <br> input in; <br> output reg [4:0] out; <br> output reg [2:0] sel; <br> <br> always @ (posedge in) <br> if (sel == 4) <br> sel = 0; <br> else sel = sel + 1; <br> <br> always @(*) <br> case (sel) <br> 0: out &lt;= 5'b0zzzz; <br> 1: out &lt;= 5'bz0zzz; <br> 2: out &lt;= 5'bzz0zz; <br> 3: out &lt;= 5'bzzz0z; <br> 4: out &lt;= 5'bzzzz0; <br> default: out &lt;= 5'bzzzzz; <br> endcase <br> endmodule <br></code> <br>  Pay attention to the record type 5'b0zzzz.  Here 5'b means that we set 5 bits in binary form, 0 - zero level, z - high-resistance state (current does not flow to pin).  And why exactly 0?  Yes, because we have a common cathode on the figure, the current flows from the anode to the cathode, or from 1 to 0. So we set 0 on the cathode, and 1 on the anode. <br><br>  Now the device decoder: <br><br> <code>module decoder_7seg (BCD, segA, segB, segC, segD, segE, segF, segG, segDP); <br> <br> input [3:0] BCD; <br> output segA, segB, segC, segD, segE, segF, segG, segDP; <br> reg [7:0] SevenSeg; <br> always @(BCD) <br> case(BCD) <br> 4'h0: SevenSeg = 8'b11111100; <br> 4'h1: SevenSeg = 8'b01100000; <br> 4'h2: SevenSeg = 8'b11011010; <br> 4'h3: SevenSeg = 8'b11110010; <br> 4'h4: SevenSeg = 8'b01100110; <br> 4'h5: SevenSeg = 8'b10110110; <br> 4'h6: SevenSeg = 8'b10111110; <br> 4'h7: SevenSeg = 8'b11100000; <br> 4'h8: SevenSeg = 8'b11111110; <br> 4'h9: SevenSeg = 8'b11110110; <br> 4'b1111: SevenSeg = 8'b11000000; <br> default: SevenSeg = 8'b00000000; <br> endcase</code> <br> <br>  assign {segA, segB, segC, segD, segE, segF, segG, segDP} = SevenSeg; <br>  endmodule <br>  Here, depending on what number we need, it is chosen which segments to light. <br>  Two points of interest are the default and the number 1111. When our BCD accepts a value different from the given (1110, which was mentioned earlier), then all segments are turned off.  When 1111 arrives here, segments A and B are lit. As you can see from the datasheet, they are also connected to points L1 and L2. <br><br>  That's all. <br>  We put everything together in <s>one pile</s> , assign pins, compile (yeah, use less than 1% of our mighty pebble) and fill it into FPGA. <br><br>  Here is the project: <br>  <a href="http://ifolder.ru/24865983">ifolder.ru/24865983</a> <br>  It is necessary to choose your FPGA, and reassign pins.  True, I used PLL ... Therefore, when transferring a project to another FPGA, you will need your input frequency (not a fact that you will have 50 MHz there) to divide it yourself. <br>  Here's a video: <br><br>  <a href="http://www.youtube.com/watch%3Fv%3DiUoiOO8wYls">www.youtube.com/watch?v=iUoiOO8wYls</a> <br>  Sources: <br>  1) Date on the indicator: <br>  <a href="http://pdf.eicom.ru/datasheets/lite-on_pdfs/ltc-4727js/ltc-4727js.pdf">pdf.eicom.ru/datasheets/lite-on_pdfs/ltc-4727js/ltc-4727js.pdf</a> <br>  2) Transfer from BIN to BCD: <br>  <a href="http://www.johnloomis.org/ece314/notes/devices/binary_to_BCD/bin_to_bcd.html">www.johnloomis.org/ece314/notes/devices/binary_to_BCD/bin_to_bcd.html</a> <br>  <a href="http://www.ece.msstate.edu/courses/ece4743/fall2007/Shift_add_3.pdf">www.ece.msstate.edu/courses/ece4743/fall2007/Shift_add_3.pdf</a> <br>  3) Segment output: <br>  <a href="http://www2.engr.arizona.edu/~rlysecky/courses/ece274-07f/labs/lab4.pdf">www2.engr.arizona.edu/~rlysecky/courses/ece274-07f/labs/lab4.pdf</a> <br>  <a href="http://we.easyelectronics.ru/Shematech/dinamicheskaya-indikaciya_2.html">we.easyelectronics.ru/Shematech/dinamicheskaya-indikaciya_2.html</a> <br>  <a href="http://www.fpga4fun.com/Opto4.html">www.fpga4fun.com/Opto4.html</a> <br>  4) Decryptor: <br>  <a href="http://www.fpga4fun.com/Opto3.html">www.fpga4fun.com/Opto3.html</a> <br><br>  Thank you for your attention, I hope someone will come in handy! <br>  <b>UPD</b> <br>  Thanks for the comments everyone! <br>  I do not know how it turned out in this blog.  I wanted to cut, fill in the pictures of the norms, remake something ... But today I didn‚Äôt go to Habr at all! <br>  There is an idea to get time from outside, for example, via NTP. <br>  About hosting - I was advised in a personal, poured there. <br>  This is my first topic, there were no publications prior to this experience, I uploaded the pictures to the first remembered hosting. <br>  I just happened to be in my hometown and with normal internet.  Tomorrow I will take into account the wishes! <br><habracut></habracut></div><p>Source: <a href="https://habr.com/ru/post/125364/">https://habr.com/ru/post/125364/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../125358/index.html">History of MySQL database recovery from files (InnoDB)</a></li>
<li><a href="../125359/index.html">Integration of asterisk with Active Directory</a></li>
<li><a href="../125360/index.html">Terms of Reference</a></li>
<li><a href="../125362/index.html">Do not use Java7 for anything.</a></li>
<li><a href="../125363/index.html">How we got to the Android Market</a></li>
<li><a href="../125366/index.html">A brief report from the development team of the webonmap.ru project</a></li>
<li><a href="../125367/index.html">Mirror ESET Update Server on Linux</a></li>
<li><a href="../125368/index.html">Cisco Modular Command Line QoS</a></li>
<li><a href="../125369/index.html">Processes in the Linux operating system (basic concepts)</a></li>
<li><a href="../125371/index.html">Accelerating with Windows Azure Accelerator</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>