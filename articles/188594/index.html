<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>As I wrote fix widescreen permissions for FlatOut</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Not so long ago I was engaged in writing fixes for several old games in order to correct the distortion of the picture and interface on widescreen mon...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>As I wrote fix widescreen permissions for FlatOut</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage2/aef/c48/e6a/aefc48e6a83f50e6ded7999fb9cf2dfc.jpg" align="left"><br>  Not so long ago I was engaged in writing fixes for several old games in order to correct the distortion of the picture and interface on widescreen monitors.  They asked me to take a look at <a href="http://en.wikipedia.org/wiki/Flatout">FlatOut</a> , so I had an idea to write about it at the same time. <br><br clear="all"><a name="habracut"></a><br><br><h2>  What is needed </h2><br>  To create a full-fledged fix that is easy to install and does not require replacing the game files, I used: <a href="https://www.hex-rays.com/products/ida/support/download.shtml" title="IDA">IDA</a> , <a href="http://www.cheatengine.org/" title="Cheat engine">Cheat Engine</a> , <a href="http://www.microsoft.com/visualstudio/rus" title="Visual studio">Visual Studio</a> , the <a href="">universal ASI Loader</a> (more on this below), and to launch the game in question in the window - <a href="http://forum.xentax.com/viewtopic.php%3Ff%3D33%26t%3D10242" title="D3DWindower">D3DWindower</a> . <br><br><h2>  Parsing resources </h2><br>  Let's look in the folder with the installed game to find out what to work with.  In this case, the interest is just one file - "flatout.exe".  In some games, additional DLLs may be present, for example, in Max Payne, to correct the image aspect ratio, I did inject into e2mfc.dll, and not into an executable file.  Flatout.exe is patched to v1.1, but the <a href="http://www.buka.ru/cgi-bin/show.pl%3Foption%3DShow_patch%26id%3D143">official patch</a> from the Russian distributor - the company "BUKA", contains three different EXE: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/storage2/888/e14/f2c/888e14f2c06bd9bae73d295b04d7fce8.jpg"><br><br>  I chose a flatout, 3.exe (2,822,144 bytes) for the study, since the IDA disassembles it into a readable form. <br><br><h2>  Experiences </h2><br>  Having opened flatout, 3.exe in IDA, first of all I start looking for constants.  Judging from my previous experience, most of the old games use one of these to display the interface and 3D images: <strong>640.0, 480.0, 1.3333, 0.0015625 = 1.0 / 640.0, 0.00208333333 = 1.0 / 480.0</strong> , etc.  First of all I drive 0.0015625 into the search, since the second most popular constants <strong>640.0</strong> and <strong>480.0</strong> are usually located nearby.  IDA finds the required address <strong>0x667CE4</strong> : <br><br><img src="https://habrastorage.org/storage2/dd3/aff/bff/dd3affbfffdb335f9b73c9f5df979473.jpg"><br><br>  Now you can run the game and try to change the value to this memory address.  This is how the FlatOut interface looks in 1280x720 resolution: <br><br> <a href=""><img src="https://habrastorage.org/storage2/de5/6f6/be8/de56f6be81c7cdeab7e2bf4efb09542f.jpg"></a> <br><br>  I run Cheat Engine in parallel, join the process.  With the button ‚ÄúAdd address manually‚Äù I add the address <strong>0x667CE4</strong> to the table: <br><br><img src="https://habrastorage.org/storage2/ee7/558/e65/ee7558e656273e5ed8687babb3db5ddf.jpg"><br><br>  I am changing its current value to 0.0010, just to see what comes of it.  The result shows that half the work is done: <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/c27/5bc/19a/c275bc19a50c7a563d2ecc43e1a0424b.jpg"></a> <br><br>  Now it remains to find how to fix the stretching of the 3D image.  I did not find the so-called <a href="http://ru.wikipedia.org/wiki/%25D0%25A1%25D0%25BE%25D0%25BE%25D1%2582%25D0%25BD%25D0%25BE%25D1%2588%25D0%25B5%25D0%25BD%25D0%25B8%25D0%25B5_%25D1%2581%25D1%2582%25D0%25BE%25D1%2580%25D0%25BE%25D0%25BD_%25D1%258D%25D0%25BA%25D1%2580%25D0%25B0%25D0%25BD%25D0%25B0">aspect ratio</a> constant, <strong>4: 3</strong> or <strong>1.3333</strong> , so I decided to try changing all the numbers <strong>480</strong> to <strong>360</strong> .  I used this method earlier in Max Payne, I thought that he could help in the search here.  In Cheat Engine, I set the following settings and click ‚ÄúFirst Scan‚Äù: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/2e5/d0b/158/2e5d0b158d1c0182ca6c2585e20ff0eb.jpg"><br><br>  Among the addresses found, I add to the table only those marked in green.  Green color means that these addresses belong to the range flatout.exe, and the rest we simply do not need. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/721/fbb/4f2/721fbb4f2788d8539a5595362c3ccea7.jpg"><br><br>  Change all found values ‚Äã‚Äãto <strong>360</strong> : <br><br><img src="https://habrastorage.org/storage2/9a4/9fa/043/9a49fa0430422950c959c553844a621f.jpg"><br><br>  The image of the game disappears, then an error appears.  Experiencedly I find out that the departure is due to the change of two addresses - <strong>FlatOut.exe + 1069C3 (0x5069C3)</strong> and <strong>FlatOut.exe + 107CCB (0x507CCB)</strong> .  I <strong>come</strong> to the address <strong>0x5069C3</strong> in IDA, see why it crashes: <br><br><img src="https://habrastorage.org/storage2/8e8/daa/d67/8e8daad670ef2ea04cbea7f5114ef09d.jpg"><br><br>  <b>480</b> here is an offset, not a constant, so this function is not of interest, but the attention is attracted by the function below, at address 0x5069D0, which, with a small conversion, gets the following form: <br><br><img src="https://habrastorage.org/storage2/ff0/589/da7/ff0589da780f14184567fe91c2c50e5a.jpg"><br><br>  I try to change the constants 4.0 and 3.0 to 16.0 and 9.0, respectively: <br><img src="https://habrastorage.org/storage2/983/ceb/30d/983ceb30d17f1fe42480c19edce0ec72.jpg"><br><br>  I am surprised to find out that this is the very aspect ratio, at the resolution of 1280x720 the picture immediately acquired the correct proportions (as it was / as it became): <br><br> <a href=""><img src="https://habrastorage.org/storage2/768/aea/bef/768aeabef0dc7e9ef8ae5b8f420e63d6.jpg"></a> <br><br> <a href=""><img src="https://habrastorage.org/storage2/dac/161/7fe/dac1617feb6b003309d3ab395d0a7f43.jpg"></a> <br><br>  Now it remains to write a plugin that calculates the above constants in accordance with the current resolution and makes the image of the game correct for any settings. <br><br><h2>  C ++ </h2><br><br>  I open Visual Studio, create a new Win32 project, the application type is a DLL library.  In the project properties, I set the following options: <br><ul><li>  Configuration - Release </li><li>  Character Set - Use Multibyte Encoding </li><li>  Runtime Library - Multi-threaded (/ MT) </li><li>  Warning Level - Level1 (/ W1) </li><li>  The final extension is .asi </li><li>  The output directory is E: \ Games \ FlatOut \ FlatOut </li></ul><br>  To work with memory, I use the special class CPatch. <br><br>  Dllmain: <br><pre><code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"stdafx.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"CPatch.h"</span></span></span><span class="hljs-meta"> HANDLE HndThread; int* g_Width = (int *)0x6B0D88; int* g_Height = (int *)0x6B0D8C; int g_CameraAspectRatio_x = 0x5069DA; int g_CameraAspectRatio_y = 0x5069E0; int g_hud_stretch_x = 0x667CE4; #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> screen_width (float)*g_Width #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> screen_height (float)*g_Height float hud_stretch_new = 0.0; int Thread() { while (!screen_width) { Sleep(0); } hud_stretch_new = 1.0/(480.0*(screen_width/screen_height)); CPatch::SetFloat(g_CameraAspectRatio_x, screen_width); CPatch::SetFloat(g_CameraAspectRatio_y, screen_height); CPatch::SetFloat(g_hud_stretch_x, hud_stretch_new); return 0; } BOOL APIENTRY DllMain(HMODULE hModule, DWORD reason, LPVOID lpReserved) { </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta">(reason==DLL_PROCESS_ATTACH) { HndThread = CreateThread(0,0,(LPTHREAD_START_ROUTINE)&amp;Thread,NULL,0,NULL); } return TRUE; }</span></span></code> </pre> <br><br>  In order for my ASI library to load along with the game, you need to install the <a href="">universal ASI Loader</a> by copying dsound.dll from the archive into the game folder.  ASI is just a renamed DLL, and dsound.dll loads ASI into the process of any game that uses DirectSound.  Loading from the scripts subfolder is possible. <br><br><h2>  Result </h2><br>  This is only the first version of the plugin, and most likely it will be updated more than once.  There are certain flaws, such as the main menu.  Also, in the event of incompatibility, you can add support for other EXE, such as steam-version. <br><br> <a href=""><img src="https://habrastorage.org/storage2/882/8fd/eb7/8828fdeb788af1145f60fdcb587d6ca6.jpg"></a> <br><br> <a href=""><img src="https://habrastorage.org/storage2/661/465/5a1/6614655a19ddb316fd62a8307d40c5e8.jpg"></a> <br><br> <a href=""><img src="https://habrastorage.org/storage2/f77/c43/f2f/f77c43f2f437e1d3f01c648350f28c0b.jpg"></a> <br><br>  You can download the plugin from <a href="https://github.com/ThirteenAG/Widescreen_Fixes_Pack/releases/tag/flatout" title="github">github</a> . <br>  Installation is simple - unpack the archive into the folder with the game. <br><br><h2>  Update 02.08.2013 </h2><br>  Released an updated version, with support for steam-version and steam-demo games. </div><p>Source: <a href="https://habr.com/ru/post/188594/">https://habr.com/ru/post/188594/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../188580/index.html">Why web applications on mobile platforms are slow</a></li>
<li><a href="../188582/index.html">Limbo similar puzzle platformer - Monochroma</a></li>
<li><a href="../188586/index.html">The last day of the 21st century or the end of the oil toad?</a></li>
<li><a href="../188590/index.html">Roskomnadzor announced the introduction of the registry of sites with "pirated" movies</a></li>
<li><a href="../188592/index.html">Test automation of Android applications using Robotium and Spoon</a></li>
<li><a href="../188598/index.html">Own simple DynDNS server</a></li>
<li><a href="../188604/index.html">Why UML</a></li>
<li><a href="../188606/index.html">ORANGEMAN: news about the distribution of servers. Initiative Development</a></li>
<li><a href="../188608/index.html">Cloud networking and network connectivity with the cloud</a></li>
<li><a href="../188612/index.html">Home 3D printer pays off in 1 year</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>