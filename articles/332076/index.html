<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Dynamic instrumentation is not easy, but trivial *: we write yet another instrumentation for American Fuzzy Lop</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="(*) Not really, really. 
 Probably, many have heard about Valgrind - a debugger that can tell where memory is leaking in your native program, where br...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Dynamic instrumentation is not easy, but trivial *: we write yet another instrumentation for American Fuzzy Lop</h1><div class="post__text post__text-html js-mediator-article"><p><img align="left" width="60%" src="https://habrastorage.org/web/193/503/063/193503063b0b4463a07173ee193498f2.png">  <em>(*) Not really, really.</em> <br>  Probably, many have heard about Valgrind - a debugger that can tell where memory is leaking in your native program, where branching depends on an uninitialized variable and much more (and in addition to memcheck, it also has other modes of operation).  Inside itself, this wonder-program grinds the native code into some intermediate bytecode, instructs it, and generates a new machine code ‚Äî already with run-time checks.  But there is a problem: Valgrind does not know how to work under Windows.  When I needed it, the search led me to a similar utility called <a href="http://www.drmemory.org/">DrMemory</a> , and there was also an analogue <code>strace</code> with it.  But it‚Äôs not so much about them as about the dynamic instrumentation library on the basis of which they are built, <a href="http://dynamorio.org/">DynamoRIO</a> .  At some point I became interested in this library from the point of view of writing my own instrumentation, started searching for documentation, came across a <a href="http://dynamorio.org/docs/API_samples.html">large number of examples</a> and was amazed that you can write simple, but complete instrumentation like <a href="">counting call instructions</a> in literally 237 lines of code, 32 of which - a license, and 8 - a description.  No, it‚Äôs certainly not ‚Äúwriting a killer of Valgrind in 30 lines of code in JavaScript‚Äù, but much simpler than what you can imagine for such a task. </p><br><p>  As an example, let's write the fourth implementation of instrumentation for fuzzer American Fuzzy Lop, which was recently <a href="https://habrahabr.ru/post/328652/">written on Habr√©</a> . </p><a name="habracut"></a><br><h1 id="chto-takoe-afl">  What is AFL </h1><br><p>  <a href="http://lcamtuf.coredump.cx/afl/">AFL</a> is a guided fuzzing tool for finding bugs and vulnerabilities, assembled from reinforced concrete <del>  crutches </del>  heuristics implemented in the most trivial and efficient way.  This is how you look at a tool that is capable, by observing the behavior of libjpeg, to synthesize valid jeeps, and you are amazed that all this is done on the basis of not so clever mechanics.  In short, in order to complete the AFL operation, the target binary must be instrumented so as to collect <em>edge coating</em> during execution: imagine each basic block ( <strong>basic block</strong> , something like a sequence of instructions from the label to the nearest transition instruction) as a vertex of the graph.  Ribs are possible ways to transfer control between the BB.  Accordingly, the AFL is interested in what transitions and in what quantity have occurred between the basic blocks of the program. </p><br><p>  The main method of instrumentation in AFL is static at compile time using <code>afl-gcc</code> / <code>afl-g++</code> wrappers or their counterparts for <code>clang</code> .  What is funny, <code>afl-gcc</code> replaces the called <code>as</code> command with a wrapper that rewrites the assembler listing generated by the compiler.  There is a more advanced version, called <code>llvm mode</code> , which is honestly built into the compilation process (produced with LLVM, of course) and, in theory, should therefore give greater performance to the generated code.  Finally, for fuzzing already compiled binaries, there is a <code>qemu mode</code> - a patch to QEMU in the emulation mode of one process that adds the necessary instrumentation (initially this mode of operation of QEMU was intended to run separate processes compiled for another architecture using the host core). </p><br><h1 id="chto-takoe-dynamorio">  What is DynamoRIO </h1><br><p>  <a href="http://www.dynamorio.org/">DynamoRIO</a> is a dynamic instrumentation system (that is, it instruments already compiled binaries directly at runtime), running on Windows, Linux and Android on x86 and x86_64 architectures, as well as ARM (support for AArch64 is in release candidate version 7.0).  Unlike QEMU, it is not designed to execute programs ‚Äúclose to text‚Äù on a foreign architecture, but to easily create your own instrumentations that modify the behavior of a program on a native architecture.  At the same time, the goal is to avoid spoiling the optimized code.  Unfortunately, I never found a way in which <em>clients</em> (the so-called user instrumentation libraries) could not be aware of the target instruction set (except for some trivial cases where there are enough cross-platform wrappers for basic instructions), because <strong>there is no</strong> conversion. " machine code -&gt; bytecode - [instrumentation] -&gt; new bytecode -&gt; instrumented machine code ".  Instead, for each broadcast base unit, a list of decoded instructions is transmitted to the client, which it can modify and supplement with the help of convenient functions and macros.  That is, it is not necessary to program in machine codes, but you will most likely have to know the x86 instruction set (or another platform). </p><br><p>  <strong>As a small bonus:</strong> I got to see what else is interesting in their account on Gitkhab, and came across an interesting repository: <a href="https://github.com/DynamoRIO/drk">DRK</a> .  The repository seems to be abandoned and somewhat lost relevance, but the description is impressive: </p><br><blockquote>  DRK is DynamoRIO as a loadable Linux Kernel module.  When DRK is loaded, all kernel-mode execution (system calls, interrupt &amp; exception handlers, kernel threads, etc.) mode process and doesn't touch kernel-mode execution. </blockquote><br><h1 id="testovaya-programma">  Test program </h1><br><p>  First, let's look at what AFL is capable of.  No, we will not take a vulnerable version of any library and wait for hours or days.  For the test, we will write the most stupid program that dereferences the null pointer, if stdin is given a string starting with the letters <code>NULL</code> .  This, of course, is not the synthesis of a dzipega from nowhere, but on the other hand it is almost not necessary to wait. </p><br><p>  So, download the AFL <a href="">from here</a> and collect it.  As you have probably guessed, we will be collecting under GNU / Linux.  However, other Unix-like systems and Unixes like Mac OS X should work too.  Take a small program: </p><br><pre> <code class="hljs lua">#include &lt;stdio.h&gt; #include &lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>.h&gt; volatile int *ptr = NULL; const <span class="hljs-built_in"><span class="hljs-built_in">char</span></span> cmd[] = <span class="hljs-string"><span class="hljs-string">"NULL"</span></span>; int main(int argc, <span class="hljs-built_in"><span class="hljs-built_in">char</span></span> *argv[]) { <span class="hljs-built_in"><span class="hljs-built_in">char</span></span> buf[<span class="hljs-number"><span class="hljs-number">16</span></span>]; fgets(buf, sizeof buf, <span class="hljs-built_in"><span class="hljs-built_in">stdin</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (strncmp(buf, cmd, <span class="hljs-number"><span class="hljs-number">4</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; } *ptr = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; }</code> </pre><br><p>  Compile it and run fuzzing: </p><br><pre> <code class="hljs smalltalk"><span class="hljs-string"><span class="hljs-string">$ </span></span>export <span class="hljs-type"><span class="hljs-type">AFL_PATH</span></span>=~/tmp/build/afl<span class="hljs-number"><span class="hljs-number">-2.42</span></span>b/ <span class="hljs-string"><span class="hljs-string">$ </span></span>#   ,     <span class="hljs-string"><span class="hljs-string">$ </span></span><span class="hljs-string"><span class="hljs-string">$A</span></span>FL_PATH/afl-gcc example-bug-libc.c -o example-bug-libc <span class="hljs-string"><span class="hljs-string">$ </span></span>#  -    ( ) <span class="hljs-string"><span class="hljs-string">$ </span></span>mkdir input <span class="hljs-string"><span class="hljs-string">$ </span></span>echo test &gt; input/<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-string"><span class="hljs-string">$ </span></span>#   <span class="hljs-string"><span class="hljs-string">$ </span></span><span class="hljs-string"><span class="hljs-string">$A</span></span>FL_PATH/afl-fuzz -i input -o output -- ./example-bug-libc</code> </pre> <br><p>  And what we see: </p><br><div style="text-align:center;"><img title="AFL can't find anything" src="https://habrastorage.org/web/b84/34e/b3e/b8434eb3e49845bb9822ef924e6cd217.png"></div><br><p>  Somehow it does not work ... Pay attention to the line last new path: AFL swears that after 91 thousand launches, he never found a new path.  In fact, this is quite logical: let me remind you, we used static instrumentation at the stage of calling the assembler.  The main comparison is made by a function from libc, which is not instrumented, and therefore it is not possible to count the number of matched characters.  So I thought, until I decided to check it, but it turned out that our binary does not import the <code>strncmp</code> function.  Judging by the output of <code>objdump -d</code> , the compiler simply generated in place of the <code>strncmp</code> instruction with a prefix instead of a loop where you could cram the instrumentation. </p><br><div class="spoiler">  <b class="spoiler_title">Instrumented main function with strncmp</b> <div class="spoiler_text"><pre> <code class="hljs mel"><span class="hljs-number"><span class="hljs-number">00000000000007</span></span>f0 &lt;.plt.got&gt;: <span class="hljs-number"><span class="hljs-number">7</span></span>f0: ff <span class="hljs-number"><span class="hljs-number">25</span></span> <span class="hljs-number"><span class="hljs-number">82</span></span> <span class="hljs-number"><span class="hljs-number">17</span></span> <span class="hljs-number"><span class="hljs-number">20</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> jmpq *<span class="hljs-number"><span class="hljs-number">0x201782</span></span>(%rip) # <span class="hljs-number"><span class="hljs-number">201</span></span>f78 &lt;<span class="hljs-keyword"><span class="hljs-keyword">getenv</span></span>@GLIBC_2<span class="hljs-number"><span class="hljs-number">.2</span></span><span class="hljs-number"><span class="hljs-number">.5</span></span>&gt; <span class="hljs-number"><span class="hljs-number">7</span></span>f6: <span class="hljs-number"><span class="hljs-number">66</span></span> <span class="hljs-number"><span class="hljs-number">90</span></span> xchg %ax,%ax <span class="hljs-number"><span class="hljs-number">7</span></span>f8: ff <span class="hljs-number"><span class="hljs-number">25</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span>a <span class="hljs-number"><span class="hljs-number">17</span></span> <span class="hljs-number"><span class="hljs-number">20</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> jmpq *<span class="hljs-number"><span class="hljs-number">0x20178a</span></span>(%rip) # <span class="hljs-number"><span class="hljs-number">201</span></span>f88 &lt;_exit@GLIBC_2<span class="hljs-number"><span class="hljs-number">.2</span></span><span class="hljs-number"><span class="hljs-number">.5</span></span>&gt; <span class="hljs-number"><span class="hljs-number">7</span></span>fe: <span class="hljs-number"><span class="hljs-number">66</span></span> <span class="hljs-number"><span class="hljs-number">90</span></span> xchg %ax,%ax <span class="hljs-number"><span class="hljs-number">800</span></span>: ff <span class="hljs-number"><span class="hljs-number">25</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span>a <span class="hljs-number"><span class="hljs-number">17</span></span> <span class="hljs-number"><span class="hljs-number">20</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> jmpq *<span class="hljs-number"><span class="hljs-number">0x20178a</span></span>(%rip) # <span class="hljs-number"><span class="hljs-number">201</span></span>f90 &lt;write@GLIBC_2<span class="hljs-number"><span class="hljs-number">.2</span></span><span class="hljs-number"><span class="hljs-number">.5</span></span>&gt; <span class="hljs-number"><span class="hljs-number">806</span></span>: <span class="hljs-number"><span class="hljs-number">66</span></span> <span class="hljs-number"><span class="hljs-number">90</span></span> xchg %ax,%ax <span class="hljs-number"><span class="hljs-number">808</span></span>: ff <span class="hljs-number"><span class="hljs-number">25</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span>a <span class="hljs-number"><span class="hljs-number">17</span></span> <span class="hljs-number"><span class="hljs-number">20</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> jmpq *<span class="hljs-number"><span class="hljs-number">0x20178a</span></span>(%rip) # <span class="hljs-number"><span class="hljs-number">201</span></span>f98 &lt;__stack_chk_fail@GLIBC_2<span class="hljs-number"><span class="hljs-number">.4</span></span>&gt; <span class="hljs-number"><span class="hljs-number">80</span></span>e: <span class="hljs-number"><span class="hljs-number">66</span></span> <span class="hljs-number"><span class="hljs-number">90</span></span> xchg %ax,%ax <span class="hljs-number"><span class="hljs-number">810</span></span>: ff <span class="hljs-number"><span class="hljs-number">25</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span>a <span class="hljs-number"><span class="hljs-number">17</span></span> <span class="hljs-number"><span class="hljs-number">20</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> jmpq *<span class="hljs-number"><span class="hljs-number">0x20178a</span></span>(%rip) # <span class="hljs-number"><span class="hljs-number">201</span></span>fa0 &lt;close@GLIBC_2<span class="hljs-number"><span class="hljs-number">.2</span></span><span class="hljs-number"><span class="hljs-number">.5</span></span>&gt; <span class="hljs-number"><span class="hljs-number">816</span></span>: <span class="hljs-number"><span class="hljs-number">66</span></span> <span class="hljs-number"><span class="hljs-number">90</span></span> xchg %ax,%ax <span class="hljs-number"><span class="hljs-number">818</span></span>: ff <span class="hljs-number"><span class="hljs-number">25</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span>a <span class="hljs-number"><span class="hljs-number">17</span></span> <span class="hljs-number"><span class="hljs-number">20</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> jmpq *<span class="hljs-number"><span class="hljs-number">0x20178a</span></span>(%rip) # <span class="hljs-number"><span class="hljs-number">201</span></span>fa8 &lt;read@GLIBC_2<span class="hljs-number"><span class="hljs-number">.2</span></span><span class="hljs-number"><span class="hljs-number">.5</span></span>&gt; <span class="hljs-number"><span class="hljs-number">81</span></span>e: <span class="hljs-number"><span class="hljs-number">66</span></span> <span class="hljs-number"><span class="hljs-number">90</span></span> xchg %ax,%ax <span class="hljs-number"><span class="hljs-number">820</span></span>: ff <span class="hljs-number"><span class="hljs-number">25</span></span> <span class="hljs-number"><span class="hljs-number">92</span></span> <span class="hljs-number"><span class="hljs-number">17</span></span> <span class="hljs-number"><span class="hljs-number">20</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> jmpq *<span class="hljs-number"><span class="hljs-number">0x201792</span></span>(%rip) # <span class="hljs-number"><span class="hljs-number">201</span></span>fb8 &lt;fgets@GLIBC_2<span class="hljs-number"><span class="hljs-number">.2</span></span><span class="hljs-number"><span class="hljs-number">.5</span></span>&gt; <span class="hljs-number"><span class="hljs-number">826</span></span>: <span class="hljs-number"><span class="hljs-number">66</span></span> <span class="hljs-number"><span class="hljs-number">90</span></span> xchg %ax,%ax <span class="hljs-number"><span class="hljs-number">828</span></span>: ff <span class="hljs-number"><span class="hljs-number">25</span></span> <span class="hljs-number"><span class="hljs-number">9</span></span>a <span class="hljs-number"><span class="hljs-number">17</span></span> <span class="hljs-number"><span class="hljs-number">20</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> jmpq *<span class="hljs-number"><span class="hljs-number">0x20179a</span></span>(%rip) # <span class="hljs-number"><span class="hljs-number">201</span></span>fc8 &lt;waitpid@GLIBC_2<span class="hljs-number"><span class="hljs-number">.2</span></span><span class="hljs-number"><span class="hljs-number">.5</span></span>&gt; <span class="hljs-number"><span class="hljs-number">82</span></span>e: <span class="hljs-number"><span class="hljs-number">66</span></span> <span class="hljs-number"><span class="hljs-number">90</span></span> xchg %ax,%ax <span class="hljs-number"><span class="hljs-number">830</span></span>: ff <span class="hljs-number"><span class="hljs-number">25</span></span> a2 <span class="hljs-number"><span class="hljs-number">17</span></span> <span class="hljs-number"><span class="hljs-number">20</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> jmpq *<span class="hljs-number"><span class="hljs-number">0x2017a2</span></span>(%rip) # <span class="hljs-number"><span class="hljs-number">201</span></span>fd8 &lt;shmat@GLIBC_2<span class="hljs-number"><span class="hljs-number">.2</span></span><span class="hljs-number"><span class="hljs-number">.5</span></span>&gt; <span class="hljs-number"><span class="hljs-number">836</span></span>: <span class="hljs-number"><span class="hljs-number">66</span></span> <span class="hljs-number"><span class="hljs-number">90</span></span> xchg %ax,%ax <span class="hljs-number"><span class="hljs-number">838</span></span>: ff <span class="hljs-number"><span class="hljs-number">25</span></span> a2 <span class="hljs-number"><span class="hljs-number">17</span></span> <span class="hljs-number"><span class="hljs-number">20</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> jmpq *<span class="hljs-number"><span class="hljs-number">0x2017a2</span></span>(%rip) # <span class="hljs-number"><span class="hljs-number">201</span></span>fe0 &lt;atoi@GLIBC_2<span class="hljs-number"><span class="hljs-number">.2</span></span><span class="hljs-number"><span class="hljs-number">.5</span></span>&gt; <span class="hljs-number"><span class="hljs-number">83</span></span>e: <span class="hljs-number"><span class="hljs-number">66</span></span> <span class="hljs-number"><span class="hljs-number">90</span></span> xchg %ax,%ax <span class="hljs-number"><span class="hljs-number">840</span></span>: ff <span class="hljs-number"><span class="hljs-number">25</span></span> aa <span class="hljs-number"><span class="hljs-number">17</span></span> <span class="hljs-number"><span class="hljs-number">20</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> jmpq *<span class="hljs-number"><span class="hljs-number">0x2017aa</span></span>(%rip) # <span class="hljs-number"><span class="hljs-number">201</span></span>ff0 &lt;__cxa_finalize@GLIBC_2<span class="hljs-number"><span class="hljs-number">.2</span></span><span class="hljs-number"><span class="hljs-number">.5</span></span>&gt; <span class="hljs-number"><span class="hljs-number">846</span></span>: <span class="hljs-number"><span class="hljs-number">66</span></span> <span class="hljs-number"><span class="hljs-number">90</span></span> xchg %ax,%ax <span class="hljs-number"><span class="hljs-number">848</span></span>: ff <span class="hljs-number"><span class="hljs-number">25</span></span> aa <span class="hljs-number"><span class="hljs-number">17</span></span> <span class="hljs-number"><span class="hljs-number">20</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> jmpq *<span class="hljs-number"><span class="hljs-number">0x2017aa</span></span>(%rip) # <span class="hljs-number"><span class="hljs-number">201</span></span>ff8 &lt;fork@GLIBC_2<span class="hljs-number"><span class="hljs-number">.2</span></span><span class="hljs-number"><span class="hljs-number">.5</span></span>&gt; <span class="hljs-number"><span class="hljs-number">84</span></span>e: <span class="hljs-number"><span class="hljs-number">66</span></span> <span class="hljs-number"><span class="hljs-number">90</span></span> xchg %ax,%ax ... <span class="hljs-number"><span class="hljs-number">0000000000000850</span></span> &lt;main&gt;: <span class="hljs-number"><span class="hljs-number">850</span></span>: <span class="hljs-number"><span class="hljs-number">48</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span>d a4 <span class="hljs-number"><span class="hljs-number">24</span></span> <span class="hljs-number"><span class="hljs-number">68</span></span> ff ff lea <span class="hljs-number"><span class="hljs-number">-0x98</span></span>(%rsp),%rsp <span class="hljs-number"><span class="hljs-number">857</span></span>: ff <span class="hljs-number"><span class="hljs-number">858</span></span>: <span class="hljs-number"><span class="hljs-number">48</span></span> <span class="hljs-number"><span class="hljs-number">89</span></span> <span class="hljs-number"><span class="hljs-number">14</span></span> <span class="hljs-number"><span class="hljs-number">24</span></span> mov %rdx,(%rsp) <span class="hljs-number"><span class="hljs-number">85</span></span>c: <span class="hljs-number"><span class="hljs-number">48</span></span> <span class="hljs-number"><span class="hljs-number">89</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span>c <span class="hljs-number"><span class="hljs-number">24</span></span> <span class="hljs-number"><span class="hljs-number">08</span></span> mov %rcx,<span class="hljs-number"><span class="hljs-number">0x8</span></span>(%rsp) <span class="hljs-number"><span class="hljs-number">861</span></span>: <span class="hljs-number"><span class="hljs-number">48</span></span> <span class="hljs-number"><span class="hljs-number">89</span></span> <span class="hljs-number"><span class="hljs-number">44</span></span> <span class="hljs-number"><span class="hljs-number">24</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span> mov %rax,<span class="hljs-number"><span class="hljs-number">0x10</span></span>(%rsp) <span class="hljs-number"><span class="hljs-number">866</span></span>: <span class="hljs-number"><span class="hljs-number">48</span></span> c7 c1 <span class="hljs-number"><span class="hljs-number">04</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span>a <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> mov $0x6a04,%rcx <span class="hljs-number"><span class="hljs-number">86</span></span>d: e8 <span class="hljs-number"><span class="hljs-number">9</span></span>e <span class="hljs-number"><span class="hljs-number">02</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> callq b10 &lt;__afl_maybe_log&gt; <span class="hljs-number"><span class="hljs-number">872</span></span>: <span class="hljs-number"><span class="hljs-number">48</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span>b <span class="hljs-number"><span class="hljs-number">44</span></span> <span class="hljs-number"><span class="hljs-number">24</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span> mov <span class="hljs-number"><span class="hljs-number">0x10</span></span>(%rsp),%rax <span class="hljs-number"><span class="hljs-number">877</span></span>: <span class="hljs-number"><span class="hljs-number">48</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span>b <span class="hljs-number"><span class="hljs-number">4</span></span>c <span class="hljs-number"><span class="hljs-number">24</span></span> <span class="hljs-number"><span class="hljs-number">08</span></span> mov <span class="hljs-number"><span class="hljs-number">0x8</span></span>(%rsp),%rcx <span class="hljs-number"><span class="hljs-number">87</span></span>c: <span class="hljs-number"><span class="hljs-number">48</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span>b <span class="hljs-number"><span class="hljs-number">14</span></span> <span class="hljs-number"><span class="hljs-number">24</span></span> mov (%rsp),%rdx <span class="hljs-number"><span class="hljs-number">880</span></span>: <span class="hljs-number"><span class="hljs-number">48</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span>d a4 <span class="hljs-number"><span class="hljs-number">24</span></span> <span class="hljs-number"><span class="hljs-number">98</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> lea <span class="hljs-number"><span class="hljs-number">0x98</span></span>(%rsp),%rsp <span class="hljs-number"><span class="hljs-number">887</span></span>: <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">888</span></span>: <span class="hljs-number"><span class="hljs-number">53</span></span> push %rbx <span class="hljs-number"><span class="hljs-number">889</span></span>: be <span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> mov $0x10,%esi <span class="hljs-number"><span class="hljs-number">88</span></span>e: <span class="hljs-number"><span class="hljs-number">48</span></span> <span class="hljs-number"><span class="hljs-number">83</span></span> ec <span class="hljs-number"><span class="hljs-number">20</span></span> sub $0x20,%rsp <span class="hljs-number"><span class="hljs-number">892</span></span>: <span class="hljs-number"><span class="hljs-number">48</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span>b <span class="hljs-number"><span class="hljs-number">15</span></span> <span class="hljs-number"><span class="hljs-number">77</span></span> <span class="hljs-number"><span class="hljs-number">17</span></span> <span class="hljs-number"><span class="hljs-number">20</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> mov <span class="hljs-number"><span class="hljs-number">0x201777</span></span>(%rip),%rdx # <span class="hljs-number"><span class="hljs-number">202010</span></span> &lt;stdin@@GLIBC_2<span class="hljs-number"><span class="hljs-number">.2</span></span><span class="hljs-number"><span class="hljs-number">.5</span></span>&gt; <span class="hljs-number"><span class="hljs-number">899</span></span>: <span class="hljs-number"><span class="hljs-number">48</span></span> <span class="hljs-number"><span class="hljs-number">89</span></span> e7 mov %rsp,%rdi <span class="hljs-number"><span class="hljs-number">89</span></span>c: <span class="hljs-number"><span class="hljs-number">64</span></span> <span class="hljs-number"><span class="hljs-number">48</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span>b <span class="hljs-number"><span class="hljs-number">04</span></span> <span class="hljs-number"><span class="hljs-number">25</span></span> <span class="hljs-number"><span class="hljs-number">28</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> mov %fs:<span class="hljs-number"><span class="hljs-number">0x28</span></span>,%rax <span class="hljs-number"><span class="hljs-number">8</span></span>a3: <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span>a5: <span class="hljs-number"><span class="hljs-number">48</span></span> <span class="hljs-number"><span class="hljs-number">89</span></span> <span class="hljs-number"><span class="hljs-number">44</span></span> <span class="hljs-number"><span class="hljs-number">24</span></span> <span class="hljs-number"><span class="hljs-number">18</span></span> mov %rax,<span class="hljs-number"><span class="hljs-number">0x18</span></span>(%rsp) <span class="hljs-number"><span class="hljs-number">8</span></span>aa: <span class="hljs-number"><span class="hljs-number">31</span></span> c0 xor %eax,%eax <span class="hljs-number"><span class="hljs-number">8</span></span>ac: e8 <span class="hljs-number"><span class="hljs-number">6</span></span>f ff ff ff callq <span class="hljs-number"><span class="hljs-number">820</span></span> &lt;.plt.got+<span class="hljs-number"><span class="hljs-number">0x30</span></span>&gt; <span class="hljs-number"><span class="hljs-number">8</span></span>b1: <span class="hljs-number"><span class="hljs-number">48</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span>d <span class="hljs-number"><span class="hljs-number">3</span></span>d dc <span class="hljs-number"><span class="hljs-number">06</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> lea <span class="hljs-number"><span class="hljs-number">0x6dc</span></span>(%rip),%rdi # f94 &lt;cmd&gt; <span class="hljs-number"><span class="hljs-number">8</span></span>b8: b9 <span class="hljs-number"><span class="hljs-number">04</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> mov $0x4,%ecx <span class="hljs-number"><span class="hljs-number">8</span></span>bd: <span class="hljs-number"><span class="hljs-number">48</span></span> <span class="hljs-number"><span class="hljs-number">89</span></span> e6 mov %rsp,%rsi <span class="hljs-number"><span class="hljs-number">8</span></span>c0: f3 a6 repz cmpsb %es:(%rdi),%ds:(%rsi) <span class="hljs-number"><span class="hljs-number">8</span></span>c2: <span class="hljs-number"><span class="hljs-number">75</span></span> <span class="hljs-number"><span class="hljs-number">45</span></span> jne <span class="hljs-number"><span class="hljs-number">909</span></span> &lt;main+<span class="hljs-number"><span class="hljs-number">0xb9</span></span>&gt; <span class="hljs-number"><span class="hljs-number">8</span></span>c4: <span class="hljs-number"><span class="hljs-number">48</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span>d a4 <span class="hljs-number"><span class="hljs-number">24</span></span> <span class="hljs-number"><span class="hljs-number">68</span></span> ff ff lea <span class="hljs-number"><span class="hljs-number">-0x98</span></span>(%rsp),%rsp <span class="hljs-number"><span class="hljs-number">8</span></span>cb: ff <span class="hljs-number"><span class="hljs-number">8</span></span>cc: <span class="hljs-number"><span class="hljs-number">48</span></span> <span class="hljs-number"><span class="hljs-number">89</span></span> <span class="hljs-number"><span class="hljs-number">14</span></span> <span class="hljs-number"><span class="hljs-number">24</span></span> mov %rdx,(%rsp) <span class="hljs-number"><span class="hljs-number">8</span></span>d0: <span class="hljs-number"><span class="hljs-number">48</span></span> <span class="hljs-number"><span class="hljs-number">89</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span>c <span class="hljs-number"><span class="hljs-number">24</span></span> <span class="hljs-number"><span class="hljs-number">08</span></span> mov %rcx,<span class="hljs-number"><span class="hljs-number">0x8</span></span>(%rsp) <span class="hljs-number"><span class="hljs-number">8</span></span>d5: <span class="hljs-number"><span class="hljs-number">48</span></span> <span class="hljs-number"><span class="hljs-number">89</span></span> <span class="hljs-number"><span class="hljs-number">44</span></span> <span class="hljs-number"><span class="hljs-number">24</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span> mov %rax,<span class="hljs-number"><span class="hljs-number">0x10</span></span>(%rsp) <span class="hljs-number"><span class="hljs-number">8</span></span>da: <span class="hljs-number"><span class="hljs-number">48</span></span> c7 c1 <span class="hljs-number"><span class="hljs-number">2</span></span>d <span class="hljs-number"><span class="hljs-number">5</span></span>b <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> mov $0x5b2d,%rcx <span class="hljs-number"><span class="hljs-number">8e1</span></span>: e8 <span class="hljs-number"><span class="hljs-number">2</span></span>a <span class="hljs-number"><span class="hljs-number">02</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> callq b10 &lt;__afl_maybe_log&gt; <span class="hljs-number"><span class="hljs-number">8e6</span></span>: <span class="hljs-number"><span class="hljs-number">48</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span>b <span class="hljs-number"><span class="hljs-number">44</span></span> <span class="hljs-number"><span class="hljs-number">24</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span> mov <span class="hljs-number"><span class="hljs-number">0x10</span></span>(%rsp),%rax <span class="hljs-number"><span class="hljs-number">8</span></span>eb: <span class="hljs-number"><span class="hljs-number">48</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span>b <span class="hljs-number"><span class="hljs-number">4</span></span>c <span class="hljs-number"><span class="hljs-number">24</span></span> <span class="hljs-number"><span class="hljs-number">08</span></span> mov <span class="hljs-number"><span class="hljs-number">0x8</span></span>(%rsp),%rcx <span class="hljs-number"><span class="hljs-number">8</span></span>f0: <span class="hljs-number"><span class="hljs-number">48</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span>b <span class="hljs-number"><span class="hljs-number">14</span></span> <span class="hljs-number"><span class="hljs-number">24</span></span> mov (%rsp),%rdx <span class="hljs-number"><span class="hljs-number">8</span></span>f4: <span class="hljs-number"><span class="hljs-number">48</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span>d a4 <span class="hljs-number"><span class="hljs-number">24</span></span> <span class="hljs-number"><span class="hljs-number">98</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> lea <span class="hljs-number"><span class="hljs-number">0x98</span></span>(%rsp),%rsp <span class="hljs-number"><span class="hljs-number">8</span></span>fb: <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span>fc: <span class="hljs-number"><span class="hljs-number">48</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span>b <span class="hljs-number"><span class="hljs-number">05</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>d <span class="hljs-number"><span class="hljs-number">17</span></span> <span class="hljs-number"><span class="hljs-number">20</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> mov <span class="hljs-number"><span class="hljs-number">0x20171d</span></span>(%rip),%rax # <span class="hljs-number"><span class="hljs-number">202020</span></span> &lt;ptr&gt; <span class="hljs-number"><span class="hljs-number">903</span></span>: c7 <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">01</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> movl $0x1,(%rax) <span class="hljs-number"><span class="hljs-number">909</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>f <span class="hljs-number"><span class="hljs-number">1</span></span>f <span class="hljs-number"><span class="hljs-number">00</span></span> nopl (%rax) <span class="hljs-number"><span class="hljs-number">90</span></span>c: <span class="hljs-number"><span class="hljs-number">48</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span>d a4 <span class="hljs-number"><span class="hljs-number">24</span></span> <span class="hljs-number"><span class="hljs-number">68</span></span> ff ff lea <span class="hljs-number"><span class="hljs-number">-0x98</span></span>(%rsp),%rsp <span class="hljs-number"><span class="hljs-number">913</span></span>: ff <span class="hljs-number"><span class="hljs-number">914</span></span>: <span class="hljs-number"><span class="hljs-number">48</span></span> <span class="hljs-number"><span class="hljs-number">89</span></span> <span class="hljs-number"><span class="hljs-number">14</span></span> <span class="hljs-number"><span class="hljs-number">24</span></span> mov %rdx,(%rsp) <span class="hljs-number"><span class="hljs-number">918</span></span>: <span class="hljs-number"><span class="hljs-number">48</span></span> <span class="hljs-number"><span class="hljs-number">89</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span>c <span class="hljs-number"><span class="hljs-number">24</span></span> <span class="hljs-number"><span class="hljs-number">08</span></span> mov %rcx,<span class="hljs-number"><span class="hljs-number">0x8</span></span>(%rsp) <span class="hljs-number"><span class="hljs-number">91</span></span>d: <span class="hljs-number"><span class="hljs-number">48</span></span> <span class="hljs-number"><span class="hljs-number">89</span></span> <span class="hljs-number"><span class="hljs-number">44</span></span> <span class="hljs-number"><span class="hljs-number">24</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span> mov %rax,<span class="hljs-number"><span class="hljs-number">0x10</span></span>(%rsp) <span class="hljs-number"><span class="hljs-number">922</span></span>: <span class="hljs-number"><span class="hljs-number">48</span></span> c7 c1 <span class="hljs-number"><span class="hljs-number">8</span></span>f <span class="hljs-number"><span class="hljs-number">33</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> mov $0x338f,%rcx <span class="hljs-number"><span class="hljs-number">929</span></span>: e8 e2 <span class="hljs-number"><span class="hljs-number">01</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> callq b10 &lt;__afl_maybe_log&gt; <span class="hljs-number"><span class="hljs-number">92</span></span>e: <span class="hljs-number"><span class="hljs-number">48</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span>b <span class="hljs-number"><span class="hljs-number">44</span></span> <span class="hljs-number"><span class="hljs-number">24</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span> mov <span class="hljs-number"><span class="hljs-number">0x10</span></span>(%rsp),%rax <span class="hljs-number"><span class="hljs-number">933</span></span>: <span class="hljs-number"><span class="hljs-number">48</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span>b <span class="hljs-number"><span class="hljs-number">4</span></span>c <span class="hljs-number"><span class="hljs-number">24</span></span> <span class="hljs-number"><span class="hljs-number">08</span></span> mov <span class="hljs-number"><span class="hljs-number">0x8</span></span>(%rsp),%rcx <span class="hljs-number"><span class="hljs-number">938</span></span>: <span class="hljs-number"><span class="hljs-number">48</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span>b <span class="hljs-number"><span class="hljs-number">14</span></span> <span class="hljs-number"><span class="hljs-number">24</span></span> mov (%rsp),%rdx <span class="hljs-number"><span class="hljs-number">93</span></span>c: <span class="hljs-number"><span class="hljs-number">48</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span>d a4 <span class="hljs-number"><span class="hljs-number">24</span></span> <span class="hljs-number"><span class="hljs-number">98</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> lea <span class="hljs-number"><span class="hljs-number">0x98</span></span>(%rsp),%rsp <span class="hljs-number"><span class="hljs-number">943</span></span>: <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">944</span></span>: <span class="hljs-number"><span class="hljs-number">31</span></span> c0 xor %eax,%eax <span class="hljs-number"><span class="hljs-number">946</span></span>: <span class="hljs-number"><span class="hljs-number">48</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span>b <span class="hljs-number"><span class="hljs-number">54</span></span> <span class="hljs-number"><span class="hljs-number">24</span></span> <span class="hljs-number"><span class="hljs-number">18</span></span> mov <span class="hljs-number"><span class="hljs-number">0x18</span></span>(%rsp),%rdx <span class="hljs-number"><span class="hljs-number">94</span></span>b: <span class="hljs-number"><span class="hljs-number">64</span></span> <span class="hljs-number"><span class="hljs-number">48</span></span> <span class="hljs-number"><span class="hljs-number">33</span></span> <span class="hljs-number"><span class="hljs-number">14</span></span> <span class="hljs-number"><span class="hljs-number">25</span></span> <span class="hljs-number"><span class="hljs-number">28</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> xor %fs:<span class="hljs-number"><span class="hljs-number">0x28</span></span>,%rdx <span class="hljs-number"><span class="hljs-number">952</span></span>: <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">954</span></span>: <span class="hljs-number"><span class="hljs-number">75</span></span> <span class="hljs-number"><span class="hljs-number">40</span></span> jne <span class="hljs-number"><span class="hljs-number">996</span></span> &lt;main+<span class="hljs-number"><span class="hljs-number">0x146</span></span>&gt; <span class="hljs-number"><span class="hljs-number">956</span></span>: <span class="hljs-number"><span class="hljs-number">66</span></span> <span class="hljs-number"><span class="hljs-number">90</span></span> xchg %ax,%ax <span class="hljs-number"><span class="hljs-number">958</span></span>: <span class="hljs-number"><span class="hljs-number">48</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span>d a4 <span class="hljs-number"><span class="hljs-number">24</span></span> <span class="hljs-number"><span class="hljs-number">68</span></span> ff ff lea <span class="hljs-number"><span class="hljs-number">-0x98</span></span>(%rsp),%rsp <span class="hljs-number"><span class="hljs-number">95</span></span>f: ff <span class="hljs-number"><span class="hljs-number">960</span></span>: <span class="hljs-number"><span class="hljs-number">48</span></span> <span class="hljs-number"><span class="hljs-number">89</span></span> <span class="hljs-number"><span class="hljs-number">14</span></span> <span class="hljs-number"><span class="hljs-number">24</span></span> mov %rdx,(%rsp) <span class="hljs-number"><span class="hljs-number">964</span></span>: <span class="hljs-number"><span class="hljs-number">48</span></span> <span class="hljs-number"><span class="hljs-number">89</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span>c <span class="hljs-number"><span class="hljs-number">24</span></span> <span class="hljs-number"><span class="hljs-number">08</span></span> mov %rcx,<span class="hljs-number"><span class="hljs-number">0x8</span></span>(%rsp) <span class="hljs-number"><span class="hljs-number">969</span></span>: <span class="hljs-number"><span class="hljs-number">48</span></span> <span class="hljs-number"><span class="hljs-number">89</span></span> <span class="hljs-number"><span class="hljs-number">44</span></span> <span class="hljs-number"><span class="hljs-number">24</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span> mov %rax,<span class="hljs-number"><span class="hljs-number">0x10</span></span>(%rsp) <span class="hljs-number"><span class="hljs-number">96</span></span>e: <span class="hljs-number"><span class="hljs-number">48</span></span> c7 c1 <span class="hljs-number"><span class="hljs-number">0</span></span>a <span class="hljs-number"><span class="hljs-number">7</span></span>d <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> mov $0x7d0a,%rcx <span class="hljs-number"><span class="hljs-number">975</span></span>: e8 <span class="hljs-number"><span class="hljs-number">96</span></span> <span class="hljs-number"><span class="hljs-number">01</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> callq b10 &lt;__afl_maybe_log&gt; <span class="hljs-number"><span class="hljs-number">97</span></span>a: <span class="hljs-number"><span class="hljs-number">48</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span>b <span class="hljs-number"><span class="hljs-number">44</span></span> <span class="hljs-number"><span class="hljs-number">24</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span> mov <span class="hljs-number"><span class="hljs-number">0x10</span></span>(%rsp),%rax <span class="hljs-number"><span class="hljs-number">97</span></span>f: <span class="hljs-number"><span class="hljs-number">48</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span>b <span class="hljs-number"><span class="hljs-number">4</span></span>c <span class="hljs-number"><span class="hljs-number">24</span></span> <span class="hljs-number"><span class="hljs-number">08</span></span> mov <span class="hljs-number"><span class="hljs-number">0x8</span></span>(%rsp),%rcx <span class="hljs-number"><span class="hljs-number">984</span></span>: <span class="hljs-number"><span class="hljs-number">48</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span>b <span class="hljs-number"><span class="hljs-number">14</span></span> <span class="hljs-number"><span class="hljs-number">24</span></span> mov (%rsp),%rdx <span class="hljs-number"><span class="hljs-number">988</span></span>: <span class="hljs-number"><span class="hljs-number">48</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span>d a4 <span class="hljs-number"><span class="hljs-number">24</span></span> <span class="hljs-number"><span class="hljs-number">98</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> lea <span class="hljs-number"><span class="hljs-number">0x98</span></span>(%rsp),%rsp <span class="hljs-number"><span class="hljs-number">98</span></span>f: <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">990</span></span>: <span class="hljs-number"><span class="hljs-number">48</span></span> <span class="hljs-number"><span class="hljs-number">83</span></span> c4 <span class="hljs-number"><span class="hljs-number">20</span></span> add $0x20,%rsp <span class="hljs-number"><span class="hljs-number">994</span></span>: <span class="hljs-number"><span class="hljs-number">5</span></span>b pop %rbx <span class="hljs-number"><span class="hljs-number">995</span></span>: c3 retq <span class="hljs-number"><span class="hljs-number">996</span></span>: <span class="hljs-number"><span class="hljs-number">66</span></span> <span class="hljs-number"><span class="hljs-number">90</span></span> xchg %ax,%ax <span class="hljs-number"><span class="hljs-number">998</span></span>: <span class="hljs-number"><span class="hljs-number">48</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span>d a4 <span class="hljs-number"><span class="hljs-number">24</span></span> <span class="hljs-number"><span class="hljs-number">68</span></span> ff ff lea <span class="hljs-number"><span class="hljs-number">-0x98</span></span>(%rsp),%rsp <span class="hljs-number"><span class="hljs-number">99</span></span>f: ff <span class="hljs-number"><span class="hljs-number">9</span></span>a0: <span class="hljs-number"><span class="hljs-number">48</span></span> <span class="hljs-number"><span class="hljs-number">89</span></span> <span class="hljs-number"><span class="hljs-number">14</span></span> <span class="hljs-number"><span class="hljs-number">24</span></span> mov %rdx,(%rsp) <span class="hljs-number"><span class="hljs-number">9</span></span>a4: <span class="hljs-number"><span class="hljs-number">48</span></span> <span class="hljs-number"><span class="hljs-number">89</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span>c <span class="hljs-number"><span class="hljs-number">24</span></span> <span class="hljs-number"><span class="hljs-number">08</span></span> mov %rcx,<span class="hljs-number"><span class="hljs-number">0x8</span></span>(%rsp) <span class="hljs-number"><span class="hljs-number">9</span></span>a9: <span class="hljs-number"><span class="hljs-number">48</span></span> <span class="hljs-number"><span class="hljs-number">89</span></span> <span class="hljs-number"><span class="hljs-number">44</span></span> <span class="hljs-number"><span class="hljs-number">24</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span> mov %rax,<span class="hljs-number"><span class="hljs-number">0x10</span></span>(%rsp) <span class="hljs-number"><span class="hljs-number">9</span></span>ae: <span class="hljs-number"><span class="hljs-number">48</span></span> c7 c1 a8 dc <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> mov $0xdca8,%rcx <span class="hljs-number"><span class="hljs-number">9</span></span>b5: e8 <span class="hljs-number"><span class="hljs-number">56</span></span> <span class="hljs-number"><span class="hljs-number">01</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> callq b10 &lt;__afl_maybe_log&gt; <span class="hljs-number"><span class="hljs-number">9</span></span>ba: <span class="hljs-number"><span class="hljs-number">48</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span>b <span class="hljs-number"><span class="hljs-number">44</span></span> <span class="hljs-number"><span class="hljs-number">24</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span> mov <span class="hljs-number"><span class="hljs-number">0x10</span></span>(%rsp),%rax <span class="hljs-number"><span class="hljs-number">9</span></span>bf: <span class="hljs-number"><span class="hljs-number">48</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span>b <span class="hljs-number"><span class="hljs-number">4</span></span>c <span class="hljs-number"><span class="hljs-number">24</span></span> <span class="hljs-number"><span class="hljs-number">08</span></span> mov <span class="hljs-number"><span class="hljs-number">0x8</span></span>(%rsp),%rcx <span class="hljs-number"><span class="hljs-number">9</span></span>c4: <span class="hljs-number"><span class="hljs-number">48</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span>b <span class="hljs-number"><span class="hljs-number">14</span></span> <span class="hljs-number"><span class="hljs-number">24</span></span> mov (%rsp),%rdx <span class="hljs-number"><span class="hljs-number">9</span></span>c8: <span class="hljs-number"><span class="hljs-number">48</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span>d a4 <span class="hljs-number"><span class="hljs-number">24</span></span> <span class="hljs-number"><span class="hljs-number">98</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> lea <span class="hljs-number"><span class="hljs-number">0x98</span></span>(%rsp),%rsp <span class="hljs-number"><span class="hljs-number">9</span></span>cf: <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">9</span></span>d0: e8 <span class="hljs-number"><span class="hljs-number">33</span></span> fe ff ff callq <span class="hljs-number"><span class="hljs-number">808</span></span> &lt;.plt.got+<span class="hljs-number"><span class="hljs-number">0x18</span></span>&gt; <span class="hljs-number"><span class="hljs-number">9</span></span>d5: <span class="hljs-number"><span class="hljs-number">66</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>e <span class="hljs-number"><span class="hljs-number">0</span></span>f <span class="hljs-number"><span class="hljs-number">1</span></span>f <span class="hljs-number"><span class="hljs-number">84</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> nopw %cs:<span class="hljs-number"><span class="hljs-number">0x0</span></span>(%rax,%rax,<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-number"><span class="hljs-number">9</span></span>dc: <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">9</span></span>df: <span class="hljs-number"><span class="hljs-number">90</span></span> nop</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">The same, but without instrumentation</b> <div class="spoiler_text"><pre> <code class="hljs mel"><span class="hljs-number"><span class="hljs-number">0000000000000630</span></span> &lt;.plt.got&gt;: <span class="hljs-number"><span class="hljs-number">630</span></span>: ff <span class="hljs-number"><span class="hljs-number">25</span></span> <span class="hljs-number"><span class="hljs-number">82</span></span> <span class="hljs-number"><span class="hljs-number">09</span></span> <span class="hljs-number"><span class="hljs-number">20</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> jmpq *<span class="hljs-number"><span class="hljs-number">0x200982</span></span>(%rip) # <span class="hljs-number"><span class="hljs-number">200</span></span>fb8 &lt;strncmp@GLIBC_2<span class="hljs-number"><span class="hljs-number">.2</span></span><span class="hljs-number"><span class="hljs-number">.5</span></span>&gt; <span class="hljs-number"><span class="hljs-number">636</span></span>: <span class="hljs-number"><span class="hljs-number">66</span></span> <span class="hljs-number"><span class="hljs-number">90</span></span> xchg %ax,%ax <span class="hljs-number"><span class="hljs-number">638</span></span>: ff <span class="hljs-number"><span class="hljs-number">25</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span>a <span class="hljs-number"><span class="hljs-number">09</span></span> <span class="hljs-number"><span class="hljs-number">20</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> jmpq *<span class="hljs-number"><span class="hljs-number">0x20098a</span></span>(%rip) # <span class="hljs-number"><span class="hljs-number">200</span></span>fc8 &lt;__stack_chk_fail@GLIBC_2<span class="hljs-number"><span class="hljs-number">.4</span></span>&gt; <span class="hljs-number"><span class="hljs-number">63</span></span>e: <span class="hljs-number"><span class="hljs-number">66</span></span> <span class="hljs-number"><span class="hljs-number">90</span></span> xchg %ax,%ax <span class="hljs-number"><span class="hljs-number">640</span></span>: ff <span class="hljs-number"><span class="hljs-number">25</span></span> <span class="hljs-number"><span class="hljs-number">92</span></span> <span class="hljs-number"><span class="hljs-number">09</span></span> <span class="hljs-number"><span class="hljs-number">20</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> jmpq *<span class="hljs-number"><span class="hljs-number">0x200992</span></span>(%rip) # <span class="hljs-number"><span class="hljs-number">200</span></span>fd8 &lt;fgets@GLIBC_2<span class="hljs-number"><span class="hljs-number">.2</span></span><span class="hljs-number"><span class="hljs-number">.5</span></span>&gt; <span class="hljs-number"><span class="hljs-number">646</span></span>: <span class="hljs-number"><span class="hljs-number">66</span></span> <span class="hljs-number"><span class="hljs-number">90</span></span> xchg %ax,%ax <span class="hljs-number"><span class="hljs-number">648</span></span>: ff <span class="hljs-number"><span class="hljs-number">25</span></span> aa <span class="hljs-number"><span class="hljs-number">09</span></span> <span class="hljs-number"><span class="hljs-number">20</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> jmpq *<span class="hljs-number"><span class="hljs-number">0x2009aa</span></span>(%rip) # <span class="hljs-number"><span class="hljs-number">200</span></span>ff8 &lt;__cxa_finalize@GLIBC_2<span class="hljs-number"><span class="hljs-number">.2</span></span><span class="hljs-number"><span class="hljs-number">.5</span></span>&gt; <span class="hljs-number"><span class="hljs-number">64</span></span>e: <span class="hljs-number"><span class="hljs-number">66</span></span> <span class="hljs-number"><span class="hljs-number">90</span></span> xchg %ax,%ax ... <span class="hljs-number"><span class="hljs-number">0000000000000780</span></span> &lt;main&gt;: <span class="hljs-number"><span class="hljs-number">780</span></span>: <span class="hljs-number"><span class="hljs-number">55</span></span> push %rbp <span class="hljs-number"><span class="hljs-number">781</span></span>: <span class="hljs-number"><span class="hljs-number">48</span></span> <span class="hljs-number"><span class="hljs-number">89</span></span> e5 mov %rsp,%rbp <span class="hljs-number"><span class="hljs-number">784</span></span>: <span class="hljs-number"><span class="hljs-number">48</span></span> <span class="hljs-number"><span class="hljs-number">83</span></span> ec <span class="hljs-number"><span class="hljs-number">30</span></span> sub $0x30,%rsp <span class="hljs-number"><span class="hljs-number">788</span></span>: <span class="hljs-number"><span class="hljs-number">89</span></span> <span class="hljs-number"><span class="hljs-number">7</span></span>d dc mov %edi,<span class="hljs-number"><span class="hljs-number">-0x24</span></span>(%rbp) <span class="hljs-number"><span class="hljs-number">78</span></span>b: <span class="hljs-number"><span class="hljs-number">48</span></span> <span class="hljs-number"><span class="hljs-number">89</span></span> <span class="hljs-number"><span class="hljs-number">75</span></span> d0 mov %rsi,<span class="hljs-number"><span class="hljs-number">-0x30</span></span>(%rbp) <span class="hljs-number"><span class="hljs-number">78</span></span>f: <span class="hljs-number"><span class="hljs-number">64</span></span> <span class="hljs-number"><span class="hljs-number">48</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span>b <span class="hljs-number"><span class="hljs-number">04</span></span> <span class="hljs-number"><span class="hljs-number">25</span></span> <span class="hljs-number"><span class="hljs-number">28</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> mov %fs:<span class="hljs-number"><span class="hljs-number">0x28</span></span>,%rax <span class="hljs-number"><span class="hljs-number">796</span></span>: <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">798</span></span>: <span class="hljs-number"><span class="hljs-number">48</span></span> <span class="hljs-number"><span class="hljs-number">89</span></span> <span class="hljs-number"><span class="hljs-number">45</span></span> f8 mov %rax,<span class="hljs-number"><span class="hljs-number">-0x8</span></span>(%rbp) <span class="hljs-number"><span class="hljs-number">79</span></span>c: <span class="hljs-number"><span class="hljs-number">31</span></span> c0 xor %eax,%eax <span class="hljs-number"><span class="hljs-number">79</span></span>e: <span class="hljs-number"><span class="hljs-number">48</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span>b <span class="hljs-number"><span class="hljs-number">15</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span>b <span class="hljs-number"><span class="hljs-number">08</span></span> <span class="hljs-number"><span class="hljs-number">20</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> mov <span class="hljs-number"><span class="hljs-number">0x20086b</span></span>(%rip),%rdx # <span class="hljs-number"><span class="hljs-number">201010</span></span> &lt;stdin@@GLIBC_2<span class="hljs-number"><span class="hljs-number">.2</span></span><span class="hljs-number"><span class="hljs-number">.5</span></span>&gt; <span class="hljs-number"><span class="hljs-number">7</span></span>a5: <span class="hljs-number"><span class="hljs-number">48</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span>d <span class="hljs-number"><span class="hljs-number">45</span></span> e0 lea <span class="hljs-number"><span class="hljs-number">-0x20</span></span>(%rbp),%rax <span class="hljs-number"><span class="hljs-number">7</span></span>a9: be <span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> mov $0x10,%esi <span class="hljs-number"><span class="hljs-number">7</span></span>ae: <span class="hljs-number"><span class="hljs-number">48</span></span> <span class="hljs-number"><span class="hljs-number">89</span></span> c7 mov %rax,%rdi <span class="hljs-number"><span class="hljs-number">7</span></span>b1: e8 <span class="hljs-number"><span class="hljs-number">8</span></span>a fe ff ff callq <span class="hljs-number"><span class="hljs-number">640</span></span> &lt;.plt.got+<span class="hljs-number"><span class="hljs-number">0x10</span></span>&gt; <span class="hljs-number"><span class="hljs-number">7</span></span>b6: <span class="hljs-number"><span class="hljs-number">48</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span>d <span class="hljs-number"><span class="hljs-number">45</span></span> e0 lea <span class="hljs-number"><span class="hljs-number">-0x20</span></span>(%rbp),%rax <span class="hljs-number"><span class="hljs-number">7</span></span>ba: ba <span class="hljs-number"><span class="hljs-number">04</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> mov $0x4,%edx <span class="hljs-number"><span class="hljs-number">7</span></span>bf: <span class="hljs-number"><span class="hljs-number">48</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span>d <span class="hljs-number"><span class="hljs-number">35</span></span> ce <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> lea <span class="hljs-number"><span class="hljs-number">0xce</span></span>(%rip),%rsi # <span class="hljs-number"><span class="hljs-number">894</span></span> &lt;cmd&gt; <span class="hljs-number"><span class="hljs-number">7</span></span>c6: <span class="hljs-number"><span class="hljs-number">48</span></span> <span class="hljs-number"><span class="hljs-number">89</span></span> c7 mov %rax,%rdi <span class="hljs-number"><span class="hljs-number">7</span></span>c9: e8 <span class="hljs-number"><span class="hljs-number">62</span></span> fe ff ff callq <span class="hljs-number"><span class="hljs-number">630</span></span> &lt;.plt.got&gt; <span class="hljs-number"><span class="hljs-number">7</span></span>ce: <span class="hljs-number"><span class="hljs-number">85</span></span> c0 test %eax,%eax <span class="hljs-number"><span class="hljs-number">7</span></span>d0: <span class="hljs-number"><span class="hljs-number">74</span></span> <span class="hljs-number"><span class="hljs-number">07</span></span> je <span class="hljs-number"><span class="hljs-number">7</span></span>d9 &lt;main+<span class="hljs-number"><span class="hljs-number">0x59</span></span>&gt; <span class="hljs-number"><span class="hljs-number">7</span></span>d2: b8 <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> mov $0x0,%eax <span class="hljs-number"><span class="hljs-number">7</span></span>d7: eb <span class="hljs-number"><span class="hljs-number">12</span></span> jmp <span class="hljs-number"><span class="hljs-number">7</span></span>eb &lt;main+<span class="hljs-number"><span class="hljs-number">0x6b</span></span>&gt; <span class="hljs-number"><span class="hljs-number">7</span></span>d9: <span class="hljs-number"><span class="hljs-number">48</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span>b <span class="hljs-number"><span class="hljs-number">05</span></span> <span class="hljs-number"><span class="hljs-number">40</span></span> <span class="hljs-number"><span class="hljs-number">08</span></span> <span class="hljs-number"><span class="hljs-number">20</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> mov <span class="hljs-number"><span class="hljs-number">0x200840</span></span>(%rip),%rax # <span class="hljs-number"><span class="hljs-number">201020</span></span> &lt;ptr&gt; <span class="hljs-number"><span class="hljs-number">7e0</span></span>: c7 <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">01</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> movl $0x1,(%rax) <span class="hljs-number"><span class="hljs-number">7e6</span></span>: b8 <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> mov $0x0,%eax <span class="hljs-number"><span class="hljs-number">7</span></span>eb: <span class="hljs-number"><span class="hljs-number">48</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span>b <span class="hljs-number"><span class="hljs-number">4</span></span>d f8 mov <span class="hljs-number"><span class="hljs-number">-0x8</span></span>(%rbp),%rcx <span class="hljs-number"><span class="hljs-number">7</span></span>ef: <span class="hljs-number"><span class="hljs-number">64</span></span> <span class="hljs-number"><span class="hljs-number">48</span></span> <span class="hljs-number"><span class="hljs-number">33</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>c <span class="hljs-number"><span class="hljs-number">25</span></span> <span class="hljs-number"><span class="hljs-number">28</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> xor %fs:<span class="hljs-number"><span class="hljs-number">0x28</span></span>,%rcx <span class="hljs-number"><span class="hljs-number">7</span></span>f6: <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">7</span></span>f8: <span class="hljs-number"><span class="hljs-number">74</span></span> <span class="hljs-number"><span class="hljs-number">05</span></span> je <span class="hljs-number"><span class="hljs-number">7</span></span>ff &lt;main+<span class="hljs-number"><span class="hljs-number">0x7f</span></span>&gt; <span class="hljs-number"><span class="hljs-number">7</span></span>fa: e8 <span class="hljs-number"><span class="hljs-number">39</span></span> fe ff ff callq <span class="hljs-number"><span class="hljs-number">638</span></span> &lt;.plt.got+<span class="hljs-number"><span class="hljs-number">0x8</span></span>&gt; <span class="hljs-number"><span class="hljs-number">7</span></span>ff: c9 leaveq <span class="hljs-number"><span class="hljs-number">800</span></span>: c3 retq <span class="hljs-number"><span class="hljs-number">801</span></span>: <span class="hljs-number"><span class="hljs-number">66</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>e <span class="hljs-number"><span class="hljs-number">0</span></span>f <span class="hljs-number"><span class="hljs-number">1</span></span>f <span class="hljs-number"><span class="hljs-number">84</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> nopw %cs:<span class="hljs-number"><span class="hljs-number">0x0</span></span>(%rax,%rax,<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-number"><span class="hljs-number">808</span></span>: <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">80</span></span>b: <span class="hljs-number"><span class="hljs-number">0</span></span>f <span class="hljs-number"><span class="hljs-number">1</span></span>f <span class="hljs-number"><span class="hljs-number">44</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> nopl <span class="hljs-number"><span class="hljs-number">0x0</span></span>(%rax,%rax,<span class="hljs-number"><span class="hljs-number">1</span></span>)</code> </pre> </div></div><br><p>  What is interesting, it seems, AFL itself turned on the optimization, because <code>strncmp</code> is honestly called in the non-instrumented code.  As for the swollen PLT in the code compiled by <code>afl-gcc</code> , then, apparently, we see the functions called by forkserver ‚Äî we will write it too, but in order.  Well, let's pretend that we have not seen this, and try to naively rewrite our example without library functions: </p><br><pre> <code class="hljs rust">#include &lt;stdio.h&gt; volatile int *ptr = NULL; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-built_in"><span class="hljs-built_in">char</span></span> cmd[] = <span class="hljs-string"><span class="hljs-string">"NULL"</span></span>; int main(int argc, <span class="hljs-built_in"><span class="hljs-built_in">char</span></span> *argv[]) { <span class="hljs-built_in"><span class="hljs-built_in">char</span></span> buf[<span class="hljs-number"><span class="hljs-number">16</span></span>]; fgets(buf, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span> buf, stdin); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (int i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span> cmd - <span class="hljs-number"><span class="hljs-number">1</span></span>; ++i) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (buf[i] != cmd[i]) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; } *ptr = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; }</code> </pre> <br><p>  Compile, run and ... tadam! </p><br><div style="text-align:center;"><img title="Test bug found" src="https://habrastorage.org/web/952/368/d30/952368d3024e4c47ad1d56a7c0e10782.png"></div><br><h1 id="pishem-svoy-forkserver">  Writing your forkserver </h1><br><p>  As I said, AFL assumes the presence of instrumentation that collects information about transitions between the basic blocks of the program under study.  But there is another optimization added by <code>afl-gcc</code> : <a href="https://lcamtuf.blogspot.ru/2014/10/fuzzing-binaries-without-execve.html">forkserver</a> .  Its meaning is not to restart the program using the <code>fork</code> - <code>execve</code> bundle, each time performing dynamic linking, etc., and once in the fuzzer process, make a <code>fork</code> , then <code>execve</code> into an instrumented program.  How are we going to restart the program under study?  The point is that we will not test this running process.  Instead, it runs code that waits for a command from the fuzzer in an infinite loop, makes a <code>fork</code> , waits for the completion of the child process, and calls back the result.  But the budding process actually processes the input data and collects information about the edge coating.  In the case of <code>afl-gcc</code> , if I understand its logic correctly, the forkserver is started when you first access the instrumented code.  In the case of <code>llvm mode</code> , the <em>deferred forkserver</em> <code>llvm mode</code> also supported - this way you can skip not only the dynamic linking, but also the initialization standard for the process being studied, which can potentially speed up the whole process by orders of magnitude, but some nuances should be taken into account: </p><br><ul><li>  the execution of the process before starting the forkserver should not depend on the input data </li><li>  spawned processes should not share a common state, for example, the current position pointer for the file descriptor open at the time of launching forkserver </li><li>  calling <code>fork</code> creates a copy of the process, but this copy will contain only the thread that made the <code>fork</code> call </li><li>  ... </li></ul><br><p>  Also in llvm mode, <em>persistent</em> mode is supported, in which several test cases are executed in a row within the same budding process.  Probably, this further reduces the overhead, but there is a danger that the result of the program at the next test example will depend not only on the current example, but also on the launch history.  By the way, after I started writing this article, I came across information that the <a href="https://github.com/ivanfratric/winafl">AFL port on Windows</a> also uses DynamoRIO for instrumentation, and it just uses persistent mode.  Well, what else is he left without <code>fork</code> support? </p><br><p>  So, you need to write your forkserver on DynamoRIO, but first you need to understand the required protocol for its interaction with the fuzzer process.  Something can be found at the above link to the AFL author's blog, but it is easier to find the <code>llvm_mode/afl-llvm-rt.oc</code> file in the <code>llvm_mode/afl-llvm-rt.oc</code> .  There are a lot of interesting things in it, but first we will look at the function <code>__afl_start_forkserver</code> - everything is described there in detail, even with comments.  We are not interested in Persistent mode, otherwise everything is pretty clear: we are given two file descriptors with known numbers - from one we read, to the other we write.  We need: </p><br><ol><li>  Quote from source: <em>Phone home and tell the parent that we're OK</em> .  Write any 4 bytes. </li><li>  We read 4 bytes.  Since it seems that in our case (without persistent mode) we have the invariant <code>child_stopped == 0</code> , what we read does not matter. </li><li>  We budge the child process and close the file descriptors in it to communicate with the fuzzer. </li><li>  We write 4 bytes with the PID of the child process into the file descriptor and wait for it (the process) to complete. </li><li>  After waiting, we write another 4 bytes with the return code and go to step 2. </li></ol><br><p>  And here we are, in fact, approached the writing of his <em>client</em> .  Here it is necessary to make a digression about the fact that although the examples from the documentation take only a couple of hundred lines, the documentation is still worth reading.  You can start, for example, <a href="http://dynamorio.org/docs/using.html">from here</a> , where, in particular, it is written about what you should not do.  For example, to paraphrase a well-known literary character, one can say that ‚Äúthe client of the instrumentation is a very strange thing: it seems to be there, but it‚Äôs not like‚Äù, which is called <a href="http://dynamorio.org/docs/transparency.html">client transparency</a> in the documentation: in particular, you need to use your copies of the system libraries ( which will help the private loader), or use the API DynamoRIO (memory allocation, parsing command line options and much more).  Also, important information is in the API function documentation: for example, the description of the <a href="http://dynamorio.org/docs/dr__events_8h.html">dr_register_bb_event</a> function indicates a short list of 11 items, which the resulting sequence of instructions after instrumentation should satisfy. </p><br><p>  To control the client build for DynamoRIO, it is recommended to use CMake - we will use it.  How to do this, you can read in the <a href="http://dynamorio.org/docs/using.html">documentation</a> , we move on to more interesting questions.  For example, in order to make a deferred forkserver, we need to somehow mark the place of its launch in the program under study, and then find this mark in DynamoRIO (however, nothing seems to prevent the forkserver from being simply called as a normal function call inside the program being studied, but it's also not interesting, is it?), Fortunately, this functionality is built into DynamoRIO and is called <a href="http://dynamorio.org/docs/using.html">annotations</a> .  The client's developer must compile a special static library that needs to be linked to the program under study, and in the required place call a function from this library, the sequence of instructions in which does not do anything interesting with the normal execution, but when launched under DynamoRIO it is recognized by it and replaced by a specific constant or function call. </p><br><p>  I will not repeat the <a href="http://dynamorio.org/docs/API_tutorial_annotation1.html">official tutorial</a> , let me just say that it is proposed to copy the header file from the DynamoRIO distribution, remake the ‚Äúcall‚Äù of two macros under the name and signature of our annotation (this file will need to be included in the program under test), and also create a source code with more by one call of the macro, which will generate the implementation of the stub for the annotation (a static library will be assembled from it, which must be linked to the program under test). </p><br><p>  About the forkserver implementation, everything is also pretty straightforward, except that it is probably not very correct to call the <code>fork</code> from our copy of <code>libc</code> : for example, the AFL author in the article above on the implementation features of forkserver said that <code>libc</code> caches the PID.  In the case of a <code>fork</code> call from the <code>libc</code> copy of the application under study, it will know about the <code>fork</code> call that has occurred, and DynamoRIO will, I would like to believe, also notice.  So I had to write something like </p><br><pre> <code class="hljs cpp"><span class="hljs-keyword"><span class="hljs-keyword">module_data_t</span></span> *<span class="hljs-keyword"><span class="hljs-keyword">module</span></span> = dr_lookup_module_by_name(<span class="hljs-string"><span class="hljs-string">"libc.so.6"</span></span>); EXIT_IF_FAILED(<span class="hljs-keyword"><span class="hljs-keyword">module</span></span> != <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">"Cannot lookup libc.\n"</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">fork_fun_t</span></span> fork_ptr = (<span class="hljs-keyword"><span class="hljs-keyword">fork_fun_t</span></span>)dr_get_proc_address(<span class="hljs-keyword"><span class="hljs-keyword">module</span></span>-&gt;handle, <span class="hljs-string"><span class="hljs-string">"fork"</span></span>); EXIT_IF_FAILED(fork_ptr != <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">"Cannot get fork function from libc.\n"</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>) dr_free_module_data(<span class="hljs-keyword"><span class="hljs-keyword">module</span></span>);</code> </pre> <br><p>  Therefore, in order to support the traditional startup mode of the forkserver when starting the program, you need to make sure that libc is already available at this point. </p><br><p>     ,     :   ,  forkserver ‚Äî .    <code>dr_client_main</code>    ‚Äî    .       . ‚Ä¶ .   <code>nm -D</code>      :  ,     <code>dr_client_main</code> .    ‚Äî  ‚Ä¶   drrun  <code>-verbose -debug</code> .  ,     ,       ,      .      QtCreator   <code>.../build-afl-dr-Desktop_3fb6e5-</code> ,   "" ‚Äî <code>.../build-afl-dr-Desktop- </code> .   ,   <em> </em> . ,  ,     ,     ,     , , , ‚Ä¶ <em>(,   <a href="https://github.com/DynamoRIO/dynamorio/issues/2538">-</a> .)</em> </p><br><p>  Testing: </p><br><pre> <code class="hljs javascript">$ ~<span class="hljs-regexp"><span class="hljs-regexp">/soft/</span></span>DynamoRIO-Linux<span class="hljs-number"><span class="hljs-number">-6.2</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">-2</span></span>/bin64/drrun -c libafl-dr.so -- ./example-bug Running forkserver... Cannot connect to fuzzer. <span class="hljs-number"><span class="hljs-number">1</span></span> $ ~<span class="hljs-regexp"><span class="hljs-regexp">/soft/</span></span>DynamoRIO-Linux<span class="hljs-number"><span class="hljs-number">-6.2</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">-2</span></span>/bin64/drrun -c libafl-dr.so -- ./example-bug <span class="hljs-number"><span class="hljs-number">198</span></span>&lt;&amp;<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">199</span></span>&gt;<span class="hljs-regexp"><span class="hljs-regexp">/dev/</span></span><span class="hljs-literal"><span class="hljs-literal">null</span></span> Running forkserver... xxxx <span class="hljs-number"><span class="hljs-number">1</span></span> Incorrect spawn command <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> fuzzer.</code> </pre> <br><p> , - . ,     AFL.      dumb mode (   ),    -  forkserver: </p><br><pre> <code class="hljs ruby">$ AFL_DUMB_FORKSRV=<span class="hljs-number"><span class="hljs-number">1</span></span> $AFL_PATH/afl-fuzz -i input -o output -n -- ./example-bug ... -   Fork server handshake failed -- ,   ... $ AFL_DUMB_FORKSRV=<span class="hljs-number"><span class="hljs-number">1</span></span> $AFL_PATH/afl-fuzz -i input -o output -n -- ~<span class="hljs-regexp"><span class="hljs-regexp">/soft/</span></span>DynamoRIO-Linux-<span class="hljs-number"><span class="hljs-number">6.2</span></span>.<span class="hljs-number"><span class="hljs-number">0</span></span>-<span class="hljs-number"><span class="hljs-number">2</span></span>/bin64/drrun -c libafl-dr.so -- ./example-bug ... -   Timeout <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> initializing fork server (adjusting -t may help) $ <span class="hljs-comment"><span class="hljs-comment">#   strace- ... $ AFL_DUMB_FORKSRV=1 $AFL_PATH/afl-fuzz -i input -o output -n -m 2048 -- ~/soft/DynamoRIO-Linux-6.2.0-2/bin64/drrun -c libafl-dr.so -- ./example-bug ...  ,     ( -m)</span></span></code> </pre><br><div style="text-align:center;"><img title="AFL  forkserver  DynamoRIO" src="https://habrastorage.org/web/b17/5be/61e/b175be61e01f41e8b5d2e90dfc0b526a.png"></div><br><p> ,   .        . </p><br><p>    :      forkserver  ,        SIGSEGV.   ,   ,     ,  ,        <code>fork</code>   <code>libc</code> ,  ,   .   ,     extension   <code>droption</code> .   ,        <code>dr_option_t&lt;T&gt;</code> ,     ,     ,    <code>dr_client_main</code>  <code>droption_parser_t::parse_argv(...)</code> (,       C++).  ,        7.0 RC1,   6.2.0-2     ,     CMake  <code>droption</code> -  .    . ,       ,         , , <code>drutil</code> . </p><br><p>     : </p><br><div class="spoiler"> <b class="spoiler_title">afl-annotations.h</b> <div class="spoiler_text"><pre> <code class="hljs smalltalk">// <span class="hljs-type"><span class="hljs-type">Based</span></span> on dr_annotations.h from <span class="hljs-type"><span class="hljs-type">DynamoRIO</span></span> sources <span class="hljs-symbol"><span class="hljs-symbol">#ifndef</span></span> _AFL_DR_ANNOTATIONS_H_ <span class="hljs-symbol"><span class="hljs-symbol">#define</span></span> _AFL_DR_ANNOTATIONS_H_ <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#include</span></span> <span class="hljs-comment"><span class="hljs-comment">"annotations/dr_annotations_asm.h"</span></span> /* <span class="hljs-type"><span class="hljs-type">To</span></span> simplify project configuration, this pragma excludes the file from <span class="hljs-type"><span class="hljs-type">GCC</span></span> warnings. */ <span class="hljs-symbol"><span class="hljs-symbol">#ifdef</span></span> __GNUC__ # pragma <span class="hljs-type"><span class="hljs-type">GCC</span></span> system_header <span class="hljs-symbol"><span class="hljs-symbol">#endif</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#define</span></span> <span class="hljs-type"><span class="hljs-type">RUN_FORKSERVER</span></span>() \ <span class="hljs-type"><span class="hljs-type">DR_ANNOTATION</span></span>(run_forkserver) <span class="hljs-symbol"><span class="hljs-symbol">#ifdef</span></span> __cplusplus extern <span class="hljs-comment"><span class="hljs-comment">"C"</span></span> { <span class="hljs-symbol"><span class="hljs-symbol">#endif</span></span> <span class="hljs-type"><span class="hljs-type">DR_DECLARE_ANNOTATION</span></span>(void, run_forkserver, ()); <span class="hljs-symbol"><span class="hljs-symbol">#ifdef</span></span> __cplusplus } <span class="hljs-symbol"><span class="hljs-symbol">#endif</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#endif</span></span></code> </pre> </div></div><br><div class="spoiler"> <b class="spoiler_title">afl-annotations.c</b> <div class="spoiler_text"><pre> <code class="hljs lisp">#include <span class="hljs-string"><span class="hljs-string">"afl-annotations.h"</span></span> DR_DEFINE_ANNOTATION(<span class="hljs-name"><span class="hljs-name">void</span></span>, run_forkserver, (), )<span class="hljs-comment"><span class="hljs-comment">;</span></span></code> </pre> </div></div><br><div class="spoiler"> <b class="spoiler_title">afl-dr.c</b> <div class="spoiler_text"><pre> <code class="hljs lua">#include &lt;dr_api.h&gt; #include &lt;droption.h&gt; #include &lt;stdint.h&gt; #include &lt;unistd.h&gt; #include &lt;sys/wait.h&gt; #include <span class="hljs-string"><span class="hljs-string">"afl-annotations.h"</span></span> static const int FROM_FUZZER_FD = <span class="hljs-number"><span class="hljs-number">198</span></span>; static const int TO_FUZZER_FD = <span class="hljs-number"><span class="hljs-number">199</span></span>; typedef int (*fork_fun_t)(); #define EXIT_IF_FAILED(isOk, msg, code) \ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!(isOk)) { \ dr_fprintf(STDERR, (msg)); \ dr_exit_process((code)); \ } static droption_t&lt;bool&gt; opt_private_fork(DROPTION_SCOPE_CLIENT, <span class="hljs-string"><span class="hljs-string">"private-fork"</span></span>, <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-string"><span class="hljs-string">"Use fork function from the private libc"</span></span>, <span class="hljs-string"><span class="hljs-string">"Use fork function from the private libc"</span></span>); static void parse_options(int argc, const <span class="hljs-built_in"><span class="hljs-built_in">char</span></span> *argv[]) { std::<span class="hljs-built_in"><span class="hljs-built_in">string</span></span> parse_err; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!droption_parser_t::parse_argv(DROPTION_SCOPE_CLIENT, argc, argv, &amp;parse_err, NULL)) { dr_fprintf(STDERR, <span class="hljs-string"><span class="hljs-string">"Incorrect client options: %s\n"</span></span>, parse_err.c_str()); dr_exit_process(<span class="hljs-number"><span class="hljs-number">1</span></span>); } } static void start_forkserver() { // For references, see https://lcamtuf.blogspot.ru/<span class="hljs-number"><span class="hljs-number">2014</span></span>/<span class="hljs-number"><span class="hljs-number">10</span></span>/fuzzing-binaries-without-execve.html // <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> __afl_start_forkserver <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> llvm_mode/afl-llvm-rt.oc from AFL sources static bool forkserver_is_running = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; uint32_t unused_four_bytes = <span class="hljs-number"><span class="hljs-number">0</span></span>; uint32_t was_killed; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!forkserver_is_running) { dr_printf(<span class="hljs-string"><span class="hljs-string">"Running forkserver...\n"</span></span>); forkserver_is_running = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { dr_printf(<span class="hljs-string"><span class="hljs-string">"Warning: Attempt to re-run forkserver ignored.\n"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">write</span></span>(TO_FUZZER_FD, &amp;unused_four_bytes, <span class="hljs-number"><span class="hljs-number">4</span></span>) != <span class="hljs-number"><span class="hljs-number">4</span></span>) { dr_printf(<span class="hljs-string"><span class="hljs-string">"Cannot connect to fuzzer.\n"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } fork_fun_t fork_ptr; // Lookup the fork <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">from</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">target</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">application</span></span></span><span class="hljs-function">, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">so</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">both</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DynamoRIO</span></span></span><span class="hljs-function"> // </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">and</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">application</span></span></span><span class="hljs-function">'</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">s</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">copy</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">of</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">libc</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">know</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">about</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fork</span></span></span><span class="hljs-function"> // </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Currently</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">causes</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">crashes</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sometimes</span></span></span><span class="hljs-function">, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">in</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">that</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">case</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">use</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">the</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">private</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">libc</span></span></span><span class="hljs-function">'</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">s</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fork</span></span></span><span class="hljs-function">. </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">if</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(!opt_private_fork.get_value()</span></span></span></span>) { module_data_t *module = dr_lookup_module_by_name(<span class="hljs-string"><span class="hljs-string">"libc.so.6"</span></span>); EXIT_IF_FAILED(module != NULL, <span class="hljs-string"><span class="hljs-string">"Cannot lookup libc.\n"</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>) fork_ptr = (fork_fun_t)dr_get_proc_address(module-&gt;handle, <span class="hljs-string"><span class="hljs-string">"fork"</span></span>); EXIT_IF_FAILED(fork_ptr != NULL, <span class="hljs-string"><span class="hljs-string">"Cannot get fork function from libc.\n"</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>) dr_free_module_data(module); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { fork_ptr = fork; } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-literal"><span class="hljs-literal">true</span></span>) { EXIT_IF_FAILED(<span class="hljs-built_in"><span class="hljs-built_in">read</span></span>(FROM_FUZZER_FD, &amp;was_killed, <span class="hljs-number"><span class="hljs-number">4</span></span>) == <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-string"><span class="hljs-string">"Incorrect spawn command from fuzzer.\n"</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>) int child_pid = fork_ptr(); EXIT_IF_FAILED(child_pid &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">"Cannot fork.\n"</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (child_pid == <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-built_in"><span class="hljs-built_in">close</span></span>(TO_FUZZER_FD); <span class="hljs-built_in"><span class="hljs-built_in">close</span></span>(FROM_FUZZER_FD); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { int <span class="hljs-built_in"><span class="hljs-built_in">status</span></span>; EXIT_IF_FAILED(<span class="hljs-built_in"><span class="hljs-built_in">write</span></span>(TO_FUZZER_FD, &amp;child_pid, <span class="hljs-number"><span class="hljs-number">4</span></span>) == <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-string"><span class="hljs-string">"Cannot write child PID.\n"</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>) EXIT_IF_FAILED(waitpid(child_pid, &amp;<span class="hljs-built_in"><span class="hljs-built_in">status</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>) &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">"Wait for child failed.\n"</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>) EXIT_IF_FAILED(<span class="hljs-built_in"><span class="hljs-built_in">write</span></span>(TO_FUZZER_FD, &amp;<span class="hljs-built_in"><span class="hljs-built_in">status</span></span>, <span class="hljs-number"><span class="hljs-number">4</span></span>) == <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-string"><span class="hljs-string">"Cannot write child exit status.\n"</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>) } } } DR_EXPORT void dr_client_main(client_id_t id, int argc, const <span class="hljs-built_in"><span class="hljs-built_in">char</span></span> *argv[]) { parse_options(argc, argv); EXIT_IF_FAILED( dr_annotation_register_call(<span class="hljs-string"><span class="hljs-string">"run_forkserver"</span></span>, (void *)start_forkserver, <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, DR_ANNOTATION_CALL_TYPE_FASTCALL), <span class="hljs-string"><span class="hljs-string">"Cannot register forkserver annotation.\n"</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>); }</code> </pre> </div></div><br><h1 id="sobiraem-ryobernoe-pokrytie">    </h1><br><p>  , ,        .     ,    ,     AFL,    .  ,   <code>afl-gcc</code>   <code>afl-as.c</code> ,            <code>afl-as.h</code> .   AFL ,  ,  ,     <a href="http://lcamtuf.coredump.cx/afl/technical_details.txt">technical details</a> .  ,        </p><br><pre> <code class="hljs ruby">cur_location = &lt;COMPILE_TIME_RANDOM&gt;; shared_mem[cur_location ^ prev_location]++; prev_location = cur_location <span class="hljs-meta"><span class="hljs-meta">&gt;&gt; </span></span><span class="hljs-number"><span class="hljs-number">1</span></span>;</code> </pre> <br><p> (     AFL).     ,           ,        ,       1 ‚Äî     <em></em> .             64-   shared memory,            <code>llvm_mode/afl-llvm-rt.oc</code> . </p><br><p>  ,       DynamoRIO,    <a href="http://dynamorio.org/docs/API_tutorial_bbdynsize1.html"> </a> .   ,      (      , ,  /  ) DynamoRIO   .          ,          <code>dr_register_bb_event</code> . ,    ,        thread-local ,      ,                   . , -,       ,        : </p><br><pre> <code class="hljs sql">//  dr_client_main: <span class="hljs-keyword"><span class="hljs-keyword">lock</span></span> = dr_mutex_create(); dr_register_thread_init_event(event_thread_init); dr_register_thread_exit_event(event_thread_exit); dr_register_bb_event(event_basic_block); dr_register_exit_event(event_exit);</code> </pre> <br><p>       : </p><br><pre> <code class="hljs cpp"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint64_t</span></span> scratch; <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> <span class="hljs-built_in"><span class="hljs-built_in">map</span></span>[MAP_SIZE]; } thread_data; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">event_thread_init</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *drcontext)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> *data = dr_thread_alloc(drcontext, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(thread_data)); <span class="hljs-built_in"><span class="hljs-built_in">memset</span></span>(data, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(thread_data)); dr_set_tls_field(drcontext, data); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">event_thread_exit</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *drcontext)</span></span></span><span class="hljs-function"> </span></span>{ thread_data *data = (thread_data *) dr_get_tls_field(drcontext); dr_mutex_lock(lock); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; MAP_SIZE; ++i) { shmem[i] += data-&gt;<span class="hljs-built_in"><span class="hljs-built_in">map</span></span>[i]; } dr_mutex_unlock(lock); dr_thread_free(drcontext, data, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(thread_data)); }</code> </pre> <br><p> ‚Ä¶        .        , -,  ,  DynamoRIO       ,    ,      thread-specific memory pool. -,     ---  <code>thread_data</code> ,      tls field. </p><br><p>  ,     :  <code>event_basic_block(void *drcontext, void *tag, instrlist_t *bb, bool for_trace, bool translating)</code> ,      .    ,           ‚Äî           <code>instrlist_t *bb</code> .       (   )    , , ,        amd64 aka x86_64.      DynamoRIO  ,     <a href="http://dynamorio.org/docs/dr__events_8h.html"><code>dr_register_bb_event</code></a>   . ,     basic block: </p><br><blockquote> DR constructs dynamic basic blocks, which are distinct from a compiler's classic basic blocks. DR does not know all entry points ahead of time, and will end up duplicating the tail of a basic block if a later entry point is discovered that targets the middle of a block created earlier, or if a later entry point targets straight-line code that falls through into code already present in a block. </blockquote><p> ,        ,      ‚Äî      ! </p><br><p>        .      ,   ,       : </p><br><pre> <code class="hljs pgsql">static dr_emit_flags_t event_basic_block(<span class="hljs-type"><span class="hljs-type">void</span></span> *drcontext, <span class="hljs-type"><span class="hljs-type">void</span></span> *tag, instrlist_t *bb, <span class="hljs-type"><span class="hljs-type">bool</span></span> for_trace, <span class="hljs-type"><span class="hljs-type">bool</span></span> translating) { instr_t *<span class="hljs-keyword"><span class="hljs-keyword">where</span></span> = instrlist_first(bb); reg_id_t tls_reg = DR_REG_XDI, offset_reg = DR_REG_XDX; dr_save_arith_flags(drcontext, bb, <span class="hljs-keyword"><span class="hljs-keyword">where</span></span>, SPILL_SLOT_1); dr_save_reg(drcontext, bb, <span class="hljs-keyword"><span class="hljs-keyword">where</span></span>, tls_reg, SPILL_SLOT_2); dr_save_reg(drcontext, bb, <span class="hljs-keyword"><span class="hljs-keyword">where</span></span>, offset_reg, SPILL_SLOT_3); dr_insert_read_tls_field(drcontext, bb, <span class="hljs-keyword"><span class="hljs-keyword">where</span></span>, tls_reg); //     dr_restore_reg(drcontext, bb, <span class="hljs-keyword"><span class="hljs-keyword">where</span></span>, offset_reg, SPILL_SLOT_3); dr_restore_reg(drcontext, bb, <span class="hljs-keyword"><span class="hljs-keyword">where</span></span>, tls_reg, SPILL_SLOT_2); dr_restore_arith_flags(drcontext, bb, <span class="hljs-keyword"><span class="hljs-keyword">where</span></span>, SPILL_SLOT_1); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> DR_EMIT_DEFAULT; }</code> </pre> <br><p>  <code>tls_reg</code>         <strong></strong>     .         COMPILE_TIME_RANDOM.       ,   <code>event_basic_block</code>    :     <code>for_trace</code>  <code>translating</code> .   , ,    ,      DynamoRIO   <em></em> .  ,     ,        ,    <code>for_trace = true</code> ,           .     ,      ,     ,      <code>translating = true</code> ‚Äî  , ,      ,   <code>translating = false</code> . ,     <code>DR_EMIT_STORE_TRANSLATIONS</code>  <code>DR_EMIT_DEFAULT</code> ,      ,      . ,         by design,            ,        .          ,   basic block. </p><br><pre> <code class="hljs cpp"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> *app_pc = dr_fragment_app_pc(tag); <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> cur_location = ((<span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span>)(<span class="hljs-keyword"><span class="hljs-keyword">uintptr_t</span></span>)app_pc * (<span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span>)<span class="hljs-number"><span class="hljs-number">33533</span></span>) &amp; <span class="hljs-number"><span class="hljs-number">0xFFFF</span></span>;</code> </pre> <br><p>         ,  ASLR   ,      . , " ",          <code>sysctl -w kernel.randomize_va_space=0</code> . </p><br><p> ,    .     .    API        ,     . .: </p><br><pre> <code class="hljs lisp"> instrlist_meta_preinsert(<span class="hljs-name"><span class="hljs-name">bb</span></span>, where, XINST_CREATE_load(<span class="hljs-name"><span class="hljs-name">drcontext</span></span>, opnd_create_reg(<span class="hljs-name"><span class="hljs-name">offset_reg</span></span>), OPND_CREATE_MEM64(<span class="hljs-name"><span class="hljs-name">tls_reg</span></span>, offsetof(<span class="hljs-name"><span class="hljs-name">thread_data</span></span>, scratch))))<span class="hljs-comment"><span class="hljs-comment">; instrlist_meta_preinsert(bb, where, INSTR_CREATE_xor(drcontext, opnd_create_reg(offset_reg), OPND_CREATE_INT32(cur_location))); instrlist_meta_preinsert(bb, where, XINST_CREATE_store(drcontext, OPND_CREATE_MEM32(tls_reg, offsetof(thread_data, scratch)), OPND_CREATE_INT32(cur_location &gt;&gt; 1))); instrlist_meta_preinsert(bb, where, INSTR_CREATE_inc(drcontext, opnd_create_base_disp(tls_reg, offset_reg, 1, offsetof(thread_data, map), OPSZ_1)));</span></span></code> </pre> <br><p> ,     ,      ,  --     ,    Segmentation fault. ,     <code>XINST_CREATE_load</code>  <code>XINST_CREATE_store</code>  : </p><br><pre> <code class="hljs xml">$ ~/soft/DynamoRIO-Linux-6.2.0-2/bin64/drrun -c libafl-dr.so --private-fork -- ./example-bug Cannot get SHM id from environment. Creating dummy map. Running forkserver... Cannot connect to fuzzer. ^C $ #  load  store $ ~/soft/DynamoRIO-Linux-6.2.0-2/bin64/drrun -c libafl-dr.so --private-fork -- ./example-bug Cannot get SHM id from environment. Creating dummy map. <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Application</span></span></span><span class="hljs-tag"> /</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">path</span></span></span><span class="hljs-tag">/</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">to</span></span></span><span class="hljs-tag">/</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">example-bug</span></span></span><span class="hljs-tag"> (</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">5058</span></span></span><span class="hljs-tag">)</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Tool</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">internal</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">crash</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">at</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">PC</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">0x00005605e72bbeaa.</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Please</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">report</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">this</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">at</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">your</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">tool</span></span></span><span class="hljs-tag">'</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">s</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">issue</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">tracker.</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Program</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">aborted.</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Received</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">SIGSEGV</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">at</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">pc</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">0x00005605e72bbeaa</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">in</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">thread</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">5058</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Base:</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">0x00005605e71c5000</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Registers:eax</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">0x0000000000000001</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ebx</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">0x00007ff6dfa12038</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ecx</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">0x0000000000000048</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">edx</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">0x0000000000000000</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">esi</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">0x0000000000000049</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">edi</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">0x0000000000000005</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">esp</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">0x00007ff6dfa0ebb0</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ebp</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">0x00007ff6dfa0ebc0</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">r8</span></span></span><span class="hljs-tag"> =</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">0x0000000000000003</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">r9</span></span></span><span class="hljs-tag"> =</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">0x0000000000000005</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">r10</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">0x0000000000000000</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">r11</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">0x00005605e72b70ef</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">r12</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">0x0000000000000000</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">r13</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">0x0000000000000000</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">r14</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">0x000000000000000c</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">r15</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">0x00005605e7368c50</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">eflags</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">0x0000000000010202</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">version</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">6.2.0</span></span></span><span class="hljs-tag">, </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">build</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">2</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">-no_dynamic_options</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">-client_lib</span></span></span><span class="hljs-tag"> '/</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">path</span></span></span><span class="hljs-tag">/</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">to</span></span></span><span class="hljs-tag">/</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">libafl-dr.so</span></span></span><span class="hljs-tag">;</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">0</span></span></span><span class="hljs-tag">;"</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">--private-fork</span></span></span><span class="hljs-tag">"' </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">-code_api</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">-stack_size</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">56K</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">-max_elide_jmp</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">0</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">-max_elide_call</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">0</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">-early_inject</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">-emulate_brk</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">-no_inline_ignored_syscalls</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">-native_exec_default_list</span></span></span><span class="hljs-tag"> '' </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">-no_native_exec_managed_code</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">-no_indcall2direct</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">0x00007ff6dfa0ebc0</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">0x0000020803000000</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><p>  What to do?     ,    .       <code>-debug -loglevel 1 -logdir /tmp/dynamorio/</code>             ,     - : </p><br><pre> <code class="hljs pgsql">ERROR: Could <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> find <span class="hljs-keyword"><span class="hljs-keyword">encoding</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>: mov (%rdi)[<span class="hljs-number"><span class="hljs-number">8</span></span>byte] -&gt; %rdx SYSLOG_ERROR: Application /<span class="hljs-type"><span class="hljs-type">path</span></span>/<span class="hljs-keyword"><span class="hljs-keyword">to</span></span>/example-bug (<span class="hljs-number"><span class="hljs-number">5192</span></span>) DynamoRIO <span class="hljs-keyword"><span class="hljs-keyword">usage</span></span> error : instr_encode error: <span class="hljs-keyword"><span class="hljs-keyword">no</span></span> <span class="hljs-keyword"><span class="hljs-keyword">encoding</span></span> <span class="hljs-built_in"><span class="hljs-built_in">found</span></span> (see <span class="hljs-keyword"><span class="hljs-keyword">log</span></span>) SYSLOG_ERROR: <span class="hljs-keyword"><span class="hljs-keyword">Usage</span></span> error: instr_encode error: <span class="hljs-keyword"><span class="hljs-keyword">no</span></span> <span class="hljs-keyword"><span class="hljs-keyword">encoding</span></span> <span class="hljs-built_in"><span class="hljs-built_in">found</span></span> (see <span class="hljs-keyword"><span class="hljs-keyword">log</span></span>) (/dynamorio_package/core/arch/x86/encode.c, <span class="hljs-type"><span class="hljs-type">line</span></span> <span class="hljs-number"><span class="hljs-number">2417</span></span>)</code> </pre> <br><p> ,      :    <strong></strong>  ,   ‚Äî <strong>  </strong> . </p><br><p>  ,  ,  : </p><br><pre> <code class="hljs kotlin">$ $AFL_PATH/afl-fuzz -i input -o output -m <span class="hljs-number"><span class="hljs-number">2048</span></span> -- ~/soft/DynamoRIO-Linux-<span class="hljs-number"><span class="hljs-number">6.2</span></span>.0-<span class="hljs-number"><span class="hljs-number">2</span></span>/bin64/drrun -c libafl-dr.so -- ./example-bug afl-fuzz <span class="hljs-number"><span class="hljs-number">2.42</span></span>b <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> &lt;<span class="hljs-symbol"><span class="hljs-symbol">lcamtuf@</span></span>google.com&gt; [+] You have <span class="hljs-number"><span class="hljs-number">4</span></span> CPU cores and <span class="hljs-number"><span class="hljs-number">1</span></span> runnable tasks (utilization: <span class="hljs-number"><span class="hljs-number">25</span></span>%). [+] Try parallel jobs - see docs/parallel_fuzzing.txt. [*] Checking CPU core loadout... [+] Found a free CPU core, binding to #<span class="hljs-number"><span class="hljs-number">0</span></span>. [*] Checking core_pattern... [*] Checking CPU scaling governor... [*] Setting up output directories... [+] Output directory exists but deemed OK to reuse. [*] Deleting old session <span class="hljs-keyword"><span class="hljs-keyword">data</span></span>... [+] Output dir cleanup successful. [*] Scanning <span class="hljs-string"><span class="hljs-string">'input'</span></span>... [+] No auto-generated dictionary tokens to reuse. [*] Creating hard links <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> all input files... [*] Validating target binary... [-] Looks like the target binary <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> not instrumented! The fuzzer depends on compile-time instrumentation to isolate interesting test cases <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> mutating the input <span class="hljs-keyword"><span class="hljs-keyword">data</span></span>. For more information, and <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> tips on how to instrument binaries, please see docs/README. When source code <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> not available, you may be able to leverage QEMU mode support. Consult the README <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> tips on how to enable <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>. (It <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> also possible to use afl-fuzz <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> a traditional, <span class="hljs-string"><span class="hljs-string">"dumb"</span></span> fuzzer. For that, you can use the -n option - but <span class="hljs-keyword"><span class="hljs-keyword">expect</span></span> much worse results.) [-] PROGRAM ABORT : No instrumentation detected Location : check_binary(), afl-fuzz.c:<span class="hljs-number"><span class="hljs-number">6894</span></span></code> </pre> <br><p> ‚Ä¶     ‚Ä¶    ?      :     <code>strace</code>   ,   ,  <code>drrun</code>   .      ,  <code>afl-fuzz</code>   ,    ? ,    ,  AFL ‚Äî    ?  ,   , ,  ,  <code>afl-fuzz.c:6894</code> ,  : </p><br><pre> <code class="hljs erlang-repl">f_data = mmap(<span class="hljs-number"><span class="hljs-number">0</span></span>, f_len, PROT_READ, MAP_PRIVATE, fd, <span class="hljs-number"><span class="hljs-number">0</span></span>); // ... if (!qemu_mode &amp;&amp; !dumb_mode &amp;&amp; !memmem(f_data, f_len, SHM_ENV_VAR, strlen(SHM_ENV_VAR) + <span class="hljs-number"><span class="hljs-number">1</span></span>)) { // ... FATAL(<span class="hljs-string"><span class="hljs-string">"No instrumentation detected"</span></span>); }</code> </pre> <br><p> -,  : AFL     <code>__AFL_SHM_ID</code> ‚Äî   ,        . -  , <del> <code>echo -ne "__AFL_SHM_ID\0" &gt;&gt; /path/to/drrun</code> </del> , ,    :      ,  ,       <code>AFL_SKIP_BIN_CHECK</code>   : </p><br><pre> <code class="hljs lua">$ #  -d      $ AFL_SKIP_BIN_CHECK=<span class="hljs-number"><span class="hljs-number">1</span></span> $AFL_PATH/afl-fuzz -i <span class="hljs-built_in"><span class="hljs-built_in">input</span></span> -o <span class="hljs-built_in"><span class="hljs-built_in">output</span></span> -m <span class="hljs-number"><span class="hljs-number">2048</span></span> -d <span class="hljs-comment"><span class="hljs-comment">-- ~/soft/DynamoRIO-Linux-6.2.0-2/bin64/drrun -c libafl-dr.so -- ./example-bug</span></span></code> </pre> <br><div style="text-align:center;"><img title="AFL     " src="https://habrastorage.org/web/3c3/105/f7e/3c3105f7ea3d4f83b11e2d72ab0f317c.png"></div><br><p> , AFL   ,   , , <code>total paths: 12</code> ,     4-5.   ,  ,   <del>  </del> libc.          <code>example-bug</code> ,   ,     (,  DynamoRIO, ).     ‚Ä¶      </p><br><h1 id="optimizacii">  </h1><br><p> ‚Ä¶    ,      . ,        ,    "  ".        <code>module_data_t *</code> ,  <code>dr_client_main</code>       ,   <code>event_basic_block</code>    ,   " ": </p><br><pre> <code class="hljs ruby">module_data_t *main_module; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>  <span class="hljs-symbol"><span class="hljs-symbol">dr_client_main:</span></span> main_module = dr_get_main_module(); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>  <span class="hljs-symbol"><span class="hljs-symbol">event_basic_block:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!opt_instrument_everything.get_value() &amp;&amp; !dr_module_contains_addr(main_module, pc)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> DR_EMIT_DEFAULT; }</code> </pre> <br><p>         80    (  2 ),   <code>output/queue</code>  <code>test</code>       <code>NU</code> ‚Äî ,     . </p><br><p> ,  DynamoRIO   <code>-thread_private</code> ,            .      tls field   , ,        ,     immediate-: </p><br><pre> <code class="hljs swift"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (dr_using_all_private_caches()) { instrlist_meta_preinsert(bb, <span class="hljs-keyword"><span class="hljs-keyword">where</span></span>, <span class="hljs-type"><span class="hljs-type">INSTR_CREATE_mov_imm</span></span>(drcontext, opnd_create_reg(tls_reg), <span class="hljs-type"><span class="hljs-type">OPND_CREATE_INTPTR</span></span>(dr_get_tls_field(drcontext)))); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { dr_insert_read_tls_field(drcontext, bb, <span class="hljs-keyword"><span class="hljs-keyword">where</span></span>, tls_reg); }</code> </pre> <br><p>    <code>-thread_private</code> (      <code>-c libafl-dr.so</code> ,     DynamoRIO,    ),     5    . ,    <code>if (0 &amp;&amp; dr_using_all_private_caches())</code> ,    ‚Äî , DynamoRIO      .  :) </p><br><p>  ,        : <code>-disable_traces</code> ‚Äî    , , ,       , ,    ,        . ‚Ä¶     10-15   . , ,     , , ,       test case-. </p><br><p>  ,      ,  ""     forkserver-:   <code>example-bug.c</code>  </p><br><pre> <code class="hljs cpp">ungetc(<span class="hljs-string"><span class="hljs-string">'1'</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">stdin</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> ch; <span class="hljs-built_in"><span class="hljs-built_in">fscanf</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">stdin</span></span>, <span class="hljs-string"><span class="hljs-string">"%c"</span></span>, &amp;ch); RUN_FORKSERVER();</code> </pre> <br><p> ‚Ä¶     15   . ,    ,    : ,     -    libc  <em></em>  forkserver,  ,    -   . </p><br><p>    .         : </p><br><ul><li>       ,      <code>afl-as</code> </li><li>         (    ,  , ) </li><li>       QEMU    forkserver    ,                  (, ,      DynamoRIO. <em>,     :     feature request,    issues,        <a href="https://github.com/DynamoRIO/dynamorio/pull/2505"></a> ...</em> ) </li></ul><br><p> ‚Ä¶      .  , <em> </em> :     "     API /     ?" , ", ,       !" ‚Äî  ,          . , ,  ,   ,     ‚Äî    ,     . </p><br><p>  References: </p><br><ul><li> <a href="https://github.com/atrosinenko/afl-dr">   Github</a> . </li><li> <a href="https://github.com/ivanfratric/winafl">WinAFL</a> ‚Äî      DynamoRIO ( Windows). </li><li>         : <a href="https://www.reddit.com/r/netsec/comments/30dux0/american_fuzzy_lop_dyninst_afl_fuzzing_blackbox/"></a> , <a href="https://groups.google.com/forum/"></a> . </li><li> <a href="https://habrahabr.ru/company/dsec/blog/142575/">Dynamic Binary Instrumentation  </a> ‚Äî  2012      , PIN </li></ul><br><p> <strong>UPD:</strong> <a href="https://github.com/atrosinenko/afl-dr/commit/6c7598547c10b840facfdf7eff3437f5433a606c"></a>      ,     (    <code>qemu_mode</code> ).   API    ,            5.  , ,    . </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/332076/">https://habr.com/ru/post/332076/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../332066/index.html">Probabilistic and informational analysis of measurement results in Python</a></li>
<li><a href="../332068/index.html">Automation blocking Petya / NonPetya</a></li>
<li><a href="../332070/index.html">We answer readers' questions: what is the IBM Watson cognitive system, and how does it work?</a></li>
<li><a href="../332072/index.html">‚ÄúYou, thunderstorm, threaten, and we hold on to each other!‚Äù - tale about how I saved the ADSL modem</a></li>
<li><a href="../332074/index.html">Autoencoders in Keras, Part 6: VAE + GAN</a></li>
<li><a href="../332078/index.html">Classifying Text with Java Neural Network</a></li>
<li><a href="../332080/index.html">Hackers and exchanges: how to attack the sphere of finance</a></li>
<li><a href="../332082/index.html">Integration of 1C with DLL using Python</a></li>
<li><a href="../332084/index.html">Work with heterogeneous containers with C ++ 17</a></li>
<li><a href="../332086/index.html">Automatic application deployment with Maven and Wildfly</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>