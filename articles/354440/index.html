<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Black Friday 2017 through the eyes of IT and developers. As we stood black Friday with a 10 times increase in traffic</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Every year Black Friday becomes a new challenge for e-commerce solutions. Customers get the opportunity to buy products at attractive prices, and IT s...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Black Friday 2017 through the eyes of IT and developers. As we stood black Friday with a 10 times increase in traffic</h1><div class="post__text post__text-html js-mediator-article">  Every year Black Friday becomes a new challenge for e-commerce solutions.  Customers get the opportunity to buy products at attractive prices, and IT specialists receive a flurry of requests to servers, exorbitant loads on all resources and unavailability of external services (such as payment systems, ERP, etc.). <br><br><img src="https://habrastorage.org/webt/bl/yt/38/blyt38fl9nts498bccjyaztnszg.jpeg"><br><br>  As we already <a href="https://habrahabr.ru/company/virtocommerce/blog/353696/">wrote earlier</a> , we work with large online stores in different countries, so we often face high loads.  In this article, we will describe how Black Friday 2017 went on one of the client projects implemented on <a href="https://habrahabr.ru/company/virtocommerce/blog/353696/">the VirtoCommerce platform</a> and deployed in the Azure Cloud and how we were able to withstand a 10 times increase in traffic. <br><a name="habracut"></a><br>  The initial configuration was built according to customer requirements without a CDN.  On the one hand, it was necessary to keep within a strict budget, on the other hand, to lay down the possibility of scaling and changing the configuration in real time. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Products looked like this: <br><br><img src="https://habrastorage.org/webt/ld/aq/t1/ldaqt1mgtgnhw8xutgqqeufcjdg.png"><br><br><ul><li>  App Service for the <b>front end of the</b> application - working on the <a href="https://github.com/VirtoCommerce/vc-storefront-core">VirtoCommerce Storefront for ASP.NET Core 2.0</a> , it has three independent stores for the Scandinavian countries: each under its own domain, with its own theme, in its own language and its own currency.  The application interacts with the <b>back end</b> system through RESTful API calls. </li><li>  The App Service for <b>back end</b> - working on the VirtoCommerce <a href="https://github.com/VirtoCommerce/vc-platform">platform</a> , it manages a single catalog, prices, store and orders, and also implements a RESTful API for accessing the functions and data of the platform. </li><li>  Logic Apps is designed to integrate with external systems. </li><li>  To monitor the performance of the solution, Application Insights are used. </li></ul><br>  On Black Friday 2017, marketers predicted an increase in traffic by 10 times.  Plus, during the day, it was planned to do email- or SMS-mailing, which should have led to a sharp, peak increase in requests at one point in time. <br><cut></cut><br><h4>  Part 1. Preparation </h4><br>  We analyzed the current system and made the following decisions that we were able to implement using Azure services. <br><br>  In order to prepare for Black Friday, we have identified 4 points: <br><br><ul><li>  Activate CDN for static resources (JavaScript and CSS). </li><li>  Activate CDN for product images. </li><li>  Increase computing resources at the time of the action. </li><li>  Configure rules for automatic Scale Out in Azure. </li></ul><br>  Thus, the scheme should look like this: <br><br><img src="https://habrastorage.org/webt/xi/3-/pe/xi3-pebm-um2bljvdqsdomwuqvs.png"><br><br><h4>  Activate CDN for static resources (JavaScript and CSS) </h4><br>  By default, all resources (JavaScript and CSS files) are loaded directly from the <b>front end of the</b> application. <br><br>  Azure Content Delivery Network (CDN) allows you to cache static web content at strategically located points.  This allows for maximum throughput for delivering content to users.  CDN also reduces the load on the web application server. <br><br>  In order to connect a CDN for caching static resources, you must: <br><br><ol><li>  Add code to form CDN links in the StaticAssetUrl method. </li><li>  Create a CDN for App Service <a href="https://docs.microsoft.com/en-us/azure/app-service/app-service-web-tutorial-content-delivery-network">docs.microsoft.com/en-us/azure/app-service/app-service-web-tutorial-content-delivery-network</a> . </li><li>  Configure CDN Url in application config. </li></ol><br>  After that, all the resources that are addressed in the <b>themes / assets / static / folder</b> path will be downloaded from the CDN. <br><br>  Previously, we performed a series of benchmark tests for different regions, which showed the effectiveness of the CDN. <br><br>  For example, for a static vendor.js file with a size of 714 KB, the following results were obtained: <b>216ms Vs 705ms</b> .  A good increase in speed. <br><br>  Before 705 ms <br><br><img src="https://habrastorage.org/webt/ip/5g/js/ip5gjsr_jltaffbwilbgicdc4wq.png"><br><br>  After 216 ms <br><br><img src="https://habrastorage.org/webt/uo/lo/6n/uolo6n1sxn6s5-ibgsxltkdhvg4.png"><br><br><h4>  Activate CDN for product images </h4><br>  In client solutions, we recommend using the Azure Blob service as primary storage for binary files or product images. <br><br>  Out of the box, a CDN can be connected to Azure Blob Storage for content caching.  The partner services with which Microsoft collaborates within Azure CDN offer developers a global solution for delivering large volumes of content.  This solution allows caching of blobs and static content of computational instances on physical nodes in the USA, Europe, Asia, Australia and South America. <br>  In order to create a new CDN for product images, you need to: <br><br><ol><li>  Install the <a href="https://habrahabr.ru/company/virtocommerce/blog/353696/">platform Virto Commerce</a> version v2.13.18 and higher.  Plus use AzureBlobProvider. </li><li>  Create an Azure CDN for Blob storage <a href="https://docs.microsoft.com/en-us/azure/cdn/cdn-create-a-storage-account-with-cdn">docs.microsoft.com/en-us/azure/cdn/cdn-create-a-storage-account-with-cdn</a> . </li><li>  Set cdnUrl attribute in AssetsConnectionString.  For example: provider = AzureBlobStorage; rootPath = assets; DefaultEndpointsProtocol = https; AccountName = {AccountName}; AccountKey = {AccountKey}; cdnUrl = abc.azureedge.net </li></ol><br>  We compared the work before and after.  For example, a jpeg file with a size of 82 KB size, we received in 126 ms, instead of 259 ms. <br><br>  Before 259 ms <br><br><img src="https://habrastorage.org/webt/tr/xq/7r/trxq7r4lgrlgyduf_sbpnqtaeak.png"><br><br>  After 126 ms <br><br><img src="https://habrastorage.org/webt/et/xz/da/etxzdasw7wup-8hiazuqvcjenjy.png"><br><br><h4>  Make Scale Up for the duration of the promotion. </h4><br>  By default, we use the Azure S2: Medium computational resources for App Services, but if we need to use large CPU or memory resources, we were ready to increase the plan to S3: Large. <br><br><img src="https://habrastorage.org/webt/ii/1t/zg/ii1tzggxttma4l3mcary4louuew.png"><br><br>  The tests conducted in Azure showed that the change in the amount of computing resources in the direction of increasing occurs on average within 2-5 minutes and without down-time. <br><br><h4>  Configure Automatic Scale Out Rules </h4><br>  Scale Out allows you to configure the number of environments in which the application runs.  In the basic setting, we have set up rules for automatically increasing / decreasing the number of roles from 2 to 5, depending on the metrics. <br><br>  With the usual work of the application, this can significantly save IT administrator time and budget. <br><br><img src="https://habrastorage.org/webt/6m/vj/id/6mvjidh233coerzodutmufcm0k0.png"><br><br>  For ourselves, we have chosen the following settings: <br><br><ul><li>  Increase instance count by 1 if CPUPercantage&gt; 80 or MemoryPercentage&gt; 90 over last 10 minutes. </li><li>  Decrease instance count by 1 if CPUPercantage &lt;70 and MemoryPercentage &lt;70 over last 10 minutes. </li></ul><br>  Unfortunately, it turned out that with peak loads, the automatic rules are too slow - they are late and in the end we had to switch to manual control.  In normal times, the automatic Scale Out works perfectly. <br><br><h3>  Part 2. Black Friday </h3><br>  Morning has come.  In the browser, developers and system administrators open Live Stream metrics.  Activated promotions and passed the first email-list.  In Live Stream, we see an increase in the number of requests.  More resources are required, but automatic rules do not have time to react to these changes. <br><br><img src="https://habrastorage.org/webt/ra/wv/wy/rawvwyi7pbtb6dvwsb6aalvn9i4.png"><br><br>  We see an increase in Response Time.  A new instance rises and the situation stabilizes. <br>  A wave of distribution passes and resources are automatically reduced.  The next wave - the picture repeats.  We decide to switch to manual control of the amount of the instance in order to leave resources with a margin. <br><br>  Customers note that the site works much faster, despite the load. <br><br>  Here is the distribution of the number of requests from the duration: <br><br><img src="https://habrastorage.org/webt/mo/pf/ev/mopfevms3alroppss_mazsnf1qc.png"><br><br>  Black Friday morning from 7:40 to 9:40.  Step 2 minutes. <br><br><img src="https://habrastorage.org/webt/xt/xx/9g/xtxx9grkf1sh67ycu4kh7vt4pmg.png"><br><br>  And this is the usual Friday: <br><br><img src="https://habrastorage.org/webt/cg/lh/e1/cglhe1slosfplz_qxdbnrekbxny.png"><br><br>  An increase in the number of orders led to an increase in the load on the database to critical parameters.  We usually assume that the operating parameter is 40% -50% DTU percentage. <br><br>  On Black Friday, the load increased to 70-80%.  It was decided to raise the resources to 100 DTU.  Changes to the plan on the fly also passed within 2-3 minutes and without down-time, which could not but rejoice.  This resolved potential stock issues.  Further more requests, more traffic.  More orders.  And so it is until one in the morning on Saturdays.  Then they all went to sleep. <br><br><img src="https://habrastorage.org/webt/q8/nb/b6/q8nbb6hsrh_0rdvuaa8xynt98kg.png"><br><br><h3>  Part 3. Retrospective </h3><br>  We stood black Friday! <br><br>  The site pleased customers with discounts, speed and 100% availability.  The customers of the store, in turn, pleased the owners of the service with a number of orders. <br><br>  Yes, the cost of IT resources for this day increased by 3 times, but the revenue for that day grew 100 times compared with the usual day.  The main costs were associated with an increase in the number of copies of applications and raising the database plan, after the end of black Friday, we returned to previous plans. <br><br>  As the calculations showed, the CDN connection increased the cost of IT resources by only ~ $ 2 / day, so the client decided to leave this configuration on an ongoing basis. <br><br>  According to our estimates, the transfer of static resources to CDN has improved the following indicators: <br><br><ul><li>  Reduced average response time by 400ms. </li><li>  Reduced Page View Load time by 1.5 seconds. </li></ul><br><h3>  What's next? </h3><br><ul><li>  We will hide all our sites behind the CDN in order to remove the re-rendering of the home page, category pages and product cards.  In our project we can do this, because the current prices, discounts for the client, shopping cart, etc.  are loaded through javascript. </li><li>  We will activate API Management between the <b>front end</b> and <b>back end</b> systems. </li><li> Add caching to improve performance in Azure API Management <a href="https://docs.microsoft.com/en-us/azure/api-management/api-management-howto-cache">docs.microsoft.com/en-us/azure/api-management/api-management-howto-cache</a> . </li><li>  Let's place App Services on several geolocations. </li></ul><br>  Well, we will prepare for the new black Friday 2018! </div><p>Source: <a href="https://habr.com/ru/post/354440/">https://habr.com/ru/post/354440/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../354426/index.html">Mother's son's style of girlfriend</a></li>
<li><a href="../354430/index.html">Creating a signature on the template in Outlook for the organization, on computers outside the domain</a></li>
<li><a href="../354432/index.html">These incredibly valuable skills will help you become more successful.</a></li>
<li><a href="../354434/index.html">Pandora's White Box</a></li>
<li><a href="../354438/index.html">How JS Works: Animation with CSS and JavaScript</a></li>
<li><a href="../354442/index.html">What is hidden inside the online cash registers: the development of a fiscal registrar</a></li>
<li><a href="../354444/index.html">Revelations emergency engineer</a></li>
<li><a href="../354448/index.html">More than a state: US foreign debt</a></li>
<li><a href="../354450/index.html">CocoaHeads April 13, 2018 from Tutu.ru office: video speeches</a></li>
<li><a href="../354452/index.html">Symbolic vulnerability: how a simple message leads to errors in the phone</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>