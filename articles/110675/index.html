<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>CouchApp: JavaScript applications in CouchDB</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Once upon a time, when I practiced writing stored procedures, triggers, cursors under MSSQL, I was not bothered by the thought of an application where...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>CouchApp: JavaScript applications in CouchDB</h1><div class="post__text post__text-html js-mediator-article"> Once upon a time, when I practiced writing stored procedures, triggers, cursors under MSSQL, I was not bothered by the thought of an application where all business logic runs at the database level, and the presentation tier simply pulls the base and is responsible for drawing the results.  A lot of my developer years have passed since then, but the opportunities for the implementation of this idea never met ... until I came across CouchDB. <br><br>  I think that many have already heard about NoSQL databases, including Couch DB.  Here I want to talk about the great opportunity to embed JavaScript applications in CouchDB, whose name is CouchApp. <br><br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      CouchApp is described on <a href="http://guide.couchdb.org/">the CouchDB book‚Äôs website</a> as a ‚ÄúJavascript and HTML5 application that is sent directly to the browser from CouchDB.‚Äù  I think that such a definition is not entirely accurate, since in this case HTML is sent to the browser, and the HTML that runs on the server decides which HTML to render.  The scheme from the site illustrates this idea somewhat better: <br> <code><font color="black"><br> Browser (UI and links between pages) <br> -------------- HTTP --------------- <br> CouchDB (persistence, business logic, and templating) <br></font></code> <br>  CouchDB is (or includes) a web server.  It performs its function of delivering results in JSON-format to REST requests, which are the main way of communicating with the database in any operations (from CRUD operations on data to creating and deleting databases themselves).  The data between the server and the client is sent over the HTTP protocol; accordingly, nothing prevents it from sending HTML.  To do this, you just need to tell him about it in the right way. <br><br>  An application in CouchDB starts with a ‚Äúdesign document‚Äù.  Since everything, including data, is called a document in CouchDB and is set in JSON format, the design of the document is no different.  Of course, it should be specifically called and have a certain structure.  The document itself contains the application code. <br><br>  The simplest base document looks like this: <br><blockquote> <code><font color="black"><font color="#009900">{</font> <br> <font color="#3366CC">"_id"</font> <font color="#339933">:</font> <font color="#3366CC">"my_doc"</font> <font color="#339933">,</font> <br> <font color="#3366CC">"_rev"</font> <font color="#339933">:</font> <font color="#3366CC">"1-7a8b01193c8798fa555243b354d1e9d7"</font> <br> <font color="#009900">}</font></font></code> </blockquote> <br>  The design of the document should have _id in the form: <code><font color="black">_design/app_name</font></code> .  The application JavaScript code is spread over the fields of the JSON object defining the design of the document (with appropriate screening).  It also indicates other application attributes, such as links to files (attachments), application manifest, etc.  Deploying an application consists of loading the design of the document and file resources (attachments) into the database. <br><br>  In order to be able to work normally on JS code in your favorite editor, not to collect bit by bit from the application design document folders, there is the <a href="https://github.com/couchapp/couchapp">couchapp</a> utility.  It is written in Python and is engaged in collecting application resources into one json document and sending it to the server, attachments are poured separately.  It also allows you to generate an initial folder structure for the application, from which it will then collect resources. <br><br>  So, the first thing to start with is to install the couchapp utility.  I will not describe the installation process, it is well written in the <a href="http://www.couchapp.org/page/installing" title="wiki">wiki</a> . <br><br>  Then, to get acquainted with the base, you can either put the base yourself, or you can register <a href="http://www.couchone.com/get">free CouchDB hosting</a> .  The last option I took advantage of.  Everything is fine in it (I will not say anything about the restrictions), except that it is impossible to look at the logs there, and it can be difficult to debug the application accordingly. <br><br>  Now everything is ready to start practicing. <br><br><h4>  Start </h4><br>  I specifically wanted to write something more than ‚ÄúHello world‚Äù and different from the blog that is developed in each tutorial, but at the same time similar to it, to be able to follow the examples in the documentation and not get too carried away with porting code from tutorial in the app.  As practice shows, this allows you to immediately understand the nuances of dealing with a new technology. <br><br>  The application that I will describe is the so-called flash cards.  The principle is simple - in life, on one side of the card a word is written in the target language, on the other - its translation.  In the application, the user, respectively, requires an interface to view the list of card sets (sets), the ability to edit the set, adding and changing words on the cards, and the interface of the card run itself. <br><br>  The document set of cards in the database will be as follows: <br><blockquote> <code><font color="black">{ <br> "_id": "my set", <br> "_rev": "1-7a8b01193c8798fa555243b354d1e9d6", <br> "type": "set", <br> "cards": [ <br> { <br> "front": "front_text", <br> "back": "back_text" <br> }, <br> { <br> "front": "front_text second", <br> "back": "back_text second" <br> } <br> ] <br> }</font></code> </blockquote> <br>  "_id" - a unique set identifier, which is also its name in combination (for simplicity) <br>  "_rev" is the set revision number.  When saving or creating a document, you can omit it, then it will be filled automatically. <br><br>  The fields "_id" and "_rev" are mandatory attributes of any document. <br><br>  ‚ÄúType‚Äù is a type of document.  Since there are no tables in CouchDB and all documents are in the database next to each other, then, for simple differentiation between samples, it is convenient to use a special field. <br>  ‚ÄúCards‚Äù is an array of objects that define cards.  You can store each card separately in a document with the ‚Äúcard‚Äù type, but for a simple application I decided not to do this. <br><br>  Create a page with a form for creating a new or editing an existing set. <br><br><h4>  Editing page </h4><br>  CouchApp has the concept of ‚Äúshow function‚Äù.  This function is responsible for displaying the base document, i.e.  transforms it into another structure, for example, can produce HTML on output. <br><br>  Show functions are stored in the js file and must be located in the shows folder.  The call to the ‚Äúedit‚Äù function will occur when we contact http: //// _ design / flashcards / _show / edit / and http: //// _ design / flashcards / _show / edit / &lt;document_id&gt;. <br><br>  The code of the file \ shows \ edit.js for our page: <br><blockquote> <code><font color="black"><font color="#0000ff">function</font> (doc, req) { <br> <font color="#008000">//!json shows._edit</font> <br> <br> <font color="#0000ff">var</font> Mustache = require( <font color="#A31515">"vendor/couchapp/lib/mustache"</font> ), <br> path = require( <font color="#A31515">"vendor/couchapp/lib/path"</font> ).init(req); <br> <br> <font color="#0000ff">var</font> data = { <br> assets : path.asset(), <br> indexPath : path.list( <font color="#A31515">'sets'</font> , <font color="#A31515">'all-sets'</font> , {descending: <font color="#0000ff">true</font> , limit:10}) <br> }; <br> <br> data.doc = doc || {}; <br> <br> <font color="#0000ff">return</font> Mustache.to_html(shows._edit, data); <br> }</font> <br></code> </blockquote><br>  The show function takes as the parameters the requested document, if it was requested and found, and an object that describes the incoming request.  In the first case, the doc will be absent. <br><br>  Next comes a comment, which is a directive to the couchapp script (called macro) to write the contents of the file \ shows \ _edit. * Into the variable ‚Äúshows._edit‚Äù.  This means that the folder can not contain more than one file named _edit, regardless of the extension.  In our case, there will be a _edit.html file that contains the code of our page with the form.  We return to it later. <br><br>  Next comes the import of two modules.  CouchDB follows the CommonJS convention for developing server-side javascript, so <a href="">import functions</a> may be familiar to Node.js developers.  I did not work with Node.js and could not find any documentation in CouchDB by the available functions.  I had to look into the CouchDB codes and figure out the examples. <br><br>  The first module is Mustache, it is responsible for rendering everything.  We need it to render the html page with the data that we will prepare for it.  The second one is path, which allows us to generate links to other pages of our application and resources, such as js scripts for working with the database (some are generated by couchapp during initialization of the project, and some are already available on the web server of the database). <br><br>  Next, a model object is created (from the MVC pattern).  The assets field is the url prefix of the directory where the scripts are laid out, indexPath is the URL of the page with the list of our sets.  The list of documents is displayed by list-functions, which will be discussed later.  The .list method will return a reference to the sets function, to which, in turn, the result of the all-sets view function will be passed. <br><br>  Below is the addition to the model of the document itself, i.e.  set of cards.  As I already wrote, we can access the edit function either with the document id or without it.  If the document is found, it will be in the doc parameter.  If it was not found, then we create an empty object for the set.  Thus, when the set edit page opens, we edit either the new set or the existing set. <br><br>  Part of the html-code of the page responsible for drawing the set: <br><blockquote> <code><font color="black"><font color="#0000ff">&lt; <font color="#800000"><b>form</b></font> <font color="#ff0000">id</font> <font color="#0000ff">=</font> <font color="#0000ff">"new-post"</font> <font color="#ff0000">method</font> <font color="#0000ff">=</font> <font color="#0000ff">"post"</font> &gt;</font> <br> {{#doc}} <br> <font color="#0000ff">&lt; <font color="#800000"><b>label</b></font> &gt;</font> Set name <font color="#0000ff">&lt; <font color="#0000ff">/</font> <font color="#800000"><b>label</b></font> &gt;</font> <font color="#0000ff">&lt; <font color="#800000"><b>input</b></font> <font color="#ff0000">type</font> <font color="#0000ff">=</font> <font color="#0000ff">"text"</font> <font color="#ff0000">size</font> <font color="#0000ff">=</font> <font color="#0000ff">"20"</font> <font color="#ff0000">name</font> <font color="#0000ff">=</font> <font color="#0000ff">"_id"</font> <font color="#ff0000">value</font> <font color="#0000ff">=</font> <font color="#0000ff">"{{_id}}"</font> &gt;</font> <br> <font color="#0000ff">&lt; <font color="#800000"><b>ul</b></font> <font color="#ff0000">class</font> <font color="#0000ff">=</font> <font color="#0000ff">"cards"</font> &gt;</font> <br> {{#cards}} <br> <font color="#0000ff">&lt; <font color="#800000"><b>li</b></font> &gt;</font> <br> <font color="#0000ff">&lt; <font color="#800000"><b>label</b></font> &gt;</font> Front <font color="#0000ff">&lt; <font color="#0000ff">/</font> <font color="#800000"><b>label</b></font> &gt;</font> <font color="#0000ff">&lt; <font color="#800000"><b>input</b></font> <font color="#ff0000">type</font> <font color="#0000ff">=</font> <font color="#0000ff">"text"</font> <font color="#ff0000">size</font> <font color="#0000ff">=</font> <font color="#0000ff">"20"</font> <font color="#ff0000">name</font> <font color="#0000ff">=</font> <font color="#0000ff">"front"</font> <font color="#ff0000">value</font> <font color="#0000ff">=</font> <font color="#0000ff">"{{front}}"</font> &gt;</font> <br> <font color="#0000ff">&lt; <font color="#800000"><b>label</b></font> &gt;</font> Back <font color="#0000ff">&lt; <font color="#0000ff">/</font> <font color="#800000"><b>label</b></font> &gt;</font> <font color="#0000ff">&lt; <font color="#800000"><b>input</b></font> <font color="#ff0000">type</font> <font color="#0000ff">=</font> <font color="#0000ff">"text"</font> <font color="#ff0000">size</font> <font color="#0000ff">=</font> <font color="#0000ff">"20"</font> <font color="#ff0000">name</font> <font color="#0000ff">=</font> <font color="#0000ff">"back"</font> <font color="#ff0000">value</font> <font color="#0000ff">=</font> <font color="#0000ff">"{{back}}"</font> &gt;</font> <br> <font color="#0000ff">&lt; <font color="#0000ff">/</font> <font color="#800000"><b>li</b></font> &gt;</font> <br> {{/cards}} <br> <br> <font color="#0000ff">&lt; <font color="#800000"><b>li</b></font> &gt;</font> <br> <font color="#0000ff">&lt; <font color="#800000"><b>label</b></font> &gt;</font> Front <font color="#0000ff">&lt; <font color="#0000ff">/</font> <font color="#800000"><b>label</b></font> &gt;</font> <font color="#0000ff">&lt; <font color="#800000"><b>input</b></font> <font color="#ff0000">type</font> <font color="#0000ff">=</font> <font color="#0000ff">"text"</font> <font color="#ff0000">size</font> <font color="#0000ff">=</font> <font color="#0000ff">"20"</font> <font color="#ff0000">name</font> <font color="#0000ff">=</font> <font color="#0000ff">"front"</font> &gt;</font> <br> <font color="#0000ff">&lt; <font color="#800000"><b>label</b></font> &gt;</font> Back <font color="#0000ff">&lt; <font color="#0000ff">/</font> <font color="#800000"><b>label</b></font> &gt;</font> <font color="#0000ff">&lt; <font color="#800000"><b>input</b></font> <font color="#ff0000">type</font> <font color="#0000ff">=</font> <font color="#0000ff">"text"</font> <font color="#ff0000">size</font> <font color="#0000ff">=</font> <font color="#0000ff">"20"</font> <font color="#ff0000">name</font> <font color="#0000ff">=</font> <font color="#0000ff">"back"</font> &gt;</font> <br> <font color="#0000ff">&lt; <font color="#0000ff">/</font> <font color="#800000"><b>li</b></font> &gt;</font> <br> <font color="#0000ff">&lt; <font color="#0000ff">/</font> <font color="#800000"><b>ul</b></font> &gt;</font> <br> <br> <font color="#0000ff">&lt; <font color="#800000"><b>button</b></font> <font color="#ff0000">id</font> <font color="#0000ff">=</font> <font color="#0000ff">"add"</font> &gt;</font> Add <font color="#0000ff">&lt; <font color="#0000ff">/</font> <font color="#800000"><b>button</b></font> &gt;&lt; <font color="#800000"><b>br</b></font> <font color="#0000ff">/</font> &gt;&lt; <font color="#800000"><b>br</b></font> <font color="#0000ff">/</font> &gt;</font> <br> {{/doc}} <br> <br> <font color="#0000ff">&lt; <font color="#800000"><b>input</b></font> <font color="#ff0000">type</font> <font color="#0000ff">=</font> <font color="#0000ff">"submit"</font> <font color="#ff0000">value</font> <font color="#0000ff">=</font> <font color="#0000ff">"Save &amp;rarr;"</font> <font color="#0000ff">/</font> &gt;</font> <br> <font color="#0000ff">&lt; <font color="#800000"><b>span</b></font> <font color="#ff0000">id</font> <font color="#0000ff">=</font> <font color="#0000ff">"saved"</font> <font color="#ff0000">style</font> <font color="#0000ff">=</font> <font color="#0000ff">"display:none;"</font> &gt;</font> Saved <font color="#0000ff">&lt; <font color="#0000ff">/</font> <font color="#800000"><b>span</b></font> &gt;</font> <br> <font color="#0000ff">&lt; <font color="#800000"><b>br</b></font> <font color="#0000ff">/</font> &gt;&lt; <font color="#800000"><b>br</b></font> <font color="#0000ff">/</font> &gt;</font> <br> <font color="#0000ff">&lt; <font color="#0000ff">/</font> <font color="#800000"><b>form</b></font> &gt;</font></font></code> </blockquote> <br>  Nothing special.  All in accordance with the <a href="">mustache</a> . <br><br>  After we showed the form, now we need to write a functional for saving the form.  To do this, you need to send a POST request with a JSON card set document.  To do this, the following scripts are added to the page: /_utils/script/jquery.js and /_utils/script/jquery.couch.js.  The first is jQuery, the second is a jQuery plugin that organizes requests to CouchDB. <br><br>  Now our script: <br><blockquote> <code><font color="black"><font color="#009900">(</font> <font color="#003366"><b>function</b></font> <font color="#009900">(</font> $ <font color="#009900">)</font> <font color="#009900">{</font> <br> $ <font color="#009900">(</font> <font color="#3366CC">'#new-post'</font> <font color="#009900">)</font> . <font color="#660066">submit</font> <font color="#009900">(</font> <font color="#003366"><b>function</b></font> <font color="#009900">(</font> <font color="#009900">)</font> <font color="#009900">{</font> <br> <font color="#003366"><b>var</b></font> self <font color="#339933">=</font> $ <font color="#009900">(</font> <font color="#000066"><b>this</b></font> <font color="#009900">)</font> <font color="#339933">,</font> setName <font color="#339933">=</font> $ <font color="#009900">(</font> <font color="#3366CC">'input[name=_id]'</font> <font color="#339933">,</font> <font color="#000066"><b>this</b></font> <font color="#009900">)</font> . <font color="#660066">val</font> <font color="#009900">(</font> <font color="#009900">)</font> <font color="#339933">,</font> <br> oldSet <font color="#339933">,</font> newSet <font color="#339933">=</font> <font color="#009900">{</font> <font color="#009900">}</font> <font color="#339933">,</font> db <font color="#339933">=</font> $. <font color="#660066">couch</font> . <font color="#660066">db</font> <font color="#009900">(</font> <font color="#3366CC">'flashcards'</font> <font color="#009900">)</font> <font color="#339933">;</font> <br> <br> <font color="#003366"><b>function</b></font> saveDoc <font color="#009900">(</font> set <font color="#009900">)</font> <font color="#009900">{</font> <br> db. <font color="#660066">saveDoc</font> <font color="#009900">(</font> set <font color="#009900">)</font> <font color="#339933">,</font> <font color="#009900">{</font> <br> success <font color="#339933">:</font> <font color="#003366"><b>function</b></font> <font color="#009900">(</font> resp <font color="#009900">)</font> <font color="#009900">{</font> <br> window. <font color="#660066">location</font> . <font color="#660066">reload</font> <font color="#009900">(</font> <font color="#003366"><b>true</b></font> <font color="#009900">)</font> <font color="#339933">;</font> <br> <font color="#009900">}</font> <br> <font color="#009900">}</font> <font color="#009900">)</font> <font color="#339933">;</font> <br> <font color="#009900">}</font> <br> <br> <font color="#006600"><i>//collect cards array</i></font> <br> newSet. <font color="#660066">cards</font> <font color="#339933">=</font> $ <font color="#009900">(</font> <font color="#3366CC">'ul.cards input'</font> <font color="#009900">)</font> . <font color="#660066">toArray</font> <font color="#009900">(</font> <font color="#009900">)</font> . <font color="#660066">reduce</font> <font color="#009900">(</font> <font color="#003366"><b>function</b></font> <font color="#009900">(</font> arr <font color="#339933">,</font> el <font color="#339933">,</font> idx <font color="#009900">)</font> <font color="#009900">{</font> <br> <font color="#000066"><b>if</b></font> <font color="#009900">(</font> <font color="#339933">!</font> <font color="#009900">(</font> idx <font color="#339933">%</font> 2 <font color="#009900">)</font> <font color="#009900">)</font> <font color="#009900">{</font> arr <font color="#009900">[</font> arr. <font color="#660066">length</font> <font color="#009900">]</font> <font color="#339933">=</font> <font color="#009900">{</font> <font color="#009900">}</font> <font color="#339933">;</font> <font color="#009900">}</font> <br> arr <font color="#009900">[</font> arr. <font color="#660066">length</font> <font color="#339933">-</font> <font color="#CC0000">1</font> <font color="#009900">]</font> <font color="#009900">[</font> <font color="#339933">!</font> <font color="#009900">(</font> idx <font color="#339933">%</font> 2 <font color="#009900">)</font> <font color="#339933">?</font> <font color="#3366CC">"front"</font> <font color="#339933">:</font> <font color="#3366CC">"back"</font> <font color="#009900">]</font> <font color="#339933">=</font> el. <font color="#660066">value</font> <font color="#339933">;</font> <br> <br> <font color="#000066"><b>return</b></font> arr <font color="#339933">;</font> <br> <font color="#009900">}</font> <font color="#339933">,</font> <font color="#009900">[</font> <font color="#009900">]</font> <font color="#009900">)</font> <font color="#339933">;</font> <br> <br> <font color="#006600"><i>//retrieve old set if found or create new</i></font> <br> db. <font color="#660066">openDoc</font> <font color="#009900">(</font> setName <font color="#339933">,</font> <font color="#009900">{</font> <br> error <font color="#339933">:</font> <font color="#003366"><b>function</b></font> <font color="#009900">(</font> code <font color="#009900">)</font> <font color="#009900">{</font> <br> oldSet <font color="#339933">=</font> <font color="#009900">{</font> <font color="#009900">}</font> <font color="#339933">;</font> <br> <font color="#000066"><b>if</b></font> <font color="#009900">(</font> setName. <font color="#660066">length</font> <font color="#009900">)</font> <font color="#009900">{</font> <br> oldSet._id <font color="#339933">=</font> setName <font color="#339933">;</font> <br> <font color="#009900">}</font> <br> saveDoc <font color="#009900">(</font> $. <font color="#660066">extend</font> <font color="#009900">(</font> oldSet <font color="#339933">,</font> newSet <font color="#009900">)</font> <font color="#339933">;</font> <br> <br> <font color="#009900">}</font> <font color="#339933">,</font> <br> success <font color="#339933">:</font> <font color="#003366"><b>function</b></font> <font color="#009900">(</font> response <font color="#009900">)</font> <font color="#009900">{</font> <br> oldSet <font color="#339933">=</font> response <font color="#339933">;</font> <br> saveDoc <font color="#009900">(</font> $. <font color="#660066">extend</font> <font color="#009900">(</font> oldSet <font color="#339933">,</font> newSet <font color="#009900">)</font> <font color="#339933">;</font> <br> <font color="#009900">}</font> <br> <font color="#009900">}</font> <font color="#009900">)</font> <font color="#339933">;</font> <br> <br> <font color="#000066"><b>return</b></font> <font color="#003366"><b>false</b></font> <font color="#339933">;</font> <br> <font color="#009900">}</font> <font color="#009900">)</font> <font color="#339933">;</font> <br> <font color="#009900">}</font> <font color="#009900">)</font> <font color="#009900">(</font> jQuery <font color="#009900">)</font> <font color="#339933">;</font></font></code> </blockquote> <br>  The main operations on working with the database here are: <br>  1. <code><font color="black"><font color="#003366"><b>var</b></font> db <font color="#339933">=</font> $. <font color="#660066">couch</font> . <font color="#660066">db</font> <font color="#009900">(</font> <font color="#3366CC">'flashcards'</font> <font color="#009900">)</font></font></code> <code><font color="black"><font color="#003366"><b>var</b></font> db <font color="#339933">=</font> $. <font color="#660066">couch</font> . <font color="#660066">db</font> <font color="#009900">(</font> <font color="#3366CC">'flashcards'</font> <font color="#009900">)</font></font></code>  <code><font color="black"><font color="#003366"><b>var</b></font> db <font color="#339933">=</font> $. <font color="#660066">couch</font> . <font color="#660066">db</font> <font color="#009900">(</font> <font color="#3366CC">'flashcards'</font> <font color="#009900">)</font></font></code> - getting a database object to call save, open methods, etc. <br>  2. <code><font color="black">db. <font color="#660066">openDoc</font> <font color="#009900">(</font> id <font color="#339933">,</font> callback <font color="#009900">)</font></font></code>  <code><font color="black">db. <font color="#660066">openDoc</font> <font color="#009900">(</font> id <font color="#339933">,</font> callback <font color="#009900">)</font></font></code> - gets the document from the database by id.  Used to get the latest version of the document.  You must send the document with the latest revision to the server, otherwise it will be rejected.  CouchDB implements only this principle of sharing shared access to a resource.  If the document is not found, then it is assumed that a new set is being created.  Then it is called to save the entire set object to the base. <br>  3. <code><font color="black">db. <font color="#660066">saveDoc</font> <font color="#009900">(</font> doc <font color="#339933">,</font> callback <font color="#009900">)</font></font></code>  <code><font color="black">db. <font color="#660066">saveDoc</font> <font color="#009900">(</font> doc <font color="#339933">,</font> callback <font color="#009900">)</font></font></code> - save the document to the database.  If everything is successful, then the page is reloaded.  The case when something went wrong, and this can happen if an old revision was sent, I do not consider. <br><br>  Now we have full functionality for creating and editing map sets.  Let us turn to the display of the list of sets. <br><br><h4>  Display Lists </h4><br>  Before displaying the list, you need to make a selection.  Sampling is done using view.  Unlike SQL, where the query can be built dynamically and, then, work on the data in the table, the view works a little differently.  It is not possible to pass any parameters from the HTTP request to the view, but they can be applied to the results obtained from the view. <br><br>  View is a function applied to each document of the database.  It is used to filter documents in order to impose an index on the results of this filtering.  View consists of a map function and an optional reduce.  To display all sets, the function \ views \ all-sets \ map.js (all-sets will be called view) looks like this: <br><blockquote> <code><font color="black"><font color="#003366"><b>function</b></font> <font color="#009900">(</font> doc <font color="#009900">)</font> <font color="#009900">{</font> <br> <font color="#000066"><b>if</b></font> <font color="#009900">(</font> doc. <font color="#660066">type</font> <font color="#339933">===</font> <font color="#3366CC">'set'</font> <font color="#339933">&amp;&amp;</font> doc. <font color="#660066">cards</font> <font color="#009900">)</font> <font color="#009900">{</font> <br> emit <font color="#009900">(</font> doc._id <font color="#339933">,</font> <font color="#003366"><b>null</b></font> <font color="#009900">)</font> <font color="#339933">;</font> <br> <font color="#009900">}</font> <br> <font color="#009900">}</font></font></code> </blockquote> <br>  Here it is checked for compliance of the document with the set type and the presence of an array with cards.  In the case of a match, the emit function is called that takes two arguments, a key and a value.  To display the set list, the value of the second parameter is not important, i.e.  all you need is a key representing the name of the set.  Results are also sorted by it.  According to the obtained set of keys and indexes will be built. <br><br>  You can make queries to view that narrow the selection.  For some queries, a nontrivial key generation scheme is required; for others, the additional function reduce.  I will not focus on this, as the documentation is pretty good written about it. <br><br>  After we have a defined view, we can set the display of its results.  If show functions were used to display documents, then list functions will be needed here.  Function \ lists \ sets.js: <br><blockquote> <code><font color="black"><font color="#003366"><b>function</b></font> <font color="#009900">(</font> head <font color="#339933">,</font> req <font color="#009900">)</font> <font color="#009900">{</font> <br> <font color="#006600"><i>// !json lists._sets</i></font> <br> <br> <font color="#003366"><b>var</b></font> Mustache <font color="#339933">=</font> require <font color="#009900">(</font> <font color="#3366CC">"vendor/couchapp/lib/mustache"</font> <font color="#009900">)</font> <font color="#339933">,</font> <br> path <font color="#339933">=</font> require <font color="#009900">(</font> <font color="#3366CC">"vendor/couchapp/lib/path"</font> <font color="#009900">)</font> . <font color="#660066">init</font> <font color="#009900">(</font> req <font color="#009900">)</font> <font color="#339933">;</font> <br> <br> provides <font color="#009900">(</font> <font color="#3366CC">'html'</font> <font color="#339933">,</font> <font color="#003366"><b>function</b></font> <font color="#009900">(</font> <font color="#009900">)</font> <font color="#009900">{</font> <br> <font color="#003366"><b>var</b></font> data <font color="#339933">=</font> <font color="#009900">{</font> <br> assets <font color="#339933">:</font> path. <font color="#660066">asset</font> <font color="#009900">(</font> <font color="#009900">)</font> <font color="#339933">,</font> <br> createNewLink <font color="#339933">:</font> path. <font color="#660066">show</font> <font color="#009900">(</font> <font color="#3366CC">'edit'</font> <font color="#009900">)</font> <br> <font color="#009900">}</font> <font color="#339933">;</font> <br> <br> data. <font color="#660066">sets</font> <font color="#339933">=</font> <font color="#009900">(</font> <font color="#003366"><b>function</b></font> <font color="#009900">(</font> <font color="#009900">)</font> <font color="#009900">{</font> <br> <font color="#003366"><b>var</b></font> row <font color="#339933">,</font> set <font color="#339933">,</font> arr <font color="#339933">=</font> <font color="#009900">[</font> <font color="#009900">]</font> <font color="#339933">;</font> <br> <font color="#000066"><b>while</b></font> <font color="#009900">(</font> row <font color="#339933">=</font> getRow <font color="#009900">(</font> <font color="#009900">)</font> <font color="#009900">)</font> <font color="#009900">{</font> <br> set <font color="#339933">=</font> row. <font color="#660066">value</font> <font color="#339933">;</font> <br> arr. <font color="#660066">push</font> <font color="#009900">(</font> <font color="#009900">{</font> <br> title <font color="#339933">:</font> row. <font color="#660066">id</font> <font color="#339933">,</font> <br> showView <font color="#339933">:</font> path. <font color="#660066">show</font> <font color="#009900">(</font> <font color="#3366CC">'set'</font> <font color="#339933">,</font> row. <font color="#660066">id</font> <font color="#009900">)</font> <font color="#339933">,</font> <br> editLink <font color="#339933">:</font> path. <font color="#660066">show</font> <font color="#009900">(</font> <font color="#3366CC">'edit'</font> <font color="#339933">,</font> row. <font color="#660066">id</font> <font color="#009900">)</font> <font color="#339933">,</font> <br> runsetLink <font color="#339933">:</font> path. <font color="#660066">asset</font> <font color="#009900">(</font> <font color="#3366CC">'flashcards_zeptojs.html'</font> <font color="#009900">)</font> <font color="#339933">+</font> <font color="#3366CC">'#'</font> <font color="#339933">+</font> row. <font color="#660066">id</font> <br> <font color="#009900">}</font> <font color="#009900">)</font> <font color="#339933">;</font> <br> <font color="#009900">}</font> <br> <font color="#000066"><b>return</b></font> arr <font color="#339933">;</font> <br> <font color="#009900">}</font> <font color="#009900">)</font> <font color="#009900">(</font> <font color="#009900">)</font> <font color="#339933">;</font> <br> <br> <font color="#000066"><b>return</b></font> Mustache. <font color="#660066">to_html</font> <font color="#009900">(</font> lists._sets <font color="#339933">,</font> data <font color="#009900">)</font> <font color="#339933">;</font> <br> <font color="#009900">}</font> <font color="#009900">)</font> <font color="#339933">;</font> <br> <font color="#009900">}</font></font></code> </blockquote> <br>  A distinctive feature of the show-function is that the available function provides (content_type, callback), which calls the callback if the content-type of the request matches and getRow (), which returns the rows from the view.  From which view to display the line is determined by url: http: //// _ design / flashcards / _list / sets / &lt;view-name&gt; ?.  In the head parameter of the function, the view parameters will be written, in req - numerous parameters of the HTTP request.  Otherwise, we do the same as in the show-function - we take a template and pass the resulting model there, and then return the result. <br><br>  Two pages left behind the article with a preview of a set of cards and the interface of the run itself, but they are absolutely trivial and are implemented with the same set of functions described above. <br><br>  This is probably all that I consider necessary to have an understanding about CouchApp.  Then you can safely refer to the documentation and implement something meaningful. <br><br><h4>  Conclusion </h4><br>  What remains in the draft from the experience of studying CouchDB with CouchApp: <br><br>  1. Very leaky documentation. <br>  CouchDB Book, there are even two versions of them - 1.0 and draft, both are in the public domain, reveal in detail the basic concepts of the database itself, but the description of couchApp is very messy and with spaces.  You have to go through different blog entries to get an overall picture of how things work.  I even think that reading the whole book does not guarantee gaining a complete understanding, although it seems to me to read 300 pages to have a high-level understanding.  On the other hand, there are small helloworld articles that only display a sacred inscription, but do not go deeper, which brings very little benefit. <br><br>  The funny thing is the lack of a description of the JavaScript API in CouchApp.  And I didn‚Äôt find a reference on such an API at all on <a href="http://www.couchone.com/">couchone.com</a> , nor on <a href="http://wiki.apache.org/couchdb">wiki.apache.org/couchdb</a> , or on the official site <a href="http://couchapp.org/">couchapp.org</a> . <br><br>  The book CouchDB is invited to look at the example of Sofa (blog), which lies on github.  The code of this application has gone so far that only in places you can find only a remote similarity.  Plus, if the application code in the book uses enough basic things, then the application in the repository already uses higher-level constructs.  When you figure out what's what, it's not so scary, but for a person who just discovered CouchApp, in my opinion, it's too difficult.  Maybe this can be facilitated by having experience in server-side JS, I don‚Äôt know, I didn‚Äôt have that experience. <br><br>  Also depressing the lack of documentation on the supplied javascript libraries.  It is not clear where they lie (I did not immediately realize that some of the libraries are provided by the couchapp script, and some already exist on the server, but where it was still to be determined) what is their API and what are they doing.  For example, in the CouchDB lead wife‚Äôs blog there is a description of test cases for javascript libraries (one plain js, the other jquery-based) performing ajax requests to the database.  But these libraries are not used in the Sofa application.  They use another library, which expands their capabilities, but which for some reason, on the first request, pulls out the entire design document of the application in order to build urls from it.  And the size of the design document even in my small application is about 1 megabyte. <br><br>  In general, judging by the documentation, then from the project it is struck with such a serious student diploma, but by no means a commercial product, despite the fact that the product is serious. <br><br>  2. Security applications. <br>  Initially, absolutely all users can make any queries to the database.  This is prohibited by specifying database users.  But since CouchApp spins within the same database, then if the user has access to CouchApp, then he has full access to all documents.  And if it is possible to prohibit writing at the level of validation functions, then with reading this will not work.  Any authorized user can make a built-in query / _all_docs and get all the documents in the database. <br><br>  Probably, this can be bypassed by screwing over Apache, where you can close all unnecessary URLs, deciding at the same time the question of pretty urls (the user will not go to / _lists / sets / ...? ...), but I haven't tried it, although the same couchapp.org works that way. <br><br>  From all this, I can conclude that it will be quieter to have CouchDB for some application that will take over security and POST requests from forms.  But the project is developing and, if innovations that simplify life are written in imputed documentation, you can try to reconsider my views. <br><br>  Thank you, I hope it was interesting. </div><p>Source: <a href="https://habr.com/ru/post/110675/">https://habr.com/ru/post/110675/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../110665/index.html">Pritchi.ru -</a></li>
<li><a href="../110666/index.html">Pixel Qi has found a display manufacturer.</a></li>
<li><a href="../110667/index.html">Accounting for processor time in the cloud</a></li>
<li><a href="../110668/index.html">Online - learning programming in Ruby without habraeffekt</a></li>
<li><a href="../110673/index.html">Matte ASUS EeePC 1015PEM</a></li>
<li><a href="../110676/index.html">Why does ReactOS need Symantec?</a></li>
<li><a href="../110677/index.html">Clip2net vs Jing</a></li>
<li><a href="../110679/index.html">Twitter bought a question and answer service</a></li>
<li><a href="../110680/index.html">How to transfer donations to the movement for Wikileaks through a Russian bank</a></li>
<li><a href="../110681/index.html">There are a quarter million articles in Ukrainian Wikipedia!</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>