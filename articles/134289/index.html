<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Development of cartographic mobile applications in C ++ / Qt, using Qt Mobility</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This post participates in the competition " Smart phones for smart posts " 
 In the previous article, we learned how to write a cartographic applicati...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Development of cartographic mobile applications in C ++ / Qt, using Qt Mobility</h1><div class="post__text post__text-html js-mediator-article"><h4>  This post participates in the competition " <a href="http://habrahabr.ru/company/Nokia/blog/132522/">Smart phones for smart posts</a> " </h4><br><img align="left" src="https://habrastorage.org/getpro/habr/post_images/d1d/6ac/84f/d1d6ac84f53034bd56c89433a4d8f6be.jpg" alt="image">  In the previous <a href="http://habrahabr.ru/blogs/qt_software/133506/">article,</a> we learned how to write a cartographic application in QML, and today we will consider developing an application based on the <a href="http://doc.qt.nokia.com/latest/graphicsview.html">Qt Graphics View</a> architecture of graphical representations, using the <a href="http://doc.qt.nokia.com/qtmobility-1.2/location-overview.html">QtLocation</a> API module.  The article can be divided into two parts: theoretical and practical.  The theoretical part deals with the architecture of the <i>Graphics View</i> and the main points of using the <i>QtLocation</i> module.  In the practical part, I will not describe creating a project from scratch, but will provide the code of the most interesting functional from the project, such as inertial map movement, animated transition to a given coordinate, <a href="http://ru.wikipedia.org/wiki/GPS">GPS positioning</a> , elements for scaling and displaying textual information. <br>  If you collected <a href="https://gitorious.org/qtm-geoservices-extras/qtm-geoservices-extras">additional plugins</a> from the previous <a href="http://habrahabr.ru/blogs/qt_software/133506/">article,</a> you can use them in this project. <br><a name="habracut"></a><br><br><h5>  Table of contents </h5><br><ol><li>  <a href="https://habr.com/ru/post/134289/">Graphics View Architecture</a> </li><li>  <a href="https://habr.com/ru/post/134289/">Introduction to graphic elements</a> </li><li>  <a href="https://habr.com/ru/post/134289/">QtLocation module</a> </li><li>  <a href="https://habr.com/ru/post/134289/">Maps and Services</a> </li><li>  <a href="https://habr.com/ru/post/134289/">Getting GPS coordinates</a> </li><li>  Project Parsing <br><ul><li>  <a href="https://habr.com/ru/post/134289/">Animated transition to the specified coordinate</a> </li><li>  <a href="https://habr.com/ru/post/134289/">Pinch gesture</a> </li><li>  <a href="https://habr.com/ru/post/134289/">Kinetic scroll</a> </li><li>  <a href="https://habr.com/ru/post/134289/">Item for status bar</a> </li><li>  <a href="https://habr.com/ru/post/134289/">Element to scale</a> </li></ul></li><li>  <a href="https://habr.com/ru/post/134289/">Tips &amp; Tricks</a> </li><li>  <a href="https://habr.com/ru/post/134289/">Conclusion</a> </li><li>  <a href="https://habr.com/ru/post/134289/">Links</a> </li></ol><br><br><a name="GraphicsView"></a><br><h5>  Graphics View Architecture </h5><br>  The graphics view architecture is similar to the <a href="http://doc.qt.nokia.com/latest/model-view-programming.html">model / view</a> architecture in the sense that it has a class for storing <a href="http://doc.qt.nokia.com/latest/qgraphicsscene.html">QGraphicsScene</a> data and a class for visualizing this <a href="http://doc.qt.nokia.com/latest/qgraphicsview.html">QGraphicsView</a> data.  The same scene can be visualized with different views, if necessary.  The graphic scene contains elements ‚Äî objects of classes derived from the abstract <a href="http://doc.qt.nokia.com/latest/qgraphicsitem.html">QGraphicsItem</a> class. <br>  From the very beginning, a lot of effort was put into the development of the architecture of graphical representations aimed at improving performance and expanding capabilities.  Scenes can be scaled, rotated and printed, and to display them, use both the Qt engine and the OpenGL library.  The architecture also supports animation and drag and drop.  Graphic scenes are suitable for presentation from a few to tens of thousands of elements, an example of <a href="http://doc.qt.nokia.com/latest/demos-chip.html">40,000 chips</a> can serve as a good illustration.  You can also place widgets that are derived from <a href="http://doc.qt.nokia.com/latest/qwidget.html">QWidget</a> on the scene. To do this, you must transfer the widget to the <a href="http://doc.qt.nokia.com/latest/qgraphicsproxywidget.html">QGraphicsProxyWidget</a> class constructor and place the proxy widget on the scene.  The proxy widget (or the <i>QWidget</i> objects themselves) is slow, but whether this slowdown is noticeable depends on the application (for more details, see <a href="http://labs.qt.nokia.com/2010/01/11/qt-graphics-and-performance-the-cost-of-convenience/">QtLabs</a> [En]). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <a name="GraphicsItem"></a><br><h5>  Introduction to graphic elements </h5><br>  The <a href="http://doc.qt.nokia.com/latest/qgraphicsitem.html">QGraphicsItem</a> class is basic for all graphic elements.  You cannot create instances of it, since it has two purely virtual methods: <a href="http://doc.qt.nokia.com/latest/qgraphicsitem.html">boundingRect ()</a> and <a href="http://doc.qt.nokia.com/latest/qgraphicsitem.html">paint ()</a> .  The <i>paint ()</i> method corresponds to the <a href="http://doc.qt.nokia.com/latest/qwidget.html">QWidget :: paintEvent ()</a> method, its implementation should draw an element.  The <i>boundingRect ()</i> method informs the infrastructure about the bounding rectangle of an element ‚Äî it is used to detect collisions and not to redraw an element that is not visible.  This class provides support for mouse and keyboard events, drag &amp; drop, grouping items.  Event processing works as follows, the view receives mouse and keyboard events, then it translates them into events for the scene, changing the <a href="http://doc.qt.nokia.com/latest/graphicsview.html">coordinates</a> in accordance with the coordinates of the scene, and then the event is passed to the desired element. <br><br><a name="QtLocation"></a><br><h5>  QtLocation module </h5><br><br><img align="left" src="https://habrastorage.org/storage1/c4131637/45a2fde4/f640acfd/97fbd3ce.png"><img align="left" src="https://habrastorage.org/storage1/f0d5bc7d/28dd3616/7a31d0b4/0e5a1375.png"><img align="left" src="https://habrastorage.org/storage1/4f3752cc/89a92f4e/72306acb/6561828a.png"><img src="https://habrastorage.org/storage1/c41320ac/4c0d91f7/bb5a5890/92e6df5e.png"><br>  The <i>QtLocation</i> module provides the developer with a convenient interface for accessing positional information.  The API allows you to abstract from a source of information, which can be a list of satellites or data from other sources. <br>  <i>QtLocation</i> , comes with a set of classes related to various aspects of navigation.  It includes hardware-related classes, such as <a href="http://doc.qt.nokia.com/qtmobility/qgeopositioninfosource.html">QGeoPositionInfoSource</a> , which provides user position information using the global positioning system (GPS) or other location sources, and <a href="http://doc.qt.nokia.com/qtmobility/qgeosatelliteinfosource.html">QGeoSatelliteInfoSource</a> , which is used to obtain satellite positioning information. <br>  The module also includes a number of classes with the main purpose, which is the description of the location information, for example, <a href="http://doc.qt.nokia.com/qtmobility/qgeocoordinate.html">QGeoCoordinate</a> , which contains latitude, longitude and height above sea level.  <i>QtLocation</i> also provides a way to represent geographic areas, either in an abstract form, like <a href="http://doc.qt.nokia.com/qtmobility/qgeoboundingarea.html">QGeoBoundingArea</a> or more precisely, as in <a href="http://doc.qt.nokia.com/qtmobility/qgeoboundingbox.html">QGeoBoundingBox</a> and <a href="http://doc.qt.nokia.com/qtmobility/qgeoboundingcircle.html">QGeoBoundingCircle</a> . <br><br><a name="GeoMap"></a><br><h5>  Maps and Services </h5><br> <a href=""><img src="http://developer.qt.nokia.com/uploads/qq35/maps/map-shapes-small.png" alt="map-shapes"></a> <br>  Before we can start working with maps, scenes and views, first of all we need to get access to a source of geographic data.  A common way to do this is to use a <a href="http://doc.qt.nokia.com/qtmobility/qgeoserviceprovider.html">QGeoServiceProvider</a> .  To find out which services are available, you can use <a href="http://doc.qt.nokia.com/qtmobility/qgeoserviceprovider.html">QGeoServiceProvider :: availableServiceProviders ()</a> , which returns an empty <a href="http://doc.qt.nokia.com/latest/qstringlist.html">QStringList</a> if there are no available services, so the developer should check this feature: <br><pre><code class="hljs ruby">QStringList services = QGeoServiceProvider::availableServiceProviders(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (services.isEmpty()) { <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>      }</code> </pre> <br>  Once the service provider has been received, we can get a <a href="http://doc.qt.nokia.com/qtmobility/qgeomappingmanager.html">QGeoMappingManager</a> , which will allow us to get an image of the card. <br><pre> <code class="hljs nginx"> <span class="hljs-attribute"><span class="hljs-attribute">QGeoMappingManager</span></span> *manager = service.mappingManager();</code> </pre>  In order to query the manager to search for objects on the map or route, you need to call <a href="http://doc.qt.nokia.com/qtmobility-1.1/qgeoservicemanager.html">searchManager ()</a> or <a href="http://doc.qt.nokia.com/qtmobility-1.1/qgeoservicemanager.html">routingManager ()</a> . <br>  To draw a map for a user, <i>QtLocation</i> provides us with a <a href="http://doc.qt.nokia.com/qtmobility-1.1/qgraphicsgeomap.html">QGraphicsGeoMap</a> class to display data from <i>QGeoMappingManager</i> .  All we have to do is create the view and scene in the usual way, and add a map to the scene: <br><pre> <code class="hljs pgsql"> QGraphicsScene scene; QGraphicsView <span class="hljs-keyword"><span class="hljs-keyword">view</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">view</span></span>.setScene(&amp;scene); QGraphicsGeoMap *geoMap = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> QGraphicsGeoMap(manager); scene.addItem(geoMap);</code> </pre><br><br><a name="GPS"></a><br><h5>  Getting GPS coordinates </h5><br><img src="https://habrastorage.org/getpro/habr/post_images/d3c/397/758/d3c3977589a72fcb1dcbbcbcef07a442.jpg" alt="image"><br>  To get GPS coordinates, you need to create a <a href="http://doc.qt.nokia.com/qtmobility-1.0/qgeopositioninfosource.html">QGeoPositionInfoSource by</a> calling <a href="http://doc.qt.nokia.com/qtmobility-1.0/qgeopositioninfosource.html">QGeoPositionInfoSource :: createDefaultSource ()</a> , which gives access to various QGeoPositionInfo <a href="http://doc.qt.nokia.com/qtmobility-1.0/qgeopositioninfo.html">information</a> .  Clients requiring location data can connect to the <a href="http://doc.qt.nokia.com/qtmobility-1.0/qgeopositioninfosource.html">positionUpdated ()</a> signal so that <i>QGeoPositionInfoSource to</i> start sending this signal must be called <a href="http://doc.qt.nokia.com/qtmobility-1.0/qgeopositioninfosource.html">startUpdates ()</a> or <a href="http://doc.qt.nokia.com/qtmobility-1.0/qgeopositioninfosource.html">requestUpdate ()</a> . <br>  An example of a client that receives location data: <br><pre> <code class="hljs haskell"><span class="hljs-class"><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MyClass</span></span></span><span class="hljs-class"> : public </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">QObject</span></span></span><span class="hljs-class"> { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Q_OBJECT</span></span></span><span class="hljs-class"> public: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MyClass</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">QObject</span></span></span><span class="hljs-class"> *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">parent</span></span></span><span class="hljs-class"> = 0) : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">QObject</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">parent</span></span></span><span class="hljs-class">) { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">QGeoPositionInfoSource</span></span></span><span class="hljs-class"> *source = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">QGeoPositionInfoSource</span></span></span><span class="hljs-class">::createDefaultSource(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">this</span></span></span><span class="hljs-class">); if (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">source</span></span></span><span class="hljs-class">) { connect(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">source</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SIGNAL</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">positionUpdated</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">QGeoPositionInfo</span></span></span><span class="hljs-class">)), this, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SLOT</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">positionUpdated</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">QGeoPositionInfo</span></span></span><span class="hljs-class">))); source-&gt;startUpdates(); } } private slots: void positionUpdated(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">QGeoPositionInfo</span></span></span><span class="hljs-class"> &amp;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">info</span></span></span><span class="hljs-class">) { qDebug() &lt;&lt; "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Position</span></span></span><span class="hljs-class"> updated:" &lt;&lt; info; } };</span></span></code> </pre><br>  If regular position updates are required, <a href="http://doc.qt.nokia.com/qtmobility-1.1/qgeopositioninfosource.html">setUpdateInterval ()</a> can be used to determine how often these updates should occur.  If the interval is not specified, updates come when they are available.  For example, if the client application requires updating every 30 seconds: <br><pre> <code class="hljs bash"> // Emit updates every 30 seconds <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> available QGeoPositionInfoSource *<span class="hljs-built_in"><span class="hljs-built_in">source</span></span> = QGeoPositionInfoSource::createDefaultSource(someParent); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">source</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">source</span></span>-&gt;setUpdateInterval(30000);</code> </pre><br><br><a name="AnimatedPan"></a><br><h5>  Animated transition to the specified coordinate </h5><br>  So, we got a general idea of ‚Äã‚Äãhow everything works, now you can go to the code.  To create a smooth movement of the map to a given coordinate, we need to expand the functionality provided by the <a href="http://doc.qt.nokia.com/qtmobility/qgraphicsgeomap.html">QGraphicsGeoMap</a> class: <br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">GeoMap</span></span> : <span class="hljs-title"><span class="hljs-title">public</span></span> <span class="hljs-title"><span class="hljs-title">QGraphicsGeoMap</span></span> { <span class="hljs-function"><span class="hljs-function">Q_OBJECT </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Q_PROPERTY</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">double</span></span></span></span><span class="hljs-function"><span class="hljs-params"> centerLatitude READ centerLatitude WRITE setCenterLatitude</span></span></span><span class="hljs-function">) </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Q_PROPERTY</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">double</span></span></span></span><span class="hljs-function"><span class="hljs-params"> centerLongitude READ centerLongitude WRITE setCenterLongitude</span></span></span><span class="hljs-function">) </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GeoMap</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">QGeoMappingManager *manager, QGraphicsItem *parent = </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span></span><span class="hljs-function">)</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">animatedPanTo</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> QGeoCoordinate&amp; center</span></span></span><span class="hljs-function">)</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">double</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">centerLatitude</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> center().latitude(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setCenterLatitude</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">double</span></span></span></span><span class="hljs-function"><span class="hljs-params"> lat</span></span></span><span class="hljs-function">)</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">double</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">centerLongitude</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> center().longitude(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setCenterLongitude</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">double</span></span></span></span><span class="hljs-function"><span class="hljs-params"> lon</span></span></span><span class="hljs-function">)</span></span>; <span class="hljs-comment"><span class="hljs-comment">//...</span></span></code> </pre><br>  and implementation: <br><pre> <code class="hljs pgsql"><span class="hljs-type"><span class="hljs-type">void</span></span> GeoMap::animatedPanTo(const QtMobility::QGeoCoordinate ¬¢er) { QGeoCoordinate curStart(this-&gt;center()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (curStart == center) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; //        setStatusBarText(QString("Panning to %1").arg(center.toString(QGeoCoordinate::Degrees))); QPropertyAnimation *latAnim = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> QPropertyAnimation(this, "centerLatitude"); latAnim-&gt;setEndValue(center.latitude()); latAnim-&gt;setDuration(<span class="hljs-number"><span class="hljs-number">300</span></span>); QPropertyAnimation *lonAnim = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> QPropertyAnimation(this, "centerLongitude"); lonAnim-&gt;setEndValue(center.longitude()); lonAnim-&gt;setDuration(<span class="hljs-number"><span class="hljs-number">300</span></span>); QParallelAnimationGroup *<span class="hljs-keyword"><span class="hljs-keyword">group</span></span> = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> QParallelAnimationGroup; <span class="hljs-keyword"><span class="hljs-keyword">group</span></span>-&gt;addAnimation(latAnim); <span class="hljs-keyword"><span class="hljs-keyword">group</span></span>-&gt;addAnimation(lonAnim); <span class="hljs-keyword"><span class="hljs-keyword">group</span></span>-&gt;<span class="hljs-keyword"><span class="hljs-keyword">start</span></span>(QAbstractAnimation::DeleteWhenStopped); } <span class="hljs-type"><span class="hljs-type">void</span></span> GeoMap::setCenterLatitude(<span class="hljs-type"><span class="hljs-type">double</span></span> lat) { QGeoCoordinate c = center(); c.setLatitude(lat); setCenter( c); } <span class="hljs-type"><span class="hljs-type">void</span></span> GeoMap::setCenterLongitude(<span class="hljs-type"><span class="hljs-type">double</span></span> lon) { QGeoCoordinate c = center(); c.setLongitude(lon); setCenter( c); }</code> </pre>  Now, when you call <i>animatedPanTo (), the</i> map will smoothly move to the specified coordinate and at the right angle, i.e.  if the new coordinate is higher relative to the current center, then the map will move up and so on.  Since <a href="http://doc.qt.nokia.com/4.7/qpropertyanimation.html">QPropertyAnimation</a> does not work with <a href="http://doc.qt.nokia.com/qtmobility/qgeocoordinate.html">QGeoCoordinate by default</a> , I added two properties to the map that the animation can work with ( <a href="http://doc.qt.nokia.com/4.7/qvariantanimation.html">list of</a> supported types).  Of course, you could register your <a href="http://doc.qt.nokia.com/4.7/qvariantanimation.html">interpolator</a> and <a href="http://doc.qt.nokia.com/4.7/qmetatype.html">register</a> <i>QGeoCoordinate</i> for <a href="http://doc.qt.nokia.com/4.7/qvariant.html">QVariant</a> , but with the properties it seems to me much clearer and more elegant. <br><br><a name="PinchGesture"></a><br><h5>  Pinch gesture </h5><br><img src="http://doc.qt.nokia.com/latest/images/pinchgesture.png" alt="image"><br>  Qt includes a gesture programming <a href="http://doc.qt.nokia.com/latest/gestures-overview.html">framework</a> that generates them from a series of events, regardless of the input method.  The gesture can be a mouse movement, a touch on the touch screen, or a series of events from other sources.  In Qt, gesture processing is represented by the following classes: <a href="http://doc.qt.nokia.com/latest/qpangesture.html">QPanGesture</a> , <a href="http://doc.qt.nokia.com/latest/qpinchgesture.html">QPinchGesture,</a> and <a href="http://doc.qt.nokia.com/latest/qswipegesture.html">QSwipeGesture</a> .  "Chips" is used to increase or decrease the image, in our case it will change the map scale.  To implement it in a class, you need to enable processing of this gesture by calling the <a href="http://doc.qt.nokia.com/latest/qgraphicsobject.html">grabGesture</a> method <a href="http://doc.qt.nokia.com/latest/qgraphicsobject.html">(Qt :: PinchGesture)</a> and process it in the <a href="http://doc.qt.nokia.com/latest/qgraphicsitem.html">sceneEvent () of</a> our map: <br><pre> <code class="hljs cpp"><span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> GeoMap::sceneEvent(QEvent *event) { <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (event-&gt;type()) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> QEvent::Gesture: { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (QGestureEvent *gesture = <span class="hljs-keyword"><span class="hljs-keyword">static_cast</span></span>&lt;QGestureEvent *&gt;(event)) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (QPinchGesture *pinch = <span class="hljs-keyword"><span class="hljs-keyword">static_cast</span></span>&lt;QPinchGesture *&gt;(gesture-&gt;gesture(Qt::PinchGesture))) { qreal scale = qLn(pinch-&gt;scaleFactor())/qLn(<span class="hljs-number"><span class="hljs-number">2</span></span>); qreal zoom = <span class="hljs-number"><span class="hljs-number">0</span></span>; zoom = scale &gt; <span class="hljs-number"><span class="hljs-number">0</span></span> ? <span class="hljs-number"><span class="hljs-number">1</span></span> : <span class="hljs-number"><span class="hljs-number">-1</span></span>; setZoomLevel(zoomLevel() + zoom); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } } } <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> QGraphicsGeoMap::sceneEvent(event); }</code> </pre><br>  Qt allows you to handle <a href="http://doc.qt.nokia.com/latest/qtouchevent.html">touch</a> events on a par with <a href="http://doc.qt.nokia.com/latest/gestures-overview.html">gestures</a> .  To accept them for a widget, you need to set the <a href="http://doc.qt.nokia.com/latest/qt.html">Qt :: WA_AcceptTouchEvents attribute</a> , and for graphic elements, call <a href="http://doc.qt.nokia.com/latest/qgraphicsitem.html">acceptTouchEvents (true)</a> . <br><br><a name="KineticScroll"></a><br><h5>  Kinetic scroll </h5><br><iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/8dvK03rZSrI%3Ffeature%3Doembed&amp;xid=25657,15700022,15700186,15700191,15700253,15700255,15700259&amp;usg=ALkJrhjsAMPE8veBWG6C6kEIHe9ihLlKaw" frameborder="0" allowfullscreen=""></iframe><br>  Kinetic Scroll is an inertial movement of the map, not knowing how to more accurately convey this functionality in words, I put a video, it‚Äôs better to see once than to read a hundred times.  We are implementing this functionality.  So, the rest of our header file: <br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">protected</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mousePressEvent</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">QGraphicsSceneMouseEvent *</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">event</span></span></span></span></span><span class="hljs-function">)</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mouseMoveEvent</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">QGraphicsSceneMouseEvent *</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">event</span></span></span></span></span><span class="hljs-function">)</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mouseReleaseEvent</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">QGraphicsSceneMouseEvent *</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">event</span></span></span></span></span><span class="hljs-function">)</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mouseDoubleClickEvent</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">QGraphicsSceneMouseEvent *</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">event</span></span></span></span></span><span class="hljs-function">)</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">wheelEvent</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">QGraphicsSceneWheelEvent *</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">event</span></span></span></span></span><span class="hljs-function">)</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">keyPressEvent</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">QKeyEvent * </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">event</span></span></span></span></span><span class="hljs-function">)</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">keyReleaseEvent</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">QKeyEvent * </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">event</span></span></span></span></span><span class="hljs-function">)</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sceneEvent</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">QEvent *</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">event</span></span></span></span></span><span class="hljs-function">)</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> slots: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">kineticTimerEvent</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">panFloatWrapper</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> QPointF &amp; delta</span></span></span><span class="hljs-function">)</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">applyPan</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Qt::KeyboardModifiers &amp; modifiers</span></span></span><span class="hljs-function">)</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setStatusBarText</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> QString &amp;text</span></span></span><span class="hljs-function">)</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> panActive; <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> panDecellerate; <span class="hljs-comment"><span class="hljs-comment">// Fractional pan, used by panFloatWrapper QPointF remainingPan; // current kinetic panning speed, in pixel/msec QPointF kineticPanSpeed; QPoint panDir; QTimer kineticTimer; QTime lastMoveTime; // An entry in the mouse history. first=speed, second=time typedef QPair&lt;QPointF, QTime&gt; MouseHistoryEntry; // A history of the last (currently 5) mouse move events is stored in order to smooth out // movement detection for kinetic panning QList&lt;MouseHistoryEntry&gt; mouseHistory; StatusBarItem *m_statusBar; };</span></span></code> </pre><br>  The most interesting, of course, in the implementation, first consider the settings for motion control: <br><pre> <code class="hljs ruby">/<span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ TODO: Some of these could be exposed in a GUI and should probably be put elsewhere in that case /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ (and made non-const) /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ Kinect annimation properties static const bool enableKineticPanning = true; /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ time until kinetic panning speed slows down to 50%, in msec static const qreal kineticPanningHalflife = 160.0; /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ keyboard panning speed without modifiers, in pixels/msec</span></span> static const qreal panSpeedNormal = <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">3</span></span>; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> keyboard panning speed with shift, <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> pixels/msec static const qreal panSpeedFast = <span class="hljs-number"><span class="hljs-number">1.0</span></span>; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> minimum panning speed, <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> pixels/msec static const qreal kineticPanSpeedThreshold = <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">005</span></span>; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> temporal resolution. Smaller values take more CPU but improve visual quality static const int kineticPanningResolution = <span class="hljs-number"><span class="hljs-number">20</span></span>; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> maximum time between last mouse move <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> mouse release <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> kinetic panning to kick <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> static const int holdTimeThreshold = <span class="hljs-number"><span class="hljs-number">100</span></span>; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span></code> </pre>  I think nothing needs to be explained, everything is clear from the comments. <br>  The rest of the implementation: <br><pre> <code class="hljs ruby">void GeoMap::mousePressEvent(QGraphicsSceneMouseEvent *event) { setFocus(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (event-&gt;button() == Qt::LeftButton) { panActive = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> When pressing, stop the timer <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> stop all current kinetic panning kineticTimer.stop(); kineticPanSpeed = QPointF(); lastMoveTime = QTime::currentTime(); } event-&gt;accept(); } void GeoMap::mouseMoveEvent(QGraphicsSceneMouseEvent *event) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (panActive) { setCursor(Qt::ClosedHandCursor); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> Calculate time delta QTime currentTime = QTime::currentTime(); int deltaTime = lastMoveTime.msecsTo(currentTime); lastMoveTime = currentTime; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> Calculate position delta QPointF delta = event-&gt;lastPos() - event-&gt;pos(); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> Calculate <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> set speed <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (deltaTime &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { kineticPanSpeed = delta / deltaTime; mouseHistory.push_back(MouseHistoryEntry(kineticPanSpeed, currentTime)); mouseHistory.pop_front(); } /<span class="hljs-regexp"><span class="hljs-regexp">/ Pan map panFloatWrapper(delta); } event-&gt;accept(); } void GeoMap::mouseReleaseEvent(QGraphicsSceneMouseEvent * event) { if (event-&gt;button() == Qt::LeftButton &amp;&amp; panActive) { panActive = false; setCursor(Qt::OpenHandCursor); if (!enableKineticPanning || lastMoveTime.msecsTo(QTime::currentTime()) &gt; holdTimeThreshold) { return; } kineticPanSpeed = QPointF(); int entries_considered = 0; QTime currentTime = QTime::currentTime(); foreach(MouseHistoryEntry entry, mouseHistory) { /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ first=speed, second=time int deltaTime = entry.second.msecsTo(currentTime); if (deltaTime &lt; holdTimeThreshold) { kineticPanSpeed += entry.first; entries_considered++; } } if (entries_considered &gt; 0) kineticPanSpeed /</span></span>= entries_considered; lastMoveTime = currentTime; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> When releasing the mouse button/finger <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> moving, <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> start the kinetic panning timer kineticTimer.start(); panDecellerate = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } event-&gt;accept(); } void GeoMap::mouseDoubleClickEvent(QGraphicsSceneMouseEvent * event) { setFocus(); animatedPanTo(screenPositionToCoordinate(event-&gt;pos())); event-&gt;accept(); } /<span class="hljs-regexp"><span class="hljs-regexp">/ ... void GeoMap::kineticTimerEvent() { QTime currentTime = QTime::currentTime(); int deltaTime = lastMoveTime.msecsTo(currentTime); lastMoveTime = currentTime; if (panDecellerate) kineticPanSpeed *= qPow(qreal(0.5), qreal(deltaTime /</span></span> kineticPanningHalflife)); QPointF scaledSpeed = kineticPanSpeed * deltaTime; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (kineticPanSpeed.manhattanLength() &lt; kineticPanSpeedThreshold) { <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> Kinetic panning is almost halted -&gt; stop it. kineticTimer.stop(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } panFloatWrapper(scaledSpeed); } /<span class="hljs-regexp"><span class="hljs-regexp">/ Wraps the pan(int, int) method to achieve floating point accuracy, /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ which is needed to scroll smoothly. void GeoMap::panFloatWrapper(const QPointF &amp; delta) { /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ Add to previously stored panning distance remainingPan += delta; /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ Convert to integers QPoint move = remainingPan.toPoint(); /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ Commit mouse movement pan(move.x(), move.y()); /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ Store committed mouse movement remainingPan -= move; }</span></span></code> </pre>  I dropped the implementation of the keyboard processing, you can get acquainted with it by downloading the entire <a href="https://gitorious.org/geo-application/geo-application/trees/master">project</a> .  The implementation of the inertial movement is taken slightly less than completely from <a href="http://qt.gitorious.org/qt-mobility/contacts/trees/29636c3b20c7e03dac2f793e7be7fc939356d29d/tests/location-testing-tools/mapviewer">this</a> example, thanks to the developers for the excellent documentation and excellent examples. <br><br><a name="StatusBar"></a><br><h5>  Item for status bar </h5><br><img src="https://habrastorage.org/storage1/01efb9fb/3a8e69ab/0c45fd55/dc43e194.png"><br>  Now let's consider an element for displaying various textual information in the status bar. <br>  When displaying text, an element first appears smoothly, is delayed for a specified time and smoothly disappears.  Let's start with the announcement: <br><pre> <code class="hljs pgsql">// An animated status bar item that appears at the bottom // <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> the map <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> StatusBarItem : <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> QObject, <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> QGraphicsRectItem { Q_OBJECT Q_PROPERTY(<span class="hljs-type"><span class="hljs-type">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">offset</span></span> <span class="hljs-keyword"><span class="hljs-keyword">READ</span></span> <span class="hljs-keyword"><span class="hljs-keyword">offset</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WRITE</span></span> setOffset) <span class="hljs-built_in"><span class="hljs-built_in">public</span></span>: explicit StatusBarItem(); ~StatusBarItem(); <span class="hljs-type"><span class="hljs-type">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">offset</span></span>() const; <span class="hljs-type"><span class="hljs-type">void</span></span> setRect(qreal x, qreal y, qreal w, qreal h); <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> slots: <span class="hljs-type"><span class="hljs-type">void</span></span> setText(QString <span class="hljs-type"><span class="hljs-type">text</span></span>); <span class="hljs-type"><span class="hljs-type">void</span></span> showText(QString <span class="hljs-type"><span class="hljs-type">text</span></span>, quint32 timeout=<span class="hljs-number"><span class="hljs-number">3000</span></span>); <span class="hljs-type"><span class="hljs-type">void</span></span> <span class="hljs-keyword"><span class="hljs-keyword">show</span></span>(); <span class="hljs-type"><span class="hljs-type">void</span></span> hide(); <span class="hljs-type"><span class="hljs-type">void</span></span> setOffset(<span class="hljs-type"><span class="hljs-type">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">offset</span></span>); private: <span class="hljs-type"><span class="hljs-type">int</span></span> m_offset; QGraphicsSimpleTextItem *m_textItem; };</code> </pre>  First, the item itself is a rectangle that contains the <a href="http://doc.qt.nokia.com/latest/qgraphicssimpletextitem.html">QGraphicsSimpleTextItem</a> and simply controls it.  Let's look at the implementation of this class: <br><pre> <code class="hljs php">StatusBarItem::StatusBarItem() { m_offset = <span class="hljs-number"><span class="hljs-number">0</span></span>; setPen(QPen(QBrush(), <span class="hljs-number"><span class="hljs-number">0</span></span>)); setBrush(QBrush(QColor(<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">120</span></span>))); m_textItem = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> QGraphicsSimpleTextItem(this); m_textItem-&gt;setBrush(QBrush(Qt::white)); setText(<span class="hljs-string"><span class="hljs-string">""</span></span>); } StatusBarItem::~StatusBarItem() { } void StatusBarItem::setText(QString text) { m_textItem-&gt;setText(text); QRectF rect = m_textItem-&gt;boundingRect(); QPointF delta = this-&gt;rect().center() - rect.center(); m_textItem-&gt;setPos(delta.x(), delta.y()); } int StatusBarItem::offset() <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> m_offset; } void StatusBarItem::setRect(qreal x, qreal y, qreal w, qreal h) { QGraphicsRectItem::setRect(x, y + m_offset, w, h); QFont f; f.setFixedPitch(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); f.setPixelSize(h/<span class="hljs-number"><span class="hljs-number">1.1</span></span>); m_textItem-&gt;setFont(f); setText(m_textItem-&gt;text()); } void StatusBarItem::setOffset(int offset) { this-&gt;setY(this-&gt;y() - m_offset + offset); m_offset = offset; } void StatusBarItem::showText(QString text, quint32 timeout) { setText(text); show(); QTimer::singleShot(timeout, this, SLOT(hide())); } void StatusBarItem::show() { QPropertyAnimation *anim = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> QPropertyAnimation(this, <span class="hljs-string"><span class="hljs-string">"offset"</span></span>); anim-&gt;setStartValue(<span class="hljs-number"><span class="hljs-number">0</span></span>); anim-&gt;setEndValue(<span class="hljs-number"><span class="hljs-number">-1</span></span> * rect().height()); anim-&gt;setDuration(<span class="hljs-number"><span class="hljs-number">500</span></span>); anim-&gt;start(QAbstractAnimation::DeleteWhenStopped); } void StatusBarItem::hide() { QPropertyAnimation *anim = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> QPropertyAnimation(this, <span class="hljs-string"><span class="hljs-string">"offset"</span></span>); anim-&gt;setStartValue(m_offset); anim-&gt;setEndValue(<span class="hljs-number"><span class="hljs-number">0</span></span>); anim-&gt;setDuration(<span class="hljs-number"><span class="hljs-number">500</span></span>); anim-&gt;start(QAbstractAnimation::DeleteWhenStopped); }</code> </pre>  The animation controls the position of the element and, depending on the method, either pulls the element up or down.  Qt <i>'s</i> motto is <i>‚ÄúCode Less.</i>  <i>Create More. "</i> Works in full. <br><br><a name="ButtonItem"></a><br><h5>  Element to scale </h5><br><img src="https://habrastorage.org/storage1/efd7ae57/5e65a7f6/0add5727/abe5cadc.png"><br>  Here I wanted to consider the implementation of buttons for scaling, but at the last moment I changed my mind (seeing the volume of the resulting article) and only describe the main principle of its work.  So, this is a regular <a href="http://doc.qt.nokia.com/latest/qgraphicsrectitem.html">QGraphicsRectItem</a> , which contains two <a href="http://doc.qt.nokia.com/latest/qgraphicssimpletextitem.html">text elements</a> for displaying <b>+</b> and <b>-</b> , and <a href="http://doc.qt.nokia.com/latest/qgraphicslineitem.html">QGraphicsLineItem</a> for visual separation.  The element reacts to user actions and by pressing it either increases or decreases the scale of the map: <br><pre> <code class="hljs erlang-repl"> //       //  ,      <span class="hljs-number"><span class="hljs-number">0</span></span>      m_geoMap-&gt;setZoomLevel(m_geoMap-&gt;zoomLevel() + zoomLevel(event-&gt;pos()));</code> </pre><br>  In principle, the element could be implemented by a single inheritance from <i>QGraphicsItem</i> and simply draw the information we need, but I thought that working with various graphical elements was more intuitive.  Who wants, can change this class, after it will consume a little less memory. <br><br><a name="Tips"></a><br><h5>  Tips &amp; Tricks </h5><br>  In order for <i>QGraphicsView to</i> use OpenGL for drawing, you just need to install the <a href="http://doc.qt.nokia.com/latest/qglwidget.html">QGLWidget</a> as follows: <br><pre> <code class="hljs lisp">#ifndef QT_NO_OPENGL setViewport(<span class="hljs-name"><span class="hljs-name">new</span></span> QGLWidget(<span class="hljs-name"><span class="hljs-name">QGLFormat</span></span>(<span class="hljs-name"><span class="hljs-name">QGL</span></span>:<span class="hljs-symbol"><span class="hljs-symbol">:SampleBuffers</span></span>)))<span class="hljs-comment"><span class="hljs-comment">; viewport()-&gt;setMouseTracking(true); setRenderHint(QPainter::HighQualityAntialiasing, true); #endif</span></span></code> </pre>  And set the <a href="http://doc.qt.nokia.com/latest/qgraphicsview.html">flag</a> for <i>QGraphicsView</i> , since <i>QGLWidget</i> does not support partial screen updates: <br><pre> <code class="hljs lisp"> graphicsView-&gt;setViewportUpdateMode(<span class="hljs-name"><span class="hljs-name">QGraphicsView</span></span>:<span class="hljs-symbol"><span class="hljs-symbol">:FullViewportUpdate</span></span>)<span class="hljs-comment"><span class="hljs-comment">;</span></span></code> </pre>  Also, if you have a lot of animated or moving elements in the scene, then for better performance, you can disable indexing of elements: <br><pre> <code class="hljs lisp"> graphicsScene-&gt;setItemIndexMethod(<span class="hljs-name"><span class="hljs-name">QGraphicsScene</span></span>:<span class="hljs-symbol"><span class="hljs-symbol">:NoIndex</span></span>)<span class="hljs-comment"><span class="hljs-comment">;</span></span></code> </pre>  <a href="http://doc.qt.nokia.com/latest/qgraphicsscene.html">Indexing is</a> great for static scene elements, it enhances the search for scene elements in functions such as <a href="http://doc.qt.nokia.com/latest/qgraphicsscene.html">items ()</a> and <a href="http://doc.qt.nokia.com/latest/qgraphicsscene.html">itemAt ()</a> .  You may also consider <a href="http://doc.qt.nokia.com/latest/qgraphicsview.html">optimizing</a> flags for <i>QGraphicsView</i> . <br><br><a name="End"></a><br><h5>  Conclusion </h5><br>  The article turned out to be large, and it seems to me that it can be expanded indefinitely.  We did not consider the API <a href="http://doc.qt.nokia.com/qtmobility-1.2/tutorials-mapsdemo-part2.html">for finding</a> objects, <a href="http://doc.qt.nokia.com/qtmobility-1.2/tutorials-mapsdemo-part4.html">laying a route</a> and working with the <a href="http://doc.qt.nokia.com/qtmobility/location-overview.html">Landmark</a> API (if anyone is interested, see Example <a href="http://doc.qt.nokia.com/qtmobility-1.2/landmarkbrowser.html">1</a> and <a href="http://doc.qt.nokia.com/qtmobility/declarative-location-landmarkmap.html">2</a> ).  In the article we got acquainted with the <i>Graphics View Framework</i> , the main points when using the <i>QtLocation</i> API, I hope, we learned how to work with the <a href="http://doc.qt.nokia.com/latest/animation.html">Animation Framework</a> and looked at the implementation of inertial movement of the map, various elements for managing the map and displaying textual information.  In general, it turned out a good component for displaying the map, which can be expanded to a full-fledged navigator.  To try the application in action, you need to install the <a href="http://qt.nokia.com/downloads">Qt SDK</a> and build the project for the Qt emulator.  Finally, some useful links. <br><br><a name="Links"></a><br><h5>  Links </h5><br><ol><li>  <a href="http://developer.qt.nokia.com/videos">Qt Videos</a> </li><li>  <a href="http://developer.qt.nokia.com/videos/watch/scene_graph_a_different_approach_to_graphics_in_qt">Scene Graph: A Different Approach to Graphics in Qt</a> </li><li>  <a href="http://developer.qt.nokia.com/videos/watch/performance_do_graphics_the_right_way">Performance: Do Graphics the Right Way</a> </li><li>  <a href="http://developer.qt.nokia.com/videos/watch/qt_graphicsview_in_depth">Qt GraphicsView in Depth</a> </li><li>  <a href="http://qt.nokia.com/learning/online/training/specialized-elearning/graphics-view">Training Materials - Graphics View</a> </li><li>  All project on <a href="https://gitorious.org/geo-application">gitorius</a> </li></ol><br><br>  PS Comments on the article are welcome, it will be very useful for such an inexperienced author as me.  Thank you in advance. </div><p>Source: <a href="https://habr.com/ru/post/134289/">https://habr.com/ru/post/134289/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../134278/index.html">StartFellows is a free grant for Internet startups.</a></li>
<li><a href="../134281/index.html">Speed ‚Äã‚Äãtest a year later</a></li>
<li><a href="../134283/index.html">Impressive Solids: making a game in C # under OpenGL, part II</a></li>
<li><a href="../134286/index.html">HTC Desire HD has been updated to Android 2.3.5 and Sense 3.0</a></li>
<li><a href="../134288/index.html">Bookbase - beta was born</a></li>
<li><a href="../134292/index.html">Winning the domino effect</a></li>
<li><a href="../134293/index.html">What if you look into the keyhole of the Election Commission?</a></li>
<li><a href="../134295/index.html">How we got to Silicon Valley</a></li>
<li><a href="../134296/index.html">Jelastic PaaS - usage statistics for databases, servers and JVM in November</a></li>
<li><a href="../134297/index.html">CiEx: Take Kadropotok</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>