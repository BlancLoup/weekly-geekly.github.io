<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ZSON: PostgreSQL extension for transparent JSONB compression</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="We recently posted on GitHub ZSON . ZSON is an extension to PostgreSQL for transparent compression of JSONB documents. Compression is accomplished by ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>ZSON: PostgreSQL extension for transparent JSONB compression</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/b06/5b3/c39/b065b3c390ad4fca8eca729e5e4f2d51.png"><br><br>  We recently posted on GitHub <a href="https://github.com/afiskon/zson">ZSON</a> .  ZSON is an extension to PostgreSQL for transparent compression of JSONB documents.  Compression is accomplished by highlighting the lines most commonly found in your documents and building a dictionary with these lines.  Moreover, strings can be not only document keys, but also values ‚Äã‚Äãor, for example, strings from nested arrays.  In some cases, ZSON allows you to reduce the size of the database to two times and increase the number of transactions per second by 10%.  In shared buffers, documents are stored in a compressed form, due to which the memory is also saved. <br><br>  Interesting?  Read on and you will learn how to use all this farming in practice. <br><a name="habracut"></a><br><h3>  Remarks </h3><br>  Before going to the main content of the article, I would like to note a few points: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ul><li>  Benchmark ZSON'a in this article is not given.  Interested readers can <a href="">read it here</a> .  Take into account that in practice everything depends very much on your data, configuration, hardware, version of the DBMS and other factors.  <a href="https://eax.me/benchmarks/">Do not believe synthetic benchmarks</a> , check everything yourself! <br><br></li><li>  The question of writing extensions for PostgreSQL is beyond the scope of this article.  Interested readers can <a href="https://eax.me/postgresql-extensions/">read a separate article on this topic</a> , and further links.  How ZSON works inside, if it‚Äôs interesting to someone, I can devote a separate article. <br><br></li><li>  PostgreSQL has a built-in compression algorithm - PGLZ.  ZSON does not replace, but complements it.  PGLZ compresses each document individually.  He cannot find that the same lines appear in different documents.  ZSON finds these strings and replaces them with 16-bit codes.  Then the documents are compressed PGLZ, as usual (or not compressed, if the final document is small and / or not pressed). </li></ul><br><h3>  Installation </h3><br>  Building ZSON from sources and installing it is done as follows: <br><br><pre><code class="bash hljs">git <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> https://github.com/afiskon/zson.git <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> zson sudo make install</code> </pre> <br>  After installation, run the tests: <br><br><pre> <code class="bash hljs">make installcheck</code> </pre> <br>  Enable ZSON for your database: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> extension zson;</code> </pre> <br>  Congratulations, ZSON is installed! <br><br><h3>  Deletion </h3><br>  When and if you want to remove ZSON, just turn it off: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">drop</span></span> extension zson;</code> </pre> <br>  And then completely cut from PostgreSQL: <br><br><pre> <code class="bash hljs">sudo make uninstall</code> </pre> <br>  All types created by ZSON, tables, and so on, will be cleaned automatically. <br><br><h3>  Using </h3><br>  First of all, you should train ZSON on your typical documents.  As a result of the training, a dictionary is constructed with the strings most frequently found in your documents, which is then used for compression.  Training takes place using the following procedure: <br><br><pre> <code class="sql hljs">zson_learn( tables_and_columns text[][], max_examples int default 10000, min_length int default 2, max_length int default 128, min_count int default 2 )</code> </pre> <br>  For example: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> zson_learn(<span class="hljs-string"><span class="hljs-string">'{{"table1", "col1"}, {"table2", "col2"}}'</span></span>);</code> </pre> <br>  You can view the resulting dictionary as follows: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> zson_dict;</code> </pre> <br>  Now you can use ZSON as a transparent replacement for the JSONB type: <br><br><pre> <code class="hljs pgsql">zson_test=# <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> zson_example(x zson); <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> zson_test=# <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> zson_example <span class="hljs-keyword"><span class="hljs-keyword">values</span></span> (<span class="hljs-string"><span class="hljs-string">'{"aaa": 123}'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> zson_test=# <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> x -&gt; <span class="hljs-string"><span class="hljs-string">'aaa'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> zson_example; -[ <span class="hljs-type"><span class="hljs-type">RECORD</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> ]- ?<span class="hljs-keyword"><span class="hljs-keyword">column</span></span>? | <span class="hljs-number"><span class="hljs-number">123</span></span></code> </pre> <br>  All operators and procedures will work with ZSON in the same way as with JSONB. <br><br><h3>  Migration to the new dictionary </h3><br>  As your document's layout changes, compression may become ineffective due to the disappearance of some lines and the appearance of others.  In this case, you can retrain ZSON on new data: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> zson_learn(<span class="hljs-string"><span class="hljs-string">'{{"table1", "col1"}, {"table2", "col2"}}'</span></span>);</code> </pre> <br>  This creates a new version of the dictionary.  When updating and creating new documents, they will be compressed with it.  Old documents will be released using the dictionary version with which they were compressed.  Note that dictionaries are cached in memory.  Therefore, ZSON learns about the new dictionary not immediately, but about a minute after its creation. <br><br>  You can determine which version of the dictionary a particular document was compressed with using the zson_info procedure: <br><br><pre> <code class="hljs pgsql">zson_test=# <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> zson_info(x) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> test_compress <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> id = <span class="hljs-number"><span class="hljs-number">1</span></span>; -[ <span class="hljs-type"><span class="hljs-type">RECORD</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> ]<span class="hljs-comment"><span class="hljs-comment">--------------------------------------------------- zson_info | zson version = 0, dict version = 1, ... zson_test=# select zson_info(x) from test_compress where id = 2; -[ RECORD 1 ]--------------------------------------------------- zson_info | zson version = 0, dict version = 0, ...</span></span></code> </pre> <br>  If you are <b>absolutely sure</b> that <b>all the</b> documents in your database are compressed using the new version of the dictionary, you can safely delete the old dictionary: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">delete</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> zson_dict <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> dict_id = <span class="hljs-number"><span class="hljs-number">0</span></span>;</code> </pre> <br>  In practice, however, this makes little sense.  You will save only a couple of kilobytes of disk space.  The paranoiac inside of me believes that the risk of losing data due to a little inattentiveness is not worth it. <br><br><h3>  How to understand that you need to update the dictionary? </h3><br>  Unfortunately, it is difficult to recommend a universal approach.  For example, you can check the average document size in your database from time to time: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> pg_table_size(<span class="hljs-string"><span class="hljs-string">'tt'</span></span>) / (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(*) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> tt)</code> </pre> <br>  If it began to increase, then it's time to update the dictionary.  You can also retrain ZSON just from time to time, for example, once a year. <br><br>  Finally, application developers themselves know when they greatly change the layout of documents.  You can include retraining ZSON in the migration scripts or instructions for updating the application. <br><br>  With a strong desire, you can come up with other approaches.  In general, it all depends on the situation. <br><br><h3>  Conclusion </h3><br>  As you can see, thanks to ZSON you get the best of both worlds - the flexibility of schemaless data combined with the compactness of the relational model.  At the same time, nothing needs to be done on the side of the application; everything happens transparently, on the side of the DBMS itself. <br><br>  If you have questions, I will be happy to answer them in the comments.  Any feedback and pull requests are most welcome. </div><p>Source: <a href="https://habr.com/ru/post/312006/">https://habr.com/ru/post/312006/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../311994/index.html">How to save the princess, using 8 (+45) programming languages, on Friday</a></li>
<li><a href="../311996/index.html">How Google Cloud breathed life into Pok√©mon GO</a></li>
<li><a href="../311998/index.html">Why you should not use finalizers</a></li>
<li><a href="../312002/index.html">Intel Software Guard Extensions, a series of educational materials. Part 1, Intel SGX Basics</a></li>
<li><a href="../312004/index.html">Higher Command Line Math - GNU Octave</a></li>
<li><a href="../312008/index.html">We write a smart contract for Solidity. Part 1 - installation and "Hello world"</a></li>
<li><a href="../312010/index.html">Google Online Conference: Progressive Web Apps Day (October 11)</a></li>
<li><a href="../312012/index.html">Oracle OpenWorld 2016: fundamentally new features of IaaS, PaaS and SaaS services</a></li>
<li><a href="../312016/index.html">Technocup. Again. Now cooler</a></li>
<li><a href="../312018/index.html">Analysis of tasks from the International Olympiad in Informatics IOI 2016</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>