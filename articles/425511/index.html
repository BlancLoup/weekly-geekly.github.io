<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Unobvious features of Rotativa for generating PDF in an ASP.NET MVC application</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Many developers are faced with the task of creating PDF reports for web applications, quite a natural request. I would like to bring to your attention...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Unobvious features of Rotativa for generating PDF in an ASP.NET MVC application</h1><div class="post__text post__text-html js-mediator-article"><p>  Many developers are faced with the task of creating PDF reports for web applications, quite a natural request.  I would like to bring to your attention my experience with this task when using the Rotativa library to generate reports.  This, in my opinion, is one of the most convenient libraries for such a goal in its segment, but when using it I encountered several not obvious points that I want to talk about. </p><a name="habracut"></a><br><p>  To be completely honest, I would like to share with you the set of rakes that I stepped on in the process of integrating this library, no doubt fast and very convenient. </p><br><p>  In this article I will not touch the question of choosing a library.  Each may have their own reasons for using this or that.  I chose Rotativa, because it had everything necessary to meet customer requirements at minimum cost for setting up.  Besides her, I tried three or four options. </p><br><h3 id="postanovka-zadachi">  Formulation of the problem </h3><br><p>  Web application on ASP.NET MVC, .NET version 4.6.  Other features do not matter in this context, with the exception of deployment.  It is assumed that the deployment will occur on Azure.  This is important because some other libraries (for example HiQPdf) do not transfer installations in certain Azure configurations, this is documented. </p><br><p>  I need to open a certain static HTML report for one link, and for the second link - a PDF version of the same report.  The report itself is just a set of some tables, fields and graphs for demonstration to the user.  Both versions assume the presence of a menu with navigation through report sections, the presence of tables, some graphics (colors, text size, borders). </p><br><h3 id="primenenie-biblioteki-rotativa">  Rotativa library application </h3><br><p>  Rotativa is applied as easily as possible in my opinion. </p><br><ol><li>  You already have a ready-made HTML report in the form of a template and an ASP.NET MVC controller, such as this: </li></ol><br><pre><code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">HttpGet</span></span>] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> Task&lt;ActionResult&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Index</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> param1, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> param2</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> model = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> service.GetReportDataAsync(param1, param2); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(model); }</code> </pre> <br><ol><li><p>  Install nuget Rotativa package </p><br></li><li><p>  Add new controller for PDF report </p><br></li></ol><br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">HttpGet</span></span>] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> Task&lt;ActionResult&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Pdf</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> param1, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> param2</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> model = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> service.GetReportDataAsync(param1, param2); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ViewAsPdf(<span class="hljs-string"><span class="hljs-string">"Index"</span></span>, model); }</code> </pre> <br><p>  In essence, from now on, you have a PDF returned as a file containing all the data from the original HTML report. </p><br><p>  <em>I did not describe the routing here, but it is assumed that you have configured the routes to correctly call both controllers</em> </p><br><p>  Interestingly, this library itself is essentially a wrapper over the well-known console utility <a href="https://wkhtmltopdf.org/">wkhtmltopdf</a> .  The speed of work at height, you can put on Azure - will work.  But there are features that we will talk about. </p><br><h3 id="page-number">  Page Number </h3><br><p>  It is logical to assume that the customer will print the PDF and will want to see the page number.  It's all very simple, thanks to the creators of Rotativa. </p><br><p>  According to the Rotativa documentation, you can use the <code>CustomSwitches</code> parameter to specify the arguments that will be passed to the <code>wkhtmltopdf</code> utility <code>wkhtmltopdf</code> .  Well, online tips are generous with examples.  The following call adds a number to the bottom of each page: </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ViewAsPdf(<span class="hljs-string"><span class="hljs-string">"Index"</span></span>, model) { PageMargins = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Rotativa.Options.Margins(<span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-number"><span class="hljs-number">10</span></span>), PageSize = Rotativa.Options.Size.A4, PageOrientation = Rotativa.Options.Orientation.Portrait, CustomSwitches = <span class="hljs-string"><span class="hljs-string">"--page-offset 0 --footer-center [page] --footer-font-size 8 };</span></span></code> </pre> <br><p>  It works great.  The page number itself is transmitted using the <code>[page]</code> parameter; such parameters will be replaced by specific values. </p><br><blockquote>  In addition to <code>[page]</code> there are others: <br><ul><li>  [page] Replaced by the number of the pages currently being printed </li><li>  [frompage] Replaced </li><li>  [topage] Replaced by last page to be printed </li><li>  [webpage] Replaced by the URL of the page being printed </li><li>  [section] Replaced by the current section </li><li>  [subsection] Replaced by current name subsection </li><li>  [date] Replaced by local system </li><li>  [isodate] Replaced by ISO 8601 extended format </li><li>  [time] Replaced by local system </li><li>  [title] Replaced by the current page object </li><li>  [doctitle] Replaced by the title of the output document </li><li>  [sitepage] Replaced by this page </li><li>  [sitepages] Replaced by </li></ul><br></blockquote><br><h3 id="table-of-content">  Table of content </h3><br><p>  Large multi-page reports require content and page navigation in PDF.  This is very convenient and simply vital when the number of pages in the report exceeds one hundred. </p><br><p>  <a href="https://wkhtmltopdf.org/usage/wkhtmltopdf.txt">wkhtmltopdf manual</a> contains a complete list of all parameters, among which is <code>--toc</code> .  Seeing this parameter, the utility essentially collects all the tags <code>&lt;h1&gt;, &lt;h2&gt;, ... &lt;h6&gt;</code> according to the document and generates a table of contents based on them.  Accordingly, it is necessary to provide for the proper use of these header tags in your HTML template. </p><br><p>  But in reality, adding <code>--toc</code> does not lead to any consequences.  As if the parameter was not.  However, other parameters work.  Thanks to a post on some forum, I found that this parameter needs to be passed without hyphens: <code>toc</code> .  Indeed, in this case, the content is added as the very first page.  Clicking on the line in the content takes you to the desired page of the document, page numbers are correct. </p><br><p>  It‚Äôs not quite clear yet how to customize styles, but I haven‚Äôt done it yet. </p><br><h3 id="javascript-execution">  JavaScript Execution </h3><br><p>  The next point I encountered was the need to add graphics to the report.  My HTML page contains JS code that adds graphics using the <code>dc.js</code> library.  Here is an example: </p><br><pre> <code class="hljs matlab"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">initChart</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> { </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">renderChart</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(@Html.Raw(Json.Encode(Model.Chart_1_Data)</span></span></span><span class="hljs-function">), '</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">chartDiv_1</span></span></span><span class="hljs-function">'); } </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">renderChart</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(data, chartElementId)</span></span></span><span class="hljs-function"> { </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">var</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">colors</span></span></span><span class="hljs-function"> = </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">['#03a9f4', '#67daff', '#8bc34a']</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">var</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">barHeight</span></span></span><span class="hljs-function"> = 45; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">var</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">clientHeight</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">data</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">length</span></span></span><span class="hljs-function"> * </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">barHeight</span></span></span><span class="hljs-function"> + 50; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">var</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">clientWidth</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">document</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getElementById</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(chartId)</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">offsetWidth</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">var</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">chart</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">dc</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">rowChart</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">('#' + chartElementId)</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">var</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ndx</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">crossfilter</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(dataToRender)</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">var</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">dimension</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ndx</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">dimension</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(d =&gt; d.name)</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">var</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">group</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">dimension</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">group</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">reduceSum</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(d =&gt; d.value)</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">chart</span></span></span><span class="hljs-function"> .</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">width</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(clientWidth)</span></span></span><span class="hljs-function"> .</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">height</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(clientHeight)</span></span></span><span class="hljs-function"> .</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">margins</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">({ top: 16, right: 16, bottom: 16, left: 16 })</span></span></span><span class="hljs-function"> .</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ordinalColors</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(colors)</span></span></span><span class="hljs-function"> .</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">dimension</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(dimension)</span></span></span><span class="hljs-function"> .</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">group</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(group)</span></span></span><span class="hljs-function"> .</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">xAxis</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> .</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">scale</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(d3.scaleLinear()</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">domain</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">([0, 2])</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">range</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">([1, 3])</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">nice</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">); </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">chart</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">render</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">; }</span></span></code> </pre> <br><p>  At the same time in HTML I have a corresponding element: </p><br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"chart_C2"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"dc-chart"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><p>  For this code to work, you must import the appropriate libraries: <code>dc.js</code> , <code>d3.js</code> , <code>crossfilter.js</code> .  Calling the function <code>initChart</code> will create a graph and insert the received <br>  svg to the specified item in the tree. </p><br><p>  But the PDF does not contain a trace of graphs.  As well as any other trace of executing javascript code before rendering PDF.  This is quite easy to check - all you have to do is to add the elementary code for creating a simple <code>&lt;div&gt;</code> element with text, just to test the fact that JavaScript was invoked. </p><br><p>  It was found out experimentally that the location of the JS code for <code>wkhtmltopdf</code> plays a significant role.  Located at the end of the <code>&lt;html&gt;</code> or say at the end of the <code>&lt;body&gt;</code> JS code will not be executed.  It seems that the utility simply does not notice him, or does not expect him to meet him there. </p><br><p>  But the code inside the <code>&lt;head&gt;</code> is executed.  Thus, I came to the scheme when the JavaScript code is located after the declaration of styles inside the <code>&lt;head&gt;</code> , and is invoked by the usual construction: </p><br><pre> <code class="hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">onload</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"initCharts()"</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><p>  In this case, the code will be executed as expected. </p><br><h3 id="javascript-limitations">  JavaScript Limitations </h3><br><p>  But there were no graphs in the output PDF anyway.  Then I began to guess that being not a full-fledged browser, the rendering and execution engine for pdf is most likely not perfect and does not understand the latest rules.  Again, by experiment, I found out that the switch functions are not perceived.  And if the interpreter finds something unknown for him, then he simply stops working. </p><br><p>  Replacing the switch functions of the form <code>x =&gt; x.value</code> with the more classical <code>function(x) { return x.value; }</code>  <code>function(x) { return x.value; }</code> helped and all the code was executed, the resulting graph got into a PDF file. </p><br><h3 id="chart-width">  Chart Width </h3><br><p>  Experimentally it became clear that it is necessary to clearly indicate the width of the parent element of the graph.  For this, I specified the <code>dc-chart</code> style.  It contains the width of the graph in pixels.  Otherwise, the graph on the PDF will be very small, despite the fact that in the HTML version it will occupy the entire width.  Specifying width in percent will work only for HTML. </p><br><h3 id="inline-javascript--css">  Inline JavaScript / CSS </h3><br><p>  Finally, I would like to point out that many HTML-to-PDF converting libraries accept some baseUrl as a parameter.  This is the URL on the basis of which the converter will complete building relative paths to get imported CSS styles, JavaScirpt files or fonts.  I cannot say exactly how this works in Rotativa, but I have come to a different approach. </p><br><p>  To speed up the initial download of the report and eliminate the very source of problems with embedding script files or styles when converting, I embed the necessary JS and CSS directly into the body of the HTML template. </p><br><p>  To do this, create the appropriate bundles: </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">BundleConfig</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RegisterBundles</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">BundleCollection bundles</span></span></span><span class="hljs-function">)</span></span> { bundles.Add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StyleBundle(<span class="hljs-string"><span class="hljs-string">"~/Styles/report-html"</span></span>) .Include(<span class="hljs-string"><span class="hljs-string">"~/Styles/report-common.css"</span></span>) .Include(<span class="hljs-string"><span class="hljs-string">"~/Styles/report-html.css"</span></span>) ); bundles.Add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StyleBundle(<span class="hljs-string"><span class="hljs-string">"~/Styles/report-pdf"</span></span>) .Include(<span class="hljs-string"><span class="hljs-string">"~/Styles/report-common.css"</span></span>) .Include(<span class="hljs-string"><span class="hljs-string">"~/Styles/report-pdf.css"</span></span>) ); bundles.Add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ScriptBundle(<span class="hljs-string"><span class="hljs-string">"~/Scripts/charts"</span></span>) .Include(<span class="hljs-string"><span class="hljs-string">"~/Scripts/d3/d3.js"</span></span>) .Include(<span class="hljs-string"><span class="hljs-string">"~/Scripts/crossfilter/crossfilter.js"</span></span>) .Include(<span class="hljs-string"><span class="hljs-string">"~/Scripts/dc/dc.js"</span></span>) ); } }</code> </pre> <br><p>  Add a configuration call to these bundles in <code>Global.asax.cs</code> </p><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Application_Start</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { ... BundleConfig.RegisterBundles(BundleTable.Bundles); }</code> </pre> <br><p>  And add the appropriate method to embed the code into the page.  It must be placed in the same namespace as <code>Global.asax.cs</code> so that the method can be called from the HTML template: </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">HtmlHelperExtensions</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> IHtmlString </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">InlineStyles</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">this</span></span></span></span><span class="hljs-function"><span class="hljs-params"> HtmlHelper htmlHelper, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> bundleVirtualPath</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> bundleContent = LoadBundleContent(htmlHelper.ViewContext.HttpContext, bundleVirtualPath); <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> htmlTag = <span class="hljs-string"><span class="hljs-string">$"&lt;style rel=\"stylesheet\" type=\"text/css\"&gt;</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{bundleContent}</span></span></span><span class="hljs-string">&lt;/style&gt;"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HtmlString(htmlTag); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> IHtmlString </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">InlineScripts</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">this</span></span></span></span><span class="hljs-function"><span class="hljs-params"> HtmlHelper htmlHelper, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> bundleVirtualPath</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> bundleContent = LoadBundleContent(htmlHelper.ViewContext.HttpContext, bundleVirtualPath); <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> htmlTag = <span class="hljs-string"><span class="hljs-string">$"&lt;script type=\"text/javascript\"&gt;</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{bundleContent}</span></span></span><span class="hljs-string">&lt;/script&gt;"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HtmlString(htmlTag); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">LoadBundleContent</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">HttpContextBase httpContext, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> bundleVirtualPath</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> bundleContext = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BundleContext(httpContext, BundleTable.Bundles, bundleVirtualPath); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> bundle = BundleTable.Bundles.Single(b =&gt; b.Path == bundleVirtualPath); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> bundleResponse = bundle.GenerateBundleResponse(bundleContext); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> bundleResponse.Content; } }</code> </pre> <br><p>  Well, the final touch is a call from the template: </p><br><pre> <code class="html hljs xml">@Html.InlineStyles("~/Styles/report-pdf"); @Html.InlineScripts("~/Scripts/charts");</code> </pre> <br><p>  As a result, all the necessary CSS and JavaScript will be directly in HTML, although during development you can work with individual files. </p><br><p>  Most likely, many will immediately think about the ineffectiveness of this approach in terms of caching requests by the browser.  But I had two specific goals: </p><br><ul><li>  so that the PDF converter does not have to make requests somewhere for styles or code, and the user to wait for this, respectively; </li><li>  That the first download of PDF and HTML report takes the minimum time, without having to wait for several additional request.  In the context of my project, this is important; </li></ul><br><h3 id="page-breaks">  Page breaks </h3><br><p>  Structuring a report into sections may be accompanied by requirements to start a new section from a new page.  In this case, you can successfully use a simple CSS approach: </p><br><pre> <code class="css hljs"><span class="hljs-selector-class"><span class="hljs-selector-class">.page-break-before</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">page-break-before</span></span>: always; } <span class="hljs-selector-class"><span class="hljs-selector-class">.no-page-break-inside</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">page-break-before</span></span>: auto; <span class="hljs-attribute"><span class="hljs-attribute">page-break-inside</span></span>: avoid; }</code> </pre> <br><p>  The wkhtmltopdf utility successfully reads these classes and understands that you need to start a new page.  The first class ‚Äî <code>page-break-before</code> ‚Äî tells the utility to always start a new page with this element.  The second class - <code>no-page-break-inside</code> - should be applied to those elements that you want to keep as much as possible on the page.  For example, you have successive blocks of structured information, or say tables.  If two blocks fit on the page - they will be located.  If the third does not fit into the page already, it will not be next.  If it is larger than a page, then its transfer is inevitable.  It all works adequately and conveniently. </p><br><h3 id="flex-behavior-in-wkhtmltopdf">  Flex Behavior in wkhtmltopdf </h3><br><p>  Well, the last feature I noticed is related to the use of flexbox markup styles.  We are all accustomed to them and almost all the markup is made flex.  However, wkhtmltopdf in this regard is slightly behind.  Horizontal flex options do not work (at least in my case, this did not work out. I saw on the network that it was worth duplicating flex styles as follows: </p><br><pre> <code class="css hljs"><span class="hljs-selector-tag"><span class="hljs-selector-tag">display</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">-webkit-flex</span></span>; <span class="hljs-selector-tag"><span class="hljs-selector-tag">display</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">flex</span></span>; <span class="hljs-selector-tag"><span class="hljs-selector-tag">flex-direction</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">row</span></span>; <span class="hljs-selector-tag"><span class="hljs-selector-tag">-webkit-flex-direction</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">row</span></span>; <span class="hljs-selector-tag"><span class="hljs-selector-tag">-webkit-box-pack</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">justify</span></span>; <span class="hljs-comment"><span class="hljs-comment">/* wkhtmltopdf uses this one */</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-webkit-justify-content</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">space-between</span></span>; <span class="hljs-selector-tag"><span class="hljs-selector-tag">justify-content</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">space-between</span></span>;</code> </pre> <br><p>  But unfortunately it did not lead to the expected markup in PDF.  I had to redo the layout of some elements so that the horizontal placement of blocks was in accordance with the requirements.  If someone has a successful integration experience of flexs for wkhtmltopdf, please share.  That would be quite helpful. </p><br><p>  Some links: </p><br><ul><li>  <a href="https://wkhtmltopdf.org/">wkhtmltopdf</a> </li><li>  <a href="https://wkhtmltopdf.org/usage/wkhtmltopdf.txt">wkhtmltopdf manual</a> </li><li>  <a href="https://github.com/webgio/Rotativa">Rotativa github</a> </li><li>  <a href="https://www.nuget.org/packages/Rotativa">Rotativa Package</a> </li><li>  <a href="https://blog.mariusschulz.com/2015/10/25/inlining-css-and-javascript-bundles-with-asp-net-mvc">Inline Styles HowTo</a> </li></ul></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/425511/">https://habr.com/ru/post/425511/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../425499/index.html">HyperX Impact DDR4 - SO-DIMM, which could! Or why in a laptop 64 GB of memory with a frequency of 3200 MHz?</a></li>
<li><a href="../425501/index.html">A / V tests on Android from A to Z</a></li>
<li><a href="../425503/index.html">Cassandra Sink for Spark Structured Streaming</a></li>
<li><a href="../425505/index.html">Analysis of the Linux kernel boot process</a></li>
<li><a href="../425507/index.html">Parsim Wikipedia for NLP tasks in 4 teams</a></li>
<li><a href="../425513/index.html">Deputies seriously undertook the taxation of miners</a></li>
<li><a href="../425515/index.html">Apple blocks the possibility of independent repair of new MacBook models</a></li>
<li><a href="../425517/index.html">How Yandex created a global precipitation forecast using radars and satellites</a></li>
<li><a href="../425519/index.html">Our problems with space are the result of making the wrong decisions.</a></li>
<li><a href="../425521/index.html">Protected methods in javascript ES5</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>