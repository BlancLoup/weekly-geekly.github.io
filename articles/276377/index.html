<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Reducing the size of a thin disk in ESXi</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="When I started working with ESXi, I ran into the problem of insufficient disk space due to heavily expanded thin disks. In general, it is better to cr...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Reducing the size of a thin disk in ESXi</h1><div class="post__text post__text-html js-mediator-article">  When I started working with ESXi, I ran into the problem of insufficient disk space due to heavily expanded thin disks.  In general, it is better to create smaller disks, because it is much easier to enlarge a disk in ESXi than to reduce it.  But what to do if you still need to reduce the disk?  Moreover, my position was aggravated by LVM sections on the server that Acronis did not recognize, and, therefore, could not change the size of the section. <br>  I will describe the way I used: <br><a name="habracut"></a><br>  <b>Stage 1) Reducing the disk inside the virtual machine</b> <br>  First you need to reduce the disk inside the virtual machine itself, for this there are many universal programs: Acronis disc director, paragon partition manager, built-in disk management utility in windows, etc.  None of these programs helped me, so I had to use the Linux and LiveCD tools. <br><br>  1) First you need to boot from livecd linux, I used centos 7 for this. When booting the virtual machine, the ESC key for the boot menu appears. <br><br>  2) Activate LVM sections <br><pre><code class="bash hljs">vgchange -ay</code> </pre> <br>  3) Verification of activated logical volumes <br><pre> <code class="bash hljs">lvscan</code> </pre><br>  4) Check file systems <br><pre> <code class="bash hljs">fsck -fy /dev/<span class="hljs-built_in"><span class="hljs-built_in">test</span></span>/root fsck -fy /dev/<span class="hljs-built_in"><span class="hljs-built_in">test</span></span>/home</code> </pre><br>  5) Reduce the size of the file system <br><pre> <code class="bash hljs">resize2fs /dev/<span class="hljs-built_in"><span class="hljs-built_in">test</span></span>/home 20G</code> </pre>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      6) Reduce the size of the volume to the size of the file system <br><pre> <code class="bash hljs">lvreduce -L 20G /dev/<span class="hljs-built_in"><span class="hljs-built_in">test</span></span>/home</code> </pre><br><br>  We can also add this place to another one. <br>  For this: <br><br>  Increase the root volume: <br><pre> <code class="bash hljs">lvextend -L +10G /dev/<span class="hljs-built_in"><span class="hljs-built_in">test</span></span>/root</code> </pre><br>  Increasing the size of the file system on the root volume to the size of the volume: <br><pre> <code class="bash hljs">resize2fs /dev/<span class="hljs-built_in"><span class="hljs-built_in">test</span></span>/root</code> </pre><br>  7) Again we check the integrity of the file system <br><pre> <code class="bash hljs">fsck -fy /dev/<span class="hljs-built_in"><span class="hljs-built_in">test</span></span>/root fsck -fy /dev/<span class="hljs-built_in"><span class="hljs-built_in">test</span></span>/home</code> </pre><br>  8) Next, you can start the virtual machine and make sure that everything works correctly <br><pre> <code class="bash hljs">df -h</code> </pre><br><br>  <b>Stage 2) reduction of provisioning space.</b> <br><br>  10) Turn off the virtual machine <br>  11) Connect via SSH to the physical server on which ESXi is installed <br>  12) Go to the directory in which the vmdk VM file is stored (the path can be found in the properties of the virtual disk in the vSphere graphical client).  I have it <br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /vmfs/volumes/datastore1*/ <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> VM_name/</code> </pre><br>  The catalog has a similar structure: <br><div class="spoiler">  <b class="spoiler_title">Virtual machine directory structure</b> <div class="spoiler_text">  / vmfs / volumes / 53114b32-24d88d5a-2cbe-0025b500004f / MTS-SCPortal-TEST3 # ls -l <br>  total 19810320 <br>  -rw-r - r-- 1 root root 27 Dec 20 20:46 VM_name-0b1f4705.hlog <br>  -rw ------- 1 root 6442450944 Feb 2 08:24 VM_name-0b1f4705.vswp <br>  -rw ------- 1 root 147102629888 Feb 2 08:28 VM_name-flat.vmdk <br>  -rw ------- 1 root root 8684 Feb 2 08:25 VM_name.nvram <br>  <b>-rw ------- 1 root 507 Feb 2 08:25 VM_name.vmdk</b> <br>  -rw-rrr-- 1 root root 0 Dec 20 20:14 VM_name.vmsd <br>  -rwxr-xr-x 1 root root 3584 Feb 2 08:25 VM_name.vmx <br>  -rw ------- 1 root root 0 Feb 2 08:24 VM_name.vmx.lck <br>  -rw-rrr-- 1 root root 273 Dec 20 20:14 VM_name.vmxf <br>  -rwxr-xr-x 1 root root 3584 Feb 2 08:25 VM_name.vmx ~ <br>  -rw ------- 1 root 3424256 Feb 2 08:24 vmmcores-1.gz <br>  -rw-rrr-- 1 root root 240722 Dec 20 20:46 vmware-1.log <br>  -rw-rrr-- 1 root root 1252287 Feb 2 08:24 vmware-2.log <br>  -rw-rrr-- 1 root root 43555 Feb 2 08:24 vmware-3.log <br>  -rw-r - r-- 1 root root 151873 Feb 2 08:25 vmware.log <br>  -rw ------- 1 root root 122683392 Feb 2 08:24 vmx-VM_name-186599173-1.vswp <br>  / vmfs / volumes / 53114b32-24d88d5a-2cbe-0025b500004f / VM_name # <br></div></div><br>  13) View the contents of the configuration file with the extension * .vmdk using the cat or vi command: <br><pre> <code class="bash hljs">cat VM_name.vmdk</code> </pre><br><div class="spoiler">  <b class="spoiler_title">Sample contents of the virtual machine configuration file</b> <div class="spoiler_text">  # Disk DescriptorFile <br>  version = 1 <br>  encoding = "UTF-8" <br>  CID = 829544ab <br>  parentCID = ffffffff <br>  isNativeSnapshot = "no" <br>  createType = "vmfs" <br><br>  #Extent description <br>  RW 44000000 VMFS "VM_name-flat.vmdk" <br><br>  # The Disk Data Base <br>  #DDB <br><br>  ddb.adapterType = "lsilogic" <br>  ddb.geometry.cylinders = "17884" <br>  ddb.geometry.heads = "255" <br>  ddb.geometry.sectors = "63" <br>  ddb.longContentID = "c78bccbfd4724f0ee20a1ef2829544ab" <br>  ddb.thinProvisioned = "0" <br>  ddb.uuid = "60 00 C2 98 20 ac 05 4a-e5 39 e4 40 e8 a2 d8 d0" <br>  ddb.virtualHWVersion = "8" <br></div></div><br>  14) The size of the vmdk disk is specified in the #Extent description section (after the RW symbols).  Change this value, for example, to set the disk size to 20GB, set 41943040 (20 GB * 1024 * 1024 * 1024/512) <br><pre> <code class="bash hljs">vi VM_name.vmdk</code> </pre><br>  I put the value a little larger than the size calculated by the method above (41943040 (20 GB * 1024 * 1024 * 1024/512)), just in case. <br>  15) It remains to clone or emigrate the virtual machine, after which the new disk size will be displayed. <br><br>  <b>Physical thin disk reduction without changing provisioning</b> <br>  It is also possible to only reduce the size of the virtual machine file, by removing zero blocks. <br>  For this: <br>  1) It is necessary to fill all unused space, inside the virtual machine, with zeros.  Create a file the size of the unused disk area, and then delete it. <br><pre> <code class="bash hljs">cat /dev/zero &gt; /file <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> / rm file</code> </pre><br>  2) Connect via SSH to the ESXi console as described above and go to the directory with the virtual machine. <br>  3) In the console, the hypervisor has a special utility that allows you to wipe the zero blocks, thereby reducing the physical size of the thin disk. <br>  This is done using the -K key (you can also use the --punchzero key) in the console of the ESXi server <br><pre> <code class="bash hljs">vmkfstools -K VM_name.vmdk</code> </pre><br>  It should be noted that the vmkfstools utility, launched with the -K key, can also convert a regular disk (zeroedthick or eagerzeroedthick) into a thin disk with cleaning out zero blocks and, accordingly, reducing the size of vmdk. <br><br>  PS I hope this article will be useful to someone.  Anyway, I spent a lot of time before I managed to correctly reduce the size of the thin disk. </div><p>Source: <a href="https://habr.com/ru/post/276377/">https://habr.com/ru/post/276377/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../276365/index.html">How the Zeptolab Game Designer Challenge was created</a></li>
<li><a href="../276367/index.html">Pitfalls of Consciousness: How researchers cheat themselves</a></li>
<li><a href="../276369/index.html">Machine learning from Octave \ Matlab to Python</a></li>
<li><a href="../276371/index.html">"Digital Rain" for Windows in 314 bytes</a></li>
<li><a href="../276373/index.html">Social CRM. Collecting the interest of Internet users</a></li>
<li><a href="../276381/index.html">Who should live and who should die: priorities of processes in Android</a></li>
<li><a href="../276383/index.html">Habra graph, community and where did all the karma go</a></li>
<li><a href="../276385/index.html">Hyper-scale server farm Amazon, Apple, Google, Switch, Toyota</a></li>
<li><a href="../276389/index.html">Telegram bot framework</a></li>
<li><a href="../276391/index.html">MonCach√© - implementation of the MongoDB API based on InterSystems Cach√©</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>