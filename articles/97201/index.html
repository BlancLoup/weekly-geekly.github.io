<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Python and Twisted - Notes on parallel data processing (multiprocessing)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Twisted is a Python framework for developing network applications that, among many other applications, can also be used for parallel data processing ‚Äî...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Python and Twisted - Notes on parallel data processing (multiprocessing)</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/e2b/77b/b24/e2b77bb2467797c2020845d2efb34bff.jpg" alt="image" align="left">  Twisted is a Python framework for developing network applications that, among many other applications, can also be used for parallel data processing ‚Äî multiprocessing.  This is great, but I had to sweat in order to find what I needed. <br><br><a name="habracut"></a>  I flipped through the <a href="http://twistedmatrix.com/projects/core/documentation/howto/">Twisted documentation</a> and the <a href="http://search.safaribooksonline.com/0596100329%3Ftocview%3Dtrue">O'Reilly Twisted</a> book.  There is also a <a href="http://search.safaribooksonline.com/0596007973/pythoncook2-CHP-15-SECT-7">recipe in the Python Cookbook</a> .  However, I found the most interesting in the article of Bruce Ekkel - <a href="http://www.artima.com/weblogs/viewpost.jsp%3Fthread%3D230001">Parallelism with Python, Twisted and Flex</a> .  Also worth reading Bruce <a href="http://www.artima.com/weblogs/viewpost.jsp%3Fthread%3D156396">Ekkel's</a> original articles about Twisted: <a href="http://www.artima.com/weblogs/viewpost.jsp%3Fthread%3D156396">Grokking Twisted</a> . <br><br>  Here are my comments on the current example of Bruce. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      I removed the Flex - partly because I do not need it and I do not want to know anything about it.  In the example, a controller is started, which initializes a number of separate parallel processes-calculators, in which some complex actions are already started (these processes are called solvers).  Also here there is an interaction between the controller and computers.  Although this example runs only on one machine, the principles described in the article are not difficult to extend to a system of several computers. <br><br>  For a good example of how this works, please see the <a href="http://www.artima.com/weblogs/viewpost.jsp%3Fthread%3D230001">original article</a> . <br><br>  Here is the solver.py which is copied from the original.  The real ‚Äúwork‚Äù takes place in the <b>step ()</b> method.  I just added some debug information for myself. <br><pre> "" "
 solver.py
 Original version by Bruce Eckel
 Solves one part of the problem.
 "" "
 import sys, random, math
 from twisted.spread import pb
 from twisted.internet import reactor

 class Solver (pb.Root):

     def __init __ (self, id):
         print "solver.py% s: solver init"% id
         self.id = id

     def __str __ (self): # String representation
         return "Solver% s"% self.id

     def remote_initialize (self, initArg):
         return "% s initialized"% self

     def step (self, arg):
         print "solver.py% s: solver step"% self.id
         "Simulate work and return result"
         result = 0
         for i in range (random.randint (1,000,000, 3,000,000)):
             angle = math.radians (random.randint (0, 45))
             result + = math.tanh (angle) /math.cosh (angle)
         return "% s,% s, result:% .2f"% (self, str (arg), result)

     # Alias ‚Äã‚Äãmethods, for demonstration version:
     remote_step1 = step
     remote_step2 = step
     remote_step3 = step

     def remote_status (self):
         print "solver.py% s: remote_status"% self.id
         Return "% s operational"% self

     def remote_terminate (self):
         print "solver.py% s: remote_terminate"% self.id
         reactor.callLater (0.5, reactor.stop)
         return "% s terminating ..."% self

 if __name__ == "__main__":
     port = int (sys.argv [1])
     reactor.listenTCP (port, pb.PBServerFactory (Solver (sys.argv [1])))
     reactor.run ()
</pre><br><br><br>  Here is the <strong>controller.py</strong> .  It is also copied from the original article, but I removed the <strong>Flex</strong> and created the start and terminate signals in the controller class.  I'm not sure that this makes sense, but at least it allowed me to use the example normally.  I also moved the terminate method from <strong>FlexInterface</strong> to <strong>Controller</strong> . <br><pre> "" "
 Controller.py
 Original version by Bruce Eckel
 Starts and manages solvers in separate processes for parallel processing.
 "" "
 import sys
 from subprocess import Popen
 from twisted.spread import pb
 from twisted.internet import reactor, defer

 START_PORT = 5566
 MAX_PROCESSES = 2

 class Controller (object):

     def broadcastCommand (self, remoteMethodName, arguments, nextStep, failureMessage):
         print "controller.py: broadcasting ..."
         deferreds = [solver.callRemote (remoteMethodName, arguments) 
                      for solver in self.solvers.values ‚Äã‚Äã()]
         print "controller.py: broadcasted"
         reactor.callLater (3, self.checkStatus)

         defer.DeferredList (deferreds, consumeErrors = True) .addCallbacks (
             nextStep, self.failed, errbackArgs = (failureMessage))
    
     def checkStatus (self):
         print "controller.py: checkStatus"
         for solver in self.solvers.values ‚Äã‚Äã():
             solver.callRemote ("status"). addCallbacks (
                 lambda r: sys.stdout.write (r + "\ n"), self.failed, 
                 errbackArgs = ("Status Check Failed"))
                                                     
     def failed (self, results, failureMessage = "Call Failed"):
         print "controller.py: failed"
         for (success, returnValue), (address, port) in zip (results, self.solvers):
             if not success:
                 raise Exception ("address:% s port:% d% s"% (address, port, failureMessage))

     def __init __ (self):
         print "controller.py: init"
         self.solvers = dict.fromkeys (
             [("localhost", i) for i in range (START_PORT, START_PORT + MAX_PROCESSES)])
         self.pids = [Popen (["python", "solver.py", str (port)]). pid
                      for ip, port in self.solvers]
         print "PIDS:", self.pids
         self.connected = False
         reactor.callLater (1, self.connect)

     def connect (self):
         print "controller.py: connect"
         connections = []
         for address port in self.solvers:
             factory = pb.PBClientFactory ()
             reactor.connectTCP (address, port, factory)
             connections.append (factory.getRootObject ())
         defer.DeferredList (connections, consumeErrors = True) .addCallbacks (
             self.storeConnections, self.failed, errbackArgs = ("Failed to Connect"))

         print "controller.py: starting parallel jobs"
         self.start ()

     def storeConnections (self, results):
         print "controller.py: storeconnections"
         for (success, solver), (address, port) in zip (results, self.solvers):
             self.solvers [address, port] = solver
         print "controller.py: Connected; self.solvers:", self.solvers
         self.connected = True

     def start (self):
         "controller.py: Begin the solving process"
         if not self.connected:
             return reactor.callLater (0.5, self.start)
         self.broadcastCommand ("step1", ("step 1"), self.step2, "Failed Step 1")

     def step2 (self, results):
         print "controller.py: step 1 results:", results
         self.broadcastCommand ("step2", ("step 2"), self.step3, "Failed Step 2")

     def step3 (self, results):
         print "controller.py: step 2 results:", results
         self.broadcastCommand ("step3", ("step 3"), self.collectResults, "Failed Step 3")

     def collectResults (self, results):
         print "controller.py: step 3 results:", results
         self.terminate ()
        
     def terminate (self):
         print "controller.py: terminate"
         for solver in self.solvers.values ‚Äã‚Äã():
             solver.callRemote ("terminate"). addErrback (self.failed, "Termination Failed")
         reactor.callLater (1, reactor.stop)
         return "Terminating remote solvers"

 if __name__ == "__main__":
     controller = Controller ()
     reactor.run ()
</pre><br><br><br>  To run the program, put both files in one folder and run <br><pre> python controller.py
</pre><br><br>  You should see how the load of two processors (if they, of course, you have 2 ;-)) rises to 100%.  And here is the script output to the screen: <br><pre> controller.py: init
 PIDS: [12173, 12174]
 solver.py 5567: solver init
 solver.py 5566: solver init
 controller.py: connect
 controller.py: starting parallel jobs
 controller.py: storeconnections
 controller.py: Connected;  self.solvers: {('localhost', 5567):, ('localhost', 5566):}
 controller.py: broadcasting ...
 controller.py: broadcasted
 solver.py 5566: solver step
 solver.py 5567: solver step
 controller.py: checkStatus
 solver.py 5566: remote_status
 Solver 5566 operational
 solver.py 5567: remote_status
 controller.py: step 1 results: [(True, 'Solver 5567, step 1, result: 683825.75'), (True, 'Solver 5566, step 1, result: 543177.17')]
 controller.py: broadcasting ...
 controller.py: broadcasted
 Solver 5567 operational
 solver.py 5566: solver step
 solver.py 5567: solver step
 controller.py: checkStatus
 solver.py 5566: remote_status
 Solver 5566 operational
 solver.py 5567: remote_status
 controller.py: step 2 results: [(True, 'Solver 5567, step 2, result: 636793.90'), (True, 'Solver 5566, step 2, result: 335358.16')]
 controller.py: broadcasting ...
 controller.py: broadcasted
 Solver 5567 operational
 solver.py 5566: solver step
 solver.py 5567: solver step
 controller.py: checkStatus
 solver.py 5566: remote_status
 Solver 5566 operational
 solver.py 5567: remote_status
 controller.py: step 3 results: [(True, 'Solver 5567, step 3, result: 847386.43'), (True, 'Solver 5566, step 3, result: 512120.15')]
 controller.py: terminate
 Solver 5567 operational
 solver.py 5566: remote_terminate
 solver.py 5567: remote_terminate
</pre><br><br><br><br>  <a href="http://www.saltycrane.com/blog/2008/09/notes-parallel-processing-python-and-twisted/">Original</a> </div><p>Source: <a href="https://habr.com/ru/post/97201/">https://habr.com/ru/post/97201/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../97193/index.html">How to teach Windows Search to look for information in pictures</a></li>
<li><a href="../97194/index.html">The graphic style of the 1972 Olympics in Munich</a></li>
<li><a href="../97195/index.html">About faith</a></li>
<li><a href="../97196/index.html">FAR manager - old friend is better than new two</a></li>
<li><a href="../97197/index.html">How long has Gmail become paranoid?</a></li>
<li><a href="../97203/index.html">Can information be someone's private property?</a></li>
<li><a href="../97204/index.html">Mac Media Center - or how to easily turn a Mac into your personal entertainment center</a></li>
<li><a href="../97205/index.html">AlterGeo geolocation with refreshing bonuses</a></li>
<li><a href="../97208/index.html">Your profession and attitude to copyright</a></li>
<li><a href="../97210/index.html">Evolution of the CMS rating methodology</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>