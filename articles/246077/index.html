<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Ruby and Postgis Time Zone Service</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In one of the projects in which I participated, the task arose of determining the time zone by the current geolocation of the user. On the backend cam...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Ruby and Postgis Time Zone Service</h1><div class="post__text post__text-html js-mediator-article">  In one of the projects in which I participated, the task arose of determining the time zone by the current geolocation of the user.  On the backend came a record created by the user using a smartphone.  The time did not come in UTC, but the parameters contained coordinates. <br>  Of course, there are ready-made services (for example, The Google Time Zone), but they are all paid or very limited in functionality.  So I decided to write my own service. <br><a name="habracut"></a><br>  Service should be as simple as possible.  On it we need to do only one request of a type. <br><pre><code class="bash hljs">http://host/timezone/name?lat=55.2341&amp;lng=43.23352</code> </pre> <br>  Where lat is latitude and lng is longitude. <br><br>  <b>We are setting up a database</b> <br><br>  We will use <a href="http://www.postgresql.org/">PostgreSQL as the database</a> .  We will also need the Postgis extension, specially sharpened for working with geographic objects. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      We assume that PostgreSQL is already installed.  If not, there are many guides and tutorials on the Internet, how to do this.  The installation process for Postgis should also be easy - the official site has detailed instructions for most popular operating systems. <br><br>  After installing all the necessary, create a new database, which we will use to determine the time zone.  As an example, I will write ‚Äútz_service‚Äù: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DATABASE</span></span> tz_service</code> </pre><br>  We include Postgis in our database: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> EXTENSION postgis; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> EXTENSION postgis_topology; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> EXTENSION fuzzystrmatch; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> EXTENSION postgis_tiger_geocoder;</code> </pre><br>  Now we need the shapefile of all time zones from <a href="http://efele.net/maps/tz/world/">efele.net</a> .  Download tz_world.zip.  The archive file is tz_world.shp.  Shape files contain a vector representation of geographic data.  But we need to convert it to a SQL dump and roll it into our tz_service database: <br><pre> <code class="bash hljs">$ /usr/lib/postgresql/9.1/bin/shp2pgsql -D tz_world.shp &gt; dump.sql $ psql -d tz_service -f dump.sql</code> </pre><br>  Done!  Check job request: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> tzid <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> tz_world <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> ST_Contains(the_geom, ST_MakePoint(<span class="hljs-number"><span class="hljs-number">-122.420706</span></span>, <span class="hljs-number"><span class="hljs-number">37.776685</span></span>));</code> </pre><br>  It should get something like this: <br><pre> <code class="sql hljs">tzid <span class="hljs-comment"><span class="hljs-comment">--------------------- America/Los_Angeles (1 ROW)</span></span></code> </pre><br>  <b>Writing Sevris in Ruby</b> <br><br>  We will use the <a href="https://github.com/intridea/grape">Grape</a> framework as the framework for the service.  It is great for quickly writing REST-like server applications. <br>  First, create a Gemfile and write down the gems we need: <br><pre> <code class="ruby hljs">source <span class="hljs-string"><span class="hljs-string">"https://rubygems.org"</span></span> gem <span class="hljs-string"><span class="hljs-string">'rake'</span></span> gem <span class="hljs-string"><span class="hljs-string">'activerecord'</span></span> gem <span class="hljs-string"><span class="hljs-string">'pg'</span></span> gem <span class="hljs-string"><span class="hljs-string">'grape'</span></span> group <span class="hljs-symbol"><span class="hljs-symbol">:development</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">:test</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> gem <span class="hljs-string"><span class="hljs-string">'shotgun'</span></span> gem <span class="hljs-string"><span class="hljs-string">'byebug'</span></span> gem <span class="hljs-string"><span class="hljs-string">'pry'</span></span> gem <span class="hljs-string"><span class="hljs-string">'pry-byebug'</span></span> gem <span class="hljs-string"><span class="hljs-string">'rspec'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre><br>  What is in the development group and test is necessary only for development and will not be used in production mode.  And you need not so much to develop: <br>  - shotgun in order not to restart the server every time, after the next code change <br>  - buebug and pry for debugging <br>  - rspec for tests <br><br>  Install all gems with dependencies: <br><pre> <code class="bash hljs">$ bundle install</code> </pre><br>  The project tree should look like this: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/6a6/eff/ada/6a6effadae8735c2e4f4e13f3b66cc97.png" alt="image"><br><br>  Let's go in order.  Let's start with configs. <br><br>  The config / database.yml will contain information for connecting to the database: <br><pre> <code class="ruby hljs"><span class="hljs-symbol"><span class="hljs-symbol">development:</span></span> &amp;config <span class="hljs-symbol"><span class="hljs-symbol">adapter:</span></span> postgresql <span class="hljs-symbol"><span class="hljs-symbol">host:</span></span> localhost <span class="hljs-symbol"><span class="hljs-symbol">username:</span></span> user <span class="hljs-symbol"><span class="hljs-symbol">password:</span></span> password <span class="hljs-symbol"><span class="hljs-symbol">database:</span></span> tz_service <span class="hljs-symbol"><span class="hljs-symbol">encoding:</span></span> utf8 <span class="hljs-symbol"><span class="hljs-symbol">test:</span></span> &lt;&lt;: *config <span class="hljs-symbol"><span class="hljs-symbol">poduction:</span></span> &lt;&lt;: *config</code> </pre><br>  Next we set the database configuration class config / configuration.rb for parsing the yaml file: <br><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Configuration</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DB_CONFIG</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">YAML</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">load_file</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">File</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">expand_path</span></span></span><span class="hljs-class">('../</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">database</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">yml</span></span></span><span class="hljs-class">', </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">__FILE__</span></span></span><span class="hljs-class">))[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ENV</span></span></span><span class="hljs-class">['</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RACK_ENV</span></span></span><span class="hljs-class">']] </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> &lt;&lt; self </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">adapter</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DB_CONFIG</span></span></span><span class="hljs-class">['</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">adapter</span></span></span><span class="hljs-class">'] </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">host</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DB_CONFIG</span></span></span><span class="hljs-class">['</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">host</span></span></span><span class="hljs-class">'] </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">username</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DB_CONFIG</span></span></span><span class="hljs-class">['</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">username</span></span></span><span class="hljs-class">'] </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">password</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DB_CONFIG</span></span></span><span class="hljs-class">['</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">password</span></span></span><span class="hljs-class">'] </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">database</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DB_CONFIG</span></span></span><span class="hljs-class">['</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">database</span></span></span><span class="hljs-class">'] </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">encoding</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DB_CONFIG</span></span></span><span class="hljs-class">['</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">encoding</span></span></span><span class="hljs-class">'] </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span></span></code> </pre><br>  App / environment.rb will contain the environment settings: <br><pre> <code class="ruby hljs"><span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">'bundler'</span></span> Bundler.<span class="hljs-keyword"><span class="hljs-keyword">require</span></span>(<span class="hljs-symbol"><span class="hljs-symbol">:default</span></span>) $: &lt;&lt; File.expand_path(<span class="hljs-string"><span class="hljs-string">'../'</span></span>, __FILE_<span class="hljs-number"><span class="hljs-number">_</span></span>) $: &lt;&lt; File.expand_path(<span class="hljs-string"><span class="hljs-string">'../../'</span></span>, __FILE_<span class="hljs-number"><span class="hljs-number">_</span></span>) $: &lt;&lt; File.expand_path(<span class="hljs-string"><span class="hljs-string">'../../config'</span></span>, __FILE_<span class="hljs-number"><span class="hljs-number">_</span></span>) $: &lt;&lt; File.expand_path(<span class="hljs-string"><span class="hljs-string">'../services'</span></span>, __FILE_<span class="hljs-number"><span class="hljs-number">_</span></span>) ENV[<span class="hljs-string"><span class="hljs-string">'RACK_ENV'</span></span>] <span class="hljs-params"><span class="hljs-params">||</span></span>= <span class="hljs-string"><span class="hljs-string">'development'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">'grape'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">'json'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">'pry'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">'active_record'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">'timezone_name_service'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">'configuration'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">'application'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">'time_zone_api'</span></span></code> </pre><br>  In app / application.rb, let's write the activerecord settings for the connection with the database: <br><pre> <code class="ruby hljs">ActiveRecord::Base.establish_connection( <span class="hljs-symbol"><span class="hljs-symbol">adapter:</span></span> Configuration.adapter, <span class="hljs-symbol"><span class="hljs-symbol">host:</span></span> Configuration.host, <span class="hljs-symbol"><span class="hljs-symbol">database:</span></span> Configuration.database, <span class="hljs-symbol"><span class="hljs-symbol">username:</span></span> Configuration.username, <span class="hljs-symbol"><span class="hljs-symbol">password:</span></span> Configuration.password, <span class="hljs-symbol"><span class="hljs-symbol">encoding:</span></span> Configuration.encoding )</code> </pre><br>  The basis for the service is ready, you only need to write one class of the service itself, which will respond to our request and that's it.  Everything?  Not!  First you need to write tests.  Do not forget about TDD. <br><br>  Create spec / spec_helper.rb and tweak it a bit: <br><pre> <code class="ruby hljs">ENV[<span class="hljs-string"><span class="hljs-string">'RACK_ENV'</span></span>] <span class="hljs-params"><span class="hljs-params">||</span></span>= <span class="hljs-string"><span class="hljs-string">'test'</span></span> require_relative <span class="hljs-string"><span class="hljs-string">'../app/environment'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">'rack/test'</span></span> RSpec.configure <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-params"><span class="hljs-params">|config|</span></span> config.treat_symbols_as_metadata_keys_with_true_values = <span class="hljs-literal"><span class="hljs-literal">true</span></span> config.run_all_when_everything_filtered = <span class="hljs-literal"><span class="hljs-literal">true</span></span> config.filter_run <span class="hljs-symbol"><span class="hljs-symbol">:focus</span></span> config.order = <span class="hljs-string"><span class="hljs-string">'random'</span></span> config.<span class="hljs-keyword"><span class="hljs-keyword">include</span></span> Rack::Test::Methods <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">app</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TimeZoneAPI</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">end</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">end</span></span></span></span></code> </pre><br>  In tests, we must describe the behavior of the service  And we expect only two things: <br>  1. Adequate response with adequate parameters in the request <br>  2. Error in the absence of parameters <br>  We describe this: <br><pre> <code class="ruby hljs">describe <span class="hljs-string"><span class="hljs-string">'API'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> let(<span class="hljs-symbol"><span class="hljs-symbol">:params</span></span>) { { <span class="hljs-symbol"><span class="hljs-symbol">lat:</span></span> <span class="hljs-number"><span class="hljs-number">55.7914056</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">lng:</span></span> <span class="hljs-number"><span class="hljs-number">49.1120427</span></span> } } <span class="hljs-comment"><span class="hljs-comment">#    let(:error) { { error: 'lat is missing, lng is missing' } } #      let(:name_response) { { timezone: 'Europe/Moscow' } } #     #  it 'should greet us' do get '/' expect(last_response).to be_ok expect(last_response.body).to eq(%Q{"Welcome to Time Zone API Service"}) end #      describe 'Timezone name' do subject { last_response } #     context 'with wrong params' do before do get '/timezone/name' end its(:status) {should eq 400} its(:body) {should eq error.to_json} end context 'with right params' do before do get '/timezone/name', params end its(:status) {should eq 200} its(:body) {should eq name_response.to_json} end end end</span></span></code> </pre><br>  Running the command: <br><pre> <code class="bash hljs">$ bundle <span class="hljs-built_in"><span class="hljs-built_in">exec</span></span> rspec</code> </pre><br>  No test will pass.  Still =) It is necessary to gilt the tests. <br>  We will need to contact the database with a non-standard query.  We will do this through the app / services / time_zone_service.rb class: <br><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TimezoneNameService</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">initialize</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">lat</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">lng</span></span></span><span class="hljs-class">) @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">lat</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">lat</span></span></span><span class="hljs-class"> @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">lng</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">lng</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">name</span></span></span><span class="hljs-class"> </span><span class="hljs-comment"><span class="hljs-class"><span class="hljs-comment">#"" .    ,        sql = "SELECT tzid FROM tz_world WHERE ST_Contains(geom, ST_MakePoint(#{ActiveRecord::Base.sanitize(</span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@lng</span></span></span></span><span class="hljs-class"><span class="hljs-comment">)}, #{ActiveRecord::Base.sanitize(</span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@lat</span></span></span></span><span class="hljs-class"><span class="hljs-comment">)}));" name_hash = ActiveRecord::Base.connection.execute(sql).first name_hash['tzid'] rescue nil end end</span></span></span></span></code> </pre><br>  And finally, the main service class app / time_zone_api.rb: <br><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TimeZoneAPI</span></span></span><span class="hljs-class"> &lt; Grape::API </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">format</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">json</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">default_format</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">json</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">default_error_formatter</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">txt</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">desc</span></span></span><span class="hljs-class"> '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Start</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">page</span></span></span><span class="hljs-class">' </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">get</span></span></span><span class="hljs-class"> '/' </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">do</span></span></span><span class="hljs-class"> '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Welcome</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Time</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Zone</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">API</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Service</span></span></span><span class="hljs-class">' </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">namespace</span></span></span><span class="hljs-class"> '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">timezone</span></span></span><span class="hljs-class">' </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">do</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">desc</span></span></span><span class="hljs-class"> '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Time</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">zone</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">name</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">by</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">coordinates</span></span></span><span class="hljs-class">' </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">params</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">do</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">requires</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">lat</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">type</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Float</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">desc</span></span></span><span class="hljs-class">: '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Latitude</span></span></span><span class="hljs-class">' </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">requires</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">lng</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">type</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Float</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">desc</span></span></span><span class="hljs-class">: '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Longitude</span></span></span><span class="hljs-class">' </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-comment"><span class="hljs-class"><span class="hljs-comment">#  get '/name' do name = TimezoneNameService.new(params[:lat], params[:lng]).name { timezone: name } end end end</span></span></span></span></code> </pre><br>  That's all!  Service is ready.  Check his work "live" by running the Grape-application: <br><pre> <code class="bash hljs">$ bundle <span class="hljs-built_in"><span class="hljs-built_in">exec</span></span> rackup</code> </pre><br>  <b>Related Links</b> <br>  <a href="https://github.com/intridea/grape">Grape</a> Framework <br>  <a href="http://postgis.net/">Postgis</a> <br>  Project <a href="https://github.com/lon10/tz-service">ID</a> on <a href="https://github.com/lon10/tz-service">Github</a> </div><p>Source: <a href="https://habr.com/ru/post/246077/">https://habr.com/ru/post/246077/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../246067/index.html">The gaming platform from Viber, Candy Crush on Windows Phone, the game of the year according to Google and Faceebook - and other news of the week for a mobile developer</a></li>
<li><a href="../246069/index.html">6 games in 6 weeks - week one</a></li>
<li><a href="../246071/index.html">Christmas sale</a></li>
<li><a href="../246073/index.html">Xenserver 6.2 installation on soft raid vs HP ProLiant DL160 Gen8</a></li>
<li><a href="../246075/index.html">Updates on vds.menu</a></li>
<li><a href="../246081/index.html">About slow programming</a></li>
<li><a href="../246087/index.html">.NEXT in Moscow: how hardcore .NET-conference conquered the capital</a></li>
<li><a href="../246089/index.html">Creating Bluetooth profiles in the BLE TI stack</a></li>
<li><a href="../246091/index.html">Working groups in OpenCL 2.0. Heterogeneous working groups</a></li>
<li><a href="../246093/index.html">Hacker's guide to neural networks. Schemes of real values. Patterns in the "reverse" stream. Example "One neuron"</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>