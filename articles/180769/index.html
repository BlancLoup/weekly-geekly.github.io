<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>IIS 7: JSON Response Compression</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="A few days ago, my friend noticed that his large JSON responses (about 0.5-1 megabytes) were not packed. Working bundle Windows 2008 R2 + IIS 7.5 + AS...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>IIS 7: JSON Response Compression</h1><div class="post__text post__text-html js-mediator-article">  A few days ago, my friend noticed that his large JSON responses (about 0.5-1 megabytes) were not packed.  Working bundle Windows 2008 R2 + IIS 7.5 + ASP.NET MVC 4. The problem is indicated, the search for a solution has begun.  To reproduce our actions, for the article I wrote a separate application. <br><a name="habracut"></a><br>  Action method <br><br><pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> ActionResult </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Index</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Request.IsAjaxRequest()) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Json(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> {<span class="hljs-comment"><span class="hljs-comment">/*  */</span></span>}, JsonRequestBehavior.AllowGet); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(); }</code> </pre> <br>  Representation <br><br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://ajax.aspnetcdn.com/ajax/jquery/jquery-1.9.0.js"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text/javascript"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="javascript"><span class="javascript"> jQuery(</span><span class="hljs-function"><span class="hljs-keyword"><span class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span></span><span class="javascript"><span class="hljs-function"> (</span></span><span class="hljs-params"><span class="javascript"><span class="hljs-function"><span class="hljs-params">$</span></span></span></span><span class="javascript"><span class="hljs-function">) </span></span></span><span class="javascript">{ $.ajax({ </span><span class="hljs-attr"><span class="javascript"><span class="hljs-attr">url</span></span></span><span class="javascript">: </span><span class="hljs-string"><span class="javascript"><span class="hljs-string">'@Url.Action("Index")'</span></span></span><span class="javascript"> }); }) </span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  The first thing checked was HTTP headers. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/storage2/ebe/505/841/ebe50584117aa2d10d939c96a6ae1482.png"><br><br>  From the screenshot you can see that the <code>X-Requested-With: XMLHttpRequest</code> ajax request is coming and the browser reports that it understands gzip or deflate with the <code>Accept-Encoding: gzip, deflate</code> header, to which the server responds with json <code>Content-Type: application/json</code> , but no compression, because there is no <code>Content-Encoding</code> header. <br><br>  Next went check on the installed modules of the web server Administrative Tools -&gt; Server Manager -&gt; Roles -&gt; IIS <br><br><img src="https://habrastorage.org/storage2/232/db9/c74/232db9c7442762bc678f96fa760d9a4b.png"><br><br>  Static / Dynamic Content Comprassion installed.  (I want to pay attention, for Windows 7 installation is carried out through addition / removal of components). <br>  Next, we check if compression is enabled for the application on IIS. <br><br><img src="https://habrastorage.org/storage2/5a8/bbb/c3e/5a8bbbc3e51db3cb2906d6c6a9710861.png"><br><br><img src="https://habrastorage.org/storage2/52a/8ea/beb/52a8eabeb6362ada7b02e47bd9e78132.png"><br><br>  If not, then tick and apply the changes.  Allow compression is also possible via <code>web.config</code> <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">system.webServer</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">urlCompression</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">doStaticCompression</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">doDynamicCompression</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">system.webServer</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  or Configuration Editor -&gt; system.webServer -&gt; urlCompression <br><br><img src="https://habrastorage.org/storage2/676/e08/f26/676e08f26a8051a28770f8d9f55c31dc.png"><br><br><img src="https://habrastorage.org/storage2/f81/2d9/e15/f812d9e159d4d7083e69cb6cf716b6ca.png"><br><br><img src="https://habrastorage.org/storage2/a2a/e2c/b72/a2ae2cb72936967ce7ebe80ec5501cec.png"><br><br>  It seems that everything is already in order, but IIS did not give up <code>Content-Encoding</code> in the response header, and does not. <br><br>  In the course went <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">system.webServer</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">httpCompression</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dynamicTypes</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">add</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">mimeType</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"application/json"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">enabled</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">add</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">mimeType</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"application/json; charset=utf-8"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">enabled</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dynamicTypes</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">httpCompression</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">system.webServer</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  and, cheers, victory, we get the long-awaited <code>Content-Encoding: gzip</code> .  But there is one very big BUT.  <code>httpCompression</code> section can only be defined in <code>applicationhost.config</code> .  And this means that either you are an IIS administrator, or this option does not suit you (unless, of course, you convince your hoster of the opposite). <br><br>  Suppose that the option found does not suit you, but you still need to compress the answer.  What we have by default in the settings of dynamic compression. <br><br><img src="https://habrastorage.org/storage2/a44/19a/809/a4419a8097dca46f5a40ae71baba20f5.png"><br><br>  Compression will be extended, for example, to <code>text/javascript</code> .  Of course, this is more like a hack, but it's better than nothing. <br><br>  Change our action method to <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> ActionResult </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Index</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Request.IsAjaxRequest()) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> JsonResult() { ContentType = <span class="hljs-string"><span class="hljs-string">"text/javascript"</span></span>, ContentEncoding = Encoding.UTF8, JsonRequestBehavior = JsonRequestBehavior.AllowGet, Data = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> {<span class="hljs-comment"><span class="hljs-comment">/*  */</span></span>} }; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(); }</code> </pre><br>  and when responding using the <code>$.ajax</code> function, we immediately get an error of data parsing.  In other words, we must now use either <code>$.getJSON</code> or explicitly indicate that we are expecting <code>json</code> . <br><br>  Representation <br><br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://ajax.aspnetcdn.com/ajax/jquery/jquery-1.9.0.js"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text/javascript"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="javascript"><span class="javascript"> jQuery(</span><span class="hljs-function"><span class="hljs-keyword"><span class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span></span><span class="javascript"><span class="hljs-function"> (</span></span><span class="hljs-params"><span class="javascript"><span class="hljs-function"><span class="hljs-params">$</span></span></span></span><span class="javascript"><span class="hljs-function">) </span></span></span><span class="javascript">{ $.ajax({ </span><span class="hljs-attr"><span class="javascript"><span class="hljs-attr">url</span></span></span><span class="javascript">: </span><span class="hljs-string"><span class="javascript"><span class="hljs-string">'@Url.Action("Index")'</span></span></span><span class="javascript">, </span><span class="hljs-attr"><span class="javascript"><span class="hljs-attr">dataType</span></span></span><span class="javascript">: </span><span class="hljs-string"><span class="javascript"><span class="hljs-string">'json'</span></span></span><span class="javascript">, }); }) </span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  And the third solution, which appeared, but did not fit those tasks (this does not mean that it is not worthy of attention) - to pack it yourself. <br><br>  I give an example from the <a href="http://stackoverflow.com/questions/3802107/how-to-gzip-content-in-asp-net-mvc">stack</a> , with which I fully agree <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">CompressAttribute</span></span> : <span class="hljs-title"><span class="hljs-title">ActionFilterAttribute</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnActionExecuting</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ActionExecutingContext filterContext</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> encodingsAccepted = filterContext.HttpContext.Request.Headers[<span class="hljs-string"><span class="hljs-string">"Accept-Encoding"</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrEmpty(encodingsAccepted)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; encodingsAccepted = encodingsAccepted.ToLowerInvariant(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> response = filterContext.HttpContext.Response; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (encodingsAccepted.Contains(<span class="hljs-string"><span class="hljs-string">"deflate"</span></span>)) { response.AppendHeader(<span class="hljs-string"><span class="hljs-string">"Content-encoding"</span></span>, <span class="hljs-string"><span class="hljs-string">"deflate"</span></span>); response.Filter = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DeflateStream(response.Filter, CompressionMode.Compress); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (encodingsAccepted.Contains(<span class="hljs-string"><span class="hljs-string">"gzip"</span></span>)) { response.AppendHeader(<span class="hljs-string"><span class="hljs-string">"Content-encoding"</span></span>, <span class="hljs-string"><span class="hljs-string">"gzip"</span></span>); response.Filter = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> GZipStream(response.Filter, CompressionMode.Compress); } } }</code> </pre><br><h4>  Compression ratio </h4><br>  While playing with the above, another interesting thing was noticed, the compressed content in Fiddler was unpacked and repacked by the same fidler again, the compression of the fidler by eye was ~ 10-20% less bytes.  How to find the settings for the degree of compression for IIS, I'll never know.  Not counting the third option, in which you can use the parameter constructors <code>CompressionLevel</code> .  Maybe one of you will tell?  I consider this moment important for me, because depending on the project, the volume of transmitted traffic is sometimes important, and sometimes, on the contrary, processor time. <br><br>  I would be glad to hear more solutions to the problem, no matter how insane the ideas at first glance seem. </div><p>Source: <a href="https://habr.com/ru/post/180769/">https://habr.com/ru/post/180769/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../180757/index.html">University of Maryland Ornithopter can do back flips and misleads birds of prey</a></li>
<li><a href="../180759/index.html">Making radio control for the aircraft</a></li>
<li><a href="../180761/index.html">What is Slow Protocols</a></li>
<li><a href="../180763/index.html">FlexPod: Cloupia Unified Infrastructure Controller (CUIC) - New Acquisition of Cisco</a></li>
<li><a href="../180765/index.html">‚ÄúParlez vous Francais ?!‚Äù Or how to make your application speak many languages</a></li>
<li><a href="../180771/index.html">Summer 2013: Roaming Guide for all mobile operators</a></li>
<li><a href="../180777/index.html">How to make your application fast: profile optimization C ++</a></li>
<li><a href="../180779/index.html">Lessons learned: Year with a big project on AngularJS</a></li>
<li><a href="../180781/index.html">Domain vk.com was included in the unified register of prohibited sites</a></li>
<li><a href="../180787/index.html">The path of a business samurai: the maximum effect for one weekend</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>