<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Simple client and server authorization of an Ajax site user using the VKontakte API</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="For one project, it was necessary to authorize the user on the site using the VKontakte API both on the client side, using the javascript Open API, an...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Simple client and server authorization of an Ajax site user using the VKontakte API</h1><div class="post__text post__text-html js-mediator-article">  For one project, it was necessary to authorize the user on the site using the VKontakte API both on the client side, using the javascript Open API, and on the server side, using PHP. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/ed0/97e/38e/ed097e38ed6e7fab6f12c2e0f4f9cda9.png" alt="Allowing access to the VK API"><br><br>  At first glance, the task is not so interesting, since VKontakte has good documentation with a detailed description of what and how, and even an example of client authorization, plus, there are already a lot of websites with authorization via the VKontakte API. <br><a name="habracut"></a><br>  Let's try to get two lists of the user's friends, one using the server API and the other using the client. <br>  At the same time in practice, let us deal with both variants of the authorization process. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      But first, let's define a task in more detail: <br><ol><li>  We do not want to preload the page once again, and only conduct the entire exchange with the server via Ajax; </li><li>  For the user, the authorization process should cause as few ‚Äúback thoughts‚Äù as possible, that is, everything should be done as comfortably as possible. </li></ol><br><div class="spoiler">  <b class="spoiler_title">Suppose we have the following HTML code</b> <div class="spoiler_text"><pre><code class="html hljs xml"><span class="hljs-meta"><span class="hljs-meta">&lt;!doctype html&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">head</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">meta</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">charset</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"utf-8"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">title</span></span></span><span class="hljs-tag">&gt;</span></span>  <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">title</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">link</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">rel</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"stylesheet"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"style.css"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"script.js"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">head</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">section</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"serverApi"</span></span></span><span class="hljs-tag">&gt;</span></span> API<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">section</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">section</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"clientApi"</span></span></span><span class="hljs-tag">&gt;</span></span> API<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">section</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> </div></div><br><h5>  Client Authorization </h5><br>  There is really nothing difficult with client authorization. <br>  According to the <a href="http://vk.com/dev/openapi">documentation</a> , it is sufficient to load <a href="">openapi.js</a> asynchronously and ‚Äúhang‚Äù <code>VK.init({appid: YOUR_APP_ID})</code> on the <code>window.vkAsyncInit</code> event, after which you can call the <code>VK.Auth.login(authInfo, YOUR_APP_PERMISSIONS)</code> function <code>VK.Auth.login(authInfo, YOUR_APP_PERMISSIONS)</code> , which will execute user authorization. <br><br><div class="spoiler">  <b class="spoiler_title">Authorization and request through the Open API</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> vk = { <span class="hljs-attr"><span class="hljs-attr">data</span></span>: {}, <span class="hljs-attr"><span class="hljs-attr">api</span></span>: <span class="hljs-string"><span class="hljs-string">"//vk.com/js/api/openapi.js"</span></span>, <span class="hljs-attr"><span class="hljs-attr">appID</span></span>: YOUR_APP_ID, <span class="hljs-attr"><span class="hljs-attr">appPermissions</span></span>: YOUR_APP_PERMISSIONS, <span class="hljs-attr"><span class="hljs-attr">init</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{ $.js(vk.api); <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.vkAsyncInit = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{ VK.init({<span class="hljs-attr"><span class="hljs-attr">apiId</span></span>: vk.appID}); load(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">load</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{ VK.Auth.login(authInfo, vk.appPermissions); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">authInfo</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">response</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(response.session){ <span class="hljs-comment"><span class="hljs-comment">//   vk.data.user = response.session.user; vk.getFriends(); }else alert("  !"); } } }, getFriends: function(){ VK.Api.call('friends.get', {fields: ['uid', 'first_name', 'last_name'], order: 'name'}, function(r){ if(r.response){ r = r.response; var ol = $('#clientApi').add('ol'); for(var i = 0; i &lt; r.length; ++i){ var li = ol.add('li').html(r[i].first_name+' '+r[i].last_name+' ('+r[i].uid+')') } }else alert("     "); }) } } $.ready(vk.init);</span></span></code> </pre><br>  First, at once I will make a reservation that the functions <code>$</code> used here are not <code>jQuery</code> .  However, their purpose may not be intuitive, so I will tell you what this or that function does.  Their independent implementation should not be difficult, just like putting all the code on <code>jQuery</code> . <br><br>  So, <br>  <code>$.ready(function)</code> - This is the handler for <code>DOMContentLoaded</code> ; <br>  <code>$.js(text)</code> - asynchronously loads the javascript file; <br>  <code>$(element)</code> - returns a wrapper over the DOM node <code>element</code> ; <br>  <code>$(element).add(node)</code> - creates a new child node for an <code>element</code> node <code>node</code> and returns a wrapper over it; <br>  <code>$(element).html(string)</code> - wrapper for <code>element.innerHTML = string</code> . <br></div></div><br>  In essence, this code does the following: <br>  When the document is ready, the VKontakte API is loaded, and, after its initialization, the <code>VK.Auth.login()</code> method is <code>VK.Auth.login()</code> , which shows a pop-up window <s>that successfully blocks with any banner cutter</s> , in which the user must confirm his consent to provide data to the client application. <br>  The <code>authInfo</code> function <code>authInfo</code> called after the user's consent or disagreement, and, in case of successful authorization, requests a list of friends. <br><br>  The client part can thus be considered complete, however, it is worthwhile to somehow warn users about the possibility of their browser blocking the confirmation window. <br><br><h5>  Server authorization </h5><br>  Server authorization is much more fun.  The server authorization mechanism for access to the VK API from a third-party site is based on the OAuth 2.0 protocol. <br><br>  The authorization process is as follows: <br><ol><li>  It is necessary in the user's browser to show a page where he will allow the application to access his data; </li><li>  After successful authorization of the application, the user's browser will be redirected to the address REDIRECT_URI specified when opening the authorization dialog.  In this case, the code for transmitting the access key will be transmitted in the GET parameter; </li><li>  It is necessary to execute the request with the transfer of the application code and secret data to a special address, in response we will receive the <b>access_token</b> access <b>key</b> that we need to make requests to the API. </li></ol><br>  Unfortunately, the second point, namely, browser redirection, does not always work, more precisely, does not work anywhere except for IE, on that very first time when a user first allows an application to access his data.  And as soon as the developers are not perverted, just to get the coveted code. <br><div class="spoiler">  <b class="spoiler_title">An example of authorization in one well-known music service</b> <div class="spoiler_text"><img src="https://habrastorage.org/getpro/habr/post_images/92d/b3d/ca1/92db3dca12251989fa1140fca93d6fb2.png" alt="Authorization with the help of VK API on one music service"><br>  True, for quite a long time, instead of the ‚ÄúLogin Success‚Äù writing on the page being opened, there is a warning that you don‚Äôt have to do exactly as it is written - you saw this message in the picture at the beginning of the topic. </div></div><br>  In addition, the opening of an additional window is again connected with the danger that it will be blocked. <br><br>  Fortunately, if we know the link to open the window, there are many good ways to open it so that it will not be blocked.  For example, the good old <code>iframe</code> tag is still in the standard HTML format, and it is perfectly suited for our task. <br><br>  First, since we know the address, we can open the frame and show the user a link where you can do everything. <br><br>  Secondly, if a redirect occurs, and a page opens from our domain in the frame, we can get access to the main window from the frame and automatically start the function of closing the frame.  At the same time, the server will already have <b>access_token</b> , which we will save in the session and by performing requests to the server from the main window we will be able to receive replies.  The reloading of the page will not happen at the same time, which completely solves our problem. <br><br>  Thirdly, if the redirection did not occur, and the user manually opened the application's access confirmation page, then there is definitely a redirect to the page from our domain, which will be opened not in the frame, but instead of the main one.  Unfortunately, this is a reboot, but it is a smaller sacrifice than it could be.  From this page, you can send the user back to the main page; the second time, authorization will pass without rebooting. <br><br>  The implementation of the <a href="https://github.com/vladkens/VK">class of access to the VK API by OAuth in PHP</a> can be easily found on the github, which I did (PHP&gt; = 5.4). <br>  (Quite by chance it turned out that this class was most likely written by the hackle <a href="https://habrahabr.ru/users/vladkens/" class="user_link">user vladkens</a> , for which many <a href="https://habrahabr.ru/users/vladkens/" class="user_link">thanks</a> to him) <br><br>  We now turn to the most interesting. <br><div class="spoiler">  <b class="spoiler_title">We implement a server script that will respond to the AJAX requests of our page.</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">require_once</span></span>(<span class="hljs-string"><span class="hljs-string">'vk.php'</span></span>); session_start(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getPostStr</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($data, $default = false)</span></span></span></span>{ <span class="hljs-comment"><span class="hljs-comment">//   -  $_POST[$data] if(!isset($_POST[$data])) return $default; $data = $_POST[$data]; $data = htmlspecialchars(strip_tags(trim($data))); return ($data != "" ? $data : $default); } function error($code, $text, $params = Array()){ $result = Array('error' =&gt; Array('code' =&gt; $code, 'message' =&gt; $text)); if(count($params) &gt; 0) foreach($params as $key =&gt; $value) $result['error'][$key] = $value; die(json_encode($result)); } $vkConf = Array( 'appID' =&gt; YOUR_APP_ID, 'apiSecret' =&gt; YOUR_API_SECRET, 'callbackUrl' =&gt; YOUR_DOMAIN . '/auth.php', 'apiSettings' =&gt; YOUR_APP_PERMISSIONS ); $vk = (isset($_SESSION['accessToken'])) ? new VK($vkConf['appID'], $vkConf['apiSecret'], $_SESSION['accessToken']) : null; function userIn($vk, $vkConf){ //   unset($_SESSION['accessToken']); $vk = new VK($vkConf['appID'], $vkConf['apiSecret']); $authorizeUrl = $vk -&gt; getAuthorizeURL($vkConf['apiSettings'], $vkConf['callbackUrl']); error(-1, "  !", Array('url' =&gt; $authorizeUrl)); } function getFriends($fields, $order, $vk){ //     $userFriends = $vk -&gt; api('friends.get', array('fields' =&gt; $fields, 'order' =&gt; $order)); $result = Array(); foreach($userFriends['response'] as $key =&gt; $value){ $result[] = Array('firstName' =&gt; $value['first_name'], 'lastName' =&gt; $value['last_name'], 'uid' =&gt; $value['uid']); } echo json_encode($result); } $method = strtolower($api -&gt; getStr("method")); switch($method){ case "user.in" : userIn($vk, $vkConf); break; case "friends.get" : getFriends(getPostStr("fields"), getPostStr("order"), $vk); break; default: Api::error(0, "   Api"); } </span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">?&gt;</span></span></span></span></code> </pre></div></div><br>  We will send requests to this page using the POST method, where the parameter <code>method</code> contains the name of the method we want to perform on the server. <br><br>  For successful authorization, we will send a request to <code>user.in</code> when our main page is ready, to which the server will respond with an error code of <code>-1</code> , which we will catch and process. <br>  At the same time, along with the error, the URL of the page on which the user must confirm access to the application will also come, and that is what we will open in the frame. <br><div class="spoiler">  <b class="spoiler_title">Let's add our client script with AJAX processing</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Api</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">method, params, callback</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!params) params = {}; $.ajax($.copy({<span class="hljs-attr"><span class="hljs-attr">method</span></span>: method}, params), <span class="hljs-string"><span class="hljs-string">'server.php'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">r</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(r.error){ <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span>(r.error.code){ <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">-1</span></span>: { <span class="hljs-comment"><span class="hljs-comment">// notAuth var div = $(document.body).add('div').id('authPopup'), iframe = div.add('iframe').attr({src: r.error.url}); div.add('p').html('                 ,   -          .      ,      ,   ').add('a').attr({href: r.error.url}).html(' '); $.splash.open({onclose:function(){ div.remove() }}); } break; default: alert(r.error.code+': '+r.error.message); } }else if(callback) callback(r); }); } $.ready(function(){ Api('user.in'); });</span></span></code> </pre><br>  I will briefly describe the <code>$</code> function: <br>  <code>$.copy(object1, object2)</code> - copies all <code>object2</code> parameters to <code>object2</code> ; <br>  <code>$.ajax(text, addr, callback)</code> - sends a POST request to <code>addr</code> , passing a <code>text</code> message.  It accepts the answer in the form of JSON and transmits it to the <code>callback</code> function; <br>  <code>$(element).id(elemID)</code> - wrapper for <code>element.id = elemID</code> ; <br>  <code>$(element).attr(object)</code> - sets the attributes of the element <code>element</code> tag.  <code>object</code> keys - attribute names, key values ‚Äã‚Äãwill be set as attribute values; <br>  <code>$(element).remove()</code> - removes <code>element</code> ; <br>  <code>$.splash.open(params)</code> - <code>$.splash.open(params)</code> browser window with a translucent dark block.  The <code>params.onclose</code> parameter is a function that will be called upon <code>$.splash.close()</code> . <br></div></div><br>  So, now when loading the document we have a window of client authorization of the application and a frame with the server authorization confirmation page.  Or, instead of the confirmation window in the frame, we see a warning, but for this case we have a link where the user can go and confirm the application permissions. <br><br>  It remains only to make the page on which the redirect is made. <br><div class="spoiler">  <b class="spoiler_title">Confirmation page of server authorization using VK</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">require_once</span></span>(<span class="hljs-string"><span class="hljs-string">'vk.php'</span></span>); session_start(); $vkConf = <span class="hljs-keyword"><span class="hljs-keyword">Array</span></span>( <span class="hljs-string"><span class="hljs-string">'appID'</span></span> =&gt; YOUR_APP_ID, <span class="hljs-string"><span class="hljs-string">'apiSecret'</span></span> =&gt; YOUR_API_SECRET, <span class="hljs-string"><span class="hljs-string">'callbackUrl'</span></span> =&gt; YOUR_DOMAIN . <span class="hljs-string"><span class="hljs-string">'/auth.php'</span></span>, ); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>($_REQUEST[<span class="hljs-string"><span class="hljs-string">'code'</span></span>])){ $vk = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> VK($vkConf[<span class="hljs-string"><span class="hljs-string">'appID'</span></span>], $vkConf[<span class="hljs-string"><span class="hljs-string">'apiSecret'</span></span>]); $accessToken = $vk -&gt; getAccessToken($_REQUEST[<span class="hljs-string"><span class="hljs-string">'code'</span></span>], $vkConf[<span class="hljs-string"><span class="hljs-string">'callbackUrl'</span></span>]); $_SESSION[<span class="hljs-string"><span class="hljs-string">'accessToken'</span></span>] = $accessToken[<span class="hljs-string"><span class="hljs-string">'access_token'</span></span>]; }<span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">die</span></span>(<span class="hljs-string"><span class="hljs-string">'Auth failed'</span></span>); <span class="hljs-meta"><span class="hljs-meta">?&gt;</span></span> &lt;!doctype html&gt; &lt;html&gt; &lt;head&gt; &lt;meta charset=<span class="hljs-string"><span class="hljs-string">"utf-8"</span></span> /&gt; &lt;title&gt;     &lt;/title&gt; &lt;script&gt; $.ready(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(window.top){ window.top.vk.getFriends(); window.top.$.splash.close(); } }) &lt;/script&gt; &lt;/head&gt; &lt;body&gt; &lt;h4&gt; !&lt;/h4&gt; &lt;p&gt;   &lt;a href=<span class="hljs-string"><span class="hljs-string">"YOUR_DOMAIN"</span></span>&gt;  &lt;/a&gt;,   &lt;/p&gt; &lt;/body&gt; &lt;/html&gt;</code> </pre></div></div><br>  Here we simply save <b>access_token</b> into session variables, and the script processing Ajax requests can use it.  In addition, if this page is opened in a frame, we call the method of the main window, which requests the list of friends of VKontakte from the server, and the method that closes the frame. <br><br>  This is the implementation of unobtrusive authorization of the site user through the VKontakte API. <br><div class="spoiler">  <b class="spoiler_title">Screenshot</b> <div class="spoiler_text"><img src="https://habrastorage.org/getpro/habr/post_images/fbb/246/956/fbb2469564385d4b83a2f73c06ed0ac0.png" alt="Result"></div></div><br>  As a homework, try to redirect to the <code>YOUR_DOMAIN</code> page from the confirmation page, if it is not open in the frame, and improve the <code>userIn()</code> method so that if there is an <b>access_token</b> session, its validity is checked and, if the key is valid, it is used instead of the new authorization . </div><p>Source: <a href="https://habr.com/ru/post/188102/">https://habr.com/ru/post/188102/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../188090/index.html">Creating TMG Internet traffic reports based on MS Reporting Services</a></li>
<li><a href="../188092/index.html">Android component from scratch</a></li>
<li><a href="../188094/index.html">Order in the photo and video archives using the technique and a pair of scripts</a></li>
<li><a href="../188096/index.html">Failover Master-Slave Cluster on PostgreSQL</a></li>
<li><a href="../188098/index.html">Relations enikeyschika and people in work</a></li>
<li><a href="../188104/index.html">Configuring WebSVN on Windows for integration into Jira with support for SVN authorization and Delphi source encoding</a></li>
<li><a href="../188106/index.html">Django development server and HTTPS testing</a></li>
<li><a href="../188108/index.html">Articles about a portable Linux server for newbies - are they needed?</a></li>
<li><a href="../188110/index.html">ExtJs as a maven dependency</a></li>
<li><a href="../188114/index.html">A real multi-threaded web server in assembler for Linux</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>