<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How we searched and found a bug in Visual Studio C ++</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="It was a wonderful summer day. Clouds were shining outside the window, crows were singing in gentle voices, someone's car was shaving fun with shampoo...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How we searched and found a bug in Visual Studio C ++</h1><div class="post__text post__text-html js-mediator-article">  It was a wonderful summer day.  Clouds were shining outside the window, crows were singing in gentle voices, someone's car was shaving fun with shampoo on a car wash, a puncher was quietly crouching behind the wall - in general, an idyll. <br><br>  Nothing foreshadowed trouble exactly until I launched the program I just compiled in release mode to check the changes before submitting them to the testing department. <br><br><h3>  Prehistory </h3><br>  We have a company for a relatively long time, and the main product is already older than some of the company's employees, so there is enough ancient code.  Nevertheless, we are trying to keep in a modern way, Modern C ++ is actively used, therefore about a year ago the main project was transferred to VC2015.  It was a separate circus with horses, tambourines, blackjack and valerian.  The secondary code translates as time and desire appear.  In this case, I decided to transfer one of such auxiliary projects to VC2015, which is very actively used by our technical support. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      I was sure that I already knew the pitfalls of such a transition, and that the task would take no more than an hour of work. <br><a name="habracut"></a><br>  Externally, the program is simple: it shows a list of rows taken from different database tables.  When a user selects a row, the column headings of the list change to the column names in the corresponding table. <br><br>  And here I notice that this is not happening. <br><br><h3>  In vivo </h3><br>  I check several times, 100% reproducibility.  I collect the project from scratch, I launch, I check.  Zero to ground. <br><br>  It was strange, because I remember exactly that the columns switched correctly during debugging, it was part of the test case.  In order to make sure of my own responsibility, I launch the Debug version and see that the columns are switching.  Also make sure that the error appears as soon as I turn on any optimization. <br><br>  What a beautiful day. <br><br>  The header update feature itself is pretty simple.  At first, it considers some condition, and then something like this works: <br><pre><code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> flag = !application-&gt;settings.showsize; <span class="hljs-comment"><span class="hljs-comment">// showsize   BYTE int first = columnData - flag; int last = ALL_COLUMNS - flag; if (condition) { for (int i = first; i &lt; last; i++) { listctrl.SetColumn(i, "- "); } } else { for (int i = first; i &lt; last; i++) { listctrl.SetColumn(i, "-  "); } }</span></span></code> </pre> <br>  Please do not throw uranium slippers, I have already said that the code is quite old. <br><br>  Thus, in any case, at least something, but it had to happen.  Moreover, the debugger, getting to this code, simply jumps to the end of the function.  I open the disassembler and see that this whole piece of code (and a dozen more lines before it) is simply missing in the listing.  Of course, the optimized code sometimes looks more abruptly than any spaghetti, and even felt boots.  But in this case, nowhere from the very beginning of the function is there even a hint of any transitions anywhere else.  In the listing you can see the calculation of the condition, and immediately after it - the exit. <br><br>  I begin to understand that the error is much more interesting than it seemed at the beginning, and the call of our specialist, who in the company is dealing with situations like ‚Äúany unknown crap‚Äù, and who don‚Äôt feed with dinner - let me find some bug in Windows.  We don‚Äôt have any illusions on the topic ‚Äúthere are no errors in compilers‚Äù, but experience suggests that 99.99% of ‚Äúerrors in compilers‚Äù are reduced to the wry hands of software developers. <br><br><h3>  In vitro </h3><br>  When an error occurs only in the optimized code, it may mean that we have stumbled upon an unknown UB somewhere, and the first candidate is the string <pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> flag = !application-&gt;settings.showsize;</code> </pre>  It quickly turns out that the problem is really somewhere here, but "not everything is so simple."  It was necessary to replace the expression with a constant, another variable, put the ternary operator instead of negation, or at least put the structure on the stack, as the code magically appeared in the listing. <br><br>  In the absence of the best ideas, we pull out this function into a separate clean project and ruthlessly throw out all unnecessary.  We immediately find out that shamanism with structures and pointers can be replaced with regular volatile: <br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;stdio.h&gt; int main() { volatile int someVar = 1; const int indexOffset = someVar ? 0 : 1; //   // const int indexOffset = !someVar; //   // const int indexOffset = 0; //   // const int indexOffset = 1; //   // const int indexOffset = someVar; //   // const int indexOffset = someVar + 1; //   for (int i = 1 - indexOffset; i &lt; 2 - indexOffset; ++i) { printf("Test passed\n"); } return 1; }</span></span></span></span></code> </pre> <br>  We were surprised a lot here, because in the original code the replacement of the negation by the ternary operator in the string <pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> flag = !application-&gt;settings.showsize;</code> </pre>  returned a piece of code in place, but for volatile it no longer worked. <br><br>  There was almost no doubt that we stumbled upon an error in the compiler, but it seemed incredible that there was no similar piece in tens of megabytes of code. <br><br><h3>  Investigation </h3><br>  It is worth noting that the main program is now going to vs2015 Update 2, because the program compiled in Update 3 suddenly became an antivirus curse, and that one that we install to our customers, and it could turn out ... ugly.  However, some developers, including me, have Update 3 installed. We checked on several different computers and VS versions, and it turned out that the error was present only in Update 3. Later it turned out that it was more correct to write "starting from Update 3." <br><br>  Google made it clear that he was not in the business, so the next logical step was to write <br>  <a href="https://stackoverflow.com/questions/44702943/visual-studio-2015-update-3-c-compiler-bug">question</a> on stackoverflow.  I must say, to send a question to StackOverflow, starting with the phrase ‚ÄúWe have found a mistake in the compiler‚Äù - it's like cutting your hand and jumping into the pool with sharks, but in this case the sharks turned out to be full and friendly.  Literally in a few minutes, the test example was simplified even more, suggested a <a href="https://godbolt.org/">tool</a> that allowed you to see the result of the translation of this code by different compilers, and, more importantly, the magic phrase ‚Äú <b>new SSA optimizer introduced in VS2015 Update 3</b> ‚Äù was <b>heard</b> .  The magic key -d2SSAOptimizer- was also mentioned there, disabling the new optimizer. <br><br>  At this time, googling led us to <a href="https://blogs.msdn.microsoft.com/vcblog/2016/05/04/new-code-optimizer/">Introducing a new, advanced Visual C ++ code optimizer</a> developer from the Visual C ++ Optimizer team with its coordinates and offering to send him error messages, which we used.  And literally in 10-15 minutes we received the following answer: <br><blockquote>  Yes, this is definitely an error in the SSA-optimizer itself - usually most of the errors that are reported to us as optimizer errors are in other places and sometimes manifest themselves after 20 years just now. <br><br>  A bug in a small optimization that tries to remove comparisons of the form (a - Const1) of a CMP (a - Const2) if no overflow occurs.  The error occurs due to the fact that in your code there is an expression (1 - indexOffset) CMP (2 - indexOffset), and although the subtraction, of course, is noncommutative, the optimizer does not take this into account and processes (1 - indexOffset), as if ( indexOffset - 1). <br><br>  A fix for this bug will be published in the next big update for VS2017.  Until that time, a good solution could be to disable the SSA-optimizer for this function, if it does not cause a strong deceleration.  This can be done using #pragma optimize ("", off): <a href="https://msdn.microsoft.com/en-us/library/chh3fb0k.aspx">msdn.microsoft.com/en-us/library/chh3fb0k.aspx</a> <div class="spoiler">  <b class="spoiler_title">Original</b> <div class="spoiler_text">  Yes, it‚Äôs usually the bugs that have been exposed. <br><br>  It's in a small opt.  that if you are not overflow, CMP (a - Const2), if there is no overflow.  (1 - indexOffset) CMP (2 - indexOffset) and the subtraction is not commutative, of course - but the optimizer has the same code as it‚Äôs (indexOffset - 1). <br><br>  For update on VS2017.  Until then, disabling the SSA Optimizer would be a decent workaround.  It doesn‚Äôt slow down things too much.  This can be done with #pragma optimize ("", off): <a href="https://msdn.microsoft.com/en-us/library/chh3fb0k.aspx">msdn.microsoft.com/en-us/library/chh3fb0k.aspx</a> </div></div></blockquote><br><h3>  Epilogue </h3><br>  As the investigation showed, at the moment all VC ++ compilers are subject to this error, starting with version 2015 Update 3 and ending with the most modern versions.  It is not known yet when the fix will be released, so if you find that pieces of code miraculously disappear from your program, check, maybe the new optimizer decided that it needed it more than you? <br><br>  It is somewhat disappointing that the fix will be released only for VS2017, however, we now know what to do about it. <br><br>  What a wonderful day! <br><br>  Thanks to <a href="https://stackoverflow.com/users/147805/codeguard">Codeguard</a> for helping <a href="https://stackoverflow.com/users/147805/codeguard">me</a> find this error. </div><p>Source: <a href="https://habr.com/ru/post/333442/">https://habr.com/ru/post/333442/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../333426/index.html">Exact calculation of averages and covariances by the Welford method</a></li>
<li><a href="../333428/index.html">Is it possible to leave Klintsy? (data mining of blablacar.ru)</a></li>
<li><a href="../333432/index.html">Atlassian certification: how to get a crust from Atlassian that you're cool</a></li>
<li><a href="../333436/index.html">The digest of interesting materials for the mobile developer # 212 (July 10 - July 16)</a></li>
<li><a href="../333440/index.html">The recommendation of the first track for streaming. Lecture in Yandex</a></li>
<li><a href="../333444/index.html">Pygest # 13. Releases, articles, interesting projects from the world of Python [July 4, 2017 - July 17, 2017]</a></li>
<li><a href="../333446/index.html">‚ÄúYour next step to the blockchain‚Äù: release of the Exonum platform from Bitfury Group</a></li>
<li><a href="../333448/index.html">Another breakpad server. Part 1</a></li>
<li><a href="../333454/index.html">The digest of fresh materials from the world of the frontend for the last week ‚Ññ271 (July 10 - 16, 2017)</a></li>
<li><a href="../333456/index.html">The last mile or how to pass the finished site to the client</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>