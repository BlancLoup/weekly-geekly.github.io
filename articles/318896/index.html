<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Truly live code reload in golang</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="If you are developing web applications on go, then this article may be of interest to you. Before switching to go, I mostly programmed in PHP and I al...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Truly live code reload in golang</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/74f/d25/730/74fd257305d14a4d94fe2e70eb68dc5d.png" align="left">  If you are developing web applications on go, then this article may be of interest to you.  Before switching to go, I mostly programmed in PHP and I always liked the fact that you can save the file, reload the page and see the result, which is already generated by the new code.  Large programs on go can be compiled for several tens of seconds, which is very fast, but still noticeable.  Is it possible to make an analogue of Java hotswap (replacing the method body at runtime), because Go compiles into native code?  The answer is yes, perhaps, but only for development.  At the moment I do not know about the ready-made tools that would allow to automate it.  In this article, I would like to demonstrate the live- <a href="https://tip.golang.org/pkg/plugin/">restoring</a> proof-of-concept using the <a href="https://tip.golang.org/pkg/plugin/">plugin</a> package <a href="https://tip.golang.org/pkg/plugin/">in go1.8beta2</a> and the <a href="https://github.com/bouk/monkey">github.com/bouk/monkey</a> package.  An inquisitive reader probably already guesses what we will do. <br><a name="habracut"></a><br><h3>  Training </h3><br>  So, before starting, we need: <br><br><ol><li>  <a href="">go1.8beta2 or newer</a> </li><li>  Linux (in go1.9 should work in macOS) </li><li>  Package github.com/bouk/monkey </li></ol><br><h3>  main idea </h3><br>  For go there is a library for monkey patching'a code, which allows you to replace the body of functions and methods "on the fly" called <a href="https://github.com/bouk/monkey">monkey</a> .  It works by rewriting the body of the function and inserting its code there.  Read more in English about the implementation can be read here: <a href="http://bouk.co/blog/monkey-patching-in-go/">bouk.co/blog/monkey-patching-in-go</a> .  In order for this library to work correctly, the project must be built with the inlining code disabled: ‚Äúgo build -gcflags = -l‚Äù.  This library suits us, but there is a problem: where can I get a pointer to a method with a new code instead of the old one? <br><br><h3>  Plugins in go1.8 </h3><br>  In the version go1.8, the plugin mechanism will appear - the ability to compile the go code as a .so file that can be dynamically loaded into an already running application and start using it.  You can read more about it here: <a href="https://tip.golang.org/pkg/plugin/">tip.golang.org/pkg/plugin</a> .  The plugin is built with dynamic linking and may differ slightly in how it works, from the usual go code.  However, as a rule, there are no differences in the work. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h3>  Putting it all together </h3><br>  Create a web server with two packages: main and handlers (import omitted for brevity). <br><br><pre><code class="hljs perl">//  main.go <span class="hljs-keyword"><span class="hljs-keyword">package</span></span> main func main() { http.HandleFunc(<span class="hljs-string"><span class="hljs-string">"/example"</span></span>, handlers.Example) http.HandleFunc(<span class="hljs-string"><span class="hljs-string">"/reload"</span></span>, handlers.Reload) http.ListenAndServe(<span class="hljs-string"><span class="hljs-string">":9999"</span></span>, nil) } //  handlers/example.go <span class="hljs-keyword"><span class="hljs-keyword">package</span></span> handlers func Example(rw http.ResponseWriter, req *http.Request) { req.ParseForm() fmt.Fprintf(rw, <span class="hljs-string"><span class="hljs-string">"Hello, %s!"</span></span>, req.Form.Get(<span class="hljs-string"><span class="hljs-string">"name"</span></span>)) } func Reload(rw http.ResponseWriter, req *http.Request) { p, <span class="hljs-number"><span class="hljs-number">_</span></span> := plugin.Open(<span class="hljs-string"><span class="hljs-string">"handlers.so"</span></span>) sym, <span class="hljs-number"><span class="hljs-number">_</span></span> := p.Lookup(<span class="hljs-string"><span class="hljs-string">"Example"</span></span>) monkey.Patch(Example, sym) }</code> </pre> <br>  Run this web server and check that it works: <br><br><pre> <code class="bash hljs">$ curl <span class="hljs-string"><span class="hljs-string">'http://localhost:9999/example?name=Yuriy'</span></span> Hello, Yuriy!</code> </pre><br>  Create another package where we put the plugin (the location of the directory does not matter, in the example I will put this file in handlers / plug / main.go): <br><br><pre> <code class="hljs go"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> main <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ( <span class="hljs-string"><span class="hljs-string">"fmt"</span></span> <span class="hljs-string"><span class="hljs-string">"net/http"</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-string"><span class="hljs-string">"C"</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Example</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(rw http.ResponseWriter, req *http.Request)</span></span></span></span> { req.ParseForm() fmt.Fprintf(rw, <span class="hljs-string"><span class="hljs-string">"Hello modified, %s!"</span></span>, req.Form.Get(<span class="hljs-string"><span class="hljs-string">"name"</span></span>)) }</code> </pre><br>  Note the <code>import "C"</code> , which was not in the original package.  This import is needed for the correct operation of the plugin. <br><br>  Build this plugin with the following command: <br><br><pre> <code class="bash hljs">$ go build -buildmode plugin -o handlers.so</code> </pre><br>  The file handlers.so needs to be placed in the directory from which you started the web server, since the relative path to handlers.so is specified in the function handlers.Reload. <br><br>  Now let's try hot-swap the code: <br><br><pre> <code class="hljs scala">$ curl <span class="hljs-symbol"><span class="hljs-symbol">'http</span></span>:<span class="hljs-comment"><span class="hljs-comment">//localhost:9999/reload'</span></span></code> </pre><br>  If there were no errors in the web server log, then everything went well and you can check that the code has been updated: <br><br><pre> <code class="hljs scala">$ curl <span class="hljs-symbol"><span class="hljs-symbol">'http</span></span>:<span class="hljs-comment"><span class="hljs-comment">//localhost:9999/example?name=Yuriy' Hello modified, Yuriy!</span></span></code> </pre><br><h3>  Conclusion </h3><br>  I posted the full example code on github: <a href="https://github.com/YuriyNasretdinov/hotreload-example">github.com/YuriyNasretdinov/hotreload-example</a> .  I would like to note that this is only a proof-of-concept and there are a lot of things that would be worth finalizing before you could really use it: <br><br><ol><li>  There is no easy way to patch in this way <i>any</i> function or method ‚Äî you need to have in advance a list of functions that can be passed to monkey.Patch. </li><li>  The collected plugins take as much as the corresponding go program, and in some cases compiling the plug-in can take a comparable amount of time with compiling the entire program.  It's hard to do something about it, except by reducing the connectivity in the application. </li><li>  monkey.Patch is not thread-safe and in theory can call SEGFAULT in an application. </li></ol><br>  However, I hope you enjoyed this article and learned something new for yourself.  Congratulations to all with the advent of the New Year holidays! </div><p>Source: <a href="https://habr.com/ru/post/318896/">https://habr.com/ru/post/318896/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../318882/index.html">Launch Telegram bot on Android device (Remote Bot for Telegram)</a></li>
<li><a href="../318886/index.html">Comparison of signal recognition methods. Neural networks against matched filter</a></li>
<li><a href="../318890/index.html">The digest of fresh materials from the world of the frontend for the last week ‚Ññ243 (December 26 - January 1, 2017)</a></li>
<li><a href="../318892/index.html">Pebble for lazy programmers</a></li>
<li><a href="../318894/index.html">How fake programmers design</a></li>
<li><a href="../318898/index.html">Simple XML Framework - we write API for working with diagrams DIA</a></li>
<li><a href="../318900/index.html">Sovereign Internet. Why it will not be in 2017</a></li>
<li><a href="../318904/index.html">How I uploaded base in GIT</a></li>
<li><a href="../318906/index.html">How IT professionals work. Anton Karpov, Head of Security at Yandex</a></li>
<li><a href="../318908/index.html">Stretching the OP on the PLO</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>