<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>What to do if lightning strikes your Amazon EC2 Instance?</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="As many know, recently in Ireland one of the data centers of Amazon was de-energized. This has already been told . As I understood from communicating ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>What to do if lightning strikes your Amazon EC2 Instance?</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/c4f/44c/9ff/c4f44c9ff5460a740314d76619d54180.png" align="left">  As many know, recently in Ireland one of the data centers of Amazon was de-energized.  This has already been <a href="http://habrahabr.ru/company/bitrix/blog/125932/">told</a> .  As I understood from communicating with my colleagues, most of the users of Amazon EC2 did get downtime, but I was not lucky - not only did the instances stop, but one of my volume turned into an error state. <br><br>  Everything would be fine (after all, there are snapshots), but here's the bad luck: you cannot disable (detach) EBS volume, if they are connected as root to any instance.  Anyway through the web. <br><br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      And so, you have an instance in the stopped state.  Volume is connected to it with the error status.  You should also receive a letter with apologies and primitive instructions like ‚Äúdo not worry, just connect the recovered snapshot-a volume‚Äù.  But as it turned out, not everything is so simple.  I will give a list of steps that I had to do to restore my instance. <br><br>  Small note: Perhaps for those who are actively working with Amazon EC2, this does not look like a problem.  But for me, which is EC2 related ‚Äúworks?  cool! ‚Äù, it was not so easy to figure out how and what to do.  Therefore, the instruction is more likely for those who are in the same position and does not want to create a new instance simply by deleting the old one. <br><br>  I wrote in support, but they couldn‚Äôt tell anything except for sympathetic advice to use Amazon AMI / API Tools. <br><br>  Even if now "lightning struck" by your server, this does not mean that the next time, too, "blow over". <br><br>  So what I did: <br><br><h3>  1. Recover from Recover snapshot </h3><br>  The first thing you need to do is go to AWS Management Console, Elastic Block Storage -&gt; Snapshots.  There should be a snapshot with the description ‚ÄúRecovery snapshot for vol-XXXXXXX‚Äù.  From it you need to create a restored copy of volume-a. <br><br><h3>  2. Try to detach the broken volume </h3><br>  And what if you're lucky?  I think about what was written to me in the support: <br><br><blockquote>  You can select "Detach Volume" from within the AWS Management Console to detach this volume from your instance.  You may need to execute multiple force-detaches if this hangs in a "detaching" state. <br><br>  If you are unable to follow up, you can‚Äôt be able to do this. <br></blockquote><br><blockquote>  You can select ‚ÄúDetach Volume‚Äù from the AWS Management Console in order to detach the volume from your instance.  You may need to perform several shutdown operations with the ‚Äúforce‚Äù option enabled if it hangs in the ‚Äúdetaching‚Äù state. <br><br>  If you did not succeed in any command, you will have to create a new instance and connect the restored volume to the instance. <br></blockquote><br><br>  Unfortunately, it didn‚Äôt work out for me - I issued ‚ÄúUnable to ...‚Äù to all operations <br><br><h3>  3. Take advantage of AMI Tools </h3><br><br>  So, the only solution in this situation is to use Amazon AMI Tools. <br>  You can download it <a href="http://docs.amazonwebservices.com/AWSEC2/latest/CommandLineReference/">from here</a> . <br><br>  So, as I have Ubuntu, it was enough for me: <br><pre><code class="hljs sql">sudo apt-get <span class="hljs-keyword"><span class="hljs-keyword">install</span></span> ec2-ami-tools sudo apt-<span class="hljs-keyword"><span class="hljs-keyword">get</span></span> <span class="hljs-keyword"><span class="hljs-keyword">install</span></span> ec2-api-tools</code> </pre> <br><br>  Under Windows it should not be much more complicated. <br><br>  Next you need to create access keys.  This is slightly different than the ‚ÄúKey pairs‚Äù in the Network / Security in the Management Console. <br><br>  In order to create a pair of key-certificate of access, you need to go to <a href="http://aws.amazon.com/">aws.amazon.com</a> , there choose Account -&gt; Security Credentials.  There go to the x.509 Certificates tab.  There you can click on ‚ÄúCreate a new Certificate‚Äù and save two files - one certificate (let's call it ec2-cert.pem) and a private key (ec2-key.pem). <br><br>  Important: do not confuse the key and certificate.  They have the same extensions (.pem) but if swapped, the tools will fall out with java.security.cert.CertificateParsingException. <br><br>  Further, it is better (although not necessary - through the parameters) to set the environment variables: <br><pre> <code class="hljs javascript"><span class="hljs-keyword"><span class="hljs-keyword">export</span></span> EC2_CERT=~<span class="hljs-regexp"><span class="hljs-regexp">/--/</span></span>ec2_cert.pem <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> EC2_PRIVATE_KEY=~<span class="hljs-regexp"><span class="hljs-regexp">/--/</span></span>ec2-key.pem</code> </pre><br><br>  After that, you can check whether everything picked up normally: <br><pre> <code class="hljs sql">$ ec2-<span class="hljs-keyword"><span class="hljs-keyword">describe</span></span>-regions REGION eu-west<span class="hljs-number"><span class="hljs-number">-1</span></span> ec2.eu-west<span class="hljs-number"><span class="hljs-number">-1.</span></span>amazonaws.com REGION us-east<span class="hljs-number"><span class="hljs-number">-1</span></span> ec2.us-east<span class="hljs-number"><span class="hljs-number">-1.</span></span>amazonaws.com REGION ap-northeast<span class="hljs-number"><span class="hljs-number">-1</span></span> ec2.ap-northeast<span class="hljs-number"><span class="hljs-number">-1.</span></span>amazonaws.com REGION us-west<span class="hljs-number"><span class="hljs-number">-1</span></span> ec2.us-west<span class="hljs-number"><span class="hljs-number">-1.</span></span>amazonaws.com REGION ap-southeast<span class="hljs-number"><span class="hljs-number">-1</span></span> ec2.ap-southeast<span class="hljs-number"><span class="hljs-number">-1.</span></span>amazonaws.com</code> </pre><br><br>  Here in the eu-west-1 region there was a problem, and I have a hostel instance there.  Watch our instances: <br><pre> <code class="hljs sql">$ ec2-<span class="hljs-keyword"><span class="hljs-keyword">describe</span></span>-instances RESERVATION .... <span class="hljs-keyword"><span class="hljs-keyword">INSTANCE</span></span> ...(   ) BLOCKDEVICE /dev/sda1 vol<span class="hljs-number"><span class="hljs-number">-20155</span></span>a49 <span class="hljs-number"><span class="hljs-number">2011</span></span><span class="hljs-number"><span class="hljs-number">-05</span></span><span class="hljs-number"><span class="hljs-number">-20</span></span>T14:<span class="hljs-number"><span class="hljs-number">14</span></span>:<span class="hljs-number"><span class="hljs-number">54.000</span></span>Z ...</code> </pre><br>  Here we need BLOCKDEVICE (and for one thing, remember / dev / sda1 - you still need it).  Namely, "vol-20155a49" (you, of course, will be different).  Check in the console - is this really the volume that does not want to shut down?  If yes, then we have the last step: <br><pre> <code class="hljs pgsql">$ ec2-detach-volume <span class="hljs-comment"><span class="hljs-comment">--region eu-west-1 vol_2055a49 --force</span></span></code> </pre><br>  After that, go to the management console and calmly connect the volume, recovered from the snapshot.  By the way, here we need to remember what happened immediately after BLOCKDEVICE - I had it "/ dev / sda1". <br><br>  Done!  Now you can start the instance :) <br><br>  As a summary, I can say that Amazon AMI / API Tools are not as complex as it seems (205 utilities in the bag), and they can be used when the web-based management console fails. <br><br>  <i>No thunderstorms or fires to your servers!</i> <br><br>  Useful links: <br>  * <a href="http://docs.amazonwebservices.com/AWSEC2/latest/UserGuide/index.html%3FSettingUp_CommandLine.html">Instructions for setting up utilities</a> <br>  * <a href="http://docs.amazonwebservices.com/AWSEC2/latest/UserGuide/index.html%3Fusing-credentials.html">How to use keys and certificates</a> <br>  * Download utilities: <a href="http://aws.amazon.com/developertools/368">AMI</a> / <a href="http://aws.amazon.com/developertools/351">API</a> </div><p>Source: <a href="https://habr.com/ru/post/126729/">https://habr.com/ru/post/126729/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../126720/index.html">Hacking Dendy Games. On the example of Road Fighter</a></li>
<li><a href="../126722/index.html">ReactOS Digest # 2</a></li>
<li><a href="../126723/index.html">Two contests from ASUS</a></li>
<li><a href="../126725/index.html">Wikimedia Referendum 2011</a></li>
<li><a href="../126726/index.html">Why rounded corners are easier to read</a></li>
<li><a href="../126730/index.html">Buying Google from Motorola brought good luck to RIM</a></li>
<li><a href="../126731/index.html">90% of people do not know about Ctrl + F</a></li>
<li><a href="../126733/index.html">PHP console under MODx Revolution</a></li>
<li><a href="../126734/index.html">The August update of Windows Phone Toolkit is out!</a></li>
<li><a href="../126735/index.html">IT movies</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>