<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Programming under Windows CE in C ++ using Embedded Visual C ++, Part 3 (probably the last).</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Programming under Windows CE in C ++ using Embedded Visual C ++, Part 3 (probably the last). 

 Continuation of the 1st and 2nd parts. 


 Now we will...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Programming under Windows CE in C ++ using Embedded Visual C ++, Part 3 (probably the last).</h1><div class="post__text post__text-html js-mediator-article"> Programming under Windows CE in C ++ using Embedded Visual C ++, Part 3 (probably the last). <br><br>  Continuation <a href="http://habrahabr.ru/blogs/development/39938/">of the 1st</a> and <a href="http://habrahabr.ru/blogs/development/39941/">2nd</a> parts. <br><a name="habracut"></a><br><br>  Now we will discuss in detail the differences between smartphones and Pocket PC.  Ready?  So: in PocketPC, you can poke a finger, but you cannot in a Smartphone.  That's all! 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The big problem with PDAs is that they don't have much memory.  It would be nice to understand where we started and what is there.  This can be done like this: <br><br> <code>MEMORYSTATUS ms; <br> ZeroMemory(&amp;ms, sizeof(ms)); <br> ms.dwLength = sizeof(MEMORYSTATUS); <br> GlobalMemoryStatus(&amp;ms); <br> <br> ULARGE_INTEGER free = {0}, avail = {0}, total = {0}; <br> GetDiskFreeSpaceEx(0, &amp;free, &amp;avail, &amp;total); <br> <br> //     PocketPC     <br> TCHAR platform[1000] = {0}; <br> SystemParametersInfo(SPI_GETPLATFORMTYPE, 1000, platform, 0); <br> <br> TCHAR OEM[1000] = {0}; <br> SystemParametersInfo(SPI_GETOEMINFO, 1000, OEM, 0); <br> <br> printf (_T(": %s."), OEM); <br> printf (_T(": %s."), platform); <br> printf (_T(",  %d  %d ."), ms.dwAvailVirtual &gt;&gt; 20, ms.dwTotalVirtual &gt;&gt; 20); <br> printf (_T(",  %d ."), free.QuadPart &gt;&gt; 20); <br></code> <br><br>  Sometimes on the PDA, you can rotate the screen in landscape and portrait orientation.  Here are the necessary functions: <br><br> <code>//    ? <br> bool CanRotateScreen() <br> { <br> #ifdef UNDER_CE <br> DEVMODE dm; <br> memset(&amp;dm, 0, sizeof(dm)); <br> dm.dmSize = sizeof(DEVMODE); <br> dm.dmFields = DM_DISPLAYQUERYORIENTATION; <br> return DISP_CHANGE_SUCCESSFUL == ChangeDisplaySettingsEx(NULL, &amp;dm, NULL, CDS_TEST, NULL); <br> #else <br> return false; <br> #endif <br> } <br> <br> //    ? <br> int ScreenRotationAngle() <br> { <br> #ifdef UNDER_CE <br> DEVMODE dm; <br> memset(&amp;dm, 0, sizeof(dm)); <br> dm.dmSize = sizeof(DEVMODE); <br> dm.dmFields = DM_DISPLAYORIENTATION; <br> ChangeDisplaySettingsEx(NULL, &amp;dm, NULL, CDS_TEST, NULL); <br> switch (dm.dmDisplayOrientation) <br> { <br> case DMDO_0: return 0; <br> case DMDO_90: return 90; <br> case DMDO_180: return 180; <br> case DMDO_270: return 270; <br> } <br> #endif <br> return -1; <br> } <br> <br> // ! <br> void RotateScreen(int angle) <br> { <br> #ifdef UNDER_CE <br> DEVMODE dm; <br> memset(&amp;dm, 0, sizeof(dm)); <br> dm.dmSize = sizeof(DEVMODE); <br> dm.dmFields = DM_DISPLAYORIENTATION; <br> switch (angle) <br> { <br> default: <br> case 0: dm.dmDisplayOrientation = DMDO_0; <br> case 90: dm.dmDisplayOrientation = DMDO_90; <br> case 180: dm.dmDisplayOrientation = DMDO_180; <br> case 270: dm.dmDisplayOrientation = DMDO_270; <br> } <br> ChangeDisplaySettingsEx(NULL, &amp;dm, NULL, CDS_RESET, NULL); <br> #endif <br> <br> } <br></code> <br><br>  Do not forget to respond to the WM_SETTINGCHANGE message!  You may want to understand what the screen now looks like: <br><br> <code>... <br> Screen.right = GetSystemMetrics(SM_CXSCREEN) - 1; <br> Screen.bottom = GetSystemMetrics(SM_CYSCREEN) - 1; <br> ...</code> <br> <br>  Since it is impossible to grasp the immensity, I‚Äôm getting round here, but I‚Äôll tell you at the end how to install your application under the PDA.  You want to create a normal human installer from under Win32, and not default squalor, right? <br><br>  You need RAPI.DLL.  If you search the network, you can find RAPI.H, which describes an incredible number of structures and functions in RAPI.DLL, some of which you need.  Using RAPI.DLL, you can establish whether the PDA is connected to a desktop PC, rummage through its files, copy files from the desktop to the PDA and back, create shortcuts, etc. <br><br>  This is done approximately like this (Delphi code, do not worry!): <br><br> <code>type <br> <br> TRapiInit = record <br> cbSize:DWORD; <br> heRapiInit:THandle; <br> hrRapiInit:HResult; <br> end; <br> <br> function CeCloseHandle(hObject: THandle): bool; stdcall external 'rapi.dll'; <br> function CeCreateFile(lpFileName: LPCWSTR; dwDesiredAccess: dword; dwShareMode: dword; lpSecurityAttributes: PSecurityAttributes; dwCreationDistribution: dword; dwFlagsAndAttributes: dword; hTemplateFile: THandle): THandle; stdcall external 'rapi.dll'; <br> function CeGetFileSize(hFile: THandle; lpFileSizeHigh: PDWORD): dword; stdcall external 'rapi.dll'; <br> function CeGetLastError: dword; stdcall external 'rapi.dll'; <br> function CeRapiInitEx(var RapiInit: TRapiInit): longint; stdcall external 'rapi.dll'; <br> function CeRapiUninit: longint; external 'rapi.dll'; <br> function CeReadFile(hFile: THandle; const lpBuffer; nNumberOfBytesToRead: dword; var NumberOfBytesRead :dword; Overlapped: POVERLAPPED): bool; stdcall external 'rapi.dll'; <br> function CeWriteFile(hFile: THandle; const lpBuffer; NumberOfBytesToWrite: dword; var NumberOfBytesWritten :dword; Overlapped: POVERLAPPED): bool; stdcall external 'rapi.dll'; <br> function CeCreateDirectory(lpPathName:LPCWSTR; lpSecurityAttributes:PSecurityAttributes):BOOL; stdcall external 'rapi.dll'; <br> function CeRemoveDirectory(PathName:LPCWSTR):BOOL; stdcall external 'rapi.dll'; <br> function GetRapiError: integer; stdcall external 'rapi.dll'; <br> <br> procedure InitRAPI(wait_ms: cardinal); <br> var <br> ri: TRapiInit; <br> h: HRESULT; <br> when: cardinal; <br> begin <br> ZeroMemory(@ri, sizeof(ri)); <br> ri.cbSize := sizeof(ri); <br> h := CeRapiInitEx(ri); <br> if FAILED(h) then raise Exception.Create('      .'); <br> when := GetTickCount + wait_ms; <br> while GetTickCount &lt; when do <br> case MsgWaitForMultipleObjects(1, ri.heRapiInit, FALSE, when - GetTickCount,QS_ALLINPUT) of <br> WAIT_OBJECT_0: if SUCCEEDED(ri.hrRapiInit) then exit else raise Exception.Create('     PDA.'); <br> WAIT_OBJECT_0 + 1: Application.ProcessMessages; <br> end; <br> raise Exception.Create('   .'); <br> end; <br> <br> procedure CopyFileToPDA(src_filename, dst_filename: string; ignore_errors: boolean ); <br> var <br> buffer: array [0..16384] of char; <br> BufferCount, ReadCount, WriteCount: cardinal; <br> dst, src: THandle; <br> filename: pWideChar; <br> code: longbool; <br> begin <br> GetMem(filename, sizeof(WideChar) * Succ(Length(dst_filename))); <br> StringToWideChar(dst_filename, filename, Succ(Length(dst_filename))); <br> try <br> src := CreateFile(PChar(src_filename), GENERIC_READ, FILE_SHARE_READ, nil, OPEN_EXISTING, 0, 0); <br> if GetLastError = INVALID_HANDLE_VALUE then raise Exception.CreateFmt('    "%s".', [src_filename]); <br> dst := CeCreateFile(filename, GENERIC_READ or GENERIC_WRITE,0,nil,CREATE_ALWAYS,FILE_ATTRIBUTE_NORMAL,0); <br> if (CeGetLastError = INVALID_HANDLE_VALUE) then raise Exception.CreateFmt('    "%s"  .', [dst_filename]); <br> BufferCount := 16384; ReadCount := 16384; <br> while ReadFile(src,Buffer,BufferCount,ReadCount,nil) and (ReadCount &lt;&gt; 0) do begin <br> code := CeWriteFile(dst,buffer,ReadCount,WriteCount, nil); <br> if not code and not ignore_errors then <br> raise Exception.Create('    "' + src_filename + '"   ("' + dst_filename + '").'); <br> Application.ProcessMessages; <br> end; <br> CloseHandle(src); <br> CeCloseHandle(dst); <br> finally <br> FreeMem(filename); <br> end; <br> end; <br> <br></code> <br><br>  Maybe you want to write the application directly to the memory card?  Then try to find it like this: <br><br> <code>function StorageCardPath: string; <br> var <br> h: THandle; <br> data: CE_FIND_DATA; <br> name: string; <br> const <br> a = FILE_ATTRIBUTE_TEMPORARY or FILE_ATTRIBUTE_DIRECTORY; <br> begin <br> h := CeFindFirstFile('\*.*', @data); <br> while h &lt;&gt; INVALID_HANDLE_VALUE do begin <br> if (data.dwFileAttributes and a) = a then begin <br> name := WideCharToString(data.cFileName); <br> if Pos('NETWORK', UpperCase(name)) = 0 then begin <br> result := '\' + name; <br> break; <br> end; <br> end; <br> if not CeFindNextFile(h, @data) then break; <br> end; <br> CeFindClose(h); <br> <br> end; <br></code> <br><br>  In general, I advise you to study the RAPI, there are a lot of useful things there.  The most important thing is that you have a human installer and full control over the installation process. <br><br>  Good luck! <br><br></div><p>Source: <a href="https://habr.com/ru/post/39946/">https://habr.com/ru/post/39946/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../399451/index.html">Why we do not have infant memories</a></li>
<li><a href="../399453/index.html">Five forms of blockchain money available now.</a></li>
<li><a href="../399455/index.html">Not only home appliances: What else is there in Audiomania for music lovers, amateurs and musicians</a></li>
<li><a href="../399457/index.html">Russian FinTech Meetup # 2: Trading in the Era of Modern Digital Technologies</a></li>
<li><a href="../399459/index.html">Blackjack leakage protection with counters</a></li>
<li><a href="../399461/index.html">Artificial intelligence will help people get rid of phobias and fears</a></li>
<li><a href="../399463/index.html">Multicopters have learned how to sit down on the roofs of moving cars</a></li>
<li><a href="../399465/index.html">Kak2tak.tk: it means the idea was not so bad ...</a></li>
<li><a href="../399469/index.html">The Pix2pix Neural Network realistically colors pencil sketches and black and white photos</a></li>
<li><a href="../39947/index.html">Alternative file managers: CubicExplorer</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>