<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Update MS16-072 breaks Group Policy. What to do with it?</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Nothing foreshadowed troubles last "Tuesday of updates" (June 14): the update bulletin contained only a dry list of important security updates and sta...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Update MS16-072 breaks Group Policy. What to do with it?</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/d0f/a02/77f/d0fa0277fb444e3d8fff08b459a84f1b.png" alt="Error: Filtering: Not Applied (Unknown Reason)"><br><br>  Nothing foreshadowed troubles last "Tuesday of updates" (June 14): the update bulletin contained only a dry list of important security updates and standard recommendations for their immediate installation.  However, after applying the updates, system administrators around the world are faced with a strange behavior of security policies.  The most common symptom: network printers and folders began to fall off. <br><a name="habracut"></a><br>  Those who followed the best practices of distributing updates noticed that this behavior was observed only in the test group, updates for which were accepted before they were distributed throughout the organization. <br><br>  When trying to understand the situation, the result of GPRESULT threw some confusion: some user-level security policies were not applied, producing a very ‚Äúinformative‚Äù message: ‚ÄúFiltering: Not Applied (Unknown Reason)‚Äù.  Some new policies simply did not appear in the GPRESULT output. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Who is guilty? </h4><br>  The culprit of this behavior was the security update from article <a href="https://support.microsoft.com/en-us/kb/3163622"><b>KB3163622</b></a> (security bulletin <b>MS16-072</b> , KB number for various operating systems: <a href="https://support.microsoft.com/en-us/kb/3159398"><b>KB3159398</b></a> , <a href="https://support.microsoft.com/en-us/kb/3163017"><b>KB3163017</b></a> , <a href="https://support.microsoft.com/en-us/kb/3163018"><b>KB3163018</b></a> , <a href="https://support.microsoft.com/en-us/kb/3163016"><b>KB3163016</b></a> ), designed to close the security <a href="https://support.microsoft.com/en-us/kb/3163016"><b>gap</b></a> in the process of applying group policies.  Since the advent of group policy technology, due attention has not been paid to ensuring the power of attorney of the policy source.  The attacker, using the MitM tactic ( <i>Man in the Middle</i> - intermediary attack), could substitute a response from the domain controllers and send fake security policies to the attacked computer, giving, for example, local administrator rights to the compromised ordinary user account. <br><br>  As it turned out, to solve this problem, Microsoft programmers did not find anything better than to change the behavior of the group policy application process, which has not changed since the release of Windows 2000. Traditional behavior involved access to <i>computer scope</i> security policies from the computer account, and to user-level security policies - from <u>user account</u> .  After installing the update KB3163622, all requests began to be sent from <u>the computer account</u> to ensure the power of attorney of the source using the Kerberos protocol. <br><br>  Testing of the update (if any, was conducted at all) did not reveal any problems, since by default access to all group policies is allowed for the <b>Authenticated Users</b> group, which includes all accounts (computers and users). <br><br>  Under actual operating conditions, system administrators restrict the distribution of many policies using a simple and intuitive <i>security filtering</i> mechanism, as well as directly modifying access settings to some policies.  It should be noted that the modification of access control lists to policies is a regular policy setting tool and cannot be the reason for accusing system administrators of creating a non-standard situation. <br><br><img src="https://habrastorage.org/files/634/55f/072/63455f0728fd45c1af5242970b223bb8.png" alt="Security Filtering List"><br>  <i>Security Filtering List</i> <br><br>  As a result, a stream of complaints poured on Microsoft, and the forums were full of quick recommendations to cancel (update) KB3163622 in WSUS.  The situation, unfortunately, has become not uncommon in recent years, when almost every month some updates come out again in a new edition after a negative reaction from users.  This time, however, Microsoft made it clear that it will not back down and will have to get used to the new rules for applying security policies. <br><br>  On June 15, a brief indication was added to MS16-072 that, as they say, ‚Äúthis is not a bug, this is a feature,‚Äù and this behavior change will be saved. <br><br>  Microsoft employee Ian Farr on June 16 published a <a href="https://blogs.technet.microsoft.com/poshchap/2016/06/16/ms16-072-known-issue-use-powershell-to-check-gpos/">script on PowerShell</a> that allows system administrators to check whether the new update will affect existing policies. <br><br>  During the week, specialized resources were seething with passion, since, apart from three lines in the security bulletin, no official information from Microsoft was received.  Finally, 9 days after the release of the update, the official blog of the Ask the Directory Services Team published a <a href="https://blogs.technet.microsoft.com/askds/2016/06/22/deploying-group-policy-security-update-ms16-072-kb3163622/">detailed article</a> that, for good, should if not precede the release of the update (even if, for security reasons, before the release of the patch, the essence of the vulnerability cannot be disclosed) , then at least go to the first line in the June bulletin. <br><br><h4>  What to do? </h4><br>  <u>TL; DR:</u> Below is a <i>guide</i> on <i>how</i> to make changes to the GPO and AD to prevent damage from installing this update. <br><br>  With all due respect to the AD DS Team, it seems to me that the solution they propose ‚Äî to add <b>Authenticated Users</b> or <b>Domain Computers</b> with read-only access to all policies that have stopped working ‚Äî is a half-measure.  When modifying or creating new security policies, from now on and forever you will need to remember to add one of the above groups.  The intuitive <i>security filtering</i> tool, available directly on the first page of the security <i>policy editor</i> ( <i>group policy editor</i> ), generally loses all meaning, since it is still necessary to manually change access control lists. <br><br>  The following solution seems to me to be easier to use: add the <b>Domain Computers</b> group with read-only rights (but <u>not</u> application) to all policies (if possible for security reasons), and also make a minimal modification of the AD <i>schema</i> ( <i>schema</i> ) so that new policies created immediately with the necessary rights. <br><br>  The advantage of this solution is the absence of the need to support it: the behavior of group policies will hardly change, there is no need to change the rules for creating / modifying policies.  The <i>security filters</i> mechanism will continue to work, which very visually allows you to present and edit access parameters to policies. <br><br>  The downside is the need to modify the schema ( <i>schema</i> ) of AD, but the modification is so trivial that it should not cause any problems. <br><br>  Why do I suggest adding <b>Domain Computers</b> , and not <b>Authenticated Users</b> ?  First, in order not to violate the <a href="https://ru.wikipedia.org/wiki/%25D0%259F%25D1%2580%25D0%25B8%25D0%25BD%25D1%2586%25D0%25B8%25D0%25BF_%25D0%25BC%25D0%25B8%25D0%25BD%25D0%25B8%25D0%25BC%25D0%25B0%25D0%25BB%25D1%258C%25D0%25BD%25D1%258B%25D1%2585_%25D0%25BF%25D1%2580%25D0%25B8%25D0%25B2%25D0%25B8%25D0%25BB%25D0%25B5%25D0%25B3%25D0%25B8%25D0%25B9">Minimum Privilege Principle</a> : even after such an abuse of this principle that this update performs, we still can prevent the unprivileged user from reading the policies that apply to privileged users by simply entering into SYSVOL.  Secondly, by default, <b>Authenticated Users</b> already have rights to read and apply the policy.  Removing <b>Authenticated Users</b> from the list of security filters ( <i>security filtering</i> ) we remove not only application rights, but also read rights.  At the same time, if the <b>Domain Computers</b> group is added to read-only access lists, it is not displayed in the <i>security filtering</i> list and will not be deleted. <br><br><h4>  Considerations on the applicability of these recommendations </h4><br>  First of all, I recommend studying the list of group policies in your domain that will be directly affected by the behavior change.  This will help the <a href="https://blogs.technet.microsoft.com/poshchap/2016/06/16/ms16-072-known-issue-use-powershell-to-check-gpos/">script with TechNet</a> or one of its modifications, in recent days published in various blogs.  You need to understand what was the purpose of changing security settings.  I see such a list of the most obvious goals: <br><br>  1. <u>Secondary access restriction to the resource</u> .  For example, access to a network printer is limited to the <b>Example1</b> group in the security settings of the printer itself, and, additionally, the security policy that connects this printer applies only to members of the <b>Example1</b> group.  In such a situation, adding rights to read (but not apply policies) for <b>Domain Computers is</b> perfectly safe. <br><br>  2. <u>Restricting the dissemination of information contained in the security policy itself</u> .  I would not recommend to store <i>sensitive</i> ( <i>sensitive</i> ) data (for example, passwords) in security policies, but I admit that until last week this approach had a right to exist, since access to the security policy files in the shared folder SYSVOL is automatically limited to the access list, applied to politics itself.  After the changes, which brings the update, access will be forced to get accounts of all computers.  Addressing the SYSVOL folder on behalf of a computer is still not the most trivial task for a user with limited rights, but, potentially, this is possible (for example, using a separate local privilege vulnerability).  Before proceeding to the following instructions, consider the potential risks, and possibly remove sensitive information from the security policy. <br><br>  2a.  Under the conditions of increased security requirements, according to the Principle of Minimum Privileges, the <u>default access for <b>Authenticated Users</b> can be replaced with a narrower access for <i>all</i> security policies</u> .  In this case, a complete revision of the entire policy protection strategy is needed.  For user-level policies, an attempt to narrow the circle of access will now inevitably lead to a violation of the postulate about the separation of user and computer security policies.  For example, an attempt to limit the distribution of a policy that applies only to privileged users, a group of computers on which these users work, will result in an actual confusion of <i>user and computer scope</i> policies, which is not a good practice. <br><br><h4>  Instruction </h4><br>  After you have decided on the applicability of the proposed approach (see the previous section), you need to start PowerShell with domain administrator or other account having full access to all security policies and enter the following command: <br><br> <code>Get-GPO -All | Set-GPPermissions -TargetType Group -TargetName "Domain Computers" -PermissionLevel GpoRead <br></code> <br>  This command will add read (but not apply) policies for the <b>Domain Computers</b> group to all domain security policies.  After its execution, you can safely install the update KB3163622, for existing security policies, it is no longer scary. <br><br>  <i><b>Warning</b></i>  <i>The next step is to change the schema (schema) of AD so that newly created policies already have permission to read the policy by the Domain Computers group in their access control list.</i>  <i>Although the change is minimal, I would like to advise those administrators who do not know what the schema (schema) AD is, first study this concept or limit to the previous paragraph of the instruction and add Domain Computers to new policies manually or launch the above PowerShell command (or modify it). with the replacement of "-All" in the name of the policy) after the creation of each new security policy.</i> <br><br>  Further instruction is a free translation of the <a href="https://sdmsoftware.com/group-policy-blog/tips-tricks/modifying-default-gpo-permissions-creation-time/">article Darren Mar-Elia</a> . <br><br>  Check that you have sufficient access for the following operations.  You must be a member (directly or indirectly) of the <b>Schema Admins</b> group. <br><br>  1. Run <i>ADSIEdit.msc</i> in the <i>Action</i> menu, open the <i>Connect To</i> item and select <i>Schema</i> from the list: <br><img src="https://habrastorage.org/files/6ac/b0e/c57/6acb0ec577b9442ba0678daf9adf3c4b.jpg" alt="Connect to schema (schema) AD in ADSIEdit"><br>  <i>Connect to schema (schema) AD in ADSIEdit</i> <br><br>  2. Expand the tree <i>CN = Schema, CN = Configuration</i> .  In the list on the right, select <i>CN = Group-Policy-Container</i> : <br><img src="https://habrastorage.org/files/d02/879/72a/d0287972aea94440af6ba9175a4fde25.jpg" alt="Group Policy Container class in ADSIEdit"><br>  <i>Group Policy Container class in ADSIEdit</i> <br><br>  3. Double-click on <i>CN = Group-Policy-Container to</i> open the attribute list.  Locate the <i>defaultSecurityDescriptor</i> attribute.  Open attribute value. <br><br>  4. <b>Just in case, copy the current value of the defaultSecurityDescriptor attribute in Notepad and save to a file.</b>  Position the cursor at the very end of the long attribute value, after the last closing bracket.  Add the following value (you can check the meaning of this ‚Äúmagic‚Äù string using the <a href="http://blogs.microsoft.co.il/files/folders/guyt/entry70399.aspx">SDDLPARSE utility</a> ): <br><br> <code>(A;CI;LCRPLORC;;;DC) <br></code> <br><img src="https://habrastorage.org/files/0d1/ac1/652/0d1ac1652efb4a04b2f23a5ea27b65c1.jpg" alt="Editing defaultSecurityDescriptor"><br>  <i>Editing defaultSecurityDescriptor</i> <br><br>  5. Click <i>OK</i> to apply the changes. <br><br>  6. Start <i>MMC</i> , go to <i>File</i> ‚Üí <i>Add / remove snap-ins</i> and select <i>Active Directory Schema</i> .  If you do not see <i>AD Schema</i> in the list, you need to disable the so-called "foolproof".  Run a command prompt with elevated privileges and enter <b>regsvr32 schmmgmt.dll</b> , then restart <i>MMC</i> .  Right click on the ‚Äú <i>Active Directory Schema</i> ‚Äù item and select ‚Äú <i>Reload the Schema</i> ‚Äù as shown below: <br><img src="https://habrastorage.org/files/b5f/950/b3c/b5f950b3c0c54a05b8c7e5dfe80d85e1.png" alt="AD schema update"><br>  <i>AD schema update</i> <br><br>  7. As a result of the above actions, new group policies will be created immediately with configured read access for the <b>Domain Computers</b> group: <br><img src="https://habrastorage.org/files/7a6/b66/9e2/7a6b669e2e9d48f0aa28b4067b41488b.jpg" alt="New security policy"><br>  <i>New security policy</i> <br><br><h4>  Conclusion </h4><br>  I do not presume to judge whether it was possible to close the gap in a less troublesome way for administrators around the world (albeit at the expense of more work for Microsoft programmers).  In any case, a detailed description of the change should have been included in the original security bulletin, and not published after 9 days in the (albeit official) blog. <br><br>  It should be noted that, by closing the MitM access <i>elevation</i> gap ( <i>elevation of privilege</i> ), updating KB3163622 opens multiple gaps in <i>information disclosure</i> , and this will have to be considered. <br><br><h4>  Links </h4><br>  1. <a href="https://support.microsoft.com/en-us/kb/3163622">Microsoft KB3163622 (security bulletin MS16-072).</a> <br><br>  2. Ian Farr.  <a href="https://blogs.technet.microsoft.com/poshchap/2016/06/16/ms16-072-known-issue-use-powershell-to-check-gpos/">A PowerShell script that allows system administrators to check if a new update will affect existing policies.</a> <br><br>  3. Ask the Directory Services Team.  Ajay Sarkaria.  <a href="https://blogs.technet.microsoft.com/askds/2016/06/22/deploying-group-policy-security-update-ms16-072-kb3163622/">Detailed article describing changes in the behavior of security policies</a> . <br><br>  4. Darren Mar-Elia.  <a href="https://sdmsoftware.com/group-policy-blog/tips-tricks/modifying-default-gpo-permissions-creation-time/">Modifying Default GPO Permissions at Creation Time</a> . </div><p>Source: <a href="https://habr.com/ru/post/304202/">https://habr.com/ru/post/304202/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../304188/index.html">Data leakage is becoming more expensive: the average size of company losses due to hacking rose to $ 4 million</a></li>
<li><a href="../304190/index.html">Acronis People 2: Start a career in Acronis. How, instead of a cozy internship, I got into the development hell</a></li>
<li><a href="../304192/index.html">Progressive simplification</a></li>
<li><a href="../304196/index.html">Confrontation: new format and new reality</a></li>
<li><a href="../304200/index.html">How to increase conversion to ecommerce using exit polls</a></li>
<li><a href="../304204/index.html">Yandex "Mail for Domain" as a mail gateway for your servers</a></li>
<li><a href="../304206/index.html">Checking the source code of WPF Samples from Microsoft</a></li>
<li><a href="../304208/index.html">AndroidAudit. Your Android application as a crime scene</a></li>
<li><a href="../304210/index.html">On the relative brightness, or how tenacious is Legacy</a></li>
<li><a href="../304212/index.html">The book "Head First. Learning Ruby</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>