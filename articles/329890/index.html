<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>PHDays VII: Confrontation Chronicles</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This year, before the ‚ÄúConfrontation‚Äù, we once again gathered a hodgepodge team, partly from employees of Solar Security, partly from caring friends a...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>PHDays VII: Confrontation Chronicles</h1><div class="post__text post__text-html js-mediator-article">  This year, before the ‚ÄúConfrontation‚Äù, we once again gathered a hodgepodge team, partly from employees of Solar Security, partly from caring friends and social builders of Russia.  In the article we will try to describe the whole process of participation in the ‚ÄúConfrontation‚Äù - what were the Easter eggs from the organizers, what were the attacks, how we defended, what tools worked, etc. <br><br><img src="https://habrastorage.org/web/ce3/548/b1b/ce3548b1b5fb4571970bfea60eb6520f.jpg"><br><a name="habracut"></a><br>  Last year, our team monitored Telecom (which was not very different in terms of infrastructure from the Office, but not the essence).  This year, the number of SOCs decreased, the Telecom infrastructure lost its domain, workstations, and most of the servers, and we decided to work with the Office as well. <br><br>  Each participant in the confrontation had their own goals and objectives.  For us, the main task was the ability to test endpoint content in ‚Äúcombat conditions‚Äù (we checked the network part last year), ideas on identifying various methods of delivering malware to users' workstations and fixing Attackers in the infrastructure.  The office was ideally suited for this, especially since the organizers promised "the enemy inside." 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      If you take an integral assessment of the event, everything was quite cheerful and interesting.  Both infrastructures that we defended did without successful attacks in the field of protection and during operation (GSM Telecom was not in the scopes of protection or monitoring).  We defended the infrastructures from the attackers (although the Telecom team received a yellow card for disputes with the referee).  On the way, we found a couple of ‚Äúeaster eggs‚Äù from the organizers, which, apparently, deprived themselves of an exciting fight with the internal enemy.  Now about everything in order. <br><br><h3>  Preparation stage, or how the infrastructure looks like before the game starts </h3><br><ol><li>  As planned by the organizers, "in order to preserve the balance in the infrastructures of companies there is a constant, with a slight backlash, the number of vulnerabilities."  In practice, this looks like Windows 2008 R2 without a single update on all 50 hosts.  This was the first surprise.  At the same time, the possibility of updating the OS was knocked out almost with a fight, for there must be a ‚Äúbalance‚Äù. <br><br>  But it is necessary to be updated in any case, because, for example, Sysmon v6 on Windows 2008 and Windows 7 is no longer installed, because the OS can not verify the digital signature.  <a href="https://support.microsoft.com/en-us/help/3033929/microsoft-security-advisory-availability-of-sha-2-code-signing-support-for-windows-7-and-windows-server-2008-r2-march-10,-2015">The decision</a> . <br><br><img src="https://habrastorage.org/web/9c5/46e/3df/9c546e3df87e4dd7b19bb787891a581d.png"><br><br></li><li>  The second surprise was the number of Web applications in the office infrastructure.  Apparently, they decided to collect all the known platforms with the most leaky software. <br><br><img src="https://habrastorage.org/web/32a/f22/e53/32af22e538e9425e873f2ad35d9b86a8.png"><br><br></li><li>  What the infrastructure looked like in general: <br><br><ul><li>  25 servers with OS Windows 2008 R2.  The main functionality is the mysql database for each of the external web services. </li><li>  25 Windows 7 workstations. </li><li>  32 external services, mainly Ubuntu with a variety of web content. </li></ul><br>  GIS, for which the Defenders had enough money: <br><br><ul><li>  CheckPoint FW + IPS on the outer perimeter of the network. </li><li>  Kaspersky AV 10 on workstations + Kaspersky for windows server 8.0 on servers. </li><li>  Kaspersky for Linux on external web servers. </li><li>  ObserveIT on all infrastructure servers. </li></ul><br>  Monitoring in SOC: <br><br><ul><li>  ArcSight - GIS + OS Audit. </li><li>  Splunk - netflow + Unix Audit.  Web monitoring + monitoring of network attacks, availability of new hosts / services. </li></ul><br></li><li>  By agreement with the Defenders, in addition to monitoring, we took upon ourselves the response on the Windows infrastructure.  Including for the reason that the audit we need does not roll out quite trivially and we ourselves had to identify problem areas. </li></ol><br><h3>  General concept of infrastructure monitoring </h3><br><ol><li>  External Web: <br><br><ul><li>  At the OS level, auth log + auditd on EXECVE + changes to the Web server configs and the / tmp / directories. </li><li>  Audit executable commands in bash (something like <a href="http://webplay.pro/linux/syslog-log-bash-history-every-user.html">webplay.pro/linux/syslog-log-bash-history-every-user.html</a> , but greatly improved). </li><li>  Hope for CheckPoint IPS. </li><li>  Kaspersky AV on Linux.  Not that we strongly believed in him, but since he is ... </li></ul><br>  Tasks for monitoring (taken at a minimum so that it is not completely embarrassing): <br><br><ul><li>  External scan. </li><li>  Password selection and server logins via SSH are not from our segments. </li><li>  Creating scripts in the OS. </li><li>  There are some custom scenarios that were added on the fly to change the infrastructure. </li></ul><br></li><li>  Windows OS: <br><br><ul><li>  Sysmon v6: <br><br><ul><li>  Running processes (many advantages compared to standard Windows audits). </li><li>  Creating files and changing the registry (included immediately on the entire host, no need to configure separately on each directory). </li><li>  Downloading libraries (I really wanted to see the use of various malware by hackers). </li><li>  Appeal to the address space of other processes. </li></ul><br></li><li>  Audit OS Windows (Advanced Audit Configuration). <br>  There is no magic here either, everything is standard.  The only point is that the audit of the category ‚ÄúFiltering Platform Connection‚Äù was necessarily included, in which it is possible to compare network events with the processes that these connections initiate. <br><br></li><li>  A couple of libraries that are injected at the start into the cmd.exe and powershell.exe processes and log all commands entered.  Wonderful thing :) <br><br><img src="https://habrastorage.org/web/a61/72d/5a4/a6172d5a4de240309964d387f5118352.png"><br><br></li><li>  A few ‚Äúsurprises‚Äù for Attackers: <br><br><ul><li>  We adopted the experience of surveys on projects and made UZ svcbackup in the domain with a password in the comments.  And a number of rules for detecting any activity under this UZ: <br><br><img src="https://habrastorage.org/web/161/6ad/002/1616ad002e2d4cce9ee5043fe1e9bfa8.png"><br><br></li><li>  Putting patches is good and right, but unfair to Attackers.  Therefore, we decided to help the organizers, and the updates on the OS began to look like this: <br><br><img src="https://habrastorage.org/web/966/65f/176/96665f176d62408c86487a0e80c4f21e.png"><br><br></li><li>  We still expected that the Attackers would quickly get inside the network, so through the domain almost all workstations rolled out LSA Protect to protect against Mimikatz.  But not for all types of KM, and only Logon Credential <br><br><pre><code class="hljs tex">HKLM<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">SYSYTEM</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">CurrentControlSet</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Control</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">SecurityProvider</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Wdigest</span></span></span></span> /v UseLogonCredential /t REG_DWORD /d 0</code> </pre> <br>  Naturally, with monitoring changes to the corresponding parameter in the registry. <br><br></li><li>  In case the Attackers, if they hit the system, tried to disconnect us from the control (for example, by turning on the blocking rules on the FW), a script was prepared that runs on a schedule and changes the policy to the original one in the presence of FW enable events: <br><br><div class="spoiler">  <b class="spoiler_title">Attention, spoiler!</b> <div class="spoiler_text"><pre> <code class="hljs mel">$compname = Get-WMIObject Win32_ComputerSystem | Select-Object -ExpandProperty name $outputevent = Get-WinEvent ‚ÄìLogName <span class="hljs-string"><span class="hljs-string">"Microsoft-Windows-Windows Firewall With Advanced Security/Firewall"</span></span> | Where-object {$_.ID -eq <span class="hljs-number"><span class="hljs-number">2003</span></span>} | Format-list TimeCreated, Message | Out-File $env:temp\JSOC_TEMP_FW #reg.<span class="hljs-keyword"><span class="hljs-keyword">exp</span></span> = (?i).(.*value.*yes) $readoutputeventE = type $env:temp\JSOC_TEMP_FW | Select-String -Pattern <span class="hljs-string"><span class="hljs-string">"Value: Yes"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($readoutputeventE) { &amp; $env:systemroot\getrulesFW.vbe &amp; $env:systemroot\System32\cmd.exe /c netsh advfirewall import $env:systemroot\JSOC.wfw Get-WinEvent ‚ÄìLogName <span class="hljs-string"><span class="hljs-string">"Microsoft-Windows-Windows Firewall With Advanced Security/Firewall"</span></span> | Where-object {$_.ID -eq <span class="hljs-number"><span class="hljs-number">2003</span></span>} | Format-list TimeCreated, Message | Out-File $env:temp\JSOC_FW_LOG &amp; $env:systemroot\System32\wevtutil.exe cl <span class="hljs-string"><span class="hljs-string">"Microsoft-Windows-Windows Firewall With Advanced Security/Firewall"</span></span> Write-EventLog ‚ÄìLogName Application ‚ÄìSource <span class="hljs-string"><span class="hljs-string">"Application"</span></span> ‚ÄìEntryType Information ‚ÄìEventID <span class="hljs-number"><span class="hljs-number">666</span></span> ‚ÄìMessage <span class="hljs-string"><span class="hljs-string">"Firewall enabled detected: START AUTORESPONSE!!1111"</span></span> }</code> </pre> </div></div></li></ul><br></li></ul></li><li>  The monitoring content of the Windows OS eventually crashed into several parts: <br><br><ul><li>  Standard Solar JSOC content that runs on all customers. </li><li>  Separate rules for the detection of anomalous activity and attempts to consolidate in the OS. <br>  It‚Äôs not interesting to write about the first part, but on the second we‚Äôll dwell a little more. <br><br><img src="https://habrastorage.org/web/b0d/ebc/124/b0debc12486b488aa779b6689b79be8a.png"></li></ul><br>  The general idea is as follows: <br><br><ol><li>  Detect attachment options in the OS.  Describe for a long time, better give a link to an excellent presentation of colleagues from the LC on PHDays, who remarkably <a href="https://www.phdays.com/program/231388/">described</a> all the detection methods: <a href="https://www.phdays.com/program/231388/">www.phdays.com/program/231388</a> </li><li>  Detect network activity of system processes.  To do this, they collected work profiles and set up exception lists for what was recognized as legitimate. </li><li>  Detect the activity of system processes in the file system and in the registry.  For this, profiles were also collected and lists of permitted activities were compiled. </li><li>  We detect changes in the registry branches, which are responsible for autostarting applications and libraries at system startup and / or user logon. </li><li>  We detect changes to registry branches that are responsible for protecting against conditional mimikatz and its analogs, changing powershell cmdlets, etc. </li></ol><br>  In general, this is a topic for individual articles; perhaps, we will describe it in more detail later. <br><br>  After the whole audit was set up and the rules started, the first results appeared.  We began to fix network activity from the svchost.exe process on some external server 208.91.197.46:9999, which was not in our profile.  In ArcSight, it looked like this: <br><br><img src="https://habrastorage.org/web/6a3/ca5/c8b/6a3ca5c8b86541f2aedf57b665455c98.jpg"><br><br>  After a quick analysis, it turned out that the malicious code is being used in svchost.exe via a malicious dll: c: \ windows \ FileName.jpg: <br><br><img src="https://habrastorage.org/web/f97/5c4/d49/f975c4d4900c4af88d61b1b506a5dbdc.jpg"><br><br>  In parallel with it, another malware was found on the same server.  That's just the functional did not have time to study, deleted immediately, as they saw :) <br><br><pre> <code class="hljs tex">c:<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">program</span></span></span></span> files (x86)<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">wina</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">wina</span></span></span></span>.exe (471d39a51a79f342033c5b0636c244dc).</code> </pre><br>  <a href="">www.trendmicro.com/vinfo/us/threat-encyclopedia/malware/troj_scar.alr</a> + <a href="https://www.virustotal.com/ru/file/1154535130d546eaa33bbc9051a9cb91e2b0e3a3991286c3d5b0a708110c9aa7/analysis/">www.virustotal.com/ru/file/1154535130d546eaa33bbc9051a9cb91e2b0e3a3991286c3d5b0a708110c9aa7/an/c/e3a3991286c3d5a3b3e3a381123aa/335c5e3a3991286c3d5a3b5e3a381126aa/335c</a> <br><br>  Perhaps this was our biggest mistake during the confrontation, but we ‚Äúnailed‚Äù this surprise from the organizers even before the start of the game.  It is likely that he was part of a large-scale plan, but it was too late to regret something :) <br><br>  With such results, we went to bed last time before starting the game. <br></li></ol><br><h3>  Standoff </h3><br>  <b>Monitoring the availability of infrastructure and the relevance of audit settings</b> <br><br>  According to the experience of last year, it was clear that the infrastructure is non-static and can change at arbitrary points in time.  But only if last year it grew (6 hosts on the outer perimeter flew in within 10 minutes flew in), then it began to decline rapidly.  At the time of launch, the number of servers within the network was reduced to 11, and the number of workstations - to 15. <br><br>  In such conditions, it quickly became clear that, despite the set up audit, reliable information about his condition was needed.  After all, if the virtual machine with any of the hosts is rolled back, then we will remain without patches and without monitoring. <br><br><img src="https://habrastorage.org/web/f9d/a81/59e/f9da8159eb604f33a191abfd0a0e6d99.png"><br><br>  As a result, a decent part of the time was spent in order to quickly deal with emerging issues.  The hosts periodically hung (the entrance to the console via the RDP could take half an hour), they were rebuilt, and all this seriously spoiled the nerves.  One thing pleases - accessibility monitoring worked for all 100. <br><br>  <b>First Incidents - Web</b> <br><br>  Expectedly, everything starts with external web services.  They scanned constantly, trying to shower shells and deface sites periodically. <br><br>  This is how sometimes attackers reveal themselves (successful operation of SSTI in photo hosting: <a href="https://defcon.ru/web-security/3840/">defcon.ru/web-security/3840</a> ): <br><br><pre> <code class="apache hljs">/<span class="hljs-attribute"><span class="hljs-attribute">var</span></span>/lib/php5/sess_vhd4sts3mpk78n4qacc4o8knm0:logged|b:1;name|s:98:<span class="hljs-string"><span class="hljs-string">"{{_self.env.registerUndefinedFilterCallback('exec')}} {{_self.env.getFilter('ping 100.64.199.5')}}"</span></span>;username|s:4:<span class="hljs-string"><span class="hljs-string">"test"</span></span>;avatar|s:25:<span class="hljs-string"><span class="hljs-string">"images/default_avatar.jpg"</span></span>;</code> </pre><br>  As a result, in the PHDays conditions, the rule has worked out quite well <br><br><img src="https://habrastorage.org/web/e4b/6e7/1bc/e4b6e71bc0a64ab78eba824c4fe1af98.png"><br><br>  Now, any attempt to gain control over the host and initiate connections to its hosts was detected quite well. <br><br>  At some point, it became boring to look after all this and on the server we made chmod ‚Äìx / bin / nc. <br><br>  Result: <br><br><pre> <code class="hljs pgsql">[Tue May <span class="hljs-number"><span class="hljs-number">23</span></span> <span class="hljs-number"><span class="hljs-number">21</span></span>:<span class="hljs-number"><span class="hljs-number">41</span></span>:<span class="hljs-number"><span class="hljs-number">36.273170</span></span> <span class="hljs-number"><span class="hljs-number">2017</span></span>] [:error] [pid <span class="hljs-number"><span class="hljs-number">4203</span></span>] [client <span class="hljs-number"><span class="hljs-number">198.18</span></span><span class="hljs-number"><span class="hljs-number">.78</span></span><span class="hljs-number"><span class="hljs-number">.12</span></span>:<span class="hljs-number"><span class="hljs-number">23814</span></span>] PHP <span class="hljs-keyword"><span class="hljs-keyword">Notice</span></span>: Undefined <span class="hljs-keyword"><span class="hljs-keyword">index</span></span>: avatar <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> /var/www/html/models/<span class="hljs-keyword"><span class="hljs-keyword">User</span></span>.php <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> <span class="hljs-type"><span class="hljs-type">line</span></span> <span class="hljs-number"><span class="hljs-number">21</span></span>, referer: http://<span class="hljs-number"><span class="hljs-number">203.0</span></span><span class="hljs-number"><span class="hljs-number">.113</span></span><span class="hljs-number"><span class="hljs-number">.155</span></span>/<span class="hljs-keyword"><span class="hljs-keyword">login</span></span>.php sh: <span class="hljs-number"><span class="hljs-number">1</span></span>: /bin/nc: Permission denied sh: <span class="hljs-number"><span class="hljs-number">1</span></span>: /bin/nc: Permission denied</code> </pre><br>  Apparently, the people on the part of the Attackers were somewhat offended and the following requests went: <br><br><pre> <code class="apache hljs"><span class="hljs-attribute"><span class="hljs-attribute">198</span></span>.18.78.12 - -<span class="hljs-meta"><span class="hljs-meta"> [24/May/2017:01:48:33 +0400] "GET /xymfrxtestfilehu****.php?hu***a=%63%61%74%20%2f%74%6d%70%2f%6d%79%70%69%70%65%7c%2f%62%69%6e%2f%64%61%73%68%20%32%3e%26%31%7c%6e%63%20%2d%6c%20%39%39%39%39%20%3e%2f%74%6d%70%2f%6d%79%70%69%70%65 HTTP/1.1" 200 1985 "-" "Mozilla/5.0 (X11; Linux x86_64; rv:45.0) Gecko/20100101 Firefox/45.0"</span></span></code> </pre><br>  Overall results: <br><br><ol><li>  The connection to the database (remember, the web servers in the external segment, and their databases within the network) on all servers did not differ in originality: <br><br><pre> <code class="nginx hljs">define('DB_NAME', 'wordpress'); /** <span class="hljs-attribute"><span class="hljs-attribute">MySQL</span></span> database username */ define(<span class="hljs-string"><span class="hljs-string">'DB_USER'</span></span>, <span class="hljs-string"><span class="hljs-string">'wordpressuser'</span></span>); /** <span class="hljs-attribute"><span class="hljs-attribute">MySQL</span></span> database password */ define(<span class="hljs-string"><span class="hljs-string">'DB_PASSWORD'</span></span>, <span class="hljs-string"><span class="hljs-string">'secondstrongpassword'</span></span>); /** <span class="hljs-attribute"><span class="hljs-attribute">MySQL</span></span> hostname */ define(<span class="hljs-string"><span class="hljs-string">'DB_HOST'</span></span>, <span class="hljs-string"><span class="hljs-string">'o-srv05.office.cityf'</span></span>);</code> </pre><br>  Once they even took advantage of it :) <br><br></li><li>  Surprisingly, a large number of attempts to upload something to the server were detected by AV Kaspersky: <br><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">Object</span></span> HEUR:Backdoor.PHP.PhpShell.eg <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> detected <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> /var/www/modx/<span class="hljs-keyword"><span class="hljs-keyword">temp</span></span>/<span class="hljs-number"><span class="hljs-number">8</span></span>f18b8d9d5a4cdbbe1f2962fa3868dd4/fonts/s.php <span class="hljs-keyword"><span class="hljs-keyword">Object</span></span> HEUR:Backdoor.Multi.Mibsun.gen <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> detected <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> /tmp/.Xorg/tshd <span class="hljs-keyword"><span class="hljs-keyword">Object</span></span> HEUR:Backdoor.Linux.Agent.ai <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> detected <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> /tmp/.Xorg/tsh/tsh <span class="hljs-keyword"><span class="hljs-keyword">Object</span></span> HEUR:Exploit.Linux.CVE<span class="hljs-number"><span class="hljs-number">-2017</span></span><span class="hljs-number"><span class="hljs-number">-7308.</span></span>a <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> detected <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> /tmp/pwn123 <span class="hljs-keyword"><span class="hljs-keyword">Object</span></span> HEUR:Exploit.Linux.Dirtycow.a <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> detected <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> /tmp/cowroot</code> </pre><br></li><li>  Monitoring the error log of the web server + application launch audit - partially solve the problem of the lack of WAF. </li><li>  Without WAF very bad.  Quickly close some kind of hole in some cases is simply impossible. </li></ol><br>  <b>And where are the attacks inside the network?</b> <br><br>  During the entire monitoring period, not a single penetration of the attackers was recorded beyond the perimeter of the Office. <br><br>  Perhaps this is the biggest disappointment in the past PHDays, because working with callbacks, injected by malware and insiders is one of the very serious layers of life of current information security and SOC.  Communicating with colleagues from the teams of Defenders, we heard from everyone that the main vector is aimed at overcoming the perimeter: they crawl the web, sometimes they deface websites, exploit vulnerabilities. <br><br>  At the same time, we regularly conducted our checks on detections on different hosts, and all of them were successful.  Everything that we planned to detect - everything worked out. <br><br>  Unfortunately, due to the lack of attacks, detailed detection logic will not work.  Therefore, a couple of examples of how such detections look in our infrastructure: <br><br><ol><li>  An example of the implementation of the keylogger in the process mstsc.exe.  Alert on a non-signed library -&gt; We look at the calls to the process that loaded this library -&gt; By PID, we get further activity and source malicious libraries. <br><br><img src="https://habrastorage.org/web/78c/ba5/129/78cba51294a3414286c0403c2ca49488.jpg"><br><br></li><li>  SandBox SIEM ÔÅä This is what an ordinary cryptor looks like: <br><br><img src="https://habrastorage.org/web/61e/564/d15/61e564d15e9d46778bd97beead363727.png"><br></li></ol><br>  In general, the presence of unprotected infrastructure and the bank in the mode of monitoring rather than blocking has greatly changed the focus of attention of the Attackers.  Most of the time, they concentrated on hacking and auditing the protection of this particular infrastructure, and not on breaking through defensive redoubts of the Defenders and SOCs.  As a result, part of the rich attackers 'toolkit was not used on the Defenders' infrastructures, and part of the surprises of the Defenders and SOCs for detection and counteraction remained not fully tested in combat conditions. <br><br>  Nevertheless, one should not take this as criticism towards the organizers.  They did a tremendous amount of work on the launch of the event, infrastructures and complex integrations, and despite all the difficulties that arose, PHDays confirmed its status as one of the key information security conferences.  But SOCs and Defenders want more fire and hardcore, and we are ready to help in its invention;) </div><p>Source: <a href="https://habr.com/ru/post/329890/">https://habr.com/ru/post/329890/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../329880/index.html">JaCarta PKI and OpenVPN for Windows</a></li>
<li><a href="../329882/index.html">9 reasons that prevent you from becoming a timlid</a></li>
<li><a href="../329884/index.html">Machine intelligence in a Gboard keyboard</a></li>
<li><a href="../329886/index.html">Delegates and Lambda Expressions in C # .Net - Cheat Sheet or Briefly</a></li>
<li><a href="../329888/index.html">ACM ICPC 2017: Final Results</a></li>
<li><a href="../329892/index.html">What are women talking about? (Text mining of beauty blogs)</a></li>
<li><a href="../329894/index.html">Reactive Stream Log Processing with RxJava - Part 1</a></li>
<li><a href="../329896/index.html">Recipes for Android: Scroll-To-Dismiss Activity</a></li>
<li><a href="../329898/index.html">Must see: videos of MoscowJS 37 mitap</a></li>
<li><a href="../329900/index.html">Initial setup of Puppet is not as simple as it sounds.</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>