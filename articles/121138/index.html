<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>rtorrent + rutorrent + nginx + php-fpm. Underwater rocks</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The previous article about the rtorrent + rutorrent + nginx + php-fpm bundle was written right after a successful installation and initial configurati...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>rtorrent + rutorrent + nginx + php-fpm. Underwater rocks</h1><div class="post__text post__text-html js-mediator-article">  <a href="http://habrahabr.ru/blogs/linux/120167/">The previous article</a> about the rtorrent + rutorrent + nginx + php-fpm bundle was written right after a successful installation and initial configuration of this bundle.  During operation, some pitfalls emerged, which I want to talk about. <br><a name="habracut"></a><br><h4>  RPC </h4><br>  As it turned out, the nginx bundle with rutorrent + rtorrent worked fine, just write the following lines in the <b>conf / config.php file</b> in the rutorrent installation directory tree: <br><br> <code>$scgi_port = 33333; <br> $scgi_host = "127.0.0.1"; <br></code> <br><br>  At the same time, it is enough to register the network socket in the rtorrent <b>~ / .rtorrent.rc</b> file: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     <code>scgi_port = 127.0.0.1:33333</code> <br> <br>  In nginx, you no longer need to write backend for / RPC2, and from the rtorrent startup scripts you need to remove work with a local UNIX socket to control rtorrent. <br><br><h4>  Access rights </h4><br>  Naturally, in order for rutorrent to work successfully, you need the user, on behalf of which the nginx and php-fpm daemons work, to grant rights to all the files and directories of the rutorrent installation.  In my case, this is done by the command: <br><br> <code>sudo chown -R http:http /srv/http/nginx/rutorrent.eternity/htdocs</code> <br> <br><h4>  Php-fpm socket </h4><br>  When using php-fpm locally, it is better to put it on a UNIX socket.  To do this, <b>you</b> need to comment out the line with the network socket in the <b>/etc/php/php-fpm.conf</b> file: <br><br> <code>;listen = 127.0.0.1:9000</code> <br> <br>  And enter the line with a UNIX-socket below: <br><br> <code>listen = /var/run/php-fpm/php-fpm.sock</code> <br> <br>  After that, you need to reconfigure nginx.  In the <b>/etc/nginx/conf/nginx.conf</b> file, <b>we</b> bring the backend block to this form: <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">upstream</span></span> backend { <span class="hljs-attribute"><span class="hljs-attribute">server</span></span> unix:/var/run/php-fpm/php-fpm.sock; }</code> </pre> <br><br>  Using UNIX sockets reduces the load on the system, since checksums are not calculated, and the data stream is sent directly to the receive buffer.  Critical for embedded solutions only. <br><br><h4>  Security </h4><br>  When using nginx locally, it is best to land on 127.0.0.1.  To do this, in the <b>/etc/nginx/conf/sites-enabled/rutorrent.eternity</b> file <b>, the</b> line of <b>listen</b> should be reduced to the following form: <br><br> <code>listen 127.0.0.1:80;</code> <br> <br>  If this is not done, the web interface can be used by someone who knows the IP address of the computer.  To be able to remotely control rtorrent, you should take care of authentication (at least through the basic nginx authentication). <br><br><h4>  geoip </h4><br>  In order for the rutorrent module called geoip to work, you need to install the appropriate extension for PHP.  In my case ( <i>Arch Linux</i> ) this action looks like this: <br><br> <code>sudo pacman -S php-geoip</code> <br> <br>  Then in the <b>/etc/php/conf.d/geoip.ini</b> file <b>you</b> need to remove the comment from a single line so that it looks like this: <br><br> <code>extension=geoip.so</code> <br> <br>  You also need to activate the JSON plugin.  This is done by creating a <b>json.ini</b> file in the <b>/etc/php/conf.d directory</b> with the following contents: <br><br> <code>extension=json.so</code> <br> <br>  <b>Without the json plugin, nothing will work.</b> <br><br><h4>  Auxiliary programs </h4><br>  In order for rutorrent to find additional programs ( <i>curl, stat, mediainfo</i> ), first, they need to be installed: <br><br> <code>sudo pacman -S curl mediainfo</code> <br> <br>  Secondly, it is necessary to allow their execution.  To do this, you need to comment out the open_basedir line in the <b>/etc/php/php.ini</b> file: <br><br> <code>;open_basedir = /srv/http/:/home/:/tmp/:/usr/share/pear/</code> <br> <br>  And, thirdly, additional programs are required to be registered in the rutorrent configuration.  CURL and stat are written in the <b>conf / config.php file</b> of the rutorrent installation directory tree as follows: <br><br><pre> <code class="hljs php">$pathToExternals = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">"php"</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-string"><span class="hljs-string">"curl"</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'/usr/bin/curl'</span></span>, <span class="hljs-string"><span class="hljs-string">"gzip"</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-string"><span class="hljs-string">"id"</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-string"><span class="hljs-string">"stat"</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'/usr/bin/stat'</span></span>, );</code> </pre> <br><br>  The path to the mediainfo program is specified in the <b>plugins / mediainfo / conf.php</b> file of the <b>rutorrent</b> installation directory tree as follows: <br><br> <code>$pathToExternals['mediainfo'] = '/usr/bin/mediainfo';</code> <br> <br>  These paths can also be omitted if the PATH environment variable is set for the user on whose behalf daemon web part daemons are set. <br><br><h4>  Yummy </h4><br>  For myself, I made a script with the following contents: <br><br><pre> <code class="hljs mel">#!/usr/bin/<span class="hljs-keyword"><span class="hljs-keyword">env</span></span> bash delay=<span class="hljs-string"><span class="hljs-string">"1000"</span></span> pid1=<span class="hljs-string"><span class="hljs-string">`pidof rtorrent`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [[ $pid1 != <span class="hljs-string"><span class="hljs-string">""</span></span> ]] then notify-send -t $delay <span class="hljs-string"><span class="hljs-string">" rtorrentd‚Ä¶"</span></span> sudo rc.d stop rtorrentd notify-send -t $delay <span class="hljs-string"><span class="hljs-string">"rtorrentd "</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> notify-send -t $delay <span class="hljs-string"><span class="hljs-string">" rtorrentd‚Ä¶"</span></span> sudo rc.d start rtorrentd notify-send -t $delay <span class="hljs-string"><span class="hljs-string">"rtorrentd "</span></span> fi</code> </pre> <br><br>  This script is granted permissions to execute: <br><br> <code>sudo chown root:root x-rtorrentd-wrapper.sh <br> sudo chmod 755 x-rtorrentd-wrapper.sh</code> <br> <br>  The script itself is moved to <b>/ usr / bin</b> : <br><br> <code>sudo mv x-rtorrentd-wrapper.sh /usr/bin</code> <br> <br>  Then somewhere on the panel of your DE ( <i>I did everything in xfce</i> ) a button is hung up to launch this script.  If rtorrent is not running, the script will launch it, and if it is running, it will turn it off, while displaying a pop-up notification on the screen via libnotify.  Of course, for this you need to install libnotify: <br><br> <code>sudo pacman -S libnotify</code> <br> <br><h4>  Restart daemons </h4><br>  After performing all the above actions, you need to restart php-fpm and nginx: <br><br> <code>sudo rc.d restart php-fpm nginx</code> <br> <br>  As a result, the chances that the rutorrent will fully earn will increase substantially. <br><br>  <b>UPDATE 1:</b> added some explanation. <br><br>  <b>UPDATE 2:</b> updated partition with RPC.  Thank you <a href="https://habrahabr.ru/users/svin0/" class="user_link">svin0</a> . </div><p>Source: <a href="https://habr.com/ru/post/121138/">https://habr.com/ru/post/121138/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../121131/index.html">Panasonic has updated its "not killed" Toughbook CF-19</a></li>
<li><a href="../121132/index.html">Code-first in Entity Framework</a></li>
<li><a href="../121134/index.html">New Trojan for Android is distributed with the Angry Birds Rio Unlock app.</a></li>
<li><a href="../121136/index.html">Functions in bashrc. One more simple thing</a></li>
<li><a href="../121137/index.html">Set the virtual machine IP over MAC without using DHCP</a></li>
<li><a href="../121140/index.html">Configure the Cisco 79XX Series Phone to Work with Asterisk</a></li>
<li><a href="../121141/index.html">You should learn cobol</a></li>
<li><a href="../121142/index.html">GUNNARS: Upgrade an IT Man's View (Part 1)</a></li>
<li><a href="../121143/index.html">Box-box of diskettes</a></li>
<li><a href="../121145/index.html">Yandex.Maps will be paid for MTS subscribers</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>