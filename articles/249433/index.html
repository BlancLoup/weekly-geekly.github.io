<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>The study of the site blocking mechanism "Rostelecom" and ways to circumvent it</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this post I will give a little research on the site blocking mechanism by Rostelecom, and also show ways to bypass it without using different tunne...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>The study of the site blocking mechanism "Rostelecom" and ways to circumvent it</h1><div class="post__text post__text-html js-mediator-article">  In this post I will give a little research on the site blocking mechanism by Rostelecom, and also show ways to bypass it without using different tunnels to third-party hosts (proxies, vpn, etc.).  This probably applies to some other providers as well. <br><a name="habracut"></a><br><h3>  The result of the lock </h3><br>  HTTP sites of RT have been blocking for some time by URL, not by IP. <br>  When blocking, a redirect of the form comes in the form <a href="http://95.167.13.50/%3Fst%3D0%26dt%3D%253CIP%253E%26rs%3D%253CURL%253E">95.167.13.50/?st=0&amp;dt= &lt;IP&gt; &amp; rs = &lt;URL&gt;</a> , where &lt;IP&gt; is the IP that the browser was connected to, &lt;URL&gt; is the URL that it requested.  If you view the transmitted traffic, it becomes clear that only the beginning of the server response is overwritten, the rest remains as it is. <div class="spoiler">  <b class="spoiler_title">It looks like this</b> <div class="spoiler_text"><pre> HTTP / 1.1 302 Found
 Connection: close
 Location: http://95.167.13.50/?st=0&amp;dt=192.237.142.117&amp;rs=grani.ru/

 f-8
 Transfer-Encoding: chunked
 Connection: keep-alive

 6d7
 &lt;! DOCTYPE HTML&gt;
 &lt;html lang = "en" xmlns: fb = "http://www.facebook.com/2008/fbml"&gt;
   &lt;head&gt;



     &lt;meta charset = "utf-8"&gt;

     &lt;title&gt;
       Grani.Ru:
       the main thing
     &lt;/ title&gt;
 ...
</pre><br></div></div><div class="spoiler">  <b class="spoiler_title">Real site response</b> <div class="spoiler_text"><pre> HTTP / 1.1 200 OK
 Server: nginx / 1.2.1
 Date: Sun, 01 Feb 2015 17:34:03 GMT
 Content-Type: text / html;  charset = utf-8
 Transfer-Encoding: chunked
 Connection: keep-alive

 6d7
 &lt;! DOCTYPE HTML&gt;
 &lt;html lang = "en" xmlns: fb = "http://www.facebook.com/2008/fbml"&gt;
   &lt;head&gt;



     &lt;meta charset = "utf-8"&gt;

     &lt;title&gt;
       Grani.Ru:
       the main thing
     &lt;/ title&gt;
 ...
</pre><br></div></div>  Those.  By finding a way to restore headers, you can bypass the lock.  Obviously, this is not the most affordable way. <br><br><h3>  What and how is blocked </h3><br>  Obviously, blocking sites from RT on manual control. <br><br>  Not all sites from the registry are blocked.  At a minimum, there are several HTTPS sites that are not blocked at all. <br>  Typically, HTTPS sites are blocked by IP, sometimes the provider climbs into HTTPS, substituting your certificate, in which case there is a blocking by URL. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Sometimes the HTTPS site from the registry is blocked only by HTTP (by URL, rather than by IP, respectively) and is quietly accessible via HTTPS. <br><br><h3>  Exploring deeper </h3><br>  During a series of experiments, the following principles of blocking operation were identified: <br><ul><li>  The first line of the request looks for the name of the HTTP method, a space, a URL, a space, or?  or /. <br>  Reacts to the methods GET, POST, HEAD, DELETE, OPTIONS, TRACE.  The PUT method has apparently been forgotten, it is being skipped.  Other method names are also missing.  Names of methods with a modified case of characters are also missing. <br><br>  The check occurs only in the first line, if you insert an empty line at the beginning of the request, the request passes. <br>  If the URL is "/", then only the method name is searched. <br><br>  When adding extra space after the method name, the request also passes without problems if the URL is not equal to "/". <br>  Apparently, the URL is considered to have ended when space characters are found, "?"  or "/".  If you add some other character to the URL, the request passes.  Including, if you add a newline character, i.e.  remove "http / 1.1" from the request. </li><li>  URL coding (urlencode) does not help overcome censorship, including in different registers.  Even if you encode the initial slash (% 2F), the request is blocked, although the web server does not understand this anymore. </li><li>  Next, look for the Host header. <br>  And it is searched in the same package. <br>  And it is searched with the obligatory correspondence to the form ‚ÄúHost: &lt;HOST&gt;‚Äù.  Any extra character or change in the case of the header name (host, HOST) allows the request to pass. <br>  Changing the case of the characters of the domain itself does not help, however, the lock is triggered. </li></ul><br><br><h3>  Workarounds </h3><br>  Thus, we arrive at the following workarounds: <br><ul><li>  Adding a blank line to the beginning of the request  Not all web servers understand, in particular, nginx does not understand. </li><li>  Add space before URL.  This is understood by popular web servers.  However, there may be problems in rare cases (such as <a href="http://habrahabr.ru/company/enterra/blog/241732/">here</a> ) </li><li>  Add some character after the URL.  Obviously, it should be some character that the web server ignores, but the censor unit decides that it is part of the URL.  I could not find such a symbol. </li><li>  Remove the protocol name and version ("HTTP / 1.1").  In this case, the request is perceived by the web server as HTTP / 1.0, and in this version of the protocol there was no Host header, so this will not work with many sites. </li><li>  Sending URL and Host in different packages. <br>  You can simply call send for the first line of the request (HTTP method and URL) and then send the rest of the request in the usual way. <br>  You can add a sufficiently large header (about 1,530 bytes to fill the entire packet for sure) between these lines. <br>  Problems with web servers in such cases are not revealed. </li><li>  Modification of the Host header. <br>  You can change the register, add spaces before and after the domain. <br>  Problems with web servers in such cases are not revealed. </li></ul><br><br><h3>  Practical implementation </h3><br>  I chose a 3proxy based implementation.  It includes a plugin that allows you to modify all the transmitted data based on regular expressions.  At the same time, the proxy is quite light and undemanding, it can be installed on an ordinary router. <br><br>  In accordance with the foregoing, the most convenient options in practice are the addition of an extra header before the Host and a modification of the Host header.  Obviously, Host modification is preferable, since  does not increase the size of the request.  I regularly use this method to decide for myself what information I can consume. <br><br>  But generally both options are easily customizable: <br><div class="spoiler">  <b class="spoiler_title">Add extra header</b> <div class="spoiler_text"><pre> pcre_rewrite cliheader dunno "Host:" "X-Something: \ r \ nHost:"
</pre></div></div><div class="spoiler">  <b class="spoiler_title">Header modification</b> <div class="spoiler_text"><pre> pcre_rewrite cliheader dunno "Host:" "HOST:"
</pre></div></div><br><div class="spoiler">  <b class="spoiler_title">Basic config</b> <div class="spoiler_text"><pre> # dns servers
 nserver 77.88.8.8
 nserver 8.8.8.8
 # cache dns
 nscache 65536
 # work in the background
 daemon
 # plugin connection, you should specify the full path
 plugin PCREPlugin.ld.so pcre_plugin
 # one of the rules described above
 pcre_rewrite ...
 # launch proxy, option -a allows to get rid of Forwarded-For and Via headers
 proxy -a -p8080 </pre></div></div><br><br>  <b>UPD:</b> <br>  <b>@ValdikSS made a very interesting note:</b> <br><blockquote>  You had to look at the traffic that comes to the interface from Rostelecom.  It is likely that the DPI is connected in parallel, rather than sequentially, and only client traffic arrives there.  Since  The DPI is clearly closer than the website, the Location package from the DPI comes faster than the real first package from the site, and the package from the site is already dropped by the OS kernel as a retransmission, so if you use Linux, one line in iptables is enough to bypass the blocking : <br><br><pre><code class="hljs cs">iptables -A INPUT -p tcp --sport <span class="hljs-number"><span class="hljs-number">80</span></span> -m <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> --algo bm --<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> <span class="hljs-string"><span class="hljs-string">"http://95.167.13.50/?st"</span></span> -j DROP</code> </pre> </blockquote><br>  <b>From me:</b> <br><blockquote>  Indeed, there is a retransmission.  I watched the traffic, but obviously not carefully enough. <br>  First comes a package in which only HTTP 302 and Location, then comes a package with a normal site response. <br>  However, the system does not discard the second packet, but uniquely combines with the first. <br>  Those.  packages come <br><div class="spoiler">  <b class="spoiler_title">one</b> <div class="spoiler_text"><pre> HTTP / 1.1 302 Found
 Connection: close
 Location: http://95.167.13.50/?st=0&amp;dt=192.237.142.117&amp;rs=grani.ru/

</pre></div></div><div class="spoiler">  <b class="spoiler_title">2</b> <div class="spoiler_text"><pre> HTTP / 1.1 200 OK
 Server: nginx / 1.2.1
 Date: Sun, 01 Feb 2015 17:34:03 GMT
 Content-Type: text / html;  charset = utf-8
 Transfer-Encoding: chunked
 Connection: keep-alive

 6d7
 &lt;! DOCTYPE HTML&gt;
 ...
</pre></div></div>  And the application sees it. <br><div class="spoiler">  <b class="spoiler_title">So</b> <div class="spoiler_text"><pre> HTTP / 1.1 302 Found
 Connection: close
 Location: http://95.167.13.50/?st=0&amp;dt=192.237.142.117&amp;rs=grani.ru/

 f-8
 Transfer-Encoding: chunked
 Connection: keep-alive

 6d7
 &lt;! DOCTYPE HTML&gt;
 ...
</pre></div></div><br>  This is observed in both Windows and Linux. <br><br>  But the above iptables rule really solves the issue. </blockquote><br>  So +1 workaround. <br><br>  This method can also be used on the gateway / router.  The rule is, of course, necessary to be added to the FORWARD chain. </div><p>Source: <a href="https://habr.com/ru/post/249433/">https://habr.com/ru/post/249433/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../249423/index.html">Find typos in ** kwargs</a></li>
<li><a href="../249425/index.html">Pundle - bundler for python</a></li>
<li><a href="../249427/index.html">New invariant of a natural number. Theorem and proof</a></li>
<li><a href="../249429/index.html">On the existence of periodic solutions in the Lorentz system</a></li>
<li><a href="../249431/index.html">Divide by zero is the norm. Part 2</a></li>
<li><a href="../249435/index.html">How to download Microsoft Office 16 from the Microsoft website</a></li>
<li><a href="../249437/index.html">EFF plan to eliminate mass surveillance</a></li>
<li><a href="../249439/index.html">Vivaldi: Opera successor short</a></li>
<li><a href="../249441/index.html">The digest of interesting materials from the world of web development and IT for the last week No. 145 (January 26 - February 1, 2015)</a></li>
<li><a href="../249445/index.html">Minimal viability for mobile applications</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>