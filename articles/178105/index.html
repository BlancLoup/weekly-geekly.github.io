<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Very fast Windows user switching</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I want to share with you a life hack, which I have been using daily for several years now. It works flawlessly, saves time. It so happened that my wif...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Very fast Windows user switching</h1><div class="post__text post__text-html js-mediator-article"><img align="left" src="https://habrastorage.org/storage2/70d/d85/7f5/70dd857f568b924a825d8a0e30e61fd1.png">  I want to share with you a life hack, which I have been using daily for several years now.  It works flawlessly, saves time.  It so happened that my wife and I had different accounts on the same home computer.  This is convenient: each has its own desktop, its own wallpaper, preferences, application settings, cookies in the browser.  I can not even imagine now how to work under one account.  But (without this ‚Äúbut‚Äù there would be no article), there is one small problem.  Switch users.  As is usually done: Start -&gt; some button, depending on the system -&gt; change user.  A user selection screen appears.  We poke into the necessary user.  Yes, there is a combination of keys Win + L.  After which again you need to poke a user change and an icon.  Total at least 3 actions.  Windows 8 made a noticeable improvement in this regard.  Click the Win + user icon and click on another in the list.  But this is without taking into account that there is a password on accounting.  This is where substantial delays begin.  Entering a password every time you switch will bother you very quickly.  And I had to set a password for my account, because I needed remote access.  Yes, it was possible to make another account for remote access, but my life hack was already ready for that moment, and it worked fine regardless of whether there are passwords on the account or not. <br><a name="habracut"></a><br>  And the idea was this.  Make it so that fast user switching happens in a single action.  By pressing a hotkey.  The search on the Internet (I remind you, it was 3 years ago) bore fruit, and similar solutions were found.  But, free or buggy, or require the installation of some third-party software.  A paid, high-quality one was found, and one worked very well, but, first, it was paid, and second, it contained extra functionality ‚Äî by pressing the hotkey, the user did not immediately switch, but the window was displayed (similar to Alt + Tab) by users.  It was decided to write your decision.  The simplest, with a minimum of functionality: hotkey - switching. <br><br>  Google issued: <ul><li>  To switch sessions, use the functions wtsapi32.dll: <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/aa383833(v%3Dvs.85).aspx">WTSEnumerateSessions</a> , <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/bb394782(v%3Dvs.85).aspx">WTSConnectSession</a> , <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/aa383830(v%3Dvs.85).aspx">WTSDisconnectSession</a> (Now, when I look at the description of these functions, it says that it works with remote work sessions, and frankly, I am a little perplexed, but it works locally, flawlessly) . </li><li>  For hotkeys, use the user32.dll functions: <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/ms646309(v%3Dvs.85).aspx">RegisterHotKey</a> , <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/ms646327(v%3Dvs.85).aspx">UnregisterHotKey</a> .  It's simple. </li></ul><br>  Immediately make a reservation, and you can throw tomatoes at me, but I wrote this thing on c #, although on the pros, it would certainly be better, more native and so on, and so on ... But, then I just started learning c # and I needed experience, and when the decision was written, it was not necessary to rewrite it, although its transfer would not take more than one evening. <br><br>  So, for starters, it was written a simple win32 application with a button, which, when clicked, would run something like this: <br><pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SwitchUser</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { IntPtr buffer = IntPtr.Zero; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> count = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-comment"><span class="hljs-comment">//   ,     if (WTSEnumerateSessions(WTS_CURRENT_SERVER_HANDLE, 0, 1, ref buffer, ref count)) { WTS_SESSION_INFO[] sessionInfo = new WTS_SESSION_INFO[count]; //   : //       for (int index = 0; index &lt; count; index++) sessionInfo[index] = (WTS_SESSION_INFO)Marshal.PtrToStructure((IntPtr)((int)buffer + (Marshal.SizeOf(new WTS_SESSION_INFO()) * index)), typeof(WTS_SESSION_INFO)); int activeSessId = -1; int targetSessId = -1; //  Id ,    // 0 ,   "Services" for (int i = 1; i &lt; count; i++) { if (sessionInfo[i].State == WTS_CONNECTSTATE_CLASS.WTSDisconnected) targetSessId = sessionInfo[i].SessionId; else if (sessionInfo[i].State == WTS_CONNECTSTATE_CLASS.WTSActive) activeSessId = sessionInfo[i].SessionId; } if ((activeSessId &gt; 0) &amp;&amp; (targetSessId &gt; 0)) { //    ,    . WTSConnectSession(Convert.ToUInt64(targetSessId), Convert.ToUInt64(activeSessId), "", false); } else { //   .   (    ) WTSDisconnectSession(WTS_CURRENT_SERVER_HANDLE, activeSessId, false); } } //    WTSFreeMemory(buffer); }</span></span></code> </pre> <br>  With two sessions, sessionInfo will have 3 elements: a session of services, a session of the 1st user, a session of the 2nd user.  Accordingly, targetSessId and activeSessId are uniquely determined.  For sessions over 2, switching will occur between the active and the last inactive. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      But then I suffered a small setback.  Some could already guess that this would not work.  When WTSConnectSession is executed from the application, the active user is disconnected, but the inclusion of the second user is not.  Those.  in other words, one user‚Äôs application cannot initiate another user‚Äôs login.  But the service can do it!  Yes, it‚Äôs a pity, but without system service we‚Äôll fail.  Well, let's create a system service in which we drop this code.  This is where C # and .Net come in handy, since writing a service on these technologies is <a href="http://msdn.microsoft.com/ru-ru/library/zt39148a.aspx">very</a> , <a href="http://habrahabr.ru/post/102826/">very simple</a> .  Now the following problem occurs: the service does not have a user interface, i.e.  the user cannot directly affect the operation of the service, and the service cannot hear the actions of the user.  Hang a hot key on the service can not. <br><br>  So, here is our solution: <br>  The user application listens to the user, and when a hotkey is detected, it sends a signal to the system service, which performs the switch. <br><br>  Very little is left, but even here I can find something to show you.  For example, what we need is a desktop application, without windows, but for it to accept hotkeys.  This can be done as everyone else does: Hide the main application window and do not show it.  But there is a better solution.  Write your <a href="http://msdn.microsoft.com/en-us/library/ms157901.aspx">ApplicationContext</a> .  <s>With black</s> <br>  For example: <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">internal</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">SUApplicationContext</span></span>: <span class="hljs-title"><span class="hljs-title">ApplicationContext</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Hotkey hk; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Form form; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> SWITCH_USER_COMMAND = <span class="hljs-number"><span class="hljs-number">193</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SUApplicationContext</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-comment"><span class="hljs-comment">//   ,     //    form = new Form(); //    Win+A hk = new Hotkey(Keys.A, false, false, false, true); //    hk.Pressed += delegate { SendSwitchCommand(); }; //  ,   if (hk.GetCanRegister(form)) hk.Register(form); //     Application.ApplicationExit += Application_ApplicationExit; } private void SendSwitchCommand() { //    ServiceController sc = new ServiceController("Sus"); try { //    sc.ExecuteCommand(SWITCH_USER_COMMAND); } catch (Exception ex) { MessageBox.Show(ex.Message); } } void Application_ApplicationExit(object sender, EventArgs e) { //     if (hk.Registered) hk.Unregister(); } } [STAThread] static void Main() { Application.EnableVisualStyles(); Application.SetCompatibleTextRenderingDefault(false); Application.Run(new SUApplicationContext()); }</span></span></code> </pre><br>  Here I use the <a href="http://bloggablea.wordpress.com/2007/05/01/global-hotkeys-with-net/">MovablePython.Hotkey</a> interface found on the Internet over user32.dll functions RegisterHotKey, UnregisterHotKey. <br><br>  And a couple of lines about the service itself. <br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnCustomCommand</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> command</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">base</span></span>.OnCustomCommand(command); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (command == SWITCH_USER_COMMAND) { SwitchUser(); } }</code> </pre><br>  We override the OnCustomCommand event, and when we receive our command, we perform the function already known to us. <br><br>  It remains to register and start the service, and put an application in the autoload for each user. <br><br>  Everything.  Now, after the first user has logged in after starting the computer and pressed Win + A, his session is disconnected, and the user selection window appears.  The second user enters, presses Win + A - the first user session appears.  Etc. <br><br>  On github you can see the <a href="https://github.com/indomit/vfsus">source code</a> .  Or you can <a href="">download the</a> entire project and compiled and ready-to-run executables. </div><p>Source: <a href="https://habr.com/ru/post/178105/">https://habr.com/ru/post/178105/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../178091/index.html">AWS AMAZON - how do you optimize resources</a></li>
<li><a href="../178095/index.html">What is ASO and why it is urgently needed by today's developers</a></li>
<li><a href="../178097/index.html">An open letter to Eric Schmidt about banning private drones</a></li>
<li><a href="../178099/index.html">The first Ukrainian SSD drive or the second life of a Swiss computer</a></li>
<li><a href="../178103/index.html">Mathematical model of the engine Lego NXT</a></li>
<li><a href="../178107/index.html">Practice remote work: a look from the inside</a></li>
<li><a href="../178111/index.html">IP PBX based on 3CX Phone System: features and configuration</a></li>
<li><a href="../178117/index.html">Bare-Metal Deployment - or how cloud elasticity is ensured in System Center 2012 SP1 Virtual Machine Manager</a></li>
<li><a href="../178119/index.html">Installing Chrome extensions and applications from the developer‚Äôs site</a></li>
<li><a href="../178125/index.html">Wiki Weapon rifle: 12 thermoplastic parts on a 3D printer</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>