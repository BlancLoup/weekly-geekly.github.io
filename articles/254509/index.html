<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Unit testing of Yii2 behavior with Codeception</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In software development, writing automatic tests is often overshadowed by more pressing issues. So in my case, the code had to be written, but tests f...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Unit testing of Yii2 behavior with Codeception</h1><div class="post__text post__text-html js-mediator-article">  In software development, writing automatic tests is often overshadowed by more pressing issues.  So in my case, the code had to be written, but tests for it were not.  At the same time, I wanted to try modular testing of my own code for a long time, and then the behavior of <a href="https://github.com/voskobovich/ManyToManyBehavior">Yii2 ManyToMany Behavior</a> , which was <a href="http://habrahabr.ru/post/244709/">already written on Habr√©,</a> turned up.  I first expanded this behavior a bit, and then decided to put together a test suite. <br><br>  The tests themselves, including those referred to in this article, can be viewed in the repository at the link above.  All the commands were executed under Windows with a globally installed composer, but I think that developers using Linux can easily adapt them for themselves. <br><br>  Next, we look at setting up a Codeception with a module for Yii2 and creating tests for behavior. <br><a name="habracut"></a><br><h2>  Why test? </h2><br>  Are automatic tests worth the time spent on their development?  It is difficult to answer unequivocally. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      When I decided to participate in the development of Yii2 ManyToMany Behavior, the functionality for working with connections of type 1-N was partially implemented and not tested.  At a minimum, I had to make sure that the existing code was working.  If I had not written automatic tests, I would still have to create some kind of Yii2 application, connect behavior to its models, and then check whether it works on some test data.  From this point of view, tests are beneficial, since the costs of writing the tests themselves are a drop in the ocean compared to the preparation of test data and test application.  In addition, the behavior being developed is a fairly simple thing, which requires only the standard Yii2 code, which is almost guaranteed to work.  This greatly facilitates the preparation of tests. <br>  In my case, the tests automatically justified themselves.  As it turned out, by resolving the conflict when merging branches, I ruined something, and the 1-N connections ceased to exist.  Thanks to the test, I quickly found the error and corrected it. <br><br><h2>  What are we testing? </h2><br>  Behavior, which we are considering, while maintaining the model also allows you to save its connection with other models.  For example, consider a simple data structure consisting of books ( <b>Book</b> ), authors ( <b>Author</b> ), and reviews of books ( <b>Review</b> ).  Books and authors are related as NN, that is, a book can have many authors, and the author has many books.  Books and reviews are related as 1-N, that is, a book can have a lot of reviews, but each review can relate to only one book. <br><br><img src="https://habrastorage.org/files/479/c18/371/479c18371f5a4b6f97c758859f956987.png"><br><br>  During testing, we will save one book with all its links.  When saving the model, it is necessary to consider several possible input data options: <br><ol><li>  A non-empty array of identifiers of the associated model.  At the same time, old links should be removed and new ones created. </li><li>  An empty array, as a result of which the old connections must be removed. </li><li>  Complete lack of data, corresponding, for example, to the editing form of a book in which there are no fields relating to the authors.  In this case, the behavior should not do anything, that is, the existing connections should not change. </li></ol><br>  It is necessary to check the behavior of behavior in all three cases. <br><br><h2>  Features Associated with Yii2 </h2><br>  Since the behavior is intended to work with Yii2, there is no point in testing it without the rest of the framework.  For testing, we will actually create a console application Yii2, and in it we will operate with models.  We consider the model from the database, pass on the necessary parameters to it, save it, read it again from the database, and check if it is saved correctly. <br><br>  Of course, for testing we need a database.  Fortunately, for our task it is not necessary to have a separate database server.  It will be enough to use the SQLite DBMS, which is supported by Yii2 and stores the database in a file.  The test data themselves will be stored as a dump, which is loaded before each test. <br><br><h2>  Configure Codeception </h2><br>  First, with the help of composer, let's execute a global codeception installation: <br><br><pre><code class="bash hljs">composer global require codeception/codeception</code> </pre> <br>  Now we will prepare everything necessary to test our behavior.  In the behavior directory there is already a file <b>composer.json</b> , which describes the behavior and its dependencies.  Add the <b>yii2-codeception</b> library to it: <br><br><pre> <code class="bash hljs">composer require --dev yiisoft/yii2-codeception</code> </pre><br>  Then, we initialize the <b>codeception</b> environment in the behavior directory: <br><br><pre> <code class="bash hljs">codecept bootstrap --customize</code> </pre><br>  The name of the actor ( <b>actor</b> ) can be left as default ( <b>Tester</b> ), and we need only one set of tests ( <b>suite</b> ) - <b>unit</b> . <br><br>  The <b>tests</b> directory and the <b>codeception.yml</b> file will <b>appear</b> , in which we will set the necessary parameters.  The default settings are fine with us, except for connecting to the database. <br><br><pre> <code class="hljs pgsql">actor: Tester paths: tests: tests <span class="hljs-keyword"><span class="hljs-keyword">log</span></span>: tests/_output data: tests/_data helpers: tests/_support settings: bootstrap: _bootstrap.php colors: <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> memory_limit: <span class="hljs-number"><span class="hljs-number">1024</span></span>M modules: config: Db: dsn: <span class="hljs-string"><span class="hljs-string">'sqlite:tests/_output/temp.db'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>: <span class="hljs-string"><span class="hljs-string">''</span></span> <span class="hljs-keyword"><span class="hljs-keyword">password</span></span>: <span class="hljs-string"><span class="hljs-string">''</span></span> dump: tests/_data/dump.<span class="hljs-keyword"><span class="hljs-keyword">sql</span></span></code> </pre><br>  Now you need to configure the <b>unit</b> test suite in the <b>files / unit.suite.yml file</b> : <br><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">class_name</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">UnitTester</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">modules</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">enabled</span></span>: <span class="hljs-selector-attr"><span class="hljs-selector-attr">[Asserts, Db]</span></span></code> </pre><br>  Module <b>UnitHelper</b> , which was enabled by default, we do not need, but we added <b>Asserts</b> and <b>Db</b> .  Now we will build the environment taking into account the selected modules: <br><br><pre> <code class="bash hljs">codecept build</code> </pre><br>  Finally, you need to configure the Yii2 autoloader in the <b>tests / _bootstrap.php file</b> : <br><pre> <code class="php hljs">defined(<span class="hljs-string"><span class="hljs-string">'YII_DEBUG'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> define(<span class="hljs-string"><span class="hljs-string">'YII_DEBUG'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); defined(<span class="hljs-string"><span class="hljs-string">'YII_ENV'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> define(<span class="hljs-string"><span class="hljs-string">'YII_ENV'</span></span>, <span class="hljs-string"><span class="hljs-string">'dev'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">require_once</span></span> <span class="hljs-keyword"><span class="hljs-keyword">__DIR__</span></span> . implode(DIRECTORY_SEPARATOR, [<span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-string"><span class="hljs-string">'..'</span></span>, <span class="hljs-string"><span class="hljs-string">'vendor'</span></span>, <span class="hljs-string"><span class="hljs-string">'autoload.php'</span></span>]); <span class="hljs-keyword"><span class="hljs-keyword">require_once</span></span> <span class="hljs-keyword"><span class="hljs-keyword">__DIR__</span></span> . implode(DIRECTORY_SEPARATOR, [<span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-string"><span class="hljs-string">'..'</span></span>, <span class="hljs-string"><span class="hljs-string">'vendor'</span></span>, <span class="hljs-string"><span class="hljs-string">'yiisoft'</span></span>, <span class="hljs-string"><span class="hljs-string">'yii2'</span></span>, <span class="hljs-string"><span class="hljs-string">'Yii.php'</span></span>]); Yii::setAlias(<span class="hljs-string"><span class="hljs-string">'@tests'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">__DIR__</span></span>); Yii::setAlias(<span class="hljs-string"><span class="hljs-string">'@data'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">__DIR__</span></span> . DIRECTORY_SEPARATOR . <span class="hljs-string"><span class="hljs-string">'_data'</span></span>);</code> </pre><br>  Before writing tests, you need to prepare a database dump and create model classes. <br><br><h2>  Database dump preparation </h2><br>  To create a database structure, it is convenient to use a visual tool, such as <a href="http://sqlitebrowser.org/">DB Browser for SQLite</a> . <br><br>  Create <b>book</b> , <b>author</b> , <b>review</b> and <b>book_has_author tables</b> , fill them with test data.  Then we do a dump and save it to <b>tests / _data / dump.sql</b> . <br><br>  My dump looks like this: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRANSACTION</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-string"><span class="hljs-string">"review"</span></span> ( <span class="hljs-string"><span class="hljs-string">`id`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">INTEGER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> AUTOINCREMENT, <span class="hljs-string"><span class="hljs-string">`book_id`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">INTEGER</span></span>, <span class="hljs-string"><span class="hljs-string">`comment`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">150</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`rating`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">INTEGER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> <span class="hljs-string"><span class="hljs-string">`review`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>,<span class="hljs-string"><span class="hljs-string">' ,   .'</span></span>,<span class="hljs-number"><span class="hljs-number">5</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> <span class="hljs-string"><span class="hljs-string">`review`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">2</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>,<span class="hljs-string"><span class="hljs-string">'!'</span></span>,<span class="hljs-number"><span class="hljs-number">5</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> <span class="hljs-string"><span class="hljs-string">`review`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">3</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>,<span class="hljs-string"><span class="hljs-string">'.'</span></span>,<span class="hljs-number"><span class="hljs-number">4</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> <span class="hljs-string"><span class="hljs-string">`review`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">4</span></span>,<span class="hljs-number"><span class="hljs-number">5</span></span>,<span class="hljs-string"><span class="hljs-string">'!'</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-string"><span class="hljs-string">"book_has_author"</span></span> ( <span class="hljs-string"><span class="hljs-string">`book_id`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">INTEGER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`author_id`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">INTEGER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> <span class="hljs-string"><span class="hljs-string">`book_has_author`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> <span class="hljs-string"><span class="hljs-string">`book_has_author`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> <span class="hljs-string"><span class="hljs-string">`book_has_author`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">2</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> <span class="hljs-string"><span class="hljs-string">`book_has_author`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">2</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> <span class="hljs-string"><span class="hljs-string">`book_has_author`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">3</span></span>,<span class="hljs-number"><span class="hljs-number">4</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> <span class="hljs-string"><span class="hljs-string">`book_has_author`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">4</span></span>,<span class="hljs-number"><span class="hljs-number">5</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> <span class="hljs-string"><span class="hljs-string">`book_has_author`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">4</span></span>,<span class="hljs-number"><span class="hljs-number">6</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> <span class="hljs-string"><span class="hljs-string">`book_has_author`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">5</span></span>,<span class="hljs-number"><span class="hljs-number">9</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-string"><span class="hljs-string">"book"</span></span> ( <span class="hljs-string"><span class="hljs-string">`id`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">INTEGER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> AUTOINCREMENT, <span class="hljs-string"><span class="hljs-string">`name`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">150</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`year`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">INTEGER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> <span class="hljs-string"><span class="hljs-string">`book`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-string"><span class="hljs-string">'   .'</span></span>,<span class="hljs-number"><span class="hljs-number">2004</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> <span class="hljs-string"><span class="hljs-string">`book`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">2</span></span>,<span class="hljs-string"><span class="hljs-string">':   /.'</span></span>,<span class="hljs-number"><span class="hljs-number">2005</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> <span class="hljs-string"><span class="hljs-string">`book`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">3</span></span>,<span class="hljs-string"><span class="hljs-string">'   .'</span></span>,<span class="hljs-number"><span class="hljs-number">1964</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> <span class="hljs-string"><span class="hljs-string">`book`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">4</span></span>,<span class="hljs-string"><span class="hljs-string">'   .'</span></span>,<span class="hljs-number"><span class="hljs-number">1979</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> <span class="hljs-string"><span class="hljs-string">`book`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">5</span></span>,<span class="hljs-string"><span class="hljs-string">'.     .'</span></span>,<span class="hljs-number"><span class="hljs-number">2004</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-string"><span class="hljs-string">"author"</span></span> ( <span class="hljs-string"><span class="hljs-string">`id`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">INTEGER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> AUTOINCREMENT, <span class="hljs-string"><span class="hljs-string">`name`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">150</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> <span class="hljs-string"><span class="hljs-string">`author`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-string"><span class="hljs-string">' ..'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> <span class="hljs-string"><span class="hljs-string">`author`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">2</span></span>,<span class="hljs-string"><span class="hljs-string">' ..'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> <span class="hljs-string"><span class="hljs-string">`author`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">3</span></span>,<span class="hljs-string"><span class="hljs-string">' ..'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> <span class="hljs-string"><span class="hljs-string">`author`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">4</span></span>,<span class="hljs-string"><span class="hljs-string">' ..'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> <span class="hljs-string"><span class="hljs-string">`author`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">5</span></span>,<span class="hljs-string"><span class="hljs-string">' ..'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> <span class="hljs-string"><span class="hljs-string">`author`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">6</span></span>,<span class="hljs-string"><span class="hljs-string">' ..'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> <span class="hljs-string"><span class="hljs-string">`author`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">7</span></span>,<span class="hljs-string"><span class="hljs-string">' ..'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> <span class="hljs-string"><span class="hljs-string">`author`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">8</span></span>,<span class="hljs-string"><span class="hljs-string">' ..'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> <span class="hljs-string"><span class="hljs-string">`author`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">9</span></span>,<span class="hljs-string"><span class="hljs-string">' ..'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">COMMIT</span></span>;</code> </pre><br><br><h2>  Configuring the application </h2><br>  Since our behavior will be tested within the console application, you need to prepare a configuration for it.  Create the file <b>tests / unit / _config.php</b> : <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [ <span class="hljs-string"><span class="hljs-string">'id'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'app-console'</span></span>, <span class="hljs-string"><span class="hljs-string">'class'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'yii\console\Application'</span></span>, <span class="hljs-string"><span class="hljs-string">'basePath'</span></span> =&gt; \Yii::getAlias(<span class="hljs-string"><span class="hljs-string">'@tests'</span></span>), <span class="hljs-string"><span class="hljs-string">'runtimePath'</span></span> =&gt; \Yii::getAlias(<span class="hljs-string"><span class="hljs-string">'@tests/_output'</span></span>), <span class="hljs-string"><span class="hljs-string">'bootstrap'</span></span> =&gt; [], <span class="hljs-string"><span class="hljs-string">'components'</span></span> =&gt; [ <span class="hljs-string"><span class="hljs-string">'db'</span></span> =&gt; [ <span class="hljs-string"><span class="hljs-string">'class'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'\yii\db\Connection'</span></span>, <span class="hljs-string"><span class="hljs-string">'dsn'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'sqlite:'</span></span>.\Yii::getAlias(<span class="hljs-string"><span class="hljs-string">'@tests/_output/temp.db'</span></span>), <span class="hljs-string"><span class="hljs-string">'username'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-string"><span class="hljs-string">'password'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">''</span></span>, ] ] ];</code> </pre><br><h2>  Creating models </h2><br>  We create model class files in the <b>tests / _data</b> directory and give them the <b>namespace data</b> .  In order not to do this manually, I in a different directory unfolded the <b>basic</b> application template, connected it to the database and created classes using <b>gii</b> . <br><br>  It is important that the desired relationship be declared in the <b>Book</b> model: <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getAuthors</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;hasMany(Author::className(), [<span class="hljs-string"><span class="hljs-string">'id'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'book_id'</span></span>]) -&gt;viaTable(<span class="hljs-string"><span class="hljs-string">'book_has_author'</span></span>, [<span class="hljs-string"><span class="hljs-string">'author_id'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'id'</span></span>]); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getReviews</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;hasMany(Review::className(), [<span class="hljs-string"><span class="hljs-string">'book_id'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'id'</span></span>]); }</code> </pre><br>  We also add the following behavior: <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">behaviors</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [ [ <span class="hljs-string"><span class="hljs-string">'class'</span></span> =&gt; \voskobovich\behaviors\ManyToManyBehavior::className(), <span class="hljs-string"><span class="hljs-string">'relations'</span></span> =&gt; [ <span class="hljs-string"><span class="hljs-string">'author_list'</span></span> =&gt; [<span class="hljs-string"><span class="hljs-string">'authors'</span></span>], <span class="hljs-string"><span class="hljs-string">'review_list'</span></span> =&gt; [<span class="hljs-string"><span class="hljs-string">'reviews'</span></span>], ] ] ]; }</code> </pre><br>  Be sure to specify the validator for the attributes that are created by the behavior: <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">rules</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [ [[<span class="hljs-string"><span class="hljs-string">'author_list'</span></span>, <span class="hljs-string"><span class="hljs-string">'review_list'</span></span>], <span class="hljs-string"><span class="hljs-string">'safe'</span></span>], ...</code> </pre><br>  Now you can write the tests themselves. <br><br><h2>  Creating tests </h2><br>  In <b>codeception,</b> test cases are drawn up as classes.  To work with Yii2 objects, you need to create a class inherited from <b>yii \ codeception \ TestCase</b> .  The class name and file name must end with <b>Test</b> . <br><br>  In the <b>tests / unit / BehaviorTest.php</b> file, we will create a <b>BehaviorTest</b> test case, and in it the <b>testSaveManyToMany</b> method, which checks whether the correct data set is stored for the NN connection: <br><br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BehaviorTest</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> \</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">yii</span></span></span><span class="hljs-class">\</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">codeception</span></span></span><span class="hljs-class">\</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TestCase</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> $appConfig = <span class="hljs-string"><span class="hljs-string">'@tests/unit/_config.php'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testSaveManyToMany</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//load $book = Book::findOne(5); //simulate form input $post = [ 'Book' =&gt; [ 'author_list' =&gt; [7, 9, 8] ] ]; $this-&gt;assertTrue($book-&gt;load($post), 'Load POST data'); $this-&gt;assertTrue($book-&gt;save(), 'Save model'); //reload $book = Book::findOne(5); //must have three authors $this-&gt;assertEquals(3, count($book-&gt;authors), 'Author count after save'); //must have authors 7, 8, and 9 $author_keys = array_keys($book-&gt;getAuthors()-&gt;indexBy('id')-&gt;all()); $this-&gt;assertContains(7, $author_keys, 'Saved author exists'); $this-&gt;assertContains(8, $author_keys, 'Saved author exists'); $this-&gt;assertContains(9, $author_keys, 'Saved author exists'); } ...</span></span></code> </pre><br>  We perform actions that are usually associated with the preservation of the form  Certain data comes from the request ( <b>$ post</b> variable).  The <b>load ()</b> method is used to write this data to model attributes.  The model is then saved using the <b>save ()</b> method. <br><br>  After our manipulations, the book should have three authors with keys 7, 8 and 9, which is verified. <br><br>  Other tests are described similarly, for example, saving an empty data set for a 1-N connection: <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testResetOneToMany</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//load $book = Book::findOne(3); //simulate form input $post = [ 'Book' =&gt; [ 'review_list' =&gt; [] ] ]; $this-&gt;assertTrue($book-&gt;load($post), 'Load POST data'); $this-&gt;assertTrue($book-&gt;save(), 'Save model'); //reload $book = Book::findOne(3); //must have zero reviews $this-&gt;assertEquals(0, count($book-&gt;reviews), 'Review count after save'); }</span></span></code> </pre><br>  If you run the <b>codecept run</b> , the system will <b>run</b> all the available tests and report on their results: <br><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">Codeception</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">PHP</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Testing</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Framework</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">v2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.11</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Powered</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">by</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">PHPUnit</span></span> 4<span class="hljs-selector-class"><span class="hljs-selector-class">.5</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">by</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Sebastian</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Bergmann</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">and</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">contributors</span></span>. <span class="hljs-selector-tag"><span class="hljs-selector-tag">Unit</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Tests</span></span> (2) <span class="hljs-selector-tag"><span class="hljs-selector-tag">--------------------------------------------------------------------------------------</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Test</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">save</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">many</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">to</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">many</span></span> (<span class="hljs-selector-tag"><span class="hljs-selector-tag">BehaviorTest</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">::testSaveManyToMany)</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Ok</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Test</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">reset</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">one</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">to</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">many</span></span> (<span class="hljs-selector-tag"><span class="hljs-selector-tag">BehaviorTest</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">::testResetOneToMany)</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Ok</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-----------------------------------------------------------------------------------------------------</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Time</span></span>: 390 <span class="hljs-selector-tag"><span class="hljs-selector-tag">ms</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">Memory</span></span>: 9<span class="hljs-selector-class"><span class="hljs-selector-class">.00Mb</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">OK</span></span> (2 <span class="hljs-selector-tag"><span class="hljs-selector-tag">tests</span></span>, 9 <span class="hljs-selector-tag"><span class="hljs-selector-tag">assertions</span></span>)</code> </pre><br><h2>  findings </h2><br>  Having tried unit testing in business, I see how useful it has been when developing various add-ons and add-ons.  In other words, it is convenient to test behavior in this way, but I wouldn‚Äôt cover all the code of my project with unit tests. <br><br>  One of the problems of unit testing that I encountered is the need to invent the conditions under which the code is checked.  When you look at what you wrote yourself, it‚Äôs hard to imagine where it might break.  It seems to me that an outside view would help here. <br><br>  In any case, I can say with confidence that when writing code, which will then be reused in other projects, unit testing solves a lot of problems and definitely pays for the time spent on its preparation. </div><p>Source: <a href="https://habr.com/ru/post/254509/">https://habr.com/ru/post/254509/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../254493/index.html">Ready solutions # 2. Alexey Lustin. The path of "Zen" from Java to 1C</a></li>
<li><a href="../254501/index.html">The digest of interesting materials from the world of Drupal # 7</a></li>
<li><a href="../254503/index.html">Single Sign-On (SSO): OpenAM + mod_auth_mellon</a></li>
<li><a href="../254505/index.html">How the Internet of Things is changing the approach to corporate security</a></li>
<li><a href="../254507/index.html">Creating a universal web application site Habrahabr.ru using the Web App Template</a></li>
<li><a href="../254513/index.html">Homemade do-it-yourself microcontroller</a></li>
<li><a href="../254521/index.html">Interesting and utility will no longer be</a></li>
<li><a href="../254523/index.html">Designer interactive exercises for online learning</a></li>
<li><a href="../254525/index.html">I want from API a line, and a point, and a point</a></li>
<li><a href="../254527/index.html">Android - Custom View or ToggleButton 4x4</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>