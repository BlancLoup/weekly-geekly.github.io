<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Browsers and app specific security mitigation. Part 2. Internet Explorer and Edge</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Internet Explorer & Edge 


 The purpose of this article is to review the specific, explorer protection mechanisms integrated into Internet Explorer a...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Browsers and app specific security mitigation. Part 2. Internet Explorer and Edge</h1><div class="post__text post__text-html js-mediator-article"><h2>  Internet Explorer &amp; Edge </h2><br><p>  The purpose of this article is to review the specific, explorer protection mechanisms integrated into Internet Explorer and Edge browsers. </p><br><p>  We decided to combine the review of IE and Edge security mechanisms into one article, because, firstly, both are products of the notorious Microsoft company, and, secondly, this approach allows us to track how the approach to protection has changed and, accordingly, the development of protection of these browsers.  Well, also for the reason that IE and Edge have a common code base. </p><br><p><img src="https://habrastorage.org/files/ecf/c3d/19f/ecfc3d19fc22459c95bfc872fe8b05bf.png" alt="ie_success_story"></p><br><a name="habracut"></a><br><p>  <em>Figure 1 - Development of security mechanisms in IE browser ( <a href="https://www.blackhat.com/docs/us-16/materials/us-16-Weston-Windows-10-Mitigation-Improvements.pdf">source</a> )</em> </p><br><p>  We present these mechanisms in the form of a list.  For IE, the list looks like this: </p><br><ul><li>  Isolated Heap is a separate heap for HTML and DOM objects; </li><li>  Memory Protection - the mechanism of "delayed" release of memory; </li><li>  Memory Garbage Collector (MemGC) - improvement of the Memory Protector mechanism, in fact, its successor; </li><li>  Sandbox - sandbox mechanism; </li><li>  Blocking obsolete ActiveX-components; </li><li>  JIT Hardening. </li></ul><br><p>  For Edge: </p><br><ul><li>  Memory Garbage Collector (MemGC); </li><li>  Sandbox; </li><li>  Attack surface reduction - obsolete code was removed (toolbars, JScript, VBScript, ActiveX, BHO, VML, legacy document models); </li><li>  Code integrity, module loading restrictions ‚Äî blocking loading DLLs that are not Windows components or device drivers that are signed.  Binary modules cannot be loaded from remote resources; </li><li>  Kernel Attack Protection - reducing the number of nuclear components available to access from the browser; </li><li>  JIT Hardening. </li></ul><br><p>  Within this article we will consider the following mechanisms: </p><br><ol><li>  Isolated Heap &amp; Memory Protection; </li><li>  MemGC; </li><li>  Sandbox implementation in IE and Edge; </li><li>  JIT Hardening. </li></ol><br><h2>  Isolated Heap &amp; Memory Protection &amp; MemGC </h2><br><p>  One of the most common classes of vulnerabilities in the browsers in question, and in other browsers too, are UAF (use-after-free). </p><br><p>  Any exploitation of UAF-vulnerabilities can be described in the form of the following scheme: </p><br><p><img src="https://habrastorage.org/files/168/4cb/bcb/1684cbbcbe274b50848bc1176754e83c.png" alt="uaf_scheme"><br>  <em>Figure 2 - UAF vulnerability exploitation scheme</em> </p><br><p>  Those.  exploitation of UAF-vulnerabilities is done in 2 steps: </p><br><ol><li><p>  <strong>Free operation</strong> - a condition is triggered under which the object's memory is freed, while a pointer to this object remains - ‚Äúdangling pointer‚Äù or dangling pointer.  It will be used in the future to refer to an already non-existent object, for example, to call its method or write some value. </p><br></li><li>  <strong>Realloc operation</strong> - memory is reallocated and the necessary values ‚Äã‚Äãare written to it.  In place of the freed old object, a new one is created with the prepared data, which will be mistakenly interpreted as components of the old object - after its release. </li></ol><br><p>  For example, if an object's method is called after it is released prematurely, which makes it possible to occupy the freed memory and overwrite the pointer to the virtual function table, thus changing the address of the method that will be called.  As a result, it can be used to transfer control to a given address. </p><br><p>  An erroneous reading of data from an object that has already been released leaves it possible to take from the memory already timely values ‚Äã‚Äãattached there, for example, a pointer to a function in the code section of the relocated ASLR module, i.e.  implement address leakage and - hereinafter - ASLR bypass </p><br><p>  Consider the mechanisms by which protection against such vulnerabilities in IE and Edge browsers is performed. </p><br><h3>  Isolated Heap </h3><br><p>  The Isolated Heap protection appeared in IE along with the June 2014 update (MS14-035).  Its main goal is protection against UAF vulnerabilities.  Now, when allocating memory for an object, it is allocated not from the process heap, but from the special ‚Äúisolated heap‚Äù (as the name implies): </p><br><p><img src="https://habrastorage.org/files/d36/5cb/096/d365cb09635d4558ad852041d9b6abb5.png" alt="one"><br>  <em>Figure 3 - Using an isolated heap when creating a <code>CImgElement</code> element</em> </p><br><p>  Virtually all HTML and SVG DOM objects (CXXXElement) use an isolated heap.  They are highly likely to have UAF vulnerabilities, so it is extremely important to isolate these objects. </p><br><p>  Thanks to the introduction of a separate heap, an attacker has problems with the second step of exploiting UAF vulnerabilities, namely, reallocating memory and writing its own controlled values ‚Äã‚Äãor code to it, because such ‚Äúconvenient‚Äù objects as strings are allocated in another ‚Äúheap‚Äù "And cannot be used to replace values ‚Äã‚Äãin a vulnerable object. </p><br><p>  As can be seen in the figure below, a pointer to an isolated heap is stored in a global variable, the initialization of this heap occurs in the DllProcessAttach () function: </p><br><p><img src="https://habrastorage.org/files/652/a9b/7fb/652a9b7fb5a0498e84c33bc10671018c.png" alt="eleven"><br>  <em>Figure 4 - Initialization of an isolated heap</em> </p><br><p>  If you track the XREFs to _g_hIsolatedHeap, you can see 2 functions-allocators that use it: </p><br><ol><li>  <code>_MemIsolatedAlloc()</code> ; </li><li>  <code>_MemIsolatedAllocClear()</code> . </li></ol><br><p>  The second option calls HeapAlloc with the HEAP_ZERO_MEMORY flag, which should prevent exploitation of vulnerabilities that use uninitialized memory. </p><br><p>  Despite the fact that the use of an isolated heap helps to reduce the probability of successful operation of UAF vulnerabilities, not everything is as good as it seems. </p><br><p>  First, there are still objects that use a ‚Äúbunch‚Äù of the process - for example, CStr.  Secondly, there is a theoretical workaround associated with the fact that the implementation of an isolated ‚Äúheap‚Äù is exactly the same as the ‚Äúheaps‚Äù of the process (there is no check of object types when allocating memory to it), and also with the fact that the selected objects are stored in separate place. </p><br><p>  Those.  to bypass the Isolated Heap, the attacker must fulfill the following conditions: </p><br><ol><li>  Find an object that is allocated in an isolated heap; </li><li>  This object should be approximately the same size as the exempted UAF object; </li><li>  The attacker should easily control the contents of this object. </li></ol><br><p>  The guys from ZDI in 2015 presented a report on Black Hat and paper [1], which offered several Isolated Heap circumvention techniques.  They have one common basis, which just satisfies the conditions described above. </p><br><p>  The difference between the technicians is only in the details, namely in the preliminary work with the "heap". </p><br><p>  Consider the basic technique. </p><br><h3>  Bypass technique based on using another type of object (Type Confusion Bypass Techique) </h3><br><p>  As mentioned earlier, an isolated ‚Äúheap‚Äù is exactly the same as the usual ‚Äúheap‚Äù of the process, that is, when allocating memory, it does not take into account the type of object created.  Because of this, the attacker has the option to fill the object being freed with an object of another type.  Overwriting a freed object with an object of another type will result in a type confusion condition. </p><br><p>  Such an object, in relation to which it is possible to create a type confusion condition, may be larger or even smaller than the size of the object with which we are going to overwrite the memory.  This is an important fact that allows an attacker to control certain offsets within a reused object.  For example, if we know that a UAF vulnerability occurs when a pointer is dereferenced, at offset 0x30, then all we need is to replace the object being freed with one that contains the value at offset 0x30, which we can control. </p><br><p>  Thus, the sequence of actions is as follows: </p><br><ol><li>  Trigger the condition of freeing the memory of the ‚Äúattacked‚Äù object; </li><li>  Replace the object with another object using heap spray; </li><li>  Trigger the re-use of the attacked object. </li></ol><br><p>  PoC of this technology can be viewed from the guys from ZDI on <a href="https://github.com/thezdi/abusing-silent-mitigations">github</a> . </p><br><h3>  Memory Protection </h3><br><p>  If the implementation of the Isolated Heap makes life difficult for an attacker in the operation of the UAF in the second step, the step of reallocating and rewriting memory, then the following mechanism makes it difficult to perform the first step, namely, freeing the memory of the object.  This protection is called <strong>Memory Protection</strong> . </p><br><p>  The essence of this mechanism is that it prevents the release of a chunk of memory as long as it is referenced in the stack or in the register (as long as there are ‚Äúdangling pointers‚Äù).  This mechanism first appeared in IE with the July security update in 2014 (MS14-037).  Check registers added in August 2014. </p><br><p>  IE uses a <em>CMemoryProtector</em> object to keep track of the parts of memory that need to be freed.  It is created for each thread, and a pointer to it is stored in TLS (thread local storage). </p><br><p>  Initialization of this object is performed in the <em>MemoryProtection :: CMemoryProtector :: ProtectCurrentThread ()</em> function (it is worth noting that during initialization all fields of the object are set to 0). </p><br><p><img src="https://habrastorage.org/files/a57/2da/e17/a572dae178114919adcd07cc966aef9d.png" alt="12"><br>  <em>Figure 5 - <code>ProtectCurrentThread()</code> function</em> </p><br><p>  The CMemoryProtector object has the following structure (Figure 6) [2] </p><br><p><img src="https://habrastorage.org/files/cde/338/962/cde33896296244bcbde5ad357ba4e5dd.png" alt="CMemoryProtector"><br>  <em>Figure 6 - Structure of the <code>CMemoryProtector</code> object</em> </p><br><p>  The <em>CMemoryProtector</em> object consists of the following fields: </p><br><ol><li>  <strong>BlocksArray</strong> is a structure of the <em>SBlockDescriptorArray</em> type, which contains information about the released memory areas (wait-list); </li><li>  <strong>IsForceMarkAndReclaim</strong> - a flag used to determine whether to call the Reclamation Sweep operation (more on this below); </li><li>  <strong>StackHighAddress</strong> is the largest stack address in the stream.  Used for the mark operation of the area when sampling pointer values ‚Äã‚Äãfrom the stack; </li><li>  <strong>StackMarkerAddress</strong> is the largest stack address when the <code>MemoryProtection::CMemoryProtector::ProtectCurrentThread()</code> function is <code>MemoryProtection::CMemoryProtector::ProtectCurrentThread()</code> .  It is used to determine whether the stack has been completely completed, and, consequently, whether the <em>Reclamation Sweep</em> operation will be performed (more on this below). </li></ol><br><p>  The <em>SBlockDescriptorArray</em> structure contains the following fields: </p><br><ol><li>  <strong>Blocks</strong> is a list of freed sections (wait-list).  Each wail-list element is a descriptor ( <em>SBlockDescriptor</em> ) containing information about the memory block: its base address, size, whether it is contained in an isolated heap or in a normal one. </li><li>  <strong>TotalSize</strong> is the total size of all exempt plots that are in a wait-list.  Used to determine whether to perform a Reclamation Sweep operation; </li><li>  <strong>Count</strong> - the number of vacated areas in the <em>Blocks</em> list; </li><li>  <strong>Max Count</strong> - the maximum number of items in the wait-list; </li><li>  <strong>IsSorted</strong> - the flag that determines whether the <em>Blocks</em> list is sorted. </li></ol><br><p>  Memory Protection when freeing memory uses the <code>MemoryProtection::CMemoryProtector::ProtectedFree()</code> <code>HeapFree()</code> instead of <code>HeapFree()</code> . </p><br><pre> <code class="hljs ruby">void __userpurge MemoryProtection::CMemoryProtector::ProtectedFree(void *a1@&lt;ecx&gt;, void *Dst, unsigned __int32 a3, void *a4) { void *v4; MemoryProtection::CMemoryProtector *v5; unsigned int v6; MemoryProtection::CMemoryProtector *v7; size_t Size; v4 = a1; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( Dst ) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( MemoryProtection::CMemoryProtector::tlsSlotForInstance != -<span class="hljs-number"><span class="hljs-number">1</span></span> &amp;&amp; (v5 = (MemoryProtection::CMemoryProtector *)TlsGetValue(MemoryProtection::CMemoryProtector::tlsSlotForInstance), (v7 = v5) != <span class="hljs-number"><span class="hljs-number">0</span></span>) ) { MemoryProtection::CMemoryProtector::ReclaimMemory(v5, v6); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>) Size = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( MemoryProtection::SBlockDescriptorArray::AddBlockDescriptor(v7, Dst, v4 != MemoryProtection::g_heapHandles, &amp;Size) ) { MemoryProtection::SAddressFilter::AddBlock((MemoryProtection::CMemoryProtector *)((char *)v7 + <span class="hljs-number"><span class="hljs-number">32</span></span>), Dst, Size); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>(<span class="hljs-number"><span class="hljs-number">2</span></span>) memset(Dst, <span class="hljs-number"><span class="hljs-number">0</span></span>, Size); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { RaiseFailFastException(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { HeapFree(v4, <span class="hljs-number"><span class="hljs-number">0</span></span>, Dst); } } }</code> </pre> <br><p>  <code>ProtectedFree()</code> function </p><br><p>  <code>ProtectedFree()</code> with a certain frequency and under certain conditions carries out the procedure Reclamation Sweep (1).  It is important to note that it is performed before the block to be released enters the Wait-List. </p><br><p>  The essence of the procedure Reclamation Sweep: </p><br><ol><li>  Checking the total number of memory plots located in the Wait-List, their total volume; </li><li>  If the total number of sites is greater than <em>CMemoryProtector.BlocksArray.TotalSize</em> or the total volume&gt; = 100,000 bytes or the <em>IsForceMarkAndReclaim</em> flag is <em>set</em> , perform the freeing procedure for the blocks in the Wait-List. <br>  2.1.  If there is a pointer to the memory block in the stack or in the register, then skip it; <br>  2.2.  If there is no pointer to the memory block, then release it. </li></ol><br><p>  A pointer to a block of memory is considered as a pointer to the beginning of the block, and to any place inside it. </p><br><p>  Several functions are responsible for the Reclamation Sweep procedure, which are called inside the <code>MemoryProtection::CMemoryProtector::ReclaimMemory()</code> conditions for starting this procedure are checked there too): </p><br><ul><li>  <code>MemoryProtection::CMemoryProtector::MarksBlocks()</code> . </li></ul><br><p>  This function first sorts the chunks in order of increasing addresses.  Then, it checks to see if there are pointers to these areas in the thread stack or in registers.  In the event that such a pointer exists, <code>MarksBlocks()</code> marks such a block. </p><br><ul><li> <code>MemoryProtection::CMemoryProtector::ReclaimUnmarkedBlocks()</code> </li> </ul><br><p>  This function performs a simple bypass of the wait-list and frees all unlabeled areas of memory.  The counter in the <code>CMemoryProtection</code> object <code>CMemoryProtection</code> also updated in the process. </p><br><p>  After the Reclamation Sweep procedure, the block to be released is added to the wait-list and filled with zeros. </p><br><p><img src="https://habrastorage.org/files/89e/83b/6c2/89e83b6c2f244c03a6df82cad09060ef.png" alt="protectedFree_algo"><br>  <em>Figure 7 - Algorithm of the <code>ProtectedFree()</code> function (source <a href="https://www.blackhat.com/docs/us-15/materials/us-15-Gorenc-Abusing-Silent-Mitigations-Understanding-Weaknesses-Within-Internet-Explorers-Isolated-Heap-And-MemoryProtection-wp.pdf">[1]</a> )</em> </p><br><p>  It is worth noting that previously there was an unconditional procedure for freeing all areas of memory <code>MemoryProtection::CMemoryProtector::ReclaimMemoryWithoutProtection()</code> - this happened every time the <code>mshtml!GlobalWndProc()</code> function was <code>mshtml!GlobalWndProc()</code> as a result of receiving a message from the main stream window.  But later this opportunity was removed. </p><br><p>  Memory Protection is an extremely effective technique against UAF vulnerabilities, when the pointer to freed memory remains on the stack or in the register, since Memory Protection ensures that this block will remain in the wait-list until it is used again (when allocating memory ) and will be in the wait-list filled with zeros. </p><br><p>  Memory Protection also reduces the likelihood of exploiting other UAF vulnerabilities that are not in the category described above.  In this case, when the "hanging pointer" is neither in the stack nor in the register, the attacker must solve the following tasks: </p><br><p>  <strong>1) Memory release delay</strong> </p><br><p>  As described above, the release of memory can take place with some delay, until the Reclamation Sweep procedure is performed. </p><br><p>  <strong>2) Uncertainty due to ‚Äúgarbage‚Äù in the stack</strong> </p><br><p>  The memory block may remain in the wait-list during the Reclamation Sweep procedure, as it may happen that the stack stores a value that is equal to the address somewhere inside the block being released.  It is not necessary that this value is a pointer, but Memory Protection will treat it that way. </p><br><p>  <strong>3) The greater difficulty in determining the time when the release of a section of memory occurs.</strong> </p><br><p>  The Reclamation Sweep procedure will be implemented only if the amount of memory in the wait-list exceeds 100,000 bytes.  This may not happen until a really large block of memory is in the wait-list. </p><br><p>  <strong>4) More complex heap manager behavior when freeing memory</strong> </p><br><p>  Summarizing all of the above, it should be borne in mind that the memory block to be released first falls into the wait-list and is there until the wait-list volume exceeds 100,000 bytes, and only then it is released while there are no pointers on the stack or in registers.  At the same time, it is impossible to predict the state of the heap after simultaneously releasing a large number of different-size memory areas from the wait-list. </p><br><p>  Despite these difficulties, the same guys from ZDI have come up with several techniques for bypassing the Memory Protection mechanism [1] - some of them are obvious and simple, and some are not. </p><br><p>  Consider them further. </p><br><h4>  Elementary technology </h4><br><p>  The most obvious solution is to use the so-called ‚Äúmemory pressure‚Äù to run the Reclamation Sweep procedure, i.e.  it is necessary to allocate and then immediately free up memory of 100,000 bytes. </p><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//        ... //     //     wait-list var n = 100000 / 0x34 + 1; for (var i = 0; i &lt; n; i++) { document.createElement("div"); } CollectGarbage(); // ,      ‚Ä¶ //</span></span></code> </pre> <br><p>  But this approach will not relieve from all problems - we will solve the problem of delaying the release of memory, but we will not get rid of all the others.  Together with our object many other objects will be freed, and in an unpredictable way.  This indefinite behavior leads to a decrease in reliability when attempting to establish control over the contents of released memory. </p><br><p>  Also, a second obvious solution was possible earlier - this is the use of an unconditional procedure for freeing all memory areas, which is carried out when the <code>GlobalWndProc()</code> function is <code>GlobalWndProc()</code> . </p><br><p>  We can interrupt the exploit execution with a delay that is so large that a new call to the <code>GlobalWndProc()</code> function has exactly occurred, then Memory Protection will release all the blocks in the wait-list. </p><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">step1</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//    ‚Ä¶ ... //    //     ,  WndProc  , //    wait-list window.setTimeout(step2, 3000); } function step2() { //      ‚Ä¶ ... //   ‚Ä¶ //     ,  WndProc  , //   wait-list,     window.setTimeout(step3, 3000); } function step3() { //      ‚Ä¶ }</span></span></code> </pre> <br><p>  This solution allows you to minimize the number of foreign objects that will be released along with ours.  But it has its drawbacks - using <code>setTimeout()</code> creates an opportunity for the appearance of an additional unpredictable branch of code that is executed in the current thread.  As a result, you can get unpredictable and unwanted heap modifications. </p><br><h4>  "Advanced" technology </h4><br><p>  The researchers did not stop there, thought and decided that to bypass Memory Protection, it is necessary to stabilize the wait-list ‚Äî you need to build a sequence of such script actions in order to monitor and know the status of the wait-list.  By creating such a sequence, we will be able to exploit UAF vulnerabilities. </p><br><p>  To begin with, suppose we can allocate buffer A with a size of 100,000 bytes.  Then we try to free this buffer.  As a result, Memory Protection will put our buffer A in the wait-list, and the size of the wait-list will be exactly&gt; = 100,000 bytes. </p><br><p><img src="https://habrastorage.org/files/335/b2f/5be/335b2f5bec84448f9f8505b711a7a76f.png" alt="13"><br>  <em>Figure 8 - The status of the wait-list after adding buffer A to it (source <a href="https://www.blackhat.com/docs/us-15/materials/us-15-Gorenc-Abusing-Silent-Mitigations-Understanding-Weaknesses-Within-Internet-Explorers-Isolated-Heap-And-MemoryProtection-wp.pdf">[1]</a> )</em> </p><br><p>  Next, we again allocate and free buffer <em>B of the</em> size <em>s</em> we already need.  During the <code>ProtectedFree()</code> call, Memory Protection will see that the size of the wait-list is such that it‚Äôs time to start freeing (actually freeing) its elements.  After this procedure, our buffer of size <em>s</em> will be in the wait-list. </p><br><p><img src="https://habrastorage.org/files/474/303/5ad/4743035ad74c464c9df20685e19820b7.png" alt="14"><br>  <em>Figure 9 - The state of the wait-list after adding buffer B to it (source <a href="https://www.blackhat.com/docs/us-15/materials/us-15-Gorenc-Abusing-Silent-Mitigations-Understanding-Weaknesses-Within-Internet-Explorers-Isolated-Heap-And-MemoryProtection-wp.pdf">[1]</a> )</em> </p><br><p>  It is possible that not all the sections from the wait-list will be released and leave it - some of them may have pointers on the stack (let's call these <em>Wi</em> ).  But, first, we can safely say that their total size is much less than 100,000 bytes.  Secondly, it does not matter what their total number and total size is for the next steps.  We know for sure that as long as there are pointers on the stack, these sections will be in the wait-list. </p><br><p>  So, at this stage, we know the approximate state of the wait-list and are ready to perform the desired actions with a ‚Äúheap‚Äù for exploiting vulnerabilities. </p><br><p>  Suppose we want to free a block of memory at address <em>C.</em>  It is possible that even with the aim of triggering the UAF at this address.  In order for the memory block at this address to be exactly freed, and to do it in a predictable way: </p><br><ol><li>  Call <code>ProtectedFree()</code> for block <em>C.</em>  Block <em>C</em> gets into the wait-list and is there along with blocks <em>Wi</em> and block <em>B of</em> size <em>s</em> ; </li><li>  We allocate memory for a large memory block <em>D with a</em> size of 100,000 bytes and immediately release it.  Now this memory block falls into the wait-list, and the size of the wait-list becomes&gt; = 100,000 bytes; </li><li>  We allocate memory for a block of memory <em>E of</em> size <em>s</em> and release it.  After calling <code>ProtectedFree()</code> for block <em>E</em> , our desired block <em>C</em> and blocks <em>B</em> and <em>D</em> will fall under the Reclamation Sweep procedure and will be released. </li></ol><br><p><img src="https://habrastorage.org/files/f55/6ec/864/f556ec8645fd473eb13b072944c70281.png" alt="15"><br>  <em>Figure 10 - The final status of the wait-list (source <a href="https://www.blackhat.com/docs/us-15/materials/us-15-Gorenc-Abusing-Silent-Mitigations-Understanding-Weaknesses-Within-Internet-Explorers-Isolated-Heap-And-MemoryProtection-wp.pdf">[1]</a> )</em> </p><br><p>  Now we bring the practice to this theoretical strategy.  You need to define an object that allocates buffers of arbitrary size and releases them through <code>ProtectedFree()</code> .  The guys from ZDI chose the <code>CStr</code> object - it has a dynamic size and can be allocated from outside.  But you can always try to choose another object, good on <em>ProtectedFree</em> 1100 xrefs. </p><br><p>  Also, analyzing MSHTML, they found that <code>CStr</code> uses the <code>CElement::var_getElementsByClassName</code> .  You can reach it via the <code>getElementsByClassName</code> DOM method on any HTML element (which is exactly what you need). </p><br><p>  At runtime, this method creates a <code>CStr</code> containing string data, which is passed as the <code>getElementsByClassName</code> parameter, and then deletes this <code>CStr</code> . </p><br><p><img src="https://habrastorage.org/files/f90/5b6/bbe/f905b6bbe88d4f30a1bfc2240c0f0592.png" alt="getElementsByClassName"><br>  <em>Figure 11 - Function code <code>CElement::var_getElementsByClassName</code></em> </p><br><p>  Thus, one call to <code>getElementsByClassName</code> can achieve the goal of allocating and freeing an arbitrary size buffer. </p><br><p>  One small limitation is that the minimum buffer size with string data that we can pass to <code>getElementsByClassName</code> is 0x28 bytes.  Therefore, <code>CStr</code> takes 0x28 * 2 + 6 = 0x56 bytes (two bytes per character, plus 6 additional bytes). </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> oDiv1 = <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.createElement(<span class="hljs-string"><span class="hljs-string">'div'</span></span>); <span class="hljs-comment"><span class="hljs-comment">// /   ProtectedFree   string1 oDiv1.getElementsByClassName(string1); // ... // /   ProtectedFree   string1 oDiv1.getElementsByClassName(string1); // ... // /   ProtectedFree   string2 oDiv1.getElementsByClassName(string2);</span></span></code> </pre><br><p>  Thus, using the technique described above, an attacker can determine any pattern he needs for allocating and freeing memory on the heap.  The complexity of the Memory Protection behavior when freeing memory is eliminated. </p><br><p>  For the sake of interest, it is highly recommended to read in [1] as far as possible, by using the Memory Protection mechanism of work, bypassing ASLR. </p><br><h3>  Memory Garbage Collector (MemGC) </h3><br><p>  The following mechanism, which we consider, can be called a successor of Memory Protection.  It is called Memory Garbage Collector (MemGC), and was introduced in the new Edge engine in Win10.  Subsequently appeared in IE11. </p><br><p>  The goal of implementing MemGC is the same as that of MP, protection against exploits like UAF. </p><br><p>  The guys from Microsoft write [3] that MemGC works in the same spirit as MP, but also scans the ‚Äúheap‚Äù, in addition to the stack and registers, for references to protected object types. </p><br><p>  But, of course, they are a little cunning, and the difference is not only in the additional viewing of the heap, but also in the implementation.  Let us consider it in more detail [4]. </p><br><p>  MemGC uses a separately managed heap called the MemGC Heap (straightforward name).  It is used to allocate memory to objects and garbage collection - in fact, the same Reclamation Sweep operation, only those memory areas that are not referenced in the MemGC Heap are also released.  MemGC  Edge   JavaScript- Chakra ( JS-,     ).    ,          . </p><br><p> , Microsoft         Chakra.  ,   <a href="https://github.com/Microsoft/ChakraCore"></a> . </p><br><p>   ,  MemGC,      ,  <em>¬´¬ª</em> ( <em>Segments</em> ),     <em>¬´¬ª</em>   ( <em>Pages</em> )  4096 . ,     ( <em>Blocks</em> ),  ,   ,       : </p><br><p><img src="https://habrastorage.org/files/9f1/ac1/04c/9f1ac104c6db401ab40b3b8f5570453c.png" alt="MemGC_Heap_Diagram_V2"><br> <em> 12 ‚Äì  MemGC Heap ( <a href="https://www.blackhat.com/docs/us-15/materials/us-15-Yason-Understanding-The-Attack-Surface-And-Attack-Resilience-Of-Project-Spartans-New-EdgeHTML-Rendering-Engine-wp.pdf">[4]</a> )</em> </p><br><p> EdgeHTML/MSHTML DOM      ,   ,  MemGC.   MemGC    ¬´¬ª, Isolated Heap,  ,      . </p><br><p>  Those. , MemGC    Isolated Heap,  Memory Protector,    UAF-    (  1,     ). </p><br><p> MemGC   : </p><br><ol><li>  ; </li><li>  ; </li><li> ¬´ ¬ª (Garbage Collector). </li></ol><br><p>    . </p><br><p> <strong>1.  .</strong> </p><br><p>   MemGC  EdgeHTML,  ,  MemGC,   ,    <code>edgehtml!MemoryProtection::HeapAlloc&lt;1&gt;()</code>  <code>edgehtml!MemoryProtection::HeapAllocClear&lt;1&gt;()</code> , ,   ,   <code>chakra!MemProtectedHeapRootAlloc()</code> . </p><br><p><img src="https://habrastorage.org/files/312/b88/7e4/312b887e4be448dfa3b3e8ede5b93d3e.png" alt="MemGC_HeapAlloc"><br> <em> 13 ‚Äì   <code>MemoryProtection::HeapAlloc&lt;1&gt;()</code></em> </p><br><p> <code>chakra!MemProtectedHeapRootAlloc()</code>   (chunk)   (Block)   ¬´¬ª (Bucket),         ‚Äúroot‚Äù. ‚ÄúRoot‚Äù-,   MemGC,  / ,    (directly referenced)        ¬´ ¬ª. </p><br><p> <strong>2.  .</strong> </p><br><p>     ,   <code>edgehtml!MemoryProtection::HeapFree()</code> , ,   ,  <code>chakra!MemProtectHeapUnrootAndZero()</code> . </p><br><p><img src="https://habrastorage.org/files/d35/645/be4/d35645be4d134f54923af1da13bc6131.png" alt="MemGC_HeapFree"><br> <em> 14 ‚Äì   <code>MemoryProtection::HeapFree()</code></em> </p><br><p> <code>chakra!MemProtectHeapUnrootAndZero()</code>    (Block),       ,      ¬´root¬ª.   ¬´root¬ª      ,   ¬´ ¬ª   ,  MemGC     . </p><br><p> <strong>3.   (Garbage Collection)</strong> </p><br><p>   ,     ,     ¬´root¬ª     ,     ,    <code>chakra!MemProtectHeap::Collect()</code> .  ¬´ ¬ª   Reclamation Sweep,       ‚Äúroot‚Äù     ,  .    Reclamation Sweep     ( <code>chakra!Memory::Recycler::ThreadProc</code> ),     <code>chakra!Memory::Recycler::StartConcurrent()</code> . </p><br><p>   ‚Äì        .      ,    ¬´root¬ª-  (    <code>chakra!Memory::Recycler::BackgroundResetMarks()</code> ). </p><br><p> , ¬´root¬ª- (.. ,    ),          .     <code>chakra!Memory::Recycler::ScanImplicitRoots()</code>  <code>chakra!MemProtectHeap::FindRoots()</code> ).      ,   . ,     ,      . </p><br><p>  ,      (   ‚Ä¶.),       [5]. </p><br><p>  ,   MemGC  IE    ,    Edge,       mshtml.dll. </p><br><p> ,    MemGC  Memory Protection: </p><br><ol><li><p> MemGC  ,   ¬´¬ª ,   ,     ,    ‚Äì ..    ¬´¬ª; </p><br></li><li><p> MemGC      ,    ¬´¬ª        ( ,        ZDI :) ); </p><br></li><li><p>  ,    Reclamation Sweep,  ,    Memory Protection,      .          . </p><br></li><li> MemGC   UAF      ,       . </li></ol><br><p>     MemGC,      (  , )     . </p><br><h2>  Sandbox </h2><br><p>  ,    ‚Äì ¬´¬ª,       .       , ,         . </p><br><p>  IE      7   Windows Vista,   Protected Mode. ,  IE10  Win8, Protected Mode        ‚Äì Enchanced Protected Mode (EPM). </p><br><p> ,   EPM . </p><br><h3>  Architecture </h3><br><p> IE  Edge    ¬´¬ª  Loosely-Coupled IE (LCIE) ,      8  IE.      .  -,     .      ,    Low Integrity Level  IE  AppContainer ‚Äì     Microsoft ‚Äî  Edge.          Windows. </p><br><p><img src="https://habrastorage.org/files/790/259/f77/790259f77e3e4a8698752885d71f586b.png" alt="sandbox"><br> <em> 15 ‚Äî  Sandbox  IE  Edge ( <a href="https://www.blackhat.com/docs/asia-14/materials/Yason/WP-Asia-14-Yason-Diving-Into-IE10s-Enhanced-Protected-Mode-Sandbox.pdf">[6]</a> )</em> </p><br><p>        Windows    ACL ‚Äì access control lists ‚Äì   . </p><br><p>        DACL (discretionary access control list ‚Äì    ),      (ACE ‚Äì access control entries):        (, ,   ..).         (access token) ,   SID- ‚Äì  : ,    ..,   DACL         . </p><br><p> Microsoft     ,    .. MIC ‚Äì mandatory integrity control ‚Äì   ;        .. integrity level ‚Äì ¬´ ¬ª (  , ¬´ ¬ª   ).    ,          ,   .      . </p><br><p><img src="https://habrastorage.org/files/c45/c3c/5bf/c45c3c5bfc2c475fb012c791d2065c44.png" alt="Nameless"><br> <em> 16 ‚Äî  Integrity Level    IE</em> </p><br><p>      .     RCE  IE,      , ,    ,  -       . </p><br><p> AppContainer       Windows.           ,  ,  ,     .     ,     ,      ,    ,    .     ,            .   SID-  ,      ‚Äúcapabilities‚Äù,   internetClient, location  microphone,   . </p><br><p> ,        ACE   DACL,    ,   SID ¬´ALL APPLICATION PACKAGES¬ª.        , ,     . </p><br><p><img src="https://habrastorage.org/files/9ce/373/831/9ce37383118e49ec8bdbf92ce19b50a1.png" alt="1"><br> <em> 17 ‚Äî         </em> </p><br><p>  ,           ,  , ,          ( ‚ÄúProgram Files‚Äù    SID). ,    Mark Yanson [6],      ,   ,    ,              . </p><br><p>              : </p><br><ol><li><p>    -,  ,     ; </p><br></li><li>      , ,        ,         , ,    . </li></ol><br><p>            capcom.sys,      .     ¬´¬ª : </p><br><p><img src="https://habrastorage.org/files/04b/ef5/57a/04bef557a01c4078b86f70718338c9ae.jpg" alt="CtD6L38XYAA2krC.jpg_large"><br> <em> 18 ‚Äî    capcom</em> </p><br><p> :  SMEP,    ,  . ,       . </p><br><p>  Another example.  Windows 10   dismhost.exe (Disk Cleanup),      ,        .     DLL     %TEMP%,     .  ,    ,       . </p><br><h2> Chakra JIT Hardening </h2><br><p>  JS    Microsoft ‚Äî IE 11  Edge ‚Äì  Chakra,     JS       .    JS-  JIT (just-in-time) ,   JS-   ,        web-. </p><br><p>    ,  JIT    .        ,             .      : </p><br><ul><li>     JS     JIT         ,  ,   -    ,    .      ,  .. ¬´¬ª (JIT spray),       ‚Äì  -.       -. </li></ul><br><p>  JIT    ,   . </p><br><ul><li>         JIT-.     ( , )              .     ROP  ‚Äì   ,   ,      . </li></ul><br><p>  JIT    ,  xor,          ‚Äì  ‚Äú <strong>constant blinding</strong> ‚Äù.       ROP-   ,        ‚Äì  ‚Äú <strong>insert NOPs</strong> ‚Äù. </p><br><h3>  Constant blinding </h3><br><p>     ?    ,    ,  ‚Äì     . </p><br><p>       ROP-,      VirtualProtect(addr, size, flags, oldflags).          Windows,            -, ..  ,     .       :   ,  ,       ,    . </p><br><p>     x64,    WinAPI   fastcall,        ‚Äì rcx, rdx, r8  r9,   ‚Äì  .  ,   ,             : pop R + ret.  rcx  rdx  ,  r8  r9    .    ‚Äúpop R‚Äù,  R ‚Äì     x64   r8 ‚Äî r15,       pop     ‚Äì REX , ,     ret   .  ,    ,         : </p><br><pre> <code class="hljs markdown">81 C0 41 58 00 00 add eax, 5841h <span class="hljs-strong"><span class="hljs-strong">_____</span></span><span class="hljs-strong"><span class="hljs-strong">_____</span></span><span class="hljs-strong"><span class="hljs-strong">_____</span></span><span class="hljs-strong"><span class="hljs-strong">_____</span></span><span class="hljs-strong"><span class="hljs-strong">_____</span></span><span class="hljs-strong"><span class="hljs-strong">_____</span></span><span class="hljs-strong"><span class="hljs-strong">_____</span></span><span class="hljs-strong"><span class="hljs-strong">_____</span></span><span class="hljs-emphasis"><span class="hljs-emphasis">___</span></span> 41 58 pop r8 00 00 add byte [rax], al</code> </pre> <br><p>    :     rax   -  ,   ,  ,      .    ,         ... </p><br><p>  : </p><br><ul><li><p>           rax  ,      ,         <strong>0xc358</strong> :) </p><br><pre> <code class="hljs perl"><span class="hljs-number"><span class="hljs-number">58</span></span> <span class="hljs-keyword"><span class="hljs-keyword">pop</span></span> rax C3 ret</code> </pre> <br></li><li><p>  .   JIT-    JS ,          ¬´¬ª. </p><br><pre> <code class="hljs actionscript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">f</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(addr)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> addr + <span class="hljs-number"><span class="hljs-number">0x5841</span></span>; }</code> </pre> <br><p><img src="https://habrastorage.org/files/54a/30c/180/54a30c180c20478ca36466ec41b91963.png" alt="2"><br> <em> 19 ‚Äî   : a.   ;</em>  <em>b.</em> <em>  ROP   .     <a href="http://users.ics.forth.gr/~elathan/papers/ndss15.pdf">[7]</a></em> </p><br><p>  ¬´¬ª    ,       . </p><br></li></ul><br><h3> Insert NOPs </h3><br><p>           JIT-   ,         . </p><br><pre> <code class="hljs css">0000 <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">rax</span></span>, 2<span class="hljs-selector-tag"><span class="hljs-selector-tag">B5C990h</span></span> 000<span class="hljs-selector-tag"><span class="hljs-selector-tag">A</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">cmp</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">rsp</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">rax</span></span> 000<span class="hljs-selector-tag"><span class="hljs-selector-tag">D</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">jg</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">loc_2AE0034</span></span> 0013 <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">rdx</span></span>, 500790<span class="hljs-selector-tag"><span class="hljs-selector-tag">h</span></span> 001<span class="hljs-selector-tag"><span class="hljs-selector-tag">D</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">rcx</span></span>, 990<span class="hljs-selector-tag"><span class="hljs-selector-tag">h</span></span> 0027 <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">rax</span></span>, 7<span class="hljs-selector-tag"><span class="hljs-selector-tag">FEF3435450h</span></span> 0031 <span class="hljs-selector-tag"><span class="hljs-selector-tag">jmp</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">rax</span></span> 0034 ; <span class="hljs-selector-tag"><span class="hljs-selector-tag">---------------------------</span></span> 0034 0034 <span class="hljs-selector-tag"><span class="hljs-selector-tag">loc_2AE0034</span></span>: 0034 <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">rax</span></span>, 23<span class="hljs-selector-tag"><span class="hljs-selector-tag">D61A8h</span></span> 003<span class="hljs-selector-tag"><span class="hljs-selector-tag">E</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">inc</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">byte</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ptr</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[rax]</span></span> 0040 <span class="hljs-selector-tag"><span class="hljs-selector-tag">jnz</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">loc_2AE0049</span></span> 0046 <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">byte</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ptr</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[rax]</span></span>, 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">FFh</span></span> 0049 0049 <span class="hljs-selector-tag"><span class="hljs-selector-tag">loc_2AE0049</span></span>: 0049 <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[rsp+20h]</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r9</span></span> 004<span class="hljs-selector-tag"><span class="hljs-selector-tag">E</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[rsp+18h]</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r8</span></span> 0053 <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[rsp+10h]</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">rdx</span></span> 0058 <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[rsp+8]</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">rcx</span></span> 005<span class="hljs-selector-tag"><span class="hljs-selector-tag">D</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">push</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">rbp</span></span> 005<span class="hljs-selector-tag"><span class="hljs-selector-tag">F</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">rbp</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">rsp</span></span> 0062 <span class="hljs-selector-tag"><span class="hljs-selector-tag">sub</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">rsp</span></span>, 10<span class="hljs-selector-tag"><span class="hljs-selector-tag">h</span></span> 0066 <span class="hljs-selector-tag"><span class="hljs-selector-tag">push</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">rdi</span></span> 0068 <span class="hljs-selector-tag"><span class="hljs-selector-tag">push</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">rsi</span></span> 006<span class="hljs-selector-tag"><span class="hljs-selector-tag">A</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">push</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">rbx</span></span> 006<span class="hljs-selector-tag"><span class="hljs-selector-tag">C</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">sub</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">rsp</span></span>, 38<span class="hljs-selector-tag"><span class="hljs-selector-tag">h</span></span> 0070 <span class="hljs-selector-tag"><span class="hljs-selector-tag">xor</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">eax</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">eax</span></span> 0072 <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[rbp-8]</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">rax</span></span></code> </pre> <br><p> <em> NOP- .</em> </p><br><pre> <code class="hljs css">0000 <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">rax</span></span>, 33<span class="hljs-selector-tag"><span class="hljs-selector-tag">CC990h</span></span> 000<span class="hljs-selector-tag"><span class="hljs-selector-tag">A</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">cmp</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">rsp</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">rax</span></span> 000<span class="hljs-selector-tag"><span class="hljs-selector-tag">D</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">jg</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">loc_3160035</span></span> 0013 <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">rdx</span></span>, 326890<span class="hljs-selector-tag"><span class="hljs-selector-tag">h</span></span> 001<span class="hljs-selector-tag"><span class="hljs-selector-tag">D</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">rcx</span></span>, 990<span class="hljs-selector-tag"><span class="hljs-selector-tag">h</span></span> 0027 <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">rax</span></span>, 7<span class="hljs-selector-tag"><span class="hljs-selector-tag">FEF3435450h</span></span> 0031 <span class="hljs-selector-tag"><span class="hljs-selector-tag">jmp</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">rax</span></span> 0034 ; <span class="hljs-selector-tag"><span class="hljs-selector-tag">---------------------------</span></span> 0034 <span class="hljs-selector-tag"><span class="hljs-selector-tag">nop</span></span> 0035 0035 <span class="hljs-selector-tag"><span class="hljs-selector-tag">loc_3160035</span></span>: 0035 <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">rax</span></span>, 2<span class="hljs-selector-tag"><span class="hljs-selector-tag">FAC1A8h</span></span> 003<span class="hljs-selector-tag"><span class="hljs-selector-tag">F</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">inc</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">byte</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ptr</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[rax]</span></span> 0041 <span class="hljs-selector-tag"><span class="hljs-selector-tag">jnz</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">loc_316004A</span></span> 0047 <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">byte</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ptr</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[rax]</span></span>, 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">FFh</span></span> 004<span class="hljs-selector-tag"><span class="hljs-selector-tag">A</span></span> 004<span class="hljs-selector-tag"><span class="hljs-selector-tag">A</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">loc_316004A</span></span>: 004<span class="hljs-selector-tag"><span class="hljs-selector-tag">A</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[rsp+20h]</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r9</span></span> 004<span class="hljs-selector-tag"><span class="hljs-selector-tag">F</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[rsp+18h]</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r8</span></span> 0054 <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[rsp+10h]</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">rdx</span></span> 0059 <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[rsp+8]</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">rcx</span></span> 005<span class="hljs-selector-tag"><span class="hljs-selector-tag">E</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">push</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">rbp</span></span> 0060 <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">rbp</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">rsp</span></span> 0063 <span class="hljs-selector-tag"><span class="hljs-selector-tag">sub</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">rsp</span></span>, 10<span class="hljs-selector-tag"><span class="hljs-selector-tag">h</span></span> 0067 <span class="hljs-selector-tag"><span class="hljs-selector-tag">push</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">rdi</span></span> 0069 <span class="hljs-selector-tag"><span class="hljs-selector-tag">push</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">rsi</span></span> 006<span class="hljs-selector-tag"><span class="hljs-selector-tag">B</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">push</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">rbx</span></span> 006<span class="hljs-selector-tag"><span class="hljs-selector-tag">D</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">sub</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">rsp</span></span>, 38<span class="hljs-selector-tag"><span class="hljs-selector-tag">h</span></span> 0071 <span class="hljs-selector-tag"><span class="hljs-selector-tag">xor</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">eax</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">eax</span></span> 0073 <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[rbp-8]</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">rax</span></span></code> </pre> <br><p> <em>    34h.  .</em> </p><br><pre> <code class="hljs css">0034 <span class="hljs-selector-tag"><span class="hljs-selector-tag">nop</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dword</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ptr</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[rax]</span></span> 0037 <span class="hljs-selector-tag"><span class="hljs-selector-tag">nop</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dword</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ptr</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[rax+00h]</span></span> 003<span class="hljs-selector-tag"><span class="hljs-selector-tag">B</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">xchg</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ax</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">ax</span></span></code> </pre> <br><p> <em>   NOP-,  .</em> </p><br><p>        ,       . </p><br><h3> JIT &amp; CFG (Control Flow Guard) </h3><br><p>     ‚Äî    CFG  Windows 8.1.           [8]. </p><br><p>  ,   JIT- ,     ,     , , ,  ‚Äî  ,   . </p><br><p> ,   CFG,       ,    ‚Äî     <strong>rax</strong> ,      .              :     JIT ROP,       <strong>rsp</strong>       ,       ,   <strong>rsp</strong>      ,   ,     <strong>rax</strong> ‚Äî    ,    (   vtable!),     <code>add byte [rax], al</code> .     . </p><br><pre> <code class="hljs kotlin">mov rax, [rdi] ; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>-&gt;vtable mov rbx, [rax+<span class="hljs-number"><span class="hljs-number">208</span></span>h] ; ptr = vtable[idx] mov rcx, rbx ; _QWORD call cs:__guard_check_icall_fptr mov rcx, rdi ; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span></code> </pre> <br><p>  JIT-     JS.          WARP  Edge,       JIT- JS [9]. </p><br><h2>  Conclusion </h2><br><p>    ‚Äì IE  Edge ‚Äî          ,     .  ,       ‚Äî     . ,     ,        .       ,   ,       . </p><br><h2>  </h2><br><ol><li> <a href="https://www.blackhat.com/docs/us-15/materials/us-15-Gorenc-Abusing-Silent-Mitigations-Understanding-Weaknesses-Within-Internet-Explorers-Isolated-Heap-And-MemoryProtection-wp.pdf">https://www.blackhat.com/docs/us-15/materials/us-15-Gorenc-Abusing-Silent-Mitigations-Understanding-Weaknesses-Within-Internet-Explorers-Isolated-Heap-And-MemoryProtection-wp.pdf</a> </li><li> <a href="https://securityintelligence.com/understanding-ies-new-exploit-mitigations-the-memory-protector-and-the-isolated-heap/">https://securityintelligence.com/understanding-ies-new-exploit-mitigations-the-memory-protector-and-the-isolated-heap/</a> </li><li> <a href="https://blogs.technet.microsoft.com/srd/2016/01/12/triaging-the-exploitability-of-ieedge-crashes/">https://blogs.technet.microsoft.com/srd/2016/01/12/triaging-the-exploitability-of-ieedge-crashes/</a> </li><li> <a href="https://www.blackhat.com/docs/us-15/materials/us-15-Yason-Understanding-The-Attack-Surface-And-Attack-Resilience-Of-Project-Spartans-New-EdgeHTML-Rendering-Engine-wp.pdf">https://www.blackhat.com/docs/us-15/materials/us-15-Yason-Understanding-The-Attack-Surface-And-Attack-Resilience-Of-Project-Spartans-New-EdgeHTML-Rendering-Engine-wp.pdf</a> </li><li> <a href="https://github.com/zenhumany/hitcon2015">https://github.com/zenhumany/hitcon2015</a> </li><li> <a href="https://www.blackhat.com/docs/asia-14/materials/Yason/WP-Asia-14-Yason-Diving-Into-IE10s-Enhanced-Protected-Mode-Sandbox.pdf">https://www.blackhat.com/docs/asia-14/materials/Yason/WP-Asia-14-Yason-Diving-Into-IE10s-Enhanced-Protected-Mode-Sandbox.pdf</a> </li><li> <a href="http://users.ics.forth.gr/~elathan/papers/ndss15.pdf">http://users.ics.forth.gr/~elathan/papers/ndss15.pdf</a> </li><li> <a href="https://habrahabr.ru/company/dsec/blog/305960/">https://habrahabr.ru/company/dsec/blog/305960/</a> </li><li> <a href="https://472ac6bb-a-62cb3a1a-s-sites.googlegroups.com/site/bingsunsec/WARPJIT/JIT%2520Spraying%2520Never%2520Dies%2520-%2520Bypass%2520CFG%2520By%2520Leveraging%2520WARP%2520Shader%2520JIT%2520Spraying.pdf">https://472ac6bb-a-62cb3a1a-s-sites.googlegroups.com/site/bingsunsec/WARPJIT/JIT%20Spraying%20Never%20Dies%20-%20Bypass%20CFG%20By%20Leveraging%20WARP%20Shader%20JIT%20Spraying.pdf</a> </li></ol><br><h2>  The authors </h2><br><ul><li>   </li><li>   / <a href="https://habrahabr.ru/users/d-t/">@dt</a> </li></ul></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/311616/">https://habr.com/ru/post/311616/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../311602/index.html">GoTech 2016 participants: facts and figures</a></li>
<li><a href="../311604/index.html">Creating a programming language. Part 0</a></li>
<li><a href="../311608/index.html">What VPS hosting really is and how to choose a reliable VPS provider</a></li>
<li><a href="../311612/index.html">Digest about clouds, network technologies and service development</a></li>
<li><a href="../311614/index.html">Linux Piter # 2 is close</a></li>
<li><a href="../311618/index.html">96 cores and optimization code ant search route</a></li>
<li><a href="../311622/index.html">ATM attacks: past, present and future</a></li>
<li><a href="../311626/index.html">Enable h264 video support on Firefox 49 on Windows XP</a></li>
<li><a href="../311628/index.html">The Ministry of Industry and Trade has published lists of manufacturers who will receive government subsidies for the development of electronics</a></li>
<li><a href="../311630/index.html">DBMS - Data Security</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>