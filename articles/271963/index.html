<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Security audit on the server. Search by security magazine. Power powershell</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="A security log audit helped my colleague monitor virtually any actions of employees who have at least some access to servers or ActiveDirectory. 

 In...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Security audit on the server. Search by security magazine. Power powershell</h1><div class="post__text post__text-html js-mediator-article">  A security log audit helped my colleague monitor virtually any actions of employees who have at least some access to servers or ActiveDirectory. <br><br>  In the topic there will be a lot of code, which I hope will be useful to you. <br><br>  The first step was to determine the list of events that needed to be monitored.  To reduce the amount of text, I created a procedure that, by the event ID, gives its description: <br><a name="habracut"></a><br><pre><code class="bash hljs">Function DefineReason (<span class="hljs-variable"><span class="hljs-variable">$Id</span></span>){ switch (<span class="hljs-variable"><span class="hljs-variable">$Id</span></span>){ 4741{ Return <span class="hljs-string"><span class="hljs-string">"   "</span></span>} 4742{ Return <span class="hljs-string"><span class="hljs-string">"   "</span></span> } 4743{ Return <span class="hljs-string"><span class="hljs-string">"   "</span></span>} 4727{ Return <span class="hljs-string"><span class="hljs-string">"     "</span></span>} 4728{ Return <span class="hljs-string"><span class="hljs-string">"       "</span></span>} 4729{ Return <span class="hljs-string"><span class="hljs-string">"       "</span></span>} 4730{ Return <span class="hljs-string"><span class="hljs-string">"     "</span></span>} 4731{ Return <span class="hljs-string"><span class="hljs-string">"     "</span></span>} 4732{ Return <span class="hljs-string"><span class="hljs-string">"       "</span></span>} 4733{ Return <span class="hljs-string"><span class="hljs-string">"       "</span></span>} 4734{ Return <span class="hljs-string"><span class="hljs-string">"     "</span></span>} 4735{ Return <span class="hljs-string"><span class="hljs-string">"     "</span></span>} 4737{ Return <span class="hljs-string"><span class="hljs-string">"     "</span></span>} 4743{ Return <span class="hljs-string"><span class="hljs-string">"   "</span></span>} 4754{ Return <span class="hljs-string"><span class="hljs-string">"     "</span></span> } 4755{ Return <span class="hljs-string"><span class="hljs-string">"     "</span></span>} 4756{ Return <span class="hljs-string"><span class="hljs-string">"       "</span></span>} 4757{ Return <span class="hljs-string"><span class="hljs-string">"       "</span></span>} 4758{ Return <span class="hljs-string"><span class="hljs-string">"     "</span></span>} 4764{ Return <span class="hljs-string"><span class="hljs-string">"  "</span></span>} 4720{ Return <span class="hljs-string"><span class="hljs-string">"  "</span></span>} 4722{ Return <span class="hljs-string"><span class="hljs-string">"  "</span></span>} 4724{ Return <span class="hljs-string"><span class="hljs-string">"  "</span></span>} 4725{ Return <span class="hljs-string"><span class="hljs-string">"   "</span></span>} 4726{ Return <span class="hljs-string"><span class="hljs-string">"   "</span></span>} 4738{ Return <span class="hljs-string"><span class="hljs-string">"  "</span></span>} 4740{ Return <span class="hljs-string"><span class="hljs-string">"   "</span></span>} 4767{ Return <span class="hljs-string"><span class="hljs-string">"   "</span></span>} 4780{ Return <span class="hljs-string"><span class="hljs-string">"       ,     "</span></span>} 4781{ Return <span class="hljs-string"><span class="hljs-string">"    "</span></span>} 4794{ Return <span class="hljs-string"><span class="hljs-string">"       "</span></span>} 5376{ Return <span class="hljs-string"><span class="hljs-string">"  :    "</span></span>} 5377{ Return <span class="hljs-string"><span class="hljs-string">"  :       "</span></span>} 4825{ Return <span class="hljs-string"><span class="hljs-string">"e     ,     RDP"</span></span>} 1102{ Return <span class="hljs-string"><span class="hljs-string">"  Security"</span></span>} } }</code> </pre> <br>  Then it was necessary to describe the events that are tracked by the access mask: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#        Function DefineReasonByAccessMask ($AccessMask){ switch($AccessMask){ "0xc0000064" { Return "   " } "0xc000006A" { Return " ,    "} "0xc0000234" { Return " " } "0xc0000072" { Return " "} "0xc0000006F" { Return "   "} "0xc00000070" { Return "  "} "0xc00000193" { Return "    "} "0xc00000071" { Return "   "} "0xc00000224" { Return "     "} "0xc000015b" { Return "     "} "0xc000006d" { Return " "} } }</span></span></code> </pre><br>  Now we know what we want to follow.  The next step in developing an audit script is to get the security log in XML format, because if there are many events, then line-by-line processing takes quite a lot of time. <br><br>  To get events from the log you can use one of the commands, each of which has its own advantages and disadvantages: <br><br><h4>  1. Get-LogEvent security </h4><br>  Benefits: <br><br>  - quick access to the event properties; <br>  - no preprocessing is required to access event properties. <br><br>  Disadvantages: <br><br>  - access only from the system security log, which is stored along the path: Windows / System32 / winevt / security.evtx; <br>  - long processing of the contents of the tag.  Processing takes place by line separation with the elimination of special characters. <br><br><h4>  2. Get-WinEvent ‚Äìpath ‚ÄúD: /‚Äù </h4><br>  Benefits: <br><br>  - quick log processing; <br>  - access to any magazine.  The main thing is to write the full path. <br><br>  Disadvantages: <br><br>  - for processing the received log requires preliminary processing. <br><br><pre> <code class="bash hljs">Try { <span class="hljs-variable"><span class="hljs-variable">$Events</span></span> = Get-WinEvent -FilterHashTable <span class="hljs-variable"><span class="hljs-variable">$MyFilter</span></span> } Catch {<span class="hljs-string"><span class="hljs-string">"No events were found in </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$Log</span></span></span><span class="hljs-string">"</span></span>; Continue} ForEach (<span class="hljs-variable"><span class="hljs-variable">$Raw_Event</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-variable"><span class="hljs-variable">$Events</span></span>) { Try{ <span class="hljs-variable"><span class="hljs-variable">$EventXML</span></span> = [xml]<span class="hljs-variable"><span class="hljs-variable">$Raw_Event</span></span>.ToXML() } Catch {Write-Host <span class="hljs-string"><span class="hljs-string">"Unable to convert an event to XML"</span></span>} <span class="hljs-variable"><span class="hljs-variable">$Event</span></span> = @{} ForEach (<span class="hljs-variable"><span class="hljs-variable">$object</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-variable"><span class="hljs-variable">$EventXML</span></span>.Event.EventData.Data) { <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.Add(<span class="hljs-variable"><span class="hljs-variable">$object</span></span>.name,<span class="hljs-variable"><span class="hljs-variable">$object</span></span>.<span class="hljs-string"><span class="hljs-string">'#text'</span></span>) } <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.Add(<span class="hljs-string"><span class="hljs-string">"ID"</span></span>,<span class="hljs-variable"><span class="hljs-variable">$Raw_Event</span></span>.ID) <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.Add(<span class="hljs-string"><span class="hljs-string">"TimeCreated"</span></span>,<span class="hljs-variable"><span class="hljs-variable">$Raw_Event</span></span>.TimeCreated)</code> </pre><br>  The next step after we got access to the log is to pull the required events from the log and make the appropriate decisions on them.  In most cases, this is sending an informational message to the mail or logging to a separate file. <br><br>  Set the parameters by which we will extrude information, possibly using an interface solution.  Dialog box with input parameters. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/b1d/511/aa5/b1d511aa571cb8fc4e813d21e0325c3f.png" alt="image"><br><br>  1. The first parameter assumes that the logs are periodically exported to a specific directory, which should be set.  If there is one log, then the standard directory for storing logs is set: ‚ÄúC: \ Windows \ System32 \ winevt \ Logs‚Äù. <br><br>  2. The second parameter defines the server by which logs will be searched.  If the server is one, then put "*". <br><br>  3. The third parameter is extremely clear: * - we are looking for events for the entire period, if a date is set, for example, 11/30/2015, then we are looking for that date.  The search for the period is carried out by entering the starting and ending dates through a dash (01.11.2015-30.11.2015) <br><br>  4. Specify the path to save the result of the work, for example, "D: \ log.log"  Below is the code that allows you to build an interface for the script: <br><br><pre> <code class="bash hljs"><span class="hljs-variable"><span class="hljs-variable">$objForm</span></span> = New-Object System.Windows.Forms.Form <span class="hljs-variable"><span class="hljs-variable">$objForm</span></span>.Text = <span class="hljs-string"><span class="hljs-string">"  "</span></span> <span class="hljs-variable"><span class="hljs-variable">$objForm</span></span>.Size = New-Object System.Drawing.Size(300,450) <span class="hljs-variable"><span class="hljs-variable">$objForm</span></span>.StartPosition = <span class="hljs-string"><span class="hljs-string">"CenterScreen"</span></span> <span class="hljs-comment"><span class="hljs-comment"># Events path $objLabel1 = New-Object System.Windows.Forms.Label $objLabel1.Location = New-Object System.Drawing.Size(10,20) $objLabel1.Size = New-Object System.Drawing.Size(280,40) $objLabel1.Text = "      `nD:/.../.../ :" $objForm.Controls.Add($objLabel1) $objTextBox1 = New-Object System.Windows.Forms.TextBox $objTextBox1.Location = New-Object System.Drawing.Size(10,60) $objTextBox1.Size = New-Object System.Drawing.Size(280,20) $objForm.Controls.Add($objTextBox1) #Find Server mode $objLabel2 = New-Object System.Windows.Forms.Label $objLabel2.Location = New-Object System.Drawing.Size(10,90) $objLabel2.Size = New-Object System.Drawing.Size(280,30) $objLabel2.Text = "1. * -   .`n2.  ." $objForm.Controls.Add($objLabel2) $objTextBox2 = New-Object System.Windows.Forms.TextBox $objTextBox2.Location = New-Object System.Drawing.Size(10,120) $objTextBox2.Size = New-Object System.Drawing.Size(280,30) $objForm.Controls.Add($objTextBox2) #Type Events Mode $objLabel3 = New-Object System.Windows.Forms.Label $objLabel3.Location = New-Object System.Drawing.Size(10,150) $objLabel3.Size = New-Object System.Drawing.Size(280,45) $objLabel3.Text = "1. * -   .`n2.  .`n3.    " $objForm.Controls.Add($objLabel3) $objTextBox3 = New-Object System.Windows.Forms.TextBox $objTextBox3.Location = New-Object System.Drawing.Size(10,195) $objTextBox3.Size = New-Object System.Drawing.Size(280,30) $objForm.Controls.Add($objTextBox3) #Date Events mode $objLabel4 = New-Object System.Windows.Forms.Label $objLabel4.Location = New-Object System.Drawing.Size(10,225) $objLabel4.Size = New-Object System.Drawing.Size(280,60) $objLabel4.Text = "1. * -   .`n2.     ...`n3.     ..-.." $objForm.Controls.Add($objLabel4) $objTextBox4 = New-Object System.Windows.Forms.TextBox $objTextBox4.Location = New-Object System.Drawing.Size(10,285) $objTextBox4.Size = New-Object System.Drawing.Size(280,30) $objForm.Controls.Add($objTextBox4) #Save Result $objLabel5 = New-Object System.Windows.Forms.Label $objLabel5.Location = New-Object System.Drawing.Size(10,315) $objLabel5.Size = New-Object System.Drawing.Size(280,30) $objLabel5.Text = "    " $objForm.Controls.Add($objLabel5) $objTextBox5 = New-Object System.Windows.Forms.TextBox $objTextBox5.Location = New-Object System.Drawing.Size(10,345) $objTextBox5.Size = New-Object System.Drawing.Size(280,30) $objForm.Controls.Add($objTextBox5) #    .       . $OKButton = New-Object System.Windows.Forms.Button $OKButton.Location = New-Object System.Drawing.Size(75,380) $OKButton.Size = New-Object System.Drawing.Size(75,23) $OKButton.Text = "OK" $OKButton.Add_Click({$objForm.Close()}) $objForm.Controls.Add($OKButton) $OKButton.DialogResult=[System.Windows.Forms.DialogResult]::OK $CancelButton = New-Object System.Windows.Forms.Button $CancelButton.Location = New-Object System.Drawing.Size(150,380) $CancelButton.Size = New-Object System.Drawing.Size(75,23) $CancelButton.Text = "Cancel" $CancelButton.Add_Click({$objForm.Close()}) $objForm.Controls.Add($CancelButton) $objForm.Topmost = $True $objForm.Add_Shown({$objForm.Activate()}) $dialogResult = $objForm.ShowDialog() #   </span></span></code> </pre><br>  We get the entered data: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#    if ($dialogResult -eq "OK"){ $Log_Path = $objTextBox1.Text $FindServerMode = $objTextBox2.Text $TypeEventsMode = $objTextBox3.Text $DateEventsmode = $objTextBox4.Text $SaveResult = $objTextBox5.Text }</span></span></code> </pre><br>  If there is a "-" symbol in the date field, then an interval is entered, if this character is entered incorrectly, your problems  We carry out separation by the symbol "-", we determine the beginning and end date of the range. <br><br><pre> <code class="bash hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-variable"><span class="hljs-variable">$DateEventsmode</span></span> -match <span class="hljs-string"><span class="hljs-string">"-"</span></span>){ <span class="hljs-variable"><span class="hljs-variable">$x</span></span> = <span class="hljs-variable"><span class="hljs-variable">$DateEventsmode</span></span>.split(<span class="hljs-string"><span class="hljs-string">"-"</span></span>) <span class="hljs-variable"><span class="hljs-variable">$StartDate</span></span> = <span class="hljs-variable"><span class="hljs-variable">$x</span></span>[0] <span class="hljs-variable"><span class="hljs-variable">$EndDate</span></span> = <span class="hljs-variable"><span class="hljs-variable">$x</span></span>[1] <span class="hljs-variable"><span class="hljs-variable">$StartDate</span></span> = [DateTime]::parse(<span class="hljs-variable"><span class="hljs-variable">$StartDate</span></span>) <span class="hljs-variable"><span class="hljs-variable">$StartDate</span></span> <span class="hljs-variable"><span class="hljs-variable">$EndDate</span></span> = [DateTime]::parse(<span class="hljs-variable"><span class="hljs-variable">$EndDate</span></span>) <span class="hljs-variable"><span class="hljs-variable">$EndDate</span></span> }</code> </pre><br>  If in the entered field there is neither "-" nor "*", then a specific date is entered. <br><br><pre> <code class="bash hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-variable"><span class="hljs-variable">$DateEventsmode</span></span> -notmatch <span class="hljs-string"><span class="hljs-string">"-"</span></span> -and <span class="hljs-variable"><span class="hljs-variable">$DateEventsmode</span></span> -ne <span class="hljs-string"><span class="hljs-string">"*"</span></span>){ <span class="hljs-variable"><span class="hljs-variable">$StartDate1</span></span> = [DateTime]::parse(<span class="hljs-variable"><span class="hljs-variable">$DateEventsmode</span></span>) }</code> </pre><br>  1. Search all servers, all events for the entire period: <br><br><pre> <code class="bash hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-variable"><span class="hljs-variable">$FindServerMode</span></span> -eq <span class="hljs-string"><span class="hljs-string">"*"</span></span> -and <span class="hljs-variable"><span class="hljs-variable">$DateEventsmode</span></span> -eq <span class="hljs-string"><span class="hljs-string">"*"</span></span> -and <span class="hljs-variable"><span class="hljs-variable">$TypeEventsMode</span></span> -eq <span class="hljs-string"><span class="hljs-string">"*"</span></span> -and <span class="hljs-variable"><span class="hljs-variable">$Log_Path</span></span> -ne <span class="hljs-string"><span class="hljs-string">""</span></span>){ Write-host <span class="hljs-string"><span class="hljs-string">"  1"</span></span> <span class="hljs-variable"><span class="hljs-variable">$ALL_LOGS</span></span> = Get-ChildItem -Path <span class="hljs-variable"><span class="hljs-variable">$Log_Path</span></span> -recurse| Where {<span class="hljs-variable"><span class="hljs-variable">$_</span></span>.Extension -eq <span class="hljs-string"><span class="hljs-string">".evtx"</span></span>} | Sort LastWriteTime <span class="hljs-variable"><span class="hljs-variable">$ALL_LOGS</span></span> foreach (<span class="hljs-variable"><span class="hljs-variable">$Log</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-variable"><span class="hljs-variable">$ALL_LOGS</span></span>){ <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span> = <span class="hljs-string"><span class="hljs-string">"Audit EventLog Security"</span></span> +<span class="hljs-string"><span class="hljs-string">"`n"</span></span> (<span class="hljs-variable"><span class="hljs-variable">$Log</span></span>).FullName <span class="hljs-variable"><span class="hljs-variable">$MyFilter</span></span> = @{Path=(<span class="hljs-variable"><span class="hljs-variable">$Log</span></span>).FullName} <span class="hljs-variable"><span class="hljs-variable">$i</span></span>=0 Try {<span class="hljs-variable"><span class="hljs-variable">$Events</span></span> = Get-WinEvent -FilterHashTable <span class="hljs-variable"><span class="hljs-variable">$MyFilter</span></span>} Catch {<span class="hljs-string"><span class="hljs-string">"No events were found in </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$Log</span></span></span><span class="hljs-string">"</span></span>; Continue} ForEach (<span class="hljs-variable"><span class="hljs-variable">$Raw_Event</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-variable"><span class="hljs-variable">$Events</span></span>){ Try{<span class="hljs-variable"><span class="hljs-variable">$EventXML</span></span> = [xml]<span class="hljs-variable"><span class="hljs-variable">$Raw_Event</span></span>.ToXML()} Catch {Write-Host <span class="hljs-string"><span class="hljs-string">"Unable to convert an event to XML"</span></span>} <span class="hljs-variable"><span class="hljs-variable">$Event</span></span> = @{} ForEach (<span class="hljs-variable"><span class="hljs-variable">$object</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-variable"><span class="hljs-variable">$EventXML</span></span>.Event.EventData.Data) { <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.Add(<span class="hljs-variable"><span class="hljs-variable">$object</span></span>.name,<span class="hljs-variable"><span class="hljs-variable">$object</span></span>.<span class="hljs-string"><span class="hljs-string">'#text'</span></span>) } <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.Add(<span class="hljs-string"><span class="hljs-string">"ID"</span></span>,<span class="hljs-variable"><span class="hljs-variable">$Raw_Event</span></span>.ID) <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.Add(<span class="hljs-string"><span class="hljs-string">"TimeCreated"</span></span>,<span class="hljs-variable"><span class="hljs-variable">$Raw_Event</span></span>.TimeCreated) <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span>+= <span class="hljs-string"><span class="hljs-string">"EventID: "</span></span> + <span class="hljs-variable"><span class="hljs-variable">$Raw_Event</span></span>.ID +<span class="hljs-string"><span class="hljs-string">"`n"</span></span> <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span>+= <span class="hljs-string"><span class="hljs-string">"Target User Name: "</span></span> + <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.TargetUserName +<span class="hljs-string"><span class="hljs-string">"`n"</span></span> <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span>+= <span class="hljs-string"><span class="hljs-string">"Target Domain Name: "</span></span> + <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.TargetDomainName +<span class="hljs-string"><span class="hljs-string">"`n"</span></span> <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span>+= <span class="hljs-string"><span class="hljs-string">"Status: "</span></span> + <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.Status +<span class="hljs-string"><span class="hljs-string">"`n"</span></span> <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span>+= <span class="hljs-string"><span class="hljs-string">"TimeGenerated: "</span></span> + <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.TimeCreated +<span class="hljs-string"><span class="hljs-string">"`n"</span></span> <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span>+= <span class="hljs-string"><span class="hljs-string">"Workstation Name: "</span></span> + <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.WorkstationName +<span class="hljs-string"><span class="hljs-string">"`n"</span></span> <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span>+= <span class="hljs-string"><span class="hljs-string">"IpAddress: "</span></span> + <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.IpAddress +<span class="hljs-string"><span class="hljs-string">"`n"</span></span> <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span>+= <span class="hljs-string"><span class="hljs-string">"Computer: "</span></span> + [xml]<span class="hljs-variable"><span class="hljs-variable">$Raw_Event</span></span>.ToXML().Event.System.Computer +<span class="hljs-string"><span class="hljs-string">"`n"</span></span> <span class="hljs-variable"><span class="hljs-variable">$Reason</span></span> = DefineReason -Id <span class="hljs-variable"><span class="hljs-variable">$Raw_Event</span></span>.ID <span class="hljs-variable"><span class="hljs-variable">$AccessM</span></span> = DefineReasonByAccessMask -AccessMask <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.Status <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span>+= <span class="hljs-string"><span class="hljs-string">"Reason(RU): "</span></span> + <span class="hljs-variable"><span class="hljs-variable">$Reason</span></span> + <span class="hljs-string"><span class="hljs-string">" "</span></span>+ <span class="hljs-variable"><span class="hljs-variable">$AccessM</span></span> +<span class="hljs-string"><span class="hljs-string">"`n"</span></span> <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span>+= <span class="hljs-string"><span class="hljs-string">"Reason(SYS): "</span></span> + <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.Message +<span class="hljs-string"><span class="hljs-string">"`n"</span></span> <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span>+= <span class="hljs-string"><span class="hljs-string">"----------------------------------------------------------------`n"</span></span> <span class="hljs-variable"><span class="hljs-variable">$i</span></span>++ } } }</code> </pre><br>  2. Search all servers, by event filter, for the entire period: <br><br><pre> <code class="bash hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-variable"><span class="hljs-variable">$FindServerMode</span></span> -eq <span class="hljs-string"><span class="hljs-string">"*"</span></span> -and <span class="hljs-variable"><span class="hljs-variable">$DateEventsmode</span></span> -eq <span class="hljs-string"><span class="hljs-string">"*"</span></span> -and <span class="hljs-variable"><span class="hljs-variable">$TypeEventsMode</span></span> -ne <span class="hljs-string"><span class="hljs-string">"*"</span></span> -and <span class="hljs-variable"><span class="hljs-variable">$Log_Path</span></span> -ne <span class="hljs-string"><span class="hljs-string">""</span></span>){ Write-host <span class="hljs-string"><span class="hljs-string">"  2"</span></span> <span class="hljs-variable"><span class="hljs-variable">$ALL_LOGS</span></span> = Get-ChildItem -Path <span class="hljs-variable"><span class="hljs-variable">$Log_Path</span></span> | Where {<span class="hljs-variable"><span class="hljs-variable">$_</span></span>.Extension -eq <span class="hljs-string"><span class="hljs-string">".evtx"</span></span>} | Sort LastWriteTime <span class="hljs-variable"><span class="hljs-variable">$ALL_LOGS</span></span> foreach (<span class="hljs-variable"><span class="hljs-variable">$Log</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-variable"><span class="hljs-variable">$ALL_LOGS</span></span>){ <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span> = <span class="hljs-string"><span class="hljs-string">"Audit EventLog Security"</span></span> +<span class="hljs-string"><span class="hljs-string">"`n"</span></span> (<span class="hljs-variable"><span class="hljs-variable">$Log</span></span>).FullName <span class="hljs-variable"><span class="hljs-variable">$MyFilter</span></span> = @{Path=(<span class="hljs-variable"><span class="hljs-variable">$Log</span></span>).FullName;ID=<span class="hljs-variable"><span class="hljs-variable">$TypeEventsMode</span></span>} Try {<span class="hljs-variable"><span class="hljs-variable">$Events</span></span> = Get-WinEvent -FilterHashTable <span class="hljs-variable"><span class="hljs-variable">$MyFilter</span></span>} Catch {<span class="hljs-string"><span class="hljs-string">"No events were found in </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$Log</span></span></span><span class="hljs-string">"</span></span>; Continue} ForEach (<span class="hljs-variable"><span class="hljs-variable">$Raw_Event</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-variable"><span class="hljs-variable">$Events</span></span>){ Try{<span class="hljs-variable"><span class="hljs-variable">$EventXML</span></span> = [xml]<span class="hljs-variable"><span class="hljs-variable">$Raw_Event</span></span>.ToXML()} Catch {Write-Host <span class="hljs-string"><span class="hljs-string">"Unable to convert an event to XML"</span></span>} <span class="hljs-variable"><span class="hljs-variable">$Event</span></span> = @{} ForEach (<span class="hljs-variable"><span class="hljs-variable">$object</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-variable"><span class="hljs-variable">$EventXML</span></span>.Event.EventData.Data) { <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.Add(<span class="hljs-variable"><span class="hljs-variable">$object</span></span>.name,<span class="hljs-variable"><span class="hljs-variable">$object</span></span>.<span class="hljs-string"><span class="hljs-string">'#text'</span></span>) } <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.Add(<span class="hljs-string"><span class="hljs-string">"ID"</span></span>,<span class="hljs-variable"><span class="hljs-variable">$Raw_Event</span></span>.ID) <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.Add(<span class="hljs-string"><span class="hljs-string">"TimeCreated"</span></span>,<span class="hljs-variable"><span class="hljs-variable">$Raw_Event</span></span>.TimeCreated) <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span>+= <span class="hljs-string"><span class="hljs-string">"EventID: "</span></span> + <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.ID +<span class="hljs-string"><span class="hljs-string">"`n"</span></span> <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span>+= <span class="hljs-string"><span class="hljs-string">"Target User Name: "</span></span> + <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.TargetUserName +<span class="hljs-string"><span class="hljs-string">"`n"</span></span> <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span>+= <span class="hljs-string"><span class="hljs-string">"Target Domain Name: "</span></span> + <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.TargetDomainName +<span class="hljs-string"><span class="hljs-string">"`n"</span></span> <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span>+= <span class="hljs-string"><span class="hljs-string">"Status: "</span></span> + <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.Status +<span class="hljs-string"><span class="hljs-string">"`n"</span></span> <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span>+= <span class="hljs-string"><span class="hljs-string">"TimeGenerated: "</span></span> + <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.TimeCreated +<span class="hljs-string"><span class="hljs-string">"`n"</span></span> <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span>+= <span class="hljs-string"><span class="hljs-string">"Workstation Name: "</span></span> + <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.WorkstationName +<span class="hljs-string"><span class="hljs-string">"`n"</span></span> <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span>+= <span class="hljs-string"><span class="hljs-string">"IpAddress: "</span></span> + <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.IpAddress +<span class="hljs-string"><span class="hljs-string">"`n"</span></span> <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span>+= <span class="hljs-string"><span class="hljs-string">"Computer: "</span></span> + [xml]<span class="hljs-variable"><span class="hljs-variable">$Raw_Event</span></span>.ToXML().Event.System.Computer +<span class="hljs-string"><span class="hljs-string">"`n"</span></span> <span class="hljs-variable"><span class="hljs-variable">$Reason</span></span> = DefineReason -Id <span class="hljs-variable"><span class="hljs-variable">$Raw_Event</span></span>.ID <span class="hljs-variable"><span class="hljs-variable">$AccessM</span></span> = DefineReasonByAccessMask -AccessMask <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.Status <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span>+= <span class="hljs-string"><span class="hljs-string">"Reason(RU): "</span></span> + <span class="hljs-variable"><span class="hljs-variable">$Reason</span></span> + <span class="hljs-string"><span class="hljs-string">" "</span></span>+ <span class="hljs-variable"><span class="hljs-variable">$AccessM</span></span> +<span class="hljs-string"><span class="hljs-string">"`n"</span></span> <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span>+= <span class="hljs-string"><span class="hljs-string">"Reason(SYS): "</span></span> + <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.Message +<span class="hljs-string"><span class="hljs-string">"`n"</span></span> <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span>+= <span class="hljs-string"><span class="hljs-string">"----------------------------------------------------------------`n"</span></span> } } }</code> </pre><br>  3. Search all servers, all events, for a range: <br><br><pre> <code class="bash hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-variable"><span class="hljs-variable">$FindServerMode</span></span> -eq <span class="hljs-string"><span class="hljs-string">"*"</span></span> -and <span class="hljs-variable"><span class="hljs-variable">$DateEventsmode</span></span> -match <span class="hljs-string"><span class="hljs-string">"-"</span></span> -and <span class="hljs-variable"><span class="hljs-variable">$TypeEventsMode</span></span> -eq <span class="hljs-string"><span class="hljs-string">"*"</span></span> -and <span class="hljs-variable"><span class="hljs-variable">$Log_Path</span></span> -ne <span class="hljs-string"><span class="hljs-string">""</span></span>){ Write-host <span class="hljs-string"><span class="hljs-string">"  3"</span></span> <span class="hljs-variable"><span class="hljs-variable">$ALL_LOGS</span></span> = Get-ChildItem -Path <span class="hljs-variable"><span class="hljs-variable">$Log_Path</span></span> -Recurse| Where {<span class="hljs-variable"><span class="hljs-variable">$_</span></span>.Extension -eq <span class="hljs-string"><span class="hljs-string">".evtx"</span></span> } | Sort LastWriteTime <span class="hljs-variable"><span class="hljs-variable">$ALL_LOGS</span></span> foreach (<span class="hljs-variable"><span class="hljs-variable">$Log</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-variable"><span class="hljs-variable">$ALL_LOGS</span></span>){ <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span> = <span class="hljs-string"><span class="hljs-string">"Audit EventLog Security"</span></span> +<span class="hljs-string"><span class="hljs-string">"`n"</span></span> (<span class="hljs-variable"><span class="hljs-variable">$Log</span></span>).FullName <span class="hljs-variable"><span class="hljs-variable">$StartDate</span></span> <span class="hljs-variable"><span class="hljs-variable">$EndDate</span></span> <span class="hljs-variable"><span class="hljs-variable">$MyFilter</span></span> = @{Path=(<span class="hljs-variable"><span class="hljs-variable">$Log</span></span>).FullName} Try {<span class="hljs-variable"><span class="hljs-variable">$Events</span></span> = Get-WinEvent -FilterHashTable <span class="hljs-variable"><span class="hljs-variable">$MyFilter</span></span>} Catch {<span class="hljs-string"><span class="hljs-string">"No events were found in </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$Log</span></span></span><span class="hljs-string">"</span></span>; Continue} ForEach (<span class="hljs-variable"><span class="hljs-variable">$Raw_Event</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-variable"><span class="hljs-variable">$Events</span></span>){ Try{<span class="hljs-variable"><span class="hljs-variable">$EventXML</span></span> = [xml]<span class="hljs-variable"><span class="hljs-variable">$Raw_Event</span></span>.ToXML()} Catch {Write-Host <span class="hljs-string"><span class="hljs-string">"Unable to convert an event to XML"</span></span>} <span class="hljs-variable"><span class="hljs-variable">$Event</span></span> = @{} ForEach (<span class="hljs-variable"><span class="hljs-variable">$object</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-variable"><span class="hljs-variable">$EventXML</span></span>.Event.EventData.Data) { <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.Add(<span class="hljs-variable"><span class="hljs-variable">$object</span></span>.name,<span class="hljs-variable"><span class="hljs-variable">$object</span></span>.<span class="hljs-string"><span class="hljs-string">'#text'</span></span>) } <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.Add(<span class="hljs-string"><span class="hljs-string">"ID"</span></span>,<span class="hljs-variable"><span class="hljs-variable">$Raw_Event</span></span>.ID) <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.Add(<span class="hljs-string"><span class="hljs-string">"TimeCreated"</span></span>,<span class="hljs-variable"><span class="hljs-variable">$Raw_Event</span></span>.TimeCreated) <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.TimeCreated <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.TimeCreated -gt <span class="hljs-variable"><span class="hljs-variable">$StartDate</span></span> -and <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.TimeCreated -lt <span class="hljs-variable"><span class="hljs-variable">$EndDate</span></span>){ <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span>+= <span class="hljs-string"><span class="hljs-string">"EventID: "</span></span> + <span class="hljs-variable"><span class="hljs-variable">$Raw_Event</span></span>.ID +<span class="hljs-string"><span class="hljs-string">"`n"</span></span> <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span>+= <span class="hljs-string"><span class="hljs-string">"Target User Name: "</span></span> + <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.TargetUserName +<span class="hljs-string"><span class="hljs-string">"`n"</span></span> <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span>+= <span class="hljs-string"><span class="hljs-string">"Target Domain Name: "</span></span> + <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.TargetDomainName +<span class="hljs-string"><span class="hljs-string">"`n"</span></span> <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span>+= <span class="hljs-string"><span class="hljs-string">"Status: "</span></span> + <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.Status +<span class="hljs-string"><span class="hljs-string">"`n"</span></span> <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span>+= <span class="hljs-string"><span class="hljs-string">"TimeGenerated: "</span></span> + <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.TimeCreated +<span class="hljs-string"><span class="hljs-string">"`n"</span></span> <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span>+= <span class="hljs-string"><span class="hljs-string">"Workstation Name: "</span></span> + <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.WorkstationName +<span class="hljs-string"><span class="hljs-string">"`n"</span></span> <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span>+= <span class="hljs-string"><span class="hljs-string">"IpAddress: "</span></span> + <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.IpAddress +<span class="hljs-string"><span class="hljs-string">"`n"</span></span> <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span>+= <span class="hljs-string"><span class="hljs-string">"Computer: "</span></span> + [xml]<span class="hljs-variable"><span class="hljs-variable">$Raw_Event</span></span>.ToXML().Event.System.Computer +<span class="hljs-string"><span class="hljs-string">"`n"</span></span> <span class="hljs-variable"><span class="hljs-variable">$Reason</span></span> = DefineReason -Id <span class="hljs-variable"><span class="hljs-variable">$Raw_Event</span></span>.ID <span class="hljs-variable"><span class="hljs-variable">$AccessM</span></span> = DefineReasonByAccessMask -AccessMask <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.Status <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span>+= <span class="hljs-string"><span class="hljs-string">"Reason(RU): "</span></span> + <span class="hljs-variable"><span class="hljs-variable">$Reason</span></span> + <span class="hljs-string"><span class="hljs-string">" "</span></span>+ <span class="hljs-variable"><span class="hljs-variable">$AccessM</span></span> +<span class="hljs-string"><span class="hljs-string">"`n"</span></span> <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span>+= <span class="hljs-string"><span class="hljs-string">"Reason(SYS): "</span></span> + <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.Message +<span class="hljs-string"><span class="hljs-string">"`n"</span></span> <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span>+= <span class="hljs-string"><span class="hljs-string">"----------------------------------------------------------------`n"</span></span> } } } }</code> </pre><br>  4. Search all servers, all events, for a specific date: <br><br><pre> <code class="bash hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-variable"><span class="hljs-variable">$FindServerMode</span></span> -eq <span class="hljs-string"><span class="hljs-string">"*"</span></span> -and <span class="hljs-variable"><span class="hljs-variable">$DateEventsmode</span></span> -notmatch <span class="hljs-string"><span class="hljs-string">"-"</span></span> -and <span class="hljs-variable"><span class="hljs-variable">$DateEventsmode</span></span> -ne <span class="hljs-string"><span class="hljs-string">"*"</span></span> -and <span class="hljs-variable"><span class="hljs-variable">$TypeEventsMode</span></span> -eq <span class="hljs-string"><span class="hljs-string">"*"</span></span> -and <span class="hljs-variable"><span class="hljs-variable">$Log_Path</span></span> -ne <span class="hljs-string"><span class="hljs-string">""</span></span>){ Write-host <span class="hljs-string"><span class="hljs-string">"  5"</span></span> <span class="hljs-variable"><span class="hljs-variable">$ALL_LOGS</span></span> = Get-ChildItem -Path <span class="hljs-variable"><span class="hljs-variable">$Log_Path</span></span> -Recurse| Where {<span class="hljs-variable"><span class="hljs-variable">$_</span></span>.Extension -eq <span class="hljs-string"><span class="hljs-string">".evtx"</span></span> -and <span class="hljs-variable"><span class="hljs-variable">$StartDate1</span></span> -ne <span class="hljs-string"><span class="hljs-string">"null"</span></span> } | Sort LastWriteTime <span class="hljs-variable"><span class="hljs-variable">$ALL_LOGS</span></span> foreach (<span class="hljs-variable"><span class="hljs-variable">$Log</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-variable"><span class="hljs-variable">$ALL_LOGS</span></span>){ <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span> = <span class="hljs-string"><span class="hljs-string">"Audit EventLog Security"</span></span> +<span class="hljs-string"><span class="hljs-string">"`n"</span></span> (<span class="hljs-variable"><span class="hljs-variable">$Log</span></span>).FullName <span class="hljs-variable"><span class="hljs-variable">$Log</span></span>.LastWriteTime <span class="hljs-variable"><span class="hljs-variable">$StartDate</span></span> <span class="hljs-variable"><span class="hljs-variable">$EndDate</span></span> <span class="hljs-variable"><span class="hljs-variable">$MyFilter</span></span> = @{Path=(<span class="hljs-variable"><span class="hljs-variable">$Log</span></span>).FullName} Try {<span class="hljs-variable"><span class="hljs-variable">$Events</span></span> = Get-WinEvent -FilterHashTable <span class="hljs-variable"><span class="hljs-variable">$MyFilter</span></span>} Catch {<span class="hljs-string"><span class="hljs-string">"No events were found in </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$Log</span></span></span><span class="hljs-string">"</span></span>; Continue} ForEach (<span class="hljs-variable"><span class="hljs-variable">$Raw_Event</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-variable"><span class="hljs-variable">$Events</span></span>){ Try{<span class="hljs-variable"><span class="hljs-variable">$EventXML</span></span> = [xml]<span class="hljs-variable"><span class="hljs-variable">$Raw_Event</span></span>.ToXML()} Catch {Write-Host <span class="hljs-string"><span class="hljs-string">"Unable to convert an event to XML"</span></span>} <span class="hljs-variable"><span class="hljs-variable">$Event</span></span> = @{} ForEach (<span class="hljs-variable"><span class="hljs-variable">$object</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-variable"><span class="hljs-variable">$EventXML</span></span>.Event.EventData.Data) { <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.Add(<span class="hljs-variable"><span class="hljs-variable">$object</span></span>.name,<span class="hljs-variable"><span class="hljs-variable">$object</span></span>.<span class="hljs-string"><span class="hljs-string">'#text'</span></span>) } <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.Add(<span class="hljs-string"><span class="hljs-string">"ID"</span></span>,<span class="hljs-variable"><span class="hljs-variable">$Raw_Event</span></span>.ID) <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.Add(<span class="hljs-string"><span class="hljs-string">"TimeCreated"</span></span>,<span class="hljs-variable"><span class="hljs-variable">$Raw_Event</span></span>.TimeCreated) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.TimeCreated.Day -eq <span class="hljs-variable"><span class="hljs-variable">$StartDate1</span></span>.Day -and <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.TimeCreated.Month -eq <span class="hljs-variable"><span class="hljs-variable">$StartDate1</span></span>.Month -and <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.TimeCreated.Year -eq <span class="hljs-variable"><span class="hljs-variable">$StartDate1</span></span>.Year){ <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span>+= <span class="hljs-string"><span class="hljs-string">"EventID: "</span></span> + <span class="hljs-variable"><span class="hljs-variable">$Raw_Event</span></span>.ID +<span class="hljs-string"><span class="hljs-string">"`n"</span></span> <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span>+= <span class="hljs-string"><span class="hljs-string">"Target User Name: "</span></span> + <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.TargetUserName +<span class="hljs-string"><span class="hljs-string">"`n"</span></span> <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span>+= <span class="hljs-string"><span class="hljs-string">"Target Domain Name: "</span></span> + <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.TargetDomainName +<span class="hljs-string"><span class="hljs-string">"`n"</span></span> <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span>+= <span class="hljs-string"><span class="hljs-string">"Status: "</span></span> + <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.Status +<span class="hljs-string"><span class="hljs-string">"`n"</span></span> <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span>+= <span class="hljs-string"><span class="hljs-string">"TimeGenerated: "</span></span> + <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.TimeCreated +<span class="hljs-string"><span class="hljs-string">"`n"</span></span> <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span>+= <span class="hljs-string"><span class="hljs-string">"Workstation Name: "</span></span> + <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.WorkstationName +<span class="hljs-string"><span class="hljs-string">"`n"</span></span> <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span>+= <span class="hljs-string"><span class="hljs-string">"IpAddress: "</span></span> + <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.IpAddress +<span class="hljs-string"><span class="hljs-string">"`n"</span></span> <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span>+= <span class="hljs-string"><span class="hljs-string">"Computer: "</span></span> + [xml]<span class="hljs-variable"><span class="hljs-variable">$Raw_Event</span></span>.ToXML().Event.System.Computer +<span class="hljs-string"><span class="hljs-string">"`n"</span></span> <span class="hljs-variable"><span class="hljs-variable">$Reason</span></span> = DefineReason -Id <span class="hljs-variable"><span class="hljs-variable">$Raw_Event</span></span>.ID <span class="hljs-variable"><span class="hljs-variable">$AccessM</span></span> = DefineReasonByAccessMask -AccessMask <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.Status <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span>+= <span class="hljs-string"><span class="hljs-string">"Reason(RU): "</span></span> + <span class="hljs-variable"><span class="hljs-variable">$Reason</span></span> + <span class="hljs-string"><span class="hljs-string">" "</span></span>+ <span class="hljs-variable"><span class="hljs-variable">$AccessM</span></span> +<span class="hljs-string"><span class="hljs-string">"`n"</span></span> <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span>+= <span class="hljs-string"><span class="hljs-string">"Reason(SYS): "</span></span> + <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.Message +<span class="hljs-string"><span class="hljs-string">"`n"</span></span> <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span>+= <span class="hljs-string"><span class="hljs-string">"----------------------------------------------------------------`n"</span></span> } } } }</code> </pre><br>  5. Search across all servers, by event filter, for a certain period: <br><br><pre> <code class="bash hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-variable"><span class="hljs-variable">$FindServerMode</span></span> -eq <span class="hljs-string"><span class="hljs-string">"*"</span></span> -and <span class="hljs-variable"><span class="hljs-variable">$DateEventsmode</span></span> -match <span class="hljs-string"><span class="hljs-string">"-"</span></span> -and <span class="hljs-variable"><span class="hljs-variable">$DateEventsmode</span></span> -ne <span class="hljs-string"><span class="hljs-string">"*"</span></span> -and <span class="hljs-variable"><span class="hljs-variable">$TypeEventsMode</span></span> -ne <span class="hljs-string"><span class="hljs-string">"*"</span></span> -and <span class="hljs-variable"><span class="hljs-variable">$Log_Path</span></span> -ne <span class="hljs-string"><span class="hljs-string">""</span></span>){ Write-host <span class="hljs-string"><span class="hljs-string">"  4"</span></span> <span class="hljs-variable"><span class="hljs-variable">$ALL_LOGS</span></span> = Get-ChildItem -Path <span class="hljs-variable"><span class="hljs-variable">$Log_Path</span></span> -Recurse| Where {<span class="hljs-variable"><span class="hljs-variable">$_</span></span>.Extension -eq <span class="hljs-string"><span class="hljs-string">".evtx"</span></span> -and <span class="hljs-variable"><span class="hljs-variable">$StartDate1</span></span> -ne <span class="hljs-string"><span class="hljs-string">""</span></span>} | Sort LastWriteTime <span class="hljs-variable"><span class="hljs-variable">$ALL_LOGS</span></span> foreach (<span class="hljs-variable"><span class="hljs-variable">$Log</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-variable"><span class="hljs-variable">$ALL_LOGS</span></span>){ <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span> = <span class="hljs-string"><span class="hljs-string">"Audit EventLog Security"</span></span> +<span class="hljs-string"><span class="hljs-string">"`n"</span></span> (<span class="hljs-variable"><span class="hljs-variable">$Log</span></span>).FullName <span class="hljs-variable"><span class="hljs-variable">$Log</span></span>.LastWriteTime <span class="hljs-variable"><span class="hljs-variable">$StartDate</span></span> <span class="hljs-variable"><span class="hljs-variable">$EndDate</span></span> <span class="hljs-variable"><span class="hljs-variable">$MyFilter</span></span> = @{Path=(<span class="hljs-variable"><span class="hljs-variable">$Log</span></span>).FullName;ID=<span class="hljs-variable"><span class="hljs-variable">$TypeEventsMode</span></span>} Try {<span class="hljs-variable"><span class="hljs-variable">$Events</span></span> = Get-WinEvent -FilterHashTable <span class="hljs-variable"><span class="hljs-variable">$MyFilter</span></span>} Catch {<span class="hljs-string"><span class="hljs-string">"No events were found in </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$Log</span></span></span><span class="hljs-string">"</span></span>; Continue} ForEach (<span class="hljs-variable"><span class="hljs-variable">$Raw_Event</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-variable"><span class="hljs-variable">$Events</span></span>){ Try{<span class="hljs-variable"><span class="hljs-variable">$EventXML</span></span> = [xml]<span class="hljs-variable"><span class="hljs-variable">$Raw_Event</span></span>.ToXML()} Catch {Write-Host <span class="hljs-string"><span class="hljs-string">"Unable to convert an event to XML"</span></span>} <span class="hljs-variable"><span class="hljs-variable">$Event</span></span> = @{} ForEach (<span class="hljs-variable"><span class="hljs-variable">$object</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-variable"><span class="hljs-variable">$EventXML</span></span>.Event.EventData.Data) { <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.Add(<span class="hljs-variable"><span class="hljs-variable">$object</span></span>.name,<span class="hljs-variable"><span class="hljs-variable">$object</span></span>.<span class="hljs-string"><span class="hljs-string">'#text'</span></span>) } <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.Add(<span class="hljs-string"><span class="hljs-string">"ID"</span></span>,<span class="hljs-variable"><span class="hljs-variable">$Raw_Event</span></span>.ID) <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.Add(<span class="hljs-string"><span class="hljs-string">"TimeCreated"</span></span>,<span class="hljs-variable"><span class="hljs-variable">$Raw_Event</span></span>.TimeCreated) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.TimeCreated.Day -eq <span class="hljs-variable"><span class="hljs-variable">$StartDate1</span></span>.Day -and <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.TimeCreated.Month -eq <span class="hljs-variable"><span class="hljs-variable">$StartDate1</span></span>.Month -and <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.TimeCreated.Year -eq <span class="hljs-variable"><span class="hljs-variable">$StartDate1</span></span>.Year){ <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span>+= <span class="hljs-string"><span class="hljs-string">"EventID: "</span></span> + <span class="hljs-variable"><span class="hljs-variable">$Raw_Event</span></span>.ID +<span class="hljs-string"><span class="hljs-string">"`n"</span></span> <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span>+= <span class="hljs-string"><span class="hljs-string">"Target User Name: "</span></span> + <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.TargetUserName +<span class="hljs-string"><span class="hljs-string">"`n"</span></span> <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span>+= <span class="hljs-string"><span class="hljs-string">"Target Domain Name: "</span></span> + <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.TargetDomainName +<span class="hljs-string"><span class="hljs-string">"`n"</span></span> <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span>+= <span class="hljs-string"><span class="hljs-string">"Status: "</span></span> + <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.Status +<span class="hljs-string"><span class="hljs-string">"`n"</span></span> <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span>+= <span class="hljs-string"><span class="hljs-string">"TimeGenerated: "</span></span> + <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.TimeCreated +<span class="hljs-string"><span class="hljs-string">"`n"</span></span> <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span>+= <span class="hljs-string"><span class="hljs-string">"Workstation Name: "</span></span> + <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.WorkstationName +<span class="hljs-string"><span class="hljs-string">"`n"</span></span> <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span>+= <span class="hljs-string"><span class="hljs-string">"IpAddress: "</span></span> + <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.IpAddress +<span class="hljs-string"><span class="hljs-string">"`n"</span></span> <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span>+= <span class="hljs-string"><span class="hljs-string">"Computer: "</span></span> + [xml]<span class="hljs-variable"><span class="hljs-variable">$Raw_Event</span></span>.ToXML().Event.System.Computer +<span class="hljs-string"><span class="hljs-string">"`n"</span></span> <span class="hljs-variable"><span class="hljs-variable">$Reason</span></span> = DefineReason -Id <span class="hljs-variable"><span class="hljs-variable">$Raw_Event</span></span>.ID <span class="hljs-variable"><span class="hljs-variable">$AccessM</span></span> = DefineReasonByAccessMask -AccessMask <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.Status <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span>+= <span class="hljs-string"><span class="hljs-string">"Reason(RU): "</span></span> + <span class="hljs-variable"><span class="hljs-variable">$Reason</span></span> + <span class="hljs-string"><span class="hljs-string">" "</span></span>+ <span class="hljs-variable"><span class="hljs-variable">$AccessM</span></span> +<span class="hljs-string"><span class="hljs-string">"`n"</span></span> <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span>+= <span class="hljs-string"><span class="hljs-string">"Reason(SYS): "</span></span> + <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.Message +<span class="hljs-string"><span class="hljs-string">"`n"</span></span> <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span>+= <span class="hljs-string"><span class="hljs-string">"----------------------------------------------------------------`n"</span></span> } } } }</code> </pre><br>  6. Search across all servers, by event filter, for a specific date: <br><br><pre> <code class="bash hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-variable"><span class="hljs-variable">$FindServerMode</span></span> -eq <span class="hljs-string"><span class="hljs-string">"*"</span></span> -and <span class="hljs-variable"><span class="hljs-variable">$TypeEventsMode</span></span> -ne <span class="hljs-string"><span class="hljs-string">"*"</span></span> -and <span class="hljs-variable"><span class="hljs-variable">$DateEventsmode</span></span> -notmatch <span class="hljs-string"><span class="hljs-string">"-"</span></span> -and <span class="hljs-variable"><span class="hljs-variable">$DateEventsmode</span></span> -ne <span class="hljs-string"><span class="hljs-string">"*"</span></span> -and <span class="hljs-variable"><span class="hljs-variable">$Log_Path</span></span> -ne <span class="hljs-string"><span class="hljs-string">""</span></span>) { Write-host <span class="hljs-string"><span class="hljs-string">"  6"</span></span> <span class="hljs-variable"><span class="hljs-variable">$ALL_LOGS</span></span> = Get-ChildItem -Path <span class="hljs-variable"><span class="hljs-variable">$Log_Path</span></span> -Recurse| Where {<span class="hljs-variable"><span class="hljs-variable">$_</span></span>.Extension -eq <span class="hljs-string"><span class="hljs-string">".evtx"</span></span> -and <span class="hljs-variable"><span class="hljs-variable">$StartDate1</span></span> -ne <span class="hljs-string"><span class="hljs-string">""</span></span> } | Sort LastWriteTime <span class="hljs-variable"><span class="hljs-variable">$ALL_LOGS</span></span> foreach (<span class="hljs-variable"><span class="hljs-variable">$Log</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-variable"><span class="hljs-variable">$ALL_LOGS</span></span>){ <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span> = <span class="hljs-string"><span class="hljs-string">"Audit EventLog Security"</span></span> +<span class="hljs-string"><span class="hljs-string">"`n"</span></span> (<span class="hljs-variable"><span class="hljs-variable">$Log</span></span>).FullName <span class="hljs-variable"><span class="hljs-variable">$Log</span></span>.LastWriteTime <span class="hljs-variable"><span class="hljs-variable">$StartDate</span></span> <span class="hljs-variable"><span class="hljs-variable">$EndDate</span></span> <span class="hljs-variable"><span class="hljs-variable">$MyFilter</span></span> = @{Path=(<span class="hljs-variable"><span class="hljs-variable">$Log</span></span>).FullName;ID=<span class="hljs-variable"><span class="hljs-variable">$TypeEventsMode</span></span>} Try {<span class="hljs-variable"><span class="hljs-variable">$Events</span></span> = Get-WinEvent -FilterHashTable <span class="hljs-variable"><span class="hljs-variable">$MyFilter</span></span>} Catch {<span class="hljs-string"><span class="hljs-string">"No events were found in </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$Log</span></span></span><span class="hljs-string">"</span></span>; Continue} ForEach (<span class="hljs-variable"><span class="hljs-variable">$Raw_Event</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-variable"><span class="hljs-variable">$Events</span></span>){ Try{<span class="hljs-variable"><span class="hljs-variable">$EventXML</span></span> = [xml]<span class="hljs-variable"><span class="hljs-variable">$Raw_Event</span></span>.ToXML()} Catch {Write-Host <span class="hljs-string"><span class="hljs-string">"Unable to convert an event to XML"</span></span>} <span class="hljs-variable"><span class="hljs-variable">$Event</span></span> = @{} ForEach (<span class="hljs-variable"><span class="hljs-variable">$object</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-variable"><span class="hljs-variable">$EventXML</span></span>.Event.EventData.Data) { <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.Add(<span class="hljs-variable"><span class="hljs-variable">$object</span></span>.name,<span class="hljs-variable"><span class="hljs-variable">$object</span></span>.<span class="hljs-string"><span class="hljs-string">'#text'</span></span>) } <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.Add(<span class="hljs-string"><span class="hljs-string">"ID"</span></span>,<span class="hljs-variable"><span class="hljs-variable">$Raw_Event</span></span>.ID) <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.Add(<span class="hljs-string"><span class="hljs-string">"TimeCreated"</span></span>,<span class="hljs-variable"><span class="hljs-variable">$Raw_Event</span></span>.TimeCreated) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.TimeCreated.Day -eq <span class="hljs-variable"><span class="hljs-variable">$StartDate1</span></span>.Day -and <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.TimeCreated.Month -eq <span class="hljs-variable"><span class="hljs-variable">$StartDate1</span></span>.Month -and <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.TimeCreated.Year -eq <span class="hljs-variable"><span class="hljs-variable">$StartDate1</span></span>.Year){ <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span>+= <span class="hljs-string"><span class="hljs-string">"EventID: "</span></span> + <span class="hljs-variable"><span class="hljs-variable">$Raw_Event</span></span>.ID +<span class="hljs-string"><span class="hljs-string">"`n"</span></span> <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span>+= <span class="hljs-string"><span class="hljs-string">"Target User Name: "</span></span> + <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.TargetUserName +<span class="hljs-string"><span class="hljs-string">"`n"</span></span> <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span>+= <span class="hljs-string"><span class="hljs-string">"Target Domain Name: "</span></span> + <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.TargetDomainName +<span class="hljs-string"><span class="hljs-string">"`n"</span></span> <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span>+= <span class="hljs-string"><span class="hljs-string">"Status: "</span></span> + <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.Status +<span class="hljs-string"><span class="hljs-string">"`n"</span></span> <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span>+= <span class="hljs-string"><span class="hljs-string">"TimeGenerated: "</span></span> + <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.TimeCreated +<span class="hljs-string"><span class="hljs-string">"`n"</span></span> <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span>+= <span class="hljs-string"><span class="hljs-string">"Workstation Name: "</span></span> + <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.WorkstationName +<span class="hljs-string"><span class="hljs-string">"`n"</span></span> <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span>+= <span class="hljs-string"><span class="hljs-string">"IpAddress: "</span></span> + <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.IpAddress +<span class="hljs-string"><span class="hljs-string">"`n"</span></span> <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span>+= <span class="hljs-string"><span class="hljs-string">"Computer: "</span></span> + [xml]<span class="hljs-variable"><span class="hljs-variable">$Raw_Event</span></span>.ToXML().Event.System.Computer +<span class="hljs-string"><span class="hljs-string">"`n"</span></span> <span class="hljs-variable"><span class="hljs-variable">$Reason</span></span> = DefineReason -Id <span class="hljs-variable"><span class="hljs-variable">$Raw_Event</span></span>.ID <span class="hljs-variable"><span class="hljs-variable">$AccessM</span></span> = DefineReasonByAccessMask -AccessMask <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.Status <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span>+= <span class="hljs-string"><span class="hljs-string">"Reason(RU): "</span></span> + <span class="hljs-variable"><span class="hljs-variable">$Reason</span></span> + <span class="hljs-string"><span class="hljs-string">" "</span></span>+ <span class="hljs-variable"><span class="hljs-variable">$AccessM</span></span> +<span class="hljs-string"><span class="hljs-string">"`n"</span></span> <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span>+= <span class="hljs-string"><span class="hljs-string">"Reason(SYS): "</span></span> + <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.Message +<span class="hljs-string"><span class="hljs-string">"`n"</span></span> <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span>+= <span class="hljs-string"><span class="hljs-string">"----------------------------------------------------------------`n"</span></span> } } } }</code> </pre><br>  7. Search on a specific server, search all events for the entire period: <br><br><pre> <code class="bash hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-variable"><span class="hljs-variable">$FindServerMode</span></span> -ne <span class="hljs-string"><span class="hljs-string">"*"</span></span> -and <span class="hljs-variable"><span class="hljs-variable">$DateEventsmode</span></span> -eq <span class="hljs-string"><span class="hljs-string">"*"</span></span> -and <span class="hljs-variable"><span class="hljs-variable">$TypeEventsMode</span></span> -eq <span class="hljs-string"><span class="hljs-string">"*"</span></span> -and <span class="hljs-variable"><span class="hljs-variable">$Log_Path</span></span> -ne <span class="hljs-string"><span class="hljs-string">""</span></span>){ Write-host <span class="hljs-string"><span class="hljs-string">"  7"</span></span> <span class="hljs-variable"><span class="hljs-variable">$ALL_LOGS</span></span> = Get-ChildItem -Path <span class="hljs-variable"><span class="hljs-variable">$Log_Path</span></span> -Recurse| Where {<span class="hljs-variable"><span class="hljs-variable">$_</span></span>.Extension -eq <span class="hljs-string"><span class="hljs-string">".evtx"</span></span> -and <span class="hljs-variable"><span class="hljs-variable">$_</span></span>.FullName -match <span class="hljs-variable"><span class="hljs-variable">$FindServerMode</span></span>} | Sort LastWriteTime <span class="hljs-variable"><span class="hljs-variable">$ALL_LOGS</span></span> foreach (<span class="hljs-variable"><span class="hljs-variable">$Log</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-variable"><span class="hljs-variable">$ALL_LOGS</span></span>){ <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span> = <span class="hljs-string"><span class="hljs-string">"Audit EventLog Security"</span></span> +<span class="hljs-string"><span class="hljs-string">"`n"</span></span> (<span class="hljs-variable"><span class="hljs-variable">$Log</span></span>).FullName <span class="hljs-variable"><span class="hljs-variable">$MyFilter</span></span> = @{Path=(<span class="hljs-variable"><span class="hljs-variable">$Log</span></span>).FullName} Try {<span class="hljs-variable"><span class="hljs-variable">$Events</span></span> = Get-WinEvent -FilterHashTable <span class="hljs-variable"><span class="hljs-variable">$MyFilter</span></span>} Catch {<span class="hljs-string"><span class="hljs-string">"No events were found in </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$Log</span></span></span><span class="hljs-string">"</span></span>; Continue} ForEach (<span class="hljs-variable"><span class="hljs-variable">$Raw_Event</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-variable"><span class="hljs-variable">$Events</span></span>){ Try{<span class="hljs-variable"><span class="hljs-variable">$EventXML</span></span> = [xml]<span class="hljs-variable"><span class="hljs-variable">$Raw_Event</span></span>.ToXML()} Catch {Write-Host <span class="hljs-string"><span class="hljs-string">"Unable to convert an event to XML"</span></span>} <span class="hljs-variable"><span class="hljs-variable">$Event</span></span> = @{} ForEach (<span class="hljs-variable"><span class="hljs-variable">$object</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-variable"><span class="hljs-variable">$EventXML</span></span>.Event.EventData.Data) { <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.Add(<span class="hljs-variable"><span class="hljs-variable">$object</span></span>.name,<span class="hljs-variable"><span class="hljs-variable">$object</span></span>.<span class="hljs-string"><span class="hljs-string">'#text'</span></span>) } <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.Add(<span class="hljs-string"><span class="hljs-string">"ID"</span></span>,<span class="hljs-variable"><span class="hljs-variable">$Raw_Event</span></span>.ID) <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.Add(<span class="hljs-string"><span class="hljs-string">"TimeCreated"</span></span>,<span class="hljs-variable"><span class="hljs-variable">$Raw_Event</span></span>.TimeCreated) <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span>+= <span class="hljs-string"><span class="hljs-string">"EventID: "</span></span> + <span class="hljs-variable"><span class="hljs-variable">$Raw_Event</span></span>.ID +<span class="hljs-string"><span class="hljs-string">"`n"</span></span> <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span>+= <span class="hljs-string"><span class="hljs-string">"Target User Name: "</span></span> + <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.TargetUserName +<span class="hljs-string"><span class="hljs-string">"`n"</span></span> <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span>+= <span class="hljs-string"><span class="hljs-string">"Target Domain Name: "</span></span> + <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.TargetDomainName +<span class="hljs-string"><span class="hljs-string">"`n"</span></span> <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span>+= <span class="hljs-string"><span class="hljs-string">"Status: "</span></span> + <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.Status +<span class="hljs-string"><span class="hljs-string">"`n"</span></span> <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span>+= <span class="hljs-string"><span class="hljs-string">"TimeGenerated: "</span></span> + <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.TimeCreated +<span class="hljs-string"><span class="hljs-string">"`n"</span></span> <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span>+= <span class="hljs-string"><span class="hljs-string">"Workstation Name: "</span></span> + <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.WorkstationName +<span class="hljs-string"><span class="hljs-string">"`n"</span></span> <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span>+= <span class="hljs-string"><span class="hljs-string">"IpAddress: "</span></span> + <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.IpAddress +<span class="hljs-string"><span class="hljs-string">"`n"</span></span> <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span>+= <span class="hljs-string"><span class="hljs-string">"Computer: "</span></span> + [xml]<span class="hljs-variable"><span class="hljs-variable">$Raw_Event</span></span>.ToXML().Event.System.Computer +<span class="hljs-string"><span class="hljs-string">"`n"</span></span> <span class="hljs-variable"><span class="hljs-variable">$Reason</span></span> = DefineReason -Id <span class="hljs-variable"><span class="hljs-variable">$Raw_Event</span></span>.ID <span class="hljs-variable"><span class="hljs-variable">$AccessM</span></span> = DefineReasonByAccessMask -AccessMask <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.Status <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span>+= <span class="hljs-string"><span class="hljs-string">"Reason(RU): "</span></span> + <span class="hljs-variable"><span class="hljs-variable">$Reason</span></span> + <span class="hljs-string"><span class="hljs-string">" "</span></span>+ <span class="hljs-variable"><span class="hljs-variable">$AccessM</span></span> +<span class="hljs-string"><span class="hljs-string">"`n"</span></span> <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span>+= <span class="hljs-string"><span class="hljs-string">"Reason(SYS): "</span></span> + <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.Message +<span class="hljs-string"><span class="hljs-string">"`n"</span></span> <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span>+= <span class="hljs-string"><span class="hljs-string">"----------------------------------------------------------------`n"</span></span> } } }</code> </pre><br>  8. Search on a specific server, by event filter, for the entire period: <br><br><pre> <code class="bash hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-variable"><span class="hljs-variable">$FindServerMode</span></span> -ne <span class="hljs-string"><span class="hljs-string">"*"</span></span> -and <span class="hljs-variable"><span class="hljs-variable">$DateEventsmode</span></span> -eq <span class="hljs-string"><span class="hljs-string">"*"</span></span> -and <span class="hljs-variable"><span class="hljs-variable">$TypeEventsMode</span></span> -ne <span class="hljs-string"><span class="hljs-string">"*"</span></span> -and <span class="hljs-variable"><span class="hljs-variable">$Log_Path</span></span> -ne <span class="hljs-string"><span class="hljs-string">""</span></span>){ Write-host <span class="hljs-string"><span class="hljs-string">"  8"</span></span> <span class="hljs-variable"><span class="hljs-variable">$ALL_LOGS</span></span> = Get-ChildItem -Path <span class="hljs-variable"><span class="hljs-variable">$Log_Path</span></span> -Recurse| Where {<span class="hljs-variable"><span class="hljs-variable">$_</span></span>.Extension -eq <span class="hljs-string"><span class="hljs-string">".evtx"</span></span> -and <span class="hljs-variable"><span class="hljs-variable">$_</span></span>.FullName -match <span class="hljs-variable"><span class="hljs-variable">$FindServerMode</span></span>} | Sort LastWriteTime <span class="hljs-variable"><span class="hljs-variable">$ALL_LOGS</span></span> foreach (<span class="hljs-variable"><span class="hljs-variable">$Log</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-variable"><span class="hljs-variable">$ALL_LOGS</span></span>){ <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span> = <span class="hljs-string"><span class="hljs-string">"Audit EventLog Security"</span></span> +<span class="hljs-string"><span class="hljs-string">"`n"</span></span> (<span class="hljs-variable"><span class="hljs-variable">$Log</span></span>).FullName <span class="hljs-variable"><span class="hljs-variable">$MyFilter</span></span> = @{Path=(<span class="hljs-variable"><span class="hljs-variable">$Log</span></span>).FullName;ID=<span class="hljs-variable"><span class="hljs-variable">$TypeEventsMode</span></span>} Try {<span class="hljs-variable"><span class="hljs-variable">$Events</span></span> = Get-WinEvent -FilterHashTable <span class="hljs-variable"><span class="hljs-variable">$MyFilter</span></span>} Catch {<span class="hljs-string"><span class="hljs-string">"No events were found in </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$Log</span></span></span><span class="hljs-string">"</span></span>; Continue} ForEach (<span class="hljs-variable"><span class="hljs-variable">$Raw_Event</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-variable"><span class="hljs-variable">$Events</span></span>){ Try{<span class="hljs-variable"><span class="hljs-variable">$EventXML</span></span> = [xml]<span class="hljs-variable"><span class="hljs-variable">$Raw_Event</span></span>.ToXML()} Catch {Write-Host <span class="hljs-string"><span class="hljs-string">"Unable to convert an event to XML"</span></span>} <span class="hljs-variable"><span class="hljs-variable">$Event</span></span> = @{} ForEach (<span class="hljs-variable"><span class="hljs-variable">$object</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-variable"><span class="hljs-variable">$EventXML</span></span>.Event.EventData.Data) { <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.Add(<span class="hljs-variable"><span class="hljs-variable">$object</span></span>.name,<span class="hljs-variable"><span class="hljs-variable">$object</span></span>.<span class="hljs-string"><span class="hljs-string">'#text'</span></span>) } <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.Add(<span class="hljs-string"><span class="hljs-string">"ID"</span></span>,<span class="hljs-variable"><span class="hljs-variable">$Raw_Event</span></span>.ID) <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.Add(<span class="hljs-string"><span class="hljs-string">"TimeCreated"</span></span>,<span class="hljs-variable"><span class="hljs-variable">$Raw_Event</span></span>.TimeCreated) <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span>+= <span class="hljs-string"><span class="hljs-string">"EventID: "</span></span> + <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.ID +<span class="hljs-string"><span class="hljs-string">"`n"</span></span> <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span>+= <span class="hljs-string"><span class="hljs-string">"Target User Name: "</span></span> + <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.TargetUserName +<span class="hljs-string"><span class="hljs-string">"`n"</span></span> <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span>+= <span class="hljs-string"><span class="hljs-string">"Target Domain Name: "</span></span> + <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.TargetDomainName +<span class="hljs-string"><span class="hljs-string">"`n"</span></span> <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span>+= <span class="hljs-string"><span class="hljs-string">"Status: "</span></span> + <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.Status +<span class="hljs-string"><span class="hljs-string">"`n"</span></span> <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span>+= <span class="hljs-string"><span class="hljs-string">"TimeGenerated: "</span></span> + <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.TimeCreated +<span class="hljs-string"><span class="hljs-string">"`n"</span></span> <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span>+= <span class="hljs-string"><span class="hljs-string">"Workstation Name: "</span></span> + <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.WorkstationName +<span class="hljs-string"><span class="hljs-string">"`n"</span></span> <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span>+= <span class="hljs-string"><span class="hljs-string">"IpAddress: "</span></span> + <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.IpAddress +<span class="hljs-string"><span class="hljs-string">"`n"</span></span> <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span>+= <span class="hljs-string"><span class="hljs-string">"Computer: "</span></span> + [xml]<span class="hljs-variable"><span class="hljs-variable">$Raw_Event</span></span>.ToXML().Event.System.Computer +<span class="hljs-string"><span class="hljs-string">"`n"</span></span> <span class="hljs-variable"><span class="hljs-variable">$Reason</span></span> = DefineReason -Id <span class="hljs-variable"><span class="hljs-variable">$Raw_Event</span></span>.ID <span class="hljs-variable"><span class="hljs-variable">$AccessM</span></span> = DefineReasonByAccessMask -AccessMask <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.Status <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span>+= <span class="hljs-string"><span class="hljs-string">"Reason(RU): "</span></span> + <span class="hljs-variable"><span class="hljs-variable">$Reason</span></span> + <span class="hljs-string"><span class="hljs-string">" "</span></span>+ <span class="hljs-variable"><span class="hljs-variable">$AccessM</span></span> +<span class="hljs-string"><span class="hljs-string">"`n"</span></span> <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span>+= <span class="hljs-string"><span class="hljs-string">"Reason(SYS): "</span></span> + <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.Message +<span class="hljs-string"><span class="hljs-string">"`n"</span></span> <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span>+= <span class="hljs-string"><span class="hljs-string">"----------------------------------------------------------------`n"</span></span> } } }</code> </pre><br>  9. Search on a specific server for all events for the period: <br><br><pre> <code class="bash hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-variable"><span class="hljs-variable">$FindServerMode</span></span> -ne <span class="hljs-string"><span class="hljs-string">"*"</span></span>-and <span class="hljs-variable"><span class="hljs-variable">$DateEventsmode</span></span> -match <span class="hljs-string"><span class="hljs-string">"-"</span></span> -and <span class="hljs-variable"><span class="hljs-variable">$TypeEventsMode</span></span> -eq <span class="hljs-string"><span class="hljs-string">"*"</span></span> -and <span class="hljs-variable"><span class="hljs-variable">$Log_Path</span></span> -ne <span class="hljs-string"><span class="hljs-string">""</span></span>){ Write-host <span class="hljs-string"><span class="hljs-string">"  9"</span></span> <span class="hljs-variable"><span class="hljs-variable">$ALL_LOGS</span></span> = Get-ChildItem -Path <span class="hljs-variable"><span class="hljs-variable">$Log_Path</span></span> -Recurse| Where {<span class="hljs-variable"><span class="hljs-variable">$_</span></span>.Extension -eq <span class="hljs-string"><span class="hljs-string">".evtx"</span></span> -and <span class="hljs-variable"><span class="hljs-variable">$_</span></span>.FullName -match <span class="hljs-variable"><span class="hljs-variable">$FindServerMode</span></span> -and <span class="hljs-variable"><span class="hljs-variable">$StartDate</span></span> -ne <span class="hljs-string"><span class="hljs-string">"null"</span></span> -and <span class="hljs-variable"><span class="hljs-variable">$EndDate</span></span> -ne <span class="hljs-string"><span class="hljs-string">"null"</span></span>} | Sort LastWriteTime <span class="hljs-variable"><span class="hljs-variable">$ALL_LOGS</span></span> foreach (<span class="hljs-variable"><span class="hljs-variable">$Log</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-variable"><span class="hljs-variable">$ALL_LOGS</span></span>){ <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span> = <span class="hljs-string"><span class="hljs-string">"Audit EventLog Security"</span></span> +<span class="hljs-string"><span class="hljs-string">"`n"</span></span> (<span class="hljs-variable"><span class="hljs-variable">$Log</span></span>).FullName <span class="hljs-variable"><span class="hljs-variable">$Log</span></span>.LastWriteTime <span class="hljs-variable"><span class="hljs-variable">$StartDate</span></span> <span class="hljs-variable"><span class="hljs-variable">$EndDate</span></span> <span class="hljs-variable"><span class="hljs-variable">$MyFilter</span></span> = @{Path=(<span class="hljs-variable"><span class="hljs-variable">$Log</span></span>).FullName} Try {<span class="hljs-variable"><span class="hljs-variable">$Events</span></span> = Get-WinEvent -FilterHashTable <span class="hljs-variable"><span class="hljs-variable">$MyFilter</span></span>} Catch {<span class="hljs-string"><span class="hljs-string">"No events were found in </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$Log</span></span></span><span class="hljs-string">"</span></span>; Continue} ForEach (<span class="hljs-variable"><span class="hljs-variable">$Raw_Event</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-variable"><span class="hljs-variable">$Events</span></span>){ Try{<span class="hljs-variable"><span class="hljs-variable">$EventXML</span></span> = [xml]<span class="hljs-variable"><span class="hljs-variable">$Raw_Event</span></span>.ToXML()} Catch {Write-Host <span class="hljs-string"><span class="hljs-string">"Unable to convert an event to XML"</span></span>} <span class="hljs-variable"><span class="hljs-variable">$Event</span></span> = @{} ForEach (<span class="hljs-variable"><span class="hljs-variable">$object</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-variable"><span class="hljs-variable">$EventXML</span></span>.Event.EventData.Data) { <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.Add(<span class="hljs-variable"><span class="hljs-variable">$object</span></span>.name,<span class="hljs-variable"><span class="hljs-variable">$object</span></span>.<span class="hljs-string"><span class="hljs-string">'#text'</span></span>) } <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.Add(<span class="hljs-string"><span class="hljs-string">"ID"</span></span>,<span class="hljs-variable"><span class="hljs-variable">$Raw_Event</span></span>.ID) <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.Add(<span class="hljs-string"><span class="hljs-string">"TimeCreated"</span></span>,<span class="hljs-variable"><span class="hljs-variable">$Raw_Event</span></span>.TimeCreated) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.TimeCreated -gt <span class="hljs-variable"><span class="hljs-variable">$StartDate</span></span> -and <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.TimeCreated -lt <span class="hljs-variable"><span class="hljs-variable">$EndDate</span></span>){ <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span>+= <span class="hljs-string"><span class="hljs-string">"EventID: "</span></span> + <span class="hljs-variable"><span class="hljs-variable">$Raw_Event</span></span>.ID +<span class="hljs-string"><span class="hljs-string">"`n"</span></span> <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span>+= <span class="hljs-string"><span class="hljs-string">"Target User Name: "</span></span> + <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.TargetUserName +<span class="hljs-string"><span class="hljs-string">"`n"</span></span> <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span>+= <span class="hljs-string"><span class="hljs-string">"Target Domain Name: "</span></span> + <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.TargetDomainName +<span class="hljs-string"><span class="hljs-string">"`n"</span></span> <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span>+= <span class="hljs-string"><span class="hljs-string">"Status: "</span></span> + <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.Status +<span class="hljs-string"><span class="hljs-string">"`n"</span></span> <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span>+= <span class="hljs-string"><span class="hljs-string">"TimeGenerated: "</span></span> + <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.TimeCreated +<span class="hljs-string"><span class="hljs-string">"`n"</span></span> <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span>+= <span class="hljs-string"><span class="hljs-string">"Workstation Name: "</span></span> + <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.WorkstationName +<span class="hljs-string"><span class="hljs-string">"`n"</span></span> <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span>+= <span class="hljs-string"><span class="hljs-string">"IpAddress: "</span></span> + <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.IpAddress +<span class="hljs-string"><span class="hljs-string">"`n"</span></span> <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span>+= <span class="hljs-string"><span class="hljs-string">"Computer: "</span></span> + [xml]<span class="hljs-variable"><span class="hljs-variable">$Raw_Event</span></span>.ToXML().Event.System.Computer +<span class="hljs-string"><span class="hljs-string">"`n"</span></span> <span class="hljs-variable"><span class="hljs-variable">$Reason</span></span> = DefineReason -Id <span class="hljs-variable"><span class="hljs-variable">$Raw_Event</span></span>.ID <span class="hljs-variable"><span class="hljs-variable">$AccessM</span></span> = DefineReasonByAccessMask -AccessMask <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.Status <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span>+= <span class="hljs-string"><span class="hljs-string">"Reason(RU): "</span></span> + <span class="hljs-variable"><span class="hljs-variable">$Reason</span></span> + <span class="hljs-string"><span class="hljs-string">" "</span></span>+ <span class="hljs-variable"><span class="hljs-variable">$AccessM</span></span> +<span class="hljs-string"><span class="hljs-string">"`n"</span></span> <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span>+= <span class="hljs-string"><span class="hljs-string">"Reason(SYS): "</span></span> + <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.Message +<span class="hljs-string"><span class="hljs-string">"`n"</span></span> <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span>+= <span class="hljs-string"><span class="hljs-string">"----------------------------------------------------------------`n"</span></span> } } } }</code> </pre><br>  10. Search on a specific server, by event filter, for the period: <br><br><pre> <code class="bash hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-variable"><span class="hljs-variable">$FindServerMode</span></span> -ne <span class="hljs-string"><span class="hljs-string">"*"</span></span> -and <span class="hljs-variable"><span class="hljs-variable">$DateEventsmode</span></span> -match <span class="hljs-string"><span class="hljs-string">"-"</span></span> -and <span class="hljs-variable"><span class="hljs-variable">$DateEventsmode</span></span> -ne <span class="hljs-string"><span class="hljs-string">"*"</span></span> -and <span class="hljs-variable"><span class="hljs-variable">$TypeEventsMode</span></span> -ne <span class="hljs-string"><span class="hljs-string">"*"</span></span> -and <span class="hljs-variable"><span class="hljs-variable">$Log_Path</span></span> -ne <span class="hljs-string"><span class="hljs-string">""</span></span>){ Write-host <span class="hljs-string"><span class="hljs-string">"  10"</span></span> <span class="hljs-variable"><span class="hljs-variable">$ALL_LOGS</span></span> = Get-ChildItem -Path <span class="hljs-variable"><span class="hljs-variable">$Log_Path</span></span> | Where {<span class="hljs-variable"><span class="hljs-variable">$_</span></span>.Extension -eq <span class="hljs-string"><span class="hljs-string">".evtx"</span></span> -and <span class="hljs-variable"><span class="hljs-variable">$_</span></span>.FullName -match <span class="hljs-variable"><span class="hljs-variable">$FindServerMode</span></span> -and <span class="hljs-variable"><span class="hljs-variable">$StartDate</span></span> -ne <span class="hljs-string"><span class="hljs-string">"null"</span></span> -and <span class="hljs-variable"><span class="hljs-variable">$EndDate</span></span> -ne <span class="hljs-string"><span class="hljs-string">"null"</span></span>} | Sort LastWriteTime <span class="hljs-variable"><span class="hljs-variable">$ALL_LOGS</span></span> foreach (<span class="hljs-variable"><span class="hljs-variable">$Log</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-variable"><span class="hljs-variable">$ALL_LOGS</span></span>){ <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span> = <span class="hljs-string"><span class="hljs-string">"Audit EventLog Security"</span></span> +<span class="hljs-string"><span class="hljs-string">"`n"</span></span> (<span class="hljs-variable"><span class="hljs-variable">$Log</span></span>).FullName <span class="hljs-variable"><span class="hljs-variable">$Log</span></span>.LastWriteTime <span class="hljs-variable"><span class="hljs-variable">$StartDate</span></span> <span class="hljs-variable"><span class="hljs-variable">$EndDate</span></span> <span class="hljs-variable"><span class="hljs-variable">$MyFilter</span></span> = @{Path=(<span class="hljs-variable"><span class="hljs-variable">$Log</span></span>).FullName;ID=<span class="hljs-variable"><span class="hljs-variable">$TypeEventsMode</span></span>} Try {<span class="hljs-variable"><span class="hljs-variable">$Events</span></span> = Get-WinEvent -FilterHashTable <span class="hljs-variable"><span class="hljs-variable">$MyFilter</span></span>} Catch {<span class="hljs-string"><span class="hljs-string">"No events were found in </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$Log</span></span></span><span class="hljs-string">"</span></span>; Continue} ForEach (<span class="hljs-variable"><span class="hljs-variable">$Raw_Event</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-variable"><span class="hljs-variable">$Events</span></span>){ Try{<span class="hljs-variable"><span class="hljs-variable">$EventXML</span></span> = [xml]<span class="hljs-variable"><span class="hljs-variable">$Raw_Event</span></span>.ToXML()} Catch {Write-Host <span class="hljs-string"><span class="hljs-string">"Unable to convert an event to XML"</span></span>} <span class="hljs-variable"><span class="hljs-variable">$Event</span></span> = @{} ForEach (<span class="hljs-variable"><span class="hljs-variable">$object</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-variable"><span class="hljs-variable">$EventXML</span></span>.Event.EventData.Data) { <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.Add(<span class="hljs-variable"><span class="hljs-variable">$object</span></span>.name,<span class="hljs-variable"><span class="hljs-variable">$object</span></span>.<span class="hljs-string"><span class="hljs-string">'#text'</span></span>) } <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.Add(<span class="hljs-string"><span class="hljs-string">"ID"</span></span>,<span class="hljs-variable"><span class="hljs-variable">$Raw_Event</span></span>.ID) <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.Add(<span class="hljs-string"><span class="hljs-string">"TimeCreated"</span></span>,<span class="hljs-variable"><span class="hljs-variable">$Raw_Event</span></span>.TimeCreated) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.TimeCreated -gt <span class="hljs-variable"><span class="hljs-variable">$StartDate</span></span> -and <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.TimeCreated -lt <span class="hljs-variable"><span class="hljs-variable">$EndDate</span></span>){ <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span>+= <span class="hljs-string"><span class="hljs-string">"EventID: "</span></span> + <span class="hljs-variable"><span class="hljs-variable">$Raw_Event</span></span>.ID +<span class="hljs-string"><span class="hljs-string">"`n"</span></span> <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span>+= <span class="hljs-string"><span class="hljs-string">"Target User Name: "</span></span> + <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.TargetUserName +<span class="hljs-string"><span class="hljs-string">"`n"</span></span> <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span>+= <span class="hljs-string"><span class="hljs-string">"Target Domain Name: "</span></span> + <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.TargetDomainName +<span class="hljs-string"><span class="hljs-string">"`n"</span></span> <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span>+= <span class="hljs-string"><span class="hljs-string">"Status: "</span></span> + <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.Status +<span class="hljs-string"><span class="hljs-string">"`n"</span></span> <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span>+= <span class="hljs-string"><span class="hljs-string">"TimeGenerated: "</span></span> + <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.TimeCreated +<span class="hljs-string"><span class="hljs-string">"`n"</span></span> <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span>+= <span class="hljs-string"><span class="hljs-string">"Workstation Name: "</span></span> + <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.WorkstationName +<span class="hljs-string"><span class="hljs-string">"`n"</span></span> <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span>+= <span class="hljs-string"><span class="hljs-string">"IpAddress: "</span></span> + <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.IpAddress +<span class="hljs-string"><span class="hljs-string">"`n"</span></span> <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span>+= <span class="hljs-string"><span class="hljs-string">"Computer: "</span></span> + [xml]<span class="hljs-variable"><span class="hljs-variable">$Raw_Event</span></span>.ToXML().Event.System.Computer +<span class="hljs-string"><span class="hljs-string">"`n"</span></span> <span class="hljs-variable"><span class="hljs-variable">$Reason</span></span> = DefineReason -Id <span class="hljs-variable"><span class="hljs-variable">$Raw_Event</span></span>.ID <span class="hljs-variable"><span class="hljs-variable">$AccessM</span></span> = DefineReasonByAccessMask -AccessMask <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.Status <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span>+= <span class="hljs-string"><span class="hljs-string">"Reason(RU): "</span></span> + <span class="hljs-variable"><span class="hljs-variable">$Reason</span></span> + <span class="hljs-string"><span class="hljs-string">" "</span></span>+ <span class="hljs-variable"><span class="hljs-variable">$AccessM</span></span> +<span class="hljs-string"><span class="hljs-string">"`n"</span></span> <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span>+= <span class="hljs-string"><span class="hljs-string">"Reason(SYS): "</span></span> + <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.Message +<span class="hljs-string"><span class="hljs-string">"`n"</span></span> <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span>+= <span class="hljs-string"><span class="hljs-string">"----------------------------------------------------------------`n"</span></span> } } } }</code> </pre><br>  11. Search for a specific server, for all events, for a specific date: <br><br><pre> <code class="bash hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-variable"><span class="hljs-variable">$FindServerMode</span></span> -ne <span class="hljs-string"><span class="hljs-string">"*"</span></span> -and <span class="hljs-variable"><span class="hljs-variable">$DateEventsmode</span></span> -notmatch <span class="hljs-string"><span class="hljs-string">"-"</span></span> -and <span class="hljs-variable"><span class="hljs-variable">$DateEventsmode</span></span> -ne <span class="hljs-string"><span class="hljs-string">"*"</span></span> -and <span class="hljs-variable"><span class="hljs-variable">$TypeEventsMode</span></span> -eq <span class="hljs-string"><span class="hljs-string">"*"</span></span> -and <span class="hljs-variable"><span class="hljs-variable">$Log_Path</span></span> -ne <span class="hljs-string"><span class="hljs-string">""</span></span>){ Write-host <span class="hljs-string"><span class="hljs-string">"  11"</span></span> <span class="hljs-variable"><span class="hljs-variable">$ALL_LOGS</span></span> = Get-ChildItem -Path <span class="hljs-variable"><span class="hljs-variable">$Log_Path</span></span> -Recurse| Where {<span class="hljs-variable"><span class="hljs-variable">$_</span></span>.Extension -eq <span class="hljs-string"><span class="hljs-string">".evtx"</span></span> -and <span class="hljs-variable"><span class="hljs-variable">$StartDate1</span></span> -ne <span class="hljs-string"><span class="hljs-string">"null"</span></span> } | Sort LastWriteTime <span class="hljs-variable"><span class="hljs-variable">$ALL_LOGS</span></span> foreach (<span class="hljs-variable"><span class="hljs-variable">$Log</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-variable"><span class="hljs-variable">$ALL_LOGS</span></span>){ <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span> = <span class="hljs-string"><span class="hljs-string">"Audit EventLog Security"</span></span> +<span class="hljs-string"><span class="hljs-string">"`n"</span></span> (<span class="hljs-variable"><span class="hljs-variable">$Log</span></span>).FullName <span class="hljs-variable"><span class="hljs-variable">$Log</span></span>.LastWriteTime <span class="hljs-variable"><span class="hljs-variable">$StartDate</span></span> <span class="hljs-variable"><span class="hljs-variable">$EndDate</span></span> <span class="hljs-variable"><span class="hljs-variable">$MyFilter</span></span> = @{Path=(<span class="hljs-variable"><span class="hljs-variable">$Log</span></span>).FullName} Try {<span class="hljs-variable"><span class="hljs-variable">$Events</span></span> = Get-WinEvent -FilterHashTable <span class="hljs-variable"><span class="hljs-variable">$MyFilter</span></span>} Catch {<span class="hljs-string"><span class="hljs-string">"No events were found in </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$Log</span></span></span><span class="hljs-string">"</span></span>; Continue} ForEach (<span class="hljs-variable"><span class="hljs-variable">$Raw_Event</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-variable"><span class="hljs-variable">$Events</span></span>){ Try{<span class="hljs-variable"><span class="hljs-variable">$EventXML</span></span> = [xml]<span class="hljs-variable"><span class="hljs-variable">$Raw_Event</span></span>.ToXML()} Catch {Write-Host <span class="hljs-string"><span class="hljs-string">"Unable to convert an event to XML"</span></span>} <span class="hljs-variable"><span class="hljs-variable">$Event</span></span> = @{} ForEach (<span class="hljs-variable"><span class="hljs-variable">$object</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-variable"><span class="hljs-variable">$EventXML</span></span>.Event.EventData.Data) { <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.Add(<span class="hljs-variable"><span class="hljs-variable">$object</span></span>.name,<span class="hljs-variable"><span class="hljs-variable">$object</span></span>.<span class="hljs-string"><span class="hljs-string">'#text'</span></span>) } <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.Add(<span class="hljs-string"><span class="hljs-string">"ID"</span></span>,<span class="hljs-variable"><span class="hljs-variable">$Raw_Event</span></span>.ID) <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.Add(<span class="hljs-string"><span class="hljs-string">"TimeCreated"</span></span>,<span class="hljs-variable"><span class="hljs-variable">$Raw_Event</span></span>.TimeCreated) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.TimeCreated.Day -eq <span class="hljs-variable"><span class="hljs-variable">$StartDate1</span></span>.Day -and <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.TimeCreated.Month -eq <span class="hljs-variable"><span class="hljs-variable">$StartDate1</span></span>.Month -and <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.TimeCreated.Year -eq <span class="hljs-variable"><span class="hljs-variable">$StartDate1</span></span>.Year){ <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span>+= <span class="hljs-string"><span class="hljs-string">"EventID: "</span></span> + <span class="hljs-variable"><span class="hljs-variable">$Raw_Event</span></span>.ID +<span class="hljs-string"><span class="hljs-string">"`n"</span></span> <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span>+= <span class="hljs-string"><span class="hljs-string">"Target User Name: "</span></span> + <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.TargetUserName +<span class="hljs-string"><span class="hljs-string">"`n"</span></span> <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span>+= <span class="hljs-string"><span class="hljs-string">"Target Domain Name: "</span></span> + <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.TargetDomainName +<span class="hljs-string"><span class="hljs-string">"`n"</span></span> <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span>+= <span class="hljs-string"><span class="hljs-string">"Status: "</span></span> + <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.Status +<span class="hljs-string"><span class="hljs-string">"`n"</span></span> <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span>+= <span class="hljs-string"><span class="hljs-string">"TimeGenerated: "</span></span> + <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.TimeCreated +<span class="hljs-string"><span class="hljs-string">"`n"</span></span> <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span>+= <span class="hljs-string"><span class="hljs-string">"Workstation Name: "</span></span> + <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.WorkstationName +<span class="hljs-string"><span class="hljs-string">"`n"</span></span> <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span>+= <span class="hljs-string"><span class="hljs-string">"IpAddress: "</span></span> + <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.IpAddress +<span class="hljs-string"><span class="hljs-string">"`n"</span></span> <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span>+= <span class="hljs-string"><span class="hljs-string">"Computer: "</span></span> + [xml]<span class="hljs-variable"><span class="hljs-variable">$Raw_Event</span></span>.ToXML().Event.System.Computer +<span class="hljs-string"><span class="hljs-string">"`n"</span></span> <span class="hljs-variable"><span class="hljs-variable">$Reason</span></span> = DefineReason -Id <span class="hljs-variable"><span class="hljs-variable">$Raw_Event</span></span>.ID <span class="hljs-variable"><span class="hljs-variable">$AccessM</span></span> = DefineReasonByAccessMask -AccessMask <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.Status <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span>+= <span class="hljs-string"><span class="hljs-string">"Reason(RU): "</span></span> + <span class="hljs-variable"><span class="hljs-variable">$Reason</span></span> + <span class="hljs-string"><span class="hljs-string">" "</span></span>+ <span class="hljs-variable"><span class="hljs-variable">$AccessM</span></span> +<span class="hljs-string"><span class="hljs-string">"`n"</span></span> <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span>+= <span class="hljs-string"><span class="hljs-string">"Reason(SYS): "</span></span> + <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.Message +<span class="hljs-string"><span class="hljs-string">"`n"</span></span> <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span>+= <span class="hljs-string"><span class="hljs-string">"----------------------------------------------------------------`n"</span></span> } } } }</code> </pre><br>  12. Search by specific server, by event filter, for a specific date: <br><br><pre> <code class="bash hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-variable"><span class="hljs-variable">$FindServerMode</span></span> -ne <span class="hljs-string"><span class="hljs-string">"*"</span></span> -and <span class="hljs-variable"><span class="hljs-variable">$TypeEventsMode</span></span> -ne <span class="hljs-string"><span class="hljs-string">"*"</span></span> -and <span class="hljs-variable"><span class="hljs-variable">$DateEventsmode</span></span> -notmatch <span class="hljs-string"><span class="hljs-string">"-"</span></span> -and <span class="hljs-variable"><span class="hljs-variable">$DateEventsmode</span></span> -ne <span class="hljs-string"><span class="hljs-string">"*"</span></span> -and <span class="hljs-variable"><span class="hljs-variable">$Log_Path</span></span> -ne <span class="hljs-string"><span class="hljs-string">""</span></span>){ Write-host <span class="hljs-string"><span class="hljs-string">"  12"</span></span> <span class="hljs-variable"><span class="hljs-variable">$ALL_LOGS</span></span> = Get-ChildItem -Path <span class="hljs-variable"><span class="hljs-variable">$Log_Path</span></span> -Recurse| Where {<span class="hljs-variable"><span class="hljs-variable">$_</span></span>.Extension -eq <span class="hljs-string"><span class="hljs-string">".evtx"</span></span> -and <span class="hljs-variable"><span class="hljs-variable">$StartDate1</span></span> -ne <span class="hljs-string"><span class="hljs-string">"null"</span></span> } | Sort LastWriteTime <span class="hljs-variable"><span class="hljs-variable">$ALL_LOGS</span></span> foreach (<span class="hljs-variable"><span class="hljs-variable">$Log</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-variable"><span class="hljs-variable">$ALL_LOGS</span></span>){ <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span> = <span class="hljs-string"><span class="hljs-string">"Audit EventLog Security"</span></span> +<span class="hljs-string"><span class="hljs-string">"`n"</span></span> (<span class="hljs-variable"><span class="hljs-variable">$Log</span></span>).FullName <span class="hljs-variable"><span class="hljs-variable">$Log</span></span>.LastWriteTime <span class="hljs-variable"><span class="hljs-variable">$StartDate</span></span> <span class="hljs-variable"><span class="hljs-variable">$EndDate</span></span> <span class="hljs-variable"><span class="hljs-variable">$MyFilter</span></span> = @{Path=(<span class="hljs-variable"><span class="hljs-variable">$Log</span></span>).FullName;ID=<span class="hljs-variable"><span class="hljs-variable">$TypeEventsMode</span></span>} Try {<span class="hljs-variable"><span class="hljs-variable">$Events</span></span> = Get-WinEvent -FilterHashTable <span class="hljs-variable"><span class="hljs-variable">$MyFilter</span></span>} Catch {<span class="hljs-string"><span class="hljs-string">"No events were found in </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$Log</span></span></span><span class="hljs-string">"</span></span>; Continue} ForEach (<span class="hljs-variable"><span class="hljs-variable">$Raw_Event</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-variable"><span class="hljs-variable">$Events</span></span>){ Try{<span class="hljs-variable"><span class="hljs-variable">$EventXML</span></span> = [xml]<span class="hljs-variable"><span class="hljs-variable">$Raw_Event</span></span>.ToXML()} Catch {Write-Host <span class="hljs-string"><span class="hljs-string">"Unable to convert an event to XML"</span></span>} <span class="hljs-variable"><span class="hljs-variable">$Event</span></span> = @{} ForEach (<span class="hljs-variable"><span class="hljs-variable">$object</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-variable"><span class="hljs-variable">$EventXML</span></span>.Event.Message) { <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.Add(<span class="hljs-variable"><span class="hljs-variable">$object</span></span>.name,<span class="hljs-variable"><span class="hljs-variable">$object</span></span>.<span class="hljs-string"><span class="hljs-string">'#text'</span></span>) } <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.Add(<span class="hljs-string"><span class="hljs-string">"ID"</span></span>,<span class="hljs-variable"><span class="hljs-variable">$Raw_Event</span></span>.ID) <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.Add(<span class="hljs-string"><span class="hljs-string">"TimeCreated"</span></span>,<span class="hljs-variable"><span class="hljs-variable">$Raw_Event</span></span>.TimeCreated) <span class="hljs-variable"><span class="hljs-variable">$Event</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.TimeCreated.Day -eq <span class="hljs-variable"><span class="hljs-variable">$StartDate1</span></span>.Day -and <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.TimeCreated.Month -eq <span class="hljs-variable"><span class="hljs-variable">$StartDate1</span></span>.Month -and <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.TimeCreated.Year -eq <span class="hljs-variable"><span class="hljs-variable">$StartDate1</span></span>.Year){ <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span>+= <span class="hljs-string"><span class="hljs-string">"EventID: "</span></span> + <span class="hljs-variable"><span class="hljs-variable">$Raw_Event</span></span>.ID +<span class="hljs-string"><span class="hljs-string">"`n"</span></span> <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span>+= <span class="hljs-string"><span class="hljs-string">"Target User Name: "</span></span> + <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.TargetUserName +<span class="hljs-string"><span class="hljs-string">"`n"</span></span> <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span>+= <span class="hljs-string"><span class="hljs-string">"Target Domain Name: "</span></span> + <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.TargetDomainName +<span class="hljs-string"><span class="hljs-string">"`n"</span></span> <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span>+= <span class="hljs-string"><span class="hljs-string">"Status: "</span></span> + <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.Status +<span class="hljs-string"><span class="hljs-string">"`n"</span></span> <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span>+= <span class="hljs-string"><span class="hljs-string">"TimeGenerated: "</span></span> + <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.TimeCreated +<span class="hljs-string"><span class="hljs-string">"`n"</span></span> <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span>+= <span class="hljs-string"><span class="hljs-string">"Workstation Name: "</span></span> + <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.WorkstationName +<span class="hljs-string"><span class="hljs-string">"`n"</span></span> <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span>+= <span class="hljs-string"><span class="hljs-string">"IpAddress: "</span></span> + <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.IpAddress +<span class="hljs-string"><span class="hljs-string">"`n"</span></span> <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span>+= <span class="hljs-string"><span class="hljs-string">"Computer: "</span></span> + [xml]<span class="hljs-variable"><span class="hljs-variable">$Raw_Event</span></span>.ToXML().Event.System.Computer +<span class="hljs-string"><span class="hljs-string">"`n"</span></span> <span class="hljs-variable"><span class="hljs-variable">$Reason</span></span> = DefineReason -Id <span class="hljs-variable"><span class="hljs-variable">$Raw_Event</span></span>.ID <span class="hljs-variable"><span class="hljs-variable">$AccessM</span></span> = DefineReasonByAccessMask -AccessMask <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.Status <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span>+= <span class="hljs-string"><span class="hljs-string">"Reason(RU): "</span></span> + <span class="hljs-variable"><span class="hljs-variable">$Reason</span></span> + <span class="hljs-string"><span class="hljs-string">" "</span></span>+ <span class="hljs-variable"><span class="hljs-variable">$AccessM</span></span> +<span class="hljs-string"><span class="hljs-string">"`n"</span></span> <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span>+= <span class="hljs-string"><span class="hljs-string">"Reason(SYS): "</span></span> + <span class="hljs-variable"><span class="hljs-variable">$Event</span></span>.Message +<span class="hljs-string"><span class="hljs-string">"`n"</span></span> <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span>+= <span class="hljs-string"><span class="hljs-string">"----------------------------------------------------------------`n"</span></span> } } } }</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">At the end of the month (the period is set individually by administrators), the security log is archived on the storage server, with the server name and the date of archiving. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">After we have described all the options for searching for events. </font><font style="vertical-align: inherit;">We need to save the result to a file, the path to which was specified by the user in the last field. </font><font style="vertical-align: inherit;">If the path is specified, the result is saved to a file. </font><font style="vertical-align: inherit;">After running the script, the file is automatically launched. </font><font style="vertical-align: inherit;">If the path to save the result is not specified, the log will be saved in the working directory under the name "log.log".</font></font><br><br><pre> <code class="bash hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-variable"><span class="hljs-variable">$SaveResult</span></span> -ne <span class="hljs-string"><span class="hljs-string">""</span></span>){ <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span> | Out-File <span class="hljs-variable"><span class="hljs-variable">$SaveResult</span></span> -Encoding utf8 Invoke-Item <span class="hljs-variable"><span class="hljs-variable">$SaveResult</span></span> <span class="hljs-variable"><span class="hljs-variable">$Event2</span></span>= @{} <span class="hljs-variable"><span class="hljs-variable">$Event</span></span> = @{} <span class="hljs-variable"><span class="hljs-variable">$Log_Path</span></span>=<span class="hljs-string"><span class="hljs-string">""</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>{ <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span> | Out-File <span class="hljs-string"><span class="hljs-string">".\log.log"</span></span> -Encoding utf8 Write-Host <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span> <span class="hljs-variable"><span class="hljs-variable">$Event2</span></span>= @{} <span class="hljs-variable"><span class="hljs-variable">$Event</span></span> = @{} <span class="hljs-variable"><span class="hljs-variable">$Log_Path</span></span>=<span class="hljs-string"><span class="hljs-string">""</span></span> }</code> </pre><br>  Thanks for attention. <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">While writing the script, the article ‚Äú </font></font><a href="http://habrahabr.ru/post/118644/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PowerShell and Security Audit</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ‚Äù </font><font style="vertical-align: inherit;">was very useful </font><font style="vertical-align: inherit;">, thanks to the author.</font></font></div><p>Source: <a href="https://habr.com/ru/post/271963/">https://habr.com/ru/post/271963/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../271953/index.html">Dispelling myths about secure passwords</a></li>
<li><a href="../271955/index.html">We invite you to the December meetings of the IT community in Samara, Novosibirsk and Krasnoyarsk</a></li>
<li><a href="../271957/index.html">Systemd and Containers: Introduction to systemd-nspawn</a></li>
<li><a href="../271959/index.html">NetApp ONTAP: UNMAP in the SAN environment</a></li>
<li><a href="../271961/index.html">Reliability and durability of server hardware</a></li>
<li><a href="../271965/index.html">Practical aspects of automatic generation of unique texts for SEO</a></li>
<li><a href="../271969/index.html">Lightweight Parser Designer with Interactive Mode</a></li>
<li><a href="../271971/index.html">Announcement of online courses Technopark, Technosphere and Technotrack on Stepic</a></li>
<li><a href="../271977/index.html">Recognition of the Burmese language: now we can even</a></li>
<li><a href="../271979/index.html">How did we do Linux-penguins for the New Year</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>