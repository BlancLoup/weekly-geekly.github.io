<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Immersion in pricing Magento 2, we remove pennies after discounts</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Pricing is perhaps Magento's dignity and the most interesting part of the system. 
 And for the owner of the store - the most important part, since it...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Immersion in pricing Magento 2, we remove pennies after discounts</h1><div class="post__text post__text-html js-mediator-article"><img src="https://morozov.group/application/files/7315/0408/7708/2017-08-30_13-07-57.png"><br>  <b>Pricing</b> is perhaps Magento's dignity and the most interesting part of the system. <br>  And for the owner of the store - the most important part, since it is associated with money. <br>  Previously, colleagues were drawing diagrams that could barely fit on the Chinese Wall, trying to fit all the calculation steps.  In this article I will try to present only the main stages of calculation, and an example of rounding discounts in favor of the store.  Fortunately, compared to Magento 1, innovations touched the deepest, the approach remained unchanged. <br><br><h2>  The tip of the iceberg </h2><br><img src="https://morozov.group/application/files/8115/0400/0579/2017-08-29_12-37-28.png" alt="image"><br><br>  When the customer changes the contents of the basket the calculation starts.  The speed of calculation depends on a variety of actions "at depth".  Let's start the dive with prominent places.  at the same time, we will see events and dependencies of the types of goods, delivery methods, price rules of the basket and the catalog. <br><a name="habracut"></a><br>  The article describes the correct pricing approach for the following modules / integrations: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ul><li>  Client balance - when money is not returned to the client, but remains in the store. </li><li>  Loyalty program - payment by "parrots" for services to the store. </li><li>  Certificates - Some balance that can be used by number. </li><li>  The multiplicity of the number - not all ERP systems are able to sell 3 goods for 2 rubles, an annoying penny appears, which the client will demand upon return. </li><li>  Integration of pricing - in some retail networks, or large companies, the responsibility for calculating the cost is produced by a particular system, SAP ERP or cloud service (a handwriting module for the cash register with an interface). </li></ul><br>  We proceed immediately to the calculation, since the formation of the rows of the basket when adding goods is a separate topic, it will be possible in the following articles. <br>  The text will contain Total, Price, Carrier models, they denote a certain type, and then it is easier to refer to. <br><br><h3>  \ Magento \ Quote \ Model \ Quote :: collectTotals </h3><br>  The journey begins where we go and start calculating. <br>  We ask TotalsCollector to do the calculation, this class was specially separated from the basket, so as not to add more lines to the code. <br><br><h4>  \ Magento \ Quote \ Model \ Quote \ TotalsCollector :: collect </h4><br>  Where we go to all addresses and ask for the addresses to calculate for all addresses. <br>  This is done for the possibility of placing orders at multiple addresses at once, since this is one of the useful functions for B2B stores that have a centralized purchasing department and orders go "wholesale" but at different places at once. <br><br><h4>  \ Magento \ Quote \ Model \ Quote \ TotalsCollector :: collectAddressTotals </h4><br>  We ask that we have a responsible TotalsCollectorList class that returns us all the stages of the calculation.  All stages are in configuration, ordered.  At the end, we‚Äôll look at our little pricing modifier. <br><br><h4>  \ Magento \ Quote \ Model \ Quote \ TotalsCollectorList :: getCollectors </h4><br>  The result of the execution is an array of classes CollectorInterface, which implements the logic of calculating the cost. <br><br>  All stages of the calculation are declared for the main entities that are important when calculating the cost: baskets, bills, returns.  There are always good examples in the system kernel: <b>vendor / magento / module-sales / etc / sales.xml</b> <br><br>  The following describes the addition of calculation steps for the order_invoice and order_creditmemo invoice (invoice) and order_creditmemo refund. <br><br>  In addition, available_product_type (available types of goods for purchase) are added.  In modules of specific types of goods types of goods are declared. <br><br><pre><code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">config</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:xsi</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xsi:noNamespaceSchemaLocation</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"urn:magento:module:Magento_Sales:etc/sales.xsd"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">section</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"order_invoice"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">group</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"totals"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">item</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"subtotal"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">instance</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Magento\Sales\Model\Order\Invoice\Total\Subtotal"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">sort_order</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"50"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">item</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"discount"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">instance</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Magento\Sales\Model\Order\Invoice\Total\Discount"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">sort_order</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"100"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">item</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"shipping"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">instance</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Magento\Sales\Model\Order\Invoice\Total\Shipping"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">sort_order</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"150"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">item</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"tax"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">instance</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Magento\Sales\Model\Order\Invoice\Total\Tax"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">sort_order</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"200"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">item</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"cost_total"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">instance</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Magento\Sales\Model\Order\Invoice\Total\Cost"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">sort_order</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"250"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">item</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"grand_total"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">instance</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Magento\Sales\Model\Order\Invoice\Total\Grand"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">sort_order</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"350"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">group</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">section</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">section</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"order_creditmemo"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">group</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"totals"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">item</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"subtotal"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">instance</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Magento\Sales\Model\Order\Creditmemo\Total\Subtotal"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">sort_order</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"50"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">item</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"discount"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">instance</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Magento\Sales\Model\Order\Creditmemo\Total\Discount"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">sort_order</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"150"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">item</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"shipping"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">instance</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Magento\Sales\Model\Order\Creditmemo\Total\Shipping"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">sort_order</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"200"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">item</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"tax"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">instance</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Magento\Sales\Model\Order\Creditmemo\Total\Tax"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">sort_order</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"250"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">item</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"cost_total"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">instance</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Magento\Sales\Model\Order\Creditmemo\Total\Cost"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">sort_order</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"300"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">item</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"grand_total"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">instance</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Magento\Sales\Model\Order\Creditmemo\Total\Grand"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">sort_order</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"400"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">group</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">section</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">order</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">available_product_type</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"simple"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">available_product_type</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"virtual"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">order</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">config</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  Below is a list of names and classes of total-models for a basket: <br><br>  1. <b>subtotal</b> =&gt; \ Magento \ Quote \ Model \ Quote \ Address \ Total \ Subtotal <br>  The calculation of the value of goods before tax discounts and other things. <br>  2. <b>tax_subtotal</b> =&gt; \ Magento \ Tax \ Model \ Sales \ Total \ Quote \ Subtotal <br>  Taxes are part of the tax <br>  3. <b>weee</b> =&gt; \ Magento \ Weee \ Model \ Total \ Quote \ Weee, <br>  Fixed taxes, excise taxes <br>  4. <b>shipping</b> =&gt; \ Magento \ Quote \ Model \ Quote \ Address \ Total \ Shipping <br>  Calculating the cost of delivery, contacting delivery services for online calculation <br>  5. <b>tax_shipping</b> =&gt; \ Magento \ Tax \ Model \ Sales \ Total \ Quote \ Shipping <br>  Taxes on delivery, delivery can also be taxed and / or for accounting it is required. <br>  6. <b>discount</b> =&gt; \ Magento \ SalesRule \ Model \ Quote \ Discount, <br>  Processing discount rules, applying coupons, promotions, ‚Äúweather‚Äù discounts <br>  7. <b>tax</b> =&gt; \ Magento \ Tax \ Model \ Sales \ Total \ Quote \ Tax <br>  Another step in the calculation of taxes, as the discount under the law may not reduce the tax base. <br>  8. <b>weee_tax</b> =&gt; \ Magento \ Weee \ Model \ Total \ Quote \ WeeeTax, <br>  Fixed Taxes Another Stage <br>  9. <b>grand_total</b> =&gt; \ Magento \ Quote \ Model \ Quote \ Address \ Total \ Grand <br>  The total counting summarizes all that is considered before. <br><br><h2>  Under water </h2><br>  The most interesting elements are in <b>subtotal, shipping, discount</b> . <br><br><h4>  \ Magento \ Quote \ Model \ Quote \ Address \ Total \ Subtotal </h4><br><img src="https://morozov.group/application/files/5715/0400/1635/2017-08-29_13-13-38.png" alt="image"><br><br>  And so, to get the cost of the goods <b>Subtotal</b> asks the product to give him the final price. <br><br>  But the product itself does not know its price, it goes to its <b>Price-</b> model. <br>  Work Price models is a whole topic for a separate article "How to create your type of product." <br>  But this is already enough to redefine the primary price of any product, it may be part of the simplest integration with personal prices for the client, where all prices are stored in a simple table, perhaps they are loaded there once a day. <br><br><h4>  \ Magento \ SalesRule \ Model \ Quote \ Discount </h4><br><img src="https://morozov.group/application/files/2215/0401/4362/2017-08-29_16-45-40.png" alt="image"><br><br>  Discounts are another interesting place where the basket is checked for whether or not a discount can be used.  Adding special rules (for example, a discount on the weather in the city) for verification deserves a separate article. <br><br>  The system checks all active discount rules for the current date.  If there are a lot of rules, it can slow down the basket recalculation.  Everything will be fine if the rules to <br><br><h4>  \ Magento \ Quote \ Model \ Quote \ Address \ Total \ Shipping </h4><br><img src="https://morozov.group/application/files/3315/0401/3919/2017-08-29_16-38-24.png" alt="image"><br><br>  The cost of shipping is calculated by circumventing all shipping methods and calling <br>  \ Magento \ Shipping \ Model \ Carrier \ AbstractCarrierInterface :: collectRates The shipping calculation is saved in the database and only happens for the specified delivery country. <br><br>  By default, you can set the delivery method and country of delivery to calculate the cost of the order immediately after adding the product to the cart.  This approach can be used if in a store we get data about a city or region by IP in some way. <br><br><h2>  Your calculation is correct </h2><br><h3>  Module \ Project \ Integration </h3><br>  How to create your module colleagues wrote earlier on Habr√© <a href="https://habrahabr.ru/post/268245/">here</a> . <br>  We will begin to introduce our own recalculation of discounts for order lines, we will remove pennies after calculating discounts. <br><br>  It is convenient when we have all the goods have prices without kopecks, and a penny from the discounts only hinders us (when calculating the VAT). <br><br>  In the <b>Project / Integration / etc / sales.xml file</b> we can add our Total-model, or remove the old / unnecessary weee. <br><br>  sort_order - provides the order of execution, for all Total-models in <b>sales.xml</b> it is also set. <br><br><pre> <code class="xml hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?xml version="1.0"?&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">config</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:xsi</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xsi:noNamespaceSchemaLocation</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"urn:magento:module:Magento_Sales:etc/sales.xsd"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">section</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"quote"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">group</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"totals"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">item</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"integration_total"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">instance</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Project\Integration\Model\Quote\Address\Total\Custom"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">sort_order</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"430"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">item</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"weee"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">instance</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">""</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">item</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"weee_tax"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">instance</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">""</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">group</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">section</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">config</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  <b>sort_order = "430"</b> - declares the calculation of discounts and before the calculation of taxes. <br>  This is the place where it is best to cut a penny from the discount or to make a request to the cart discount calculation system. <br><br>  The implementation of the calculation in <b>\ Project \ Integration \ Model \ Quote \ Address \ Total \ Custom</b> <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">Project</span></span>\<span class="hljs-title"><span class="hljs-title">Integration</span></span>\<span class="hljs-title"><span class="hljs-title">Model</span></span>\<span class="hljs-title"><span class="hljs-title">Quote</span></span>\<span class="hljs-title"><span class="hljs-title">Address</span></span>\<span class="hljs-title"><span class="hljs-title">Total</span></span>; <span class="hljs-comment"><span class="hljs-comment">//    class Custom extends \Magento\Quote\Model\Quote\Address\Total\AbstractTotal { //    ... public function __construct( //      DI ... ) { //     ... } public function collect( \Magento\Quote\Model\Quote $quote, \Magento\Quote\Api\Data\ShippingAssignmentInterface $shippingAssignment, \Magento\Quote\Model\Quote\Address\Total $total ) { $address = $shippingAssignment-&gt;getShipping()-&gt;getAddress(); $quoteItems = $quote-&gt;getAllItems(); //       ,    ,   ,  - if ($total-&gt;getTotalAmount('discount') == 0 || $quote-&gt;getItemsCount() == 0 || !$quote-&gt;getId() || $address-&gt;getAddressType() == 'billing') return $this; //      ,     ... //     $totalDiscount = 0; $baseTotalDiscount = 0; foreach ($quoteItems as $item) { //  ,     $newDiscountAmount = (int)$item-&gt;getDiscountAmount(); $newBaseDiscountAmount = (int)$item-&gt;getBaseDiscountAmount(); //     $totalDiscount += $newDiscountAmount; $baseTotalDiscount += $newBaseDiscountAmount; //    $rowTotal = $item-&gt;getRowTotal() + $item-&gt;getDiscountAmount() - $newDiscountAmount; $baseRowTotal = $item-&gt;getBaseRowTotal() + $item-&gt;getBaseDiscountAmount() - $newBaseDiscountAmount; //    $item-&gt;setDiscountAmount($newDiscountAmount); $item-&gt;setBaseDiscountAmount($newBaseDiscountAmount); //     $item-&gt;setRowTotal($rowTotal); $item-&gt;setBaseRowTotal($baseRowTotal); } //   $total-&gt;setTotalAmount('discount', $totalDiscount); $total-&gt;setBaseTotalAmount('discount', $baseTotalDiscount); $total-&gt;setSubtotalWithDiscount($total-&gt;getSubtotal() + $total-&gt;getDiscountAmount()); $total-&gt;setBaseSubtotalWithDiscount($total-&gt;getBaseSubtotal() + $total-&gt;getBaseDiscountAmount()); return $this; } }</span></span></code> </pre><br>  <b>Instead of ending</b> <br>  Here we successfully threw a penny.  No cents, no problem. <br><br>  If we use additional price modifiers (our special discounts or surcharges, taxes on Internet Explorer), then we need to worry that all calculations are correct in bills and returns, otherwise you will turn into serial programmers who kill accountants.  It is optimal to modify the discount or the base value of the goods to ensure the integrity of the amounts even under the conditions of returns. </div><p>Source: <a href="https://habr.com/ru/post/336934/">https://habr.com/ru/post/336934/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../336920/index.html">SYSTIMAX Structured Cabling Systems - High Performance Innovation Based Infrastructure</a></li>
<li><a href="../336922/index.html">Azure Monitor: features and limitations</a></li>
<li><a href="../336924/index.html">6 fresh examples of parsing and design improvements in simple ways</a></li>
<li><a href="../336928/index.html">"Letters to the Editor"</a></li>
<li><a href="../336932/index.html">Spectroscope-kaleidoscope</a></li>
<li><a href="../336936/index.html">IoT and 5G</a></li>
<li><a href="../336938/index.html">As a star of Brazilian TV shows, she accidentally helped open an IT company in Russia</a></li>
<li><a href="../336940/index.html">Transition to date-oriented design</a></li>
<li><a href="../336942/index.html">Vertex Wireless VW210: a rare router and its inner world</a></li>
<li><a href="../336944/index.html">Overview of one Russian RTOS, part 3. Structure of the simplest program</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>