<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Recovering virtualized Active Directory deleted objects from tombstone objects</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="We continue to publish articles on backup and recovery after virtualized Active Directory failures. The previous article dealt with restoring the enti...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Recovering virtualized Active Directory deleted objects from tombstone objects</h1><div class="post__text post__text-html js-mediator-article"><p>  We continue to publish articles on backup and recovery after virtualized Active Directory failures.  The <a href="https://habrahabr.ru/company/veeam/blog/313570/">previous article</a> dealt with restoring the entire domain controller.  However, system administrators are much more likely to encounter requests to restore individual Active Directory objects.  Therefore, today we will consider the restoration of virtualized Active Directory objects from tombstone in systems with forest functional mode not higher than Windows Server 2008. In principle, now they are quite rare, but somewhere they are probably still used somewhere.  Newer systems and features such as Active Directory Recycle Bin will be discussed in the next article. </p><br><p><img src="https://habrastorage.org/files/65b/789/934/65b7899340444d1b88d83b3e51ca5eed.png" alt="image"></p><a name="habracut"></a><br><h2 id="zhiznennyy-cikl-obekta-active-directory">  Active Directory Object Lifecycle </h2><br><p>  So why is it so important to understand how systems of earlier versions function?  Because modern logic and familiar functionality are not applicable in these cases.  Before the advent of Windows Server 2008 R2, the life cycle of Active Directory objects was as follows: </p><br><p><img src="https://www.veeam.com/blog/wp-content/uploads/2016/05/AD-object-lifecycle.png" alt="image"></p><br><p>  Deleting an Active Directory object does not physically delete it ‚Äî this is what happens: </p><br><ol><li>  Active Directory hides the remote object by changing the <strong>isDeleted</strong> attribute <strong>value</strong> to <strong>TRUE</strong> . </li><li>  Then, most object attributes are reset, and the object itself is renamed and moved to a special container (CN = Deleted Objects).  From this point on, the object receives the status of ‚Äútombstone‚Äù, and standard Active Directory tools are not aware of its existence. </li><li>  The object is in this special state for a specified period (60 days in Windows Server 2000/2003 and 180 days in Windows 2003 SP1 / 2008).  This is done to ensure successful replication of data in the system. </li><li>  At the end of the allotted time of existence in the ‚Äútombstone‚Äù state, a special process is called (the so-called <em>garbage collector</em> ), which physically removes the object from the database. </li></ol><br><p>  And here the question arises: if the "tombstone" object is not physically deleted for some time, is it possible to restore it?  In short - you can.  Although such a mechanism for deleting objects was not intended for use as a temporary recycle bin, and deleted objects were not supposed to be restored, it is technically possible.  Further I will tell how it can be made. </p><br><h2 id="vosstanovlenie-obektov-active-directory-s-pomoschyu-utility-ldp">  Restore Active Directory objects using the LDP utility </h2><br><p>  LDP ( <strong>LDP.exe</strong> ) ‚Äîa time-tested program created by Active Directory developers.  It looks pretty simple, but it has many features that allow you to fully manage Active Directory objects.  Its disadvantage is that it takes a lot of time to master the functionality of the program, and the interface is not very modern and clear. <br>  <em>Note: This article is not a complete LDP guide.</em>  <em>To learn how to work with the program, I recommend using <a href="https://technet.microsoft.com/en-us/library/2007.09.tombstones.aspx">the LDP manual</a> .</em> </p><br><p>  So, to restore the ‚Äútombstone‚Äù object using LDP, you need to do the following: </p><br><ol><li>  Run the program ( <strong>Start - Run - ldp</strong> ) </li><li>  Connect it to a domain controller ( <strong>Connection - Connect ..</strong> ).  Use to connect the data of the corresponding account (administrator of the enterprise or domain).  ( <strong>Connection - Bind ..</strong> ) </li><li>  Find the desired object in the container of deleted objects.  You will need to learn how to use different search and filter settings ( <strong>Browse - Search</strong> ). </li><li>  In the ‚Äú <strong>Controls</strong> ‚Äù dialog box, select the ‚Äú <strong>return deleted objects</strong> ‚Äù option and click the ‚Äú <strong>check in</strong> ‚Äù button to add an object identifier for this option to the <strong>Active Control</strong> list. </li><li>  Then save the settings and run the query to find the deleted object. </li><li>  Restore the ‚Äútombstone‚Äù object using a wizard ( <strong>Browse - Modify</strong> ) to find the object by the <strong>distinguishedName</strong> parameter (DN) and remove the <strong>isDeleted</strong> value while renaming the object. </li><li>  As a result, the object will be restored, and it can be seen through the tool for viewing users and computers in Active Directory. </li></ol><br><p>  The figure below shows a typical search example that I performed to find tombstone objects in my test domain: </p><br><p><img src="https://www.veeam.com/blog/wp-content/uploads/2016/05/Searching-tombstones-with-LDP.png" alt="image"></p><br><p>  <strong>In addition to the above, some features of such restoration of tombstone objects should be remembered.</strong>  <strong>For example, some attributes (for example, group membership) that were deleted during the initial deletion will not be restored, which could potentially cause you problems.</strong> </p><br><h2 id="ispolzovanie-veeam-explorer-dlya-microsoft-active-directory">  Using Veeam Explorer <em>for Microsoft Active Directory</em> </h2><br><p>  As an alternative, you can use Veeam solutions, in particular, <a href="https://www.veeam.com/ru/microsoft-active-directory-explorer.html">Veeam Explorer <em>for Active Directory</em></a> .  This program will allow you to perform recovery much easier and faster.  In doing so, it solves many of the problems of recovering tombstone objects ‚Äî for example, losing the account password and many important attributes, such as the user's first and last name.  However, this recovery option is not suitable for all scenarios - you first need to conduct preliminary training.  Namely: to use Veeam Explorer <em>for Active Directory</em> , you must have a backup copy of the domain controller where the object was deleted.  Today we are considering a virtualized controller whose backup was created using Veeam Backup &amp; Replication. </p><br><p>  So, if you are lucky enough to be the administrator of a virtual domain controller with the functional mode of a Windows Server 2003 or Windows Server 2008 domain forest, you can use the following procedure: </p><br><ol><li>  Make sure that you have a backup copy of the domain controller and that when it was created, data processing was taken into account taking into account the state of the applications (why this is important, mentioned in the <a href="https://habrahabr.ru/company/veeam/blog/309904/">first article of the</a> series) - that is, the option <strong>Guest Processing&gt; Enable</strong> was selected for the backup task <strong>application-aware processing</strong> . </li></ol><br><p><img src="https://www.veeam.com/blog/wp-content/uploads/2016/05/VBR-Editing-Backup-Job.png" alt="image"></p><br><ol><li>  If you need to restore a deleted object, go to the backup of the domain controller, right-click and select <strong>Restore application items&gt; Microsoft Active Directory objects ...</strong> ( <strong>Microsoft Active Directory objects</strong> ) to start the recovery and run Veeam Explorer <em>for Active Directory</em> . </li></ol><br><p><img src="https://www.veeam.com/blog/wp-content/uploads/2016/05/VEAD.png" alt="image"></p><br><ol><li>  Find the container you need and turn on the <strong>Compare all objects</strong> and <strong>Show changed objects only</strong> options.  This will set up pre-filtering: Veeam Explorer compares the data in the backup with the current DC state and displays only the changed objects.  View the status of objects and find those with which it is designated as <em>Tombstone</em> . </li></ol><br><p><img src="https://www.veeam.com/blog/wp-content/uploads/2016/05/VEAD-objects-comparison.png" alt="image"></p><br><ol><li>  The desired object (s) can be restored to the work environment or exported as an .lde file. </li></ol><br><p><img src="https://www.veeam.com/blog/wp-content/uploads/2016/05/VEAD-granular-restore.png" alt="image"></p><br><ol><li>  When restoring a user account at one of the steps in the wizard, you will be prompted to specify the <strong>password restore options</strong> .  You can choose from the following options: </li></ol><br><ul><li>  restore account with old password ( <strong>Restore password</strong> ) </li><li>  set a new password manually </li><li>  do a restore without a password ( <strong>Do not restore password</strong> ) </li></ul><br><p>  <strong>Restoring the old password will reduce the burden on the administrator and make the account recovery process completely invisible to the user.</strong>  <strong>Imagine that at night, as a result of a failure, an entire unit (OU) with hundreds of users disappeared, and it needs to be restored.</strong>  <strong>In the morning, upon entering the system, all employees will be asked to change their password, and they, of course, will start asking questions.</strong>  <strong>Naturally, if possible, it is better to avoid such a situation.</strong> <strong><br></strong> </p><br><p><img src="https://helpcenter.veeam.com/backup/explorers/images/vead_restore_obj_3.png" alt="image"></p><br><p>  Given the above, it is clear that Veeam Explorer <em>for Microsoft Active Directory</em> offers a relatively simple way to restore tombstone objects to Active Directory.  If you are working in a suitable system, I recommend to pay attention to this product. </p><br><p>  For today, perhaps, everything.  In the next article in this series, we will compare the capabilities of the Active Directory recycle bin with other ways to restore objects. </p><br><h2 id="poleznye-ssylki">  Useful links: </h2><br><ul><li>  <a href="https://habrahabr.ru/company/veeam/blog/309904/">An article on Habr√© about backing up domain controllers using Veeam</a> </li><li>  <a href="https://habrahabr.ru/company/veeam/blog/313570/">Article on Habr√© about restoring a domain controller from a backup using Veeam</a> </li><li>  <a href="https://habrahabr.ru/company/veeam/blog/281050/">Veeam Endpoint Backup FREE 1.5 Review</a> </li><li>  <a href="https://technet.microsoft.com/en-us/library/2007.09.tombstones.aspx">Microsoft TechNet Magazine article on working with LDP</a> (in English) </li></ul></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/317174/">https://habr.com/ru/post/317174/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../317162/index.html">Magento 2: ObjectManager and Proxy Classes</a></li>
<li><a href="../317164/index.html">How to pay programmers less</a></li>
<li><a href="../317166/index.html">Working with JSON in SQL Server 2016</a></li>
<li><a href="../317170/index.html">How the company is headed by a general director-programmer - opinions and experience of experts</a></li>
<li><a href="../317172/index.html">Inkscape: the beginning (translation)</a></li>
<li><a href="../317176/index.html">Where is the Internet of Things going?</a></li>
<li><a href="../317178/index.html">Why not write bots for Skype</a></li>
<li><a href="../317180/index.html">About C language and performance</a></li>
<li><a href="../317182/index.html">Remote logging in journald or Still ‚Äúyou don't need this‚Äù?</a></li>
<li><a href="../317184/index.html">Why to achieve the goal is enough notebook</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>