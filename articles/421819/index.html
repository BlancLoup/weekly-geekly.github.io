<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ELK Stack for storing Django application logs</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Each of the projects that outgrows the prototype stage needs logging organization. Competent logging solves a lot of problems and helps to understand ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>ELK Stack for storing Django application logs</h1><div class="post__text post__text-html js-mediator-article"><p>  Each of the projects that outgrows the prototype stage needs logging organization.  Competent logging solves a lot of problems and helps to understand the status of the project.  At the initial stage, logging to the file suited me until the project grew and the search for logs did not begin to take time. </p><br><p>  The solution was to create a centralized repository log with log aggregation and search.  The choice fell on the ELK stack.  ELK is a combination of three OpenSource projects: ElasticSearch, Logstash and Kibana.  ELK stores logs, builds graphs and there is support for full-text search with filters.  This article describes the process of configuring the ELK stack for storing Django application logs. <a name="habracut"></a></p><br><h2 id="ustanovka-elk">  ELK installation </h2><br><p>  Docker will be used to install the ELK stack, the <a href="https://github.com/deviantony/docker-elk">docker-elk</a> repository is used as the basis.  Change the Logstash setting, add the GROK pattern for the nginx logging match and change the output section so that the Django application logs and the nginx logs are saved in different ElasticSearch indexes.  As a result, logstash.conf looks like this: </p><br><pre><code class="hljs haskell"><span class="hljs-title"><span class="hljs-title">input</span></span> { beats { port =&gt; <span class="hljs-number"><span class="hljs-number">5000</span></span> host =&gt; <span class="hljs-string"><span class="hljs-string">"0.0.0.0"</span></span> } } filter { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class">] == "nginx" { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">grok</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">match</span></span></span><span class="hljs-class"> =&gt; { "</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">message</span></span></span><span class="hljs-class">" =&gt; "%{</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">IPORHOST</span></span></span><span class="hljs-class">:</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">remote_ip</span></span></span><span class="hljs-class">} - %{</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DATA</span></span></span><span class="hljs-class">:</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">user_name</span></span></span><span class="hljs-class">} \[%{</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HTTPDATE</span></span></span><span class="hljs-class">:</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">access_time</span></span></span><span class="hljs-class">}\] \"%{</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">WORD</span></span></span><span class="hljs-class">:</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">http_method</span></span></span><span class="hljs-class">} %{</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DATA</span></span></span><span class="hljs-class">:</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">url</span></span></span><span class="hljs-class">} </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HTTP</span></span></span><span class="hljs-class">/%{</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NUMBER</span></span></span><span class="hljs-class">:</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">http_version</span></span></span><span class="hljs-class">}\" %{</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NUMBER</span></span></span><span class="hljs-class">:</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">response_code</span></span></span><span class="hljs-class">} %{</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NUMBER</span></span></span><span class="hljs-class">:</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">body_sent_bytes</span></span></span><span class="hljs-class">} \"%{</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DATA</span></span></span><span class="hljs-class">:</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">referrer</span></span></span><span class="hljs-class">}\" \"%{</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DATA</span></span></span><span class="hljs-class">:</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">agent</span></span></span><span class="hljs-class">}\"" } } } } output { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> [</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">type</span></span></span><span class="hljs-class">] == "</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nginx</span></span></span><span class="hljs-class">" { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">elasticsearch</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hosts</span></span></span><span class="hljs-class"> =&gt; "</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">elasticsearch</span></span></span><span class="hljs-class">:9200" </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">index</span></span></span><span class="hljs-class"> =&gt; "</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nginx</span></span></span><span class="hljs-class">-%{+</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">YYYY</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MM</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dd</span></span></span><span class="hljs-class">}" } } else if [</span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class">] == "django" { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">elasticsearch</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hosts</span></span></span><span class="hljs-class"> =&gt; "</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">elasticsearch</span></span></span><span class="hljs-class">:9200" </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">index</span></span></span><span class="hljs-class"> =&gt; "</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">django</span></span></span><span class="hljs-class">-%{+</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">YYYY</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MM</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dd</span></span></span><span class="hljs-class">}" } } else { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">elasticsearch</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hosts</span></span></span><span class="hljs-class"> =&gt; "</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">elasticsearch</span></span></span><span class="hljs-class">:9200" </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">index</span></span></span><span class="hljs-class"> =&gt; "</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">unknown_messages</span></span></span><span class="hljs-class">" } } }</span></span></code> </pre> <br><p>  After making changes, run the stack: </p><br><pre> <code class="hljs">docker-compose up</code> </pre> <br><p>  After startup, the stack listens to the following ports: </p><br><ul><li>  5000: Logstash TCP input. </li><li>  9200: Elasticsearch HTTP </li><li>  9300: Elasticsearch TCP transport </li><li>  5601: Kibana </li></ul><br><h2 id="arhitektura-logirovaniya">  Logging architecture </h2><br><p>  Consider the architecture of logging Django application. </p><br><p><img src="https://habrastorage.org/webt/3u/sd/-i/3usd-ipwvef2bdmnh_nqhozsdv4.png" alt="image"></p><br><p>  As can be seen from the diagram, the application consists of the following services: nginx, django application, celery worker.  Each of the services sent logs to the ELK stack.  Consider setting up each service separately. </p><br><h2 id="zapis-nginx-logov-v-elk">  Write Nginx logs to ELK </h2><br><p>  To work with nginx logs, you need an additional Filebeat service.  The installation process of Filebeat is described in detail on the <a href="https://www.elastic.co/guide/en/beats/filebeat/current/filebeat-installation.html">official website</a> .  An example of installing a Filebeat service on an Ubuntu server: </p><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">curl</span></span> -L -O https://artifacts.elastic.co/downloads/beats/filebeat/filebeat-6.4.0-amd64.deb sudo dpkg -i filebeat-<span class="hljs-number"><span class="hljs-number">6</span></span>.<span class="hljs-number"><span class="hljs-number">4</span></span>.<span class="hljs-number"><span class="hljs-number">0</span></span>-amd64.deb</code> </pre> <br><p>  Filebeat will read logs from a file and send to Logstash.  Configuration example: </p><br><pre> <code class="hljs pgsql">filebeat.inputs: - <span class="hljs-keyword"><span class="hljs-keyword">type</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">log</span></span> enabled: <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> paths: - /var/<span class="hljs-keyword"><span class="hljs-keyword">log</span></span>/nginx/<span class="hljs-keyword"><span class="hljs-keyword">access</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">log</span></span> fields: <span class="hljs-keyword"><span class="hljs-keyword">type</span></span>: nginx fields_under_root: <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> scan_frequency: <span class="hljs-number"><span class="hljs-number">5</span></span>s output.logstash: hosts: ["logstash:5000"]</code> </pre> <br><p>  We start our Filebeat service and watch for the appearance of logs in Kibana. </p><br><h2 id="zapis-django-logov-v-elk">  Write Django logs to ELK </h2><br><p>  For Django to interact with the Logstash service, install the optional <a href="https://pypi.org/project/python-logstash/">Python-logstash package</a> . </p><br><pre> <code class="hljs sql">pip <span class="hljs-keyword"><span class="hljs-keyword">install</span></span> python-logstash</code> </pre> <br><p>  Change the Django application settings so that the logs are sent to the Logstash service. </p><br><pre> <code class="hljs scala"><span class="hljs-type"><span class="hljs-type">LOGGING</span></span> = { <span class="hljs-symbol"><span class="hljs-symbol">'versio</span></span>n': <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">'disable_existing_logger</span></span>s': <span class="hljs-type"><span class="hljs-type">False</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">'formatter</span></span>s': { <span class="hljs-symbol"><span class="hljs-symbol">'simpl</span></span>e': { <span class="hljs-symbol"><span class="hljs-symbol">'forma</span></span>t': <span class="hljs-symbol"><span class="hljs-symbol">'velname</span></span>)s %(message)s' }, }, <span class="hljs-symbol"><span class="hljs-symbol">'handler</span></span>s': { <span class="hljs-symbol"><span class="hljs-symbol">'consol</span></span>e': { <span class="hljs-symbol"><span class="hljs-symbol">'leve</span></span>l': <span class="hljs-symbol"><span class="hljs-symbol">'INF</span></span>O', <span class="hljs-symbol"><span class="hljs-symbol">'clas</span></span>s': <span class="hljs-symbol"><span class="hljs-symbol">'logging</span></span>.<span class="hljs-type"><span class="hljs-type">StreamHandler</span></span>', <span class="hljs-symbol"><span class="hljs-symbol">'formatte</span></span>r': <span class="hljs-symbol"><span class="hljs-symbol">'simpl</span></span>e' }, <span class="hljs-symbol"><span class="hljs-symbol">'logstas</span></span>h': { <span class="hljs-symbol"><span class="hljs-symbol">'leve</span></span>l': <span class="hljs-symbol"><span class="hljs-symbol">'INF</span></span>O', <span class="hljs-symbol"><span class="hljs-symbol">'clas</span></span>s': <span class="hljs-symbol"><span class="hljs-symbol">'logstash</span></span>.<span class="hljs-type"><span class="hljs-type">TCPLogstashHandler</span></span>', <span class="hljs-symbol"><span class="hljs-symbol">'hos</span></span>t': <span class="hljs-symbol"><span class="hljs-symbol">'logstas</span></span>h', <span class="hljs-symbol"><span class="hljs-symbol">'por</span></span>t': <span class="hljs-number"><span class="hljs-number">5000</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">'versio</span></span>n': <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">'message_typ</span></span>e': <span class="hljs-symbol"><span class="hljs-symbol">'djang</span></span>o', # <span class="hljs-symbol"><span class="hljs-symbol">'typ</span></span>e'   logstash . <span class="hljs-symbol"><span class="hljs-symbol">'fqd</span></span>n': <span class="hljs-type"><span class="hljs-type">False</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">'tag</span></span>s': [<span class="hljs-symbol"><span class="hljs-symbol">'djang</span></span>o'], #  . }, }, <span class="hljs-symbol"><span class="hljs-symbol">'logger</span></span>s': { <span class="hljs-symbol"><span class="hljs-symbol">'django</span></span>.request': { <span class="hljs-symbol"><span class="hljs-symbol">'handler</span></span>s': [<span class="hljs-symbol"><span class="hljs-symbol">'logstas</span></span>h'], <span class="hljs-symbol"><span class="hljs-symbol">'leve</span></span>l': <span class="hljs-symbol"><span class="hljs-symbol">'INF</span></span>O', <span class="hljs-symbol"><span class="hljs-symbol">'propagat</span></span>e': <span class="hljs-type"><span class="hljs-type">True</span></span>, }, ... } }</code> </pre> <br><p>  After that, the application will send logs to Logstash.  Usage example: </p><br><pre> <code class="hljs python"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> logging logger = logging.getLogger(__name__) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test_view</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(request, arg1, arg)</span></span></span><span class="hljs-function">:</span></span> ... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> is_error: <span class="hljs-comment"><span class="hljs-comment">#    logger.error('Something went wrong!')</span></span></code> </pre> <br><p>  After that, customize Kibana to display the necessary information.  Sample screenshots of your own settings: </p><br><p><img src="https://habrastorage.org/webt/13/by/h7/13byh7fdbinasgnqkjp5xzs4poe.png" alt="image"><br><img src="https://habrastorage.org/webt/dm/ri/wt/dmriwt3i7hsxtwmtrkyyf9e0inm.png" alt="image"><br><img src="https://habrastorage.org/webt/9h/1q/8f/9h1q8fodu60xzmhv31zsumj-pfy.png" alt="image"></p><br><p>  The system collects logs of services, allows you to conveniently search for them, build graphs and visualizations, allowing you to detect and fix problems as soon as possible. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/421819/">https://habr.com/ru/post/421819/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../421807/index.html">Take part in the public testing of the service of Positive Technologies for finding vulnerabilities on websites</a></li>
<li><a href="../421809/index.html">Java EE Concurrency API</a></li>
<li><a href="../421811/index.html">IETF proposed a new standard for messaging - what you need to know</a></li>
<li><a href="../421815/index.html">Liquid metal in the laptop six months later</a></li>
<li><a href="../421817/index.html">Working with forms in React.js using basic tools</a></li>
<li><a href="../421821/index.html">We apply Voronoi mosaic, pixelation and geometric masks in shaders to decorate the site</a></li>
<li><a href="../421823/index.html">As we in x-ray x64 delivered</a></li>
<li><a href="../421827/index.html">What to read about Java right now?</a></li>
<li><a href="../421829/index.html">Anomaly Frango - a fantastic novel with real people from IT</a></li>
<li><a href="../421833/index.html">We write our simplest program for ARM Cortex-M3</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>