<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Segmentation of text lines of documents into characters using convolutional and recurrent neural networks</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="String segmentation into characters is one of the most important stages in the process of optical character recognition (OCR), in particular, in optic...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Segmentation of text lines of documents into characters using convolutional and recurrent neural networks</h1><div class="post__text post__text-html js-mediator-article">  String segmentation into characters is one of the most important stages in the process of optical character recognition (OCR), in particular, in optical recognition of document images.  Line segmentation is the decomposition of an image containing a sequence of characters into fragments containing individual characters. <br><br>  The importance of segmentation is due to the fact that the basis of most modern OCR systems are classifiers (including neural network) of individual characters, and not words or text fragments.  In such systems, errors of incorrect insertion of cuts between characters are usually the cause of the lion's share of final recognition errors. <br><br>  The search for character boundaries is complicated due to printing artifacts and digitization (scanning) of a document, resulting in ‚Äúspilling‚Äù and ‚Äúgluing‚Äù characters.  In the case of using stationary or mobile small-sized video cameras, the spectrum of digitization artifacts is significantly replenished: defocusing and blurring, projective distortions, deformation and bending of the document are possible.  When shooting a camera in natural scenes on images often appear parasitic differences in brightness (shadows, reflections), as well as color distortion and digital noise as a result of low light.  The figure below shows examples of complex cases in the segmentation of the fields of the RF passport. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/files/f35/6b6/46c/f356b646c0ba460eb600ec5bb3fec842.jpg" height="70" width="350"><img src="https://habrastorage.org/files/b88/5a6/59d/b885a659dd5c4108878619e985f67769.jpg" height="70" width="350"><br><img src="https://habrastorage.org/files/a39/971/46a/a3997146a5c64213b4abd26d0eaf2c3b.jpg" height="70" width="350"><img src="https://habrastorage.org/files/c03/f5f/6bc/c03f5f6bc33b4f40821e3ed48cf28056.jpg" height="70" width="350"><br><img src="https://habrastorage.org/files/5a4/906/ea3/5a4906ea3edd4969bef564ca9a01738c.jpg" height="70" width="350"><img src="https://habrastorage.org/files/25d/414/ea5/25d414ea58a14e3b8b8437c03aa58df6.jpg" height="70" width="350"><br><br>  In this article we will talk about the method of character string segmentation of text lines of documents developed by us in <a href="http://smartengines.ru/">Smart Engines</a> , based on the training of convolutional and recurrent neural networks.  The main document considered in the work is the <a href="https://habrahabr.ru/company/smartengines/blog/252703/">passport of the Russian Federation</a> . <br><a name="habracut"></a><br><h2>  "End-to-end" segmentation using machine learning methods </h2><br>  Machine learning methods are widely used in modern segmentation algorithms.  However, their use is usually combined with additional algorithms, such as the generation of primary cuts for the learning model of character recognition, or dynamic programming on the output estimates of this model. <br><br>  Of interest is the development of a segmentation algorithm that uses machine learning methods to analyze the image of a line with little or no additional preliminary and post-processing (end-to-end).  Such approaches are distinguished by the fact that they do not require fine manual adjustments for a specific case (font, field type, document type), but rather representative, marked-up training samples of a sufficiently large size.  This makes it possible to simplify and accelerate the creation of segmentation algorithms for new types of document fields, as well as to improve the accuracy and resistance to various distortions arising during the shooting. <br><br><h2>  Quality assessment of segmentation methods </h2><br>  When developing segmentation methods, as well as when developing any algorithms, it is required to fix a way to assess the quality of their work.  It is highly desirable that this method allows the developed method to be compared with other algorithms.  We describe the quality indicators used in this work to evaluate the methods of segmentation of the fields of the RF passport. <br><br>  The purpose of segmentation of the text into symbols is its subsequent recognition, which determines the popularity of using the quality of the final recognition as an assessment of the quality of the segmentation algorithm.  The evaluation of the quality of the recognition algorithm can be either the accuracy of recognition of individual characters or words, or the average Levenshtein distance.  The quality indicators of the RF Passport Recognition System in this work put the accuracy of the full recognition of each of the document fields (name, surname, place of birth, etc.) accurate to the character due to the high cost of a single error in a single field - an error even in one The identity field symbol is critical. <br><br>  However, in the case of assessing the quality of segmentation through the quality of recognition, the dependence of the estimates on the specific recognition model arises.  This is a problem when developing an integrated system, since the interchangeability of various segmentation algorithms and recognition algorithms is lost.  Therefore, the development used additional quality metrics based only on the analysis of the immediate boundaries between the symbols exposed by segmentation algorithms, such as accuracy, completeness, and F1-measure.  This becomes possible if there is a ‚Äúperfect‚Äù markup not only of characters in the fields, but also of cuts between them, prepared by people, which was prepared in this work, but not always available. <br><br><h2>  Preparation and artificial expansion of the training sample </h2><br>  The training set contains images of selected fields of the RF passport, cut off along the base lines of the text, with marked positions of ideal cuts between the characters.  The marking can be carried out both completely manually and semi-automatically - the existing segmentation algorithm inserts cuts, which are subsequently checked and, if necessary, adjusted by people. <br><br>  Preparation of a sample of passports of the Russian Federation and its marking is an expensive operation, and not only because of the large amount of manual work.  Identity documents contain personal information, the turnover of which is regulated by law, which is why open access to databases containing a large number of images of RF passports is not possible.  Note that the creation of a fully artificial sample is also difficult due to the lack of open specifications of the background security elements of the RF passport, such as guilloche, holograms, etc. <br><br>  Thus, it is problematic to draw a sample of sufficient volume for training a high precision approximator that is resistant to shooting conditions and field guidance errors.  In order to increase stability, <a href="https://habrahabr.ru/company/smartengines/blog/264677/">artificial expansion (augmentation) of a</a> training sample using data transformation is used.  Each sample is synthesized by applying a random set of transformations that simulate the transformation of a real field image. <br><br>  To expand the training sample of RF passport fields, the following were applied: adding Gaussian noise distortion, projective distortion to simulate non-ideal finding of document boundaries in mobile shooting conditions and Gaussian blur for defocus modeling, stretching characters in height and width (these character parameters can differ greatly in passports from different regions), and vertical and horizontal shifts (the errors of the real field guidance system are modeled).  Additional sampling extension methods were also used: letter shuffling and specular reflections, which is not found in natural conditions, but experiments have shown an increase in accuracy with the use of such an extension.  The following are illustrations of the transformations described. <br><table><tbody><tr><th>  Transformation </th><th>  Illustration </th></tr><tr><td>  Original image </td><td><img src="https://habrastorage.org/files/09e/c51/3bb/09ec513bbe75453b9c3c148d9de33f2e.png"></td></tr><tr><td>  Gaussian noise </td><td><img src="https://habrastorage.org/files/ad8/75d/679/ad875d6790db40419fcd59f63fd7a152.png"></td></tr><tr><td>  Projective distortion </td><td><img src="https://habrastorage.org/files/f63/30c/317/f6330c3171e14e64be4101a5560f7188.png"></td></tr><tr><td>  Gaussian blur </td><td><img src="https://habrastorage.org/files/064/81e/912/06481e912cfb43dba5794bc9d0ef2d5a.png"></td></tr><tr><td>  Shifts </td><td><img src="https://habrastorage.org/files/1b4/a72/1bc/1b4a721bc9e643fa8f2236dddb9006fe.png"></td></tr><tr><td>  Letter shuffle </td><td><img src="https://habrastorage.org/files/6b0/715/8af/6b07158afe1f40a98d9ea523dac5825d.png"></td></tr><tr><td>  Reflections </td><td><img src="https://habrastorage.org/files/c34/cce/832/c34cce8325794184b3e6d612bd489ff7.png"></td></tr><tr><td>  Stretching </td><td><img src="https://habrastorage.org/files/a81/126/d62/a81126d627be4fdc8023bb6daa1a3c33.png"></td></tr><tr><td>  Transformation Combination </td><td><img src="https://habrastorage.org/files/3e1/94a/8b0/3e194a8b0f904e4ca01019e9fdc2f03c.png"></td></tr></tbody></table><br><h2>  Layout layout and output network vectors </h2><br>  Regardless of the type of universal approximator used, for its training and operation, it is necessary to determine the loss function (error), which will be minimized on the training set at the training stage of the model parameters. <br><br>  Standard deviation (MSD) is a classical loss function that satisfies the requirements for continuity and differentiability.  The final answers of the segmentation algorithm are a list of the positions of the cuts, therefore, theoretically, it would be possible to adapt the standard deviation (RMS) between the corresponding output cuts and the ‚Äúideal‚Äù ones as the average distance between them.  Unfortunately, in the naive implementation of this approach leads to a problem, especially when using a neural network. <br><br>  The number of cuts between characters, as well as the number of characters themselves, is not fixed and the segmentation algorithm does not know in advance how many cuts are required to be stamped.  Then, in the case of the coincidence of the number of cuts in the markup and at the output of the segmentation algorithm, the error function through distance fits us.  However, with a different number of cuts, the problem of counting losses for missing or excessive cuts arises, especially in the presence of reasonable requirements for the loss function.  In addition, the number of outputs of the neural network is fixed within a single architecture and the support of a dynamic number of outputs requires an unnecessary complication and entanglement of the model. <br><br>  Thus, such markup and network output formats are required which support the setting of any allowable number of cuts, while their corresponding loss function remains usable in the training of the neural network by gradient methods.  It is proposed to use the following model: instead of the list of coordinates of the sections we will consider real probabilistic estimates of the location of the section in each of the columns of image pixels.  The marking of the cuts will then look like this: zeros in all positions, except for the positions of the cuts in which there are ones.  The standard deviation in this case is also suitable as a function of the loss, but is already calculated between the probability estimation vectors.  The final positions of the cuts at the output of the algorithm are obtained by transforming the output probability estimates, which will be described in detail later. <br><br>  Small fluctuations regarding cuts from the markup usually do not strongly affect the quality of recognition, especially if the segmentation algorithm places the cuts not directly on the character boundaries (so that there are two cuts between two characters), but in the middle area (there is one cut between the characters).  The loss function proposed above in this case will equally penalize the output probabilities at positions that do not correspond to ideal cuts, regardless of their distance.  Therefore, to mitigate the fine with small fluctuations in the output of the network, it is proposed to use a Gaussian markup blur with a radius proportional to the average width of the character in this image from the test set. <br><br><h2>  Segmentation using convolutional neural networks </h2><br>  One of the most popular neural network architectures in image analysis tasks is the deep convolutional network architecture, which was chosen for the first substantial experiments in creating our segmented student method.  The classical model of a convolutional network consists of several convolutional layers that make up feature maps by applying a convolution operation to a trained core, alternating with sub-sampling (max pooling) in order to reduce the dimension of the feature map.  The last layers (ending with the output layer) have a fully connected architecture. <br><br>  For neural networks used in the work, the input data (feature vectors) are half-tone raster images of RF passport fields, reduced to a fixed width and height, for example, 200x20 pixels.  The size of the output layer, which returns probabilistic estimates of the presence of a cut in the image columns, respectively, is also fixed and is 200 pixels.  The following is a diagram of the convolutional neural network used in the work. <br><br><img src="https://habrastorage.org/files/01a/0c2/0ac/01a0c20acc764a33a791fad48b79f6ed.png"><br><br>  The hidden part of the neural network consists of convolutional layers, followed by two fully connected layers.  Each convolutional layer is followed by a downsampling layer.  The hyperbolic tangent was used as activation functions.  During the training, a technique of random selective zeroing of the activation functions (dropout) of hidden layers was used. <br><br><h2>  Additional segmentation using recurrent neural LSTM networks </h2><br>  In order to increase the accuracy of the trained segmentation network of the described architecture, the method of post-processing the outputs of the convolutional network was applied by submitting them to the input of an additional two-way recurrent network. <br><br>  Recurrent neural networks are designed specifically for working with sequences: besides the next element of the sequence, they take their own hidden state as input.  Recurrent neural networks of the long short-term memory architecture (LSTM, Long Short-Term Memory) have been used in the work, which have proven themselves in a large number of applications of sequence analysis, such as recognition of printed and handwritten text, speech, and others.  LSTM architecture networks are able to ‚Äúmemorize‚Äù the structure of a sequence;  in the case of line segmentation, the structure can be understood, for example, the average width of characters in a line and the distance between them. <br><br>  The two-way recurrent LSTM network used accepts a sequence composed by applying a fixed-size sliding window (for example, 10) to the output vector of probability estimates of a convolutional network.  Thus, the i position of the input vector of the recurrent network contains the last 10 outputs of the convolutional network.  The bilateral orientation of the network consists in the creation of two one-way networks, one of which processes the sequence from left to right, and the other from right to left.  Then, the output vectors of both networks, corresponding to the same positions of the original sequence, are concatenated and transmitted to the input to the fully connected layer, followed by the final layer, returning the same final probabilistic estimates.  It is important to note that the outputs of the convolutional network, on which recurrent training is conducted, are calculated in advance, so the convolutional network does not change when training is recurrent, which greatly speeds up training.  The figure below contains the scheme of the used architecture of the recurrent network at the outputs of the convolutional network. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/5d5/7c3/64a/5d57c364ad4943b4b586dcd4979d798a.png"></div><br>  After adding a recurrent network at the outputs of the convolutional network, the overall final recognition quality improved significantly, which will be shown in the table at the end of the article.  The activation function in the LSTM network was also a hyperbolic tangent. <br><br><h2>  Transformation of probability estimates into final cuts </h2><br>  To obtain the final positions of the cuts at the output of the algorithm, it is necessary to perform a conversion of probability estimates.  Simple threshold filtering will not work in this case, since the network‚Äôs output assessments are concentrated in large numbers around the proposed cuts.  Since the neural network approximated the markup subjected to Gaussian blurring around the positions of the cuts, filtering can be a fairly stable and simple way to convert probabilities to cuts, leaving only local maximums of the estimates following the threshold cut with a low threshold.  To eliminate noise positives, additional Gaussian blur is used, which does not change the position of strong maxima. <br><br>  The method of filtering local maxima is simple and showed good results, but we decided to check whether it is possible to completely get rid of the ‚Äúengineering‚Äù approach at the stage of probability conversion.  For the purpose of the experiment, another network of a fully connected architecture with a small number of weights was trained, taking the final probabilistic outputs of the resulting network as input, and returning similar probabilistic estimates at the output.  The difference is that it is trained on the original marks of the cuts, which were not subjected to Gaussian blurring.  Probabilistic estimates at the output of the last network are already subjected to simple threshold filtering without additional processing to obtain the final positions of the cuts.  The following figure shows examples of how the segmentation algorithm described by the student works with the output of intermediate results. <br><br><img src="https://habrastorage.org/files/781/32c/009/78132c00984c43768c3639599d24f168.jpg" height="120" width="350"><img src="https://habrastorage.org/files/488/cd8/f76/488cd8f7634f47499d089b4c8ca963f2.jpg" height="120" width="350"><br><br><img src="https://habrastorage.org/files/77e/397/afe/77e397afe7a14a298d5255592d21749a.jpg" height="120" width="350"><img src="https://habrastorage.org/files/9bf/926/1ce/9bf9261ced9242ee97e431a4c6e74797.jpg" height="120" width="350"><br><br><img src="https://habrastorage.org/files/e14/e21/d74/e14e21d74d644fc48c8dd86016f52089.jpg" height="120" width="350"><img src="https://habrastorage.org/files/714/ea8/a73/714ea8a735a445e69b9eec9c88f2889e.jpg" height="120" width="350"><br><br>  The probabilistic estimates at the outputs of the convolutional network are marked with a red background, and the yellow - following recurrent one.  Green color indicates probabilistic estimates of the recurrent network, filtered by a fixed threshold, and finally, blue shows the remaining cuts ‚Äî filtered estimates that are local maxima. <br><br><h2>  Experiments and Results </h2><br>  The main fields of the passport of the Russian Federation in the experiments were the fields of the last name, first name and patronymic.  The size of the initial training sample was 6000 images, after its expansion with the help of data synthesis - 150,000 images.  The size of the test sample for evaluating segmentation with auxiliary metrics without recognition is 630 images.  The test sample for field recognition contained 1300 images of RF passports, one image of each field on the document. <br><br>  When recognizing fields on the results of segmentation, the same RF passport recognition system was used, which was not changed.  It is important to note that the neural network intended for field recognition was trained on symbols subjected to compression using the classic "engineering" segmentation methods, and the cuts exposed by the trained segmentation algorithm were transmitted without additional processing and compression to the recognition system.  The following table contains the experimental results of the accuracy of the final recognition of the fields (the proportion of fully correctly recognized fields). <br><table><tbody><tr><th>  Segmentation algorithm </th><th>  Surname,% </th><th>  Name% </th><th>  Middle name, % </th></tr><tr><td>  Convolution network </td><td>  68.53 </td><td>  76.00 </td><td>  78.30 </td></tr><tr><td>  Recurrent network at the outputs of the convolution network </td><td>  86.23 </td><td>  90.69 </td><td>  91.38 </td></tr></tbody></table><br>  The table shows that the addition of a recurrent network at the outputs of a convolutional network in the segmentation subsystem greatly improves the accuracy of field recognition.  Note that the process of processing includes finding the boundaries of a passport in natural conditions when shooting from mobile devices, which explains the imperfect recognition accuracy - the most unfavorable sample was chosen from the point of view of distortions arising from the survey, etc. <br><br>  In the experiments with the trained segmentation methods, the implementation of neural networks from the Lasagne package in the Python language was used.  The trained models were further converted into our internal format C ++ libraries of neural networks. <br><br><h2>  Conclusion </h2><br>  The article examined the method of segmentation of printed text fields and conducted its experimental analysis on the example of the segmentation module module of the passport recognition system of a citizen of the Russian Federation.  The method uses machine learning approaches (artificial neural networks) at almost all stages of work, which makes the setup process for new types of fields and documents fully automatic, subject to the availability of a training set, which makes the method promising. <br><br>  As a further study of the segmentation method based on machine learning approaches, it is planned to conduct experiments on other types of fields and documents, analyze and classify errors in order to form new ways to expand the training set, as well as profiling and optimizing the performance of the method on mobile devices, for example, reducing the number of trained parameters.  Also, of interest is the study of methods for the complete recognition of whole words or fields without segmentation using recurrent neural networks. </div><p>Source: <a href="https://habr.com/ru/post/328000/">https://habr.com/ru/post/328000/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../327988/index.html">Free from all shackles: Emercoin version 6.2 has become completely decentralized</a></li>
<li><a href="../327990/index.html">Pentestit Security Conference 2017: reports</a></li>
<li><a href="../327994/index.html">We check the code of the dynamic analyzer Valgrind using a static analyzer</a></li>
<li><a href="../327996/index.html">BK-0010 emulator on FPGA</a></li>
<li><a href="../327998/index.html">Conference Outsource-People 2017, Krakow (day two)</a></li>
<li><a href="../328002/index.html">SimplePage: a simple, declarative framework for rapid prototyping</a></li>
<li><a href="../328004/index.html">Part 3. Where to store data for decentralized applications on the blockchain?</a></li>
<li><a href="../328006/index.html">‚ÄúThe incident with Gitlab is a very good and revealing story‚Äù, - Alexey Lesovsky about PostgreSQL administration</a></li>
<li><a href="../328008/index.html">UAC Bypass or the story of three escalations</a></li>
<li><a href="../328010/index.html">Bildim under stm32duino using CMake (and scavenging from the linker)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>