<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Creating audio plugin, part 11</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="All posts series: 
 Part 1. Introduction and setup 
 Part 2. Learning Code 
 Part 3. VST and AU 
 Part 4. Digital Distortion 
 Part 5. Presets and GUI...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Creating audio plugin, part 11</h1><div class="post__text post__text-html js-mediator-article">  All posts series: <br>  <a href="http://habrahabr.ru/post/224911/">Part 1. Introduction and setup</a> <br>  <a href="http://habrahabr.ru/post/225019/">Part 2. Learning Code</a> <br>  <a href="http://habrahabr.ru/post/225457/">Part 3. VST and AU</a> <br>  <a href="http://habrahabr.ru/post/225751/">Part 4. Digital Distortion</a> <br>  <a href="http://habrahabr.ru/post/225755/">Part 5. Presets and GUI</a> <br>  <a href="http://habrahabr.ru/post/226439/">Part 6. Signal synthesis</a> <br>  <a href="http://habrahabr.ru/post/226573/">Part 7. Receive MIDI Messages</a> <br>  <a href="http://habrahabr.ru/post/226823/">Part 8. Virtual Keyboard</a> <br>  <a href="http://habrahabr.ru/post/227475/">Part 9. Envelopes</a> <br>  <a href="http://habrahabr.ru/post/227601/">Part 10. Refinement GUI</a> <br>  <a href="http://habrahabr.ru/post/227791/">Part 11. Filter</a> <br>  <a href="http://habrahabr.ru/post/227827/">Part 12. Low-frequency oscillator</a> <br>  <a href="http://habrahabr.ru/post/228267/">Part 13. Redesign</a> <br>  <a href="http://habrahabr.ru/post/231513/">Part 14. Polyphony 1</a> <br>  <a href="http://habrahabr.ru/post/231923/">Part 15. Polyphony 2</a> <br>  <a href="http://habrahabr.ru/post/232153/">Part 16. Antialiasing</a> <br><hr><br><br>  Today we will make a resonant filter.  Filter development is a complex area, with many DSP engineers all over the world puzzling over it.  We will not dive into its wilds, but create a simple <i>low-pass filter</i> ( <i>Low-Pass</i> ), <i>band-pass</i> ( <i>Band Pass</i> ) and <i>a high pass filter</i> ( <i>High Pass</i> ) based on <a href="http://www.musicdsp.org/showone.php%3Fid%3D29">the</a> Paul Kellet <a href="http://www.musicdsp.org/showone.php%3Fid%3D29">algorithm</a> . <br><a name="habracut"></a><br>  We begin, as you might guess, with creating a <code>Filter</code> class.  Remove <pre> <code class="hljs erlang-repl"><code class="cpp">#include  <i>Filter.h</i> ( )     : <br> <br> class Filter { public: enum FilterMode { FILTER_MODE_LOWPASS = <span class="hljs-number"><span class="hljs-number">0</span></span>, FILTER_MODE_HIGHPASS, FILTER_MODE_BANDPASS, kNumFilterModes }; Filter() : cutoff(<span class="hljs-number"><span class="hljs-number">0.99</span></span>), resonance(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), mode(FILTER_MODE_LOWPASS), buf0(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), buf1(<span class="hljs-number"><span class="hljs-number">0.0</span></span>) { calculateFeedbackAmount(); }; double process(double inputValue); inline void setCutoff(double newCutoff) { cutoff = newCutoff; calculateFeedbackAmount(); }; inline void setResonance(double newResonance) { resonance = newResonance; calculateFeedbackAmount(); }; inline void setFilterMode(FilterMode newMode) { mode = newMode; } private: double cutoff; double resonance; FilterMode mode; double feedbackAmount; inline void calculateFeedbackAmount() { feedbackAmount = resonance + resonance/(<span class="hljs-number"><span class="hljs-number">1.0</span></span> - cutoff); } double buf0; double buf1; };</code> <br> <br>  <code>private</code>     <i> </i> <code>cutoff</code>  <i></i> <code>resonance</code> . <code>Mode</code>      (Lowpass, Highpass, Bandpass).  <code>feedbackAmount</code> , <code>buf0</code>  <code>buf1</code>    ,    . <br>          ( <code>calculateFeedbackAmount()</code> ).  <code>process</code>      .   <code>feedbackAmount</code>   <code>cutoff</code>  <code>resonance</code> ,    <code>calculateFeedbackAmount</code>      . <br> <br>   <i>Filter.cpp</i>  : <br> <br> <code class="cpp">// By Paul Kellett // http://www.musicdsp.org/showone.php?id=<span class="hljs-number"><span class="hljs-number">29</span></span> double Filter::process(double inputValue) { buf0 += cutoff * (inputValue - buf0); buf1 += cutoff * (buf0 - buf1); switch (mode) { case FILTER_MODE_LOWPASS: return buf1; case FILTER_MODE_HIGHPASS: return inputValue - buf0; case FILTER_MODE_BANDPASS: return buf0 - buf1; default: return <span class="hljs-number"><span class="hljs-number">0.0</span></span>; } }</code> <br> <br> , ?  ,         <i> </i> . ¬´ ¬ª   ,               (. .    <span class="hljs-number"><span class="hljs-number">6</span></span> ).     <code>buf0</code>  <code>buf1</code> :        .     <code>inputValue</code> ,  - <code>buf0</code> (  ).   .    <span class="hljs-number"><span class="hljs-number">6</span></span> /   <span class="hljs-number"><span class="hljs-number">12</span></span> /.  <code>switch</code> ,  <code>buf1</code>    . , ,    <code>buf0</code> ,       <span class="hljs-number"><span class="hljs-number">12</span></span>,   <span class="hljs-number"><span class="hljs-number">6</span></span> /,        . <br> <br>  <code>case</code> <code>FILTER_MODE_HIGHPASS</code>    . <code>buf0</code>       .   <code>inputValue</code>  <code>buf0</code> ,   .    <code>buf1</code> ,     . <br> <br>  <code>case</code> <code>FILTER_MODE_BANDPASS</code> ,  <code>buf0 - buf1</code>   .  <code>buf0</code>       ,     <code>buf1</code> . ,   . <br>  :    <i> </i>    <i> </i> ,   . <br> <br>  <code>buf1</code>     .       <a href="http://ru.wikipedia.org/wiki/%25D0%25A4%25D0%25B8%25D0%25BB%25D1%258C%25D1%2582%25D1%2580_%25D1%2581_%25D0%25B1%25D0%25B5%25D1%2581%25D0%25BA%25D0%25BE%25D0%25BD%25D0%25B5%25D1%2587%25D0%25BD%25D0%25BE%25D0%25B9_%25D0%25B8%25D0%25BC%25D0%25BF%25D1%2583%25D0%25BB%25D1%258C%25D1%2581%25D0%25BD%25D0%25BE%25D0%25B9_%25D1%2585%25D0%25B0%25D1%2580%25D0%25B0%25D0%25BA%25D1%2582%25D0%25B5%25D1%2580%25D0%25B8%25D1%2581%25D1%2582%25D0%25B8%25D0%25BA%25D0%25BE%25D0%25B9">    </a> ( <i>Infinite Impulse Response</i> ,  <i>IIR</i> ).  <a href="http://www.dspguide.com/ch14/1.htm"> </a> ,      .      ,         ,      . <br> <br>   <br>       ,     ,     .   ,  ,      ,  ,          .           ,  NI Massive,   ¬´ <a href="http://lurkmore.to/%25D0%25A2%25D1%2591%25D0%25BF%25D0%25BB%25D1%258B%25D0%25B9_%25D0%25BB%25D0%25B0%25D0%25BC%25D0%25BF%25D0%25BE%25D0%25B2%25D1%258B%25D0%25B9_%25D0%25B7%25D0%25B2%25D1%2583%25D0%25BA">  </a> ¬ª.       ,          ,   .        ,          (  Massive       ).      ¬´¬ª , , , AAS Ultra Analog,       ,     ,    ,        .         ,  ,    <a href="http://www.kvraudio.com/forum/viewtopic.php%3Ft%3D350246"></a> ,   ,      NI Reaktor. ,            ‚Äî    ,    ..     . <br> <br>   <br>     .   GUI.  <i>bg.png</i>   ( <i>‚ÄúMove to trash‚Äù</i>  Xcode),       : <br> <br> <a href="">filtermode.png</a> <a href="">knob_small.png</a> (  ,   <span class="hljs-number"><span class="hljs-number">50</span></span> <span class="hljs-number"><span class="hljs-number">50</span></span> ) <a href="">bg.png</a> (       ) <br> <br>    ID  <i>resource.h</i> : <br> <br> <code class="cpp">// Unique IDs for each image resource. #define BG_ID <span class="hljs-number"><span class="hljs-number">101</span></span> #define WHITE_KEY_ID <span class="hljs-number"><span class="hljs-number">102</span></span> #define BLACK_KEY_ID <span class="hljs-number"><span class="hljs-number">103</span></span> #define WAVEFORM_ID <span class="hljs-number"><span class="hljs-number">104</span></span> #define KNOB_ID <span class="hljs-number"><span class="hljs-number">105</span></span> #define KNOB_SMALL_ID <span class="hljs-number"><span class="hljs-number">106</span></span> #define FILTERMODE_ID <span class="hljs-number"><span class="hljs-number">107</span></span> // Image resource locations for this plug. #define BG_FN <span class="hljs-string"><span class="hljs-string">"resources/img/bg.png"</span></span> #define WHITE_KEY_FN <span class="hljs-string"><span class="hljs-string">"resources/img/whitekey.png"</span></span> #define BLACK_KEY_FN <span class="hljs-string"><span class="hljs-string">"resources/img/blackkey.png"</span></span> #define WAVEFORM_FN <span class="hljs-string"><span class="hljs-string">"resources/img/waveform.png"</span></span> #define KNOB_FN <span class="hljs-string"><span class="hljs-string">"resources/img/knob.png"</span></span> #define KNOB_SMALL_FN <span class="hljs-string"><span class="hljs-string">"resources/img/knob_small.png"</span></span> #define FILTERMODE_FN <span class="hljs-string"><span class="hljs-string">"resources/img/filtermode.png"</span></span></code> <br> <br>  <i>Synthesis.rc</i> : <br> <br> <code class="cpp">#include <span class="hljs-string"><span class="hljs-string">"resource.h"</span></span> BG_ID PNG BG_FN WHITE_KEY_ID PNG WHITE_KEY_FN BLACK_KEY_ID PNG BLACK_KEY_FN WAVEFORM_ID PNG WAVEFORM_FN KNOB_ID PNG KNOB_FN KNOB_SMALL_ID PNG KNOB_SMALL_FN FILTERMODE_ID PNG FILTERMODE_FN</code> <br> <br>   <code>#include <span class="hljs-string"><span class="hljs-string">"Filter.h"</span></span></code>  <i>Synthesis.h</i>    <code>private</code> : <br> <br> <code class="cpp">Filter mFilter;</code> <br> <br>  <code>EParams</code>  <i>Synthesis.cpp</i> : <br> <br> <code class="cpp">enum EParams { mWaveform = <span class="hljs-number"><span class="hljs-number">0</span></span>, mAttack, mDecay, mSustain, mRelease, mFilterMode, mFilterCutoff, mFilterResonance, mFilterAttack, mFilterDecay, mFilterSustain, mFilterRelease, mFilterEnvelopeAmount, kNumParams };</code> <br> <br>        : <br> <br> <code class="cpp">pGraphics-&gt;AttachControl(new ISwitchControl(this, <span class="hljs-number"><span class="hljs-number">24</span></span>, <span class="hljs-number"><span class="hljs-number">38</span></span>, mWaveform, &amp;waveformBitmap));</code> <br> <br>      .      (Lowpass, Highpass, Bandpass).    <code>AttachGraphics(pGraphics)</code> : <br> <br> <code class="cpp">GetParam(mFilterMode)-&gt;InitEnum(<span class="hljs-string"><span class="hljs-string">"Filter Mode"</span></span>, Filter::FILTER_MODE_LOWPASS, Filter::kNumFilterModes); IBitmap filtermodeBitmap = pGraphics-&gt;LoadIBitmap(FILTERMODE_ID, FILTERMODE_FN, <span class="hljs-number"><span class="hljs-number">3</span></span>); pGraphics-&gt;AttachControl(new ISwitchControl(this, <span class="hljs-number"><span class="hljs-number">24</span></span>, <span class="hljs-number"><span class="hljs-number">123</span></span>, mFilterMode, &amp;filtermodeBitmap));</code> <br> <br>         .    .     <i>knob_small.png</i> : <br> <br> <code class="cpp">// Knobs for filter cutoff and resonance IBitmap smallKnobBitmap = pGraphics-&gt;LoadIBitmap(KNOB_SMALL_ID, KNOB_SMALL_FN, <span class="hljs-number"><span class="hljs-number">64</span></span>); // Cutoff knob: GetParam(mFilterCutoff)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Cutoff"</span></span>, <span class="hljs-number"><span class="hljs-number">0.99</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">0.99</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); GetParam(mFilterCutoff)-&gt;SetShape(<span class="hljs-number"><span class="hljs-number">2</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-number"><span class="hljs-number">177</span></span>, mFilterCutoff, &amp;smallKnobBitmap)); // Resonance knob: GetParam(mFilterResonance)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Resonance"</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">61</span></span>, <span class="hljs-number"><span class="hljs-number">177</span></span>, mFilterResonance, &amp;smallKnobBitmap));</code> <br> <br>   ,           <code><span class="hljs-number"><span class="hljs-number">1.0</span></span></code> ,   <code>calculateFeedbackAmount</code>    , . <br>  <code>ProcessDoubleReplacing</code>     : <br> <br> <code class="cpp">leftOutput[i] = rightOutput[i] = mFilter.process(mOscillator.nextSample() * mEnvelopeGenerator.nextSample() * velocity / <span class="hljs-number"><span class="hljs-number">127.0</span></span>);</code> <br> <br>       .  <code>switch</code>   <code>Synthesis::OnParamChange</code> : <br> <br> <code class="cpp">case mFilterCutoff: mFilter.setCutoff(GetParam(paramIdx)-&gt;Value()); break; case mFilterResonance: mFilter.setResonance(GetParam(paramIdx)-&gt;Value()); break; case mFilterMode: mFilter.setFilterMode(static_cast&lt;Filter::FilterMode&gt;(GetParam(paramIdx)-&gt;Int())); break;</code> <br> <br>    .  -      . <br> <br>  <br> <br>  ‚Äî      .   ,   ,          . <br>      : <br> <br> <code class="cpp">buf0 += cutoff * (inputValue - buf0 + feedbackAmount * (buf0 - buf1));</code> <br> <br> ,   ,      ( <code>buf0 ‚Äì buf1</code> ),   <code>feedbackAmount</code> .    <code>calculateFeedbackAmount</code>  <code>feedbackAmount</code>  <code>resonance</code> , . .    ,   . <br> <br>  ,            .     ,  <i></i> ,      <a href="https://www.youtube.com/watch%3Fv%3DJWyMj6KxGHM"> </a> .    ,        ,       . <br> <br>  -<span class="hljs-number"><span class="hljs-number">12</span></span> /  -<span class="hljs-number"><span class="hljs-number">24</span></span> / <br>        !     <span class="hljs-number"><span class="hljs-number">24</span></span>   .     <code>switch</code>  <code>Filter::process</code> : <br> <br> <code class="cpp">buf2 += cutoff * (buf1 - buf2); buf3 += cutoff * (buf2 ‚Äì buf3);</code> <br> <br>   :      ,       ,            .     ,       , , <a href="https://ccrma.stanford.edu/~Jos/filters/Filter_Stability.html"></a> (       ).     <code>switch</code> : <br> <br> <code class="cpp">switch (mode) { case FILTER_MODE_LOWPASS: return buf3; case FILTER_MODE_HIGHPASS: return inputValue - buf3; case FILTER_MODE_BANDPASS: return buf0 - buf3; default: return <span class="hljs-number"><span class="hljs-number">0.0</span></span>; }</code> <br> <br>   <code>buf1</code>  <code>buf3</code> ‚Äì      .    -<span class="hljs-number"><span class="hljs-number">24</span></span> /.     <code>buf2</code>  <code>buf3</code> ,        <code>private</code> <i>Filter.h</i> : <br> <br> <code class="cpp">double buf2; double buf3;</code> <br> <br>    ,   <code>buf0</code> c <code>buf1</code> : <br> <br> <code class="cpp">Filter() : // ... buf0(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), buf1(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), buf2(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), buf3(<span class="hljs-number"><span class="hljs-number">0.0</span></span>) // ...</code> <br> <br>     , ,     :     .       . <br>          ? <br> <br>   <br>    .  ,           ,       . <br> -      <code>cutoff</code>   .      .    <code>cutoffMod</code> ,    ,       <code>cutoff</code>    .     <code><code>#include    private</code> : <br> <br> <code class="cpp">double cutoffMod;</code> <br> <br> : <br> <br> <code class="cpp">Filter() : cutoff(<span class="hljs-number"><span class="hljs-number">0.99</span></span>), resonance(<span class="hljs-number"><span class="hljs-number">0.01</span></span>), cutoffMod(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), // ...</code> <br> <br>         .   <code>private</code> : <br> <br> <code class="cpp">inline double getCalculatedCutoff() const { return fmax(fmin(cutoff + cutoffMod, <span class="hljs-number"><span class="hljs-number">0.99</span></span>), <span class="hljs-number"><span class="hljs-number">0.01</span></span>); };</code> <br> <br> <code>calculateFeedbackAmount</code>     : <br> <br> <code class="cpp">inline void calculateFeedbackAmount() { feedbackAmount = resonance + resonance/(<span class="hljs-number"><span class="hljs-number">1.0</span></span> - getCalculatedCutoff()); }</code> <br> <br>       <code>cutoffMod</code> .   <code>feedbackAmount</code>    ,     : <br> <br> <code class="cpp">inline void setCutoffMod(double newCutoffMod) { cutoffMod = newCutoffMod; calculateFeedbackAmount(); }</code> <br> <br> ,       .   <code>Filter::process</code>   : <br> <br> <code class="cpp">if (inputValue == <span class="hljs-number"><span class="hljs-number">0.0</span></span>) return inputValue; double calculatedCutoff = getCalculatedCutoff(); buf0 += calculatedCutoff * (inputValue - buf0 + feedbackAmount * (buf0 - buf1)); buf1 += calculatedCutoff * (buf0 - buf1); buf2 += calculatedCutoff * (buf1 - buf2); buf3 += calculatedCutoff * (buf2 ‚Äì buf3);</code> <br> <br>        ,    .    ,      ,   .     .     <code>cutoff</code>  <code>calculatedCutoff</code>   -. <br> <br> ,       ( <code>setCutoffMod</code> ),   <code>Synthesis</code>    ,     ,    .    ,        <code>cutoffMod</code> .    <code>filterEnvelopeAmount</code>    <code>-<span class="hljs-number"><span class="hljs-number">1</span></span></code>  <code>+<span class="hljs-number"><span class="hljs-number">1</span></span></code> .   GUI. <br> <br>   <code>private</code> <i>Synthesis.h</i>    : <br> <br> <code class="cpp">EnvelopeGenerator mFilterEnvelopeGenerator; double filterEnvelopeAmount;</code> <br> <br>       MIDI ,      <code>onNoteOn</code>  <code>onNoteOff</code> : <br> <br> <code class="cpp">inline void onNoteOn(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); mFilterEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); }; inline void onNoteOff(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); mFilterEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); };</code> <br> <br>    .   <code>ProcessDoubleReplacing</code>        : <br> <br> <code class="cpp">mFilter.setCutoffMod(mFilterEnvelopeGenerator.nextSample() * filterEnvelopeAmount);</code> <br> <br>  ,        <code>nextSample</code>  <code>filterEnvelopeAmount</code>     <code>cutoffMod</code> .     <code>filterEnvelopeAmount</code>  : <br> <br> <code class="cpp">Synthesis::Synthesis(IPlugInstanceInfo instanceInfo) : IPLUG_CTOR(kNumParams, kNumPrograms, instanceInfo), lastVirtualKeyboardNoteNumber(virtualKeyboardMinimumNoteNumber - <span class="hljs-number"><span class="hljs-number">1</span></span>), filterEnvelopeAmount(<span class="hljs-number"><span class="hljs-number">0.0</span></span>) { // ... }</code> <br> <br>       <code>Synthesis::Reset</code> : <br> <br> <code class="cpp">mFilterEnvelopeGenerator.setSampleRate(GetSampleRate());</code> <br> <br>      <code>EParams</code> ,       .  <code>AttachGraphics</code>     : <br> <br> <code class="cpp">// Knobs for filter envelope // Attack knob GetParam(mFilterAttack)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Filter Env Attack"</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">10.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); GetParam(mFilterAttack)-&gt;SetShape(<span class="hljs-number"><span class="hljs-number">3</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">139</span></span>, <span class="hljs-number"><span class="hljs-number">178</span></span>, mFilterAttack, &amp;smallKnobBitmap)); // Decay knob: GetParam(mFilterDecay)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Filter Env Decay"</span></span>, <span class="hljs-number"><span class="hljs-number">0.5</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">15.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); GetParam(mFilterDecay)-&gt;SetShape(<span class="hljs-number"><span class="hljs-number">3</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">195</span></span>, <span class="hljs-number"><span class="hljs-number">178</span></span>, mFilterDecay, &amp;smallKnobBitmap)); // Sustain knob: GetParam(mFilterSustain)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Filter Env Sustain"</span></span>, <span class="hljs-number"><span class="hljs-number">0.1</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>, <span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); GetParam(mFilterSustain)-&gt;SetShape(<span class="hljs-number"><span class="hljs-number">2</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">251</span></span>, <span class="hljs-number"><span class="hljs-number">178</span></span>, mFilterSustain, &amp;smallKnobBitmap)); // Release knob: GetParam(mFilterRelease)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Filter Env Release"</span></span>, <span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>, <span class="hljs-number"><span class="hljs-number">15.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); GetParam(mFilterRelease)-&gt;SetShape(<span class="hljs-number"><span class="hljs-number">3</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">307</span></span>, <span class="hljs-number"><span class="hljs-number">178</span></span>, mFilterRelease, &amp;smallKnobBitmap)); // Filter envelope amount knob: GetParam(mFilterEnvelopeAmount)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Filter Env Amount"</span></span>, <span class="hljs-number"><span class="hljs-number">0.0</span></span>, -<span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">363</span></span>, <span class="hljs-number"><span class="hljs-number">178</span></span>, mFilterEnvelopeAmount, &amp;smallKnobBitmap));</code> <br> <br>     ,       <code>smallKnobBitmap</code> .                   .     ,    .  <code>Synthesis::OnParamChange</code>    <code>switch</code> : <br> <br> <code class="cpp">case mFilterAttack: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK, GetParam(paramIdx)-&gt;Value()); break; case mFilterDecay: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_DECAY, GetParam(paramIdx)-&gt;Value()); break; case mFilterSustain: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_SUSTAIN, GetParam(paramIdx)-&gt;Value()); break; case mFilterRelease: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE, GetParam(paramIdx)-&gt;Value()); break; case mFilterEnvelopeAmount: filterEnvelopeAmount = GetParam(paramIdx)-&gt;Value(); break;</code> <br> <br> ! <br>     !           (-   C1),   : <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/f5d/757/3f9/f5d7573f9b3a720fe5898d88ae477cfc.png"> <br> <br>        <code>EnvelopeGenerator</code>  .         .        ! <br> <br>    <a href=""></a> . <br> <br>        :) <br> <br>  : <br> <a href="http://martin-finke.de/blog/articles/audio-plugins-013-filter/">martin-finke.de/blog/articles/audio-plugins-<span class="hljs-number"><span class="hljs-number">013</span></span>-filter</a></code></code> </pre> <code><code class="cpp">#include  <i>Filter.h</i> ( )     : <br> <br> class Filter { public: enum FilterMode { FILTER_MODE_LOWPASS = 0, FILTER_MODE_HIGHPASS, FILTER_MODE_BANDPASS, kNumFilterModes }; Filter() : cutoff(0.99), resonance(0.0), mode(FILTER_MODE_LOWPASS), buf0(0.0), buf1(0.0) { calculateFeedbackAmount(); }; double process(double inputValue); inline void setCutoff(double newCutoff) { cutoff = newCutoff; calculateFeedbackAmount(); }; inline void setResonance(double newResonance) { resonance = newResonance; calculateFeedbackAmount(); }; inline void setFilterMode(FilterMode newMode) { mode = newMode; } private: double cutoff; double resonance; FilterMode mode; double feedbackAmount; inline void calculateFeedbackAmount() { feedbackAmount = resonance + resonance/(1.0 - cutoff); } double buf0; double buf1; };</code> <br> <br>  <code>private</code>     <i> </i> <code>cutoff</code>  <i></i> <code>resonance</code> . <code>Mode</code>      (Lowpass, Highpass, Bandpass).  <code>feedbackAmount</code> , <code>buf0</code>  <code>buf1</code>    ,    . <br>          ( <code>calculateFeedbackAmount()</code> ).  <code>process</code>      .   <code>feedbackAmount</code>   <code>cutoff</code>  <code>resonance</code> ,    <code>calculateFeedbackAmount</code>      . <br> <br>   <i>Filter.cpp</i>  : <br> <br> <code class="cpp">// By Paul Kellett // http://www.musicdsp.org/showone.php?id=29 double Filter::process(double inputValue) { buf0 += cutoff * (inputValue - buf0); buf1 += cutoff * (buf0 - buf1); switch (mode) { case FILTER_MODE_LOWPASS: return buf1; case FILTER_MODE_HIGHPASS: return inputValue - buf0; case FILTER_MODE_BANDPASS: return buf0 - buf1; default: return 0.0; } }</code> <br> <br> , ?  ,         <i> </i> . ¬´ ¬ª   ,               (. .    6 ).     <code>buf0</code>  <code>buf1</code> :        .     <code>inputValue</code> ,  - <code>buf0</code> (  ).   .    6 /   12 /.  <code>switch</code> ,  <code>buf1</code>    . , ,    <code>buf0</code> ,       12,   6 /,        . <br> <br>  <code>case</code> <code>FILTER_MODE_HIGHPASS</code>    . <code>buf0</code>       .   <code>inputValue</code>  <code>buf0</code> ,   .    <code>buf1</code> ,     . <br> <br>  <code>case</code> <code>FILTER_MODE_BANDPASS</code> ,  <code>buf0 - buf1</code>   .  <code>buf0</code>       ,     <code>buf1</code> . ,   . <br>  :    <i> </i>    <i> </i> ,   . <br> <br>  <code>buf1</code>     .       <a href="http://ru.wikipedia.org/wiki/%25D0%25A4%25D0%25B8%25D0%25BB%25D1%258C%25D1%2582%25D1%2580_%25D1%2581_%25D0%25B1%25D0%25B5%25D1%2581%25D0%25BA%25D0%25BE%25D0%25BD%25D0%25B5%25D1%2587%25D0%25BD%25D0%25BE%25D0%25B9_%25D0%25B8%25D0%25BC%25D0%25BF%25D1%2583%25D0%25BB%25D1%258C%25D1%2581%25D0%25BD%25D0%25BE%25D0%25B9_%25D1%2585%25D0%25B0%25D1%2580%25D0%25B0%25D0%25BA%25D1%2582%25D0%25B5%25D1%2580%25D0%25B8%25D1%2581%25D1%2582%25D0%25B8%25D0%25BA%25D0%25BE%25D0%25B9">    </a> ( <i>Infinite Impulse Response</i> ,  <i>IIR</i> ).  <a href="http://www.dspguide.com/ch14/1.htm"> </a> ,      .      ,         ,      . <br> <br>   <br>       ,     ,     .   ,  ,      ,  ,          .           ,  NI Massive,   ¬´ <a href="http://lurkmore.to/%25D0%25A2%25D1%2591%25D0%25BF%25D0%25BB%25D1%258B%25D0%25B9_%25D0%25BB%25D0%25B0%25D0%25BC%25D0%25BF%25D0%25BE%25D0%25B2%25D1%258B%25D0%25B9_%25D0%25B7%25D0%25B2%25D1%2583%25D0%25BA">  </a> ¬ª.       ,          ,   .        ,          (  Massive       ).      ¬´¬ª , , , AAS Ultra Analog,       ,     ,    ,        .         ,  ,    <a href="http://www.kvraudio.com/forum/viewtopic.php%3Ft%3D350246"></a> ,   ,      NI Reaktor. ,            ‚Äî    ,    ..     . <br> <br>   <br>     .   GUI.  <i>bg.png</i>   ( <i>‚ÄúMove to trash‚Äù</i>  Xcode),       : <br> <br> <a href="">filtermode.png</a> <a href="">knob_small.png</a> (  ,   50 50 ) <a href="">bg.png</a> (       ) <br> <br>    ID  <i>resource.h</i> : <br> <br> <code class="cpp">// Unique IDs for each image resource. #define BG_ID 101 #define WHITE_KEY_ID 102 #define BLACK_KEY_ID 103 #define WAVEFORM_ID 104 #define KNOB_ID 105 #define KNOB_SMALL_ID 106 #define FILTERMODE_ID 107 // Image resource locations for this plug. #define BG_FN "resources/img/bg.png" #define WHITE_KEY_FN "resources/img/whitekey.png" #define BLACK_KEY_FN "resources/img/blackkey.png" #define WAVEFORM_FN "resources/img/waveform.png" #define KNOB_FN "resources/img/knob.png" #define KNOB_SMALL_FN "resources/img/knob_small.png" #define FILTERMODE_FN "resources/img/filtermode.png"</code> <br> <br>  <i>Synthesis.rc</i> : <br> <br> <code class="cpp">#include "resource.h" BG_ID PNG BG_FN WHITE_KEY_ID PNG WHITE_KEY_FN BLACK_KEY_ID PNG BLACK_KEY_FN WAVEFORM_ID PNG WAVEFORM_FN KNOB_ID PNG KNOB_FN KNOB_SMALL_ID PNG KNOB_SMALL_FN FILTERMODE_ID PNG FILTERMODE_FN</code> <br> <br>   <code>#include "Filter.h"</code>  <i>Synthesis.h</i>    <code>private</code> : <br> <br> <code class="cpp">Filter mFilter;</code> <br> <br>  <code>EParams</code>  <i>Synthesis.cpp</i> : <br> <br> <code class="cpp">enum EParams { mWaveform = 0, mAttack, mDecay, mSustain, mRelease, mFilterMode, mFilterCutoff, mFilterResonance, mFilterAttack, mFilterDecay, mFilterSustain, mFilterRelease, mFilterEnvelopeAmount, kNumParams };</code> <br> <br>        : <br> <br> <code class="cpp">pGraphics-&gt;AttachControl(new ISwitchControl(this, 24, 38, mWaveform, &amp;waveformBitmap));</code> <br> <br>      .      (Lowpass, Highpass, Bandpass).    <code>AttachGraphics(pGraphics)</code> : <br> <br> <code class="cpp">GetParam(mFilterMode)-&gt;InitEnum("Filter Mode", Filter::FILTER_MODE_LOWPASS, Filter::kNumFilterModes); IBitmap filtermodeBitmap = pGraphics-&gt;LoadIBitmap(FILTERMODE_ID, FILTERMODE_FN, 3); pGraphics-&gt;AttachControl(new ISwitchControl(this, 24, 123, mFilterMode, &amp;filtermodeBitmap));</code> <br> <br>         .    .     <i>knob_small.png</i> : <br> <br> <code class="cpp">// Knobs for filter cutoff and resonance IBitmap smallKnobBitmap = pGraphics-&gt;LoadIBitmap(KNOB_SMALL_ID, KNOB_SMALL_FN, 64); // Cutoff knob: GetParam(mFilterCutoff)-&gt;InitDouble("Cutoff", 0.99, 0.01, 0.99, 0.001); GetParam(mFilterCutoff)-&gt;SetShape(2); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 5, 177, mFilterCutoff, &amp;smallKnobBitmap)); // Resonance knob: GetParam(mFilterResonance)-&gt;InitDouble("Resonance", 0.01, 0.01, 1.0, 0.001); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 61, 177, mFilterResonance, &amp;smallKnobBitmap));</code> <br> <br>   ,           <code>1.0</code> ,   <code>calculateFeedbackAmount</code>    , . <br>  <code>ProcessDoubleReplacing</code>     : <br> <br> <code class="cpp">leftOutput[i] = rightOutput[i] = mFilter.process(mOscillator.nextSample() * mEnvelopeGenerator.nextSample() * velocity / 127.0);</code> <br> <br>       .  <code>switch</code>   <code>Synthesis::OnParamChange</code> : <br> <br> <code class="cpp">case mFilterCutoff: mFilter.setCutoff(GetParam(paramIdx)-&gt;Value()); break; case mFilterResonance: mFilter.setResonance(GetParam(paramIdx)-&gt;Value()); break; case mFilterMode: mFilter.setFilterMode(static_cast&lt;Filter::FilterMode&gt;(GetParam(paramIdx)-&gt;Int())); break;</code> <br> <br>    .  -      . <br> <br>  <br> <br>  ‚Äî      .   ,   ,          . <br>      : <br> <br> <code class="cpp">buf0 += cutoff * (inputValue - buf0 + feedbackAmount * (buf0 - buf1));</code> <br> <br> ,   ,      ( <code>buf0 ‚Äì buf1</code> ),   <code>feedbackAmount</code> .    <code>calculateFeedbackAmount</code>  <code>feedbackAmount</code>  <code>resonance</code> , . .    ,   . <br> <br>  ,            .     ,  <i></i> ,      <a href="https://www.youtube.com/watch%3Fv%3DJWyMj6KxGHM"> </a> .    ,        ,       . <br> <br>  -12 /  -24 / <br>        !     24   .     <code>switch</code>  <code>Filter::process</code> : <br> <br> <code class="cpp">buf2 += cutoff * (buf1 - buf2); buf3 += cutoff * (buf2 ‚Äì buf3);</code> <br> <br>   :      ,       ,            .     ,       , , <a href="https://ccrma.stanford.edu/~Jos/filters/Filter_Stability.html"></a> (       ).     <code>switch</code> : <br> <br> <code class="cpp">switch (mode) { case FILTER_MODE_LOWPASS: return buf3; case FILTER_MODE_HIGHPASS: return inputValue - buf3; case FILTER_MODE_BANDPASS: return buf0 - buf3; default: return 0.0; }</code> <br> <br>   <code>buf1</code>  <code>buf3</code> ‚Äì      .    -24 /.     <code>buf2</code>  <code>buf3</code> ,        <code>private</code> <i>Filter.h</i> : <br> <br> <code class="cpp">double buf2; double buf3;</code> <br> <br>    ,   <code>buf0</code> c <code>buf1</code> : <br> <br> <code class="cpp">Filter() : // ... buf0(0.0), buf1(0.0), buf2(0.0), buf3(0.0) // ...</code> <br> <br>     , ,     :     .       . <br>          ? <br> <br>   <br>    .  ,           ,       . <br> -      <code>cutoff</code>   .      .    <code>cutoffMod</code> ,    ,       <code>cutoff</code>    .     <code><code>#include    private</code> : <br> <br> <code class="cpp">double cutoffMod;</code> <br> <br> : <br> <br> <code class="cpp">Filter() : cutoff(0.99), resonance(0.01), cutoffMod(0.0), // ...</code> <br> <br>         .   <code>private</code> : <br> <br> <code class="cpp">inline double getCalculatedCutoff() const { return fmax(fmin(cutoff + cutoffMod, 0.99), 0.01); };</code> <br> <br> <code>calculateFeedbackAmount</code>     : <br> <br> <code class="cpp">inline void calculateFeedbackAmount() { feedbackAmount = resonance + resonance/(1.0 - getCalculatedCutoff()); }</code> <br> <br>       <code>cutoffMod</code> .   <code>feedbackAmount</code>    ,     : <br> <br> <code class="cpp">inline void setCutoffMod(double newCutoffMod) { cutoffMod = newCutoffMod; calculateFeedbackAmount(); }</code> <br> <br> ,       .   <code>Filter::process</code>   : <br> <br> <code class="cpp">if (inputValue == 0.0) return inputValue; double calculatedCutoff = getCalculatedCutoff(); buf0 += calculatedCutoff * (inputValue - buf0 + feedbackAmount * (buf0 - buf1)); buf1 += calculatedCutoff * (buf0 - buf1); buf2 += calculatedCutoff * (buf1 - buf2); buf3 += calculatedCutoff * (buf2 ‚Äì buf3);</code> <br> <br>        ,    .    ,      ,   .     .     <code>cutoff</code>  <code>calculatedCutoff</code>   -. <br> <br> ,       ( <code>setCutoffMod</code> ),   <code>Synthesis</code>    ,     ,    .    ,        <code>cutoffMod</code> .    <code>filterEnvelopeAmount</code>    <code>-1</code>  <code>+1</code> .   GUI. <br> <br>   <code>private</code> <i>Synthesis.h</i>    : <br> <br> <code class="cpp">EnvelopeGenerator mFilterEnvelopeGenerator; double filterEnvelopeAmount;</code> <br> <br>       MIDI ,      <code>onNoteOn</code>  <code>onNoteOff</code> : <br> <br> <code class="cpp">inline void onNoteOn(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); mFilterEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); }; inline void onNoteOff(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); mFilterEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); };</code> <br> <br>    .   <code>ProcessDoubleReplacing</code>        : <br> <br> <code class="cpp">mFilter.setCutoffMod(mFilterEnvelopeGenerator.nextSample() * filterEnvelopeAmount);</code> <br> <br>  ,        <code>nextSample</code>  <code>filterEnvelopeAmount</code>     <code>cutoffMod</code> .     <code>filterEnvelopeAmount</code>  : <br> <br> <code class="cpp">Synthesis::Synthesis(IPlugInstanceInfo instanceInfo) : IPLUG_CTOR(kNumParams, kNumPrograms, instanceInfo), lastVirtualKeyboardNoteNumber(virtualKeyboardMinimumNoteNumber - 1), filterEnvelopeAmount(0.0) { // ... }</code> <br> <br>       <code>Synthesis::Reset</code> : <br> <br> <code class="cpp">mFilterEnvelopeGenerator.setSampleRate(GetSampleRate());</code> <br> <br>      <code>EParams</code> ,       .  <code>AttachGraphics</code>     : <br> <br> <code class="cpp">// Knobs for filter envelope // Attack knob GetParam(mFilterAttack)-&gt;InitDouble("Filter Env Attack", 0.01, 0.01, 10.0, 0.001); GetParam(mFilterAttack)-&gt;SetShape(3); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 139, 178, mFilterAttack, &amp;smallKnobBitmap)); // Decay knob: GetParam(mFilterDecay)-&gt;InitDouble("Filter Env Decay", 0.5, 0.01, 15.0, 0.001); GetParam(mFilterDecay)-&gt;SetShape(3); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 195, 178, mFilterDecay, &amp;smallKnobBitmap)); // Sustain knob: GetParam(mFilterSustain)-&gt;InitDouble("Filter Env Sustain", 0.1, 0.001, 1.0, 0.001); GetParam(mFilterSustain)-&gt;SetShape(2); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 251, 178, mFilterSustain, &amp;smallKnobBitmap)); // Release knob: GetParam(mFilterRelease)-&gt;InitDouble("Filter Env Release", 1.0, 0.001, 15.0, 0.001); GetParam(mFilterRelease)-&gt;SetShape(3); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 307, 178, mFilterRelease, &amp;smallKnobBitmap)); // Filter envelope amount knob: GetParam(mFilterEnvelopeAmount)-&gt;InitDouble("Filter Env Amount", 0.0, -1.0, 1.0, 0.001); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 363, 178, mFilterEnvelopeAmount, &amp;smallKnobBitmap));</code> <br> <br>     ,       <code>smallKnobBitmap</code> .                   .     ,    .  <code>Synthesis::OnParamChange</code>    <code>switch</code> : <br> <br> <code class="cpp">case mFilterAttack: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK, GetParam(paramIdx)-&gt;Value()); break; case mFilterDecay: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_DECAY, GetParam(paramIdx)-&gt;Value()); break; case mFilterSustain: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_SUSTAIN, GetParam(paramIdx)-&gt;Value()); break; case mFilterRelease: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE, GetParam(paramIdx)-&gt;Value()); break; case mFilterEnvelopeAmount: filterEnvelopeAmount = GetParam(paramIdx)-&gt;Value(); break;</code> <br> <br> ! <br>     !           (-   C1),   : <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/f5d/757/3f9/f5d7573f9b3a720fe5898d88ae477cfc.png"> <br> <br>        <code>EnvelopeGenerator</code>  .         .        ! <br> <br>    <a href=""></a> . <br> <br>        :) <br> <br>  : <br> <a href="http://martin-finke.de/blog/articles/audio-plugins-013-filter/">martin-finke.de/blog/articles/audio-plugins-013-filter</a></code></code> <pre> <code class="hljs erlang-repl"><code class="cpp">#include  <i>Filter.h</i> ( )     : <br> <br> class Filter { public: enum FilterMode { FILTER_MODE_LOWPASS = <span class="hljs-number"><span class="hljs-number">0</span></span>, FILTER_MODE_HIGHPASS, FILTER_MODE_BANDPASS, kNumFilterModes }; Filter() : cutoff(<span class="hljs-number"><span class="hljs-number">0.99</span></span>), resonance(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), mode(FILTER_MODE_LOWPASS), buf0(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), buf1(<span class="hljs-number"><span class="hljs-number">0.0</span></span>) { calculateFeedbackAmount(); }; double process(double inputValue); inline void setCutoff(double newCutoff) { cutoff = newCutoff; calculateFeedbackAmount(); }; inline void setResonance(double newResonance) { resonance = newResonance; calculateFeedbackAmount(); }; inline void setFilterMode(FilterMode newMode) { mode = newMode; } private: double cutoff; double resonance; FilterMode mode; double feedbackAmount; inline void calculateFeedbackAmount() { feedbackAmount = resonance + resonance/(<span class="hljs-number"><span class="hljs-number">1.0</span></span> - cutoff); } double buf0; double buf1; };</code> <br> <br>  <code>private</code>     <i> </i> <code>cutoff</code>  <i></i> <code>resonance</code> . <code>Mode</code>      (Lowpass, Highpass, Bandpass).  <code>feedbackAmount</code> , <code>buf0</code>  <code>buf1</code>    ,    . <br>          ( <code>calculateFeedbackAmount()</code> ).  <code>process</code>      .   <code>feedbackAmount</code>   <code>cutoff</code>  <code>resonance</code> ,    <code>calculateFeedbackAmount</code>      . <br> <br>   <i>Filter.cpp</i>  : <br> <br> <code class="cpp">// By Paul Kellett // http://www.musicdsp.org/showone.php?id=<span class="hljs-number"><span class="hljs-number">29</span></span> double Filter::process(double inputValue) { buf0 += cutoff * (inputValue - buf0); buf1 += cutoff * (buf0 - buf1); switch (mode) { case FILTER_MODE_LOWPASS: return buf1; case FILTER_MODE_HIGHPASS: return inputValue - buf0; case FILTER_MODE_BANDPASS: return buf0 - buf1; default: return <span class="hljs-number"><span class="hljs-number">0.0</span></span>; } }</code> <br> <br> , ?  ,         <i> </i> . ¬´ ¬ª   ,               (. .    <span class="hljs-number"><span class="hljs-number">6</span></span> ).     <code>buf0</code>  <code>buf1</code> :        .     <code>inputValue</code> ,  - <code>buf0</code> (  ).   .    <span class="hljs-number"><span class="hljs-number">6</span></span> /   <span class="hljs-number"><span class="hljs-number">12</span></span> /.  <code>switch</code> ,  <code>buf1</code>    . , ,    <code>buf0</code> ,       <span class="hljs-number"><span class="hljs-number">12</span></span>,   <span class="hljs-number"><span class="hljs-number">6</span></span> /,        . <br> <br>  <code>case</code> <code>FILTER_MODE_HIGHPASS</code>    . <code>buf0</code>       .   <code>inputValue</code>  <code>buf0</code> ,   .    <code>buf1</code> ,     . <br> <br>  <code>case</code> <code>FILTER_MODE_BANDPASS</code> ,  <code>buf0 - buf1</code>   .  <code>buf0</code>       ,     <code>buf1</code> . ,   . <br>  :    <i> </i>    <i> </i> ,   . <br> <br>  <code>buf1</code>     .       <a href="http://ru.wikipedia.org/wiki/%25D0%25A4%25D0%25B8%25D0%25BB%25D1%258C%25D1%2582%25D1%2580_%25D1%2581_%25D0%25B1%25D0%25B5%25D1%2581%25D0%25BA%25D0%25BE%25D0%25BD%25D0%25B5%25D1%2587%25D0%25BD%25D0%25BE%25D0%25B9_%25D0%25B8%25D0%25BC%25D0%25BF%25D1%2583%25D0%25BB%25D1%258C%25D1%2581%25D0%25BD%25D0%25BE%25D0%25B9_%25D1%2585%25D0%25B0%25D1%2580%25D0%25B0%25D0%25BA%25D1%2582%25D0%25B5%25D1%2580%25D0%25B8%25D1%2581%25D1%2582%25D0%25B8%25D0%25BA%25D0%25BE%25D0%25B9">    </a> ( <i>Infinite Impulse Response</i> ,  <i>IIR</i> ).  <a href="http://www.dspguide.com/ch14/1.htm"> </a> ,      .      ,         ,      . <br> <br>   <br>       ,     ,     .   ,  ,      ,  ,          .           ,  NI Massive,   ¬´ <a href="http://lurkmore.to/%25D0%25A2%25D1%2591%25D0%25BF%25D0%25BB%25D1%258B%25D0%25B9_%25D0%25BB%25D0%25B0%25D0%25BC%25D0%25BF%25D0%25BE%25D0%25B2%25D1%258B%25D0%25B9_%25D0%25B7%25D0%25B2%25D1%2583%25D0%25BA">  </a> ¬ª.       ,          ,   .        ,          (  Massive       ).      ¬´¬ª , , , AAS Ultra Analog,       ,     ,    ,        .         ,  ,    <a href="http://www.kvraudio.com/forum/viewtopic.php%3Ft%3D350246"></a> ,   ,      NI Reaktor. ,            ‚Äî    ,    ..     . <br> <br>   <br>     .   GUI.  <i>bg.png</i>   ( <i>‚ÄúMove to trash‚Äù</i>  Xcode),       : <br> <br> <a href="">filtermode.png</a> <a href="">knob_small.png</a> (  ,   <span class="hljs-number"><span class="hljs-number">50</span></span> <span class="hljs-number"><span class="hljs-number">50</span></span> ) <a href="">bg.png</a> (       ) <br> <br>    ID  <i>resource.h</i> : <br> <br> <code class="cpp">// Unique IDs for each image resource. #define BG_ID <span class="hljs-number"><span class="hljs-number">101</span></span> #define WHITE_KEY_ID <span class="hljs-number"><span class="hljs-number">102</span></span> #define BLACK_KEY_ID <span class="hljs-number"><span class="hljs-number">103</span></span> #define WAVEFORM_ID <span class="hljs-number"><span class="hljs-number">104</span></span> #define KNOB_ID <span class="hljs-number"><span class="hljs-number">105</span></span> #define KNOB_SMALL_ID <span class="hljs-number"><span class="hljs-number">106</span></span> #define FILTERMODE_ID <span class="hljs-number"><span class="hljs-number">107</span></span> // Image resource locations for this plug. #define BG_FN <span class="hljs-string"><span class="hljs-string">"resources/img/bg.png"</span></span> #define WHITE_KEY_FN <span class="hljs-string"><span class="hljs-string">"resources/img/whitekey.png"</span></span> #define BLACK_KEY_FN <span class="hljs-string"><span class="hljs-string">"resources/img/blackkey.png"</span></span> #define WAVEFORM_FN <span class="hljs-string"><span class="hljs-string">"resources/img/waveform.png"</span></span> #define KNOB_FN <span class="hljs-string"><span class="hljs-string">"resources/img/knob.png"</span></span> #define KNOB_SMALL_FN <span class="hljs-string"><span class="hljs-string">"resources/img/knob_small.png"</span></span> #define FILTERMODE_FN <span class="hljs-string"><span class="hljs-string">"resources/img/filtermode.png"</span></span></code> <br> <br>  <i>Synthesis.rc</i> : <br> <br> <code class="cpp">#include <span class="hljs-string"><span class="hljs-string">"resource.h"</span></span> BG_ID PNG BG_FN WHITE_KEY_ID PNG WHITE_KEY_FN BLACK_KEY_ID PNG BLACK_KEY_FN WAVEFORM_ID PNG WAVEFORM_FN KNOB_ID PNG KNOB_FN KNOB_SMALL_ID PNG KNOB_SMALL_FN FILTERMODE_ID PNG FILTERMODE_FN</code> <br> <br>   <code>#include <span class="hljs-string"><span class="hljs-string">"Filter.h"</span></span></code>  <i>Synthesis.h</i>    <code>private</code> : <br> <br> <code class="cpp">Filter mFilter;</code> <br> <br>  <code>EParams</code>  <i>Synthesis.cpp</i> : <br> <br> <code class="cpp">enum EParams { mWaveform = <span class="hljs-number"><span class="hljs-number">0</span></span>, mAttack, mDecay, mSustain, mRelease, mFilterMode, mFilterCutoff, mFilterResonance, mFilterAttack, mFilterDecay, mFilterSustain, mFilterRelease, mFilterEnvelopeAmount, kNumParams };</code> <br> <br>        : <br> <br> <code class="cpp">pGraphics-&gt;AttachControl(new ISwitchControl(this, <span class="hljs-number"><span class="hljs-number">24</span></span>, <span class="hljs-number"><span class="hljs-number">38</span></span>, mWaveform, &amp;waveformBitmap));</code> <br> <br>      .      (Lowpass, Highpass, Bandpass).    <code>AttachGraphics(pGraphics)</code> : <br> <br> <code class="cpp">GetParam(mFilterMode)-&gt;InitEnum(<span class="hljs-string"><span class="hljs-string">"Filter Mode"</span></span>, Filter::FILTER_MODE_LOWPASS, Filter::kNumFilterModes); IBitmap filtermodeBitmap = pGraphics-&gt;LoadIBitmap(FILTERMODE_ID, FILTERMODE_FN, <span class="hljs-number"><span class="hljs-number">3</span></span>); pGraphics-&gt;AttachControl(new ISwitchControl(this, <span class="hljs-number"><span class="hljs-number">24</span></span>, <span class="hljs-number"><span class="hljs-number">123</span></span>, mFilterMode, &amp;filtermodeBitmap));</code> <br> <br>         .    .     <i>knob_small.png</i> : <br> <br> <code class="cpp">// Knobs for filter cutoff and resonance IBitmap smallKnobBitmap = pGraphics-&gt;LoadIBitmap(KNOB_SMALL_ID, KNOB_SMALL_FN, <span class="hljs-number"><span class="hljs-number">64</span></span>); // Cutoff knob: GetParam(mFilterCutoff)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Cutoff"</span></span>, <span class="hljs-number"><span class="hljs-number">0.99</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">0.99</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); GetParam(mFilterCutoff)-&gt;SetShape(<span class="hljs-number"><span class="hljs-number">2</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-number"><span class="hljs-number">177</span></span>, mFilterCutoff, &amp;smallKnobBitmap)); // Resonance knob: GetParam(mFilterResonance)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Resonance"</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">61</span></span>, <span class="hljs-number"><span class="hljs-number">177</span></span>, mFilterResonance, &amp;smallKnobBitmap));</code> <br> <br>   ,           <code><span class="hljs-number"><span class="hljs-number">1.0</span></span></code> ,   <code>calculateFeedbackAmount</code>    , . <br>  <code>ProcessDoubleReplacing</code>     : <br> <br> <code class="cpp">leftOutput[i] = rightOutput[i] = mFilter.process(mOscillator.nextSample() * mEnvelopeGenerator.nextSample() * velocity / <span class="hljs-number"><span class="hljs-number">127.0</span></span>);</code> <br> <br>       .  <code>switch</code>   <code>Synthesis::OnParamChange</code> : <br> <br> <code class="cpp">case mFilterCutoff: mFilter.setCutoff(GetParam(paramIdx)-&gt;Value()); break; case mFilterResonance: mFilter.setResonance(GetParam(paramIdx)-&gt;Value()); break; case mFilterMode: mFilter.setFilterMode(static_cast&lt;Filter::FilterMode&gt;(GetParam(paramIdx)-&gt;Int())); break;</code> <br> <br>    .  -      . <br> <br>  <br> <br>  ‚Äî      .   ,   ,          . <br>      : <br> <br> <code class="cpp">buf0 += cutoff * (inputValue - buf0 + feedbackAmount * (buf0 - buf1));</code> <br> <br> ,   ,      ( <code>buf0 ‚Äì buf1</code> ),   <code>feedbackAmount</code> .    <code>calculateFeedbackAmount</code>  <code>feedbackAmount</code>  <code>resonance</code> , . .    ,   . <br> <br>  ,            .     ,  <i></i> ,      <a href="https://www.youtube.com/watch%3Fv%3DJWyMj6KxGHM"> </a> .    ,        ,       . <br> <br>  -<span class="hljs-number"><span class="hljs-number">12</span></span> /  -<span class="hljs-number"><span class="hljs-number">24</span></span> / <br>        !     <span class="hljs-number"><span class="hljs-number">24</span></span>   .     <code>switch</code>  <code>Filter::process</code> : <br> <br> <code class="cpp">buf2 += cutoff * (buf1 - buf2); buf3 += cutoff * (buf2 ‚Äì buf3);</code> <br> <br>   :      ,       ,            .     ,       , , <a href="https://ccrma.stanford.edu/~Jos/filters/Filter_Stability.html"></a> (       ).     <code>switch</code> : <br> <br> <code class="cpp">switch (mode) { case FILTER_MODE_LOWPASS: return buf3; case FILTER_MODE_HIGHPASS: return inputValue - buf3; case FILTER_MODE_BANDPASS: return buf0 - buf3; default: return <span class="hljs-number"><span class="hljs-number">0.0</span></span>; }</code> <br> <br>   <code>buf1</code>  <code>buf3</code> ‚Äì      .    -<span class="hljs-number"><span class="hljs-number">24</span></span> /.     <code>buf2</code>  <code>buf3</code> ,        <code>private</code> <i>Filter.h</i> : <br> <br> <code class="cpp">double buf2; double buf3;</code> <br> <br>    ,   <code>buf0</code> c <code>buf1</code> : <br> <br> <code class="cpp">Filter() : // ... buf0(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), buf1(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), buf2(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), buf3(<span class="hljs-number"><span class="hljs-number">0.0</span></span>) // ...</code> <br> <br>     , ,     :     .       . <br>          ? <br> <br>   <br>    .  ,           ,       . <br> -      <code>cutoff</code>   .      .    <code>cutoffMod</code> ,    ,       <code>cutoff</code>    .     <code><code>#include    private</code> : <br> <br> <code class="cpp">double cutoffMod;</code> <br> <br> : <br> <br> <code class="cpp">Filter() : cutoff(<span class="hljs-number"><span class="hljs-number">0.99</span></span>), resonance(<span class="hljs-number"><span class="hljs-number">0.01</span></span>), cutoffMod(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), // ...</code> <br> <br>         .   <code>private</code> : <br> <br> <code class="cpp">inline double getCalculatedCutoff() const { return fmax(fmin(cutoff + cutoffMod, <span class="hljs-number"><span class="hljs-number">0.99</span></span>), <span class="hljs-number"><span class="hljs-number">0.01</span></span>); };</code> <br> <br> <code>calculateFeedbackAmount</code>     : <br> <br> <code class="cpp">inline void calculateFeedbackAmount() { feedbackAmount = resonance + resonance/(<span class="hljs-number"><span class="hljs-number">1.0</span></span> - getCalculatedCutoff()); }</code> <br> <br>       <code>cutoffMod</code> .   <code>feedbackAmount</code>    ,     : <br> <br> <code class="cpp">inline void setCutoffMod(double newCutoffMod) { cutoffMod = newCutoffMod; calculateFeedbackAmount(); }</code> <br> <br> ,       .   <code>Filter::process</code>   : <br> <br> <code class="cpp">if (inputValue == <span class="hljs-number"><span class="hljs-number">0.0</span></span>) return inputValue; double calculatedCutoff = getCalculatedCutoff(); buf0 += calculatedCutoff * (inputValue - buf0 + feedbackAmount * (buf0 - buf1)); buf1 += calculatedCutoff * (buf0 - buf1); buf2 += calculatedCutoff * (buf1 - buf2); buf3 += calculatedCutoff * (buf2 ‚Äì buf3);</code> <br> <br>        ,    .    ,      ,   .     .     <code>cutoff</code>  <code>calculatedCutoff</code>   -. <br> <br> ,       ( <code>setCutoffMod</code> ),   <code>Synthesis</code>    ,     ,    .    ,        <code>cutoffMod</code> .    <code>filterEnvelopeAmount</code>    <code>-<span class="hljs-number"><span class="hljs-number">1</span></span></code>  <code>+<span class="hljs-number"><span class="hljs-number">1</span></span></code> .   GUI. <br> <br>   <code>private</code> <i>Synthesis.h</i>    : <br> <br> <code class="cpp">EnvelopeGenerator mFilterEnvelopeGenerator; double filterEnvelopeAmount;</code> <br> <br>       MIDI ,      <code>onNoteOn</code>  <code>onNoteOff</code> : <br> <br> <code class="cpp">inline void onNoteOn(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); mFilterEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); }; inline void onNoteOff(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); mFilterEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); };</code> <br> <br>    .   <code>ProcessDoubleReplacing</code>        : <br> <br> <code class="cpp">mFilter.setCutoffMod(mFilterEnvelopeGenerator.nextSample() * filterEnvelopeAmount);</code> <br> <br>  ,        <code>nextSample</code>  <code>filterEnvelopeAmount</code>     <code>cutoffMod</code> .     <code>filterEnvelopeAmount</code>  : <br> <br> <code class="cpp">Synthesis::Synthesis(IPlugInstanceInfo instanceInfo) : IPLUG_CTOR(kNumParams, kNumPrograms, instanceInfo), lastVirtualKeyboardNoteNumber(virtualKeyboardMinimumNoteNumber - <span class="hljs-number"><span class="hljs-number">1</span></span>), filterEnvelopeAmount(<span class="hljs-number"><span class="hljs-number">0.0</span></span>) { // ... }</code> <br> <br>       <code>Synthesis::Reset</code> : <br> <br> <code class="cpp">mFilterEnvelopeGenerator.setSampleRate(GetSampleRate());</code> <br> <br>      <code>EParams</code> ,       .  <code>AttachGraphics</code>     : <br> <br> <code class="cpp">// Knobs for filter envelope // Attack knob GetParam(mFilterAttack)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Filter Env Attack"</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">10.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); GetParam(mFilterAttack)-&gt;SetShape(<span class="hljs-number"><span class="hljs-number">3</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">139</span></span>, <span class="hljs-number"><span class="hljs-number">178</span></span>, mFilterAttack, &amp;smallKnobBitmap)); // Decay knob: GetParam(mFilterDecay)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Filter Env Decay"</span></span>, <span class="hljs-number"><span class="hljs-number">0.5</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">15.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); GetParam(mFilterDecay)-&gt;SetShape(<span class="hljs-number"><span class="hljs-number">3</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">195</span></span>, <span class="hljs-number"><span class="hljs-number">178</span></span>, mFilterDecay, &amp;smallKnobBitmap)); // Sustain knob: GetParam(mFilterSustain)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Filter Env Sustain"</span></span>, <span class="hljs-number"><span class="hljs-number">0.1</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>, <span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); GetParam(mFilterSustain)-&gt;SetShape(<span class="hljs-number"><span class="hljs-number">2</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">251</span></span>, <span class="hljs-number"><span class="hljs-number">178</span></span>, mFilterSustain, &amp;smallKnobBitmap)); // Release knob: GetParam(mFilterRelease)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Filter Env Release"</span></span>, <span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>, <span class="hljs-number"><span class="hljs-number">15.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); GetParam(mFilterRelease)-&gt;SetShape(<span class="hljs-number"><span class="hljs-number">3</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">307</span></span>, <span class="hljs-number"><span class="hljs-number">178</span></span>, mFilterRelease, &amp;smallKnobBitmap)); // Filter envelope amount knob: GetParam(mFilterEnvelopeAmount)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Filter Env Amount"</span></span>, <span class="hljs-number"><span class="hljs-number">0.0</span></span>, -<span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">363</span></span>, <span class="hljs-number"><span class="hljs-number">178</span></span>, mFilterEnvelopeAmount, &amp;smallKnobBitmap));</code> <br> <br>     ,       <code>smallKnobBitmap</code> .                   .     ,    .  <code>Synthesis::OnParamChange</code>    <code>switch</code> : <br> <br> <code class="cpp">case mFilterAttack: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK, GetParam(paramIdx)-&gt;Value()); break; case mFilterDecay: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_DECAY, GetParam(paramIdx)-&gt;Value()); break; case mFilterSustain: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_SUSTAIN, GetParam(paramIdx)-&gt;Value()); break; case mFilterRelease: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE, GetParam(paramIdx)-&gt;Value()); break; case mFilterEnvelopeAmount: filterEnvelopeAmount = GetParam(paramIdx)-&gt;Value(); break;</code> <br> <br> ! <br>     !           (-   C1),   : <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/f5d/757/3f9/f5d7573f9b3a720fe5898d88ae477cfc.png"> <br> <br>        <code>EnvelopeGenerator</code>  .         .        ! <br> <br>    <a href=""></a> . <br> <br>        :) <br> <br>  : <br> <a href="http://martin-finke.de/blog/articles/audio-plugins-013-filter/">martin-finke.de/blog/articles/audio-plugins-<span class="hljs-number"><span class="hljs-number">013</span></span>-filter</a></code></code> </pre> <code><code class="cpp">#include  <i>Filter.h</i> ( )     : <br> <br> class Filter { public: enum FilterMode { FILTER_MODE_LOWPASS = 0, FILTER_MODE_HIGHPASS, FILTER_MODE_BANDPASS, kNumFilterModes }; Filter() : cutoff(0.99), resonance(0.0), mode(FILTER_MODE_LOWPASS), buf0(0.0), buf1(0.0) { calculateFeedbackAmount(); }; double process(double inputValue); inline void setCutoff(double newCutoff) { cutoff = newCutoff; calculateFeedbackAmount(); }; inline void setResonance(double newResonance) { resonance = newResonance; calculateFeedbackAmount(); }; inline void setFilterMode(FilterMode newMode) { mode = newMode; } private: double cutoff; double resonance; FilterMode mode; double feedbackAmount; inline void calculateFeedbackAmount() { feedbackAmount = resonance + resonance/(1.0 - cutoff); } double buf0; double buf1; };</code> <br> <br>  <code>private</code>     <i> </i> <code>cutoff</code>  <i></i> <code>resonance</code> . <code>Mode</code>      (Lowpass, Highpass, Bandpass).  <code>feedbackAmount</code> , <code>buf0</code>  <code>buf1</code>    ,    . <br>          ( <code>calculateFeedbackAmount()</code> ).  <code>process</code>      .   <code>feedbackAmount</code>   <code>cutoff</code>  <code>resonance</code> ,    <code>calculateFeedbackAmount</code>      . <br> <br>   <i>Filter.cpp</i>  : <br> <br> <code class="cpp">// By Paul Kellett // http://www.musicdsp.org/showone.php?id=29 double Filter::process(double inputValue) { buf0 += cutoff * (inputValue - buf0); buf1 += cutoff * (buf0 - buf1); switch (mode) { case FILTER_MODE_LOWPASS: return buf1; case FILTER_MODE_HIGHPASS: return inputValue - buf0; case FILTER_MODE_BANDPASS: return buf0 - buf1; default: return 0.0; } }</code> <br> <br> , ?  ,         <i> </i> . ¬´ ¬ª   ,               (. .    6 ).     <code>buf0</code>  <code>buf1</code> :        .     <code>inputValue</code> ,  - <code>buf0</code> (  ).   .    6 /   12 /.  <code>switch</code> ,  <code>buf1</code>    . , ,    <code>buf0</code> ,       12,   6 /,        . <br> <br>  <code>case</code> <code>FILTER_MODE_HIGHPASS</code>    . <code>buf0</code>       .   <code>inputValue</code>  <code>buf0</code> ,   .    <code>buf1</code> ,     . <br> <br>  <code>case</code> <code>FILTER_MODE_BANDPASS</code> ,  <code>buf0 - buf1</code>   .  <code>buf0</code>       ,     <code>buf1</code> . ,   . <br>  :    <i> </i>    <i> </i> ,   . <br> <br>  <code>buf1</code>     .       <a href="http://ru.wikipedia.org/wiki/%25D0%25A4%25D0%25B8%25D0%25BB%25D1%258C%25D1%2582%25D1%2580_%25D1%2581_%25D0%25B1%25D0%25B5%25D1%2581%25D0%25BA%25D0%25BE%25D0%25BD%25D0%25B5%25D1%2587%25D0%25BD%25D0%25BE%25D0%25B9_%25D0%25B8%25D0%25BC%25D0%25BF%25D1%2583%25D0%25BB%25D1%258C%25D1%2581%25D0%25BD%25D0%25BE%25D0%25B9_%25D1%2585%25D0%25B0%25D1%2580%25D0%25B0%25D0%25BA%25D1%2582%25D0%25B5%25D1%2580%25D0%25B8%25D1%2581%25D1%2582%25D0%25B8%25D0%25BA%25D0%25BE%25D0%25B9">    </a> ( <i>Infinite Impulse Response</i> ,  <i>IIR</i> ).  <a href="http://www.dspguide.com/ch14/1.htm"> </a> ,      .      ,         ,      . <br> <br>   <br>       ,     ,     .   ,  ,      ,  ,          .           ,  NI Massive,   ¬´ <a href="http://lurkmore.to/%25D0%25A2%25D1%2591%25D0%25BF%25D0%25BB%25D1%258B%25D0%25B9_%25D0%25BB%25D0%25B0%25D0%25BC%25D0%25BF%25D0%25BE%25D0%25B2%25D1%258B%25D0%25B9_%25D0%25B7%25D0%25B2%25D1%2583%25D0%25BA">  </a> ¬ª.       ,          ,   .        ,          (  Massive       ).      ¬´¬ª , , , AAS Ultra Analog,       ,     ,    ,        .         ,  ,    <a href="http://www.kvraudio.com/forum/viewtopic.php%3Ft%3D350246"></a> ,   ,      NI Reaktor. ,            ‚Äî    ,    ..     . <br> <br>   <br>     .   GUI.  <i>bg.png</i>   ( <i>‚ÄúMove to trash‚Äù</i>  Xcode),       : <br> <br> <a href="">filtermode.png</a> <a href="">knob_small.png</a> (  ,   50 50 ) <a href="">bg.png</a> (       ) <br> <br>    ID  <i>resource.h</i> : <br> <br> <code class="cpp">// Unique IDs for each image resource. #define BG_ID 101 #define WHITE_KEY_ID 102 #define BLACK_KEY_ID 103 #define WAVEFORM_ID 104 #define KNOB_ID 105 #define KNOB_SMALL_ID 106 #define FILTERMODE_ID 107 // Image resource locations for this plug. #define BG_FN "resources/img/bg.png" #define WHITE_KEY_FN "resources/img/whitekey.png" #define BLACK_KEY_FN "resources/img/blackkey.png" #define WAVEFORM_FN "resources/img/waveform.png" #define KNOB_FN "resources/img/knob.png" #define KNOB_SMALL_FN "resources/img/knob_small.png" #define FILTERMODE_FN "resources/img/filtermode.png"</code> <br> <br>  <i>Synthesis.rc</i> : <br> <br> <code class="cpp">#include "resource.h" BG_ID PNG BG_FN WHITE_KEY_ID PNG WHITE_KEY_FN BLACK_KEY_ID PNG BLACK_KEY_FN WAVEFORM_ID PNG WAVEFORM_FN KNOB_ID PNG KNOB_FN KNOB_SMALL_ID PNG KNOB_SMALL_FN FILTERMODE_ID PNG FILTERMODE_FN</code> <br> <br>   <code>#include "Filter.h"</code>  <i>Synthesis.h</i>    <code>private</code> : <br> <br> <code class="cpp">Filter mFilter;</code> <br> <br>  <code>EParams</code>  <i>Synthesis.cpp</i> : <br> <br> <code class="cpp">enum EParams { mWaveform = 0, mAttack, mDecay, mSustain, mRelease, mFilterMode, mFilterCutoff, mFilterResonance, mFilterAttack, mFilterDecay, mFilterSustain, mFilterRelease, mFilterEnvelopeAmount, kNumParams };</code> <br> <br>        : <br> <br> <code class="cpp">pGraphics-&gt;AttachControl(new ISwitchControl(this, 24, 38, mWaveform, &amp;waveformBitmap));</code> <br> <br>      .      (Lowpass, Highpass, Bandpass).    <code>AttachGraphics(pGraphics)</code> : <br> <br> <code class="cpp">GetParam(mFilterMode)-&gt;InitEnum("Filter Mode", Filter::FILTER_MODE_LOWPASS, Filter::kNumFilterModes); IBitmap filtermodeBitmap = pGraphics-&gt;LoadIBitmap(FILTERMODE_ID, FILTERMODE_FN, 3); pGraphics-&gt;AttachControl(new ISwitchControl(this, 24, 123, mFilterMode, &amp;filtermodeBitmap));</code> <br> <br>         .    .     <i>knob_small.png</i> : <br> <br> <code class="cpp">// Knobs for filter cutoff and resonance IBitmap smallKnobBitmap = pGraphics-&gt;LoadIBitmap(KNOB_SMALL_ID, KNOB_SMALL_FN, 64); // Cutoff knob: GetParam(mFilterCutoff)-&gt;InitDouble("Cutoff", 0.99, 0.01, 0.99, 0.001); GetParam(mFilterCutoff)-&gt;SetShape(2); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 5, 177, mFilterCutoff, &amp;smallKnobBitmap)); // Resonance knob: GetParam(mFilterResonance)-&gt;InitDouble("Resonance", 0.01, 0.01, 1.0, 0.001); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 61, 177, mFilterResonance, &amp;smallKnobBitmap));</code> <br> <br>   ,           <code>1.0</code> ,   <code>calculateFeedbackAmount</code>    , . <br>  <code>ProcessDoubleReplacing</code>     : <br> <br> <code class="cpp">leftOutput[i] = rightOutput[i] = mFilter.process(mOscillator.nextSample() * mEnvelopeGenerator.nextSample() * velocity / 127.0);</code> <br> <br>       .  <code>switch</code>   <code>Synthesis::OnParamChange</code> : <br> <br> <code class="cpp">case mFilterCutoff: mFilter.setCutoff(GetParam(paramIdx)-&gt;Value()); break; case mFilterResonance: mFilter.setResonance(GetParam(paramIdx)-&gt;Value()); break; case mFilterMode: mFilter.setFilterMode(static_cast&lt;Filter::FilterMode&gt;(GetParam(paramIdx)-&gt;Int())); break;</code> <br> <br>    .  -      . <br> <br>  <br> <br>  ‚Äî      .   ,   ,          . <br>      : <br> <br> <code class="cpp">buf0 += cutoff * (inputValue - buf0 + feedbackAmount * (buf0 - buf1));</code> <br> <br> ,   ,      ( <code>buf0 ‚Äì buf1</code> ),   <code>feedbackAmount</code> .    <code>calculateFeedbackAmount</code>  <code>feedbackAmount</code>  <code>resonance</code> , . .    ,   . <br> <br>  ,            .     ,  <i></i> ,      <a href="https://www.youtube.com/watch%3Fv%3DJWyMj6KxGHM"> </a> .    ,        ,       . <br> <br>  -12 /  -24 / <br>        !     24   .     <code>switch</code>  <code>Filter::process</code> : <br> <br> <code class="cpp">buf2 += cutoff * (buf1 - buf2); buf3 += cutoff * (buf2 ‚Äì buf3);</code> <br> <br>   :      ,       ,            .     ,       , , <a href="https://ccrma.stanford.edu/~Jos/filters/Filter_Stability.html"></a> (       ).     <code>switch</code> : <br> <br> <code class="cpp">switch (mode) { case FILTER_MODE_LOWPASS: return buf3; case FILTER_MODE_HIGHPASS: return inputValue - buf3; case FILTER_MODE_BANDPASS: return buf0 - buf3; default: return 0.0; }</code> <br> <br>   <code>buf1</code>  <code>buf3</code> ‚Äì      .    -24 /.     <code>buf2</code>  <code>buf3</code> ,        <code>private</code> <i>Filter.h</i> : <br> <br> <code class="cpp">double buf2; double buf3;</code> <br> <br>    ,   <code>buf0</code> c <code>buf1</code> : <br> <br> <code class="cpp">Filter() : // ... buf0(0.0), buf1(0.0), buf2(0.0), buf3(0.0) // ...</code> <br> <br>     , ,     :     .       . <br>          ? <br> <br>   <br>    .  ,           ,       . <br> -      <code>cutoff</code>   .      .    <code>cutoffMod</code> ,    ,       <code>cutoff</code>    .     <code><code>#include    private</code> : <br> <br> <code class="cpp">double cutoffMod;</code> <br> <br> : <br> <br> <code class="cpp">Filter() : cutoff(0.99), resonance(0.01), cutoffMod(0.0), // ...</code> <br> <br>         .   <code>private</code> : <br> <br> <code class="cpp">inline double getCalculatedCutoff() const { return fmax(fmin(cutoff + cutoffMod, 0.99), 0.01); };</code> <br> <br> <code>calculateFeedbackAmount</code>     : <br> <br> <code class="cpp">inline void calculateFeedbackAmount() { feedbackAmount = resonance + resonance/(1.0 - getCalculatedCutoff()); }</code> <br> <br>       <code>cutoffMod</code> .   <code>feedbackAmount</code>    ,     : <br> <br> <code class="cpp">inline void setCutoffMod(double newCutoffMod) { cutoffMod = newCutoffMod; calculateFeedbackAmount(); }</code> <br> <br> ,       .   <code>Filter::process</code>   : <br> <br> <code class="cpp">if (inputValue == 0.0) return inputValue; double calculatedCutoff = getCalculatedCutoff(); buf0 += calculatedCutoff * (inputValue - buf0 + feedbackAmount * (buf0 - buf1)); buf1 += calculatedCutoff * (buf0 - buf1); buf2 += calculatedCutoff * (buf1 - buf2); buf3 += calculatedCutoff * (buf2 ‚Äì buf3);</code> <br> <br>        ,    .    ,      ,   .     .     <code>cutoff</code>  <code>calculatedCutoff</code>   -. <br> <br> ,       ( <code>setCutoffMod</code> ),   <code>Synthesis</code>    ,     ,    .    ,        <code>cutoffMod</code> .    <code>filterEnvelopeAmount</code>    <code>-1</code>  <code>+1</code> .   GUI. <br> <br>   <code>private</code> <i>Synthesis.h</i>    : <br> <br> <code class="cpp">EnvelopeGenerator mFilterEnvelopeGenerator; double filterEnvelopeAmount;</code> <br> <br>       MIDI ,      <code>onNoteOn</code>  <code>onNoteOff</code> : <br> <br> <code class="cpp">inline void onNoteOn(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); mFilterEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); }; inline void onNoteOff(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); mFilterEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); };</code> <br> <br>    .   <code>ProcessDoubleReplacing</code>        : <br> <br> <code class="cpp">mFilter.setCutoffMod(mFilterEnvelopeGenerator.nextSample() * filterEnvelopeAmount);</code> <br> <br>  ,        <code>nextSample</code>  <code>filterEnvelopeAmount</code>     <code>cutoffMod</code> .     <code>filterEnvelopeAmount</code>  : <br> <br> <code class="cpp">Synthesis::Synthesis(IPlugInstanceInfo instanceInfo) : IPLUG_CTOR(kNumParams, kNumPrograms, instanceInfo), lastVirtualKeyboardNoteNumber(virtualKeyboardMinimumNoteNumber - 1), filterEnvelopeAmount(0.0) { // ... }</code> <br> <br>       <code>Synthesis::Reset</code> : <br> <br> <code class="cpp">mFilterEnvelopeGenerator.setSampleRate(GetSampleRate());</code> <br> <br>      <code>EParams</code> ,       .  <code>AttachGraphics</code>     : <br> <br> <code class="cpp">// Knobs for filter envelope // Attack knob GetParam(mFilterAttack)-&gt;InitDouble("Filter Env Attack", 0.01, 0.01, 10.0, 0.001); GetParam(mFilterAttack)-&gt;SetShape(3); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 139, 178, mFilterAttack, &amp;smallKnobBitmap)); // Decay knob: GetParam(mFilterDecay)-&gt;InitDouble("Filter Env Decay", 0.5, 0.01, 15.0, 0.001); GetParam(mFilterDecay)-&gt;SetShape(3); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 195, 178, mFilterDecay, &amp;smallKnobBitmap)); // Sustain knob: GetParam(mFilterSustain)-&gt;InitDouble("Filter Env Sustain", 0.1, 0.001, 1.0, 0.001); GetParam(mFilterSustain)-&gt;SetShape(2); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 251, 178, mFilterSustain, &amp;smallKnobBitmap)); // Release knob: GetParam(mFilterRelease)-&gt;InitDouble("Filter Env Release", 1.0, 0.001, 15.0, 0.001); GetParam(mFilterRelease)-&gt;SetShape(3); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 307, 178, mFilterRelease, &amp;smallKnobBitmap)); // Filter envelope amount knob: GetParam(mFilterEnvelopeAmount)-&gt;InitDouble("Filter Env Amount", 0.0, -1.0, 1.0, 0.001); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 363, 178, mFilterEnvelopeAmount, &amp;smallKnobBitmap));</code> <br> <br>     ,       <code>smallKnobBitmap</code> .                   .     ,    .  <code>Synthesis::OnParamChange</code>    <code>switch</code> : <br> <br> <code class="cpp">case mFilterAttack: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK, GetParam(paramIdx)-&gt;Value()); break; case mFilterDecay: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_DECAY, GetParam(paramIdx)-&gt;Value()); break; case mFilterSustain: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_SUSTAIN, GetParam(paramIdx)-&gt;Value()); break; case mFilterRelease: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE, GetParam(paramIdx)-&gt;Value()); break; case mFilterEnvelopeAmount: filterEnvelopeAmount = GetParam(paramIdx)-&gt;Value(); break;</code> <br> <br> ! <br>     !           (-   C1),   : <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/f5d/757/3f9/f5d7573f9b3a720fe5898d88ae477cfc.png"> <br> <br>        <code>EnvelopeGenerator</code>  .         .        ! <br> <br>    <a href=""></a> . <br> <br>        :) <br> <br>  : <br> <a href="http://martin-finke.de/blog/articles/audio-plugins-013-filter/">martin-finke.de/blog/articles/audio-plugins-013-filter</a></code></code> <h3> <code><code class="cpp">#include  <i>Filter.h</i> ( )     : <br> <br> class Filter { public: enum FilterMode { FILTER_MODE_LOWPASS = 0, FILTER_MODE_HIGHPASS, FILTER_MODE_BANDPASS, kNumFilterModes }; Filter() : cutoff(0.99), resonance(0.0), mode(FILTER_MODE_LOWPASS), buf0(0.0), buf1(0.0) { calculateFeedbackAmount(); }; double process(double inputValue); inline void setCutoff(double newCutoff) { cutoff = newCutoff; calculateFeedbackAmount(); }; inline void setResonance(double newResonance) { resonance = newResonance; calculateFeedbackAmount(); }; inline void setFilterMode(FilterMode newMode) { mode = newMode; } private: double cutoff; double resonance; FilterMode mode; double feedbackAmount; inline void calculateFeedbackAmount() { feedbackAmount = resonance + resonance/(1.0 - cutoff); } double buf0; double buf1; };</code> <br> <br>  <code>private</code>     <i> </i> <code>cutoff</code>  <i></i> <code>resonance</code> . <code>Mode</code>      (Lowpass, Highpass, Bandpass).  <code>feedbackAmount</code> , <code>buf0</code>  <code>buf1</code>    ,    . <br>          ( <code>calculateFeedbackAmount()</code> ).  <code>process</code>      .   <code>feedbackAmount</code>   <code>cutoff</code>  <code>resonance</code> ,    <code>calculateFeedbackAmount</code>      . <br> <br>   <i>Filter.cpp</i>  : <br> <br> <code class="cpp">// By Paul Kellett // http://www.musicdsp.org/showone.php?id=29 double Filter::process(double inputValue) { buf0 += cutoff * (inputValue - buf0); buf1 += cutoff * (buf0 - buf1); switch (mode) { case FILTER_MODE_LOWPASS: return buf1; case FILTER_MODE_HIGHPASS: return inputValue - buf0; case FILTER_MODE_BANDPASS: return buf0 - buf1; default: return 0.0; } }</code> <br> <br> , ?  ,         <i> </i> . ¬´ ¬ª   ,               (. .    6 ).     <code>buf0</code>  <code>buf1</code> :        .     <code>inputValue</code> ,  - <code>buf0</code> (  ).   .    6 /   12 /.  <code>switch</code> ,  <code>buf1</code>    . , ,    <code>buf0</code> ,       12,   6 /,        . <br> <br>  <code>case</code> <code>FILTER_MODE_HIGHPASS</code>    . <code>buf0</code>       .   <code>inputValue</code>  <code>buf0</code> ,   .    <code>buf1</code> ,     . <br> <br>  <code>case</code> <code>FILTER_MODE_BANDPASS</code> ,  <code>buf0 - buf1</code>   .  <code>buf0</code>       ,     <code>buf1</code> . ,   . <br>  :    <i> </i>    <i> </i> ,   . <br> <br>  <code>buf1</code>     .       <a href="http://ru.wikipedia.org/wiki/%25D0%25A4%25D0%25B8%25D0%25BB%25D1%258C%25D1%2582%25D1%2580_%25D1%2581_%25D0%25B1%25D0%25B5%25D1%2581%25D0%25BA%25D0%25BE%25D0%25BD%25D0%25B5%25D1%2587%25D0%25BD%25D0%25BE%25D0%25B9_%25D0%25B8%25D0%25BC%25D0%25BF%25D1%2583%25D0%25BB%25D1%258C%25D1%2581%25D0%25BD%25D0%25BE%25D0%25B9_%25D1%2585%25D0%25B0%25D1%2580%25D0%25B0%25D0%25BA%25D1%2582%25D0%25B5%25D1%2580%25D0%25B8%25D1%2581%25D1%2582%25D0%25B8%25D0%25BA%25D0%25BE%25D0%25B9">    </a> ( <i>Infinite Impulse Response</i> ,  <i>IIR</i> ).  <a href="http://www.dspguide.com/ch14/1.htm"> </a> ,      .      ,         ,      . <br> <br>   <br>       ,     ,     .   ,  ,      ,  ,          .           ,  NI Massive,   ¬´ <a href="http://lurkmore.to/%25D0%25A2%25D1%2591%25D0%25BF%25D0%25BB%25D1%258B%25D0%25B9_%25D0%25BB%25D0%25B0%25D0%25BC%25D0%25BF%25D0%25BE%25D0%25B2%25D1%258B%25D0%25B9_%25D0%25B7%25D0%25B2%25D1%2583%25D0%25BA">  </a> ¬ª.       ,          ,   .        ,          (  Massive       ).      ¬´¬ª , , , AAS Ultra Analog,       ,     ,    ,        .         ,  ,    <a href="http://www.kvraudio.com/forum/viewtopic.php%3Ft%3D350246"></a> ,   ,      NI Reaktor. ,            ‚Äî    ,    ..     . <br> <br>   <br>     .   GUI.  <i>bg.png</i>   ( <i>‚ÄúMove to trash‚Äù</i>  Xcode),       : <br> <br> <a href="">filtermode.png</a> <a href="">knob_small.png</a> (  ,   50 50 ) <a href="">bg.png</a> (       ) <br> <br>    ID  <i>resource.h</i> : <br> <br> <code class="cpp">// Unique IDs for each image resource. #define BG_ID 101 #define WHITE_KEY_ID 102 #define BLACK_KEY_ID 103 #define WAVEFORM_ID 104 #define KNOB_ID 105 #define KNOB_SMALL_ID 106 #define FILTERMODE_ID 107 // Image resource locations for this plug. #define BG_FN "resources/img/bg.png" #define WHITE_KEY_FN "resources/img/whitekey.png" #define BLACK_KEY_FN "resources/img/blackkey.png" #define WAVEFORM_FN "resources/img/waveform.png" #define KNOB_FN "resources/img/knob.png" #define KNOB_SMALL_FN "resources/img/knob_small.png" #define FILTERMODE_FN "resources/img/filtermode.png"</code> <br> <br>  <i>Synthesis.rc</i> : <br> <br> <code class="cpp">#include "resource.h" BG_ID PNG BG_FN WHITE_KEY_ID PNG WHITE_KEY_FN BLACK_KEY_ID PNG BLACK_KEY_FN WAVEFORM_ID PNG WAVEFORM_FN KNOB_ID PNG KNOB_FN KNOB_SMALL_ID PNG KNOB_SMALL_FN FILTERMODE_ID PNG FILTERMODE_FN</code> <br> <br>   <code>#include "Filter.h"</code>  <i>Synthesis.h</i>    <code>private</code> : <br> <br> <code class="cpp">Filter mFilter;</code> <br> <br>  <code>EParams</code>  <i>Synthesis.cpp</i> : <br> <br> <code class="cpp">enum EParams { mWaveform = 0, mAttack, mDecay, mSustain, mRelease, mFilterMode, mFilterCutoff, mFilterResonance, mFilterAttack, mFilterDecay, mFilterSustain, mFilterRelease, mFilterEnvelopeAmount, kNumParams };</code> <br> <br>        : <br> <br> <code class="cpp">pGraphics-&gt;AttachControl(new ISwitchControl(this, 24, 38, mWaveform, &amp;waveformBitmap));</code> <br> <br>      .      (Lowpass, Highpass, Bandpass).    <code>AttachGraphics(pGraphics)</code> : <br> <br> <code class="cpp">GetParam(mFilterMode)-&gt;InitEnum("Filter Mode", Filter::FILTER_MODE_LOWPASS, Filter::kNumFilterModes); IBitmap filtermodeBitmap = pGraphics-&gt;LoadIBitmap(FILTERMODE_ID, FILTERMODE_FN, 3); pGraphics-&gt;AttachControl(new ISwitchControl(this, 24, 123, mFilterMode, &amp;filtermodeBitmap));</code> <br> <br>         .    .     <i>knob_small.png</i> : <br> <br> <code class="cpp">// Knobs for filter cutoff and resonance IBitmap smallKnobBitmap = pGraphics-&gt;LoadIBitmap(KNOB_SMALL_ID, KNOB_SMALL_FN, 64); // Cutoff knob: GetParam(mFilterCutoff)-&gt;InitDouble("Cutoff", 0.99, 0.01, 0.99, 0.001); GetParam(mFilterCutoff)-&gt;SetShape(2); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 5, 177, mFilterCutoff, &amp;smallKnobBitmap)); // Resonance knob: GetParam(mFilterResonance)-&gt;InitDouble("Resonance", 0.01, 0.01, 1.0, 0.001); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 61, 177, mFilterResonance, &amp;smallKnobBitmap));</code> <br> <br>   ,           <code>1.0</code> ,   <code>calculateFeedbackAmount</code>    , . <br>  <code>ProcessDoubleReplacing</code>     : <br> <br> <code class="cpp">leftOutput[i] = rightOutput[i] = mFilter.process(mOscillator.nextSample() * mEnvelopeGenerator.nextSample() * velocity / 127.0);</code> <br> <br>       .  <code>switch</code>   <code>Synthesis::OnParamChange</code> : <br> <br> <code class="cpp">case mFilterCutoff: mFilter.setCutoff(GetParam(paramIdx)-&gt;Value()); break; case mFilterResonance: mFilter.setResonance(GetParam(paramIdx)-&gt;Value()); break; case mFilterMode: mFilter.setFilterMode(static_cast&lt;Filter::FilterMode&gt;(GetParam(paramIdx)-&gt;Int())); break;</code> <br> <br>    .  -      . <br> <br>  <br> <br>  ‚Äî      .   ,   ,          . <br>      : <br> <br> <code class="cpp">buf0 += cutoff * (inputValue - buf0 + feedbackAmount * (buf0 - buf1));</code> <br> <br> ,   ,      ( <code>buf0 ‚Äì buf1</code> ),   <code>feedbackAmount</code> .    <code>calculateFeedbackAmount</code>  <code>feedbackAmount</code>  <code>resonance</code> , . .    ,   . <br> <br>  ,            .     ,  <i></i> ,      <a href="https://www.youtube.com/watch%3Fv%3DJWyMj6KxGHM"> </a> .    ,        ,       . <br> <br>  -12 /  -24 / <br>        !     24   .     <code>switch</code>  <code>Filter::process</code> : <br> <br> <code class="cpp">buf2 += cutoff * (buf1 - buf2); buf3 += cutoff * (buf2 ‚Äì buf3);</code> <br> <br>   :      ,       ,            .     ,       , , <a href="https://ccrma.stanford.edu/~Jos/filters/Filter_Stability.html"></a> (       ).     <code>switch</code> : <br> <br> <code class="cpp">switch (mode) { case FILTER_MODE_LOWPASS: return buf3; case FILTER_MODE_HIGHPASS: return inputValue - buf3; case FILTER_MODE_BANDPASS: return buf0 - buf3; default: return 0.0; }</code> <br> <br>   <code>buf1</code>  <code>buf3</code> ‚Äì      .    -24 /.     <code>buf2</code>  <code>buf3</code> ,        <code>private</code> <i>Filter.h</i> : <br> <br> <code class="cpp">double buf2; double buf3;</code> <br> <br>    ,   <code>buf0</code> c <code>buf1</code> : <br> <br> <code class="cpp">Filter() : // ... buf0(0.0), buf1(0.0), buf2(0.0), buf3(0.0) // ...</code> <br> <br>     , ,     :     .       . <br>          ? <br> <br>   <br>    .  ,           ,       . <br> -      <code>cutoff</code>   .      .    <code>cutoffMod</code> ,    ,       <code>cutoff</code>    .     <code><code>#include    private</code> : <br> <br> <code class="cpp">double cutoffMod;</code> <br> <br> : <br> <br> <code class="cpp">Filter() : cutoff(0.99), resonance(0.01), cutoffMod(0.0), // ...</code> <br> <br>         .   <code>private</code> : <br> <br> <code class="cpp">inline double getCalculatedCutoff() const { return fmax(fmin(cutoff + cutoffMod, 0.99), 0.01); };</code> <br> <br> <code>calculateFeedbackAmount</code>     : <br> <br> <code class="cpp">inline void calculateFeedbackAmount() { feedbackAmount = resonance + resonance/(1.0 - getCalculatedCutoff()); }</code> <br> <br>       <code>cutoffMod</code> .   <code>feedbackAmount</code>    ,     : <br> <br> <code class="cpp">inline void setCutoffMod(double newCutoffMod) { cutoffMod = newCutoffMod; calculateFeedbackAmount(); }</code> <br> <br> ,       .   <code>Filter::process</code>   : <br> <br> <code class="cpp">if (inputValue == 0.0) return inputValue; double calculatedCutoff = getCalculatedCutoff(); buf0 += calculatedCutoff * (inputValue - buf0 + feedbackAmount * (buf0 - buf1)); buf1 += calculatedCutoff * (buf0 - buf1); buf2 += calculatedCutoff * (buf1 - buf2); buf3 += calculatedCutoff * (buf2 ‚Äì buf3);</code> <br> <br>        ,    .    ,      ,   .     .     <code>cutoff</code>  <code>calculatedCutoff</code>   -. <br> <br> ,       ( <code>setCutoffMod</code> ),   <code>Synthesis</code>    ,     ,    .    ,        <code>cutoffMod</code> .    <code>filterEnvelopeAmount</code>    <code>-1</code>  <code>+1</code> .   GUI. <br> <br>   <code>private</code> <i>Synthesis.h</i>    : <br> <br> <code class="cpp">EnvelopeGenerator mFilterEnvelopeGenerator; double filterEnvelopeAmount;</code> <br> <br>       MIDI ,      <code>onNoteOn</code>  <code>onNoteOff</code> : <br> <br> <code class="cpp">inline void onNoteOn(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); mFilterEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); }; inline void onNoteOff(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); mFilterEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); };</code> <br> <br>    .   <code>ProcessDoubleReplacing</code>        : <br> <br> <code class="cpp">mFilter.setCutoffMod(mFilterEnvelopeGenerator.nextSample() * filterEnvelopeAmount);</code> <br> <br>  ,        <code>nextSample</code>  <code>filterEnvelopeAmount</code>     <code>cutoffMod</code> .     <code>filterEnvelopeAmount</code>  : <br> <br> <code class="cpp">Synthesis::Synthesis(IPlugInstanceInfo instanceInfo) : IPLUG_CTOR(kNumParams, kNumPrograms, instanceInfo), lastVirtualKeyboardNoteNumber(virtualKeyboardMinimumNoteNumber - 1), filterEnvelopeAmount(0.0) { // ... }</code> <br> <br>       <code>Synthesis::Reset</code> : <br> <br> <code class="cpp">mFilterEnvelopeGenerator.setSampleRate(GetSampleRate());</code> <br> <br>      <code>EParams</code> ,       .  <code>AttachGraphics</code>     : <br> <br> <code class="cpp">// Knobs for filter envelope // Attack knob GetParam(mFilterAttack)-&gt;InitDouble("Filter Env Attack", 0.01, 0.01, 10.0, 0.001); GetParam(mFilterAttack)-&gt;SetShape(3); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 139, 178, mFilterAttack, &amp;smallKnobBitmap)); // Decay knob: GetParam(mFilterDecay)-&gt;InitDouble("Filter Env Decay", 0.5, 0.01, 15.0, 0.001); GetParam(mFilterDecay)-&gt;SetShape(3); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 195, 178, mFilterDecay, &amp;smallKnobBitmap)); // Sustain knob: GetParam(mFilterSustain)-&gt;InitDouble("Filter Env Sustain", 0.1, 0.001, 1.0, 0.001); GetParam(mFilterSustain)-&gt;SetShape(2); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 251, 178, mFilterSustain, &amp;smallKnobBitmap)); // Release knob: GetParam(mFilterRelease)-&gt;InitDouble("Filter Env Release", 1.0, 0.001, 15.0, 0.001); GetParam(mFilterRelease)-&gt;SetShape(3); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 307, 178, mFilterRelease, &amp;smallKnobBitmap)); // Filter envelope amount knob: GetParam(mFilterEnvelopeAmount)-&gt;InitDouble("Filter Env Amount", 0.0, -1.0, 1.0, 0.001); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 363, 178, mFilterEnvelopeAmount, &amp;smallKnobBitmap));</code> <br> <br>     ,       <code>smallKnobBitmap</code> .                   .     ,    .  <code>Synthesis::OnParamChange</code>    <code>switch</code> : <br> <br> <code class="cpp">case mFilterAttack: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK, GetParam(paramIdx)-&gt;Value()); break; case mFilterDecay: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_DECAY, GetParam(paramIdx)-&gt;Value()); break; case mFilterSustain: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_SUSTAIN, GetParam(paramIdx)-&gt;Value()); break; case mFilterRelease: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE, GetParam(paramIdx)-&gt;Value()); break; case mFilterEnvelopeAmount: filterEnvelopeAmount = GetParam(paramIdx)-&gt;Value(); break;</code> <br> <br> ! <br>     !           (-   C1),   : <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/f5d/757/3f9/f5d7573f9b3a720fe5898d88ae477cfc.png"> <br> <br>        <code>EnvelopeGenerator</code>  .         .        ! <br> <br>    <a href=""></a> . <br> <br>        :) <br> <br>  : <br> <a href="http://martin-finke.de/blog/articles/audio-plugins-013-filter/">martin-finke.de/blog/articles/audio-plugins-013-filter</a></code></code> </h3> <code><code class="cpp">#include  <i>Filter.h</i> ( )     : <br> <br> class Filter { public: enum FilterMode { FILTER_MODE_LOWPASS = 0, FILTER_MODE_HIGHPASS, FILTER_MODE_BANDPASS, kNumFilterModes }; Filter() : cutoff(0.99), resonance(0.0), mode(FILTER_MODE_LOWPASS), buf0(0.0), buf1(0.0) { calculateFeedbackAmount(); }; double process(double inputValue); inline void setCutoff(double newCutoff) { cutoff = newCutoff; calculateFeedbackAmount(); }; inline void setResonance(double newResonance) { resonance = newResonance; calculateFeedbackAmount(); }; inline void setFilterMode(FilterMode newMode) { mode = newMode; } private: double cutoff; double resonance; FilterMode mode; double feedbackAmount; inline void calculateFeedbackAmount() { feedbackAmount = resonance + resonance/(1.0 - cutoff); } double buf0; double buf1; };</code> <br> <br>  <code>private</code>     <i> </i> <code>cutoff</code>  <i></i> <code>resonance</code> . <code>Mode</code>      (Lowpass, Highpass, Bandpass).  <code>feedbackAmount</code> , <code>buf0</code>  <code>buf1</code>    ,    . <br>          ( <code>calculateFeedbackAmount()</code> ).  <code>process</code>      .   <code>feedbackAmount</code>   <code>cutoff</code>  <code>resonance</code> ,    <code>calculateFeedbackAmount</code>      . <br> <br>   <i>Filter.cpp</i>  : <br> <br> <code class="cpp">// By Paul Kellett // http://www.musicdsp.org/showone.php?id=29 double Filter::process(double inputValue) { buf0 += cutoff * (inputValue - buf0); buf1 += cutoff * (buf0 - buf1); switch (mode) { case FILTER_MODE_LOWPASS: return buf1; case FILTER_MODE_HIGHPASS: return inputValue - buf0; case FILTER_MODE_BANDPASS: return buf0 - buf1; default: return 0.0; } }</code> <br> <br> , ?  ,         <i> </i> . ¬´ ¬ª   ,               (. .    6 ).     <code>buf0</code>  <code>buf1</code> :        .     <code>inputValue</code> ,  - <code>buf0</code> (  ).   .    6 /   12 /.  <code>switch</code> ,  <code>buf1</code>    . , ,    <code>buf0</code> ,       12,   6 /,        . <br> <br>  <code>case</code> <code>FILTER_MODE_HIGHPASS</code>    . <code>buf0</code>       .   <code>inputValue</code>  <code>buf0</code> ,   .    <code>buf1</code> ,     . <br> <br>  <code>case</code> <code>FILTER_MODE_BANDPASS</code> ,  <code>buf0 - buf1</code>   .  <code>buf0</code>       ,     <code>buf1</code> . ,   . <br>  :    <i> </i>    <i> </i> ,   . <br> <br>  <code>buf1</code>     .       <a href="http://ru.wikipedia.org/wiki/%25D0%25A4%25D0%25B8%25D0%25BB%25D1%258C%25D1%2582%25D1%2580_%25D1%2581_%25D0%25B1%25D0%25B5%25D1%2581%25D0%25BA%25D0%25BE%25D0%25BD%25D0%25B5%25D1%2587%25D0%25BD%25D0%25BE%25D0%25B9_%25D0%25B8%25D0%25BC%25D0%25BF%25D1%2583%25D0%25BB%25D1%258C%25D1%2581%25D0%25BD%25D0%25BE%25D0%25B9_%25D1%2585%25D0%25B0%25D1%2580%25D0%25B0%25D0%25BA%25D1%2582%25D0%25B5%25D1%2580%25D0%25B8%25D1%2581%25D1%2582%25D0%25B8%25D0%25BA%25D0%25BE%25D0%25B9">    </a> ( <i>Infinite Impulse Response</i> ,  <i>IIR</i> ).  <a href="http://www.dspguide.com/ch14/1.htm"> </a> ,      .      ,         ,      . <br> <br>   <br>       ,     ,     .   ,  ,      ,  ,          .           ,  NI Massive,   ¬´ <a href="http://lurkmore.to/%25D0%25A2%25D1%2591%25D0%25BF%25D0%25BB%25D1%258B%25D0%25B9_%25D0%25BB%25D0%25B0%25D0%25BC%25D0%25BF%25D0%25BE%25D0%25B2%25D1%258B%25D0%25B9_%25D0%25B7%25D0%25B2%25D1%2583%25D0%25BA">  </a> ¬ª.       ,          ,   .        ,          (  Massive       ).      ¬´¬ª , , , AAS Ultra Analog,       ,     ,    ,        .         ,  ,    <a href="http://www.kvraudio.com/forum/viewtopic.php%3Ft%3D350246"></a> ,   ,      NI Reaktor. ,            ‚Äî    ,    ..     . <br> <br>   <br>     .   GUI.  <i>bg.png</i>   ( <i>‚ÄúMove to trash‚Äù</i>  Xcode),       : <br> <br> <a href="">filtermode.png</a> <a href="">knob_small.png</a> (  ,   50 50 ) <a href="">bg.png</a> (       ) <br> <br>    ID  <i>resource.h</i> : <br> <br> <code class="cpp">// Unique IDs for each image resource. #define BG_ID 101 #define WHITE_KEY_ID 102 #define BLACK_KEY_ID 103 #define WAVEFORM_ID 104 #define KNOB_ID 105 #define KNOB_SMALL_ID 106 #define FILTERMODE_ID 107 // Image resource locations for this plug. #define BG_FN "resources/img/bg.png" #define WHITE_KEY_FN "resources/img/whitekey.png" #define BLACK_KEY_FN "resources/img/blackkey.png" #define WAVEFORM_FN "resources/img/waveform.png" #define KNOB_FN "resources/img/knob.png" #define KNOB_SMALL_FN "resources/img/knob_small.png" #define FILTERMODE_FN "resources/img/filtermode.png"</code> <br> <br>  <i>Synthesis.rc</i> : <br> <br> <code class="cpp">#include "resource.h" BG_ID PNG BG_FN WHITE_KEY_ID PNG WHITE_KEY_FN BLACK_KEY_ID PNG BLACK_KEY_FN WAVEFORM_ID PNG WAVEFORM_FN KNOB_ID PNG KNOB_FN KNOB_SMALL_ID PNG KNOB_SMALL_FN FILTERMODE_ID PNG FILTERMODE_FN</code> <br> <br>   <code>#include "Filter.h"</code>  <i>Synthesis.h</i>    <code>private</code> : <br> <br> <code class="cpp">Filter mFilter;</code> <br> <br>  <code>EParams</code>  <i>Synthesis.cpp</i> : <br> <br> <code class="cpp">enum EParams { mWaveform = 0, mAttack, mDecay, mSustain, mRelease, mFilterMode, mFilterCutoff, mFilterResonance, mFilterAttack, mFilterDecay, mFilterSustain, mFilterRelease, mFilterEnvelopeAmount, kNumParams };</code> <br> <br>        : <br> <br> <code class="cpp">pGraphics-&gt;AttachControl(new ISwitchControl(this, 24, 38, mWaveform, &amp;waveformBitmap));</code> <br> <br>      .      (Lowpass, Highpass, Bandpass).    <code>AttachGraphics(pGraphics)</code> : <br> <br> <code class="cpp">GetParam(mFilterMode)-&gt;InitEnum("Filter Mode", Filter::FILTER_MODE_LOWPASS, Filter::kNumFilterModes); IBitmap filtermodeBitmap = pGraphics-&gt;LoadIBitmap(FILTERMODE_ID, FILTERMODE_FN, 3); pGraphics-&gt;AttachControl(new ISwitchControl(this, 24, 123, mFilterMode, &amp;filtermodeBitmap));</code> <br> <br>         .    .     <i>knob_small.png</i> : <br> <br> <code class="cpp">// Knobs for filter cutoff and resonance IBitmap smallKnobBitmap = pGraphics-&gt;LoadIBitmap(KNOB_SMALL_ID, KNOB_SMALL_FN, 64); // Cutoff knob: GetParam(mFilterCutoff)-&gt;InitDouble("Cutoff", 0.99, 0.01, 0.99, 0.001); GetParam(mFilterCutoff)-&gt;SetShape(2); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 5, 177, mFilterCutoff, &amp;smallKnobBitmap)); // Resonance knob: GetParam(mFilterResonance)-&gt;InitDouble("Resonance", 0.01, 0.01, 1.0, 0.001); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 61, 177, mFilterResonance, &amp;smallKnobBitmap));</code> <br> <br>   ,           <code>1.0</code> ,   <code>calculateFeedbackAmount</code>    , . <br>  <code>ProcessDoubleReplacing</code>     : <br> <br> <code class="cpp">leftOutput[i] = rightOutput[i] = mFilter.process(mOscillator.nextSample() * mEnvelopeGenerator.nextSample() * velocity / 127.0);</code> <br> <br>       .  <code>switch</code>   <code>Synthesis::OnParamChange</code> : <br> <br> <code class="cpp">case mFilterCutoff: mFilter.setCutoff(GetParam(paramIdx)-&gt;Value()); break; case mFilterResonance: mFilter.setResonance(GetParam(paramIdx)-&gt;Value()); break; case mFilterMode: mFilter.setFilterMode(static_cast&lt;Filter::FilterMode&gt;(GetParam(paramIdx)-&gt;Int())); break;</code> <br> <br>    .  -      . <br> <br>  <br> <br>  ‚Äî      .   ,   ,          . <br>      : <br> <br> <code class="cpp">buf0 += cutoff * (inputValue - buf0 + feedbackAmount * (buf0 - buf1));</code> <br> <br> ,   ,      ( <code>buf0 ‚Äì buf1</code> ),   <code>feedbackAmount</code> .    <code>calculateFeedbackAmount</code>  <code>feedbackAmount</code>  <code>resonance</code> , . .    ,   . <br> <br>  ,            .     ,  <i></i> ,      <a href="https://www.youtube.com/watch%3Fv%3DJWyMj6KxGHM"> </a> .    ,        ,       . <br> <br>  -12 /  -24 / <br>        !     24   .     <code>switch</code>  <code>Filter::process</code> : <br> <br> <code class="cpp">buf2 += cutoff * (buf1 - buf2); buf3 += cutoff * (buf2 ‚Äì buf3);</code> <br> <br>   :      ,       ,            .     ,       , , <a href="https://ccrma.stanford.edu/~Jos/filters/Filter_Stability.html"></a> (       ).     <code>switch</code> : <br> <br> <code class="cpp">switch (mode) { case FILTER_MODE_LOWPASS: return buf3; case FILTER_MODE_HIGHPASS: return inputValue - buf3; case FILTER_MODE_BANDPASS: return buf0 - buf3; default: return 0.0; }</code> <br> <br>   <code>buf1</code>  <code>buf3</code> ‚Äì      .    -24 /.     <code>buf2</code>  <code>buf3</code> ,        <code>private</code> <i>Filter.h</i> : <br> <br> <code class="cpp">double buf2; double buf3;</code> <br> <br>    ,   <code>buf0</code> c <code>buf1</code> : <br> <br> <code class="cpp">Filter() : // ... buf0(0.0), buf1(0.0), buf2(0.0), buf3(0.0) // ...</code> <br> <br>     , ,     :     .       . <br>          ? <br> <br>   <br>    .  ,           ,       . <br> -      <code>cutoff</code>   .      .    <code>cutoffMod</code> ,    ,       <code>cutoff</code>    .     <code><code>#include    private</code> : <br> <br> <code class="cpp">double cutoffMod;</code> <br> <br> : <br> <br> <code class="cpp">Filter() : cutoff(0.99), resonance(0.01), cutoffMod(0.0), // ...</code> <br> <br>         .   <code>private</code> : <br> <br> <code class="cpp">inline double getCalculatedCutoff() const { return fmax(fmin(cutoff + cutoffMod, 0.99), 0.01); };</code> <br> <br> <code>calculateFeedbackAmount</code>     : <br> <br> <code class="cpp">inline void calculateFeedbackAmount() { feedbackAmount = resonance + resonance/(1.0 - getCalculatedCutoff()); }</code> <br> <br>       <code>cutoffMod</code> .   <code>feedbackAmount</code>    ,     : <br> <br> <code class="cpp">inline void setCutoffMod(double newCutoffMod) { cutoffMod = newCutoffMod; calculateFeedbackAmount(); }</code> <br> <br> ,       .   <code>Filter::process</code>   : <br> <br> <code class="cpp">if (inputValue == 0.0) return inputValue; double calculatedCutoff = getCalculatedCutoff(); buf0 += calculatedCutoff * (inputValue - buf0 + feedbackAmount * (buf0 - buf1)); buf1 += calculatedCutoff * (buf0 - buf1); buf2 += calculatedCutoff * (buf1 - buf2); buf3 += calculatedCutoff * (buf2 ‚Äì buf3);</code> <br> <br>        ,    .    ,      ,   .     .     <code>cutoff</code>  <code>calculatedCutoff</code>   -. <br> <br> ,       ( <code>setCutoffMod</code> ),   <code>Synthesis</code>    ,     ,    .    ,        <code>cutoffMod</code> .    <code>filterEnvelopeAmount</code>    <code>-1</code>  <code>+1</code> .   GUI. <br> <br>   <code>private</code> <i>Synthesis.h</i>    : <br> <br> <code class="cpp">EnvelopeGenerator mFilterEnvelopeGenerator; double filterEnvelopeAmount;</code> <br> <br>       MIDI ,      <code>onNoteOn</code>  <code>onNoteOff</code> : <br> <br> <code class="cpp">inline void onNoteOn(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); mFilterEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); }; inline void onNoteOff(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); mFilterEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); };</code> <br> <br>    .   <code>ProcessDoubleReplacing</code>        : <br> <br> <code class="cpp">mFilter.setCutoffMod(mFilterEnvelopeGenerator.nextSample() * filterEnvelopeAmount);</code> <br> <br>  ,        <code>nextSample</code>  <code>filterEnvelopeAmount</code>     <code>cutoffMod</code> .     <code>filterEnvelopeAmount</code>  : <br> <br> <code class="cpp">Synthesis::Synthesis(IPlugInstanceInfo instanceInfo) : IPLUG_CTOR(kNumParams, kNumPrograms, instanceInfo), lastVirtualKeyboardNoteNumber(virtualKeyboardMinimumNoteNumber - 1), filterEnvelopeAmount(0.0) { // ... }</code> <br> <br>       <code>Synthesis::Reset</code> : <br> <br> <code class="cpp">mFilterEnvelopeGenerator.setSampleRate(GetSampleRate());</code> <br> <br>      <code>EParams</code> ,       .  <code>AttachGraphics</code>     : <br> <br> <code class="cpp">// Knobs for filter envelope // Attack knob GetParam(mFilterAttack)-&gt;InitDouble("Filter Env Attack", 0.01, 0.01, 10.0, 0.001); GetParam(mFilterAttack)-&gt;SetShape(3); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 139, 178, mFilterAttack, &amp;smallKnobBitmap)); // Decay knob: GetParam(mFilterDecay)-&gt;InitDouble("Filter Env Decay", 0.5, 0.01, 15.0, 0.001); GetParam(mFilterDecay)-&gt;SetShape(3); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 195, 178, mFilterDecay, &amp;smallKnobBitmap)); // Sustain knob: GetParam(mFilterSustain)-&gt;InitDouble("Filter Env Sustain", 0.1, 0.001, 1.0, 0.001); GetParam(mFilterSustain)-&gt;SetShape(2); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 251, 178, mFilterSustain, &amp;smallKnobBitmap)); // Release knob: GetParam(mFilterRelease)-&gt;InitDouble("Filter Env Release", 1.0, 0.001, 15.0, 0.001); GetParam(mFilterRelease)-&gt;SetShape(3); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 307, 178, mFilterRelease, &amp;smallKnobBitmap)); // Filter envelope amount knob: GetParam(mFilterEnvelopeAmount)-&gt;InitDouble("Filter Env Amount", 0.0, -1.0, 1.0, 0.001); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 363, 178, mFilterEnvelopeAmount, &amp;smallKnobBitmap));</code> <br> <br>     ,       <code>smallKnobBitmap</code> .                   .     ,    .  <code>Synthesis::OnParamChange</code>    <code>switch</code> : <br> <br> <code class="cpp">case mFilterAttack: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK, GetParam(paramIdx)-&gt;Value()); break; case mFilterDecay: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_DECAY, GetParam(paramIdx)-&gt;Value()); break; case mFilterSustain: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_SUSTAIN, GetParam(paramIdx)-&gt;Value()); break; case mFilterRelease: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE, GetParam(paramIdx)-&gt;Value()); break; case mFilterEnvelopeAmount: filterEnvelopeAmount = GetParam(paramIdx)-&gt;Value(); break;</code> <br> <br> ! <br>     !           (-   C1),   : <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/f5d/757/3f9/f5d7573f9b3a720fe5898d88ae477cfc.png"> <br> <br>        <code>EnvelopeGenerator</code>  .         .        ! <br> <br>    <a href=""></a> . <br> <br>        :) <br> <br>  : <br> <a href="http://martin-finke.de/blog/articles/audio-plugins-013-filter/">martin-finke.de/blog/articles/audio-plugins-013-filter</a></code></code> <h3> <code><code class="cpp">#include  <i>Filter.h</i> ( )     : <br> <br> class Filter { public: enum FilterMode { FILTER_MODE_LOWPASS = 0, FILTER_MODE_HIGHPASS, FILTER_MODE_BANDPASS, kNumFilterModes }; Filter() : cutoff(0.99), resonance(0.0), mode(FILTER_MODE_LOWPASS), buf0(0.0), buf1(0.0) { calculateFeedbackAmount(); }; double process(double inputValue); inline void setCutoff(double newCutoff) { cutoff = newCutoff; calculateFeedbackAmount(); }; inline void setResonance(double newResonance) { resonance = newResonance; calculateFeedbackAmount(); }; inline void setFilterMode(FilterMode newMode) { mode = newMode; } private: double cutoff; double resonance; FilterMode mode; double feedbackAmount; inline void calculateFeedbackAmount() { feedbackAmount = resonance + resonance/(1.0 - cutoff); } double buf0; double buf1; };</code> <br> <br>  <code>private</code>     <i> </i> <code>cutoff</code>  <i></i> <code>resonance</code> . <code>Mode</code>      (Lowpass, Highpass, Bandpass).  <code>feedbackAmount</code> , <code>buf0</code>  <code>buf1</code>    ,    . <br>          ( <code>calculateFeedbackAmount()</code> ).  <code>process</code>      .   <code>feedbackAmount</code>   <code>cutoff</code>  <code>resonance</code> ,    <code>calculateFeedbackAmount</code>      . <br> <br>   <i>Filter.cpp</i>  : <br> <br> <code class="cpp">// By Paul Kellett // http://www.musicdsp.org/showone.php?id=29 double Filter::process(double inputValue) { buf0 += cutoff * (inputValue - buf0); buf1 += cutoff * (buf0 - buf1); switch (mode) { case FILTER_MODE_LOWPASS: return buf1; case FILTER_MODE_HIGHPASS: return inputValue - buf0; case FILTER_MODE_BANDPASS: return buf0 - buf1; default: return 0.0; } }</code> <br> <br> , ?  ,         <i> </i> . ¬´ ¬ª   ,               (. .    6 ).     <code>buf0</code>  <code>buf1</code> :        .     <code>inputValue</code> ,  - <code>buf0</code> (  ).   .    6 /   12 /.  <code>switch</code> ,  <code>buf1</code>    . , ,    <code>buf0</code> ,       12,   6 /,        . <br> <br>  <code>case</code> <code>FILTER_MODE_HIGHPASS</code>    . <code>buf0</code>       .   <code>inputValue</code>  <code>buf0</code> ,   .    <code>buf1</code> ,     . <br> <br>  <code>case</code> <code>FILTER_MODE_BANDPASS</code> ,  <code>buf0 - buf1</code>   .  <code>buf0</code>       ,     <code>buf1</code> . ,   . <br>  :    <i> </i>    <i> </i> ,   . <br> <br>  <code>buf1</code>     .       <a href="http://ru.wikipedia.org/wiki/%25D0%25A4%25D0%25B8%25D0%25BB%25D1%258C%25D1%2582%25D1%2580_%25D1%2581_%25D0%25B1%25D0%25B5%25D1%2581%25D0%25BA%25D0%25BE%25D0%25BD%25D0%25B5%25D1%2587%25D0%25BD%25D0%25BE%25D0%25B9_%25D0%25B8%25D0%25BC%25D0%25BF%25D1%2583%25D0%25BB%25D1%258C%25D1%2581%25D0%25BD%25D0%25BE%25D0%25B9_%25D1%2585%25D0%25B0%25D1%2580%25D0%25B0%25D0%25BA%25D1%2582%25D0%25B5%25D1%2580%25D0%25B8%25D1%2581%25D1%2582%25D0%25B8%25D0%25BA%25D0%25BE%25D0%25B9">    </a> ( <i>Infinite Impulse Response</i> ,  <i>IIR</i> ).  <a href="http://www.dspguide.com/ch14/1.htm"> </a> ,      .      ,         ,      . <br> <br>   <br>       ,     ,     .   ,  ,      ,  ,          .           ,  NI Massive,   ¬´ <a href="http://lurkmore.to/%25D0%25A2%25D1%2591%25D0%25BF%25D0%25BB%25D1%258B%25D0%25B9_%25D0%25BB%25D0%25B0%25D0%25BC%25D0%25BF%25D0%25BE%25D0%25B2%25D1%258B%25D0%25B9_%25D0%25B7%25D0%25B2%25D1%2583%25D0%25BA">  </a> ¬ª.       ,          ,   .        ,          (  Massive       ).      ¬´¬ª , , , AAS Ultra Analog,       ,     ,    ,        .         ,  ,    <a href="http://www.kvraudio.com/forum/viewtopic.php%3Ft%3D350246"></a> ,   ,      NI Reaktor. ,            ‚Äî    ,    ..     . <br> <br>   <br>     .   GUI.  <i>bg.png</i>   ( <i>‚ÄúMove to trash‚Äù</i>  Xcode),       : <br> <br> <a href="">filtermode.png</a> <a href="">knob_small.png</a> (  ,   50 50 ) <a href="">bg.png</a> (       ) <br> <br>    ID  <i>resource.h</i> : <br> <br> <code class="cpp">// Unique IDs for each image resource. #define BG_ID 101 #define WHITE_KEY_ID 102 #define BLACK_KEY_ID 103 #define WAVEFORM_ID 104 #define KNOB_ID 105 #define KNOB_SMALL_ID 106 #define FILTERMODE_ID 107 // Image resource locations for this plug. #define BG_FN "resources/img/bg.png" #define WHITE_KEY_FN "resources/img/whitekey.png" #define BLACK_KEY_FN "resources/img/blackkey.png" #define WAVEFORM_FN "resources/img/waveform.png" #define KNOB_FN "resources/img/knob.png" #define KNOB_SMALL_FN "resources/img/knob_small.png" #define FILTERMODE_FN "resources/img/filtermode.png"</code> <br> <br>  <i>Synthesis.rc</i> : <br> <br> <code class="cpp">#include "resource.h" BG_ID PNG BG_FN WHITE_KEY_ID PNG WHITE_KEY_FN BLACK_KEY_ID PNG BLACK_KEY_FN WAVEFORM_ID PNG WAVEFORM_FN KNOB_ID PNG KNOB_FN KNOB_SMALL_ID PNG KNOB_SMALL_FN FILTERMODE_ID PNG FILTERMODE_FN</code> <br> <br>   <code>#include "Filter.h"</code>  <i>Synthesis.h</i>    <code>private</code> : <br> <br> <code class="cpp">Filter mFilter;</code> <br> <br>  <code>EParams</code>  <i>Synthesis.cpp</i> : <br> <br> <code class="cpp">enum EParams { mWaveform = 0, mAttack, mDecay, mSustain, mRelease, mFilterMode, mFilterCutoff, mFilterResonance, mFilterAttack, mFilterDecay, mFilterSustain, mFilterRelease, mFilterEnvelopeAmount, kNumParams };</code> <br> <br>        : <br> <br> <code class="cpp">pGraphics-&gt;AttachControl(new ISwitchControl(this, 24, 38, mWaveform, &amp;waveformBitmap));</code> <br> <br>      .      (Lowpass, Highpass, Bandpass).    <code>AttachGraphics(pGraphics)</code> : <br> <br> <code class="cpp">GetParam(mFilterMode)-&gt;InitEnum("Filter Mode", Filter::FILTER_MODE_LOWPASS, Filter::kNumFilterModes); IBitmap filtermodeBitmap = pGraphics-&gt;LoadIBitmap(FILTERMODE_ID, FILTERMODE_FN, 3); pGraphics-&gt;AttachControl(new ISwitchControl(this, 24, 123, mFilterMode, &amp;filtermodeBitmap));</code> <br> <br>         .    .     <i>knob_small.png</i> : <br> <br> <code class="cpp">// Knobs for filter cutoff and resonance IBitmap smallKnobBitmap = pGraphics-&gt;LoadIBitmap(KNOB_SMALL_ID, KNOB_SMALL_FN, 64); // Cutoff knob: GetParam(mFilterCutoff)-&gt;InitDouble("Cutoff", 0.99, 0.01, 0.99, 0.001); GetParam(mFilterCutoff)-&gt;SetShape(2); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 5, 177, mFilterCutoff, &amp;smallKnobBitmap)); // Resonance knob: GetParam(mFilterResonance)-&gt;InitDouble("Resonance", 0.01, 0.01, 1.0, 0.001); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 61, 177, mFilterResonance, &amp;smallKnobBitmap));</code> <br> <br>   ,           <code>1.0</code> ,   <code>calculateFeedbackAmount</code>    , . <br>  <code>ProcessDoubleReplacing</code>     : <br> <br> <code class="cpp">leftOutput[i] = rightOutput[i] = mFilter.process(mOscillator.nextSample() * mEnvelopeGenerator.nextSample() * velocity / 127.0);</code> <br> <br>       .  <code>switch</code>   <code>Synthesis::OnParamChange</code> : <br> <br> <code class="cpp">case mFilterCutoff: mFilter.setCutoff(GetParam(paramIdx)-&gt;Value()); break; case mFilterResonance: mFilter.setResonance(GetParam(paramIdx)-&gt;Value()); break; case mFilterMode: mFilter.setFilterMode(static_cast&lt;Filter::FilterMode&gt;(GetParam(paramIdx)-&gt;Int())); break;</code> <br> <br>    .  -      . <br> <br>  <br> <br>  ‚Äî      .   ,   ,          . <br>      : <br> <br> <code class="cpp">buf0 += cutoff * (inputValue - buf0 + feedbackAmount * (buf0 - buf1));</code> <br> <br> ,   ,      ( <code>buf0 ‚Äì buf1</code> ),   <code>feedbackAmount</code> .    <code>calculateFeedbackAmount</code>  <code>feedbackAmount</code>  <code>resonance</code> , . .    ,   . <br> <br>  ,            .     ,  <i></i> ,      <a href="https://www.youtube.com/watch%3Fv%3DJWyMj6KxGHM"> </a> .    ,        ,       . <br> <br>  -12 /  -24 / <br>        !     24   .     <code>switch</code>  <code>Filter::process</code> : <br> <br> <code class="cpp">buf2 += cutoff * (buf1 - buf2); buf3 += cutoff * (buf2 ‚Äì buf3);</code> <br> <br>   :      ,       ,            .     ,       , , <a href="https://ccrma.stanford.edu/~Jos/filters/Filter_Stability.html"></a> (       ).     <code>switch</code> : <br> <br> <code class="cpp">switch (mode) { case FILTER_MODE_LOWPASS: return buf3; case FILTER_MODE_HIGHPASS: return inputValue - buf3; case FILTER_MODE_BANDPASS: return buf0 - buf3; default: return 0.0; }</code> <br> <br>   <code>buf1</code>  <code>buf3</code> ‚Äì      .    -24 /.     <code>buf2</code>  <code>buf3</code> ,        <code>private</code> <i>Filter.h</i> : <br> <br> <code class="cpp">double buf2; double buf3;</code> <br> <br>    ,   <code>buf0</code> c <code>buf1</code> : <br> <br> <code class="cpp">Filter() : // ... buf0(0.0), buf1(0.0), buf2(0.0), buf3(0.0) // ...</code> <br> <br>     , ,     :     .       . <br>          ? <br> <br>   <br>    .  ,           ,       . <br> -      <code>cutoff</code>   .      .    <code>cutoffMod</code> ,    ,       <code>cutoff</code>    .     <code><code>#include    private</code> : <br> <br> <code class="cpp">double cutoffMod;</code> <br> <br> : <br> <br> <code class="cpp">Filter() : cutoff(0.99), resonance(0.01), cutoffMod(0.0), // ...</code> <br> <br>         .   <code>private</code> : <br> <br> <code class="cpp">inline double getCalculatedCutoff() const { return fmax(fmin(cutoff + cutoffMod, 0.99), 0.01); };</code> <br> <br> <code>calculateFeedbackAmount</code>     : <br> <br> <code class="cpp">inline void calculateFeedbackAmount() { feedbackAmount = resonance + resonance/(1.0 - getCalculatedCutoff()); }</code> <br> <br>       <code>cutoffMod</code> .   <code>feedbackAmount</code>    ,     : <br> <br> <code class="cpp">inline void setCutoffMod(double newCutoffMod) { cutoffMod = newCutoffMod; calculateFeedbackAmount(); }</code> <br> <br> ,       .   <code>Filter::process</code>   : <br> <br> <code class="cpp">if (inputValue == 0.0) return inputValue; double calculatedCutoff = getCalculatedCutoff(); buf0 += calculatedCutoff * (inputValue - buf0 + feedbackAmount * (buf0 - buf1)); buf1 += calculatedCutoff * (buf0 - buf1); buf2 += calculatedCutoff * (buf1 - buf2); buf3 += calculatedCutoff * (buf2 ‚Äì buf3);</code> <br> <br>        ,    .    ,      ,   .     .     <code>cutoff</code>  <code>calculatedCutoff</code>   -. <br> <br> ,       ( <code>setCutoffMod</code> ),   <code>Synthesis</code>    ,     ,    .    ,        <code>cutoffMod</code> .    <code>filterEnvelopeAmount</code>    <code>-1</code>  <code>+1</code> .   GUI. <br> <br>   <code>private</code> <i>Synthesis.h</i>    : <br> <br> <code class="cpp">EnvelopeGenerator mFilterEnvelopeGenerator; double filterEnvelopeAmount;</code> <br> <br>       MIDI ,      <code>onNoteOn</code>  <code>onNoteOff</code> : <br> <br> <code class="cpp">inline void onNoteOn(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); mFilterEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); }; inline void onNoteOff(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); mFilterEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); };</code> <br> <br>    .   <code>ProcessDoubleReplacing</code>        : <br> <br> <code class="cpp">mFilter.setCutoffMod(mFilterEnvelopeGenerator.nextSample() * filterEnvelopeAmount);</code> <br> <br>  ,        <code>nextSample</code>  <code>filterEnvelopeAmount</code>     <code>cutoffMod</code> .     <code>filterEnvelopeAmount</code>  : <br> <br> <code class="cpp">Synthesis::Synthesis(IPlugInstanceInfo instanceInfo) : IPLUG_CTOR(kNumParams, kNumPrograms, instanceInfo), lastVirtualKeyboardNoteNumber(virtualKeyboardMinimumNoteNumber - 1), filterEnvelopeAmount(0.0) { // ... }</code> <br> <br>       <code>Synthesis::Reset</code> : <br> <br> <code class="cpp">mFilterEnvelopeGenerator.setSampleRate(GetSampleRate());</code> <br> <br>      <code>EParams</code> ,       .  <code>AttachGraphics</code>     : <br> <br> <code class="cpp">// Knobs for filter envelope // Attack knob GetParam(mFilterAttack)-&gt;InitDouble("Filter Env Attack", 0.01, 0.01, 10.0, 0.001); GetParam(mFilterAttack)-&gt;SetShape(3); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 139, 178, mFilterAttack, &amp;smallKnobBitmap)); // Decay knob: GetParam(mFilterDecay)-&gt;InitDouble("Filter Env Decay", 0.5, 0.01, 15.0, 0.001); GetParam(mFilterDecay)-&gt;SetShape(3); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 195, 178, mFilterDecay, &amp;smallKnobBitmap)); // Sustain knob: GetParam(mFilterSustain)-&gt;InitDouble("Filter Env Sustain", 0.1, 0.001, 1.0, 0.001); GetParam(mFilterSustain)-&gt;SetShape(2); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 251, 178, mFilterSustain, &amp;smallKnobBitmap)); // Release knob: GetParam(mFilterRelease)-&gt;InitDouble("Filter Env Release", 1.0, 0.001, 15.0, 0.001); GetParam(mFilterRelease)-&gt;SetShape(3); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 307, 178, mFilterRelease, &amp;smallKnobBitmap)); // Filter envelope amount knob: GetParam(mFilterEnvelopeAmount)-&gt;InitDouble("Filter Env Amount", 0.0, -1.0, 1.0, 0.001); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 363, 178, mFilterEnvelopeAmount, &amp;smallKnobBitmap));</code> <br> <br>     ,       <code>smallKnobBitmap</code> .                   .     ,    .  <code>Synthesis::OnParamChange</code>    <code>switch</code> : <br> <br> <code class="cpp">case mFilterAttack: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK, GetParam(paramIdx)-&gt;Value()); break; case mFilterDecay: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_DECAY, GetParam(paramIdx)-&gt;Value()); break; case mFilterSustain: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_SUSTAIN, GetParam(paramIdx)-&gt;Value()); break; case mFilterRelease: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE, GetParam(paramIdx)-&gt;Value()); break; case mFilterEnvelopeAmount: filterEnvelopeAmount = GetParam(paramIdx)-&gt;Value(); break;</code> <br> <br> ! <br>     !           (-   C1),   : <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/f5d/757/3f9/f5d7573f9b3a720fe5898d88ae477cfc.png"> <br> <br>        <code>EnvelopeGenerator</code>  .         .        ! <br> <br>    <a href=""></a> . <br> <br>        :) <br> <br>  : <br> <a href="http://martin-finke.de/blog/articles/audio-plugins-013-filter/">martin-finke.de/blog/articles/audio-plugins-013-filter</a></code></code> </h3> <code><code class="cpp">#include  <i>Filter.h</i> ( )     : <br> <br> class Filter { public: enum FilterMode { FILTER_MODE_LOWPASS = 0, FILTER_MODE_HIGHPASS, FILTER_MODE_BANDPASS, kNumFilterModes }; Filter() : cutoff(0.99), resonance(0.0), mode(FILTER_MODE_LOWPASS), buf0(0.0), buf1(0.0) { calculateFeedbackAmount(); }; double process(double inputValue); inline void setCutoff(double newCutoff) { cutoff = newCutoff; calculateFeedbackAmount(); }; inline void setResonance(double newResonance) { resonance = newResonance; calculateFeedbackAmount(); }; inline void setFilterMode(FilterMode newMode) { mode = newMode; } private: double cutoff; double resonance; FilterMode mode; double feedbackAmount; inline void calculateFeedbackAmount() { feedbackAmount = resonance + resonance/(1.0 - cutoff); } double buf0; double buf1; };</code> <br> <br>  <code>private</code>     <i> </i> <code>cutoff</code>  <i></i> <code>resonance</code> . <code>Mode</code>      (Lowpass, Highpass, Bandpass).  <code>feedbackAmount</code> , <code>buf0</code>  <code>buf1</code>    ,    . <br>          ( <code>calculateFeedbackAmount()</code> ).  <code>process</code>      .   <code>feedbackAmount</code>   <code>cutoff</code>  <code>resonance</code> ,    <code>calculateFeedbackAmount</code>      . <br> <br>   <i>Filter.cpp</i>  : <br> <br> <code class="cpp">// By Paul Kellett // http://www.musicdsp.org/showone.php?id=29 double Filter::process(double inputValue) { buf0 += cutoff * (inputValue - buf0); buf1 += cutoff * (buf0 - buf1); switch (mode) { case FILTER_MODE_LOWPASS: return buf1; case FILTER_MODE_HIGHPASS: return inputValue - buf0; case FILTER_MODE_BANDPASS: return buf0 - buf1; default: return 0.0; } }</code> <br> <br> , ?  ,         <i> </i> . ¬´ ¬ª   ,               (. .    6 ).     <code>buf0</code>  <code>buf1</code> :        .     <code>inputValue</code> ,  - <code>buf0</code> (  ).   .    6 /   12 /.  <code>switch</code> ,  <code>buf1</code>    . , ,    <code>buf0</code> ,       12,   6 /,        . <br> <br>  <code>case</code> <code>FILTER_MODE_HIGHPASS</code>    . <code>buf0</code>       .   <code>inputValue</code>  <code>buf0</code> ,   .    <code>buf1</code> ,     . <br> <br>  <code>case</code> <code>FILTER_MODE_BANDPASS</code> ,  <code>buf0 - buf1</code>   .  <code>buf0</code>       ,     <code>buf1</code> . ,   . <br>  :    <i> </i>    <i> </i> ,   . <br> <br>  <code>buf1</code>     .       <a href="http://ru.wikipedia.org/wiki/%25D0%25A4%25D0%25B8%25D0%25BB%25D1%258C%25D1%2582%25D1%2580_%25D1%2581_%25D0%25B1%25D0%25B5%25D1%2581%25D0%25BA%25D0%25BE%25D0%25BD%25D0%25B5%25D1%2587%25D0%25BD%25D0%25BE%25D0%25B9_%25D0%25B8%25D0%25BC%25D0%25BF%25D1%2583%25D0%25BB%25D1%258C%25D1%2581%25D0%25BD%25D0%25BE%25D0%25B9_%25D1%2585%25D0%25B0%25D1%2580%25D0%25B0%25D0%25BA%25D1%2582%25D0%25B5%25D1%2580%25D0%25B8%25D1%2581%25D1%2582%25D0%25B8%25D0%25BA%25D0%25BE%25D0%25B9">    </a> ( <i>Infinite Impulse Response</i> ,  <i>IIR</i> ).  <a href="http://www.dspguide.com/ch14/1.htm"> </a> ,      .      ,         ,      . <br> <br>   <br>       ,     ,     .   ,  ,      ,  ,          .           ,  NI Massive,   ¬´ <a href="http://lurkmore.to/%25D0%25A2%25D1%2591%25D0%25BF%25D0%25BB%25D1%258B%25D0%25B9_%25D0%25BB%25D0%25B0%25D0%25BC%25D0%25BF%25D0%25BE%25D0%25B2%25D1%258B%25D0%25B9_%25D0%25B7%25D0%25B2%25D1%2583%25D0%25BA">  </a> ¬ª.       ,          ,   .        ,          (  Massive       ).      ¬´¬ª , , , AAS Ultra Analog,       ,     ,    ,        .         ,  ,    <a href="http://www.kvraudio.com/forum/viewtopic.php%3Ft%3D350246"></a> ,   ,      NI Reaktor. ,            ‚Äî    ,    ..     . <br> <br>   <br>     .   GUI.  <i>bg.png</i>   ( <i>‚ÄúMove to trash‚Äù</i>  Xcode),       : <br> <br> <a href="">filtermode.png</a> <a href="">knob_small.png</a> (  ,   50 50 ) <a href="">bg.png</a> (       ) <br> <br>    ID  <i>resource.h</i> : <br> <br> <code class="cpp">// Unique IDs for each image resource. #define BG_ID 101 #define WHITE_KEY_ID 102 #define BLACK_KEY_ID 103 #define WAVEFORM_ID 104 #define KNOB_ID 105 #define KNOB_SMALL_ID 106 #define FILTERMODE_ID 107 // Image resource locations for this plug. #define BG_FN "resources/img/bg.png" #define WHITE_KEY_FN "resources/img/whitekey.png" #define BLACK_KEY_FN "resources/img/blackkey.png" #define WAVEFORM_FN "resources/img/waveform.png" #define KNOB_FN "resources/img/knob.png" #define KNOB_SMALL_FN "resources/img/knob_small.png" #define FILTERMODE_FN "resources/img/filtermode.png"</code> <br> <br>  <i>Synthesis.rc</i> : <br> <br> <code class="cpp">#include "resource.h" BG_ID PNG BG_FN WHITE_KEY_ID PNG WHITE_KEY_FN BLACK_KEY_ID PNG BLACK_KEY_FN WAVEFORM_ID PNG WAVEFORM_FN KNOB_ID PNG KNOB_FN KNOB_SMALL_ID PNG KNOB_SMALL_FN FILTERMODE_ID PNG FILTERMODE_FN</code> <br> <br>   <code>#include "Filter.h"</code>  <i>Synthesis.h</i>    <code>private</code> : <br> <br> <code class="cpp">Filter mFilter;</code> <br> <br>  <code>EParams</code>  <i>Synthesis.cpp</i> : <br> <br> <code class="cpp">enum EParams { mWaveform = 0, mAttack, mDecay, mSustain, mRelease, mFilterMode, mFilterCutoff, mFilterResonance, mFilterAttack, mFilterDecay, mFilterSustain, mFilterRelease, mFilterEnvelopeAmount, kNumParams };</code> <br> <br>        : <br> <br> <code class="cpp">pGraphics-&gt;AttachControl(new ISwitchControl(this, 24, 38, mWaveform, &amp;waveformBitmap));</code> <br> <br>      .      (Lowpass, Highpass, Bandpass).    <code>AttachGraphics(pGraphics)</code> : <br> <br> <code class="cpp">GetParam(mFilterMode)-&gt;InitEnum("Filter Mode", Filter::FILTER_MODE_LOWPASS, Filter::kNumFilterModes); IBitmap filtermodeBitmap = pGraphics-&gt;LoadIBitmap(FILTERMODE_ID, FILTERMODE_FN, 3); pGraphics-&gt;AttachControl(new ISwitchControl(this, 24, 123, mFilterMode, &amp;filtermodeBitmap));</code> <br> <br>         .    .     <i>knob_small.png</i> : <br> <br> <code class="cpp">// Knobs for filter cutoff and resonance IBitmap smallKnobBitmap = pGraphics-&gt;LoadIBitmap(KNOB_SMALL_ID, KNOB_SMALL_FN, 64); // Cutoff knob: GetParam(mFilterCutoff)-&gt;InitDouble("Cutoff", 0.99, 0.01, 0.99, 0.001); GetParam(mFilterCutoff)-&gt;SetShape(2); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 5, 177, mFilterCutoff, &amp;smallKnobBitmap)); // Resonance knob: GetParam(mFilterResonance)-&gt;InitDouble("Resonance", 0.01, 0.01, 1.0, 0.001); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 61, 177, mFilterResonance, &amp;smallKnobBitmap));</code> <br> <br>   ,           <code>1.0</code> ,   <code>calculateFeedbackAmount</code>    , . <br>  <code>ProcessDoubleReplacing</code>     : <br> <br> <code class="cpp">leftOutput[i] = rightOutput[i] = mFilter.process(mOscillator.nextSample() * mEnvelopeGenerator.nextSample() * velocity / 127.0);</code> <br> <br>       .  <code>switch</code>   <code>Synthesis::OnParamChange</code> : <br> <br> <code class="cpp">case mFilterCutoff: mFilter.setCutoff(GetParam(paramIdx)-&gt;Value()); break; case mFilterResonance: mFilter.setResonance(GetParam(paramIdx)-&gt;Value()); break; case mFilterMode: mFilter.setFilterMode(static_cast&lt;Filter::FilterMode&gt;(GetParam(paramIdx)-&gt;Int())); break;</code> <br> <br>    .  -      . <br> <br>  <br> <br>  ‚Äî      .   ,   ,          . <br>      : <br> <br> <code class="cpp">buf0 += cutoff * (inputValue - buf0 + feedbackAmount * (buf0 - buf1));</code> <br> <br> ,   ,      ( <code>buf0 ‚Äì buf1</code> ),   <code>feedbackAmount</code> .    <code>calculateFeedbackAmount</code>  <code>feedbackAmount</code>  <code>resonance</code> , . .    ,   . <br> <br>  ,            .     ,  <i></i> ,      <a href="https://www.youtube.com/watch%3Fv%3DJWyMj6KxGHM"> </a> .    ,        ,       . <br> <br>  -12 /  -24 / <br>        !     24   .     <code>switch</code>  <code>Filter::process</code> : <br> <br> <code class="cpp">buf2 += cutoff * (buf1 - buf2); buf3 += cutoff * (buf2 ‚Äì buf3);</code> <br> <br>   :      ,       ,            .     ,       , , <a href="https://ccrma.stanford.edu/~Jos/filters/Filter_Stability.html"></a> (       ).     <code>switch</code> : <br> <br> <code class="cpp">switch (mode) { case FILTER_MODE_LOWPASS: return buf3; case FILTER_MODE_HIGHPASS: return inputValue - buf3; case FILTER_MODE_BANDPASS: return buf0 - buf3; default: return 0.0; }</code> <br> <br>   <code>buf1</code>  <code>buf3</code> ‚Äì      .    -24 /.     <code>buf2</code>  <code>buf3</code> ,        <code>private</code> <i>Filter.h</i> : <br> <br> <code class="cpp">double buf2; double buf3;</code> <br> <br>    ,   <code>buf0</code> c <code>buf1</code> : <br> <br> <code class="cpp">Filter() : // ... buf0(0.0), buf1(0.0), buf2(0.0), buf3(0.0) // ...</code> <br> <br>     , ,     :     .       . <br>          ? <br> <br>   <br>    .  ,           ,       . <br> -      <code>cutoff</code>   .      .    <code>cutoffMod</code> ,    ,       <code>cutoff</code>    .     <code><code>#include    private</code> : <br> <br> <code class="cpp">double cutoffMod;</code> <br> <br> : <br> <br> <code class="cpp">Filter() : cutoff(0.99), resonance(0.01), cutoffMod(0.0), // ...</code> <br> <br>         .   <code>private</code> : <br> <br> <code class="cpp">inline double getCalculatedCutoff() const { return fmax(fmin(cutoff + cutoffMod, 0.99), 0.01); };</code> <br> <br> <code>calculateFeedbackAmount</code>     : <br> <br> <code class="cpp">inline void calculateFeedbackAmount() { feedbackAmount = resonance + resonance/(1.0 - getCalculatedCutoff()); }</code> <br> <br>       <code>cutoffMod</code> .   <code>feedbackAmount</code>    ,     : <br> <br> <code class="cpp">inline void setCutoffMod(double newCutoffMod) { cutoffMod = newCutoffMod; calculateFeedbackAmount(); }</code> <br> <br> ,       .   <code>Filter::process</code>   : <br> <br> <code class="cpp">if (inputValue == 0.0) return inputValue; double calculatedCutoff = getCalculatedCutoff(); buf0 += calculatedCutoff * (inputValue - buf0 + feedbackAmount * (buf0 - buf1)); buf1 += calculatedCutoff * (buf0 - buf1); buf2 += calculatedCutoff * (buf1 - buf2); buf3 += calculatedCutoff * (buf2 ‚Äì buf3);</code> <br> <br>        ,    .    ,      ,   .     .     <code>cutoff</code>  <code>calculatedCutoff</code>   -. <br> <br> ,       ( <code>setCutoffMod</code> ),   <code>Synthesis</code>    ,     ,    .    ,        <code>cutoffMod</code> .    <code>filterEnvelopeAmount</code>    <code>-1</code>  <code>+1</code> .   GUI. <br> <br>   <code>private</code> <i>Synthesis.h</i>    : <br> <br> <code class="cpp">EnvelopeGenerator mFilterEnvelopeGenerator; double filterEnvelopeAmount;</code> <br> <br>       MIDI ,      <code>onNoteOn</code>  <code>onNoteOff</code> : <br> <br> <code class="cpp">inline void onNoteOn(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); mFilterEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); }; inline void onNoteOff(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); mFilterEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); };</code> <br> <br>    .   <code>ProcessDoubleReplacing</code>        : <br> <br> <code class="cpp">mFilter.setCutoffMod(mFilterEnvelopeGenerator.nextSample() * filterEnvelopeAmount);</code> <br> <br>  ,        <code>nextSample</code>  <code>filterEnvelopeAmount</code>     <code>cutoffMod</code> .     <code>filterEnvelopeAmount</code>  : <br> <br> <code class="cpp">Synthesis::Synthesis(IPlugInstanceInfo instanceInfo) : IPLUG_CTOR(kNumParams, kNumPrograms, instanceInfo), lastVirtualKeyboardNoteNumber(virtualKeyboardMinimumNoteNumber - 1), filterEnvelopeAmount(0.0) { // ... }</code> <br> <br>       <code>Synthesis::Reset</code> : <br> <br> <code class="cpp">mFilterEnvelopeGenerator.setSampleRate(GetSampleRate());</code> <br> <br>      <code>EParams</code> ,       .  <code>AttachGraphics</code>     : <br> <br> <code class="cpp">// Knobs for filter envelope // Attack knob GetParam(mFilterAttack)-&gt;InitDouble("Filter Env Attack", 0.01, 0.01, 10.0, 0.001); GetParam(mFilterAttack)-&gt;SetShape(3); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 139, 178, mFilterAttack, &amp;smallKnobBitmap)); // Decay knob: GetParam(mFilterDecay)-&gt;InitDouble("Filter Env Decay", 0.5, 0.01, 15.0, 0.001); GetParam(mFilterDecay)-&gt;SetShape(3); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 195, 178, mFilterDecay, &amp;smallKnobBitmap)); // Sustain knob: GetParam(mFilterSustain)-&gt;InitDouble("Filter Env Sustain", 0.1, 0.001, 1.0, 0.001); GetParam(mFilterSustain)-&gt;SetShape(2); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 251, 178, mFilterSustain, &amp;smallKnobBitmap)); // Release knob: GetParam(mFilterRelease)-&gt;InitDouble("Filter Env Release", 1.0, 0.001, 15.0, 0.001); GetParam(mFilterRelease)-&gt;SetShape(3); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 307, 178, mFilterRelease, &amp;smallKnobBitmap)); // Filter envelope amount knob: GetParam(mFilterEnvelopeAmount)-&gt;InitDouble("Filter Env Amount", 0.0, -1.0, 1.0, 0.001); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 363, 178, mFilterEnvelopeAmount, &amp;smallKnobBitmap));</code> <br> <br>     ,       <code>smallKnobBitmap</code> .                   .     ,    .  <code>Synthesis::OnParamChange</code>    <code>switch</code> : <br> <br> <code class="cpp">case mFilterAttack: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK, GetParam(paramIdx)-&gt;Value()); break; case mFilterDecay: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_DECAY, GetParam(paramIdx)-&gt;Value()); break; case mFilterSustain: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_SUSTAIN, GetParam(paramIdx)-&gt;Value()); break; case mFilterRelease: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE, GetParam(paramIdx)-&gt;Value()); break; case mFilterEnvelopeAmount: filterEnvelopeAmount = GetParam(paramIdx)-&gt;Value(); break;</code> <br> <br> ! <br>     !           (-   C1),   : <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/f5d/757/3f9/f5d7573f9b3a720fe5898d88ae477cfc.png"> <br> <br>        <code>EnvelopeGenerator</code>  .         .        ! <br> <br>    <a href=""></a> . <br> <br>        :) <br> <br>  : <br> <a href="http://martin-finke.de/blog/articles/audio-plugins-013-filter/">martin-finke.de/blog/articles/audio-plugins-013-filter</a></code></code> <ul><li> <code><a href=""><code class="cpp">#include  <i>Filter.h</i> ( )     : <br> <br> class Filter { public: enum FilterMode { FILTER_MODE_LOWPASS = 0, FILTER_MODE_HIGHPASS, FILTER_MODE_BANDPASS, kNumFilterModes }; Filter() : cutoff(0.99), resonance(0.0), mode(FILTER_MODE_LOWPASS), buf0(0.0), buf1(0.0) { calculateFeedbackAmount(); }; double process(double inputValue); inline void setCutoff(double newCutoff) { cutoff = newCutoff; calculateFeedbackAmount(); }; inline void setResonance(double newResonance) { resonance = newResonance; calculateFeedbackAmount(); }; inline void setFilterMode(FilterMode newMode) { mode = newMode; } private: double cutoff; double resonance; FilterMode mode; double feedbackAmount; inline void calculateFeedbackAmount() { feedbackAmount = resonance + resonance/(1.0 - cutoff); } double buf0; double buf1; };</code> <br> <br>  <code>private</code>     <i> </i> <code>cutoff</code>  <i></i> <code>resonance</code> . <code>Mode</code>      (Lowpass, Highpass, Bandpass).  <code>feedbackAmount</code> , <code>buf0</code>  <code>buf1</code>    ,    . <br>          ( <code>calculateFeedbackAmount()</code> ).  <code>process</code>      .   <code>feedbackAmount</code>   <code>cutoff</code>  <code>resonance</code> ,    <code>calculateFeedbackAmount</code>      . <br> <br>   <i>Filter.cpp</i>  : <br> <br> <code class="cpp">// By Paul Kellett // http://www.musicdsp.org/showone.php?id=29 double Filter::process(double inputValue) { buf0 += cutoff * (inputValue - buf0); buf1 += cutoff * (buf0 - buf1); switch (mode) { case FILTER_MODE_LOWPASS: return buf1; case FILTER_MODE_HIGHPASS: return inputValue - buf0; case FILTER_MODE_BANDPASS: return buf0 - buf1; default: return 0.0; } }</code> <br> <br> , ?  ,         <i> </i> . ¬´ ¬ª   ,               (. .    6 ).     <code>buf0</code>  <code>buf1</code> :        .     <code>inputValue</code> ,  - <code>buf0</code> (  ).   .    6 /   12 /.  <code>switch</code> ,  <code>buf1</code>    . , ,    <code>buf0</code> ,       12,   6 /,        . <br> <br>  <code>case</code> <code>FILTER_MODE_HIGHPASS</code>    . <code>buf0</code>       .   <code>inputValue</code>  <code>buf0</code> ,   .    <code>buf1</code> ,     . <br> <br>  <code>case</code> <code>FILTER_MODE_BANDPASS</code> ,  <code>buf0 - buf1</code>   .  <code>buf0</code>       ,     <code>buf1</code> . ,   . <br>  :    <i> </i>    <i> </i> ,   . <br> <br>  <code>buf1</code>     .       </a><a href="http://ru.wikipedia.org/wiki/%25D0%25A4%25D0%25B8%25D0%25BB%25D1%258C%25D1%2582%25D1%2580_%25D1%2581_%25D0%25B1%25D0%25B5%25D1%2581%25D0%25BA%25D0%25BE%25D0%25BD%25D0%25B5%25D1%2587%25D0%25BD%25D0%25BE%25D0%25B9_%25D0%25B8%25D0%25BC%25D0%25BF%25D1%2583%25D0%25BB%25D1%258C%25D1%2581%25D0%25BD%25D0%25BE%25D0%25B9_%25D1%2585%25D0%25B0%25D1%2580%25D0%25B0%25D0%25BA%25D1%2582%25D0%25B5%25D1%2580%25D0%25B8%25D1%2581%25D1%2582%25D0%25B8%25D0%25BA%25D0%25BE%25D0%25B9">    </a> ( <i>Infinite Impulse Response</i> ,  <i>IIR</i> ).  <a href="http://www.dspguide.com/ch14/1.htm"> </a> ,      .      ,         ,      . <br> <br>   <br>       ,     ,     .   ,  ,      ,  ,          .           ,  NI Massive,   ¬´ <a href="http://lurkmore.to/%25D0%25A2%25D1%2591%25D0%25BF%25D0%25BB%25D1%258B%25D0%25B9_%25D0%25BB%25D0%25B0%25D0%25BC%25D0%25BF%25D0%25BE%25D0%25B2%25D1%258B%25D0%25B9_%25D0%25B7%25D0%25B2%25D1%2583%25D0%25BA">  </a> ¬ª.       ,          ,   .        ,          (  Massive       ).      ¬´¬ª , , , AAS Ultra Analog,       ,     ,    ,        .         ,  ,    <a href="http://www.kvraudio.com/forum/viewtopic.php%3Ft%3D350246"></a> ,   ,      NI Reaktor. ,            ‚Äî    ,    ..     . <br> <br>   <br>     .   GUI.  <i>bg.png</i>   ( <i>‚ÄúMove to trash‚Äù</i>  Xcode),       : <br> <br> filtermode.png <a href="">knob_small.png</a> (  ,   50 50 ) <a href="">bg.png</a> (       ) <br> <br>    ID  <i>resource.h</i> : <br> <br> <code class="cpp">// Unique IDs for each image resource. #define BG_ID 101 #define WHITE_KEY_ID 102 #define BLACK_KEY_ID 103 #define WAVEFORM_ID 104 #define KNOB_ID 105 #define KNOB_SMALL_ID 106 #define FILTERMODE_ID 107 // Image resource locations for this plug. #define BG_FN "resources/img/bg.png" #define WHITE_KEY_FN "resources/img/whitekey.png" #define BLACK_KEY_FN "resources/img/blackkey.png" #define WAVEFORM_FN "resources/img/waveform.png" #define KNOB_FN "resources/img/knob.png" #define KNOB_SMALL_FN "resources/img/knob_small.png" #define FILTERMODE_FN "resources/img/filtermode.png"</code> <br> <br>  <i>Synthesis.rc</i> : <br> <br> <code class="cpp">#include "resource.h" BG_ID PNG BG_FN WHITE_KEY_ID PNG WHITE_KEY_FN BLACK_KEY_ID PNG BLACK_KEY_FN WAVEFORM_ID PNG WAVEFORM_FN KNOB_ID PNG KNOB_FN KNOB_SMALL_ID PNG KNOB_SMALL_FN FILTERMODE_ID PNG FILTERMODE_FN</code> <br> <br>   <code>#include "Filter.h"</code>  <i>Synthesis.h</i>    <code>private</code> : <br> <br> <code class="cpp">Filter mFilter;</code> <br> <br>  <code>EParams</code>  <i>Synthesis.cpp</i> : <br> <br> <code class="cpp">enum EParams { mWaveform = 0, mAttack, mDecay, mSustain, mRelease, mFilterMode, mFilterCutoff, mFilterResonance, mFilterAttack, mFilterDecay, mFilterSustain, mFilterRelease, mFilterEnvelopeAmount, kNumParams };</code> <br> <br>        : <br> <br> <code class="cpp">pGraphics-&gt;AttachControl(new ISwitchControl(this, 24, 38, mWaveform, &amp;waveformBitmap));</code> <br> <br>      .      (Lowpass, Highpass, Bandpass).    <code>AttachGraphics(pGraphics)</code> : <br> <br> <code class="cpp">GetParam(mFilterMode)-&gt;InitEnum("Filter Mode", Filter::FILTER_MODE_LOWPASS, Filter::kNumFilterModes); IBitmap filtermodeBitmap = pGraphics-&gt;LoadIBitmap(FILTERMODE_ID, FILTERMODE_FN, 3); pGraphics-&gt;AttachControl(new ISwitchControl(this, 24, 123, mFilterMode, &amp;filtermodeBitmap));</code> <br> <br>         .    .     <i>knob_small.png</i> : <br> <br> <code class="cpp">// Knobs for filter cutoff and resonance IBitmap smallKnobBitmap = pGraphics-&gt;LoadIBitmap(KNOB_SMALL_ID, KNOB_SMALL_FN, 64); // Cutoff knob: GetParam(mFilterCutoff)-&gt;InitDouble("Cutoff", 0.99, 0.01, 0.99, 0.001); GetParam(mFilterCutoff)-&gt;SetShape(2); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 5, 177, mFilterCutoff, &amp;smallKnobBitmap)); // Resonance knob: GetParam(mFilterResonance)-&gt;InitDouble("Resonance", 0.01, 0.01, 1.0, 0.001); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 61, 177, mFilterResonance, &amp;smallKnobBitmap));</code> <br> <br>   ,           <code>1.0</code> ,   <code>calculateFeedbackAmount</code>    , . <br>  <code>ProcessDoubleReplacing</code>     : <br> <br> <code class="cpp">leftOutput[i] = rightOutput[i] = mFilter.process(mOscillator.nextSample() * mEnvelopeGenerator.nextSample() * velocity / 127.0);</code> <br> <br>       .  <code>switch</code>   <code>Synthesis::OnParamChange</code> : <br> <br> <code class="cpp">case mFilterCutoff: mFilter.setCutoff(GetParam(paramIdx)-&gt;Value()); break; case mFilterResonance: mFilter.setResonance(GetParam(paramIdx)-&gt;Value()); break; case mFilterMode: mFilter.setFilterMode(static_cast&lt;Filter::FilterMode&gt;(GetParam(paramIdx)-&gt;Int())); break;</code> <br> <br>    .  -      . <br> <br>  <br> <br>  ‚Äî      .   ,   ,          . <br>      : <br> <br> <code class="cpp">buf0 += cutoff * (inputValue - buf0 + feedbackAmount * (buf0 - buf1));</code> <br> <br> ,   ,      ( <code>buf0 ‚Äì buf1</code> ),   <code>feedbackAmount</code> .    <code>calculateFeedbackAmount</code>  <code>feedbackAmount</code>  <code>resonance</code> , . .    ,   . <br> <br>  ,            .     ,  <i></i> ,      <a href="https://www.youtube.com/watch%3Fv%3DJWyMj6KxGHM"> </a> .    ,        ,       . <br> <br>  -12 /  -24 / <br>        !     24   .     <code>switch</code>  <code>Filter::process</code> : <br> <br> <code class="cpp">buf2 += cutoff * (buf1 - buf2); buf3 += cutoff * (buf2 ‚Äì buf3);</code> <br> <br>   :      ,       ,            .     ,       , , <a href="https://ccrma.stanford.edu/~Jos/filters/Filter_Stability.html"></a> (       ).     <code>switch</code> : <br> <br> <code class="cpp">switch (mode) { case FILTER_MODE_LOWPASS: return buf3; case FILTER_MODE_HIGHPASS: return inputValue - buf3; case FILTER_MODE_BANDPASS: return buf0 - buf3; default: return 0.0; }</code> <br> <br>   <code>buf1</code>  <code>buf3</code> ‚Äì      .    -24 /.     <code>buf2</code>  <code>buf3</code> ,        <code>private</code> <i>Filter.h</i> : <br> <br> <code class="cpp">double buf2; double buf3;</code> <br> <br>    ,   <code>buf0</code> c <code>buf1</code> : <br> <br> <code class="cpp">Filter() : // ... buf0(0.0), buf1(0.0), buf2(0.0), buf3(0.0) // ...</code> <br> <br>     , ,     :     .       . <br>          ? <br> <br>   <br>    .  ,           ,       . <br> -      <code>cutoff</code>   .      .    <code>cutoffMod</code> ,    ,       <code>cutoff</code>    .     <code><code>#include    private</code> : <br> <br> <code class="cpp">double cutoffMod;</code> <br> <br> : <br> <br> <code class="cpp">Filter() : cutoff(0.99), resonance(0.01), cutoffMod(0.0), // ...</code> <br> <br>         .   <code>private</code> : <br> <br> <code class="cpp">inline double getCalculatedCutoff() const { return fmax(fmin(cutoff + cutoffMod, 0.99), 0.01); };</code> <br> <br> <code>calculateFeedbackAmount</code>     : <br> <br> <code class="cpp">inline void calculateFeedbackAmount() { feedbackAmount = resonance + resonance/(1.0 - getCalculatedCutoff()); }</code> <br> <br>       <code>cutoffMod</code> .   <code>feedbackAmount</code>    ,     : <br> <br> <code class="cpp">inline void setCutoffMod(double newCutoffMod) { cutoffMod = newCutoffMod; calculateFeedbackAmount(); }</code> <br> <br> ,       .   <code>Filter::process</code>   : <br> <br> <code class="cpp">if (inputValue == 0.0) return inputValue; double calculatedCutoff = getCalculatedCutoff(); buf0 += calculatedCutoff * (inputValue - buf0 + feedbackAmount * (buf0 - buf1)); buf1 += calculatedCutoff * (buf0 - buf1); buf2 += calculatedCutoff * (buf1 - buf2); buf3 += calculatedCutoff * (buf2 ‚Äì buf3);</code> <br> <br>        ,    .    ,      ,   .     .     <code>cutoff</code>  <code>calculatedCutoff</code>   -. <br> <br> ,       ( <code>setCutoffMod</code> ),   <code>Synthesis</code>    ,     ,    .    ,        <code>cutoffMod</code> .    <code>filterEnvelopeAmount</code>    <code>-1</code>  <code>+1</code> .   GUI. <br> <br>   <code>private</code> <i>Synthesis.h</i>    : <br> <br> <code class="cpp">EnvelopeGenerator mFilterEnvelopeGenerator; double filterEnvelopeAmount;</code> <br> <br>       MIDI ,      <code>onNoteOn</code>  <code>onNoteOff</code> : <br> <br> <code class="cpp">inline void onNoteOn(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); mFilterEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); }; inline void onNoteOff(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); mFilterEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); };</code> <br> <br>    .   <code>ProcessDoubleReplacing</code>        : <br> <br> <code class="cpp">mFilter.setCutoffMod(mFilterEnvelopeGenerator.nextSample() * filterEnvelopeAmount);</code> <br> <br>  ,        <code>nextSample</code>  <code>filterEnvelopeAmount</code>     <code>cutoffMod</code> .     <code>filterEnvelopeAmount</code>  : <br> <br> <code class="cpp">Synthesis::Synthesis(IPlugInstanceInfo instanceInfo) : IPLUG_CTOR(kNumParams, kNumPrograms, instanceInfo), lastVirtualKeyboardNoteNumber(virtualKeyboardMinimumNoteNumber - 1), filterEnvelopeAmount(0.0) { // ... }</code> <br> <br>       <code>Synthesis::Reset</code> : <br> <br> <code class="cpp">mFilterEnvelopeGenerator.setSampleRate(GetSampleRate());</code> <br> <br>      <code>EParams</code> ,       .  <code>AttachGraphics</code>     : <br> <br> <code class="cpp">// Knobs for filter envelope // Attack knob GetParam(mFilterAttack)-&gt;InitDouble("Filter Env Attack", 0.01, 0.01, 10.0, 0.001); GetParam(mFilterAttack)-&gt;SetShape(3); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 139, 178, mFilterAttack, &amp;smallKnobBitmap)); // Decay knob: GetParam(mFilterDecay)-&gt;InitDouble("Filter Env Decay", 0.5, 0.01, 15.0, 0.001); GetParam(mFilterDecay)-&gt;SetShape(3); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 195, 178, mFilterDecay, &amp;smallKnobBitmap)); // Sustain knob: GetParam(mFilterSustain)-&gt;InitDouble("Filter Env Sustain", 0.1, 0.001, 1.0, 0.001); GetParam(mFilterSustain)-&gt;SetShape(2); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 251, 178, mFilterSustain, &amp;smallKnobBitmap)); // Release knob: GetParam(mFilterRelease)-&gt;InitDouble("Filter Env Release", 1.0, 0.001, 15.0, 0.001); GetParam(mFilterRelease)-&gt;SetShape(3); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 307, 178, mFilterRelease, &amp;smallKnobBitmap)); // Filter envelope amount knob: GetParam(mFilterEnvelopeAmount)-&gt;InitDouble("Filter Env Amount", 0.0, -1.0, 1.0, 0.001); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 363, 178, mFilterEnvelopeAmount, &amp;smallKnobBitmap));</code> <br> <br>     ,       <code>smallKnobBitmap</code> .                   .     ,    .  <code>Synthesis::OnParamChange</code>    <code>switch</code> : <br> <br> <code class="cpp">case mFilterAttack: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK, GetParam(paramIdx)-&gt;Value()); break; case mFilterDecay: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_DECAY, GetParam(paramIdx)-&gt;Value()); break; case mFilterSustain: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_SUSTAIN, GetParam(paramIdx)-&gt;Value()); break; case mFilterRelease: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE, GetParam(paramIdx)-&gt;Value()); break; case mFilterEnvelopeAmount: filterEnvelopeAmount = GetParam(paramIdx)-&gt;Value(); break;</code> <br> <br> ! <br>     !           (-   C1),   : <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/f5d/757/3f9/f5d7573f9b3a720fe5898d88ae477cfc.png"> <br> <br>        <code>EnvelopeGenerator</code>  .         .        ! <br> <br>    <a href=""></a> . <br> <br>        :) <br> <br>  : <br> <a href="http://martin-finke.de/blog/articles/audio-plugins-013-filter/">martin-finke.de/blog/articles/audio-plugins-013-filter</a></code></code> </li> <li> <code><code class="cpp">#include  <i>Filter.h</i> ( )     : <br> <br> class Filter { public: enum FilterMode { FILTER_MODE_LOWPASS = 0, FILTER_MODE_HIGHPASS, FILTER_MODE_BANDPASS, kNumFilterModes }; Filter() : cutoff(0.99), resonance(0.0), mode(FILTER_MODE_LOWPASS), buf0(0.0), buf1(0.0) { calculateFeedbackAmount(); }; double process(double inputValue); inline void setCutoff(double newCutoff) { cutoff = newCutoff; calculateFeedbackAmount(); }; inline void setResonance(double newResonance) { resonance = newResonance; calculateFeedbackAmount(); }; inline void setFilterMode(FilterMode newMode) { mode = newMode; } private: double cutoff; double resonance; FilterMode mode; double feedbackAmount; inline void calculateFeedbackAmount() { feedbackAmount = resonance + resonance/(1.0 - cutoff); } double buf0; double buf1; };</code> <br> <br>  <code>private</code>     <i> </i> <code>cutoff</code>  <i></i> <code>resonance</code> . <code>Mode</code>      (Lowpass, Highpass, Bandpass).  <code>feedbackAmount</code> , <code>buf0</code>  <code>buf1</code>    ,    . <br>          ( <code>calculateFeedbackAmount()</code> ).  <code>process</code>      .   <code>feedbackAmount</code>   <code>cutoff</code>  <code>resonance</code> ,    <code>calculateFeedbackAmount</code>      . <br> <br>   <i>Filter.cpp</i>  : <br> <br> <code class="cpp">// By Paul Kellett // http://www.musicdsp.org/showone.php?id=29 double Filter::process(double inputValue) { buf0 += cutoff * (inputValue - buf0); buf1 += cutoff * (buf0 - buf1); switch (mode) { case FILTER_MODE_LOWPASS: return buf1; case FILTER_MODE_HIGHPASS: return inputValue - buf0; case FILTER_MODE_BANDPASS: return buf0 - buf1; default: return 0.0; } }</code> <br> <br> , ?  ,         <i> </i> . ¬´ ¬ª   ,               (. .    6 ).     <code>buf0</code>  <code>buf1</code> :        .     <code>inputValue</code> ,  - <code>buf0</code> (  ).   .    6 /   12 /.  <code>switch</code> ,  <code>buf1</code>    . , ,    <code>buf0</code> ,       12,   6 /,        . <br> <br>  <code>case</code> <code>FILTER_MODE_HIGHPASS</code>    . <code>buf0</code>       .   <code>inputValue</code>  <code>buf0</code> ,   .    <code>buf1</code> ,     . <br> <br>  <code>case</code> <code>FILTER_MODE_BANDPASS</code> ,  <code>buf0 - buf1</code>   .  <code>buf0</code>       ,     <code>buf1</code> . ,   . <br>  :    <i> </i>    <i> </i> ,   . <br> <br>  <code>buf1</code>     .       <a href="http://ru.wikipedia.org/wiki/%25D0%25A4%25D0%25B8%25D0%25BB%25D1%258C%25D1%2582%25D1%2580_%25D1%2581_%25D0%25B1%25D0%25B5%25D1%2581%25D0%25BA%25D0%25BE%25D0%25BD%25D0%25B5%25D1%2587%25D0%25BD%25D0%25BE%25D0%25B9_%25D0%25B8%25D0%25BC%25D0%25BF%25D1%2583%25D0%25BB%25D1%258C%25D1%2581%25D0%25BD%25D0%25BE%25D0%25B9_%25D1%2585%25D0%25B0%25D1%2580%25D0%25B0%25D0%25BA%25D1%2582%25D0%25B5%25D1%2580%25D0%25B8%25D1%2581%25D1%2582%25D0%25B8%25D0%25BA%25D0%25BE%25D0%25B9">    </a> ( <i>Infinite Impulse Response</i> ,  <i>IIR</i> ).  <a href="http://www.dspguide.com/ch14/1.htm"> </a> ,      .      ,         ,      . <br> <br>   <br>       ,     ,     .   ,  ,      ,  ,          .           ,  NI Massive,   ¬´ <a href="http://lurkmore.to/%25D0%25A2%25D1%2591%25D0%25BF%25D0%25BB%25D1%258B%25D0%25B9_%25D0%25BB%25D0%25B0%25D0%25BC%25D0%25BF%25D0%25BE%25D0%25B2%25D1%258B%25D0%25B9_%25D0%25B7%25D0%25B2%25D1%2583%25D0%25BA">  </a> ¬ª.       ,          ,   .        ,          (  Massive       ).      ¬´¬ª , , , AAS Ultra Analog,       ,     ,    ,        .         ,  ,    <a href="http://www.kvraudio.com/forum/viewtopic.php%3Ft%3D350246"></a> ,   ,      NI Reaktor. ,            ‚Äî    ,    ..     . <br> <br>   <br>     .   GUI.  <i>bg.png</i>   ( <i>‚ÄúMove to trash‚Äù</i>  Xcode),       : <br> <br> <a href="">filtermode.png</a> <a href="">knob_small.png</a> (  ,   50 50 ) <a href="">bg.png</a> (       ) <br> <br>    ID  <i>resource.h</i> : <br> <br> <code class="cpp">// Unique IDs for each image resource. #define BG_ID 101 #define WHITE_KEY_ID 102 #define BLACK_KEY_ID 103 #define WAVEFORM_ID 104 #define KNOB_ID 105 #define KNOB_SMALL_ID 106 #define FILTERMODE_ID 107 // Image resource locations for this plug. #define BG_FN "resources/img/bg.png" #define WHITE_KEY_FN "resources/img/whitekey.png" #define BLACK_KEY_FN "resources/img/blackkey.png" #define WAVEFORM_FN "resources/img/waveform.png" #define KNOB_FN "resources/img/knob.png" #define KNOB_SMALL_FN "resources/img/knob_small.png" #define FILTERMODE_FN "resources/img/filtermode.png"</code> <br> <br>  <i>Synthesis.rc</i> : <br> <br> <code class="cpp">#include "resource.h" BG_ID PNG BG_FN WHITE_KEY_ID PNG WHITE_KEY_FN BLACK_KEY_ID PNG BLACK_KEY_FN WAVEFORM_ID PNG WAVEFORM_FN KNOB_ID PNG KNOB_FN KNOB_SMALL_ID PNG KNOB_SMALL_FN FILTERMODE_ID PNG FILTERMODE_FN</code> <br> <br>   <code>#include "Filter.h"</code>  <i>Synthesis.h</i>    <code>private</code> : <br> <br> <code class="cpp">Filter mFilter;</code> <br> <br>  <code>EParams</code>  <i>Synthesis.cpp</i> : <br> <br> <code class="cpp">enum EParams { mWaveform = 0, mAttack, mDecay, mSustain, mRelease, mFilterMode, mFilterCutoff, mFilterResonance, mFilterAttack, mFilterDecay, mFilterSustain, mFilterRelease, mFilterEnvelopeAmount, kNumParams };</code> <br> <br>        : <br> <br> <code class="cpp">pGraphics-&gt;AttachControl(new ISwitchControl(this, 24, 38, mWaveform, &amp;waveformBitmap));</code> <br> <br>      .      (Lowpass, Highpass, Bandpass).    <code>AttachGraphics(pGraphics)</code> : <br> <br> <code class="cpp">GetParam(mFilterMode)-&gt;InitEnum("Filter Mode", Filter::FILTER_MODE_LOWPASS, Filter::kNumFilterModes); IBitmap filtermodeBitmap = pGraphics-&gt;LoadIBitmap(FILTERMODE_ID, FILTERMODE_FN, 3); pGraphics-&gt;AttachControl(new ISwitchControl(this, 24, 123, mFilterMode, &amp;filtermodeBitmap));</code> <br> <br>         .    .     <i>knob_small.png</i> : <br> <br> <code class="cpp">// Knobs for filter cutoff and resonance IBitmap smallKnobBitmap = pGraphics-&gt;LoadIBitmap(KNOB_SMALL_ID, KNOB_SMALL_FN, 64); // Cutoff knob: GetParam(mFilterCutoff)-&gt;InitDouble("Cutoff", 0.99, 0.01, 0.99, 0.001); GetParam(mFilterCutoff)-&gt;SetShape(2); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 5, 177, mFilterCutoff, &amp;smallKnobBitmap)); // Resonance knob: GetParam(mFilterResonance)-&gt;InitDouble("Resonance", 0.01, 0.01, 1.0, 0.001); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 61, 177, mFilterResonance, &amp;smallKnobBitmap));</code> <br> <br>   ,           <code>1.0</code> ,   <code>calculateFeedbackAmount</code>    , . <br>  <code>ProcessDoubleReplacing</code>     : <br> <br> <code class="cpp">leftOutput[i] = rightOutput[i] = mFilter.process(mOscillator.nextSample() * mEnvelopeGenerator.nextSample() * velocity / 127.0);</code> <br> <br>       .  <code>switch</code>   <code>Synthesis::OnParamChange</code> : <br> <br> <code class="cpp">case mFilterCutoff: mFilter.setCutoff(GetParam(paramIdx)-&gt;Value()); break; case mFilterResonance: mFilter.setResonance(GetParam(paramIdx)-&gt;Value()); break; case mFilterMode: mFilter.setFilterMode(static_cast&lt;Filter::FilterMode&gt;(GetParam(paramIdx)-&gt;Int())); break;</code> <br> <br>    .  -      . <br> <br>  <br> <br>  ‚Äî      .   ,   ,          . <br>      : <br> <br> <code class="cpp">buf0 += cutoff * (inputValue - buf0 + feedbackAmount * (buf0 - buf1));</code> <br> <br> ,   ,      ( <code>buf0 ‚Äì buf1</code> ),   <code>feedbackAmount</code> .    <code>calculateFeedbackAmount</code>  <code>feedbackAmount</code>  <code>resonance</code> , . .    ,   . <br> <br>  ,            .     ,  <i></i> ,      <a href="https://www.youtube.com/watch%3Fv%3DJWyMj6KxGHM"> </a> .    ,        ,       . <br> <br>  -12 /  -24 / <br>        !     24   .     <code>switch</code>  <code>Filter::process</code> : <br> <br> <code class="cpp">buf2 += cutoff * (buf1 - buf2); buf3 += cutoff * (buf2 ‚Äì buf3);</code> <br> <br>   :      ,       ,            .     ,       , , <a href="https://ccrma.stanford.edu/~Jos/filters/Filter_Stability.html"></a> (       ).     <code>switch</code> : <br> <br> <code class="cpp">switch (mode) { case FILTER_MODE_LOWPASS: return buf3; case FILTER_MODE_HIGHPASS: return inputValue - buf3; case FILTER_MODE_BANDPASS: return buf0 - buf3; default: return 0.0; }</code> <br> <br>   <code>buf1</code>  <code>buf3</code> ‚Äì      .    -24 /.     <code>buf2</code>  <code>buf3</code> ,        <code>private</code> <i>Filter.h</i> : <br> <br> <code class="cpp">double buf2; double buf3;</code> <br> <br>    ,   <code>buf0</code> c <code>buf1</code> : <br> <br> <code class="cpp">Filter() : // ... buf0(0.0), buf1(0.0), buf2(0.0), buf3(0.0) // ...</code> <br> <br>     , ,     :     .       . <br>          ? <br> <br>   <br>    .  ,           ,       . <br> -      <code>cutoff</code>   .      .    <code>cutoffMod</code> ,    ,       <code>cutoff</code>    .     <code><code>#include    private</code> : <br> <br> <code class="cpp">double cutoffMod;</code> <br> <br> : <br> <br> <code class="cpp">Filter() : cutoff(0.99), resonance(0.01), cutoffMod(0.0), // ...</code> <br> <br>         .   <code>private</code> : <br> <br> <code class="cpp">inline double getCalculatedCutoff() const { return fmax(fmin(cutoff + cutoffMod, 0.99), 0.01); };</code> <br> <br> <code>calculateFeedbackAmount</code>     : <br> <br> <code class="cpp">inline void calculateFeedbackAmount() { feedbackAmount = resonance + resonance/(1.0 - getCalculatedCutoff()); }</code> <br> <br>       <code>cutoffMod</code> .   <code>feedbackAmount</code>    ,     : <br> <br> <code class="cpp">inline void setCutoffMod(double newCutoffMod) { cutoffMod = newCutoffMod; calculateFeedbackAmount(); }</code> <br> <br> ,       .   <code>Filter::process</code>   : <br> <br> <code class="cpp">if (inputValue == 0.0) return inputValue; double calculatedCutoff = getCalculatedCutoff(); buf0 += calculatedCutoff * (inputValue - buf0 + feedbackAmount * (buf0 - buf1)); buf1 += calculatedCutoff * (buf0 - buf1); buf2 += calculatedCutoff * (buf1 - buf2); buf3 += calculatedCutoff * (buf2 ‚Äì buf3);</code> <br> <br>        ,    .    ,      ,   .     .     <code>cutoff</code>  <code>calculatedCutoff</code>   -. <br> <br> ,       ( <code>setCutoffMod</code> ),   <code>Synthesis</code>    ,     ,    .    ,        <code>cutoffMod</code> .    <code>filterEnvelopeAmount</code>    <code>-1</code>  <code>+1</code> .   GUI. <br> <br>   <code>private</code> <i>Synthesis.h</i>    : <br> <br> <code class="cpp">EnvelopeGenerator mFilterEnvelopeGenerator; double filterEnvelopeAmount;</code> <br> <br>       MIDI ,      <code>onNoteOn</code>  <code>onNoteOff</code> : <br> <br> <code class="cpp">inline void onNoteOn(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); mFilterEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); }; inline void onNoteOff(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); mFilterEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); };</code> <br> <br>    .   <code>ProcessDoubleReplacing</code>        : <br> <br> <code class="cpp">mFilter.setCutoffMod(mFilterEnvelopeGenerator.nextSample() * filterEnvelopeAmount);</code> <br> <br>  ,        <code>nextSample</code>  <code>filterEnvelopeAmount</code>     <code>cutoffMod</code> .     <code>filterEnvelopeAmount</code>  : <br> <br> <code class="cpp">Synthesis::Synthesis(IPlugInstanceInfo instanceInfo) : IPLUG_CTOR(kNumParams, kNumPrograms, instanceInfo), lastVirtualKeyboardNoteNumber(virtualKeyboardMinimumNoteNumber - 1), filterEnvelopeAmount(0.0) { // ... }</code> <br> <br>       <code>Synthesis::Reset</code> : <br> <br> <code class="cpp">mFilterEnvelopeGenerator.setSampleRate(GetSampleRate());</code> <br> <br>      <code>EParams</code> ,       .  <code>AttachGraphics</code>     : <br> <br> <code class="cpp">// Knobs for filter envelope // Attack knob GetParam(mFilterAttack)-&gt;InitDouble("Filter Env Attack", 0.01, 0.01, 10.0, 0.001); GetParam(mFilterAttack)-&gt;SetShape(3); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 139, 178, mFilterAttack, &amp;smallKnobBitmap)); // Decay knob: GetParam(mFilterDecay)-&gt;InitDouble("Filter Env Decay", 0.5, 0.01, 15.0, 0.001); GetParam(mFilterDecay)-&gt;SetShape(3); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 195, 178, mFilterDecay, &amp;smallKnobBitmap)); // Sustain knob: GetParam(mFilterSustain)-&gt;InitDouble("Filter Env Sustain", 0.1, 0.001, 1.0, 0.001); GetParam(mFilterSustain)-&gt;SetShape(2); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 251, 178, mFilterSustain, &amp;smallKnobBitmap)); // Release knob: GetParam(mFilterRelease)-&gt;InitDouble("Filter Env Release", 1.0, 0.001, 15.0, 0.001); GetParam(mFilterRelease)-&gt;SetShape(3); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 307, 178, mFilterRelease, &amp;smallKnobBitmap)); // Filter envelope amount knob: GetParam(mFilterEnvelopeAmount)-&gt;InitDouble("Filter Env Amount", 0.0, -1.0, 1.0, 0.001); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 363, 178, mFilterEnvelopeAmount, &amp;smallKnobBitmap));</code> <br> <br>     ,       <code>smallKnobBitmap</code> .                   .     ,    .  <code>Synthesis::OnParamChange</code>    <code>switch</code> : <br> <br> <code class="cpp">case mFilterAttack: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK, GetParam(paramIdx)-&gt;Value()); break; case mFilterDecay: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_DECAY, GetParam(paramIdx)-&gt;Value()); break; case mFilterSustain: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_SUSTAIN, GetParam(paramIdx)-&gt;Value()); break; case mFilterRelease: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE, GetParam(paramIdx)-&gt;Value()); break; case mFilterEnvelopeAmount: filterEnvelopeAmount = GetParam(paramIdx)-&gt;Value(); break;</code> <br> <br> ! <br>     !           (-   C1),   : <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/f5d/757/3f9/f5d7573f9b3a720fe5898d88ae477cfc.png"> <br> <br>        <code>EnvelopeGenerator</code>  .         .        ! <br> <br>    <a href=""></a> . <br> <br>        :) <br> <br>  : <br> <a href="http://martin-finke.de/blog/articles/audio-plugins-013-filter/">martin-finke.de/blog/articles/audio-plugins-013-filter</a></code></code> </li> <li> <code><code class="cpp">#include  <i>Filter.h</i> ( )     : <br> <br> class Filter { public: enum FilterMode { FILTER_MODE_LOWPASS = 0, FILTER_MODE_HIGHPASS, FILTER_MODE_BANDPASS, kNumFilterModes }; Filter() : cutoff(0.99), resonance(0.0), mode(FILTER_MODE_LOWPASS), buf0(0.0), buf1(0.0) { calculateFeedbackAmount(); }; double process(double inputValue); inline void setCutoff(double newCutoff) { cutoff = newCutoff; calculateFeedbackAmount(); }; inline void setResonance(double newResonance) { resonance = newResonance; calculateFeedbackAmount(); }; inline void setFilterMode(FilterMode newMode) { mode = newMode; } private: double cutoff; double resonance; FilterMode mode; double feedbackAmount; inline void calculateFeedbackAmount() { feedbackAmount = resonance + resonance/(1.0 - cutoff); } double buf0; double buf1; };</code> <br> <br>  <code>private</code>     <i> </i> <code>cutoff</code>  <i></i> <code>resonance</code> . <code>Mode</code>      (Lowpass, Highpass, Bandpass).  <code>feedbackAmount</code> , <code>buf0</code>  <code>buf1</code>    ,    . <br>          ( <code>calculateFeedbackAmount()</code> ).  <code>process</code>      .   <code>feedbackAmount</code>   <code>cutoff</code>  <code>resonance</code> ,    <code>calculateFeedbackAmount</code>      . <br> <br>   <i>Filter.cpp</i>  : <br> <br> <code class="cpp">// By Paul Kellett // http://www.musicdsp.org/showone.php?id=29 double Filter::process(double inputValue) { buf0 += cutoff * (inputValue - buf0); buf1 += cutoff * (buf0 - buf1); switch (mode) { case FILTER_MODE_LOWPASS: return buf1; case FILTER_MODE_HIGHPASS: return inputValue - buf0; case FILTER_MODE_BANDPASS: return buf0 - buf1; default: return 0.0; } }</code> <br> <br> , ?  ,         <i> </i> . ¬´ ¬ª   ,               (. .    6 ).     <code>buf0</code>  <code>buf1</code> :        .     <code>inputValue</code> ,  - <code>buf0</code> (  ).   .    6 /   12 /.  <code>switch</code> ,  <code>buf1</code>    . , ,    <code>buf0</code> ,       12,   6 /,        . <br> <br>  <code>case</code> <code>FILTER_MODE_HIGHPASS</code>    . <code>buf0</code>       .   <code>inputValue</code>  <code>buf0</code> ,   .    <code>buf1</code> ,     . <br> <br>  <code>case</code> <code>FILTER_MODE_BANDPASS</code> ,  <code>buf0 - buf1</code>   .  <code>buf0</code>       ,     <code>buf1</code> . ,   . <br>  :    <i> </i>    <i> </i> ,   . <br> <br>  <code>buf1</code>     .       <a href="http://ru.wikipedia.org/wiki/%25D0%25A4%25D0%25B8%25D0%25BB%25D1%258C%25D1%2582%25D1%2580_%25D1%2581_%25D0%25B1%25D0%25B5%25D1%2581%25D0%25BA%25D0%25BE%25D0%25BD%25D0%25B5%25D1%2587%25D0%25BD%25D0%25BE%25D0%25B9_%25D0%25B8%25D0%25BC%25D0%25BF%25D1%2583%25D0%25BB%25D1%258C%25D1%2581%25D0%25BD%25D0%25BE%25D0%25B9_%25D1%2585%25D0%25B0%25D1%2580%25D0%25B0%25D0%25BA%25D1%2582%25D0%25B5%25D1%2580%25D0%25B8%25D1%2581%25D1%2582%25D0%25B8%25D0%25BA%25D0%25BE%25D0%25B9">    </a> ( <i>Infinite Impulse Response</i> ,  <i>IIR</i> ).  <a href="http://www.dspguide.com/ch14/1.htm"> </a> ,      .      ,         ,      . <br> <br>   <br>       ,     ,     .   ,  ,      ,  ,          .           ,  NI Massive,   ¬´ <a href="http://lurkmore.to/%25D0%25A2%25D1%2591%25D0%25BF%25D0%25BB%25D1%258B%25D0%25B9_%25D0%25BB%25D0%25B0%25D0%25BC%25D0%25BF%25D0%25BE%25D0%25B2%25D1%258B%25D0%25B9_%25D0%25B7%25D0%25B2%25D1%2583%25D0%25BA">  </a> ¬ª.       ,          ,   .        ,          (  Massive       ).      ¬´¬ª , , , AAS Ultra Analog,       ,     ,    ,        .         ,  ,    <a href="http://www.kvraudio.com/forum/viewtopic.php%3Ft%3D350246"></a> ,   ,      NI Reaktor. ,            ‚Äî    ,    ..     . <br> <br>   <br>     .   GUI.  <i>bg.png</i>   ( <i>‚ÄúMove to trash‚Äù</i>  Xcode),       : <br> <br> <a href="">filtermode.png</a> <a href="">knob_small.png</a> (  ,   50 50 ) <a href="">bg.png</a> (       ) <br> <br>    ID  <i>resource.h</i> : <br> <br> <code class="cpp">// Unique IDs for each image resource. #define BG_ID 101 #define WHITE_KEY_ID 102 #define BLACK_KEY_ID 103 #define WAVEFORM_ID 104 #define KNOB_ID 105 #define KNOB_SMALL_ID 106 #define FILTERMODE_ID 107 // Image resource locations for this plug. #define BG_FN "resources/img/bg.png" #define WHITE_KEY_FN "resources/img/whitekey.png" #define BLACK_KEY_FN "resources/img/blackkey.png" #define WAVEFORM_FN "resources/img/waveform.png" #define KNOB_FN "resources/img/knob.png" #define KNOB_SMALL_FN "resources/img/knob_small.png" #define FILTERMODE_FN "resources/img/filtermode.png"</code> <br> <br>  <i>Synthesis.rc</i> : <br> <br> <code class="cpp">#include "resource.h" BG_ID PNG BG_FN WHITE_KEY_ID PNG WHITE_KEY_FN BLACK_KEY_ID PNG BLACK_KEY_FN WAVEFORM_ID PNG WAVEFORM_FN KNOB_ID PNG KNOB_FN KNOB_SMALL_ID PNG KNOB_SMALL_FN FILTERMODE_ID PNG FILTERMODE_FN</code> <br> <br>   <code>#include "Filter.h"</code>  <i>Synthesis.h</i>    <code>private</code> : <br> <br> <code class="cpp">Filter mFilter;</code> <br> <br>  <code>EParams</code>  <i>Synthesis.cpp</i> : <br> <br> <code class="cpp">enum EParams { mWaveform = 0, mAttack, mDecay, mSustain, mRelease, mFilterMode, mFilterCutoff, mFilterResonance, mFilterAttack, mFilterDecay, mFilterSustain, mFilterRelease, mFilterEnvelopeAmount, kNumParams };</code> <br> <br>        : <br> <br> <code class="cpp">pGraphics-&gt;AttachControl(new ISwitchControl(this, 24, 38, mWaveform, &amp;waveformBitmap));</code> <br> <br>      .      (Lowpass, Highpass, Bandpass).    <code>AttachGraphics(pGraphics)</code> : <br> <br> <code class="cpp">GetParam(mFilterMode)-&gt;InitEnum("Filter Mode", Filter::FILTER_MODE_LOWPASS, Filter::kNumFilterModes); IBitmap filtermodeBitmap = pGraphics-&gt;LoadIBitmap(FILTERMODE_ID, FILTERMODE_FN, 3); pGraphics-&gt;AttachControl(new ISwitchControl(this, 24, 123, mFilterMode, &amp;filtermodeBitmap));</code> <br> <br>         .    .     <i>knob_small.png</i> : <br> <br> <code class="cpp">// Knobs for filter cutoff and resonance IBitmap smallKnobBitmap = pGraphics-&gt;LoadIBitmap(KNOB_SMALL_ID, KNOB_SMALL_FN, 64); // Cutoff knob: GetParam(mFilterCutoff)-&gt;InitDouble("Cutoff", 0.99, 0.01, 0.99, 0.001); GetParam(mFilterCutoff)-&gt;SetShape(2); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 5, 177, mFilterCutoff, &amp;smallKnobBitmap)); // Resonance knob: GetParam(mFilterResonance)-&gt;InitDouble("Resonance", 0.01, 0.01, 1.0, 0.001); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 61, 177, mFilterResonance, &amp;smallKnobBitmap));</code> <br> <br>   ,           <code>1.0</code> ,   <code>calculateFeedbackAmount</code>    , . <br>  <code>ProcessDoubleReplacing</code>     : <br> <br> <code class="cpp">leftOutput[i] = rightOutput[i] = mFilter.process(mOscillator.nextSample() * mEnvelopeGenerator.nextSample() * velocity / 127.0);</code> <br> <br>       .  <code>switch</code>   <code>Synthesis::OnParamChange</code> : <br> <br> <code class="cpp">case mFilterCutoff: mFilter.setCutoff(GetParam(paramIdx)-&gt;Value()); break; case mFilterResonance: mFilter.setResonance(GetParam(paramIdx)-&gt;Value()); break; case mFilterMode: mFilter.setFilterMode(static_cast&lt;Filter::FilterMode&gt;(GetParam(paramIdx)-&gt;Int())); break;</code> <br> <br>    .  -      . <br> <br>  <br> <br>  ‚Äî      .   ,   ,          . <br>      : <br> <br> <code class="cpp">buf0 += cutoff * (inputValue - buf0 + feedbackAmount * (buf0 - buf1));</code> <br> <br> ,   ,      ( <code>buf0 ‚Äì buf1</code> ),   <code>feedbackAmount</code> .    <code>calculateFeedbackAmount</code>  <code>feedbackAmount</code>  <code>resonance</code> , . .    ,   . <br> <br>  ,            .     ,  <i></i> ,      <a href="https://www.youtube.com/watch%3Fv%3DJWyMj6KxGHM"> </a> .    ,        ,       . <br> <br>  -12 /  -24 / <br>        !     24   .     <code>switch</code>  <code>Filter::process</code> : <br> <br> <code class="cpp">buf2 += cutoff * (buf1 - buf2); buf3 += cutoff * (buf2 ‚Äì buf3);</code> <br> <br>   :      ,       ,            .     ,       , , <a href="https://ccrma.stanford.edu/~Jos/filters/Filter_Stability.html"></a> (       ).     <code>switch</code> : <br> <br> <code class="cpp">switch (mode) { case FILTER_MODE_LOWPASS: return buf3; case FILTER_MODE_HIGHPASS: return inputValue - buf3; case FILTER_MODE_BANDPASS: return buf0 - buf3; default: return 0.0; }</code> <br> <br>   <code>buf1</code>  <code>buf3</code> ‚Äì      .    -24 /.     <code>buf2</code>  <code>buf3</code> ,        <code>private</code> <i>Filter.h</i> : <br> <br> <code class="cpp">double buf2; double buf3;</code> <br> <br>    ,   <code>buf0</code> c <code>buf1</code> : <br> <br> <code class="cpp">Filter() : // ... buf0(0.0), buf1(0.0), buf2(0.0), buf3(0.0) // ...</code> <br> <br>     , ,     :     .       . <br>          ? <br> <br>   <br>    .  ,           ,       . <br> -      <code>cutoff</code>   .      .    <code>cutoffMod</code> ,    ,       <code>cutoff</code>    .     <code><code>#include    private</code> : <br> <br> <code class="cpp">double cutoffMod;</code> <br> <br> : <br> <br> <code class="cpp">Filter() : cutoff(0.99), resonance(0.01), cutoffMod(0.0), // ...</code> <br> <br>         .   <code>private</code> : <br> <br> <code class="cpp">inline double getCalculatedCutoff() const { return fmax(fmin(cutoff + cutoffMod, 0.99), 0.01); };</code> <br> <br> <code>calculateFeedbackAmount</code>     : <br> <br> <code class="cpp">inline void calculateFeedbackAmount() { feedbackAmount = resonance + resonance/(1.0 - getCalculatedCutoff()); }</code> <br> <br>       <code>cutoffMod</code> .   <code>feedbackAmount</code>    ,     : <br> <br> <code class="cpp">inline void setCutoffMod(double newCutoffMod) { cutoffMod = newCutoffMod; calculateFeedbackAmount(); }</code> <br> <br> ,       .   <code>Filter::process</code>   : <br> <br> <code class="cpp">if (inputValue == 0.0) return inputValue; double calculatedCutoff = getCalculatedCutoff(); buf0 += calculatedCutoff * (inputValue - buf0 + feedbackAmount * (buf0 - buf1)); buf1 += calculatedCutoff * (buf0 - buf1); buf2 += calculatedCutoff * (buf1 - buf2); buf3 += calculatedCutoff * (buf2 ‚Äì buf3);</code> <br> <br>        ,    .    ,      ,   .     .     <code>cutoff</code>  <code>calculatedCutoff</code>   -. <br> <br> ,       ( <code>setCutoffMod</code> ),   <code>Synthesis</code>    ,     ,    .    ,        <code>cutoffMod</code> .    <code>filterEnvelopeAmount</code>    <code>-1</code>  <code>+1</code> .   GUI. <br> <br>   <code>private</code> <i>Synthesis.h</i>    : <br> <br> <code class="cpp">EnvelopeGenerator mFilterEnvelopeGenerator; double filterEnvelopeAmount;</code> <br> <br>       MIDI ,      <code>onNoteOn</code>  <code>onNoteOff</code> : <br> <br> <code class="cpp">inline void onNoteOn(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); mFilterEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); }; inline void onNoteOff(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); mFilterEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); };</code> <br> <br>    .   <code>ProcessDoubleReplacing</code>        : <br> <br> <code class="cpp">mFilter.setCutoffMod(mFilterEnvelopeGenerator.nextSample() * filterEnvelopeAmount);</code> <br> <br>  ,        <code>nextSample</code>  <code>filterEnvelopeAmount</code>     <code>cutoffMod</code> .     <code>filterEnvelopeAmount</code>  : <br> <br> <code class="cpp">Synthesis::Synthesis(IPlugInstanceInfo instanceInfo) : IPLUG_CTOR(kNumParams, kNumPrograms, instanceInfo), lastVirtualKeyboardNoteNumber(virtualKeyboardMinimumNoteNumber - 1), filterEnvelopeAmount(0.0) { // ... }</code> <br> <br>       <code>Synthesis::Reset</code> : <br> <br> <code class="cpp">mFilterEnvelopeGenerator.setSampleRate(GetSampleRate());</code> <br> <br>      <code>EParams</code> ,       .  <code>AttachGraphics</code>     : <br> <br> <code class="cpp">// Knobs for filter envelope // Attack knob GetParam(mFilterAttack)-&gt;InitDouble("Filter Env Attack", 0.01, 0.01, 10.0, 0.001); GetParam(mFilterAttack)-&gt;SetShape(3); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 139, 178, mFilterAttack, &amp;smallKnobBitmap)); // Decay knob: GetParam(mFilterDecay)-&gt;InitDouble("Filter Env Decay", 0.5, 0.01, 15.0, 0.001); GetParam(mFilterDecay)-&gt;SetShape(3); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 195, 178, mFilterDecay, &amp;smallKnobBitmap)); // Sustain knob: GetParam(mFilterSustain)-&gt;InitDouble("Filter Env Sustain", 0.1, 0.001, 1.0, 0.001); GetParam(mFilterSustain)-&gt;SetShape(2); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 251, 178, mFilterSustain, &amp;smallKnobBitmap)); // Release knob: GetParam(mFilterRelease)-&gt;InitDouble("Filter Env Release", 1.0, 0.001, 15.0, 0.001); GetParam(mFilterRelease)-&gt;SetShape(3); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 307, 178, mFilterRelease, &amp;smallKnobBitmap)); // Filter envelope amount knob: GetParam(mFilterEnvelopeAmount)-&gt;InitDouble("Filter Env Amount", 0.0, -1.0, 1.0, 0.001); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 363, 178, mFilterEnvelopeAmount, &amp;smallKnobBitmap));</code> <br> <br>     ,       <code>smallKnobBitmap</code> .                   .     ,    .  <code>Synthesis::OnParamChange</code>    <code>switch</code> : <br> <br> <code class="cpp">case mFilterAttack: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK, GetParam(paramIdx)-&gt;Value()); break; case mFilterDecay: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_DECAY, GetParam(paramIdx)-&gt;Value()); break; case mFilterSustain: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_SUSTAIN, GetParam(paramIdx)-&gt;Value()); break; case mFilterRelease: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE, GetParam(paramIdx)-&gt;Value()); break; case mFilterEnvelopeAmount: filterEnvelopeAmount = GetParam(paramIdx)-&gt;Value(); break;</code> <br> <br> ! <br>     !           (-   C1),   : <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/f5d/757/3f9/f5d7573f9b3a720fe5898d88ae477cfc.png"> <br> <br>        <code>EnvelopeGenerator</code>  .         .        ! <br> <br>    <a href=""></a> . <br> <br>        :) <br> <br>  : <br> <a href="http://martin-finke.de/blog/articles/audio-plugins-013-filter/">martin-finke.de/blog/articles/audio-plugins-013-filter</a></code></code> </li> </ul> <code><code class="cpp">#include  <i>Filter.h</i> ( )     : <br> <br> class Filter { public: enum FilterMode { FILTER_MODE_LOWPASS = 0, FILTER_MODE_HIGHPASS, FILTER_MODE_BANDPASS, kNumFilterModes }; Filter() : cutoff(0.99), resonance(0.0), mode(FILTER_MODE_LOWPASS), buf0(0.0), buf1(0.0) { calculateFeedbackAmount(); }; double process(double inputValue); inline void setCutoff(double newCutoff) { cutoff = newCutoff; calculateFeedbackAmount(); }; inline void setResonance(double newResonance) { resonance = newResonance; calculateFeedbackAmount(); }; inline void setFilterMode(FilterMode newMode) { mode = newMode; } private: double cutoff; double resonance; FilterMode mode; double feedbackAmount; inline void calculateFeedbackAmount() { feedbackAmount = resonance + resonance/(1.0 - cutoff); } double buf0; double buf1; };</code> <br> <br>  <code>private</code>     <i> </i> <code>cutoff</code>  <i></i> <code>resonance</code> . <code>Mode</code>      (Lowpass, Highpass, Bandpass).  <code>feedbackAmount</code> , <code>buf0</code>  <code>buf1</code>    ,    . <br>          ( <code>calculateFeedbackAmount()</code> ).  <code>process</code>      .   <code>feedbackAmount</code>   <code>cutoff</code>  <code>resonance</code> ,    <code>calculateFeedbackAmount</code>      . <br> <br>   <i>Filter.cpp</i>  : <br> <br> <code class="cpp">// By Paul Kellett // http://www.musicdsp.org/showone.php?id=29 double Filter::process(double inputValue) { buf0 += cutoff * (inputValue - buf0); buf1 += cutoff * (buf0 - buf1); switch (mode) { case FILTER_MODE_LOWPASS: return buf1; case FILTER_MODE_HIGHPASS: return inputValue - buf0; case FILTER_MODE_BANDPASS: return buf0 - buf1; default: return 0.0; } }</code> <br> <br> , ?  ,         <i> </i> . ¬´ ¬ª   ,               (. .    6 ).     <code>buf0</code>  <code>buf1</code> :        .     <code>inputValue</code> ,  - <code>buf0</code> (  ).   .    6 /   12 /.  <code>switch</code> ,  <code>buf1</code>    . , ,    <code>buf0</code> ,       12,   6 /,        . <br> <br>  <code>case</code> <code>FILTER_MODE_HIGHPASS</code>    . <code>buf0</code>       .   <code>inputValue</code>  <code>buf0</code> ,   .    <code>buf1</code> ,     . <br> <br>  <code>case</code> <code>FILTER_MODE_BANDPASS</code> ,  <code>buf0 - buf1</code>   .  <code>buf0</code>       ,     <code>buf1</code> . ,   . <br>  :    <i> </i>    <i> </i> ,   . <br> <br>  <code>buf1</code>     .       <a href="http://ru.wikipedia.org/wiki/%25D0%25A4%25D0%25B8%25D0%25BB%25D1%258C%25D1%2582%25D1%2580_%25D1%2581_%25D0%25B1%25D0%25B5%25D1%2581%25D0%25BA%25D0%25BE%25D0%25BD%25D0%25B5%25D1%2587%25D0%25BD%25D0%25BE%25D0%25B9_%25D0%25B8%25D0%25BC%25D0%25BF%25D1%2583%25D0%25BB%25D1%258C%25D1%2581%25D0%25BD%25D0%25BE%25D0%25B9_%25D1%2585%25D0%25B0%25D1%2580%25D0%25B0%25D0%25BA%25D1%2582%25D0%25B5%25D1%2580%25D0%25B8%25D1%2581%25D1%2582%25D0%25B8%25D0%25BA%25D0%25BE%25D0%25B9">    </a> ( <i>Infinite Impulse Response</i> ,  <i>IIR</i> ).  <a href="http://www.dspguide.com/ch14/1.htm"> </a> ,      .      ,         ,      . <br> <br>   <br>       ,     ,     .   ,  ,      ,  ,          .           ,  NI Massive,   ¬´ <a href="http://lurkmore.to/%25D0%25A2%25D1%2591%25D0%25BF%25D0%25BB%25D1%258B%25D0%25B9_%25D0%25BB%25D0%25B0%25D0%25BC%25D0%25BF%25D0%25BE%25D0%25B2%25D1%258B%25D0%25B9_%25D0%25B7%25D0%25B2%25D1%2583%25D0%25BA">  </a> ¬ª.       ,          ,   .        ,          (  Massive       ).      ¬´¬ª , , , AAS Ultra Analog,       ,     ,    ,        .         ,  ,    <a href="http://www.kvraudio.com/forum/viewtopic.php%3Ft%3D350246"></a> ,   ,      NI Reaktor. ,            ‚Äî    ,    ..     . <br> <br>   <br>     .   GUI.  <i>bg.png</i>   ( <i>‚ÄúMove to trash‚Äù</i>  Xcode),       : <br> <br> <a href="">filtermode.png</a> <a href="">knob_small.png</a> (  ,   50 50 ) <a href="">bg.png</a> (       ) <br> <br>    ID  <i>resource.h</i> : <br> <br> <code class="cpp">// Unique IDs for each image resource. #define BG_ID 101 #define WHITE_KEY_ID 102 #define BLACK_KEY_ID 103 #define WAVEFORM_ID 104 #define KNOB_ID 105 #define KNOB_SMALL_ID 106 #define FILTERMODE_ID 107 // Image resource locations for this plug. #define BG_FN "resources/img/bg.png" #define WHITE_KEY_FN "resources/img/whitekey.png" #define BLACK_KEY_FN "resources/img/blackkey.png" #define WAVEFORM_FN "resources/img/waveform.png" #define KNOB_FN "resources/img/knob.png" #define KNOB_SMALL_FN "resources/img/knob_small.png" #define FILTERMODE_FN "resources/img/filtermode.png"</code> <br> <br>  <i>Synthesis.rc</i> : <br> <br> <code class="cpp">#include "resource.h" BG_ID PNG BG_FN WHITE_KEY_ID PNG WHITE_KEY_FN BLACK_KEY_ID PNG BLACK_KEY_FN WAVEFORM_ID PNG WAVEFORM_FN KNOB_ID PNG KNOB_FN KNOB_SMALL_ID PNG KNOB_SMALL_FN FILTERMODE_ID PNG FILTERMODE_FN</code> <br> <br>   <code>#include "Filter.h"</code>  <i>Synthesis.h</i>    <code>private</code> : <br> <br> <code class="cpp">Filter mFilter;</code> <br> <br>  <code>EParams</code>  <i>Synthesis.cpp</i> : <br> <br> <code class="cpp">enum EParams { mWaveform = 0, mAttack, mDecay, mSustain, mRelease, mFilterMode, mFilterCutoff, mFilterResonance, mFilterAttack, mFilterDecay, mFilterSustain, mFilterRelease, mFilterEnvelopeAmount, kNumParams };</code> <br> <br>        : <br> <br> <code class="cpp">pGraphics-&gt;AttachControl(new ISwitchControl(this, 24, 38, mWaveform, &amp;waveformBitmap));</code> <br> <br>      .      (Lowpass, Highpass, Bandpass).    <code>AttachGraphics(pGraphics)</code> : <br> <br> <code class="cpp">GetParam(mFilterMode)-&gt;InitEnum("Filter Mode", Filter::FILTER_MODE_LOWPASS, Filter::kNumFilterModes); IBitmap filtermodeBitmap = pGraphics-&gt;LoadIBitmap(FILTERMODE_ID, FILTERMODE_FN, 3); pGraphics-&gt;AttachControl(new ISwitchControl(this, 24, 123, mFilterMode, &amp;filtermodeBitmap));</code> <br> <br>         .    .     <i>knob_small.png</i> : <br> <br> <code class="cpp">// Knobs for filter cutoff and resonance IBitmap smallKnobBitmap = pGraphics-&gt;LoadIBitmap(KNOB_SMALL_ID, KNOB_SMALL_FN, 64); // Cutoff knob: GetParam(mFilterCutoff)-&gt;InitDouble("Cutoff", 0.99, 0.01, 0.99, 0.001); GetParam(mFilterCutoff)-&gt;SetShape(2); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 5, 177, mFilterCutoff, &amp;smallKnobBitmap)); // Resonance knob: GetParam(mFilterResonance)-&gt;InitDouble("Resonance", 0.01, 0.01, 1.0, 0.001); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 61, 177, mFilterResonance, &amp;smallKnobBitmap));</code> <br> <br>   ,           <code>1.0</code> ,   <code>calculateFeedbackAmount</code>    , . <br>  <code>ProcessDoubleReplacing</code>     : <br> <br> <code class="cpp">leftOutput[i] = rightOutput[i] = mFilter.process(mOscillator.nextSample() * mEnvelopeGenerator.nextSample() * velocity / 127.0);</code> <br> <br>       .  <code>switch</code>   <code>Synthesis::OnParamChange</code> : <br> <br> <code class="cpp">case mFilterCutoff: mFilter.setCutoff(GetParam(paramIdx)-&gt;Value()); break; case mFilterResonance: mFilter.setResonance(GetParam(paramIdx)-&gt;Value()); break; case mFilterMode: mFilter.setFilterMode(static_cast&lt;Filter::FilterMode&gt;(GetParam(paramIdx)-&gt;Int())); break;</code> <br> <br>    .  -      . <br> <br>  <br> <br>  ‚Äî      .   ,   ,          . <br>      : <br> <br> <code class="cpp">buf0 += cutoff * (inputValue - buf0 + feedbackAmount * (buf0 - buf1));</code> <br> <br> ,   ,      ( <code>buf0 ‚Äì buf1</code> ),   <code>feedbackAmount</code> .    <code>calculateFeedbackAmount</code>  <code>feedbackAmount</code>  <code>resonance</code> , . .    ,   . <br> <br>  ,            .     ,  <i></i> ,      <a href="https://www.youtube.com/watch%3Fv%3DJWyMj6KxGHM"> </a> .    ,        ,       . <br> <br>  -12 /  -24 / <br>        !     24   .     <code>switch</code>  <code>Filter::process</code> : <br> <br> <code class="cpp">buf2 += cutoff * (buf1 - buf2); buf3 += cutoff * (buf2 ‚Äì buf3);</code> <br> <br>   :      ,       ,            .     ,       , , <a href="https://ccrma.stanford.edu/~Jos/filters/Filter_Stability.html"></a> (       ).     <code>switch</code> : <br> <br> <code class="cpp">switch (mode) { case FILTER_MODE_LOWPASS: return buf3; case FILTER_MODE_HIGHPASS: return inputValue - buf3; case FILTER_MODE_BANDPASS: return buf0 - buf3; default: return 0.0; }</code> <br> <br>   <code>buf1</code>  <code>buf3</code> ‚Äì      .    -24 /.     <code>buf2</code>  <code>buf3</code> ,        <code>private</code> <i>Filter.h</i> : <br> <br> <code class="cpp">double buf2; double buf3;</code> <br> <br>    ,   <code>buf0</code> c <code>buf1</code> : <br> <br> <code class="cpp">Filter() : // ... buf0(0.0), buf1(0.0), buf2(0.0), buf3(0.0) // ...</code> <br> <br>     , ,     :     .       . <br>          ? <br> <br>   <br>    .  ,           ,       . <br> -      <code>cutoff</code>   .      .    <code>cutoffMod</code> ,    ,       <code>cutoff</code>    .     <code><code>#include    private</code> : <br> <br> <code class="cpp">double cutoffMod;</code> <br> <br> : <br> <br> <code class="cpp">Filter() : cutoff(0.99), resonance(0.01), cutoffMod(0.0), // ...</code> <br> <br>         .   <code>private</code> : <br> <br> <code class="cpp">inline double getCalculatedCutoff() const { return fmax(fmin(cutoff + cutoffMod, 0.99), 0.01); };</code> <br> <br> <code>calculateFeedbackAmount</code>     : <br> <br> <code class="cpp">inline void calculateFeedbackAmount() { feedbackAmount = resonance + resonance/(1.0 - getCalculatedCutoff()); }</code> <br> <br>       <code>cutoffMod</code> .   <code>feedbackAmount</code>    ,     : <br> <br> <code class="cpp">inline void setCutoffMod(double newCutoffMod) { cutoffMod = newCutoffMod; calculateFeedbackAmount(); }</code> <br> <br> ,       .   <code>Filter::process</code>   : <br> <br> <code class="cpp">if (inputValue == 0.0) return inputValue; double calculatedCutoff = getCalculatedCutoff(); buf0 += calculatedCutoff * (inputValue - buf0 + feedbackAmount * (buf0 - buf1)); buf1 += calculatedCutoff * (buf0 - buf1); buf2 += calculatedCutoff * (buf1 - buf2); buf3 += calculatedCutoff * (buf2 ‚Äì buf3);</code> <br> <br>        ,    .    ,      ,   .     .     <code>cutoff</code>  <code>calculatedCutoff</code>   -. <br> <br> ,       ( <code>setCutoffMod</code> ),   <code>Synthesis</code>    ,     ,    .    ,        <code>cutoffMod</code> .    <code>filterEnvelopeAmount</code>    <code>-1</code>  <code>+1</code> .   GUI. <br> <br>   <code>private</code> <i>Synthesis.h</i>    : <br> <br> <code class="cpp">EnvelopeGenerator mFilterEnvelopeGenerator; double filterEnvelopeAmount;</code> <br> <br>       MIDI ,      <code>onNoteOn</code>  <code>onNoteOff</code> : <br> <br> <code class="cpp">inline void onNoteOn(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); mFilterEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); }; inline void onNoteOff(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); mFilterEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); };</code> <br> <br>    .   <code>ProcessDoubleReplacing</code>        : <br> <br> <code class="cpp">mFilter.setCutoffMod(mFilterEnvelopeGenerator.nextSample() * filterEnvelopeAmount);</code> <br> <br>  ,        <code>nextSample</code>  <code>filterEnvelopeAmount</code>     <code>cutoffMod</code> .     <code>filterEnvelopeAmount</code>  : <br> <br> <code class="cpp">Synthesis::Synthesis(IPlugInstanceInfo instanceInfo) : IPLUG_CTOR(kNumParams, kNumPrograms, instanceInfo), lastVirtualKeyboardNoteNumber(virtualKeyboardMinimumNoteNumber - 1), filterEnvelopeAmount(0.0) { // ... }</code> <br> <br>       <code>Synthesis::Reset</code> : <br> <br> <code class="cpp">mFilterEnvelopeGenerator.setSampleRate(GetSampleRate());</code> <br> <br>      <code>EParams</code> ,       .  <code>AttachGraphics</code>     : <br> <br> <code class="cpp">// Knobs for filter envelope // Attack knob GetParam(mFilterAttack)-&gt;InitDouble("Filter Env Attack", 0.01, 0.01, 10.0, 0.001); GetParam(mFilterAttack)-&gt;SetShape(3); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 139, 178, mFilterAttack, &amp;smallKnobBitmap)); // Decay knob: GetParam(mFilterDecay)-&gt;InitDouble("Filter Env Decay", 0.5, 0.01, 15.0, 0.001); GetParam(mFilterDecay)-&gt;SetShape(3); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 195, 178, mFilterDecay, &amp;smallKnobBitmap)); // Sustain knob: GetParam(mFilterSustain)-&gt;InitDouble("Filter Env Sustain", 0.1, 0.001, 1.0, 0.001); GetParam(mFilterSustain)-&gt;SetShape(2); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 251, 178, mFilterSustain, &amp;smallKnobBitmap)); // Release knob: GetParam(mFilterRelease)-&gt;InitDouble("Filter Env Release", 1.0, 0.001, 15.0, 0.001); GetParam(mFilterRelease)-&gt;SetShape(3); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 307, 178, mFilterRelease, &amp;smallKnobBitmap)); // Filter envelope amount knob: GetParam(mFilterEnvelopeAmount)-&gt;InitDouble("Filter Env Amount", 0.0, -1.0, 1.0, 0.001); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 363, 178, mFilterEnvelopeAmount, &amp;smallKnobBitmap));</code> <br> <br>     ,       <code>smallKnobBitmap</code> .                   .     ,    .  <code>Synthesis::OnParamChange</code>    <code>switch</code> : <br> <br> <code class="cpp">case mFilterAttack: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK, GetParam(paramIdx)-&gt;Value()); break; case mFilterDecay: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_DECAY, GetParam(paramIdx)-&gt;Value()); break; case mFilterSustain: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_SUSTAIN, GetParam(paramIdx)-&gt;Value()); break; case mFilterRelease: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE, GetParam(paramIdx)-&gt;Value()); break; case mFilterEnvelopeAmount: filterEnvelopeAmount = GetParam(paramIdx)-&gt;Value(); break;</code> <br> <br> ! <br>     !           (-   C1),   : <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/f5d/757/3f9/f5d7573f9b3a720fe5898d88ae477cfc.png"> <br> <br>        <code>EnvelopeGenerator</code>  .         .        ! <br> <br>    <a href=""></a> . <br> <br>        :) <br> <br>  : <br> <a href="http://martin-finke.de/blog/articles/audio-plugins-013-filter/">martin-finke.de/blog/articles/audio-plugins-013-filter</a></code></code> <pre> <code class="hljs erlang-repl"><code class="cpp">#include  <i>Filter.h</i> ( )     : <br> <br> class Filter { public: enum FilterMode { FILTER_MODE_LOWPASS = <span class="hljs-number"><span class="hljs-number">0</span></span>, FILTER_MODE_HIGHPASS, FILTER_MODE_BANDPASS, kNumFilterModes }; Filter() : cutoff(<span class="hljs-number"><span class="hljs-number">0.99</span></span>), resonance(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), mode(FILTER_MODE_LOWPASS), buf0(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), buf1(<span class="hljs-number"><span class="hljs-number">0.0</span></span>) { calculateFeedbackAmount(); }; double process(double inputValue); inline void setCutoff(double newCutoff) { cutoff = newCutoff; calculateFeedbackAmount(); }; inline void setResonance(double newResonance) { resonance = newResonance; calculateFeedbackAmount(); }; inline void setFilterMode(FilterMode newMode) { mode = newMode; } private: double cutoff; double resonance; FilterMode mode; double feedbackAmount; inline void calculateFeedbackAmount() { feedbackAmount = resonance + resonance/(<span class="hljs-number"><span class="hljs-number">1.0</span></span> - cutoff); } double buf0; double buf1; };</code> <br> <br>  <code>private</code>     <i> </i> <code>cutoff</code>  <i></i> <code>resonance</code> . <code>Mode</code>      (Lowpass, Highpass, Bandpass).  <code>feedbackAmount</code> , <code>buf0</code>  <code>buf1</code>    ,    . <br>          ( <code>calculateFeedbackAmount()</code> ).  <code>process</code>      .   <code>feedbackAmount</code>   <code>cutoff</code>  <code>resonance</code> ,    <code>calculateFeedbackAmount</code>      . <br> <br>   <i>Filter.cpp</i>  : <br> <br> <code class="cpp">// By Paul Kellett // http://www.musicdsp.org/showone.php?id=<span class="hljs-number"><span class="hljs-number">29</span></span> double Filter::process(double inputValue) { buf0 += cutoff * (inputValue - buf0); buf1 += cutoff * (buf0 - buf1); switch (mode) { case FILTER_MODE_LOWPASS: return buf1; case FILTER_MODE_HIGHPASS: return inputValue - buf0; case FILTER_MODE_BANDPASS: return buf0 - buf1; default: return <span class="hljs-number"><span class="hljs-number">0.0</span></span>; } }</code> <br> <br> , ?  ,         <i> </i> . ¬´ ¬ª   ,               (. .    <span class="hljs-number"><span class="hljs-number">6</span></span> ).     <code>buf0</code>  <code>buf1</code> :        .     <code>inputValue</code> ,  - <code>buf0</code> (  ).   .    <span class="hljs-number"><span class="hljs-number">6</span></span> /   <span class="hljs-number"><span class="hljs-number">12</span></span> /.  <code>switch</code> ,  <code>buf1</code>    . , ,    <code>buf0</code> ,       <span class="hljs-number"><span class="hljs-number">12</span></span>,   <span class="hljs-number"><span class="hljs-number">6</span></span> /,        . <br> <br>  <code>case</code> <code>FILTER_MODE_HIGHPASS</code>    . <code>buf0</code>       .   <code>inputValue</code>  <code>buf0</code> ,   .    <code>buf1</code> ,     . <br> <br>  <code>case</code> <code>FILTER_MODE_BANDPASS</code> ,  <code>buf0 - buf1</code>   .  <code>buf0</code>       ,     <code>buf1</code> . ,   . <br>  :    <i> </i>    <i> </i> ,   . <br> <br>  <code>buf1</code>     .       <a href="http://ru.wikipedia.org/wiki/%25D0%25A4%25D0%25B8%25D0%25BB%25D1%258C%25D1%2582%25D1%2580_%25D1%2581_%25D0%25B1%25D0%25B5%25D1%2581%25D0%25BA%25D0%25BE%25D0%25BD%25D0%25B5%25D1%2587%25D0%25BD%25D0%25BE%25D0%25B9_%25D0%25B8%25D0%25BC%25D0%25BF%25D1%2583%25D0%25BB%25D1%258C%25D1%2581%25D0%25BD%25D0%25BE%25D0%25B9_%25D1%2585%25D0%25B0%25D1%2580%25D0%25B0%25D0%25BA%25D1%2582%25D0%25B5%25D1%2580%25D0%25B8%25D1%2581%25D1%2582%25D0%25B8%25D0%25BA%25D0%25BE%25D0%25B9">    </a> ( <i>Infinite Impulse Response</i> ,  <i>IIR</i> ).  <a href="http://www.dspguide.com/ch14/1.htm"> </a> ,      .      ,         ,      . <br> <br>   <br>       ,     ,     .   ,  ,      ,  ,          .           ,  NI Massive,   ¬´ <a href="http://lurkmore.to/%25D0%25A2%25D1%2591%25D0%25BF%25D0%25BB%25D1%258B%25D0%25B9_%25D0%25BB%25D0%25B0%25D0%25BC%25D0%25BF%25D0%25BE%25D0%25B2%25D1%258B%25D0%25B9_%25D0%25B7%25D0%25B2%25D1%2583%25D0%25BA">  </a> ¬ª.       ,          ,   .        ,          (  Massive       ).      ¬´¬ª , , , AAS Ultra Analog,       ,     ,    ,        .         ,  ,    <a href="http://www.kvraudio.com/forum/viewtopic.php%3Ft%3D350246"></a> ,   ,      NI Reaktor. ,            ‚Äî    ,    ..     . <br> <br>   <br>     .   GUI.  <i>bg.png</i>   ( <i>‚ÄúMove to trash‚Äù</i>  Xcode),       : <br> <br> <a href="">filtermode.png</a> <a href="">knob_small.png</a> (  ,   <span class="hljs-number"><span class="hljs-number">50</span></span> <span class="hljs-number"><span class="hljs-number">50</span></span> ) <a href="">bg.png</a> (       ) <br> <br>    ID  <i>resource.h</i> : <br> <br> <code class="cpp">// Unique IDs for each image resource. #define BG_ID <span class="hljs-number"><span class="hljs-number">101</span></span> #define WHITE_KEY_ID <span class="hljs-number"><span class="hljs-number">102</span></span> #define BLACK_KEY_ID <span class="hljs-number"><span class="hljs-number">103</span></span> #define WAVEFORM_ID <span class="hljs-number"><span class="hljs-number">104</span></span> #define KNOB_ID <span class="hljs-number"><span class="hljs-number">105</span></span> #define KNOB_SMALL_ID <span class="hljs-number"><span class="hljs-number">106</span></span> #define FILTERMODE_ID <span class="hljs-number"><span class="hljs-number">107</span></span> // Image resource locations for this plug. #define BG_FN <span class="hljs-string"><span class="hljs-string">"resources/img/bg.png"</span></span> #define WHITE_KEY_FN <span class="hljs-string"><span class="hljs-string">"resources/img/whitekey.png"</span></span> #define BLACK_KEY_FN <span class="hljs-string"><span class="hljs-string">"resources/img/blackkey.png"</span></span> #define WAVEFORM_FN <span class="hljs-string"><span class="hljs-string">"resources/img/waveform.png"</span></span> #define KNOB_FN <span class="hljs-string"><span class="hljs-string">"resources/img/knob.png"</span></span> #define KNOB_SMALL_FN <span class="hljs-string"><span class="hljs-string">"resources/img/knob_small.png"</span></span> #define FILTERMODE_FN <span class="hljs-string"><span class="hljs-string">"resources/img/filtermode.png"</span></span></code> <br> <br>  <i>Synthesis.rc</i> : <br> <br> <code class="cpp">#include <span class="hljs-string"><span class="hljs-string">"resource.h"</span></span> BG_ID PNG BG_FN WHITE_KEY_ID PNG WHITE_KEY_FN BLACK_KEY_ID PNG BLACK_KEY_FN WAVEFORM_ID PNG WAVEFORM_FN KNOB_ID PNG KNOB_FN KNOB_SMALL_ID PNG KNOB_SMALL_FN FILTERMODE_ID PNG FILTERMODE_FN</code> <br> <br>   <code>#include <span class="hljs-string"><span class="hljs-string">"Filter.h"</span></span></code>  <i>Synthesis.h</i>    <code>private</code> : <br> <br> <code class="cpp">Filter mFilter;</code> <br> <br>  <code>EParams</code>  <i>Synthesis.cpp</i> : <br> <br> <code class="cpp">enum EParams { mWaveform = <span class="hljs-number"><span class="hljs-number">0</span></span>, mAttack, mDecay, mSustain, mRelease, mFilterMode, mFilterCutoff, mFilterResonance, mFilterAttack, mFilterDecay, mFilterSustain, mFilterRelease, mFilterEnvelopeAmount, kNumParams };</code> <br> <br>        : <br> <br> <code class="cpp">pGraphics-&gt;AttachControl(new ISwitchControl(this, <span class="hljs-number"><span class="hljs-number">24</span></span>, <span class="hljs-number"><span class="hljs-number">38</span></span>, mWaveform, &amp;waveformBitmap));</code> <br> <br>      .      (Lowpass, Highpass, Bandpass).    <code>AttachGraphics(pGraphics)</code> : <br> <br> <code class="cpp">GetParam(mFilterMode)-&gt;InitEnum(<span class="hljs-string"><span class="hljs-string">"Filter Mode"</span></span>, Filter::FILTER_MODE_LOWPASS, Filter::kNumFilterModes); IBitmap filtermodeBitmap = pGraphics-&gt;LoadIBitmap(FILTERMODE_ID, FILTERMODE_FN, <span class="hljs-number"><span class="hljs-number">3</span></span>); pGraphics-&gt;AttachControl(new ISwitchControl(this, <span class="hljs-number"><span class="hljs-number">24</span></span>, <span class="hljs-number"><span class="hljs-number">123</span></span>, mFilterMode, &amp;filtermodeBitmap));</code> <br> <br>         .    .     <i>knob_small.png</i> : <br> <br> <code class="cpp">// Knobs for filter cutoff and resonance IBitmap smallKnobBitmap = pGraphics-&gt;LoadIBitmap(KNOB_SMALL_ID, KNOB_SMALL_FN, <span class="hljs-number"><span class="hljs-number">64</span></span>); // Cutoff knob: GetParam(mFilterCutoff)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Cutoff"</span></span>, <span class="hljs-number"><span class="hljs-number">0.99</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">0.99</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); GetParam(mFilterCutoff)-&gt;SetShape(<span class="hljs-number"><span class="hljs-number">2</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-number"><span class="hljs-number">177</span></span>, mFilterCutoff, &amp;smallKnobBitmap)); // Resonance knob: GetParam(mFilterResonance)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Resonance"</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">61</span></span>, <span class="hljs-number"><span class="hljs-number">177</span></span>, mFilterResonance, &amp;smallKnobBitmap));</code> <br> <br>   ,           <code><span class="hljs-number"><span class="hljs-number">1.0</span></span></code> ,   <code>calculateFeedbackAmount</code>    , . <br>  <code>ProcessDoubleReplacing</code>     : <br> <br> <code class="cpp">leftOutput[i] = rightOutput[i] = mFilter.process(mOscillator.nextSample() * mEnvelopeGenerator.nextSample() * velocity / <span class="hljs-number"><span class="hljs-number">127.0</span></span>);</code> <br> <br>       .  <code>switch</code>   <code>Synthesis::OnParamChange</code> : <br> <br> <code class="cpp">case mFilterCutoff: mFilter.setCutoff(GetParam(paramIdx)-&gt;Value()); break; case mFilterResonance: mFilter.setResonance(GetParam(paramIdx)-&gt;Value()); break; case mFilterMode: mFilter.setFilterMode(static_cast&lt;Filter::FilterMode&gt;(GetParam(paramIdx)-&gt;Int())); break;</code> <br> <br>    .  -      . <br> <br>  <br> <br>  ‚Äî      .   ,   ,          . <br>      : <br> <br> <code class="cpp">buf0 += cutoff * (inputValue - buf0 + feedbackAmount * (buf0 - buf1));</code> <br> <br> ,   ,      ( <code>buf0 ‚Äì buf1</code> ),   <code>feedbackAmount</code> .    <code>calculateFeedbackAmount</code>  <code>feedbackAmount</code>  <code>resonance</code> , . .    ,   . <br> <br>  ,            .     ,  <i></i> ,      <a href="https://www.youtube.com/watch%3Fv%3DJWyMj6KxGHM"> </a> .    ,        ,       . <br> <br>  -<span class="hljs-number"><span class="hljs-number">12</span></span> /  -<span class="hljs-number"><span class="hljs-number">24</span></span> / <br>        !     <span class="hljs-number"><span class="hljs-number">24</span></span>   .     <code>switch</code>  <code>Filter::process</code> : <br> <br> <code class="cpp">buf2 += cutoff * (buf1 - buf2); buf3 += cutoff * (buf2 ‚Äì buf3);</code> <br> <br>   :      ,       ,            .     ,       , , <a href="https://ccrma.stanford.edu/~Jos/filters/Filter_Stability.html"></a> (       ).     <code>switch</code> : <br> <br> <code class="cpp">switch (mode) { case FILTER_MODE_LOWPASS: return buf3; case FILTER_MODE_HIGHPASS: return inputValue - buf3; case FILTER_MODE_BANDPASS: return buf0 - buf3; default: return <span class="hljs-number"><span class="hljs-number">0.0</span></span>; }</code> <br> <br>   <code>buf1</code>  <code>buf3</code> ‚Äì      .    -<span class="hljs-number"><span class="hljs-number">24</span></span> /.     <code>buf2</code>  <code>buf3</code> ,        <code>private</code> <i>Filter.h</i> : <br> <br> <code class="cpp">double buf2; double buf3;</code> <br> <br>    ,   <code>buf0</code> c <code>buf1</code> : <br> <br> <code class="cpp">Filter() : // ... buf0(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), buf1(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), buf2(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), buf3(<span class="hljs-number"><span class="hljs-number">0.0</span></span>) // ...</code> <br> <br>     , ,     :     .       . <br>          ? <br> <br>   <br>    .  ,           ,       . <br> -      <code>cutoff</code>   .      .    <code>cutoffMod</code> ,    ,       <code>cutoff</code>    .     <code><code>#include    private</code> : <br> <br> <code class="cpp">double cutoffMod;</code> <br> <br> : <br> <br> <code class="cpp">Filter() : cutoff(<span class="hljs-number"><span class="hljs-number">0.99</span></span>), resonance(<span class="hljs-number"><span class="hljs-number">0.01</span></span>), cutoffMod(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), // ...</code> <br> <br>         .   <code>private</code> : <br> <br> <code class="cpp">inline double getCalculatedCutoff() const { return fmax(fmin(cutoff + cutoffMod, <span class="hljs-number"><span class="hljs-number">0.99</span></span>), <span class="hljs-number"><span class="hljs-number">0.01</span></span>); };</code> <br> <br> <code>calculateFeedbackAmount</code>     : <br> <br> <code class="cpp">inline void calculateFeedbackAmount() { feedbackAmount = resonance + resonance/(<span class="hljs-number"><span class="hljs-number">1.0</span></span> - getCalculatedCutoff()); }</code> <br> <br>       <code>cutoffMod</code> .   <code>feedbackAmount</code>    ,     : <br> <br> <code class="cpp">inline void setCutoffMod(double newCutoffMod) { cutoffMod = newCutoffMod; calculateFeedbackAmount(); }</code> <br> <br> ,       .   <code>Filter::process</code>   : <br> <br> <code class="cpp">if (inputValue == <span class="hljs-number"><span class="hljs-number">0.0</span></span>) return inputValue; double calculatedCutoff = getCalculatedCutoff(); buf0 += calculatedCutoff * (inputValue - buf0 + feedbackAmount * (buf0 - buf1)); buf1 += calculatedCutoff * (buf0 - buf1); buf2 += calculatedCutoff * (buf1 - buf2); buf3 += calculatedCutoff * (buf2 ‚Äì buf3);</code> <br> <br>        ,    .    ,      ,   .     .     <code>cutoff</code>  <code>calculatedCutoff</code>   -. <br> <br> ,       ( <code>setCutoffMod</code> ),   <code>Synthesis</code>    ,     ,    .    ,        <code>cutoffMod</code> .    <code>filterEnvelopeAmount</code>    <code>-<span class="hljs-number"><span class="hljs-number">1</span></span></code>  <code>+<span class="hljs-number"><span class="hljs-number">1</span></span></code> .   GUI. <br> <br>   <code>private</code> <i>Synthesis.h</i>    : <br> <br> <code class="cpp">EnvelopeGenerator mFilterEnvelopeGenerator; double filterEnvelopeAmount;</code> <br> <br>       MIDI ,      <code>onNoteOn</code>  <code>onNoteOff</code> : <br> <br> <code class="cpp">inline void onNoteOn(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); mFilterEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); }; inline void onNoteOff(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); mFilterEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); };</code> <br> <br>    .   <code>ProcessDoubleReplacing</code>        : <br> <br> <code class="cpp">mFilter.setCutoffMod(mFilterEnvelopeGenerator.nextSample() * filterEnvelopeAmount);</code> <br> <br>  ,        <code>nextSample</code>  <code>filterEnvelopeAmount</code>     <code>cutoffMod</code> .     <code>filterEnvelopeAmount</code>  : <br> <br> <code class="cpp">Synthesis::Synthesis(IPlugInstanceInfo instanceInfo) : IPLUG_CTOR(kNumParams, kNumPrograms, instanceInfo), lastVirtualKeyboardNoteNumber(virtualKeyboardMinimumNoteNumber - <span class="hljs-number"><span class="hljs-number">1</span></span>), filterEnvelopeAmount(<span class="hljs-number"><span class="hljs-number">0.0</span></span>) { // ... }</code> <br> <br>       <code>Synthesis::Reset</code> : <br> <br> <code class="cpp">mFilterEnvelopeGenerator.setSampleRate(GetSampleRate());</code> <br> <br>      <code>EParams</code> ,       .  <code>AttachGraphics</code>     : <br> <br> <code class="cpp">// Knobs for filter envelope // Attack knob GetParam(mFilterAttack)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Filter Env Attack"</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">10.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); GetParam(mFilterAttack)-&gt;SetShape(<span class="hljs-number"><span class="hljs-number">3</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">139</span></span>, <span class="hljs-number"><span class="hljs-number">178</span></span>, mFilterAttack, &amp;smallKnobBitmap)); // Decay knob: GetParam(mFilterDecay)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Filter Env Decay"</span></span>, <span class="hljs-number"><span class="hljs-number">0.5</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">15.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); GetParam(mFilterDecay)-&gt;SetShape(<span class="hljs-number"><span class="hljs-number">3</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">195</span></span>, <span class="hljs-number"><span class="hljs-number">178</span></span>, mFilterDecay, &amp;smallKnobBitmap)); // Sustain knob: GetParam(mFilterSustain)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Filter Env Sustain"</span></span>, <span class="hljs-number"><span class="hljs-number">0.1</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>, <span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); GetParam(mFilterSustain)-&gt;SetShape(<span class="hljs-number"><span class="hljs-number">2</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">251</span></span>, <span class="hljs-number"><span class="hljs-number">178</span></span>, mFilterSustain, &amp;smallKnobBitmap)); // Release knob: GetParam(mFilterRelease)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Filter Env Release"</span></span>, <span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>, <span class="hljs-number"><span class="hljs-number">15.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); GetParam(mFilterRelease)-&gt;SetShape(<span class="hljs-number"><span class="hljs-number">3</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">307</span></span>, <span class="hljs-number"><span class="hljs-number">178</span></span>, mFilterRelease, &amp;smallKnobBitmap)); // Filter envelope amount knob: GetParam(mFilterEnvelopeAmount)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Filter Env Amount"</span></span>, <span class="hljs-number"><span class="hljs-number">0.0</span></span>, -<span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">363</span></span>, <span class="hljs-number"><span class="hljs-number">178</span></span>, mFilterEnvelopeAmount, &amp;smallKnobBitmap));</code> <br> <br>     ,       <code>smallKnobBitmap</code> .                   .     ,    .  <code>Synthesis::OnParamChange</code>    <code>switch</code> : <br> <br> <code class="cpp">case mFilterAttack: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK, GetParam(paramIdx)-&gt;Value()); break; case mFilterDecay: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_DECAY, GetParam(paramIdx)-&gt;Value()); break; case mFilterSustain: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_SUSTAIN, GetParam(paramIdx)-&gt;Value()); break; case mFilterRelease: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE, GetParam(paramIdx)-&gt;Value()); break; case mFilterEnvelopeAmount: filterEnvelopeAmount = GetParam(paramIdx)-&gt;Value(); break;</code> <br> <br> ! <br>     !           (-   C1),   : <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/f5d/757/3f9/f5d7573f9b3a720fe5898d88ae477cfc.png"> <br> <br>        <code>EnvelopeGenerator</code>  .         .        ! <br> <br>    <a href=""></a> . <br> <br>        :) <br> <br>  : <br> <a href="http://martin-finke.de/blog/articles/audio-plugins-013-filter/">martin-finke.de/blog/articles/audio-plugins-<span class="hljs-number"><span class="hljs-number">013</span></span>-filter</a></code></code> </pre> <code><code class="cpp">#include  <i>Filter.h</i> ( )     : <br> <br> class Filter { public: enum FilterMode { FILTER_MODE_LOWPASS = 0, FILTER_MODE_HIGHPASS, FILTER_MODE_BANDPASS, kNumFilterModes }; Filter() : cutoff(0.99), resonance(0.0), mode(FILTER_MODE_LOWPASS), buf0(0.0), buf1(0.0) { calculateFeedbackAmount(); }; double process(double inputValue); inline void setCutoff(double newCutoff) { cutoff = newCutoff; calculateFeedbackAmount(); }; inline void setResonance(double newResonance) { resonance = newResonance; calculateFeedbackAmount(); }; inline void setFilterMode(FilterMode newMode) { mode = newMode; } private: double cutoff; double resonance; FilterMode mode; double feedbackAmount; inline void calculateFeedbackAmount() { feedbackAmount = resonance + resonance/(1.0 - cutoff); } double buf0; double buf1; };</code> <br> <br>  <code>private</code>     <i> </i> <code>cutoff</code>  <i></i> <code>resonance</code> . <code>Mode</code>      (Lowpass, Highpass, Bandpass).  <code>feedbackAmount</code> , <code>buf0</code>  <code>buf1</code>    ,    . <br>          ( <code>calculateFeedbackAmount()</code> ).  <code>process</code>      .   <code>feedbackAmount</code>   <code>cutoff</code>  <code>resonance</code> ,    <code>calculateFeedbackAmount</code>      . <br> <br>   <i>Filter.cpp</i>  : <br> <br> <code class="cpp">// By Paul Kellett // http://www.musicdsp.org/showone.php?id=29 double Filter::process(double inputValue) { buf0 += cutoff * (inputValue - buf0); buf1 += cutoff * (buf0 - buf1); switch (mode) { case FILTER_MODE_LOWPASS: return buf1; case FILTER_MODE_HIGHPASS: return inputValue - buf0; case FILTER_MODE_BANDPASS: return buf0 - buf1; default: return 0.0; } }</code> <br> <br> , ?  ,         <i> </i> . ¬´ ¬ª   ,               (. .    6 ).     <code>buf0</code>  <code>buf1</code> :        .     <code>inputValue</code> ,  - <code>buf0</code> (  ).   .    6 /   12 /.  <code>switch</code> ,  <code>buf1</code>    . , ,    <code>buf0</code> ,       12,   6 /,        . <br> <br>  <code>case</code> <code>FILTER_MODE_HIGHPASS</code>    . <code>buf0</code>       .   <code>inputValue</code>  <code>buf0</code> ,   .    <code>buf1</code> ,     . <br> <br>  <code>case</code> <code>FILTER_MODE_BANDPASS</code> ,  <code>buf0 - buf1</code>   .  <code>buf0</code>       ,     <code>buf1</code> . ,   . <br>  :    <i> </i>    <i> </i> ,   . <br> <br>  <code>buf1</code>     .       <a href="http://ru.wikipedia.org/wiki/%25D0%25A4%25D0%25B8%25D0%25BB%25D1%258C%25D1%2582%25D1%2580_%25D1%2581_%25D0%25B1%25D0%25B5%25D1%2581%25D0%25BA%25D0%25BE%25D0%25BD%25D0%25B5%25D1%2587%25D0%25BD%25D0%25BE%25D0%25B9_%25D0%25B8%25D0%25BC%25D0%25BF%25D1%2583%25D0%25BB%25D1%258C%25D1%2581%25D0%25BD%25D0%25BE%25D0%25B9_%25D1%2585%25D0%25B0%25D1%2580%25D0%25B0%25D0%25BA%25D1%2582%25D0%25B5%25D1%2580%25D0%25B8%25D1%2581%25D1%2582%25D0%25B8%25D0%25BA%25D0%25BE%25D0%25B9">    </a> ( <i>Infinite Impulse Response</i> ,  <i>IIR</i> ).  <a href="http://www.dspguide.com/ch14/1.htm"> </a> ,      .      ,         ,      . <br> <br>   <br>       ,     ,     .   ,  ,      ,  ,          .           ,  NI Massive,   ¬´ <a href="http://lurkmore.to/%25D0%25A2%25D1%2591%25D0%25BF%25D0%25BB%25D1%258B%25D0%25B9_%25D0%25BB%25D0%25B0%25D0%25BC%25D0%25BF%25D0%25BE%25D0%25B2%25D1%258B%25D0%25B9_%25D0%25B7%25D0%25B2%25D1%2583%25D0%25BA">  </a> ¬ª.       ,          ,   .        ,          (  Massive       ).      ¬´¬ª , , , AAS Ultra Analog,       ,     ,    ,        .         ,  ,    <a href="http://www.kvraudio.com/forum/viewtopic.php%3Ft%3D350246"></a> ,   ,      NI Reaktor. ,            ‚Äî    ,    ..     . <br> <br>   <br>     .   GUI.  <i>bg.png</i>   ( <i>‚ÄúMove to trash‚Äù</i>  Xcode),       : <br> <br> <a href="">filtermode.png</a> <a href="">knob_small.png</a> (  ,   50 50 ) <a href="">bg.png</a> (       ) <br> <br>    ID  <i>resource.h</i> : <br> <br> <code class="cpp">// Unique IDs for each image resource. #define BG_ID 101 #define WHITE_KEY_ID 102 #define BLACK_KEY_ID 103 #define WAVEFORM_ID 104 #define KNOB_ID 105 #define KNOB_SMALL_ID 106 #define FILTERMODE_ID 107 // Image resource locations for this plug. #define BG_FN "resources/img/bg.png" #define WHITE_KEY_FN "resources/img/whitekey.png" #define BLACK_KEY_FN "resources/img/blackkey.png" #define WAVEFORM_FN "resources/img/waveform.png" #define KNOB_FN "resources/img/knob.png" #define KNOB_SMALL_FN "resources/img/knob_small.png" #define FILTERMODE_FN "resources/img/filtermode.png"</code> <br> <br>  <i>Synthesis.rc</i> : <br> <br> <code class="cpp">#include "resource.h" BG_ID PNG BG_FN WHITE_KEY_ID PNG WHITE_KEY_FN BLACK_KEY_ID PNG BLACK_KEY_FN WAVEFORM_ID PNG WAVEFORM_FN KNOB_ID PNG KNOB_FN KNOB_SMALL_ID PNG KNOB_SMALL_FN FILTERMODE_ID PNG FILTERMODE_FN</code> <br> <br>   <code>#include "Filter.h"</code>  <i>Synthesis.h</i>    <code>private</code> : <br> <br> <code class="cpp">Filter mFilter;</code> <br> <br>  <code>EParams</code>  <i>Synthesis.cpp</i> : <br> <br> <code class="cpp">enum EParams { mWaveform = 0, mAttack, mDecay, mSustain, mRelease, mFilterMode, mFilterCutoff, mFilterResonance, mFilterAttack, mFilterDecay, mFilterSustain, mFilterRelease, mFilterEnvelopeAmount, kNumParams };</code> <br> <br>        : <br> <br> <code class="cpp">pGraphics-&gt;AttachControl(new ISwitchControl(this, 24, 38, mWaveform, &amp;waveformBitmap));</code> <br> <br>      .      (Lowpass, Highpass, Bandpass).    <code>AttachGraphics(pGraphics)</code> : <br> <br> <code class="cpp">GetParam(mFilterMode)-&gt;InitEnum("Filter Mode", Filter::FILTER_MODE_LOWPASS, Filter::kNumFilterModes); IBitmap filtermodeBitmap = pGraphics-&gt;LoadIBitmap(FILTERMODE_ID, FILTERMODE_FN, 3); pGraphics-&gt;AttachControl(new ISwitchControl(this, 24, 123, mFilterMode, &amp;filtermodeBitmap));</code> <br> <br>         .    .     <i>knob_small.png</i> : <br> <br> <code class="cpp">// Knobs for filter cutoff and resonance IBitmap smallKnobBitmap = pGraphics-&gt;LoadIBitmap(KNOB_SMALL_ID, KNOB_SMALL_FN, 64); // Cutoff knob: GetParam(mFilterCutoff)-&gt;InitDouble("Cutoff", 0.99, 0.01, 0.99, 0.001); GetParam(mFilterCutoff)-&gt;SetShape(2); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 5, 177, mFilterCutoff, &amp;smallKnobBitmap)); // Resonance knob: GetParam(mFilterResonance)-&gt;InitDouble("Resonance", 0.01, 0.01, 1.0, 0.001); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 61, 177, mFilterResonance, &amp;smallKnobBitmap));</code> <br> <br>   ,           <code>1.0</code> ,   <code>calculateFeedbackAmount</code>    , . <br>  <code>ProcessDoubleReplacing</code>     : <br> <br> <code class="cpp">leftOutput[i] = rightOutput[i] = mFilter.process(mOscillator.nextSample() * mEnvelopeGenerator.nextSample() * velocity / 127.0);</code> <br> <br>       .  <code>switch</code>   <code>Synthesis::OnParamChange</code> : <br> <br> <code class="cpp">case mFilterCutoff: mFilter.setCutoff(GetParam(paramIdx)-&gt;Value()); break; case mFilterResonance: mFilter.setResonance(GetParam(paramIdx)-&gt;Value()); break; case mFilterMode: mFilter.setFilterMode(static_cast&lt;Filter::FilterMode&gt;(GetParam(paramIdx)-&gt;Int())); break;</code> <br> <br>    .  -      . <br> <br>  <br> <br>  ‚Äî      .   ,   ,          . <br>      : <br> <br> <code class="cpp">buf0 += cutoff * (inputValue - buf0 + feedbackAmount * (buf0 - buf1));</code> <br> <br> ,   ,      ( <code>buf0 ‚Äì buf1</code> ),   <code>feedbackAmount</code> .    <code>calculateFeedbackAmount</code>  <code>feedbackAmount</code>  <code>resonance</code> , . .    ,   . <br> <br>  ,            .     ,  <i></i> ,      <a href="https://www.youtube.com/watch%3Fv%3DJWyMj6KxGHM"> </a> .    ,        ,       . <br> <br>  -12 /  -24 / <br>        !     24   .     <code>switch</code>  <code>Filter::process</code> : <br> <br> <code class="cpp">buf2 += cutoff * (buf1 - buf2); buf3 += cutoff * (buf2 ‚Äì buf3);</code> <br> <br>   :      ,       ,            .     ,       , , <a href="https://ccrma.stanford.edu/~Jos/filters/Filter_Stability.html"></a> (       ).     <code>switch</code> : <br> <br> <code class="cpp">switch (mode) { case FILTER_MODE_LOWPASS: return buf3; case FILTER_MODE_HIGHPASS: return inputValue - buf3; case FILTER_MODE_BANDPASS: return buf0 - buf3; default: return 0.0; }</code> <br> <br>   <code>buf1</code>  <code>buf3</code> ‚Äì      .    -24 /.     <code>buf2</code>  <code>buf3</code> ,        <code>private</code> <i>Filter.h</i> : <br> <br> <code class="cpp">double buf2; double buf3;</code> <br> <br>    ,   <code>buf0</code> c <code>buf1</code> : <br> <br> <code class="cpp">Filter() : // ... buf0(0.0), buf1(0.0), buf2(0.0), buf3(0.0) // ...</code> <br> <br>     , ,     :     .       . <br>          ? <br> <br>   <br>    .  ,           ,       . <br> -      <code>cutoff</code>   .      .    <code>cutoffMod</code> ,    ,       <code>cutoff</code>    .     <code><code>#include    private</code> : <br> <br> <code class="cpp">double cutoffMod;</code> <br> <br> : <br> <br> <code class="cpp">Filter() : cutoff(0.99), resonance(0.01), cutoffMod(0.0), // ...</code> <br> <br>         .   <code>private</code> : <br> <br> <code class="cpp">inline double getCalculatedCutoff() const { return fmax(fmin(cutoff + cutoffMod, 0.99), 0.01); };</code> <br> <br> <code>calculateFeedbackAmount</code>     : <br> <br> <code class="cpp">inline void calculateFeedbackAmount() { feedbackAmount = resonance + resonance/(1.0 - getCalculatedCutoff()); }</code> <br> <br>       <code>cutoffMod</code> .   <code>feedbackAmount</code>    ,     : <br> <br> <code class="cpp">inline void setCutoffMod(double newCutoffMod) { cutoffMod = newCutoffMod; calculateFeedbackAmount(); }</code> <br> <br> ,       .   <code>Filter::process</code>   : <br> <br> <code class="cpp">if (inputValue == 0.0) return inputValue; double calculatedCutoff = getCalculatedCutoff(); buf0 += calculatedCutoff * (inputValue - buf0 + feedbackAmount * (buf0 - buf1)); buf1 += calculatedCutoff * (buf0 - buf1); buf2 += calculatedCutoff * (buf1 - buf2); buf3 += calculatedCutoff * (buf2 ‚Äì buf3);</code> <br> <br>        ,    .    ,      ,   .     .     <code>cutoff</code>  <code>calculatedCutoff</code>   -. <br> <br> ,       ( <code>setCutoffMod</code> ),   <code>Synthesis</code>    ,     ,    .    ,        <code>cutoffMod</code> .    <code>filterEnvelopeAmount</code>    <code>-1</code>  <code>+1</code> .   GUI. <br> <br>   <code>private</code> <i>Synthesis.h</i>    : <br> <br> <code class="cpp">EnvelopeGenerator mFilterEnvelopeGenerator; double filterEnvelopeAmount;</code> <br> <br>       MIDI ,      <code>onNoteOn</code>  <code>onNoteOff</code> : <br> <br> <code class="cpp">inline void onNoteOn(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); mFilterEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); }; inline void onNoteOff(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); mFilterEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); };</code> <br> <br>    .   <code>ProcessDoubleReplacing</code>        : <br> <br> <code class="cpp">mFilter.setCutoffMod(mFilterEnvelopeGenerator.nextSample() * filterEnvelopeAmount);</code> <br> <br>  ,        <code>nextSample</code>  <code>filterEnvelopeAmount</code>     <code>cutoffMod</code> .     <code>filterEnvelopeAmount</code>  : <br> <br> <code class="cpp">Synthesis::Synthesis(IPlugInstanceInfo instanceInfo) : IPLUG_CTOR(kNumParams, kNumPrograms, instanceInfo), lastVirtualKeyboardNoteNumber(virtualKeyboardMinimumNoteNumber - 1), filterEnvelopeAmount(0.0) { // ... }</code> <br> <br>       <code>Synthesis::Reset</code> : <br> <br> <code class="cpp">mFilterEnvelopeGenerator.setSampleRate(GetSampleRate());</code> <br> <br>      <code>EParams</code> ,       .  <code>AttachGraphics</code>     : <br> <br> <code class="cpp">// Knobs for filter envelope // Attack knob GetParam(mFilterAttack)-&gt;InitDouble("Filter Env Attack", 0.01, 0.01, 10.0, 0.001); GetParam(mFilterAttack)-&gt;SetShape(3); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 139, 178, mFilterAttack, &amp;smallKnobBitmap)); // Decay knob: GetParam(mFilterDecay)-&gt;InitDouble("Filter Env Decay", 0.5, 0.01, 15.0, 0.001); GetParam(mFilterDecay)-&gt;SetShape(3); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 195, 178, mFilterDecay, &amp;smallKnobBitmap)); // Sustain knob: GetParam(mFilterSustain)-&gt;InitDouble("Filter Env Sustain", 0.1, 0.001, 1.0, 0.001); GetParam(mFilterSustain)-&gt;SetShape(2); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 251, 178, mFilterSustain, &amp;smallKnobBitmap)); // Release knob: GetParam(mFilterRelease)-&gt;InitDouble("Filter Env Release", 1.0, 0.001, 15.0, 0.001); GetParam(mFilterRelease)-&gt;SetShape(3); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 307, 178, mFilterRelease, &amp;smallKnobBitmap)); // Filter envelope amount knob: GetParam(mFilterEnvelopeAmount)-&gt;InitDouble("Filter Env Amount", 0.0, -1.0, 1.0, 0.001); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 363, 178, mFilterEnvelopeAmount, &amp;smallKnobBitmap));</code> <br> <br>     ,       <code>smallKnobBitmap</code> .                   .     ,    .  <code>Synthesis::OnParamChange</code>    <code>switch</code> : <br> <br> <code class="cpp">case mFilterAttack: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK, GetParam(paramIdx)-&gt;Value()); break; case mFilterDecay: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_DECAY, GetParam(paramIdx)-&gt;Value()); break; case mFilterSustain: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_SUSTAIN, GetParam(paramIdx)-&gt;Value()); break; case mFilterRelease: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE, GetParam(paramIdx)-&gt;Value()); break; case mFilterEnvelopeAmount: filterEnvelopeAmount = GetParam(paramIdx)-&gt;Value(); break;</code> <br> <br> ! <br>     !           (-   C1),   : <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/f5d/757/3f9/f5d7573f9b3a720fe5898d88ae477cfc.png"> <br> <br>        <code>EnvelopeGenerator</code>  .         .        ! <br> <br>    <a href=""></a> . <br> <br>        :) <br> <br>  : <br> <a href="http://martin-finke.de/blog/articles/audio-plugins-013-filter/">martin-finke.de/blog/articles/audio-plugins-013-filter</a></code></code> <pre> <code class="hljs erlang-repl"><code class="cpp">#include  <i>Filter.h</i> ( )     : <br> <br> class Filter { public: enum FilterMode { FILTER_MODE_LOWPASS = <span class="hljs-number"><span class="hljs-number">0</span></span>, FILTER_MODE_HIGHPASS, FILTER_MODE_BANDPASS, kNumFilterModes }; Filter() : cutoff(<span class="hljs-number"><span class="hljs-number">0.99</span></span>), resonance(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), mode(FILTER_MODE_LOWPASS), buf0(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), buf1(<span class="hljs-number"><span class="hljs-number">0.0</span></span>) { calculateFeedbackAmount(); }; double process(double inputValue); inline void setCutoff(double newCutoff) { cutoff = newCutoff; calculateFeedbackAmount(); }; inline void setResonance(double newResonance) { resonance = newResonance; calculateFeedbackAmount(); }; inline void setFilterMode(FilterMode newMode) { mode = newMode; } private: double cutoff; double resonance; FilterMode mode; double feedbackAmount; inline void calculateFeedbackAmount() { feedbackAmount = resonance + resonance/(<span class="hljs-number"><span class="hljs-number">1.0</span></span> - cutoff); } double buf0; double buf1; };</code> <br> <br>  <code>private</code>     <i> </i> <code>cutoff</code>  <i></i> <code>resonance</code> . <code>Mode</code>      (Lowpass, Highpass, Bandpass).  <code>feedbackAmount</code> , <code>buf0</code>  <code>buf1</code>    ,    . <br>          ( <code>calculateFeedbackAmount()</code> ).  <code>process</code>      .   <code>feedbackAmount</code>   <code>cutoff</code>  <code>resonance</code> ,    <code>calculateFeedbackAmount</code>      . <br> <br>   <i>Filter.cpp</i>  : <br> <br> <code class="cpp">// By Paul Kellett // http://www.musicdsp.org/showone.php?id=<span class="hljs-number"><span class="hljs-number">29</span></span> double Filter::process(double inputValue) { buf0 += cutoff * (inputValue - buf0); buf1 += cutoff * (buf0 - buf1); switch (mode) { case FILTER_MODE_LOWPASS: return buf1; case FILTER_MODE_HIGHPASS: return inputValue - buf0; case FILTER_MODE_BANDPASS: return buf0 - buf1; default: return <span class="hljs-number"><span class="hljs-number">0.0</span></span>; } }</code> <br> <br> , ?  ,         <i> </i> . ¬´ ¬ª   ,               (. .    <span class="hljs-number"><span class="hljs-number">6</span></span> ).     <code>buf0</code>  <code>buf1</code> :        .     <code>inputValue</code> ,  - <code>buf0</code> (  ).   .    <span class="hljs-number"><span class="hljs-number">6</span></span> /   <span class="hljs-number"><span class="hljs-number">12</span></span> /.  <code>switch</code> ,  <code>buf1</code>    . , ,    <code>buf0</code> ,       <span class="hljs-number"><span class="hljs-number">12</span></span>,   <span class="hljs-number"><span class="hljs-number">6</span></span> /,        . <br> <br>  <code>case</code> <code>FILTER_MODE_HIGHPASS</code>    . <code>buf0</code>       .   <code>inputValue</code>  <code>buf0</code> ,   .    <code>buf1</code> ,     . <br> <br>  <code>case</code> <code>FILTER_MODE_BANDPASS</code> ,  <code>buf0 - buf1</code>   .  <code>buf0</code>       ,     <code>buf1</code> . ,   . <br>  :    <i> </i>    <i> </i> ,   . <br> <br>  <code>buf1</code>     .       <a href="http://ru.wikipedia.org/wiki/%25D0%25A4%25D0%25B8%25D0%25BB%25D1%258C%25D1%2582%25D1%2580_%25D1%2581_%25D0%25B1%25D0%25B5%25D1%2581%25D0%25BA%25D0%25BE%25D0%25BD%25D0%25B5%25D1%2587%25D0%25BD%25D0%25BE%25D0%25B9_%25D0%25B8%25D0%25BC%25D0%25BF%25D1%2583%25D0%25BB%25D1%258C%25D1%2581%25D0%25BD%25D0%25BE%25D0%25B9_%25D1%2585%25D0%25B0%25D1%2580%25D0%25B0%25D0%25BA%25D1%2582%25D0%25B5%25D1%2580%25D0%25B8%25D1%2581%25D1%2582%25D0%25B8%25D0%25BA%25D0%25BE%25D0%25B9">    </a> ( <i>Infinite Impulse Response</i> ,  <i>IIR</i> ).  <a href="http://www.dspguide.com/ch14/1.htm"> </a> ,      .      ,         ,      . <br> <br>   <br>       ,     ,     .   ,  ,      ,  ,          .           ,  NI Massive,   ¬´ <a href="http://lurkmore.to/%25D0%25A2%25D1%2591%25D0%25BF%25D0%25BB%25D1%258B%25D0%25B9_%25D0%25BB%25D0%25B0%25D0%25BC%25D0%25BF%25D0%25BE%25D0%25B2%25D1%258B%25D0%25B9_%25D0%25B7%25D0%25B2%25D1%2583%25D0%25BA">  </a> ¬ª.       ,          ,   .        ,          (  Massive       ).      ¬´¬ª , , , AAS Ultra Analog,       ,     ,    ,        .         ,  ,    <a href="http://www.kvraudio.com/forum/viewtopic.php%3Ft%3D350246"></a> ,   ,      NI Reaktor. ,            ‚Äî    ,    ..     . <br> <br>   <br>     .   GUI.  <i>bg.png</i>   ( <i>‚ÄúMove to trash‚Äù</i>  Xcode),       : <br> <br> <a href="">filtermode.png</a> <a href="">knob_small.png</a> (  ,   <span class="hljs-number"><span class="hljs-number">50</span></span> <span class="hljs-number"><span class="hljs-number">50</span></span> ) <a href="">bg.png</a> (       ) <br> <br>    ID  <i>resource.h</i> : <br> <br> <code class="cpp">// Unique IDs for each image resource. #define BG_ID <span class="hljs-number"><span class="hljs-number">101</span></span> #define WHITE_KEY_ID <span class="hljs-number"><span class="hljs-number">102</span></span> #define BLACK_KEY_ID <span class="hljs-number"><span class="hljs-number">103</span></span> #define WAVEFORM_ID <span class="hljs-number"><span class="hljs-number">104</span></span> #define KNOB_ID <span class="hljs-number"><span class="hljs-number">105</span></span> #define KNOB_SMALL_ID <span class="hljs-number"><span class="hljs-number">106</span></span> #define FILTERMODE_ID <span class="hljs-number"><span class="hljs-number">107</span></span> // Image resource locations for this plug. #define BG_FN <span class="hljs-string"><span class="hljs-string">"resources/img/bg.png"</span></span> #define WHITE_KEY_FN <span class="hljs-string"><span class="hljs-string">"resources/img/whitekey.png"</span></span> #define BLACK_KEY_FN <span class="hljs-string"><span class="hljs-string">"resources/img/blackkey.png"</span></span> #define WAVEFORM_FN <span class="hljs-string"><span class="hljs-string">"resources/img/waveform.png"</span></span> #define KNOB_FN <span class="hljs-string"><span class="hljs-string">"resources/img/knob.png"</span></span> #define KNOB_SMALL_FN <span class="hljs-string"><span class="hljs-string">"resources/img/knob_small.png"</span></span> #define FILTERMODE_FN <span class="hljs-string"><span class="hljs-string">"resources/img/filtermode.png"</span></span></code> <br> <br>  <i>Synthesis.rc</i> : <br> <br> <code class="cpp">#include <span class="hljs-string"><span class="hljs-string">"resource.h"</span></span> BG_ID PNG BG_FN WHITE_KEY_ID PNG WHITE_KEY_FN BLACK_KEY_ID PNG BLACK_KEY_FN WAVEFORM_ID PNG WAVEFORM_FN KNOB_ID PNG KNOB_FN KNOB_SMALL_ID PNG KNOB_SMALL_FN FILTERMODE_ID PNG FILTERMODE_FN</code> <br> <br>   <code>#include <span class="hljs-string"><span class="hljs-string">"Filter.h"</span></span></code>  <i>Synthesis.h</i>    <code>private</code> : <br> <br> <code class="cpp">Filter mFilter;</code> <br> <br>  <code>EParams</code>  <i>Synthesis.cpp</i> : <br> <br> <code class="cpp">enum EParams { mWaveform = <span class="hljs-number"><span class="hljs-number">0</span></span>, mAttack, mDecay, mSustain, mRelease, mFilterMode, mFilterCutoff, mFilterResonance, mFilterAttack, mFilterDecay, mFilterSustain, mFilterRelease, mFilterEnvelopeAmount, kNumParams };</code> <br> <br>        : <br> <br> <code class="cpp">pGraphics-&gt;AttachControl(new ISwitchControl(this, <span class="hljs-number"><span class="hljs-number">24</span></span>, <span class="hljs-number"><span class="hljs-number">38</span></span>, mWaveform, &amp;waveformBitmap));</code> <br> <br>      .      (Lowpass, Highpass, Bandpass).    <code>AttachGraphics(pGraphics)</code> : <br> <br> <code class="cpp">GetParam(mFilterMode)-&gt;InitEnum(<span class="hljs-string"><span class="hljs-string">"Filter Mode"</span></span>, Filter::FILTER_MODE_LOWPASS, Filter::kNumFilterModes); IBitmap filtermodeBitmap = pGraphics-&gt;LoadIBitmap(FILTERMODE_ID, FILTERMODE_FN, <span class="hljs-number"><span class="hljs-number">3</span></span>); pGraphics-&gt;AttachControl(new ISwitchControl(this, <span class="hljs-number"><span class="hljs-number">24</span></span>, <span class="hljs-number"><span class="hljs-number">123</span></span>, mFilterMode, &amp;filtermodeBitmap));</code> <br> <br>         .    .     <i>knob_small.png</i> : <br> <br> <code class="cpp">// Knobs for filter cutoff and resonance IBitmap smallKnobBitmap = pGraphics-&gt;LoadIBitmap(KNOB_SMALL_ID, KNOB_SMALL_FN, <span class="hljs-number"><span class="hljs-number">64</span></span>); // Cutoff knob: GetParam(mFilterCutoff)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Cutoff"</span></span>, <span class="hljs-number"><span class="hljs-number">0.99</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">0.99</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); GetParam(mFilterCutoff)-&gt;SetShape(<span class="hljs-number"><span class="hljs-number">2</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-number"><span class="hljs-number">177</span></span>, mFilterCutoff, &amp;smallKnobBitmap)); // Resonance knob: GetParam(mFilterResonance)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Resonance"</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">61</span></span>, <span class="hljs-number"><span class="hljs-number">177</span></span>, mFilterResonance, &amp;smallKnobBitmap));</code> <br> <br>   ,           <code><span class="hljs-number"><span class="hljs-number">1.0</span></span></code> ,   <code>calculateFeedbackAmount</code>    , . <br>  <code>ProcessDoubleReplacing</code>     : <br> <br> <code class="cpp">leftOutput[i] = rightOutput[i] = mFilter.process(mOscillator.nextSample() * mEnvelopeGenerator.nextSample() * velocity / <span class="hljs-number"><span class="hljs-number">127.0</span></span>);</code> <br> <br>       .  <code>switch</code>   <code>Synthesis::OnParamChange</code> : <br> <br> <code class="cpp">case mFilterCutoff: mFilter.setCutoff(GetParam(paramIdx)-&gt;Value()); break; case mFilterResonance: mFilter.setResonance(GetParam(paramIdx)-&gt;Value()); break; case mFilterMode: mFilter.setFilterMode(static_cast&lt;Filter::FilterMode&gt;(GetParam(paramIdx)-&gt;Int())); break;</code> <br> <br>    .  -      . <br> <br>  <br> <br>  ‚Äî      .   ,   ,          . <br>      : <br> <br> <code class="cpp">buf0 += cutoff * (inputValue - buf0 + feedbackAmount * (buf0 - buf1));</code> <br> <br> ,   ,      ( <code>buf0 ‚Äì buf1</code> ),   <code>feedbackAmount</code> .    <code>calculateFeedbackAmount</code>  <code>feedbackAmount</code>  <code>resonance</code> , . .    ,   . <br> <br>  ,            .     ,  <i></i> ,      <a href="https://www.youtube.com/watch%3Fv%3DJWyMj6KxGHM"> </a> .    ,        ,       . <br> <br>  -<span class="hljs-number"><span class="hljs-number">12</span></span> /  -<span class="hljs-number"><span class="hljs-number">24</span></span> / <br>        !     <span class="hljs-number"><span class="hljs-number">24</span></span>   .     <code>switch</code>  <code>Filter::process</code> : <br> <br> <code class="cpp">buf2 += cutoff * (buf1 - buf2); buf3 += cutoff * (buf2 ‚Äì buf3);</code> <br> <br>   :      ,       ,            .     ,       , , <a href="https://ccrma.stanford.edu/~Jos/filters/Filter_Stability.html"></a> (       ).     <code>switch</code> : <br> <br> <code class="cpp">switch (mode) { case FILTER_MODE_LOWPASS: return buf3; case FILTER_MODE_HIGHPASS: return inputValue - buf3; case FILTER_MODE_BANDPASS: return buf0 - buf3; default: return <span class="hljs-number"><span class="hljs-number">0.0</span></span>; }</code> <br> <br>   <code>buf1</code>  <code>buf3</code> ‚Äì      .    -<span class="hljs-number"><span class="hljs-number">24</span></span> /.     <code>buf2</code>  <code>buf3</code> ,        <code>private</code> <i>Filter.h</i> : <br> <br> <code class="cpp">double buf2; double buf3;</code> <br> <br>    ,   <code>buf0</code> c <code>buf1</code> : <br> <br> <code class="cpp">Filter() : // ... buf0(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), buf1(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), buf2(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), buf3(<span class="hljs-number"><span class="hljs-number">0.0</span></span>) // ...</code> <br> <br>     , ,     :     .       . <br>          ? <br> <br>   <br>    .  ,           ,       . <br> -      <code>cutoff</code>   .      .    <code>cutoffMod</code> ,    ,       <code>cutoff</code>    .     <code><code>#include    private</code> : <br> <br> <code class="cpp">double cutoffMod;</code> <br> <br> : <br> <br> <code class="cpp">Filter() : cutoff(<span class="hljs-number"><span class="hljs-number">0.99</span></span>), resonance(<span class="hljs-number"><span class="hljs-number">0.01</span></span>), cutoffMod(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), // ...</code> <br> <br>         .   <code>private</code> : <br> <br> <code class="cpp">inline double getCalculatedCutoff() const { return fmax(fmin(cutoff + cutoffMod, <span class="hljs-number"><span class="hljs-number">0.99</span></span>), <span class="hljs-number"><span class="hljs-number">0.01</span></span>); };</code> <br> <br> <code>calculateFeedbackAmount</code>     : <br> <br> <code class="cpp">inline void calculateFeedbackAmount() { feedbackAmount = resonance + resonance/(<span class="hljs-number"><span class="hljs-number">1.0</span></span> - getCalculatedCutoff()); }</code> <br> <br>       <code>cutoffMod</code> .   <code>feedbackAmount</code>    ,     : <br> <br> <code class="cpp">inline void setCutoffMod(double newCutoffMod) { cutoffMod = newCutoffMod; calculateFeedbackAmount(); }</code> <br> <br> ,       .   <code>Filter::process</code>   : <br> <br> <code class="cpp">if (inputValue == <span class="hljs-number"><span class="hljs-number">0.0</span></span>) return inputValue; double calculatedCutoff = getCalculatedCutoff(); buf0 += calculatedCutoff * (inputValue - buf0 + feedbackAmount * (buf0 - buf1)); buf1 += calculatedCutoff * (buf0 - buf1); buf2 += calculatedCutoff * (buf1 - buf2); buf3 += calculatedCutoff * (buf2 ‚Äì buf3);</code> <br> <br>        ,    .    ,      ,   .     .     <code>cutoff</code>  <code>calculatedCutoff</code>   -. <br> <br> ,       ( <code>setCutoffMod</code> ),   <code>Synthesis</code>    ,     ,    .    ,        <code>cutoffMod</code> .    <code>filterEnvelopeAmount</code>    <code>-<span class="hljs-number"><span class="hljs-number">1</span></span></code>  <code>+<span class="hljs-number"><span class="hljs-number">1</span></span></code> .   GUI. <br> <br>   <code>private</code> <i>Synthesis.h</i>    : <br> <br> <code class="cpp">EnvelopeGenerator mFilterEnvelopeGenerator; double filterEnvelopeAmount;</code> <br> <br>       MIDI ,      <code>onNoteOn</code>  <code>onNoteOff</code> : <br> <br> <code class="cpp">inline void onNoteOn(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); mFilterEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); }; inline void onNoteOff(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); mFilterEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); };</code> <br> <br>    .   <code>ProcessDoubleReplacing</code>        : <br> <br> <code class="cpp">mFilter.setCutoffMod(mFilterEnvelopeGenerator.nextSample() * filterEnvelopeAmount);</code> <br> <br>  ,        <code>nextSample</code>  <code>filterEnvelopeAmount</code>     <code>cutoffMod</code> .     <code>filterEnvelopeAmount</code>  : <br> <br> <code class="cpp">Synthesis::Synthesis(IPlugInstanceInfo instanceInfo) : IPLUG_CTOR(kNumParams, kNumPrograms, instanceInfo), lastVirtualKeyboardNoteNumber(virtualKeyboardMinimumNoteNumber - <span class="hljs-number"><span class="hljs-number">1</span></span>), filterEnvelopeAmount(<span class="hljs-number"><span class="hljs-number">0.0</span></span>) { // ... }</code> <br> <br>       <code>Synthesis::Reset</code> : <br> <br> <code class="cpp">mFilterEnvelopeGenerator.setSampleRate(GetSampleRate());</code> <br> <br>      <code>EParams</code> ,       .  <code>AttachGraphics</code>     : <br> <br> <code class="cpp">// Knobs for filter envelope // Attack knob GetParam(mFilterAttack)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Filter Env Attack"</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">10.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); GetParam(mFilterAttack)-&gt;SetShape(<span class="hljs-number"><span class="hljs-number">3</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">139</span></span>, <span class="hljs-number"><span class="hljs-number">178</span></span>, mFilterAttack, &amp;smallKnobBitmap)); // Decay knob: GetParam(mFilterDecay)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Filter Env Decay"</span></span>, <span class="hljs-number"><span class="hljs-number">0.5</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">15.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); GetParam(mFilterDecay)-&gt;SetShape(<span class="hljs-number"><span class="hljs-number">3</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">195</span></span>, <span class="hljs-number"><span class="hljs-number">178</span></span>, mFilterDecay, &amp;smallKnobBitmap)); // Sustain knob: GetParam(mFilterSustain)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Filter Env Sustain"</span></span>, <span class="hljs-number"><span class="hljs-number">0.1</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>, <span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); GetParam(mFilterSustain)-&gt;SetShape(<span class="hljs-number"><span class="hljs-number">2</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">251</span></span>, <span class="hljs-number"><span class="hljs-number">178</span></span>, mFilterSustain, &amp;smallKnobBitmap)); // Release knob: GetParam(mFilterRelease)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Filter Env Release"</span></span>, <span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>, <span class="hljs-number"><span class="hljs-number">15.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); GetParam(mFilterRelease)-&gt;SetShape(<span class="hljs-number"><span class="hljs-number">3</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">307</span></span>, <span class="hljs-number"><span class="hljs-number">178</span></span>, mFilterRelease, &amp;smallKnobBitmap)); // Filter envelope amount knob: GetParam(mFilterEnvelopeAmount)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Filter Env Amount"</span></span>, <span class="hljs-number"><span class="hljs-number">0.0</span></span>, -<span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">363</span></span>, <span class="hljs-number"><span class="hljs-number">178</span></span>, mFilterEnvelopeAmount, &amp;smallKnobBitmap));</code> <br> <br>     ,       <code>smallKnobBitmap</code> .                   .     ,    .  <code>Synthesis::OnParamChange</code>    <code>switch</code> : <br> <br> <code class="cpp">case mFilterAttack: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK, GetParam(paramIdx)-&gt;Value()); break; case mFilterDecay: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_DECAY, GetParam(paramIdx)-&gt;Value()); break; case mFilterSustain: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_SUSTAIN, GetParam(paramIdx)-&gt;Value()); break; case mFilterRelease: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE, GetParam(paramIdx)-&gt;Value()); break; case mFilterEnvelopeAmount: filterEnvelopeAmount = GetParam(paramIdx)-&gt;Value(); break;</code> <br> <br> ! <br>     !           (-   C1),   : <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/f5d/757/3f9/f5d7573f9b3a720fe5898d88ae477cfc.png"> <br> <br>        <code>EnvelopeGenerator</code>  .         .        ! <br> <br>    <a href=""></a> . <br> <br>        :) <br> <br>  : <br> <a href="http://martin-finke.de/blog/articles/audio-plugins-013-filter/">martin-finke.de/blog/articles/audio-plugins-<span class="hljs-number"><span class="hljs-number">013</span></span>-filter</a></code></code> </pre> <code><code class="cpp">#include  <i>Filter.h</i> ( )     : <br> <br> class Filter { public: enum FilterMode { FILTER_MODE_LOWPASS = 0, FILTER_MODE_HIGHPASS, FILTER_MODE_BANDPASS, kNumFilterModes }; Filter() : cutoff(0.99), resonance(0.0), mode(FILTER_MODE_LOWPASS), buf0(0.0), buf1(0.0) { calculateFeedbackAmount(); }; double process(double inputValue); inline void setCutoff(double newCutoff) { cutoff = newCutoff; calculateFeedbackAmount(); }; inline void setResonance(double newResonance) { resonance = newResonance; calculateFeedbackAmount(); }; inline void setFilterMode(FilterMode newMode) { mode = newMode; } private: double cutoff; double resonance; FilterMode mode; double feedbackAmount; inline void calculateFeedbackAmount() { feedbackAmount = resonance + resonance/(1.0 - cutoff); } double buf0; double buf1; };</code> <br> <br>  <code>private</code>     <i> </i> <code>cutoff</code>  <i></i> <code>resonance</code> . <code>Mode</code>      (Lowpass, Highpass, Bandpass).  <code>feedbackAmount</code> , <code>buf0</code>  <code>buf1</code>    ,    . <br>          ( <code>calculateFeedbackAmount()</code> ).  <code>process</code>      .   <code>feedbackAmount</code>   <code>cutoff</code>  <code>resonance</code> ,    <code>calculateFeedbackAmount</code>      . <br> <br>   <i>Filter.cpp</i>  : <br> <br> <code class="cpp">// By Paul Kellett // http://www.musicdsp.org/showone.php?id=29 double Filter::process(double inputValue) { buf0 += cutoff * (inputValue - buf0); buf1 += cutoff * (buf0 - buf1); switch (mode) { case FILTER_MODE_LOWPASS: return buf1; case FILTER_MODE_HIGHPASS: return inputValue - buf0; case FILTER_MODE_BANDPASS: return buf0 - buf1; default: return 0.0; } }</code> <br> <br> , ?  ,         <i> </i> . ¬´ ¬ª   ,               (. .    6 ).     <code>buf0</code>  <code>buf1</code> :        .     <code>inputValue</code> ,  - <code>buf0</code> (  ).   .    6 /   12 /.  <code>switch</code> ,  <code>buf1</code>    . , ,    <code>buf0</code> ,       12,   6 /,        . <br> <br>  <code>case</code> <code>FILTER_MODE_HIGHPASS</code>    . <code>buf0</code>       .   <code>inputValue</code>  <code>buf0</code> ,   .    <code>buf1</code> ,     . <br> <br>  <code>case</code> <code>FILTER_MODE_BANDPASS</code> ,  <code>buf0 - buf1</code>   .  <code>buf0</code>       ,     <code>buf1</code> . ,   . <br>  :    <i> </i>    <i> </i> ,   . <br> <br>  <code>buf1</code>     .       <a href="http://ru.wikipedia.org/wiki/%25D0%25A4%25D0%25B8%25D0%25BB%25D1%258C%25D1%2582%25D1%2580_%25D1%2581_%25D0%25B1%25D0%25B5%25D1%2581%25D0%25BA%25D0%25BE%25D0%25BD%25D0%25B5%25D1%2587%25D0%25BD%25D0%25BE%25D0%25B9_%25D0%25B8%25D0%25BC%25D0%25BF%25D1%2583%25D0%25BB%25D1%258C%25D1%2581%25D0%25BD%25D0%25BE%25D0%25B9_%25D1%2585%25D0%25B0%25D1%2580%25D0%25B0%25D0%25BA%25D1%2582%25D0%25B5%25D1%2580%25D0%25B8%25D1%2581%25D1%2582%25D0%25B8%25D0%25BA%25D0%25BE%25D0%25B9">    </a> ( <i>Infinite Impulse Response</i> ,  <i>IIR</i> ).  <a href="http://www.dspguide.com/ch14/1.htm"> </a> ,      .      ,         ,      . <br> <br>   <br>       ,     ,     .   ,  ,      ,  ,          .           ,  NI Massive,   ¬´ <a href="http://lurkmore.to/%25D0%25A2%25D1%2591%25D0%25BF%25D0%25BB%25D1%258B%25D0%25B9_%25D0%25BB%25D0%25B0%25D0%25BC%25D0%25BF%25D0%25BE%25D0%25B2%25D1%258B%25D0%25B9_%25D0%25B7%25D0%25B2%25D1%2583%25D0%25BA">  </a> ¬ª.       ,          ,   .        ,          (  Massive       ).      ¬´¬ª , , , AAS Ultra Analog,       ,     ,    ,        .         ,  ,    <a href="http://www.kvraudio.com/forum/viewtopic.php%3Ft%3D350246"></a> ,   ,      NI Reaktor. ,            ‚Äî    ,    ..     . <br> <br>   <br>     .   GUI.  <i>bg.png</i>   ( <i>‚ÄúMove to trash‚Äù</i>  Xcode),       : <br> <br> <a href="">filtermode.png</a> <a href="">knob_small.png</a> (  ,   50 50 ) <a href="">bg.png</a> (       ) <br> <br>    ID  <i>resource.h</i> : <br> <br> <code class="cpp">// Unique IDs for each image resource. #define BG_ID 101 #define WHITE_KEY_ID 102 #define BLACK_KEY_ID 103 #define WAVEFORM_ID 104 #define KNOB_ID 105 #define KNOB_SMALL_ID 106 #define FILTERMODE_ID 107 // Image resource locations for this plug. #define BG_FN "resources/img/bg.png" #define WHITE_KEY_FN "resources/img/whitekey.png" #define BLACK_KEY_FN "resources/img/blackkey.png" #define WAVEFORM_FN "resources/img/waveform.png" #define KNOB_FN "resources/img/knob.png" #define KNOB_SMALL_FN "resources/img/knob_small.png" #define FILTERMODE_FN "resources/img/filtermode.png"</code> <br> <br>  <i>Synthesis.rc</i> : <br> <br> <code class="cpp">#include "resource.h" BG_ID PNG BG_FN WHITE_KEY_ID PNG WHITE_KEY_FN BLACK_KEY_ID PNG BLACK_KEY_FN WAVEFORM_ID PNG WAVEFORM_FN KNOB_ID PNG KNOB_FN KNOB_SMALL_ID PNG KNOB_SMALL_FN FILTERMODE_ID PNG FILTERMODE_FN</code> <br> <br>   <code>#include "Filter.h"</code>  <i>Synthesis.h</i>    <code>private</code> : <br> <br> <code class="cpp">Filter mFilter;</code> <br> <br>  <code>EParams</code>  <i>Synthesis.cpp</i> : <br> <br> <code class="cpp">enum EParams { mWaveform = 0, mAttack, mDecay, mSustain, mRelease, mFilterMode, mFilterCutoff, mFilterResonance, mFilterAttack, mFilterDecay, mFilterSustain, mFilterRelease, mFilterEnvelopeAmount, kNumParams };</code> <br> <br>        : <br> <br> <code class="cpp">pGraphics-&gt;AttachControl(new ISwitchControl(this, 24, 38, mWaveform, &amp;waveformBitmap));</code> <br> <br>      .      (Lowpass, Highpass, Bandpass).    <code>AttachGraphics(pGraphics)</code> : <br> <br> <code class="cpp">GetParam(mFilterMode)-&gt;InitEnum("Filter Mode", Filter::FILTER_MODE_LOWPASS, Filter::kNumFilterModes); IBitmap filtermodeBitmap = pGraphics-&gt;LoadIBitmap(FILTERMODE_ID, FILTERMODE_FN, 3); pGraphics-&gt;AttachControl(new ISwitchControl(this, 24, 123, mFilterMode, &amp;filtermodeBitmap));</code> <br> <br>         .    .     <i>knob_small.png</i> : <br> <br> <code class="cpp">// Knobs for filter cutoff and resonance IBitmap smallKnobBitmap = pGraphics-&gt;LoadIBitmap(KNOB_SMALL_ID, KNOB_SMALL_FN, 64); // Cutoff knob: GetParam(mFilterCutoff)-&gt;InitDouble("Cutoff", 0.99, 0.01, 0.99, 0.001); GetParam(mFilterCutoff)-&gt;SetShape(2); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 5, 177, mFilterCutoff, &amp;smallKnobBitmap)); // Resonance knob: GetParam(mFilterResonance)-&gt;InitDouble("Resonance", 0.01, 0.01, 1.0, 0.001); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 61, 177, mFilterResonance, &amp;smallKnobBitmap));</code> <br> <br>   ,           <code>1.0</code> ,   <code>calculateFeedbackAmount</code>    , . <br>  <code>ProcessDoubleReplacing</code>     : <br> <br> <code class="cpp">leftOutput[i] = rightOutput[i] = mFilter.process(mOscillator.nextSample() * mEnvelopeGenerator.nextSample() * velocity / 127.0);</code> <br> <br>       .  <code>switch</code>   <code>Synthesis::OnParamChange</code> : <br> <br> <code class="cpp">case mFilterCutoff: mFilter.setCutoff(GetParam(paramIdx)-&gt;Value()); break; case mFilterResonance: mFilter.setResonance(GetParam(paramIdx)-&gt;Value()); break; case mFilterMode: mFilter.setFilterMode(static_cast&lt;Filter::FilterMode&gt;(GetParam(paramIdx)-&gt;Int())); break;</code> <br> <br>    .  -      . <br> <br>  <br> <br>  ‚Äî      .   ,   ,          . <br>      : <br> <br> <code class="cpp">buf0 += cutoff * (inputValue - buf0 + feedbackAmount * (buf0 - buf1));</code> <br> <br> ,   ,      ( <code>buf0 ‚Äì buf1</code> ),   <code>feedbackAmount</code> .    <code>calculateFeedbackAmount</code>  <code>feedbackAmount</code>  <code>resonance</code> , . .    ,   . <br> <br>  ,            .     ,  <i></i> ,      <a href="https://www.youtube.com/watch%3Fv%3DJWyMj6KxGHM"> </a> .    ,        ,       . <br> <br>  -12 /  -24 / <br>        !     24   .     <code>switch</code>  <code>Filter::process</code> : <br> <br> <code class="cpp">buf2 += cutoff * (buf1 - buf2); buf3 += cutoff * (buf2 ‚Äì buf3);</code> <br> <br>   :      ,       ,            .     ,       , , <a href="https://ccrma.stanford.edu/~Jos/filters/Filter_Stability.html"></a> (       ).     <code>switch</code> : <br> <br> <code class="cpp">switch (mode) { case FILTER_MODE_LOWPASS: return buf3; case FILTER_MODE_HIGHPASS: return inputValue - buf3; case FILTER_MODE_BANDPASS: return buf0 - buf3; default: return 0.0; }</code> <br> <br>   <code>buf1</code>  <code>buf3</code> ‚Äì      .    -24 /.     <code>buf2</code>  <code>buf3</code> ,        <code>private</code> <i>Filter.h</i> : <br> <br> <code class="cpp">double buf2; double buf3;</code> <br> <br>    ,   <code>buf0</code> c <code>buf1</code> : <br> <br> <code class="cpp">Filter() : // ... buf0(0.0), buf1(0.0), buf2(0.0), buf3(0.0) // ...</code> <br> <br>     , ,     :     .       . <br>          ? <br> <br>   <br>    .  ,           ,       . <br> -      <code>cutoff</code>   .      .    <code>cutoffMod</code> ,    ,       <code>cutoff</code>    .     <code><code>#include    private</code> : <br> <br> <code class="cpp">double cutoffMod;</code> <br> <br> : <br> <br> <code class="cpp">Filter() : cutoff(0.99), resonance(0.01), cutoffMod(0.0), // ...</code> <br> <br>         .   <code>private</code> : <br> <br> <code class="cpp">inline double getCalculatedCutoff() const { return fmax(fmin(cutoff + cutoffMod, 0.99), 0.01); };</code> <br> <br> <code>calculateFeedbackAmount</code>     : <br> <br> <code class="cpp">inline void calculateFeedbackAmount() { feedbackAmount = resonance + resonance/(1.0 - getCalculatedCutoff()); }</code> <br> <br>       <code>cutoffMod</code> .   <code>feedbackAmount</code>    ,     : <br> <br> <code class="cpp">inline void setCutoffMod(double newCutoffMod) { cutoffMod = newCutoffMod; calculateFeedbackAmount(); }</code> <br> <br> ,       .   <code>Filter::process</code>   : <br> <br> <code class="cpp">if (inputValue == 0.0) return inputValue; double calculatedCutoff = getCalculatedCutoff(); buf0 += calculatedCutoff * (inputValue - buf0 + feedbackAmount * (buf0 - buf1)); buf1 += calculatedCutoff * (buf0 - buf1); buf2 += calculatedCutoff * (buf1 - buf2); buf3 += calculatedCutoff * (buf2 ‚Äì buf3);</code> <br> <br>        ,    .    ,      ,   .     .     <code>cutoff</code>  <code>calculatedCutoff</code>   -. <br> <br> ,       ( <code>setCutoffMod</code> ),   <code>Synthesis</code>    ,     ,    .    ,        <code>cutoffMod</code> .    <code>filterEnvelopeAmount</code>    <code>-1</code>  <code>+1</code> .   GUI. <br> <br>   <code>private</code> <i>Synthesis.h</i>    : <br> <br> <code class="cpp">EnvelopeGenerator mFilterEnvelopeGenerator; double filterEnvelopeAmount;</code> <br> <br>       MIDI ,      <code>onNoteOn</code>  <code>onNoteOff</code> : <br> <br> <code class="cpp">inline void onNoteOn(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); mFilterEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); }; inline void onNoteOff(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); mFilterEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); };</code> <br> <br>    .   <code>ProcessDoubleReplacing</code>        : <br> <br> <code class="cpp">mFilter.setCutoffMod(mFilterEnvelopeGenerator.nextSample() * filterEnvelopeAmount);</code> <br> <br>  ,        <code>nextSample</code>  <code>filterEnvelopeAmount</code>     <code>cutoffMod</code> .     <code>filterEnvelopeAmount</code>  : <br> <br> <code class="cpp">Synthesis::Synthesis(IPlugInstanceInfo instanceInfo) : IPLUG_CTOR(kNumParams, kNumPrograms, instanceInfo), lastVirtualKeyboardNoteNumber(virtualKeyboardMinimumNoteNumber - 1), filterEnvelopeAmount(0.0) { // ... }</code> <br> <br>       <code>Synthesis::Reset</code> : <br> <br> <code class="cpp">mFilterEnvelopeGenerator.setSampleRate(GetSampleRate());</code> <br> <br>      <code>EParams</code> ,       .  <code>AttachGraphics</code>     : <br> <br> <code class="cpp">// Knobs for filter envelope // Attack knob GetParam(mFilterAttack)-&gt;InitDouble("Filter Env Attack", 0.01, 0.01, 10.0, 0.001); GetParam(mFilterAttack)-&gt;SetShape(3); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 139, 178, mFilterAttack, &amp;smallKnobBitmap)); // Decay knob: GetParam(mFilterDecay)-&gt;InitDouble("Filter Env Decay", 0.5, 0.01, 15.0, 0.001); GetParam(mFilterDecay)-&gt;SetShape(3); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 195, 178, mFilterDecay, &amp;smallKnobBitmap)); // Sustain knob: GetParam(mFilterSustain)-&gt;InitDouble("Filter Env Sustain", 0.1, 0.001, 1.0, 0.001); GetParam(mFilterSustain)-&gt;SetShape(2); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 251, 178, mFilterSustain, &amp;smallKnobBitmap)); // Release knob: GetParam(mFilterRelease)-&gt;InitDouble("Filter Env Release", 1.0, 0.001, 15.0, 0.001); GetParam(mFilterRelease)-&gt;SetShape(3); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 307, 178, mFilterRelease, &amp;smallKnobBitmap)); // Filter envelope amount knob: GetParam(mFilterEnvelopeAmount)-&gt;InitDouble("Filter Env Amount", 0.0, -1.0, 1.0, 0.001); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 363, 178, mFilterEnvelopeAmount, &amp;smallKnobBitmap));</code> <br> <br>     ,       <code>smallKnobBitmap</code> .                   .     ,    .  <code>Synthesis::OnParamChange</code>    <code>switch</code> : <br> <br> <code class="cpp">case mFilterAttack: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK, GetParam(paramIdx)-&gt;Value()); break; case mFilterDecay: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_DECAY, GetParam(paramIdx)-&gt;Value()); break; case mFilterSustain: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_SUSTAIN, GetParam(paramIdx)-&gt;Value()); break; case mFilterRelease: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE, GetParam(paramIdx)-&gt;Value()); break; case mFilterEnvelopeAmount: filterEnvelopeAmount = GetParam(paramIdx)-&gt;Value(); break;</code> <br> <br> ! <br>     !           (-   C1),   : <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/f5d/757/3f9/f5d7573f9b3a720fe5898d88ae477cfc.png"> <br> <br>        <code>EnvelopeGenerator</code>  .         .        ! <br> <br>    <a href=""></a> . <br> <br>        :) <br> <br>  : <br> <a href="http://martin-finke.de/blog/articles/audio-plugins-013-filter/">martin-finke.de/blog/articles/audio-plugins-013-filter</a></code></code> <pre> <code class="hljs erlang-repl"><code class="cpp"><code class="cpp">#include  <i>Filter.h</i> ( )     : <br> <br> class Filter { public: enum FilterMode { FILTER_MODE_LOWPASS = <span class="hljs-number"><span class="hljs-number">0</span></span>, FILTER_MODE_HIGHPASS, FILTER_MODE_BANDPASS, kNumFilterModes }; Filter() : cutoff(<span class="hljs-number"><span class="hljs-number">0.99</span></span>), resonance(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), mode(FILTER_MODE_LOWPASS), buf0(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), buf1(<span class="hljs-number"><span class="hljs-number">0.0</span></span>) { calculateFeedbackAmount(); }; double process(double inputValue); inline void setCutoff(double newCutoff) { cutoff = newCutoff; calculateFeedbackAmount(); }; inline void setResonance(double newResonance) { resonance = newResonance; calculateFeedbackAmount(); }; inline void setFilterMode(FilterMode newMode) { mode = newMode; } private: double cutoff; double resonance; FilterMode mode; double feedbackAmount; inline void calculateFeedbackAmount() { feedbackAmount = resonance + resonance/(<span class="hljs-number"><span class="hljs-number">1.0</span></span> - cutoff); } double buf0; double buf1; };</code> <br> <br>  <code>private</code>     <i> </i> <code>cutoff</code>  <i></i> <code>resonance</code> . <code>Mode</code>      (Lowpass, Highpass, Bandpass).  <code>feedbackAmount</code> , <code>buf0</code>  <code>buf1</code>    ,    . <br>          ( <code>calculateFeedbackAmount()</code> ).  <code>process</code>      .   <code>feedbackAmount</code>   <code>cutoff</code>  <code>resonance</code> ,    <code>calculateFeedbackAmount</code>      . <br> <br>   <i>Filter.cpp</i>  : <br> <br> <code class="cpp">// By Paul Kellett // http://www.musicdsp.org/showone.php?id=<span class="hljs-number"><span class="hljs-number">29</span></span> double Filter::process(double inputValue) { buf0 += cutoff * (inputValue - buf0); buf1 += cutoff * (buf0 - buf1); switch (mode) { case FILTER_MODE_LOWPASS: return buf1; case FILTER_MODE_HIGHPASS: return inputValue - buf0; case FILTER_MODE_BANDPASS: return buf0 - buf1; default: return <span class="hljs-number"><span class="hljs-number">0.0</span></span>; } }</code> <br> <br> , ?  ,         <i> </i> . ¬´ ¬ª   ,               (. .    <span class="hljs-number"><span class="hljs-number">6</span></span> ).     <code>buf0</code>  <code>buf1</code> :        .     <code>inputValue</code> ,  - <code>buf0</code> (  ).   .    <span class="hljs-number"><span class="hljs-number">6</span></span> /   <span class="hljs-number"><span class="hljs-number">12</span></span> /.  <code>switch</code> ,  <code>buf1</code>    . , ,    <code>buf0</code> ,       <span class="hljs-number"><span class="hljs-number">12</span></span>,   <span class="hljs-number"><span class="hljs-number">6</span></span> /,        . <br> <br>  <code>case</code> <code>FILTER_MODE_HIGHPASS</code>    . <code>buf0</code>       .   <code>inputValue</code>  <code>buf0</code> ,   .    <code>buf1</code> ,     . <br> <br>  <code>case</code> <code>FILTER_MODE_BANDPASS</code> ,  <code>buf0 - buf1</code>   .  <code>buf0</code>       ,     <code>buf1</code> . ,   . <br>  :    <i> </i>    <i> </i> ,   . <br> <br>  <code>buf1</code>     .       <a href="http://ru.wikipedia.org/wiki/%25D0%25A4%25D0%25B8%25D0%25BB%25D1%258C%25D1%2582%25D1%2580_%25D1%2581_%25D0%25B1%25D0%25B5%25D1%2581%25D0%25BA%25D0%25BE%25D0%25BD%25D0%25B5%25D1%2587%25D0%25BD%25D0%25BE%25D0%25B9_%25D0%25B8%25D0%25BC%25D0%25BF%25D1%2583%25D0%25BB%25D1%258C%25D1%2581%25D0%25BD%25D0%25BE%25D0%25B9_%25D1%2585%25D0%25B0%25D1%2580%25D0%25B0%25D0%25BA%25D1%2582%25D0%25B5%25D1%2580%25D0%25B8%25D1%2581%25D1%2582%25D0%25B8%25D0%25BA%25D0%25BE%25D0%25B9">    </a> ( <i>Infinite Impulse Response</i> ,  <i>IIR</i> ).  <a href="http://www.dspguide.com/ch14/1.htm"> </a> ,      .      ,         ,      . <br> <br>   <br>       ,     ,     .   ,  ,      ,  ,          .           ,  NI Massive,   ¬´ <a href="http://lurkmore.to/%25D0%25A2%25D1%2591%25D0%25BF%25D0%25BB%25D1%258B%25D0%25B9_%25D0%25BB%25D0%25B0%25D0%25BC%25D0%25BF%25D0%25BE%25D0%25B2%25D1%258B%25D0%25B9_%25D0%25B7%25D0%25B2%25D1%2583%25D0%25BA">  </a> ¬ª.       ,          ,   .        ,          (  Massive       ).      ¬´¬ª , , , AAS Ultra Analog,       ,     ,    ,        .         ,  ,    <a href="http://www.kvraudio.com/forum/viewtopic.php%3Ft%3D350246"></a> ,   ,      NI Reaktor. ,            ‚Äî    ,    ..     . <br> <br>   <br>     .   GUI.  <i>bg.png</i>   ( <i>‚ÄúMove to trash‚Äù</i>  Xcode),       : <br> <br> <a href="">filtermode.png</a> <a href="">knob_small.png</a> (  ,   <span class="hljs-number"><span class="hljs-number">50</span></span> <span class="hljs-number"><span class="hljs-number">50</span></span> ) <a href="">bg.png</a> (       ) <br> <br>    ID  <i>resource.h</i> : <br> <br> <code class="cpp">// Unique IDs for each image resource. #define BG_ID <span class="hljs-number"><span class="hljs-number">101</span></span> #define WHITE_KEY_ID <span class="hljs-number"><span class="hljs-number">102</span></span> #define BLACK_KEY_ID <span class="hljs-number"><span class="hljs-number">103</span></span> #define WAVEFORM_ID <span class="hljs-number"><span class="hljs-number">104</span></span> #define KNOB_ID <span class="hljs-number"><span class="hljs-number">105</span></span> #define KNOB_SMALL_ID <span class="hljs-number"><span class="hljs-number">106</span></span> #define FILTERMODE_ID <span class="hljs-number"><span class="hljs-number">107</span></span> // Image resource locations for this plug. #define BG_FN <span class="hljs-string"><span class="hljs-string">"resources/img/bg.png"</span></span> #define WHITE_KEY_FN <span class="hljs-string"><span class="hljs-string">"resources/img/whitekey.png"</span></span> #define BLACK_KEY_FN <span class="hljs-string"><span class="hljs-string">"resources/img/blackkey.png"</span></span> #define WAVEFORM_FN <span class="hljs-string"><span class="hljs-string">"resources/img/waveform.png"</span></span> #define KNOB_FN <span class="hljs-string"><span class="hljs-string">"resources/img/knob.png"</span></span> #define KNOB_SMALL_FN <span class="hljs-string"><span class="hljs-string">"resources/img/knob_small.png"</span></span> #define FILTERMODE_FN <span class="hljs-string"><span class="hljs-string">"resources/img/filtermode.png"</span></span></code> <br> <br>  <i>Synthesis.rc</i> : <br> <br> <code class="cpp">#include <span class="hljs-string"><span class="hljs-string">"resource.h"</span></span> BG_ID PNG BG_FN WHITE_KEY_ID PNG WHITE_KEY_FN BLACK_KEY_ID PNG BLACK_KEY_FN WAVEFORM_ID PNG WAVEFORM_FN KNOB_ID PNG KNOB_FN KNOB_SMALL_ID PNG KNOB_SMALL_FN FILTERMODE_ID PNG FILTERMODE_FN</code> <br> <br>   <code>#include <span class="hljs-string"><span class="hljs-string">"Filter.h"</span></span></code>  <i>Synthesis.h</i>    <code>private</code> : <br> <br> Filter mFilter; <br> <br>  <code>EParams</code>  <i>Synthesis.cpp</i> : <br> <br> <code class="cpp">enum EParams { mWaveform = <span class="hljs-number"><span class="hljs-number">0</span></span>, mAttack, mDecay, mSustain, mRelease, mFilterMode, mFilterCutoff, mFilterResonance, mFilterAttack, mFilterDecay, mFilterSustain, mFilterRelease, mFilterEnvelopeAmount, kNumParams };</code> <br> <br>        : <br> <br> <code class="cpp">pGraphics-&gt;AttachControl(new ISwitchControl(this, <span class="hljs-number"><span class="hljs-number">24</span></span>, <span class="hljs-number"><span class="hljs-number">38</span></span>, mWaveform, &amp;waveformBitmap));</code> <br> <br>      .      (Lowpass, Highpass, Bandpass).    <code>AttachGraphics(pGraphics)</code> : <br> <br> <code class="cpp">GetParam(mFilterMode)-&gt;InitEnum(<span class="hljs-string"><span class="hljs-string">"Filter Mode"</span></span>, Filter::FILTER_MODE_LOWPASS, Filter::kNumFilterModes); IBitmap filtermodeBitmap = pGraphics-&gt;LoadIBitmap(FILTERMODE_ID, FILTERMODE_FN, <span class="hljs-number"><span class="hljs-number">3</span></span>); pGraphics-&gt;AttachControl(new ISwitchControl(this, <span class="hljs-number"><span class="hljs-number">24</span></span>, <span class="hljs-number"><span class="hljs-number">123</span></span>, mFilterMode, &amp;filtermodeBitmap));</code> <br> <br>         .    .     <i>knob_small.png</i> : <br> <br> <code class="cpp">// Knobs for filter cutoff and resonance IBitmap smallKnobBitmap = pGraphics-&gt;LoadIBitmap(KNOB_SMALL_ID, KNOB_SMALL_FN, <span class="hljs-number"><span class="hljs-number">64</span></span>); // Cutoff knob: GetParam(mFilterCutoff)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Cutoff"</span></span>, <span class="hljs-number"><span class="hljs-number">0.99</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">0.99</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); GetParam(mFilterCutoff)-&gt;SetShape(<span class="hljs-number"><span class="hljs-number">2</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-number"><span class="hljs-number">177</span></span>, mFilterCutoff, &amp;smallKnobBitmap)); // Resonance knob: GetParam(mFilterResonance)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Resonance"</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">61</span></span>, <span class="hljs-number"><span class="hljs-number">177</span></span>, mFilterResonance, &amp;smallKnobBitmap));</code> <br> <br>   ,           <code><span class="hljs-number"><span class="hljs-number">1.0</span></span></code> ,   <code>calculateFeedbackAmount</code>    , . <br>  <code>ProcessDoubleReplacing</code>     : <br> <br> <code class="cpp">leftOutput[i] = rightOutput[i] = mFilter.process(mOscillator.nextSample() * mEnvelopeGenerator.nextSample() * velocity / <span class="hljs-number"><span class="hljs-number">127.0</span></span>);</code> <br> <br>       .  <code>switch</code>   <code>Synthesis::OnParamChange</code> : <br> <br> <code class="cpp">case mFilterCutoff: mFilter.setCutoff(GetParam(paramIdx)-&gt;Value()); break; case mFilterResonance: mFilter.setResonance(GetParam(paramIdx)-&gt;Value()); break; case mFilterMode: mFilter.setFilterMode(static_cast&lt;Filter::FilterMode&gt;(GetParam(paramIdx)-&gt;Int())); break;</code> <br> <br>    .  -      . <br> <br>  <br> <br>  ‚Äî      .   ,   ,          . <br>      : <br> <br> <code class="cpp">buf0 += cutoff * (inputValue - buf0 + feedbackAmount * (buf0 - buf1));</code> <br> <br> ,   ,      ( <code>buf0 ‚Äì buf1</code> ),   <code>feedbackAmount</code> .    <code>calculateFeedbackAmount</code>  <code>feedbackAmount</code>  <code>resonance</code> , . .    ,   . <br> <br>  ,            .     ,  <i></i> ,      <a href="https://www.youtube.com/watch%3Fv%3DJWyMj6KxGHM"> </a> .    ,        ,       . <br> <br>  -<span class="hljs-number"><span class="hljs-number">12</span></span> /  -<span class="hljs-number"><span class="hljs-number">24</span></span> / <br>        !     <span class="hljs-number"><span class="hljs-number">24</span></span>   .     <code>switch</code>  <code>Filter::process</code> : <br> <br> <code class="cpp">buf2 += cutoff * (buf1 - buf2); buf3 += cutoff * (buf2 ‚Äì buf3);</code> <br> <br>   :      ,       ,            .     ,       , , <a href="https://ccrma.stanford.edu/~Jos/filters/Filter_Stability.html"></a> (       ).     <code>switch</code> : <br> <br> <code class="cpp">switch (mode) { case FILTER_MODE_LOWPASS: return buf3; case FILTER_MODE_HIGHPASS: return inputValue - buf3; case FILTER_MODE_BANDPASS: return buf0 - buf3; default: return <span class="hljs-number"><span class="hljs-number">0.0</span></span>; }</code> <br> <br>   <code>buf1</code>  <code>buf3</code> ‚Äì      .    -<span class="hljs-number"><span class="hljs-number">24</span></span> /.     <code>buf2</code>  <code>buf3</code> ,        <code>private</code> <i>Filter.h</i> : <br> <br> <code class="cpp">double buf2; double buf3;</code> <br> <br>    ,   <code>buf0</code> c <code>buf1</code> : <br> <br> <code class="cpp">Filter() : // ... buf0(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), buf1(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), buf2(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), buf3(<span class="hljs-number"><span class="hljs-number">0.0</span></span>) // ...</code> <br> <br>     , ,     :     .       . <br>          ? <br> <br>   <br>    .  ,           ,       . <br> -      <code>cutoff</code>   .      .    <code>cutoffMod</code> ,    ,       <code>cutoff</code>    .     <code><code>#include    private</code> : <br> <br> <code class="cpp">double cutoffMod;</code> <br> <br> : <br> <br> <code class="cpp">Filter() : cutoff(<span class="hljs-number"><span class="hljs-number">0.99</span></span>), resonance(<span class="hljs-number"><span class="hljs-number">0.01</span></span>), cutoffMod(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), // ...</code> <br> <br>         .   <code>private</code> : <br> <br> <code class="cpp">inline double getCalculatedCutoff() const { return fmax(fmin(cutoff + cutoffMod, <span class="hljs-number"><span class="hljs-number">0.99</span></span>), <span class="hljs-number"><span class="hljs-number">0.01</span></span>); };</code> <br> <br> <code>calculateFeedbackAmount</code>     : <br> <br> <code class="cpp">inline void calculateFeedbackAmount() { feedbackAmount = resonance + resonance/(<span class="hljs-number"><span class="hljs-number">1.0</span></span> - getCalculatedCutoff()); }</code> <br> <br>       <code>cutoffMod</code> .   <code>feedbackAmount</code>    ,     : <br> <br> <code class="cpp">inline void setCutoffMod(double newCutoffMod) { cutoffMod = newCutoffMod; calculateFeedbackAmount(); }</code> <br> <br> ,       .   <code>Filter::process</code>   : <br> <br> <code class="cpp">if (inputValue == <span class="hljs-number"><span class="hljs-number">0.0</span></span>) return inputValue; double calculatedCutoff = getCalculatedCutoff(); buf0 += calculatedCutoff * (inputValue - buf0 + feedbackAmount * (buf0 - buf1)); buf1 += calculatedCutoff * (buf0 - buf1); buf2 += calculatedCutoff * (buf1 - buf2); buf3 += calculatedCutoff * (buf2 ‚Äì buf3);</code> <br> <br>        ,    .    ,      ,   .     .     <code>cutoff</code>  <code>calculatedCutoff</code>   -. <br> <br> ,       ( <code>setCutoffMod</code> ),   <code>Synthesis</code>    ,     ,    .    ,        <code>cutoffMod</code> .    <code>filterEnvelopeAmount</code>    <code>-<span class="hljs-number"><span class="hljs-number">1</span></span></code>  <code>+<span class="hljs-number"><span class="hljs-number">1</span></span></code> .   GUI. <br> <br>   <code>private</code> <i>Synthesis.h</i>    : <br> <br> <code class="cpp">EnvelopeGenerator mFilterEnvelopeGenerator; double filterEnvelopeAmount;</code> <br> <br>       MIDI ,      <code>onNoteOn</code>  <code>onNoteOff</code> : <br> <br> <code class="cpp">inline void onNoteOn(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); mFilterEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); }; inline void onNoteOff(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); mFilterEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); };</code> <br> <br>    .   <code>ProcessDoubleReplacing</code>        : <br> <br> <code class="cpp">mFilter.setCutoffMod(mFilterEnvelopeGenerator.nextSample() * filterEnvelopeAmount);</code> <br> <br>  ,        <code>nextSample</code>  <code>filterEnvelopeAmount</code>     <code>cutoffMod</code> .     <code>filterEnvelopeAmount</code>  : <br> <br> <code class="cpp">Synthesis::Synthesis(IPlugInstanceInfo instanceInfo) : IPLUG_CTOR(kNumParams, kNumPrograms, instanceInfo), lastVirtualKeyboardNoteNumber(virtualKeyboardMinimumNoteNumber - <span class="hljs-number"><span class="hljs-number">1</span></span>), filterEnvelopeAmount(<span class="hljs-number"><span class="hljs-number">0.0</span></span>) { // ... }</code> <br> <br>       <code>Synthesis::Reset</code> : <br> <br> <code class="cpp">mFilterEnvelopeGenerator.setSampleRate(GetSampleRate());</code> <br> <br>      <code>EParams</code> ,       .  <code>AttachGraphics</code>     : <br> <br> <code class="cpp">// Knobs for filter envelope // Attack knob GetParam(mFilterAttack)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Filter Env Attack"</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">10.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); GetParam(mFilterAttack)-&gt;SetShape(<span class="hljs-number"><span class="hljs-number">3</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">139</span></span>, <span class="hljs-number"><span class="hljs-number">178</span></span>, mFilterAttack, &amp;smallKnobBitmap)); // Decay knob: GetParam(mFilterDecay)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Filter Env Decay"</span></span>, <span class="hljs-number"><span class="hljs-number">0.5</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">15.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); GetParam(mFilterDecay)-&gt;SetShape(<span class="hljs-number"><span class="hljs-number">3</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">195</span></span>, <span class="hljs-number"><span class="hljs-number">178</span></span>, mFilterDecay, &amp;smallKnobBitmap)); // Sustain knob: GetParam(mFilterSustain)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Filter Env Sustain"</span></span>, <span class="hljs-number"><span class="hljs-number">0.1</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>, <span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); GetParam(mFilterSustain)-&gt;SetShape(<span class="hljs-number"><span class="hljs-number">2</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">251</span></span>, <span class="hljs-number"><span class="hljs-number">178</span></span>, mFilterSustain, &amp;smallKnobBitmap)); // Release knob: GetParam(mFilterRelease)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Filter Env Release"</span></span>, <span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>, <span class="hljs-number"><span class="hljs-number">15.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); GetParam(mFilterRelease)-&gt;SetShape(<span class="hljs-number"><span class="hljs-number">3</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">307</span></span>, <span class="hljs-number"><span class="hljs-number">178</span></span>, mFilterRelease, &amp;smallKnobBitmap)); // Filter envelope amount knob: GetParam(mFilterEnvelopeAmount)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Filter Env Amount"</span></span>, <span class="hljs-number"><span class="hljs-number">0.0</span></span>, -<span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">363</span></span>, <span class="hljs-number"><span class="hljs-number">178</span></span>, mFilterEnvelopeAmount, &amp;smallKnobBitmap));</code> <br> <br>     ,       <code>smallKnobBitmap</code> .                   .     ,    .  <code>Synthesis::OnParamChange</code>    <code>switch</code> : <br> <br> <code class="cpp">case mFilterAttack: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK, GetParam(paramIdx)-&gt;Value()); break; case mFilterDecay: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_DECAY, GetParam(paramIdx)-&gt;Value()); break; case mFilterSustain: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_SUSTAIN, GetParam(paramIdx)-&gt;Value()); break; case mFilterRelease: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE, GetParam(paramIdx)-&gt;Value()); break; case mFilterEnvelopeAmount: filterEnvelopeAmount = GetParam(paramIdx)-&gt;Value(); break;</code> <br> <br> ! <br>     !           (-   C1),   : <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/f5d/757/3f9/f5d7573f9b3a720fe5898d88ae477cfc.png"> <br> <br>        <code>EnvelopeGenerator</code>  .         .        ! <br> <br>    <a href=""></a> . <br> <br>        :) <br> <br>  : <br> <a href="http://martin-finke.de/blog/articles/audio-plugins-013-filter/">martin-finke.de/blog/articles/audio-plugins-<span class="hljs-number"><span class="hljs-number">013</span></span>-filter</a></code></code></code> </pre> <code><code class="cpp">#include  <i>Filter.h</i> ( )     : <br> <br> class Filter { public: enum FilterMode { FILTER_MODE_LOWPASS = 0, FILTER_MODE_HIGHPASS, FILTER_MODE_BANDPASS, kNumFilterModes }; Filter() : cutoff(0.99), resonance(0.0), mode(FILTER_MODE_LOWPASS), buf0(0.0), buf1(0.0) { calculateFeedbackAmount(); }; double process(double inputValue); inline void setCutoff(double newCutoff) { cutoff = newCutoff; calculateFeedbackAmount(); }; inline void setResonance(double newResonance) { resonance = newResonance; calculateFeedbackAmount(); }; inline void setFilterMode(FilterMode newMode) { mode = newMode; } private: double cutoff; double resonance; FilterMode mode; double feedbackAmount; inline void calculateFeedbackAmount() { feedbackAmount = resonance + resonance/(1.0 - cutoff); } double buf0; double buf1; };</code> <br> <br>  <code>private</code>     <i> </i> <code>cutoff</code>  <i></i> <code>resonance</code> . <code>Mode</code>      (Lowpass, Highpass, Bandpass).  <code>feedbackAmount</code> , <code>buf0</code>  <code>buf1</code>    ,    . <br>          ( <code>calculateFeedbackAmount()</code> ).  <code>process</code>      .   <code>feedbackAmount</code>   <code>cutoff</code>  <code>resonance</code> ,    <code>calculateFeedbackAmount</code>      . <br> <br>   <i>Filter.cpp</i>  : <br> <br> <code class="cpp">// By Paul Kellett // http://www.musicdsp.org/showone.php?id=29 double Filter::process(double inputValue) { buf0 += cutoff * (inputValue - buf0); buf1 += cutoff * (buf0 - buf1); switch (mode) { case FILTER_MODE_LOWPASS: return buf1; case FILTER_MODE_HIGHPASS: return inputValue - buf0; case FILTER_MODE_BANDPASS: return buf0 - buf1; default: return 0.0; } }</code> <br> <br> , ?  ,         <i> </i> . ¬´ ¬ª   ,               (. .    6 ).     <code>buf0</code>  <code>buf1</code> :        .     <code>inputValue</code> ,  - <code>buf0</code> (  ).   .    6 /   12 /.  <code>switch</code> ,  <code>buf1</code>    . , ,    <code>buf0</code> ,       12,   6 /,        . <br> <br>  <code>case</code> <code>FILTER_MODE_HIGHPASS</code>    . <code>buf0</code>       .   <code>inputValue</code>  <code>buf0</code> ,   .    <code>buf1</code> ,     . <br> <br>  <code>case</code> <code>FILTER_MODE_BANDPASS</code> ,  <code>buf0 - buf1</code>   .  <code>buf0</code>       ,     <code>buf1</code> . ,   . <br>  :    <i> </i>    <i> </i> ,   . <br> <br>  <code>buf1</code>     .       <a href="http://ru.wikipedia.org/wiki/%25D0%25A4%25D0%25B8%25D0%25BB%25D1%258C%25D1%2582%25D1%2580_%25D1%2581_%25D0%25B1%25D0%25B5%25D1%2581%25D0%25BA%25D0%25BE%25D0%25BD%25D0%25B5%25D1%2587%25D0%25BD%25D0%25BE%25D0%25B9_%25D0%25B8%25D0%25BC%25D0%25BF%25D1%2583%25D0%25BB%25D1%258C%25D1%2581%25D0%25BD%25D0%25BE%25D0%25B9_%25D1%2585%25D0%25B0%25D1%2580%25D0%25B0%25D0%25BA%25D1%2582%25D0%25B5%25D1%2580%25D0%25B8%25D1%2581%25D1%2582%25D0%25B8%25D0%25BA%25D0%25BE%25D0%25B9">    </a> ( <i>Infinite Impulse Response</i> ,  <i>IIR</i> ).  <a href="http://www.dspguide.com/ch14/1.htm"> </a> ,      .      ,         ,      . <br> <br>   <br>       ,     ,     .   ,  ,      ,  ,          .           ,  NI Massive,   ¬´ <a href="http://lurkmore.to/%25D0%25A2%25D1%2591%25D0%25BF%25D0%25BB%25D1%258B%25D0%25B9_%25D0%25BB%25D0%25B0%25D0%25BC%25D0%25BF%25D0%25BE%25D0%25B2%25D1%258B%25D0%25B9_%25D0%25B7%25D0%25B2%25D1%2583%25D0%25BA">  </a> ¬ª.       ,          ,   .        ,          (  Massive       ).      ¬´¬ª , , , AAS Ultra Analog,       ,     ,    ,        .         ,  ,    <a href="http://www.kvraudio.com/forum/viewtopic.php%3Ft%3D350246"></a> ,   ,      NI Reaktor. ,            ‚Äî    ,    ..     . <br> <br>   <br>     .   GUI.  <i>bg.png</i>   ( <i>‚ÄúMove to trash‚Äù</i>  Xcode),       : <br> <br> <a href="">filtermode.png</a> <a href="">knob_small.png</a> (  ,   50 50 ) <a href="">bg.png</a> (       ) <br> <br>    ID  <i>resource.h</i> : <br> <br> <code class="cpp">// Unique IDs for each image resource. #define BG_ID 101 #define WHITE_KEY_ID 102 #define BLACK_KEY_ID 103 #define WAVEFORM_ID 104 #define KNOB_ID 105 #define KNOB_SMALL_ID 106 #define FILTERMODE_ID 107 // Image resource locations for this plug. #define BG_FN "resources/img/bg.png" #define WHITE_KEY_FN "resources/img/whitekey.png" #define BLACK_KEY_FN "resources/img/blackkey.png" #define WAVEFORM_FN "resources/img/waveform.png" #define KNOB_FN "resources/img/knob.png" #define KNOB_SMALL_FN "resources/img/knob_small.png" #define FILTERMODE_FN "resources/img/filtermode.png"</code> <br> <br>  <i>Synthesis.rc</i> : <br> <br> <code class="cpp">#include "resource.h" BG_ID PNG BG_FN WHITE_KEY_ID PNG WHITE_KEY_FN BLACK_KEY_ID PNG BLACK_KEY_FN WAVEFORM_ID PNG WAVEFORM_FN KNOB_ID PNG KNOB_FN KNOB_SMALL_ID PNG KNOB_SMALL_FN FILTERMODE_ID PNG FILTERMODE_FN</code> <br> <br>   <code>#include "Filter.h"</code>  <i>Synthesis.h</i>    <code>private</code> : <br> <br> <code class="cpp">Filter mFilter;</code> <br> <br>  <code>EParams</code>  <i>Synthesis.cpp</i> : <br> <br> <code class="cpp">enum EParams { mWaveform = 0, mAttack, mDecay, mSustain, mRelease, mFilterMode, mFilterCutoff, mFilterResonance, mFilterAttack, mFilterDecay, mFilterSustain, mFilterRelease, mFilterEnvelopeAmount, kNumParams };</code> <br> <br>        : <br> <br> <code class="cpp">pGraphics-&gt;AttachControl(new ISwitchControl(this, 24, 38, mWaveform, &amp;waveformBitmap));</code> <br> <br>      .      (Lowpass, Highpass, Bandpass).    <code>AttachGraphics(pGraphics)</code> : <br> <br> <code class="cpp">GetParam(mFilterMode)-&gt;InitEnum("Filter Mode", Filter::FILTER_MODE_LOWPASS, Filter::kNumFilterModes); IBitmap filtermodeBitmap = pGraphics-&gt;LoadIBitmap(FILTERMODE_ID, FILTERMODE_FN, 3); pGraphics-&gt;AttachControl(new ISwitchControl(this, 24, 123, mFilterMode, &amp;filtermodeBitmap));</code> <br> <br>         .    .     <i>knob_small.png</i> : <br> <br> <code class="cpp">// Knobs for filter cutoff and resonance IBitmap smallKnobBitmap = pGraphics-&gt;LoadIBitmap(KNOB_SMALL_ID, KNOB_SMALL_FN, 64); // Cutoff knob: GetParam(mFilterCutoff)-&gt;InitDouble("Cutoff", 0.99, 0.01, 0.99, 0.001); GetParam(mFilterCutoff)-&gt;SetShape(2); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 5, 177, mFilterCutoff, &amp;smallKnobBitmap)); // Resonance knob: GetParam(mFilterResonance)-&gt;InitDouble("Resonance", 0.01, 0.01, 1.0, 0.001); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 61, 177, mFilterResonance, &amp;smallKnobBitmap));</code> <br> <br>   ,           <code>1.0</code> ,   <code>calculateFeedbackAmount</code>    , . <br>  <code>ProcessDoubleReplacing</code>     : <br> <br> <code class="cpp">leftOutput[i] = rightOutput[i] = mFilter.process(mOscillator.nextSample() * mEnvelopeGenerator.nextSample() * velocity / 127.0);</code> <br> <br>       .  <code>switch</code>   <code>Synthesis::OnParamChange</code> : <br> <br> <code class="cpp">case mFilterCutoff: mFilter.setCutoff(GetParam(paramIdx)-&gt;Value()); break; case mFilterResonance: mFilter.setResonance(GetParam(paramIdx)-&gt;Value()); break; case mFilterMode: mFilter.setFilterMode(static_cast&lt;Filter::FilterMode&gt;(GetParam(paramIdx)-&gt;Int())); break;</code> <br> <br>    .  -      . <br> <br>  <br> <br>  ‚Äî      .   ,   ,          . <br>      : <br> <br> <code class="cpp">buf0 += cutoff * (inputValue - buf0 + feedbackAmount * (buf0 - buf1));</code> <br> <br> ,   ,      ( <code>buf0 ‚Äì buf1</code> ),   <code>feedbackAmount</code> .    <code>calculateFeedbackAmount</code>  <code>feedbackAmount</code>  <code>resonance</code> , . .    ,   . <br> <br>  ,            .     ,  <i></i> ,      <a href="https://www.youtube.com/watch%3Fv%3DJWyMj6KxGHM"> </a> .    ,        ,       . <br> <br>  -12 /  -24 / <br>        !     24   .     <code>switch</code>  <code>Filter::process</code> : <br> <br> <code class="cpp">buf2 += cutoff * (buf1 - buf2); buf3 += cutoff * (buf2 ‚Äì buf3);</code> <br> <br>   :      ,       ,            .     ,       , , <a href="https://ccrma.stanford.edu/~Jos/filters/Filter_Stability.html"></a> (       ).     <code>switch</code> : <br> <br> <code class="cpp">switch (mode) { case FILTER_MODE_LOWPASS: return buf3; case FILTER_MODE_HIGHPASS: return inputValue - buf3; case FILTER_MODE_BANDPASS: return buf0 - buf3; default: return 0.0; }</code> <br> <br>   <code>buf1</code>  <code>buf3</code> ‚Äì      .    -24 /.     <code>buf2</code>  <code>buf3</code> ,        <code>private</code> <i>Filter.h</i> : <br> <br> <code class="cpp">double buf2; double buf3;</code> <br> <br>    ,   <code>buf0</code> c <code>buf1</code> : <br> <br> <code class="cpp">Filter() : // ... buf0(0.0), buf1(0.0), buf2(0.0), buf3(0.0) // ...</code> <br> <br>     , ,     :     .       . <br>          ? <br> <br>   <br>    .  ,           ,       . <br> -      <code>cutoff</code>   .      .    <code>cutoffMod</code> ,    ,       <code>cutoff</code>    .     <code><code>#include    private</code> : <br> <br> <code class="cpp">double cutoffMod;</code> <br> <br> : <br> <br> <code class="cpp">Filter() : cutoff(0.99), resonance(0.01), cutoffMod(0.0), // ...</code> <br> <br>         .   <code>private</code> : <br> <br> <code class="cpp">inline double getCalculatedCutoff() const { return fmax(fmin(cutoff + cutoffMod, 0.99), 0.01); };</code> <br> <br> <code>calculateFeedbackAmount</code>     : <br> <br> <code class="cpp">inline void calculateFeedbackAmount() { feedbackAmount = resonance + resonance/(1.0 - getCalculatedCutoff()); }</code> <br> <br>       <code>cutoffMod</code> .   <code>feedbackAmount</code>    ,     : <br> <br> <code class="cpp">inline void setCutoffMod(double newCutoffMod) { cutoffMod = newCutoffMod; calculateFeedbackAmount(); }</code> <br> <br> ,       .   <code>Filter::process</code>   : <br> <br> <code class="cpp">if (inputValue == 0.0) return inputValue; double calculatedCutoff = getCalculatedCutoff(); buf0 += calculatedCutoff * (inputValue - buf0 + feedbackAmount * (buf0 - buf1)); buf1 += calculatedCutoff * (buf0 - buf1); buf2 += calculatedCutoff * (buf1 - buf2); buf3 += calculatedCutoff * (buf2 ‚Äì buf3);</code> <br> <br>        ,    .    ,      ,   .     .     <code>cutoff</code>  <code>calculatedCutoff</code>   -. <br> <br> ,       ( <code>setCutoffMod</code> ),   <code>Synthesis</code>    ,     ,    .    ,        <code>cutoffMod</code> .    <code>filterEnvelopeAmount</code>    <code>-1</code>  <code>+1</code> .   GUI. <br> <br>   <code>private</code> <i>Synthesis.h</i>    : <br> <br> <code class="cpp">EnvelopeGenerator mFilterEnvelopeGenerator; double filterEnvelopeAmount;</code> <br> <br>       MIDI ,      <code>onNoteOn</code>  <code>onNoteOff</code> : <br> <br> <code class="cpp">inline void onNoteOn(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); mFilterEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); }; inline void onNoteOff(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); mFilterEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); };</code> <br> <br>    .   <code>ProcessDoubleReplacing</code>        : <br> <br> <code class="cpp">mFilter.setCutoffMod(mFilterEnvelopeGenerator.nextSample() * filterEnvelopeAmount);</code> <br> <br>  ,        <code>nextSample</code>  <code>filterEnvelopeAmount</code>     <code>cutoffMod</code> .     <code>filterEnvelopeAmount</code>  : <br> <br> <code class="cpp">Synthesis::Synthesis(IPlugInstanceInfo instanceInfo) : IPLUG_CTOR(kNumParams, kNumPrograms, instanceInfo), lastVirtualKeyboardNoteNumber(virtualKeyboardMinimumNoteNumber - 1), filterEnvelopeAmount(0.0) { // ... }</code> <br> <br>       <code>Synthesis::Reset</code> : <br> <br> <code class="cpp">mFilterEnvelopeGenerator.setSampleRate(GetSampleRate());</code> <br> <br>      <code>EParams</code> ,       .  <code>AttachGraphics</code>     : <br> <br> <code class="cpp">// Knobs for filter envelope // Attack knob GetParam(mFilterAttack)-&gt;InitDouble("Filter Env Attack", 0.01, 0.01, 10.0, 0.001); GetParam(mFilterAttack)-&gt;SetShape(3); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 139, 178, mFilterAttack, &amp;smallKnobBitmap)); // Decay knob: GetParam(mFilterDecay)-&gt;InitDouble("Filter Env Decay", 0.5, 0.01, 15.0, 0.001); GetParam(mFilterDecay)-&gt;SetShape(3); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 195, 178, mFilterDecay, &amp;smallKnobBitmap)); // Sustain knob: GetParam(mFilterSustain)-&gt;InitDouble("Filter Env Sustain", 0.1, 0.001, 1.0, 0.001); GetParam(mFilterSustain)-&gt;SetShape(2); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 251, 178, mFilterSustain, &amp;smallKnobBitmap)); // Release knob: GetParam(mFilterRelease)-&gt;InitDouble("Filter Env Release", 1.0, 0.001, 15.0, 0.001); GetParam(mFilterRelease)-&gt;SetShape(3); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 307, 178, mFilterRelease, &amp;smallKnobBitmap)); // Filter envelope amount knob: GetParam(mFilterEnvelopeAmount)-&gt;InitDouble("Filter Env Amount", 0.0, -1.0, 1.0, 0.001); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 363, 178, mFilterEnvelopeAmount, &amp;smallKnobBitmap));</code> <br> <br>     ,       <code>smallKnobBitmap</code> .                   .     ,    .  <code>Synthesis::OnParamChange</code>    <code>switch</code> : <br> <br> <code class="cpp">case mFilterAttack: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK, GetParam(paramIdx)-&gt;Value()); break; case mFilterDecay: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_DECAY, GetParam(paramIdx)-&gt;Value()); break; case mFilterSustain: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_SUSTAIN, GetParam(paramIdx)-&gt;Value()); break; case mFilterRelease: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE, GetParam(paramIdx)-&gt;Value()); break; case mFilterEnvelopeAmount: filterEnvelopeAmount = GetParam(paramIdx)-&gt;Value(); break;</code> <br> <br> ! <br>     !           (-   C1),   : <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/f5d/757/3f9/f5d7573f9b3a720fe5898d88ae477cfc.png"> <br> <br>        <code>EnvelopeGenerator</code>  .         .        ! <br> <br>    <a href=""></a> . <br> <br>        :) <br> <br>  : <br> <a href="http://martin-finke.de/blog/articles/audio-plugins-013-filter/">martin-finke.de/blog/articles/audio-plugins-013-filter</a></code></code> <pre> <code class="hljs erlang-repl"><code class="cpp">#include  <i>Filter.h</i> ( )     : <br> <br> class Filter { public: enum FilterMode { FILTER_MODE_LOWPASS = <span class="hljs-number"><span class="hljs-number">0</span></span>, FILTER_MODE_HIGHPASS, FILTER_MODE_BANDPASS, kNumFilterModes }; Filter() : cutoff(<span class="hljs-number"><span class="hljs-number">0.99</span></span>), resonance(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), mode(FILTER_MODE_LOWPASS), buf0(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), buf1(<span class="hljs-number"><span class="hljs-number">0.0</span></span>) { calculateFeedbackAmount(); }; double process(double inputValue); inline void setCutoff(double newCutoff) { cutoff = newCutoff; calculateFeedbackAmount(); }; inline void setResonance(double newResonance) { resonance = newResonance; calculateFeedbackAmount(); }; inline void setFilterMode(FilterMode newMode) { mode = newMode; } private: double cutoff; double resonance; FilterMode mode; double feedbackAmount; inline void calculateFeedbackAmount() { feedbackAmount = resonance + resonance/(<span class="hljs-number"><span class="hljs-number">1.0</span></span> - cutoff); } double buf0; double buf1; };</code> <br> <br>  <code>private</code>     <i> </i> <code>cutoff</code>  <i></i> <code>resonance</code> . <code>Mode</code>      (Lowpass, Highpass, Bandpass).  <code>feedbackAmount</code> , <code>buf0</code>  <code>buf1</code>    ,    . <br>          ( <code>calculateFeedbackAmount()</code> ).  <code>process</code>      .   <code>feedbackAmount</code>   <code>cutoff</code>  <code>resonance</code> ,    <code>calculateFeedbackAmount</code>      . <br> <br>   <i>Filter.cpp</i>  : <br> <br> <code class="cpp">// By Paul Kellett // http://www.musicdsp.org/showone.php?id=<span class="hljs-number"><span class="hljs-number">29</span></span> double Filter::process(double inputValue) { buf0 += cutoff * (inputValue - buf0); buf1 += cutoff * (buf0 - buf1); switch (mode) { case FILTER_MODE_LOWPASS: return buf1; case FILTER_MODE_HIGHPASS: return inputValue - buf0; case FILTER_MODE_BANDPASS: return buf0 - buf1; default: return <span class="hljs-number"><span class="hljs-number">0.0</span></span>; } }</code> <br> <br> , ?  ,         <i> </i> . ¬´ ¬ª   ,               (. .    <span class="hljs-number"><span class="hljs-number">6</span></span> ).     <code>buf0</code>  <code>buf1</code> :        .     <code>inputValue</code> ,  - <code>buf0</code> (  ).   .    <span class="hljs-number"><span class="hljs-number">6</span></span> /   <span class="hljs-number"><span class="hljs-number">12</span></span> /.  <code>switch</code> ,  <code>buf1</code>    . , ,    <code>buf0</code> ,       <span class="hljs-number"><span class="hljs-number">12</span></span>,   <span class="hljs-number"><span class="hljs-number">6</span></span> /,        . <br> <br>  <code>case</code> <code>FILTER_MODE_HIGHPASS</code>    . <code>buf0</code>       .   <code>inputValue</code>  <code>buf0</code> ,   .    <code>buf1</code> ,     . <br> <br>  <code>case</code> <code>FILTER_MODE_BANDPASS</code> ,  <code>buf0 - buf1</code>   .  <code>buf0</code>       ,     <code>buf1</code> . ,   . <br>  :    <i> </i>    <i> </i> ,   . <br> <br>  <code>buf1</code>     .       <a href="http://ru.wikipedia.org/wiki/%25D0%25A4%25D0%25B8%25D0%25BB%25D1%258C%25D1%2582%25D1%2580_%25D1%2581_%25D0%25B1%25D0%25B5%25D1%2581%25D0%25BA%25D0%25BE%25D0%25BD%25D0%25B5%25D1%2587%25D0%25BD%25D0%25BE%25D0%25B9_%25D0%25B8%25D0%25BC%25D0%25BF%25D1%2583%25D0%25BB%25D1%258C%25D1%2581%25D0%25BD%25D0%25BE%25D0%25B9_%25D1%2585%25D0%25B0%25D1%2580%25D0%25B0%25D0%25BA%25D1%2582%25D0%25B5%25D1%2580%25D0%25B8%25D1%2581%25D1%2582%25D0%25B8%25D0%25BA%25D0%25BE%25D0%25B9">    </a> ( <i>Infinite Impulse Response</i> ,  <i>IIR</i> ).  <a href="http://www.dspguide.com/ch14/1.htm"> </a> ,      .      ,         ,      . <br> <br>   <br>       ,     ,     .   ,  ,      ,  ,          .           ,  NI Massive,   ¬´ <a href="http://lurkmore.to/%25D0%25A2%25D1%2591%25D0%25BF%25D0%25BB%25D1%258B%25D0%25B9_%25D0%25BB%25D0%25B0%25D0%25BC%25D0%25BF%25D0%25BE%25D0%25B2%25D1%258B%25D0%25B9_%25D0%25B7%25D0%25B2%25D1%2583%25D0%25BA">  </a> ¬ª.       ,          ,   .        ,          (  Massive       ).      ¬´¬ª , , , AAS Ultra Analog,       ,     ,    ,        .         ,  ,    <a href="http://www.kvraudio.com/forum/viewtopic.php%3Ft%3D350246"></a> ,   ,      NI Reaktor. ,            ‚Äî    ,    ..     . <br> <br>   <br>     .   GUI.  <i>bg.png</i>   ( <i>‚ÄúMove to trash‚Äù</i>  Xcode),       : <br> <br> <a href="">filtermode.png</a> <a href="">knob_small.png</a> (  ,   <span class="hljs-number"><span class="hljs-number">50</span></span> <span class="hljs-number"><span class="hljs-number">50</span></span> ) <a href="">bg.png</a> (       ) <br> <br>    ID  <i>resource.h</i> : <br> <br> <code class="cpp">// Unique IDs for each image resource. #define BG_ID <span class="hljs-number"><span class="hljs-number">101</span></span> #define WHITE_KEY_ID <span class="hljs-number"><span class="hljs-number">102</span></span> #define BLACK_KEY_ID <span class="hljs-number"><span class="hljs-number">103</span></span> #define WAVEFORM_ID <span class="hljs-number"><span class="hljs-number">104</span></span> #define KNOB_ID <span class="hljs-number"><span class="hljs-number">105</span></span> #define KNOB_SMALL_ID <span class="hljs-number"><span class="hljs-number">106</span></span> #define FILTERMODE_ID <span class="hljs-number"><span class="hljs-number">107</span></span> // Image resource locations for this plug. #define BG_FN <span class="hljs-string"><span class="hljs-string">"resources/img/bg.png"</span></span> #define WHITE_KEY_FN <span class="hljs-string"><span class="hljs-string">"resources/img/whitekey.png"</span></span> #define BLACK_KEY_FN <span class="hljs-string"><span class="hljs-string">"resources/img/blackkey.png"</span></span> #define WAVEFORM_FN <span class="hljs-string"><span class="hljs-string">"resources/img/waveform.png"</span></span> #define KNOB_FN <span class="hljs-string"><span class="hljs-string">"resources/img/knob.png"</span></span> #define KNOB_SMALL_FN <span class="hljs-string"><span class="hljs-string">"resources/img/knob_small.png"</span></span> #define FILTERMODE_FN <span class="hljs-string"><span class="hljs-string">"resources/img/filtermode.png"</span></span></code> <br> <br>  <i>Synthesis.rc</i> : <br> <br> <code class="cpp">#include <span class="hljs-string"><span class="hljs-string">"resource.h"</span></span> BG_ID PNG BG_FN WHITE_KEY_ID PNG WHITE_KEY_FN BLACK_KEY_ID PNG BLACK_KEY_FN WAVEFORM_ID PNG WAVEFORM_FN KNOB_ID PNG KNOB_FN KNOB_SMALL_ID PNG KNOB_SMALL_FN FILTERMODE_ID PNG FILTERMODE_FN</code> <br> <br>   <code>#include <span class="hljs-string"><span class="hljs-string">"Filter.h"</span></span></code>  <i>Synthesis.h</i>    <code>private</code> : <br> <br> <code class="cpp">Filter mFilter;</code> <br> <br>  <code>EParams</code>  <i>Synthesis.cpp</i> : <br> <br> <code class="cpp">enum EParams { mWaveform = <span class="hljs-number"><span class="hljs-number">0</span></span>, mAttack, mDecay, mSustain, mRelease, mFilterMode, mFilterCutoff, mFilterResonance, mFilterAttack, mFilterDecay, mFilterSustain, mFilterRelease, mFilterEnvelopeAmount, kNumParams };</code> <br> <br>        : <br> <br> <code class="cpp">pGraphics-&gt;AttachControl(new ISwitchControl(this, <span class="hljs-number"><span class="hljs-number">24</span></span>, <span class="hljs-number"><span class="hljs-number">38</span></span>, mWaveform, &amp;waveformBitmap));</code> <br> <br>      .      (Lowpass, Highpass, Bandpass).    <code>AttachGraphics(pGraphics)</code> : <br> <br> <code class="cpp">GetParam(mFilterMode)-&gt;InitEnum(<span class="hljs-string"><span class="hljs-string">"Filter Mode"</span></span>, Filter::FILTER_MODE_LOWPASS, Filter::kNumFilterModes); IBitmap filtermodeBitmap = pGraphics-&gt;LoadIBitmap(FILTERMODE_ID, FILTERMODE_FN, <span class="hljs-number"><span class="hljs-number">3</span></span>); pGraphics-&gt;AttachControl(new ISwitchControl(this, <span class="hljs-number"><span class="hljs-number">24</span></span>, <span class="hljs-number"><span class="hljs-number">123</span></span>, mFilterMode, &amp;filtermodeBitmap));</code> <br> <br>         .    .     <i>knob_small.png</i> : <br> <br> <code class="cpp">// Knobs for filter cutoff and resonance IBitmap smallKnobBitmap = pGraphics-&gt;LoadIBitmap(KNOB_SMALL_ID, KNOB_SMALL_FN, <span class="hljs-number"><span class="hljs-number">64</span></span>); // Cutoff knob: GetParam(mFilterCutoff)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Cutoff"</span></span>, <span class="hljs-number"><span class="hljs-number">0.99</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">0.99</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); GetParam(mFilterCutoff)-&gt;SetShape(<span class="hljs-number"><span class="hljs-number">2</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-number"><span class="hljs-number">177</span></span>, mFilterCutoff, &amp;smallKnobBitmap)); // Resonance knob: GetParam(mFilterResonance)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Resonance"</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">61</span></span>, <span class="hljs-number"><span class="hljs-number">177</span></span>, mFilterResonance, &amp;smallKnobBitmap));</code> <br> <br>   ,           <code><span class="hljs-number"><span class="hljs-number">1.0</span></span></code> ,   <code>calculateFeedbackAmount</code>    , . <br>  <code>ProcessDoubleReplacing</code>     : <br> <br> <code class="cpp">leftOutput[i] = rightOutput[i] = mFilter.process(mOscillator.nextSample() * mEnvelopeGenerator.nextSample() * velocity / <span class="hljs-number"><span class="hljs-number">127.0</span></span>);</code> <br> <br>       .  <code>switch</code>   <code>Synthesis::OnParamChange</code> : <br> <br> <code class="cpp">case mFilterCutoff: mFilter.setCutoff(GetParam(paramIdx)-&gt;Value()); break; case mFilterResonance: mFilter.setResonance(GetParam(paramIdx)-&gt;Value()); break; case mFilterMode: mFilter.setFilterMode(static_cast&lt;Filter::FilterMode&gt;(GetParam(paramIdx)-&gt;Int())); break;</code> <br> <br>    .  -      . <br> <br>  <br> <br>  ‚Äî      .   ,   ,          . <br>      : <br> <br> <code class="cpp">buf0 += cutoff * (inputValue - buf0 + feedbackAmount * (buf0 - buf1));</code> <br> <br> ,   ,      ( <code>buf0 ‚Äì buf1</code> ),   <code>feedbackAmount</code> .    <code>calculateFeedbackAmount</code>  <code>feedbackAmount</code>  <code>resonance</code> , . .    ,   . <br> <br>  ,            .     ,  <i></i> ,      <a href="https://www.youtube.com/watch%3Fv%3DJWyMj6KxGHM"> </a> .    ,        ,       . <br> <br>  -<span class="hljs-number"><span class="hljs-number">12</span></span> /  -<span class="hljs-number"><span class="hljs-number">24</span></span> / <br>        !     <span class="hljs-number"><span class="hljs-number">24</span></span>   .     <code>switch</code>  <code>Filter::process</code> : <br> <br> <code class="cpp">buf2 += cutoff * (buf1 - buf2); buf3 += cutoff * (buf2 ‚Äì buf3);</code> <br> <br>   :      ,       ,            .     ,       , , <a href="https://ccrma.stanford.edu/~Jos/filters/Filter_Stability.html"></a> (       ).     <code>switch</code> : <br> <br> <code class="cpp">switch (mode) { case FILTER_MODE_LOWPASS: return buf3; case FILTER_MODE_HIGHPASS: return inputValue - buf3; case FILTER_MODE_BANDPASS: return buf0 - buf3; default: return <span class="hljs-number"><span class="hljs-number">0.0</span></span>; }</code> <br> <br>   <code>buf1</code>  <code>buf3</code> ‚Äì      .    -<span class="hljs-number"><span class="hljs-number">24</span></span> /.     <code>buf2</code>  <code>buf3</code> ,        <code>private</code> <i>Filter.h</i> : <br> <br> <code class="cpp">double buf2; double buf3;</code> <br> <br>    ,   <code>buf0</code> c <code>buf1</code> : <br> <br> <code class="cpp">Filter() : // ... buf0(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), buf1(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), buf2(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), buf3(<span class="hljs-number"><span class="hljs-number">0.0</span></span>) // ...</code> <br> <br>     , ,     :     .       . <br>          ? <br> <br>   <br>    .  ,           ,       . <br> -      <code>cutoff</code>   .      .    <code>cutoffMod</code> ,    ,       <code>cutoff</code>    .     <code><code>#include    private</code> : <br> <br> <code class="cpp">double cutoffMod;</code> <br> <br> : <br> <br> <code class="cpp">Filter() : cutoff(<span class="hljs-number"><span class="hljs-number">0.99</span></span>), resonance(<span class="hljs-number"><span class="hljs-number">0.01</span></span>), cutoffMod(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), // ...</code> <br> <br>         .   <code>private</code> : <br> <br> <code class="cpp">inline double getCalculatedCutoff() const { return fmax(fmin(cutoff + cutoffMod, <span class="hljs-number"><span class="hljs-number">0.99</span></span>), <span class="hljs-number"><span class="hljs-number">0.01</span></span>); };</code> <br> <br> <code>calculateFeedbackAmount</code>     : <br> <br> <code class="cpp">inline void calculateFeedbackAmount() { feedbackAmount = resonance + resonance/(<span class="hljs-number"><span class="hljs-number">1.0</span></span> - getCalculatedCutoff()); }</code> <br> <br>       <code>cutoffMod</code> .   <code>feedbackAmount</code>    ,     : <br> <br> <code class="cpp">inline void setCutoffMod(double newCutoffMod) { cutoffMod = newCutoffMod; calculateFeedbackAmount(); }</code> <br> <br> ,       .   <code>Filter::process</code>   : <br> <br> <code class="cpp">if (inputValue == <span class="hljs-number"><span class="hljs-number">0.0</span></span>) return inputValue; double calculatedCutoff = getCalculatedCutoff(); buf0 += calculatedCutoff * (inputValue - buf0 + feedbackAmount * (buf0 - buf1)); buf1 += calculatedCutoff * (buf0 - buf1); buf2 += calculatedCutoff * (buf1 - buf2); buf3 += calculatedCutoff * (buf2 ‚Äì buf3);</code> <br> <br>        ,    .    ,      ,   .     .     <code>cutoff</code>  <code>calculatedCutoff</code>   -. <br> <br> ,       ( <code>setCutoffMod</code> ),   <code>Synthesis</code>    ,     ,    .    ,        <code>cutoffMod</code> .    <code>filterEnvelopeAmount</code>    <code>-<span class="hljs-number"><span class="hljs-number">1</span></span></code>  <code>+<span class="hljs-number"><span class="hljs-number">1</span></span></code> .   GUI. <br> <br>   <code>private</code> <i>Synthesis.h</i>    : <br> <br> <code class="cpp">EnvelopeGenerator mFilterEnvelopeGenerator; double filterEnvelopeAmount;</code> <br> <br>       MIDI ,      <code>onNoteOn</code>  <code>onNoteOff</code> : <br> <br> <code class="cpp">inline void onNoteOn(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); mFilterEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); }; inline void onNoteOff(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); mFilterEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); };</code> <br> <br>    .   <code>ProcessDoubleReplacing</code>        : <br> <br> <code class="cpp">mFilter.setCutoffMod(mFilterEnvelopeGenerator.nextSample() * filterEnvelopeAmount);</code> <br> <br>  ,        <code>nextSample</code>  <code>filterEnvelopeAmount</code>     <code>cutoffMod</code> .     <code>filterEnvelopeAmount</code>  : <br> <br> <code class="cpp">Synthesis::Synthesis(IPlugInstanceInfo instanceInfo) : IPLUG_CTOR(kNumParams, kNumPrograms, instanceInfo), lastVirtualKeyboardNoteNumber(virtualKeyboardMinimumNoteNumber - <span class="hljs-number"><span class="hljs-number">1</span></span>), filterEnvelopeAmount(<span class="hljs-number"><span class="hljs-number">0.0</span></span>) { // ... }</code> <br> <br>       <code>Synthesis::Reset</code> : <br> <br> <code class="cpp">mFilterEnvelopeGenerator.setSampleRate(GetSampleRate());</code> <br> <br>      <code>EParams</code> ,       .  <code>AttachGraphics</code>     : <br> <br> <code class="cpp">// Knobs for filter envelope // Attack knob GetParam(mFilterAttack)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Filter Env Attack"</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">10.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); GetParam(mFilterAttack)-&gt;SetShape(<span class="hljs-number"><span class="hljs-number">3</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">139</span></span>, <span class="hljs-number"><span class="hljs-number">178</span></span>, mFilterAttack, &amp;smallKnobBitmap)); // Decay knob: GetParam(mFilterDecay)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Filter Env Decay"</span></span>, <span class="hljs-number"><span class="hljs-number">0.5</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">15.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); GetParam(mFilterDecay)-&gt;SetShape(<span class="hljs-number"><span class="hljs-number">3</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">195</span></span>, <span class="hljs-number"><span class="hljs-number">178</span></span>, mFilterDecay, &amp;smallKnobBitmap)); // Sustain knob: GetParam(mFilterSustain)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Filter Env Sustain"</span></span>, <span class="hljs-number"><span class="hljs-number">0.1</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>, <span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); GetParam(mFilterSustain)-&gt;SetShape(<span class="hljs-number"><span class="hljs-number">2</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">251</span></span>, <span class="hljs-number"><span class="hljs-number">178</span></span>, mFilterSustain, &amp;smallKnobBitmap)); // Release knob: GetParam(mFilterRelease)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Filter Env Release"</span></span>, <span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>, <span class="hljs-number"><span class="hljs-number">15.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); GetParam(mFilterRelease)-&gt;SetShape(<span class="hljs-number"><span class="hljs-number">3</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">307</span></span>, <span class="hljs-number"><span class="hljs-number">178</span></span>, mFilterRelease, &amp;smallKnobBitmap)); // Filter envelope amount knob: GetParam(mFilterEnvelopeAmount)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Filter Env Amount"</span></span>, <span class="hljs-number"><span class="hljs-number">0.0</span></span>, -<span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">363</span></span>, <span class="hljs-number"><span class="hljs-number">178</span></span>, mFilterEnvelopeAmount, &amp;smallKnobBitmap));</code> <br> <br>     ,       <code>smallKnobBitmap</code> .                   .     ,    .  <code>Synthesis::OnParamChange</code>    <code>switch</code> : <br> <br> <code class="cpp">case mFilterAttack: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK, GetParam(paramIdx)-&gt;Value()); break; case mFilterDecay: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_DECAY, GetParam(paramIdx)-&gt;Value()); break; case mFilterSustain: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_SUSTAIN, GetParam(paramIdx)-&gt;Value()); break; case mFilterRelease: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE, GetParam(paramIdx)-&gt;Value()); break; case mFilterEnvelopeAmount: filterEnvelopeAmount = GetParam(paramIdx)-&gt;Value(); break;</code> <br> <br> ! <br>     !           (-   C1),   : <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/f5d/757/3f9/f5d7573f9b3a720fe5898d88ae477cfc.png"> <br> <br>        <code>EnvelopeGenerator</code>  .         .        ! <br> <br>    <a href=""></a> . <br> <br>        :) <br> <br>  : <br> <a href="http://martin-finke.de/blog/articles/audio-plugins-013-filter/">martin-finke.de/blog/articles/audio-plugins-<span class="hljs-number"><span class="hljs-number">013</span></span>-filter</a></code></code> </pre> <code><code class="cpp">#include  <i>Filter.h</i> ( )     : <br> <br> class Filter { public: enum FilterMode { FILTER_MODE_LOWPASS = 0, FILTER_MODE_HIGHPASS, FILTER_MODE_BANDPASS, kNumFilterModes }; Filter() : cutoff(0.99), resonance(0.0), mode(FILTER_MODE_LOWPASS), buf0(0.0), buf1(0.0) { calculateFeedbackAmount(); }; double process(double inputValue); inline void setCutoff(double newCutoff) { cutoff = newCutoff; calculateFeedbackAmount(); }; inline void setResonance(double newResonance) { resonance = newResonance; calculateFeedbackAmount(); }; inline void setFilterMode(FilterMode newMode) { mode = newMode; } private: double cutoff; double resonance; FilterMode mode; double feedbackAmount; inline void calculateFeedbackAmount() { feedbackAmount = resonance + resonance/(1.0 - cutoff); } double buf0; double buf1; };</code> <br> <br>  <code>private</code>     <i> </i> <code>cutoff</code>  <i></i> <code>resonance</code> . <code>Mode</code>      (Lowpass, Highpass, Bandpass).  <code>feedbackAmount</code> , <code>buf0</code>  <code>buf1</code>    ,    . <br>          ( <code>calculateFeedbackAmount()</code> ).  <code>process</code>      .   <code>feedbackAmount</code>   <code>cutoff</code>  <code>resonance</code> ,    <code>calculateFeedbackAmount</code>      . <br> <br>   <i>Filter.cpp</i>  : <br> <br> <code class="cpp">// By Paul Kellett // http://www.musicdsp.org/showone.php?id=29 double Filter::process(double inputValue) { buf0 += cutoff * (inputValue - buf0); buf1 += cutoff * (buf0 - buf1); switch (mode) { case FILTER_MODE_LOWPASS: return buf1; case FILTER_MODE_HIGHPASS: return inputValue - buf0; case FILTER_MODE_BANDPASS: return buf0 - buf1; default: return 0.0; } }</code> <br> <br> , ?  ,         <i> </i> . ¬´ ¬ª   ,               (. .    6 ).     <code>buf0</code>  <code>buf1</code> :        .     <code>inputValue</code> ,  - <code>buf0</code> (  ).   .    6 /   12 /.  <code>switch</code> ,  <code>buf1</code>    . , ,    <code>buf0</code> ,       12,   6 /,        . <br> <br>  <code>case</code> <code>FILTER_MODE_HIGHPASS</code>    . <code>buf0</code>       .   <code>inputValue</code>  <code>buf0</code> ,   .    <code>buf1</code> ,     . <br> <br>  <code>case</code> <code>FILTER_MODE_BANDPASS</code> ,  <code>buf0 - buf1</code>   .  <code>buf0</code>       ,     <code>buf1</code> . ,   . <br>  :    <i> </i>    <i> </i> ,   . <br> <br>  <code>buf1</code>     .       <a href="http://ru.wikipedia.org/wiki/%25D0%25A4%25D0%25B8%25D0%25BB%25D1%258C%25D1%2582%25D1%2580_%25D1%2581_%25D0%25B1%25D0%25B5%25D1%2581%25D0%25BA%25D0%25BE%25D0%25BD%25D0%25B5%25D1%2587%25D0%25BD%25D0%25BE%25D0%25B9_%25D0%25B8%25D0%25BC%25D0%25BF%25D1%2583%25D0%25BB%25D1%258C%25D1%2581%25D0%25BD%25D0%25BE%25D0%25B9_%25D1%2585%25D0%25B0%25D1%2580%25D0%25B0%25D0%25BA%25D1%2582%25D0%25B5%25D1%2580%25D0%25B8%25D1%2581%25D1%2582%25D0%25B8%25D0%25BA%25D0%25BE%25D0%25B9">    </a> ( <i>Infinite Impulse Response</i> ,  <i>IIR</i> ).  <a href="http://www.dspguide.com/ch14/1.htm"> </a> ,      .      ,         ,      . <br> <br>   <br>       ,     ,     .   ,  ,      ,  ,          .           ,  NI Massive,   ¬´ <a href="http://lurkmore.to/%25D0%25A2%25D1%2591%25D0%25BF%25D0%25BB%25D1%258B%25D0%25B9_%25D0%25BB%25D0%25B0%25D0%25BC%25D0%25BF%25D0%25BE%25D0%25B2%25D1%258B%25D0%25B9_%25D0%25B7%25D0%25B2%25D1%2583%25D0%25BA">  </a> ¬ª.       ,          ,   .        ,          (  Massive       ).      ¬´¬ª , , , AAS Ultra Analog,       ,     ,    ,        .         ,  ,    <a href="http://www.kvraudio.com/forum/viewtopic.php%3Ft%3D350246"></a> ,   ,      NI Reaktor. ,            ‚Äî    ,    ..     . <br> <br>   <br>     .   GUI.  <i>bg.png</i>   ( <i>‚ÄúMove to trash‚Äù</i>  Xcode),       : <br> <br> <a href="">filtermode.png</a> <a href="">knob_small.png</a> (  ,   50 50 ) <a href="">bg.png</a> (       ) <br> <br>    ID  <i>resource.h</i> : <br> <br> <code class="cpp">// Unique IDs for each image resource. #define BG_ID 101 #define WHITE_KEY_ID 102 #define BLACK_KEY_ID 103 #define WAVEFORM_ID 104 #define KNOB_ID 105 #define KNOB_SMALL_ID 106 #define FILTERMODE_ID 107 // Image resource locations for this plug. #define BG_FN "resources/img/bg.png" #define WHITE_KEY_FN "resources/img/whitekey.png" #define BLACK_KEY_FN "resources/img/blackkey.png" #define WAVEFORM_FN "resources/img/waveform.png" #define KNOB_FN "resources/img/knob.png" #define KNOB_SMALL_FN "resources/img/knob_small.png" #define FILTERMODE_FN "resources/img/filtermode.png"</code> <br> <br>  <i>Synthesis.rc</i> : <br> <br> <code class="cpp">#include "resource.h" BG_ID PNG BG_FN WHITE_KEY_ID PNG WHITE_KEY_FN BLACK_KEY_ID PNG BLACK_KEY_FN WAVEFORM_ID PNG WAVEFORM_FN KNOB_ID PNG KNOB_FN KNOB_SMALL_ID PNG KNOB_SMALL_FN FILTERMODE_ID PNG FILTERMODE_FN</code> <br> <br>   <code>#include "Filter.h"</code>  <i>Synthesis.h</i>    <code>private</code> : <br> <br> <code class="cpp">Filter mFilter;</code> <br> <br>  <code>EParams</code>  <i>Synthesis.cpp</i> : <br> <br> <code class="cpp">enum EParams { mWaveform = 0, mAttack, mDecay, mSustain, mRelease, mFilterMode, mFilterCutoff, mFilterResonance, mFilterAttack, mFilterDecay, mFilterSustain, mFilterRelease, mFilterEnvelopeAmount, kNumParams };</code> <br> <br>        : <br> <br> <code class="cpp">pGraphics-&gt;AttachControl(new ISwitchControl(this, 24, 38, mWaveform, &amp;waveformBitmap));</code> <br> <br>      .      (Lowpass, Highpass, Bandpass).    <code>AttachGraphics(pGraphics)</code> : <br> <br> <code class="cpp">GetParam(mFilterMode)-&gt;InitEnum("Filter Mode", Filter::FILTER_MODE_LOWPASS, Filter::kNumFilterModes); IBitmap filtermodeBitmap = pGraphics-&gt;LoadIBitmap(FILTERMODE_ID, FILTERMODE_FN, 3); pGraphics-&gt;AttachControl(new ISwitchControl(this, 24, 123, mFilterMode, &amp;filtermodeBitmap));</code> <br> <br>         .    .     <i>knob_small.png</i> : <br> <br> <code class="cpp">// Knobs for filter cutoff and resonance IBitmap smallKnobBitmap = pGraphics-&gt;LoadIBitmap(KNOB_SMALL_ID, KNOB_SMALL_FN, 64); // Cutoff knob: GetParam(mFilterCutoff)-&gt;InitDouble("Cutoff", 0.99, 0.01, 0.99, 0.001); GetParam(mFilterCutoff)-&gt;SetShape(2); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 5, 177, mFilterCutoff, &amp;smallKnobBitmap)); // Resonance knob: GetParam(mFilterResonance)-&gt;InitDouble("Resonance", 0.01, 0.01, 1.0, 0.001); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 61, 177, mFilterResonance, &amp;smallKnobBitmap));</code> <br> <br>   ,           <code>1.0</code> ,   <code>calculateFeedbackAmount</code>    , . <br>  <code>ProcessDoubleReplacing</code>     : <br> <br> <code class="cpp">leftOutput[i] = rightOutput[i] = mFilter.process(mOscillator.nextSample() * mEnvelopeGenerator.nextSample() * velocity / 127.0);</code> <br> <br>       .  <code>switch</code>   <code>Synthesis::OnParamChange</code> : <br> <br> <code class="cpp">case mFilterCutoff: mFilter.setCutoff(GetParam(paramIdx)-&gt;Value()); break; case mFilterResonance: mFilter.setResonance(GetParam(paramIdx)-&gt;Value()); break; case mFilterMode: mFilter.setFilterMode(static_cast&lt;Filter::FilterMode&gt;(GetParam(paramIdx)-&gt;Int())); break;</code> <br> <br>    .  -      . <br> <br>  <br> <br>  ‚Äî      .   ,   ,          . <br>      : <br> <br> <code class="cpp">buf0 += cutoff * (inputValue - buf0 + feedbackAmount * (buf0 - buf1));</code> <br> <br> ,   ,      ( <code>buf0 ‚Äì buf1</code> ),   <code>feedbackAmount</code> .    <code>calculateFeedbackAmount</code>  <code>feedbackAmount</code>  <code>resonance</code> , . .    ,   . <br> <br>  ,            .     ,  <i></i> ,      <a href="https://www.youtube.com/watch%3Fv%3DJWyMj6KxGHM"> </a> .    ,        ,       . <br> <br>  -12 /  -24 / <br>        !     24   .     <code>switch</code>  <code>Filter::process</code> : <br> <br> <code class="cpp">buf2 += cutoff * (buf1 - buf2); buf3 += cutoff * (buf2 ‚Äì buf3);</code> <br> <br>   :      ,       ,            .     ,       , , <a href="https://ccrma.stanford.edu/~Jos/filters/Filter_Stability.html"></a> (       ).     <code>switch</code> : <br> <br> <code class="cpp">switch (mode) { case FILTER_MODE_LOWPASS: return buf3; case FILTER_MODE_HIGHPASS: return inputValue - buf3; case FILTER_MODE_BANDPASS: return buf0 - buf3; default: return 0.0; }</code> <br> <br>   <code>buf1</code>  <code>buf3</code> ‚Äì      .    -24 /.     <code>buf2</code>  <code>buf3</code> ,        <code>private</code> <i>Filter.h</i> : <br> <br> <code class="cpp">double buf2; double buf3;</code> <br> <br>    ,   <code>buf0</code> c <code>buf1</code> : <br> <br> <code class="cpp">Filter() : // ... buf0(0.0), buf1(0.0), buf2(0.0), buf3(0.0) // ...</code> <br> <br>     , ,     :     .       . <br>          ? <br> <br>   <br>    .  ,           ,       . <br> -      <code>cutoff</code>   .      .    <code>cutoffMod</code> ,    ,       <code>cutoff</code>    .     <code><code>#include    private</code> : <br> <br> <code class="cpp">double cutoffMod;</code> <br> <br> : <br> <br> <code class="cpp">Filter() : cutoff(0.99), resonance(0.01), cutoffMod(0.0), // ...</code> <br> <br>         .   <code>private</code> : <br> <br> <code class="cpp">inline double getCalculatedCutoff() const { return fmax(fmin(cutoff + cutoffMod, 0.99), 0.01); };</code> <br> <br> <code>calculateFeedbackAmount</code>     : <br> <br> <code class="cpp">inline void calculateFeedbackAmount() { feedbackAmount = resonance + resonance/(1.0 - getCalculatedCutoff()); }</code> <br> <br>       <code>cutoffMod</code> .   <code>feedbackAmount</code>    ,     : <br> <br> <code class="cpp">inline void setCutoffMod(double newCutoffMod) { cutoffMod = newCutoffMod; calculateFeedbackAmount(); }</code> <br> <br> ,       .   <code>Filter::process</code>   : <br> <br> <code class="cpp">if (inputValue == 0.0) return inputValue; double calculatedCutoff = getCalculatedCutoff(); buf0 += calculatedCutoff * (inputValue - buf0 + feedbackAmount * (buf0 - buf1)); buf1 += calculatedCutoff * (buf0 - buf1); buf2 += calculatedCutoff * (buf1 - buf2); buf3 += calculatedCutoff * (buf2 ‚Äì buf3);</code> <br> <br>        ,    .    ,      ,   .     .     <code>cutoff</code>  <code>calculatedCutoff</code>   -. <br> <br> ,       ( <code>setCutoffMod</code> ),   <code>Synthesis</code>    ,     ,    .    ,        <code>cutoffMod</code> .    <code>filterEnvelopeAmount</code>    <code>-1</code>  <code>+1</code> .   GUI. <br> <br>   <code>private</code> <i>Synthesis.h</i>    : <br> <br> <code class="cpp">EnvelopeGenerator mFilterEnvelopeGenerator; double filterEnvelopeAmount;</code> <br> <br>       MIDI ,      <code>onNoteOn</code>  <code>onNoteOff</code> : <br> <br> <code class="cpp">inline void onNoteOn(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); mFilterEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); }; inline void onNoteOff(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); mFilterEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); };</code> <br> <br>    .   <code>ProcessDoubleReplacing</code>        : <br> <br> <code class="cpp">mFilter.setCutoffMod(mFilterEnvelopeGenerator.nextSample() * filterEnvelopeAmount);</code> <br> <br>  ,        <code>nextSample</code>  <code>filterEnvelopeAmount</code>     <code>cutoffMod</code> .     <code>filterEnvelopeAmount</code>  : <br> <br> <code class="cpp">Synthesis::Synthesis(IPlugInstanceInfo instanceInfo) : IPLUG_CTOR(kNumParams, kNumPrograms, instanceInfo), lastVirtualKeyboardNoteNumber(virtualKeyboardMinimumNoteNumber - 1), filterEnvelopeAmount(0.0) { // ... }</code> <br> <br>       <code>Synthesis::Reset</code> : <br> <br> <code class="cpp">mFilterEnvelopeGenerator.setSampleRate(GetSampleRate());</code> <br> <br>      <code>EParams</code> ,       .  <code>AttachGraphics</code>     : <br> <br> <code class="cpp">// Knobs for filter envelope // Attack knob GetParam(mFilterAttack)-&gt;InitDouble("Filter Env Attack", 0.01, 0.01, 10.0, 0.001); GetParam(mFilterAttack)-&gt;SetShape(3); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 139, 178, mFilterAttack, &amp;smallKnobBitmap)); // Decay knob: GetParam(mFilterDecay)-&gt;InitDouble("Filter Env Decay", 0.5, 0.01, 15.0, 0.001); GetParam(mFilterDecay)-&gt;SetShape(3); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 195, 178, mFilterDecay, &amp;smallKnobBitmap)); // Sustain knob: GetParam(mFilterSustain)-&gt;InitDouble("Filter Env Sustain", 0.1, 0.001, 1.0, 0.001); GetParam(mFilterSustain)-&gt;SetShape(2); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 251, 178, mFilterSustain, &amp;smallKnobBitmap)); // Release knob: GetParam(mFilterRelease)-&gt;InitDouble("Filter Env Release", 1.0, 0.001, 15.0, 0.001); GetParam(mFilterRelease)-&gt;SetShape(3); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 307, 178, mFilterRelease, &amp;smallKnobBitmap)); // Filter envelope amount knob: GetParam(mFilterEnvelopeAmount)-&gt;InitDouble("Filter Env Amount", 0.0, -1.0, 1.0, 0.001); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 363, 178, mFilterEnvelopeAmount, &amp;smallKnobBitmap));</code> <br> <br>     ,       <code>smallKnobBitmap</code> .                   .     ,    .  <code>Synthesis::OnParamChange</code>    <code>switch</code> : <br> <br> <code class="cpp">case mFilterAttack: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK, GetParam(paramIdx)-&gt;Value()); break; case mFilterDecay: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_DECAY, GetParam(paramIdx)-&gt;Value()); break; case mFilterSustain: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_SUSTAIN, GetParam(paramIdx)-&gt;Value()); break; case mFilterRelease: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE, GetParam(paramIdx)-&gt;Value()); break; case mFilterEnvelopeAmount: filterEnvelopeAmount = GetParam(paramIdx)-&gt;Value(); break;</code> <br> <br> ! <br>     !           (-   C1),   : <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/f5d/757/3f9/f5d7573f9b3a720fe5898d88ae477cfc.png"> <br> <br>        <code>EnvelopeGenerator</code>  .         .        ! <br> <br>    <a href=""></a> . <br> <br>        :) <br> <br>  : <br> <a href="http://martin-finke.de/blog/articles/audio-plugins-013-filter/">martin-finke.de/blog/articles/audio-plugins-013-filter</a></code></code> <pre> <code class="hljs erlang-repl"><code class="cpp"><code class="cpp">#include  <i>Filter.h</i> ( )     : <br> <br> class Filter { public: enum FilterMode { FILTER_MODE_LOWPASS = <span class="hljs-number"><span class="hljs-number">0</span></span>, FILTER_MODE_HIGHPASS, FILTER_MODE_BANDPASS, kNumFilterModes }; Filter() : cutoff(<span class="hljs-number"><span class="hljs-number">0.99</span></span>), resonance(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), mode(FILTER_MODE_LOWPASS), buf0(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), buf1(<span class="hljs-number"><span class="hljs-number">0.0</span></span>) { calculateFeedbackAmount(); }; double process(double inputValue); inline void setCutoff(double newCutoff) { cutoff = newCutoff; calculateFeedbackAmount(); }; inline void setResonance(double newResonance) { resonance = newResonance; calculateFeedbackAmount(); }; inline void setFilterMode(FilterMode newMode) { mode = newMode; } private: double cutoff; double resonance; FilterMode mode; double feedbackAmount; inline void calculateFeedbackAmount() { feedbackAmount = resonance + resonance/(<span class="hljs-number"><span class="hljs-number">1.0</span></span> - cutoff); } double buf0; double buf1; };</code> <br> <br>  <code>private</code>     <i> </i> <code>cutoff</code>  <i></i> <code>resonance</code> . <code>Mode</code>      (Lowpass, Highpass, Bandpass).  <code>feedbackAmount</code> , <code>buf0</code>  <code>buf1</code>    ,    . <br>          ( <code>calculateFeedbackAmount()</code> ).  <code>process</code>      .   <code>feedbackAmount</code>   <code>cutoff</code>  <code>resonance</code> ,    <code>calculateFeedbackAmount</code>      . <br> <br>   <i>Filter.cpp</i>  : <br> <br> <code class="cpp">// By Paul Kellett // http://www.musicdsp.org/showone.php?id=<span class="hljs-number"><span class="hljs-number">29</span></span> double Filter::process(double inputValue) { buf0 += cutoff * (inputValue - buf0); buf1 += cutoff * (buf0 - buf1); switch (mode) { case FILTER_MODE_LOWPASS: return buf1; case FILTER_MODE_HIGHPASS: return inputValue - buf0; case FILTER_MODE_BANDPASS: return buf0 - buf1; default: return <span class="hljs-number"><span class="hljs-number">0.0</span></span>; } }</code> <br> <br> , ?  ,         <i> </i> . ¬´ ¬ª   ,               (. .    <span class="hljs-number"><span class="hljs-number">6</span></span> ).     <code>buf0</code>  <code>buf1</code> :        .     <code>inputValue</code> ,  - <code>buf0</code> (  ).   .    <span class="hljs-number"><span class="hljs-number">6</span></span> /   <span class="hljs-number"><span class="hljs-number">12</span></span> /.  <code>switch</code> ,  <code>buf1</code>    . , ,    <code>buf0</code> ,       <span class="hljs-number"><span class="hljs-number">12</span></span>,   <span class="hljs-number"><span class="hljs-number">6</span></span> /,        . <br> <br>  <code>case</code> <code>FILTER_MODE_HIGHPASS</code>    . <code>buf0</code>       .   <code>inputValue</code>  <code>buf0</code> ,   .    <code>buf1</code> ,     . <br> <br>  <code>case</code> <code>FILTER_MODE_BANDPASS</code> ,  <code>buf0 - buf1</code>   .  <code>buf0</code>       ,     <code>buf1</code> . ,   . <br>  :    <i> </i>    <i> </i> ,   . <br> <br>  <code>buf1</code>     .       <a href="http://ru.wikipedia.org/wiki/%25D0%25A4%25D0%25B8%25D0%25BB%25D1%258C%25D1%2582%25D1%2580_%25D1%2581_%25D0%25B1%25D0%25B5%25D1%2581%25D0%25BA%25D0%25BE%25D0%25BD%25D0%25B5%25D1%2587%25D0%25BD%25D0%25BE%25D0%25B9_%25D0%25B8%25D0%25BC%25D0%25BF%25D1%2583%25D0%25BB%25D1%258C%25D1%2581%25D0%25BD%25D0%25BE%25D0%25B9_%25D1%2585%25D0%25B0%25D1%2580%25D0%25B0%25D0%25BA%25D1%2582%25D0%25B5%25D1%2580%25D0%25B8%25D1%2581%25D1%2582%25D0%25B8%25D0%25BA%25D0%25BE%25D0%25B9">    </a> ( <i>Infinite Impulse Response</i> ,  <i>IIR</i> ).  <a href="http://www.dspguide.com/ch14/1.htm"> </a> ,      .      ,         ,      . <br> <br>   <br>       ,     ,     .   ,  ,      ,  ,          .           ,  NI Massive,   ¬´ <a href="http://lurkmore.to/%25D0%25A2%25D1%2591%25D0%25BF%25D0%25BB%25D1%258B%25D0%25B9_%25D0%25BB%25D0%25B0%25D0%25BC%25D0%25BF%25D0%25BE%25D0%25B2%25D1%258B%25D0%25B9_%25D0%25B7%25D0%25B2%25D1%2583%25D0%25BA">  </a> ¬ª.       ,          ,   .        ,          (  Massive       ).      ¬´¬ª , , , AAS Ultra Analog,       ,     ,    ,        .         ,  ,    <a href="http://www.kvraudio.com/forum/viewtopic.php%3Ft%3D350246"></a> ,   ,      NI Reaktor. ,            ‚Äî    ,    ..     . <br> <br>   <br>     .   GUI.  <i>bg.png</i>   ( <i>‚ÄúMove to trash‚Äù</i>  Xcode),       : <br> <br> <a href="">filtermode.png</a> <a href="">knob_small.png</a> (  ,   <span class="hljs-number"><span class="hljs-number">50</span></span> <span class="hljs-number"><span class="hljs-number">50</span></span> ) <a href="">bg.png</a> (       ) <br> <br>    ID  <i>resource.h</i> : <br> <br> <code class="cpp">// Unique IDs for each image resource. #define BG_ID <span class="hljs-number"><span class="hljs-number">101</span></span> #define WHITE_KEY_ID <span class="hljs-number"><span class="hljs-number">102</span></span> #define BLACK_KEY_ID <span class="hljs-number"><span class="hljs-number">103</span></span> #define WAVEFORM_ID <span class="hljs-number"><span class="hljs-number">104</span></span> #define KNOB_ID <span class="hljs-number"><span class="hljs-number">105</span></span> #define KNOB_SMALL_ID <span class="hljs-number"><span class="hljs-number">106</span></span> #define FILTERMODE_ID <span class="hljs-number"><span class="hljs-number">107</span></span> // Image resource locations for this plug. #define BG_FN <span class="hljs-string"><span class="hljs-string">"resources/img/bg.png"</span></span> #define WHITE_KEY_FN <span class="hljs-string"><span class="hljs-string">"resources/img/whitekey.png"</span></span> #define BLACK_KEY_FN <span class="hljs-string"><span class="hljs-string">"resources/img/blackkey.png"</span></span> #define WAVEFORM_FN <span class="hljs-string"><span class="hljs-string">"resources/img/waveform.png"</span></span> #define KNOB_FN <span class="hljs-string"><span class="hljs-string">"resources/img/knob.png"</span></span> #define KNOB_SMALL_FN <span class="hljs-string"><span class="hljs-string">"resources/img/knob_small.png"</span></span> #define FILTERMODE_FN <span class="hljs-string"><span class="hljs-string">"resources/img/filtermode.png"</span></span></code> <br> <br>  <i>Synthesis.rc</i> : <br> <br> <code class="cpp">#include <span class="hljs-string"><span class="hljs-string">"resource.h"</span></span> BG_ID PNG BG_FN WHITE_KEY_ID PNG WHITE_KEY_FN BLACK_KEY_ID PNG BLACK_KEY_FN WAVEFORM_ID PNG WAVEFORM_FN KNOB_ID PNG KNOB_FN KNOB_SMALL_ID PNG KNOB_SMALL_FN FILTERMODE_ID PNG FILTERMODE_FN</code> <br> <br>   <code>#include <span class="hljs-string"><span class="hljs-string">"Filter.h"</span></span></code>  <i>Synthesis.h</i>    <code>private</code> : <br> <br> <code class="cpp">Filter mFilter;</code> <br> <br>  <code>EParams</code>  <i>Synthesis.cpp</i> : <br> <br> <code class="cpp">enum EParams { mWaveform = <span class="hljs-number"><span class="hljs-number">0</span></span>, mAttack, mDecay, mSustain, mRelease, mFilterMode, mFilterCutoff, mFilterResonance, mFilterAttack, mFilterDecay, mFilterSustain, mFilterRelease, mFilterEnvelopeAmount, kNumParams };</code> <br> <br>        : <br> <br> pGraphics-&gt;AttachControl(new ISwitchControl(this, <span class="hljs-number"><span class="hljs-number">24</span></span>, <span class="hljs-number"><span class="hljs-number">38</span></span>, mWaveform, &amp;waveformBitmap)); <br> <br>      .      (Lowpass, Highpass, Bandpass).    <code>AttachGraphics(pGraphics)</code> : <br> <br> <code class="cpp">GetParam(mFilterMode)-&gt;InitEnum(<span class="hljs-string"><span class="hljs-string">"Filter Mode"</span></span>, Filter::FILTER_MODE_LOWPASS, Filter::kNumFilterModes); IBitmap filtermodeBitmap = pGraphics-&gt;LoadIBitmap(FILTERMODE_ID, FILTERMODE_FN, <span class="hljs-number"><span class="hljs-number">3</span></span>); pGraphics-&gt;AttachControl(new ISwitchControl(this, <span class="hljs-number"><span class="hljs-number">24</span></span>, <span class="hljs-number"><span class="hljs-number">123</span></span>, mFilterMode, &amp;filtermodeBitmap));</code> <br> <br>         .    .     <i>knob_small.png</i> : <br> <br> <code class="cpp">// Knobs for filter cutoff and resonance IBitmap smallKnobBitmap = pGraphics-&gt;LoadIBitmap(KNOB_SMALL_ID, KNOB_SMALL_FN, <span class="hljs-number"><span class="hljs-number">64</span></span>); // Cutoff knob: GetParam(mFilterCutoff)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Cutoff"</span></span>, <span class="hljs-number"><span class="hljs-number">0.99</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">0.99</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); GetParam(mFilterCutoff)-&gt;SetShape(<span class="hljs-number"><span class="hljs-number">2</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-number"><span class="hljs-number">177</span></span>, mFilterCutoff, &amp;smallKnobBitmap)); // Resonance knob: GetParam(mFilterResonance)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Resonance"</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">61</span></span>, <span class="hljs-number"><span class="hljs-number">177</span></span>, mFilterResonance, &amp;smallKnobBitmap));</code> <br> <br>   ,           <code><span class="hljs-number"><span class="hljs-number">1.0</span></span></code> ,   <code>calculateFeedbackAmount</code>    , . <br>  <code>ProcessDoubleReplacing</code>     : <br> <br> <code class="cpp">leftOutput[i] = rightOutput[i] = mFilter.process(mOscillator.nextSample() * mEnvelopeGenerator.nextSample() * velocity / <span class="hljs-number"><span class="hljs-number">127.0</span></span>);</code> <br> <br>       .  <code>switch</code>   <code>Synthesis::OnParamChange</code> : <br> <br> <code class="cpp">case mFilterCutoff: mFilter.setCutoff(GetParam(paramIdx)-&gt;Value()); break; case mFilterResonance: mFilter.setResonance(GetParam(paramIdx)-&gt;Value()); break; case mFilterMode: mFilter.setFilterMode(static_cast&lt;Filter::FilterMode&gt;(GetParam(paramIdx)-&gt;Int())); break;</code> <br> <br>    .  -      . <br> <br>  <br> <br>  ‚Äî      .   ,   ,          . <br>      : <br> <br> <code class="cpp">buf0 += cutoff * (inputValue - buf0 + feedbackAmount * (buf0 - buf1));</code> <br> <br> ,   ,      ( <code>buf0 ‚Äì buf1</code> ),   <code>feedbackAmount</code> .    <code>calculateFeedbackAmount</code>  <code>feedbackAmount</code>  <code>resonance</code> , . .    ,   . <br> <br>  ,            .     ,  <i></i> ,      <a href="https://www.youtube.com/watch%3Fv%3DJWyMj6KxGHM"> </a> .    ,        ,       . <br> <br>  -<span class="hljs-number"><span class="hljs-number">12</span></span> /  -<span class="hljs-number"><span class="hljs-number">24</span></span> / <br>        !     <span class="hljs-number"><span class="hljs-number">24</span></span>   .     <code>switch</code>  <code>Filter::process</code> : <br> <br> <code class="cpp">buf2 += cutoff * (buf1 - buf2); buf3 += cutoff * (buf2 ‚Äì buf3);</code> <br> <br>   :      ,       ,            .     ,       , , <a href="https://ccrma.stanford.edu/~Jos/filters/Filter_Stability.html"></a> (       ).     <code>switch</code> : <br> <br> <code class="cpp">switch (mode) { case FILTER_MODE_LOWPASS: return buf3; case FILTER_MODE_HIGHPASS: return inputValue - buf3; case FILTER_MODE_BANDPASS: return buf0 - buf3; default: return <span class="hljs-number"><span class="hljs-number">0.0</span></span>; }</code> <br> <br>   <code>buf1</code>  <code>buf3</code> ‚Äì      .    -<span class="hljs-number"><span class="hljs-number">24</span></span> /.     <code>buf2</code>  <code>buf3</code> ,        <code>private</code> <i>Filter.h</i> : <br> <br> <code class="cpp">double buf2; double buf3;</code> <br> <br>    ,   <code>buf0</code> c <code>buf1</code> : <br> <br> <code class="cpp">Filter() : // ... buf0(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), buf1(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), buf2(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), buf3(<span class="hljs-number"><span class="hljs-number">0.0</span></span>) // ...</code> <br> <br>     , ,     :     .       . <br>          ? <br> <br>   <br>    .  ,           ,       . <br> -      <code>cutoff</code>   .      .    <code>cutoffMod</code> ,    ,       <code>cutoff</code>    .     <code><code>#include    private</code> : <br> <br> <code class="cpp">double cutoffMod;</code> <br> <br> : <br> <br> <code class="cpp">Filter() : cutoff(<span class="hljs-number"><span class="hljs-number">0.99</span></span>), resonance(<span class="hljs-number"><span class="hljs-number">0.01</span></span>), cutoffMod(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), // ...</code> <br> <br>         .   <code>private</code> : <br> <br> <code class="cpp">inline double getCalculatedCutoff() const { return fmax(fmin(cutoff + cutoffMod, <span class="hljs-number"><span class="hljs-number">0.99</span></span>), <span class="hljs-number"><span class="hljs-number">0.01</span></span>); };</code> <br> <br> <code>calculateFeedbackAmount</code>     : <br> <br> <code class="cpp">inline void calculateFeedbackAmount() { feedbackAmount = resonance + resonance/(<span class="hljs-number"><span class="hljs-number">1.0</span></span> - getCalculatedCutoff()); }</code> <br> <br>       <code>cutoffMod</code> .   <code>feedbackAmount</code>    ,     : <br> <br> <code class="cpp">inline void setCutoffMod(double newCutoffMod) { cutoffMod = newCutoffMod; calculateFeedbackAmount(); }</code> <br> <br> ,       .   <code>Filter::process</code>   : <br> <br> <code class="cpp">if (inputValue == <span class="hljs-number"><span class="hljs-number">0.0</span></span>) return inputValue; double calculatedCutoff = getCalculatedCutoff(); buf0 += calculatedCutoff * (inputValue - buf0 + feedbackAmount * (buf0 - buf1)); buf1 += calculatedCutoff * (buf0 - buf1); buf2 += calculatedCutoff * (buf1 - buf2); buf3 += calculatedCutoff * (buf2 ‚Äì buf3);</code> <br> <br>        ,    .    ,      ,   .     .     <code>cutoff</code>  <code>calculatedCutoff</code>   -. <br> <br> ,       ( <code>setCutoffMod</code> ),   <code>Synthesis</code>    ,     ,    .    ,        <code>cutoffMod</code> .    <code>filterEnvelopeAmount</code>    <code>-<span class="hljs-number"><span class="hljs-number">1</span></span></code>  <code>+<span class="hljs-number"><span class="hljs-number">1</span></span></code> .   GUI. <br> <br>   <code>private</code> <i>Synthesis.h</i>    : <br> <br> <code class="cpp">EnvelopeGenerator mFilterEnvelopeGenerator; double filterEnvelopeAmount;</code> <br> <br>       MIDI ,      <code>onNoteOn</code>  <code>onNoteOff</code> : <br> <br> <code class="cpp">inline void onNoteOn(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); mFilterEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); }; inline void onNoteOff(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); mFilterEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); };</code> <br> <br>    .   <code>ProcessDoubleReplacing</code>        : <br> <br> <code class="cpp">mFilter.setCutoffMod(mFilterEnvelopeGenerator.nextSample() * filterEnvelopeAmount);</code> <br> <br>  ,        <code>nextSample</code>  <code>filterEnvelopeAmount</code>     <code>cutoffMod</code> .     <code>filterEnvelopeAmount</code>  : <br> <br> <code class="cpp">Synthesis::Synthesis(IPlugInstanceInfo instanceInfo) : IPLUG_CTOR(kNumParams, kNumPrograms, instanceInfo), lastVirtualKeyboardNoteNumber(virtualKeyboardMinimumNoteNumber - <span class="hljs-number"><span class="hljs-number">1</span></span>), filterEnvelopeAmount(<span class="hljs-number"><span class="hljs-number">0.0</span></span>) { // ... }</code> <br> <br>       <code>Synthesis::Reset</code> : <br> <br> <code class="cpp">mFilterEnvelopeGenerator.setSampleRate(GetSampleRate());</code> <br> <br>      <code>EParams</code> ,       .  <code>AttachGraphics</code>     : <br> <br> <code class="cpp">// Knobs for filter envelope // Attack knob GetParam(mFilterAttack)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Filter Env Attack"</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">10.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); GetParam(mFilterAttack)-&gt;SetShape(<span class="hljs-number"><span class="hljs-number">3</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">139</span></span>, <span class="hljs-number"><span class="hljs-number">178</span></span>, mFilterAttack, &amp;smallKnobBitmap)); // Decay knob: GetParam(mFilterDecay)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Filter Env Decay"</span></span>, <span class="hljs-number"><span class="hljs-number">0.5</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">15.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); GetParam(mFilterDecay)-&gt;SetShape(<span class="hljs-number"><span class="hljs-number">3</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">195</span></span>, <span class="hljs-number"><span class="hljs-number">178</span></span>, mFilterDecay, &amp;smallKnobBitmap)); // Sustain knob: GetParam(mFilterSustain)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Filter Env Sustain"</span></span>, <span class="hljs-number"><span class="hljs-number">0.1</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>, <span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); GetParam(mFilterSustain)-&gt;SetShape(<span class="hljs-number"><span class="hljs-number">2</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">251</span></span>, <span class="hljs-number"><span class="hljs-number">178</span></span>, mFilterSustain, &amp;smallKnobBitmap)); // Release knob: GetParam(mFilterRelease)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Filter Env Release"</span></span>, <span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>, <span class="hljs-number"><span class="hljs-number">15.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); GetParam(mFilterRelease)-&gt;SetShape(<span class="hljs-number"><span class="hljs-number">3</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">307</span></span>, <span class="hljs-number"><span class="hljs-number">178</span></span>, mFilterRelease, &amp;smallKnobBitmap)); // Filter envelope amount knob: GetParam(mFilterEnvelopeAmount)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Filter Env Amount"</span></span>, <span class="hljs-number"><span class="hljs-number">0.0</span></span>, -<span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">363</span></span>, <span class="hljs-number"><span class="hljs-number">178</span></span>, mFilterEnvelopeAmount, &amp;smallKnobBitmap));</code> <br> <br>     ,       <code>smallKnobBitmap</code> .                   .     ,    .  <code>Synthesis::OnParamChange</code>    <code>switch</code> : <br> <br> <code class="cpp">case mFilterAttack: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK, GetParam(paramIdx)-&gt;Value()); break; case mFilterDecay: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_DECAY, GetParam(paramIdx)-&gt;Value()); break; case mFilterSustain: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_SUSTAIN, GetParam(paramIdx)-&gt;Value()); break; case mFilterRelease: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE, GetParam(paramIdx)-&gt;Value()); break; case mFilterEnvelopeAmount: filterEnvelopeAmount = GetParam(paramIdx)-&gt;Value(); break;</code> <br> <br> ! <br>     !           (-   C1),   : <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/f5d/757/3f9/f5d7573f9b3a720fe5898d88ae477cfc.png"> <br> <br>        <code>EnvelopeGenerator</code>  .         .        ! <br> <br>    <a href=""></a> . <br> <br>        :) <br> <br>  : <br> <a href="http://martin-finke.de/blog/articles/audio-plugins-013-filter/">martin-finke.de/blog/articles/audio-plugins-<span class="hljs-number"><span class="hljs-number">013</span></span>-filter</a></code></code></code> </pre> <code><code class="cpp">#include  <i>Filter.h</i> ( )     : <br> <br> class Filter { public: enum FilterMode { FILTER_MODE_LOWPASS = 0, FILTER_MODE_HIGHPASS, FILTER_MODE_BANDPASS, kNumFilterModes }; Filter() : cutoff(0.99), resonance(0.0), mode(FILTER_MODE_LOWPASS), buf0(0.0), buf1(0.0) { calculateFeedbackAmount(); }; double process(double inputValue); inline void setCutoff(double newCutoff) { cutoff = newCutoff; calculateFeedbackAmount(); }; inline void setResonance(double newResonance) { resonance = newResonance; calculateFeedbackAmount(); }; inline void setFilterMode(FilterMode newMode) { mode = newMode; } private: double cutoff; double resonance; FilterMode mode; double feedbackAmount; inline void calculateFeedbackAmount() { feedbackAmount = resonance + resonance/(1.0 - cutoff); } double buf0; double buf1; };</code> <br> <br>  <code>private</code>     <i> </i> <code>cutoff</code>  <i></i> <code>resonance</code> . <code>Mode</code>      (Lowpass, Highpass, Bandpass).  <code>feedbackAmount</code> , <code>buf0</code>  <code>buf1</code>    ,    . <br>          ( <code>calculateFeedbackAmount()</code> ).  <code>process</code>      .   <code>feedbackAmount</code>   <code>cutoff</code>  <code>resonance</code> ,    <code>calculateFeedbackAmount</code>      . <br> <br>   <i>Filter.cpp</i>  : <br> <br> <code class="cpp">// By Paul Kellett // http://www.musicdsp.org/showone.php?id=29 double Filter::process(double inputValue) { buf0 += cutoff * (inputValue - buf0); buf1 += cutoff * (buf0 - buf1); switch (mode) { case FILTER_MODE_LOWPASS: return buf1; case FILTER_MODE_HIGHPASS: return inputValue - buf0; case FILTER_MODE_BANDPASS: return buf0 - buf1; default: return 0.0; } }</code> <br> <br> , ?  ,         <i> </i> . ¬´ ¬ª   ,               (. .    6 ).     <code>buf0</code>  <code>buf1</code> :        .     <code>inputValue</code> ,  - <code>buf0</code> (  ).   .    6 /   12 /.  <code>switch</code> ,  <code>buf1</code>    . , ,    <code>buf0</code> ,       12,   6 /,        . <br> <br>  <code>case</code> <code>FILTER_MODE_HIGHPASS</code>    . <code>buf0</code>       .   <code>inputValue</code>  <code>buf0</code> ,   .    <code>buf1</code> ,     . <br> <br>  <code>case</code> <code>FILTER_MODE_BANDPASS</code> ,  <code>buf0 - buf1</code>   .  <code>buf0</code>       ,     <code>buf1</code> . ,   . <br>  :    <i> </i>    <i> </i> ,   . <br> <br>  <code>buf1</code>     .       <a href="http://ru.wikipedia.org/wiki/%25D0%25A4%25D0%25B8%25D0%25BB%25D1%258C%25D1%2582%25D1%2580_%25D1%2581_%25D0%25B1%25D0%25B5%25D1%2581%25D0%25BA%25D0%25BE%25D0%25BD%25D0%25B5%25D1%2587%25D0%25BD%25D0%25BE%25D0%25B9_%25D0%25B8%25D0%25BC%25D0%25BF%25D1%2583%25D0%25BB%25D1%258C%25D1%2581%25D0%25BD%25D0%25BE%25D0%25B9_%25D1%2585%25D0%25B0%25D1%2580%25D0%25B0%25D0%25BA%25D1%2582%25D0%25B5%25D1%2580%25D0%25B8%25D1%2581%25D1%2582%25D0%25B8%25D0%25BA%25D0%25BE%25D0%25B9">    </a> ( <i>Infinite Impulse Response</i> ,  <i>IIR</i> ).  <a href="http://www.dspguide.com/ch14/1.htm"> </a> ,      .      ,         ,      . <br> <br>   <br>       ,     ,     .   ,  ,      ,  ,          .           ,  NI Massive,   ¬´ <a href="http://lurkmore.to/%25D0%25A2%25D1%2591%25D0%25BF%25D0%25BB%25D1%258B%25D0%25B9_%25D0%25BB%25D0%25B0%25D0%25BC%25D0%25BF%25D0%25BE%25D0%25B2%25D1%258B%25D0%25B9_%25D0%25B7%25D0%25B2%25D1%2583%25D0%25BA">  </a> ¬ª.       ,          ,   .        ,          (  Massive       ).      ¬´¬ª , , , AAS Ultra Analog,       ,     ,    ,        .         ,  ,    <a href="http://www.kvraudio.com/forum/viewtopic.php%3Ft%3D350246"></a> ,   ,      NI Reaktor. ,            ‚Äî    ,    ..     . <br> <br>   <br>     .   GUI.  <i>bg.png</i>   ( <i>‚ÄúMove to trash‚Äù</i>  Xcode),       : <br> <br> <a href="">filtermode.png</a> <a href="">knob_small.png</a> (  ,   50 50 ) <a href="">bg.png</a> (       ) <br> <br>    ID  <i>resource.h</i> : <br> <br> <code class="cpp">// Unique IDs for each image resource. #define BG_ID 101 #define WHITE_KEY_ID 102 #define BLACK_KEY_ID 103 #define WAVEFORM_ID 104 #define KNOB_ID 105 #define KNOB_SMALL_ID 106 #define FILTERMODE_ID 107 // Image resource locations for this plug. #define BG_FN "resources/img/bg.png" #define WHITE_KEY_FN "resources/img/whitekey.png" #define BLACK_KEY_FN "resources/img/blackkey.png" #define WAVEFORM_FN "resources/img/waveform.png" #define KNOB_FN "resources/img/knob.png" #define KNOB_SMALL_FN "resources/img/knob_small.png" #define FILTERMODE_FN "resources/img/filtermode.png"</code> <br> <br>  <i>Synthesis.rc</i> : <br> <br> <code class="cpp">#include "resource.h" BG_ID PNG BG_FN WHITE_KEY_ID PNG WHITE_KEY_FN BLACK_KEY_ID PNG BLACK_KEY_FN WAVEFORM_ID PNG WAVEFORM_FN KNOB_ID PNG KNOB_FN KNOB_SMALL_ID PNG KNOB_SMALL_FN FILTERMODE_ID PNG FILTERMODE_FN</code> <br> <br>   <code>#include "Filter.h"</code>  <i>Synthesis.h</i>    <code>private</code> : <br> <br> <code class="cpp">Filter mFilter;</code> <br> <br>  <code>EParams</code>  <i>Synthesis.cpp</i> : <br> <br> <code class="cpp">enum EParams { mWaveform = 0, mAttack, mDecay, mSustain, mRelease, mFilterMode, mFilterCutoff, mFilterResonance, mFilterAttack, mFilterDecay, mFilterSustain, mFilterRelease, mFilterEnvelopeAmount, kNumParams };</code> <br> <br>        : <br> <br> <code class="cpp">pGraphics-&gt;AttachControl(new ISwitchControl(this, 24, 38, mWaveform, &amp;waveformBitmap));</code> <br> <br>      .      (Lowpass, Highpass, Bandpass).    <code>AttachGraphics(pGraphics)</code> : <br> <br> <code class="cpp">GetParam(mFilterMode)-&gt;InitEnum("Filter Mode", Filter::FILTER_MODE_LOWPASS, Filter::kNumFilterModes); IBitmap filtermodeBitmap = pGraphics-&gt;LoadIBitmap(FILTERMODE_ID, FILTERMODE_FN, 3); pGraphics-&gt;AttachControl(new ISwitchControl(this, 24, 123, mFilterMode, &amp;filtermodeBitmap));</code> <br> <br>         .    .     <i>knob_small.png</i> : <br> <br> <code class="cpp">// Knobs for filter cutoff and resonance IBitmap smallKnobBitmap = pGraphics-&gt;LoadIBitmap(KNOB_SMALL_ID, KNOB_SMALL_FN, 64); // Cutoff knob: GetParam(mFilterCutoff)-&gt;InitDouble("Cutoff", 0.99, 0.01, 0.99, 0.001); GetParam(mFilterCutoff)-&gt;SetShape(2); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 5, 177, mFilterCutoff, &amp;smallKnobBitmap)); // Resonance knob: GetParam(mFilterResonance)-&gt;InitDouble("Resonance", 0.01, 0.01, 1.0, 0.001); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 61, 177, mFilterResonance, &amp;smallKnobBitmap));</code> <br> <br>   ,           <code>1.0</code> ,   <code>calculateFeedbackAmount</code>    , . <br>  <code>ProcessDoubleReplacing</code>     : <br> <br> <code class="cpp">leftOutput[i] = rightOutput[i] = mFilter.process(mOscillator.nextSample() * mEnvelopeGenerator.nextSample() * velocity / 127.0);</code> <br> <br>       .  <code>switch</code>   <code>Synthesis::OnParamChange</code> : <br> <br> <code class="cpp">case mFilterCutoff: mFilter.setCutoff(GetParam(paramIdx)-&gt;Value()); break; case mFilterResonance: mFilter.setResonance(GetParam(paramIdx)-&gt;Value()); break; case mFilterMode: mFilter.setFilterMode(static_cast&lt;Filter::FilterMode&gt;(GetParam(paramIdx)-&gt;Int())); break;</code> <br> <br>    .  -      . <br> <br>  <br> <br>  ‚Äî      .   ,   ,          . <br>      : <br> <br> <code class="cpp">buf0 += cutoff * (inputValue - buf0 + feedbackAmount * (buf0 - buf1));</code> <br> <br> ,   ,      ( <code>buf0 ‚Äì buf1</code> ),   <code>feedbackAmount</code> .    <code>calculateFeedbackAmount</code>  <code>feedbackAmount</code>  <code>resonance</code> , . .    ,   . <br> <br>  ,            .     ,  <i></i> ,      <a href="https://www.youtube.com/watch%3Fv%3DJWyMj6KxGHM"> </a> .    ,        ,       . <br> <br>  -12 /  -24 / <br>        !     24   .     <code>switch</code>  <code>Filter::process</code> : <br> <br> <code class="cpp">buf2 += cutoff * (buf1 - buf2); buf3 += cutoff * (buf2 ‚Äì buf3);</code> <br> <br>   :      ,       ,            .     ,       , , <a href="https://ccrma.stanford.edu/~Jos/filters/Filter_Stability.html"></a> (       ).     <code>switch</code> : <br> <br> <code class="cpp">switch (mode) { case FILTER_MODE_LOWPASS: return buf3; case FILTER_MODE_HIGHPASS: return inputValue - buf3; case FILTER_MODE_BANDPASS: return buf0 - buf3; default: return 0.0; }</code> <br> <br>   <code>buf1</code>  <code>buf3</code> ‚Äì      .    -24 /.     <code>buf2</code>  <code>buf3</code> ,        <code>private</code> <i>Filter.h</i> : <br> <br> <code class="cpp">double buf2; double buf3;</code> <br> <br>    ,   <code>buf0</code> c <code>buf1</code> : <br> <br> <code class="cpp">Filter() : // ... buf0(0.0), buf1(0.0), buf2(0.0), buf3(0.0) // ...</code> <br> <br>     , ,     :     .       . <br>          ? <br> <br>   <br>    .  ,           ,       . <br> -      <code>cutoff</code>   .      .    <code>cutoffMod</code> ,    ,       <code>cutoff</code>    .     <code><code>#include    private</code> : <br> <br> <code class="cpp">double cutoffMod;</code> <br> <br> : <br> <br> <code class="cpp">Filter() : cutoff(0.99), resonance(0.01), cutoffMod(0.0), // ...</code> <br> <br>         .   <code>private</code> : <br> <br> <code class="cpp">inline double getCalculatedCutoff() const { return fmax(fmin(cutoff + cutoffMod, 0.99), 0.01); };</code> <br> <br> <code>calculateFeedbackAmount</code>     : <br> <br> <code class="cpp">inline void calculateFeedbackAmount() { feedbackAmount = resonance + resonance/(1.0 - getCalculatedCutoff()); }</code> <br> <br>       <code>cutoffMod</code> .   <code>feedbackAmount</code>    ,     : <br> <br> <code class="cpp">inline void setCutoffMod(double newCutoffMod) { cutoffMod = newCutoffMod; calculateFeedbackAmount(); }</code> <br> <br> ,       .   <code>Filter::process</code>   : <br> <br> <code class="cpp">if (inputValue == 0.0) return inputValue; double calculatedCutoff = getCalculatedCutoff(); buf0 += calculatedCutoff * (inputValue - buf0 + feedbackAmount * (buf0 - buf1)); buf1 += calculatedCutoff * (buf0 - buf1); buf2 += calculatedCutoff * (buf1 - buf2); buf3 += calculatedCutoff * (buf2 ‚Äì buf3);</code> <br> <br>        ,    .    ,      ,   .     .     <code>cutoff</code>  <code>calculatedCutoff</code>   -. <br> <br> ,       ( <code>setCutoffMod</code> ),   <code>Synthesis</code>    ,     ,    .    ,        <code>cutoffMod</code> .    <code>filterEnvelopeAmount</code>    <code>-1</code>  <code>+1</code> .   GUI. <br> <br>   <code>private</code> <i>Synthesis.h</i>    : <br> <br> <code class="cpp">EnvelopeGenerator mFilterEnvelopeGenerator; double filterEnvelopeAmount;</code> <br> <br>       MIDI ,      <code>onNoteOn</code>  <code>onNoteOff</code> : <br> <br> <code class="cpp">inline void onNoteOn(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); mFilterEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); }; inline void onNoteOff(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); mFilterEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); };</code> <br> <br>    .   <code>ProcessDoubleReplacing</code>        : <br> <br> <code class="cpp">mFilter.setCutoffMod(mFilterEnvelopeGenerator.nextSample() * filterEnvelopeAmount);</code> <br> <br>  ,        <code>nextSample</code>  <code>filterEnvelopeAmount</code>     <code>cutoffMod</code> .     <code>filterEnvelopeAmount</code>  : <br> <br> <code class="cpp">Synthesis::Synthesis(IPlugInstanceInfo instanceInfo) : IPLUG_CTOR(kNumParams, kNumPrograms, instanceInfo), lastVirtualKeyboardNoteNumber(virtualKeyboardMinimumNoteNumber - 1), filterEnvelopeAmount(0.0) { // ... }</code> <br> <br>       <code>Synthesis::Reset</code> : <br> <br> <code class="cpp">mFilterEnvelopeGenerator.setSampleRate(GetSampleRate());</code> <br> <br>      <code>EParams</code> ,       .  <code>AttachGraphics</code>     : <br> <br> <code class="cpp">// Knobs for filter envelope // Attack knob GetParam(mFilterAttack)-&gt;InitDouble("Filter Env Attack", 0.01, 0.01, 10.0, 0.001); GetParam(mFilterAttack)-&gt;SetShape(3); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 139, 178, mFilterAttack, &amp;smallKnobBitmap)); // Decay knob: GetParam(mFilterDecay)-&gt;InitDouble("Filter Env Decay", 0.5, 0.01, 15.0, 0.001); GetParam(mFilterDecay)-&gt;SetShape(3); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 195, 178, mFilterDecay, &amp;smallKnobBitmap)); // Sustain knob: GetParam(mFilterSustain)-&gt;InitDouble("Filter Env Sustain", 0.1, 0.001, 1.0, 0.001); GetParam(mFilterSustain)-&gt;SetShape(2); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 251, 178, mFilterSustain, &amp;smallKnobBitmap)); // Release knob: GetParam(mFilterRelease)-&gt;InitDouble("Filter Env Release", 1.0, 0.001, 15.0, 0.001); GetParam(mFilterRelease)-&gt;SetShape(3); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 307, 178, mFilterRelease, &amp;smallKnobBitmap)); // Filter envelope amount knob: GetParam(mFilterEnvelopeAmount)-&gt;InitDouble("Filter Env Amount", 0.0, -1.0, 1.0, 0.001); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 363, 178, mFilterEnvelopeAmount, &amp;smallKnobBitmap));</code> <br> <br>     ,       <code>smallKnobBitmap</code> .                   .     ,    .  <code>Synthesis::OnParamChange</code>    <code>switch</code> : <br> <br> <code class="cpp">case mFilterAttack: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK, GetParam(paramIdx)-&gt;Value()); break; case mFilterDecay: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_DECAY, GetParam(paramIdx)-&gt;Value()); break; case mFilterSustain: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_SUSTAIN, GetParam(paramIdx)-&gt;Value()); break; case mFilterRelease: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE, GetParam(paramIdx)-&gt;Value()); break; case mFilterEnvelopeAmount: filterEnvelopeAmount = GetParam(paramIdx)-&gt;Value(); break;</code> <br> <br> ! <br>     !           (-   C1),   : <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/f5d/757/3f9/f5d7573f9b3a720fe5898d88ae477cfc.png"> <br> <br>        <code>EnvelopeGenerator</code>  .         .        ! <br> <br>    <a href=""></a> . <br> <br>        :) <br> <br>  : <br> <a href="http://martin-finke.de/blog/articles/audio-plugins-013-filter/">martin-finke.de/blog/articles/audio-plugins-013-filter</a></code></code> <pre> <code class="hljs erlang-repl"><code class="cpp">#include  <i>Filter.h</i> ( )     : <br> <br> class Filter { public: enum FilterMode { FILTER_MODE_LOWPASS = <span class="hljs-number"><span class="hljs-number">0</span></span>, FILTER_MODE_HIGHPASS, FILTER_MODE_BANDPASS, kNumFilterModes }; Filter() : cutoff(<span class="hljs-number"><span class="hljs-number">0.99</span></span>), resonance(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), mode(FILTER_MODE_LOWPASS), buf0(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), buf1(<span class="hljs-number"><span class="hljs-number">0.0</span></span>) { calculateFeedbackAmount(); }; double process(double inputValue); inline void setCutoff(double newCutoff) { cutoff = newCutoff; calculateFeedbackAmount(); }; inline void setResonance(double newResonance) { resonance = newResonance; calculateFeedbackAmount(); }; inline void setFilterMode(FilterMode newMode) { mode = newMode; } private: double cutoff; double resonance; FilterMode mode; double feedbackAmount; inline void calculateFeedbackAmount() { feedbackAmount = resonance + resonance/(<span class="hljs-number"><span class="hljs-number">1.0</span></span> - cutoff); } double buf0; double buf1; };</code> <br> <br>  <code>private</code>     <i> </i> <code>cutoff</code>  <i></i> <code>resonance</code> . <code>Mode</code>      (Lowpass, Highpass, Bandpass).  <code>feedbackAmount</code> , <code>buf0</code>  <code>buf1</code>    ,    . <br>          ( <code>calculateFeedbackAmount()</code> ).  <code>process</code>      .   <code>feedbackAmount</code>   <code>cutoff</code>  <code>resonance</code> ,    <code>calculateFeedbackAmount</code>      . <br> <br>   <i>Filter.cpp</i>  : <br> <br> <code class="cpp">// By Paul Kellett // http://www.musicdsp.org/showone.php?id=<span class="hljs-number"><span class="hljs-number">29</span></span> double Filter::process(double inputValue) { buf0 += cutoff * (inputValue - buf0); buf1 += cutoff * (buf0 - buf1); switch (mode) { case FILTER_MODE_LOWPASS: return buf1; case FILTER_MODE_HIGHPASS: return inputValue - buf0; case FILTER_MODE_BANDPASS: return buf0 - buf1; default: return <span class="hljs-number"><span class="hljs-number">0.0</span></span>; } }</code> <br> <br> , ?  ,         <i> </i> . ¬´ ¬ª   ,               (. .    <span class="hljs-number"><span class="hljs-number">6</span></span> ).     <code>buf0</code>  <code>buf1</code> :        .     <code>inputValue</code> ,  - <code>buf0</code> (  ).   .    <span class="hljs-number"><span class="hljs-number">6</span></span> /   <span class="hljs-number"><span class="hljs-number">12</span></span> /.  <code>switch</code> ,  <code>buf1</code>    . , ,    <code>buf0</code> ,       <span class="hljs-number"><span class="hljs-number">12</span></span>,   <span class="hljs-number"><span class="hljs-number">6</span></span> /,        . <br> <br>  <code>case</code> <code>FILTER_MODE_HIGHPASS</code>    . <code>buf0</code>       .   <code>inputValue</code>  <code>buf0</code> ,   .    <code>buf1</code> ,     . <br> <br>  <code>case</code> <code>FILTER_MODE_BANDPASS</code> ,  <code>buf0 - buf1</code>   .  <code>buf0</code>       ,     <code>buf1</code> . ,   . <br>  :    <i> </i>    <i> </i> ,   . <br> <br>  <code>buf1</code>     .       <a href="http://ru.wikipedia.org/wiki/%25D0%25A4%25D0%25B8%25D0%25BB%25D1%258C%25D1%2582%25D1%2580_%25D1%2581_%25D0%25B1%25D0%25B5%25D1%2581%25D0%25BA%25D0%25BE%25D0%25BD%25D0%25B5%25D1%2587%25D0%25BD%25D0%25BE%25D0%25B9_%25D0%25B8%25D0%25BC%25D0%25BF%25D1%2583%25D0%25BB%25D1%258C%25D1%2581%25D0%25BD%25D0%25BE%25D0%25B9_%25D1%2585%25D0%25B0%25D1%2580%25D0%25B0%25D0%25BA%25D1%2582%25D0%25B5%25D1%2580%25D0%25B8%25D1%2581%25D1%2582%25D0%25B8%25D0%25BA%25D0%25BE%25D0%25B9">    </a> ( <i>Infinite Impulse Response</i> ,  <i>IIR</i> ).  <a href="http://www.dspguide.com/ch14/1.htm"> </a> ,      .      ,         ,      . <br> <br>   <br>       ,     ,     .   ,  ,      ,  ,          .           ,  NI Massive,   ¬´ <a href="http://lurkmore.to/%25D0%25A2%25D1%2591%25D0%25BF%25D0%25BB%25D1%258B%25D0%25B9_%25D0%25BB%25D0%25B0%25D0%25BC%25D0%25BF%25D0%25BE%25D0%25B2%25D1%258B%25D0%25B9_%25D0%25B7%25D0%25B2%25D1%2583%25D0%25BA">  </a> ¬ª.       ,          ,   .        ,          (  Massive       ).      ¬´¬ª , , , AAS Ultra Analog,       ,     ,    ,        .         ,  ,    <a href="http://www.kvraudio.com/forum/viewtopic.php%3Ft%3D350246"></a> ,   ,      NI Reaktor. ,            ‚Äî    ,    ..     . <br> <br>   <br>     .   GUI.  <i>bg.png</i>   ( <i>‚ÄúMove to trash‚Äù</i>  Xcode),       : <br> <br> <a href="">filtermode.png</a> <a href="">knob_small.png</a> (  ,   <span class="hljs-number"><span class="hljs-number">50</span></span> <span class="hljs-number"><span class="hljs-number">50</span></span> ) <a href="">bg.png</a> (       ) <br> <br>    ID  <i>resource.h</i> : <br> <br> <code class="cpp">// Unique IDs for each image resource. #define BG_ID <span class="hljs-number"><span class="hljs-number">101</span></span> #define WHITE_KEY_ID <span class="hljs-number"><span class="hljs-number">102</span></span> #define BLACK_KEY_ID <span class="hljs-number"><span class="hljs-number">103</span></span> #define WAVEFORM_ID <span class="hljs-number"><span class="hljs-number">104</span></span> #define KNOB_ID <span class="hljs-number"><span class="hljs-number">105</span></span> #define KNOB_SMALL_ID <span class="hljs-number"><span class="hljs-number">106</span></span> #define FILTERMODE_ID <span class="hljs-number"><span class="hljs-number">107</span></span> // Image resource locations for this plug. #define BG_FN <span class="hljs-string"><span class="hljs-string">"resources/img/bg.png"</span></span> #define WHITE_KEY_FN <span class="hljs-string"><span class="hljs-string">"resources/img/whitekey.png"</span></span> #define BLACK_KEY_FN <span class="hljs-string"><span class="hljs-string">"resources/img/blackkey.png"</span></span> #define WAVEFORM_FN <span class="hljs-string"><span class="hljs-string">"resources/img/waveform.png"</span></span> #define KNOB_FN <span class="hljs-string"><span class="hljs-string">"resources/img/knob.png"</span></span> #define KNOB_SMALL_FN <span class="hljs-string"><span class="hljs-string">"resources/img/knob_small.png"</span></span> #define FILTERMODE_FN <span class="hljs-string"><span class="hljs-string">"resources/img/filtermode.png"</span></span></code> <br> <br>  <i>Synthesis.rc</i> : <br> <br> <code class="cpp">#include <span class="hljs-string"><span class="hljs-string">"resource.h"</span></span> BG_ID PNG BG_FN WHITE_KEY_ID PNG WHITE_KEY_FN BLACK_KEY_ID PNG BLACK_KEY_FN WAVEFORM_ID PNG WAVEFORM_FN KNOB_ID PNG KNOB_FN KNOB_SMALL_ID PNG KNOB_SMALL_FN FILTERMODE_ID PNG FILTERMODE_FN</code> <br> <br>   <code>#include <span class="hljs-string"><span class="hljs-string">"Filter.h"</span></span></code>  <i>Synthesis.h</i>    <code>private</code> : <br> <br> <code class="cpp">Filter mFilter;</code> <br> <br>  <code>EParams</code>  <i>Synthesis.cpp</i> : <br> <br> <code class="cpp">enum EParams { mWaveform = <span class="hljs-number"><span class="hljs-number">0</span></span>, mAttack, mDecay, mSustain, mRelease, mFilterMode, mFilterCutoff, mFilterResonance, mFilterAttack, mFilterDecay, mFilterSustain, mFilterRelease, mFilterEnvelopeAmount, kNumParams };</code> <br> <br>        : <br> <br> <code class="cpp">pGraphics-&gt;AttachControl(new ISwitchControl(this, <span class="hljs-number"><span class="hljs-number">24</span></span>, <span class="hljs-number"><span class="hljs-number">38</span></span>, mWaveform, &amp;waveformBitmap));</code> <br> <br>      .      (Lowpass, Highpass, Bandpass).    <code>AttachGraphics(pGraphics)</code> : <br> <br> <code class="cpp">GetParam(mFilterMode)-&gt;InitEnum(<span class="hljs-string"><span class="hljs-string">"Filter Mode"</span></span>, Filter::FILTER_MODE_LOWPASS, Filter::kNumFilterModes); IBitmap filtermodeBitmap = pGraphics-&gt;LoadIBitmap(FILTERMODE_ID, FILTERMODE_FN, <span class="hljs-number"><span class="hljs-number">3</span></span>); pGraphics-&gt;AttachControl(new ISwitchControl(this, <span class="hljs-number"><span class="hljs-number">24</span></span>, <span class="hljs-number"><span class="hljs-number">123</span></span>, mFilterMode, &amp;filtermodeBitmap));</code> <br> <br>         .    .     <i>knob_small.png</i> : <br> <br> <code class="cpp">// Knobs for filter cutoff and resonance IBitmap smallKnobBitmap = pGraphics-&gt;LoadIBitmap(KNOB_SMALL_ID, KNOB_SMALL_FN, <span class="hljs-number"><span class="hljs-number">64</span></span>); // Cutoff knob: GetParam(mFilterCutoff)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Cutoff"</span></span>, <span class="hljs-number"><span class="hljs-number">0.99</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">0.99</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); GetParam(mFilterCutoff)-&gt;SetShape(<span class="hljs-number"><span class="hljs-number">2</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-number"><span class="hljs-number">177</span></span>, mFilterCutoff, &amp;smallKnobBitmap)); // Resonance knob: GetParam(mFilterResonance)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Resonance"</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">61</span></span>, <span class="hljs-number"><span class="hljs-number">177</span></span>, mFilterResonance, &amp;smallKnobBitmap));</code> <br> <br>   ,           <code><span class="hljs-number"><span class="hljs-number">1.0</span></span></code> ,   <code>calculateFeedbackAmount</code>    , . <br>  <code>ProcessDoubleReplacing</code>     : <br> <br> <code class="cpp">leftOutput[i] = rightOutput[i] = mFilter.process(mOscillator.nextSample() * mEnvelopeGenerator.nextSample() * velocity / <span class="hljs-number"><span class="hljs-number">127.0</span></span>);</code> <br> <br>       .  <code>switch</code>   <code>Synthesis::OnParamChange</code> : <br> <br> <code class="cpp">case mFilterCutoff: mFilter.setCutoff(GetParam(paramIdx)-&gt;Value()); break; case mFilterResonance: mFilter.setResonance(GetParam(paramIdx)-&gt;Value()); break; case mFilterMode: mFilter.setFilterMode(static_cast&lt;Filter::FilterMode&gt;(GetParam(paramIdx)-&gt;Int())); break;</code> <br> <br>    .  -      . <br> <br>  <br> <br>  ‚Äî      .   ,   ,          . <br>      : <br> <br> <code class="cpp">buf0 += cutoff * (inputValue - buf0 + feedbackAmount * (buf0 - buf1));</code> <br> <br> ,   ,      ( <code>buf0 ‚Äì buf1</code> ),   <code>feedbackAmount</code> .    <code>calculateFeedbackAmount</code>  <code>feedbackAmount</code>  <code>resonance</code> , . .    ,   . <br> <br>  ,            .     ,  <i></i> ,      <a href="https://www.youtube.com/watch%3Fv%3DJWyMj6KxGHM"> </a> .    ,        ,       . <br> <br>  -<span class="hljs-number"><span class="hljs-number">12</span></span> /  -<span class="hljs-number"><span class="hljs-number">24</span></span> / <br>        !     <span class="hljs-number"><span class="hljs-number">24</span></span>   .     <code>switch</code>  <code>Filter::process</code> : <br> <br> <code class="cpp">buf2 += cutoff * (buf1 - buf2); buf3 += cutoff * (buf2 ‚Äì buf3);</code> <br> <br>   :      ,       ,            .     ,       , , <a href="https://ccrma.stanford.edu/~Jos/filters/Filter_Stability.html"></a> (       ).     <code>switch</code> : <br> <br> <code class="cpp">switch (mode) { case FILTER_MODE_LOWPASS: return buf3; case FILTER_MODE_HIGHPASS: return inputValue - buf3; case FILTER_MODE_BANDPASS: return buf0 - buf3; default: return <span class="hljs-number"><span class="hljs-number">0.0</span></span>; }</code> <br> <br>   <code>buf1</code>  <code>buf3</code> ‚Äì      .    -<span class="hljs-number"><span class="hljs-number">24</span></span> /.     <code>buf2</code>  <code>buf3</code> ,        <code>private</code> <i>Filter.h</i> : <br> <br> <code class="cpp">double buf2; double buf3;</code> <br> <br>    ,   <code>buf0</code> c <code>buf1</code> : <br> <br> <code class="cpp">Filter() : // ... buf0(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), buf1(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), buf2(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), buf3(<span class="hljs-number"><span class="hljs-number">0.0</span></span>) // ...</code> <br> <br>     , ,     :     .       . <br>          ? <br> <br>   <br>    .  ,           ,       . <br> -      <code>cutoff</code>   .      .    <code>cutoffMod</code> ,    ,       <code>cutoff</code>    .     <code><code>#include    private</code> : <br> <br> <code class="cpp">double cutoffMod;</code> <br> <br> : <br> <br> <code class="cpp">Filter() : cutoff(<span class="hljs-number"><span class="hljs-number">0.99</span></span>), resonance(<span class="hljs-number"><span class="hljs-number">0.01</span></span>), cutoffMod(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), // ...</code> <br> <br>         .   <code>private</code> : <br> <br> <code class="cpp">inline double getCalculatedCutoff() const { return fmax(fmin(cutoff + cutoffMod, <span class="hljs-number"><span class="hljs-number">0.99</span></span>), <span class="hljs-number"><span class="hljs-number">0.01</span></span>); };</code> <br> <br> <code>calculateFeedbackAmount</code>     : <br> <br> <code class="cpp">inline void calculateFeedbackAmount() { feedbackAmount = resonance + resonance/(<span class="hljs-number"><span class="hljs-number">1.0</span></span> - getCalculatedCutoff()); }</code> <br> <br>       <code>cutoffMod</code> .   <code>feedbackAmount</code>    ,     : <br> <br> <code class="cpp">inline void setCutoffMod(double newCutoffMod) { cutoffMod = newCutoffMod; calculateFeedbackAmount(); }</code> <br> <br> ,       .   <code>Filter::process</code>   : <br> <br> <code class="cpp">if (inputValue == <span class="hljs-number"><span class="hljs-number">0.0</span></span>) return inputValue; double calculatedCutoff = getCalculatedCutoff(); buf0 += calculatedCutoff * (inputValue - buf0 + feedbackAmount * (buf0 - buf1)); buf1 += calculatedCutoff * (buf0 - buf1); buf2 += calculatedCutoff * (buf1 - buf2); buf3 += calculatedCutoff * (buf2 ‚Äì buf3);</code> <br> <br>        ,    .    ,      ,   .     .     <code>cutoff</code>  <code>calculatedCutoff</code>   -. <br> <br> ,       ( <code>setCutoffMod</code> ),   <code>Synthesis</code>    ,     ,    .    ,        <code>cutoffMod</code> .    <code>filterEnvelopeAmount</code>    <code>-<span class="hljs-number"><span class="hljs-number">1</span></span></code>  <code>+<span class="hljs-number"><span class="hljs-number">1</span></span></code> .   GUI. <br> <br>   <code>private</code> <i>Synthesis.h</i>    : <br> <br> <code class="cpp">EnvelopeGenerator mFilterEnvelopeGenerator; double filterEnvelopeAmount;</code> <br> <br>       MIDI ,      <code>onNoteOn</code>  <code>onNoteOff</code> : <br> <br> <code class="cpp">inline void onNoteOn(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); mFilterEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); }; inline void onNoteOff(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); mFilterEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); };</code> <br> <br>    .   <code>ProcessDoubleReplacing</code>        : <br> <br> <code class="cpp">mFilter.setCutoffMod(mFilterEnvelopeGenerator.nextSample() * filterEnvelopeAmount);</code> <br> <br>  ,        <code>nextSample</code>  <code>filterEnvelopeAmount</code>     <code>cutoffMod</code> .     <code>filterEnvelopeAmount</code>  : <br> <br> <code class="cpp">Synthesis::Synthesis(IPlugInstanceInfo instanceInfo) : IPLUG_CTOR(kNumParams, kNumPrograms, instanceInfo), lastVirtualKeyboardNoteNumber(virtualKeyboardMinimumNoteNumber - <span class="hljs-number"><span class="hljs-number">1</span></span>), filterEnvelopeAmount(<span class="hljs-number"><span class="hljs-number">0.0</span></span>) { // ... }</code> <br> <br>       <code>Synthesis::Reset</code> : <br> <br> <code class="cpp">mFilterEnvelopeGenerator.setSampleRate(GetSampleRate());</code> <br> <br>      <code>EParams</code> ,       .  <code>AttachGraphics</code>     : <br> <br> <code class="cpp">// Knobs for filter envelope // Attack knob GetParam(mFilterAttack)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Filter Env Attack"</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">10.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); GetParam(mFilterAttack)-&gt;SetShape(<span class="hljs-number"><span class="hljs-number">3</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">139</span></span>, <span class="hljs-number"><span class="hljs-number">178</span></span>, mFilterAttack, &amp;smallKnobBitmap)); // Decay knob: GetParam(mFilterDecay)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Filter Env Decay"</span></span>, <span class="hljs-number"><span class="hljs-number">0.5</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">15.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); GetParam(mFilterDecay)-&gt;SetShape(<span class="hljs-number"><span class="hljs-number">3</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">195</span></span>, <span class="hljs-number"><span class="hljs-number">178</span></span>, mFilterDecay, &amp;smallKnobBitmap)); // Sustain knob: GetParam(mFilterSustain)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Filter Env Sustain"</span></span>, <span class="hljs-number"><span class="hljs-number">0.1</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>, <span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); GetParam(mFilterSustain)-&gt;SetShape(<span class="hljs-number"><span class="hljs-number">2</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">251</span></span>, <span class="hljs-number"><span class="hljs-number">178</span></span>, mFilterSustain, &amp;smallKnobBitmap)); // Release knob: GetParam(mFilterRelease)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Filter Env Release"</span></span>, <span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>, <span class="hljs-number"><span class="hljs-number">15.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); GetParam(mFilterRelease)-&gt;SetShape(<span class="hljs-number"><span class="hljs-number">3</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">307</span></span>, <span class="hljs-number"><span class="hljs-number">178</span></span>, mFilterRelease, &amp;smallKnobBitmap)); // Filter envelope amount knob: GetParam(mFilterEnvelopeAmount)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Filter Env Amount"</span></span>, <span class="hljs-number"><span class="hljs-number">0.0</span></span>, -<span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">363</span></span>, <span class="hljs-number"><span class="hljs-number">178</span></span>, mFilterEnvelopeAmount, &amp;smallKnobBitmap));</code> <br> <br>     ,       <code>smallKnobBitmap</code> .                   .     ,    .  <code>Synthesis::OnParamChange</code>    <code>switch</code> : <br> <br> <code class="cpp">case mFilterAttack: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK, GetParam(paramIdx)-&gt;Value()); break; case mFilterDecay: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_DECAY, GetParam(paramIdx)-&gt;Value()); break; case mFilterSustain: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_SUSTAIN, GetParam(paramIdx)-&gt;Value()); break; case mFilterRelease: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE, GetParam(paramIdx)-&gt;Value()); break; case mFilterEnvelopeAmount: filterEnvelopeAmount = GetParam(paramIdx)-&gt;Value(); break;</code> <br> <br> ! <br>     !           (-   C1),   : <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/f5d/757/3f9/f5d7573f9b3a720fe5898d88ae477cfc.png"> <br> <br>        <code>EnvelopeGenerator</code>  .         .        ! <br> <br>    <a href=""></a> . <br> <br>        :) <br> <br>  : <br> <a href="http://martin-finke.de/blog/articles/audio-plugins-013-filter/">martin-finke.de/blog/articles/audio-plugins-<span class="hljs-number"><span class="hljs-number">013</span></span>-filter</a></code></code> </pre> <code><code class="cpp">#include  <i>Filter.h</i> ( )     : <br> <br> class Filter { public: enum FilterMode { FILTER_MODE_LOWPASS = 0, FILTER_MODE_HIGHPASS, FILTER_MODE_BANDPASS, kNumFilterModes }; Filter() : cutoff(0.99), resonance(0.0), mode(FILTER_MODE_LOWPASS), buf0(0.0), buf1(0.0) { calculateFeedbackAmount(); }; double process(double inputValue); inline void setCutoff(double newCutoff) { cutoff = newCutoff; calculateFeedbackAmount(); }; inline void setResonance(double newResonance) { resonance = newResonance; calculateFeedbackAmount(); }; inline void setFilterMode(FilterMode newMode) { mode = newMode; } private: double cutoff; double resonance; FilterMode mode; double feedbackAmount; inline void calculateFeedbackAmount() { feedbackAmount = resonance + resonance/(1.0 - cutoff); } double buf0; double buf1; };</code> <br> <br>  <code>private</code>     <i> </i> <code>cutoff</code>  <i></i> <code>resonance</code> . <code>Mode</code>      (Lowpass, Highpass, Bandpass).  <code>feedbackAmount</code> , <code>buf0</code>  <code>buf1</code>    ,    . <br>          ( <code>calculateFeedbackAmount()</code> ).  <code>process</code>      .   <code>feedbackAmount</code>   <code>cutoff</code>  <code>resonance</code> ,    <code>calculateFeedbackAmount</code>      . <br> <br>   <i>Filter.cpp</i>  : <br> <br> <code class="cpp">// By Paul Kellett // http://www.musicdsp.org/showone.php?id=29 double Filter::process(double inputValue) { buf0 += cutoff * (inputValue - buf0); buf1 += cutoff * (buf0 - buf1); switch (mode) { case FILTER_MODE_LOWPASS: return buf1; case FILTER_MODE_HIGHPASS: return inputValue - buf0; case FILTER_MODE_BANDPASS: return buf0 - buf1; default: return 0.0; } }</code> <br> <br> , ?  ,         <i> </i> . ¬´ ¬ª   ,               (. .    6 ).     <code>buf0</code>  <code>buf1</code> :        .     <code>inputValue</code> ,  - <code>buf0</code> (  ).   .    6 /   12 /.  <code>switch</code> ,  <code>buf1</code>    . , ,    <code>buf0</code> ,       12,   6 /,        . <br> <br>  <code>case</code> <code>FILTER_MODE_HIGHPASS</code>    . <code>buf0</code>       .   <code>inputValue</code>  <code>buf0</code> ,   .    <code>buf1</code> ,     . <br> <br>  <code>case</code> <code>FILTER_MODE_BANDPASS</code> ,  <code>buf0 - buf1</code>   .  <code>buf0</code>       ,     <code>buf1</code> . ,   . <br>  :    <i> </i>    <i> </i> ,   . <br> <br>  <code>buf1</code>     .       <a href="http://ru.wikipedia.org/wiki/%25D0%25A4%25D0%25B8%25D0%25BB%25D1%258C%25D1%2582%25D1%2580_%25D1%2581_%25D0%25B1%25D0%25B5%25D1%2581%25D0%25BA%25D0%25BE%25D0%25BD%25D0%25B5%25D1%2587%25D0%25BD%25D0%25BE%25D0%25B9_%25D0%25B8%25D0%25BC%25D0%25BF%25D1%2583%25D0%25BB%25D1%258C%25D1%2581%25D0%25BD%25D0%25BE%25D0%25B9_%25D1%2585%25D0%25B0%25D1%2580%25D0%25B0%25D0%25BA%25D1%2582%25D0%25B5%25D1%2580%25D0%25B8%25D1%2581%25D1%2582%25D0%25B8%25D0%25BA%25D0%25BE%25D0%25B9">    </a> ( <i>Infinite Impulse Response</i> ,  <i>IIR</i> ).  <a href="http://www.dspguide.com/ch14/1.htm"> </a> ,      .      ,         ,      . <br> <br>   <br>       ,     ,     .   ,  ,      ,  ,          .           ,  NI Massive,   ¬´ <a href="http://lurkmore.to/%25D0%25A2%25D1%2591%25D0%25BF%25D0%25BB%25D1%258B%25D0%25B9_%25D0%25BB%25D0%25B0%25D0%25BC%25D0%25BF%25D0%25BE%25D0%25B2%25D1%258B%25D0%25B9_%25D0%25B7%25D0%25B2%25D1%2583%25D0%25BA">  </a> ¬ª.       ,          ,   .        ,          (  Massive       ).      ¬´¬ª , , , AAS Ultra Analog,       ,     ,    ,        .         ,  ,    <a href="http://www.kvraudio.com/forum/viewtopic.php%3Ft%3D350246"></a> ,   ,      NI Reaktor. ,            ‚Äî    ,    ..     . <br> <br>   <br>     .   GUI.  <i>bg.png</i>   ( <i>‚ÄúMove to trash‚Äù</i>  Xcode),       : <br> <br> <a href="">filtermode.png</a> <a href="">knob_small.png</a> (  ,   50 50 ) <a href="">bg.png</a> (       ) <br> <br>    ID  <i>resource.h</i> : <br> <br> <code class="cpp">// Unique IDs for each image resource. #define BG_ID 101 #define WHITE_KEY_ID 102 #define BLACK_KEY_ID 103 #define WAVEFORM_ID 104 #define KNOB_ID 105 #define KNOB_SMALL_ID 106 #define FILTERMODE_ID 107 // Image resource locations for this plug. #define BG_FN "resources/img/bg.png" #define WHITE_KEY_FN "resources/img/whitekey.png" #define BLACK_KEY_FN "resources/img/blackkey.png" #define WAVEFORM_FN "resources/img/waveform.png" #define KNOB_FN "resources/img/knob.png" #define KNOB_SMALL_FN "resources/img/knob_small.png" #define FILTERMODE_FN "resources/img/filtermode.png"</code> <br> <br>  <i>Synthesis.rc</i> : <br> <br> <code class="cpp">#include "resource.h" BG_ID PNG BG_FN WHITE_KEY_ID PNG WHITE_KEY_FN BLACK_KEY_ID PNG BLACK_KEY_FN WAVEFORM_ID PNG WAVEFORM_FN KNOB_ID PNG KNOB_FN KNOB_SMALL_ID PNG KNOB_SMALL_FN FILTERMODE_ID PNG FILTERMODE_FN</code> <br> <br>   <code>#include "Filter.h"</code>  <i>Synthesis.h</i>    <code>private</code> : <br> <br> <code class="cpp">Filter mFilter;</code> <br> <br>  <code>EParams</code>  <i>Synthesis.cpp</i> : <br> <br> <code class="cpp">enum EParams { mWaveform = 0, mAttack, mDecay, mSustain, mRelease, mFilterMode, mFilterCutoff, mFilterResonance, mFilterAttack, mFilterDecay, mFilterSustain, mFilterRelease, mFilterEnvelopeAmount, kNumParams };</code> <br> <br>        : <br> <br> <code class="cpp">pGraphics-&gt;AttachControl(new ISwitchControl(this, 24, 38, mWaveform, &amp;waveformBitmap));</code> <br> <br>      .      (Lowpass, Highpass, Bandpass).    <code>AttachGraphics(pGraphics)</code> : <br> <br> <code class="cpp">GetParam(mFilterMode)-&gt;InitEnum("Filter Mode", Filter::FILTER_MODE_LOWPASS, Filter::kNumFilterModes); IBitmap filtermodeBitmap = pGraphics-&gt;LoadIBitmap(FILTERMODE_ID, FILTERMODE_FN, 3); pGraphics-&gt;AttachControl(new ISwitchControl(this, 24, 123, mFilterMode, &amp;filtermodeBitmap));</code> <br> <br>         .    .     <i>knob_small.png</i> : <br> <br> <code class="cpp">// Knobs for filter cutoff and resonance IBitmap smallKnobBitmap = pGraphics-&gt;LoadIBitmap(KNOB_SMALL_ID, KNOB_SMALL_FN, 64); // Cutoff knob: GetParam(mFilterCutoff)-&gt;InitDouble("Cutoff", 0.99, 0.01, 0.99, 0.001); GetParam(mFilterCutoff)-&gt;SetShape(2); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 5, 177, mFilterCutoff, &amp;smallKnobBitmap)); // Resonance knob: GetParam(mFilterResonance)-&gt;InitDouble("Resonance", 0.01, 0.01, 1.0, 0.001); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 61, 177, mFilterResonance, &amp;smallKnobBitmap));</code> <br> <br>   ,           <code>1.0</code> ,   <code>calculateFeedbackAmount</code>    , . <br>  <code>ProcessDoubleReplacing</code>     : <br> <br> <code class="cpp">leftOutput[i] = rightOutput[i] = mFilter.process(mOscillator.nextSample() * mEnvelopeGenerator.nextSample() * velocity / 127.0);</code> <br> <br>       .  <code>switch</code>   <code>Synthesis::OnParamChange</code> : <br> <br> <code class="cpp">case mFilterCutoff: mFilter.setCutoff(GetParam(paramIdx)-&gt;Value()); break; case mFilterResonance: mFilter.setResonance(GetParam(paramIdx)-&gt;Value()); break; case mFilterMode: mFilter.setFilterMode(static_cast&lt;Filter::FilterMode&gt;(GetParam(paramIdx)-&gt;Int())); break;</code> <br> <br>    .  -      . <br> <br>  <br> <br>  ‚Äî      .   ,   ,          . <br>      : <br> <br> <code class="cpp">buf0 += cutoff * (inputValue - buf0 + feedbackAmount * (buf0 - buf1));</code> <br> <br> ,   ,      ( <code>buf0 ‚Äì buf1</code> ),   <code>feedbackAmount</code> .    <code>calculateFeedbackAmount</code>  <code>feedbackAmount</code>  <code>resonance</code> , . .    ,   . <br> <br>  ,            .     ,  <i></i> ,      <a href="https://www.youtube.com/watch%3Fv%3DJWyMj6KxGHM"> </a> .    ,        ,       . <br> <br>  -12 /  -24 / <br>        !     24   .     <code>switch</code>  <code>Filter::process</code> : <br> <br> <code class="cpp">buf2 += cutoff * (buf1 - buf2); buf3 += cutoff * (buf2 ‚Äì buf3);</code> <br> <br>   :      ,       ,            .     ,       , , <a href="https://ccrma.stanford.edu/~Jos/filters/Filter_Stability.html"></a> (       ).     <code>switch</code> : <br> <br> <code class="cpp">switch (mode) { case FILTER_MODE_LOWPASS: return buf3; case FILTER_MODE_HIGHPASS: return inputValue - buf3; case FILTER_MODE_BANDPASS: return buf0 - buf3; default: return 0.0; }</code> <br> <br>   <code>buf1</code>  <code>buf3</code> ‚Äì      .    -24 /.     <code>buf2</code>  <code>buf3</code> ,        <code>private</code> <i>Filter.h</i> : <br> <br> <code class="cpp">double buf2; double buf3;</code> <br> <br>    ,   <code>buf0</code> c <code>buf1</code> : <br> <br> <code class="cpp">Filter() : // ... buf0(0.0), buf1(0.0), buf2(0.0), buf3(0.0) // ...</code> <br> <br>     , ,     :     .       . <br>          ? <br> <br>   <br>    .  ,           ,       . <br> -      <code>cutoff</code>   .      .    <code>cutoffMod</code> ,    ,       <code>cutoff</code>    .     <code><code>#include    private</code> : <br> <br> <code class="cpp">double cutoffMod;</code> <br> <br> : <br> <br> <code class="cpp">Filter() : cutoff(0.99), resonance(0.01), cutoffMod(0.0), // ...</code> <br> <br>         .   <code>private</code> : <br> <br> <code class="cpp">inline double getCalculatedCutoff() const { return fmax(fmin(cutoff + cutoffMod, 0.99), 0.01); };</code> <br> <br> <code>calculateFeedbackAmount</code>     : <br> <br> <code class="cpp">inline void calculateFeedbackAmount() { feedbackAmount = resonance + resonance/(1.0 - getCalculatedCutoff()); }</code> <br> <br>       <code>cutoffMod</code> .   <code>feedbackAmount</code>    ,     : <br> <br> <code class="cpp">inline void setCutoffMod(double newCutoffMod) { cutoffMod = newCutoffMod; calculateFeedbackAmount(); }</code> <br> <br> ,       .   <code>Filter::process</code>   : <br> <br> <code class="cpp">if (inputValue == 0.0) return inputValue; double calculatedCutoff = getCalculatedCutoff(); buf0 += calculatedCutoff * (inputValue - buf0 + feedbackAmount * (buf0 - buf1)); buf1 += calculatedCutoff * (buf0 - buf1); buf2 += calculatedCutoff * (buf1 - buf2); buf3 += calculatedCutoff * (buf2 ‚Äì buf3);</code> <br> <br>        ,    .    ,      ,   .     .     <code>cutoff</code>  <code>calculatedCutoff</code>   -. <br> <br> ,       ( <code>setCutoffMod</code> ),   <code>Synthesis</code>    ,     ,    .    ,        <code>cutoffMod</code> .    <code>filterEnvelopeAmount</code>    <code>-1</code>  <code>+1</code> .   GUI. <br> <br>   <code>private</code> <i>Synthesis.h</i>    : <br> <br> <code class="cpp">EnvelopeGenerator mFilterEnvelopeGenerator; double filterEnvelopeAmount;</code> <br> <br>       MIDI ,      <code>onNoteOn</code>  <code>onNoteOff</code> : <br> <br> <code class="cpp">inline void onNoteOn(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); mFilterEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); }; inline void onNoteOff(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); mFilterEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); };</code> <br> <br>    .   <code>ProcessDoubleReplacing</code>        : <br> <br> <code class="cpp">mFilter.setCutoffMod(mFilterEnvelopeGenerator.nextSample() * filterEnvelopeAmount);</code> <br> <br>  ,        <code>nextSample</code>  <code>filterEnvelopeAmount</code>     <code>cutoffMod</code> .     <code>filterEnvelopeAmount</code>  : <br> <br> <code class="cpp">Synthesis::Synthesis(IPlugInstanceInfo instanceInfo) : IPLUG_CTOR(kNumParams, kNumPrograms, instanceInfo), lastVirtualKeyboardNoteNumber(virtualKeyboardMinimumNoteNumber - 1), filterEnvelopeAmount(0.0) { // ... }</code> <br> <br>       <code>Synthesis::Reset</code> : <br> <br> <code class="cpp">mFilterEnvelopeGenerator.setSampleRate(GetSampleRate());</code> <br> <br>      <code>EParams</code> ,       .  <code>AttachGraphics</code>     : <br> <br> <code class="cpp">// Knobs for filter envelope // Attack knob GetParam(mFilterAttack)-&gt;InitDouble("Filter Env Attack", 0.01, 0.01, 10.0, 0.001); GetParam(mFilterAttack)-&gt;SetShape(3); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 139, 178, mFilterAttack, &amp;smallKnobBitmap)); // Decay knob: GetParam(mFilterDecay)-&gt;InitDouble("Filter Env Decay", 0.5, 0.01, 15.0, 0.001); GetParam(mFilterDecay)-&gt;SetShape(3); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 195, 178, mFilterDecay, &amp;smallKnobBitmap)); // Sustain knob: GetParam(mFilterSustain)-&gt;InitDouble("Filter Env Sustain", 0.1, 0.001, 1.0, 0.001); GetParam(mFilterSustain)-&gt;SetShape(2); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 251, 178, mFilterSustain, &amp;smallKnobBitmap)); // Release knob: GetParam(mFilterRelease)-&gt;InitDouble("Filter Env Release", 1.0, 0.001, 15.0, 0.001); GetParam(mFilterRelease)-&gt;SetShape(3); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 307, 178, mFilterRelease, &amp;smallKnobBitmap)); // Filter envelope amount knob: GetParam(mFilterEnvelopeAmount)-&gt;InitDouble("Filter Env Amount", 0.0, -1.0, 1.0, 0.001); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 363, 178, mFilterEnvelopeAmount, &amp;smallKnobBitmap));</code> <br> <br>     ,       <code>smallKnobBitmap</code> .                   .     ,    .  <code>Synthesis::OnParamChange</code>    <code>switch</code> : <br> <br> <code class="cpp">case mFilterAttack: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK, GetParam(paramIdx)-&gt;Value()); break; case mFilterDecay: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_DECAY, GetParam(paramIdx)-&gt;Value()); break; case mFilterSustain: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_SUSTAIN, GetParam(paramIdx)-&gt;Value()); break; case mFilterRelease: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE, GetParam(paramIdx)-&gt;Value()); break; case mFilterEnvelopeAmount: filterEnvelopeAmount = GetParam(paramIdx)-&gt;Value(); break;</code> <br> <br> ! <br>     !           (-   C1),   : <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/f5d/757/3f9/f5d7573f9b3a720fe5898d88ae477cfc.png"> <br> <br>        <code>EnvelopeGenerator</code>  .         .        ! <br> <br>    <a href=""></a> . <br> <br>        :) <br> <br>  : <br> <a href="http://martin-finke.de/blog/articles/audio-plugins-013-filter/">martin-finke.de/blog/articles/audio-plugins-013-filter</a></code></code> <pre> <code class="hljs erlang-repl"><code class="cpp">#include  <i>Filter.h</i> ( )     : <br> <br> class Filter { public: enum FilterMode { FILTER_MODE_LOWPASS = <span class="hljs-number"><span class="hljs-number">0</span></span>, FILTER_MODE_HIGHPASS, FILTER_MODE_BANDPASS, kNumFilterModes }; Filter() : cutoff(<span class="hljs-number"><span class="hljs-number">0.99</span></span>), resonance(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), mode(FILTER_MODE_LOWPASS), buf0(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), buf1(<span class="hljs-number"><span class="hljs-number">0.0</span></span>) { calculateFeedbackAmount(); }; double process(double inputValue); inline void setCutoff(double newCutoff) { cutoff = newCutoff; calculateFeedbackAmount(); }; inline void setResonance(double newResonance) { resonance = newResonance; calculateFeedbackAmount(); }; inline void setFilterMode(FilterMode newMode) { mode = newMode; } private: double cutoff; double resonance; FilterMode mode; double feedbackAmount; inline void calculateFeedbackAmount() { feedbackAmount = resonance + resonance/(<span class="hljs-number"><span class="hljs-number">1.0</span></span> - cutoff); } double buf0; double buf1; };</code> <br> <br>  <code>private</code>     <i> </i> <code>cutoff</code>  <i></i> <code>resonance</code> . <code>Mode</code>      (Lowpass, Highpass, Bandpass).  <code>feedbackAmount</code> , <code>buf0</code>  <code>buf1</code>    ,    . <br>          ( <code>calculateFeedbackAmount()</code> ).  <code>process</code>      .   <code>feedbackAmount</code>   <code>cutoff</code>  <code>resonance</code> ,    <code>calculateFeedbackAmount</code>      . <br> <br>   <i>Filter.cpp</i>  : <br> <br> <code class="cpp">// By Paul Kellett // http://www.musicdsp.org/showone.php?id=<span class="hljs-number"><span class="hljs-number">29</span></span> double Filter::process(double inputValue) { buf0 += cutoff * (inputValue - buf0); buf1 += cutoff * (buf0 - buf1); switch (mode) { case FILTER_MODE_LOWPASS: return buf1; case FILTER_MODE_HIGHPASS: return inputValue - buf0; case FILTER_MODE_BANDPASS: return buf0 - buf1; default: return <span class="hljs-number"><span class="hljs-number">0.0</span></span>; } }</code> <br> <br> , ?  ,         <i> </i> . ¬´ ¬ª   ,               (. .    <span class="hljs-number"><span class="hljs-number">6</span></span> ).     <code>buf0</code>  <code>buf1</code> :        .     <code>inputValue</code> ,  - <code>buf0</code> (  ).   .    <span class="hljs-number"><span class="hljs-number">6</span></span> /   <span class="hljs-number"><span class="hljs-number">12</span></span> /.  <code>switch</code> ,  <code>buf1</code>    . , ,    <code>buf0</code> ,       <span class="hljs-number"><span class="hljs-number">12</span></span>,   <span class="hljs-number"><span class="hljs-number">6</span></span> /,        . <br> <br>  <code>case</code> <code>FILTER_MODE_HIGHPASS</code>    . <code>buf0</code>       .   <code>inputValue</code>  <code>buf0</code> ,   .    <code>buf1</code> ,     . <br> <br>  <code>case</code> <code>FILTER_MODE_BANDPASS</code> ,  <code>buf0 - buf1</code>   .  <code>buf0</code>       ,     <code>buf1</code> . ,   . <br>  :    <i> </i>    <i> </i> ,   . <br> <br>  <code>buf1</code>     .       <a href="http://ru.wikipedia.org/wiki/%25D0%25A4%25D0%25B8%25D0%25BB%25D1%258C%25D1%2582%25D1%2580_%25D1%2581_%25D0%25B1%25D0%25B5%25D1%2581%25D0%25BA%25D0%25BE%25D0%25BD%25D0%25B5%25D1%2587%25D0%25BD%25D0%25BE%25D0%25B9_%25D0%25B8%25D0%25BC%25D0%25BF%25D1%2583%25D0%25BB%25D1%258C%25D1%2581%25D0%25BD%25D0%25BE%25D0%25B9_%25D1%2585%25D0%25B0%25D1%2580%25D0%25B0%25D0%25BA%25D1%2582%25D0%25B5%25D1%2580%25D0%25B8%25D1%2581%25D1%2582%25D0%25B8%25D0%25BA%25D0%25BE%25D0%25B9">    </a> ( <i>Infinite Impulse Response</i> ,  <i>IIR</i> ).  <a href="http://www.dspguide.com/ch14/1.htm"> </a> ,      .      ,         ,      . <br> <br>   <br>       ,     ,     .   ,  ,      ,  ,          .           ,  NI Massive,   ¬´ <a href="http://lurkmore.to/%25D0%25A2%25D1%2591%25D0%25BF%25D0%25BB%25D1%258B%25D0%25B9_%25D0%25BB%25D0%25B0%25D0%25BC%25D0%25BF%25D0%25BE%25D0%25B2%25D1%258B%25D0%25B9_%25D0%25B7%25D0%25B2%25D1%2583%25D0%25BA">  </a> ¬ª.       ,          ,   .        ,          (  Massive       ).      ¬´¬ª , , , AAS Ultra Analog,       ,     ,    ,        .         ,  ,    <a href="http://www.kvraudio.com/forum/viewtopic.php%3Ft%3D350246"></a> ,   ,      NI Reaktor. ,            ‚Äî    ,    ..     . <br> <br>   <br>     .   GUI.  <i>bg.png</i>   ( <i>‚ÄúMove to trash‚Äù</i>  Xcode),       : <br> <br> <a href="">filtermode.png</a> <a href="">knob_small.png</a> (  ,   <span class="hljs-number"><span class="hljs-number">50</span></span> <span class="hljs-number"><span class="hljs-number">50</span></span> ) <a href="">bg.png</a> (       ) <br> <br>    ID  <i>resource.h</i> : <br> <br> <code class="cpp">// Unique IDs for each image resource. #define BG_ID <span class="hljs-number"><span class="hljs-number">101</span></span> #define WHITE_KEY_ID <span class="hljs-number"><span class="hljs-number">102</span></span> #define BLACK_KEY_ID <span class="hljs-number"><span class="hljs-number">103</span></span> #define WAVEFORM_ID <span class="hljs-number"><span class="hljs-number">104</span></span> #define KNOB_ID <span class="hljs-number"><span class="hljs-number">105</span></span> #define KNOB_SMALL_ID <span class="hljs-number"><span class="hljs-number">106</span></span> #define FILTERMODE_ID <span class="hljs-number"><span class="hljs-number">107</span></span> // Image resource locations for this plug. #define BG_FN <span class="hljs-string"><span class="hljs-string">"resources/img/bg.png"</span></span> #define WHITE_KEY_FN <span class="hljs-string"><span class="hljs-string">"resources/img/whitekey.png"</span></span> #define BLACK_KEY_FN <span class="hljs-string"><span class="hljs-string">"resources/img/blackkey.png"</span></span> #define WAVEFORM_FN <span class="hljs-string"><span class="hljs-string">"resources/img/waveform.png"</span></span> #define KNOB_FN <span class="hljs-string"><span class="hljs-string">"resources/img/knob.png"</span></span> #define KNOB_SMALL_FN <span class="hljs-string"><span class="hljs-string">"resources/img/knob_small.png"</span></span> #define FILTERMODE_FN <span class="hljs-string"><span class="hljs-string">"resources/img/filtermode.png"</span></span></code> <br> <br>  <i>Synthesis.rc</i> : <br> <br> <code class="cpp">#include <span class="hljs-string"><span class="hljs-string">"resource.h"</span></span> BG_ID PNG BG_FN WHITE_KEY_ID PNG WHITE_KEY_FN BLACK_KEY_ID PNG BLACK_KEY_FN WAVEFORM_ID PNG WAVEFORM_FN KNOB_ID PNG KNOB_FN KNOB_SMALL_ID PNG KNOB_SMALL_FN FILTERMODE_ID PNG FILTERMODE_FN</code> <br> <br>   <code>#include <span class="hljs-string"><span class="hljs-string">"Filter.h"</span></span></code>  <i>Synthesis.h</i>    <code>private</code> : <br> <br> <code class="cpp">Filter mFilter;</code> <br> <br>  <code>EParams</code>  <i>Synthesis.cpp</i> : <br> <br> <code class="cpp">enum EParams { mWaveform = <span class="hljs-number"><span class="hljs-number">0</span></span>, mAttack, mDecay, mSustain, mRelease, mFilterMode, mFilterCutoff, mFilterResonance, mFilterAttack, mFilterDecay, mFilterSustain, mFilterRelease, mFilterEnvelopeAmount, kNumParams };</code> <br> <br>        : <br> <br> <code class="cpp">pGraphics-&gt;AttachControl(new ISwitchControl(this, <span class="hljs-number"><span class="hljs-number">24</span></span>, <span class="hljs-number"><span class="hljs-number">38</span></span>, mWaveform, &amp;waveformBitmap));</code> <br> <br>      .      (Lowpass, Highpass, Bandpass).    <code>AttachGraphics(pGraphics)</code> : <br> <br> <code class="cpp">GetParam(mFilterMode)-&gt;InitEnum(<span class="hljs-string"><span class="hljs-string">"Filter Mode"</span></span>, Filter::FILTER_MODE_LOWPASS, Filter::kNumFilterModes); IBitmap filtermodeBitmap = pGraphics-&gt;LoadIBitmap(FILTERMODE_ID, FILTERMODE_FN, <span class="hljs-number"><span class="hljs-number">3</span></span>); pGraphics-&gt;AttachControl(new ISwitchControl(this, <span class="hljs-number"><span class="hljs-number">24</span></span>, <span class="hljs-number"><span class="hljs-number">123</span></span>, mFilterMode, &amp;filtermodeBitmap));</code> <br> <br>         .    .     <i>knob_small.png</i> : <br> <br> <code class="cpp">// Knobs for filter cutoff and resonance IBitmap smallKnobBitmap = pGraphics-&gt;LoadIBitmap(KNOB_SMALL_ID, KNOB_SMALL_FN, <span class="hljs-number"><span class="hljs-number">64</span></span>); // Cutoff knob: GetParam(mFilterCutoff)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Cutoff"</span></span>, <span class="hljs-number"><span class="hljs-number">0.99</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">0.99</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); GetParam(mFilterCutoff)-&gt;SetShape(<span class="hljs-number"><span class="hljs-number">2</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-number"><span class="hljs-number">177</span></span>, mFilterCutoff, &amp;smallKnobBitmap)); // Resonance knob: GetParam(mFilterResonance)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Resonance"</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">61</span></span>, <span class="hljs-number"><span class="hljs-number">177</span></span>, mFilterResonance, &amp;smallKnobBitmap));</code> <br> <br>   ,           <code><span class="hljs-number"><span class="hljs-number">1.0</span></span></code> ,   <code>calculateFeedbackAmount</code>    , . <br>  <code>ProcessDoubleReplacing</code>     : <br> <br> <code class="cpp">leftOutput[i] = rightOutput[i] = mFilter.process(mOscillator.nextSample() * mEnvelopeGenerator.nextSample() * velocity / <span class="hljs-number"><span class="hljs-number">127.0</span></span>);</code> <br> <br>       .  <code>switch</code>   <code>Synthesis::OnParamChange</code> : <br> <br> <code class="cpp">case mFilterCutoff: mFilter.setCutoff(GetParam(paramIdx)-&gt;Value()); break; case mFilterResonance: mFilter.setResonance(GetParam(paramIdx)-&gt;Value()); break; case mFilterMode: mFilter.setFilterMode(static_cast&lt;Filter::FilterMode&gt;(GetParam(paramIdx)-&gt;Int())); break;</code> <br> <br>    .  -      . <br> <br>  <br> <br>  ‚Äî      .   ,   ,          . <br>      : <br> <br> <code class="cpp">buf0 += cutoff * (inputValue - buf0 + feedbackAmount * (buf0 - buf1));</code> <br> <br> ,   ,      ( <code>buf0 ‚Äì buf1</code> ),   <code>feedbackAmount</code> .    <code>calculateFeedbackAmount</code>  <code>feedbackAmount</code>  <code>resonance</code> , . .    ,   . <br> <br>  ,            .     ,  <i></i> ,      <a href="https://www.youtube.com/watch%3Fv%3DJWyMj6KxGHM"> </a> .    ,        ,       . <br> <br>  -<span class="hljs-number"><span class="hljs-number">12</span></span> /  -<span class="hljs-number"><span class="hljs-number">24</span></span> / <br>        !     <span class="hljs-number"><span class="hljs-number">24</span></span>   .     <code>switch</code>  <code>Filter::process</code> : <br> <br> <code class="cpp">buf2 += cutoff * (buf1 - buf2); buf3 += cutoff * (buf2 ‚Äì buf3);</code> <br> <br>   :      ,       ,            .     ,       , , <a href="https://ccrma.stanford.edu/~Jos/filters/Filter_Stability.html"></a> (       ).     <code>switch</code> : <br> <br> <code class="cpp">switch (mode) { case FILTER_MODE_LOWPASS: return buf3; case FILTER_MODE_HIGHPASS: return inputValue - buf3; case FILTER_MODE_BANDPASS: return buf0 - buf3; default: return <span class="hljs-number"><span class="hljs-number">0.0</span></span>; }</code> <br> <br>   <code>buf1</code>  <code>buf3</code> ‚Äì      .    -<span class="hljs-number"><span class="hljs-number">24</span></span> /.     <code>buf2</code>  <code>buf3</code> ,        <code>private</code> <i>Filter.h</i> : <br> <br> <code class="cpp">double buf2; double buf3;</code> <br> <br>    ,   <code>buf0</code> c <code>buf1</code> : <br> <br> <code class="cpp">Filter() : // ... buf0(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), buf1(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), buf2(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), buf3(<span class="hljs-number"><span class="hljs-number">0.0</span></span>) // ...</code> <br> <br>     , ,     :     .       . <br>          ? <br> <br>   <br>    .  ,           ,       . <br> -      <code>cutoff</code>   .      .    <code>cutoffMod</code> ,    ,       <code>cutoff</code>    .     <code><code>#include    private</code> : <br> <br> <code class="cpp">double cutoffMod;</code> <br> <br> : <br> <br> <code class="cpp">Filter() : cutoff(<span class="hljs-number"><span class="hljs-number">0.99</span></span>), resonance(<span class="hljs-number"><span class="hljs-number">0.01</span></span>), cutoffMod(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), // ...</code> <br> <br>         .   <code>private</code> : <br> <br> <code class="cpp">inline double getCalculatedCutoff() const { return fmax(fmin(cutoff + cutoffMod, <span class="hljs-number"><span class="hljs-number">0.99</span></span>), <span class="hljs-number"><span class="hljs-number">0.01</span></span>); };</code> <br> <br> <code>calculateFeedbackAmount</code>     : <br> <br> <code class="cpp">inline void calculateFeedbackAmount() { feedbackAmount = resonance + resonance/(<span class="hljs-number"><span class="hljs-number">1.0</span></span> - getCalculatedCutoff()); }</code> <br> <br>       <code>cutoffMod</code> .   <code>feedbackAmount</code>    ,     : <br> <br> <code class="cpp">inline void setCutoffMod(double newCutoffMod) { cutoffMod = newCutoffMod; calculateFeedbackAmount(); }</code> <br> <br> ,       .   <code>Filter::process</code>   : <br> <br> <code class="cpp">if (inputValue == <span class="hljs-number"><span class="hljs-number">0.0</span></span>) return inputValue; double calculatedCutoff = getCalculatedCutoff(); buf0 += calculatedCutoff * (inputValue - buf0 + feedbackAmount * (buf0 - buf1)); buf1 += calculatedCutoff * (buf0 - buf1); buf2 += calculatedCutoff * (buf1 - buf2); buf3 += calculatedCutoff * (buf2 ‚Äì buf3);</code> <br> <br>        ,    .    ,      ,   .     .     <code>cutoff</code>  <code>calculatedCutoff</code>   -. <br> <br> ,       ( <code>setCutoffMod</code> ),   <code>Synthesis</code>    ,     ,    .    ,        <code>cutoffMod</code> .    <code>filterEnvelopeAmount</code>    <code>-<span class="hljs-number"><span class="hljs-number">1</span></span></code>  <code>+<span class="hljs-number"><span class="hljs-number">1</span></span></code> .   GUI. <br> <br>   <code>private</code> <i>Synthesis.h</i>    : <br> <br> <code class="cpp">EnvelopeGenerator mFilterEnvelopeGenerator; double filterEnvelopeAmount;</code> <br> <br>       MIDI ,      <code>onNoteOn</code>  <code>onNoteOff</code> : <br> <br> <code class="cpp">inline void onNoteOn(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); mFilterEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); }; inline void onNoteOff(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); mFilterEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); };</code> <br> <br>    .   <code>ProcessDoubleReplacing</code>        : <br> <br> <code class="cpp">mFilter.setCutoffMod(mFilterEnvelopeGenerator.nextSample() * filterEnvelopeAmount);</code> <br> <br>  ,        <code>nextSample</code>  <code>filterEnvelopeAmount</code>     <code>cutoffMod</code> .     <code>filterEnvelopeAmount</code>  : <br> <br> <code class="cpp">Synthesis::Synthesis(IPlugInstanceInfo instanceInfo) : IPLUG_CTOR(kNumParams, kNumPrograms, instanceInfo), lastVirtualKeyboardNoteNumber(virtualKeyboardMinimumNoteNumber - <span class="hljs-number"><span class="hljs-number">1</span></span>), filterEnvelopeAmount(<span class="hljs-number"><span class="hljs-number">0.0</span></span>) { // ... }</code> <br> <br>       <code>Synthesis::Reset</code> : <br> <br> <code class="cpp">mFilterEnvelopeGenerator.setSampleRate(GetSampleRate());</code> <br> <br>      <code>EParams</code> ,       .  <code>AttachGraphics</code>     : <br> <br> <code class="cpp">// Knobs for filter envelope // Attack knob GetParam(mFilterAttack)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Filter Env Attack"</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">10.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); GetParam(mFilterAttack)-&gt;SetShape(<span class="hljs-number"><span class="hljs-number">3</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">139</span></span>, <span class="hljs-number"><span class="hljs-number">178</span></span>, mFilterAttack, &amp;smallKnobBitmap)); // Decay knob: GetParam(mFilterDecay)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Filter Env Decay"</span></span>, <span class="hljs-number"><span class="hljs-number">0.5</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">15.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); GetParam(mFilterDecay)-&gt;SetShape(<span class="hljs-number"><span class="hljs-number">3</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">195</span></span>, <span class="hljs-number"><span class="hljs-number">178</span></span>, mFilterDecay, &amp;smallKnobBitmap)); // Sustain knob: GetParam(mFilterSustain)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Filter Env Sustain"</span></span>, <span class="hljs-number"><span class="hljs-number">0.1</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>, <span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); GetParam(mFilterSustain)-&gt;SetShape(<span class="hljs-number"><span class="hljs-number">2</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">251</span></span>, <span class="hljs-number"><span class="hljs-number">178</span></span>, mFilterSustain, &amp;smallKnobBitmap)); // Release knob: GetParam(mFilterRelease)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Filter Env Release"</span></span>, <span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>, <span class="hljs-number"><span class="hljs-number">15.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); GetParam(mFilterRelease)-&gt;SetShape(<span class="hljs-number"><span class="hljs-number">3</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">307</span></span>, <span class="hljs-number"><span class="hljs-number">178</span></span>, mFilterRelease, &amp;smallKnobBitmap)); // Filter envelope amount knob: GetParam(mFilterEnvelopeAmount)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Filter Env Amount"</span></span>, <span class="hljs-number"><span class="hljs-number">0.0</span></span>, -<span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">363</span></span>, <span class="hljs-number"><span class="hljs-number">178</span></span>, mFilterEnvelopeAmount, &amp;smallKnobBitmap));</code> <br> <br>     ,       <code>smallKnobBitmap</code> .                   .     ,    .  <code>Synthesis::OnParamChange</code>    <code>switch</code> : <br> <br> <code class="cpp">case mFilterAttack: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK, GetParam(paramIdx)-&gt;Value()); break; case mFilterDecay: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_DECAY, GetParam(paramIdx)-&gt;Value()); break; case mFilterSustain: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_SUSTAIN, GetParam(paramIdx)-&gt;Value()); break; case mFilterRelease: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE, GetParam(paramIdx)-&gt;Value()); break; case mFilterEnvelopeAmount: filterEnvelopeAmount = GetParam(paramIdx)-&gt;Value(); break;</code> <br> <br> ! <br>     !           (-   C1),   : <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/f5d/757/3f9/f5d7573f9b3a720fe5898d88ae477cfc.png"> <br> <br>        <code>EnvelopeGenerator</code>  .         .        ! <br> <br>    <a href=""></a> . <br> <br>        :) <br> <br>  : <br> <a href="http://martin-finke.de/blog/articles/audio-plugins-013-filter/">martin-finke.de/blog/articles/audio-plugins-<span class="hljs-number"><span class="hljs-number">013</span></span>-filter</a></code></code> </pre> <code><code class="cpp">#include  <i>Filter.h</i> ( )     : <br> <br> class Filter { public: enum FilterMode { FILTER_MODE_LOWPASS = 0, FILTER_MODE_HIGHPASS, FILTER_MODE_BANDPASS, kNumFilterModes }; Filter() : cutoff(0.99), resonance(0.0), mode(FILTER_MODE_LOWPASS), buf0(0.0), buf1(0.0) { calculateFeedbackAmount(); }; double process(double inputValue); inline void setCutoff(double newCutoff) { cutoff = newCutoff; calculateFeedbackAmount(); }; inline void setResonance(double newResonance) { resonance = newResonance; calculateFeedbackAmount(); }; inline void setFilterMode(FilterMode newMode) { mode = newMode; } private: double cutoff; double resonance; FilterMode mode; double feedbackAmount; inline void calculateFeedbackAmount() { feedbackAmount = resonance + resonance/(1.0 - cutoff); } double buf0; double buf1; };</code> <br> <br>  <code>private</code>     <i> </i> <code>cutoff</code>  <i></i> <code>resonance</code> . <code>Mode</code>      (Lowpass, Highpass, Bandpass).  <code>feedbackAmount</code> , <code>buf0</code>  <code>buf1</code>    ,    . <br>          ( <code>calculateFeedbackAmount()</code> ).  <code>process</code>      .   <code>feedbackAmount</code>   <code>cutoff</code>  <code>resonance</code> ,    <code>calculateFeedbackAmount</code>      . <br> <br>   <i>Filter.cpp</i>  : <br> <br> <code class="cpp">// By Paul Kellett // http://www.musicdsp.org/showone.php?id=29 double Filter::process(double inputValue) { buf0 += cutoff * (inputValue - buf0); buf1 += cutoff * (buf0 - buf1); switch (mode) { case FILTER_MODE_LOWPASS: return buf1; case FILTER_MODE_HIGHPASS: return inputValue - buf0; case FILTER_MODE_BANDPASS: return buf0 - buf1; default: return 0.0; } }</code> <br> <br> , ?  ,         <i> </i> . ¬´ ¬ª   ,               (. .    6 ).     <code>buf0</code>  <code>buf1</code> :        .     <code>inputValue</code> ,  - <code>buf0</code> (  ).   .    6 /   12 /.  <code>switch</code> ,  <code>buf1</code>    . , ,    <code>buf0</code> ,       12,   6 /,        . <br> <br>  <code>case</code> <code>FILTER_MODE_HIGHPASS</code>    . <code>buf0</code>       .   <code>inputValue</code>  <code>buf0</code> ,   .    <code>buf1</code> ,     . <br> <br>  <code>case</code> <code>FILTER_MODE_BANDPASS</code> ,  <code>buf0 - buf1</code>   .  <code>buf0</code>       ,     <code>buf1</code> . ,   . <br>  :    <i> </i>    <i> </i> ,   . <br> <br>  <code>buf1</code>     .       <a href="http://ru.wikipedia.org/wiki/%25D0%25A4%25D0%25B8%25D0%25BB%25D1%258C%25D1%2582%25D1%2580_%25D1%2581_%25D0%25B1%25D0%25B5%25D1%2581%25D0%25BA%25D0%25BE%25D0%25BD%25D0%25B5%25D1%2587%25D0%25BD%25D0%25BE%25D0%25B9_%25D0%25B8%25D0%25BC%25D0%25BF%25D1%2583%25D0%25BB%25D1%258C%25D1%2581%25D0%25BD%25D0%25BE%25D0%25B9_%25D1%2585%25D0%25B0%25D1%2580%25D0%25B0%25D0%25BA%25D1%2582%25D0%25B5%25D1%2580%25D0%25B8%25D1%2581%25D1%2582%25D0%25B8%25D0%25BA%25D0%25BE%25D0%25B9">    </a> ( <i>Infinite Impulse Response</i> ,  <i>IIR</i> ).  <a href="http://www.dspguide.com/ch14/1.htm"> </a> ,      .      ,         ,      . <br> <br>   <br>       ,     ,     .   ,  ,      ,  ,          .           ,  NI Massive,   ¬´ <a href="http://lurkmore.to/%25D0%25A2%25D1%2591%25D0%25BF%25D0%25BB%25D1%258B%25D0%25B9_%25D0%25BB%25D0%25B0%25D0%25BC%25D0%25BF%25D0%25BE%25D0%25B2%25D1%258B%25D0%25B9_%25D0%25B7%25D0%25B2%25D1%2583%25D0%25BA">  </a> ¬ª.       ,          ,   .        ,          (  Massive       ).      ¬´¬ª , , , AAS Ultra Analog,       ,     ,    ,        .         ,  ,    <a href="http://www.kvraudio.com/forum/viewtopic.php%3Ft%3D350246"></a> ,   ,      NI Reaktor. ,            ‚Äî    ,    ..     . <br> <br>   <br>     .   GUI.  <i>bg.png</i>   ( <i>‚ÄúMove to trash‚Äù</i>  Xcode),       : <br> <br> <a href="">filtermode.png</a> <a href="">knob_small.png</a> (  ,   50 50 ) <a href="">bg.png</a> (       ) <br> <br>    ID  <i>resource.h</i> : <br> <br> <code class="cpp">// Unique IDs for each image resource. #define BG_ID 101 #define WHITE_KEY_ID 102 #define BLACK_KEY_ID 103 #define WAVEFORM_ID 104 #define KNOB_ID 105 #define KNOB_SMALL_ID 106 #define FILTERMODE_ID 107 // Image resource locations for this plug. #define BG_FN "resources/img/bg.png" #define WHITE_KEY_FN "resources/img/whitekey.png" #define BLACK_KEY_FN "resources/img/blackkey.png" #define WAVEFORM_FN "resources/img/waveform.png" #define KNOB_FN "resources/img/knob.png" #define KNOB_SMALL_FN "resources/img/knob_small.png" #define FILTERMODE_FN "resources/img/filtermode.png"</code> <br> <br>  <i>Synthesis.rc</i> : <br> <br> <code class="cpp">#include "resource.h" BG_ID PNG BG_FN WHITE_KEY_ID PNG WHITE_KEY_FN BLACK_KEY_ID PNG BLACK_KEY_FN WAVEFORM_ID PNG WAVEFORM_FN KNOB_ID PNG KNOB_FN KNOB_SMALL_ID PNG KNOB_SMALL_FN FILTERMODE_ID PNG FILTERMODE_FN</code> <br> <br>   <code>#include "Filter.h"</code>  <i>Synthesis.h</i>    <code>private</code> : <br> <br> <code class="cpp">Filter mFilter;</code> <br> <br>  <code>EParams</code>  <i>Synthesis.cpp</i> : <br> <br> <code class="cpp">enum EParams { mWaveform = 0, mAttack, mDecay, mSustain, mRelease, mFilterMode, mFilterCutoff, mFilterResonance, mFilterAttack, mFilterDecay, mFilterSustain, mFilterRelease, mFilterEnvelopeAmount, kNumParams };</code> <br> <br>        : <br> <br> <code class="cpp">pGraphics-&gt;AttachControl(new ISwitchControl(this, 24, 38, mWaveform, &amp;waveformBitmap));</code> <br> <br>      .      (Lowpass, Highpass, Bandpass).    <code>AttachGraphics(pGraphics)</code> : <br> <br> <code class="cpp">GetParam(mFilterMode)-&gt;InitEnum("Filter Mode", Filter::FILTER_MODE_LOWPASS, Filter::kNumFilterModes); IBitmap filtermodeBitmap = pGraphics-&gt;LoadIBitmap(FILTERMODE_ID, FILTERMODE_FN, 3); pGraphics-&gt;AttachControl(new ISwitchControl(this, 24, 123, mFilterMode, &amp;filtermodeBitmap));</code> <br> <br>         .    .     <i>knob_small.png</i> : <br> <br> <code class="cpp">// Knobs for filter cutoff and resonance IBitmap smallKnobBitmap = pGraphics-&gt;LoadIBitmap(KNOB_SMALL_ID, KNOB_SMALL_FN, 64); // Cutoff knob: GetParam(mFilterCutoff)-&gt;InitDouble("Cutoff", 0.99, 0.01, 0.99, 0.001); GetParam(mFilterCutoff)-&gt;SetShape(2); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 5, 177, mFilterCutoff, &amp;smallKnobBitmap)); // Resonance knob: GetParam(mFilterResonance)-&gt;InitDouble("Resonance", 0.01, 0.01, 1.0, 0.001); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 61, 177, mFilterResonance, &amp;smallKnobBitmap));</code> <br> <br>   ,           <code>1.0</code> ,   <code>calculateFeedbackAmount</code>    , . <br>  <code>ProcessDoubleReplacing</code>     : <br> <br> <code class="cpp">leftOutput[i] = rightOutput[i] = mFilter.process(mOscillator.nextSample() * mEnvelopeGenerator.nextSample() * velocity / 127.0);</code> <br> <br>       .  <code>switch</code>   <code>Synthesis::OnParamChange</code> : <br> <br> <code class="cpp">case mFilterCutoff: mFilter.setCutoff(GetParam(paramIdx)-&gt;Value()); break; case mFilterResonance: mFilter.setResonance(GetParam(paramIdx)-&gt;Value()); break; case mFilterMode: mFilter.setFilterMode(static_cast&lt;Filter::FilterMode&gt;(GetParam(paramIdx)-&gt;Int())); break;</code> <br> <br>    .  -      . <br> <br>  <br> <br>  ‚Äî      .   ,   ,          . <br>      : <br> <br> <code class="cpp">buf0 += cutoff * (inputValue - buf0 + feedbackAmount * (buf0 - buf1));</code> <br> <br> ,   ,      ( <code>buf0 ‚Äì buf1</code> ),   <code>feedbackAmount</code> .    <code>calculateFeedbackAmount</code>  <code>feedbackAmount</code>  <code>resonance</code> , . .    ,   . <br> <br>  ,            .     ,  <i></i> ,      <a href="https://www.youtube.com/watch%3Fv%3DJWyMj6KxGHM"> </a> .    ,        ,       . <br> <br>  -12 /  -24 / <br>        !     24   .     <code>switch</code>  <code>Filter::process</code> : <br> <br> <code class="cpp">buf2 += cutoff * (buf1 - buf2); buf3 += cutoff * (buf2 ‚Äì buf3);</code> <br> <br>   :      ,       ,            .     ,       , , <a href="https://ccrma.stanford.edu/~Jos/filters/Filter_Stability.html"></a> (       ).     <code>switch</code> : <br> <br> <code class="cpp">switch (mode) { case FILTER_MODE_LOWPASS: return buf3; case FILTER_MODE_HIGHPASS: return inputValue - buf3; case FILTER_MODE_BANDPASS: return buf0 - buf3; default: return 0.0; }</code> <br> <br>   <code>buf1</code>  <code>buf3</code> ‚Äì      .    -24 /.     <code>buf2</code>  <code>buf3</code> ,        <code>private</code> <i>Filter.h</i> : <br> <br> <code class="cpp">double buf2; double buf3;</code> <br> <br>    ,   <code>buf0</code> c <code>buf1</code> : <br> <br> <code class="cpp">Filter() : // ... buf0(0.0), buf1(0.0), buf2(0.0), buf3(0.0) // ...</code> <br> <br>     , ,     :     .       . <br>          ? <br> <br>   <br>    .  ,           ,       . <br> -      <code>cutoff</code>   .      .    <code>cutoffMod</code> ,    ,       <code>cutoff</code>    .     <code><code>#include    private</code> : <br> <br> <code class="cpp">double cutoffMod;</code> <br> <br> : <br> <br> <code class="cpp">Filter() : cutoff(0.99), resonance(0.01), cutoffMod(0.0), // ...</code> <br> <br>         .   <code>private</code> : <br> <br> <code class="cpp">inline double getCalculatedCutoff() const { return fmax(fmin(cutoff + cutoffMod, 0.99), 0.01); };</code> <br> <br> <code>calculateFeedbackAmount</code>     : <br> <br> <code class="cpp">inline void calculateFeedbackAmount() { feedbackAmount = resonance + resonance/(1.0 - getCalculatedCutoff()); }</code> <br> <br>       <code>cutoffMod</code> .   <code>feedbackAmount</code>    ,     : <br> <br> <code class="cpp">inline void setCutoffMod(double newCutoffMod) { cutoffMod = newCutoffMod; calculateFeedbackAmount(); }</code> <br> <br> ,       .   <code>Filter::process</code>   : <br> <br> <code class="cpp">if (inputValue == 0.0) return inputValue; double calculatedCutoff = getCalculatedCutoff(); buf0 += calculatedCutoff * (inputValue - buf0 + feedbackAmount * (buf0 - buf1)); buf1 += calculatedCutoff * (buf0 - buf1); buf2 += calculatedCutoff * (buf1 - buf2); buf3 += calculatedCutoff * (buf2 ‚Äì buf3);</code> <br> <br>        ,    .    ,      ,   .     .     <code>cutoff</code>  <code>calculatedCutoff</code>   -. <br> <br> ,       ( <code>setCutoffMod</code> ),   <code>Synthesis</code>    ,     ,    .    ,        <code>cutoffMod</code> .    <code>filterEnvelopeAmount</code>    <code>-1</code>  <code>+1</code> .   GUI. <br> <br>   <code>private</code> <i>Synthesis.h</i>    : <br> <br> <code class="cpp">EnvelopeGenerator mFilterEnvelopeGenerator; double filterEnvelopeAmount;</code> <br> <br>       MIDI ,      <code>onNoteOn</code>  <code>onNoteOff</code> : <br> <br> <code class="cpp">inline void onNoteOn(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); mFilterEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); }; inline void onNoteOff(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); mFilterEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); };</code> <br> <br>    .   <code>ProcessDoubleReplacing</code>        : <br> <br> <code class="cpp">mFilter.setCutoffMod(mFilterEnvelopeGenerator.nextSample() * filterEnvelopeAmount);</code> <br> <br>  ,        <code>nextSample</code>  <code>filterEnvelopeAmount</code>     <code>cutoffMod</code> .     <code>filterEnvelopeAmount</code>  : <br> <br> <code class="cpp">Synthesis::Synthesis(IPlugInstanceInfo instanceInfo) : IPLUG_CTOR(kNumParams, kNumPrograms, instanceInfo), lastVirtualKeyboardNoteNumber(virtualKeyboardMinimumNoteNumber - 1), filterEnvelopeAmount(0.0) { // ... }</code> <br> <br>       <code>Synthesis::Reset</code> : <br> <br> <code class="cpp">mFilterEnvelopeGenerator.setSampleRate(GetSampleRate());</code> <br> <br>      <code>EParams</code> ,       .  <code>AttachGraphics</code>     : <br> <br> <code class="cpp">// Knobs for filter envelope // Attack knob GetParam(mFilterAttack)-&gt;InitDouble("Filter Env Attack", 0.01, 0.01, 10.0, 0.001); GetParam(mFilterAttack)-&gt;SetShape(3); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 139, 178, mFilterAttack, &amp;smallKnobBitmap)); // Decay knob: GetParam(mFilterDecay)-&gt;InitDouble("Filter Env Decay", 0.5, 0.01, 15.0, 0.001); GetParam(mFilterDecay)-&gt;SetShape(3); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 195, 178, mFilterDecay, &amp;smallKnobBitmap)); // Sustain knob: GetParam(mFilterSustain)-&gt;InitDouble("Filter Env Sustain", 0.1, 0.001, 1.0, 0.001); GetParam(mFilterSustain)-&gt;SetShape(2); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 251, 178, mFilterSustain, &amp;smallKnobBitmap)); // Release knob: GetParam(mFilterRelease)-&gt;InitDouble("Filter Env Release", 1.0, 0.001, 15.0, 0.001); GetParam(mFilterRelease)-&gt;SetShape(3); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 307, 178, mFilterRelease, &amp;smallKnobBitmap)); // Filter envelope amount knob: GetParam(mFilterEnvelopeAmount)-&gt;InitDouble("Filter Env Amount", 0.0, -1.0, 1.0, 0.001); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 363, 178, mFilterEnvelopeAmount, &amp;smallKnobBitmap));</code> <br> <br>     ,       <code>smallKnobBitmap</code> .                   .     ,    .  <code>Synthesis::OnParamChange</code>    <code>switch</code> : <br> <br> <code class="cpp">case mFilterAttack: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK, GetParam(paramIdx)-&gt;Value()); break; case mFilterDecay: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_DECAY, GetParam(paramIdx)-&gt;Value()); break; case mFilterSustain: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_SUSTAIN, GetParam(paramIdx)-&gt;Value()); break; case mFilterRelease: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE, GetParam(paramIdx)-&gt;Value()); break; case mFilterEnvelopeAmount: filterEnvelopeAmount = GetParam(paramIdx)-&gt;Value(); break;</code> <br> <br> ! <br>     !           (-   C1),   : <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/f5d/757/3f9/f5d7573f9b3a720fe5898d88ae477cfc.png"> <br> <br>        <code>EnvelopeGenerator</code>  .         .        ! <br> <br>    <a href=""></a> . <br> <br>        :) <br> <br>  : <br> <a href="http://martin-finke.de/blog/articles/audio-plugins-013-filter/">martin-finke.de/blog/articles/audio-plugins-013-filter</a></code></code> <pre> <code class="hljs erlang-repl"><code class="cpp"><code class="cpp">#include  <i>Filter.h</i> ( )     : <br> <br> class Filter { public: enum FilterMode { FILTER_MODE_LOWPASS = <span class="hljs-number"><span class="hljs-number">0</span></span>, FILTER_MODE_HIGHPASS, FILTER_MODE_BANDPASS, kNumFilterModes }; Filter() : cutoff(<span class="hljs-number"><span class="hljs-number">0.99</span></span>), resonance(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), mode(FILTER_MODE_LOWPASS), buf0(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), buf1(<span class="hljs-number"><span class="hljs-number">0.0</span></span>) { calculateFeedbackAmount(); }; double process(double inputValue); inline void setCutoff(double newCutoff) { cutoff = newCutoff; calculateFeedbackAmount(); }; inline void setResonance(double newResonance) { resonance = newResonance; calculateFeedbackAmount(); }; inline void setFilterMode(FilterMode newMode) { mode = newMode; } private: double cutoff; double resonance; FilterMode mode; double feedbackAmount; inline void calculateFeedbackAmount() { feedbackAmount = resonance + resonance/(<span class="hljs-number"><span class="hljs-number">1.0</span></span> - cutoff); } double buf0; double buf1; };</code> <br> <br>  <code>private</code>     <i> </i> <code>cutoff</code>  <i></i> <code>resonance</code> . <code>Mode</code>      (Lowpass, Highpass, Bandpass).  <code>feedbackAmount</code> , <code>buf0</code>  <code>buf1</code>    ,    . <br>          ( <code>calculateFeedbackAmount()</code> ).  <code>process</code>      .   <code>feedbackAmount</code>   <code>cutoff</code>  <code>resonance</code> ,    <code>calculateFeedbackAmount</code>      . <br> <br>   <i>Filter.cpp</i>  : <br> <br> <code class="cpp">// By Paul Kellett // http://www.musicdsp.org/showone.php?id=<span class="hljs-number"><span class="hljs-number">29</span></span> double Filter::process(double inputValue) { buf0 += cutoff * (inputValue - buf0); buf1 += cutoff * (buf0 - buf1); switch (mode) { case FILTER_MODE_LOWPASS: return buf1; case FILTER_MODE_HIGHPASS: return inputValue - buf0; case FILTER_MODE_BANDPASS: return buf0 - buf1; default: return <span class="hljs-number"><span class="hljs-number">0.0</span></span>; } }</code> <br> <br> , ?  ,         <i> </i> . ¬´ ¬ª   ,               (. .    <span class="hljs-number"><span class="hljs-number">6</span></span> ).     <code>buf0</code>  <code>buf1</code> :        .     <code>inputValue</code> ,  - <code>buf0</code> (  ).   .    <span class="hljs-number"><span class="hljs-number">6</span></span> /   <span class="hljs-number"><span class="hljs-number">12</span></span> /.  <code>switch</code> ,  <code>buf1</code>    . , ,    <code>buf0</code> ,       <span class="hljs-number"><span class="hljs-number">12</span></span>,   <span class="hljs-number"><span class="hljs-number">6</span></span> /,        . <br> <br>  <code>case</code> <code>FILTER_MODE_HIGHPASS</code>    . <code>buf0</code>       .   <code>inputValue</code>  <code>buf0</code> ,   .    <code>buf1</code> ,     . <br> <br>  <code>case</code> <code>FILTER_MODE_BANDPASS</code> ,  <code>buf0 - buf1</code>   .  <code>buf0</code>       ,     <code>buf1</code> . ,   . <br>  :    <i> </i>    <i> </i> ,   . <br> <br>  <code>buf1</code>     .       <a href="http://ru.wikipedia.org/wiki/%25D0%25A4%25D0%25B8%25D0%25BB%25D1%258C%25D1%2582%25D1%2580_%25D1%2581_%25D0%25B1%25D0%25B5%25D1%2581%25D0%25BA%25D0%25BE%25D0%25BD%25D0%25B5%25D1%2587%25D0%25BD%25D0%25BE%25D0%25B9_%25D0%25B8%25D0%25BC%25D0%25BF%25D1%2583%25D0%25BB%25D1%258C%25D1%2581%25D0%25BD%25D0%25BE%25D0%25B9_%25D1%2585%25D0%25B0%25D1%2580%25D0%25B0%25D0%25BA%25D1%2582%25D0%25B5%25D1%2580%25D0%25B8%25D1%2581%25D1%2582%25D0%25B8%25D0%25BA%25D0%25BE%25D0%25B9">    </a> ( <i>Infinite Impulse Response</i> ,  <i>IIR</i> ).  <a href="http://www.dspguide.com/ch14/1.htm"> </a> ,      .      ,         ,      . <br> <br>   <br>       ,     ,     .   ,  ,      ,  ,          .           ,  NI Massive,   ¬´ <a href="http://lurkmore.to/%25D0%25A2%25D1%2591%25D0%25BF%25D0%25BB%25D1%258B%25D0%25B9_%25D0%25BB%25D0%25B0%25D0%25BC%25D0%25BF%25D0%25BE%25D0%25B2%25D1%258B%25D0%25B9_%25D0%25B7%25D0%25B2%25D1%2583%25D0%25BA">  </a> ¬ª.       ,          ,   .        ,          (  Massive       ).      ¬´¬ª , , , AAS Ultra Analog,       ,     ,    ,        .         ,  ,    <a href="http://www.kvraudio.com/forum/viewtopic.php%3Ft%3D350246"></a> ,   ,      NI Reaktor. ,            ‚Äî    ,    ..     . <br> <br>   <br>     .   GUI.  <i>bg.png</i>   ( <i>‚ÄúMove to trash‚Äù</i>  Xcode),       : <br> <br> <a href="">filtermode.png</a> <a href="">knob_small.png</a> (  ,   <span class="hljs-number"><span class="hljs-number">50</span></span> <span class="hljs-number"><span class="hljs-number">50</span></span> ) <a href="">bg.png</a> (       ) <br> <br>    ID  <i>resource.h</i> : <br> <br> <code class="cpp">// Unique IDs for each image resource. #define BG_ID <span class="hljs-number"><span class="hljs-number">101</span></span> #define WHITE_KEY_ID <span class="hljs-number"><span class="hljs-number">102</span></span> #define BLACK_KEY_ID <span class="hljs-number"><span class="hljs-number">103</span></span> #define WAVEFORM_ID <span class="hljs-number"><span class="hljs-number">104</span></span> #define KNOB_ID <span class="hljs-number"><span class="hljs-number">105</span></span> #define KNOB_SMALL_ID <span class="hljs-number"><span class="hljs-number">106</span></span> #define FILTERMODE_ID <span class="hljs-number"><span class="hljs-number">107</span></span> // Image resource locations for this plug. #define BG_FN <span class="hljs-string"><span class="hljs-string">"resources/img/bg.png"</span></span> #define WHITE_KEY_FN <span class="hljs-string"><span class="hljs-string">"resources/img/whitekey.png"</span></span> #define BLACK_KEY_FN <span class="hljs-string"><span class="hljs-string">"resources/img/blackkey.png"</span></span> #define WAVEFORM_FN <span class="hljs-string"><span class="hljs-string">"resources/img/waveform.png"</span></span> #define KNOB_FN <span class="hljs-string"><span class="hljs-string">"resources/img/knob.png"</span></span> #define KNOB_SMALL_FN <span class="hljs-string"><span class="hljs-string">"resources/img/knob_small.png"</span></span> #define FILTERMODE_FN <span class="hljs-string"><span class="hljs-string">"resources/img/filtermode.png"</span></span></code> <br> <br>  <i>Synthesis.rc</i> : <br> <br> <code class="cpp">#include <span class="hljs-string"><span class="hljs-string">"resource.h"</span></span> BG_ID PNG BG_FN WHITE_KEY_ID PNG WHITE_KEY_FN BLACK_KEY_ID PNG BLACK_KEY_FN WAVEFORM_ID PNG WAVEFORM_FN KNOB_ID PNG KNOB_FN KNOB_SMALL_ID PNG KNOB_SMALL_FN FILTERMODE_ID PNG FILTERMODE_FN</code> <br> <br>   <code>#include <span class="hljs-string"><span class="hljs-string">"Filter.h"</span></span></code>  <i>Synthesis.h</i>    <code>private</code> : <br> <br> <code class="cpp">Filter mFilter;</code> <br> <br>  <code>EParams</code>  <i>Synthesis.cpp</i> : <br> <br> <code class="cpp">enum EParams { mWaveform = <span class="hljs-number"><span class="hljs-number">0</span></span>, mAttack, mDecay, mSustain, mRelease, mFilterMode, mFilterCutoff, mFilterResonance, mFilterAttack, mFilterDecay, mFilterSustain, mFilterRelease, mFilterEnvelopeAmount, kNumParams };</code> <br> <br>        : <br> <br> <code class="cpp">pGraphics-&gt;AttachControl(new ISwitchControl(this, <span class="hljs-number"><span class="hljs-number">24</span></span>, <span class="hljs-number"><span class="hljs-number">38</span></span>, mWaveform, &amp;waveformBitmap));</code> <br> <br>      .      (Lowpass, Highpass, Bandpass).    <code>AttachGraphics(pGraphics)</code> : <br> <br> <code class="cpp">GetParam(mFilterMode)-&gt;InitEnum(<span class="hljs-string"><span class="hljs-string">"Filter Mode"</span></span>, Filter::FILTER_MODE_LOWPASS, Filter::kNumFilterModes); IBitmap filtermodeBitmap = pGraphics-&gt;LoadIBitmap(FILTERMODE_ID, FILTERMODE_FN, <span class="hljs-number"><span class="hljs-number">3</span></span>); pGraphics-&gt;AttachControl(new ISwitchControl(this, <span class="hljs-number"><span class="hljs-number">24</span></span>, <span class="hljs-number"><span class="hljs-number">123</span></span>, mFilterMode, &amp;filtermodeBitmap));</code> <br> <br>         .    .     <i>knob_small.png</i> : <br> <br> <code class="cpp">// Knobs for filter cutoff and resonance IBitmap smallKnobBitmap = pGraphics-&gt;LoadIBitmap(KNOB_SMALL_ID, KNOB_SMALL_FN, <span class="hljs-number"><span class="hljs-number">64</span></span>); // Cutoff knob: GetParam(mFilterCutoff)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Cutoff"</span></span>, <span class="hljs-number"><span class="hljs-number">0.99</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">0.99</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); GetParam(mFilterCutoff)-&gt;SetShape(<span class="hljs-number"><span class="hljs-number">2</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-number"><span class="hljs-number">177</span></span>, mFilterCutoff, &amp;smallKnobBitmap)); // Resonance knob: GetParam(mFilterResonance)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Resonance"</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">61</span></span>, <span class="hljs-number"><span class="hljs-number">177</span></span>, mFilterResonance, &amp;smallKnobBitmap));</code> <br> <br>   ,           <code><span class="hljs-number"><span class="hljs-number">1.0</span></span></code> ,   <code>calculateFeedbackAmount</code>    , . <br>  <code>ProcessDoubleReplacing</code>     : <br> <br> leftOutput[i] = rightOutput[i] = mFilter.process(mOscillator.nextSample() * mEnvelopeGenerator.nextSample() * velocity / <span class="hljs-number"><span class="hljs-number">127.0</span></span>); <br> <br>       .  <code>switch</code>   <code>Synthesis::OnParamChange</code> : <br> <br> <code class="cpp">case mFilterCutoff: mFilter.setCutoff(GetParam(paramIdx)-&gt;Value()); break; case mFilterResonance: mFilter.setResonance(GetParam(paramIdx)-&gt;Value()); break; case mFilterMode: mFilter.setFilterMode(static_cast&lt;Filter::FilterMode&gt;(GetParam(paramIdx)-&gt;Int())); break;</code> <br> <br>    .  -      . <br> <br>  <br> <br>  ‚Äî      .   ,   ,          . <br>      : <br> <br> <code class="cpp">buf0 += cutoff * (inputValue - buf0 + feedbackAmount * (buf0 - buf1));</code> <br> <br> ,   ,      ( <code>buf0 ‚Äì buf1</code> ),   <code>feedbackAmount</code> .    <code>calculateFeedbackAmount</code>  <code>feedbackAmount</code>  <code>resonance</code> , . .    ,   . <br> <br>  ,            .     ,  <i></i> ,      <a href="https://www.youtube.com/watch%3Fv%3DJWyMj6KxGHM"> </a> .    ,        ,       . <br> <br>  -<span class="hljs-number"><span class="hljs-number">12</span></span> /  -<span class="hljs-number"><span class="hljs-number">24</span></span> / <br>        !     <span class="hljs-number"><span class="hljs-number">24</span></span>   .     <code>switch</code>  <code>Filter::process</code> : <br> <br> <code class="cpp">buf2 += cutoff * (buf1 - buf2); buf3 += cutoff * (buf2 ‚Äì buf3);</code> <br> <br>   :      ,       ,            .     ,       , , <a href="https://ccrma.stanford.edu/~Jos/filters/Filter_Stability.html"></a> (       ).     <code>switch</code> : <br> <br> <code class="cpp">switch (mode) { case FILTER_MODE_LOWPASS: return buf3; case FILTER_MODE_HIGHPASS: return inputValue - buf3; case FILTER_MODE_BANDPASS: return buf0 - buf3; default: return <span class="hljs-number"><span class="hljs-number">0.0</span></span>; }</code> <br> <br>   <code>buf1</code>  <code>buf3</code> ‚Äì      .    -<span class="hljs-number"><span class="hljs-number">24</span></span> /.     <code>buf2</code>  <code>buf3</code> ,        <code>private</code> <i>Filter.h</i> : <br> <br> <code class="cpp">double buf2; double buf3;</code> <br> <br>    ,   <code>buf0</code> c <code>buf1</code> : <br> <br> <code class="cpp">Filter() : // ... buf0(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), buf1(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), buf2(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), buf3(<span class="hljs-number"><span class="hljs-number">0.0</span></span>) // ...</code> <br> <br>     , ,     :     .       . <br>          ? <br> <br>   <br>    .  ,           ,       . <br> -      <code>cutoff</code>   .      .    <code>cutoffMod</code> ,    ,       <code>cutoff</code>    .     <code><code>#include    private</code> : <br> <br> <code class="cpp">double cutoffMod;</code> <br> <br> : <br> <br> <code class="cpp">Filter() : cutoff(<span class="hljs-number"><span class="hljs-number">0.99</span></span>), resonance(<span class="hljs-number"><span class="hljs-number">0.01</span></span>), cutoffMod(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), // ...</code> <br> <br>         .   <code>private</code> : <br> <br> <code class="cpp">inline double getCalculatedCutoff() const { return fmax(fmin(cutoff + cutoffMod, <span class="hljs-number"><span class="hljs-number">0.99</span></span>), <span class="hljs-number"><span class="hljs-number">0.01</span></span>); };</code> <br> <br> <code>calculateFeedbackAmount</code>     : <br> <br> <code class="cpp">inline void calculateFeedbackAmount() { feedbackAmount = resonance + resonance/(<span class="hljs-number"><span class="hljs-number">1.0</span></span> - getCalculatedCutoff()); }</code> <br> <br>       <code>cutoffMod</code> .   <code>feedbackAmount</code>    ,     : <br> <br> <code class="cpp">inline void setCutoffMod(double newCutoffMod) { cutoffMod = newCutoffMod; calculateFeedbackAmount(); }</code> <br> <br> ,       .   <code>Filter::process</code>   : <br> <br> <code class="cpp">if (inputValue == <span class="hljs-number"><span class="hljs-number">0.0</span></span>) return inputValue; double calculatedCutoff = getCalculatedCutoff(); buf0 += calculatedCutoff * (inputValue - buf0 + feedbackAmount * (buf0 - buf1)); buf1 += calculatedCutoff * (buf0 - buf1); buf2 += calculatedCutoff * (buf1 - buf2); buf3 += calculatedCutoff * (buf2 ‚Äì buf3);</code> <br> <br>        ,    .    ,      ,   .     .     <code>cutoff</code>  <code>calculatedCutoff</code>   -. <br> <br> ,       ( <code>setCutoffMod</code> ),   <code>Synthesis</code>    ,     ,    .    ,        <code>cutoffMod</code> .    <code>filterEnvelopeAmount</code>    <code>-<span class="hljs-number"><span class="hljs-number">1</span></span></code>  <code>+<span class="hljs-number"><span class="hljs-number">1</span></span></code> .   GUI. <br> <br>   <code>private</code> <i>Synthesis.h</i>    : <br> <br> <code class="cpp">EnvelopeGenerator mFilterEnvelopeGenerator; double filterEnvelopeAmount;</code> <br> <br>       MIDI ,      <code>onNoteOn</code>  <code>onNoteOff</code> : <br> <br> <code class="cpp">inline void onNoteOn(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); mFilterEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); }; inline void onNoteOff(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); mFilterEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); };</code> <br> <br>    .   <code>ProcessDoubleReplacing</code>        : <br> <br> <code class="cpp">mFilter.setCutoffMod(mFilterEnvelopeGenerator.nextSample() * filterEnvelopeAmount);</code> <br> <br>  ,        <code>nextSample</code>  <code>filterEnvelopeAmount</code>     <code>cutoffMod</code> .     <code>filterEnvelopeAmount</code>  : <br> <br> <code class="cpp">Synthesis::Synthesis(IPlugInstanceInfo instanceInfo) : IPLUG_CTOR(kNumParams, kNumPrograms, instanceInfo), lastVirtualKeyboardNoteNumber(virtualKeyboardMinimumNoteNumber - <span class="hljs-number"><span class="hljs-number">1</span></span>), filterEnvelopeAmount(<span class="hljs-number"><span class="hljs-number">0.0</span></span>) { // ... }</code> <br> <br>       <code>Synthesis::Reset</code> : <br> <br> <code class="cpp">mFilterEnvelopeGenerator.setSampleRate(GetSampleRate());</code> <br> <br>      <code>EParams</code> ,       .  <code>AttachGraphics</code>     : <br> <br> <code class="cpp">// Knobs for filter envelope // Attack knob GetParam(mFilterAttack)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Filter Env Attack"</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">10.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); GetParam(mFilterAttack)-&gt;SetShape(<span class="hljs-number"><span class="hljs-number">3</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">139</span></span>, <span class="hljs-number"><span class="hljs-number">178</span></span>, mFilterAttack, &amp;smallKnobBitmap)); // Decay knob: GetParam(mFilterDecay)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Filter Env Decay"</span></span>, <span class="hljs-number"><span class="hljs-number">0.5</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">15.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); GetParam(mFilterDecay)-&gt;SetShape(<span class="hljs-number"><span class="hljs-number">3</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">195</span></span>, <span class="hljs-number"><span class="hljs-number">178</span></span>, mFilterDecay, &amp;smallKnobBitmap)); // Sustain knob: GetParam(mFilterSustain)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Filter Env Sustain"</span></span>, <span class="hljs-number"><span class="hljs-number">0.1</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>, <span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); GetParam(mFilterSustain)-&gt;SetShape(<span class="hljs-number"><span class="hljs-number">2</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">251</span></span>, <span class="hljs-number"><span class="hljs-number">178</span></span>, mFilterSustain, &amp;smallKnobBitmap)); // Release knob: GetParam(mFilterRelease)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Filter Env Release"</span></span>, <span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>, <span class="hljs-number"><span class="hljs-number">15.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); GetParam(mFilterRelease)-&gt;SetShape(<span class="hljs-number"><span class="hljs-number">3</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">307</span></span>, <span class="hljs-number"><span class="hljs-number">178</span></span>, mFilterRelease, &amp;smallKnobBitmap)); // Filter envelope amount knob: GetParam(mFilterEnvelopeAmount)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Filter Env Amount"</span></span>, <span class="hljs-number"><span class="hljs-number">0.0</span></span>, -<span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">363</span></span>, <span class="hljs-number"><span class="hljs-number">178</span></span>, mFilterEnvelopeAmount, &amp;smallKnobBitmap));</code> <br> <br>     ,       <code>smallKnobBitmap</code> .                   .     ,    .  <code>Synthesis::OnParamChange</code>    <code>switch</code> : <br> <br> <code class="cpp">case mFilterAttack: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK, GetParam(paramIdx)-&gt;Value()); break; case mFilterDecay: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_DECAY, GetParam(paramIdx)-&gt;Value()); break; case mFilterSustain: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_SUSTAIN, GetParam(paramIdx)-&gt;Value()); break; case mFilterRelease: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE, GetParam(paramIdx)-&gt;Value()); break; case mFilterEnvelopeAmount: filterEnvelopeAmount = GetParam(paramIdx)-&gt;Value(); break;</code> <br> <br> ! <br>     !           (-   C1),   : <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/f5d/757/3f9/f5d7573f9b3a720fe5898d88ae477cfc.png"> <br> <br>        <code>EnvelopeGenerator</code>  .         .        ! <br> <br>    <a href=""></a> . <br> <br>        :) <br> <br>  : <br> <a href="http://martin-finke.de/blog/articles/audio-plugins-013-filter/">martin-finke.de/blog/articles/audio-plugins-<span class="hljs-number"><span class="hljs-number">013</span></span>-filter</a></code></code></code> </pre> <code><code class="cpp">#include  <i>Filter.h</i> ( )     : <br> <br> class Filter { public: enum FilterMode { FILTER_MODE_LOWPASS = 0, FILTER_MODE_HIGHPASS, FILTER_MODE_BANDPASS, kNumFilterModes }; Filter() : cutoff(0.99), resonance(0.0), mode(FILTER_MODE_LOWPASS), buf0(0.0), buf1(0.0) { calculateFeedbackAmount(); }; double process(double inputValue); inline void setCutoff(double newCutoff) { cutoff = newCutoff; calculateFeedbackAmount(); }; inline void setResonance(double newResonance) { resonance = newResonance; calculateFeedbackAmount(); }; inline void setFilterMode(FilterMode newMode) { mode = newMode; } private: double cutoff; double resonance; FilterMode mode; double feedbackAmount; inline void calculateFeedbackAmount() { feedbackAmount = resonance + resonance/(1.0 - cutoff); } double buf0; double buf1; };</code> <br> <br>  <code>private</code>     <i> </i> <code>cutoff</code>  <i></i> <code>resonance</code> . <code>Mode</code>      (Lowpass, Highpass, Bandpass).  <code>feedbackAmount</code> , <code>buf0</code>  <code>buf1</code>    ,    . <br>          ( <code>calculateFeedbackAmount()</code> ).  <code>process</code>      .   <code>feedbackAmount</code>   <code>cutoff</code>  <code>resonance</code> ,    <code>calculateFeedbackAmount</code>      . <br> <br>   <i>Filter.cpp</i>  : <br> <br> <code class="cpp">// By Paul Kellett // http://www.musicdsp.org/showone.php?id=29 double Filter::process(double inputValue) { buf0 += cutoff * (inputValue - buf0); buf1 += cutoff * (buf0 - buf1); switch (mode) { case FILTER_MODE_LOWPASS: return buf1; case FILTER_MODE_HIGHPASS: return inputValue - buf0; case FILTER_MODE_BANDPASS: return buf0 - buf1; default: return 0.0; } }</code> <br> <br> , ?  ,         <i> </i> . ¬´ ¬ª   ,               (. .    6 ).     <code>buf0</code>  <code>buf1</code> :        .     <code>inputValue</code> ,  - <code>buf0</code> (  ).   .    6 /   12 /.  <code>switch</code> ,  <code>buf1</code>    . , ,    <code>buf0</code> ,       12,   6 /,        . <br> <br>  <code>case</code> <code>FILTER_MODE_HIGHPASS</code>    . <code>buf0</code>       .   <code>inputValue</code>  <code>buf0</code> ,   .    <code>buf1</code> ,     . <br> <br>  <code>case</code> <code>FILTER_MODE_BANDPASS</code> ,  <code>buf0 - buf1</code>   .  <code>buf0</code>       ,     <code>buf1</code> . ,   . <br>  :    <i> </i>    <i> </i> ,   . <br> <br>  <code>buf1</code>     .       <a href="http://ru.wikipedia.org/wiki/%25D0%25A4%25D0%25B8%25D0%25BB%25D1%258C%25D1%2582%25D1%2580_%25D1%2581_%25D0%25B1%25D0%25B5%25D1%2581%25D0%25BA%25D0%25BE%25D0%25BD%25D0%25B5%25D1%2587%25D0%25BD%25D0%25BE%25D0%25B9_%25D0%25B8%25D0%25BC%25D0%25BF%25D1%2583%25D0%25BB%25D1%258C%25D1%2581%25D0%25BD%25D0%25BE%25D0%25B9_%25D1%2585%25D0%25B0%25D1%2580%25D0%25B0%25D0%25BA%25D1%2582%25D0%25B5%25D1%2580%25D0%25B8%25D1%2581%25D1%2582%25D0%25B8%25D0%25BA%25D0%25BE%25D0%25B9">    </a> ( <i>Infinite Impulse Response</i> ,  <i>IIR</i> ).  <a href="http://www.dspguide.com/ch14/1.htm"> </a> ,      .      ,         ,      . <br> <br>   <br>       ,     ,     .   ,  ,      ,  ,          .           ,  NI Massive,   ¬´ <a href="http://lurkmore.to/%25D0%25A2%25D1%2591%25D0%25BF%25D0%25BB%25D1%258B%25D0%25B9_%25D0%25BB%25D0%25B0%25D0%25BC%25D0%25BF%25D0%25BE%25D0%25B2%25D1%258B%25D0%25B9_%25D0%25B7%25D0%25B2%25D1%2583%25D0%25BA">  </a> ¬ª.       ,          ,   .        ,          (  Massive       ).      ¬´¬ª , , , AAS Ultra Analog,       ,     ,    ,        .         ,  ,    <a href="http://www.kvraudio.com/forum/viewtopic.php%3Ft%3D350246"></a> ,   ,      NI Reaktor. ,            ‚Äî    ,    ..     . <br> <br>   <br>     .   GUI.  <i>bg.png</i>   ( <i>‚ÄúMove to trash‚Äù</i>  Xcode),       : <br> <br> <a href="">filtermode.png</a> <a href="">knob_small.png</a> (  ,   50 50 ) <a href="">bg.png</a> (       ) <br> <br>    ID  <i>resource.h</i> : <br> <br> <code class="cpp">// Unique IDs for each image resource. #define BG_ID 101 #define WHITE_KEY_ID 102 #define BLACK_KEY_ID 103 #define WAVEFORM_ID 104 #define KNOB_ID 105 #define KNOB_SMALL_ID 106 #define FILTERMODE_ID 107 // Image resource locations for this plug. #define BG_FN "resources/img/bg.png" #define WHITE_KEY_FN "resources/img/whitekey.png" #define BLACK_KEY_FN "resources/img/blackkey.png" #define WAVEFORM_FN "resources/img/waveform.png" #define KNOB_FN "resources/img/knob.png" #define KNOB_SMALL_FN "resources/img/knob_small.png" #define FILTERMODE_FN "resources/img/filtermode.png"</code> <br> <br>  <i>Synthesis.rc</i> : <br> <br> <code class="cpp">#include "resource.h" BG_ID PNG BG_FN WHITE_KEY_ID PNG WHITE_KEY_FN BLACK_KEY_ID PNG BLACK_KEY_FN WAVEFORM_ID PNG WAVEFORM_FN KNOB_ID PNG KNOB_FN KNOB_SMALL_ID PNG KNOB_SMALL_FN FILTERMODE_ID PNG FILTERMODE_FN</code> <br> <br>   <code>#include "Filter.h"</code>  <i>Synthesis.h</i>    <code>private</code> : <br> <br> <code class="cpp">Filter mFilter;</code> <br> <br>  <code>EParams</code>  <i>Synthesis.cpp</i> : <br> <br> <code class="cpp">enum EParams { mWaveform = 0, mAttack, mDecay, mSustain, mRelease, mFilterMode, mFilterCutoff, mFilterResonance, mFilterAttack, mFilterDecay, mFilterSustain, mFilterRelease, mFilterEnvelopeAmount, kNumParams };</code> <br> <br>        : <br> <br> <code class="cpp">pGraphics-&gt;AttachControl(new ISwitchControl(this, 24, 38, mWaveform, &amp;waveformBitmap));</code> <br> <br>      .      (Lowpass, Highpass, Bandpass).    <code>AttachGraphics(pGraphics)</code> : <br> <br> <code class="cpp">GetParam(mFilterMode)-&gt;InitEnum("Filter Mode", Filter::FILTER_MODE_LOWPASS, Filter::kNumFilterModes); IBitmap filtermodeBitmap = pGraphics-&gt;LoadIBitmap(FILTERMODE_ID, FILTERMODE_FN, 3); pGraphics-&gt;AttachControl(new ISwitchControl(this, 24, 123, mFilterMode, &amp;filtermodeBitmap));</code> <br> <br>         .    .     <i>knob_small.png</i> : <br> <br> <code class="cpp">// Knobs for filter cutoff and resonance IBitmap smallKnobBitmap = pGraphics-&gt;LoadIBitmap(KNOB_SMALL_ID, KNOB_SMALL_FN, 64); // Cutoff knob: GetParam(mFilterCutoff)-&gt;InitDouble("Cutoff", 0.99, 0.01, 0.99, 0.001); GetParam(mFilterCutoff)-&gt;SetShape(2); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 5, 177, mFilterCutoff, &amp;smallKnobBitmap)); // Resonance knob: GetParam(mFilterResonance)-&gt;InitDouble("Resonance", 0.01, 0.01, 1.0, 0.001); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 61, 177, mFilterResonance, &amp;smallKnobBitmap));</code> <br> <br>   ,           <code>1.0</code> ,   <code>calculateFeedbackAmount</code>    , . <br>  <code>ProcessDoubleReplacing</code>     : <br> <br> <code class="cpp">leftOutput[i] = rightOutput[i] = mFilter.process(mOscillator.nextSample() * mEnvelopeGenerator.nextSample() * velocity / 127.0);</code> <br> <br>       .  <code>switch</code>   <code>Synthesis::OnParamChange</code> : <br> <br> <code class="cpp">case mFilterCutoff: mFilter.setCutoff(GetParam(paramIdx)-&gt;Value()); break; case mFilterResonance: mFilter.setResonance(GetParam(paramIdx)-&gt;Value()); break; case mFilterMode: mFilter.setFilterMode(static_cast&lt;Filter::FilterMode&gt;(GetParam(paramIdx)-&gt;Int())); break;</code> <br> <br>    .  -      . <br> <br>  <br> <br>  ‚Äî      .   ,   ,          . <br>      : <br> <br> <code class="cpp">buf0 += cutoff * (inputValue - buf0 + feedbackAmount * (buf0 - buf1));</code> <br> <br> ,   ,      ( <code>buf0 ‚Äì buf1</code> ),   <code>feedbackAmount</code> .    <code>calculateFeedbackAmount</code>  <code>feedbackAmount</code>  <code>resonance</code> , . .    ,   . <br> <br>  ,            .     ,  <i></i> ,      <a href="https://www.youtube.com/watch%3Fv%3DJWyMj6KxGHM"> </a> .    ,        ,       . <br> <br>  -12 /  -24 / <br>        !     24   .     <code>switch</code>  <code>Filter::process</code> : <br> <br> <code class="cpp">buf2 += cutoff * (buf1 - buf2); buf3 += cutoff * (buf2 ‚Äì buf3);</code> <br> <br>   :      ,       ,            .     ,       , , <a href="https://ccrma.stanford.edu/~Jos/filters/Filter_Stability.html"></a> (       ).     <code>switch</code> : <br> <br> <code class="cpp">switch (mode) { case FILTER_MODE_LOWPASS: return buf3; case FILTER_MODE_HIGHPASS: return inputValue - buf3; case FILTER_MODE_BANDPASS: return buf0 - buf3; default: return 0.0; }</code> <br> <br>   <code>buf1</code>  <code>buf3</code> ‚Äì      .    -24 /.     <code>buf2</code>  <code>buf3</code> ,        <code>private</code> <i>Filter.h</i> : <br> <br> <code class="cpp">double buf2; double buf3;</code> <br> <br>    ,   <code>buf0</code> c <code>buf1</code> : <br> <br> <code class="cpp">Filter() : // ... buf0(0.0), buf1(0.0), buf2(0.0), buf3(0.0) // ...</code> <br> <br>     , ,     :     .       . <br>          ? <br> <br>   <br>    .  ,           ,       . <br> -      <code>cutoff</code>   .      .    <code>cutoffMod</code> ,    ,       <code>cutoff</code>    .     <code><code>#include    private</code> : <br> <br> <code class="cpp">double cutoffMod;</code> <br> <br> : <br> <br> <code class="cpp">Filter() : cutoff(0.99), resonance(0.01), cutoffMod(0.0), // ...</code> <br> <br>         .   <code>private</code> : <br> <br> <code class="cpp">inline double getCalculatedCutoff() const { return fmax(fmin(cutoff + cutoffMod, 0.99), 0.01); };</code> <br> <br> <code>calculateFeedbackAmount</code>     : <br> <br> <code class="cpp">inline void calculateFeedbackAmount() { feedbackAmount = resonance + resonance/(1.0 - getCalculatedCutoff()); }</code> <br> <br>       <code>cutoffMod</code> .   <code>feedbackAmount</code>    ,     : <br> <br> <code class="cpp">inline void setCutoffMod(double newCutoffMod) { cutoffMod = newCutoffMod; calculateFeedbackAmount(); }</code> <br> <br> ,       .   <code>Filter::process</code>   : <br> <br> <code class="cpp">if (inputValue == 0.0) return inputValue; double calculatedCutoff = getCalculatedCutoff(); buf0 += calculatedCutoff * (inputValue - buf0 + feedbackAmount * (buf0 - buf1)); buf1 += calculatedCutoff * (buf0 - buf1); buf2 += calculatedCutoff * (buf1 - buf2); buf3 += calculatedCutoff * (buf2 ‚Äì buf3);</code> <br> <br>        ,    .    ,      ,   .     .     <code>cutoff</code>  <code>calculatedCutoff</code>   -. <br> <br> ,       ( <code>setCutoffMod</code> ),   <code>Synthesis</code>    ,     ,    .    ,        <code>cutoffMod</code> .    <code>filterEnvelopeAmount</code>    <code>-1</code>  <code>+1</code> .   GUI. <br> <br>   <code>private</code> <i>Synthesis.h</i>    : <br> <br> <code class="cpp">EnvelopeGenerator mFilterEnvelopeGenerator; double filterEnvelopeAmount;</code> <br> <br>       MIDI ,      <code>onNoteOn</code>  <code>onNoteOff</code> : <br> <br> <code class="cpp">inline void onNoteOn(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); mFilterEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); }; inline void onNoteOff(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); mFilterEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); };</code> <br> <br>    .   <code>ProcessDoubleReplacing</code>        : <br> <br> <code class="cpp">mFilter.setCutoffMod(mFilterEnvelopeGenerator.nextSample() * filterEnvelopeAmount);</code> <br> <br>  ,        <code>nextSample</code>  <code>filterEnvelopeAmount</code>     <code>cutoffMod</code> .     <code>filterEnvelopeAmount</code>  : <br> <br> <code class="cpp">Synthesis::Synthesis(IPlugInstanceInfo instanceInfo) : IPLUG_CTOR(kNumParams, kNumPrograms, instanceInfo), lastVirtualKeyboardNoteNumber(virtualKeyboardMinimumNoteNumber - 1), filterEnvelopeAmount(0.0) { // ... }</code> <br> <br>       <code>Synthesis::Reset</code> : <br> <br> <code class="cpp">mFilterEnvelopeGenerator.setSampleRate(GetSampleRate());</code> <br> <br>      <code>EParams</code> ,       .  <code>AttachGraphics</code>     : <br> <br> <code class="cpp">// Knobs for filter envelope // Attack knob GetParam(mFilterAttack)-&gt;InitDouble("Filter Env Attack", 0.01, 0.01, 10.0, 0.001); GetParam(mFilterAttack)-&gt;SetShape(3); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 139, 178, mFilterAttack, &amp;smallKnobBitmap)); // Decay knob: GetParam(mFilterDecay)-&gt;InitDouble("Filter Env Decay", 0.5, 0.01, 15.0, 0.001); GetParam(mFilterDecay)-&gt;SetShape(3); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 195, 178, mFilterDecay, &amp;smallKnobBitmap)); // Sustain knob: GetParam(mFilterSustain)-&gt;InitDouble("Filter Env Sustain", 0.1, 0.001, 1.0, 0.001); GetParam(mFilterSustain)-&gt;SetShape(2); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 251, 178, mFilterSustain, &amp;smallKnobBitmap)); // Release knob: GetParam(mFilterRelease)-&gt;InitDouble("Filter Env Release", 1.0, 0.001, 15.0, 0.001); GetParam(mFilterRelease)-&gt;SetShape(3); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 307, 178, mFilterRelease, &amp;smallKnobBitmap)); // Filter envelope amount knob: GetParam(mFilterEnvelopeAmount)-&gt;InitDouble("Filter Env Amount", 0.0, -1.0, 1.0, 0.001); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 363, 178, mFilterEnvelopeAmount, &amp;smallKnobBitmap));</code> <br> <br>     ,       <code>smallKnobBitmap</code> .                   .     ,    .  <code>Synthesis::OnParamChange</code>    <code>switch</code> : <br> <br> <code class="cpp">case mFilterAttack: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK, GetParam(paramIdx)-&gt;Value()); break; case mFilterDecay: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_DECAY, GetParam(paramIdx)-&gt;Value()); break; case mFilterSustain: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_SUSTAIN, GetParam(paramIdx)-&gt;Value()); break; case mFilterRelease: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE, GetParam(paramIdx)-&gt;Value()); break; case mFilterEnvelopeAmount: filterEnvelopeAmount = GetParam(paramIdx)-&gt;Value(); break;</code> <br> <br> ! <br>     !           (-   C1),   : <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/f5d/757/3f9/f5d7573f9b3a720fe5898d88ae477cfc.png"> <br> <br>        <code>EnvelopeGenerator</code>  .         .        ! <br> <br>    <a href=""></a> . <br> <br>        :) <br> <br>  : <br> <a href="http://martin-finke.de/blog/articles/audio-plugins-013-filter/">martin-finke.de/blog/articles/audio-plugins-013-filter</a></code></code> <pre> <code class="hljs erlang-repl"><code class="cpp">#include  <i>Filter.h</i> ( )     : <br> <br> class Filter { public: enum FilterMode { FILTER_MODE_LOWPASS = <span class="hljs-number"><span class="hljs-number">0</span></span>, FILTER_MODE_HIGHPASS, FILTER_MODE_BANDPASS, kNumFilterModes }; Filter() : cutoff(<span class="hljs-number"><span class="hljs-number">0.99</span></span>), resonance(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), mode(FILTER_MODE_LOWPASS), buf0(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), buf1(<span class="hljs-number"><span class="hljs-number">0.0</span></span>) { calculateFeedbackAmount(); }; double process(double inputValue); inline void setCutoff(double newCutoff) { cutoff = newCutoff; calculateFeedbackAmount(); }; inline void setResonance(double newResonance) { resonance = newResonance; calculateFeedbackAmount(); }; inline void setFilterMode(FilterMode newMode) { mode = newMode; } private: double cutoff; double resonance; FilterMode mode; double feedbackAmount; inline void calculateFeedbackAmount() { feedbackAmount = resonance + resonance/(<span class="hljs-number"><span class="hljs-number">1.0</span></span> - cutoff); } double buf0; double buf1; };</code> <br> <br>  <code>private</code>     <i> </i> <code>cutoff</code>  <i></i> <code>resonance</code> . <code>Mode</code>      (Lowpass, Highpass, Bandpass).  <code>feedbackAmount</code> , <code>buf0</code>  <code>buf1</code>    ,    . <br>          ( <code>calculateFeedbackAmount()</code> ).  <code>process</code>      .   <code>feedbackAmount</code>   <code>cutoff</code>  <code>resonance</code> ,    <code>calculateFeedbackAmount</code>      . <br> <br>   <i>Filter.cpp</i>  : <br> <br> <code class="cpp">// By Paul Kellett // http://www.musicdsp.org/showone.php?id=<span class="hljs-number"><span class="hljs-number">29</span></span> double Filter::process(double inputValue) { buf0 += cutoff * (inputValue - buf0); buf1 += cutoff * (buf0 - buf1); switch (mode) { case FILTER_MODE_LOWPASS: return buf1; case FILTER_MODE_HIGHPASS: return inputValue - buf0; case FILTER_MODE_BANDPASS: return buf0 - buf1; default: return <span class="hljs-number"><span class="hljs-number">0.0</span></span>; } }</code> <br> <br> , ?  ,         <i> </i> . ¬´ ¬ª   ,               (. .    <span class="hljs-number"><span class="hljs-number">6</span></span> ).     <code>buf0</code>  <code>buf1</code> :        .     <code>inputValue</code> ,  - <code>buf0</code> (  ).   .    <span class="hljs-number"><span class="hljs-number">6</span></span> /   <span class="hljs-number"><span class="hljs-number">12</span></span> /.  <code>switch</code> ,  <code>buf1</code>    . , ,    <code>buf0</code> ,       <span class="hljs-number"><span class="hljs-number">12</span></span>,   <span class="hljs-number"><span class="hljs-number">6</span></span> /,        . <br> <br>  <code>case</code> <code>FILTER_MODE_HIGHPASS</code>    . <code>buf0</code>       .   <code>inputValue</code>  <code>buf0</code> ,   .    <code>buf1</code> ,     . <br> <br>  <code>case</code> <code>FILTER_MODE_BANDPASS</code> ,  <code>buf0 - buf1</code>   .  <code>buf0</code>       ,     <code>buf1</code> . ,   . <br>  :    <i> </i>    <i> </i> ,   . <br> <br>  <code>buf1</code>     .       <a href="http://ru.wikipedia.org/wiki/%25D0%25A4%25D0%25B8%25D0%25BB%25D1%258C%25D1%2582%25D1%2580_%25D1%2581_%25D0%25B1%25D0%25B5%25D1%2581%25D0%25BA%25D0%25BE%25D0%25BD%25D0%25B5%25D1%2587%25D0%25BD%25D0%25BE%25D0%25B9_%25D0%25B8%25D0%25BC%25D0%25BF%25D1%2583%25D0%25BB%25D1%258C%25D1%2581%25D0%25BD%25D0%25BE%25D0%25B9_%25D1%2585%25D0%25B0%25D1%2580%25D0%25B0%25D0%25BA%25D1%2582%25D0%25B5%25D1%2580%25D0%25B8%25D1%2581%25D1%2582%25D0%25B8%25D0%25BA%25D0%25BE%25D0%25B9">    </a> ( <i>Infinite Impulse Response</i> ,  <i>IIR</i> ).  <a href="http://www.dspguide.com/ch14/1.htm"> </a> ,      .      ,         ,      . <br> <br>   <br>       ,     ,     .   ,  ,      ,  ,          .           ,  NI Massive,   ¬´ <a href="http://lurkmore.to/%25D0%25A2%25D1%2591%25D0%25BF%25D0%25BB%25D1%258B%25D0%25B9_%25D0%25BB%25D0%25B0%25D0%25BC%25D0%25BF%25D0%25BE%25D0%25B2%25D1%258B%25D0%25B9_%25D0%25B7%25D0%25B2%25D1%2583%25D0%25BA">  </a> ¬ª.       ,          ,   .        ,          (  Massive       ).      ¬´¬ª , , , AAS Ultra Analog,       ,     ,    ,        .         ,  ,    <a href="http://www.kvraudio.com/forum/viewtopic.php%3Ft%3D350246"></a> ,   ,      NI Reaktor. ,            ‚Äî    ,    ..     . <br> <br>   <br>     .   GUI.  <i>bg.png</i>   ( <i>‚ÄúMove to trash‚Äù</i>  Xcode),       : <br> <br> <a href="">filtermode.png</a> <a href="">knob_small.png</a> (  ,   <span class="hljs-number"><span class="hljs-number">50</span></span> <span class="hljs-number"><span class="hljs-number">50</span></span> ) <a href="">bg.png</a> (       ) <br> <br>    ID  <i>resource.h</i> : <br> <br> <code class="cpp">// Unique IDs for each image resource. #define BG_ID <span class="hljs-number"><span class="hljs-number">101</span></span> #define WHITE_KEY_ID <span class="hljs-number"><span class="hljs-number">102</span></span> #define BLACK_KEY_ID <span class="hljs-number"><span class="hljs-number">103</span></span> #define WAVEFORM_ID <span class="hljs-number"><span class="hljs-number">104</span></span> #define KNOB_ID <span class="hljs-number"><span class="hljs-number">105</span></span> #define KNOB_SMALL_ID <span class="hljs-number"><span class="hljs-number">106</span></span> #define FILTERMODE_ID <span class="hljs-number"><span class="hljs-number">107</span></span> // Image resource locations for this plug. #define BG_FN <span class="hljs-string"><span class="hljs-string">"resources/img/bg.png"</span></span> #define WHITE_KEY_FN <span class="hljs-string"><span class="hljs-string">"resources/img/whitekey.png"</span></span> #define BLACK_KEY_FN <span class="hljs-string"><span class="hljs-string">"resources/img/blackkey.png"</span></span> #define WAVEFORM_FN <span class="hljs-string"><span class="hljs-string">"resources/img/waveform.png"</span></span> #define KNOB_FN <span class="hljs-string"><span class="hljs-string">"resources/img/knob.png"</span></span> #define KNOB_SMALL_FN <span class="hljs-string"><span class="hljs-string">"resources/img/knob_small.png"</span></span> #define FILTERMODE_FN <span class="hljs-string"><span class="hljs-string">"resources/img/filtermode.png"</span></span></code> <br> <br>  <i>Synthesis.rc</i> : <br> <br> <code class="cpp">#include <span class="hljs-string"><span class="hljs-string">"resource.h"</span></span> BG_ID PNG BG_FN WHITE_KEY_ID PNG WHITE_KEY_FN BLACK_KEY_ID PNG BLACK_KEY_FN WAVEFORM_ID PNG WAVEFORM_FN KNOB_ID PNG KNOB_FN KNOB_SMALL_ID PNG KNOB_SMALL_FN FILTERMODE_ID PNG FILTERMODE_FN</code> <br> <br>   <code>#include <span class="hljs-string"><span class="hljs-string">"Filter.h"</span></span></code>  <i>Synthesis.h</i>    <code>private</code> : <br> <br> <code class="cpp">Filter mFilter;</code> <br> <br>  <code>EParams</code>  <i>Synthesis.cpp</i> : <br> <br> <code class="cpp">enum EParams { mWaveform = <span class="hljs-number"><span class="hljs-number">0</span></span>, mAttack, mDecay, mSustain, mRelease, mFilterMode, mFilterCutoff, mFilterResonance, mFilterAttack, mFilterDecay, mFilterSustain, mFilterRelease, mFilterEnvelopeAmount, kNumParams };</code> <br> <br>        : <br> <br> <code class="cpp">pGraphics-&gt;AttachControl(new ISwitchControl(this, <span class="hljs-number"><span class="hljs-number">24</span></span>, <span class="hljs-number"><span class="hljs-number">38</span></span>, mWaveform, &amp;waveformBitmap));</code> <br> <br>      .      (Lowpass, Highpass, Bandpass).    <code>AttachGraphics(pGraphics)</code> : <br> <br> <code class="cpp">GetParam(mFilterMode)-&gt;InitEnum(<span class="hljs-string"><span class="hljs-string">"Filter Mode"</span></span>, Filter::FILTER_MODE_LOWPASS, Filter::kNumFilterModes); IBitmap filtermodeBitmap = pGraphics-&gt;LoadIBitmap(FILTERMODE_ID, FILTERMODE_FN, <span class="hljs-number"><span class="hljs-number">3</span></span>); pGraphics-&gt;AttachControl(new ISwitchControl(this, <span class="hljs-number"><span class="hljs-number">24</span></span>, <span class="hljs-number"><span class="hljs-number">123</span></span>, mFilterMode, &amp;filtermodeBitmap));</code> <br> <br>         .    .     <i>knob_small.png</i> : <br> <br> <code class="cpp">// Knobs for filter cutoff and resonance IBitmap smallKnobBitmap = pGraphics-&gt;LoadIBitmap(KNOB_SMALL_ID, KNOB_SMALL_FN, <span class="hljs-number"><span class="hljs-number">64</span></span>); // Cutoff knob: GetParam(mFilterCutoff)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Cutoff"</span></span>, <span class="hljs-number"><span class="hljs-number">0.99</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">0.99</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); GetParam(mFilterCutoff)-&gt;SetShape(<span class="hljs-number"><span class="hljs-number">2</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-number"><span class="hljs-number">177</span></span>, mFilterCutoff, &amp;smallKnobBitmap)); // Resonance knob: GetParam(mFilterResonance)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Resonance"</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">61</span></span>, <span class="hljs-number"><span class="hljs-number">177</span></span>, mFilterResonance, &amp;smallKnobBitmap));</code> <br> <br>   ,           <code><span class="hljs-number"><span class="hljs-number">1.0</span></span></code> ,   <code>calculateFeedbackAmount</code>    , . <br>  <code>ProcessDoubleReplacing</code>     : <br> <br> <code class="cpp">leftOutput[i] = rightOutput[i] = mFilter.process(mOscillator.nextSample() * mEnvelopeGenerator.nextSample() * velocity / <span class="hljs-number"><span class="hljs-number">127.0</span></span>);</code> <br> <br>       .  <code>switch</code>   <code>Synthesis::OnParamChange</code> : <br> <br> <code class="cpp">case mFilterCutoff: mFilter.setCutoff(GetParam(paramIdx)-&gt;Value()); break; case mFilterResonance: mFilter.setResonance(GetParam(paramIdx)-&gt;Value()); break; case mFilterMode: mFilter.setFilterMode(static_cast&lt;Filter::FilterMode&gt;(GetParam(paramIdx)-&gt;Int())); break;</code> <br> <br>    .  -      . <br> <br>  <br> <br>  ‚Äî      .   ,   ,          . <br>      : <br> <br> <code class="cpp">buf0 += cutoff * (inputValue - buf0 + feedbackAmount * (buf0 - buf1));</code> <br> <br> ,   ,      ( <code>buf0 ‚Äì buf1</code> ),   <code>feedbackAmount</code> .    <code>calculateFeedbackAmount</code>  <code>feedbackAmount</code>  <code>resonance</code> , . .    ,   . <br> <br>  ,            .     ,  <i></i> ,      <a href="https://www.youtube.com/watch%3Fv%3DJWyMj6KxGHM"> </a> .    ,        ,       . <br> <br>  -<span class="hljs-number"><span class="hljs-number">12</span></span> /  -<span class="hljs-number"><span class="hljs-number">24</span></span> / <br>        !     <span class="hljs-number"><span class="hljs-number">24</span></span>   .     <code>switch</code>  <code>Filter::process</code> : <br> <br> <code class="cpp">buf2 += cutoff * (buf1 - buf2); buf3 += cutoff * (buf2 ‚Äì buf3);</code> <br> <br>   :      ,       ,            .     ,       , , <a href="https://ccrma.stanford.edu/~Jos/filters/Filter_Stability.html"></a> (       ).     <code>switch</code> : <br> <br> <code class="cpp">switch (mode) { case FILTER_MODE_LOWPASS: return buf3; case FILTER_MODE_HIGHPASS: return inputValue - buf3; case FILTER_MODE_BANDPASS: return buf0 - buf3; default: return <span class="hljs-number"><span class="hljs-number">0.0</span></span>; }</code> <br> <br>   <code>buf1</code>  <code>buf3</code> ‚Äì      .    -<span class="hljs-number"><span class="hljs-number">24</span></span> /.     <code>buf2</code>  <code>buf3</code> ,        <code>private</code> <i>Filter.h</i> : <br> <br> <code class="cpp">double buf2; double buf3;</code> <br> <br>    ,   <code>buf0</code> c <code>buf1</code> : <br> <br> <code class="cpp">Filter() : // ... buf0(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), buf1(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), buf2(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), buf3(<span class="hljs-number"><span class="hljs-number">0.0</span></span>) // ...</code> <br> <br>     , ,     :     .       . <br>          ? <br> <br>   <br>    .  ,           ,       . <br> -      <code>cutoff</code>   .      .    <code>cutoffMod</code> ,    ,       <code>cutoff</code>    .     <code><code>#include    private</code> : <br> <br> <code class="cpp">double cutoffMod;</code> <br> <br> : <br> <br> <code class="cpp">Filter() : cutoff(<span class="hljs-number"><span class="hljs-number">0.99</span></span>), resonance(<span class="hljs-number"><span class="hljs-number">0.01</span></span>), cutoffMod(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), // ...</code> <br> <br>         .   <code>private</code> : <br> <br> <code class="cpp">inline double getCalculatedCutoff() const { return fmax(fmin(cutoff + cutoffMod, <span class="hljs-number"><span class="hljs-number">0.99</span></span>), <span class="hljs-number"><span class="hljs-number">0.01</span></span>); };</code> <br> <br> <code>calculateFeedbackAmount</code>     : <br> <br> <code class="cpp">inline void calculateFeedbackAmount() { feedbackAmount = resonance + resonance/(<span class="hljs-number"><span class="hljs-number">1.0</span></span> - getCalculatedCutoff()); }</code> <br> <br>       <code>cutoffMod</code> .   <code>feedbackAmount</code>    ,     : <br> <br> <code class="cpp">inline void setCutoffMod(double newCutoffMod) { cutoffMod = newCutoffMod; calculateFeedbackAmount(); }</code> <br> <br> ,       .   <code>Filter::process</code>   : <br> <br> <code class="cpp">if (inputValue == <span class="hljs-number"><span class="hljs-number">0.0</span></span>) return inputValue; double calculatedCutoff = getCalculatedCutoff(); buf0 += calculatedCutoff * (inputValue - buf0 + feedbackAmount * (buf0 - buf1)); buf1 += calculatedCutoff * (buf0 - buf1); buf2 += calculatedCutoff * (buf1 - buf2); buf3 += calculatedCutoff * (buf2 ‚Äì buf3);</code> <br> <br>        ,    .    ,      ,   .     .     <code>cutoff</code>  <code>calculatedCutoff</code>   -. <br> <br> ,       ( <code>setCutoffMod</code> ),   <code>Synthesis</code>    ,     ,    .    ,        <code>cutoffMod</code> .    <code>filterEnvelopeAmount</code>    <code>-<span class="hljs-number"><span class="hljs-number">1</span></span></code>  <code>+<span class="hljs-number"><span class="hljs-number">1</span></span></code> .   GUI. <br> <br>   <code>private</code> <i>Synthesis.h</i>    : <br> <br> <code class="cpp">EnvelopeGenerator mFilterEnvelopeGenerator; double filterEnvelopeAmount;</code> <br> <br>       MIDI ,      <code>onNoteOn</code>  <code>onNoteOff</code> : <br> <br> <code class="cpp">inline void onNoteOn(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); mFilterEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); }; inline void onNoteOff(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); mFilterEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); };</code> <br> <br>    .   <code>ProcessDoubleReplacing</code>        : <br> <br> <code class="cpp">mFilter.setCutoffMod(mFilterEnvelopeGenerator.nextSample() * filterEnvelopeAmount);</code> <br> <br>  ,        <code>nextSample</code>  <code>filterEnvelopeAmount</code>     <code>cutoffMod</code> .     <code>filterEnvelopeAmount</code>  : <br> <br> <code class="cpp">Synthesis::Synthesis(IPlugInstanceInfo instanceInfo) : IPLUG_CTOR(kNumParams, kNumPrograms, instanceInfo), lastVirtualKeyboardNoteNumber(virtualKeyboardMinimumNoteNumber - <span class="hljs-number"><span class="hljs-number">1</span></span>), filterEnvelopeAmount(<span class="hljs-number"><span class="hljs-number">0.0</span></span>) { // ... }</code> <br> <br>       <code>Synthesis::Reset</code> : <br> <br> <code class="cpp">mFilterEnvelopeGenerator.setSampleRate(GetSampleRate());</code> <br> <br>      <code>EParams</code> ,       .  <code>AttachGraphics</code>     : <br> <br> <code class="cpp">// Knobs for filter envelope // Attack knob GetParam(mFilterAttack)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Filter Env Attack"</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">10.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); GetParam(mFilterAttack)-&gt;SetShape(<span class="hljs-number"><span class="hljs-number">3</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">139</span></span>, <span class="hljs-number"><span class="hljs-number">178</span></span>, mFilterAttack, &amp;smallKnobBitmap)); // Decay knob: GetParam(mFilterDecay)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Filter Env Decay"</span></span>, <span class="hljs-number"><span class="hljs-number">0.5</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">15.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); GetParam(mFilterDecay)-&gt;SetShape(<span class="hljs-number"><span class="hljs-number">3</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">195</span></span>, <span class="hljs-number"><span class="hljs-number">178</span></span>, mFilterDecay, &amp;smallKnobBitmap)); // Sustain knob: GetParam(mFilterSustain)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Filter Env Sustain"</span></span>, <span class="hljs-number"><span class="hljs-number">0.1</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>, <span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); GetParam(mFilterSustain)-&gt;SetShape(<span class="hljs-number"><span class="hljs-number">2</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">251</span></span>, <span class="hljs-number"><span class="hljs-number">178</span></span>, mFilterSustain, &amp;smallKnobBitmap)); // Release knob: GetParam(mFilterRelease)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Filter Env Release"</span></span>, <span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>, <span class="hljs-number"><span class="hljs-number">15.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); GetParam(mFilterRelease)-&gt;SetShape(<span class="hljs-number"><span class="hljs-number">3</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">307</span></span>, <span class="hljs-number"><span class="hljs-number">178</span></span>, mFilterRelease, &amp;smallKnobBitmap)); // Filter envelope amount knob: GetParam(mFilterEnvelopeAmount)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Filter Env Amount"</span></span>, <span class="hljs-number"><span class="hljs-number">0.0</span></span>, -<span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">363</span></span>, <span class="hljs-number"><span class="hljs-number">178</span></span>, mFilterEnvelopeAmount, &amp;smallKnobBitmap));</code> <br> <br>     ,       <code>smallKnobBitmap</code> .                   .     ,    .  <code>Synthesis::OnParamChange</code>    <code>switch</code> : <br> <br> <code class="cpp">case mFilterAttack: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK, GetParam(paramIdx)-&gt;Value()); break; case mFilterDecay: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_DECAY, GetParam(paramIdx)-&gt;Value()); break; case mFilterSustain: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_SUSTAIN, GetParam(paramIdx)-&gt;Value()); break; case mFilterRelease: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE, GetParam(paramIdx)-&gt;Value()); break; case mFilterEnvelopeAmount: filterEnvelopeAmount = GetParam(paramIdx)-&gt;Value(); break;</code> <br> <br> ! <br>     !           (-   C1),   : <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/f5d/757/3f9/f5d7573f9b3a720fe5898d88ae477cfc.png"> <br> <br>        <code>EnvelopeGenerator</code>  .         .        ! <br> <br>    <a href=""></a> . <br> <br>        :) <br> <br>  : <br> <a href="http://martin-finke.de/blog/articles/audio-plugins-013-filter/">martin-finke.de/blog/articles/audio-plugins-<span class="hljs-number"><span class="hljs-number">013</span></span>-filter</a></code></code> </pre> <code><code class="cpp">#include  <i>Filter.h</i> ( )     : <br> <br> class Filter { public: enum FilterMode { FILTER_MODE_LOWPASS = 0, FILTER_MODE_HIGHPASS, FILTER_MODE_BANDPASS, kNumFilterModes }; Filter() : cutoff(0.99), resonance(0.0), mode(FILTER_MODE_LOWPASS), buf0(0.0), buf1(0.0) { calculateFeedbackAmount(); }; double process(double inputValue); inline void setCutoff(double newCutoff) { cutoff = newCutoff; calculateFeedbackAmount(); }; inline void setResonance(double newResonance) { resonance = newResonance; calculateFeedbackAmount(); }; inline void setFilterMode(FilterMode newMode) { mode = newMode; } private: double cutoff; double resonance; FilterMode mode; double feedbackAmount; inline void calculateFeedbackAmount() { feedbackAmount = resonance + resonance/(1.0 - cutoff); } double buf0; double buf1; };</code> <br> <br>  <code>private</code>     <i> </i> <code>cutoff</code>  <i></i> <code>resonance</code> . <code>Mode</code>      (Lowpass, Highpass, Bandpass).  <code>feedbackAmount</code> , <code>buf0</code>  <code>buf1</code>    ,    . <br>          ( <code>calculateFeedbackAmount()</code> ).  <code>process</code>      .   <code>feedbackAmount</code>   <code>cutoff</code>  <code>resonance</code> ,    <code>calculateFeedbackAmount</code>      . <br> <br>   <i>Filter.cpp</i>  : <br> <br> <code class="cpp">// By Paul Kellett // http://www.musicdsp.org/showone.php?id=29 double Filter::process(double inputValue) { buf0 += cutoff * (inputValue - buf0); buf1 += cutoff * (buf0 - buf1); switch (mode) { case FILTER_MODE_LOWPASS: return buf1; case FILTER_MODE_HIGHPASS: return inputValue - buf0; case FILTER_MODE_BANDPASS: return buf0 - buf1; default: return 0.0; } }</code> <br> <br> , ?  ,         <i> </i> . ¬´ ¬ª   ,               (. .    6 ).     <code>buf0</code>  <code>buf1</code> :        .     <code>inputValue</code> ,  - <code>buf0</code> (  ).   .    6 /   12 /.  <code>switch</code> ,  <code>buf1</code>    . , ,    <code>buf0</code> ,       12,   6 /,        . <br> <br>  <code>case</code> <code>FILTER_MODE_HIGHPASS</code>    . <code>buf0</code>       .   <code>inputValue</code>  <code>buf0</code> ,   .    <code>buf1</code> ,     . <br> <br>  <code>case</code> <code>FILTER_MODE_BANDPASS</code> ,  <code>buf0 - buf1</code>   .  <code>buf0</code>       ,     <code>buf1</code> . ,   . <br>  :    <i> </i>    <i> </i> ,   . <br> <br>  <code>buf1</code>     .       <a href="http://ru.wikipedia.org/wiki/%25D0%25A4%25D0%25B8%25D0%25BB%25D1%258C%25D1%2582%25D1%2580_%25D1%2581_%25D0%25B1%25D0%25B5%25D1%2581%25D0%25BA%25D0%25BE%25D0%25BD%25D0%25B5%25D1%2587%25D0%25BD%25D0%25BE%25D0%25B9_%25D0%25B8%25D0%25BC%25D0%25BF%25D1%2583%25D0%25BB%25D1%258C%25D1%2581%25D0%25BD%25D0%25BE%25D0%25B9_%25D1%2585%25D0%25B0%25D1%2580%25D0%25B0%25D0%25BA%25D1%2582%25D0%25B5%25D1%2580%25D0%25B8%25D1%2581%25D1%2582%25D0%25B8%25D0%25BA%25D0%25BE%25D0%25B9">    </a> ( <i>Infinite Impulse Response</i> ,  <i>IIR</i> ).  <a href="http://www.dspguide.com/ch14/1.htm"> </a> ,      .      ,         ,      . <br> <br>   <br>       ,     ,     .   ,  ,      ,  ,          .           ,  NI Massive,   ¬´ <a href="http://lurkmore.to/%25D0%25A2%25D1%2591%25D0%25BF%25D0%25BB%25D1%258B%25D0%25B9_%25D0%25BB%25D0%25B0%25D0%25BC%25D0%25BF%25D0%25BE%25D0%25B2%25D1%258B%25D0%25B9_%25D0%25B7%25D0%25B2%25D1%2583%25D0%25BA">  </a> ¬ª.       ,          ,   .        ,          (  Massive       ).      ¬´¬ª , , , AAS Ultra Analog,       ,     ,    ,        .         ,  ,    <a href="http://www.kvraudio.com/forum/viewtopic.php%3Ft%3D350246"></a> ,   ,      NI Reaktor. ,            ‚Äî    ,    ..     . <br> <br>   <br>     .   GUI.  <i>bg.png</i>   ( <i>‚ÄúMove to trash‚Äù</i>  Xcode),       : <br> <br> <a href="">filtermode.png</a> <a href="">knob_small.png</a> (  ,   50 50 ) <a href="">bg.png</a> (       ) <br> <br>    ID  <i>resource.h</i> : <br> <br> <code class="cpp">// Unique IDs for each image resource. #define BG_ID 101 #define WHITE_KEY_ID 102 #define BLACK_KEY_ID 103 #define WAVEFORM_ID 104 #define KNOB_ID 105 #define KNOB_SMALL_ID 106 #define FILTERMODE_ID 107 // Image resource locations for this plug. #define BG_FN "resources/img/bg.png" #define WHITE_KEY_FN "resources/img/whitekey.png" #define BLACK_KEY_FN "resources/img/blackkey.png" #define WAVEFORM_FN "resources/img/waveform.png" #define KNOB_FN "resources/img/knob.png" #define KNOB_SMALL_FN "resources/img/knob_small.png" #define FILTERMODE_FN "resources/img/filtermode.png"</code> <br> <br>  <i>Synthesis.rc</i> : <br> <br> <code class="cpp">#include "resource.h" BG_ID PNG BG_FN WHITE_KEY_ID PNG WHITE_KEY_FN BLACK_KEY_ID PNG BLACK_KEY_FN WAVEFORM_ID PNG WAVEFORM_FN KNOB_ID PNG KNOB_FN KNOB_SMALL_ID PNG KNOB_SMALL_FN FILTERMODE_ID PNG FILTERMODE_FN</code> <br> <br>   <code>#include "Filter.h"</code>  <i>Synthesis.h</i>    <code>private</code> : <br> <br> <code class="cpp">Filter mFilter;</code> <br> <br>  <code>EParams</code>  <i>Synthesis.cpp</i> : <br> <br> <code class="cpp">enum EParams { mWaveform = 0, mAttack, mDecay, mSustain, mRelease, mFilterMode, mFilterCutoff, mFilterResonance, mFilterAttack, mFilterDecay, mFilterSustain, mFilterRelease, mFilterEnvelopeAmount, kNumParams };</code> <br> <br>        : <br> <br> <code class="cpp">pGraphics-&gt;AttachControl(new ISwitchControl(this, 24, 38, mWaveform, &amp;waveformBitmap));</code> <br> <br>      .      (Lowpass, Highpass, Bandpass).    <code>AttachGraphics(pGraphics)</code> : <br> <br> <code class="cpp">GetParam(mFilterMode)-&gt;InitEnum("Filter Mode", Filter::FILTER_MODE_LOWPASS, Filter::kNumFilterModes); IBitmap filtermodeBitmap = pGraphics-&gt;LoadIBitmap(FILTERMODE_ID, FILTERMODE_FN, 3); pGraphics-&gt;AttachControl(new ISwitchControl(this, 24, 123, mFilterMode, &amp;filtermodeBitmap));</code> <br> <br>         .    .     <i>knob_small.png</i> : <br> <br> <code class="cpp">// Knobs for filter cutoff and resonance IBitmap smallKnobBitmap = pGraphics-&gt;LoadIBitmap(KNOB_SMALL_ID, KNOB_SMALL_FN, 64); // Cutoff knob: GetParam(mFilterCutoff)-&gt;InitDouble("Cutoff", 0.99, 0.01, 0.99, 0.001); GetParam(mFilterCutoff)-&gt;SetShape(2); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 5, 177, mFilterCutoff, &amp;smallKnobBitmap)); // Resonance knob: GetParam(mFilterResonance)-&gt;InitDouble("Resonance", 0.01, 0.01, 1.0, 0.001); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 61, 177, mFilterResonance, &amp;smallKnobBitmap));</code> <br> <br>   ,           <code>1.0</code> ,   <code>calculateFeedbackAmount</code>    , . <br>  <code>ProcessDoubleReplacing</code>     : <br> <br> <code class="cpp">leftOutput[i] = rightOutput[i] = mFilter.process(mOscillator.nextSample() * mEnvelopeGenerator.nextSample() * velocity / 127.0);</code> <br> <br>       .  <code>switch</code>   <code>Synthesis::OnParamChange</code> : <br> <br> <code class="cpp">case mFilterCutoff: mFilter.setCutoff(GetParam(paramIdx)-&gt;Value()); break; case mFilterResonance: mFilter.setResonance(GetParam(paramIdx)-&gt;Value()); break; case mFilterMode: mFilter.setFilterMode(static_cast&lt;Filter::FilterMode&gt;(GetParam(paramIdx)-&gt;Int())); break;</code> <br> <br>    .  -      . <br> <br>  <br> <br>  ‚Äî      .   ,   ,          . <br>      : <br> <br> <code class="cpp">buf0 += cutoff * (inputValue - buf0 + feedbackAmount * (buf0 - buf1));</code> <br> <br> ,   ,      ( <code>buf0 ‚Äì buf1</code> ),   <code>feedbackAmount</code> .    <code>calculateFeedbackAmount</code>  <code>feedbackAmount</code>  <code>resonance</code> , . .    ,   . <br> <br>  ,            .     ,  <i></i> ,      <a href="https://www.youtube.com/watch%3Fv%3DJWyMj6KxGHM"> </a> .    ,        ,       . <br> <br>  -12 /  -24 / <br>        !     24   .     <code>switch</code>  <code>Filter::process</code> : <br> <br> <code class="cpp">buf2 += cutoff * (buf1 - buf2); buf3 += cutoff * (buf2 ‚Äì buf3);</code> <br> <br>   :      ,       ,            .     ,       , , <a href="https://ccrma.stanford.edu/~Jos/filters/Filter_Stability.html"></a> (       ).     <code>switch</code> : <br> <br> <code class="cpp">switch (mode) { case FILTER_MODE_LOWPASS: return buf3; case FILTER_MODE_HIGHPASS: return inputValue - buf3; case FILTER_MODE_BANDPASS: return buf0 - buf3; default: return 0.0; }</code> <br> <br>   <code>buf1</code>  <code>buf3</code> ‚Äì      .    -24 /.     <code>buf2</code>  <code>buf3</code> ,        <code>private</code> <i>Filter.h</i> : <br> <br> <code class="cpp">double buf2; double buf3;</code> <br> <br>    ,   <code>buf0</code> c <code>buf1</code> : <br> <br> <code class="cpp">Filter() : // ... buf0(0.0), buf1(0.0), buf2(0.0), buf3(0.0) // ...</code> <br> <br>     , ,     :     .       . <br>          ? <br> <br>   <br>    .  ,           ,       . <br> -      <code>cutoff</code>   .      .    <code>cutoffMod</code> ,    ,       <code>cutoff</code>    .     <code><code>#include    private</code> : <br> <br> <code class="cpp">double cutoffMod;</code> <br> <br> : <br> <br> <code class="cpp">Filter() : cutoff(0.99), resonance(0.01), cutoffMod(0.0), // ...</code> <br> <br>         .   <code>private</code> : <br> <br> <code class="cpp">inline double getCalculatedCutoff() const { return fmax(fmin(cutoff + cutoffMod, 0.99), 0.01); };</code> <br> <br> <code>calculateFeedbackAmount</code>     : <br> <br> <code class="cpp">inline void calculateFeedbackAmount() { feedbackAmount = resonance + resonance/(1.0 - getCalculatedCutoff()); }</code> <br> <br>       <code>cutoffMod</code> .   <code>feedbackAmount</code>    ,     : <br> <br> <code class="cpp">inline void setCutoffMod(double newCutoffMod) { cutoffMod = newCutoffMod; calculateFeedbackAmount(); }</code> <br> <br> ,       .   <code>Filter::process</code>   : <br> <br> <code class="cpp">if (inputValue == 0.0) return inputValue; double calculatedCutoff = getCalculatedCutoff(); buf0 += calculatedCutoff * (inputValue - buf0 + feedbackAmount * (buf0 - buf1)); buf1 += calculatedCutoff * (buf0 - buf1); buf2 += calculatedCutoff * (buf1 - buf2); buf3 += calculatedCutoff * (buf2 ‚Äì buf3);</code> <br> <br>        ,    .    ,      ,   .     .     <code>cutoff</code>  <code>calculatedCutoff</code>   -. <br> <br> ,       ( <code>setCutoffMod</code> ),   <code>Synthesis</code>    ,     ,    .    ,        <code>cutoffMod</code> .    <code>filterEnvelopeAmount</code>    <code>-1</code>  <code>+1</code> .   GUI. <br> <br>   <code>private</code> <i>Synthesis.h</i>    : <br> <br> <code class="cpp">EnvelopeGenerator mFilterEnvelopeGenerator; double filterEnvelopeAmount;</code> <br> <br>       MIDI ,      <code>onNoteOn</code>  <code>onNoteOff</code> : <br> <br> <code class="cpp">inline void onNoteOn(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); mFilterEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); }; inline void onNoteOff(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); mFilterEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); };</code> <br> <br>    .   <code>ProcessDoubleReplacing</code>        : <br> <br> <code class="cpp">mFilter.setCutoffMod(mFilterEnvelopeGenerator.nextSample() * filterEnvelopeAmount);</code> <br> <br>  ,        <code>nextSample</code>  <code>filterEnvelopeAmount</code>     <code>cutoffMod</code> .     <code>filterEnvelopeAmount</code>  : <br> <br> <code class="cpp">Synthesis::Synthesis(IPlugInstanceInfo instanceInfo) : IPLUG_CTOR(kNumParams, kNumPrograms, instanceInfo), lastVirtualKeyboardNoteNumber(virtualKeyboardMinimumNoteNumber - 1), filterEnvelopeAmount(0.0) { // ... }</code> <br> <br>       <code>Synthesis::Reset</code> : <br> <br> <code class="cpp">mFilterEnvelopeGenerator.setSampleRate(GetSampleRate());</code> <br> <br>      <code>EParams</code> ,       .  <code>AttachGraphics</code>     : <br> <br> <code class="cpp">// Knobs for filter envelope // Attack knob GetParam(mFilterAttack)-&gt;InitDouble("Filter Env Attack", 0.01, 0.01, 10.0, 0.001); GetParam(mFilterAttack)-&gt;SetShape(3); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 139, 178, mFilterAttack, &amp;smallKnobBitmap)); // Decay knob: GetParam(mFilterDecay)-&gt;InitDouble("Filter Env Decay", 0.5, 0.01, 15.0, 0.001); GetParam(mFilterDecay)-&gt;SetShape(3); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 195, 178, mFilterDecay, &amp;smallKnobBitmap)); // Sustain knob: GetParam(mFilterSustain)-&gt;InitDouble("Filter Env Sustain", 0.1, 0.001, 1.0, 0.001); GetParam(mFilterSustain)-&gt;SetShape(2); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 251, 178, mFilterSustain, &amp;smallKnobBitmap)); // Release knob: GetParam(mFilterRelease)-&gt;InitDouble("Filter Env Release", 1.0, 0.001, 15.0, 0.001); GetParam(mFilterRelease)-&gt;SetShape(3); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 307, 178, mFilterRelease, &amp;smallKnobBitmap)); // Filter envelope amount knob: GetParam(mFilterEnvelopeAmount)-&gt;InitDouble("Filter Env Amount", 0.0, -1.0, 1.0, 0.001); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 363, 178, mFilterEnvelopeAmount, &amp;smallKnobBitmap));</code> <br> <br>     ,       <code>smallKnobBitmap</code> .                   .     ,    .  <code>Synthesis::OnParamChange</code>    <code>switch</code> : <br> <br> <code class="cpp">case mFilterAttack: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK, GetParam(paramIdx)-&gt;Value()); break; case mFilterDecay: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_DECAY, GetParam(paramIdx)-&gt;Value()); break; case mFilterSustain: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_SUSTAIN, GetParam(paramIdx)-&gt;Value()); break; case mFilterRelease: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE, GetParam(paramIdx)-&gt;Value()); break; case mFilterEnvelopeAmount: filterEnvelopeAmount = GetParam(paramIdx)-&gt;Value(); break;</code> <br> <br> ! <br>     !           (-   C1),   : <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/f5d/757/3f9/f5d7573f9b3a720fe5898d88ae477cfc.png"> <br> <br>        <code>EnvelopeGenerator</code>  .         .        ! <br> <br>    <a href=""></a> . <br> <br>        :) <br> <br>  : <br> <a href="http://martin-finke.de/blog/articles/audio-plugins-013-filter/">martin-finke.de/blog/articles/audio-plugins-013-filter</a></code></code> <h3> <code><code class="cpp">#include  <i>Filter.h</i> ( )     : <br> <br> class Filter { public: enum FilterMode { FILTER_MODE_LOWPASS = 0, FILTER_MODE_HIGHPASS, FILTER_MODE_BANDPASS, kNumFilterModes }; Filter() : cutoff(0.99), resonance(0.0), mode(FILTER_MODE_LOWPASS), buf0(0.0), buf1(0.0) { calculateFeedbackAmount(); }; double process(double inputValue); inline void setCutoff(double newCutoff) { cutoff = newCutoff; calculateFeedbackAmount(); }; inline void setResonance(double newResonance) { resonance = newResonance; calculateFeedbackAmount(); }; inline void setFilterMode(FilterMode newMode) { mode = newMode; } private: double cutoff; double resonance; FilterMode mode; double feedbackAmount; inline void calculateFeedbackAmount() { feedbackAmount = resonance + resonance/(1.0 - cutoff); } double buf0; double buf1; };</code> <br> <br>  <code>private</code>     <i> </i> <code>cutoff</code>  <i></i> <code>resonance</code> . <code>Mode</code>      (Lowpass, Highpass, Bandpass).  <code>feedbackAmount</code> , <code>buf0</code>  <code>buf1</code>    ,    . <br>          ( <code>calculateFeedbackAmount()</code> ).  <code>process</code>      .   <code>feedbackAmount</code>   <code>cutoff</code>  <code>resonance</code> ,    <code>calculateFeedbackAmount</code>      . <br> <br>   <i>Filter.cpp</i>  : <br> <br> <code class="cpp">// By Paul Kellett // http://www.musicdsp.org/showone.php?id=29 double Filter::process(double inputValue) { buf0 += cutoff * (inputValue - buf0); buf1 += cutoff * (buf0 - buf1); switch (mode) { case FILTER_MODE_LOWPASS: return buf1; case FILTER_MODE_HIGHPASS: return inputValue - buf0; case FILTER_MODE_BANDPASS: return buf0 - buf1; default: return 0.0; } }</code> <br> <br> , ?  ,         <i> </i> . ¬´ ¬ª   ,               (. .    6 ).     <code>buf0</code>  <code>buf1</code> :        .     <code>inputValue</code> ,  - <code>buf0</code> (  ).   .    6 /   12 /.  <code>switch</code> ,  <code>buf1</code>    . , ,    <code>buf0</code> ,       12,   6 /,        . <br> <br>  <code>case</code> <code>FILTER_MODE_HIGHPASS</code>    . <code>buf0</code>       .   <code>inputValue</code>  <code>buf0</code> ,   .    <code>buf1</code> ,     . <br> <br>  <code>case</code> <code>FILTER_MODE_BANDPASS</code> ,  <code>buf0 - buf1</code>   .  <code>buf0</code>       ,     <code>buf1</code> . ,   . <br>  :    <i> </i>    <i> </i> ,   . <br> <br>  <code>buf1</code>     .       <a href="http://ru.wikipedia.org/wiki/%25D0%25A4%25D0%25B8%25D0%25BB%25D1%258C%25D1%2582%25D1%2580_%25D1%2581_%25D0%25B1%25D0%25B5%25D1%2581%25D0%25BA%25D0%25BE%25D0%25BD%25D0%25B5%25D1%2587%25D0%25BD%25D0%25BE%25D0%25B9_%25D0%25B8%25D0%25BC%25D0%25BF%25D1%2583%25D0%25BB%25D1%258C%25D1%2581%25D0%25BD%25D0%25BE%25D0%25B9_%25D1%2585%25D0%25B0%25D1%2580%25D0%25B0%25D0%25BA%25D1%2582%25D0%25B5%25D1%2580%25D0%25B8%25D1%2581%25D1%2582%25D0%25B8%25D0%25BA%25D0%25BE%25D0%25B9">    </a> ( <i>Infinite Impulse Response</i> ,  <i>IIR</i> ).  <a href="http://www.dspguide.com/ch14/1.htm"> </a> ,      .      ,         ,      . <br> <br>   <br>       ,     ,     .   ,  ,      ,  ,          .           ,  NI Massive,   ¬´ <a href="http://lurkmore.to/%25D0%25A2%25D1%2591%25D0%25BF%25D0%25BB%25D1%258B%25D0%25B9_%25D0%25BB%25D0%25B0%25D0%25BC%25D0%25BF%25D0%25BE%25D0%25B2%25D1%258B%25D0%25B9_%25D0%25B7%25D0%25B2%25D1%2583%25D0%25BA">  </a> ¬ª.       ,          ,   .        ,          (  Massive       ).      ¬´¬ª , , , AAS Ultra Analog,       ,     ,    ,        .         ,  ,    <a href="http://www.kvraudio.com/forum/viewtopic.php%3Ft%3D350246"></a> ,   ,      NI Reaktor. ,            ‚Äî    ,    ..     . <br> <br>   <br>     .   GUI.  <i>bg.png</i>   ( <i>‚ÄúMove to trash‚Äù</i>  Xcode),       : <br> <br> <a href="">filtermode.png</a> <a href="">knob_small.png</a> (  ,   50 50 ) <a href="">bg.png</a> (       ) <br> <br>    ID  <i>resource.h</i> : <br> <br> <code class="cpp">// Unique IDs for each image resource. #define BG_ID 101 #define WHITE_KEY_ID 102 #define BLACK_KEY_ID 103 #define WAVEFORM_ID 104 #define KNOB_ID 105 #define KNOB_SMALL_ID 106 #define FILTERMODE_ID 107 // Image resource locations for this plug. #define BG_FN "resources/img/bg.png" #define WHITE_KEY_FN "resources/img/whitekey.png" #define BLACK_KEY_FN "resources/img/blackkey.png" #define WAVEFORM_FN "resources/img/waveform.png" #define KNOB_FN "resources/img/knob.png" #define KNOB_SMALL_FN "resources/img/knob_small.png" #define FILTERMODE_FN "resources/img/filtermode.png"</code> <br> <br>  <i>Synthesis.rc</i> : <br> <br> <code class="cpp">#include "resource.h" BG_ID PNG BG_FN WHITE_KEY_ID PNG WHITE_KEY_FN BLACK_KEY_ID PNG BLACK_KEY_FN WAVEFORM_ID PNG WAVEFORM_FN KNOB_ID PNG KNOB_FN KNOB_SMALL_ID PNG KNOB_SMALL_FN FILTERMODE_ID PNG FILTERMODE_FN</code> <br> <br>   <code>#include "Filter.h"</code>  <i>Synthesis.h</i>    <code>private</code> : <br> <br> <code class="cpp">Filter mFilter;</code> <br> <br>  <code>EParams</code>  <i>Synthesis.cpp</i> : <br> <br> <code class="cpp">enum EParams { mWaveform = 0, mAttack, mDecay, mSustain, mRelease, mFilterMode, mFilterCutoff, mFilterResonance, mFilterAttack, mFilterDecay, mFilterSustain, mFilterRelease, mFilterEnvelopeAmount, kNumParams };</code> <br> <br>        : <br> <br> <code class="cpp">pGraphics-&gt;AttachControl(new ISwitchControl(this, 24, 38, mWaveform, &amp;waveformBitmap));</code> <br> <br>      .      (Lowpass, Highpass, Bandpass).    <code>AttachGraphics(pGraphics)</code> : <br> <br> <code class="cpp">GetParam(mFilterMode)-&gt;InitEnum("Filter Mode", Filter::FILTER_MODE_LOWPASS, Filter::kNumFilterModes); IBitmap filtermodeBitmap = pGraphics-&gt;LoadIBitmap(FILTERMODE_ID, FILTERMODE_FN, 3); pGraphics-&gt;AttachControl(new ISwitchControl(this, 24, 123, mFilterMode, &amp;filtermodeBitmap));</code> <br> <br>         .    .     <i>knob_small.png</i> : <br> <br> <code class="cpp">// Knobs for filter cutoff and resonance IBitmap smallKnobBitmap = pGraphics-&gt;LoadIBitmap(KNOB_SMALL_ID, KNOB_SMALL_FN, 64); // Cutoff knob: GetParam(mFilterCutoff)-&gt;InitDouble("Cutoff", 0.99, 0.01, 0.99, 0.001); GetParam(mFilterCutoff)-&gt;SetShape(2); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 5, 177, mFilterCutoff, &amp;smallKnobBitmap)); // Resonance knob: GetParam(mFilterResonance)-&gt;InitDouble("Resonance", 0.01, 0.01, 1.0, 0.001); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 61, 177, mFilterResonance, &amp;smallKnobBitmap));</code> <br> <br>   ,           <code>1.0</code> ,   <code>calculateFeedbackAmount</code>    , . <br>  <code>ProcessDoubleReplacing</code>     : <br> <br> <code class="cpp">leftOutput[i] = rightOutput[i] = mFilter.process(mOscillator.nextSample() * mEnvelopeGenerator.nextSample() * velocity / 127.0);</code> <br> <br>       .  <code>switch</code>   <code>Synthesis::OnParamChange</code> : <br> <br> <code class="cpp">case mFilterCutoff: mFilter.setCutoff(GetParam(paramIdx)-&gt;Value()); break; case mFilterResonance: mFilter.setResonance(GetParam(paramIdx)-&gt;Value()); break; case mFilterMode: mFilter.setFilterMode(static_cast&lt;Filter::FilterMode&gt;(GetParam(paramIdx)-&gt;Int())); break;</code> <br> <br>    .  -      . <br> <br>  <br> <br>  ‚Äî      .   ,   ,          . <br>      : <br> <br> <code class="cpp">buf0 += cutoff * (inputValue - buf0 + feedbackAmount * (buf0 - buf1));</code> <br> <br> ,   ,      ( <code>buf0 ‚Äì buf1</code> ),   <code>feedbackAmount</code> .    <code>calculateFeedbackAmount</code>  <code>feedbackAmount</code>  <code>resonance</code> , . .    ,   . <br> <br>  ,            .     ,  <i></i> ,      <a href="https://www.youtube.com/watch%3Fv%3DJWyMj6KxGHM"> </a> .    ,        ,       . <br> <br>  -12 /  -24 / <br>        !     24   .     <code>switch</code>  <code>Filter::process</code> : <br> <br> <code class="cpp">buf2 += cutoff * (buf1 - buf2); buf3 += cutoff * (buf2 ‚Äì buf3);</code> <br> <br>   :      ,       ,            .     ,       , , <a href="https://ccrma.stanford.edu/~Jos/filters/Filter_Stability.html"></a> (       ).     <code>switch</code> : <br> <br> <code class="cpp">switch (mode) { case FILTER_MODE_LOWPASS: return buf3; case FILTER_MODE_HIGHPASS: return inputValue - buf3; case FILTER_MODE_BANDPASS: return buf0 - buf3; default: return 0.0; }</code> <br> <br>   <code>buf1</code>  <code>buf3</code> ‚Äì      .    -24 /.     <code>buf2</code>  <code>buf3</code> ,        <code>private</code> <i>Filter.h</i> : <br> <br> <code class="cpp">double buf2; double buf3;</code> <br> <br>    ,   <code>buf0</code> c <code>buf1</code> : <br> <br> <code class="cpp">Filter() : // ... buf0(0.0), buf1(0.0), buf2(0.0), buf3(0.0) // ...</code> <br> <br>     , ,     :     .       . <br>          ? <br> <br>   <br>    .  ,           ,       . <br> -      <code>cutoff</code>   .      .    <code>cutoffMod</code> ,    ,       <code>cutoff</code>    .     <code><code>#include    private</code> : <br> <br> <code class="cpp">double cutoffMod;</code> <br> <br> : <br> <br> <code class="cpp">Filter() : cutoff(0.99), resonance(0.01), cutoffMod(0.0), // ...</code> <br> <br>         .   <code>private</code> : <br> <br> <code class="cpp">inline double getCalculatedCutoff() const { return fmax(fmin(cutoff + cutoffMod, 0.99), 0.01); };</code> <br> <br> <code>calculateFeedbackAmount</code>     : <br> <br> <code class="cpp">inline void calculateFeedbackAmount() { feedbackAmount = resonance + resonance/(1.0 - getCalculatedCutoff()); }</code> <br> <br>       <code>cutoffMod</code> .   <code>feedbackAmount</code>    ,     : <br> <br> <code class="cpp">inline void setCutoffMod(double newCutoffMod) { cutoffMod = newCutoffMod; calculateFeedbackAmount(); }</code> <br> <br> ,       .   <code>Filter::process</code>   : <br> <br> <code class="cpp">if (inputValue == 0.0) return inputValue; double calculatedCutoff = getCalculatedCutoff(); buf0 += calculatedCutoff * (inputValue - buf0 + feedbackAmount * (buf0 - buf1)); buf1 += calculatedCutoff * (buf0 - buf1); buf2 += calculatedCutoff * (buf1 - buf2); buf3 += calculatedCutoff * (buf2 ‚Äì buf3);</code> <br> <br>        ,    .    ,      ,   .     .     <code>cutoff</code>  <code>calculatedCutoff</code>   -. <br> <br> ,       ( <code>setCutoffMod</code> ),   <code>Synthesis</code>    ,     ,    .    ,        <code>cutoffMod</code> .    <code>filterEnvelopeAmount</code>    <code>-1</code>  <code>+1</code> .   GUI. <br> <br>   <code>private</code> <i>Synthesis.h</i>    : <br> <br> <code class="cpp">EnvelopeGenerator mFilterEnvelopeGenerator; double filterEnvelopeAmount;</code> <br> <br>       MIDI ,      <code>onNoteOn</code>  <code>onNoteOff</code> : <br> <br> <code class="cpp">inline void onNoteOn(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); mFilterEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); }; inline void onNoteOff(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); mFilterEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); };</code> <br> <br>    .   <code>ProcessDoubleReplacing</code>        : <br> <br> <code class="cpp">mFilter.setCutoffMod(mFilterEnvelopeGenerator.nextSample() * filterEnvelopeAmount);</code> <br> <br>  ,        <code>nextSample</code>  <code>filterEnvelopeAmount</code>     <code>cutoffMod</code> .     <code>filterEnvelopeAmount</code>  : <br> <br> <code class="cpp">Synthesis::Synthesis(IPlugInstanceInfo instanceInfo) : IPLUG_CTOR(kNumParams, kNumPrograms, instanceInfo), lastVirtualKeyboardNoteNumber(virtualKeyboardMinimumNoteNumber - 1), filterEnvelopeAmount(0.0) { // ... }</code> <br> <br>       <code>Synthesis::Reset</code> : <br> <br> <code class="cpp">mFilterEnvelopeGenerator.setSampleRate(GetSampleRate());</code> <br> <br>      <code>EParams</code> ,       .  <code>AttachGraphics</code>     : <br> <br> <code class="cpp">// Knobs for filter envelope // Attack knob GetParam(mFilterAttack)-&gt;InitDouble("Filter Env Attack", 0.01, 0.01, 10.0, 0.001); GetParam(mFilterAttack)-&gt;SetShape(3); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 139, 178, mFilterAttack, &amp;smallKnobBitmap)); // Decay knob: GetParam(mFilterDecay)-&gt;InitDouble("Filter Env Decay", 0.5, 0.01, 15.0, 0.001); GetParam(mFilterDecay)-&gt;SetShape(3); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 195, 178, mFilterDecay, &amp;smallKnobBitmap)); // Sustain knob: GetParam(mFilterSustain)-&gt;InitDouble("Filter Env Sustain", 0.1, 0.001, 1.0, 0.001); GetParam(mFilterSustain)-&gt;SetShape(2); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 251, 178, mFilterSustain, &amp;smallKnobBitmap)); // Release knob: GetParam(mFilterRelease)-&gt;InitDouble("Filter Env Release", 1.0, 0.001, 15.0, 0.001); GetParam(mFilterRelease)-&gt;SetShape(3); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 307, 178, mFilterRelease, &amp;smallKnobBitmap)); // Filter envelope amount knob: GetParam(mFilterEnvelopeAmount)-&gt;InitDouble("Filter Env Amount", 0.0, -1.0, 1.0, 0.001); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 363, 178, mFilterEnvelopeAmount, &amp;smallKnobBitmap));</code> <br> <br>     ,       <code>smallKnobBitmap</code> .                   .     ,    .  <code>Synthesis::OnParamChange</code>    <code>switch</code> : <br> <br> <code class="cpp">case mFilterAttack: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK, GetParam(paramIdx)-&gt;Value()); break; case mFilterDecay: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_DECAY, GetParam(paramIdx)-&gt;Value()); break; case mFilterSustain: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_SUSTAIN, GetParam(paramIdx)-&gt;Value()); break; case mFilterRelease: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE, GetParam(paramIdx)-&gt;Value()); break; case mFilterEnvelopeAmount: filterEnvelopeAmount = GetParam(paramIdx)-&gt;Value(); break;</code> <br> <br> ! <br>     !           (-   C1),   : <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/f5d/757/3f9/f5d7573f9b3a720fe5898d88ae477cfc.png"> <br> <br>        <code>EnvelopeGenerator</code>  .         .        ! <br> <br>    <a href=""></a> . <br> <br>        :) <br> <br>  : <br> <a href="http://martin-finke.de/blog/articles/audio-plugins-013-filter/">martin-finke.de/blog/articles/audio-plugins-013-filter</a></code></code> </h3> <code><code class="cpp">#include  <i>Filter.h</i> ( )     : <br> <br> class Filter { public: enum FilterMode { FILTER_MODE_LOWPASS = 0, FILTER_MODE_HIGHPASS, FILTER_MODE_BANDPASS, kNumFilterModes }; Filter() : cutoff(0.99), resonance(0.0), mode(FILTER_MODE_LOWPASS), buf0(0.0), buf1(0.0) { calculateFeedbackAmount(); }; double process(double inputValue); inline void setCutoff(double newCutoff) { cutoff = newCutoff; calculateFeedbackAmount(); }; inline void setResonance(double newResonance) { resonance = newResonance; calculateFeedbackAmount(); }; inline void setFilterMode(FilterMode newMode) { mode = newMode; } private: double cutoff; double resonance; FilterMode mode; double feedbackAmount; inline void calculateFeedbackAmount() { feedbackAmount = resonance + resonance/(1.0 - cutoff); } double buf0; double buf1; };</code> <br> <br>  <code>private</code>     <i> </i> <code>cutoff</code>  <i></i> <code>resonance</code> . <code>Mode</code>      (Lowpass, Highpass, Bandpass).  <code>feedbackAmount</code> , <code>buf0</code>  <code>buf1</code>    ,    . <br>          ( <code>calculateFeedbackAmount()</code> ).  <code>process</code>      .   <code>feedbackAmount</code>   <code>cutoff</code>  <code>resonance</code> ,    <code>calculateFeedbackAmount</code>      . <br> <br>   <i>Filter.cpp</i>  : <br> <br> <code class="cpp">// By Paul Kellett // http://www.musicdsp.org/showone.php?id=29 double Filter::process(double inputValue) { buf0 += cutoff * (inputValue - buf0); buf1 += cutoff * (buf0 - buf1); switch (mode) { case FILTER_MODE_LOWPASS: return buf1; case FILTER_MODE_HIGHPASS: return inputValue - buf0; case FILTER_MODE_BANDPASS: return buf0 - buf1; default: return 0.0; } }</code> <br> <br> , ?  ,         <i> </i> . ¬´ ¬ª   ,               (. .    6 ).     <code>buf0</code>  <code>buf1</code> :        .     <code>inputValue</code> ,  - <code>buf0</code> (  ).   .    6 /   12 /.  <code>switch</code> ,  <code>buf1</code>    . , ,    <code>buf0</code> ,       12,   6 /,        . <br> <br>  <code>case</code> <code>FILTER_MODE_HIGHPASS</code>    . <code>buf0</code>       .   <code>inputValue</code>  <code>buf0</code> ,   .    <code>buf1</code> ,     . <br> <br>  <code>case</code> <code>FILTER_MODE_BANDPASS</code> ,  <code>buf0 - buf1</code>   .  <code>buf0</code>       ,     <code>buf1</code> . ,   . <br>  :    <i> </i>    <i> </i> ,   . <br> <br>  <code>buf1</code>     .       <a href="http://ru.wikipedia.org/wiki/%25D0%25A4%25D0%25B8%25D0%25BB%25D1%258C%25D1%2582%25D1%2580_%25D1%2581_%25D0%25B1%25D0%25B5%25D1%2581%25D0%25BA%25D0%25BE%25D0%25BD%25D0%25B5%25D1%2587%25D0%25BD%25D0%25BE%25D0%25B9_%25D0%25B8%25D0%25BC%25D0%25BF%25D1%2583%25D0%25BB%25D1%258C%25D1%2581%25D0%25BD%25D0%25BE%25D0%25B9_%25D1%2585%25D0%25B0%25D1%2580%25D0%25B0%25D0%25BA%25D1%2582%25D0%25B5%25D1%2580%25D0%25B8%25D1%2581%25D1%2582%25D0%25B8%25D0%25BA%25D0%25BE%25D0%25B9">    </a> ( <i>Infinite Impulse Response</i> ,  <i>IIR</i> ).  <a href="http://www.dspguide.com/ch14/1.htm"> </a> ,      .      ,         ,      . <br> <br>   <br>       ,     ,     .   ,  ,      ,  ,          .           ,  NI Massive,   ¬´ <a href="http://lurkmore.to/%25D0%25A2%25D1%2591%25D0%25BF%25D0%25BB%25D1%258B%25D0%25B9_%25D0%25BB%25D0%25B0%25D0%25BC%25D0%25BF%25D0%25BE%25D0%25B2%25D1%258B%25D0%25B9_%25D0%25B7%25D0%25B2%25D1%2583%25D0%25BA">  </a> ¬ª.       ,          ,   .        ,          (  Massive       ).      ¬´¬ª , , , AAS Ultra Analog,       ,     ,    ,        .         ,  ,    <a href="http://www.kvraudio.com/forum/viewtopic.php%3Ft%3D350246"></a> ,   ,      NI Reaktor. ,            ‚Äî    ,    ..     . <br> <br>   <br>     .   GUI.  <i>bg.png</i>   ( <i>‚ÄúMove to trash‚Äù</i>  Xcode),       : <br> <br> <a href="">filtermode.png</a> <a href="">knob_small.png</a> (  ,   50 50 ) <a href="">bg.png</a> (       ) <br> <br>    ID  <i>resource.h</i> : <br> <br> <code class="cpp">// Unique IDs for each image resource. #define BG_ID 101 #define WHITE_KEY_ID 102 #define BLACK_KEY_ID 103 #define WAVEFORM_ID 104 #define KNOB_ID 105 #define KNOB_SMALL_ID 106 #define FILTERMODE_ID 107 // Image resource locations for this plug. #define BG_FN "resources/img/bg.png" #define WHITE_KEY_FN "resources/img/whitekey.png" #define BLACK_KEY_FN "resources/img/blackkey.png" #define WAVEFORM_FN "resources/img/waveform.png" #define KNOB_FN "resources/img/knob.png" #define KNOB_SMALL_FN "resources/img/knob_small.png" #define FILTERMODE_FN "resources/img/filtermode.png"</code> <br> <br>  <i>Synthesis.rc</i> : <br> <br> <code class="cpp">#include "resource.h" BG_ID PNG BG_FN WHITE_KEY_ID PNG WHITE_KEY_FN BLACK_KEY_ID PNG BLACK_KEY_FN WAVEFORM_ID PNG WAVEFORM_FN KNOB_ID PNG KNOB_FN KNOB_SMALL_ID PNG KNOB_SMALL_FN FILTERMODE_ID PNG FILTERMODE_FN</code> <br> <br>   <code>#include "Filter.h"</code>  <i>Synthesis.h</i>    <code>private</code> : <br> <br> <code class="cpp">Filter mFilter;</code> <br> <br>  <code>EParams</code>  <i>Synthesis.cpp</i> : <br> <br> <code class="cpp">enum EParams { mWaveform = 0, mAttack, mDecay, mSustain, mRelease, mFilterMode, mFilterCutoff, mFilterResonance, mFilterAttack, mFilterDecay, mFilterSustain, mFilterRelease, mFilterEnvelopeAmount, kNumParams };</code> <br> <br>        : <br> <br> <code class="cpp">pGraphics-&gt;AttachControl(new ISwitchControl(this, 24, 38, mWaveform, &amp;waveformBitmap));</code> <br> <br>      .      (Lowpass, Highpass, Bandpass).    <code>AttachGraphics(pGraphics)</code> : <br> <br> <code class="cpp">GetParam(mFilterMode)-&gt;InitEnum("Filter Mode", Filter::FILTER_MODE_LOWPASS, Filter::kNumFilterModes); IBitmap filtermodeBitmap = pGraphics-&gt;LoadIBitmap(FILTERMODE_ID, FILTERMODE_FN, 3); pGraphics-&gt;AttachControl(new ISwitchControl(this, 24, 123, mFilterMode, &amp;filtermodeBitmap));</code> <br> <br>         .    .     <i>knob_small.png</i> : <br> <br> <code class="cpp">// Knobs for filter cutoff and resonance IBitmap smallKnobBitmap = pGraphics-&gt;LoadIBitmap(KNOB_SMALL_ID, KNOB_SMALL_FN, 64); // Cutoff knob: GetParam(mFilterCutoff)-&gt;InitDouble("Cutoff", 0.99, 0.01, 0.99, 0.001); GetParam(mFilterCutoff)-&gt;SetShape(2); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 5, 177, mFilterCutoff, &amp;smallKnobBitmap)); // Resonance knob: GetParam(mFilterResonance)-&gt;InitDouble("Resonance", 0.01, 0.01, 1.0, 0.001); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 61, 177, mFilterResonance, &amp;smallKnobBitmap));</code> <br> <br>   ,           <code>1.0</code> ,   <code>calculateFeedbackAmount</code>    , . <br>  <code>ProcessDoubleReplacing</code>     : <br> <br> <code class="cpp">leftOutput[i] = rightOutput[i] = mFilter.process(mOscillator.nextSample() * mEnvelopeGenerator.nextSample() * velocity / 127.0);</code> <br> <br>       .  <code>switch</code>   <code>Synthesis::OnParamChange</code> : <br> <br> <code class="cpp">case mFilterCutoff: mFilter.setCutoff(GetParam(paramIdx)-&gt;Value()); break; case mFilterResonance: mFilter.setResonance(GetParam(paramIdx)-&gt;Value()); break; case mFilterMode: mFilter.setFilterMode(static_cast&lt;Filter::FilterMode&gt;(GetParam(paramIdx)-&gt;Int())); break;</code> <br> <br>    .  -      . <br> <br>  <br> <br>  ‚Äî      .   ,   ,          . <br>      : <br> <br> <code class="cpp">buf0 += cutoff * (inputValue - buf0 + feedbackAmount * (buf0 - buf1));</code> <br> <br> ,   ,      ( <code>buf0 ‚Äì buf1</code> ),   <code>feedbackAmount</code> .    <code>calculateFeedbackAmount</code>  <code>feedbackAmount</code>  <code>resonance</code> , . .    ,   . <br> <br>  ,            .     ,  <i></i> ,      <a href="https://www.youtube.com/watch%3Fv%3DJWyMj6KxGHM"> </a> .    ,        ,       . <br> <br>  -12 /  -24 / <br>        !     24   .     <code>switch</code>  <code>Filter::process</code> : <br> <br> <code class="cpp">buf2 += cutoff * (buf1 - buf2); buf3 += cutoff * (buf2 ‚Äì buf3);</code> <br> <br>   :      ,       ,            .     ,       , , <a href="https://ccrma.stanford.edu/~Jos/filters/Filter_Stability.html"></a> (       ).     <code>switch</code> : <br> <br> <code class="cpp">switch (mode) { case FILTER_MODE_LOWPASS: return buf3; case FILTER_MODE_HIGHPASS: return inputValue - buf3; case FILTER_MODE_BANDPASS: return buf0 - buf3; default: return 0.0; }</code> <br> <br>   <code>buf1</code>  <code>buf3</code> ‚Äì      .    -24 /.     <code>buf2</code>  <code>buf3</code> ,        <code>private</code> <i>Filter.h</i> : <br> <br> <code class="cpp">double buf2; double buf3;</code> <br> <br>    ,   <code>buf0</code> c <code>buf1</code> : <br> <br> <code class="cpp">Filter() : // ... buf0(0.0), buf1(0.0), buf2(0.0), buf3(0.0) // ...</code> <br> <br>     , ,     :     .       . <br>          ? <br> <br>   <br>    .  ,           ,       . <br> -      <code>cutoff</code>   .      .    <code>cutoffMod</code> ,    ,       <code>cutoff</code>    .     <code><code>#include    private</code> : <br> <br> <code class="cpp">double cutoffMod;</code> <br> <br> : <br> <br> <code class="cpp">Filter() : cutoff(0.99), resonance(0.01), cutoffMod(0.0), // ...</code> <br> <br>         .   <code>private</code> : <br> <br> <code class="cpp">inline double getCalculatedCutoff() const { return fmax(fmin(cutoff + cutoffMod, 0.99), 0.01); };</code> <br> <br> <code>calculateFeedbackAmount</code>     : <br> <br> <code class="cpp">inline void calculateFeedbackAmount() { feedbackAmount = resonance + resonance/(1.0 - getCalculatedCutoff()); }</code> <br> <br>       <code>cutoffMod</code> .   <code>feedbackAmount</code>    ,     : <br> <br> <code class="cpp">inline void setCutoffMod(double newCutoffMod) { cutoffMod = newCutoffMod; calculateFeedbackAmount(); }</code> <br> <br> ,       .   <code>Filter::process</code>   : <br> <br> <code class="cpp">if (inputValue == 0.0) return inputValue; double calculatedCutoff = getCalculatedCutoff(); buf0 += calculatedCutoff * (inputValue - buf0 + feedbackAmount * (buf0 - buf1)); buf1 += calculatedCutoff * (buf0 - buf1); buf2 += calculatedCutoff * (buf1 - buf2); buf3 += calculatedCutoff * (buf2 ‚Äì buf3);</code> <br> <br>        ,    .    ,      ,   .     .     <code>cutoff</code>  <code>calculatedCutoff</code>   -. <br> <br> ,       ( <code>setCutoffMod</code> ),   <code>Synthesis</code>    ,     ,    .    ,        <code>cutoffMod</code> .    <code>filterEnvelopeAmount</code>    <code>-1</code>  <code>+1</code> .   GUI. <br> <br>   <code>private</code> <i>Synthesis.h</i>    : <br> <br> <code class="cpp">EnvelopeGenerator mFilterEnvelopeGenerator; double filterEnvelopeAmount;</code> <br> <br>       MIDI ,      <code>onNoteOn</code>  <code>onNoteOff</code> : <br> <br> <code class="cpp">inline void onNoteOn(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); mFilterEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); }; inline void onNoteOff(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); mFilterEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); };</code> <br> <br>    .   <code>ProcessDoubleReplacing</code>        : <br> <br> <code class="cpp">mFilter.setCutoffMod(mFilterEnvelopeGenerator.nextSample() * filterEnvelopeAmount);</code> <br> <br>  ,        <code>nextSample</code>  <code>filterEnvelopeAmount</code>     <code>cutoffMod</code> .     <code>filterEnvelopeAmount</code>  : <br> <br> <code class="cpp">Synthesis::Synthesis(IPlugInstanceInfo instanceInfo) : IPLUG_CTOR(kNumParams, kNumPrograms, instanceInfo), lastVirtualKeyboardNoteNumber(virtualKeyboardMinimumNoteNumber - 1), filterEnvelopeAmount(0.0) { // ... }</code> <br> <br>       <code>Synthesis::Reset</code> : <br> <br> <code class="cpp">mFilterEnvelopeGenerator.setSampleRate(GetSampleRate());</code> <br> <br>      <code>EParams</code> ,       .  <code>AttachGraphics</code>     : <br> <br> <code class="cpp">// Knobs for filter envelope // Attack knob GetParam(mFilterAttack)-&gt;InitDouble("Filter Env Attack", 0.01, 0.01, 10.0, 0.001); GetParam(mFilterAttack)-&gt;SetShape(3); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 139, 178, mFilterAttack, &amp;smallKnobBitmap)); // Decay knob: GetParam(mFilterDecay)-&gt;InitDouble("Filter Env Decay", 0.5, 0.01, 15.0, 0.001); GetParam(mFilterDecay)-&gt;SetShape(3); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 195, 178, mFilterDecay, &amp;smallKnobBitmap)); // Sustain knob: GetParam(mFilterSustain)-&gt;InitDouble("Filter Env Sustain", 0.1, 0.001, 1.0, 0.001); GetParam(mFilterSustain)-&gt;SetShape(2); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 251, 178, mFilterSustain, &amp;smallKnobBitmap)); // Release knob: GetParam(mFilterRelease)-&gt;InitDouble("Filter Env Release", 1.0, 0.001, 15.0, 0.001); GetParam(mFilterRelease)-&gt;SetShape(3); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 307, 178, mFilterRelease, &amp;smallKnobBitmap)); // Filter envelope amount knob: GetParam(mFilterEnvelopeAmount)-&gt;InitDouble("Filter Env Amount", 0.0, -1.0, 1.0, 0.001); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 363, 178, mFilterEnvelopeAmount, &amp;smallKnobBitmap));</code> <br> <br>     ,       <code>smallKnobBitmap</code> .                   .     ,    .  <code>Synthesis::OnParamChange</code>    <code>switch</code> : <br> <br> <code class="cpp">case mFilterAttack: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK, GetParam(paramIdx)-&gt;Value()); break; case mFilterDecay: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_DECAY, GetParam(paramIdx)-&gt;Value()); break; case mFilterSustain: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_SUSTAIN, GetParam(paramIdx)-&gt;Value()); break; case mFilterRelease: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE, GetParam(paramIdx)-&gt;Value()); break; case mFilterEnvelopeAmount: filterEnvelopeAmount = GetParam(paramIdx)-&gt;Value(); break;</code> <br> <br> ! <br>     !           (-   C1),   : <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/f5d/757/3f9/f5d7573f9b3a720fe5898d88ae477cfc.png"> <br> <br>        <code>EnvelopeGenerator</code>  .         .        ! <br> <br>    <a href=""></a> . <br> <br>        :) <br> <br>  : <br> <a href="http://martin-finke.de/blog/articles/audio-plugins-013-filter/">martin-finke.de/blog/articles/audio-plugins-013-filter</a></code></code> <pre> <code class="hljs erlang-repl"><code class="cpp"><code class="cpp">#include  <i>Filter.h</i> ( )     : <br> <br> class Filter { public: enum FilterMode { FILTER_MODE_LOWPASS = <span class="hljs-number"><span class="hljs-number">0</span></span>, FILTER_MODE_HIGHPASS, FILTER_MODE_BANDPASS, kNumFilterModes }; Filter() : cutoff(<span class="hljs-number"><span class="hljs-number">0.99</span></span>), resonance(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), mode(FILTER_MODE_LOWPASS), buf0(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), buf1(<span class="hljs-number"><span class="hljs-number">0.0</span></span>) { calculateFeedbackAmount(); }; double process(double inputValue); inline void setCutoff(double newCutoff) { cutoff = newCutoff; calculateFeedbackAmount(); }; inline void setResonance(double newResonance) { resonance = newResonance; calculateFeedbackAmount(); }; inline void setFilterMode(FilterMode newMode) { mode = newMode; } private: double cutoff; double resonance; FilterMode mode; double feedbackAmount; inline void calculateFeedbackAmount() { feedbackAmount = resonance + resonance/(<span class="hljs-number"><span class="hljs-number">1.0</span></span> - cutoff); } double buf0; double buf1; };</code> <br> <br>  <code>private</code>     <i> </i> <code>cutoff</code>  <i></i> <code>resonance</code> . <code>Mode</code>      (Lowpass, Highpass, Bandpass).  <code>feedbackAmount</code> , <code>buf0</code>  <code>buf1</code>    ,    . <br>          ( <code>calculateFeedbackAmount()</code> ).  <code>process</code>      .   <code>feedbackAmount</code>   <code>cutoff</code>  <code>resonance</code> ,    <code>calculateFeedbackAmount</code>      . <br> <br>   <i>Filter.cpp</i>  : <br> <br> <code class="cpp">// By Paul Kellett // http://www.musicdsp.org/showone.php?id=<span class="hljs-number"><span class="hljs-number">29</span></span> double Filter::process(double inputValue) { buf0 += cutoff * (inputValue - buf0); buf1 += cutoff * (buf0 - buf1); switch (mode) { case FILTER_MODE_LOWPASS: return buf1; case FILTER_MODE_HIGHPASS: return inputValue - buf0; case FILTER_MODE_BANDPASS: return buf0 - buf1; default: return <span class="hljs-number"><span class="hljs-number">0.0</span></span>; } }</code> <br> <br> , ?  ,         <i> </i> . ¬´ ¬ª   ,               (. .    <span class="hljs-number"><span class="hljs-number">6</span></span> ).     <code>buf0</code>  <code>buf1</code> :        .     <code>inputValue</code> ,  - <code>buf0</code> (  ).   .    <span class="hljs-number"><span class="hljs-number">6</span></span> /   <span class="hljs-number"><span class="hljs-number">12</span></span> /.  <code>switch</code> ,  <code>buf1</code>    . , ,    <code>buf0</code> ,       <span class="hljs-number"><span class="hljs-number">12</span></span>,   <span class="hljs-number"><span class="hljs-number">6</span></span> /,        . <br> <br>  <code>case</code> <code>FILTER_MODE_HIGHPASS</code>    . <code>buf0</code>       .   <code>inputValue</code>  <code>buf0</code> ,   .    <code>buf1</code> ,     . <br> <br>  <code>case</code> <code>FILTER_MODE_BANDPASS</code> ,  <code>buf0 - buf1</code>   .  <code>buf0</code>       ,     <code>buf1</code> . ,   . <br>  :    <i> </i>    <i> </i> ,   . <br> <br>  <code>buf1</code>     .       <a href="http://ru.wikipedia.org/wiki/%25D0%25A4%25D0%25B8%25D0%25BB%25D1%258C%25D1%2582%25D1%2580_%25D1%2581_%25D0%25B1%25D0%25B5%25D1%2581%25D0%25BA%25D0%25BE%25D0%25BD%25D0%25B5%25D1%2587%25D0%25BD%25D0%25BE%25D0%25B9_%25D0%25B8%25D0%25BC%25D0%25BF%25D1%2583%25D0%25BB%25D1%258C%25D1%2581%25D0%25BD%25D0%25BE%25D0%25B9_%25D1%2585%25D0%25B0%25D1%2580%25D0%25B0%25D0%25BA%25D1%2582%25D0%25B5%25D1%2580%25D0%25B8%25D1%2581%25D1%2582%25D0%25B8%25D0%25BA%25D0%25BE%25D0%25B9">    </a> ( <i>Infinite Impulse Response</i> ,  <i>IIR</i> ).  <a href="http://www.dspguide.com/ch14/1.htm"> </a> ,      .      ,         ,      . <br> <br>   <br>       ,     ,     .   ,  ,      ,  ,          .           ,  NI Massive,   ¬´ <a href="http://lurkmore.to/%25D0%25A2%25D1%2591%25D0%25BF%25D0%25BB%25D1%258B%25D0%25B9_%25D0%25BB%25D0%25B0%25D0%25BC%25D0%25BF%25D0%25BE%25D0%25B2%25D1%258B%25D0%25B9_%25D0%25B7%25D0%25B2%25D1%2583%25D0%25BA">  </a> ¬ª.       ,          ,   .        ,          (  Massive       ).      ¬´¬ª , , , AAS Ultra Analog,       ,     ,    ,        .         ,  ,    <a href="http://www.kvraudio.com/forum/viewtopic.php%3Ft%3D350246"></a> ,   ,      NI Reaktor. ,            ‚Äî    ,    ..     . <br> <br>   <br>     .   GUI.  <i>bg.png</i>   ( <i>‚ÄúMove to trash‚Äù</i>  Xcode),       : <br> <br> <a href="">filtermode.png</a> <a href="">knob_small.png</a> (  ,   <span class="hljs-number"><span class="hljs-number">50</span></span> <span class="hljs-number"><span class="hljs-number">50</span></span> ) <a href="">bg.png</a> (       ) <br> <br>    ID  <i>resource.h</i> : <br> <br> <code class="cpp">// Unique IDs for each image resource. #define BG_ID <span class="hljs-number"><span class="hljs-number">101</span></span> #define WHITE_KEY_ID <span class="hljs-number"><span class="hljs-number">102</span></span> #define BLACK_KEY_ID <span class="hljs-number"><span class="hljs-number">103</span></span> #define WAVEFORM_ID <span class="hljs-number"><span class="hljs-number">104</span></span> #define KNOB_ID <span class="hljs-number"><span class="hljs-number">105</span></span> #define KNOB_SMALL_ID <span class="hljs-number"><span class="hljs-number">106</span></span> #define FILTERMODE_ID <span class="hljs-number"><span class="hljs-number">107</span></span> // Image resource locations for this plug. #define BG_FN <span class="hljs-string"><span class="hljs-string">"resources/img/bg.png"</span></span> #define WHITE_KEY_FN <span class="hljs-string"><span class="hljs-string">"resources/img/whitekey.png"</span></span> #define BLACK_KEY_FN <span class="hljs-string"><span class="hljs-string">"resources/img/blackkey.png"</span></span> #define WAVEFORM_FN <span class="hljs-string"><span class="hljs-string">"resources/img/waveform.png"</span></span> #define KNOB_FN <span class="hljs-string"><span class="hljs-string">"resources/img/knob.png"</span></span> #define KNOB_SMALL_FN <span class="hljs-string"><span class="hljs-string">"resources/img/knob_small.png"</span></span> #define FILTERMODE_FN <span class="hljs-string"><span class="hljs-string">"resources/img/filtermode.png"</span></span></code> <br> <br>  <i>Synthesis.rc</i> : <br> <br> <code class="cpp">#include <span class="hljs-string"><span class="hljs-string">"resource.h"</span></span> BG_ID PNG BG_FN WHITE_KEY_ID PNG WHITE_KEY_FN BLACK_KEY_ID PNG BLACK_KEY_FN WAVEFORM_ID PNG WAVEFORM_FN KNOB_ID PNG KNOB_FN KNOB_SMALL_ID PNG KNOB_SMALL_FN FILTERMODE_ID PNG FILTERMODE_FN</code> <br> <br>   <code>#include <span class="hljs-string"><span class="hljs-string">"Filter.h"</span></span></code>  <i>Synthesis.h</i>    <code>private</code> : <br> <br> <code class="cpp">Filter mFilter;</code> <br> <br>  <code>EParams</code>  <i>Synthesis.cpp</i> : <br> <br> <code class="cpp">enum EParams { mWaveform = <span class="hljs-number"><span class="hljs-number">0</span></span>, mAttack, mDecay, mSustain, mRelease, mFilterMode, mFilterCutoff, mFilterResonance, mFilterAttack, mFilterDecay, mFilterSustain, mFilterRelease, mFilterEnvelopeAmount, kNumParams };</code> <br> <br>        : <br> <br> <code class="cpp">pGraphics-&gt;AttachControl(new ISwitchControl(this, <span class="hljs-number"><span class="hljs-number">24</span></span>, <span class="hljs-number"><span class="hljs-number">38</span></span>, mWaveform, &amp;waveformBitmap));</code> <br> <br>      .      (Lowpass, Highpass, Bandpass).    <code>AttachGraphics(pGraphics)</code> : <br> <br> <code class="cpp">GetParam(mFilterMode)-&gt;InitEnum(<span class="hljs-string"><span class="hljs-string">"Filter Mode"</span></span>, Filter::FILTER_MODE_LOWPASS, Filter::kNumFilterModes); IBitmap filtermodeBitmap = pGraphics-&gt;LoadIBitmap(FILTERMODE_ID, FILTERMODE_FN, <span class="hljs-number"><span class="hljs-number">3</span></span>); pGraphics-&gt;AttachControl(new ISwitchControl(this, <span class="hljs-number"><span class="hljs-number">24</span></span>, <span class="hljs-number"><span class="hljs-number">123</span></span>, mFilterMode, &amp;filtermodeBitmap));</code> <br> <br>         .    .     <i>knob_small.png</i> : <br> <br> <code class="cpp">// Knobs for filter cutoff and resonance IBitmap smallKnobBitmap = pGraphics-&gt;LoadIBitmap(KNOB_SMALL_ID, KNOB_SMALL_FN, <span class="hljs-number"><span class="hljs-number">64</span></span>); // Cutoff knob: GetParam(mFilterCutoff)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Cutoff"</span></span>, <span class="hljs-number"><span class="hljs-number">0.99</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">0.99</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); GetParam(mFilterCutoff)-&gt;SetShape(<span class="hljs-number"><span class="hljs-number">2</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-number"><span class="hljs-number">177</span></span>, mFilterCutoff, &amp;smallKnobBitmap)); // Resonance knob: GetParam(mFilterResonance)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Resonance"</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">61</span></span>, <span class="hljs-number"><span class="hljs-number">177</span></span>, mFilterResonance, &amp;smallKnobBitmap));</code> <br> <br>   ,           <code><span class="hljs-number"><span class="hljs-number">1.0</span></span></code> ,   <code>calculateFeedbackAmount</code>    , . <br>  <code>ProcessDoubleReplacing</code>     : <br> <br> <code class="cpp">leftOutput[i] = rightOutput[i] = mFilter.process(mOscillator.nextSample() * mEnvelopeGenerator.nextSample() * velocity / <span class="hljs-number"><span class="hljs-number">127.0</span></span>);</code> <br> <br>       .  <code>switch</code>   <code>Synthesis::OnParamChange</code> : <br> <br> <code class="cpp">case mFilterCutoff: mFilter.setCutoff(GetParam(paramIdx)-&gt;Value()); break; case mFilterResonance: mFilter.setResonance(GetParam(paramIdx)-&gt;Value()); break; case mFilterMode: mFilter.setFilterMode(static_cast&lt;Filter::FilterMode&gt;(GetParam(paramIdx)-&gt;Int())); break;</code> <br> <br>    .  -      . <br> <br>  <br> <br>  ‚Äî      .   ,   ,          . <br>      : <br> <br> buf0 += cutoff * (inputValue - buf0 + feedbackAmount * (buf0 - buf1)); <br> <br> ,   ,      ( <code>buf0 ‚Äì buf1</code> ),   <code>feedbackAmount</code> .    <code>calculateFeedbackAmount</code>  <code>feedbackAmount</code>  <code>resonance</code> , . .    ,   . <br> <br>  ,            .     ,  <i></i> ,      <a href="https://www.youtube.com/watch%3Fv%3DJWyMj6KxGHM"> </a> .    ,        ,       . <br> <br>  -<span class="hljs-number"><span class="hljs-number">12</span></span> /  -<span class="hljs-number"><span class="hljs-number">24</span></span> / <br>        !     <span class="hljs-number"><span class="hljs-number">24</span></span>   .     <code>switch</code>  <code>Filter::process</code> : <br> <br> <code class="cpp">buf2 += cutoff * (buf1 - buf2); buf3 += cutoff * (buf2 ‚Äì buf3);</code> <br> <br>   :      ,       ,            .     ,       , , <a href="https://ccrma.stanford.edu/~Jos/filters/Filter_Stability.html"></a> (       ).     <code>switch</code> : <br> <br> <code class="cpp">switch (mode) { case FILTER_MODE_LOWPASS: return buf3; case FILTER_MODE_HIGHPASS: return inputValue - buf3; case FILTER_MODE_BANDPASS: return buf0 - buf3; default: return <span class="hljs-number"><span class="hljs-number">0.0</span></span>; }</code> <br> <br>   <code>buf1</code>  <code>buf3</code> ‚Äì      .    -<span class="hljs-number"><span class="hljs-number">24</span></span> /.     <code>buf2</code>  <code>buf3</code> ,        <code>private</code> <i>Filter.h</i> : <br> <br> <code class="cpp">double buf2; double buf3;</code> <br> <br>    ,   <code>buf0</code> c <code>buf1</code> : <br> <br> <code class="cpp">Filter() : // ... buf0(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), buf1(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), buf2(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), buf3(<span class="hljs-number"><span class="hljs-number">0.0</span></span>) // ...</code> <br> <br>     , ,     :     .       . <br>          ? <br> <br>   <br>    .  ,           ,       . <br> -      <code>cutoff</code>   .      .    <code>cutoffMod</code> ,    ,       <code>cutoff</code>    .     <code><code>#include    private</code> : <br> <br> <code class="cpp">double cutoffMod;</code> <br> <br> : <br> <br> <code class="cpp">Filter() : cutoff(<span class="hljs-number"><span class="hljs-number">0.99</span></span>), resonance(<span class="hljs-number"><span class="hljs-number">0.01</span></span>), cutoffMod(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), // ...</code> <br> <br>         .   <code>private</code> : <br> <br> <code class="cpp">inline double getCalculatedCutoff() const { return fmax(fmin(cutoff + cutoffMod, <span class="hljs-number"><span class="hljs-number">0.99</span></span>), <span class="hljs-number"><span class="hljs-number">0.01</span></span>); };</code> <br> <br> <code>calculateFeedbackAmount</code>     : <br> <br> <code class="cpp">inline void calculateFeedbackAmount() { feedbackAmount = resonance + resonance/(<span class="hljs-number"><span class="hljs-number">1.0</span></span> - getCalculatedCutoff()); }</code> <br> <br>       <code>cutoffMod</code> .   <code>feedbackAmount</code>    ,     : <br> <br> <code class="cpp">inline void setCutoffMod(double newCutoffMod) { cutoffMod = newCutoffMod; calculateFeedbackAmount(); }</code> <br> <br> ,       .   <code>Filter::process</code>   : <br> <br> <code class="cpp">if (inputValue == <span class="hljs-number"><span class="hljs-number">0.0</span></span>) return inputValue; double calculatedCutoff = getCalculatedCutoff(); buf0 += calculatedCutoff * (inputValue - buf0 + feedbackAmount * (buf0 - buf1)); buf1 += calculatedCutoff * (buf0 - buf1); buf2 += calculatedCutoff * (buf1 - buf2); buf3 += calculatedCutoff * (buf2 ‚Äì buf3);</code> <br> <br>        ,    .    ,      ,   .     .     <code>cutoff</code>  <code>calculatedCutoff</code>   -. <br> <br> ,       ( <code>setCutoffMod</code> ),   <code>Synthesis</code>    ,     ,    .    ,        <code>cutoffMod</code> .    <code>filterEnvelopeAmount</code>    <code>-<span class="hljs-number"><span class="hljs-number">1</span></span></code>  <code>+<span class="hljs-number"><span class="hljs-number">1</span></span></code> .   GUI. <br> <br>   <code>private</code> <i>Synthesis.h</i>    : <br> <br> <code class="cpp">EnvelopeGenerator mFilterEnvelopeGenerator; double filterEnvelopeAmount;</code> <br> <br>       MIDI ,      <code>onNoteOn</code>  <code>onNoteOff</code> : <br> <br> <code class="cpp">inline void onNoteOn(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); mFilterEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); }; inline void onNoteOff(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); mFilterEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); };</code> <br> <br>    .   <code>ProcessDoubleReplacing</code>        : <br> <br> <code class="cpp">mFilter.setCutoffMod(mFilterEnvelopeGenerator.nextSample() * filterEnvelopeAmount);</code> <br> <br>  ,        <code>nextSample</code>  <code>filterEnvelopeAmount</code>     <code>cutoffMod</code> .     <code>filterEnvelopeAmount</code>  : <br> <br> <code class="cpp">Synthesis::Synthesis(IPlugInstanceInfo instanceInfo) : IPLUG_CTOR(kNumParams, kNumPrograms, instanceInfo), lastVirtualKeyboardNoteNumber(virtualKeyboardMinimumNoteNumber - <span class="hljs-number"><span class="hljs-number">1</span></span>), filterEnvelopeAmount(<span class="hljs-number"><span class="hljs-number">0.0</span></span>) { // ... }</code> <br> <br>       <code>Synthesis::Reset</code> : <br> <br> <code class="cpp">mFilterEnvelopeGenerator.setSampleRate(GetSampleRate());</code> <br> <br>      <code>EParams</code> ,       .  <code>AttachGraphics</code>     : <br> <br> <code class="cpp">// Knobs for filter envelope // Attack knob GetParam(mFilterAttack)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Filter Env Attack"</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">10.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); GetParam(mFilterAttack)-&gt;SetShape(<span class="hljs-number"><span class="hljs-number">3</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">139</span></span>, <span class="hljs-number"><span class="hljs-number">178</span></span>, mFilterAttack, &amp;smallKnobBitmap)); // Decay knob: GetParam(mFilterDecay)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Filter Env Decay"</span></span>, <span class="hljs-number"><span class="hljs-number">0.5</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">15.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); GetParam(mFilterDecay)-&gt;SetShape(<span class="hljs-number"><span class="hljs-number">3</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">195</span></span>, <span class="hljs-number"><span class="hljs-number">178</span></span>, mFilterDecay, &amp;smallKnobBitmap)); // Sustain knob: GetParam(mFilterSustain)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Filter Env Sustain"</span></span>, <span class="hljs-number"><span class="hljs-number">0.1</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>, <span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); GetParam(mFilterSustain)-&gt;SetShape(<span class="hljs-number"><span class="hljs-number">2</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">251</span></span>, <span class="hljs-number"><span class="hljs-number">178</span></span>, mFilterSustain, &amp;smallKnobBitmap)); // Release knob: GetParam(mFilterRelease)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Filter Env Release"</span></span>, <span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>, <span class="hljs-number"><span class="hljs-number">15.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); GetParam(mFilterRelease)-&gt;SetShape(<span class="hljs-number"><span class="hljs-number">3</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">307</span></span>, <span class="hljs-number"><span class="hljs-number">178</span></span>, mFilterRelease, &amp;smallKnobBitmap)); // Filter envelope amount knob: GetParam(mFilterEnvelopeAmount)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Filter Env Amount"</span></span>, <span class="hljs-number"><span class="hljs-number">0.0</span></span>, -<span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">363</span></span>, <span class="hljs-number"><span class="hljs-number">178</span></span>, mFilterEnvelopeAmount, &amp;smallKnobBitmap));</code> <br> <br>     ,       <code>smallKnobBitmap</code> .                   .     ,    .  <code>Synthesis::OnParamChange</code>    <code>switch</code> : <br> <br> <code class="cpp">case mFilterAttack: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK, GetParam(paramIdx)-&gt;Value()); break; case mFilterDecay: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_DECAY, GetParam(paramIdx)-&gt;Value()); break; case mFilterSustain: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_SUSTAIN, GetParam(paramIdx)-&gt;Value()); break; case mFilterRelease: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE, GetParam(paramIdx)-&gt;Value()); break; case mFilterEnvelopeAmount: filterEnvelopeAmount = GetParam(paramIdx)-&gt;Value(); break;</code> <br> <br> ! <br>     !           (-   C1),   : <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/f5d/757/3f9/f5d7573f9b3a720fe5898d88ae477cfc.png"> <br> <br>        <code>EnvelopeGenerator</code>  .         .        ! <br> <br>    <a href=""></a> . <br> <br>        :) <br> <br>  : <br> <a href="http://martin-finke.de/blog/articles/audio-plugins-013-filter/">martin-finke.de/blog/articles/audio-plugins-<span class="hljs-number"><span class="hljs-number">013</span></span>-filter</a></code></code></code> </pre> <code><code class="cpp">#include  <i>Filter.h</i> ( )     : <br> <br> class Filter { public: enum FilterMode { FILTER_MODE_LOWPASS = 0, FILTER_MODE_HIGHPASS, FILTER_MODE_BANDPASS, kNumFilterModes }; Filter() : cutoff(0.99), resonance(0.0), mode(FILTER_MODE_LOWPASS), buf0(0.0), buf1(0.0) { calculateFeedbackAmount(); }; double process(double inputValue); inline void setCutoff(double newCutoff) { cutoff = newCutoff; calculateFeedbackAmount(); }; inline void setResonance(double newResonance) { resonance = newResonance; calculateFeedbackAmount(); }; inline void setFilterMode(FilterMode newMode) { mode = newMode; } private: double cutoff; double resonance; FilterMode mode; double feedbackAmount; inline void calculateFeedbackAmount() { feedbackAmount = resonance + resonance/(1.0 - cutoff); } double buf0; double buf1; };</code> <br> <br>  <code>private</code>     <i> </i> <code>cutoff</code>  <i></i> <code>resonance</code> . <code>Mode</code>      (Lowpass, Highpass, Bandpass).  <code>feedbackAmount</code> , <code>buf0</code>  <code>buf1</code>    ,    . <br>          ( <code>calculateFeedbackAmount()</code> ).  <code>process</code>      .   <code>feedbackAmount</code>   <code>cutoff</code>  <code>resonance</code> ,    <code>calculateFeedbackAmount</code>      . <br> <br>   <i>Filter.cpp</i>  : <br> <br> <code class="cpp">// By Paul Kellett // http://www.musicdsp.org/showone.php?id=29 double Filter::process(double inputValue) { buf0 += cutoff * (inputValue - buf0); buf1 += cutoff * (buf0 - buf1); switch (mode) { case FILTER_MODE_LOWPASS: return buf1; case FILTER_MODE_HIGHPASS: return inputValue - buf0; case FILTER_MODE_BANDPASS: return buf0 - buf1; default: return 0.0; } }</code> <br> <br> , ?  ,         <i> </i> . ¬´ ¬ª   ,               (. .    6 ).     <code>buf0</code>  <code>buf1</code> :        .     <code>inputValue</code> ,  - <code>buf0</code> (  ).   .    6 /   12 /.  <code>switch</code> ,  <code>buf1</code>    . , ,    <code>buf0</code> ,       12,   6 /,        . <br> <br>  <code>case</code> <code>FILTER_MODE_HIGHPASS</code>    . <code>buf0</code>       .   <code>inputValue</code>  <code>buf0</code> ,   .    <code>buf1</code> ,     . <br> <br>  <code>case</code> <code>FILTER_MODE_BANDPASS</code> ,  <code>buf0 - buf1</code>   .  <code>buf0</code>       ,     <code>buf1</code> . ,   . <br>  :    <i> </i>    <i> </i> ,   . <br> <br>  <code>buf1</code>     .       <a href="http://ru.wikipedia.org/wiki/%25D0%25A4%25D0%25B8%25D0%25BB%25D1%258C%25D1%2582%25D1%2580_%25D1%2581_%25D0%25B1%25D0%25B5%25D1%2581%25D0%25BA%25D0%25BE%25D0%25BD%25D0%25B5%25D1%2587%25D0%25BD%25D0%25BE%25D0%25B9_%25D0%25B8%25D0%25BC%25D0%25BF%25D1%2583%25D0%25BB%25D1%258C%25D1%2581%25D0%25BD%25D0%25BE%25D0%25B9_%25D1%2585%25D0%25B0%25D1%2580%25D0%25B0%25D0%25BA%25D1%2582%25D0%25B5%25D1%2580%25D0%25B8%25D1%2581%25D1%2582%25D0%25B8%25D0%25BA%25D0%25BE%25D0%25B9">    </a> ( <i>Infinite Impulse Response</i> ,  <i>IIR</i> ).  <a href="http://www.dspguide.com/ch14/1.htm"> </a> ,      .      ,         ,      . <br> <br>   <br>       ,     ,     .   ,  ,      ,  ,          .           ,  NI Massive,   ¬´ <a href="http://lurkmore.to/%25D0%25A2%25D1%2591%25D0%25BF%25D0%25BB%25D1%258B%25D0%25B9_%25D0%25BB%25D0%25B0%25D0%25BC%25D0%25BF%25D0%25BE%25D0%25B2%25D1%258B%25D0%25B9_%25D0%25B7%25D0%25B2%25D1%2583%25D0%25BA">  </a> ¬ª.       ,          ,   .        ,          (  Massive       ).      ¬´¬ª , , , AAS Ultra Analog,       ,     ,    ,        .         ,  ,    <a href="http://www.kvraudio.com/forum/viewtopic.php%3Ft%3D350246"></a> ,   ,      NI Reaktor. ,            ‚Äî    ,    ..     . <br> <br>   <br>     .   GUI.  <i>bg.png</i>   ( <i>‚ÄúMove to trash‚Äù</i>  Xcode),       : <br> <br> <a href="">filtermode.png</a> <a href="">knob_small.png</a> (  ,   50 50 ) <a href="">bg.png</a> (       ) <br> <br>    ID  <i>resource.h</i> : <br> <br> <code class="cpp">// Unique IDs for each image resource. #define BG_ID 101 #define WHITE_KEY_ID 102 #define BLACK_KEY_ID 103 #define WAVEFORM_ID 104 #define KNOB_ID 105 #define KNOB_SMALL_ID 106 #define FILTERMODE_ID 107 // Image resource locations for this plug. #define BG_FN "resources/img/bg.png" #define WHITE_KEY_FN "resources/img/whitekey.png" #define BLACK_KEY_FN "resources/img/blackkey.png" #define WAVEFORM_FN "resources/img/waveform.png" #define KNOB_FN "resources/img/knob.png" #define KNOB_SMALL_FN "resources/img/knob_small.png" #define FILTERMODE_FN "resources/img/filtermode.png"</code> <br> <br>  <i>Synthesis.rc</i> : <br> <br> <code class="cpp">#include "resource.h" BG_ID PNG BG_FN WHITE_KEY_ID PNG WHITE_KEY_FN BLACK_KEY_ID PNG BLACK_KEY_FN WAVEFORM_ID PNG WAVEFORM_FN KNOB_ID PNG KNOB_FN KNOB_SMALL_ID PNG KNOB_SMALL_FN FILTERMODE_ID PNG FILTERMODE_FN</code> <br> <br>   <code>#include "Filter.h"</code>  <i>Synthesis.h</i>    <code>private</code> : <br> <br> <code class="cpp">Filter mFilter;</code> <br> <br>  <code>EParams</code>  <i>Synthesis.cpp</i> : <br> <br> <code class="cpp">enum EParams { mWaveform = 0, mAttack, mDecay, mSustain, mRelease, mFilterMode, mFilterCutoff, mFilterResonance, mFilterAttack, mFilterDecay, mFilterSustain, mFilterRelease, mFilterEnvelopeAmount, kNumParams };</code> <br> <br>        : <br> <br> <code class="cpp">pGraphics-&gt;AttachControl(new ISwitchControl(this, 24, 38, mWaveform, &amp;waveformBitmap));</code> <br> <br>      .      (Lowpass, Highpass, Bandpass).    <code>AttachGraphics(pGraphics)</code> : <br> <br> <code class="cpp">GetParam(mFilterMode)-&gt;InitEnum("Filter Mode", Filter::FILTER_MODE_LOWPASS, Filter::kNumFilterModes); IBitmap filtermodeBitmap = pGraphics-&gt;LoadIBitmap(FILTERMODE_ID, FILTERMODE_FN, 3); pGraphics-&gt;AttachControl(new ISwitchControl(this, 24, 123, mFilterMode, &amp;filtermodeBitmap));</code> <br> <br>         .    .     <i>knob_small.png</i> : <br> <br> <code class="cpp">// Knobs for filter cutoff and resonance IBitmap smallKnobBitmap = pGraphics-&gt;LoadIBitmap(KNOB_SMALL_ID, KNOB_SMALL_FN, 64); // Cutoff knob: GetParam(mFilterCutoff)-&gt;InitDouble("Cutoff", 0.99, 0.01, 0.99, 0.001); GetParam(mFilterCutoff)-&gt;SetShape(2); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 5, 177, mFilterCutoff, &amp;smallKnobBitmap)); // Resonance knob: GetParam(mFilterResonance)-&gt;InitDouble("Resonance", 0.01, 0.01, 1.0, 0.001); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 61, 177, mFilterResonance, &amp;smallKnobBitmap));</code> <br> <br>   ,           <code>1.0</code> ,   <code>calculateFeedbackAmount</code>    , . <br>  <code>ProcessDoubleReplacing</code>     : <br> <br> <code class="cpp">leftOutput[i] = rightOutput[i] = mFilter.process(mOscillator.nextSample() * mEnvelopeGenerator.nextSample() * velocity / 127.0);</code> <br> <br>       .  <code>switch</code>   <code>Synthesis::OnParamChange</code> : <br> <br> <code class="cpp">case mFilterCutoff: mFilter.setCutoff(GetParam(paramIdx)-&gt;Value()); break; case mFilterResonance: mFilter.setResonance(GetParam(paramIdx)-&gt;Value()); break; case mFilterMode: mFilter.setFilterMode(static_cast&lt;Filter::FilterMode&gt;(GetParam(paramIdx)-&gt;Int())); break;</code> <br> <br>    .  -      . <br> <br>  <br> <br>  ‚Äî      .   ,   ,          . <br>      : <br> <br> <code class="cpp">buf0 += cutoff * (inputValue - buf0 + feedbackAmount * (buf0 - buf1));</code> <br> <br> ,   ,      ( <code>buf0 ‚Äì buf1</code> ),   <code>feedbackAmount</code> .    <code>calculateFeedbackAmount</code>  <code>feedbackAmount</code>  <code>resonance</code> , . .    ,   . <br> <br>  ,            .     ,  <i></i> ,      <a href="https://www.youtube.com/watch%3Fv%3DJWyMj6KxGHM"> </a> .    ,        ,       . <br> <br>  -12 /  -24 / <br>        !     24   .     <code>switch</code>  <code>Filter::process</code> : <br> <br> <code class="cpp">buf2 += cutoff * (buf1 - buf2); buf3 += cutoff * (buf2 ‚Äì buf3);</code> <br> <br>   :      ,       ,            .     ,       , , <a href="https://ccrma.stanford.edu/~Jos/filters/Filter_Stability.html"></a> (       ).     <code>switch</code> : <br> <br> <code class="cpp">switch (mode) { case FILTER_MODE_LOWPASS: return buf3; case FILTER_MODE_HIGHPASS: return inputValue - buf3; case FILTER_MODE_BANDPASS: return buf0 - buf3; default: return 0.0; }</code> <br> <br>   <code>buf1</code>  <code>buf3</code> ‚Äì      .    -24 /.     <code>buf2</code>  <code>buf3</code> ,        <code>private</code> <i>Filter.h</i> : <br> <br> <code class="cpp">double buf2; double buf3;</code> <br> <br>    ,   <code>buf0</code> c <code>buf1</code> : <br> <br> <code class="cpp">Filter() : // ... buf0(0.0), buf1(0.0), buf2(0.0), buf3(0.0) // ...</code> <br> <br>     , ,     :     .       . <br>          ? <br> <br>   <br>    .  ,           ,       . <br> -      <code>cutoff</code>   .      .    <code>cutoffMod</code> ,    ,       <code>cutoff</code>    .     <code><code>#include    private</code> : <br> <br> <code class="cpp">double cutoffMod;</code> <br> <br> : <br> <br> <code class="cpp">Filter() : cutoff(0.99), resonance(0.01), cutoffMod(0.0), // ...</code> <br> <br>         .   <code>private</code> : <br> <br> <code class="cpp">inline double getCalculatedCutoff() const { return fmax(fmin(cutoff + cutoffMod, 0.99), 0.01); };</code> <br> <br> <code>calculateFeedbackAmount</code>     : <br> <br> <code class="cpp">inline void calculateFeedbackAmount() { feedbackAmount = resonance + resonance/(1.0 - getCalculatedCutoff()); }</code> <br> <br>       <code>cutoffMod</code> .   <code>feedbackAmount</code>    ,     : <br> <br> <code class="cpp">inline void setCutoffMod(double newCutoffMod) { cutoffMod = newCutoffMod; calculateFeedbackAmount(); }</code> <br> <br> ,       .   <code>Filter::process</code>   : <br> <br> <code class="cpp">if (inputValue == 0.0) return inputValue; double calculatedCutoff = getCalculatedCutoff(); buf0 += calculatedCutoff * (inputValue - buf0 + feedbackAmount * (buf0 - buf1)); buf1 += calculatedCutoff * (buf0 - buf1); buf2 += calculatedCutoff * (buf1 - buf2); buf3 += calculatedCutoff * (buf2 ‚Äì buf3);</code> <br> <br>        ,    .    ,      ,   .     .     <code>cutoff</code>  <code>calculatedCutoff</code>   -. <br> <br> ,       ( <code>setCutoffMod</code> ),   <code>Synthesis</code>    ,     ,    .    ,        <code>cutoffMod</code> .    <code>filterEnvelopeAmount</code>    <code>-1</code>  <code>+1</code> .   GUI. <br> <br>   <code>private</code> <i>Synthesis.h</i>    : <br> <br> <code class="cpp">EnvelopeGenerator mFilterEnvelopeGenerator; double filterEnvelopeAmount;</code> <br> <br>       MIDI ,      <code>onNoteOn</code>  <code>onNoteOff</code> : <br> <br> <code class="cpp">inline void onNoteOn(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); mFilterEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); }; inline void onNoteOff(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); mFilterEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); };</code> <br> <br>    .   <code>ProcessDoubleReplacing</code>        : <br> <br> <code class="cpp">mFilter.setCutoffMod(mFilterEnvelopeGenerator.nextSample() * filterEnvelopeAmount);</code> <br> <br>  ,        <code>nextSample</code>  <code>filterEnvelopeAmount</code>     <code>cutoffMod</code> .     <code>filterEnvelopeAmount</code>  : <br> <br> <code class="cpp">Synthesis::Synthesis(IPlugInstanceInfo instanceInfo) : IPLUG_CTOR(kNumParams, kNumPrograms, instanceInfo), lastVirtualKeyboardNoteNumber(virtualKeyboardMinimumNoteNumber - 1), filterEnvelopeAmount(0.0) { // ... }</code> <br> <br>       <code>Synthesis::Reset</code> : <br> <br> <code class="cpp">mFilterEnvelopeGenerator.setSampleRate(GetSampleRate());</code> <br> <br>      <code>EParams</code> ,       .  <code>AttachGraphics</code>     : <br> <br> <code class="cpp">// Knobs for filter envelope // Attack knob GetParam(mFilterAttack)-&gt;InitDouble("Filter Env Attack", 0.01, 0.01, 10.0, 0.001); GetParam(mFilterAttack)-&gt;SetShape(3); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 139, 178, mFilterAttack, &amp;smallKnobBitmap)); // Decay knob: GetParam(mFilterDecay)-&gt;InitDouble("Filter Env Decay", 0.5, 0.01, 15.0, 0.001); GetParam(mFilterDecay)-&gt;SetShape(3); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 195, 178, mFilterDecay, &amp;smallKnobBitmap)); // Sustain knob: GetParam(mFilterSustain)-&gt;InitDouble("Filter Env Sustain", 0.1, 0.001, 1.0, 0.001); GetParam(mFilterSustain)-&gt;SetShape(2); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 251, 178, mFilterSustain, &amp;smallKnobBitmap)); // Release knob: GetParam(mFilterRelease)-&gt;InitDouble("Filter Env Release", 1.0, 0.001, 15.0, 0.001); GetParam(mFilterRelease)-&gt;SetShape(3); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 307, 178, mFilterRelease, &amp;smallKnobBitmap)); // Filter envelope amount knob: GetParam(mFilterEnvelopeAmount)-&gt;InitDouble("Filter Env Amount", 0.0, -1.0, 1.0, 0.001); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 363, 178, mFilterEnvelopeAmount, &amp;smallKnobBitmap));</code> <br> <br>     ,       <code>smallKnobBitmap</code> .                   .     ,    .  <code>Synthesis::OnParamChange</code>    <code>switch</code> : <br> <br> <code class="cpp">case mFilterAttack: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK, GetParam(paramIdx)-&gt;Value()); break; case mFilterDecay: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_DECAY, GetParam(paramIdx)-&gt;Value()); break; case mFilterSustain: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_SUSTAIN, GetParam(paramIdx)-&gt;Value()); break; case mFilterRelease: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE, GetParam(paramIdx)-&gt;Value()); break; case mFilterEnvelopeAmount: filterEnvelopeAmount = GetParam(paramIdx)-&gt;Value(); break;</code> <br> <br> ! <br>     !           (-   C1),   : <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/f5d/757/3f9/f5d7573f9b3a720fe5898d88ae477cfc.png"> <br> <br>        <code>EnvelopeGenerator</code>  .         .        ! <br> <br>    <a href=""></a> . <br> <br>        :) <br> <br>  : <br> <a href="http://martin-finke.de/blog/articles/audio-plugins-013-filter/">martin-finke.de/blog/articles/audio-plugins-013-filter</a></code></code> <h3> <code><code class="cpp">#include  <i>Filter.h</i> ( )     : <br> <br> class Filter { public: enum FilterMode { FILTER_MODE_LOWPASS = 0, FILTER_MODE_HIGHPASS, FILTER_MODE_BANDPASS, kNumFilterModes }; Filter() : cutoff(0.99), resonance(0.0), mode(FILTER_MODE_LOWPASS), buf0(0.0), buf1(0.0) { calculateFeedbackAmount(); }; double process(double inputValue); inline void setCutoff(double newCutoff) { cutoff = newCutoff; calculateFeedbackAmount(); }; inline void setResonance(double newResonance) { resonance = newResonance; calculateFeedbackAmount(); }; inline void setFilterMode(FilterMode newMode) { mode = newMode; } private: double cutoff; double resonance; FilterMode mode; double feedbackAmount; inline void calculateFeedbackAmount() { feedbackAmount = resonance + resonance/(1.0 - cutoff); } double buf0; double buf1; };</code> <br> <br>  <code>private</code>     <i> </i> <code>cutoff</code>  <i></i> <code>resonance</code> . <code>Mode</code>      (Lowpass, Highpass, Bandpass).  <code>feedbackAmount</code> , <code>buf0</code>  <code>buf1</code>    ,    . <br>          ( <code>calculateFeedbackAmount()</code> ).  <code>process</code>      .   <code>feedbackAmount</code>   <code>cutoff</code>  <code>resonance</code> ,    <code>calculateFeedbackAmount</code>      . <br> <br>   <i>Filter.cpp</i>  : <br> <br> <code class="cpp">// By Paul Kellett // http://www.musicdsp.org/showone.php?id=29 double Filter::process(double inputValue) { buf0 += cutoff * (inputValue - buf0); buf1 += cutoff * (buf0 - buf1); switch (mode) { case FILTER_MODE_LOWPASS: return buf1; case FILTER_MODE_HIGHPASS: return inputValue - buf0; case FILTER_MODE_BANDPASS: return buf0 - buf1; default: return 0.0; } }</code> <br> <br> , ?  ,         <i> </i> . ¬´ ¬ª   ,               (. .    6 ).     <code>buf0</code>  <code>buf1</code> :        .     <code>inputValue</code> ,  - <code>buf0</code> (  ).   .    6 /   12 /.  <code>switch</code> ,  <code>buf1</code>    . , ,    <code>buf0</code> ,       12,   6 /,        . <br> <br>  <code>case</code> <code>FILTER_MODE_HIGHPASS</code>    . <code>buf0</code>       .   <code>inputValue</code>  <code>buf0</code> ,   .    <code>buf1</code> ,     . <br> <br>  <code>case</code> <code>FILTER_MODE_BANDPASS</code> ,  <code>buf0 - buf1</code>   .  <code>buf0</code>       ,     <code>buf1</code> . ,   . <br>  :    <i> </i>    <i> </i> ,   . <br> <br>  <code>buf1</code>     .       <a href="http://ru.wikipedia.org/wiki/%25D0%25A4%25D0%25B8%25D0%25BB%25D1%258C%25D1%2582%25D1%2580_%25D1%2581_%25D0%25B1%25D0%25B5%25D1%2581%25D0%25BA%25D0%25BE%25D0%25BD%25D0%25B5%25D1%2587%25D0%25BD%25D0%25BE%25D0%25B9_%25D0%25B8%25D0%25BC%25D0%25BF%25D1%2583%25D0%25BB%25D1%258C%25D1%2581%25D0%25BD%25D0%25BE%25D0%25B9_%25D1%2585%25D0%25B0%25D1%2580%25D0%25B0%25D0%25BA%25D1%2582%25D0%25B5%25D1%2580%25D0%25B8%25D1%2581%25D1%2582%25D0%25B8%25D0%25BA%25D0%25BE%25D0%25B9">    </a> ( <i>Infinite Impulse Response</i> ,  <i>IIR</i> ).  <a href="http://www.dspguide.com/ch14/1.htm"> </a> ,      .      ,         ,      . <br> <br>   <br>       ,     ,     .   ,  ,      ,  ,          .           ,  NI Massive,   ¬´ <a href="http://lurkmore.to/%25D0%25A2%25D1%2591%25D0%25BF%25D0%25BB%25D1%258B%25D0%25B9_%25D0%25BB%25D0%25B0%25D0%25BC%25D0%25BF%25D0%25BE%25D0%25B2%25D1%258B%25D0%25B9_%25D0%25B7%25D0%25B2%25D1%2583%25D0%25BA">  </a> ¬ª.       ,          ,   .        ,          (  Massive       ).      ¬´¬ª , , , AAS Ultra Analog,       ,     ,    ,        .         ,  ,    <a href="http://www.kvraudio.com/forum/viewtopic.php%3Ft%3D350246"></a> ,   ,      NI Reaktor. ,            ‚Äî    ,    ..     . <br> <br>   <br>     .   GUI.  <i>bg.png</i>   ( <i>‚ÄúMove to trash‚Äù</i>  Xcode),       : <br> <br> <a href="">filtermode.png</a> <a href="">knob_small.png</a> (  ,   50 50 ) <a href="">bg.png</a> (       ) <br> <br>    ID  <i>resource.h</i> : <br> <br> <code class="cpp">// Unique IDs for each image resource. #define BG_ID 101 #define WHITE_KEY_ID 102 #define BLACK_KEY_ID 103 #define WAVEFORM_ID 104 #define KNOB_ID 105 #define KNOB_SMALL_ID 106 #define FILTERMODE_ID 107 // Image resource locations for this plug. #define BG_FN "resources/img/bg.png" #define WHITE_KEY_FN "resources/img/whitekey.png" #define BLACK_KEY_FN "resources/img/blackkey.png" #define WAVEFORM_FN "resources/img/waveform.png" #define KNOB_FN "resources/img/knob.png" #define KNOB_SMALL_FN "resources/img/knob_small.png" #define FILTERMODE_FN "resources/img/filtermode.png"</code> <br> <br>  <i>Synthesis.rc</i> : <br> <br> <code class="cpp">#include "resource.h" BG_ID PNG BG_FN WHITE_KEY_ID PNG WHITE_KEY_FN BLACK_KEY_ID PNG BLACK_KEY_FN WAVEFORM_ID PNG WAVEFORM_FN KNOB_ID PNG KNOB_FN KNOB_SMALL_ID PNG KNOB_SMALL_FN FILTERMODE_ID PNG FILTERMODE_FN</code> <br> <br>   <code>#include "Filter.h"</code>  <i>Synthesis.h</i>    <code>private</code> : <br> <br> <code class="cpp">Filter mFilter;</code> <br> <br>  <code>EParams</code>  <i>Synthesis.cpp</i> : <br> <br> <code class="cpp">enum EParams { mWaveform = 0, mAttack, mDecay, mSustain, mRelease, mFilterMode, mFilterCutoff, mFilterResonance, mFilterAttack, mFilterDecay, mFilterSustain, mFilterRelease, mFilterEnvelopeAmount, kNumParams };</code> <br> <br>        : <br> <br> <code class="cpp">pGraphics-&gt;AttachControl(new ISwitchControl(this, 24, 38, mWaveform, &amp;waveformBitmap));</code> <br> <br>      .      (Lowpass, Highpass, Bandpass).    <code>AttachGraphics(pGraphics)</code> : <br> <br> <code class="cpp">GetParam(mFilterMode)-&gt;InitEnum("Filter Mode", Filter::FILTER_MODE_LOWPASS, Filter::kNumFilterModes); IBitmap filtermodeBitmap = pGraphics-&gt;LoadIBitmap(FILTERMODE_ID, FILTERMODE_FN, 3); pGraphics-&gt;AttachControl(new ISwitchControl(this, 24, 123, mFilterMode, &amp;filtermodeBitmap));</code> <br> <br>         .    .     <i>knob_small.png</i> : <br> <br> <code class="cpp">// Knobs for filter cutoff and resonance IBitmap smallKnobBitmap = pGraphics-&gt;LoadIBitmap(KNOB_SMALL_ID, KNOB_SMALL_FN, 64); // Cutoff knob: GetParam(mFilterCutoff)-&gt;InitDouble("Cutoff", 0.99, 0.01, 0.99, 0.001); GetParam(mFilterCutoff)-&gt;SetShape(2); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 5, 177, mFilterCutoff, &amp;smallKnobBitmap)); // Resonance knob: GetParam(mFilterResonance)-&gt;InitDouble("Resonance", 0.01, 0.01, 1.0, 0.001); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 61, 177, mFilterResonance, &amp;smallKnobBitmap));</code> <br> <br>   ,           <code>1.0</code> ,   <code>calculateFeedbackAmount</code>    , . <br>  <code>ProcessDoubleReplacing</code>     : <br> <br> <code class="cpp">leftOutput[i] = rightOutput[i] = mFilter.process(mOscillator.nextSample() * mEnvelopeGenerator.nextSample() * velocity / 127.0);</code> <br> <br>       .  <code>switch</code>   <code>Synthesis::OnParamChange</code> : <br> <br> <code class="cpp">case mFilterCutoff: mFilter.setCutoff(GetParam(paramIdx)-&gt;Value()); break; case mFilterResonance: mFilter.setResonance(GetParam(paramIdx)-&gt;Value()); break; case mFilterMode: mFilter.setFilterMode(static_cast&lt;Filter::FilterMode&gt;(GetParam(paramIdx)-&gt;Int())); break;</code> <br> <br>    .  -      . <br> <br>  <br> <br>  ‚Äî      .   ,   ,          . <br>      : <br> <br> <code class="cpp">buf0 += cutoff * (inputValue - buf0 + feedbackAmount * (buf0 - buf1));</code> <br> <br> ,   ,      ( <code>buf0 ‚Äì buf1</code> ),   <code>feedbackAmount</code> .    <code>calculateFeedbackAmount</code>  <code>feedbackAmount</code>  <code>resonance</code> , . .    ,   . <br> <br>  ,            .     ,  <i></i> ,      <a href="https://www.youtube.com/watch%3Fv%3DJWyMj6KxGHM"> </a> .    ,        ,       . <br> <br>  -12 /  -24 / <br>        !     24   .     <code>switch</code>  <code>Filter::process</code> : <br> <br> <code class="cpp">buf2 += cutoff * (buf1 - buf2); buf3 += cutoff * (buf2 ‚Äì buf3);</code> <br> <br>   :      ,       ,            .     ,       , , <a href="https://ccrma.stanford.edu/~Jos/filters/Filter_Stability.html"></a> (       ).     <code>switch</code> : <br> <br> <code class="cpp">switch (mode) { case FILTER_MODE_LOWPASS: return buf3; case FILTER_MODE_HIGHPASS: return inputValue - buf3; case FILTER_MODE_BANDPASS: return buf0 - buf3; default: return 0.0; }</code> <br> <br>   <code>buf1</code>  <code>buf3</code> ‚Äì      .    -24 /.     <code>buf2</code>  <code>buf3</code> ,        <code>private</code> <i>Filter.h</i> : <br> <br> <code class="cpp">double buf2; double buf3;</code> <br> <br>    ,   <code>buf0</code> c <code>buf1</code> : <br> <br> <code class="cpp">Filter() : // ... buf0(0.0), buf1(0.0), buf2(0.0), buf3(0.0) // ...</code> <br> <br>     , ,     :     .       . <br>          ? <br> <br>   <br>    .  ,           ,       . <br> -      <code>cutoff</code>   .      .    <code>cutoffMod</code> ,    ,       <code>cutoff</code>    .     <code><code>#include    private</code> : <br> <br> <code class="cpp">double cutoffMod;</code> <br> <br> : <br> <br> <code class="cpp">Filter() : cutoff(0.99), resonance(0.01), cutoffMod(0.0), // ...</code> <br> <br>         .   <code>private</code> : <br> <br> <code class="cpp">inline double getCalculatedCutoff() const { return fmax(fmin(cutoff + cutoffMod, 0.99), 0.01); };</code> <br> <br> <code>calculateFeedbackAmount</code>     : <br> <br> <code class="cpp">inline void calculateFeedbackAmount() { feedbackAmount = resonance + resonance/(1.0 - getCalculatedCutoff()); }</code> <br> <br>       <code>cutoffMod</code> .   <code>feedbackAmount</code>    ,     : <br> <br> <code class="cpp">inline void setCutoffMod(double newCutoffMod) { cutoffMod = newCutoffMod; calculateFeedbackAmount(); }</code> <br> <br> ,       .   <code>Filter::process</code>   : <br> <br> <code class="cpp">if (inputValue == 0.0) return inputValue; double calculatedCutoff = getCalculatedCutoff(); buf0 += calculatedCutoff * (inputValue - buf0 + feedbackAmount * (buf0 - buf1)); buf1 += calculatedCutoff * (buf0 - buf1); buf2 += calculatedCutoff * (buf1 - buf2); buf3 += calculatedCutoff * (buf2 ‚Äì buf3);</code> <br> <br>        ,    .    ,      ,   .     .     <code>cutoff</code>  <code>calculatedCutoff</code>   -. <br> <br> ,       ( <code>setCutoffMod</code> ),   <code>Synthesis</code>    ,     ,    .    ,        <code>cutoffMod</code> .    <code>filterEnvelopeAmount</code>    <code>-1</code>  <code>+1</code> .   GUI. <br> <br>   <code>private</code> <i>Synthesis.h</i>    : <br> <br> <code class="cpp">EnvelopeGenerator mFilterEnvelopeGenerator; double filterEnvelopeAmount;</code> <br> <br>       MIDI ,      <code>onNoteOn</code>  <code>onNoteOff</code> : <br> <br> <code class="cpp">inline void onNoteOn(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); mFilterEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); }; inline void onNoteOff(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); mFilterEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); };</code> <br> <br>    .   <code>ProcessDoubleReplacing</code>        : <br> <br> <code class="cpp">mFilter.setCutoffMod(mFilterEnvelopeGenerator.nextSample() * filterEnvelopeAmount);</code> <br> <br>  ,        <code>nextSample</code>  <code>filterEnvelopeAmount</code>     <code>cutoffMod</code> .     <code>filterEnvelopeAmount</code>  : <br> <br> <code class="cpp">Synthesis::Synthesis(IPlugInstanceInfo instanceInfo) : IPLUG_CTOR(kNumParams, kNumPrograms, instanceInfo), lastVirtualKeyboardNoteNumber(virtualKeyboardMinimumNoteNumber - 1), filterEnvelopeAmount(0.0) { // ... }</code> <br> <br>       <code>Synthesis::Reset</code> : <br> <br> <code class="cpp">mFilterEnvelopeGenerator.setSampleRate(GetSampleRate());</code> <br> <br>      <code>EParams</code> ,       .  <code>AttachGraphics</code>     : <br> <br> <code class="cpp">// Knobs for filter envelope // Attack knob GetParam(mFilterAttack)-&gt;InitDouble("Filter Env Attack", 0.01, 0.01, 10.0, 0.001); GetParam(mFilterAttack)-&gt;SetShape(3); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 139, 178, mFilterAttack, &amp;smallKnobBitmap)); // Decay knob: GetParam(mFilterDecay)-&gt;InitDouble("Filter Env Decay", 0.5, 0.01, 15.0, 0.001); GetParam(mFilterDecay)-&gt;SetShape(3); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 195, 178, mFilterDecay, &amp;smallKnobBitmap)); // Sustain knob: GetParam(mFilterSustain)-&gt;InitDouble("Filter Env Sustain", 0.1, 0.001, 1.0, 0.001); GetParam(mFilterSustain)-&gt;SetShape(2); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 251, 178, mFilterSustain, &amp;smallKnobBitmap)); // Release knob: GetParam(mFilterRelease)-&gt;InitDouble("Filter Env Release", 1.0, 0.001, 15.0, 0.001); GetParam(mFilterRelease)-&gt;SetShape(3); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 307, 178, mFilterRelease, &amp;smallKnobBitmap)); // Filter envelope amount knob: GetParam(mFilterEnvelopeAmount)-&gt;InitDouble("Filter Env Amount", 0.0, -1.0, 1.0, 0.001); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 363, 178, mFilterEnvelopeAmount, &amp;smallKnobBitmap));</code> <br> <br>     ,       <code>smallKnobBitmap</code> .                   .     ,    .  <code>Synthesis::OnParamChange</code>    <code>switch</code> : <br> <br> <code class="cpp">case mFilterAttack: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK, GetParam(paramIdx)-&gt;Value()); break; case mFilterDecay: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_DECAY, GetParam(paramIdx)-&gt;Value()); break; case mFilterSustain: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_SUSTAIN, GetParam(paramIdx)-&gt;Value()); break; case mFilterRelease: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE, GetParam(paramIdx)-&gt;Value()); break; case mFilterEnvelopeAmount: filterEnvelopeAmount = GetParam(paramIdx)-&gt;Value(); break;</code> <br> <br> ! <br>     !           (-   C1),   : <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/f5d/757/3f9/f5d7573f9b3a720fe5898d88ae477cfc.png"> <br> <br>        <code>EnvelopeGenerator</code>  .         .        ! <br> <br>    <a href=""></a> . <br> <br>        :) <br> <br>  : <br> <a href="http://martin-finke.de/blog/articles/audio-plugins-013-filter/">martin-finke.de/blog/articles/audio-plugins-013-filter</a></code></code> </h3> <code><code class="cpp">#include  <i>Filter.h</i> ( )     : <br> <br> class Filter { public: enum FilterMode { FILTER_MODE_LOWPASS = 0, FILTER_MODE_HIGHPASS, FILTER_MODE_BANDPASS, kNumFilterModes }; Filter() : cutoff(0.99), resonance(0.0), mode(FILTER_MODE_LOWPASS), buf0(0.0), buf1(0.0) { calculateFeedbackAmount(); }; double process(double inputValue); inline void setCutoff(double newCutoff) { cutoff = newCutoff; calculateFeedbackAmount(); }; inline void setResonance(double newResonance) { resonance = newResonance; calculateFeedbackAmount(); }; inline void setFilterMode(FilterMode newMode) { mode = newMode; } private: double cutoff; double resonance; FilterMode mode; double feedbackAmount; inline void calculateFeedbackAmount() { feedbackAmount = resonance + resonance/(1.0 - cutoff); } double buf0; double buf1; };</code> <br> <br>  <code>private</code>     <i> </i> <code>cutoff</code>  <i></i> <code>resonance</code> . <code>Mode</code>      (Lowpass, Highpass, Bandpass).  <code>feedbackAmount</code> , <code>buf0</code>  <code>buf1</code>    ,    . <br>          ( <code>calculateFeedbackAmount()</code> ).  <code>process</code>      .   <code>feedbackAmount</code>   <code>cutoff</code>  <code>resonance</code> ,    <code>calculateFeedbackAmount</code>      . <br> <br>   <i>Filter.cpp</i>  : <br> <br> <code class="cpp">// By Paul Kellett // http://www.musicdsp.org/showone.php?id=29 double Filter::process(double inputValue) { buf0 += cutoff * (inputValue - buf0); buf1 += cutoff * (buf0 - buf1); switch (mode) { case FILTER_MODE_LOWPASS: return buf1; case FILTER_MODE_HIGHPASS: return inputValue - buf0; case FILTER_MODE_BANDPASS: return buf0 - buf1; default: return 0.0; } }</code> <br> <br> , ?  ,         <i> </i> . ¬´ ¬ª   ,               (. .    6 ).     <code>buf0</code>  <code>buf1</code> :        .     <code>inputValue</code> ,  - <code>buf0</code> (  ).   .    6 /   12 /.  <code>switch</code> ,  <code>buf1</code>    . , ,    <code>buf0</code> ,       12,   6 /,        . <br> <br>  <code>case</code> <code>FILTER_MODE_HIGHPASS</code>    . <code>buf0</code>       .   <code>inputValue</code>  <code>buf0</code> ,   .    <code>buf1</code> ,     . <br> <br>  <code>case</code> <code>FILTER_MODE_BANDPASS</code> ,  <code>buf0 - buf1</code>   .  <code>buf0</code>       ,     <code>buf1</code> . ,   . <br>  :    <i> </i>    <i> </i> ,   . <br> <br>  <code>buf1</code>     .       <a href="http://ru.wikipedia.org/wiki/%25D0%25A4%25D0%25B8%25D0%25BB%25D1%258C%25D1%2582%25D1%2580_%25D1%2581_%25D0%25B1%25D0%25B5%25D1%2581%25D0%25BA%25D0%25BE%25D0%25BD%25D0%25B5%25D1%2587%25D0%25BD%25D0%25BE%25D0%25B9_%25D0%25B8%25D0%25BC%25D0%25BF%25D1%2583%25D0%25BB%25D1%258C%25D1%2581%25D0%25BD%25D0%25BE%25D0%25B9_%25D1%2585%25D0%25B0%25D1%2580%25D0%25B0%25D0%25BA%25D1%2582%25D0%25B5%25D1%2580%25D0%25B8%25D1%2581%25D1%2582%25D0%25B8%25D0%25BA%25D0%25BE%25D0%25B9">    </a> ( <i>Infinite Impulse Response</i> ,  <i>IIR</i> ).  <a href="http://www.dspguide.com/ch14/1.htm"> </a> ,      .      ,         ,      . <br> <br>   <br>       ,     ,     .   ,  ,      ,  ,          .           ,  NI Massive,   ¬´ <a href="http://lurkmore.to/%25D0%25A2%25D1%2591%25D0%25BF%25D0%25BB%25D1%258B%25D0%25B9_%25D0%25BB%25D0%25B0%25D0%25BC%25D0%25BF%25D0%25BE%25D0%25B2%25D1%258B%25D0%25B9_%25D0%25B7%25D0%25B2%25D1%2583%25D0%25BA">  </a> ¬ª.       ,          ,   .        ,          (  Massive       ).      ¬´¬ª , , , AAS Ultra Analog,       ,     ,    ,        .         ,  ,    <a href="http://www.kvraudio.com/forum/viewtopic.php%3Ft%3D350246"></a> ,   ,      NI Reaktor. ,            ‚Äî    ,    ..     . <br> <br>   <br>     .   GUI.  <i>bg.png</i>   ( <i>‚ÄúMove to trash‚Äù</i>  Xcode),       : <br> <br> <a href="">filtermode.png</a> <a href="">knob_small.png</a> (  ,   50 50 ) <a href="">bg.png</a> (       ) <br> <br>    ID  <i>resource.h</i> : <br> <br> <code class="cpp">// Unique IDs for each image resource. #define BG_ID 101 #define WHITE_KEY_ID 102 #define BLACK_KEY_ID 103 #define WAVEFORM_ID 104 #define KNOB_ID 105 #define KNOB_SMALL_ID 106 #define FILTERMODE_ID 107 // Image resource locations for this plug. #define BG_FN "resources/img/bg.png" #define WHITE_KEY_FN "resources/img/whitekey.png" #define BLACK_KEY_FN "resources/img/blackkey.png" #define WAVEFORM_FN "resources/img/waveform.png" #define KNOB_FN "resources/img/knob.png" #define KNOB_SMALL_FN "resources/img/knob_small.png" #define FILTERMODE_FN "resources/img/filtermode.png"</code> <br> <br>  <i>Synthesis.rc</i> : <br> <br> <code class="cpp">#include "resource.h" BG_ID PNG BG_FN WHITE_KEY_ID PNG WHITE_KEY_FN BLACK_KEY_ID PNG BLACK_KEY_FN WAVEFORM_ID PNG WAVEFORM_FN KNOB_ID PNG KNOB_FN KNOB_SMALL_ID PNG KNOB_SMALL_FN FILTERMODE_ID PNG FILTERMODE_FN</code> <br> <br>   <code>#include "Filter.h"</code>  <i>Synthesis.h</i>    <code>private</code> : <br> <br> <code class="cpp">Filter mFilter;</code> <br> <br>  <code>EParams</code>  <i>Synthesis.cpp</i> : <br> <br> <code class="cpp">enum EParams { mWaveform = 0, mAttack, mDecay, mSustain, mRelease, mFilterMode, mFilterCutoff, mFilterResonance, mFilterAttack, mFilterDecay, mFilterSustain, mFilterRelease, mFilterEnvelopeAmount, kNumParams };</code> <br> <br>        : <br> <br> <code class="cpp">pGraphics-&gt;AttachControl(new ISwitchControl(this, 24, 38, mWaveform, &amp;waveformBitmap));</code> <br> <br>      .      (Lowpass, Highpass, Bandpass).    <code>AttachGraphics(pGraphics)</code> : <br> <br> <code class="cpp">GetParam(mFilterMode)-&gt;InitEnum("Filter Mode", Filter::FILTER_MODE_LOWPASS, Filter::kNumFilterModes); IBitmap filtermodeBitmap = pGraphics-&gt;LoadIBitmap(FILTERMODE_ID, FILTERMODE_FN, 3); pGraphics-&gt;AttachControl(new ISwitchControl(this, 24, 123, mFilterMode, &amp;filtermodeBitmap));</code> <br> <br>         .    .     <i>knob_small.png</i> : <br> <br> <code class="cpp">// Knobs for filter cutoff and resonance IBitmap smallKnobBitmap = pGraphics-&gt;LoadIBitmap(KNOB_SMALL_ID, KNOB_SMALL_FN, 64); // Cutoff knob: GetParam(mFilterCutoff)-&gt;InitDouble("Cutoff", 0.99, 0.01, 0.99, 0.001); GetParam(mFilterCutoff)-&gt;SetShape(2); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 5, 177, mFilterCutoff, &amp;smallKnobBitmap)); // Resonance knob: GetParam(mFilterResonance)-&gt;InitDouble("Resonance", 0.01, 0.01, 1.0, 0.001); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 61, 177, mFilterResonance, &amp;smallKnobBitmap));</code> <br> <br>   ,           <code>1.0</code> ,   <code>calculateFeedbackAmount</code>    , . <br>  <code>ProcessDoubleReplacing</code>     : <br> <br> <code class="cpp">leftOutput[i] = rightOutput[i] = mFilter.process(mOscillator.nextSample() * mEnvelopeGenerator.nextSample() * velocity / 127.0);</code> <br> <br>       .  <code>switch</code>   <code>Synthesis::OnParamChange</code> : <br> <br> <code class="cpp">case mFilterCutoff: mFilter.setCutoff(GetParam(paramIdx)-&gt;Value()); break; case mFilterResonance: mFilter.setResonance(GetParam(paramIdx)-&gt;Value()); break; case mFilterMode: mFilter.setFilterMode(static_cast&lt;Filter::FilterMode&gt;(GetParam(paramIdx)-&gt;Int())); break;</code> <br> <br>    .  -      . <br> <br>  <br> <br>  ‚Äî      .   ,   ,          . <br>      : <br> <br> <code class="cpp">buf0 += cutoff * (inputValue - buf0 + feedbackAmount * (buf0 - buf1));</code> <br> <br> ,   ,      ( <code>buf0 ‚Äì buf1</code> ),   <code>feedbackAmount</code> .    <code>calculateFeedbackAmount</code>  <code>feedbackAmount</code>  <code>resonance</code> , . .    ,   . <br> <br>  ,            .     ,  <i></i> ,      <a href="https://www.youtube.com/watch%3Fv%3DJWyMj6KxGHM"> </a> .    ,        ,       . <br> <br>  -12 /  -24 / <br>        !     24   .     <code>switch</code>  <code>Filter::process</code> : <br> <br> <code class="cpp">buf2 += cutoff * (buf1 - buf2); buf3 += cutoff * (buf2 ‚Äì buf3);</code> <br> <br>   :      ,       ,            .     ,       , , <a href="https://ccrma.stanford.edu/~Jos/filters/Filter_Stability.html"></a> (       ).     <code>switch</code> : <br> <br> <code class="cpp">switch (mode) { case FILTER_MODE_LOWPASS: return buf3; case FILTER_MODE_HIGHPASS: return inputValue - buf3; case FILTER_MODE_BANDPASS: return buf0 - buf3; default: return 0.0; }</code> <br> <br>   <code>buf1</code>  <code>buf3</code> ‚Äì      .    -24 /.     <code>buf2</code>  <code>buf3</code> ,        <code>private</code> <i>Filter.h</i> : <br> <br> <code class="cpp">double buf2; double buf3;</code> <br> <br>    ,   <code>buf0</code> c <code>buf1</code> : <br> <br> <code class="cpp">Filter() : // ... buf0(0.0), buf1(0.0), buf2(0.0), buf3(0.0) // ...</code> <br> <br>     , ,     :     .       . <br>          ? <br> <br>   <br>    .  ,           ,       . <br> -      <code>cutoff</code>   .      .    <code>cutoffMod</code> ,    ,       <code>cutoff</code>    .     <code><code>#include    private</code> : <br> <br> <code class="cpp">double cutoffMod;</code> <br> <br> : <br> <br> <code class="cpp">Filter() : cutoff(0.99), resonance(0.01), cutoffMod(0.0), // ...</code> <br> <br>         .   <code>private</code> : <br> <br> <code class="cpp">inline double getCalculatedCutoff() const { return fmax(fmin(cutoff + cutoffMod, 0.99), 0.01); };</code> <br> <br> <code>calculateFeedbackAmount</code>     : <br> <br> <code class="cpp">inline void calculateFeedbackAmount() { feedbackAmount = resonance + resonance/(1.0 - getCalculatedCutoff()); }</code> <br> <br>       <code>cutoffMod</code> .   <code>feedbackAmount</code>    ,     : <br> <br> <code class="cpp">inline void setCutoffMod(double newCutoffMod) { cutoffMod = newCutoffMod; calculateFeedbackAmount(); }</code> <br> <br> ,       .   <code>Filter::process</code>   : <br> <br> <code class="cpp">if (inputValue == 0.0) return inputValue; double calculatedCutoff = getCalculatedCutoff(); buf0 += calculatedCutoff * (inputValue - buf0 + feedbackAmount * (buf0 - buf1)); buf1 += calculatedCutoff * (buf0 - buf1); buf2 += calculatedCutoff * (buf1 - buf2); buf3 += calculatedCutoff * (buf2 ‚Äì buf3);</code> <br> <br>        ,    .    ,      ,   .     .     <code>cutoff</code>  <code>calculatedCutoff</code>   -. <br> <br> ,       ( <code>setCutoffMod</code> ),   <code>Synthesis</code>    ,     ,    .    ,        <code>cutoffMod</code> .    <code>filterEnvelopeAmount</code>    <code>-1</code>  <code>+1</code> .   GUI. <br> <br>   <code>private</code> <i>Synthesis.h</i>    : <br> <br> <code class="cpp">EnvelopeGenerator mFilterEnvelopeGenerator; double filterEnvelopeAmount;</code> <br> <br>       MIDI ,      <code>onNoteOn</code>  <code>onNoteOff</code> : <br> <br> <code class="cpp">inline void onNoteOn(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); mFilterEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); }; inline void onNoteOff(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); mFilterEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); };</code> <br> <br>    .   <code>ProcessDoubleReplacing</code>        : <br> <br> <code class="cpp">mFilter.setCutoffMod(mFilterEnvelopeGenerator.nextSample() * filterEnvelopeAmount);</code> <br> <br>  ,        <code>nextSample</code>  <code>filterEnvelopeAmount</code>     <code>cutoffMod</code> .     <code>filterEnvelopeAmount</code>  : <br> <br> <code class="cpp">Synthesis::Synthesis(IPlugInstanceInfo instanceInfo) : IPLUG_CTOR(kNumParams, kNumPrograms, instanceInfo), lastVirtualKeyboardNoteNumber(virtualKeyboardMinimumNoteNumber - 1), filterEnvelopeAmount(0.0) { // ... }</code> <br> <br>       <code>Synthesis::Reset</code> : <br> <br> <code class="cpp">mFilterEnvelopeGenerator.setSampleRate(GetSampleRate());</code> <br> <br>      <code>EParams</code> ,       .  <code>AttachGraphics</code>     : <br> <br> <code class="cpp">// Knobs for filter envelope // Attack knob GetParam(mFilterAttack)-&gt;InitDouble("Filter Env Attack", 0.01, 0.01, 10.0, 0.001); GetParam(mFilterAttack)-&gt;SetShape(3); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 139, 178, mFilterAttack, &amp;smallKnobBitmap)); // Decay knob: GetParam(mFilterDecay)-&gt;InitDouble("Filter Env Decay", 0.5, 0.01, 15.0, 0.001); GetParam(mFilterDecay)-&gt;SetShape(3); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 195, 178, mFilterDecay, &amp;smallKnobBitmap)); // Sustain knob: GetParam(mFilterSustain)-&gt;InitDouble("Filter Env Sustain", 0.1, 0.001, 1.0, 0.001); GetParam(mFilterSustain)-&gt;SetShape(2); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 251, 178, mFilterSustain, &amp;smallKnobBitmap)); // Release knob: GetParam(mFilterRelease)-&gt;InitDouble("Filter Env Release", 1.0, 0.001, 15.0, 0.001); GetParam(mFilterRelease)-&gt;SetShape(3); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 307, 178, mFilterRelease, &amp;smallKnobBitmap)); // Filter envelope amount knob: GetParam(mFilterEnvelopeAmount)-&gt;InitDouble("Filter Env Amount", 0.0, -1.0, 1.0, 0.001); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 363, 178, mFilterEnvelopeAmount, &amp;smallKnobBitmap));</code> <br> <br>     ,       <code>smallKnobBitmap</code> .                   .     ,    .  <code>Synthesis::OnParamChange</code>    <code>switch</code> : <br> <br> <code class="cpp">case mFilterAttack: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK, GetParam(paramIdx)-&gt;Value()); break; case mFilterDecay: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_DECAY, GetParam(paramIdx)-&gt;Value()); break; case mFilterSustain: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_SUSTAIN, GetParam(paramIdx)-&gt;Value()); break; case mFilterRelease: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE, GetParam(paramIdx)-&gt;Value()); break; case mFilterEnvelopeAmount: filterEnvelopeAmount = GetParam(paramIdx)-&gt;Value(); break;</code> <br> <br> ! <br>     !           (-   C1),   : <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/f5d/757/3f9/f5d7573f9b3a720fe5898d88ae477cfc.png"> <br> <br>        <code>EnvelopeGenerator</code>  .         .        ! <br> <br>    <a href=""></a> . <br> <br>        :) <br> <br>  : <br> <a href="http://martin-finke.de/blog/articles/audio-plugins-013-filter/">martin-finke.de/blog/articles/audio-plugins-013-filter</a></code></code> <pre> <code class="hljs erlang-repl"><code class="cpp">#include  <i>Filter.h</i> ( )     : <br> <br> class Filter { public: enum FilterMode { FILTER_MODE_LOWPASS = <span class="hljs-number"><span class="hljs-number">0</span></span>, FILTER_MODE_HIGHPASS, FILTER_MODE_BANDPASS, kNumFilterModes }; Filter() : cutoff(<span class="hljs-number"><span class="hljs-number">0.99</span></span>), resonance(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), mode(FILTER_MODE_LOWPASS), buf0(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), buf1(<span class="hljs-number"><span class="hljs-number">0.0</span></span>) { calculateFeedbackAmount(); }; double process(double inputValue); inline void setCutoff(double newCutoff) { cutoff = newCutoff; calculateFeedbackAmount(); }; inline void setResonance(double newResonance) { resonance = newResonance; calculateFeedbackAmount(); }; inline void setFilterMode(FilterMode newMode) { mode = newMode; } private: double cutoff; double resonance; FilterMode mode; double feedbackAmount; inline void calculateFeedbackAmount() { feedbackAmount = resonance + resonance/(<span class="hljs-number"><span class="hljs-number">1.0</span></span> - cutoff); } double buf0; double buf1; };</code> <br> <br>  <code>private</code>     <i> </i> <code>cutoff</code>  <i></i> <code>resonance</code> . <code>Mode</code>      (Lowpass, Highpass, Bandpass).  <code>feedbackAmount</code> , <code>buf0</code>  <code>buf1</code>    ,    . <br>          ( <code>calculateFeedbackAmount()</code> ).  <code>process</code>      .   <code>feedbackAmount</code>   <code>cutoff</code>  <code>resonance</code> ,    <code>calculateFeedbackAmount</code>      . <br> <br>   <i>Filter.cpp</i>  : <br> <br> <code class="cpp">// By Paul Kellett // http://www.musicdsp.org/showone.php?id=<span class="hljs-number"><span class="hljs-number">29</span></span> double Filter::process(double inputValue) { buf0 += cutoff * (inputValue - buf0); buf1 += cutoff * (buf0 - buf1); switch (mode) { case FILTER_MODE_LOWPASS: return buf1; case FILTER_MODE_HIGHPASS: return inputValue - buf0; case FILTER_MODE_BANDPASS: return buf0 - buf1; default: return <span class="hljs-number"><span class="hljs-number">0.0</span></span>; } }</code> <br> <br> , ?  ,         <i> </i> . ¬´ ¬ª   ,               (. .    <span class="hljs-number"><span class="hljs-number">6</span></span> ).     <code>buf0</code>  <code>buf1</code> :        .     <code>inputValue</code> ,  - <code>buf0</code> (  ).   .    <span class="hljs-number"><span class="hljs-number">6</span></span> /   <span class="hljs-number"><span class="hljs-number">12</span></span> /.  <code>switch</code> ,  <code>buf1</code>    . , ,    <code>buf0</code> ,       <span class="hljs-number"><span class="hljs-number">12</span></span>,   <span class="hljs-number"><span class="hljs-number">6</span></span> /,        . <br> <br>  <code>case</code> <code>FILTER_MODE_HIGHPASS</code>    . <code>buf0</code>       .   <code>inputValue</code>  <code>buf0</code> ,   .    <code>buf1</code> ,     . <br> <br>  <code>case</code> <code>FILTER_MODE_BANDPASS</code> ,  <code>buf0 - buf1</code>   .  <code>buf0</code>       ,     <code>buf1</code> . ,   . <br>  :    <i> </i>    <i> </i> ,   . <br> <br>  <code>buf1</code>     .       <a href="http://ru.wikipedia.org/wiki/%25D0%25A4%25D0%25B8%25D0%25BB%25D1%258C%25D1%2582%25D1%2580_%25D1%2581_%25D0%25B1%25D0%25B5%25D1%2581%25D0%25BA%25D0%25BE%25D0%25BD%25D0%25B5%25D1%2587%25D0%25BD%25D0%25BE%25D0%25B9_%25D0%25B8%25D0%25BC%25D0%25BF%25D1%2583%25D0%25BB%25D1%258C%25D1%2581%25D0%25BD%25D0%25BE%25D0%25B9_%25D1%2585%25D0%25B0%25D1%2580%25D0%25B0%25D0%25BA%25D1%2582%25D0%25B5%25D1%2580%25D0%25B8%25D1%2581%25D1%2582%25D0%25B8%25D0%25BA%25D0%25BE%25D0%25B9">    </a> ( <i>Infinite Impulse Response</i> ,  <i>IIR</i> ).  <a href="http://www.dspguide.com/ch14/1.htm"> </a> ,      .      ,         ,      . <br> <br>   <br>       ,     ,     .   ,  ,      ,  ,          .           ,  NI Massive,   ¬´ <a href="http://lurkmore.to/%25D0%25A2%25D1%2591%25D0%25BF%25D0%25BB%25D1%258B%25D0%25B9_%25D0%25BB%25D0%25B0%25D0%25BC%25D0%25BF%25D0%25BE%25D0%25B2%25D1%258B%25D0%25B9_%25D0%25B7%25D0%25B2%25D1%2583%25D0%25BA">  </a> ¬ª.       ,          ,   .        ,          (  Massive       ).      ¬´¬ª , , , AAS Ultra Analog,       ,     ,    ,        .         ,  ,    <a href="http://www.kvraudio.com/forum/viewtopic.php%3Ft%3D350246"></a> ,   ,      NI Reaktor. ,            ‚Äî    ,    ..     . <br> <br>   <br>     .   GUI.  <i>bg.png</i>   ( <i>‚ÄúMove to trash‚Äù</i>  Xcode),       : <br> <br> <a href="">filtermode.png</a> <a href="">knob_small.png</a> (  ,   <span class="hljs-number"><span class="hljs-number">50</span></span> <span class="hljs-number"><span class="hljs-number">50</span></span> ) <a href="">bg.png</a> (       ) <br> <br>    ID  <i>resource.h</i> : <br> <br> <code class="cpp">// Unique IDs for each image resource. #define BG_ID <span class="hljs-number"><span class="hljs-number">101</span></span> #define WHITE_KEY_ID <span class="hljs-number"><span class="hljs-number">102</span></span> #define BLACK_KEY_ID <span class="hljs-number"><span class="hljs-number">103</span></span> #define WAVEFORM_ID <span class="hljs-number"><span class="hljs-number">104</span></span> #define KNOB_ID <span class="hljs-number"><span class="hljs-number">105</span></span> #define KNOB_SMALL_ID <span class="hljs-number"><span class="hljs-number">106</span></span> #define FILTERMODE_ID <span class="hljs-number"><span class="hljs-number">107</span></span> // Image resource locations for this plug. #define BG_FN <span class="hljs-string"><span class="hljs-string">"resources/img/bg.png"</span></span> #define WHITE_KEY_FN <span class="hljs-string"><span class="hljs-string">"resources/img/whitekey.png"</span></span> #define BLACK_KEY_FN <span class="hljs-string"><span class="hljs-string">"resources/img/blackkey.png"</span></span> #define WAVEFORM_FN <span class="hljs-string"><span class="hljs-string">"resources/img/waveform.png"</span></span> #define KNOB_FN <span class="hljs-string"><span class="hljs-string">"resources/img/knob.png"</span></span> #define KNOB_SMALL_FN <span class="hljs-string"><span class="hljs-string">"resources/img/knob_small.png"</span></span> #define FILTERMODE_FN <span class="hljs-string"><span class="hljs-string">"resources/img/filtermode.png"</span></span></code> <br> <br>  <i>Synthesis.rc</i> : <br> <br> <code class="cpp">#include <span class="hljs-string"><span class="hljs-string">"resource.h"</span></span> BG_ID PNG BG_FN WHITE_KEY_ID PNG WHITE_KEY_FN BLACK_KEY_ID PNG BLACK_KEY_FN WAVEFORM_ID PNG WAVEFORM_FN KNOB_ID PNG KNOB_FN KNOB_SMALL_ID PNG KNOB_SMALL_FN FILTERMODE_ID PNG FILTERMODE_FN</code> <br> <br>   <code>#include <span class="hljs-string"><span class="hljs-string">"Filter.h"</span></span></code>  <i>Synthesis.h</i>    <code>private</code> : <br> <br> <code class="cpp">Filter mFilter;</code> <br> <br>  <code>EParams</code>  <i>Synthesis.cpp</i> : <br> <br> <code class="cpp">enum EParams { mWaveform = <span class="hljs-number"><span class="hljs-number">0</span></span>, mAttack, mDecay, mSustain, mRelease, mFilterMode, mFilterCutoff, mFilterResonance, mFilterAttack, mFilterDecay, mFilterSustain, mFilterRelease, mFilterEnvelopeAmount, kNumParams };</code> <br> <br>        : <br> <br> <code class="cpp">pGraphics-&gt;AttachControl(new ISwitchControl(this, <span class="hljs-number"><span class="hljs-number">24</span></span>, <span class="hljs-number"><span class="hljs-number">38</span></span>, mWaveform, &amp;waveformBitmap));</code> <br> <br>      .      (Lowpass, Highpass, Bandpass).    <code>AttachGraphics(pGraphics)</code> : <br> <br> <code class="cpp">GetParam(mFilterMode)-&gt;InitEnum(<span class="hljs-string"><span class="hljs-string">"Filter Mode"</span></span>, Filter::FILTER_MODE_LOWPASS, Filter::kNumFilterModes); IBitmap filtermodeBitmap = pGraphics-&gt;LoadIBitmap(FILTERMODE_ID, FILTERMODE_FN, <span class="hljs-number"><span class="hljs-number">3</span></span>); pGraphics-&gt;AttachControl(new ISwitchControl(this, <span class="hljs-number"><span class="hljs-number">24</span></span>, <span class="hljs-number"><span class="hljs-number">123</span></span>, mFilterMode, &amp;filtermodeBitmap));</code> <br> <br>         .    .     <i>knob_small.png</i> : <br> <br> <code class="cpp">// Knobs for filter cutoff and resonance IBitmap smallKnobBitmap = pGraphics-&gt;LoadIBitmap(KNOB_SMALL_ID, KNOB_SMALL_FN, <span class="hljs-number"><span class="hljs-number">64</span></span>); // Cutoff knob: GetParam(mFilterCutoff)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Cutoff"</span></span>, <span class="hljs-number"><span class="hljs-number">0.99</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">0.99</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); GetParam(mFilterCutoff)-&gt;SetShape(<span class="hljs-number"><span class="hljs-number">2</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-number"><span class="hljs-number">177</span></span>, mFilterCutoff, &amp;smallKnobBitmap)); // Resonance knob: GetParam(mFilterResonance)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Resonance"</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">61</span></span>, <span class="hljs-number"><span class="hljs-number">177</span></span>, mFilterResonance, &amp;smallKnobBitmap));</code> <br> <br>   ,           <code><span class="hljs-number"><span class="hljs-number">1.0</span></span></code> ,   <code>calculateFeedbackAmount</code>    , . <br>  <code>ProcessDoubleReplacing</code>     : <br> <br> <code class="cpp">leftOutput[i] = rightOutput[i] = mFilter.process(mOscillator.nextSample() * mEnvelopeGenerator.nextSample() * velocity / <span class="hljs-number"><span class="hljs-number">127.0</span></span>);</code> <br> <br>       .  <code>switch</code>   <code>Synthesis::OnParamChange</code> : <br> <br> <code class="cpp">case mFilterCutoff: mFilter.setCutoff(GetParam(paramIdx)-&gt;Value()); break; case mFilterResonance: mFilter.setResonance(GetParam(paramIdx)-&gt;Value()); break; case mFilterMode: mFilter.setFilterMode(static_cast&lt;Filter::FilterMode&gt;(GetParam(paramIdx)-&gt;Int())); break;</code> <br> <br>    .  -      . <br> <br>  <br> <br>  ‚Äî      .   ,   ,          . <br>      : <br> <br> <code class="cpp">buf0 += cutoff * (inputValue - buf0 + feedbackAmount * (buf0 - buf1));</code> <br> <br> ,   ,      ( <code>buf0 ‚Äì buf1</code> ),   <code>feedbackAmount</code> .    <code>calculateFeedbackAmount</code>  <code>feedbackAmount</code>  <code>resonance</code> , . .    ,   . <br> <br>  ,            .     ,  <i></i> ,      <a href="https://www.youtube.com/watch%3Fv%3DJWyMj6KxGHM"> </a> .    ,        ,       . <br> <br>  -<span class="hljs-number"><span class="hljs-number">12</span></span> /  -<span class="hljs-number"><span class="hljs-number">24</span></span> / <br>        !     <span class="hljs-number"><span class="hljs-number">24</span></span>   .     <code>switch</code>  <code>Filter::process</code> : <br> <br> <code class="cpp">buf2 += cutoff * (buf1 - buf2); buf3 += cutoff * (buf2 ‚Äì buf3);</code> <br> <br>   :      ,       ,            .     ,       , , <a href="https://ccrma.stanford.edu/~Jos/filters/Filter_Stability.html"></a> (       ).     <code>switch</code> : <br> <br> <code class="cpp">switch (mode) { case FILTER_MODE_LOWPASS: return buf3; case FILTER_MODE_HIGHPASS: return inputValue - buf3; case FILTER_MODE_BANDPASS: return buf0 - buf3; default: return <span class="hljs-number"><span class="hljs-number">0.0</span></span>; }</code> <br> <br>   <code>buf1</code>  <code>buf3</code> ‚Äì      .    -<span class="hljs-number"><span class="hljs-number">24</span></span> /.     <code>buf2</code>  <code>buf3</code> ,        <code>private</code> <i>Filter.h</i> : <br> <br> <code class="cpp">double buf2; double buf3;</code> <br> <br>    ,   <code>buf0</code> c <code>buf1</code> : <br> <br> <code class="cpp">Filter() : // ... buf0(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), buf1(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), buf2(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), buf3(<span class="hljs-number"><span class="hljs-number">0.0</span></span>) // ...</code> <br> <br>     , ,     :     .       . <br>          ? <br> <br>   <br>    .  ,           ,       . <br> -      <code>cutoff</code>   .      .    <code>cutoffMod</code> ,    ,       <code>cutoff</code>    .     <code><code>#include    private</code> : <br> <br> <code class="cpp">double cutoffMod;</code> <br> <br> : <br> <br> <code class="cpp">Filter() : cutoff(<span class="hljs-number"><span class="hljs-number">0.99</span></span>), resonance(<span class="hljs-number"><span class="hljs-number">0.01</span></span>), cutoffMod(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), // ...</code> <br> <br>         .   <code>private</code> : <br> <br> <code class="cpp">inline double getCalculatedCutoff() const { return fmax(fmin(cutoff + cutoffMod, <span class="hljs-number"><span class="hljs-number">0.99</span></span>), <span class="hljs-number"><span class="hljs-number">0.01</span></span>); };</code> <br> <br> <code>calculateFeedbackAmount</code>     : <br> <br> <code class="cpp">inline void calculateFeedbackAmount() { feedbackAmount = resonance + resonance/(<span class="hljs-number"><span class="hljs-number">1.0</span></span> - getCalculatedCutoff()); }</code> <br> <br>       <code>cutoffMod</code> .   <code>feedbackAmount</code>    ,     : <br> <br> <code class="cpp">inline void setCutoffMod(double newCutoffMod) { cutoffMod = newCutoffMod; calculateFeedbackAmount(); }</code> <br> <br> ,       .   <code>Filter::process</code>   : <br> <br> <code class="cpp">if (inputValue == <span class="hljs-number"><span class="hljs-number">0.0</span></span>) return inputValue; double calculatedCutoff = getCalculatedCutoff(); buf0 += calculatedCutoff * (inputValue - buf0 + feedbackAmount * (buf0 - buf1)); buf1 += calculatedCutoff * (buf0 - buf1); buf2 += calculatedCutoff * (buf1 - buf2); buf3 += calculatedCutoff * (buf2 ‚Äì buf3);</code> <br> <br>        ,    .    ,      ,   .     .     <code>cutoff</code>  <code>calculatedCutoff</code>   -. <br> <br> ,       ( <code>setCutoffMod</code> ),   <code>Synthesis</code>    ,     ,    .    ,        <code>cutoffMod</code> .    <code>filterEnvelopeAmount</code>    <code>-<span class="hljs-number"><span class="hljs-number">1</span></span></code>  <code>+<span class="hljs-number"><span class="hljs-number">1</span></span></code> .   GUI. <br> <br>   <code>private</code> <i>Synthesis.h</i>    : <br> <br> <code class="cpp">EnvelopeGenerator mFilterEnvelopeGenerator; double filterEnvelopeAmount;</code> <br> <br>       MIDI ,      <code>onNoteOn</code>  <code>onNoteOff</code> : <br> <br> <code class="cpp">inline void onNoteOn(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); mFilterEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); }; inline void onNoteOff(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); mFilterEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); };</code> <br> <br>    .   <code>ProcessDoubleReplacing</code>        : <br> <br> <code class="cpp">mFilter.setCutoffMod(mFilterEnvelopeGenerator.nextSample() * filterEnvelopeAmount);</code> <br> <br>  ,        <code>nextSample</code>  <code>filterEnvelopeAmount</code>     <code>cutoffMod</code> .     <code>filterEnvelopeAmount</code>  : <br> <br> <code class="cpp">Synthesis::Synthesis(IPlugInstanceInfo instanceInfo) : IPLUG_CTOR(kNumParams, kNumPrograms, instanceInfo), lastVirtualKeyboardNoteNumber(virtualKeyboardMinimumNoteNumber - <span class="hljs-number"><span class="hljs-number">1</span></span>), filterEnvelopeAmount(<span class="hljs-number"><span class="hljs-number">0.0</span></span>) { // ... }</code> <br> <br>       <code>Synthesis::Reset</code> : <br> <br> <code class="cpp">mFilterEnvelopeGenerator.setSampleRate(GetSampleRate());</code> <br> <br>      <code>EParams</code> ,       .  <code>AttachGraphics</code>     : <br> <br> <code class="cpp">// Knobs for filter envelope // Attack knob GetParam(mFilterAttack)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Filter Env Attack"</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">10.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); GetParam(mFilterAttack)-&gt;SetShape(<span class="hljs-number"><span class="hljs-number">3</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">139</span></span>, <span class="hljs-number"><span class="hljs-number">178</span></span>, mFilterAttack, &amp;smallKnobBitmap)); // Decay knob: GetParam(mFilterDecay)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Filter Env Decay"</span></span>, <span class="hljs-number"><span class="hljs-number">0.5</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">15.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); GetParam(mFilterDecay)-&gt;SetShape(<span class="hljs-number"><span class="hljs-number">3</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">195</span></span>, <span class="hljs-number"><span class="hljs-number">178</span></span>, mFilterDecay, &amp;smallKnobBitmap)); // Sustain knob: GetParam(mFilterSustain)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Filter Env Sustain"</span></span>, <span class="hljs-number"><span class="hljs-number">0.1</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>, <span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); GetParam(mFilterSustain)-&gt;SetShape(<span class="hljs-number"><span class="hljs-number">2</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">251</span></span>, <span class="hljs-number"><span class="hljs-number">178</span></span>, mFilterSustain, &amp;smallKnobBitmap)); // Release knob: GetParam(mFilterRelease)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Filter Env Release"</span></span>, <span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>, <span class="hljs-number"><span class="hljs-number">15.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); GetParam(mFilterRelease)-&gt;SetShape(<span class="hljs-number"><span class="hljs-number">3</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">307</span></span>, <span class="hljs-number"><span class="hljs-number">178</span></span>, mFilterRelease, &amp;smallKnobBitmap)); // Filter envelope amount knob: GetParam(mFilterEnvelopeAmount)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Filter Env Amount"</span></span>, <span class="hljs-number"><span class="hljs-number">0.0</span></span>, -<span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">363</span></span>, <span class="hljs-number"><span class="hljs-number">178</span></span>, mFilterEnvelopeAmount, &amp;smallKnobBitmap));</code> <br> <br>     ,       <code>smallKnobBitmap</code> .                   .     ,    .  <code>Synthesis::OnParamChange</code>    <code>switch</code> : <br> <br> <code class="cpp">case mFilterAttack: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK, GetParam(paramIdx)-&gt;Value()); break; case mFilterDecay: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_DECAY, GetParam(paramIdx)-&gt;Value()); break; case mFilterSustain: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_SUSTAIN, GetParam(paramIdx)-&gt;Value()); break; case mFilterRelease: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE, GetParam(paramIdx)-&gt;Value()); break; case mFilterEnvelopeAmount: filterEnvelopeAmount = GetParam(paramIdx)-&gt;Value(); break;</code> <br> <br> ! <br>     !           (-   C1),   : <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/f5d/757/3f9/f5d7573f9b3a720fe5898d88ae477cfc.png"> <br> <br>        <code>EnvelopeGenerator</code>  .         .        ! <br> <br>    <a href=""></a> . <br> <br>        :) <br> <br>  : <br> <a href="http://martin-finke.de/blog/articles/audio-plugins-013-filter/">martin-finke.de/blog/articles/audio-plugins-<span class="hljs-number"><span class="hljs-number">013</span></span>-filter</a></code></code> </pre> <code><code class="cpp">#include  <i>Filter.h</i> ( )     : <br> <br> class Filter { public: enum FilterMode { FILTER_MODE_LOWPASS = 0, FILTER_MODE_HIGHPASS, FILTER_MODE_BANDPASS, kNumFilterModes }; Filter() : cutoff(0.99), resonance(0.0), mode(FILTER_MODE_LOWPASS), buf0(0.0), buf1(0.0) { calculateFeedbackAmount(); }; double process(double inputValue); inline void setCutoff(double newCutoff) { cutoff = newCutoff; calculateFeedbackAmount(); }; inline void setResonance(double newResonance) { resonance = newResonance; calculateFeedbackAmount(); }; inline void setFilterMode(FilterMode newMode) { mode = newMode; } private: double cutoff; double resonance; FilterMode mode; double feedbackAmount; inline void calculateFeedbackAmount() { feedbackAmount = resonance + resonance/(1.0 - cutoff); } double buf0; double buf1; };</code> <br> <br>  <code>private</code>     <i> </i> <code>cutoff</code>  <i></i> <code>resonance</code> . <code>Mode</code>      (Lowpass, Highpass, Bandpass).  <code>feedbackAmount</code> , <code>buf0</code>  <code>buf1</code>    ,    . <br>          ( <code>calculateFeedbackAmount()</code> ).  <code>process</code>      .   <code>feedbackAmount</code>   <code>cutoff</code>  <code>resonance</code> ,    <code>calculateFeedbackAmount</code>      . <br> <br>   <i>Filter.cpp</i>  : <br> <br> <code class="cpp">// By Paul Kellett // http://www.musicdsp.org/showone.php?id=29 double Filter::process(double inputValue) { buf0 += cutoff * (inputValue - buf0); buf1 += cutoff * (buf0 - buf1); switch (mode) { case FILTER_MODE_LOWPASS: return buf1; case FILTER_MODE_HIGHPASS: return inputValue - buf0; case FILTER_MODE_BANDPASS: return buf0 - buf1; default: return 0.0; } }</code> <br> <br> , ?  ,         <i> </i> . ¬´ ¬ª   ,               (. .    6 ).     <code>buf0</code>  <code>buf1</code> :        .     <code>inputValue</code> ,  - <code>buf0</code> (  ).   .    6 /   12 /.  <code>switch</code> ,  <code>buf1</code>    . , ,    <code>buf0</code> ,       12,   6 /,        . <br> <br>  <code>case</code> <code>FILTER_MODE_HIGHPASS</code>    . <code>buf0</code>       .   <code>inputValue</code>  <code>buf0</code> ,   .    <code>buf1</code> ,     . <br> <br>  <code>case</code> <code>FILTER_MODE_BANDPASS</code> ,  <code>buf0 - buf1</code>   .  <code>buf0</code>       ,     <code>buf1</code> . ,   . <br>  :    <i> </i>    <i> </i> ,   . <br> <br>  <code>buf1</code>     .       <a href="http://ru.wikipedia.org/wiki/%25D0%25A4%25D0%25B8%25D0%25BB%25D1%258C%25D1%2582%25D1%2580_%25D1%2581_%25D0%25B1%25D0%25B5%25D1%2581%25D0%25BA%25D0%25BE%25D0%25BD%25D0%25B5%25D1%2587%25D0%25BD%25D0%25BE%25D0%25B9_%25D0%25B8%25D0%25BC%25D0%25BF%25D1%2583%25D0%25BB%25D1%258C%25D1%2581%25D0%25BD%25D0%25BE%25D0%25B9_%25D1%2585%25D0%25B0%25D1%2580%25D0%25B0%25D0%25BA%25D1%2582%25D0%25B5%25D1%2580%25D0%25B8%25D1%2581%25D1%2582%25D0%25B8%25D0%25BA%25D0%25BE%25D0%25B9">    </a> ( <i>Infinite Impulse Response</i> ,  <i>IIR</i> ).  <a href="http://www.dspguide.com/ch14/1.htm"> </a> ,      .      ,         ,      . <br> <br>   <br>       ,     ,     .   ,  ,      ,  ,          .           ,  NI Massive,   ¬´ <a href="http://lurkmore.to/%25D0%25A2%25D1%2591%25D0%25BF%25D0%25BB%25D1%258B%25D0%25B9_%25D0%25BB%25D0%25B0%25D0%25BC%25D0%25BF%25D0%25BE%25D0%25B2%25D1%258B%25D0%25B9_%25D0%25B7%25D0%25B2%25D1%2583%25D0%25BA">  </a> ¬ª.       ,          ,   .        ,          (  Massive       ).      ¬´¬ª , , , AAS Ultra Analog,       ,     ,    ,        .         ,  ,    <a href="http://www.kvraudio.com/forum/viewtopic.php%3Ft%3D350246"></a> ,   ,      NI Reaktor. ,            ‚Äî    ,    ..     . <br> <br>   <br>     .   GUI.  <i>bg.png</i>   ( <i>‚ÄúMove to trash‚Äù</i>  Xcode),       : <br> <br> <a href="">filtermode.png</a> <a href="">knob_small.png</a> (  ,   50 50 ) <a href="">bg.png</a> (       ) <br> <br>    ID  <i>resource.h</i> : <br> <br> <code class="cpp">// Unique IDs for each image resource. #define BG_ID 101 #define WHITE_KEY_ID 102 #define BLACK_KEY_ID 103 #define WAVEFORM_ID 104 #define KNOB_ID 105 #define KNOB_SMALL_ID 106 #define FILTERMODE_ID 107 // Image resource locations for this plug. #define BG_FN "resources/img/bg.png" #define WHITE_KEY_FN "resources/img/whitekey.png" #define BLACK_KEY_FN "resources/img/blackkey.png" #define WAVEFORM_FN "resources/img/waveform.png" #define KNOB_FN "resources/img/knob.png" #define KNOB_SMALL_FN "resources/img/knob_small.png" #define FILTERMODE_FN "resources/img/filtermode.png"</code> <br> <br>  <i>Synthesis.rc</i> : <br> <br> <code class="cpp">#include "resource.h" BG_ID PNG BG_FN WHITE_KEY_ID PNG WHITE_KEY_FN BLACK_KEY_ID PNG BLACK_KEY_FN WAVEFORM_ID PNG WAVEFORM_FN KNOB_ID PNG KNOB_FN KNOB_SMALL_ID PNG KNOB_SMALL_FN FILTERMODE_ID PNG FILTERMODE_FN</code> <br> <br>   <code>#include "Filter.h"</code>  <i>Synthesis.h</i>    <code>private</code> : <br> <br> <code class="cpp">Filter mFilter;</code> <br> <br>  <code>EParams</code>  <i>Synthesis.cpp</i> : <br> <br> <code class="cpp">enum EParams { mWaveform = 0, mAttack, mDecay, mSustain, mRelease, mFilterMode, mFilterCutoff, mFilterResonance, mFilterAttack, mFilterDecay, mFilterSustain, mFilterRelease, mFilterEnvelopeAmount, kNumParams };</code> <br> <br>        : <br> <br> <code class="cpp">pGraphics-&gt;AttachControl(new ISwitchControl(this, 24, 38, mWaveform, &amp;waveformBitmap));</code> <br> <br>      .      (Lowpass, Highpass, Bandpass).    <code>AttachGraphics(pGraphics)</code> : <br> <br> <code class="cpp">GetParam(mFilterMode)-&gt;InitEnum("Filter Mode", Filter::FILTER_MODE_LOWPASS, Filter::kNumFilterModes); IBitmap filtermodeBitmap = pGraphics-&gt;LoadIBitmap(FILTERMODE_ID, FILTERMODE_FN, 3); pGraphics-&gt;AttachControl(new ISwitchControl(this, 24, 123, mFilterMode, &amp;filtermodeBitmap));</code> <br> <br>         .    .     <i>knob_small.png</i> : <br> <br> <code class="cpp">// Knobs for filter cutoff and resonance IBitmap smallKnobBitmap = pGraphics-&gt;LoadIBitmap(KNOB_SMALL_ID, KNOB_SMALL_FN, 64); // Cutoff knob: GetParam(mFilterCutoff)-&gt;InitDouble("Cutoff", 0.99, 0.01, 0.99, 0.001); GetParam(mFilterCutoff)-&gt;SetShape(2); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 5, 177, mFilterCutoff, &amp;smallKnobBitmap)); // Resonance knob: GetParam(mFilterResonance)-&gt;InitDouble("Resonance", 0.01, 0.01, 1.0, 0.001); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 61, 177, mFilterResonance, &amp;smallKnobBitmap));</code> <br> <br>   ,           <code>1.0</code> ,   <code>calculateFeedbackAmount</code>    , . <br>  <code>ProcessDoubleReplacing</code>     : <br> <br> <code class="cpp">leftOutput[i] = rightOutput[i] = mFilter.process(mOscillator.nextSample() * mEnvelopeGenerator.nextSample() * velocity / 127.0);</code> <br> <br>       .  <code>switch</code>   <code>Synthesis::OnParamChange</code> : <br> <br> <code class="cpp">case mFilterCutoff: mFilter.setCutoff(GetParam(paramIdx)-&gt;Value()); break; case mFilterResonance: mFilter.setResonance(GetParam(paramIdx)-&gt;Value()); break; case mFilterMode: mFilter.setFilterMode(static_cast&lt;Filter::FilterMode&gt;(GetParam(paramIdx)-&gt;Int())); break;</code> <br> <br>    .  -      . <br> <br>  <br> <br>  ‚Äî      .   ,   ,          . <br>      : <br> <br> <code class="cpp">buf0 += cutoff * (inputValue - buf0 + feedbackAmount * (buf0 - buf1));</code> <br> <br> ,   ,      ( <code>buf0 ‚Äì buf1</code> ),   <code>feedbackAmount</code> .    <code>calculateFeedbackAmount</code>  <code>feedbackAmount</code>  <code>resonance</code> , . .    ,   . <br> <br>  ,            .     ,  <i></i> ,      <a href="https://www.youtube.com/watch%3Fv%3DJWyMj6KxGHM"> </a> .    ,        ,       . <br> <br>  -12 /  -24 / <br>        !     24   .     <code>switch</code>  <code>Filter::process</code> : <br> <br> <code class="cpp">buf2 += cutoff * (buf1 - buf2); buf3 += cutoff * (buf2 ‚Äì buf3);</code> <br> <br>   :      ,       ,            .     ,       , , <a href="https://ccrma.stanford.edu/~Jos/filters/Filter_Stability.html"></a> (       ).     <code>switch</code> : <br> <br> <code class="cpp">switch (mode) { case FILTER_MODE_LOWPASS: return buf3; case FILTER_MODE_HIGHPASS: return inputValue - buf3; case FILTER_MODE_BANDPASS: return buf0 - buf3; default: return 0.0; }</code> <br> <br>   <code>buf1</code>  <code>buf3</code> ‚Äì      .    -24 /.     <code>buf2</code>  <code>buf3</code> ,        <code>private</code> <i>Filter.h</i> : <br> <br> <code class="cpp">double buf2; double buf3;</code> <br> <br>    ,   <code>buf0</code> c <code>buf1</code> : <br> <br> <code class="cpp">Filter() : // ... buf0(0.0), buf1(0.0), buf2(0.0), buf3(0.0) // ...</code> <br> <br>     , ,     :     .       . <br>          ? <br> <br>   <br>    .  ,           ,       . <br> -      <code>cutoff</code>   .      .    <code>cutoffMod</code> ,    ,       <code>cutoff</code>    .     <code><code>#include    private</code> : <br> <br> <code class="cpp">double cutoffMod;</code> <br> <br> : <br> <br> <code class="cpp">Filter() : cutoff(0.99), resonance(0.01), cutoffMod(0.0), // ...</code> <br> <br>         .   <code>private</code> : <br> <br> <code class="cpp">inline double getCalculatedCutoff() const { return fmax(fmin(cutoff + cutoffMod, 0.99), 0.01); };</code> <br> <br> <code>calculateFeedbackAmount</code>     : <br> <br> <code class="cpp">inline void calculateFeedbackAmount() { feedbackAmount = resonance + resonance/(1.0 - getCalculatedCutoff()); }</code> <br> <br>       <code>cutoffMod</code> .   <code>feedbackAmount</code>    ,     : <br> <br> <code class="cpp">inline void setCutoffMod(double newCutoffMod) { cutoffMod = newCutoffMod; calculateFeedbackAmount(); }</code> <br> <br> ,       .   <code>Filter::process</code>   : <br> <br> <code class="cpp">if (inputValue == 0.0) return inputValue; double calculatedCutoff = getCalculatedCutoff(); buf0 += calculatedCutoff * (inputValue - buf0 + feedbackAmount * (buf0 - buf1)); buf1 += calculatedCutoff * (buf0 - buf1); buf2 += calculatedCutoff * (buf1 - buf2); buf3 += calculatedCutoff * (buf2 ‚Äì buf3);</code> <br> <br>        ,    .    ,      ,   .     .     <code>cutoff</code>  <code>calculatedCutoff</code>   -. <br> <br> ,       ( <code>setCutoffMod</code> ),   <code>Synthesis</code>    ,     ,    .    ,        <code>cutoffMod</code> .    <code>filterEnvelopeAmount</code>    <code>-1</code>  <code>+1</code> .   GUI. <br> <br>   <code>private</code> <i>Synthesis.h</i>    : <br> <br> <code class="cpp">EnvelopeGenerator mFilterEnvelopeGenerator; double filterEnvelopeAmount;</code> <br> <br>       MIDI ,      <code>onNoteOn</code>  <code>onNoteOff</code> : <br> <br> <code class="cpp">inline void onNoteOn(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); mFilterEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); }; inline void onNoteOff(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); mFilterEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); };</code> <br> <br>    .   <code>ProcessDoubleReplacing</code>        : <br> <br> <code class="cpp">mFilter.setCutoffMod(mFilterEnvelopeGenerator.nextSample() * filterEnvelopeAmount);</code> <br> <br>  ,        <code>nextSample</code>  <code>filterEnvelopeAmount</code>     <code>cutoffMod</code> .     <code>filterEnvelopeAmount</code>  : <br> <br> <code class="cpp">Synthesis::Synthesis(IPlugInstanceInfo instanceInfo) : IPLUG_CTOR(kNumParams, kNumPrograms, instanceInfo), lastVirtualKeyboardNoteNumber(virtualKeyboardMinimumNoteNumber - 1), filterEnvelopeAmount(0.0) { // ... }</code> <br> <br>       <code>Synthesis::Reset</code> : <br> <br> <code class="cpp">mFilterEnvelopeGenerator.setSampleRate(GetSampleRate());</code> <br> <br>      <code>EParams</code> ,       .  <code>AttachGraphics</code>     : <br> <br> <code class="cpp">// Knobs for filter envelope // Attack knob GetParam(mFilterAttack)-&gt;InitDouble("Filter Env Attack", 0.01, 0.01, 10.0, 0.001); GetParam(mFilterAttack)-&gt;SetShape(3); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 139, 178, mFilterAttack, &amp;smallKnobBitmap)); // Decay knob: GetParam(mFilterDecay)-&gt;InitDouble("Filter Env Decay", 0.5, 0.01, 15.0, 0.001); GetParam(mFilterDecay)-&gt;SetShape(3); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 195, 178, mFilterDecay, &amp;smallKnobBitmap)); // Sustain knob: GetParam(mFilterSustain)-&gt;InitDouble("Filter Env Sustain", 0.1, 0.001, 1.0, 0.001); GetParam(mFilterSustain)-&gt;SetShape(2); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 251, 178, mFilterSustain, &amp;smallKnobBitmap)); // Release knob: GetParam(mFilterRelease)-&gt;InitDouble("Filter Env Release", 1.0, 0.001, 15.0, 0.001); GetParam(mFilterRelease)-&gt;SetShape(3); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 307, 178, mFilterRelease, &amp;smallKnobBitmap)); // Filter envelope amount knob: GetParam(mFilterEnvelopeAmount)-&gt;InitDouble("Filter Env Amount", 0.0, -1.0, 1.0, 0.001); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 363, 178, mFilterEnvelopeAmount, &amp;smallKnobBitmap));</code> <br> <br>     ,       <code>smallKnobBitmap</code> .                   .     ,    .  <code>Synthesis::OnParamChange</code>    <code>switch</code> : <br> <br> <code class="cpp">case mFilterAttack: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK, GetParam(paramIdx)-&gt;Value()); break; case mFilterDecay: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_DECAY, GetParam(paramIdx)-&gt;Value()); break; case mFilterSustain: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_SUSTAIN, GetParam(paramIdx)-&gt;Value()); break; case mFilterRelease: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE, GetParam(paramIdx)-&gt;Value()); break; case mFilterEnvelopeAmount: filterEnvelopeAmount = GetParam(paramIdx)-&gt;Value(); break;</code> <br> <br> ! <br>     !           (-   C1),   : <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/f5d/757/3f9/f5d7573f9b3a720fe5898d88ae477cfc.png"> <br> <br>        <code>EnvelopeGenerator</code>  .         .        ! <br> <br>    <a href=""></a> . <br> <br>        :) <br> <br>  : <br> <a href="http://martin-finke.de/blog/articles/audio-plugins-013-filter/">martin-finke.de/blog/articles/audio-plugins-013-filter</a></code></code> <pre> <code class="hljs erlang-repl"><code class="cpp">#include  <i>Filter.h</i> ( )     : <br> <br> class Filter { public: enum FilterMode { FILTER_MODE_LOWPASS = <span class="hljs-number"><span class="hljs-number">0</span></span>, FILTER_MODE_HIGHPASS, FILTER_MODE_BANDPASS, kNumFilterModes }; Filter() : cutoff(<span class="hljs-number"><span class="hljs-number">0.99</span></span>), resonance(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), mode(FILTER_MODE_LOWPASS), buf0(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), buf1(<span class="hljs-number"><span class="hljs-number">0.0</span></span>) { calculateFeedbackAmount(); }; double process(double inputValue); inline void setCutoff(double newCutoff) { cutoff = newCutoff; calculateFeedbackAmount(); }; inline void setResonance(double newResonance) { resonance = newResonance; calculateFeedbackAmount(); }; inline void setFilterMode(FilterMode newMode) { mode = newMode; } private: double cutoff; double resonance; FilterMode mode; double feedbackAmount; inline void calculateFeedbackAmount() { feedbackAmount = resonance + resonance/(<span class="hljs-number"><span class="hljs-number">1.0</span></span> - cutoff); } double buf0; double buf1; };</code> <br> <br>  <code>private</code>     <i> </i> <code>cutoff</code>  <i></i> <code>resonance</code> . <code>Mode</code>      (Lowpass, Highpass, Bandpass).  <code>feedbackAmount</code> , <code>buf0</code>  <code>buf1</code>    ,    . <br>          ( <code>calculateFeedbackAmount()</code> ).  <code>process</code>      .   <code>feedbackAmount</code>   <code>cutoff</code>  <code>resonance</code> ,    <code>calculateFeedbackAmount</code>      . <br> <br>   <i>Filter.cpp</i>  : <br> <br> <code class="cpp">// By Paul Kellett // http://www.musicdsp.org/showone.php?id=<span class="hljs-number"><span class="hljs-number">29</span></span> double Filter::process(double inputValue) { buf0 += cutoff * (inputValue - buf0); buf1 += cutoff * (buf0 - buf1); switch (mode) { case FILTER_MODE_LOWPASS: return buf1; case FILTER_MODE_HIGHPASS: return inputValue - buf0; case FILTER_MODE_BANDPASS: return buf0 - buf1; default: return <span class="hljs-number"><span class="hljs-number">0.0</span></span>; } }</code> <br> <br> , ?  ,         <i> </i> . ¬´ ¬ª   ,               (. .    <span class="hljs-number"><span class="hljs-number">6</span></span> ).     <code>buf0</code>  <code>buf1</code> :        .     <code>inputValue</code> ,  - <code>buf0</code> (  ).   .    <span class="hljs-number"><span class="hljs-number">6</span></span> /   <span class="hljs-number"><span class="hljs-number">12</span></span> /.  <code>switch</code> ,  <code>buf1</code>    . , ,    <code>buf0</code> ,       <span class="hljs-number"><span class="hljs-number">12</span></span>,   <span class="hljs-number"><span class="hljs-number">6</span></span> /,        . <br> <br>  <code>case</code> <code>FILTER_MODE_HIGHPASS</code>    . <code>buf0</code>       .   <code>inputValue</code>  <code>buf0</code> ,   .    <code>buf1</code> ,     . <br> <br>  <code>case</code> <code>FILTER_MODE_BANDPASS</code> ,  <code>buf0 - buf1</code>   .  <code>buf0</code>       ,     <code>buf1</code> . ,   . <br>  :    <i> </i>    <i> </i> ,   . <br> <br>  <code>buf1</code>     .       <a href="http://ru.wikipedia.org/wiki/%25D0%25A4%25D0%25B8%25D0%25BB%25D1%258C%25D1%2582%25D1%2580_%25D1%2581_%25D0%25B1%25D0%25B5%25D1%2581%25D0%25BA%25D0%25BE%25D0%25BD%25D0%25B5%25D1%2587%25D0%25BD%25D0%25BE%25D0%25B9_%25D0%25B8%25D0%25BC%25D0%25BF%25D1%2583%25D0%25BB%25D1%258C%25D1%2581%25D0%25BD%25D0%25BE%25D0%25B9_%25D1%2585%25D0%25B0%25D1%2580%25D0%25B0%25D0%25BA%25D1%2582%25D0%25B5%25D1%2580%25D0%25B8%25D1%2581%25D1%2582%25D0%25B8%25D0%25BA%25D0%25BE%25D0%25B9">    </a> ( <i>Infinite Impulse Response</i> ,  <i>IIR</i> ).  <a href="http://www.dspguide.com/ch14/1.htm"> </a> ,      .      ,         ,      . <br> <br>   <br>       ,     ,     .   ,  ,      ,  ,          .           ,  NI Massive,   ¬´ <a href="http://lurkmore.to/%25D0%25A2%25D1%2591%25D0%25BF%25D0%25BB%25D1%258B%25D0%25B9_%25D0%25BB%25D0%25B0%25D0%25BC%25D0%25BF%25D0%25BE%25D0%25B2%25D1%258B%25D0%25B9_%25D0%25B7%25D0%25B2%25D1%2583%25D0%25BA">  </a> ¬ª.       ,          ,   .        ,          (  Massive       ).      ¬´¬ª , , , AAS Ultra Analog,       ,     ,    ,        .         ,  ,    <a href="http://www.kvraudio.com/forum/viewtopic.php%3Ft%3D350246"></a> ,   ,      NI Reaktor. ,            ‚Äî    ,    ..     . <br> <br>   <br>     .   GUI.  <i>bg.png</i>   ( <i>‚ÄúMove to trash‚Äù</i>  Xcode),       : <br> <br> <a href="">filtermode.png</a> <a href="">knob_small.png</a> (  ,   <span class="hljs-number"><span class="hljs-number">50</span></span> <span class="hljs-number"><span class="hljs-number">50</span></span> ) <a href="">bg.png</a> (       ) <br> <br>    ID  <i>resource.h</i> : <br> <br> <code class="cpp">// Unique IDs for each image resource. #define BG_ID <span class="hljs-number"><span class="hljs-number">101</span></span> #define WHITE_KEY_ID <span class="hljs-number"><span class="hljs-number">102</span></span> #define BLACK_KEY_ID <span class="hljs-number"><span class="hljs-number">103</span></span> #define WAVEFORM_ID <span class="hljs-number"><span class="hljs-number">104</span></span> #define KNOB_ID <span class="hljs-number"><span class="hljs-number">105</span></span> #define KNOB_SMALL_ID <span class="hljs-number"><span class="hljs-number">106</span></span> #define FILTERMODE_ID <span class="hljs-number"><span class="hljs-number">107</span></span> // Image resource locations for this plug. #define BG_FN <span class="hljs-string"><span class="hljs-string">"resources/img/bg.png"</span></span> #define WHITE_KEY_FN <span class="hljs-string"><span class="hljs-string">"resources/img/whitekey.png"</span></span> #define BLACK_KEY_FN <span class="hljs-string"><span class="hljs-string">"resources/img/blackkey.png"</span></span> #define WAVEFORM_FN <span class="hljs-string"><span class="hljs-string">"resources/img/waveform.png"</span></span> #define KNOB_FN <span class="hljs-string"><span class="hljs-string">"resources/img/knob.png"</span></span> #define KNOB_SMALL_FN <span class="hljs-string"><span class="hljs-string">"resources/img/knob_small.png"</span></span> #define FILTERMODE_FN <span class="hljs-string"><span class="hljs-string">"resources/img/filtermode.png"</span></span></code> <br> <br>  <i>Synthesis.rc</i> : <br> <br> <code class="cpp">#include <span class="hljs-string"><span class="hljs-string">"resource.h"</span></span> BG_ID PNG BG_FN WHITE_KEY_ID PNG WHITE_KEY_FN BLACK_KEY_ID PNG BLACK_KEY_FN WAVEFORM_ID PNG WAVEFORM_FN KNOB_ID PNG KNOB_FN KNOB_SMALL_ID PNG KNOB_SMALL_FN FILTERMODE_ID PNG FILTERMODE_FN</code> <br> <br>   <code>#include <span class="hljs-string"><span class="hljs-string">"Filter.h"</span></span></code>  <i>Synthesis.h</i>    <code>private</code> : <br> <br> <code class="cpp">Filter mFilter;</code> <br> <br>  <code>EParams</code>  <i>Synthesis.cpp</i> : <br> <br> <code class="cpp">enum EParams { mWaveform = <span class="hljs-number"><span class="hljs-number">0</span></span>, mAttack, mDecay, mSustain, mRelease, mFilterMode, mFilterCutoff, mFilterResonance, mFilterAttack, mFilterDecay, mFilterSustain, mFilterRelease, mFilterEnvelopeAmount, kNumParams };</code> <br> <br>        : <br> <br> <code class="cpp">pGraphics-&gt;AttachControl(new ISwitchControl(this, <span class="hljs-number"><span class="hljs-number">24</span></span>, <span class="hljs-number"><span class="hljs-number">38</span></span>, mWaveform, &amp;waveformBitmap));</code> <br> <br>      .      (Lowpass, Highpass, Bandpass).    <code>AttachGraphics(pGraphics)</code> : <br> <br> <code class="cpp">GetParam(mFilterMode)-&gt;InitEnum(<span class="hljs-string"><span class="hljs-string">"Filter Mode"</span></span>, Filter::FILTER_MODE_LOWPASS, Filter::kNumFilterModes); IBitmap filtermodeBitmap = pGraphics-&gt;LoadIBitmap(FILTERMODE_ID, FILTERMODE_FN, <span class="hljs-number"><span class="hljs-number">3</span></span>); pGraphics-&gt;AttachControl(new ISwitchControl(this, <span class="hljs-number"><span class="hljs-number">24</span></span>, <span class="hljs-number"><span class="hljs-number">123</span></span>, mFilterMode, &amp;filtermodeBitmap));</code> <br> <br>         .    .     <i>knob_small.png</i> : <br> <br> <code class="cpp">// Knobs for filter cutoff and resonance IBitmap smallKnobBitmap = pGraphics-&gt;LoadIBitmap(KNOB_SMALL_ID, KNOB_SMALL_FN, <span class="hljs-number"><span class="hljs-number">64</span></span>); // Cutoff knob: GetParam(mFilterCutoff)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Cutoff"</span></span>, <span class="hljs-number"><span class="hljs-number">0.99</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">0.99</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); GetParam(mFilterCutoff)-&gt;SetShape(<span class="hljs-number"><span class="hljs-number">2</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-number"><span class="hljs-number">177</span></span>, mFilterCutoff, &amp;smallKnobBitmap)); // Resonance knob: GetParam(mFilterResonance)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Resonance"</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">61</span></span>, <span class="hljs-number"><span class="hljs-number">177</span></span>, mFilterResonance, &amp;smallKnobBitmap));</code> <br> <br>   ,           <code><span class="hljs-number"><span class="hljs-number">1.0</span></span></code> ,   <code>calculateFeedbackAmount</code>    , . <br>  <code>ProcessDoubleReplacing</code>     : <br> <br> <code class="cpp">leftOutput[i] = rightOutput[i] = mFilter.process(mOscillator.nextSample() * mEnvelopeGenerator.nextSample() * velocity / <span class="hljs-number"><span class="hljs-number">127.0</span></span>);</code> <br> <br>       .  <code>switch</code>   <code>Synthesis::OnParamChange</code> : <br> <br> <code class="cpp">case mFilterCutoff: mFilter.setCutoff(GetParam(paramIdx)-&gt;Value()); break; case mFilterResonance: mFilter.setResonance(GetParam(paramIdx)-&gt;Value()); break; case mFilterMode: mFilter.setFilterMode(static_cast&lt;Filter::FilterMode&gt;(GetParam(paramIdx)-&gt;Int())); break;</code> <br> <br>    .  -      . <br> <br>  <br> <br>  ‚Äî      .   ,   ,          . <br>      : <br> <br> <code class="cpp">buf0 += cutoff * (inputValue - buf0 + feedbackAmount * (buf0 - buf1));</code> <br> <br> ,   ,      ( <code>buf0 ‚Äì buf1</code> ),   <code>feedbackAmount</code> .    <code>calculateFeedbackAmount</code>  <code>feedbackAmount</code>  <code>resonance</code> , . .    ,   . <br> <br>  ,            .     ,  <i></i> ,      <a href="https://www.youtube.com/watch%3Fv%3DJWyMj6KxGHM"> </a> .    ,        ,       . <br> <br>  -<span class="hljs-number"><span class="hljs-number">12</span></span> /  -<span class="hljs-number"><span class="hljs-number">24</span></span> / <br>        !     <span class="hljs-number"><span class="hljs-number">24</span></span>   .     <code>switch</code>  <code>Filter::process</code> : <br> <br> <code class="cpp">buf2 += cutoff * (buf1 - buf2); buf3 += cutoff * (buf2 ‚Äì buf3);</code> <br> <br>   :      ,       ,            .     ,       , , <a href="https://ccrma.stanford.edu/~Jos/filters/Filter_Stability.html"></a> (       ).     <code>switch</code> : <br> <br> <code class="cpp">switch (mode) { case FILTER_MODE_LOWPASS: return buf3; case FILTER_MODE_HIGHPASS: return inputValue - buf3; case FILTER_MODE_BANDPASS: return buf0 - buf3; default: return <span class="hljs-number"><span class="hljs-number">0.0</span></span>; }</code> <br> <br>   <code>buf1</code>  <code>buf3</code> ‚Äì      .    -<span class="hljs-number"><span class="hljs-number">24</span></span> /.     <code>buf2</code>  <code>buf3</code> ,        <code>private</code> <i>Filter.h</i> : <br> <br> <code class="cpp">double buf2; double buf3;</code> <br> <br>    ,   <code>buf0</code> c <code>buf1</code> : <br> <br> <code class="cpp">Filter() : // ... buf0(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), buf1(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), buf2(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), buf3(<span class="hljs-number"><span class="hljs-number">0.0</span></span>) // ...</code> <br> <br>     , ,     :     .       . <br>          ? <br> <br>   <br>    .  ,           ,       . <br> -      <code>cutoff</code>   .      .    <code>cutoffMod</code> ,    ,       <code>cutoff</code>    .     <code><code>#include    private</code> : <br> <br> <code class="cpp">double cutoffMod;</code> <br> <br> : <br> <br> <code class="cpp">Filter() : cutoff(<span class="hljs-number"><span class="hljs-number">0.99</span></span>), resonance(<span class="hljs-number"><span class="hljs-number">0.01</span></span>), cutoffMod(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), // ...</code> <br> <br>         .   <code>private</code> : <br> <br> <code class="cpp">inline double getCalculatedCutoff() const { return fmax(fmin(cutoff + cutoffMod, <span class="hljs-number"><span class="hljs-number">0.99</span></span>), <span class="hljs-number"><span class="hljs-number">0.01</span></span>); };</code> <br> <br> <code>calculateFeedbackAmount</code>     : <br> <br> <code class="cpp">inline void calculateFeedbackAmount() { feedbackAmount = resonance + resonance/(<span class="hljs-number"><span class="hljs-number">1.0</span></span> - getCalculatedCutoff()); }</code> <br> <br>       <code>cutoffMod</code> .   <code>feedbackAmount</code>    ,     : <br> <br> <code class="cpp">inline void setCutoffMod(double newCutoffMod) { cutoffMod = newCutoffMod; calculateFeedbackAmount(); }</code> <br> <br> ,       .   <code>Filter::process</code>   : <br> <br> <code class="cpp">if (inputValue == <span class="hljs-number"><span class="hljs-number">0.0</span></span>) return inputValue; double calculatedCutoff = getCalculatedCutoff(); buf0 += calculatedCutoff * (inputValue - buf0 + feedbackAmount * (buf0 - buf1)); buf1 += calculatedCutoff * (buf0 - buf1); buf2 += calculatedCutoff * (buf1 - buf2); buf3 += calculatedCutoff * (buf2 ‚Äì buf3);</code> <br> <br>        ,    .    ,      ,   .     .     <code>cutoff</code>  <code>calculatedCutoff</code>   -. <br> <br> ,       ( <code>setCutoffMod</code> ),   <code>Synthesis</code>    ,     ,    .    ,        <code>cutoffMod</code> .    <code>filterEnvelopeAmount</code>    <code>-<span class="hljs-number"><span class="hljs-number">1</span></span></code>  <code>+<span class="hljs-number"><span class="hljs-number">1</span></span></code> .   GUI. <br> <br>   <code>private</code> <i>Synthesis.h</i>    : <br> <br> <code class="cpp">EnvelopeGenerator mFilterEnvelopeGenerator; double filterEnvelopeAmount;</code> <br> <br>       MIDI ,      <code>onNoteOn</code>  <code>onNoteOff</code> : <br> <br> <code class="cpp">inline void onNoteOn(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); mFilterEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); }; inline void onNoteOff(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); mFilterEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); };</code> <br> <br>    .   <code>ProcessDoubleReplacing</code>        : <br> <br> <code class="cpp">mFilter.setCutoffMod(mFilterEnvelopeGenerator.nextSample() * filterEnvelopeAmount);</code> <br> <br>  ,        <code>nextSample</code>  <code>filterEnvelopeAmount</code>     <code>cutoffMod</code> .     <code>filterEnvelopeAmount</code>  : <br> <br> <code class="cpp">Synthesis::Synthesis(IPlugInstanceInfo instanceInfo) : IPLUG_CTOR(kNumParams, kNumPrograms, instanceInfo), lastVirtualKeyboardNoteNumber(virtualKeyboardMinimumNoteNumber - <span class="hljs-number"><span class="hljs-number">1</span></span>), filterEnvelopeAmount(<span class="hljs-number"><span class="hljs-number">0.0</span></span>) { // ... }</code> <br> <br>       <code>Synthesis::Reset</code> : <br> <br> <code class="cpp">mFilterEnvelopeGenerator.setSampleRate(GetSampleRate());</code> <br> <br>      <code>EParams</code> ,       .  <code>AttachGraphics</code>     : <br> <br> <code class="cpp">// Knobs for filter envelope // Attack knob GetParam(mFilterAttack)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Filter Env Attack"</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">10.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); GetParam(mFilterAttack)-&gt;SetShape(<span class="hljs-number"><span class="hljs-number">3</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">139</span></span>, <span class="hljs-number"><span class="hljs-number">178</span></span>, mFilterAttack, &amp;smallKnobBitmap)); // Decay knob: GetParam(mFilterDecay)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Filter Env Decay"</span></span>, <span class="hljs-number"><span class="hljs-number">0.5</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">15.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); GetParam(mFilterDecay)-&gt;SetShape(<span class="hljs-number"><span class="hljs-number">3</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">195</span></span>, <span class="hljs-number"><span class="hljs-number">178</span></span>, mFilterDecay, &amp;smallKnobBitmap)); // Sustain knob: GetParam(mFilterSustain)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Filter Env Sustain"</span></span>, <span class="hljs-number"><span class="hljs-number">0.1</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>, <span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); GetParam(mFilterSustain)-&gt;SetShape(<span class="hljs-number"><span class="hljs-number">2</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">251</span></span>, <span class="hljs-number"><span class="hljs-number">178</span></span>, mFilterSustain, &amp;smallKnobBitmap)); // Release knob: GetParam(mFilterRelease)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Filter Env Release"</span></span>, <span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>, <span class="hljs-number"><span class="hljs-number">15.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); GetParam(mFilterRelease)-&gt;SetShape(<span class="hljs-number"><span class="hljs-number">3</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">307</span></span>, <span class="hljs-number"><span class="hljs-number">178</span></span>, mFilterRelease, &amp;smallKnobBitmap)); // Filter envelope amount knob: GetParam(mFilterEnvelopeAmount)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Filter Env Amount"</span></span>, <span class="hljs-number"><span class="hljs-number">0.0</span></span>, -<span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">363</span></span>, <span class="hljs-number"><span class="hljs-number">178</span></span>, mFilterEnvelopeAmount, &amp;smallKnobBitmap));</code> <br> <br>     ,       <code>smallKnobBitmap</code> .                   .     ,    .  <code>Synthesis::OnParamChange</code>    <code>switch</code> : <br> <br> <code class="cpp">case mFilterAttack: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK, GetParam(paramIdx)-&gt;Value()); break; case mFilterDecay: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_DECAY, GetParam(paramIdx)-&gt;Value()); break; case mFilterSustain: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_SUSTAIN, GetParam(paramIdx)-&gt;Value()); break; case mFilterRelease: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE, GetParam(paramIdx)-&gt;Value()); break; case mFilterEnvelopeAmount: filterEnvelopeAmount = GetParam(paramIdx)-&gt;Value(); break;</code> <br> <br> ! <br>     !           (-   C1),   : <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/f5d/757/3f9/f5d7573f9b3a720fe5898d88ae477cfc.png"> <br> <br>        <code>EnvelopeGenerator</code>  .         .        ! <br> <br>    <a href=""></a> . <br> <br>        :) <br> <br>  : <br> <a href="http://martin-finke.de/blog/articles/audio-plugins-013-filter/">martin-finke.de/blog/articles/audio-plugins-<span class="hljs-number"><span class="hljs-number">013</span></span>-filter</a></code></code> </pre> <code><code class="cpp">#include  <i>Filter.h</i> ( )     : <br> <br> class Filter { public: enum FilterMode { FILTER_MODE_LOWPASS = 0, FILTER_MODE_HIGHPASS, FILTER_MODE_BANDPASS, kNumFilterModes }; Filter() : cutoff(0.99), resonance(0.0), mode(FILTER_MODE_LOWPASS), buf0(0.0), buf1(0.0) { calculateFeedbackAmount(); }; double process(double inputValue); inline void setCutoff(double newCutoff) { cutoff = newCutoff; calculateFeedbackAmount(); }; inline void setResonance(double newResonance) { resonance = newResonance; calculateFeedbackAmount(); }; inline void setFilterMode(FilterMode newMode) { mode = newMode; } private: double cutoff; double resonance; FilterMode mode; double feedbackAmount; inline void calculateFeedbackAmount() { feedbackAmount = resonance + resonance/(1.0 - cutoff); } double buf0; double buf1; };</code> <br> <br>  <code>private</code>     <i> </i> <code>cutoff</code>  <i></i> <code>resonance</code> . <code>Mode</code>      (Lowpass, Highpass, Bandpass).  <code>feedbackAmount</code> , <code>buf0</code>  <code>buf1</code>    ,    . <br>          ( <code>calculateFeedbackAmount()</code> ).  <code>process</code>      .   <code>feedbackAmount</code>   <code>cutoff</code>  <code>resonance</code> ,    <code>calculateFeedbackAmount</code>      . <br> <br>   <i>Filter.cpp</i>  : <br> <br> <code class="cpp">// By Paul Kellett // http://www.musicdsp.org/showone.php?id=29 double Filter::process(double inputValue) { buf0 += cutoff * (inputValue - buf0); buf1 += cutoff * (buf0 - buf1); switch (mode) { case FILTER_MODE_LOWPASS: return buf1; case FILTER_MODE_HIGHPASS: return inputValue - buf0; case FILTER_MODE_BANDPASS: return buf0 - buf1; default: return 0.0; } }</code> <br> <br> , ?  ,         <i> </i> . ¬´ ¬ª   ,               (. .    6 ).     <code>buf0</code>  <code>buf1</code> :        .     <code>inputValue</code> ,  - <code>buf0</code> (  ).   .    6 /   12 /.  <code>switch</code> ,  <code>buf1</code>    . , ,    <code>buf0</code> ,       12,   6 /,        . <br> <br>  <code>case</code> <code>FILTER_MODE_HIGHPASS</code>    . <code>buf0</code>       .   <code>inputValue</code>  <code>buf0</code> ,   .    <code>buf1</code> ,     . <br> <br>  <code>case</code> <code>FILTER_MODE_BANDPASS</code> ,  <code>buf0 - buf1</code>   .  <code>buf0</code>       ,     <code>buf1</code> . ,   . <br>  :    <i> </i>    <i> </i> ,   . <br> <br>  <code>buf1</code>     .       <a href="http://ru.wikipedia.org/wiki/%25D0%25A4%25D0%25B8%25D0%25BB%25D1%258C%25D1%2582%25D1%2580_%25D1%2581_%25D0%25B1%25D0%25B5%25D1%2581%25D0%25BA%25D0%25BE%25D0%25BD%25D0%25B5%25D1%2587%25D0%25BD%25D0%25BE%25D0%25B9_%25D0%25B8%25D0%25BC%25D0%25BF%25D1%2583%25D0%25BB%25D1%258C%25D1%2581%25D0%25BD%25D0%25BE%25D0%25B9_%25D1%2585%25D0%25B0%25D1%2580%25D0%25B0%25D0%25BA%25D1%2582%25D0%25B5%25D1%2580%25D0%25B8%25D1%2581%25D1%2582%25D0%25B8%25D0%25BA%25D0%25BE%25D0%25B9">    </a> ( <i>Infinite Impulse Response</i> ,  <i>IIR</i> ).  <a href="http://www.dspguide.com/ch14/1.htm"> </a> ,      .      ,         ,      . <br> <br>   <br>       ,     ,     .   ,  ,      ,  ,          .           ,  NI Massive,   ¬´ <a href="http://lurkmore.to/%25D0%25A2%25D1%2591%25D0%25BF%25D0%25BB%25D1%258B%25D0%25B9_%25D0%25BB%25D0%25B0%25D0%25BC%25D0%25BF%25D0%25BE%25D0%25B2%25D1%258B%25D0%25B9_%25D0%25B7%25D0%25B2%25D1%2583%25D0%25BA">  </a> ¬ª.       ,          ,   .        ,          (  Massive       ).      ¬´¬ª , , , AAS Ultra Analog,       ,     ,    ,        .         ,  ,    <a href="http://www.kvraudio.com/forum/viewtopic.php%3Ft%3D350246"></a> ,   ,      NI Reaktor. ,            ‚Äî    ,    ..     . <br> <br>   <br>     .   GUI.  <i>bg.png</i>   ( <i>‚ÄúMove to trash‚Äù</i>  Xcode),       : <br> <br> <a href="">filtermode.png</a> <a href="">knob_small.png</a> (  ,   50 50 ) <a href="">bg.png</a> (       ) <br> <br>    ID  <i>resource.h</i> : <br> <br> <code class="cpp">// Unique IDs for each image resource. #define BG_ID 101 #define WHITE_KEY_ID 102 #define BLACK_KEY_ID 103 #define WAVEFORM_ID 104 #define KNOB_ID 105 #define KNOB_SMALL_ID 106 #define FILTERMODE_ID 107 // Image resource locations for this plug. #define BG_FN "resources/img/bg.png" #define WHITE_KEY_FN "resources/img/whitekey.png" #define BLACK_KEY_FN "resources/img/blackkey.png" #define WAVEFORM_FN "resources/img/waveform.png" #define KNOB_FN "resources/img/knob.png" #define KNOB_SMALL_FN "resources/img/knob_small.png" #define FILTERMODE_FN "resources/img/filtermode.png"</code> <br> <br>  <i>Synthesis.rc</i> : <br> <br> <code class="cpp">#include "resource.h" BG_ID PNG BG_FN WHITE_KEY_ID PNG WHITE_KEY_FN BLACK_KEY_ID PNG BLACK_KEY_FN WAVEFORM_ID PNG WAVEFORM_FN KNOB_ID PNG KNOB_FN KNOB_SMALL_ID PNG KNOB_SMALL_FN FILTERMODE_ID PNG FILTERMODE_FN</code> <br> <br>   <code>#include "Filter.h"</code>  <i>Synthesis.h</i>    <code>private</code> : <br> <br> <code class="cpp">Filter mFilter;</code> <br> <br>  <code>EParams</code>  <i>Synthesis.cpp</i> : <br> <br> <code class="cpp">enum EParams { mWaveform = 0, mAttack, mDecay, mSustain, mRelease, mFilterMode, mFilterCutoff, mFilterResonance, mFilterAttack, mFilterDecay, mFilterSustain, mFilterRelease, mFilterEnvelopeAmount, kNumParams };</code> <br> <br>        : <br> <br> <code class="cpp">pGraphics-&gt;AttachControl(new ISwitchControl(this, 24, 38, mWaveform, &amp;waveformBitmap));</code> <br> <br>      .      (Lowpass, Highpass, Bandpass).    <code>AttachGraphics(pGraphics)</code> : <br> <br> <code class="cpp">GetParam(mFilterMode)-&gt;InitEnum("Filter Mode", Filter::FILTER_MODE_LOWPASS, Filter::kNumFilterModes); IBitmap filtermodeBitmap = pGraphics-&gt;LoadIBitmap(FILTERMODE_ID, FILTERMODE_FN, 3); pGraphics-&gt;AttachControl(new ISwitchControl(this, 24, 123, mFilterMode, &amp;filtermodeBitmap));</code> <br> <br>         .    .     <i>knob_small.png</i> : <br> <br> <code class="cpp">// Knobs for filter cutoff and resonance IBitmap smallKnobBitmap = pGraphics-&gt;LoadIBitmap(KNOB_SMALL_ID, KNOB_SMALL_FN, 64); // Cutoff knob: GetParam(mFilterCutoff)-&gt;InitDouble("Cutoff", 0.99, 0.01, 0.99, 0.001); GetParam(mFilterCutoff)-&gt;SetShape(2); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 5, 177, mFilterCutoff, &amp;smallKnobBitmap)); // Resonance knob: GetParam(mFilterResonance)-&gt;InitDouble("Resonance", 0.01, 0.01, 1.0, 0.001); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 61, 177, mFilterResonance, &amp;smallKnobBitmap));</code> <br> <br>   ,           <code>1.0</code> ,   <code>calculateFeedbackAmount</code>    , . <br>  <code>ProcessDoubleReplacing</code>     : <br> <br> <code class="cpp">leftOutput[i] = rightOutput[i] = mFilter.process(mOscillator.nextSample() * mEnvelopeGenerator.nextSample() * velocity / 127.0);</code> <br> <br>       .  <code>switch</code>   <code>Synthesis::OnParamChange</code> : <br> <br> <code class="cpp">case mFilterCutoff: mFilter.setCutoff(GetParam(paramIdx)-&gt;Value()); break; case mFilterResonance: mFilter.setResonance(GetParam(paramIdx)-&gt;Value()); break; case mFilterMode: mFilter.setFilterMode(static_cast&lt;Filter::FilterMode&gt;(GetParam(paramIdx)-&gt;Int())); break;</code> <br> <br>    .  -      . <br> <br>  <br> <br>  ‚Äî      .   ,   ,          . <br>      : <br> <br> <code class="cpp">buf0 += cutoff * (inputValue - buf0 + feedbackAmount * (buf0 - buf1));</code> <br> <br> ,   ,      ( <code>buf0 ‚Äì buf1</code> ),   <code>feedbackAmount</code> .    <code>calculateFeedbackAmount</code>  <code>feedbackAmount</code>  <code>resonance</code> , . .    ,   . <br> <br>  ,            .     ,  <i></i> ,      <a href="https://www.youtube.com/watch%3Fv%3DJWyMj6KxGHM"> </a> .    ,        ,       . <br> <br>  -12 /  -24 / <br>        !     24   .     <code>switch</code>  <code>Filter::process</code> : <br> <br> <code class="cpp">buf2 += cutoff * (buf1 - buf2); buf3 += cutoff * (buf2 ‚Äì buf3);</code> <br> <br>   :      ,       ,            .     ,       , , <a href="https://ccrma.stanford.edu/~Jos/filters/Filter_Stability.html"></a> (       ).     <code>switch</code> : <br> <br> <code class="cpp">switch (mode) { case FILTER_MODE_LOWPASS: return buf3; case FILTER_MODE_HIGHPASS: return inputValue - buf3; case FILTER_MODE_BANDPASS: return buf0 - buf3; default: return 0.0; }</code> <br> <br>   <code>buf1</code>  <code>buf3</code> ‚Äì      .    -24 /.     <code>buf2</code>  <code>buf3</code> ,        <code>private</code> <i>Filter.h</i> : <br> <br> <code class="cpp">double buf2; double buf3;</code> <br> <br>    ,   <code>buf0</code> c <code>buf1</code> : <br> <br> <code class="cpp">Filter() : // ... buf0(0.0), buf1(0.0), buf2(0.0), buf3(0.0) // ...</code> <br> <br>     , ,     :     .       . <br>          ? <br> <br>   <br>    .  ,           ,       . <br> -      <code>cutoff</code>   .      .    <code>cutoffMod</code> ,    ,       <code>cutoff</code>    .     <code><code>#include    private</code> : <br> <br> <code class="cpp">double cutoffMod;</code> <br> <br> : <br> <br> <code class="cpp">Filter() : cutoff(0.99), resonance(0.01), cutoffMod(0.0), // ...</code> <br> <br>         .   <code>private</code> : <br> <br> <code class="cpp">inline double getCalculatedCutoff() const { return fmax(fmin(cutoff + cutoffMod, 0.99), 0.01); };</code> <br> <br> <code>calculateFeedbackAmount</code>     : <br> <br> <code class="cpp">inline void calculateFeedbackAmount() { feedbackAmount = resonance + resonance/(1.0 - getCalculatedCutoff()); }</code> <br> <br>       <code>cutoffMod</code> .   <code>feedbackAmount</code>    ,     : <br> <br> <code class="cpp">inline void setCutoffMod(double newCutoffMod) { cutoffMod = newCutoffMod; calculateFeedbackAmount(); }</code> <br> <br> ,       .   <code>Filter::process</code>   : <br> <br> <code class="cpp">if (inputValue == 0.0) return inputValue; double calculatedCutoff = getCalculatedCutoff(); buf0 += calculatedCutoff * (inputValue - buf0 + feedbackAmount * (buf0 - buf1)); buf1 += calculatedCutoff * (buf0 - buf1); buf2 += calculatedCutoff * (buf1 - buf2); buf3 += calculatedCutoff * (buf2 ‚Äì buf3);</code> <br> <br>        ,    .    ,      ,   .     .     <code>cutoff</code>  <code>calculatedCutoff</code>   -. <br> <br> ,       ( <code>setCutoffMod</code> ),   <code>Synthesis</code>    ,     ,    .    ,        <code>cutoffMod</code> .    <code>filterEnvelopeAmount</code>    <code>-1</code>  <code>+1</code> .   GUI. <br> <br>   <code>private</code> <i>Synthesis.h</i>    : <br> <br> <code class="cpp">EnvelopeGenerator mFilterEnvelopeGenerator; double filterEnvelopeAmount;</code> <br> <br>       MIDI ,      <code>onNoteOn</code>  <code>onNoteOff</code> : <br> <br> <code class="cpp">inline void onNoteOn(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); mFilterEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); }; inline void onNoteOff(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); mFilterEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); };</code> <br> <br>    .   <code>ProcessDoubleReplacing</code>        : <br> <br> <code class="cpp">mFilter.setCutoffMod(mFilterEnvelopeGenerator.nextSample() * filterEnvelopeAmount);</code> <br> <br>  ,        <code>nextSample</code>  <code>filterEnvelopeAmount</code>     <code>cutoffMod</code> .     <code>filterEnvelopeAmount</code>  : <br> <br> <code class="cpp">Synthesis::Synthesis(IPlugInstanceInfo instanceInfo) : IPLUG_CTOR(kNumParams, kNumPrograms, instanceInfo), lastVirtualKeyboardNoteNumber(virtualKeyboardMinimumNoteNumber - 1), filterEnvelopeAmount(0.0) { // ... }</code> <br> <br>       <code>Synthesis::Reset</code> : <br> <br> <code class="cpp">mFilterEnvelopeGenerator.setSampleRate(GetSampleRate());</code> <br> <br>      <code>EParams</code> ,       .  <code>AttachGraphics</code>     : <br> <br> <code class="cpp">// Knobs for filter envelope // Attack knob GetParam(mFilterAttack)-&gt;InitDouble("Filter Env Attack", 0.01, 0.01, 10.0, 0.001); GetParam(mFilterAttack)-&gt;SetShape(3); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 139, 178, mFilterAttack, &amp;smallKnobBitmap)); // Decay knob: GetParam(mFilterDecay)-&gt;InitDouble("Filter Env Decay", 0.5, 0.01, 15.0, 0.001); GetParam(mFilterDecay)-&gt;SetShape(3); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 195, 178, mFilterDecay, &amp;smallKnobBitmap)); // Sustain knob: GetParam(mFilterSustain)-&gt;InitDouble("Filter Env Sustain", 0.1, 0.001, 1.0, 0.001); GetParam(mFilterSustain)-&gt;SetShape(2); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 251, 178, mFilterSustain, &amp;smallKnobBitmap)); // Release knob: GetParam(mFilterRelease)-&gt;InitDouble("Filter Env Release", 1.0, 0.001, 15.0, 0.001); GetParam(mFilterRelease)-&gt;SetShape(3); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 307, 178, mFilterRelease, &amp;smallKnobBitmap)); // Filter envelope amount knob: GetParam(mFilterEnvelopeAmount)-&gt;InitDouble("Filter Env Amount", 0.0, -1.0, 1.0, 0.001); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 363, 178, mFilterEnvelopeAmount, &amp;smallKnobBitmap));</code> <br> <br>     ,       <code>smallKnobBitmap</code> .                   .     ,    .  <code>Synthesis::OnParamChange</code>    <code>switch</code> : <br> <br> <code class="cpp">case mFilterAttack: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK, GetParam(paramIdx)-&gt;Value()); break; case mFilterDecay: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_DECAY, GetParam(paramIdx)-&gt;Value()); break; case mFilterSustain: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_SUSTAIN, GetParam(paramIdx)-&gt;Value()); break; case mFilterRelease: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE, GetParam(paramIdx)-&gt;Value()); break; case mFilterEnvelopeAmount: filterEnvelopeAmount = GetParam(paramIdx)-&gt;Value(); break;</code> <br> <br> ! <br>     !           (-   C1),   : <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/f5d/757/3f9/f5d7573f9b3a720fe5898d88ae477cfc.png"> <br> <br>        <code>EnvelopeGenerator</code>  .         .        ! <br> <br>    <a href=""></a> . <br> <br>        :) <br> <br>  : <br> <a href="http://martin-finke.de/blog/articles/audio-plugins-013-filter/">martin-finke.de/blog/articles/audio-plugins-013-filter</a></code></code> <pre> <code class="hljs erlang-repl"><code class="cpp">#include  <i>Filter.h</i> ( )     : <br> <br> class Filter { public: enum FilterMode { FILTER_MODE_LOWPASS = <span class="hljs-number"><span class="hljs-number">0</span></span>, FILTER_MODE_HIGHPASS, FILTER_MODE_BANDPASS, kNumFilterModes }; Filter() : cutoff(<span class="hljs-number"><span class="hljs-number">0.99</span></span>), resonance(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), mode(FILTER_MODE_LOWPASS), buf0(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), buf1(<span class="hljs-number"><span class="hljs-number">0.0</span></span>) { calculateFeedbackAmount(); }; double process(double inputValue); inline void setCutoff(double newCutoff) { cutoff = newCutoff; calculateFeedbackAmount(); }; inline void setResonance(double newResonance) { resonance = newResonance; calculateFeedbackAmount(); }; inline void setFilterMode(FilterMode newMode) { mode = newMode; } private: double cutoff; double resonance; FilterMode mode; double feedbackAmount; inline void calculateFeedbackAmount() { feedbackAmount = resonance + resonance/(<span class="hljs-number"><span class="hljs-number">1.0</span></span> - cutoff); } double buf0; double buf1; };</code> <br> <br>  <code>private</code>     <i> </i> <code>cutoff</code>  <i></i> <code>resonance</code> . <code>Mode</code>      (Lowpass, Highpass, Bandpass).  <code>feedbackAmount</code> , <code>buf0</code>  <code>buf1</code>    ,    . <br>          ( <code>calculateFeedbackAmount()</code> ).  <code>process</code>      .   <code>feedbackAmount</code>   <code>cutoff</code>  <code>resonance</code> ,    <code>calculateFeedbackAmount</code>      . <br> <br>   <i>Filter.cpp</i>  : <br> <br> <code class="cpp">// By Paul Kellett // http://www.musicdsp.org/showone.php?id=<span class="hljs-number"><span class="hljs-number">29</span></span> double Filter::process(double inputValue) { buf0 += cutoff * (inputValue - buf0); buf1 += cutoff * (buf0 - buf1); switch (mode) { case FILTER_MODE_LOWPASS: return buf1; case FILTER_MODE_HIGHPASS: return inputValue - buf0; case FILTER_MODE_BANDPASS: return buf0 - buf1; default: return <span class="hljs-number"><span class="hljs-number">0.0</span></span>; } }</code> <br> <br> , ?  ,         <i> </i> . ¬´ ¬ª   ,               (. .    <span class="hljs-number"><span class="hljs-number">6</span></span> ).     <code>buf0</code>  <code>buf1</code> :        .     <code>inputValue</code> ,  - <code>buf0</code> (  ).   .    <span class="hljs-number"><span class="hljs-number">6</span></span> /   <span class="hljs-number"><span class="hljs-number">12</span></span> /.  <code>switch</code> ,  <code>buf1</code>    . , ,    <code>buf0</code> ,       <span class="hljs-number"><span class="hljs-number">12</span></span>,   <span class="hljs-number"><span class="hljs-number">6</span></span> /,        . <br> <br>  <code>case</code> <code>FILTER_MODE_HIGHPASS</code>    . <code>buf0</code>       .   <code>inputValue</code>  <code>buf0</code> ,   .    <code>buf1</code> ,     . <br> <br>  <code>case</code> <code>FILTER_MODE_BANDPASS</code> ,  <code>buf0 - buf1</code>   .  <code>buf0</code>       ,     <code>buf1</code> . ,   . <br>  :    <i> </i>    <i> </i> ,   . <br> <br>  <code>buf1</code>     .       <a href="http://ru.wikipedia.org/wiki/%25D0%25A4%25D0%25B8%25D0%25BB%25D1%258C%25D1%2582%25D1%2580_%25D1%2581_%25D0%25B1%25D0%25B5%25D1%2581%25D0%25BA%25D0%25BE%25D0%25BD%25D0%25B5%25D1%2587%25D0%25BD%25D0%25BE%25D0%25B9_%25D0%25B8%25D0%25BC%25D0%25BF%25D1%2583%25D0%25BB%25D1%258C%25D1%2581%25D0%25BD%25D0%25BE%25D0%25B9_%25D1%2585%25D0%25B0%25D1%2580%25D0%25B0%25D0%25BA%25D1%2582%25D0%25B5%25D1%2580%25D0%25B8%25D1%2581%25D1%2582%25D0%25B8%25D0%25BA%25D0%25BE%25D0%25B9">    </a> ( <i>Infinite Impulse Response</i> ,  <i>IIR</i> ).  <a href="http://www.dspguide.com/ch14/1.htm"> </a> ,      .      ,         ,      . <br> <br>   <br>       ,     ,     .   ,  ,      ,  ,          .           ,  NI Massive,   ¬´ <a href="http://lurkmore.to/%25D0%25A2%25D1%2591%25D0%25BF%25D0%25BB%25D1%258B%25D0%25B9_%25D0%25BB%25D0%25B0%25D0%25BC%25D0%25BF%25D0%25BE%25D0%25B2%25D1%258B%25D0%25B9_%25D0%25B7%25D0%25B2%25D1%2583%25D0%25BA">  </a> ¬ª.       ,          ,   .        ,          (  Massive       ).      ¬´¬ª , , , AAS Ultra Analog,       ,     ,    ,        .         ,  ,    <a href="http://www.kvraudio.com/forum/viewtopic.php%3Ft%3D350246"></a> ,   ,      NI Reaktor. ,            ‚Äî    ,    ..     . <br> <br>   <br>     .   GUI.  <i>bg.png</i>   ( <i>‚ÄúMove to trash‚Äù</i>  Xcode),       : <br> <br> <a href="">filtermode.png</a> <a href="">knob_small.png</a> (  ,   <span class="hljs-number"><span class="hljs-number">50</span></span> <span class="hljs-number"><span class="hljs-number">50</span></span> ) <a href="">bg.png</a> (       ) <br> <br>    ID  <i>resource.h</i> : <br> <br> <code class="cpp">// Unique IDs for each image resource. #define BG_ID <span class="hljs-number"><span class="hljs-number">101</span></span> #define WHITE_KEY_ID <span class="hljs-number"><span class="hljs-number">102</span></span> #define BLACK_KEY_ID <span class="hljs-number"><span class="hljs-number">103</span></span> #define WAVEFORM_ID <span class="hljs-number"><span class="hljs-number">104</span></span> #define KNOB_ID <span class="hljs-number"><span class="hljs-number">105</span></span> #define KNOB_SMALL_ID <span class="hljs-number"><span class="hljs-number">106</span></span> #define FILTERMODE_ID <span class="hljs-number"><span class="hljs-number">107</span></span> // Image resource locations for this plug. #define BG_FN <span class="hljs-string"><span class="hljs-string">"resources/img/bg.png"</span></span> #define WHITE_KEY_FN <span class="hljs-string"><span class="hljs-string">"resources/img/whitekey.png"</span></span> #define BLACK_KEY_FN <span class="hljs-string"><span class="hljs-string">"resources/img/blackkey.png"</span></span> #define WAVEFORM_FN <span class="hljs-string"><span class="hljs-string">"resources/img/waveform.png"</span></span> #define KNOB_FN <span class="hljs-string"><span class="hljs-string">"resources/img/knob.png"</span></span> #define KNOB_SMALL_FN <span class="hljs-string"><span class="hljs-string">"resources/img/knob_small.png"</span></span> #define FILTERMODE_FN <span class="hljs-string"><span class="hljs-string">"resources/img/filtermode.png"</span></span></code> <br> <br>  <i>Synthesis.rc</i> : <br> <br> <code class="cpp">#include <span class="hljs-string"><span class="hljs-string">"resource.h"</span></span> BG_ID PNG BG_FN WHITE_KEY_ID PNG WHITE_KEY_FN BLACK_KEY_ID PNG BLACK_KEY_FN WAVEFORM_ID PNG WAVEFORM_FN KNOB_ID PNG KNOB_FN KNOB_SMALL_ID PNG KNOB_SMALL_FN FILTERMODE_ID PNG FILTERMODE_FN</code> <br> <br>   <code>#include <span class="hljs-string"><span class="hljs-string">"Filter.h"</span></span></code>  <i>Synthesis.h</i>    <code>private</code> : <br> <br> <code class="cpp">Filter mFilter;</code> <br> <br>  <code>EParams</code>  <i>Synthesis.cpp</i> : <br> <br> <code class="cpp">enum EParams { mWaveform = <span class="hljs-number"><span class="hljs-number">0</span></span>, mAttack, mDecay, mSustain, mRelease, mFilterMode, mFilterCutoff, mFilterResonance, mFilterAttack, mFilterDecay, mFilterSustain, mFilterRelease, mFilterEnvelopeAmount, kNumParams };</code> <br> <br>        : <br> <br> <code class="cpp">pGraphics-&gt;AttachControl(new ISwitchControl(this, <span class="hljs-number"><span class="hljs-number">24</span></span>, <span class="hljs-number"><span class="hljs-number">38</span></span>, mWaveform, &amp;waveformBitmap));</code> <br> <br>      .      (Lowpass, Highpass, Bandpass).    <code>AttachGraphics(pGraphics)</code> : <br> <br> <code class="cpp">GetParam(mFilterMode)-&gt;InitEnum(<span class="hljs-string"><span class="hljs-string">"Filter Mode"</span></span>, Filter::FILTER_MODE_LOWPASS, Filter::kNumFilterModes); IBitmap filtermodeBitmap = pGraphics-&gt;LoadIBitmap(FILTERMODE_ID, FILTERMODE_FN, <span class="hljs-number"><span class="hljs-number">3</span></span>); pGraphics-&gt;AttachControl(new ISwitchControl(this, <span class="hljs-number"><span class="hljs-number">24</span></span>, <span class="hljs-number"><span class="hljs-number">123</span></span>, mFilterMode, &amp;filtermodeBitmap));</code> <br> <br>         .    .     <i>knob_small.png</i> : <br> <br> <code class="cpp">// Knobs for filter cutoff and resonance IBitmap smallKnobBitmap = pGraphics-&gt;LoadIBitmap(KNOB_SMALL_ID, KNOB_SMALL_FN, <span class="hljs-number"><span class="hljs-number">64</span></span>); // Cutoff knob: GetParam(mFilterCutoff)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Cutoff"</span></span>, <span class="hljs-number"><span class="hljs-number">0.99</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">0.99</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); GetParam(mFilterCutoff)-&gt;SetShape(<span class="hljs-number"><span class="hljs-number">2</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-number"><span class="hljs-number">177</span></span>, mFilterCutoff, &amp;smallKnobBitmap)); // Resonance knob: GetParam(mFilterResonance)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Resonance"</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">61</span></span>, <span class="hljs-number"><span class="hljs-number">177</span></span>, mFilterResonance, &amp;smallKnobBitmap));</code> <br> <br>   ,           <code><span class="hljs-number"><span class="hljs-number">1.0</span></span></code> ,   <code>calculateFeedbackAmount</code>    , . <br>  <code>ProcessDoubleReplacing</code>     : <br> <br> <code class="cpp">leftOutput[i] = rightOutput[i] = mFilter.process(mOscillator.nextSample() * mEnvelopeGenerator.nextSample() * velocity / <span class="hljs-number"><span class="hljs-number">127.0</span></span>);</code> <br> <br>       .  <code>switch</code>   <code>Synthesis::OnParamChange</code> : <br> <br> <code class="cpp">case mFilterCutoff: mFilter.setCutoff(GetParam(paramIdx)-&gt;Value()); break; case mFilterResonance: mFilter.setResonance(GetParam(paramIdx)-&gt;Value()); break; case mFilterMode: mFilter.setFilterMode(static_cast&lt;Filter::FilterMode&gt;(GetParam(paramIdx)-&gt;Int())); break;</code> <br> <br>    .  -      . <br> <br>  <br> <br>  ‚Äî      .   ,   ,          . <br>      : <br> <br> <code class="cpp">buf0 += cutoff * (inputValue - buf0 + feedbackAmount * (buf0 - buf1));</code> <br> <br> ,   ,      ( <code>buf0 ‚Äì buf1</code> ),   <code>feedbackAmount</code> .    <code>calculateFeedbackAmount</code>  <code>feedbackAmount</code>  <code>resonance</code> , . .    ,   . <br> <br>  ,            .     ,  <i></i> ,      <a href="https://www.youtube.com/watch%3Fv%3DJWyMj6KxGHM"> </a> .    ,        ,       . <br> <br>  -<span class="hljs-number"><span class="hljs-number">12</span></span> /  -<span class="hljs-number"><span class="hljs-number">24</span></span> / <br>        !     <span class="hljs-number"><span class="hljs-number">24</span></span>   .     <code>switch</code>  <code>Filter::process</code> : <br> <br> <code class="cpp">buf2 += cutoff * (buf1 - buf2); buf3 += cutoff * (buf2 ‚Äì buf3);</code> <br> <br>   :      ,       ,            .     ,       , , <a href="https://ccrma.stanford.edu/~Jos/filters/Filter_Stability.html"></a> (       ).     <code>switch</code> : <br> <br> <code class="cpp">switch (mode) { case FILTER_MODE_LOWPASS: return buf3; case FILTER_MODE_HIGHPASS: return inputValue - buf3; case FILTER_MODE_BANDPASS: return buf0 - buf3; default: return <span class="hljs-number"><span class="hljs-number">0.0</span></span>; }</code> <br> <br>   <code>buf1</code>  <code>buf3</code> ‚Äì      .    -<span class="hljs-number"><span class="hljs-number">24</span></span> /.     <code>buf2</code>  <code>buf3</code> ,        <code>private</code> <i>Filter.h</i> : <br> <br> <code class="cpp">double buf2; double buf3;</code> <br> <br>    ,   <code>buf0</code> c <code>buf1</code> : <br> <br> <code class="cpp">Filter() : // ... buf0(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), buf1(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), buf2(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), buf3(<span class="hljs-number"><span class="hljs-number">0.0</span></span>) // ...</code> <br> <br>     , ,     :     .       . <br>          ? <br> <br>   <br>    .  ,           ,       . <br> -      <code>cutoff</code>   .      .    <code>cutoffMod</code> ,    ,       <code>cutoff</code>    .     <code><code>#include    private</code> : <br> <br> <code class="cpp">double cutoffMod;</code> <br> <br> : <br> <br> <code class="cpp">Filter() : cutoff(<span class="hljs-number"><span class="hljs-number">0.99</span></span>), resonance(<span class="hljs-number"><span class="hljs-number">0.01</span></span>), cutoffMod(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), // ...</code> <br> <br>         .   <code>private</code> : <br> <br> <code class="cpp">inline double getCalculatedCutoff() const { return fmax(fmin(cutoff + cutoffMod, <span class="hljs-number"><span class="hljs-number">0.99</span></span>), <span class="hljs-number"><span class="hljs-number">0.01</span></span>); };</code> <br> <br> <code>calculateFeedbackAmount</code>     : <br> <br> <code class="cpp">inline void calculateFeedbackAmount() { feedbackAmount = resonance + resonance/(<span class="hljs-number"><span class="hljs-number">1.0</span></span> - getCalculatedCutoff()); }</code> <br> <br>       <code>cutoffMod</code> .   <code>feedbackAmount</code>    ,     : <br> <br> <code class="cpp">inline void setCutoffMod(double newCutoffMod) { cutoffMod = newCutoffMod; calculateFeedbackAmount(); }</code> <br> <br> ,       .   <code>Filter::process</code>   : <br> <br> <code class="cpp">if (inputValue == <span class="hljs-number"><span class="hljs-number">0.0</span></span>) return inputValue; double calculatedCutoff = getCalculatedCutoff(); buf0 += calculatedCutoff * (inputValue - buf0 + feedbackAmount * (buf0 - buf1)); buf1 += calculatedCutoff * (buf0 - buf1); buf2 += calculatedCutoff * (buf1 - buf2); buf3 += calculatedCutoff * (buf2 ‚Äì buf3);</code> <br> <br>        ,    .    ,      ,   .     .     <code>cutoff</code>  <code>calculatedCutoff</code>   -. <br> <br> ,       ( <code>setCutoffMod</code> ),   <code>Synthesis</code>    ,     ,    .    ,        <code>cutoffMod</code> .    <code>filterEnvelopeAmount</code>    <code>-<span class="hljs-number"><span class="hljs-number">1</span></span></code>  <code>+<span class="hljs-number"><span class="hljs-number">1</span></span></code> .   GUI. <br> <br>   <code>private</code> <i>Synthesis.h</i>    : <br> <br> <code class="cpp">EnvelopeGenerator mFilterEnvelopeGenerator; double filterEnvelopeAmount;</code> <br> <br>       MIDI ,      <code>onNoteOn</code>  <code>onNoteOff</code> : <br> <br> <code class="cpp">inline void onNoteOn(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); mFilterEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); }; inline void onNoteOff(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); mFilterEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); };</code> <br> <br>    .   <code>ProcessDoubleReplacing</code>        : <br> <br> <code class="cpp">mFilter.setCutoffMod(mFilterEnvelopeGenerator.nextSample() * filterEnvelopeAmount);</code> <br> <br>  ,        <code>nextSample</code>  <code>filterEnvelopeAmount</code>     <code>cutoffMod</code> .     <code>filterEnvelopeAmount</code>  : <br> <br> <code class="cpp">Synthesis::Synthesis(IPlugInstanceInfo instanceInfo) : IPLUG_CTOR(kNumParams, kNumPrograms, instanceInfo), lastVirtualKeyboardNoteNumber(virtualKeyboardMinimumNoteNumber - <span class="hljs-number"><span class="hljs-number">1</span></span>), filterEnvelopeAmount(<span class="hljs-number"><span class="hljs-number">0.0</span></span>) { // ... }</code> <br> <br>       <code>Synthesis::Reset</code> : <br> <br> <code class="cpp">mFilterEnvelopeGenerator.setSampleRate(GetSampleRate());</code> <br> <br>      <code>EParams</code> ,       .  <code>AttachGraphics</code>     : <br> <br> <code class="cpp">// Knobs for filter envelope // Attack knob GetParam(mFilterAttack)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Filter Env Attack"</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">10.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); GetParam(mFilterAttack)-&gt;SetShape(<span class="hljs-number"><span class="hljs-number">3</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">139</span></span>, <span class="hljs-number"><span class="hljs-number">178</span></span>, mFilterAttack, &amp;smallKnobBitmap)); // Decay knob: GetParam(mFilterDecay)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Filter Env Decay"</span></span>, <span class="hljs-number"><span class="hljs-number">0.5</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">15.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); GetParam(mFilterDecay)-&gt;SetShape(<span class="hljs-number"><span class="hljs-number">3</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">195</span></span>, <span class="hljs-number"><span class="hljs-number">178</span></span>, mFilterDecay, &amp;smallKnobBitmap)); // Sustain knob: GetParam(mFilterSustain)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Filter Env Sustain"</span></span>, <span class="hljs-number"><span class="hljs-number">0.1</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>, <span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); GetParam(mFilterSustain)-&gt;SetShape(<span class="hljs-number"><span class="hljs-number">2</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">251</span></span>, <span class="hljs-number"><span class="hljs-number">178</span></span>, mFilterSustain, &amp;smallKnobBitmap)); // Release knob: GetParam(mFilterRelease)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Filter Env Release"</span></span>, <span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>, <span class="hljs-number"><span class="hljs-number">15.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); GetParam(mFilterRelease)-&gt;SetShape(<span class="hljs-number"><span class="hljs-number">3</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">307</span></span>, <span class="hljs-number"><span class="hljs-number">178</span></span>, mFilterRelease, &amp;smallKnobBitmap)); // Filter envelope amount knob: GetParam(mFilterEnvelopeAmount)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Filter Env Amount"</span></span>, <span class="hljs-number"><span class="hljs-number">0.0</span></span>, -<span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">363</span></span>, <span class="hljs-number"><span class="hljs-number">178</span></span>, mFilterEnvelopeAmount, &amp;smallKnobBitmap));</code> <br> <br>     ,       <code>smallKnobBitmap</code> .                   .     ,    .  <code>Synthesis::OnParamChange</code>    <code>switch</code> : <br> <br> <code class="cpp">case mFilterAttack: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK, GetParam(paramIdx)-&gt;Value()); break; case mFilterDecay: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_DECAY, GetParam(paramIdx)-&gt;Value()); break; case mFilterSustain: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_SUSTAIN, GetParam(paramIdx)-&gt;Value()); break; case mFilterRelease: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE, GetParam(paramIdx)-&gt;Value()); break; case mFilterEnvelopeAmount: filterEnvelopeAmount = GetParam(paramIdx)-&gt;Value(); break;</code> <br> <br> ! <br>     !           (-   C1),   : <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/f5d/757/3f9/f5d7573f9b3a720fe5898d88ae477cfc.png"> <br> <br>        <code>EnvelopeGenerator</code>  .         .        ! <br> <br>    <a href=""></a> . <br> <br>        :) <br> <br>  : <br> <a href="http://martin-finke.de/blog/articles/audio-plugins-013-filter/">martin-finke.de/blog/articles/audio-plugins-<span class="hljs-number"><span class="hljs-number">013</span></span>-filter</a></code></code> </pre> <code><code class="cpp">#include  <i>Filter.h</i> ( )     : <br> <br> class Filter { public: enum FilterMode { FILTER_MODE_LOWPASS = 0, FILTER_MODE_HIGHPASS, FILTER_MODE_BANDPASS, kNumFilterModes }; Filter() : cutoff(0.99), resonance(0.0), mode(FILTER_MODE_LOWPASS), buf0(0.0), buf1(0.0) { calculateFeedbackAmount(); }; double process(double inputValue); inline void setCutoff(double newCutoff) { cutoff = newCutoff; calculateFeedbackAmount(); }; inline void setResonance(double newResonance) { resonance = newResonance; calculateFeedbackAmount(); }; inline void setFilterMode(FilterMode newMode) { mode = newMode; } private: double cutoff; double resonance; FilterMode mode; double feedbackAmount; inline void calculateFeedbackAmount() { feedbackAmount = resonance + resonance/(1.0 - cutoff); } double buf0; double buf1; };</code> <br> <br>  <code>private</code>     <i> </i> <code>cutoff</code>  <i></i> <code>resonance</code> . <code>Mode</code>      (Lowpass, Highpass, Bandpass).  <code>feedbackAmount</code> , <code>buf0</code>  <code>buf1</code>    ,    . <br>          ( <code>calculateFeedbackAmount()</code> ).  <code>process</code>      .   <code>feedbackAmount</code>   <code>cutoff</code>  <code>resonance</code> ,    <code>calculateFeedbackAmount</code>      . <br> <br>   <i>Filter.cpp</i>  : <br> <br> <code class="cpp">// By Paul Kellett // http://www.musicdsp.org/showone.php?id=29 double Filter::process(double inputValue) { buf0 += cutoff * (inputValue - buf0); buf1 += cutoff * (buf0 - buf1); switch (mode) { case FILTER_MODE_LOWPASS: return buf1; case FILTER_MODE_HIGHPASS: return inputValue - buf0; case FILTER_MODE_BANDPASS: return buf0 - buf1; default: return 0.0; } }</code> <br> <br> , ?  ,         <i> </i> . ¬´ ¬ª   ,               (. .    6 ).     <code>buf0</code>  <code>buf1</code> :        .     <code>inputValue</code> ,  - <code>buf0</code> (  ).   .    6 /   12 /.  <code>switch</code> ,  <code>buf1</code>    . , ,    <code>buf0</code> ,       12,   6 /,        . <br> <br>  <code>case</code> <code>FILTER_MODE_HIGHPASS</code>    . <code>buf0</code>       .   <code>inputValue</code>  <code>buf0</code> ,   .    <code>buf1</code> ,     . <br> <br>  <code>case</code> <code>FILTER_MODE_BANDPASS</code> ,  <code>buf0 - buf1</code>   .  <code>buf0</code>       ,     <code>buf1</code> . ,   . <br>  :    <i> </i>    <i> </i> ,   . <br> <br>  <code>buf1</code>     .       <a href="http://ru.wikipedia.org/wiki/%25D0%25A4%25D0%25B8%25D0%25BB%25D1%258C%25D1%2582%25D1%2580_%25D1%2581_%25D0%25B1%25D0%25B5%25D1%2581%25D0%25BA%25D0%25BE%25D0%25BD%25D0%25B5%25D1%2587%25D0%25BD%25D0%25BE%25D0%25B9_%25D0%25B8%25D0%25BC%25D0%25BF%25D1%2583%25D0%25BB%25D1%258C%25D1%2581%25D0%25BD%25D0%25BE%25D0%25B9_%25D1%2585%25D0%25B0%25D1%2580%25D0%25B0%25D0%25BA%25D1%2582%25D0%25B5%25D1%2580%25D0%25B8%25D1%2581%25D1%2582%25D0%25B8%25D0%25BA%25D0%25BE%25D0%25B9">    </a> ( <i>Infinite Impulse Response</i> ,  <i>IIR</i> ).  <a href="http://www.dspguide.com/ch14/1.htm"> </a> ,      .      ,         ,      . <br> <br>   <br>       ,     ,     .   ,  ,      ,  ,          .           ,  NI Massive,   ¬´ <a href="http://lurkmore.to/%25D0%25A2%25D1%2591%25D0%25BF%25D0%25BB%25D1%258B%25D0%25B9_%25D0%25BB%25D0%25B0%25D0%25BC%25D0%25BF%25D0%25BE%25D0%25B2%25D1%258B%25D0%25B9_%25D0%25B7%25D0%25B2%25D1%2583%25D0%25BA">  </a> ¬ª.       ,          ,   .        ,          (  Massive       ).      ¬´¬ª , , , AAS Ultra Analog,       ,     ,    ,        .         ,  ,    <a href="http://www.kvraudio.com/forum/viewtopic.php%3Ft%3D350246"></a> ,   ,      NI Reaktor. ,            ‚Äî    ,    ..     . <br> <br>   <br>     .   GUI.  <i>bg.png</i>   ( <i>‚ÄúMove to trash‚Äù</i>  Xcode),       : <br> <br> <a href="">filtermode.png</a> <a href="">knob_small.png</a> (  ,   50 50 ) <a href="">bg.png</a> (       ) <br> <br>    ID  <i>resource.h</i> : <br> <br> <code class="cpp">// Unique IDs for each image resource. #define BG_ID 101 #define WHITE_KEY_ID 102 #define BLACK_KEY_ID 103 #define WAVEFORM_ID 104 #define KNOB_ID 105 #define KNOB_SMALL_ID 106 #define FILTERMODE_ID 107 // Image resource locations for this plug. #define BG_FN "resources/img/bg.png" #define WHITE_KEY_FN "resources/img/whitekey.png" #define BLACK_KEY_FN "resources/img/blackkey.png" #define WAVEFORM_FN "resources/img/waveform.png" #define KNOB_FN "resources/img/knob.png" #define KNOB_SMALL_FN "resources/img/knob_small.png" #define FILTERMODE_FN "resources/img/filtermode.png"</code> <br> <br>  <i>Synthesis.rc</i> : <br> <br> <code class="cpp">#include "resource.h" BG_ID PNG BG_FN WHITE_KEY_ID PNG WHITE_KEY_FN BLACK_KEY_ID PNG BLACK_KEY_FN WAVEFORM_ID PNG WAVEFORM_FN KNOB_ID PNG KNOB_FN KNOB_SMALL_ID PNG KNOB_SMALL_FN FILTERMODE_ID PNG FILTERMODE_FN</code> <br> <br>   <code>#include "Filter.h"</code>  <i>Synthesis.h</i>    <code>private</code> : <br> <br> <code class="cpp">Filter mFilter;</code> <br> <br>  <code>EParams</code>  <i>Synthesis.cpp</i> : <br> <br> <code class="cpp">enum EParams { mWaveform = 0, mAttack, mDecay, mSustain, mRelease, mFilterMode, mFilterCutoff, mFilterResonance, mFilterAttack, mFilterDecay, mFilterSustain, mFilterRelease, mFilterEnvelopeAmount, kNumParams };</code> <br> <br>        : <br> <br> <code class="cpp">pGraphics-&gt;AttachControl(new ISwitchControl(this, 24, 38, mWaveform, &amp;waveformBitmap));</code> <br> <br>      .      (Lowpass, Highpass, Bandpass).    <code>AttachGraphics(pGraphics)</code> : <br> <br> <code class="cpp">GetParam(mFilterMode)-&gt;InitEnum("Filter Mode", Filter::FILTER_MODE_LOWPASS, Filter::kNumFilterModes); IBitmap filtermodeBitmap = pGraphics-&gt;LoadIBitmap(FILTERMODE_ID, FILTERMODE_FN, 3); pGraphics-&gt;AttachControl(new ISwitchControl(this, 24, 123, mFilterMode, &amp;filtermodeBitmap));</code> <br> <br>         .    .     <i>knob_small.png</i> : <br> <br> <code class="cpp">// Knobs for filter cutoff and resonance IBitmap smallKnobBitmap = pGraphics-&gt;LoadIBitmap(KNOB_SMALL_ID, KNOB_SMALL_FN, 64); // Cutoff knob: GetParam(mFilterCutoff)-&gt;InitDouble("Cutoff", 0.99, 0.01, 0.99, 0.001); GetParam(mFilterCutoff)-&gt;SetShape(2); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 5, 177, mFilterCutoff, &amp;smallKnobBitmap)); // Resonance knob: GetParam(mFilterResonance)-&gt;InitDouble("Resonance", 0.01, 0.01, 1.0, 0.001); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 61, 177, mFilterResonance, &amp;smallKnobBitmap));</code> <br> <br>   ,           <code>1.0</code> ,   <code>calculateFeedbackAmount</code>    , . <br>  <code>ProcessDoubleReplacing</code>     : <br> <br> <code class="cpp">leftOutput[i] = rightOutput[i] = mFilter.process(mOscillator.nextSample() * mEnvelopeGenerator.nextSample() * velocity / 127.0);</code> <br> <br>       .  <code>switch</code>   <code>Synthesis::OnParamChange</code> : <br> <br> <code class="cpp">case mFilterCutoff: mFilter.setCutoff(GetParam(paramIdx)-&gt;Value()); break; case mFilterResonance: mFilter.setResonance(GetParam(paramIdx)-&gt;Value()); break; case mFilterMode: mFilter.setFilterMode(static_cast&lt;Filter::FilterMode&gt;(GetParam(paramIdx)-&gt;Int())); break;</code> <br> <br>    .  -      . <br> <br>  <br> <br>  ‚Äî      .   ,   ,          . <br>      : <br> <br> <code class="cpp">buf0 += cutoff * (inputValue - buf0 + feedbackAmount * (buf0 - buf1));</code> <br> <br> ,   ,      ( <code>buf0 ‚Äì buf1</code> ),   <code>feedbackAmount</code> .    <code>calculateFeedbackAmount</code>  <code>feedbackAmount</code>  <code>resonance</code> , . .    ,   . <br> <br>  ,            .     ,  <i></i> ,      <a href="https://www.youtube.com/watch%3Fv%3DJWyMj6KxGHM"> </a> .    ,        ,       . <br> <br>  -12 /  -24 / <br>        !     24   .     <code>switch</code>  <code>Filter::process</code> : <br> <br> <code class="cpp">buf2 += cutoff * (buf1 - buf2); buf3 += cutoff * (buf2 ‚Äì buf3);</code> <br> <br>   :      ,       ,            .     ,       , , <a href="https://ccrma.stanford.edu/~Jos/filters/Filter_Stability.html"></a> (       ).     <code>switch</code> : <br> <br> <code class="cpp">switch (mode) { case FILTER_MODE_LOWPASS: return buf3; case FILTER_MODE_HIGHPASS: return inputValue - buf3; case FILTER_MODE_BANDPASS: return buf0 - buf3; default: return 0.0; }</code> <br> <br>   <code>buf1</code>  <code>buf3</code> ‚Äì      .    -24 /.     <code>buf2</code>  <code>buf3</code> ,        <code>private</code> <i>Filter.h</i> : <br> <br> <code class="cpp">double buf2; double buf3;</code> <br> <br>    ,   <code>buf0</code> c <code>buf1</code> : <br> <br> <code class="cpp">Filter() : // ... buf0(0.0), buf1(0.0), buf2(0.0), buf3(0.0) // ...</code> <br> <br>     , ,     :     .       . <br>          ? <br> <br>   <br>    .  ,           ,       . <br> -      <code>cutoff</code>   .      .    <code>cutoffMod</code> ,    ,       <code>cutoff</code>    .     <code><code>#include    private</code> : <br> <br> <code class="cpp">double cutoffMod;</code> <br> <br> : <br> <br> <code class="cpp">Filter() : cutoff(0.99), resonance(0.01), cutoffMod(0.0), // ...</code> <br> <br>         .   <code>private</code> : <br> <br> <code class="cpp">inline double getCalculatedCutoff() const { return fmax(fmin(cutoff + cutoffMod, 0.99), 0.01); };</code> <br> <br> <code>calculateFeedbackAmount</code>     : <br> <br> <code class="cpp">inline void calculateFeedbackAmount() { feedbackAmount = resonance + resonance/(1.0 - getCalculatedCutoff()); }</code> <br> <br>       <code>cutoffMod</code> .   <code>feedbackAmount</code>    ,     : <br> <br> <code class="cpp">inline void setCutoffMod(double newCutoffMod) { cutoffMod = newCutoffMod; calculateFeedbackAmount(); }</code> <br> <br> ,       .   <code>Filter::process</code>   : <br> <br> <code class="cpp">if (inputValue == 0.0) return inputValue; double calculatedCutoff = getCalculatedCutoff(); buf0 += calculatedCutoff * (inputValue - buf0 + feedbackAmount * (buf0 - buf1)); buf1 += calculatedCutoff * (buf0 - buf1); buf2 += calculatedCutoff * (buf1 - buf2); buf3 += calculatedCutoff * (buf2 ‚Äì buf3);</code> <br> <br>        ,    .    ,      ,   .     .     <code>cutoff</code>  <code>calculatedCutoff</code>   -. <br> <br> ,       ( <code>setCutoffMod</code> ),   <code>Synthesis</code>    ,     ,    .    ,        <code>cutoffMod</code> .    <code>filterEnvelopeAmount</code>    <code>-1</code>  <code>+1</code> .   GUI. <br> <br>   <code>private</code> <i>Synthesis.h</i>    : <br> <br> <code class="cpp">EnvelopeGenerator mFilterEnvelopeGenerator; double filterEnvelopeAmount;</code> <br> <br>       MIDI ,      <code>onNoteOn</code>  <code>onNoteOff</code> : <br> <br> <code class="cpp">inline void onNoteOn(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); mFilterEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); }; inline void onNoteOff(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); mFilterEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); };</code> <br> <br>    .   <code>ProcessDoubleReplacing</code>        : <br> <br> <code class="cpp">mFilter.setCutoffMod(mFilterEnvelopeGenerator.nextSample() * filterEnvelopeAmount);</code> <br> <br>  ,        <code>nextSample</code>  <code>filterEnvelopeAmount</code>     <code>cutoffMod</code> .     <code>filterEnvelopeAmount</code>  : <br> <br> <code class="cpp">Synthesis::Synthesis(IPlugInstanceInfo instanceInfo) : IPLUG_CTOR(kNumParams, kNumPrograms, instanceInfo), lastVirtualKeyboardNoteNumber(virtualKeyboardMinimumNoteNumber - 1), filterEnvelopeAmount(0.0) { // ... }</code> <br> <br>       <code>Synthesis::Reset</code> : <br> <br> <code class="cpp">mFilterEnvelopeGenerator.setSampleRate(GetSampleRate());</code> <br> <br>      <code>EParams</code> ,       .  <code>AttachGraphics</code>     : <br> <br> <code class="cpp">// Knobs for filter envelope // Attack knob GetParam(mFilterAttack)-&gt;InitDouble("Filter Env Attack", 0.01, 0.01, 10.0, 0.001); GetParam(mFilterAttack)-&gt;SetShape(3); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 139, 178, mFilterAttack, &amp;smallKnobBitmap)); // Decay knob: GetParam(mFilterDecay)-&gt;InitDouble("Filter Env Decay", 0.5, 0.01, 15.0, 0.001); GetParam(mFilterDecay)-&gt;SetShape(3); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 195, 178, mFilterDecay, &amp;smallKnobBitmap)); // Sustain knob: GetParam(mFilterSustain)-&gt;InitDouble("Filter Env Sustain", 0.1, 0.001, 1.0, 0.001); GetParam(mFilterSustain)-&gt;SetShape(2); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 251, 178, mFilterSustain, &amp;smallKnobBitmap)); // Release knob: GetParam(mFilterRelease)-&gt;InitDouble("Filter Env Release", 1.0, 0.001, 15.0, 0.001); GetParam(mFilterRelease)-&gt;SetShape(3); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 307, 178, mFilterRelease, &amp;smallKnobBitmap)); // Filter envelope amount knob: GetParam(mFilterEnvelopeAmount)-&gt;InitDouble("Filter Env Amount", 0.0, -1.0, 1.0, 0.001); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 363, 178, mFilterEnvelopeAmount, &amp;smallKnobBitmap));</code> <br> <br>     ,       <code>smallKnobBitmap</code> .                   .     ,    .  <code>Synthesis::OnParamChange</code>    <code>switch</code> : <br> <br> <code class="cpp">case mFilterAttack: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK, GetParam(paramIdx)-&gt;Value()); break; case mFilterDecay: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_DECAY, GetParam(paramIdx)-&gt;Value()); break; case mFilterSustain: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_SUSTAIN, GetParam(paramIdx)-&gt;Value()); break; case mFilterRelease: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE, GetParam(paramIdx)-&gt;Value()); break; case mFilterEnvelopeAmount: filterEnvelopeAmount = GetParam(paramIdx)-&gt;Value(); break;</code> <br> <br> ! <br>     !           (-   C1),   : <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/f5d/757/3f9/f5d7573f9b3a720fe5898d88ae477cfc.png"> <br> <br>        <code>EnvelopeGenerator</code>  .         .        ! <br> <br>    <a href=""></a> . <br> <br>        :) <br> <br>  : <br> <a href="http://martin-finke.de/blog/articles/audio-plugins-013-filter/">martin-finke.de/blog/articles/audio-plugins-013-filter</a></code></code> <pre> <code class="hljs erlang-repl"><code class="cpp">#include  <i>Filter.h</i> ( )     : <br> <br> class Filter { public: enum FilterMode { FILTER_MODE_LOWPASS = <span class="hljs-number"><span class="hljs-number">0</span></span>, FILTER_MODE_HIGHPASS, FILTER_MODE_BANDPASS, kNumFilterModes }; Filter() : cutoff(<span class="hljs-number"><span class="hljs-number">0.99</span></span>), resonance(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), mode(FILTER_MODE_LOWPASS), buf0(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), buf1(<span class="hljs-number"><span class="hljs-number">0.0</span></span>) { calculateFeedbackAmount(); }; double process(double inputValue); inline void setCutoff(double newCutoff) { cutoff = newCutoff; calculateFeedbackAmount(); }; inline void setResonance(double newResonance) { resonance = newResonance; calculateFeedbackAmount(); }; inline void setFilterMode(FilterMode newMode) { mode = newMode; } private: double cutoff; double resonance; FilterMode mode; double feedbackAmount; inline void calculateFeedbackAmount() { feedbackAmount = resonance + resonance/(<span class="hljs-number"><span class="hljs-number">1.0</span></span> - cutoff); } double buf0; double buf1; };</code> <br> <br>  <code>private</code>     <i> </i> <code>cutoff</code>  <i></i> <code>resonance</code> . <code>Mode</code>      (Lowpass, Highpass, Bandpass).  <code>feedbackAmount</code> , <code>buf0</code>  <code>buf1</code>    ,    . <br>          ( <code>calculateFeedbackAmount()</code> ).  <code>process</code>      .   <code>feedbackAmount</code>   <code>cutoff</code>  <code>resonance</code> ,    <code>calculateFeedbackAmount</code>      . <br> <br>   <i>Filter.cpp</i>  : <br> <br> <code class="cpp">// By Paul Kellett // http://www.musicdsp.org/showone.php?id=<span class="hljs-number"><span class="hljs-number">29</span></span> double Filter::process(double inputValue) { buf0 += cutoff * (inputValue - buf0); buf1 += cutoff * (buf0 - buf1); switch (mode) { case FILTER_MODE_LOWPASS: return buf1; case FILTER_MODE_HIGHPASS: return inputValue - buf0; case FILTER_MODE_BANDPASS: return buf0 - buf1; default: return <span class="hljs-number"><span class="hljs-number">0.0</span></span>; } }</code> <br> <br> , ?  ,         <i> </i> . ¬´ ¬ª   ,               (. .    <span class="hljs-number"><span class="hljs-number">6</span></span> ).     <code>buf0</code>  <code>buf1</code> :        .     <code>inputValue</code> ,  - <code>buf0</code> (  ).   .    <span class="hljs-number"><span class="hljs-number">6</span></span> /   <span class="hljs-number"><span class="hljs-number">12</span></span> /.  <code>switch</code> ,  <code>buf1</code>    . , ,    <code>buf0</code> ,       <span class="hljs-number"><span class="hljs-number">12</span></span>,   <span class="hljs-number"><span class="hljs-number">6</span></span> /,        . <br> <br>  <code>case</code> <code>FILTER_MODE_HIGHPASS</code>    . <code>buf0</code>       .   <code>inputValue</code>  <code>buf0</code> ,   .    <code>buf1</code> ,     . <br> <br>  <code>case</code> <code>FILTER_MODE_BANDPASS</code> ,  <code>buf0 - buf1</code>   .  <code>buf0</code>       ,     <code>buf1</code> . ,   . <br>  :    <i> </i>    <i> </i> ,   . <br> <br>  <code>buf1</code>     .       <a href="http://ru.wikipedia.org/wiki/%25D0%25A4%25D0%25B8%25D0%25BB%25D1%258C%25D1%2582%25D1%2580_%25D1%2581_%25D0%25B1%25D0%25B5%25D1%2581%25D0%25BA%25D0%25BE%25D0%25BD%25D0%25B5%25D1%2587%25D0%25BD%25D0%25BE%25D0%25B9_%25D0%25B8%25D0%25BC%25D0%25BF%25D1%2583%25D0%25BB%25D1%258C%25D1%2581%25D0%25BD%25D0%25BE%25D0%25B9_%25D1%2585%25D0%25B0%25D1%2580%25D0%25B0%25D0%25BA%25D1%2582%25D0%25B5%25D1%2580%25D0%25B8%25D1%2581%25D1%2582%25D0%25B8%25D0%25BA%25D0%25BE%25D0%25B9">    </a> ( <i>Infinite Impulse Response</i> ,  <i>IIR</i> ).  <a href="http://www.dspguide.com/ch14/1.htm"> </a> ,      .      ,         ,      . <br> <br>   <br>       ,     ,     .   ,  ,      ,  ,          .           ,  NI Massive,   ¬´ <a href="http://lurkmore.to/%25D0%25A2%25D1%2591%25D0%25BF%25D0%25BB%25D1%258B%25D0%25B9_%25D0%25BB%25D0%25B0%25D0%25BC%25D0%25BF%25D0%25BE%25D0%25B2%25D1%258B%25D0%25B9_%25D0%25B7%25D0%25B2%25D1%2583%25D0%25BA">  </a> ¬ª.       ,          ,   .        ,          (  Massive       ).      ¬´¬ª , , , AAS Ultra Analog,       ,     ,    ,        .         ,  ,    <a href="http://www.kvraudio.com/forum/viewtopic.php%3Ft%3D350246"></a> ,   ,      NI Reaktor. ,            ‚Äî    ,    ..     . <br> <br>   <br>     .   GUI.  <i>bg.png</i>   ( <i>‚ÄúMove to trash‚Äù</i>  Xcode),       : <br> <br> <a href="">filtermode.png</a> <a href="">knob_small.png</a> (  ,   <span class="hljs-number"><span class="hljs-number">50</span></span> <span class="hljs-number"><span class="hljs-number">50</span></span> ) <a href="">bg.png</a> (       ) <br> <br>    ID  <i>resource.h</i> : <br> <br> <code class="cpp">// Unique IDs for each image resource. #define BG_ID <span class="hljs-number"><span class="hljs-number">101</span></span> #define WHITE_KEY_ID <span class="hljs-number"><span class="hljs-number">102</span></span> #define BLACK_KEY_ID <span class="hljs-number"><span class="hljs-number">103</span></span> #define WAVEFORM_ID <span class="hljs-number"><span class="hljs-number">104</span></span> #define KNOB_ID <span class="hljs-number"><span class="hljs-number">105</span></span> #define KNOB_SMALL_ID <span class="hljs-number"><span class="hljs-number">106</span></span> #define FILTERMODE_ID <span class="hljs-number"><span class="hljs-number">107</span></span> // Image resource locations for this plug. #define BG_FN <span class="hljs-string"><span class="hljs-string">"resources/img/bg.png"</span></span> #define WHITE_KEY_FN <span class="hljs-string"><span class="hljs-string">"resources/img/whitekey.png"</span></span> #define BLACK_KEY_FN <span class="hljs-string"><span class="hljs-string">"resources/img/blackkey.png"</span></span> #define WAVEFORM_FN <span class="hljs-string"><span class="hljs-string">"resources/img/waveform.png"</span></span> #define KNOB_FN <span class="hljs-string"><span class="hljs-string">"resources/img/knob.png"</span></span> #define KNOB_SMALL_FN <span class="hljs-string"><span class="hljs-string">"resources/img/knob_small.png"</span></span> #define FILTERMODE_FN <span class="hljs-string"><span class="hljs-string">"resources/img/filtermode.png"</span></span></code> <br> <br>  <i>Synthesis.rc</i> : <br> <br> <code class="cpp">#include <span class="hljs-string"><span class="hljs-string">"resource.h"</span></span> BG_ID PNG BG_FN WHITE_KEY_ID PNG WHITE_KEY_FN BLACK_KEY_ID PNG BLACK_KEY_FN WAVEFORM_ID PNG WAVEFORM_FN KNOB_ID PNG KNOB_FN KNOB_SMALL_ID PNG KNOB_SMALL_FN FILTERMODE_ID PNG FILTERMODE_FN</code> <br> <br>   <code>#include <span class="hljs-string"><span class="hljs-string">"Filter.h"</span></span></code>  <i>Synthesis.h</i>    <code>private</code> : <br> <br> <code class="cpp">Filter mFilter;</code> <br> <br>  <code>EParams</code>  <i>Synthesis.cpp</i> : <br> <br> <code class="cpp">enum EParams { mWaveform = <span class="hljs-number"><span class="hljs-number">0</span></span>, mAttack, mDecay, mSustain, mRelease, mFilterMode, mFilterCutoff, mFilterResonance, mFilterAttack, mFilterDecay, mFilterSustain, mFilterRelease, mFilterEnvelopeAmount, kNumParams };</code> <br> <br>        : <br> <br> <code class="cpp">pGraphics-&gt;AttachControl(new ISwitchControl(this, <span class="hljs-number"><span class="hljs-number">24</span></span>, <span class="hljs-number"><span class="hljs-number">38</span></span>, mWaveform, &amp;waveformBitmap));</code> <br> <br>      .      (Lowpass, Highpass, Bandpass).    <code>AttachGraphics(pGraphics)</code> : <br> <br> <code class="cpp">GetParam(mFilterMode)-&gt;InitEnum(<span class="hljs-string"><span class="hljs-string">"Filter Mode"</span></span>, Filter::FILTER_MODE_LOWPASS, Filter::kNumFilterModes); IBitmap filtermodeBitmap = pGraphics-&gt;LoadIBitmap(FILTERMODE_ID, FILTERMODE_FN, <span class="hljs-number"><span class="hljs-number">3</span></span>); pGraphics-&gt;AttachControl(new ISwitchControl(this, <span class="hljs-number"><span class="hljs-number">24</span></span>, <span class="hljs-number"><span class="hljs-number">123</span></span>, mFilterMode, &amp;filtermodeBitmap));</code> <br> <br>         .    .     <i>knob_small.png</i> : <br> <br> <code class="cpp">// Knobs for filter cutoff and resonance IBitmap smallKnobBitmap = pGraphics-&gt;LoadIBitmap(KNOB_SMALL_ID, KNOB_SMALL_FN, <span class="hljs-number"><span class="hljs-number">64</span></span>); // Cutoff knob: GetParam(mFilterCutoff)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Cutoff"</span></span>, <span class="hljs-number"><span class="hljs-number">0.99</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">0.99</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); GetParam(mFilterCutoff)-&gt;SetShape(<span class="hljs-number"><span class="hljs-number">2</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-number"><span class="hljs-number">177</span></span>, mFilterCutoff, &amp;smallKnobBitmap)); // Resonance knob: GetParam(mFilterResonance)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Resonance"</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">61</span></span>, <span class="hljs-number"><span class="hljs-number">177</span></span>, mFilterResonance, &amp;smallKnobBitmap));</code> <br> <br>   ,           <code><span class="hljs-number"><span class="hljs-number">1.0</span></span></code> ,   <code>calculateFeedbackAmount</code>    , . <br>  <code>ProcessDoubleReplacing</code>     : <br> <br> <code class="cpp">leftOutput[i] = rightOutput[i] = mFilter.process(mOscillator.nextSample() * mEnvelopeGenerator.nextSample() * velocity / <span class="hljs-number"><span class="hljs-number">127.0</span></span>);</code> <br> <br>       .  <code>switch</code>   <code>Synthesis::OnParamChange</code> : <br> <br> <code class="cpp">case mFilterCutoff: mFilter.setCutoff(GetParam(paramIdx)-&gt;Value()); break; case mFilterResonance: mFilter.setResonance(GetParam(paramIdx)-&gt;Value()); break; case mFilterMode: mFilter.setFilterMode(static_cast&lt;Filter::FilterMode&gt;(GetParam(paramIdx)-&gt;Int())); break;</code> <br> <br>    .  -      . <br> <br>  <br> <br>  ‚Äî      .   ,   ,          . <br>      : <br> <br> <code class="cpp">buf0 += cutoff * (inputValue - buf0 + feedbackAmount * (buf0 - buf1));</code> <br> <br> ,   ,      ( <code>buf0 ‚Äì buf1</code> ),   <code>feedbackAmount</code> .    <code>calculateFeedbackAmount</code>  <code>feedbackAmount</code>  <code>resonance</code> , . .    ,   . <br> <br>  ,            .     ,  <i></i> ,      <a href="https://www.youtube.com/watch%3Fv%3DJWyMj6KxGHM"> </a> .    ,        ,       . <br> <br>  -<span class="hljs-number"><span class="hljs-number">12</span></span> /  -<span class="hljs-number"><span class="hljs-number">24</span></span> / <br>        !     <span class="hljs-number"><span class="hljs-number">24</span></span>   .     <code>switch</code>  <code>Filter::process</code> : <br> <br> <code class="cpp">buf2 += cutoff * (buf1 - buf2); buf3 += cutoff * (buf2 ‚Äì buf3);</code> <br> <br>   :      ,       ,            .     ,       , , <a href="https://ccrma.stanford.edu/~Jos/filters/Filter_Stability.html"></a> (       ).     <code>switch</code> : <br> <br> <code class="cpp">switch (mode) { case FILTER_MODE_LOWPASS: return buf3; case FILTER_MODE_HIGHPASS: return inputValue - buf3; case FILTER_MODE_BANDPASS: return buf0 - buf3; default: return <span class="hljs-number"><span class="hljs-number">0.0</span></span>; }</code> <br> <br>   <code>buf1</code>  <code>buf3</code> ‚Äì      .    -<span class="hljs-number"><span class="hljs-number">24</span></span> /.     <code>buf2</code>  <code>buf3</code> ,        <code>private</code> <i>Filter.h</i> : <br> <br> <code class="cpp">double buf2; double buf3;</code> <br> <br>    ,   <code>buf0</code> c <code>buf1</code> : <br> <br> <code class="cpp">Filter() : // ... buf0(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), buf1(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), buf2(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), buf3(<span class="hljs-number"><span class="hljs-number">0.0</span></span>) // ...</code> <br> <br>     , ,     :     .       . <br>          ? <br> <br>   <br>    .  ,           ,       . <br> -      <code>cutoff</code>   .      .    <code>cutoffMod</code> ,    ,       <code>cutoff</code>    .     <code><code>#include    private</code> : <br> <br> <code class="cpp">double cutoffMod;</code> <br> <br> : <br> <br> <code class="cpp">Filter() : cutoff(<span class="hljs-number"><span class="hljs-number">0.99</span></span>), resonance(<span class="hljs-number"><span class="hljs-number">0.01</span></span>), cutoffMod(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), // ...</code> <br> <br>         .   <code>private</code> : <br> <br> <code class="cpp">inline double getCalculatedCutoff() const { return fmax(fmin(cutoff + cutoffMod, <span class="hljs-number"><span class="hljs-number">0.99</span></span>), <span class="hljs-number"><span class="hljs-number">0.01</span></span>); };</code> <br> <br> <code>calculateFeedbackAmount</code>     : <br> <br> <code class="cpp">inline void calculateFeedbackAmount() { feedbackAmount = resonance + resonance/(<span class="hljs-number"><span class="hljs-number">1.0</span></span> - getCalculatedCutoff()); }</code> <br> <br>       <code>cutoffMod</code> .   <code>feedbackAmount</code>    ,     : <br> <br> <code class="cpp">inline void setCutoffMod(double newCutoffMod) { cutoffMod = newCutoffMod; calculateFeedbackAmount(); }</code> <br> <br> ,       .   <code>Filter::process</code>   : <br> <br> <code class="cpp">if (inputValue == <span class="hljs-number"><span class="hljs-number">0.0</span></span>) return inputValue; double calculatedCutoff = getCalculatedCutoff(); buf0 += calculatedCutoff * (inputValue - buf0 + feedbackAmount * (buf0 - buf1)); buf1 += calculatedCutoff * (buf0 - buf1); buf2 += calculatedCutoff * (buf1 - buf2); buf3 += calculatedCutoff * (buf2 ‚Äì buf3);</code> <br> <br>        ,    .    ,      ,   .     .     <code>cutoff</code>  <code>calculatedCutoff</code>   -. <br> <br> ,       ( <code>setCutoffMod</code> ),   <code>Synthesis</code>    ,     ,    .    ,        <code>cutoffMod</code> .    <code>filterEnvelopeAmount</code>    <code>-<span class="hljs-number"><span class="hljs-number">1</span></span></code>  <code>+<span class="hljs-number"><span class="hljs-number">1</span></span></code> .   GUI. <br> <br>   <code>private</code> <i>Synthesis.h</i>    : <br> <br> <code class="cpp">EnvelopeGenerator mFilterEnvelopeGenerator; double filterEnvelopeAmount;</code> <br> <br>       MIDI ,      <code>onNoteOn</code>  <code>onNoteOff</code> : <br> <br> <code class="cpp">inline void onNoteOn(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); mFilterEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); }; inline void onNoteOff(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); mFilterEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); };</code> <br> <br>    .   <code>ProcessDoubleReplacing</code>        : <br> <br> <code class="cpp">mFilter.setCutoffMod(mFilterEnvelopeGenerator.nextSample() * filterEnvelopeAmount);</code> <br> <br>  ,        <code>nextSample</code>  <code>filterEnvelopeAmount</code>     <code>cutoffMod</code> .     <code>filterEnvelopeAmount</code>  : <br> <br> <code class="cpp">Synthesis::Synthesis(IPlugInstanceInfo instanceInfo) : IPLUG_CTOR(kNumParams, kNumPrograms, instanceInfo), lastVirtualKeyboardNoteNumber(virtualKeyboardMinimumNoteNumber - <span class="hljs-number"><span class="hljs-number">1</span></span>), filterEnvelopeAmount(<span class="hljs-number"><span class="hljs-number">0.0</span></span>) { // ... }</code> <br> <br>       <code>Synthesis::Reset</code> : <br> <br> <code class="cpp">mFilterEnvelopeGenerator.setSampleRate(GetSampleRate());</code> <br> <br>      <code>EParams</code> ,       .  <code>AttachGraphics</code>     : <br> <br> <code class="cpp">// Knobs for filter envelope // Attack knob GetParam(mFilterAttack)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Filter Env Attack"</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">10.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); GetParam(mFilterAttack)-&gt;SetShape(<span class="hljs-number"><span class="hljs-number">3</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">139</span></span>, <span class="hljs-number"><span class="hljs-number">178</span></span>, mFilterAttack, &amp;smallKnobBitmap)); // Decay knob: GetParam(mFilterDecay)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Filter Env Decay"</span></span>, <span class="hljs-number"><span class="hljs-number">0.5</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">15.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); GetParam(mFilterDecay)-&gt;SetShape(<span class="hljs-number"><span class="hljs-number">3</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">195</span></span>, <span class="hljs-number"><span class="hljs-number">178</span></span>, mFilterDecay, &amp;smallKnobBitmap)); // Sustain knob: GetParam(mFilterSustain)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Filter Env Sustain"</span></span>, <span class="hljs-number"><span class="hljs-number">0.1</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>, <span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); GetParam(mFilterSustain)-&gt;SetShape(<span class="hljs-number"><span class="hljs-number">2</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">251</span></span>, <span class="hljs-number"><span class="hljs-number">178</span></span>, mFilterSustain, &amp;smallKnobBitmap)); // Release knob: GetParam(mFilterRelease)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Filter Env Release"</span></span>, <span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>, <span class="hljs-number"><span class="hljs-number">15.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); GetParam(mFilterRelease)-&gt;SetShape(<span class="hljs-number"><span class="hljs-number">3</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">307</span></span>, <span class="hljs-number"><span class="hljs-number">178</span></span>, mFilterRelease, &amp;smallKnobBitmap)); // Filter envelope amount knob: GetParam(mFilterEnvelopeAmount)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Filter Env Amount"</span></span>, <span class="hljs-number"><span class="hljs-number">0.0</span></span>, -<span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">363</span></span>, <span class="hljs-number"><span class="hljs-number">178</span></span>, mFilterEnvelopeAmount, &amp;smallKnobBitmap));</code> <br> <br>     ,       <code>smallKnobBitmap</code> .                   .     ,    .  <code>Synthesis::OnParamChange</code>    <code>switch</code> : <br> <br> <code class="cpp">case mFilterAttack: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK, GetParam(paramIdx)-&gt;Value()); break; case mFilterDecay: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_DECAY, GetParam(paramIdx)-&gt;Value()); break; case mFilterSustain: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_SUSTAIN, GetParam(paramIdx)-&gt;Value()); break; case mFilterRelease: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE, GetParam(paramIdx)-&gt;Value()); break; case mFilterEnvelopeAmount: filterEnvelopeAmount = GetParam(paramIdx)-&gt;Value(); break;</code> <br> <br> ! <br>     !           (-   C1),   : <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/f5d/757/3f9/f5d7573f9b3a720fe5898d88ae477cfc.png"> <br> <br>        <code>EnvelopeGenerator</code>  .         .        ! <br> <br>    <a href=""></a> . <br> <br>        :) <br> <br>  : <br> <a href="http://martin-finke.de/blog/articles/audio-plugins-013-filter/">martin-finke.de/blog/articles/audio-plugins-<span class="hljs-number"><span class="hljs-number">013</span></span>-filter</a></code></code> </pre> <code><code class="cpp">#include  <i>Filter.h</i> ( )     : <br> <br> class Filter { public: enum FilterMode { FILTER_MODE_LOWPASS = 0, FILTER_MODE_HIGHPASS, FILTER_MODE_BANDPASS, kNumFilterModes }; Filter() : cutoff(0.99), resonance(0.0), mode(FILTER_MODE_LOWPASS), buf0(0.0), buf1(0.0) { calculateFeedbackAmount(); }; double process(double inputValue); inline void setCutoff(double newCutoff) { cutoff = newCutoff; calculateFeedbackAmount(); }; inline void setResonance(double newResonance) { resonance = newResonance; calculateFeedbackAmount(); }; inline void setFilterMode(FilterMode newMode) { mode = newMode; } private: double cutoff; double resonance; FilterMode mode; double feedbackAmount; inline void calculateFeedbackAmount() { feedbackAmount = resonance + resonance/(1.0 - cutoff); } double buf0; double buf1; };</code> <br> <br>  <code>private</code>     <i> </i> <code>cutoff</code>  <i></i> <code>resonance</code> . <code>Mode</code>      (Lowpass, Highpass, Bandpass).  <code>feedbackAmount</code> , <code>buf0</code>  <code>buf1</code>    ,    . <br>          ( <code>calculateFeedbackAmount()</code> ).  <code>process</code>      .   <code>feedbackAmount</code>   <code>cutoff</code>  <code>resonance</code> ,    <code>calculateFeedbackAmount</code>      . <br> <br>   <i>Filter.cpp</i>  : <br> <br> <code class="cpp">// By Paul Kellett // http://www.musicdsp.org/showone.php?id=29 double Filter::process(double inputValue) { buf0 += cutoff * (inputValue - buf0); buf1 += cutoff * (buf0 - buf1); switch (mode) { case FILTER_MODE_LOWPASS: return buf1; case FILTER_MODE_HIGHPASS: return inputValue - buf0; case FILTER_MODE_BANDPASS: return buf0 - buf1; default: return 0.0; } }</code> <br> <br> , ?  ,         <i> </i> . ¬´ ¬ª   ,               (. .    6 ).     <code>buf0</code>  <code>buf1</code> :        .     <code>inputValue</code> ,  - <code>buf0</code> (  ).   .    6 /   12 /.  <code>switch</code> ,  <code>buf1</code>    . , ,    <code>buf0</code> ,       12,   6 /,        . <br> <br>  <code>case</code> <code>FILTER_MODE_HIGHPASS</code>    . <code>buf0</code>       .   <code>inputValue</code>  <code>buf0</code> ,   .    <code>buf1</code> ,     . <br> <br>  <code>case</code> <code>FILTER_MODE_BANDPASS</code> ,  <code>buf0 - buf1</code>   .  <code>buf0</code>       ,     <code>buf1</code> . ,   . <br>  :    <i> </i>    <i> </i> ,   . <br> <br>  <code>buf1</code>     .       <a href="http://ru.wikipedia.org/wiki/%25D0%25A4%25D0%25B8%25D0%25BB%25D1%258C%25D1%2582%25D1%2580_%25D1%2581_%25D0%25B1%25D0%25B5%25D1%2581%25D0%25BA%25D0%25BE%25D0%25BD%25D0%25B5%25D1%2587%25D0%25BD%25D0%25BE%25D0%25B9_%25D0%25B8%25D0%25BC%25D0%25BF%25D1%2583%25D0%25BB%25D1%258C%25D1%2581%25D0%25BD%25D0%25BE%25D0%25B9_%25D1%2585%25D0%25B0%25D1%2580%25D0%25B0%25D0%25BA%25D1%2582%25D0%25B5%25D1%2580%25D0%25B8%25D1%2581%25D1%2582%25D0%25B8%25D0%25BA%25D0%25BE%25D0%25B9">    </a> ( <i>Infinite Impulse Response</i> ,  <i>IIR</i> ).  <a href="http://www.dspguide.com/ch14/1.htm"> </a> ,      .      ,         ,      . <br> <br>   <br>       ,     ,     .   ,  ,      ,  ,          .           ,  NI Massive,   ¬´ <a href="http://lurkmore.to/%25D0%25A2%25D1%2591%25D0%25BF%25D0%25BB%25D1%258B%25D0%25B9_%25D0%25BB%25D0%25B0%25D0%25BC%25D0%25BF%25D0%25BE%25D0%25B2%25D1%258B%25D0%25B9_%25D0%25B7%25D0%25B2%25D1%2583%25D0%25BA">  </a> ¬ª.       ,          ,   .        ,          (  Massive       ).      ¬´¬ª , , , AAS Ultra Analog,       ,     ,    ,        .         ,  ,    <a href="http://www.kvraudio.com/forum/viewtopic.php%3Ft%3D350246"></a> ,   ,      NI Reaktor. ,            ‚Äî    ,    ..     . <br> <br>   <br>     .   GUI.  <i>bg.png</i>   ( <i>‚ÄúMove to trash‚Äù</i>  Xcode),       : <br> <br> <a href="">filtermode.png</a> <a href="">knob_small.png</a> (  ,   50 50 ) <a href="">bg.png</a> (       ) <br> <br>    ID  <i>resource.h</i> : <br> <br> <code class="cpp">// Unique IDs for each image resource. #define BG_ID 101 #define WHITE_KEY_ID 102 #define BLACK_KEY_ID 103 #define WAVEFORM_ID 104 #define KNOB_ID 105 #define KNOB_SMALL_ID 106 #define FILTERMODE_ID 107 // Image resource locations for this plug. #define BG_FN "resources/img/bg.png" #define WHITE_KEY_FN "resources/img/whitekey.png" #define BLACK_KEY_FN "resources/img/blackkey.png" #define WAVEFORM_FN "resources/img/waveform.png" #define KNOB_FN "resources/img/knob.png" #define KNOB_SMALL_FN "resources/img/knob_small.png" #define FILTERMODE_FN "resources/img/filtermode.png"</code> <br> <br>  <i>Synthesis.rc</i> : <br> <br> <code class="cpp">#include "resource.h" BG_ID PNG BG_FN WHITE_KEY_ID PNG WHITE_KEY_FN BLACK_KEY_ID PNG BLACK_KEY_FN WAVEFORM_ID PNG WAVEFORM_FN KNOB_ID PNG KNOB_FN KNOB_SMALL_ID PNG KNOB_SMALL_FN FILTERMODE_ID PNG FILTERMODE_FN</code> <br> <br>   <code>#include "Filter.h"</code>  <i>Synthesis.h</i>    <code>private</code> : <br> <br> <code class="cpp">Filter mFilter;</code> <br> <br>  <code>EParams</code>  <i>Synthesis.cpp</i> : <br> <br> <code class="cpp">enum EParams { mWaveform = 0, mAttack, mDecay, mSustain, mRelease, mFilterMode, mFilterCutoff, mFilterResonance, mFilterAttack, mFilterDecay, mFilterSustain, mFilterRelease, mFilterEnvelopeAmount, kNumParams };</code> <br> <br>        : <br> <br> <code class="cpp">pGraphics-&gt;AttachControl(new ISwitchControl(this, 24, 38, mWaveform, &amp;waveformBitmap));</code> <br> <br>      .      (Lowpass, Highpass, Bandpass).    <code>AttachGraphics(pGraphics)</code> : <br> <br> <code class="cpp">GetParam(mFilterMode)-&gt;InitEnum("Filter Mode", Filter::FILTER_MODE_LOWPASS, Filter::kNumFilterModes); IBitmap filtermodeBitmap = pGraphics-&gt;LoadIBitmap(FILTERMODE_ID, FILTERMODE_FN, 3); pGraphics-&gt;AttachControl(new ISwitchControl(this, 24, 123, mFilterMode, &amp;filtermodeBitmap));</code> <br> <br>         .    .     <i>knob_small.png</i> : <br> <br> <code class="cpp">// Knobs for filter cutoff and resonance IBitmap smallKnobBitmap = pGraphics-&gt;LoadIBitmap(KNOB_SMALL_ID, KNOB_SMALL_FN, 64); // Cutoff knob: GetParam(mFilterCutoff)-&gt;InitDouble("Cutoff", 0.99, 0.01, 0.99, 0.001); GetParam(mFilterCutoff)-&gt;SetShape(2); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 5, 177, mFilterCutoff, &amp;smallKnobBitmap)); // Resonance knob: GetParam(mFilterResonance)-&gt;InitDouble("Resonance", 0.01, 0.01, 1.0, 0.001); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 61, 177, mFilterResonance, &amp;smallKnobBitmap));</code> <br> <br>   ,           <code>1.0</code> ,   <code>calculateFeedbackAmount</code>    , . <br>  <code>ProcessDoubleReplacing</code>     : <br> <br> <code class="cpp">leftOutput[i] = rightOutput[i] = mFilter.process(mOscillator.nextSample() * mEnvelopeGenerator.nextSample() * velocity / 127.0);</code> <br> <br>       .  <code>switch</code>   <code>Synthesis::OnParamChange</code> : <br> <br> <code class="cpp">case mFilterCutoff: mFilter.setCutoff(GetParam(paramIdx)-&gt;Value()); break; case mFilterResonance: mFilter.setResonance(GetParam(paramIdx)-&gt;Value()); break; case mFilterMode: mFilter.setFilterMode(static_cast&lt;Filter::FilterMode&gt;(GetParam(paramIdx)-&gt;Int())); break;</code> <br> <br>    .  -      . <br> <br>  <br> <br>  ‚Äî      .   ,   ,          . <br>      : <br> <br> <code class="cpp">buf0 += cutoff * (inputValue - buf0 + feedbackAmount * (buf0 - buf1));</code> <br> <br> ,   ,      ( <code>buf0 ‚Äì buf1</code> ),   <code>feedbackAmount</code> .    <code>calculateFeedbackAmount</code>  <code>feedbackAmount</code>  <code>resonance</code> , . .    ,   . <br> <br>  ,            .     ,  <i></i> ,      <a href="https://www.youtube.com/watch%3Fv%3DJWyMj6KxGHM"> </a> .    ,        ,       . <br> <br>  -12 /  -24 / <br>        !     24   .     <code>switch</code>  <code>Filter::process</code> : <br> <br> <code class="cpp">buf2 += cutoff * (buf1 - buf2); buf3 += cutoff * (buf2 ‚Äì buf3);</code> <br> <br>   :      ,       ,            .     ,       , , <a href="https://ccrma.stanford.edu/~Jos/filters/Filter_Stability.html"></a> (       ).     <code>switch</code> : <br> <br> <code class="cpp">switch (mode) { case FILTER_MODE_LOWPASS: return buf3; case FILTER_MODE_HIGHPASS: return inputValue - buf3; case FILTER_MODE_BANDPASS: return buf0 - buf3; default: return 0.0; }</code> <br> <br>   <code>buf1</code>  <code>buf3</code> ‚Äì      .    -24 /.     <code>buf2</code>  <code>buf3</code> ,        <code>private</code> <i>Filter.h</i> : <br> <br> <code class="cpp">double buf2; double buf3;</code> <br> <br>    ,   <code>buf0</code> c <code>buf1</code> : <br> <br> <code class="cpp">Filter() : // ... buf0(0.0), buf1(0.0), buf2(0.0), buf3(0.0) // ...</code> <br> <br>     , ,     :     .       . <br>          ? <br> <br>   <br>    .  ,           ,       . <br> -      <code>cutoff</code>   .      .    <code>cutoffMod</code> ,    ,       <code>cutoff</code>    .     <code><code>#include    private</code> : <br> <br> <code class="cpp">double cutoffMod;</code> <br> <br> : <br> <br> <code class="cpp">Filter() : cutoff(0.99), resonance(0.01), cutoffMod(0.0), // ...</code> <br> <br>         .   <code>private</code> : <br> <br> <code class="cpp">inline double getCalculatedCutoff() const { return fmax(fmin(cutoff + cutoffMod, 0.99), 0.01); };</code> <br> <br> <code>calculateFeedbackAmount</code>     : <br> <br> <code class="cpp">inline void calculateFeedbackAmount() { feedbackAmount = resonance + resonance/(1.0 - getCalculatedCutoff()); }</code> <br> <br>       <code>cutoffMod</code> .   <code>feedbackAmount</code>    ,     : <br> <br> <code class="cpp">inline void setCutoffMod(double newCutoffMod) { cutoffMod = newCutoffMod; calculateFeedbackAmount(); }</code> <br> <br> ,       .   <code>Filter::process</code>   : <br> <br> <code class="cpp">if (inputValue == 0.0) return inputValue; double calculatedCutoff = getCalculatedCutoff(); buf0 += calculatedCutoff * (inputValue - buf0 + feedbackAmount * (buf0 - buf1)); buf1 += calculatedCutoff * (buf0 - buf1); buf2 += calculatedCutoff * (buf1 - buf2); buf3 += calculatedCutoff * (buf2 ‚Äì buf3);</code> <br> <br>        ,    .    ,      ,   .     .     <code>cutoff</code>  <code>calculatedCutoff</code>   -. <br> <br> ,       ( <code>setCutoffMod</code> ),   <code>Synthesis</code>    ,     ,    .    ,        <code>cutoffMod</code> .    <code>filterEnvelopeAmount</code>    <code>-1</code>  <code>+1</code> .   GUI. <br> <br>   <code>private</code> <i>Synthesis.h</i>    : <br> <br> <code class="cpp">EnvelopeGenerator mFilterEnvelopeGenerator; double filterEnvelopeAmount;</code> <br> <br>       MIDI ,      <code>onNoteOn</code>  <code>onNoteOff</code> : <br> <br> <code class="cpp">inline void onNoteOn(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); mFilterEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); }; inline void onNoteOff(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); mFilterEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); };</code> <br> <br>    .   <code>ProcessDoubleReplacing</code>        : <br> <br> <code class="cpp">mFilter.setCutoffMod(mFilterEnvelopeGenerator.nextSample() * filterEnvelopeAmount);</code> <br> <br>  ,        <code>nextSample</code>  <code>filterEnvelopeAmount</code>     <code>cutoffMod</code> .     <code>filterEnvelopeAmount</code>  : <br> <br> <code class="cpp">Synthesis::Synthesis(IPlugInstanceInfo instanceInfo) : IPLUG_CTOR(kNumParams, kNumPrograms, instanceInfo), lastVirtualKeyboardNoteNumber(virtualKeyboardMinimumNoteNumber - 1), filterEnvelopeAmount(0.0) { // ... }</code> <br> <br>       <code>Synthesis::Reset</code> : <br> <br> <code class="cpp">mFilterEnvelopeGenerator.setSampleRate(GetSampleRate());</code> <br> <br>      <code>EParams</code> ,       .  <code>AttachGraphics</code>     : <br> <br> <code class="cpp">// Knobs for filter envelope // Attack knob GetParam(mFilterAttack)-&gt;InitDouble("Filter Env Attack", 0.01, 0.01, 10.0, 0.001); GetParam(mFilterAttack)-&gt;SetShape(3); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 139, 178, mFilterAttack, &amp;smallKnobBitmap)); // Decay knob: GetParam(mFilterDecay)-&gt;InitDouble("Filter Env Decay", 0.5, 0.01, 15.0, 0.001); GetParam(mFilterDecay)-&gt;SetShape(3); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 195, 178, mFilterDecay, &amp;smallKnobBitmap)); // Sustain knob: GetParam(mFilterSustain)-&gt;InitDouble("Filter Env Sustain", 0.1, 0.001, 1.0, 0.001); GetParam(mFilterSustain)-&gt;SetShape(2); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 251, 178, mFilterSustain, &amp;smallKnobBitmap)); // Release knob: GetParam(mFilterRelease)-&gt;InitDouble("Filter Env Release", 1.0, 0.001, 15.0, 0.001); GetParam(mFilterRelease)-&gt;SetShape(3); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 307, 178, mFilterRelease, &amp;smallKnobBitmap)); // Filter envelope amount knob: GetParam(mFilterEnvelopeAmount)-&gt;InitDouble("Filter Env Amount", 0.0, -1.0, 1.0, 0.001); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 363, 178, mFilterEnvelopeAmount, &amp;smallKnobBitmap));</code> <br> <br>     ,       <code>smallKnobBitmap</code> .                   .     ,    .  <code>Synthesis::OnParamChange</code>    <code>switch</code> : <br> <br> <code class="cpp">case mFilterAttack: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK, GetParam(paramIdx)-&gt;Value()); break; case mFilterDecay: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_DECAY, GetParam(paramIdx)-&gt;Value()); break; case mFilterSustain: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_SUSTAIN, GetParam(paramIdx)-&gt;Value()); break; case mFilterRelease: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE, GetParam(paramIdx)-&gt;Value()); break; case mFilterEnvelopeAmount: filterEnvelopeAmount = GetParam(paramIdx)-&gt;Value(); break;</code> <br> <br> ! <br>     !           (-   C1),   : <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/f5d/757/3f9/f5d7573f9b3a720fe5898d88ae477cfc.png"> <br> <br>        <code>EnvelopeGenerator</code>  .         .        ! <br> <br>    <a href=""></a> . <br> <br>        :) <br> <br>  : <br> <a href="http://martin-finke.de/blog/articles/audio-plugins-013-filter/">martin-finke.de/blog/articles/audio-plugins-013-filter</a></code></code> <h3> <code><code class="cpp">#include  <i>Filter.h</i> ( )     : <br> <br> class Filter { public: enum FilterMode { FILTER_MODE_LOWPASS = 0, FILTER_MODE_HIGHPASS, FILTER_MODE_BANDPASS, kNumFilterModes }; Filter() : cutoff(0.99), resonance(0.0), mode(FILTER_MODE_LOWPASS), buf0(0.0), buf1(0.0) { calculateFeedbackAmount(); }; double process(double inputValue); inline void setCutoff(double newCutoff) { cutoff = newCutoff; calculateFeedbackAmount(); }; inline void setResonance(double newResonance) { resonance = newResonance; calculateFeedbackAmount(); }; inline void setFilterMode(FilterMode newMode) { mode = newMode; } private: double cutoff; double resonance; FilterMode mode; double feedbackAmount; inline void calculateFeedbackAmount() { feedbackAmount = resonance + resonance/(1.0 - cutoff); } double buf0; double buf1; };</code> <br> <br>  <code>private</code>     <i> </i> <code>cutoff</code>  <i></i> <code>resonance</code> . <code>Mode</code>      (Lowpass, Highpass, Bandpass).  <code>feedbackAmount</code> , <code>buf0</code>  <code>buf1</code>    ,    . <br>          ( <code>calculateFeedbackAmount()</code> ).  <code>process</code>      .   <code>feedbackAmount</code>   <code>cutoff</code>  <code>resonance</code> ,    <code>calculateFeedbackAmount</code>      . <br> <br>   <i>Filter.cpp</i>  : <br> <br> <code class="cpp">// By Paul Kellett // http://www.musicdsp.org/showone.php?id=29 double Filter::process(double inputValue) { buf0 += cutoff * (inputValue - buf0); buf1 += cutoff * (buf0 - buf1); switch (mode) { case FILTER_MODE_LOWPASS: return buf1; case FILTER_MODE_HIGHPASS: return inputValue - buf0; case FILTER_MODE_BANDPASS: return buf0 - buf1; default: return 0.0; } }</code> <br> <br> , ?  ,         <i> </i> . ¬´ ¬ª   ,               (. .    6 ).     <code>buf0</code>  <code>buf1</code> :        .     <code>inputValue</code> ,  - <code>buf0</code> (  ).   .    6 /   12 /.  <code>switch</code> ,  <code>buf1</code>    . , ,    <code>buf0</code> ,       12,   6 /,        . <br> <br>  <code>case</code> <code>FILTER_MODE_HIGHPASS</code>    . <code>buf0</code>       .   <code>inputValue</code>  <code>buf0</code> ,   .    <code>buf1</code> ,     . <br> <br>  <code>case</code> <code>FILTER_MODE_BANDPASS</code> ,  <code>buf0 - buf1</code>   .  <code>buf0</code>       ,     <code>buf1</code> . ,   . <br>  :    <i> </i>    <i> </i> ,   . <br> <br>  <code>buf1</code>     .       <a href="http://ru.wikipedia.org/wiki/%25D0%25A4%25D0%25B8%25D0%25BB%25D1%258C%25D1%2582%25D1%2580_%25D1%2581_%25D0%25B1%25D0%25B5%25D1%2581%25D0%25BA%25D0%25BE%25D0%25BD%25D0%25B5%25D1%2587%25D0%25BD%25D0%25BE%25D0%25B9_%25D0%25B8%25D0%25BC%25D0%25BF%25D1%2583%25D0%25BB%25D1%258C%25D1%2581%25D0%25BD%25D0%25BE%25D0%25B9_%25D1%2585%25D0%25B0%25D1%2580%25D0%25B0%25D0%25BA%25D1%2582%25D0%25B5%25D1%2580%25D0%25B8%25D1%2581%25D1%2582%25D0%25B8%25D0%25BA%25D0%25BE%25D0%25B9">    </a> ( <i>Infinite Impulse Response</i> ,  <i>IIR</i> ).  <a href="http://www.dspguide.com/ch14/1.htm"> </a> ,      .      ,         ,      . <br> <br>   <br>       ,     ,     .   ,  ,      ,  ,          .           ,  NI Massive,   ¬´ <a href="http://lurkmore.to/%25D0%25A2%25D1%2591%25D0%25BF%25D0%25BB%25D1%258B%25D0%25B9_%25D0%25BB%25D0%25B0%25D0%25BC%25D0%25BF%25D0%25BE%25D0%25B2%25D1%258B%25D0%25B9_%25D0%25B7%25D0%25B2%25D1%2583%25D0%25BA">  </a> ¬ª.       ,          ,   .        ,          (  Massive       ).      ¬´¬ª , , , AAS Ultra Analog,       ,     ,    ,        .         ,  ,    <a href="http://www.kvraudio.com/forum/viewtopic.php%3Ft%3D350246"></a> ,   ,      NI Reaktor. ,            ‚Äî    ,    ..     . <br> <br>   <br>     .   GUI.  <i>bg.png</i>   ( <i>‚ÄúMove to trash‚Äù</i>  Xcode),       : <br> <br> <a href="">filtermode.png</a> <a href="">knob_small.png</a> (  ,   50 50 ) <a href="">bg.png</a> (       ) <br> <br>    ID  <i>resource.h</i> : <br> <br> <code class="cpp">// Unique IDs for each image resource. #define BG_ID 101 #define WHITE_KEY_ID 102 #define BLACK_KEY_ID 103 #define WAVEFORM_ID 104 #define KNOB_ID 105 #define KNOB_SMALL_ID 106 #define FILTERMODE_ID 107 // Image resource locations for this plug. #define BG_FN "resources/img/bg.png" #define WHITE_KEY_FN "resources/img/whitekey.png" #define BLACK_KEY_FN "resources/img/blackkey.png" #define WAVEFORM_FN "resources/img/waveform.png" #define KNOB_FN "resources/img/knob.png" #define KNOB_SMALL_FN "resources/img/knob_small.png" #define FILTERMODE_FN "resources/img/filtermode.png"</code> <br> <br>  <i>Synthesis.rc</i> : <br> <br> <code class="cpp">#include "resource.h" BG_ID PNG BG_FN WHITE_KEY_ID PNG WHITE_KEY_FN BLACK_KEY_ID PNG BLACK_KEY_FN WAVEFORM_ID PNG WAVEFORM_FN KNOB_ID PNG KNOB_FN KNOB_SMALL_ID PNG KNOB_SMALL_FN FILTERMODE_ID PNG FILTERMODE_FN</code> <br> <br>   <code>#include "Filter.h"</code>  <i>Synthesis.h</i>    <code>private</code> : <br> <br> <code class="cpp">Filter mFilter;</code> <br> <br>  <code>EParams</code>  <i>Synthesis.cpp</i> : <br> <br> <code class="cpp">enum EParams { mWaveform = 0, mAttack, mDecay, mSustain, mRelease, mFilterMode, mFilterCutoff, mFilterResonance, mFilterAttack, mFilterDecay, mFilterSustain, mFilterRelease, mFilterEnvelopeAmount, kNumParams };</code> <br> <br>        : <br> <br> <code class="cpp">pGraphics-&gt;AttachControl(new ISwitchControl(this, 24, 38, mWaveform, &amp;waveformBitmap));</code> <br> <br>      .      (Lowpass, Highpass, Bandpass).    <code>AttachGraphics(pGraphics)</code> : <br> <br> <code class="cpp">GetParam(mFilterMode)-&gt;InitEnum("Filter Mode", Filter::FILTER_MODE_LOWPASS, Filter::kNumFilterModes); IBitmap filtermodeBitmap = pGraphics-&gt;LoadIBitmap(FILTERMODE_ID, FILTERMODE_FN, 3); pGraphics-&gt;AttachControl(new ISwitchControl(this, 24, 123, mFilterMode, &amp;filtermodeBitmap));</code> <br> <br>         .    .     <i>knob_small.png</i> : <br> <br> <code class="cpp">// Knobs for filter cutoff and resonance IBitmap smallKnobBitmap = pGraphics-&gt;LoadIBitmap(KNOB_SMALL_ID, KNOB_SMALL_FN, 64); // Cutoff knob: GetParam(mFilterCutoff)-&gt;InitDouble("Cutoff", 0.99, 0.01, 0.99, 0.001); GetParam(mFilterCutoff)-&gt;SetShape(2); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 5, 177, mFilterCutoff, &amp;smallKnobBitmap)); // Resonance knob: GetParam(mFilterResonance)-&gt;InitDouble("Resonance", 0.01, 0.01, 1.0, 0.001); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 61, 177, mFilterResonance, &amp;smallKnobBitmap));</code> <br> <br>   ,           <code>1.0</code> ,   <code>calculateFeedbackAmount</code>    , . <br>  <code>ProcessDoubleReplacing</code>     : <br> <br> <code class="cpp">leftOutput[i] = rightOutput[i] = mFilter.process(mOscillator.nextSample() * mEnvelopeGenerator.nextSample() * velocity / 127.0);</code> <br> <br>       .  <code>switch</code>   <code>Synthesis::OnParamChange</code> : <br> <br> <code class="cpp">case mFilterCutoff: mFilter.setCutoff(GetParam(paramIdx)-&gt;Value()); break; case mFilterResonance: mFilter.setResonance(GetParam(paramIdx)-&gt;Value()); break; case mFilterMode: mFilter.setFilterMode(static_cast&lt;Filter::FilterMode&gt;(GetParam(paramIdx)-&gt;Int())); break;</code> <br> <br>    .  -      . <br> <br>  <br> <br>  ‚Äî      .   ,   ,          . <br>      : <br> <br> <code class="cpp">buf0 += cutoff * (inputValue - buf0 + feedbackAmount * (buf0 - buf1));</code> <br> <br> ,   ,      ( <code>buf0 ‚Äì buf1</code> ),   <code>feedbackAmount</code> .    <code>calculateFeedbackAmount</code>  <code>feedbackAmount</code>  <code>resonance</code> , . .    ,   . <br> <br>  ,            .     ,  <i></i> ,      <a href="https://www.youtube.com/watch%3Fv%3DJWyMj6KxGHM"> </a> .    ,        ,       . <br> <br>  -12 /  -24 / <br>        !     24   .     <code>switch</code>  <code>Filter::process</code> : <br> <br> <code class="cpp">buf2 += cutoff * (buf1 - buf2); buf3 += cutoff * (buf2 ‚Äì buf3);</code> <br> <br>   :      ,       ,            .     ,       , , <a href="https://ccrma.stanford.edu/~Jos/filters/Filter_Stability.html"></a> (       ).     <code>switch</code> : <br> <br> <code class="cpp">switch (mode) { case FILTER_MODE_LOWPASS: return buf3; case FILTER_MODE_HIGHPASS: return inputValue - buf3; case FILTER_MODE_BANDPASS: return buf0 - buf3; default: return 0.0; }</code> <br> <br>   <code>buf1</code>  <code>buf3</code> ‚Äì      .    -24 /.     <code>buf2</code>  <code>buf3</code> ,        <code>private</code> <i>Filter.h</i> : <br> <br> <code class="cpp">double buf2; double buf3;</code> <br> <br>    ,   <code>buf0</code> c <code>buf1</code> : <br> <br> <code class="cpp">Filter() : // ... buf0(0.0), buf1(0.0), buf2(0.0), buf3(0.0) // ...</code> <br> <br>     , ,     :     .       . <br>          ? <br> <br>   <br>    .  ,           ,       . <br> -      <code>cutoff</code>   .      .    <code>cutoffMod</code> ,    ,       <code>cutoff</code>    .     <code><code>#include    private</code> : <br> <br> <code class="cpp">double cutoffMod;</code> <br> <br> : <br> <br> <code class="cpp">Filter() : cutoff(0.99), resonance(0.01), cutoffMod(0.0), // ...</code> <br> <br>         .   <code>private</code> : <br> <br> <code class="cpp">inline double getCalculatedCutoff() const { return fmax(fmin(cutoff + cutoffMod, 0.99), 0.01); };</code> <br> <br> <code>calculateFeedbackAmount</code>     : <br> <br> <code class="cpp">inline void calculateFeedbackAmount() { feedbackAmount = resonance + resonance/(1.0 - getCalculatedCutoff()); }</code> <br> <br>       <code>cutoffMod</code> .   <code>feedbackAmount</code>    ,     : <br> <br> <code class="cpp">inline void setCutoffMod(double newCutoffMod) { cutoffMod = newCutoffMod; calculateFeedbackAmount(); }</code> <br> <br> ,       .   <code>Filter::process</code>   : <br> <br> <code class="cpp">if (inputValue == 0.0) return inputValue; double calculatedCutoff = getCalculatedCutoff(); buf0 += calculatedCutoff * (inputValue - buf0 + feedbackAmount * (buf0 - buf1)); buf1 += calculatedCutoff * (buf0 - buf1); buf2 += calculatedCutoff * (buf1 - buf2); buf3 += calculatedCutoff * (buf2 ‚Äì buf3);</code> <br> <br>        ,    .    ,      ,   .     .     <code>cutoff</code>  <code>calculatedCutoff</code>   -. <br> <br> ,       ( <code>setCutoffMod</code> ),   <code>Synthesis</code>    ,     ,    .    ,        <code>cutoffMod</code> .    <code>filterEnvelopeAmount</code>    <code>-1</code>  <code>+1</code> .   GUI. <br> <br>   <code>private</code> <i>Synthesis.h</i>    : <br> <br> <code class="cpp">EnvelopeGenerator mFilterEnvelopeGenerator; double filterEnvelopeAmount;</code> <br> <br>       MIDI ,      <code>onNoteOn</code>  <code>onNoteOff</code> : <br> <br> <code class="cpp">inline void onNoteOn(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); mFilterEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); }; inline void onNoteOff(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); mFilterEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); };</code> <br> <br>    .   <code>ProcessDoubleReplacing</code>        : <br> <br> <code class="cpp">mFilter.setCutoffMod(mFilterEnvelopeGenerator.nextSample() * filterEnvelopeAmount);</code> <br> <br>  ,        <code>nextSample</code>  <code>filterEnvelopeAmount</code>     <code>cutoffMod</code> .     <code>filterEnvelopeAmount</code>  : <br> <br> <code class="cpp">Synthesis::Synthesis(IPlugInstanceInfo instanceInfo) : IPLUG_CTOR(kNumParams, kNumPrograms, instanceInfo), lastVirtualKeyboardNoteNumber(virtualKeyboardMinimumNoteNumber - 1), filterEnvelopeAmount(0.0) { // ... }</code> <br> <br>       <code>Synthesis::Reset</code> : <br> <br> <code class="cpp">mFilterEnvelopeGenerator.setSampleRate(GetSampleRate());</code> <br> <br>      <code>EParams</code> ,       .  <code>AttachGraphics</code>     : <br> <br> <code class="cpp">// Knobs for filter envelope // Attack knob GetParam(mFilterAttack)-&gt;InitDouble("Filter Env Attack", 0.01, 0.01, 10.0, 0.001); GetParam(mFilterAttack)-&gt;SetShape(3); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 139, 178, mFilterAttack, &amp;smallKnobBitmap)); // Decay knob: GetParam(mFilterDecay)-&gt;InitDouble("Filter Env Decay", 0.5, 0.01, 15.0, 0.001); GetParam(mFilterDecay)-&gt;SetShape(3); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 195, 178, mFilterDecay, &amp;smallKnobBitmap)); // Sustain knob: GetParam(mFilterSustain)-&gt;InitDouble("Filter Env Sustain", 0.1, 0.001, 1.0, 0.001); GetParam(mFilterSustain)-&gt;SetShape(2); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 251, 178, mFilterSustain, &amp;smallKnobBitmap)); // Release knob: GetParam(mFilterRelease)-&gt;InitDouble("Filter Env Release", 1.0, 0.001, 15.0, 0.001); GetParam(mFilterRelease)-&gt;SetShape(3); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 307, 178, mFilterRelease, &amp;smallKnobBitmap)); // Filter envelope amount knob: GetParam(mFilterEnvelopeAmount)-&gt;InitDouble("Filter Env Amount", 0.0, -1.0, 1.0, 0.001); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 363, 178, mFilterEnvelopeAmount, &amp;smallKnobBitmap));</code> <br> <br>     ,       <code>smallKnobBitmap</code> .                   .     ,    .  <code>Synthesis::OnParamChange</code>    <code>switch</code> : <br> <br> <code class="cpp">case mFilterAttack: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK, GetParam(paramIdx)-&gt;Value()); break; case mFilterDecay: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_DECAY, GetParam(paramIdx)-&gt;Value()); break; case mFilterSustain: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_SUSTAIN, GetParam(paramIdx)-&gt;Value()); break; case mFilterRelease: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE, GetParam(paramIdx)-&gt;Value()); break; case mFilterEnvelopeAmount: filterEnvelopeAmount = GetParam(paramIdx)-&gt;Value(); break;</code> <br> <br> ! <br>     !           (-   C1),   : <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/f5d/757/3f9/f5d7573f9b3a720fe5898d88ae477cfc.png"> <br> <br>        <code>EnvelopeGenerator</code>  .         .        ! <br> <br>    <a href=""></a> . <br> <br>        :) <br> <br>  : <br> <a href="http://martin-finke.de/blog/articles/audio-plugins-013-filter/">martin-finke.de/blog/articles/audio-plugins-013-filter</a></code></code> </h3> <code><code class="cpp">#include  <i>Filter.h</i> ( )     : <br> <br> class Filter { public: enum FilterMode { FILTER_MODE_LOWPASS = 0, FILTER_MODE_HIGHPASS, FILTER_MODE_BANDPASS, kNumFilterModes }; Filter() : cutoff(0.99), resonance(0.0), mode(FILTER_MODE_LOWPASS), buf0(0.0), buf1(0.0) { calculateFeedbackAmount(); }; double process(double inputValue); inline void setCutoff(double newCutoff) { cutoff = newCutoff; calculateFeedbackAmount(); }; inline void setResonance(double newResonance) { resonance = newResonance; calculateFeedbackAmount(); }; inline void setFilterMode(FilterMode newMode) { mode = newMode; } private: double cutoff; double resonance; FilterMode mode; double feedbackAmount; inline void calculateFeedbackAmount() { feedbackAmount = resonance + resonance/(1.0 - cutoff); } double buf0; double buf1; };</code> <br> <br>  <code>private</code>     <i> </i> <code>cutoff</code>  <i></i> <code>resonance</code> . <code>Mode</code>      (Lowpass, Highpass, Bandpass).  <code>feedbackAmount</code> , <code>buf0</code>  <code>buf1</code>    ,    . <br>          ( <code>calculateFeedbackAmount()</code> ).  <code>process</code>      .   <code>feedbackAmount</code>   <code>cutoff</code>  <code>resonance</code> ,    <code>calculateFeedbackAmount</code>      . <br> <br>   <i>Filter.cpp</i>  : <br> <br> <code class="cpp">// By Paul Kellett // http://www.musicdsp.org/showone.php?id=29 double Filter::process(double inputValue) { buf0 += cutoff * (inputValue - buf0); buf1 += cutoff * (buf0 - buf1); switch (mode) { case FILTER_MODE_LOWPASS: return buf1; case FILTER_MODE_HIGHPASS: return inputValue - buf0; case FILTER_MODE_BANDPASS: return buf0 - buf1; default: return 0.0; } }</code> <br> <br> , ?  ,         <i> </i> . ¬´ ¬ª   ,               (. .    6 ).     <code>buf0</code>  <code>buf1</code> :        .     <code>inputValue</code> ,  - <code>buf0</code> (  ).   .    6 /   12 /.  <code>switch</code> ,  <code>buf1</code>    . , ,    <code>buf0</code> ,       12,   6 /,        . <br> <br>  <code>case</code> <code>FILTER_MODE_HIGHPASS</code>    . <code>buf0</code>       .   <code>inputValue</code>  <code>buf0</code> ,   .    <code>buf1</code> ,     . <br> <br>  <code>case</code> <code>FILTER_MODE_BANDPASS</code> ,  <code>buf0 - buf1</code>   .  <code>buf0</code>       ,     <code>buf1</code> . ,   . <br>  :    <i> </i>    <i> </i> ,   . <br> <br>  <code>buf1</code>     .       <a href="http://ru.wikipedia.org/wiki/%25D0%25A4%25D0%25B8%25D0%25BB%25D1%258C%25D1%2582%25D1%2580_%25D1%2581_%25D0%25B1%25D0%25B5%25D1%2581%25D0%25BA%25D0%25BE%25D0%25BD%25D0%25B5%25D1%2587%25D0%25BD%25D0%25BE%25D0%25B9_%25D0%25B8%25D0%25BC%25D0%25BF%25D1%2583%25D0%25BB%25D1%258C%25D1%2581%25D0%25BD%25D0%25BE%25D0%25B9_%25D1%2585%25D0%25B0%25D1%2580%25D0%25B0%25D0%25BA%25D1%2582%25D0%25B5%25D1%2580%25D0%25B8%25D1%2581%25D1%2582%25D0%25B8%25D0%25BA%25D0%25BE%25D0%25B9">    </a> ( <i>Infinite Impulse Response</i> ,  <i>IIR</i> ).  <a href="http://www.dspguide.com/ch14/1.htm"> </a> ,      .      ,         ,      . <br> <br>   <br>       ,     ,     .   ,  ,      ,  ,          .           ,  NI Massive,   ¬´ <a href="http://lurkmore.to/%25D0%25A2%25D1%2591%25D0%25BF%25D0%25BB%25D1%258B%25D0%25B9_%25D0%25BB%25D0%25B0%25D0%25BC%25D0%25BF%25D0%25BE%25D0%25B2%25D1%258B%25D0%25B9_%25D0%25B7%25D0%25B2%25D1%2583%25D0%25BA">  </a> ¬ª.       ,          ,   .        ,          (  Massive       ).      ¬´¬ª , , , AAS Ultra Analog,       ,     ,    ,        .         ,  ,    <a href="http://www.kvraudio.com/forum/viewtopic.php%3Ft%3D350246"></a> ,   ,      NI Reaktor. ,            ‚Äî    ,    ..     . <br> <br>   <br>     .   GUI.  <i>bg.png</i>   ( <i>‚ÄúMove to trash‚Äù</i>  Xcode),       : <br> <br> <a href="">filtermode.png</a> <a href="">knob_small.png</a> (  ,   50 50 ) <a href="">bg.png</a> (       ) <br> <br>    ID  <i>resource.h</i> : <br> <br> <code class="cpp">// Unique IDs for each image resource. #define BG_ID 101 #define WHITE_KEY_ID 102 #define BLACK_KEY_ID 103 #define WAVEFORM_ID 104 #define KNOB_ID 105 #define KNOB_SMALL_ID 106 #define FILTERMODE_ID 107 // Image resource locations for this plug. #define BG_FN "resources/img/bg.png" #define WHITE_KEY_FN "resources/img/whitekey.png" #define BLACK_KEY_FN "resources/img/blackkey.png" #define WAVEFORM_FN "resources/img/waveform.png" #define KNOB_FN "resources/img/knob.png" #define KNOB_SMALL_FN "resources/img/knob_small.png" #define FILTERMODE_FN "resources/img/filtermode.png"</code> <br> <br>  <i>Synthesis.rc</i> : <br> <br> <code class="cpp">#include "resource.h" BG_ID PNG BG_FN WHITE_KEY_ID PNG WHITE_KEY_FN BLACK_KEY_ID PNG BLACK_KEY_FN WAVEFORM_ID PNG WAVEFORM_FN KNOB_ID PNG KNOB_FN KNOB_SMALL_ID PNG KNOB_SMALL_FN FILTERMODE_ID PNG FILTERMODE_FN</code> <br> <br>   <code>#include "Filter.h"</code>  <i>Synthesis.h</i>    <code>private</code> : <br> <br> <code class="cpp">Filter mFilter;</code> <br> <br>  <code>EParams</code>  <i>Synthesis.cpp</i> : <br> <br> <code class="cpp">enum EParams { mWaveform = 0, mAttack, mDecay, mSustain, mRelease, mFilterMode, mFilterCutoff, mFilterResonance, mFilterAttack, mFilterDecay, mFilterSustain, mFilterRelease, mFilterEnvelopeAmount, kNumParams };</code> <br> <br>        : <br> <br> <code class="cpp">pGraphics-&gt;AttachControl(new ISwitchControl(this, 24, 38, mWaveform, &amp;waveformBitmap));</code> <br> <br>      .      (Lowpass, Highpass, Bandpass).    <code>AttachGraphics(pGraphics)</code> : <br> <br> <code class="cpp">GetParam(mFilterMode)-&gt;InitEnum("Filter Mode", Filter::FILTER_MODE_LOWPASS, Filter::kNumFilterModes); IBitmap filtermodeBitmap = pGraphics-&gt;LoadIBitmap(FILTERMODE_ID, FILTERMODE_FN, 3); pGraphics-&gt;AttachControl(new ISwitchControl(this, 24, 123, mFilterMode, &amp;filtermodeBitmap));</code> <br> <br>         .    .     <i>knob_small.png</i> : <br> <br> <code class="cpp">// Knobs for filter cutoff and resonance IBitmap smallKnobBitmap = pGraphics-&gt;LoadIBitmap(KNOB_SMALL_ID, KNOB_SMALL_FN, 64); // Cutoff knob: GetParam(mFilterCutoff)-&gt;InitDouble("Cutoff", 0.99, 0.01, 0.99, 0.001); GetParam(mFilterCutoff)-&gt;SetShape(2); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 5, 177, mFilterCutoff, &amp;smallKnobBitmap)); // Resonance knob: GetParam(mFilterResonance)-&gt;InitDouble("Resonance", 0.01, 0.01, 1.0, 0.001); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 61, 177, mFilterResonance, &amp;smallKnobBitmap));</code> <br> <br>   ,           <code>1.0</code> ,   <code>calculateFeedbackAmount</code>    , . <br>  <code>ProcessDoubleReplacing</code>     : <br> <br> <code class="cpp">leftOutput[i] = rightOutput[i] = mFilter.process(mOscillator.nextSample() * mEnvelopeGenerator.nextSample() * velocity / 127.0);</code> <br> <br>       .  <code>switch</code>   <code>Synthesis::OnParamChange</code> : <br> <br> <code class="cpp">case mFilterCutoff: mFilter.setCutoff(GetParam(paramIdx)-&gt;Value()); break; case mFilterResonance: mFilter.setResonance(GetParam(paramIdx)-&gt;Value()); break; case mFilterMode: mFilter.setFilterMode(static_cast&lt;Filter::FilterMode&gt;(GetParam(paramIdx)-&gt;Int())); break;</code> <br> <br>    .  -      . <br> <br>  <br> <br>  ‚Äî      .   ,   ,          . <br>      : <br> <br> <code class="cpp">buf0 += cutoff * (inputValue - buf0 + feedbackAmount * (buf0 - buf1));</code> <br> <br> ,   ,      ( <code>buf0 ‚Äì buf1</code> ),   <code>feedbackAmount</code> .    <code>calculateFeedbackAmount</code>  <code>feedbackAmount</code>  <code>resonance</code> , . .    ,   . <br> <br>  ,            .     ,  <i></i> ,      <a href="https://www.youtube.com/watch%3Fv%3DJWyMj6KxGHM"> </a> .    ,        ,       . <br> <br>  -12 /  -24 / <br>        !     24   .     <code>switch</code>  <code>Filter::process</code> : <br> <br> <code class="cpp">buf2 += cutoff * (buf1 - buf2); buf3 += cutoff * (buf2 ‚Äì buf3);</code> <br> <br>   :      ,       ,            .     ,       , , <a href="https://ccrma.stanford.edu/~Jos/filters/Filter_Stability.html"></a> (       ).     <code>switch</code> : <br> <br> <code class="cpp">switch (mode) { case FILTER_MODE_LOWPASS: return buf3; case FILTER_MODE_HIGHPASS: return inputValue - buf3; case FILTER_MODE_BANDPASS: return buf0 - buf3; default: return 0.0; }</code> <br> <br>   <code>buf1</code>  <code>buf3</code> ‚Äì      .    -24 /.     <code>buf2</code>  <code>buf3</code> ,        <code>private</code> <i>Filter.h</i> : <br> <br> <code class="cpp">double buf2; double buf3;</code> <br> <br>    ,   <code>buf0</code> c <code>buf1</code> : <br> <br> <code class="cpp">Filter() : // ... buf0(0.0), buf1(0.0), buf2(0.0), buf3(0.0) // ...</code> <br> <br>     , ,     :     .       . <br>          ? <br> <br>   <br>    .  ,           ,       . <br> -      <code>cutoff</code>   .      .    <code>cutoffMod</code> ,    ,       <code>cutoff</code>    .     <code><code>#include    private</code> : <br> <br> <code class="cpp">double cutoffMod;</code> <br> <br> : <br> <br> <code class="cpp">Filter() : cutoff(0.99), resonance(0.01), cutoffMod(0.0), // ...</code> <br> <br>         .   <code>private</code> : <br> <br> <code class="cpp">inline double getCalculatedCutoff() const { return fmax(fmin(cutoff + cutoffMod, 0.99), 0.01); };</code> <br> <br> <code>calculateFeedbackAmount</code>     : <br> <br> <code class="cpp">inline void calculateFeedbackAmount() { feedbackAmount = resonance + resonance/(1.0 - getCalculatedCutoff()); }</code> <br> <br>       <code>cutoffMod</code> .   <code>feedbackAmount</code>    ,     : <br> <br> <code class="cpp">inline void setCutoffMod(double newCutoffMod) { cutoffMod = newCutoffMod; calculateFeedbackAmount(); }</code> <br> <br> ,       .   <code>Filter::process</code>   : <br> <br> <code class="cpp">if (inputValue == 0.0) return inputValue; double calculatedCutoff = getCalculatedCutoff(); buf0 += calculatedCutoff * (inputValue - buf0 + feedbackAmount * (buf0 - buf1)); buf1 += calculatedCutoff * (buf0 - buf1); buf2 += calculatedCutoff * (buf1 - buf2); buf3 += calculatedCutoff * (buf2 ‚Äì buf3);</code> <br> <br>        ,    .    ,      ,   .     .     <code>cutoff</code>  <code>calculatedCutoff</code>   -. <br> <br> ,       ( <code>setCutoffMod</code> ),   <code>Synthesis</code>    ,     ,    .    ,        <code>cutoffMod</code> .    <code>filterEnvelopeAmount</code>    <code>-1</code>  <code>+1</code> .   GUI. <br> <br>   <code>private</code> <i>Synthesis.h</i>    : <br> <br> <code class="cpp">EnvelopeGenerator mFilterEnvelopeGenerator; double filterEnvelopeAmount;</code> <br> <br>       MIDI ,      <code>onNoteOn</code>  <code>onNoteOff</code> : <br> <br> <code class="cpp">inline void onNoteOn(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); mFilterEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); }; inline void onNoteOff(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); mFilterEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); };</code> <br> <br>    .   <code>ProcessDoubleReplacing</code>        : <br> <br> <code class="cpp">mFilter.setCutoffMod(mFilterEnvelopeGenerator.nextSample() * filterEnvelopeAmount);</code> <br> <br>  ,        <code>nextSample</code>  <code>filterEnvelopeAmount</code>     <code>cutoffMod</code> .     <code>filterEnvelopeAmount</code>  : <br> <br> <code class="cpp">Synthesis::Synthesis(IPlugInstanceInfo instanceInfo) : IPLUG_CTOR(kNumParams, kNumPrograms, instanceInfo), lastVirtualKeyboardNoteNumber(virtualKeyboardMinimumNoteNumber - 1), filterEnvelopeAmount(0.0) { // ... }</code> <br> <br>       <code>Synthesis::Reset</code> : <br> <br> <code class="cpp">mFilterEnvelopeGenerator.setSampleRate(GetSampleRate());</code> <br> <br>      <code>EParams</code> ,       .  <code>AttachGraphics</code>     : <br> <br> <code class="cpp">// Knobs for filter envelope // Attack knob GetParam(mFilterAttack)-&gt;InitDouble("Filter Env Attack", 0.01, 0.01, 10.0, 0.001); GetParam(mFilterAttack)-&gt;SetShape(3); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 139, 178, mFilterAttack, &amp;smallKnobBitmap)); // Decay knob: GetParam(mFilterDecay)-&gt;InitDouble("Filter Env Decay", 0.5, 0.01, 15.0, 0.001); GetParam(mFilterDecay)-&gt;SetShape(3); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 195, 178, mFilterDecay, &amp;smallKnobBitmap)); // Sustain knob: GetParam(mFilterSustain)-&gt;InitDouble("Filter Env Sustain", 0.1, 0.001, 1.0, 0.001); GetParam(mFilterSustain)-&gt;SetShape(2); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 251, 178, mFilterSustain, &amp;smallKnobBitmap)); // Release knob: GetParam(mFilterRelease)-&gt;InitDouble("Filter Env Release", 1.0, 0.001, 15.0, 0.001); GetParam(mFilterRelease)-&gt;SetShape(3); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 307, 178, mFilterRelease, &amp;smallKnobBitmap)); // Filter envelope amount knob: GetParam(mFilterEnvelopeAmount)-&gt;InitDouble("Filter Env Amount", 0.0, -1.0, 1.0, 0.001); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 363, 178, mFilterEnvelopeAmount, &amp;smallKnobBitmap));</code> <br> <br>     ,       <code>smallKnobBitmap</code> .                   .     ,    .  <code>Synthesis::OnParamChange</code>    <code>switch</code> : <br> <br> <code class="cpp">case mFilterAttack: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK, GetParam(paramIdx)-&gt;Value()); break; case mFilterDecay: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_DECAY, GetParam(paramIdx)-&gt;Value()); break; case mFilterSustain: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_SUSTAIN, GetParam(paramIdx)-&gt;Value()); break; case mFilterRelease: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE, GetParam(paramIdx)-&gt;Value()); break; case mFilterEnvelopeAmount: filterEnvelopeAmount = GetParam(paramIdx)-&gt;Value(); break;</code> <br> <br> ! <br>     !           (-   C1),   : <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/f5d/757/3f9/f5d7573f9b3a720fe5898d88ae477cfc.png"> <br> <br>        <code>EnvelopeGenerator</code>  .         .        ! <br> <br>    <a href=""></a> . <br> <br>        :) <br> <br>  : <br> <a href="http://martin-finke.de/blog/articles/audio-plugins-013-filter/">martin-finke.de/blog/articles/audio-plugins-013-filter</a></code></code> <pre> <code class="hljs erlang-repl"><code><code class="cpp"><code class="cpp">#include  <i>Filter.h</i> ( )     : <br> <br> class Filter { public: enum FilterMode { FILTER_MODE_LOWPASS = <span class="hljs-number"><span class="hljs-number">0</span></span>, FILTER_MODE_HIGHPASS, FILTER_MODE_BANDPASS, kNumFilterModes }; Filter() : cutoff(<span class="hljs-number"><span class="hljs-number">0.99</span></span>), resonance(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), mode(FILTER_MODE_LOWPASS), buf0(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), buf1(<span class="hljs-number"><span class="hljs-number">0.0</span></span>) { calculateFeedbackAmount(); }; double process(double inputValue); inline void setCutoff(double newCutoff) { cutoff = newCutoff; calculateFeedbackAmount(); }; inline void setResonance(double newResonance) { resonance = newResonance; calculateFeedbackAmount(); }; inline void setFilterMode(FilterMode newMode) { mode = newMode; } private: double cutoff; double resonance; FilterMode mode; double feedbackAmount; inline void calculateFeedbackAmount() { feedbackAmount = resonance + resonance/(<span class="hljs-number"><span class="hljs-number">1.0</span></span> - cutoff); } double buf0; double buf1; };</code> <br> <br>  <code>private</code>     <i> </i> <code>cutoff</code>  <i></i> <code>resonance</code> . <code>Mode</code>      (Lowpass, Highpass, Bandpass).  <code>feedbackAmount</code> , <code>buf0</code>  <code>buf1</code>    ,    . <br>          ( <code>calculateFeedbackAmount()</code> ).  <code>process</code>      .   <code>feedbackAmount</code>   <code>cutoff</code>  <code>resonance</code> ,    <code>calculateFeedbackAmount</code>      . <br> <br>   <i>Filter.cpp</i>  : <br> <br> <code class="cpp">// By Paul Kellett // http://www.musicdsp.org/showone.php?id=<span class="hljs-number"><span class="hljs-number">29</span></span> double Filter::process(double inputValue) { buf0 += cutoff * (inputValue - buf0); buf1 += cutoff * (buf0 - buf1); switch (mode) { case FILTER_MODE_LOWPASS: return buf1; case FILTER_MODE_HIGHPASS: return inputValue - buf0; case FILTER_MODE_BANDPASS: return buf0 - buf1; default: return <span class="hljs-number"><span class="hljs-number">0.0</span></span>; } }</code> <br> <br> , ?  ,         <i> </i> . ¬´ ¬ª   ,               (. .    <span class="hljs-number"><span class="hljs-number">6</span></span> ).     <code>buf0</code>  <code>buf1</code> :        .     <code>inputValue</code> ,  - <code>buf0</code> (  ).   .    <span class="hljs-number"><span class="hljs-number">6</span></span> /   <span class="hljs-number"><span class="hljs-number">12</span></span> /.  <code>switch</code> ,  <code>buf1</code>    . , ,    <code>buf0</code> ,       <span class="hljs-number"><span class="hljs-number">12</span></span>,   <span class="hljs-number"><span class="hljs-number">6</span></span> /,        . <br> <br>  <code>case</code> <code>FILTER_MODE_HIGHPASS</code>    . <code>buf0</code>       .   <code>inputValue</code>  <code>buf0</code> ,   .    <code>buf1</code> ,     . <br> <br>  <code>case</code> <code>FILTER_MODE_BANDPASS</code> ,  <code>buf0 - buf1</code>   .  <code>buf0</code>       ,     <code>buf1</code> . ,   . <br>  :    <i> </i>    <i> </i> ,   . <br> <br>  <code>buf1</code>     .       <a href="http://ru.wikipedia.org/wiki/%25D0%25A4%25D0%25B8%25D0%25BB%25D1%258C%25D1%2582%25D1%2580_%25D1%2581_%25D0%25B1%25D0%25B5%25D1%2581%25D0%25BA%25D0%25BE%25D0%25BD%25D0%25B5%25D1%2587%25D0%25BD%25D0%25BE%25D0%25B9_%25D0%25B8%25D0%25BC%25D0%25BF%25D1%2583%25D0%25BB%25D1%258C%25D1%2581%25D0%25BD%25D0%25BE%25D0%25B9_%25D1%2585%25D0%25B0%25D1%2580%25D0%25B0%25D0%25BA%25D1%2582%25D0%25B5%25D1%2580%25D0%25B8%25D1%2581%25D1%2582%25D0%25B8%25D0%25BA%25D0%25BE%25D0%25B9">    </a> ( <i>Infinite Impulse Response</i> ,  <i>IIR</i> ).  <a href="http://www.dspguide.com/ch14/1.htm"> </a> ,      .      ,         ,      . <br> <br>   <br>       ,     ,     .   ,  ,      ,  ,          .           ,  NI Massive,   ¬´ <a href="http://lurkmore.to/%25D0%25A2%25D1%2591%25D0%25BF%25D0%25BB%25D1%258B%25D0%25B9_%25D0%25BB%25D0%25B0%25D0%25BC%25D0%25BF%25D0%25BE%25D0%25B2%25D1%258B%25D0%25B9_%25D0%25B7%25D0%25B2%25D1%2583%25D0%25BA">  </a> ¬ª.       ,          ,   .        ,          (  Massive       ).      ¬´¬ª , , , AAS Ultra Analog,       ,     ,    ,        .         ,  ,    <a href="http://www.kvraudio.com/forum/viewtopic.php%3Ft%3D350246"></a> ,   ,      NI Reaktor. ,            ‚Äî    ,    ..     . <br> <br>   <br>     .   GUI.  <i>bg.png</i>   ( <i>‚ÄúMove to trash‚Äù</i>  Xcode),       : <br> <br> <a href="">filtermode.png</a> <a href="">knob_small.png</a> (  ,   <span class="hljs-number"><span class="hljs-number">50</span></span> <span class="hljs-number"><span class="hljs-number">50</span></span> ) <a href="">bg.png</a> (       ) <br> <br>    ID  <i>resource.h</i> : <br> <br> <code class="cpp">// Unique IDs for each image resource. #define BG_ID <span class="hljs-number"><span class="hljs-number">101</span></span> #define WHITE_KEY_ID <span class="hljs-number"><span class="hljs-number">102</span></span> #define BLACK_KEY_ID <span class="hljs-number"><span class="hljs-number">103</span></span> #define WAVEFORM_ID <span class="hljs-number"><span class="hljs-number">104</span></span> #define KNOB_ID <span class="hljs-number"><span class="hljs-number">105</span></span> #define KNOB_SMALL_ID <span class="hljs-number"><span class="hljs-number">106</span></span> #define FILTERMODE_ID <span class="hljs-number"><span class="hljs-number">107</span></span> // Image resource locations for this plug. #define BG_FN <span class="hljs-string"><span class="hljs-string">"resources/img/bg.png"</span></span> #define WHITE_KEY_FN <span class="hljs-string"><span class="hljs-string">"resources/img/whitekey.png"</span></span> #define BLACK_KEY_FN <span class="hljs-string"><span class="hljs-string">"resources/img/blackkey.png"</span></span> #define WAVEFORM_FN <span class="hljs-string"><span class="hljs-string">"resources/img/waveform.png"</span></span> #define KNOB_FN <span class="hljs-string"><span class="hljs-string">"resources/img/knob.png"</span></span> #define KNOB_SMALL_FN <span class="hljs-string"><span class="hljs-string">"resources/img/knob_small.png"</span></span> #define FILTERMODE_FN <span class="hljs-string"><span class="hljs-string">"resources/img/filtermode.png"</span></span></code> <br> <br>  <i>Synthesis.rc</i> : <br> <br> <code class="cpp">#include <span class="hljs-string"><span class="hljs-string">"resource.h"</span></span> BG_ID PNG BG_FN WHITE_KEY_ID PNG WHITE_KEY_FN BLACK_KEY_ID PNG BLACK_KEY_FN WAVEFORM_ID PNG WAVEFORM_FN KNOB_ID PNG KNOB_FN KNOB_SMALL_ID PNG KNOB_SMALL_FN FILTERMODE_ID PNG FILTERMODE_FN</code> <br> <br>   <code>#include <span class="hljs-string"><span class="hljs-string">"Filter.h"</span></span></code>  <i>Synthesis.h</i>    <code>private</code> : <br> <br> <code class="cpp">Filter mFilter;</code> <br> <br>  <code>EParams</code>  <i>Synthesis.cpp</i> : <br> <br> <code class="cpp">enum EParams { mWaveform = <span class="hljs-number"><span class="hljs-number">0</span></span>, mAttack, mDecay, mSustain, mRelease, mFilterMode, mFilterCutoff, mFilterResonance, mFilterAttack, mFilterDecay, mFilterSustain, mFilterRelease, mFilterEnvelopeAmount, kNumParams };</code> <br> <br>        : <br> <br> <code class="cpp">pGraphics-&gt;AttachControl(new ISwitchControl(this, <span class="hljs-number"><span class="hljs-number">24</span></span>, <span class="hljs-number"><span class="hljs-number">38</span></span>, mWaveform, &amp;waveformBitmap));</code> <br> <br>      .      (Lowpass, Highpass, Bandpass).    <code>AttachGraphics(pGraphics)</code> : <br> <br> <code class="cpp">GetParam(mFilterMode)-&gt;InitEnum(<span class="hljs-string"><span class="hljs-string">"Filter Mode"</span></span>, Filter::FILTER_MODE_LOWPASS, Filter::kNumFilterModes); IBitmap filtermodeBitmap = pGraphics-&gt;LoadIBitmap(FILTERMODE_ID, FILTERMODE_FN, <span class="hljs-number"><span class="hljs-number">3</span></span>); pGraphics-&gt;AttachControl(new ISwitchControl(this, <span class="hljs-number"><span class="hljs-number">24</span></span>, <span class="hljs-number"><span class="hljs-number">123</span></span>, mFilterMode, &amp;filtermodeBitmap));</code> <br> <br>         .    .     <i>knob_small.png</i> : <br> <br> <code class="cpp">// Knobs for filter cutoff and resonance IBitmap smallKnobBitmap = pGraphics-&gt;LoadIBitmap(KNOB_SMALL_ID, KNOB_SMALL_FN, <span class="hljs-number"><span class="hljs-number">64</span></span>); // Cutoff knob: GetParam(mFilterCutoff)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Cutoff"</span></span>, <span class="hljs-number"><span class="hljs-number">0.99</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">0.99</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); GetParam(mFilterCutoff)-&gt;SetShape(<span class="hljs-number"><span class="hljs-number">2</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-number"><span class="hljs-number">177</span></span>, mFilterCutoff, &amp;smallKnobBitmap)); // Resonance knob: GetParam(mFilterResonance)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Resonance"</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">61</span></span>, <span class="hljs-number"><span class="hljs-number">177</span></span>, mFilterResonance, &amp;smallKnobBitmap));</code> <br> <br>   ,           <code><span class="hljs-number"><span class="hljs-number">1.0</span></span></code> ,   <code>calculateFeedbackAmount</code>    , . <br>  <code>ProcessDoubleReplacing</code>     : <br> <br> <code class="cpp">leftOutput[i] = rightOutput[i] = mFilter.process(mOscillator.nextSample() * mEnvelopeGenerator.nextSample() * velocity / <span class="hljs-number"><span class="hljs-number">127.0</span></span>);</code> <br> <br>       .  <code>switch</code>   <code>Synthesis::OnParamChange</code> : <br> <br> <code class="cpp">case mFilterCutoff: mFilter.setCutoff(GetParam(paramIdx)-&gt;Value()); break; case mFilterResonance: mFilter.setResonance(GetParam(paramIdx)-&gt;Value()); break; case mFilterMode: mFilter.setFilterMode(static_cast&lt;Filter::FilterMode&gt;(GetParam(paramIdx)-&gt;Int())); break;</code> <br> <br>    .  -      . <br> <br>  <br> <br>  ‚Äî      .   ,   ,          . <br>      : <br> <br> <code class="cpp">buf0 += cutoff * (inputValue - buf0 + feedbackAmount * (buf0 - buf1));</code> <br> <br> ,   ,      ( <code>buf0 ‚Äì buf1</code> ),   <code>feedbackAmount</code> .    <code>calculateFeedbackAmount</code>  <code>feedbackAmount</code>  <code>resonance</code> , . .    ,   . <br> <br>  ,            .     ,  <i></i> ,      <a href="https://www.youtube.com/watch%3Fv%3DJWyMj6KxGHM"> </a> .    ,        ,       . <br> <br>  -<span class="hljs-number"><span class="hljs-number">12</span></span> /  -<span class="hljs-number"><span class="hljs-number">24</span></span> / <br>        !     <span class="hljs-number"><span class="hljs-number">24</span></span>   .     <code>switch</code>  <code>Filter::process</code> : <br> <br> <code class="cpp">buf2 += cutoff * (buf1 - buf2); buf3 += cutoff * (buf2 ‚Äì buf3);</code> <br> <br>   :      ,       ,            .     ,       , , <a href="https://ccrma.stanford.edu/~Jos/filters/Filter_Stability.html"></a> (       ).     <code>switch</code> : <br> <br> <code class="cpp">switch (mode) { case FILTER_MODE_LOWPASS: return buf3; case FILTER_MODE_HIGHPASS: return inputValue - buf3; case FILTER_MODE_BANDPASS: return buf0 - buf3; default: return <span class="hljs-number"><span class="hljs-number">0.0</span></span>; }</code> <br> <br>   <code>buf1</code>  <code>buf3</code> ‚Äì      .    -<span class="hljs-number"><span class="hljs-number">24</span></span> /.     <code>buf2</code>  <code>buf3</code> ,        <code>private</code> <i>Filter.h</i> : <br> <br> <code class="cpp">double buf2; double buf3;</code> <br> <br>    ,   <code>buf0</code> c <code>buf1</code> : <br> <br> <code class="cpp">Filter() : // ... buf0(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), buf1(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), buf2(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), buf3(<span class="hljs-number"><span class="hljs-number">0.0</span></span>) // ...</code> <br> <br>     , ,     :     .       . <br>          ? <br> <br>   <br>    .  ,           ,       . <br> -      <code>cutoff</code>   .      .    <code>cutoffMod</code> ,    ,       <code>cutoff</code>    .     <code>#include    private</code> : <br> <br> double cutoffMod; <br> <br> : <br> <br> <code class="cpp">Filter() : cutoff(<span class="hljs-number"><span class="hljs-number">0.99</span></span>), resonance(<span class="hljs-number"><span class="hljs-number">0.01</span></span>), cutoffMod(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), // ...</code> <br> <br>         .   <code>private</code> : <br> <br> <code class="cpp">inline double getCalculatedCutoff() const { return fmax(fmin(cutoff + cutoffMod, <span class="hljs-number"><span class="hljs-number">0.99</span></span>), <span class="hljs-number"><span class="hljs-number">0.01</span></span>); };</code> <br> <br> <code>calculateFeedbackAmount</code>     : <br> <br> <code class="cpp">inline void calculateFeedbackAmount() { feedbackAmount = resonance + resonance/(<span class="hljs-number"><span class="hljs-number">1.0</span></span> - getCalculatedCutoff()); }</code> <br> <br>       <code>cutoffMod</code> .   <code>feedbackAmount</code>    ,     : <br> <br> <code class="cpp">inline void setCutoffMod(double newCutoffMod) { cutoffMod = newCutoffMod; calculateFeedbackAmount(); }</code> <br> <br> ,       .   <code>Filter::process</code>   : <br> <br> <code class="cpp">if (inputValue == <span class="hljs-number"><span class="hljs-number">0.0</span></span>) return inputValue; double calculatedCutoff = getCalculatedCutoff(); buf0 += calculatedCutoff * (inputValue - buf0 + feedbackAmount * (buf0 - buf1)); buf1 += calculatedCutoff * (buf0 - buf1); buf2 += calculatedCutoff * (buf1 - buf2); buf3 += calculatedCutoff * (buf2 ‚Äì buf3);</code> <br> <br>        ,    .    ,      ,   .     .     <code>cutoff</code>  <code>calculatedCutoff</code>   -. <br> <br> ,       ( <code>setCutoffMod</code> ),   <code>Synthesis</code>    ,     ,    .    ,        <code>cutoffMod</code> .    <code>filterEnvelopeAmount</code>    <code>-<span class="hljs-number"><span class="hljs-number">1</span></span></code>  <code>+<span class="hljs-number"><span class="hljs-number">1</span></span></code> .   GUI. <br> <br>   <code>private</code> <i>Synthesis.h</i>    : <br> <br> <code class="cpp">EnvelopeGenerator mFilterEnvelopeGenerator; double filterEnvelopeAmount;</code> <br> <br>       MIDI ,      <code>onNoteOn</code>  <code>onNoteOff</code> : <br> <br> <code class="cpp">inline void onNoteOn(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); mFilterEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); }; inline void onNoteOff(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); mFilterEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); };</code> <br> <br>    .   <code>ProcessDoubleReplacing</code>        : <br> <br> <code class="cpp">mFilter.setCutoffMod(mFilterEnvelopeGenerator.nextSample() * filterEnvelopeAmount);</code> <br> <br>  ,        <code>nextSample</code>  <code>filterEnvelopeAmount</code>     <code>cutoffMod</code> .     <code>filterEnvelopeAmount</code>  : <br> <br> <code class="cpp">Synthesis::Synthesis(IPlugInstanceInfo instanceInfo) : IPLUG_CTOR(kNumParams, kNumPrograms, instanceInfo), lastVirtualKeyboardNoteNumber(virtualKeyboardMinimumNoteNumber - <span class="hljs-number"><span class="hljs-number">1</span></span>), filterEnvelopeAmount(<span class="hljs-number"><span class="hljs-number">0.0</span></span>) { // ... }</code> <br> <br>       <code>Synthesis::Reset</code> : <br> <br> <code class="cpp">mFilterEnvelopeGenerator.setSampleRate(GetSampleRate());</code> <br> <br>      <code>EParams</code> ,       .  <code>AttachGraphics</code>     : <br> <br> <code class="cpp">// Knobs for filter envelope // Attack knob GetParam(mFilterAttack)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Filter Env Attack"</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">10.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); GetParam(mFilterAttack)-&gt;SetShape(<span class="hljs-number"><span class="hljs-number">3</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">139</span></span>, <span class="hljs-number"><span class="hljs-number">178</span></span>, mFilterAttack, &amp;smallKnobBitmap)); // Decay knob: GetParam(mFilterDecay)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Filter Env Decay"</span></span>, <span class="hljs-number"><span class="hljs-number">0.5</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">15.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); GetParam(mFilterDecay)-&gt;SetShape(<span class="hljs-number"><span class="hljs-number">3</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">195</span></span>, <span class="hljs-number"><span class="hljs-number">178</span></span>, mFilterDecay, &amp;smallKnobBitmap)); // Sustain knob: GetParam(mFilterSustain)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Filter Env Sustain"</span></span>, <span class="hljs-number"><span class="hljs-number">0.1</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>, <span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); GetParam(mFilterSustain)-&gt;SetShape(<span class="hljs-number"><span class="hljs-number">2</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">251</span></span>, <span class="hljs-number"><span class="hljs-number">178</span></span>, mFilterSustain, &amp;smallKnobBitmap)); // Release knob: GetParam(mFilterRelease)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Filter Env Release"</span></span>, <span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>, <span class="hljs-number"><span class="hljs-number">15.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); GetParam(mFilterRelease)-&gt;SetShape(<span class="hljs-number"><span class="hljs-number">3</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">307</span></span>, <span class="hljs-number"><span class="hljs-number">178</span></span>, mFilterRelease, &amp;smallKnobBitmap)); // Filter envelope amount knob: GetParam(mFilterEnvelopeAmount)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Filter Env Amount"</span></span>, <span class="hljs-number"><span class="hljs-number">0.0</span></span>, -<span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">363</span></span>, <span class="hljs-number"><span class="hljs-number">178</span></span>, mFilterEnvelopeAmount, &amp;smallKnobBitmap));</code> <br> <br>     ,       <code>smallKnobBitmap</code> .                   .     ,    .  <code>Synthesis::OnParamChange</code>    <code>switch</code> : <br> <br> <code class="cpp">case mFilterAttack: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK, GetParam(paramIdx)-&gt;Value()); break; case mFilterDecay: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_DECAY, GetParam(paramIdx)-&gt;Value()); break; case mFilterSustain: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_SUSTAIN, GetParam(paramIdx)-&gt;Value()); break; case mFilterRelease: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE, GetParam(paramIdx)-&gt;Value()); break; case mFilterEnvelopeAmount: filterEnvelopeAmount = GetParam(paramIdx)-&gt;Value(); break;</code> <br> <br> ! <br>     !           (-   C1),   : <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/f5d/757/3f9/f5d7573f9b3a720fe5898d88ae477cfc.png"> <br> <br>        <code>EnvelopeGenerator</code>  .         .        ! <br> <br>    <a href=""></a> . <br> <br>        :) <br> <br>  : <br> <a href="http://martin-finke.de/blog/articles/audio-plugins-013-filter/">martin-finke.de/blog/articles/audio-plugins-<span class="hljs-number"><span class="hljs-number">013</span></span>-filter</a></code></code></code> </pre> <code><code><code class="cpp">#include  <i>Filter.h</i> ( )     : <br> <br> class Filter { public: enum FilterMode { FILTER_MODE_LOWPASS = 0, FILTER_MODE_HIGHPASS, FILTER_MODE_BANDPASS, kNumFilterModes }; Filter() : cutoff(0.99), resonance(0.0), mode(FILTER_MODE_LOWPASS), buf0(0.0), buf1(0.0) { calculateFeedbackAmount(); }; double process(double inputValue); inline void setCutoff(double newCutoff) { cutoff = newCutoff; calculateFeedbackAmount(); }; inline void setResonance(double newResonance) { resonance = newResonance; calculateFeedbackAmount(); }; inline void setFilterMode(FilterMode newMode) { mode = newMode; } private: double cutoff; double resonance; FilterMode mode; double feedbackAmount; inline void calculateFeedbackAmount() { feedbackAmount = resonance + resonance/(1.0 - cutoff); } double buf0; double buf1; };</code> <br> <br>  <code>private</code>     <i> </i> <code>cutoff</code>  <i></i> <code>resonance</code> . <code>Mode</code>      (Lowpass, Highpass, Bandpass).  <code>feedbackAmount</code> , <code>buf0</code>  <code>buf1</code>    ,    . <br>          ( <code>calculateFeedbackAmount()</code> ).  <code>process</code>      .   <code>feedbackAmount</code>   <code>cutoff</code>  <code>resonance</code> ,    <code>calculateFeedbackAmount</code>      . <br> <br>   <i>Filter.cpp</i>  : <br> <br> <code class="cpp">// By Paul Kellett // http://www.musicdsp.org/showone.php?id=29 double Filter::process(double inputValue) { buf0 += cutoff * (inputValue - buf0); buf1 += cutoff * (buf0 - buf1); switch (mode) { case FILTER_MODE_LOWPASS: return buf1; case FILTER_MODE_HIGHPASS: return inputValue - buf0; case FILTER_MODE_BANDPASS: return buf0 - buf1; default: return 0.0; } }</code> <br> <br> , ?  ,         <i> </i> . ¬´ ¬ª   ,               (. .    6 ).     <code>buf0</code>  <code>buf1</code> :        .     <code>inputValue</code> ,  - <code>buf0</code> (  ).   .    6 /   12 /.  <code>switch</code> ,  <code>buf1</code>    . , ,    <code>buf0</code> ,       12,   6 /,        . <br> <br>  <code>case</code> <code>FILTER_MODE_HIGHPASS</code>    . <code>buf0</code>       .   <code>inputValue</code>  <code>buf0</code> ,   .    <code>buf1</code> ,     . <br> <br>  <code>case</code> <code>FILTER_MODE_BANDPASS</code> ,  <code>buf0 - buf1</code>   .  <code>buf0</code>       ,     <code>buf1</code> . ,   . <br>  :    <i> </i>    <i> </i> ,   . <br> <br>  <code>buf1</code>     .       <a href="http://ru.wikipedia.org/wiki/%25D0%25A4%25D0%25B8%25D0%25BB%25D1%258C%25D1%2582%25D1%2580_%25D1%2581_%25D0%25B1%25D0%25B5%25D1%2581%25D0%25BA%25D0%25BE%25D0%25BD%25D0%25B5%25D1%2587%25D0%25BD%25D0%25BE%25D0%25B9_%25D0%25B8%25D0%25BC%25D0%25BF%25D1%2583%25D0%25BB%25D1%258C%25D1%2581%25D0%25BD%25D0%25BE%25D0%25B9_%25D1%2585%25D0%25B0%25D1%2580%25D0%25B0%25D0%25BA%25D1%2582%25D0%25B5%25D1%2580%25D0%25B8%25D1%2581%25D1%2582%25D0%25B8%25D0%25BA%25D0%25BE%25D0%25B9">    </a> ( <i>Infinite Impulse Response</i> ,  <i>IIR</i> ).  <a href="http://www.dspguide.com/ch14/1.htm"> </a> ,      .      ,         ,      . <br> <br>   <br>       ,     ,     .   ,  ,      ,  ,          .           ,  NI Massive,   ¬´ <a href="http://lurkmore.to/%25D0%25A2%25D1%2591%25D0%25BF%25D0%25BB%25D1%258B%25D0%25B9_%25D0%25BB%25D0%25B0%25D0%25BC%25D0%25BF%25D0%25BE%25D0%25B2%25D1%258B%25D0%25B9_%25D0%25B7%25D0%25B2%25D1%2583%25D0%25BA">  </a> ¬ª.       ,          ,   .        ,          (  Massive       ).      ¬´¬ª , , , AAS Ultra Analog,       ,     ,    ,        .         ,  ,    <a href="http://www.kvraudio.com/forum/viewtopic.php%3Ft%3D350246"></a> ,   ,      NI Reaktor. ,            ‚Äî    ,    ..     . <br> <br>   <br>     .   GUI.  <i>bg.png</i>   ( <i>‚ÄúMove to trash‚Äù</i>  Xcode),       : <br> <br> <a href="">filtermode.png</a> <a href="">knob_small.png</a> (  ,   50 50 ) <a href="">bg.png</a> (       ) <br> <br>    ID  <i>resource.h</i> : <br> <br> <code class="cpp">// Unique IDs for each image resource. #define BG_ID 101 #define WHITE_KEY_ID 102 #define BLACK_KEY_ID 103 #define WAVEFORM_ID 104 #define KNOB_ID 105 #define KNOB_SMALL_ID 106 #define FILTERMODE_ID 107 // Image resource locations for this plug. #define BG_FN "resources/img/bg.png" #define WHITE_KEY_FN "resources/img/whitekey.png" #define BLACK_KEY_FN "resources/img/blackkey.png" #define WAVEFORM_FN "resources/img/waveform.png" #define KNOB_FN "resources/img/knob.png" #define KNOB_SMALL_FN "resources/img/knob_small.png" #define FILTERMODE_FN "resources/img/filtermode.png"</code> <br> <br>  <i>Synthesis.rc</i> : <br> <br> <code class="cpp">#include "resource.h" BG_ID PNG BG_FN WHITE_KEY_ID PNG WHITE_KEY_FN BLACK_KEY_ID PNG BLACK_KEY_FN WAVEFORM_ID PNG WAVEFORM_FN KNOB_ID PNG KNOB_FN KNOB_SMALL_ID PNG KNOB_SMALL_FN FILTERMODE_ID PNG FILTERMODE_FN</code> <br> <br>   <code>#include "Filter.h"</code>  <i>Synthesis.h</i>    <code>private</code> : <br> <br> <code class="cpp">Filter mFilter;</code> <br> <br>  <code>EParams</code>  <i>Synthesis.cpp</i> : <br> <br> <code class="cpp">enum EParams { mWaveform = 0, mAttack, mDecay, mSustain, mRelease, mFilterMode, mFilterCutoff, mFilterResonance, mFilterAttack, mFilterDecay, mFilterSustain, mFilterRelease, mFilterEnvelopeAmount, kNumParams };</code> <br> <br>        : <br> <br> <code class="cpp">pGraphics-&gt;AttachControl(new ISwitchControl(this, 24, 38, mWaveform, &amp;waveformBitmap));</code> <br> <br>      .      (Lowpass, Highpass, Bandpass).    <code>AttachGraphics(pGraphics)</code> : <br> <br> <code class="cpp">GetParam(mFilterMode)-&gt;InitEnum("Filter Mode", Filter::FILTER_MODE_LOWPASS, Filter::kNumFilterModes); IBitmap filtermodeBitmap = pGraphics-&gt;LoadIBitmap(FILTERMODE_ID, FILTERMODE_FN, 3); pGraphics-&gt;AttachControl(new ISwitchControl(this, 24, 123, mFilterMode, &amp;filtermodeBitmap));</code> <br> <br>         .    .     <i>knob_small.png</i> : <br> <br> <code class="cpp">// Knobs for filter cutoff and resonance IBitmap smallKnobBitmap = pGraphics-&gt;LoadIBitmap(KNOB_SMALL_ID, KNOB_SMALL_FN, 64); // Cutoff knob: GetParam(mFilterCutoff)-&gt;InitDouble("Cutoff", 0.99, 0.01, 0.99, 0.001); GetParam(mFilterCutoff)-&gt;SetShape(2); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 5, 177, mFilterCutoff, &amp;smallKnobBitmap)); // Resonance knob: GetParam(mFilterResonance)-&gt;InitDouble("Resonance", 0.01, 0.01, 1.0, 0.001); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 61, 177, mFilterResonance, &amp;smallKnobBitmap));</code> <br> <br>   ,           <code>1.0</code> ,   <code>calculateFeedbackAmount</code>    , . <br>  <code>ProcessDoubleReplacing</code>     : <br> <br> <code class="cpp">leftOutput[i] = rightOutput[i] = mFilter.process(mOscillator.nextSample() * mEnvelopeGenerator.nextSample() * velocity / 127.0);</code> <br> <br>       .  <code>switch</code>   <code>Synthesis::OnParamChange</code> : <br> <br> <code class="cpp">case mFilterCutoff: mFilter.setCutoff(GetParam(paramIdx)-&gt;Value()); break; case mFilterResonance: mFilter.setResonance(GetParam(paramIdx)-&gt;Value()); break; case mFilterMode: mFilter.setFilterMode(static_cast&lt;Filter::FilterMode&gt;(GetParam(paramIdx)-&gt;Int())); break;</code> <br> <br>    .  -      . <br> <br>  <br> <br>  ‚Äî      .   ,   ,          . <br>      : <br> <br> <code class="cpp">buf0 += cutoff * (inputValue - buf0 + feedbackAmount * (buf0 - buf1));</code> <br> <br> ,   ,      ( <code>buf0 ‚Äì buf1</code> ),   <code>feedbackAmount</code> .    <code>calculateFeedbackAmount</code>  <code>feedbackAmount</code>  <code>resonance</code> , . .    ,   . <br> <br>  ,            .     ,  <i></i> ,      <a href="https://www.youtube.com/watch%3Fv%3DJWyMj6KxGHM"> </a> .    ,        ,       . <br> <br>  -12 /  -24 / <br>        !     24   .     <code>switch</code>  <code>Filter::process</code> : <br> <br> <code class="cpp">buf2 += cutoff * (buf1 - buf2); buf3 += cutoff * (buf2 ‚Äì buf3);</code> <br> <br>   :      ,       ,            .     ,       , , <a href="https://ccrma.stanford.edu/~Jos/filters/Filter_Stability.html"></a> (       ).     <code>switch</code> : <br> <br> <code class="cpp">switch (mode) { case FILTER_MODE_LOWPASS: return buf3; case FILTER_MODE_HIGHPASS: return inputValue - buf3; case FILTER_MODE_BANDPASS: return buf0 - buf3; default: return 0.0; }</code> <br> <br>   <code>buf1</code>  <code>buf3</code> ‚Äì      .    -24 /.     <code>buf2</code>  <code>buf3</code> ,        <code>private</code> <i>Filter.h</i> : <br> <br> <code class="cpp">double buf2; double buf3;</code> <br> <br>    ,   <code>buf0</code> c <code>buf1</code> : <br> <br> <code class="cpp">Filter() : // ... buf0(0.0), buf1(0.0), buf2(0.0), buf3(0.0) // ...</code> <br> <br>     , ,     :     .       . <br>          ? <br> <br>   <br>    .  ,           ,       . <br> -      <code>cutoff</code>   .      .    <code>cutoffMod</code> ,    ,       <code>cutoff</code>    .     <code>#include    private</code> : <br> <br> <code class="cpp">double cutoffMod;</code> <br> <br> : <br> <br> <code class="cpp">Filter() : cutoff(0.99), resonance(0.01), cutoffMod(0.0), // ...</code> <br> <br>         .   <code>private</code> : <br> <br> <code class="cpp">inline double getCalculatedCutoff() const { return fmax(fmin(cutoff + cutoffMod, 0.99), 0.01); };</code> <br> <br> <code>calculateFeedbackAmount</code>     : <br> <br> <code class="cpp">inline void calculateFeedbackAmount() { feedbackAmount = resonance + resonance/(1.0 - getCalculatedCutoff()); }</code> <br> <br>       <code>cutoffMod</code> .   <code>feedbackAmount</code>    ,     : <br> <br> <code class="cpp">inline void setCutoffMod(double newCutoffMod) { cutoffMod = newCutoffMod; calculateFeedbackAmount(); }</code> <br> <br> ,       .   <code>Filter::process</code>   : <br> <br> <code class="cpp">if (inputValue == 0.0) return inputValue; double calculatedCutoff = getCalculatedCutoff(); buf0 += calculatedCutoff * (inputValue - buf0 + feedbackAmount * (buf0 - buf1)); buf1 += calculatedCutoff * (buf0 - buf1); buf2 += calculatedCutoff * (buf1 - buf2); buf3 += calculatedCutoff * (buf2 ‚Äì buf3);</code> <br> <br>        ,    .    ,      ,   .     .     <code>cutoff</code>  <code>calculatedCutoff</code>   -. <br> <br> ,       ( <code>setCutoffMod</code> ),   <code>Synthesis</code>    ,     ,    .    ,        <code>cutoffMod</code> .    <code>filterEnvelopeAmount</code>    <code>-1</code>  <code>+1</code> .   GUI. <br> <br>   <code>private</code> <i>Synthesis.h</i>    : <br> <br> <code class="cpp">EnvelopeGenerator mFilterEnvelopeGenerator; double filterEnvelopeAmount;</code> <br> <br>       MIDI ,      <code>onNoteOn</code>  <code>onNoteOff</code> : <br> <br> <code class="cpp">inline void onNoteOn(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); mFilterEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); }; inline void onNoteOff(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); mFilterEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); };</code> <br> <br>    .   <code>ProcessDoubleReplacing</code>        : <br> <br> <code class="cpp">mFilter.setCutoffMod(mFilterEnvelopeGenerator.nextSample() * filterEnvelopeAmount);</code> <br> <br>  ,        <code>nextSample</code>  <code>filterEnvelopeAmount</code>     <code>cutoffMod</code> .     <code>filterEnvelopeAmount</code>  : <br> <br> <code class="cpp">Synthesis::Synthesis(IPlugInstanceInfo instanceInfo) : IPLUG_CTOR(kNumParams, kNumPrograms, instanceInfo), lastVirtualKeyboardNoteNumber(virtualKeyboardMinimumNoteNumber - 1), filterEnvelopeAmount(0.0) { // ... }</code> <br> <br>       <code>Synthesis::Reset</code> : <br> <br> <code class="cpp">mFilterEnvelopeGenerator.setSampleRate(GetSampleRate());</code> <br> <br>      <code>EParams</code> ,       .  <code>AttachGraphics</code>     : <br> <br> <code class="cpp">// Knobs for filter envelope // Attack knob GetParam(mFilterAttack)-&gt;InitDouble("Filter Env Attack", 0.01, 0.01, 10.0, 0.001); GetParam(mFilterAttack)-&gt;SetShape(3); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 139, 178, mFilterAttack, &amp;smallKnobBitmap)); // Decay knob: GetParam(mFilterDecay)-&gt;InitDouble("Filter Env Decay", 0.5, 0.01, 15.0, 0.001); GetParam(mFilterDecay)-&gt;SetShape(3); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 195, 178, mFilterDecay, &amp;smallKnobBitmap)); // Sustain knob: GetParam(mFilterSustain)-&gt;InitDouble("Filter Env Sustain", 0.1, 0.001, 1.0, 0.001); GetParam(mFilterSustain)-&gt;SetShape(2); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 251, 178, mFilterSustain, &amp;smallKnobBitmap)); // Release knob: GetParam(mFilterRelease)-&gt;InitDouble("Filter Env Release", 1.0, 0.001, 15.0, 0.001); GetParam(mFilterRelease)-&gt;SetShape(3); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 307, 178, mFilterRelease, &amp;smallKnobBitmap)); // Filter envelope amount knob: GetParam(mFilterEnvelopeAmount)-&gt;InitDouble("Filter Env Amount", 0.0, -1.0, 1.0, 0.001); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 363, 178, mFilterEnvelopeAmount, &amp;smallKnobBitmap));</code> <br> <br>     ,       <code>smallKnobBitmap</code> .                   .     ,    .  <code>Synthesis::OnParamChange</code>    <code>switch</code> : <br> <br> <code class="cpp">case mFilterAttack: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK, GetParam(paramIdx)-&gt;Value()); break; case mFilterDecay: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_DECAY, GetParam(paramIdx)-&gt;Value()); break; case mFilterSustain: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_SUSTAIN, GetParam(paramIdx)-&gt;Value()); break; case mFilterRelease: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE, GetParam(paramIdx)-&gt;Value()); break; case mFilterEnvelopeAmount: filterEnvelopeAmount = GetParam(paramIdx)-&gt;Value(); break;</code> <br> <br> ! <br>     !           (-   C1),   : <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/f5d/757/3f9/f5d7573f9b3a720fe5898d88ae477cfc.png"> <br> <br>        <code>EnvelopeGenerator</code>  .         .        ! <br> <br>    <a href=""></a> . <br> <br>        :) <br> <br>  : <br> <a href="http://martin-finke.de/blog/articles/audio-plugins-013-filter/">martin-finke.de/blog/articles/audio-plugins-013-filter</a></code></code> <pre> <code class="hljs erlang-repl"><code class="cpp">#include  <i>Filter.h</i> ( )     : <br> <br> class Filter { public: enum FilterMode { FILTER_MODE_LOWPASS = <span class="hljs-number"><span class="hljs-number">0</span></span>, FILTER_MODE_HIGHPASS, FILTER_MODE_BANDPASS, kNumFilterModes }; Filter() : cutoff(<span class="hljs-number"><span class="hljs-number">0.99</span></span>), resonance(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), mode(FILTER_MODE_LOWPASS), buf0(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), buf1(<span class="hljs-number"><span class="hljs-number">0.0</span></span>) { calculateFeedbackAmount(); }; double process(double inputValue); inline void setCutoff(double newCutoff) { cutoff = newCutoff; calculateFeedbackAmount(); }; inline void setResonance(double newResonance) { resonance = newResonance; calculateFeedbackAmount(); }; inline void setFilterMode(FilterMode newMode) { mode = newMode; } private: double cutoff; double resonance; FilterMode mode; double feedbackAmount; inline void calculateFeedbackAmount() { feedbackAmount = resonance + resonance/(<span class="hljs-number"><span class="hljs-number">1.0</span></span> - cutoff); } double buf0; double buf1; };</code> <br> <br>  <code>private</code>     <i> </i> <code>cutoff</code>  <i></i> <code>resonance</code> . <code>Mode</code>      (Lowpass, Highpass, Bandpass).  <code>feedbackAmount</code> , <code>buf0</code>  <code>buf1</code>    ,    . <br>          ( <code>calculateFeedbackAmount()</code> ).  <code>process</code>      .   <code>feedbackAmount</code>   <code>cutoff</code>  <code>resonance</code> ,    <code>calculateFeedbackAmount</code>      . <br> <br>   <i>Filter.cpp</i>  : <br> <br> <code class="cpp">// By Paul Kellett // http://www.musicdsp.org/showone.php?id=<span class="hljs-number"><span class="hljs-number">29</span></span> double Filter::process(double inputValue) { buf0 += cutoff * (inputValue - buf0); buf1 += cutoff * (buf0 - buf1); switch (mode) { case FILTER_MODE_LOWPASS: return buf1; case FILTER_MODE_HIGHPASS: return inputValue - buf0; case FILTER_MODE_BANDPASS: return buf0 - buf1; default: return <span class="hljs-number"><span class="hljs-number">0.0</span></span>; } }</code> <br> <br> , ?  ,         <i> </i> . ¬´ ¬ª   ,               (. .    <span class="hljs-number"><span class="hljs-number">6</span></span> ).     <code>buf0</code>  <code>buf1</code> :        .     <code>inputValue</code> ,  - <code>buf0</code> (  ).   .    <span class="hljs-number"><span class="hljs-number">6</span></span> /   <span class="hljs-number"><span class="hljs-number">12</span></span> /.  <code>switch</code> ,  <code>buf1</code>    . , ,    <code>buf0</code> ,       <span class="hljs-number"><span class="hljs-number">12</span></span>,   <span class="hljs-number"><span class="hljs-number">6</span></span> /,        . <br> <br>  <code>case</code> <code>FILTER_MODE_HIGHPASS</code>    . <code>buf0</code>       .   <code>inputValue</code>  <code>buf0</code> ,   .    <code>buf1</code> ,     . <br> <br>  <code>case</code> <code>FILTER_MODE_BANDPASS</code> ,  <code>buf0 - buf1</code>   .  <code>buf0</code>       ,     <code>buf1</code> . ,   . <br>  :    <i> </i>    <i> </i> ,   . <br> <br>  <code>buf1</code>     .       <a href="http://ru.wikipedia.org/wiki/%25D0%25A4%25D0%25B8%25D0%25BB%25D1%258C%25D1%2582%25D1%2580_%25D1%2581_%25D0%25B1%25D0%25B5%25D1%2581%25D0%25BA%25D0%25BE%25D0%25BD%25D0%25B5%25D1%2587%25D0%25BD%25D0%25BE%25D0%25B9_%25D0%25B8%25D0%25BC%25D0%25BF%25D1%2583%25D0%25BB%25D1%258C%25D1%2581%25D0%25BD%25D0%25BE%25D0%25B9_%25D1%2585%25D0%25B0%25D1%2580%25D0%25B0%25D0%25BA%25D1%2582%25D0%25B5%25D1%2580%25D0%25B8%25D1%2581%25D1%2582%25D0%25B8%25D0%25BA%25D0%25BE%25D0%25B9">    </a> ( <i>Infinite Impulse Response</i> ,  <i>IIR</i> ).  <a href="http://www.dspguide.com/ch14/1.htm"> </a> ,      .      ,         ,      . <br> <br>   <br>       ,     ,     .   ,  ,      ,  ,          .           ,  NI Massive,   ¬´ <a href="http://lurkmore.to/%25D0%25A2%25D1%2591%25D0%25BF%25D0%25BB%25D1%258B%25D0%25B9_%25D0%25BB%25D0%25B0%25D0%25BC%25D0%25BF%25D0%25BE%25D0%25B2%25D1%258B%25D0%25B9_%25D0%25B7%25D0%25B2%25D1%2583%25D0%25BA">  </a> ¬ª.       ,          ,   .        ,          (  Massive       ).      ¬´¬ª , , , AAS Ultra Analog,       ,     ,    ,        .         ,  ,    <a href="http://www.kvraudio.com/forum/viewtopic.php%3Ft%3D350246"></a> ,   ,      NI Reaktor. ,            ‚Äî    ,    ..     . <br> <br>   <br>     .   GUI.  <i>bg.png</i>   ( <i>‚ÄúMove to trash‚Äù</i>  Xcode),       : <br> <br> <a href="">filtermode.png</a> <a href="">knob_small.png</a> (  ,   <span class="hljs-number"><span class="hljs-number">50</span></span> <span class="hljs-number"><span class="hljs-number">50</span></span> ) <a href="">bg.png</a> (       ) <br> <br>    ID  <i>resource.h</i> : <br> <br> <code class="cpp">// Unique IDs for each image resource. #define BG_ID <span class="hljs-number"><span class="hljs-number">101</span></span> #define WHITE_KEY_ID <span class="hljs-number"><span class="hljs-number">102</span></span> #define BLACK_KEY_ID <span class="hljs-number"><span class="hljs-number">103</span></span> #define WAVEFORM_ID <span class="hljs-number"><span class="hljs-number">104</span></span> #define KNOB_ID <span class="hljs-number"><span class="hljs-number">105</span></span> #define KNOB_SMALL_ID <span class="hljs-number"><span class="hljs-number">106</span></span> #define FILTERMODE_ID <span class="hljs-number"><span class="hljs-number">107</span></span> // Image resource locations for this plug. #define BG_FN <span class="hljs-string"><span class="hljs-string">"resources/img/bg.png"</span></span> #define WHITE_KEY_FN <span class="hljs-string"><span class="hljs-string">"resources/img/whitekey.png"</span></span> #define BLACK_KEY_FN <span class="hljs-string"><span class="hljs-string">"resources/img/blackkey.png"</span></span> #define WAVEFORM_FN <span class="hljs-string"><span class="hljs-string">"resources/img/waveform.png"</span></span> #define KNOB_FN <span class="hljs-string"><span class="hljs-string">"resources/img/knob.png"</span></span> #define KNOB_SMALL_FN <span class="hljs-string"><span class="hljs-string">"resources/img/knob_small.png"</span></span> #define FILTERMODE_FN <span class="hljs-string"><span class="hljs-string">"resources/img/filtermode.png"</span></span></code> <br> <br>  <i>Synthesis.rc</i> : <br> <br> <code class="cpp">#include <span class="hljs-string"><span class="hljs-string">"resource.h"</span></span> BG_ID PNG BG_FN WHITE_KEY_ID PNG WHITE_KEY_FN BLACK_KEY_ID PNG BLACK_KEY_FN WAVEFORM_ID PNG WAVEFORM_FN KNOB_ID PNG KNOB_FN KNOB_SMALL_ID PNG KNOB_SMALL_FN FILTERMODE_ID PNG FILTERMODE_FN</code> <br> <br>   <code>#include <span class="hljs-string"><span class="hljs-string">"Filter.h"</span></span></code>  <i>Synthesis.h</i>    <code>private</code> : <br> <br> <code class="cpp">Filter mFilter;</code> <br> <br>  <code>EParams</code>  <i>Synthesis.cpp</i> : <br> <br> <code class="cpp">enum EParams { mWaveform = <span class="hljs-number"><span class="hljs-number">0</span></span>, mAttack, mDecay, mSustain, mRelease, mFilterMode, mFilterCutoff, mFilterResonance, mFilterAttack, mFilterDecay, mFilterSustain, mFilterRelease, mFilterEnvelopeAmount, kNumParams };</code> <br> <br>        : <br> <br> <code class="cpp">pGraphics-&gt;AttachControl(new ISwitchControl(this, <span class="hljs-number"><span class="hljs-number">24</span></span>, <span class="hljs-number"><span class="hljs-number">38</span></span>, mWaveform, &amp;waveformBitmap));</code> <br> <br>      .      (Lowpass, Highpass, Bandpass).    <code>AttachGraphics(pGraphics)</code> : <br> <br> <code class="cpp">GetParam(mFilterMode)-&gt;InitEnum(<span class="hljs-string"><span class="hljs-string">"Filter Mode"</span></span>, Filter::FILTER_MODE_LOWPASS, Filter::kNumFilterModes); IBitmap filtermodeBitmap = pGraphics-&gt;LoadIBitmap(FILTERMODE_ID, FILTERMODE_FN, <span class="hljs-number"><span class="hljs-number">3</span></span>); pGraphics-&gt;AttachControl(new ISwitchControl(this, <span class="hljs-number"><span class="hljs-number">24</span></span>, <span class="hljs-number"><span class="hljs-number">123</span></span>, mFilterMode, &amp;filtermodeBitmap));</code> <br> <br>         .    .     <i>knob_small.png</i> : <br> <br> <code class="cpp">// Knobs for filter cutoff and resonance IBitmap smallKnobBitmap = pGraphics-&gt;LoadIBitmap(KNOB_SMALL_ID, KNOB_SMALL_FN, <span class="hljs-number"><span class="hljs-number">64</span></span>); // Cutoff knob: GetParam(mFilterCutoff)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Cutoff"</span></span>, <span class="hljs-number"><span class="hljs-number">0.99</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">0.99</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); GetParam(mFilterCutoff)-&gt;SetShape(<span class="hljs-number"><span class="hljs-number">2</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-number"><span class="hljs-number">177</span></span>, mFilterCutoff, &amp;smallKnobBitmap)); // Resonance knob: GetParam(mFilterResonance)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Resonance"</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">61</span></span>, <span class="hljs-number"><span class="hljs-number">177</span></span>, mFilterResonance, &amp;smallKnobBitmap));</code> <br> <br>   ,           <code><span class="hljs-number"><span class="hljs-number">1.0</span></span></code> ,   <code>calculateFeedbackAmount</code>    , . <br>  <code>ProcessDoubleReplacing</code>     : <br> <br> <code class="cpp">leftOutput[i] = rightOutput[i] = mFilter.process(mOscillator.nextSample() * mEnvelopeGenerator.nextSample() * velocity / <span class="hljs-number"><span class="hljs-number">127.0</span></span>);</code> <br> <br>       .  <code>switch</code>   <code>Synthesis::OnParamChange</code> : <br> <br> <code class="cpp">case mFilterCutoff: mFilter.setCutoff(GetParam(paramIdx)-&gt;Value()); break; case mFilterResonance: mFilter.setResonance(GetParam(paramIdx)-&gt;Value()); break; case mFilterMode: mFilter.setFilterMode(static_cast&lt;Filter::FilterMode&gt;(GetParam(paramIdx)-&gt;Int())); break;</code> <br> <br>    .  -      . <br> <br>  <br> <br>  ‚Äî      .   ,   ,          . <br>      : <br> <br> <code class="cpp">buf0 += cutoff * (inputValue - buf0 + feedbackAmount * (buf0 - buf1));</code> <br> <br> ,   ,      ( <code>buf0 ‚Äì buf1</code> ),   <code>feedbackAmount</code> .    <code>calculateFeedbackAmount</code>  <code>feedbackAmount</code>  <code>resonance</code> , . .    ,   . <br> <br>  ,            .     ,  <i></i> ,      <a href="https://www.youtube.com/watch%3Fv%3DJWyMj6KxGHM"> </a> .    ,        ,       . <br> <br>  -<span class="hljs-number"><span class="hljs-number">12</span></span> /  -<span class="hljs-number"><span class="hljs-number">24</span></span> / <br>        !     <span class="hljs-number"><span class="hljs-number">24</span></span>   .     <code>switch</code>  <code>Filter::process</code> : <br> <br> <code class="cpp">buf2 += cutoff * (buf1 - buf2); buf3 += cutoff * (buf2 ‚Äì buf3);</code> <br> <br>   :      ,       ,            .     ,       , , <a href="https://ccrma.stanford.edu/~Jos/filters/Filter_Stability.html"></a> (       ).     <code>switch</code> : <br> <br> <code class="cpp">switch (mode) { case FILTER_MODE_LOWPASS: return buf3; case FILTER_MODE_HIGHPASS: return inputValue - buf3; case FILTER_MODE_BANDPASS: return buf0 - buf3; default: return <span class="hljs-number"><span class="hljs-number">0.0</span></span>; }</code> <br> <br>   <code>buf1</code>  <code>buf3</code> ‚Äì      .    -<span class="hljs-number"><span class="hljs-number">24</span></span> /.     <code>buf2</code>  <code>buf3</code> ,        <code>private</code> <i>Filter.h</i> : <br> <br> <code class="cpp">double buf2; double buf3;</code> <br> <br>    ,   <code>buf0</code> c <code>buf1</code> : <br> <br> <code class="cpp">Filter() : // ... buf0(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), buf1(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), buf2(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), buf3(<span class="hljs-number"><span class="hljs-number">0.0</span></span>) // ...</code> <br> <br>     , ,     :     .       . <br>          ? <br> <br>   <br>    .  ,           ,       . <br> -      <code>cutoff</code>   .      .    <code>cutoffMod</code> ,    ,       <code>cutoff</code>    .     <code><code>#include    private</code> : <br> <br> <code class="cpp">double cutoffMod;</code> <br> <br> : <br> <br> <code class="cpp">Filter() : cutoff(<span class="hljs-number"><span class="hljs-number">0.99</span></span>), resonance(<span class="hljs-number"><span class="hljs-number">0.01</span></span>), cutoffMod(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), // ...</code> <br> <br>         .   <code>private</code> : <br> <br> <code class="cpp">inline double getCalculatedCutoff() const { return fmax(fmin(cutoff + cutoffMod, <span class="hljs-number"><span class="hljs-number">0.99</span></span>), <span class="hljs-number"><span class="hljs-number">0.01</span></span>); };</code> <br> <br> <code>calculateFeedbackAmount</code>     : <br> <br> <code class="cpp">inline void calculateFeedbackAmount() { feedbackAmount = resonance + resonance/(<span class="hljs-number"><span class="hljs-number">1.0</span></span> - getCalculatedCutoff()); }</code> <br> <br>       <code>cutoffMod</code> .   <code>feedbackAmount</code>    ,     : <br> <br> <code class="cpp">inline void setCutoffMod(double newCutoffMod) { cutoffMod = newCutoffMod; calculateFeedbackAmount(); }</code> <br> <br> ,       .   <code>Filter::process</code>   : <br> <br> <code class="cpp">if (inputValue == <span class="hljs-number"><span class="hljs-number">0.0</span></span>) return inputValue; double calculatedCutoff = getCalculatedCutoff(); buf0 += calculatedCutoff * (inputValue - buf0 + feedbackAmount * (buf0 - buf1)); buf1 += calculatedCutoff * (buf0 - buf1); buf2 += calculatedCutoff * (buf1 - buf2); buf3 += calculatedCutoff * (buf2 ‚Äì buf3);</code> <br> <br>        ,    .    ,      ,   .     .     <code>cutoff</code>  <code>calculatedCutoff</code>   -. <br> <br> ,       ( <code>setCutoffMod</code> ),   <code>Synthesis</code>    ,     ,    .    ,        <code>cutoffMod</code> .    <code>filterEnvelopeAmount</code>    <code>-<span class="hljs-number"><span class="hljs-number">1</span></span></code>  <code>+<span class="hljs-number"><span class="hljs-number">1</span></span></code> .   GUI. <br> <br>   <code>private</code> <i>Synthesis.h</i>    : <br> <br> <code class="cpp">EnvelopeGenerator mFilterEnvelopeGenerator; double filterEnvelopeAmount;</code> <br> <br>       MIDI ,      <code>onNoteOn</code>  <code>onNoteOff</code> : <br> <br> <code class="cpp">inline void onNoteOn(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); mFilterEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); }; inline void onNoteOff(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); mFilterEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); };</code> <br> <br>    .   <code>ProcessDoubleReplacing</code>        : <br> <br> <code class="cpp">mFilter.setCutoffMod(mFilterEnvelopeGenerator.nextSample() * filterEnvelopeAmount);</code> <br> <br>  ,        <code>nextSample</code>  <code>filterEnvelopeAmount</code>     <code>cutoffMod</code> .     <code>filterEnvelopeAmount</code>  : <br> <br> <code class="cpp">Synthesis::Synthesis(IPlugInstanceInfo instanceInfo) : IPLUG_CTOR(kNumParams, kNumPrograms, instanceInfo), lastVirtualKeyboardNoteNumber(virtualKeyboardMinimumNoteNumber - <span class="hljs-number"><span class="hljs-number">1</span></span>), filterEnvelopeAmount(<span class="hljs-number"><span class="hljs-number">0.0</span></span>) { // ... }</code> <br> <br>       <code>Synthesis::Reset</code> : <br> <br> <code class="cpp">mFilterEnvelopeGenerator.setSampleRate(GetSampleRate());</code> <br> <br>      <code>EParams</code> ,       .  <code>AttachGraphics</code>     : <br> <br> <code class="cpp">// Knobs for filter envelope // Attack knob GetParam(mFilterAttack)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Filter Env Attack"</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">10.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); GetParam(mFilterAttack)-&gt;SetShape(<span class="hljs-number"><span class="hljs-number">3</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">139</span></span>, <span class="hljs-number"><span class="hljs-number">178</span></span>, mFilterAttack, &amp;smallKnobBitmap)); // Decay knob: GetParam(mFilterDecay)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Filter Env Decay"</span></span>, <span class="hljs-number"><span class="hljs-number">0.5</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">15.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); GetParam(mFilterDecay)-&gt;SetShape(<span class="hljs-number"><span class="hljs-number">3</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">195</span></span>, <span class="hljs-number"><span class="hljs-number">178</span></span>, mFilterDecay, &amp;smallKnobBitmap)); // Sustain knob: GetParam(mFilterSustain)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Filter Env Sustain"</span></span>, <span class="hljs-number"><span class="hljs-number">0.1</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>, <span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); GetParam(mFilterSustain)-&gt;SetShape(<span class="hljs-number"><span class="hljs-number">2</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">251</span></span>, <span class="hljs-number"><span class="hljs-number">178</span></span>, mFilterSustain, &amp;smallKnobBitmap)); // Release knob: GetParam(mFilterRelease)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Filter Env Release"</span></span>, <span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>, <span class="hljs-number"><span class="hljs-number">15.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); GetParam(mFilterRelease)-&gt;SetShape(<span class="hljs-number"><span class="hljs-number">3</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">307</span></span>, <span class="hljs-number"><span class="hljs-number">178</span></span>, mFilterRelease, &amp;smallKnobBitmap)); // Filter envelope amount knob: GetParam(mFilterEnvelopeAmount)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Filter Env Amount"</span></span>, <span class="hljs-number"><span class="hljs-number">0.0</span></span>, -<span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">363</span></span>, <span class="hljs-number"><span class="hljs-number">178</span></span>, mFilterEnvelopeAmount, &amp;smallKnobBitmap));</code> <br> <br>     ,       <code>smallKnobBitmap</code> .                   .     ,    .  <code>Synthesis::OnParamChange</code>    <code>switch</code> : <br> <br> <code class="cpp">case mFilterAttack: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK, GetParam(paramIdx)-&gt;Value()); break; case mFilterDecay: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_DECAY, GetParam(paramIdx)-&gt;Value()); break; case mFilterSustain: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_SUSTAIN, GetParam(paramIdx)-&gt;Value()); break; case mFilterRelease: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE, GetParam(paramIdx)-&gt;Value()); break; case mFilterEnvelopeAmount: filterEnvelopeAmount = GetParam(paramIdx)-&gt;Value(); break;</code> <br> <br> ! <br>     !           (-   C1),   : <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/f5d/757/3f9/f5d7573f9b3a720fe5898d88ae477cfc.png"> <br> <br>        <code>EnvelopeGenerator</code>  .         .        ! <br> <br>    <a href=""></a> . <br> <br>        :) <br> <br>  : <br> <a href="http://martin-finke.de/blog/articles/audio-plugins-013-filter/">martin-finke.de/blog/articles/audio-plugins-<span class="hljs-number"><span class="hljs-number">013</span></span>-filter</a></code></code> </pre> <code><code><code class="cpp">#include  <i>Filter.h</i> ( )     : <br> <br> class Filter { public: enum FilterMode { FILTER_MODE_LOWPASS = 0, FILTER_MODE_HIGHPASS, FILTER_MODE_BANDPASS, kNumFilterModes }; Filter() : cutoff(0.99), resonance(0.0), mode(FILTER_MODE_LOWPASS), buf0(0.0), buf1(0.0) { calculateFeedbackAmount(); }; double process(double inputValue); inline void setCutoff(double newCutoff) { cutoff = newCutoff; calculateFeedbackAmount(); }; inline void setResonance(double newResonance) { resonance = newResonance; calculateFeedbackAmount(); }; inline void setFilterMode(FilterMode newMode) { mode = newMode; } private: double cutoff; double resonance; FilterMode mode; double feedbackAmount; inline void calculateFeedbackAmount() { feedbackAmount = resonance + resonance/(1.0 - cutoff); } double buf0; double buf1; };</code> <br> <br>  <code>private</code>     <i> </i> <code>cutoff</code>  <i></i> <code>resonance</code> . <code>Mode</code>      (Lowpass, Highpass, Bandpass).  <code>feedbackAmount</code> , <code>buf0</code>  <code>buf1</code>    ,    . <br>          ( <code>calculateFeedbackAmount()</code> ).  <code>process</code>      .   <code>feedbackAmount</code>   <code>cutoff</code>  <code>resonance</code> ,    <code>calculateFeedbackAmount</code>      . <br> <br>   <i>Filter.cpp</i>  : <br> <br> <code class="cpp">// By Paul Kellett // http://www.musicdsp.org/showone.php?id=29 double Filter::process(double inputValue) { buf0 += cutoff * (inputValue - buf0); buf1 += cutoff * (buf0 - buf1); switch (mode) { case FILTER_MODE_LOWPASS: return buf1; case FILTER_MODE_HIGHPASS: return inputValue - buf0; case FILTER_MODE_BANDPASS: return buf0 - buf1; default: return 0.0; } }</code> <br> <br> , ?  ,         <i> </i> . ¬´ ¬ª   ,               (. .    6 ).     <code>buf0</code>  <code>buf1</code> :        .     <code>inputValue</code> ,  - <code>buf0</code> (  ).   .    6 /   12 /.  <code>switch</code> ,  <code>buf1</code>    . , ,    <code>buf0</code> ,       12,   6 /,        . <br> <br>  <code>case</code> <code>FILTER_MODE_HIGHPASS</code>    . <code>buf0</code>       .   <code>inputValue</code>  <code>buf0</code> ,   .    <code>buf1</code> ,     . <br> <br>  <code>case</code> <code>FILTER_MODE_BANDPASS</code> ,  <code>buf0 - buf1</code>   .  <code>buf0</code>       ,     <code>buf1</code> . ,   . <br>  :    <i> </i>    <i> </i> ,   . <br> <br>  <code>buf1</code>     .       <a href="http://ru.wikipedia.org/wiki/%25D0%25A4%25D0%25B8%25D0%25BB%25D1%258C%25D1%2582%25D1%2580_%25D1%2581_%25D0%25B1%25D0%25B5%25D1%2581%25D0%25BA%25D0%25BE%25D0%25BD%25D0%25B5%25D1%2587%25D0%25BD%25D0%25BE%25D0%25B9_%25D0%25B8%25D0%25BC%25D0%25BF%25D1%2583%25D0%25BB%25D1%258C%25D1%2581%25D0%25BD%25D0%25BE%25D0%25B9_%25D1%2585%25D0%25B0%25D1%2580%25D0%25B0%25D0%25BA%25D1%2582%25D0%25B5%25D1%2580%25D0%25B8%25D1%2581%25D1%2582%25D0%25B8%25D0%25BA%25D0%25BE%25D0%25B9">    </a> ( <i>Infinite Impulse Response</i> ,  <i>IIR</i> ).  <a href="http://www.dspguide.com/ch14/1.htm"> </a> ,      .      ,         ,      . <br> <br>   <br>       ,     ,     .   ,  ,      ,  ,          .           ,  NI Massive,   ¬´ <a href="http://lurkmore.to/%25D0%25A2%25D1%2591%25D0%25BF%25D0%25BB%25D1%258B%25D0%25B9_%25D0%25BB%25D0%25B0%25D0%25BC%25D0%25BF%25D0%25BE%25D0%25B2%25D1%258B%25D0%25B9_%25D0%25B7%25D0%25B2%25D1%2583%25D0%25BA">  </a> ¬ª.       ,          ,   .        ,          (  Massive       ).      ¬´¬ª , , , AAS Ultra Analog,       ,     ,    ,        .         ,  ,    <a href="http://www.kvraudio.com/forum/viewtopic.php%3Ft%3D350246"></a> ,   ,      NI Reaktor. ,            ‚Äî    ,    ..     . <br> <br>   <br>     .   GUI.  <i>bg.png</i>   ( <i>‚ÄúMove to trash‚Äù</i>  Xcode),       : <br> <br> <a href="">filtermode.png</a> <a href="">knob_small.png</a> (  ,   50 50 ) <a href="">bg.png</a> (       ) <br> <br>    ID  <i>resource.h</i> : <br> <br> <code class="cpp">// Unique IDs for each image resource. #define BG_ID 101 #define WHITE_KEY_ID 102 #define BLACK_KEY_ID 103 #define WAVEFORM_ID 104 #define KNOB_ID 105 #define KNOB_SMALL_ID 106 #define FILTERMODE_ID 107 // Image resource locations for this plug. #define BG_FN "resources/img/bg.png" #define WHITE_KEY_FN "resources/img/whitekey.png" #define BLACK_KEY_FN "resources/img/blackkey.png" #define WAVEFORM_FN "resources/img/waveform.png" #define KNOB_FN "resources/img/knob.png" #define KNOB_SMALL_FN "resources/img/knob_small.png" #define FILTERMODE_FN "resources/img/filtermode.png"</code> <br> <br>  <i>Synthesis.rc</i> : <br> <br> <code class="cpp">#include "resource.h" BG_ID PNG BG_FN WHITE_KEY_ID PNG WHITE_KEY_FN BLACK_KEY_ID PNG BLACK_KEY_FN WAVEFORM_ID PNG WAVEFORM_FN KNOB_ID PNG KNOB_FN KNOB_SMALL_ID PNG KNOB_SMALL_FN FILTERMODE_ID PNG FILTERMODE_FN</code> <br> <br>   <code>#include "Filter.h"</code>  <i>Synthesis.h</i>    <code>private</code> : <br> <br> <code class="cpp">Filter mFilter;</code> <br> <br>  <code>EParams</code>  <i>Synthesis.cpp</i> : <br> <br> <code class="cpp">enum EParams { mWaveform = 0, mAttack, mDecay, mSustain, mRelease, mFilterMode, mFilterCutoff, mFilterResonance, mFilterAttack, mFilterDecay, mFilterSustain, mFilterRelease, mFilterEnvelopeAmount, kNumParams };</code> <br> <br>        : <br> <br> <code class="cpp">pGraphics-&gt;AttachControl(new ISwitchControl(this, 24, 38, mWaveform, &amp;waveformBitmap));</code> <br> <br>      .      (Lowpass, Highpass, Bandpass).    <code>AttachGraphics(pGraphics)</code> : <br> <br> <code class="cpp">GetParam(mFilterMode)-&gt;InitEnum("Filter Mode", Filter::FILTER_MODE_LOWPASS, Filter::kNumFilterModes); IBitmap filtermodeBitmap = pGraphics-&gt;LoadIBitmap(FILTERMODE_ID, FILTERMODE_FN, 3); pGraphics-&gt;AttachControl(new ISwitchControl(this, 24, 123, mFilterMode, &amp;filtermodeBitmap));</code> <br> <br>         .    .     <i>knob_small.png</i> : <br> <br> <code class="cpp">// Knobs for filter cutoff and resonance IBitmap smallKnobBitmap = pGraphics-&gt;LoadIBitmap(KNOB_SMALL_ID, KNOB_SMALL_FN, 64); // Cutoff knob: GetParam(mFilterCutoff)-&gt;InitDouble("Cutoff", 0.99, 0.01, 0.99, 0.001); GetParam(mFilterCutoff)-&gt;SetShape(2); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 5, 177, mFilterCutoff, &amp;smallKnobBitmap)); // Resonance knob: GetParam(mFilterResonance)-&gt;InitDouble("Resonance", 0.01, 0.01, 1.0, 0.001); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 61, 177, mFilterResonance, &amp;smallKnobBitmap));</code> <br> <br>   ,           <code>1.0</code> ,   <code>calculateFeedbackAmount</code>    , . <br>  <code>ProcessDoubleReplacing</code>     : <br> <br> <code class="cpp">leftOutput[i] = rightOutput[i] = mFilter.process(mOscillator.nextSample() * mEnvelopeGenerator.nextSample() * velocity / 127.0);</code> <br> <br>       .  <code>switch</code>   <code>Synthesis::OnParamChange</code> : <br> <br> <code class="cpp">case mFilterCutoff: mFilter.setCutoff(GetParam(paramIdx)-&gt;Value()); break; case mFilterResonance: mFilter.setResonance(GetParam(paramIdx)-&gt;Value()); break; case mFilterMode: mFilter.setFilterMode(static_cast&lt;Filter::FilterMode&gt;(GetParam(paramIdx)-&gt;Int())); break;</code> <br> <br>    .  -      . <br> <br>  <br> <br>  ‚Äî      .   ,   ,          . <br>      : <br> <br> <code class="cpp">buf0 += cutoff * (inputValue - buf0 + feedbackAmount * (buf0 - buf1));</code> <br> <br> ,   ,      ( <code>buf0 ‚Äì buf1</code> ),   <code>feedbackAmount</code> .    <code>calculateFeedbackAmount</code>  <code>feedbackAmount</code>  <code>resonance</code> , . .    ,   . <br> <br>  ,            .     ,  <i></i> ,      <a href="https://www.youtube.com/watch%3Fv%3DJWyMj6KxGHM"> </a> .    ,        ,       . <br> <br>  -12 /  -24 / <br>        !     24   .     <code>switch</code>  <code>Filter::process</code> : <br> <br> <code class="cpp">buf2 += cutoff * (buf1 - buf2); buf3 += cutoff * (buf2 ‚Äì buf3);</code> <br> <br>   :      ,       ,            .     ,       , , <a href="https://ccrma.stanford.edu/~Jos/filters/Filter_Stability.html"></a> (       ).     <code>switch</code> : <br> <br> <code class="cpp">switch (mode) { case FILTER_MODE_LOWPASS: return buf3; case FILTER_MODE_HIGHPASS: return inputValue - buf3; case FILTER_MODE_BANDPASS: return buf0 - buf3; default: return 0.0; }</code> <br> <br>   <code>buf1</code>  <code>buf3</code> ‚Äì      .    -24 /.     <code>buf2</code>  <code>buf3</code> ,        <code>private</code> <i>Filter.h</i> : <br> <br> <code class="cpp">double buf2; double buf3;</code> <br> <br>    ,   <code>buf0</code> c <code>buf1</code> : <br> <br> <code class="cpp">Filter() : // ... buf0(0.0), buf1(0.0), buf2(0.0), buf3(0.0) // ...</code> <br> <br>     , ,     :     .       . <br>          ? <br> <br>   <br>    .  ,           ,       . <br> -      <code>cutoff</code>   .      .    <code>cutoffMod</code> ,    ,       <code>cutoff</code>    .     <code>#include    private</code> : <br> <br> <code class="cpp">double cutoffMod;</code> <br> <br> : <br> <br> <code class="cpp">Filter() : cutoff(0.99), resonance(0.01), cutoffMod(0.0), // ...</code> <br> <br>         .   <code>private</code> : <br> <br> <code class="cpp">inline double getCalculatedCutoff() const { return fmax(fmin(cutoff + cutoffMod, 0.99), 0.01); };</code> <br> <br> <code>calculateFeedbackAmount</code>     : <br> <br> <code class="cpp">inline void calculateFeedbackAmount() { feedbackAmount = resonance + resonance/(1.0 - getCalculatedCutoff()); }</code> <br> <br>       <code>cutoffMod</code> .   <code>feedbackAmount</code>    ,     : <br> <br> <code class="cpp">inline void setCutoffMod(double newCutoffMod) { cutoffMod = newCutoffMod; calculateFeedbackAmount(); }</code> <br> <br> ,       .   <code>Filter::process</code>   : <br> <br> <code class="cpp">if (inputValue == 0.0) return inputValue; double calculatedCutoff = getCalculatedCutoff(); buf0 += calculatedCutoff * (inputValue - buf0 + feedbackAmount * (buf0 - buf1)); buf1 += calculatedCutoff * (buf0 - buf1); buf2 += calculatedCutoff * (buf1 - buf2); buf3 += calculatedCutoff * (buf2 ‚Äì buf3);</code> <br> <br>        ,    .    ,      ,   .     .     <code>cutoff</code>  <code>calculatedCutoff</code>   -. <br> <br> ,       ( <code>setCutoffMod</code> ),   <code>Synthesis</code>    ,     ,    .    ,        <code>cutoffMod</code> .    <code>filterEnvelopeAmount</code>    <code>-1</code>  <code>+1</code> .   GUI. <br> <br>   <code>private</code> <i>Synthesis.h</i>    : <br> <br> <code class="cpp">EnvelopeGenerator mFilterEnvelopeGenerator; double filterEnvelopeAmount;</code> <br> <br>       MIDI ,      <code>onNoteOn</code>  <code>onNoteOff</code> : <br> <br> <code class="cpp">inline void onNoteOn(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); mFilterEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); }; inline void onNoteOff(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); mFilterEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); };</code> <br> <br>    .   <code>ProcessDoubleReplacing</code>        : <br> <br> <code class="cpp">mFilter.setCutoffMod(mFilterEnvelopeGenerator.nextSample() * filterEnvelopeAmount);</code> <br> <br>  ,        <code>nextSample</code>  <code>filterEnvelopeAmount</code>     <code>cutoffMod</code> .     <code>filterEnvelopeAmount</code>  : <br> <br> <code class="cpp">Synthesis::Synthesis(IPlugInstanceInfo instanceInfo) : IPLUG_CTOR(kNumParams, kNumPrograms, instanceInfo), lastVirtualKeyboardNoteNumber(virtualKeyboardMinimumNoteNumber - 1), filterEnvelopeAmount(0.0) { // ... }</code> <br> <br>       <code>Synthesis::Reset</code> : <br> <br> <code class="cpp">mFilterEnvelopeGenerator.setSampleRate(GetSampleRate());</code> <br> <br>      <code>EParams</code> ,       .  <code>AttachGraphics</code>     : <br> <br> <code class="cpp">// Knobs for filter envelope // Attack knob GetParam(mFilterAttack)-&gt;InitDouble("Filter Env Attack", 0.01, 0.01, 10.0, 0.001); GetParam(mFilterAttack)-&gt;SetShape(3); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 139, 178, mFilterAttack, &amp;smallKnobBitmap)); // Decay knob: GetParam(mFilterDecay)-&gt;InitDouble("Filter Env Decay", 0.5, 0.01, 15.0, 0.001); GetParam(mFilterDecay)-&gt;SetShape(3); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 195, 178, mFilterDecay, &amp;smallKnobBitmap)); // Sustain knob: GetParam(mFilterSustain)-&gt;InitDouble("Filter Env Sustain", 0.1, 0.001, 1.0, 0.001); GetParam(mFilterSustain)-&gt;SetShape(2); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 251, 178, mFilterSustain, &amp;smallKnobBitmap)); // Release knob: GetParam(mFilterRelease)-&gt;InitDouble("Filter Env Release", 1.0, 0.001, 15.0, 0.001); GetParam(mFilterRelease)-&gt;SetShape(3); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 307, 178, mFilterRelease, &amp;smallKnobBitmap)); // Filter envelope amount knob: GetParam(mFilterEnvelopeAmount)-&gt;InitDouble("Filter Env Amount", 0.0, -1.0, 1.0, 0.001); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 363, 178, mFilterEnvelopeAmount, &amp;smallKnobBitmap));</code> <br> <br>     ,       <code>smallKnobBitmap</code> .                   .     ,    .  <code>Synthesis::OnParamChange</code>    <code>switch</code> : <br> <br> <code class="cpp">case mFilterAttack: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK, GetParam(paramIdx)-&gt;Value()); break; case mFilterDecay: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_DECAY, GetParam(paramIdx)-&gt;Value()); break; case mFilterSustain: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_SUSTAIN, GetParam(paramIdx)-&gt;Value()); break; case mFilterRelease: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE, GetParam(paramIdx)-&gt;Value()); break; case mFilterEnvelopeAmount: filterEnvelopeAmount = GetParam(paramIdx)-&gt;Value(); break;</code> <br> <br> ! <br>     !           (-   C1),   : <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/f5d/757/3f9/f5d7573f9b3a720fe5898d88ae477cfc.png"> <br> <br>        <code>EnvelopeGenerator</code>  .         .        ! <br> <br>    <a href=""></a> . <br> <br>        :) <br> <br>  : <br> <a href="http://martin-finke.de/blog/articles/audio-plugins-013-filter/">martin-finke.de/blog/articles/audio-plugins-013-filter</a></code></code> <pre> <code class="hljs erlang-repl"><code class="cpp">#include  <i>Filter.h</i> ( )     : <br> <br> class Filter { public: enum FilterMode { FILTER_MODE_LOWPASS = <span class="hljs-number"><span class="hljs-number">0</span></span>, FILTER_MODE_HIGHPASS, FILTER_MODE_BANDPASS, kNumFilterModes }; Filter() : cutoff(<span class="hljs-number"><span class="hljs-number">0.99</span></span>), resonance(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), mode(FILTER_MODE_LOWPASS), buf0(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), buf1(<span class="hljs-number"><span class="hljs-number">0.0</span></span>) { calculateFeedbackAmount(); }; double process(double inputValue); inline void setCutoff(double newCutoff) { cutoff = newCutoff; calculateFeedbackAmount(); }; inline void setResonance(double newResonance) { resonance = newResonance; calculateFeedbackAmount(); }; inline void setFilterMode(FilterMode newMode) { mode = newMode; } private: double cutoff; double resonance; FilterMode mode; double feedbackAmount; inline void calculateFeedbackAmount() { feedbackAmount = resonance + resonance/(<span class="hljs-number"><span class="hljs-number">1.0</span></span> - cutoff); } double buf0; double buf1; };</code> <br> <br>  <code>private</code>     <i> </i> <code>cutoff</code>  <i></i> <code>resonance</code> . <code>Mode</code>      (Lowpass, Highpass, Bandpass).  <code>feedbackAmount</code> , <code>buf0</code>  <code>buf1</code>    ,    . <br>          ( <code>calculateFeedbackAmount()</code> ).  <code>process</code>      .   <code>feedbackAmount</code>   <code>cutoff</code>  <code>resonance</code> ,    <code>calculateFeedbackAmount</code>      . <br> <br>   <i>Filter.cpp</i>  : <br> <br> <code class="cpp">// By Paul Kellett // http://www.musicdsp.org/showone.php?id=<span class="hljs-number"><span class="hljs-number">29</span></span> double Filter::process(double inputValue) { buf0 += cutoff * (inputValue - buf0); buf1 += cutoff * (buf0 - buf1); switch (mode) { case FILTER_MODE_LOWPASS: return buf1; case FILTER_MODE_HIGHPASS: return inputValue - buf0; case FILTER_MODE_BANDPASS: return buf0 - buf1; default: return <span class="hljs-number"><span class="hljs-number">0.0</span></span>; } }</code> <br> <br> , ?  ,         <i> </i> . ¬´ ¬ª   ,               (. .    <span class="hljs-number"><span class="hljs-number">6</span></span> ).     <code>buf0</code>  <code>buf1</code> :        .     <code>inputValue</code> ,  - <code>buf0</code> (  ).   .    <span class="hljs-number"><span class="hljs-number">6</span></span> /   <span class="hljs-number"><span class="hljs-number">12</span></span> /.  <code>switch</code> ,  <code>buf1</code>    . , ,    <code>buf0</code> ,       <span class="hljs-number"><span class="hljs-number">12</span></span>,   <span class="hljs-number"><span class="hljs-number">6</span></span> /,        . <br> <br>  <code>case</code> <code>FILTER_MODE_HIGHPASS</code>    . <code>buf0</code>       .   <code>inputValue</code>  <code>buf0</code> ,   .    <code>buf1</code> ,     . <br> <br>  <code>case</code> <code>FILTER_MODE_BANDPASS</code> ,  <code>buf0 - buf1</code>   .  <code>buf0</code>       ,     <code>buf1</code> . ,   . <br>  :    <i> </i>    <i> </i> ,   . <br> <br>  <code>buf1</code>     .       <a href="http://ru.wikipedia.org/wiki/%25D0%25A4%25D0%25B8%25D0%25BB%25D1%258C%25D1%2582%25D1%2580_%25D1%2581_%25D0%25B1%25D0%25B5%25D1%2581%25D0%25BA%25D0%25BE%25D0%25BD%25D0%25B5%25D1%2587%25D0%25BD%25D0%25BE%25D0%25B9_%25D0%25B8%25D0%25BC%25D0%25BF%25D1%2583%25D0%25BB%25D1%258C%25D1%2581%25D0%25BD%25D0%25BE%25D0%25B9_%25D1%2585%25D0%25B0%25D1%2580%25D0%25B0%25D0%25BA%25D1%2582%25D0%25B5%25D1%2580%25D0%25B8%25D1%2581%25D1%2582%25D0%25B8%25D0%25BA%25D0%25BE%25D0%25B9">    </a> ( <i>Infinite Impulse Response</i> ,  <i>IIR</i> ).  <a href="http://www.dspguide.com/ch14/1.htm"> </a> ,      .      ,         ,      . <br> <br>   <br>       ,     ,     .   ,  ,      ,  ,          .           ,  NI Massive,   ¬´ <a href="http://lurkmore.to/%25D0%25A2%25D1%2591%25D0%25BF%25D0%25BB%25D1%258B%25D0%25B9_%25D0%25BB%25D0%25B0%25D0%25BC%25D0%25BF%25D0%25BE%25D0%25B2%25D1%258B%25D0%25B9_%25D0%25B7%25D0%25B2%25D1%2583%25D0%25BA">  </a> ¬ª.       ,          ,   .        ,          (  Massive       ).      ¬´¬ª , , , AAS Ultra Analog,       ,     ,    ,        .         ,  ,    <a href="http://www.kvraudio.com/forum/viewtopic.php%3Ft%3D350246"></a> ,   ,      NI Reaktor. ,            ‚Äî    ,    ..     . <br> <br>   <br>     .   GUI.  <i>bg.png</i>   ( <i>‚ÄúMove to trash‚Äù</i>  Xcode),       : <br> <br> <a href="">filtermode.png</a> <a href="">knob_small.png</a> (  ,   <span class="hljs-number"><span class="hljs-number">50</span></span> <span class="hljs-number"><span class="hljs-number">50</span></span> ) <a href="">bg.png</a> (       ) <br> <br>    ID  <i>resource.h</i> : <br> <br> <code class="cpp">// Unique IDs for each image resource. #define BG_ID <span class="hljs-number"><span class="hljs-number">101</span></span> #define WHITE_KEY_ID <span class="hljs-number"><span class="hljs-number">102</span></span> #define BLACK_KEY_ID <span class="hljs-number"><span class="hljs-number">103</span></span> #define WAVEFORM_ID <span class="hljs-number"><span class="hljs-number">104</span></span> #define KNOB_ID <span class="hljs-number"><span class="hljs-number">105</span></span> #define KNOB_SMALL_ID <span class="hljs-number"><span class="hljs-number">106</span></span> #define FILTERMODE_ID <span class="hljs-number"><span class="hljs-number">107</span></span> // Image resource locations for this plug. #define BG_FN <span class="hljs-string"><span class="hljs-string">"resources/img/bg.png"</span></span> #define WHITE_KEY_FN <span class="hljs-string"><span class="hljs-string">"resources/img/whitekey.png"</span></span> #define BLACK_KEY_FN <span class="hljs-string"><span class="hljs-string">"resources/img/blackkey.png"</span></span> #define WAVEFORM_FN <span class="hljs-string"><span class="hljs-string">"resources/img/waveform.png"</span></span> #define KNOB_FN <span class="hljs-string"><span class="hljs-string">"resources/img/knob.png"</span></span> #define KNOB_SMALL_FN <span class="hljs-string"><span class="hljs-string">"resources/img/knob_small.png"</span></span> #define FILTERMODE_FN <span class="hljs-string"><span class="hljs-string">"resources/img/filtermode.png"</span></span></code> <br> <br>  <i>Synthesis.rc</i> : <br> <br> <code class="cpp">#include <span class="hljs-string"><span class="hljs-string">"resource.h"</span></span> BG_ID PNG BG_FN WHITE_KEY_ID PNG WHITE_KEY_FN BLACK_KEY_ID PNG BLACK_KEY_FN WAVEFORM_ID PNG WAVEFORM_FN KNOB_ID PNG KNOB_FN KNOB_SMALL_ID PNG KNOB_SMALL_FN FILTERMODE_ID PNG FILTERMODE_FN</code> <br> <br>   <code>#include <span class="hljs-string"><span class="hljs-string">"Filter.h"</span></span></code>  <i>Synthesis.h</i>    <code>private</code> : <br> <br> <code class="cpp">Filter mFilter;</code> <br> <br>  <code>EParams</code>  <i>Synthesis.cpp</i> : <br> <br> <code class="cpp">enum EParams { mWaveform = <span class="hljs-number"><span class="hljs-number">0</span></span>, mAttack, mDecay, mSustain, mRelease, mFilterMode, mFilterCutoff, mFilterResonance, mFilterAttack, mFilterDecay, mFilterSustain, mFilterRelease, mFilterEnvelopeAmount, kNumParams };</code> <br> <br>        : <br> <br> <code class="cpp">pGraphics-&gt;AttachControl(new ISwitchControl(this, <span class="hljs-number"><span class="hljs-number">24</span></span>, <span class="hljs-number"><span class="hljs-number">38</span></span>, mWaveform, &amp;waveformBitmap));</code> <br> <br>      .      (Lowpass, Highpass, Bandpass).    <code>AttachGraphics(pGraphics)</code> : <br> <br> <code class="cpp">GetParam(mFilterMode)-&gt;InitEnum(<span class="hljs-string"><span class="hljs-string">"Filter Mode"</span></span>, Filter::FILTER_MODE_LOWPASS, Filter::kNumFilterModes); IBitmap filtermodeBitmap = pGraphics-&gt;LoadIBitmap(FILTERMODE_ID, FILTERMODE_FN, <span class="hljs-number"><span class="hljs-number">3</span></span>); pGraphics-&gt;AttachControl(new ISwitchControl(this, <span class="hljs-number"><span class="hljs-number">24</span></span>, <span class="hljs-number"><span class="hljs-number">123</span></span>, mFilterMode, &amp;filtermodeBitmap));</code> <br> <br>         .    .     <i>knob_small.png</i> : <br> <br> <code class="cpp">// Knobs for filter cutoff and resonance IBitmap smallKnobBitmap = pGraphics-&gt;LoadIBitmap(KNOB_SMALL_ID, KNOB_SMALL_FN, <span class="hljs-number"><span class="hljs-number">64</span></span>); // Cutoff knob: GetParam(mFilterCutoff)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Cutoff"</span></span>, <span class="hljs-number"><span class="hljs-number">0.99</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">0.99</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); GetParam(mFilterCutoff)-&gt;SetShape(<span class="hljs-number"><span class="hljs-number">2</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-number"><span class="hljs-number">177</span></span>, mFilterCutoff, &amp;smallKnobBitmap)); // Resonance knob: GetParam(mFilterResonance)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Resonance"</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">61</span></span>, <span class="hljs-number"><span class="hljs-number">177</span></span>, mFilterResonance, &amp;smallKnobBitmap));</code> <br> <br>   ,           <code><span class="hljs-number"><span class="hljs-number">1.0</span></span></code> ,   <code>calculateFeedbackAmount</code>    , . <br>  <code>ProcessDoubleReplacing</code>     : <br> <br> <code class="cpp">leftOutput[i] = rightOutput[i] = mFilter.process(mOscillator.nextSample() * mEnvelopeGenerator.nextSample() * velocity / <span class="hljs-number"><span class="hljs-number">127.0</span></span>);</code> <br> <br>       .  <code>switch</code>   <code>Synthesis::OnParamChange</code> : <br> <br> <code class="cpp">case mFilterCutoff: mFilter.setCutoff(GetParam(paramIdx)-&gt;Value()); break; case mFilterResonance: mFilter.setResonance(GetParam(paramIdx)-&gt;Value()); break; case mFilterMode: mFilter.setFilterMode(static_cast&lt;Filter::FilterMode&gt;(GetParam(paramIdx)-&gt;Int())); break;</code> <br> <br>    .  -      . <br> <br>  <br> <br>  ‚Äî      .   ,   ,          . <br>      : <br> <br> <code class="cpp">buf0 += cutoff * (inputValue - buf0 + feedbackAmount * (buf0 - buf1));</code> <br> <br> ,   ,      ( <code>buf0 ‚Äì buf1</code> ),   <code>feedbackAmount</code> .    <code>calculateFeedbackAmount</code>  <code>feedbackAmount</code>  <code>resonance</code> , . .    ,   . <br> <br>  ,            .     ,  <i></i> ,      <a href="https://www.youtube.com/watch%3Fv%3DJWyMj6KxGHM"> </a> .    ,        ,       . <br> <br>  -<span class="hljs-number"><span class="hljs-number">12</span></span> /  -<span class="hljs-number"><span class="hljs-number">24</span></span> / <br>        !     <span class="hljs-number"><span class="hljs-number">24</span></span>   .     <code>switch</code>  <code>Filter::process</code> : <br> <br> <code class="cpp">buf2 += cutoff * (buf1 - buf2); buf3 += cutoff * (buf2 ‚Äì buf3);</code> <br> <br>   :      ,       ,            .     ,       , , <a href="https://ccrma.stanford.edu/~Jos/filters/Filter_Stability.html"></a> (       ).     <code>switch</code> : <br> <br> <code class="cpp">switch (mode) { case FILTER_MODE_LOWPASS: return buf3; case FILTER_MODE_HIGHPASS: return inputValue - buf3; case FILTER_MODE_BANDPASS: return buf0 - buf3; default: return <span class="hljs-number"><span class="hljs-number">0.0</span></span>; }</code> <br> <br>   <code>buf1</code>  <code>buf3</code> ‚Äì      .    -<span class="hljs-number"><span class="hljs-number">24</span></span> /.     <code>buf2</code>  <code>buf3</code> ,        <code>private</code> <i>Filter.h</i> : <br> <br> <code class="cpp">double buf2; double buf3;</code> <br> <br>    ,   <code>buf0</code> c <code>buf1</code> : <br> <br> <code class="cpp">Filter() : // ... buf0(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), buf1(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), buf2(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), buf3(<span class="hljs-number"><span class="hljs-number">0.0</span></span>) // ...</code> <br> <br>     , ,     :     .       . <br>          ? <br> <br>   <br>    .  ,           ,       . <br> -      <code>cutoff</code>   .      .    <code>cutoffMod</code> ,    ,       <code>cutoff</code>    .     <code><code>#include    private</code> : <br> <br> <code class="cpp">double cutoffMod;</code> <br> <br> : <br> <br> <code class="cpp">Filter() : cutoff(<span class="hljs-number"><span class="hljs-number">0.99</span></span>), resonance(<span class="hljs-number"><span class="hljs-number">0.01</span></span>), cutoffMod(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), // ...</code> <br> <br>         .   <code>private</code> : <br> <br> <code class="cpp">inline double getCalculatedCutoff() const { return fmax(fmin(cutoff + cutoffMod, <span class="hljs-number"><span class="hljs-number">0.99</span></span>), <span class="hljs-number"><span class="hljs-number">0.01</span></span>); };</code> <br> <br> <code>calculateFeedbackAmount</code>     : <br> <br> <code class="cpp">inline void calculateFeedbackAmount() { feedbackAmount = resonance + resonance/(<span class="hljs-number"><span class="hljs-number">1.0</span></span> - getCalculatedCutoff()); }</code> <br> <br>       <code>cutoffMod</code> .   <code>feedbackAmount</code>    ,     : <br> <br> <code class="cpp">inline void setCutoffMod(double newCutoffMod) { cutoffMod = newCutoffMod; calculateFeedbackAmount(); }</code> <br> <br> ,       .   <code>Filter::process</code>   : <br> <br> <code class="cpp">if (inputValue == <span class="hljs-number"><span class="hljs-number">0.0</span></span>) return inputValue; double calculatedCutoff = getCalculatedCutoff(); buf0 += calculatedCutoff * (inputValue - buf0 + feedbackAmount * (buf0 - buf1)); buf1 += calculatedCutoff * (buf0 - buf1); buf2 += calculatedCutoff * (buf1 - buf2); buf3 += calculatedCutoff * (buf2 ‚Äì buf3);</code> <br> <br>        ,    .    ,      ,   .     .     <code>cutoff</code>  <code>calculatedCutoff</code>   -. <br> <br> ,       ( <code>setCutoffMod</code> ),   <code>Synthesis</code>    ,     ,    .    ,        <code>cutoffMod</code> .    <code>filterEnvelopeAmount</code>    <code>-<span class="hljs-number"><span class="hljs-number">1</span></span></code>  <code>+<span class="hljs-number"><span class="hljs-number">1</span></span></code> .   GUI. <br> <br>   <code>private</code> <i>Synthesis.h</i>    : <br> <br> <code class="cpp">EnvelopeGenerator mFilterEnvelopeGenerator; double filterEnvelopeAmount;</code> <br> <br>       MIDI ,      <code>onNoteOn</code>  <code>onNoteOff</code> : <br> <br> <code class="cpp">inline void onNoteOn(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); mFilterEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); }; inline void onNoteOff(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); mFilterEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); };</code> <br> <br>    .   <code>ProcessDoubleReplacing</code>        : <br> <br> <code class="cpp">mFilter.setCutoffMod(mFilterEnvelopeGenerator.nextSample() * filterEnvelopeAmount);</code> <br> <br>  ,        <code>nextSample</code>  <code>filterEnvelopeAmount</code>     <code>cutoffMod</code> .     <code>filterEnvelopeAmount</code>  : <br> <br> <code class="cpp">Synthesis::Synthesis(IPlugInstanceInfo instanceInfo) : IPLUG_CTOR(kNumParams, kNumPrograms, instanceInfo), lastVirtualKeyboardNoteNumber(virtualKeyboardMinimumNoteNumber - <span class="hljs-number"><span class="hljs-number">1</span></span>), filterEnvelopeAmount(<span class="hljs-number"><span class="hljs-number">0.0</span></span>) { // ... }</code> <br> <br>       <code>Synthesis::Reset</code> : <br> <br> <code class="cpp">mFilterEnvelopeGenerator.setSampleRate(GetSampleRate());</code> <br> <br>      <code>EParams</code> ,       .  <code>AttachGraphics</code>     : <br> <br> <code class="cpp">// Knobs for filter envelope // Attack knob GetParam(mFilterAttack)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Filter Env Attack"</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">10.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); GetParam(mFilterAttack)-&gt;SetShape(<span class="hljs-number"><span class="hljs-number">3</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">139</span></span>, <span class="hljs-number"><span class="hljs-number">178</span></span>, mFilterAttack, &amp;smallKnobBitmap)); // Decay knob: GetParam(mFilterDecay)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Filter Env Decay"</span></span>, <span class="hljs-number"><span class="hljs-number">0.5</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">15.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); GetParam(mFilterDecay)-&gt;SetShape(<span class="hljs-number"><span class="hljs-number">3</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">195</span></span>, <span class="hljs-number"><span class="hljs-number">178</span></span>, mFilterDecay, &amp;smallKnobBitmap)); // Sustain knob: GetParam(mFilterSustain)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Filter Env Sustain"</span></span>, <span class="hljs-number"><span class="hljs-number">0.1</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>, <span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); GetParam(mFilterSustain)-&gt;SetShape(<span class="hljs-number"><span class="hljs-number">2</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">251</span></span>, <span class="hljs-number"><span class="hljs-number">178</span></span>, mFilterSustain, &amp;smallKnobBitmap)); // Release knob: GetParam(mFilterRelease)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Filter Env Release"</span></span>, <span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>, <span class="hljs-number"><span class="hljs-number">15.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); GetParam(mFilterRelease)-&gt;SetShape(<span class="hljs-number"><span class="hljs-number">3</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">307</span></span>, <span class="hljs-number"><span class="hljs-number">178</span></span>, mFilterRelease, &amp;smallKnobBitmap)); // Filter envelope amount knob: GetParam(mFilterEnvelopeAmount)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Filter Env Amount"</span></span>, <span class="hljs-number"><span class="hljs-number">0.0</span></span>, -<span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">363</span></span>, <span class="hljs-number"><span class="hljs-number">178</span></span>, mFilterEnvelopeAmount, &amp;smallKnobBitmap));</code> <br> <br>     ,       <code>smallKnobBitmap</code> .                   .     ,    .  <code>Synthesis::OnParamChange</code>    <code>switch</code> : <br> <br> <code class="cpp">case mFilterAttack: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK, GetParam(paramIdx)-&gt;Value()); break; case mFilterDecay: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_DECAY, GetParam(paramIdx)-&gt;Value()); break; case mFilterSustain: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_SUSTAIN, GetParam(paramIdx)-&gt;Value()); break; case mFilterRelease: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE, GetParam(paramIdx)-&gt;Value()); break; case mFilterEnvelopeAmount: filterEnvelopeAmount = GetParam(paramIdx)-&gt;Value(); break;</code> <br> <br> ! <br>     !           (-   C1),   : <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/f5d/757/3f9/f5d7573f9b3a720fe5898d88ae477cfc.png"> <br> <br>        <code>EnvelopeGenerator</code>  .         .        ! <br> <br>    <a href=""></a> . <br> <br>        :) <br> <br>  : <br> <a href="http://martin-finke.de/blog/articles/audio-plugins-013-filter/">martin-finke.de/blog/articles/audio-plugins-<span class="hljs-number"><span class="hljs-number">013</span></span>-filter</a></code></code> </pre> <code><code><code class="cpp">#include  <i>Filter.h</i> ( )     : <br> <br> class Filter { public: enum FilterMode { FILTER_MODE_LOWPASS = 0, FILTER_MODE_HIGHPASS, FILTER_MODE_BANDPASS, kNumFilterModes }; Filter() : cutoff(0.99), resonance(0.0), mode(FILTER_MODE_LOWPASS), buf0(0.0), buf1(0.0) { calculateFeedbackAmount(); }; double process(double inputValue); inline void setCutoff(double newCutoff) { cutoff = newCutoff; calculateFeedbackAmount(); }; inline void setResonance(double newResonance) { resonance = newResonance; calculateFeedbackAmount(); }; inline void setFilterMode(FilterMode newMode) { mode = newMode; } private: double cutoff; double resonance; FilterMode mode; double feedbackAmount; inline void calculateFeedbackAmount() { feedbackAmount = resonance + resonance/(1.0 - cutoff); } double buf0; double buf1; };</code> <br> <br>  <code>private</code>     <i> </i> <code>cutoff</code>  <i></i> <code>resonance</code> . <code>Mode</code>      (Lowpass, Highpass, Bandpass).  <code>feedbackAmount</code> , <code>buf0</code>  <code>buf1</code>    ,    . <br>          ( <code>calculateFeedbackAmount()</code> ).  <code>process</code>      .   <code>feedbackAmount</code>   <code>cutoff</code>  <code>resonance</code> ,    <code>calculateFeedbackAmount</code>      . <br> <br>   <i>Filter.cpp</i>  : <br> <br> <code class="cpp">// By Paul Kellett // http://www.musicdsp.org/showone.php?id=29 double Filter::process(double inputValue) { buf0 += cutoff * (inputValue - buf0); buf1 += cutoff * (buf0 - buf1); switch (mode) { case FILTER_MODE_LOWPASS: return buf1; case FILTER_MODE_HIGHPASS: return inputValue - buf0; case FILTER_MODE_BANDPASS: return buf0 - buf1; default: return 0.0; } }</code> <br> <br> , ?  ,         <i> </i> . ¬´ ¬ª   ,               (. .    6 ).     <code>buf0</code>  <code>buf1</code> :        .     <code>inputValue</code> ,  - <code>buf0</code> (  ).   .    6 /   12 /.  <code>switch</code> ,  <code>buf1</code>    . , ,    <code>buf0</code> ,       12,   6 /,        . <br> <br>  <code>case</code> <code>FILTER_MODE_HIGHPASS</code>    . <code>buf0</code>       .   <code>inputValue</code>  <code>buf0</code> ,   .    <code>buf1</code> ,     . <br> <br>  <code>case</code> <code>FILTER_MODE_BANDPASS</code> ,  <code>buf0 - buf1</code>   .  <code>buf0</code>       ,     <code>buf1</code> . ,   . <br>  :    <i> </i>    <i> </i> ,   . <br> <br>  <code>buf1</code>     .       <a href="http://ru.wikipedia.org/wiki/%25D0%25A4%25D0%25B8%25D0%25BB%25D1%258C%25D1%2582%25D1%2580_%25D1%2581_%25D0%25B1%25D0%25B5%25D1%2581%25D0%25BA%25D0%25BE%25D0%25BD%25D0%25B5%25D1%2587%25D0%25BD%25D0%25BE%25D0%25B9_%25D0%25B8%25D0%25BC%25D0%25BF%25D1%2583%25D0%25BB%25D1%258C%25D1%2581%25D0%25BD%25D0%25BE%25D0%25B9_%25D1%2585%25D0%25B0%25D1%2580%25D0%25B0%25D0%25BA%25D1%2582%25D0%25B5%25D1%2580%25D0%25B8%25D1%2581%25D1%2582%25D0%25B8%25D0%25BA%25D0%25BE%25D0%25B9">    </a> ( <i>Infinite Impulse Response</i> ,  <i>IIR</i> ).  <a href="http://www.dspguide.com/ch14/1.htm"> </a> ,      .      ,         ,      . <br> <br>   <br>       ,     ,     .   ,  ,      ,  ,          .           ,  NI Massive,   ¬´ <a href="http://lurkmore.to/%25D0%25A2%25D1%2591%25D0%25BF%25D0%25BB%25D1%258B%25D0%25B9_%25D0%25BB%25D0%25B0%25D0%25BC%25D0%25BF%25D0%25BE%25D0%25B2%25D1%258B%25D0%25B9_%25D0%25B7%25D0%25B2%25D1%2583%25D0%25BA">  </a> ¬ª.       ,          ,   .        ,          (  Massive       ).      ¬´¬ª , , , AAS Ultra Analog,       ,     ,    ,        .         ,  ,    <a href="http://www.kvraudio.com/forum/viewtopic.php%3Ft%3D350246"></a> ,   ,      NI Reaktor. ,            ‚Äî    ,    ..     . <br> <br>   <br>     .   GUI.  <i>bg.png</i>   ( <i>‚ÄúMove to trash‚Äù</i>  Xcode),       : <br> <br> <a href="">filtermode.png</a> <a href="">knob_small.png</a> (  ,   50 50 ) <a href="">bg.png</a> (       ) <br> <br>    ID  <i>resource.h</i> : <br> <br> <code class="cpp">// Unique IDs for each image resource. #define BG_ID 101 #define WHITE_KEY_ID 102 #define BLACK_KEY_ID 103 #define WAVEFORM_ID 104 #define KNOB_ID 105 #define KNOB_SMALL_ID 106 #define FILTERMODE_ID 107 // Image resource locations for this plug. #define BG_FN "resources/img/bg.png" #define WHITE_KEY_FN "resources/img/whitekey.png" #define BLACK_KEY_FN "resources/img/blackkey.png" #define WAVEFORM_FN "resources/img/waveform.png" #define KNOB_FN "resources/img/knob.png" #define KNOB_SMALL_FN "resources/img/knob_small.png" #define FILTERMODE_FN "resources/img/filtermode.png"</code> <br> <br>  <i>Synthesis.rc</i> : <br> <br> <code class="cpp">#include "resource.h" BG_ID PNG BG_FN WHITE_KEY_ID PNG WHITE_KEY_FN BLACK_KEY_ID PNG BLACK_KEY_FN WAVEFORM_ID PNG WAVEFORM_FN KNOB_ID PNG KNOB_FN KNOB_SMALL_ID PNG KNOB_SMALL_FN FILTERMODE_ID PNG FILTERMODE_FN</code> <br> <br>   <code>#include "Filter.h"</code>  <i>Synthesis.h</i>    <code>private</code> : <br> <br> <code class="cpp">Filter mFilter;</code> <br> <br>  <code>EParams</code>  <i>Synthesis.cpp</i> : <br> <br> <code class="cpp">enum EParams { mWaveform = 0, mAttack, mDecay, mSustain, mRelease, mFilterMode, mFilterCutoff, mFilterResonance, mFilterAttack, mFilterDecay, mFilterSustain, mFilterRelease, mFilterEnvelopeAmount, kNumParams };</code> <br> <br>        : <br> <br> <code class="cpp">pGraphics-&gt;AttachControl(new ISwitchControl(this, 24, 38, mWaveform, &amp;waveformBitmap));</code> <br> <br>      .      (Lowpass, Highpass, Bandpass).    <code>AttachGraphics(pGraphics)</code> : <br> <br> <code class="cpp">GetParam(mFilterMode)-&gt;InitEnum("Filter Mode", Filter::FILTER_MODE_LOWPASS, Filter::kNumFilterModes); IBitmap filtermodeBitmap = pGraphics-&gt;LoadIBitmap(FILTERMODE_ID, FILTERMODE_FN, 3); pGraphics-&gt;AttachControl(new ISwitchControl(this, 24, 123, mFilterMode, &amp;filtermodeBitmap));</code> <br> <br>         .    .     <i>knob_small.png</i> : <br> <br> <code class="cpp">// Knobs for filter cutoff and resonance IBitmap smallKnobBitmap = pGraphics-&gt;LoadIBitmap(KNOB_SMALL_ID, KNOB_SMALL_FN, 64); // Cutoff knob: GetParam(mFilterCutoff)-&gt;InitDouble("Cutoff", 0.99, 0.01, 0.99, 0.001); GetParam(mFilterCutoff)-&gt;SetShape(2); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 5, 177, mFilterCutoff, &amp;smallKnobBitmap)); // Resonance knob: GetParam(mFilterResonance)-&gt;InitDouble("Resonance", 0.01, 0.01, 1.0, 0.001); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 61, 177, mFilterResonance, &amp;smallKnobBitmap));</code> <br> <br>   ,           <code>1.0</code> ,   <code>calculateFeedbackAmount</code>    , . <br>  <code>ProcessDoubleReplacing</code>     : <br> <br> <code class="cpp">leftOutput[i] = rightOutput[i] = mFilter.process(mOscillator.nextSample() * mEnvelopeGenerator.nextSample() * velocity / 127.0);</code> <br> <br>       .  <code>switch</code>   <code>Synthesis::OnParamChange</code> : <br> <br> <code class="cpp">case mFilterCutoff: mFilter.setCutoff(GetParam(paramIdx)-&gt;Value()); break; case mFilterResonance: mFilter.setResonance(GetParam(paramIdx)-&gt;Value()); break; case mFilterMode: mFilter.setFilterMode(static_cast&lt;Filter::FilterMode&gt;(GetParam(paramIdx)-&gt;Int())); break;</code> <br> <br>    .  -      . <br> <br>  <br> <br>  ‚Äî      .   ,   ,          . <br>      : <br> <br> <code class="cpp">buf0 += cutoff * (inputValue - buf0 + feedbackAmount * (buf0 - buf1));</code> <br> <br> ,   ,      ( <code>buf0 ‚Äì buf1</code> ),   <code>feedbackAmount</code> .    <code>calculateFeedbackAmount</code>  <code>feedbackAmount</code>  <code>resonance</code> , . .    ,   . <br> <br>  ,            .     ,  <i></i> ,      <a href="https://www.youtube.com/watch%3Fv%3DJWyMj6KxGHM"> </a> .    ,        ,       . <br> <br>  -12 /  -24 / <br>        !     24   .     <code>switch</code>  <code>Filter::process</code> : <br> <br> <code class="cpp">buf2 += cutoff * (buf1 - buf2); buf3 += cutoff * (buf2 ‚Äì buf3);</code> <br> <br>   :      ,       ,            .     ,       , , <a href="https://ccrma.stanford.edu/~Jos/filters/Filter_Stability.html"></a> (       ).     <code>switch</code> : <br> <br> <code class="cpp">switch (mode) { case FILTER_MODE_LOWPASS: return buf3; case FILTER_MODE_HIGHPASS: return inputValue - buf3; case FILTER_MODE_BANDPASS: return buf0 - buf3; default: return 0.0; }</code> <br> <br>   <code>buf1</code>  <code>buf3</code> ‚Äì      .    -24 /.     <code>buf2</code>  <code>buf3</code> ,        <code>private</code> <i>Filter.h</i> : <br> <br> <code class="cpp">double buf2; double buf3;</code> <br> <br>    ,   <code>buf0</code> c <code>buf1</code> : <br> <br> <code class="cpp">Filter() : // ... buf0(0.0), buf1(0.0), buf2(0.0), buf3(0.0) // ...</code> <br> <br>     , ,     :     .       . <br>          ? <br> <br>   <br>    .  ,           ,       . <br> -      <code>cutoff</code>   .      .    <code>cutoffMod</code> ,    ,       <code>cutoff</code>    .     <code>#include    private</code> : <br> <br> <code class="cpp">double cutoffMod;</code> <br> <br> : <br> <br> <code class="cpp">Filter() : cutoff(0.99), resonance(0.01), cutoffMod(0.0), // ...</code> <br> <br>         .   <code>private</code> : <br> <br> <code class="cpp">inline double getCalculatedCutoff() const { return fmax(fmin(cutoff + cutoffMod, 0.99), 0.01); };</code> <br> <br> <code>calculateFeedbackAmount</code>     : <br> <br> <code class="cpp">inline void calculateFeedbackAmount() { feedbackAmount = resonance + resonance/(1.0 - getCalculatedCutoff()); }</code> <br> <br>       <code>cutoffMod</code> .   <code>feedbackAmount</code>    ,     : <br> <br> <code class="cpp">inline void setCutoffMod(double newCutoffMod) { cutoffMod = newCutoffMod; calculateFeedbackAmount(); }</code> <br> <br> ,       .   <code>Filter::process</code>   : <br> <br> <code class="cpp">if (inputValue == 0.0) return inputValue; double calculatedCutoff = getCalculatedCutoff(); buf0 += calculatedCutoff * (inputValue - buf0 + feedbackAmount * (buf0 - buf1)); buf1 += calculatedCutoff * (buf0 - buf1); buf2 += calculatedCutoff * (buf1 - buf2); buf3 += calculatedCutoff * (buf2 ‚Äì buf3);</code> <br> <br>        ,    .    ,      ,   .     .     <code>cutoff</code>  <code>calculatedCutoff</code>   -. <br> <br> ,       ( <code>setCutoffMod</code> ),   <code>Synthesis</code>    ,     ,    .    ,        <code>cutoffMod</code> .    <code>filterEnvelopeAmount</code>    <code>-1</code>  <code>+1</code> .   GUI. <br> <br>   <code>private</code> <i>Synthesis.h</i>    : <br> <br> <code class="cpp">EnvelopeGenerator mFilterEnvelopeGenerator; double filterEnvelopeAmount;</code> <br> <br>       MIDI ,      <code>onNoteOn</code>  <code>onNoteOff</code> : <br> <br> <code class="cpp">inline void onNoteOn(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); mFilterEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); }; inline void onNoteOff(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); mFilterEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); };</code> <br> <br>    .   <code>ProcessDoubleReplacing</code>        : <br> <br> <code class="cpp">mFilter.setCutoffMod(mFilterEnvelopeGenerator.nextSample() * filterEnvelopeAmount);</code> <br> <br>  ,        <code>nextSample</code>  <code>filterEnvelopeAmount</code>     <code>cutoffMod</code> .     <code>filterEnvelopeAmount</code>  : <br> <br> <code class="cpp">Synthesis::Synthesis(IPlugInstanceInfo instanceInfo) : IPLUG_CTOR(kNumParams, kNumPrograms, instanceInfo), lastVirtualKeyboardNoteNumber(virtualKeyboardMinimumNoteNumber - 1), filterEnvelopeAmount(0.0) { // ... }</code> <br> <br>       <code>Synthesis::Reset</code> : <br> <br> <code class="cpp">mFilterEnvelopeGenerator.setSampleRate(GetSampleRate());</code> <br> <br>      <code>EParams</code> ,       .  <code>AttachGraphics</code>     : <br> <br> <code class="cpp">// Knobs for filter envelope // Attack knob GetParam(mFilterAttack)-&gt;InitDouble("Filter Env Attack", 0.01, 0.01, 10.0, 0.001); GetParam(mFilterAttack)-&gt;SetShape(3); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 139, 178, mFilterAttack, &amp;smallKnobBitmap)); // Decay knob: GetParam(mFilterDecay)-&gt;InitDouble("Filter Env Decay", 0.5, 0.01, 15.0, 0.001); GetParam(mFilterDecay)-&gt;SetShape(3); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 195, 178, mFilterDecay, &amp;smallKnobBitmap)); // Sustain knob: GetParam(mFilterSustain)-&gt;InitDouble("Filter Env Sustain", 0.1, 0.001, 1.0, 0.001); GetParam(mFilterSustain)-&gt;SetShape(2); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 251, 178, mFilterSustain, &amp;smallKnobBitmap)); // Release knob: GetParam(mFilterRelease)-&gt;InitDouble("Filter Env Release", 1.0, 0.001, 15.0, 0.001); GetParam(mFilterRelease)-&gt;SetShape(3); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 307, 178, mFilterRelease, &amp;smallKnobBitmap)); // Filter envelope amount knob: GetParam(mFilterEnvelopeAmount)-&gt;InitDouble("Filter Env Amount", 0.0, -1.0, 1.0, 0.001); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 363, 178, mFilterEnvelopeAmount, &amp;smallKnobBitmap));</code> <br> <br>     ,       <code>smallKnobBitmap</code> .                   .     ,    .  <code>Synthesis::OnParamChange</code>    <code>switch</code> : <br> <br> <code class="cpp">case mFilterAttack: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK, GetParam(paramIdx)-&gt;Value()); break; case mFilterDecay: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_DECAY, GetParam(paramIdx)-&gt;Value()); break; case mFilterSustain: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_SUSTAIN, GetParam(paramIdx)-&gt;Value()); break; case mFilterRelease: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE, GetParam(paramIdx)-&gt;Value()); break; case mFilterEnvelopeAmount: filterEnvelopeAmount = GetParam(paramIdx)-&gt;Value(); break;</code> <br> <br> ! <br>     !           (-   C1),   : <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/f5d/757/3f9/f5d7573f9b3a720fe5898d88ae477cfc.png"> <br> <br>        <code>EnvelopeGenerator</code>  .         .        ! <br> <br>    <a href=""></a> . <br> <br>        :) <br> <br>  : <br> <a href="http://martin-finke.de/blog/articles/audio-plugins-013-filter/">martin-finke.de/blog/articles/audio-plugins-013-filter</a></code></code> <pre> <code class="hljs erlang-repl"><code class="cpp">#include  <i>Filter.h</i> ( )     : <br> <br> class Filter { public: enum FilterMode { FILTER_MODE_LOWPASS = <span class="hljs-number"><span class="hljs-number">0</span></span>, FILTER_MODE_HIGHPASS, FILTER_MODE_BANDPASS, kNumFilterModes }; Filter() : cutoff(<span class="hljs-number"><span class="hljs-number">0.99</span></span>), resonance(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), mode(FILTER_MODE_LOWPASS), buf0(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), buf1(<span class="hljs-number"><span class="hljs-number">0.0</span></span>) { calculateFeedbackAmount(); }; double process(double inputValue); inline void setCutoff(double newCutoff) { cutoff = newCutoff; calculateFeedbackAmount(); }; inline void setResonance(double newResonance) { resonance = newResonance; calculateFeedbackAmount(); }; inline void setFilterMode(FilterMode newMode) { mode = newMode; } private: double cutoff; double resonance; FilterMode mode; double feedbackAmount; inline void calculateFeedbackAmount() { feedbackAmount = resonance + resonance/(<span class="hljs-number"><span class="hljs-number">1.0</span></span> - cutoff); } double buf0; double buf1; };</code> <br> <br>  <code>private</code>     <i> </i> <code>cutoff</code>  <i></i> <code>resonance</code> . <code>Mode</code>      (Lowpass, Highpass, Bandpass).  <code>feedbackAmount</code> , <code>buf0</code>  <code>buf1</code>    ,    . <br>          ( <code>calculateFeedbackAmount()</code> ).  <code>process</code>      .   <code>feedbackAmount</code>   <code>cutoff</code>  <code>resonance</code> ,    <code>calculateFeedbackAmount</code>      . <br> <br>   <i>Filter.cpp</i>  : <br> <br> <code class="cpp">// By Paul Kellett // http://www.musicdsp.org/showone.php?id=<span class="hljs-number"><span class="hljs-number">29</span></span> double Filter::process(double inputValue) { buf0 += cutoff * (inputValue - buf0); buf1 += cutoff * (buf0 - buf1); switch (mode) { case FILTER_MODE_LOWPASS: return buf1; case FILTER_MODE_HIGHPASS: return inputValue - buf0; case FILTER_MODE_BANDPASS: return buf0 - buf1; default: return <span class="hljs-number"><span class="hljs-number">0.0</span></span>; } }</code> <br> <br> , ?  ,         <i> </i> . ¬´ ¬ª   ,               (. .    <span class="hljs-number"><span class="hljs-number">6</span></span> ).     <code>buf0</code>  <code>buf1</code> :        .     <code>inputValue</code> ,  - <code>buf0</code> (  ).   .    <span class="hljs-number"><span class="hljs-number">6</span></span> /   <span class="hljs-number"><span class="hljs-number">12</span></span> /.  <code>switch</code> ,  <code>buf1</code>    . , ,    <code>buf0</code> ,       <span class="hljs-number"><span class="hljs-number">12</span></span>,   <span class="hljs-number"><span class="hljs-number">6</span></span> /,        . <br> <br>  <code>case</code> <code>FILTER_MODE_HIGHPASS</code>    . <code>buf0</code>       .   <code>inputValue</code>  <code>buf0</code> ,   .    <code>buf1</code> ,     . <br> <br>  <code>case</code> <code>FILTER_MODE_BANDPASS</code> ,  <code>buf0 - buf1</code>   .  <code>buf0</code>       ,     <code>buf1</code> . ,   . <br>  :    <i> </i>    <i> </i> ,   . <br> <br>  <code>buf1</code>     .       <a href="http://ru.wikipedia.org/wiki/%25D0%25A4%25D0%25B8%25D0%25BB%25D1%258C%25D1%2582%25D1%2580_%25D1%2581_%25D0%25B1%25D0%25B5%25D1%2581%25D0%25BA%25D0%25BE%25D0%25BD%25D0%25B5%25D1%2587%25D0%25BD%25D0%25BE%25D0%25B9_%25D0%25B8%25D0%25BC%25D0%25BF%25D1%2583%25D0%25BB%25D1%258C%25D1%2581%25D0%25BD%25D0%25BE%25D0%25B9_%25D1%2585%25D0%25B0%25D1%2580%25D0%25B0%25D0%25BA%25D1%2582%25D0%25B5%25D1%2580%25D0%25B8%25D1%2581%25D1%2582%25D0%25B8%25D0%25BA%25D0%25BE%25D0%25B9">    </a> ( <i>Infinite Impulse Response</i> ,  <i>IIR</i> ).  <a href="http://www.dspguide.com/ch14/1.htm"> </a> ,      .      ,         ,      . <br> <br>   <br>       ,     ,     .   ,  ,      ,  ,          .           ,  NI Massive,   ¬´ <a href="http://lurkmore.to/%25D0%25A2%25D1%2591%25D0%25BF%25D0%25BB%25D1%258B%25D0%25B9_%25D0%25BB%25D0%25B0%25D0%25BC%25D0%25BF%25D0%25BE%25D0%25B2%25D1%258B%25D0%25B9_%25D0%25B7%25D0%25B2%25D1%2583%25D0%25BA">  </a> ¬ª.       ,          ,   .        ,          (  Massive       ).      ¬´¬ª , , , AAS Ultra Analog,       ,     ,    ,        .         ,  ,    <a href="http://www.kvraudio.com/forum/viewtopic.php%3Ft%3D350246"></a> ,   ,      NI Reaktor. ,            ‚Äî    ,    ..     . <br> <br>   <br>     .   GUI.  <i>bg.png</i>   ( <i>‚ÄúMove to trash‚Äù</i>  Xcode),       : <br> <br> <a href="">filtermode.png</a> <a href="">knob_small.png</a> (  ,   <span class="hljs-number"><span class="hljs-number">50</span></span> <span class="hljs-number"><span class="hljs-number">50</span></span> ) <a href="">bg.png</a> (       ) <br> <br>    ID  <i>resource.h</i> : <br> <br> <code class="cpp">// Unique IDs for each image resource. #define BG_ID <span class="hljs-number"><span class="hljs-number">101</span></span> #define WHITE_KEY_ID <span class="hljs-number"><span class="hljs-number">102</span></span> #define BLACK_KEY_ID <span class="hljs-number"><span class="hljs-number">103</span></span> #define WAVEFORM_ID <span class="hljs-number"><span class="hljs-number">104</span></span> #define KNOB_ID <span class="hljs-number"><span class="hljs-number">105</span></span> #define KNOB_SMALL_ID <span class="hljs-number"><span class="hljs-number">106</span></span> #define FILTERMODE_ID <span class="hljs-number"><span class="hljs-number">107</span></span> // Image resource locations for this plug. #define BG_FN <span class="hljs-string"><span class="hljs-string">"resources/img/bg.png"</span></span> #define WHITE_KEY_FN <span class="hljs-string"><span class="hljs-string">"resources/img/whitekey.png"</span></span> #define BLACK_KEY_FN <span class="hljs-string"><span class="hljs-string">"resources/img/blackkey.png"</span></span> #define WAVEFORM_FN <span class="hljs-string"><span class="hljs-string">"resources/img/waveform.png"</span></span> #define KNOB_FN <span class="hljs-string"><span class="hljs-string">"resources/img/knob.png"</span></span> #define KNOB_SMALL_FN <span class="hljs-string"><span class="hljs-string">"resources/img/knob_small.png"</span></span> #define FILTERMODE_FN <span class="hljs-string"><span class="hljs-string">"resources/img/filtermode.png"</span></span></code> <br> <br>  <i>Synthesis.rc</i> : <br> <br> <code class="cpp">#include <span class="hljs-string"><span class="hljs-string">"resource.h"</span></span> BG_ID PNG BG_FN WHITE_KEY_ID PNG WHITE_KEY_FN BLACK_KEY_ID PNG BLACK_KEY_FN WAVEFORM_ID PNG WAVEFORM_FN KNOB_ID PNG KNOB_FN KNOB_SMALL_ID PNG KNOB_SMALL_FN FILTERMODE_ID PNG FILTERMODE_FN</code> <br> <br>   <code>#include <span class="hljs-string"><span class="hljs-string">"Filter.h"</span></span></code>  <i>Synthesis.h</i>    <code>private</code> : <br> <br> <code class="cpp">Filter mFilter;</code> <br> <br>  <code>EParams</code>  <i>Synthesis.cpp</i> : <br> <br> <code class="cpp">enum EParams { mWaveform = <span class="hljs-number"><span class="hljs-number">0</span></span>, mAttack, mDecay, mSustain, mRelease, mFilterMode, mFilterCutoff, mFilterResonance, mFilterAttack, mFilterDecay, mFilterSustain, mFilterRelease, mFilterEnvelopeAmount, kNumParams };</code> <br> <br>        : <br> <br> <code class="cpp">pGraphics-&gt;AttachControl(new ISwitchControl(this, <span class="hljs-number"><span class="hljs-number">24</span></span>, <span class="hljs-number"><span class="hljs-number">38</span></span>, mWaveform, &amp;waveformBitmap));</code> <br> <br>      .      (Lowpass, Highpass, Bandpass).    <code>AttachGraphics(pGraphics)</code> : <br> <br> <code class="cpp">GetParam(mFilterMode)-&gt;InitEnum(<span class="hljs-string"><span class="hljs-string">"Filter Mode"</span></span>, Filter::FILTER_MODE_LOWPASS, Filter::kNumFilterModes); IBitmap filtermodeBitmap = pGraphics-&gt;LoadIBitmap(FILTERMODE_ID, FILTERMODE_FN, <span class="hljs-number"><span class="hljs-number">3</span></span>); pGraphics-&gt;AttachControl(new ISwitchControl(this, <span class="hljs-number"><span class="hljs-number">24</span></span>, <span class="hljs-number"><span class="hljs-number">123</span></span>, mFilterMode, &amp;filtermodeBitmap));</code> <br> <br>         .    .     <i>knob_small.png</i> : <br> <br> <code class="cpp">// Knobs for filter cutoff and resonance IBitmap smallKnobBitmap = pGraphics-&gt;LoadIBitmap(KNOB_SMALL_ID, KNOB_SMALL_FN, <span class="hljs-number"><span class="hljs-number">64</span></span>); // Cutoff knob: GetParam(mFilterCutoff)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Cutoff"</span></span>, <span class="hljs-number"><span class="hljs-number">0.99</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">0.99</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); GetParam(mFilterCutoff)-&gt;SetShape(<span class="hljs-number"><span class="hljs-number">2</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-number"><span class="hljs-number">177</span></span>, mFilterCutoff, &amp;smallKnobBitmap)); // Resonance knob: GetParam(mFilterResonance)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Resonance"</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">61</span></span>, <span class="hljs-number"><span class="hljs-number">177</span></span>, mFilterResonance, &amp;smallKnobBitmap));</code> <br> <br>   ,           <code><span class="hljs-number"><span class="hljs-number">1.0</span></span></code> ,   <code>calculateFeedbackAmount</code>    , . <br>  <code>ProcessDoubleReplacing</code>     : <br> <br> <code class="cpp">leftOutput[i] = rightOutput[i] = mFilter.process(mOscillator.nextSample() * mEnvelopeGenerator.nextSample() * velocity / <span class="hljs-number"><span class="hljs-number">127.0</span></span>);</code> <br> <br>       .  <code>switch</code>   <code>Synthesis::OnParamChange</code> : <br> <br> <code class="cpp">case mFilterCutoff: mFilter.setCutoff(GetParam(paramIdx)-&gt;Value()); break; case mFilterResonance: mFilter.setResonance(GetParam(paramIdx)-&gt;Value()); break; case mFilterMode: mFilter.setFilterMode(static_cast&lt;Filter::FilterMode&gt;(GetParam(paramIdx)-&gt;Int())); break;</code> <br> <br>    .  -      . <br> <br>  <br> <br>  ‚Äî      .   ,   ,          . <br>      : <br> <br> <code class="cpp">buf0 += cutoff * (inputValue - buf0 + feedbackAmount * (buf0 - buf1));</code> <br> <br> ,   ,      ( <code>buf0 ‚Äì buf1</code> ),   <code>feedbackAmount</code> .    <code>calculateFeedbackAmount</code>  <code>feedbackAmount</code>  <code>resonance</code> , . .    ,   . <br> <br>  ,            .     ,  <i></i> ,      <a href="https://www.youtube.com/watch%3Fv%3DJWyMj6KxGHM"> </a> .    ,        ,       . <br> <br>  -<span class="hljs-number"><span class="hljs-number">12</span></span> /  -<span class="hljs-number"><span class="hljs-number">24</span></span> / <br>        !     <span class="hljs-number"><span class="hljs-number">24</span></span>   .     <code>switch</code>  <code>Filter::process</code> : <br> <br> <code class="cpp">buf2 += cutoff * (buf1 - buf2); buf3 += cutoff * (buf2 ‚Äì buf3);</code> <br> <br>   :      ,       ,            .     ,       , , <a href="https://ccrma.stanford.edu/~Jos/filters/Filter_Stability.html"></a> (       ).     <code>switch</code> : <br> <br> <code class="cpp">switch (mode) { case FILTER_MODE_LOWPASS: return buf3; case FILTER_MODE_HIGHPASS: return inputValue - buf3; case FILTER_MODE_BANDPASS: return buf0 - buf3; default: return <span class="hljs-number"><span class="hljs-number">0.0</span></span>; }</code> <br> <br>   <code>buf1</code>  <code>buf3</code> ‚Äì      .    -<span class="hljs-number"><span class="hljs-number">24</span></span> /.     <code>buf2</code>  <code>buf3</code> ,        <code>private</code> <i>Filter.h</i> : <br> <br> <code class="cpp">double buf2; double buf3;</code> <br> <br>    ,   <code>buf0</code> c <code>buf1</code> : <br> <br> <code class="cpp">Filter() : // ... buf0(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), buf1(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), buf2(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), buf3(<span class="hljs-number"><span class="hljs-number">0.0</span></span>) // ...</code> <br> <br>     , ,     :     .       . <br>          ? <br> <br>   <br>    .  ,           ,       . <br> -      <code>cutoff</code>   .      .    <code>cutoffMod</code> ,    ,       <code>cutoff</code>    .     <code><code>#include    private</code> : <br> <br> <code class="cpp">double cutoffMod;</code> <br> <br> : <br> <br> <code class="cpp">Filter() : cutoff(<span class="hljs-number"><span class="hljs-number">0.99</span></span>), resonance(<span class="hljs-number"><span class="hljs-number">0.01</span></span>), cutoffMod(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), // ...</code> <br> <br>         .   <code>private</code> : <br> <br> <code class="cpp">inline double getCalculatedCutoff() const { return fmax(fmin(cutoff + cutoffMod, <span class="hljs-number"><span class="hljs-number">0.99</span></span>), <span class="hljs-number"><span class="hljs-number">0.01</span></span>); };</code> <br> <br> <code>calculateFeedbackAmount</code>     : <br> <br> <code class="cpp">inline void calculateFeedbackAmount() { feedbackAmount = resonance + resonance/(<span class="hljs-number"><span class="hljs-number">1.0</span></span> - getCalculatedCutoff()); }</code> <br> <br>       <code>cutoffMod</code> .   <code>feedbackAmount</code>    ,     : <br> <br> <code class="cpp">inline void setCutoffMod(double newCutoffMod) { cutoffMod = newCutoffMod; calculateFeedbackAmount(); }</code> <br> <br> ,       .   <code>Filter::process</code>   : <br> <br> <code class="cpp">if (inputValue == <span class="hljs-number"><span class="hljs-number">0.0</span></span>) return inputValue; double calculatedCutoff = getCalculatedCutoff(); buf0 += calculatedCutoff * (inputValue - buf0 + feedbackAmount * (buf0 - buf1)); buf1 += calculatedCutoff * (buf0 - buf1); buf2 += calculatedCutoff * (buf1 - buf2); buf3 += calculatedCutoff * (buf2 ‚Äì buf3);</code> <br> <br>        ,    .    ,      ,   .     .     <code>cutoff</code>  <code>calculatedCutoff</code>   -. <br> <br> ,       ( <code>setCutoffMod</code> ),   <code>Synthesis</code>    ,     ,    .    ,        <code>cutoffMod</code> .    <code>filterEnvelopeAmount</code>    <code>-<span class="hljs-number"><span class="hljs-number">1</span></span></code>  <code>+<span class="hljs-number"><span class="hljs-number">1</span></span></code> .   GUI. <br> <br>   <code>private</code> <i>Synthesis.h</i>    : <br> <br> <code class="cpp">EnvelopeGenerator mFilterEnvelopeGenerator; double filterEnvelopeAmount;</code> <br> <br>       MIDI ,      <code>onNoteOn</code>  <code>onNoteOff</code> : <br> <br> <code class="cpp">inline void onNoteOn(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); mFilterEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); }; inline void onNoteOff(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); mFilterEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); };</code> <br> <br>    .   <code>ProcessDoubleReplacing</code>        : <br> <br> <code class="cpp">mFilter.setCutoffMod(mFilterEnvelopeGenerator.nextSample() * filterEnvelopeAmount);</code> <br> <br>  ,        <code>nextSample</code>  <code>filterEnvelopeAmount</code>     <code>cutoffMod</code> .     <code>filterEnvelopeAmount</code>  : <br> <br> <code class="cpp">Synthesis::Synthesis(IPlugInstanceInfo instanceInfo) : IPLUG_CTOR(kNumParams, kNumPrograms, instanceInfo), lastVirtualKeyboardNoteNumber(virtualKeyboardMinimumNoteNumber - <span class="hljs-number"><span class="hljs-number">1</span></span>), filterEnvelopeAmount(<span class="hljs-number"><span class="hljs-number">0.0</span></span>) { // ... }</code> <br> <br>       <code>Synthesis::Reset</code> : <br> <br> <code class="cpp">mFilterEnvelopeGenerator.setSampleRate(GetSampleRate());</code> <br> <br>      <code>EParams</code> ,       .  <code>AttachGraphics</code>     : <br> <br> <code class="cpp">// Knobs for filter envelope // Attack knob GetParam(mFilterAttack)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Filter Env Attack"</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">10.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); GetParam(mFilterAttack)-&gt;SetShape(<span class="hljs-number"><span class="hljs-number">3</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">139</span></span>, <span class="hljs-number"><span class="hljs-number">178</span></span>, mFilterAttack, &amp;smallKnobBitmap)); // Decay knob: GetParam(mFilterDecay)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Filter Env Decay"</span></span>, <span class="hljs-number"><span class="hljs-number">0.5</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">15.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); GetParam(mFilterDecay)-&gt;SetShape(<span class="hljs-number"><span class="hljs-number">3</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">195</span></span>, <span class="hljs-number"><span class="hljs-number">178</span></span>, mFilterDecay, &amp;smallKnobBitmap)); // Sustain knob: GetParam(mFilterSustain)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Filter Env Sustain"</span></span>, <span class="hljs-number"><span class="hljs-number">0.1</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>, <span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); GetParam(mFilterSustain)-&gt;SetShape(<span class="hljs-number"><span class="hljs-number">2</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">251</span></span>, <span class="hljs-number"><span class="hljs-number">178</span></span>, mFilterSustain, &amp;smallKnobBitmap)); // Release knob: GetParam(mFilterRelease)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Filter Env Release"</span></span>, <span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>, <span class="hljs-number"><span class="hljs-number">15.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); GetParam(mFilterRelease)-&gt;SetShape(<span class="hljs-number"><span class="hljs-number">3</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">307</span></span>, <span class="hljs-number"><span class="hljs-number">178</span></span>, mFilterRelease, &amp;smallKnobBitmap)); // Filter envelope amount knob: GetParam(mFilterEnvelopeAmount)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Filter Env Amount"</span></span>, <span class="hljs-number"><span class="hljs-number">0.0</span></span>, -<span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">363</span></span>, <span class="hljs-number"><span class="hljs-number">178</span></span>, mFilterEnvelopeAmount, &amp;smallKnobBitmap));</code> <br> <br>     ,       <code>smallKnobBitmap</code> .                   .     ,    .  <code>Synthesis::OnParamChange</code>    <code>switch</code> : <br> <br> <code class="cpp">case mFilterAttack: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK, GetParam(paramIdx)-&gt;Value()); break; case mFilterDecay: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_DECAY, GetParam(paramIdx)-&gt;Value()); break; case mFilterSustain: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_SUSTAIN, GetParam(paramIdx)-&gt;Value()); break; case mFilterRelease: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE, GetParam(paramIdx)-&gt;Value()); break; case mFilterEnvelopeAmount: filterEnvelopeAmount = GetParam(paramIdx)-&gt;Value(); break;</code> <br> <br> ! <br>     !           (-   C1),   : <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/f5d/757/3f9/f5d7573f9b3a720fe5898d88ae477cfc.png"> <br> <br>        <code>EnvelopeGenerator</code>  .         .        ! <br> <br>    <a href=""></a> . <br> <br>        :) <br> <br>  : <br> <a href="http://martin-finke.de/blog/articles/audio-plugins-013-filter/">martin-finke.de/blog/articles/audio-plugins-<span class="hljs-number"><span class="hljs-number">013</span></span>-filter</a></code></code> </pre> <code><code><code class="cpp">#include  <i>Filter.h</i> ( )     : <br> <br> class Filter { public: enum FilterMode { FILTER_MODE_LOWPASS = 0, FILTER_MODE_HIGHPASS, FILTER_MODE_BANDPASS, kNumFilterModes }; Filter() : cutoff(0.99), resonance(0.0), mode(FILTER_MODE_LOWPASS), buf0(0.0), buf1(0.0) { calculateFeedbackAmount(); }; double process(double inputValue); inline void setCutoff(double newCutoff) { cutoff = newCutoff; calculateFeedbackAmount(); }; inline void setResonance(double newResonance) { resonance = newResonance; calculateFeedbackAmount(); }; inline void setFilterMode(FilterMode newMode) { mode = newMode; } private: double cutoff; double resonance; FilterMode mode; double feedbackAmount; inline void calculateFeedbackAmount() { feedbackAmount = resonance + resonance/(1.0 - cutoff); } double buf0; double buf1; };</code> <br> <br>  <code>private</code>     <i> </i> <code>cutoff</code>  <i></i> <code>resonance</code> . <code>Mode</code>      (Lowpass, Highpass, Bandpass).  <code>feedbackAmount</code> , <code>buf0</code>  <code>buf1</code>    ,    . <br>          ( <code>calculateFeedbackAmount()</code> ).  <code>process</code>      .   <code>feedbackAmount</code>   <code>cutoff</code>  <code>resonance</code> ,    <code>calculateFeedbackAmount</code>      . <br> <br>   <i>Filter.cpp</i>  : <br> <br> <code class="cpp">// By Paul Kellett // http://www.musicdsp.org/showone.php?id=29 double Filter::process(double inputValue) { buf0 += cutoff * (inputValue - buf0); buf1 += cutoff * (buf0 - buf1); switch (mode) { case FILTER_MODE_LOWPASS: return buf1; case FILTER_MODE_HIGHPASS: return inputValue - buf0; case FILTER_MODE_BANDPASS: return buf0 - buf1; default: return 0.0; } }</code> <br> <br> , ?  ,         <i> </i> . ¬´ ¬ª   ,               (. .    6 ).     <code>buf0</code>  <code>buf1</code> :        .     <code>inputValue</code> ,  - <code>buf0</code> (  ).   .    6 /   12 /.  <code>switch</code> ,  <code>buf1</code>    . , ,    <code>buf0</code> ,       12,   6 /,        . <br> <br>  <code>case</code> <code>FILTER_MODE_HIGHPASS</code>    . <code>buf0</code>       .   <code>inputValue</code>  <code>buf0</code> ,   .    <code>buf1</code> ,     . <br> <br>  <code>case</code> <code>FILTER_MODE_BANDPASS</code> ,  <code>buf0 - buf1</code>   .  <code>buf0</code>       ,     <code>buf1</code> . ,   . <br>  :    <i> </i>    <i> </i> ,   . <br> <br>  <code>buf1</code>     .       <a href="http://ru.wikipedia.org/wiki/%25D0%25A4%25D0%25B8%25D0%25BB%25D1%258C%25D1%2582%25D1%2580_%25D1%2581_%25D0%25B1%25D0%25B5%25D1%2581%25D0%25BA%25D0%25BE%25D0%25BD%25D0%25B5%25D1%2587%25D0%25BD%25D0%25BE%25D0%25B9_%25D0%25B8%25D0%25BC%25D0%25BF%25D1%2583%25D0%25BB%25D1%258C%25D1%2581%25D0%25BD%25D0%25BE%25D0%25B9_%25D1%2585%25D0%25B0%25D1%2580%25D0%25B0%25D0%25BA%25D1%2582%25D0%25B5%25D1%2580%25D0%25B8%25D1%2581%25D1%2582%25D0%25B8%25D0%25BA%25D0%25BE%25D0%25B9">    </a> ( <i>Infinite Impulse Response</i> ,  <i>IIR</i> ).  <a href="http://www.dspguide.com/ch14/1.htm"> </a> ,      .      ,         ,      . <br> <br>   <br>       ,     ,     .   ,  ,      ,  ,          .           ,  NI Massive,   ¬´ <a href="http://lurkmore.to/%25D0%25A2%25D1%2591%25D0%25BF%25D0%25BB%25D1%258B%25D0%25B9_%25D0%25BB%25D0%25B0%25D0%25BC%25D0%25BF%25D0%25BE%25D0%25B2%25D1%258B%25D0%25B9_%25D0%25B7%25D0%25B2%25D1%2583%25D0%25BA">  </a> ¬ª.       ,          ,   .        ,          (  Massive       ).      ¬´¬ª , , , AAS Ultra Analog,       ,     ,    ,        .         ,  ,    <a href="http://www.kvraudio.com/forum/viewtopic.php%3Ft%3D350246"></a> ,   ,      NI Reaktor. ,            ‚Äî    ,    ..     . <br> <br>   <br>     .   GUI.  <i>bg.png</i>   ( <i>‚ÄúMove to trash‚Äù</i>  Xcode),       : <br> <br> <a href="">filtermode.png</a> <a href="">knob_small.png</a> (  ,   50 50 ) <a href="">bg.png</a> (       ) <br> <br>    ID  <i>resource.h</i> : <br> <br> <code class="cpp">// Unique IDs for each image resource. #define BG_ID 101 #define WHITE_KEY_ID 102 #define BLACK_KEY_ID 103 #define WAVEFORM_ID 104 #define KNOB_ID 105 #define KNOB_SMALL_ID 106 #define FILTERMODE_ID 107 // Image resource locations for this plug. #define BG_FN "resources/img/bg.png" #define WHITE_KEY_FN "resources/img/whitekey.png" #define BLACK_KEY_FN "resources/img/blackkey.png" #define WAVEFORM_FN "resources/img/waveform.png" #define KNOB_FN "resources/img/knob.png" #define KNOB_SMALL_FN "resources/img/knob_small.png" #define FILTERMODE_FN "resources/img/filtermode.png"</code> <br> <br>  <i>Synthesis.rc</i> : <br> <br> <code class="cpp">#include "resource.h" BG_ID PNG BG_FN WHITE_KEY_ID PNG WHITE_KEY_FN BLACK_KEY_ID PNG BLACK_KEY_FN WAVEFORM_ID PNG WAVEFORM_FN KNOB_ID PNG KNOB_FN KNOB_SMALL_ID PNG KNOB_SMALL_FN FILTERMODE_ID PNG FILTERMODE_FN</code> <br> <br>   <code>#include "Filter.h"</code>  <i>Synthesis.h</i>    <code>private</code> : <br> <br> <code class="cpp">Filter mFilter;</code> <br> <br>  <code>EParams</code>  <i>Synthesis.cpp</i> : <br> <br> <code class="cpp">enum EParams { mWaveform = 0, mAttack, mDecay, mSustain, mRelease, mFilterMode, mFilterCutoff, mFilterResonance, mFilterAttack, mFilterDecay, mFilterSustain, mFilterRelease, mFilterEnvelopeAmount, kNumParams };</code> <br> <br>        : <br> <br> <code class="cpp">pGraphics-&gt;AttachControl(new ISwitchControl(this, 24, 38, mWaveform, &amp;waveformBitmap));</code> <br> <br>      .      (Lowpass, Highpass, Bandpass).    <code>AttachGraphics(pGraphics)</code> : <br> <br> <code class="cpp">GetParam(mFilterMode)-&gt;InitEnum("Filter Mode", Filter::FILTER_MODE_LOWPASS, Filter::kNumFilterModes); IBitmap filtermodeBitmap = pGraphics-&gt;LoadIBitmap(FILTERMODE_ID, FILTERMODE_FN, 3); pGraphics-&gt;AttachControl(new ISwitchControl(this, 24, 123, mFilterMode, &amp;filtermodeBitmap));</code> <br> <br>         .    .     <i>knob_small.png</i> : <br> <br> <code class="cpp">// Knobs for filter cutoff and resonance IBitmap smallKnobBitmap = pGraphics-&gt;LoadIBitmap(KNOB_SMALL_ID, KNOB_SMALL_FN, 64); // Cutoff knob: GetParam(mFilterCutoff)-&gt;InitDouble("Cutoff", 0.99, 0.01, 0.99, 0.001); GetParam(mFilterCutoff)-&gt;SetShape(2); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 5, 177, mFilterCutoff, &amp;smallKnobBitmap)); // Resonance knob: GetParam(mFilterResonance)-&gt;InitDouble("Resonance", 0.01, 0.01, 1.0, 0.001); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 61, 177, mFilterResonance, &amp;smallKnobBitmap));</code> <br> <br>   ,           <code>1.0</code> ,   <code>calculateFeedbackAmount</code>    , . <br>  <code>ProcessDoubleReplacing</code>     : <br> <br> <code class="cpp">leftOutput[i] = rightOutput[i] = mFilter.process(mOscillator.nextSample() * mEnvelopeGenerator.nextSample() * velocity / 127.0);</code> <br> <br>       .  <code>switch</code>   <code>Synthesis::OnParamChange</code> : <br> <br> <code class="cpp">case mFilterCutoff: mFilter.setCutoff(GetParam(paramIdx)-&gt;Value()); break; case mFilterResonance: mFilter.setResonance(GetParam(paramIdx)-&gt;Value()); break; case mFilterMode: mFilter.setFilterMode(static_cast&lt;Filter::FilterMode&gt;(GetParam(paramIdx)-&gt;Int())); break;</code> <br> <br>    .  -      . <br> <br>  <br> <br>  ‚Äî      .   ,   ,          . <br>      : <br> <br> <code class="cpp">buf0 += cutoff * (inputValue - buf0 + feedbackAmount * (buf0 - buf1));</code> <br> <br> ,   ,      ( <code>buf0 ‚Äì buf1</code> ),   <code>feedbackAmount</code> .    <code>calculateFeedbackAmount</code>  <code>feedbackAmount</code>  <code>resonance</code> , . .    ,   . <br> <br>  ,            .     ,  <i></i> ,      <a href="https://www.youtube.com/watch%3Fv%3DJWyMj6KxGHM"> </a> .    ,        ,       . <br> <br>  -12 /  -24 / <br>        !     24   .     <code>switch</code>  <code>Filter::process</code> : <br> <br> <code class="cpp">buf2 += cutoff * (buf1 - buf2); buf3 += cutoff * (buf2 ‚Äì buf3);</code> <br> <br>   :      ,       ,            .     ,       , , <a href="https://ccrma.stanford.edu/~Jos/filters/Filter_Stability.html"></a> (       ).     <code>switch</code> : <br> <br> <code class="cpp">switch (mode) { case FILTER_MODE_LOWPASS: return buf3; case FILTER_MODE_HIGHPASS: return inputValue - buf3; case FILTER_MODE_BANDPASS: return buf0 - buf3; default: return 0.0; }</code> <br> <br>   <code>buf1</code>  <code>buf3</code> ‚Äì      .    -24 /.     <code>buf2</code>  <code>buf3</code> ,        <code>private</code> <i>Filter.h</i> : <br> <br> <code class="cpp">double buf2; double buf3;</code> <br> <br>    ,   <code>buf0</code> c <code>buf1</code> : <br> <br> <code class="cpp">Filter() : // ... buf0(0.0), buf1(0.0), buf2(0.0), buf3(0.0) // ...</code> <br> <br>     , ,     :     .       . <br>          ? <br> <br>   <br>    .  ,           ,       . <br> -      <code>cutoff</code>   .      .    <code>cutoffMod</code> ,    ,       <code>cutoff</code>    .     <code>#include    private</code> : <br> <br> <code class="cpp">double cutoffMod;</code> <br> <br> : <br> <br> <code class="cpp">Filter() : cutoff(0.99), resonance(0.01), cutoffMod(0.0), // ...</code> <br> <br>         .   <code>private</code> : <br> <br> <code class="cpp">inline double getCalculatedCutoff() const { return fmax(fmin(cutoff + cutoffMod, 0.99), 0.01); };</code> <br> <br> <code>calculateFeedbackAmount</code>     : <br> <br> <code class="cpp">inline void calculateFeedbackAmount() { feedbackAmount = resonance + resonance/(1.0 - getCalculatedCutoff()); }</code> <br> <br>       <code>cutoffMod</code> .   <code>feedbackAmount</code>    ,     : <br> <br> <code class="cpp">inline void setCutoffMod(double newCutoffMod) { cutoffMod = newCutoffMod; calculateFeedbackAmount(); }</code> <br> <br> ,       .   <code>Filter::process</code>   : <br> <br> <code class="cpp">if (inputValue == 0.0) return inputValue; double calculatedCutoff = getCalculatedCutoff(); buf0 += calculatedCutoff * (inputValue - buf0 + feedbackAmount * (buf0 - buf1)); buf1 += calculatedCutoff * (buf0 - buf1); buf2 += calculatedCutoff * (buf1 - buf2); buf3 += calculatedCutoff * (buf2 ‚Äì buf3);</code> <br> <br>        ,    .    ,      ,   .     .     <code>cutoff</code>  <code>calculatedCutoff</code>   -. <br> <br> ,       ( <code>setCutoffMod</code> ),   <code>Synthesis</code>    ,     ,    .    ,        <code>cutoffMod</code> .    <code>filterEnvelopeAmount</code>    <code>-1</code>  <code>+1</code> .   GUI. <br> <br>   <code>private</code> <i>Synthesis.h</i>    : <br> <br> <code class="cpp">EnvelopeGenerator mFilterEnvelopeGenerator; double filterEnvelopeAmount;</code> <br> <br>       MIDI ,      <code>onNoteOn</code>  <code>onNoteOff</code> : <br> <br> <code class="cpp">inline void onNoteOn(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); mFilterEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); }; inline void onNoteOff(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); mFilterEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); };</code> <br> <br>    .   <code>ProcessDoubleReplacing</code>        : <br> <br> <code class="cpp">mFilter.setCutoffMod(mFilterEnvelopeGenerator.nextSample() * filterEnvelopeAmount);</code> <br> <br>  ,        <code>nextSample</code>  <code>filterEnvelopeAmount</code>     <code>cutoffMod</code> .     <code>filterEnvelopeAmount</code>  : <br> <br> <code class="cpp">Synthesis::Synthesis(IPlugInstanceInfo instanceInfo) : IPLUG_CTOR(kNumParams, kNumPrograms, instanceInfo), lastVirtualKeyboardNoteNumber(virtualKeyboardMinimumNoteNumber - 1), filterEnvelopeAmount(0.0) { // ... }</code> <br> <br>       <code>Synthesis::Reset</code> : <br> <br> <code class="cpp">mFilterEnvelopeGenerator.setSampleRate(GetSampleRate());</code> <br> <br>      <code>EParams</code> ,       .  <code>AttachGraphics</code>     : <br> <br> <code class="cpp">// Knobs for filter envelope // Attack knob GetParam(mFilterAttack)-&gt;InitDouble("Filter Env Attack", 0.01, 0.01, 10.0, 0.001); GetParam(mFilterAttack)-&gt;SetShape(3); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 139, 178, mFilterAttack, &amp;smallKnobBitmap)); // Decay knob: GetParam(mFilterDecay)-&gt;InitDouble("Filter Env Decay", 0.5, 0.01, 15.0, 0.001); GetParam(mFilterDecay)-&gt;SetShape(3); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 195, 178, mFilterDecay, &amp;smallKnobBitmap)); // Sustain knob: GetParam(mFilterSustain)-&gt;InitDouble("Filter Env Sustain", 0.1, 0.001, 1.0, 0.001); GetParam(mFilterSustain)-&gt;SetShape(2); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 251, 178, mFilterSustain, &amp;smallKnobBitmap)); // Release knob: GetParam(mFilterRelease)-&gt;InitDouble("Filter Env Release", 1.0, 0.001, 15.0, 0.001); GetParam(mFilterRelease)-&gt;SetShape(3); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 307, 178, mFilterRelease, &amp;smallKnobBitmap)); // Filter envelope amount knob: GetParam(mFilterEnvelopeAmount)-&gt;InitDouble("Filter Env Amount", 0.0, -1.0, 1.0, 0.001); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 363, 178, mFilterEnvelopeAmount, &amp;smallKnobBitmap));</code> <br> <br>     ,       <code>smallKnobBitmap</code> .                   .     ,    .  <code>Synthesis::OnParamChange</code>    <code>switch</code> : <br> <br> <code class="cpp">case mFilterAttack: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK, GetParam(paramIdx)-&gt;Value()); break; case mFilterDecay: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_DECAY, GetParam(paramIdx)-&gt;Value()); break; case mFilterSustain: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_SUSTAIN, GetParam(paramIdx)-&gt;Value()); break; case mFilterRelease: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE, GetParam(paramIdx)-&gt;Value()); break; case mFilterEnvelopeAmount: filterEnvelopeAmount = GetParam(paramIdx)-&gt;Value(); break;</code> <br> <br> ! <br>     !           (-   C1),   : <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/f5d/757/3f9/f5d7573f9b3a720fe5898d88ae477cfc.png"> <br> <br>        <code>EnvelopeGenerator</code>  .         .        ! <br> <br>    <a href=""></a> . <br> <br>        :) <br> <br>  : <br> <a href="http://martin-finke.de/blog/articles/audio-plugins-013-filter/">martin-finke.de/blog/articles/audio-plugins-013-filter</a></code></code> <pre> <code class="hljs erlang-repl"><code class="cpp">#include  <i>Filter.h</i> ( )     : <br> <br> class Filter { public: enum FilterMode { FILTER_MODE_LOWPASS = <span class="hljs-number"><span class="hljs-number">0</span></span>, FILTER_MODE_HIGHPASS, FILTER_MODE_BANDPASS, kNumFilterModes }; Filter() : cutoff(<span class="hljs-number"><span class="hljs-number">0.99</span></span>), resonance(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), mode(FILTER_MODE_LOWPASS), buf0(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), buf1(<span class="hljs-number"><span class="hljs-number">0.0</span></span>) { calculateFeedbackAmount(); }; double process(double inputValue); inline void setCutoff(double newCutoff) { cutoff = newCutoff; calculateFeedbackAmount(); }; inline void setResonance(double newResonance) { resonance = newResonance; calculateFeedbackAmount(); }; inline void setFilterMode(FilterMode newMode) { mode = newMode; } private: double cutoff; double resonance; FilterMode mode; double feedbackAmount; inline void calculateFeedbackAmount() { feedbackAmount = resonance + resonance/(<span class="hljs-number"><span class="hljs-number">1.0</span></span> - cutoff); } double buf0; double buf1; };</code> <br> <br>  <code>private</code>     <i> </i> <code>cutoff</code>  <i></i> <code>resonance</code> . <code>Mode</code>      (Lowpass, Highpass, Bandpass).  <code>feedbackAmount</code> , <code>buf0</code>  <code>buf1</code>    ,    . <br>          ( <code>calculateFeedbackAmount()</code> ).  <code>process</code>      .   <code>feedbackAmount</code>   <code>cutoff</code>  <code>resonance</code> ,    <code>calculateFeedbackAmount</code>      . <br> <br>   <i>Filter.cpp</i>  : <br> <br> <code class="cpp">// By Paul Kellett // http://www.musicdsp.org/showone.php?id=<span class="hljs-number"><span class="hljs-number">29</span></span> double Filter::process(double inputValue) { buf0 += cutoff * (inputValue - buf0); buf1 += cutoff * (buf0 - buf1); switch (mode) { case FILTER_MODE_LOWPASS: return buf1; case FILTER_MODE_HIGHPASS: return inputValue - buf0; case FILTER_MODE_BANDPASS: return buf0 - buf1; default: return <span class="hljs-number"><span class="hljs-number">0.0</span></span>; } }</code> <br> <br> , ?  ,         <i> </i> . ¬´ ¬ª   ,               (. .    <span class="hljs-number"><span class="hljs-number">6</span></span> ).     <code>buf0</code>  <code>buf1</code> :        .     <code>inputValue</code> ,  - <code>buf0</code> (  ).   .    <span class="hljs-number"><span class="hljs-number">6</span></span> /   <span class="hljs-number"><span class="hljs-number">12</span></span> /.  <code>switch</code> ,  <code>buf1</code>    . , ,    <code>buf0</code> ,       <span class="hljs-number"><span class="hljs-number">12</span></span>,   <span class="hljs-number"><span class="hljs-number">6</span></span> /,        . <br> <br>  <code>case</code> <code>FILTER_MODE_HIGHPASS</code>    . <code>buf0</code>       .   <code>inputValue</code>  <code>buf0</code> ,   .    <code>buf1</code> ,     . <br> <br>  <code>case</code> <code>FILTER_MODE_BANDPASS</code> ,  <code>buf0 - buf1</code>   .  <code>buf0</code>       ,     <code>buf1</code> . ,   . <br>  :    <i> </i>    <i> </i> ,   . <br> <br>  <code>buf1</code>     .       <a href="http://ru.wikipedia.org/wiki/%25D0%25A4%25D0%25B8%25D0%25BB%25D1%258C%25D1%2582%25D1%2580_%25D1%2581_%25D0%25B1%25D0%25B5%25D1%2581%25D0%25BA%25D0%25BE%25D0%25BD%25D0%25B5%25D1%2587%25D0%25BD%25D0%25BE%25D0%25B9_%25D0%25B8%25D0%25BC%25D0%25BF%25D1%2583%25D0%25BB%25D1%258C%25D1%2581%25D0%25BD%25D0%25BE%25D0%25B9_%25D1%2585%25D0%25B0%25D1%2580%25D0%25B0%25D0%25BA%25D1%2582%25D0%25B5%25D1%2580%25D0%25B8%25D1%2581%25D1%2582%25D0%25B8%25D0%25BA%25D0%25BE%25D0%25B9">    </a> ( <i>Infinite Impulse Response</i> ,  <i>IIR</i> ).  <a href="http://www.dspguide.com/ch14/1.htm"> </a> ,      .      ,         ,      . <br> <br>   <br>       ,     ,     .   ,  ,      ,  ,          .           ,  NI Massive,   ¬´ <a href="http://lurkmore.to/%25D0%25A2%25D1%2591%25D0%25BF%25D0%25BB%25D1%258B%25D0%25B9_%25D0%25BB%25D0%25B0%25D0%25BC%25D0%25BF%25D0%25BE%25D0%25B2%25D1%258B%25D0%25B9_%25D0%25B7%25D0%25B2%25D1%2583%25D0%25BA">  </a> ¬ª.       ,          ,   .        ,          (  Massive       ).      ¬´¬ª , , , AAS Ultra Analog,       ,     ,    ,        .         ,  ,    <a href="http://www.kvraudio.com/forum/viewtopic.php%3Ft%3D350246"></a> ,   ,      NI Reaktor. ,            ‚Äî    ,    ..     . <br> <br>   <br>     .   GUI.  <i>bg.png</i>   ( <i>‚ÄúMove to trash‚Äù</i>  Xcode),       : <br> <br> <a href="">filtermode.png</a> <a href="">knob_small.png</a> (  ,   <span class="hljs-number"><span class="hljs-number">50</span></span> <span class="hljs-number"><span class="hljs-number">50</span></span> ) <a href="">bg.png</a> (       ) <br> <br>    ID  <i>resource.h</i> : <br> <br> <code class="cpp">// Unique IDs for each image resource. #define BG_ID <span class="hljs-number"><span class="hljs-number">101</span></span> #define WHITE_KEY_ID <span class="hljs-number"><span class="hljs-number">102</span></span> #define BLACK_KEY_ID <span class="hljs-number"><span class="hljs-number">103</span></span> #define WAVEFORM_ID <span class="hljs-number"><span class="hljs-number">104</span></span> #define KNOB_ID <span class="hljs-number"><span class="hljs-number">105</span></span> #define KNOB_SMALL_ID <span class="hljs-number"><span class="hljs-number">106</span></span> #define FILTERMODE_ID <span class="hljs-number"><span class="hljs-number">107</span></span> // Image resource locations for this plug. #define BG_FN <span class="hljs-string"><span class="hljs-string">"resources/img/bg.png"</span></span> #define WHITE_KEY_FN <span class="hljs-string"><span class="hljs-string">"resources/img/whitekey.png"</span></span> #define BLACK_KEY_FN <span class="hljs-string"><span class="hljs-string">"resources/img/blackkey.png"</span></span> #define WAVEFORM_FN <span class="hljs-string"><span class="hljs-string">"resources/img/waveform.png"</span></span> #define KNOB_FN <span class="hljs-string"><span class="hljs-string">"resources/img/knob.png"</span></span> #define KNOB_SMALL_FN <span class="hljs-string"><span class="hljs-string">"resources/img/knob_small.png"</span></span> #define FILTERMODE_FN <span class="hljs-string"><span class="hljs-string">"resources/img/filtermode.png"</span></span></code> <br> <br>  <i>Synthesis.rc</i> : <br> <br> <code class="cpp">#include <span class="hljs-string"><span class="hljs-string">"resource.h"</span></span> BG_ID PNG BG_FN WHITE_KEY_ID PNG WHITE_KEY_FN BLACK_KEY_ID PNG BLACK_KEY_FN WAVEFORM_ID PNG WAVEFORM_FN KNOB_ID PNG KNOB_FN KNOB_SMALL_ID PNG KNOB_SMALL_FN FILTERMODE_ID PNG FILTERMODE_FN</code> <br> <br>   <code>#include <span class="hljs-string"><span class="hljs-string">"Filter.h"</span></span></code>  <i>Synthesis.h</i>    <code>private</code> : <br> <br> <code class="cpp">Filter mFilter;</code> <br> <br>  <code>EParams</code>  <i>Synthesis.cpp</i> : <br> <br> <code class="cpp">enum EParams { mWaveform = <span class="hljs-number"><span class="hljs-number">0</span></span>, mAttack, mDecay, mSustain, mRelease, mFilterMode, mFilterCutoff, mFilterResonance, mFilterAttack, mFilterDecay, mFilterSustain, mFilterRelease, mFilterEnvelopeAmount, kNumParams };</code> <br> <br>        : <br> <br> <code class="cpp">pGraphics-&gt;AttachControl(new ISwitchControl(this, <span class="hljs-number"><span class="hljs-number">24</span></span>, <span class="hljs-number"><span class="hljs-number">38</span></span>, mWaveform, &amp;waveformBitmap));</code> <br> <br>      .      (Lowpass, Highpass, Bandpass).    <code>AttachGraphics(pGraphics)</code> : <br> <br> <code class="cpp">GetParam(mFilterMode)-&gt;InitEnum(<span class="hljs-string"><span class="hljs-string">"Filter Mode"</span></span>, Filter::FILTER_MODE_LOWPASS, Filter::kNumFilterModes); IBitmap filtermodeBitmap = pGraphics-&gt;LoadIBitmap(FILTERMODE_ID, FILTERMODE_FN, <span class="hljs-number"><span class="hljs-number">3</span></span>); pGraphics-&gt;AttachControl(new ISwitchControl(this, <span class="hljs-number"><span class="hljs-number">24</span></span>, <span class="hljs-number"><span class="hljs-number">123</span></span>, mFilterMode, &amp;filtermodeBitmap));</code> <br> <br>         .    .     <i>knob_small.png</i> : <br> <br> <code class="cpp">// Knobs for filter cutoff and resonance IBitmap smallKnobBitmap = pGraphics-&gt;LoadIBitmap(KNOB_SMALL_ID, KNOB_SMALL_FN, <span class="hljs-number"><span class="hljs-number">64</span></span>); // Cutoff knob: GetParam(mFilterCutoff)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Cutoff"</span></span>, <span class="hljs-number"><span class="hljs-number">0.99</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">0.99</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); GetParam(mFilterCutoff)-&gt;SetShape(<span class="hljs-number"><span class="hljs-number">2</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-number"><span class="hljs-number">177</span></span>, mFilterCutoff, &amp;smallKnobBitmap)); // Resonance knob: GetParam(mFilterResonance)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Resonance"</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">61</span></span>, <span class="hljs-number"><span class="hljs-number">177</span></span>, mFilterResonance, &amp;smallKnobBitmap));</code> <br> <br>   ,           <code><span class="hljs-number"><span class="hljs-number">1.0</span></span></code> ,   <code>calculateFeedbackAmount</code>    , . <br>  <code>ProcessDoubleReplacing</code>     : <br> <br> <code class="cpp">leftOutput[i] = rightOutput[i] = mFilter.process(mOscillator.nextSample() * mEnvelopeGenerator.nextSample() * velocity / <span class="hljs-number"><span class="hljs-number">127.0</span></span>);</code> <br> <br>       .  <code>switch</code>   <code>Synthesis::OnParamChange</code> : <br> <br> <code class="cpp">case mFilterCutoff: mFilter.setCutoff(GetParam(paramIdx)-&gt;Value()); break; case mFilterResonance: mFilter.setResonance(GetParam(paramIdx)-&gt;Value()); break; case mFilterMode: mFilter.setFilterMode(static_cast&lt;Filter::FilterMode&gt;(GetParam(paramIdx)-&gt;Int())); break;</code> <br> <br>    .  -      . <br> <br>  <br> <br>  ‚Äî      .   ,   ,          . <br>      : <br> <br> <code class="cpp">buf0 += cutoff * (inputValue - buf0 + feedbackAmount * (buf0 - buf1));</code> <br> <br> ,   ,      ( <code>buf0 ‚Äì buf1</code> ),   <code>feedbackAmount</code> .    <code>calculateFeedbackAmount</code>  <code>feedbackAmount</code>  <code>resonance</code> , . .    ,   . <br> <br>  ,            .     ,  <i></i> ,      <a href="https://www.youtube.com/watch%3Fv%3DJWyMj6KxGHM"> </a> .    ,        ,       . <br> <br>  -<span class="hljs-number"><span class="hljs-number">12</span></span> /  -<span class="hljs-number"><span class="hljs-number">24</span></span> / <br>        !     <span class="hljs-number"><span class="hljs-number">24</span></span>   .     <code>switch</code>  <code>Filter::process</code> : <br> <br> <code class="cpp">buf2 += cutoff * (buf1 - buf2); buf3 += cutoff * (buf2 ‚Äì buf3);</code> <br> <br>   :      ,       ,            .     ,       , , <a href="https://ccrma.stanford.edu/~Jos/filters/Filter_Stability.html"></a> (       ).     <code>switch</code> : <br> <br> <code class="cpp">switch (mode) { case FILTER_MODE_LOWPASS: return buf3; case FILTER_MODE_HIGHPASS: return inputValue - buf3; case FILTER_MODE_BANDPASS: return buf0 - buf3; default: return <span class="hljs-number"><span class="hljs-number">0.0</span></span>; }</code> <br> <br>   <code>buf1</code>  <code>buf3</code> ‚Äì      .    -<span class="hljs-number"><span class="hljs-number">24</span></span> /.     <code>buf2</code>  <code>buf3</code> ,        <code>private</code> <i>Filter.h</i> : <br> <br> <code class="cpp">double buf2; double buf3;</code> <br> <br>    ,   <code>buf0</code> c <code>buf1</code> : <br> <br> <code class="cpp">Filter() : // ... buf0(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), buf1(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), buf2(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), buf3(<span class="hljs-number"><span class="hljs-number">0.0</span></span>) // ...</code> <br> <br>     , ,     :     .       . <br>          ? <br> <br>   <br>    .  ,           ,       . <br> -      <code>cutoff</code>   .      .    <code>cutoffMod</code> ,    ,       <code>cutoff</code>    .     <code><code>#include    private</code> : <br> <br> <code class="cpp">double cutoffMod;</code> <br> <br> : <br> <br> <code class="cpp">Filter() : cutoff(<span class="hljs-number"><span class="hljs-number">0.99</span></span>), resonance(<span class="hljs-number"><span class="hljs-number">0.01</span></span>), cutoffMod(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), // ...</code> <br> <br>         .   <code>private</code> : <br> <br> <code class="cpp">inline double getCalculatedCutoff() const { return fmax(fmin(cutoff + cutoffMod, <span class="hljs-number"><span class="hljs-number">0.99</span></span>), <span class="hljs-number"><span class="hljs-number">0.01</span></span>); };</code> <br> <br> <code>calculateFeedbackAmount</code>     : <br> <br> <code class="cpp">inline void calculateFeedbackAmount() { feedbackAmount = resonance + resonance/(<span class="hljs-number"><span class="hljs-number">1.0</span></span> - getCalculatedCutoff()); }</code> <br> <br>       <code>cutoffMod</code> .   <code>feedbackAmount</code>    ,     : <br> <br> <code class="cpp">inline void setCutoffMod(double newCutoffMod) { cutoffMod = newCutoffMod; calculateFeedbackAmount(); }</code> <br> <br> ,       .   <code>Filter::process</code>   : <br> <br> <code class="cpp">if (inputValue == <span class="hljs-number"><span class="hljs-number">0.0</span></span>) return inputValue; double calculatedCutoff = getCalculatedCutoff(); buf0 += calculatedCutoff * (inputValue - buf0 + feedbackAmount * (buf0 - buf1)); buf1 += calculatedCutoff * (buf0 - buf1); buf2 += calculatedCutoff * (buf1 - buf2); buf3 += calculatedCutoff * (buf2 ‚Äì buf3);</code> <br> <br>        ,    .    ,      ,   .     .     <code>cutoff</code>  <code>calculatedCutoff</code>   -. <br> <br> ,       ( <code>setCutoffMod</code> ),   <code>Synthesis</code>    ,     ,    .    ,        <code>cutoffMod</code> .    <code>filterEnvelopeAmount</code>    <code>-<span class="hljs-number"><span class="hljs-number">1</span></span></code>  <code>+<span class="hljs-number"><span class="hljs-number">1</span></span></code> .   GUI. <br> <br>   <code>private</code> <i>Synthesis.h</i>    : <br> <br> <code class="cpp">EnvelopeGenerator mFilterEnvelopeGenerator; double filterEnvelopeAmount;</code> <br> <br>       MIDI ,      <code>onNoteOn</code>  <code>onNoteOff</code> : <br> <br> <code class="cpp">inline void onNoteOn(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); mFilterEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); }; inline void onNoteOff(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); mFilterEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); };</code> <br> <br>    .   <code>ProcessDoubleReplacing</code>        : <br> <br> <code class="cpp">mFilter.setCutoffMod(mFilterEnvelopeGenerator.nextSample() * filterEnvelopeAmount);</code> <br> <br>  ,        <code>nextSample</code>  <code>filterEnvelopeAmount</code>     <code>cutoffMod</code> .     <code>filterEnvelopeAmount</code>  : <br> <br> <code class="cpp">Synthesis::Synthesis(IPlugInstanceInfo instanceInfo) : IPLUG_CTOR(kNumParams, kNumPrograms, instanceInfo), lastVirtualKeyboardNoteNumber(virtualKeyboardMinimumNoteNumber - <span class="hljs-number"><span class="hljs-number">1</span></span>), filterEnvelopeAmount(<span class="hljs-number"><span class="hljs-number">0.0</span></span>) { // ... }</code> <br> <br>       <code>Synthesis::Reset</code> : <br> <br> <code class="cpp">mFilterEnvelopeGenerator.setSampleRate(GetSampleRate());</code> <br> <br>      <code>EParams</code> ,       .  <code>AttachGraphics</code>     : <br> <br> <code class="cpp">// Knobs for filter envelope // Attack knob GetParam(mFilterAttack)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Filter Env Attack"</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">10.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); GetParam(mFilterAttack)-&gt;SetShape(<span class="hljs-number"><span class="hljs-number">3</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">139</span></span>, <span class="hljs-number"><span class="hljs-number">178</span></span>, mFilterAttack, &amp;smallKnobBitmap)); // Decay knob: GetParam(mFilterDecay)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Filter Env Decay"</span></span>, <span class="hljs-number"><span class="hljs-number">0.5</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">15.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); GetParam(mFilterDecay)-&gt;SetShape(<span class="hljs-number"><span class="hljs-number">3</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">195</span></span>, <span class="hljs-number"><span class="hljs-number">178</span></span>, mFilterDecay, &amp;smallKnobBitmap)); // Sustain knob: GetParam(mFilterSustain)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Filter Env Sustain"</span></span>, <span class="hljs-number"><span class="hljs-number">0.1</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>, <span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); GetParam(mFilterSustain)-&gt;SetShape(<span class="hljs-number"><span class="hljs-number">2</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">251</span></span>, <span class="hljs-number"><span class="hljs-number">178</span></span>, mFilterSustain, &amp;smallKnobBitmap)); // Release knob: GetParam(mFilterRelease)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Filter Env Release"</span></span>, <span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>, <span class="hljs-number"><span class="hljs-number">15.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); GetParam(mFilterRelease)-&gt;SetShape(<span class="hljs-number"><span class="hljs-number">3</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">307</span></span>, <span class="hljs-number"><span class="hljs-number">178</span></span>, mFilterRelease, &amp;smallKnobBitmap)); // Filter envelope amount knob: GetParam(mFilterEnvelopeAmount)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Filter Env Amount"</span></span>, <span class="hljs-number"><span class="hljs-number">0.0</span></span>, -<span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">363</span></span>, <span class="hljs-number"><span class="hljs-number">178</span></span>, mFilterEnvelopeAmount, &amp;smallKnobBitmap));</code> <br> <br>     ,       <code>smallKnobBitmap</code> .                   .     ,    .  <code>Synthesis::OnParamChange</code>    <code>switch</code> : <br> <br> <code class="cpp">case mFilterAttack: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK, GetParam(paramIdx)-&gt;Value()); break; case mFilterDecay: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_DECAY, GetParam(paramIdx)-&gt;Value()); break; case mFilterSustain: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_SUSTAIN, GetParam(paramIdx)-&gt;Value()); break; case mFilterRelease: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE, GetParam(paramIdx)-&gt;Value()); break; case mFilterEnvelopeAmount: filterEnvelopeAmount = GetParam(paramIdx)-&gt;Value(); break;</code> <br> <br> ! <br>     !           (-   C1),   : <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/f5d/757/3f9/f5d7573f9b3a720fe5898d88ae477cfc.png"> <br> <br>        <code>EnvelopeGenerator</code>  .         .        ! <br> <br>    <a href=""></a> . <br> <br>        :) <br> <br>  : <br> <a href="http://martin-finke.de/blog/articles/audio-plugins-013-filter/">martin-finke.de/blog/articles/audio-plugins-<span class="hljs-number"><span class="hljs-number">013</span></span>-filter</a></code></code> </pre> <code><code><code class="cpp">#include  <i>Filter.h</i> ( )     : <br> <br> class Filter { public: enum FilterMode { FILTER_MODE_LOWPASS = 0, FILTER_MODE_HIGHPASS, FILTER_MODE_BANDPASS, kNumFilterModes }; Filter() : cutoff(0.99), resonance(0.0), mode(FILTER_MODE_LOWPASS), buf0(0.0), buf1(0.0) { calculateFeedbackAmount(); }; double process(double inputValue); inline void setCutoff(double newCutoff) { cutoff = newCutoff; calculateFeedbackAmount(); }; inline void setResonance(double newResonance) { resonance = newResonance; calculateFeedbackAmount(); }; inline void setFilterMode(FilterMode newMode) { mode = newMode; } private: double cutoff; double resonance; FilterMode mode; double feedbackAmount; inline void calculateFeedbackAmount() { feedbackAmount = resonance + resonance/(1.0 - cutoff); } double buf0; double buf1; };</code> <br> <br>  <code>private</code>     <i> </i> <code>cutoff</code>  <i></i> <code>resonance</code> . <code>Mode</code>      (Lowpass, Highpass, Bandpass).  <code>feedbackAmount</code> , <code>buf0</code>  <code>buf1</code>    ,    . <br>          ( <code>calculateFeedbackAmount()</code> ).  <code>process</code>      .   <code>feedbackAmount</code>   <code>cutoff</code>  <code>resonance</code> ,    <code>calculateFeedbackAmount</code>      . <br> <br>   <i>Filter.cpp</i>  : <br> <br> <code class="cpp">// By Paul Kellett // http://www.musicdsp.org/showone.php?id=29 double Filter::process(double inputValue) { buf0 += cutoff * (inputValue - buf0); buf1 += cutoff * (buf0 - buf1); switch (mode) { case FILTER_MODE_LOWPASS: return buf1; case FILTER_MODE_HIGHPASS: return inputValue - buf0; case FILTER_MODE_BANDPASS: return buf0 - buf1; default: return 0.0; } }</code> <br> <br> , ?  ,         <i> </i> . ¬´ ¬ª   ,               (. .    6 ).     <code>buf0</code>  <code>buf1</code> :        .     <code>inputValue</code> ,  - <code>buf0</code> (  ).   .    6 /   12 /.  <code>switch</code> ,  <code>buf1</code>    . , ,    <code>buf0</code> ,       12,   6 /,        . <br> <br>  <code>case</code> <code>FILTER_MODE_HIGHPASS</code>    . <code>buf0</code>       .   <code>inputValue</code>  <code>buf0</code> ,   .    <code>buf1</code> ,     . <br> <br>  <code>case</code> <code>FILTER_MODE_BANDPASS</code> ,  <code>buf0 - buf1</code>   .  <code>buf0</code>       ,     <code>buf1</code> . ,   . <br>  :    <i> </i>    <i> </i> ,   . <br> <br>  <code>buf1</code>     .       <a href="http://ru.wikipedia.org/wiki/%25D0%25A4%25D0%25B8%25D0%25BB%25D1%258C%25D1%2582%25D1%2580_%25D1%2581_%25D0%25B1%25D0%25B5%25D1%2581%25D0%25BA%25D0%25BE%25D0%25BD%25D0%25B5%25D1%2587%25D0%25BD%25D0%25BE%25D0%25B9_%25D0%25B8%25D0%25BC%25D0%25BF%25D1%2583%25D0%25BB%25D1%258C%25D1%2581%25D0%25BD%25D0%25BE%25D0%25B9_%25D1%2585%25D0%25B0%25D1%2580%25D0%25B0%25D0%25BA%25D1%2582%25D0%25B5%25D1%2580%25D0%25B8%25D1%2581%25D1%2582%25D0%25B8%25D0%25BA%25D0%25BE%25D0%25B9">    </a> ( <i>Infinite Impulse Response</i> ,  <i>IIR</i> ).  <a href="http://www.dspguide.com/ch14/1.htm"> </a> ,      .      ,         ,      . <br> <br>   <br>       ,     ,     .   ,  ,      ,  ,          .           ,  NI Massive,   ¬´ <a href="http://lurkmore.to/%25D0%25A2%25D1%2591%25D0%25BF%25D0%25BB%25D1%258B%25D0%25B9_%25D0%25BB%25D0%25B0%25D0%25BC%25D0%25BF%25D0%25BE%25D0%25B2%25D1%258B%25D0%25B9_%25D0%25B7%25D0%25B2%25D1%2583%25D0%25BA">  </a> ¬ª.       ,          ,   .        ,          (  Massive       ).      ¬´¬ª , , , AAS Ultra Analog,       ,     ,    ,        .         ,  ,    <a href="http://www.kvraudio.com/forum/viewtopic.php%3Ft%3D350246"></a> ,   ,      NI Reaktor. ,            ‚Äî    ,    ..     . <br> <br>   <br>     .   GUI.  <i>bg.png</i>   ( <i>‚ÄúMove to trash‚Äù</i>  Xcode),       : <br> <br> <a href="">filtermode.png</a> <a href="">knob_small.png</a> (  ,   50 50 ) <a href="">bg.png</a> (       ) <br> <br>    ID  <i>resource.h</i> : <br> <br> <code class="cpp">// Unique IDs for each image resource. #define BG_ID 101 #define WHITE_KEY_ID 102 #define BLACK_KEY_ID 103 #define WAVEFORM_ID 104 #define KNOB_ID 105 #define KNOB_SMALL_ID 106 #define FILTERMODE_ID 107 // Image resource locations for this plug. #define BG_FN "resources/img/bg.png" #define WHITE_KEY_FN "resources/img/whitekey.png" #define BLACK_KEY_FN "resources/img/blackkey.png" #define WAVEFORM_FN "resources/img/waveform.png" #define KNOB_FN "resources/img/knob.png" #define KNOB_SMALL_FN "resources/img/knob_small.png" #define FILTERMODE_FN "resources/img/filtermode.png"</code> <br> <br>  <i>Synthesis.rc</i> : <br> <br> <code class="cpp">#include "resource.h" BG_ID PNG BG_FN WHITE_KEY_ID PNG WHITE_KEY_FN BLACK_KEY_ID PNG BLACK_KEY_FN WAVEFORM_ID PNG WAVEFORM_FN KNOB_ID PNG KNOB_FN KNOB_SMALL_ID PNG KNOB_SMALL_FN FILTERMODE_ID PNG FILTERMODE_FN</code> <br> <br>   <code>#include "Filter.h"</code>  <i>Synthesis.h</i>    <code>private</code> : <br> <br> <code class="cpp">Filter mFilter;</code> <br> <br>  <code>EParams</code>  <i>Synthesis.cpp</i> : <br> <br> <code class="cpp">enum EParams { mWaveform = 0, mAttack, mDecay, mSustain, mRelease, mFilterMode, mFilterCutoff, mFilterResonance, mFilterAttack, mFilterDecay, mFilterSustain, mFilterRelease, mFilterEnvelopeAmount, kNumParams };</code> <br> <br>        : <br> <br> <code class="cpp">pGraphics-&gt;AttachControl(new ISwitchControl(this, 24, 38, mWaveform, &amp;waveformBitmap));</code> <br> <br>      .      (Lowpass, Highpass, Bandpass).    <code>AttachGraphics(pGraphics)</code> : <br> <br> <code class="cpp">GetParam(mFilterMode)-&gt;InitEnum("Filter Mode", Filter::FILTER_MODE_LOWPASS, Filter::kNumFilterModes); IBitmap filtermodeBitmap = pGraphics-&gt;LoadIBitmap(FILTERMODE_ID, FILTERMODE_FN, 3); pGraphics-&gt;AttachControl(new ISwitchControl(this, 24, 123, mFilterMode, &amp;filtermodeBitmap));</code> <br> <br>         .    .     <i>knob_small.png</i> : <br> <br> <code class="cpp">// Knobs for filter cutoff and resonance IBitmap smallKnobBitmap = pGraphics-&gt;LoadIBitmap(KNOB_SMALL_ID, KNOB_SMALL_FN, 64); // Cutoff knob: GetParam(mFilterCutoff)-&gt;InitDouble("Cutoff", 0.99, 0.01, 0.99, 0.001); GetParam(mFilterCutoff)-&gt;SetShape(2); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 5, 177, mFilterCutoff, &amp;smallKnobBitmap)); // Resonance knob: GetParam(mFilterResonance)-&gt;InitDouble("Resonance", 0.01, 0.01, 1.0, 0.001); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 61, 177, mFilterResonance, &amp;smallKnobBitmap));</code> <br> <br>   ,           <code>1.0</code> ,   <code>calculateFeedbackAmount</code>    , . <br>  <code>ProcessDoubleReplacing</code>     : <br> <br> <code class="cpp">leftOutput[i] = rightOutput[i] = mFilter.process(mOscillator.nextSample() * mEnvelopeGenerator.nextSample() * velocity / 127.0);</code> <br> <br>       .  <code>switch</code>   <code>Synthesis::OnParamChange</code> : <br> <br> <code class="cpp">case mFilterCutoff: mFilter.setCutoff(GetParam(paramIdx)-&gt;Value()); break; case mFilterResonance: mFilter.setResonance(GetParam(paramIdx)-&gt;Value()); break; case mFilterMode: mFilter.setFilterMode(static_cast&lt;Filter::FilterMode&gt;(GetParam(paramIdx)-&gt;Int())); break;</code> <br> <br>    .  -      . <br> <br>  <br> <br>  ‚Äî      .   ,   ,          . <br>      : <br> <br> <code class="cpp">buf0 += cutoff * (inputValue - buf0 + feedbackAmount * (buf0 - buf1));</code> <br> <br> ,   ,      ( <code>buf0 ‚Äì buf1</code> ),   <code>feedbackAmount</code> .    <code>calculateFeedbackAmount</code>  <code>feedbackAmount</code>  <code>resonance</code> , . .    ,   . <br> <br>  ,            .     ,  <i></i> ,      <a href="https://www.youtube.com/watch%3Fv%3DJWyMj6KxGHM"> </a> .    ,        ,       . <br> <br>  -12 /  -24 / <br>        !     24   .     <code>switch</code>  <code>Filter::process</code> : <br> <br> <code class="cpp">buf2 += cutoff * (buf1 - buf2); buf3 += cutoff * (buf2 ‚Äì buf3);</code> <br> <br>   :      ,       ,            .     ,       , , <a href="https://ccrma.stanford.edu/~Jos/filters/Filter_Stability.html"></a> (       ).     <code>switch</code> : <br> <br> <code class="cpp">switch (mode) { case FILTER_MODE_LOWPASS: return buf3; case FILTER_MODE_HIGHPASS: return inputValue - buf3; case FILTER_MODE_BANDPASS: return buf0 - buf3; default: return 0.0; }</code> <br> <br>   <code>buf1</code>  <code>buf3</code> ‚Äì      .    -24 /.     <code>buf2</code>  <code>buf3</code> ,        <code>private</code> <i>Filter.h</i> : <br> <br> <code class="cpp">double buf2; double buf3;</code> <br> <br>    ,   <code>buf0</code> c <code>buf1</code> : <br> <br> <code class="cpp">Filter() : // ... buf0(0.0), buf1(0.0), buf2(0.0), buf3(0.0) // ...</code> <br> <br>     , ,     :     .       . <br>          ? <br> <br>   <br>    .  ,           ,       . <br> -      <code>cutoff</code>   .      .    <code>cutoffMod</code> ,    ,       <code>cutoff</code>    .     <code>#include    private</code> : <br> <br> <code class="cpp">double cutoffMod;</code> <br> <br> : <br> <br> <code class="cpp">Filter() : cutoff(0.99), resonance(0.01), cutoffMod(0.0), // ...</code> <br> <br>         .   <code>private</code> : <br> <br> <code class="cpp">inline double getCalculatedCutoff() const { return fmax(fmin(cutoff + cutoffMod, 0.99), 0.01); };</code> <br> <br> <code>calculateFeedbackAmount</code>     : <br> <br> <code class="cpp">inline void calculateFeedbackAmount() { feedbackAmount = resonance + resonance/(1.0 - getCalculatedCutoff()); }</code> <br> <br>       <code>cutoffMod</code> .   <code>feedbackAmount</code>    ,     : <br> <br> <code class="cpp">inline void setCutoffMod(double newCutoffMod) { cutoffMod = newCutoffMod; calculateFeedbackAmount(); }</code> <br> <br> ,       .   <code>Filter::process</code>   : <br> <br> <code class="cpp">if (inputValue == 0.0) return inputValue; double calculatedCutoff = getCalculatedCutoff(); buf0 += calculatedCutoff * (inputValue - buf0 + feedbackAmount * (buf0 - buf1)); buf1 += calculatedCutoff * (buf0 - buf1); buf2 += calculatedCutoff * (buf1 - buf2); buf3 += calculatedCutoff * (buf2 ‚Äì buf3);</code> <br> <br>        ,    .    ,      ,   .     .     <code>cutoff</code>  <code>calculatedCutoff</code>   -. <br> <br> ,       ( <code>setCutoffMod</code> ),   <code>Synthesis</code>    ,     ,    .    ,        <code>cutoffMod</code> .    <code>filterEnvelopeAmount</code>    <code>-1</code>  <code>+1</code> .   GUI. <br> <br>   <code>private</code> <i>Synthesis.h</i>    : <br> <br> <code class="cpp">EnvelopeGenerator mFilterEnvelopeGenerator; double filterEnvelopeAmount;</code> <br> <br>       MIDI ,      <code>onNoteOn</code>  <code>onNoteOff</code> : <br> <br> <code class="cpp">inline void onNoteOn(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); mFilterEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); }; inline void onNoteOff(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); mFilterEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); };</code> <br> <br>    .   <code>ProcessDoubleReplacing</code>        : <br> <br> <code class="cpp">mFilter.setCutoffMod(mFilterEnvelopeGenerator.nextSample() * filterEnvelopeAmount);</code> <br> <br>  ,        <code>nextSample</code>  <code>filterEnvelopeAmount</code>     <code>cutoffMod</code> .     <code>filterEnvelopeAmount</code>  : <br> <br> <code class="cpp">Synthesis::Synthesis(IPlugInstanceInfo instanceInfo) : IPLUG_CTOR(kNumParams, kNumPrograms, instanceInfo), lastVirtualKeyboardNoteNumber(virtualKeyboardMinimumNoteNumber - 1), filterEnvelopeAmount(0.0) { // ... }</code> <br> <br>       <code>Synthesis::Reset</code> : <br> <br> <code class="cpp">mFilterEnvelopeGenerator.setSampleRate(GetSampleRate());</code> <br> <br>      <code>EParams</code> ,       .  <code>AttachGraphics</code>     : <br> <br> <code class="cpp">// Knobs for filter envelope // Attack knob GetParam(mFilterAttack)-&gt;InitDouble("Filter Env Attack", 0.01, 0.01, 10.0, 0.001); GetParam(mFilterAttack)-&gt;SetShape(3); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 139, 178, mFilterAttack, &amp;smallKnobBitmap)); // Decay knob: GetParam(mFilterDecay)-&gt;InitDouble("Filter Env Decay", 0.5, 0.01, 15.0, 0.001); GetParam(mFilterDecay)-&gt;SetShape(3); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 195, 178, mFilterDecay, &amp;smallKnobBitmap)); // Sustain knob: GetParam(mFilterSustain)-&gt;InitDouble("Filter Env Sustain", 0.1, 0.001, 1.0, 0.001); GetParam(mFilterSustain)-&gt;SetShape(2); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 251, 178, mFilterSustain, &amp;smallKnobBitmap)); // Release knob: GetParam(mFilterRelease)-&gt;InitDouble("Filter Env Release", 1.0, 0.001, 15.0, 0.001); GetParam(mFilterRelease)-&gt;SetShape(3); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 307, 178, mFilterRelease, &amp;smallKnobBitmap)); // Filter envelope amount knob: GetParam(mFilterEnvelopeAmount)-&gt;InitDouble("Filter Env Amount", 0.0, -1.0, 1.0, 0.001); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 363, 178, mFilterEnvelopeAmount, &amp;smallKnobBitmap));</code> <br> <br>     ,       <code>smallKnobBitmap</code> .                   .     ,    .  <code>Synthesis::OnParamChange</code>    <code>switch</code> : <br> <br> <code class="cpp">case mFilterAttack: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK, GetParam(paramIdx)-&gt;Value()); break; case mFilterDecay: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_DECAY, GetParam(paramIdx)-&gt;Value()); break; case mFilterSustain: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_SUSTAIN, GetParam(paramIdx)-&gt;Value()); break; case mFilterRelease: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE, GetParam(paramIdx)-&gt;Value()); break; case mFilterEnvelopeAmount: filterEnvelopeAmount = GetParam(paramIdx)-&gt;Value(); break;</code> <br> <br> ! <br>     !           (-   C1),   : <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/f5d/757/3f9/f5d7573f9b3a720fe5898d88ae477cfc.png"> <br> <br>        <code>EnvelopeGenerator</code>  .         .        ! <br> <br>    <a href=""></a> . <br> <br>        :) <br> <br>  : <br> <a href="http://martin-finke.de/blog/articles/audio-plugins-013-filter/">martin-finke.de/blog/articles/audio-plugins-013-filter</a></code></code> <pre> <code class="hljs erlang-repl"><code class="cpp">#include  <i>Filter.h</i> ( )     : <br> <br> class Filter { public: enum FilterMode { FILTER_MODE_LOWPASS = <span class="hljs-number"><span class="hljs-number">0</span></span>, FILTER_MODE_HIGHPASS, FILTER_MODE_BANDPASS, kNumFilterModes }; Filter() : cutoff(<span class="hljs-number"><span class="hljs-number">0.99</span></span>), resonance(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), mode(FILTER_MODE_LOWPASS), buf0(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), buf1(<span class="hljs-number"><span class="hljs-number">0.0</span></span>) { calculateFeedbackAmount(); }; double process(double inputValue); inline void setCutoff(double newCutoff) { cutoff = newCutoff; calculateFeedbackAmount(); }; inline void setResonance(double newResonance) { resonance = newResonance; calculateFeedbackAmount(); }; inline void setFilterMode(FilterMode newMode) { mode = newMode; } private: double cutoff; double resonance; FilterMode mode; double feedbackAmount; inline void calculateFeedbackAmount() { feedbackAmount = resonance + resonance/(<span class="hljs-number"><span class="hljs-number">1.0</span></span> - cutoff); } double buf0; double buf1; };</code> <br> <br>  <code>private</code>     <i> </i> <code>cutoff</code>  <i></i> <code>resonance</code> . <code>Mode</code>      (Lowpass, Highpass, Bandpass).  <code>feedbackAmount</code> , <code>buf0</code>  <code>buf1</code>    ,    . <br>          ( <code>calculateFeedbackAmount()</code> ).  <code>process</code>      .   <code>feedbackAmount</code>   <code>cutoff</code>  <code>resonance</code> ,    <code>calculateFeedbackAmount</code>      . <br> <br>   <i>Filter.cpp</i>  : <br> <br> <code class="cpp">// By Paul Kellett // http://www.musicdsp.org/showone.php?id=<span class="hljs-number"><span class="hljs-number">29</span></span> double Filter::process(double inputValue) { buf0 += cutoff * (inputValue - buf0); buf1 += cutoff * (buf0 - buf1); switch (mode) { case FILTER_MODE_LOWPASS: return buf1; case FILTER_MODE_HIGHPASS: return inputValue - buf0; case FILTER_MODE_BANDPASS: return buf0 - buf1; default: return <span class="hljs-number"><span class="hljs-number">0.0</span></span>; } }</code> <br> <br> , ?  ,         <i> </i> . ¬´ ¬ª   ,               (. .    <span class="hljs-number"><span class="hljs-number">6</span></span> ).     <code>buf0</code>  <code>buf1</code> :        .     <code>inputValue</code> ,  - <code>buf0</code> (  ).   .    <span class="hljs-number"><span class="hljs-number">6</span></span> /   <span class="hljs-number"><span class="hljs-number">12</span></span> /.  <code>switch</code> ,  <code>buf1</code>    . , ,    <code>buf0</code> ,       <span class="hljs-number"><span class="hljs-number">12</span></span>,   <span class="hljs-number"><span class="hljs-number">6</span></span> /,        . <br> <br>  <code>case</code> <code>FILTER_MODE_HIGHPASS</code>    . <code>buf0</code>       .   <code>inputValue</code>  <code>buf0</code> ,   .    <code>buf1</code> ,     . <br> <br>  <code>case</code> <code>FILTER_MODE_BANDPASS</code> ,  <code>buf0 - buf1</code>   .  <code>buf0</code>       ,     <code>buf1</code> . ,   . <br>  :    <i> </i>    <i> </i> ,   . <br> <br>  <code>buf1</code>     .       <a href="http://ru.wikipedia.org/wiki/%25D0%25A4%25D0%25B8%25D0%25BB%25D1%258C%25D1%2582%25D1%2580_%25D1%2581_%25D0%25B1%25D0%25B5%25D1%2581%25D0%25BA%25D0%25BE%25D0%25BD%25D0%25B5%25D1%2587%25D0%25BD%25D0%25BE%25D0%25B9_%25D0%25B8%25D0%25BC%25D0%25BF%25D1%2583%25D0%25BB%25D1%258C%25D1%2581%25D0%25BD%25D0%25BE%25D0%25B9_%25D1%2585%25D0%25B0%25D1%2580%25D0%25B0%25D0%25BA%25D1%2582%25D0%25B5%25D1%2580%25D0%25B8%25D1%2581%25D1%2582%25D0%25B8%25D0%25BA%25D0%25BE%25D0%25B9">    </a> ( <i>Infinite Impulse Response</i> ,  <i>IIR</i> ).  <a href="http://www.dspguide.com/ch14/1.htm"> </a> ,      .      ,         ,      . <br> <br>   <br>       ,     ,     .   ,  ,      ,  ,          .           ,  NI Massive,   ¬´ <a href="http://lurkmore.to/%25D0%25A2%25D1%2591%25D0%25BF%25D0%25BB%25D1%258B%25D0%25B9_%25D0%25BB%25D0%25B0%25D0%25BC%25D0%25BF%25D0%25BE%25D0%25B2%25D1%258B%25D0%25B9_%25D0%25B7%25D0%25B2%25D1%2583%25D0%25BA">  </a> ¬ª.       ,          ,   .        ,          (  Massive       ).      ¬´¬ª , , , AAS Ultra Analog,       ,     ,    ,        .         ,  ,    <a href="http://www.kvraudio.com/forum/viewtopic.php%3Ft%3D350246"></a> ,   ,      NI Reaktor. ,            ‚Äî    ,    ..     . <br> <br>   <br>     .   GUI.  <i>bg.png</i>   ( <i>‚ÄúMove to trash‚Äù</i>  Xcode),       : <br> <br> <a href="">filtermode.png</a> <a href="">knob_small.png</a> (  ,   <span class="hljs-number"><span class="hljs-number">50</span></span> <span class="hljs-number"><span class="hljs-number">50</span></span> ) <a href="">bg.png</a> (       ) <br> <br>    ID  <i>resource.h</i> : <br> <br> <code class="cpp">// Unique IDs for each image resource. #define BG_ID <span class="hljs-number"><span class="hljs-number">101</span></span> #define WHITE_KEY_ID <span class="hljs-number"><span class="hljs-number">102</span></span> #define BLACK_KEY_ID <span class="hljs-number"><span class="hljs-number">103</span></span> #define WAVEFORM_ID <span class="hljs-number"><span class="hljs-number">104</span></span> #define KNOB_ID <span class="hljs-number"><span class="hljs-number">105</span></span> #define KNOB_SMALL_ID <span class="hljs-number"><span class="hljs-number">106</span></span> #define FILTERMODE_ID <span class="hljs-number"><span class="hljs-number">107</span></span> // Image resource locations for this plug. #define BG_FN <span class="hljs-string"><span class="hljs-string">"resources/img/bg.png"</span></span> #define WHITE_KEY_FN <span class="hljs-string"><span class="hljs-string">"resources/img/whitekey.png"</span></span> #define BLACK_KEY_FN <span class="hljs-string"><span class="hljs-string">"resources/img/blackkey.png"</span></span> #define WAVEFORM_FN <span class="hljs-string"><span class="hljs-string">"resources/img/waveform.png"</span></span> #define KNOB_FN <span class="hljs-string"><span class="hljs-string">"resources/img/knob.png"</span></span> #define KNOB_SMALL_FN <span class="hljs-string"><span class="hljs-string">"resources/img/knob_small.png"</span></span> #define FILTERMODE_FN <span class="hljs-string"><span class="hljs-string">"resources/img/filtermode.png"</span></span></code> <br> <br>  <i>Synthesis.rc</i> : <br> <br> <code class="cpp">#include <span class="hljs-string"><span class="hljs-string">"resource.h"</span></span> BG_ID PNG BG_FN WHITE_KEY_ID PNG WHITE_KEY_FN BLACK_KEY_ID PNG BLACK_KEY_FN WAVEFORM_ID PNG WAVEFORM_FN KNOB_ID PNG KNOB_FN KNOB_SMALL_ID PNG KNOB_SMALL_FN FILTERMODE_ID PNG FILTERMODE_FN</code> <br> <br>   <code>#include <span class="hljs-string"><span class="hljs-string">"Filter.h"</span></span></code>  <i>Synthesis.h</i>    <code>private</code> : <br> <br> <code class="cpp">Filter mFilter;</code> <br> <br>  <code>EParams</code>  <i>Synthesis.cpp</i> : <br> <br> <code class="cpp">enum EParams { mWaveform = <span class="hljs-number"><span class="hljs-number">0</span></span>, mAttack, mDecay, mSustain, mRelease, mFilterMode, mFilterCutoff, mFilterResonance, mFilterAttack, mFilterDecay, mFilterSustain, mFilterRelease, mFilterEnvelopeAmount, kNumParams };</code> <br> <br>        : <br> <br> <code class="cpp">pGraphics-&gt;AttachControl(new ISwitchControl(this, <span class="hljs-number"><span class="hljs-number">24</span></span>, <span class="hljs-number"><span class="hljs-number">38</span></span>, mWaveform, &amp;waveformBitmap));</code> <br> <br>      .      (Lowpass, Highpass, Bandpass).    <code>AttachGraphics(pGraphics)</code> : <br> <br> <code class="cpp">GetParam(mFilterMode)-&gt;InitEnum(<span class="hljs-string"><span class="hljs-string">"Filter Mode"</span></span>, Filter::FILTER_MODE_LOWPASS, Filter::kNumFilterModes); IBitmap filtermodeBitmap = pGraphics-&gt;LoadIBitmap(FILTERMODE_ID, FILTERMODE_FN, <span class="hljs-number"><span class="hljs-number">3</span></span>); pGraphics-&gt;AttachControl(new ISwitchControl(this, <span class="hljs-number"><span class="hljs-number">24</span></span>, <span class="hljs-number"><span class="hljs-number">123</span></span>, mFilterMode, &amp;filtermodeBitmap));</code> <br> <br>         .    .     <i>knob_small.png</i> : <br> <br> <code class="cpp">// Knobs for filter cutoff and resonance IBitmap smallKnobBitmap = pGraphics-&gt;LoadIBitmap(KNOB_SMALL_ID, KNOB_SMALL_FN, <span class="hljs-number"><span class="hljs-number">64</span></span>); // Cutoff knob: GetParam(mFilterCutoff)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Cutoff"</span></span>, <span class="hljs-number"><span class="hljs-number">0.99</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">0.99</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); GetParam(mFilterCutoff)-&gt;SetShape(<span class="hljs-number"><span class="hljs-number">2</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-number"><span class="hljs-number">177</span></span>, mFilterCutoff, &amp;smallKnobBitmap)); // Resonance knob: GetParam(mFilterResonance)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Resonance"</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">61</span></span>, <span class="hljs-number"><span class="hljs-number">177</span></span>, mFilterResonance, &amp;smallKnobBitmap));</code> <br> <br>   ,           <code><span class="hljs-number"><span class="hljs-number">1.0</span></span></code> ,   <code>calculateFeedbackAmount</code>    , . <br>  <code>ProcessDoubleReplacing</code>     : <br> <br> <code class="cpp">leftOutput[i] = rightOutput[i] = mFilter.process(mOscillator.nextSample() * mEnvelopeGenerator.nextSample() * velocity / <span class="hljs-number"><span class="hljs-number">127.0</span></span>);</code> <br> <br>       .  <code>switch</code>   <code>Synthesis::OnParamChange</code> : <br> <br> <code class="cpp">case mFilterCutoff: mFilter.setCutoff(GetParam(paramIdx)-&gt;Value()); break; case mFilterResonance: mFilter.setResonance(GetParam(paramIdx)-&gt;Value()); break; case mFilterMode: mFilter.setFilterMode(static_cast&lt;Filter::FilterMode&gt;(GetParam(paramIdx)-&gt;Int())); break;</code> <br> <br>    .  -      . <br> <br>  <br> <br>  ‚Äî      .   ,   ,          . <br>      : <br> <br> <code class="cpp">buf0 += cutoff * (inputValue - buf0 + feedbackAmount * (buf0 - buf1));</code> <br> <br> ,   ,      ( <code>buf0 ‚Äì buf1</code> ),   <code>feedbackAmount</code> .    <code>calculateFeedbackAmount</code>  <code>feedbackAmount</code>  <code>resonance</code> , . .    ,   . <br> <br>  ,            .     ,  <i></i> ,      <a href="https://www.youtube.com/watch%3Fv%3DJWyMj6KxGHM"> </a> .    ,        ,       . <br> <br>  -<span class="hljs-number"><span class="hljs-number">12</span></span> /  -<span class="hljs-number"><span class="hljs-number">24</span></span> / <br>        !     <span class="hljs-number"><span class="hljs-number">24</span></span>   .     <code>switch</code>  <code>Filter::process</code> : <br> <br> <code class="cpp">buf2 += cutoff * (buf1 - buf2); buf3 += cutoff * (buf2 ‚Äì buf3);</code> <br> <br>   :      ,       ,            .     ,       , , <a href="https://ccrma.stanford.edu/~Jos/filters/Filter_Stability.html"></a> (       ).     <code>switch</code> : <br> <br> <code class="cpp">switch (mode) { case FILTER_MODE_LOWPASS: return buf3; case FILTER_MODE_HIGHPASS: return inputValue - buf3; case FILTER_MODE_BANDPASS: return buf0 - buf3; default: return <span class="hljs-number"><span class="hljs-number">0.0</span></span>; }</code> <br> <br>   <code>buf1</code>  <code>buf3</code> ‚Äì      .    -<span class="hljs-number"><span class="hljs-number">24</span></span> /.     <code>buf2</code>  <code>buf3</code> ,        <code>private</code> <i>Filter.h</i> : <br> <br> <code class="cpp">double buf2; double buf3;</code> <br> <br>    ,   <code>buf0</code> c <code>buf1</code> : <br> <br> <code class="cpp">Filter() : // ... buf0(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), buf1(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), buf2(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), buf3(<span class="hljs-number"><span class="hljs-number">0.0</span></span>) // ...</code> <br> <br>     , ,     :     .       . <br>          ? <br> <br>   <br>    .  ,           ,       . <br> -      <code>cutoff</code>   .      .    <code>cutoffMod</code> ,    ,       <code>cutoff</code>    .     <code><code>#include    private</code> : <br> <br> <code class="cpp">double cutoffMod;</code> <br> <br> : <br> <br> <code class="cpp">Filter() : cutoff(<span class="hljs-number"><span class="hljs-number">0.99</span></span>), resonance(<span class="hljs-number"><span class="hljs-number">0.01</span></span>), cutoffMod(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), // ...</code> <br> <br>         .   <code>private</code> : <br> <br> <code class="cpp">inline double getCalculatedCutoff() const { return fmax(fmin(cutoff + cutoffMod, <span class="hljs-number"><span class="hljs-number">0.99</span></span>), <span class="hljs-number"><span class="hljs-number">0.01</span></span>); };</code> <br> <br> <code>calculateFeedbackAmount</code>     : <br> <br> <code class="cpp">inline void calculateFeedbackAmount() { feedbackAmount = resonance + resonance/(<span class="hljs-number"><span class="hljs-number">1.0</span></span> - getCalculatedCutoff()); }</code> <br> <br>       <code>cutoffMod</code> .   <code>feedbackAmount</code>    ,     : <br> <br> <code class="cpp">inline void setCutoffMod(double newCutoffMod) { cutoffMod = newCutoffMod; calculateFeedbackAmount(); }</code> <br> <br> ,       .   <code>Filter::process</code>   : <br> <br> <code class="cpp">if (inputValue == <span class="hljs-number"><span class="hljs-number">0.0</span></span>) return inputValue; double calculatedCutoff = getCalculatedCutoff(); buf0 += calculatedCutoff * (inputValue - buf0 + feedbackAmount * (buf0 - buf1)); buf1 += calculatedCutoff * (buf0 - buf1); buf2 += calculatedCutoff * (buf1 - buf2); buf3 += calculatedCutoff * (buf2 ‚Äì buf3);</code> <br> <br>        ,    .    ,      ,   .     .     <code>cutoff</code>  <code>calculatedCutoff</code>   -. <br> <br> ,       ( <code>setCutoffMod</code> ),   <code>Synthesis</code>    ,     ,    .    ,        <code>cutoffMod</code> .    <code>filterEnvelopeAmount</code>    <code>-<span class="hljs-number"><span class="hljs-number">1</span></span></code>  <code>+<span class="hljs-number"><span class="hljs-number">1</span></span></code> .   GUI. <br> <br>   <code>private</code> <i>Synthesis.h</i>    : <br> <br> <code class="cpp">EnvelopeGenerator mFilterEnvelopeGenerator; double filterEnvelopeAmount;</code> <br> <br>       MIDI ,      <code>onNoteOn</code>  <code>onNoteOff</code> : <br> <br> <code class="cpp">inline void onNoteOn(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); mFilterEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); }; inline void onNoteOff(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); mFilterEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); };</code> <br> <br>    .   <code>ProcessDoubleReplacing</code>        : <br> <br> <code class="cpp">mFilter.setCutoffMod(mFilterEnvelopeGenerator.nextSample() * filterEnvelopeAmount);</code> <br> <br>  ,        <code>nextSample</code>  <code>filterEnvelopeAmount</code>     <code>cutoffMod</code> .     <code>filterEnvelopeAmount</code>  : <br> <br> <code class="cpp">Synthesis::Synthesis(IPlugInstanceInfo instanceInfo) : IPLUG_CTOR(kNumParams, kNumPrograms, instanceInfo), lastVirtualKeyboardNoteNumber(virtualKeyboardMinimumNoteNumber - <span class="hljs-number"><span class="hljs-number">1</span></span>), filterEnvelopeAmount(<span class="hljs-number"><span class="hljs-number">0.0</span></span>) { // ... }</code> <br> <br>       <code>Synthesis::Reset</code> : <br> <br> <code class="cpp">mFilterEnvelopeGenerator.setSampleRate(GetSampleRate());</code> <br> <br>      <code>EParams</code> ,       .  <code>AttachGraphics</code>     : <br> <br> <code class="cpp">// Knobs for filter envelope // Attack knob GetParam(mFilterAttack)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Filter Env Attack"</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">10.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); GetParam(mFilterAttack)-&gt;SetShape(<span class="hljs-number"><span class="hljs-number">3</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">139</span></span>, <span class="hljs-number"><span class="hljs-number">178</span></span>, mFilterAttack, &amp;smallKnobBitmap)); // Decay knob: GetParam(mFilterDecay)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Filter Env Decay"</span></span>, <span class="hljs-number"><span class="hljs-number">0.5</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">15.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); GetParam(mFilterDecay)-&gt;SetShape(<span class="hljs-number"><span class="hljs-number">3</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">195</span></span>, <span class="hljs-number"><span class="hljs-number">178</span></span>, mFilterDecay, &amp;smallKnobBitmap)); // Sustain knob: GetParam(mFilterSustain)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Filter Env Sustain"</span></span>, <span class="hljs-number"><span class="hljs-number">0.1</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>, <span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); GetParam(mFilterSustain)-&gt;SetShape(<span class="hljs-number"><span class="hljs-number">2</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">251</span></span>, <span class="hljs-number"><span class="hljs-number">178</span></span>, mFilterSustain, &amp;smallKnobBitmap)); // Release knob: GetParam(mFilterRelease)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Filter Env Release"</span></span>, <span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>, <span class="hljs-number"><span class="hljs-number">15.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); GetParam(mFilterRelease)-&gt;SetShape(<span class="hljs-number"><span class="hljs-number">3</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">307</span></span>, <span class="hljs-number"><span class="hljs-number">178</span></span>, mFilterRelease, &amp;smallKnobBitmap)); // Filter envelope amount knob: GetParam(mFilterEnvelopeAmount)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Filter Env Amount"</span></span>, <span class="hljs-number"><span class="hljs-number">0.0</span></span>, -<span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">363</span></span>, <span class="hljs-number"><span class="hljs-number">178</span></span>, mFilterEnvelopeAmount, &amp;smallKnobBitmap));</code> <br> <br>     ,       <code>smallKnobBitmap</code> .                   .     ,    .  <code>Synthesis::OnParamChange</code>    <code>switch</code> : <br> <br> <code class="cpp">case mFilterAttack: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK, GetParam(paramIdx)-&gt;Value()); break; case mFilterDecay: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_DECAY, GetParam(paramIdx)-&gt;Value()); break; case mFilterSustain: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_SUSTAIN, GetParam(paramIdx)-&gt;Value()); break; case mFilterRelease: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE, GetParam(paramIdx)-&gt;Value()); break; case mFilterEnvelopeAmount: filterEnvelopeAmount = GetParam(paramIdx)-&gt;Value(); break;</code> <br> <br> ! <br>     !           (-   C1),   : <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/f5d/757/3f9/f5d7573f9b3a720fe5898d88ae477cfc.png"> <br> <br>        <code>EnvelopeGenerator</code>  .         .        ! <br> <br>    <a href=""></a> . <br> <br>        :) <br> <br>  : <br> <a href="http://martin-finke.de/blog/articles/audio-plugins-013-filter/">martin-finke.de/blog/articles/audio-plugins-<span class="hljs-number"><span class="hljs-number">013</span></span>-filter</a></code></code> </pre> <code><code><code class="cpp">#include  <i>Filter.h</i> ( )     : <br> <br> class Filter { public: enum FilterMode { FILTER_MODE_LOWPASS = 0, FILTER_MODE_HIGHPASS, FILTER_MODE_BANDPASS, kNumFilterModes }; Filter() : cutoff(0.99), resonance(0.0), mode(FILTER_MODE_LOWPASS), buf0(0.0), buf1(0.0) { calculateFeedbackAmount(); }; double process(double inputValue); inline void setCutoff(double newCutoff) { cutoff = newCutoff; calculateFeedbackAmount(); }; inline void setResonance(double newResonance) { resonance = newResonance; calculateFeedbackAmount(); }; inline void setFilterMode(FilterMode newMode) { mode = newMode; } private: double cutoff; double resonance; FilterMode mode; double feedbackAmount; inline void calculateFeedbackAmount() { feedbackAmount = resonance + resonance/(1.0 - cutoff); } double buf0; double buf1; };</code> <br> <br>  <code>private</code>     <i> </i> <code>cutoff</code>  <i></i> <code>resonance</code> . <code>Mode</code>      (Lowpass, Highpass, Bandpass).  <code>feedbackAmount</code> , <code>buf0</code>  <code>buf1</code>    ,    . <br>          ( <code>calculateFeedbackAmount()</code> ).  <code>process</code>      .   <code>feedbackAmount</code>   <code>cutoff</code>  <code>resonance</code> ,    <code>calculateFeedbackAmount</code>      . <br> <br>   <i>Filter.cpp</i>  : <br> <br> <code class="cpp">// By Paul Kellett // http://www.musicdsp.org/showone.php?id=29 double Filter::process(double inputValue) { buf0 += cutoff * (inputValue - buf0); buf1 += cutoff * (buf0 - buf1); switch (mode) { case FILTER_MODE_LOWPASS: return buf1; case FILTER_MODE_HIGHPASS: return inputValue - buf0; case FILTER_MODE_BANDPASS: return buf0 - buf1; default: return 0.0; } }</code> <br> <br> , ?  ,         <i> </i> . ¬´ ¬ª   ,               (. .    6 ).     <code>buf0</code>  <code>buf1</code> :        .     <code>inputValue</code> ,  - <code>buf0</code> (  ).   .    6 /   12 /.  <code>switch</code> ,  <code>buf1</code>    . , ,    <code>buf0</code> ,       12,   6 /,        . <br> <br>  <code>case</code> <code>FILTER_MODE_HIGHPASS</code>    . <code>buf0</code>       .   <code>inputValue</code>  <code>buf0</code> ,   .    <code>buf1</code> ,     . <br> <br>  <code>case</code> <code>FILTER_MODE_BANDPASS</code> ,  <code>buf0 - buf1</code>   .  <code>buf0</code>       ,     <code>buf1</code> . ,   . <br>  :    <i> </i>    <i> </i> ,   . <br> <br>  <code>buf1</code>     .       <a href="http://ru.wikipedia.org/wiki/%25D0%25A4%25D0%25B8%25D0%25BB%25D1%258C%25D1%2582%25D1%2580_%25D1%2581_%25D0%25B1%25D0%25B5%25D1%2581%25D0%25BA%25D0%25BE%25D0%25BD%25D0%25B5%25D1%2587%25D0%25BD%25D0%25BE%25D0%25B9_%25D0%25B8%25D0%25BC%25D0%25BF%25D1%2583%25D0%25BB%25D1%258C%25D1%2581%25D0%25BD%25D0%25BE%25D0%25B9_%25D1%2585%25D0%25B0%25D1%2580%25D0%25B0%25D0%25BA%25D1%2582%25D0%25B5%25D1%2580%25D0%25B8%25D1%2581%25D1%2582%25D0%25B8%25D0%25BA%25D0%25BE%25D0%25B9">    </a> ( <i>Infinite Impulse Response</i> ,  <i>IIR</i> ).  <a href="http://www.dspguide.com/ch14/1.htm"> </a> ,      .      ,         ,      . <br> <br>   <br>       ,     ,     .   ,  ,      ,  ,          .           ,  NI Massive,   ¬´ <a href="http://lurkmore.to/%25D0%25A2%25D1%2591%25D0%25BF%25D0%25BB%25D1%258B%25D0%25B9_%25D0%25BB%25D0%25B0%25D0%25BC%25D0%25BF%25D0%25BE%25D0%25B2%25D1%258B%25D0%25B9_%25D0%25B7%25D0%25B2%25D1%2583%25D0%25BA">  </a> ¬ª.       ,          ,   .        ,          (  Massive       ).      ¬´¬ª , , , AAS Ultra Analog,       ,     ,    ,        .         ,  ,    <a href="http://www.kvraudio.com/forum/viewtopic.php%3Ft%3D350246"></a> ,   ,      NI Reaktor. ,            ‚Äî    ,    ..     . <br> <br>   <br>     .   GUI.  <i>bg.png</i>   ( <i>‚ÄúMove to trash‚Äù</i>  Xcode),       : <br> <br> <a href="">filtermode.png</a> <a href="">knob_small.png</a> (  ,   50 50 ) <a href="">bg.png</a> (       ) <br> <br>    ID  <i>resource.h</i> : <br> <br> <code class="cpp">// Unique IDs for each image resource. #define BG_ID 101 #define WHITE_KEY_ID 102 #define BLACK_KEY_ID 103 #define WAVEFORM_ID 104 #define KNOB_ID 105 #define KNOB_SMALL_ID 106 #define FILTERMODE_ID 107 // Image resource locations for this plug. #define BG_FN "resources/img/bg.png" #define WHITE_KEY_FN "resources/img/whitekey.png" #define BLACK_KEY_FN "resources/img/blackkey.png" #define WAVEFORM_FN "resources/img/waveform.png" #define KNOB_FN "resources/img/knob.png" #define KNOB_SMALL_FN "resources/img/knob_small.png" #define FILTERMODE_FN "resources/img/filtermode.png"</code> <br> <br>  <i>Synthesis.rc</i> : <br> <br> <code class="cpp">#include "resource.h" BG_ID PNG BG_FN WHITE_KEY_ID PNG WHITE_KEY_FN BLACK_KEY_ID PNG BLACK_KEY_FN WAVEFORM_ID PNG WAVEFORM_FN KNOB_ID PNG KNOB_FN KNOB_SMALL_ID PNG KNOB_SMALL_FN FILTERMODE_ID PNG FILTERMODE_FN</code> <br> <br>   <code>#include "Filter.h"</code>  <i>Synthesis.h</i>    <code>private</code> : <br> <br> <code class="cpp">Filter mFilter;</code> <br> <br>  <code>EParams</code>  <i>Synthesis.cpp</i> : <br> <br> <code class="cpp">enum EParams { mWaveform = 0, mAttack, mDecay, mSustain, mRelease, mFilterMode, mFilterCutoff, mFilterResonance, mFilterAttack, mFilterDecay, mFilterSustain, mFilterRelease, mFilterEnvelopeAmount, kNumParams };</code> <br> <br>        : <br> <br> <code class="cpp">pGraphics-&gt;AttachControl(new ISwitchControl(this, 24, 38, mWaveform, &amp;waveformBitmap));</code> <br> <br>      .      (Lowpass, Highpass, Bandpass).    <code>AttachGraphics(pGraphics)</code> : <br> <br> <code class="cpp">GetParam(mFilterMode)-&gt;InitEnum("Filter Mode", Filter::FILTER_MODE_LOWPASS, Filter::kNumFilterModes); IBitmap filtermodeBitmap = pGraphics-&gt;LoadIBitmap(FILTERMODE_ID, FILTERMODE_FN, 3); pGraphics-&gt;AttachControl(new ISwitchControl(this, 24, 123, mFilterMode, &amp;filtermodeBitmap));</code> <br> <br>         .    .     <i>knob_small.png</i> : <br> <br> <code class="cpp">// Knobs for filter cutoff and resonance IBitmap smallKnobBitmap = pGraphics-&gt;LoadIBitmap(KNOB_SMALL_ID, KNOB_SMALL_FN, 64); // Cutoff knob: GetParam(mFilterCutoff)-&gt;InitDouble("Cutoff", 0.99, 0.01, 0.99, 0.001); GetParam(mFilterCutoff)-&gt;SetShape(2); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 5, 177, mFilterCutoff, &amp;smallKnobBitmap)); // Resonance knob: GetParam(mFilterResonance)-&gt;InitDouble("Resonance", 0.01, 0.01, 1.0, 0.001); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 61, 177, mFilterResonance, &amp;smallKnobBitmap));</code> <br> <br>   ,           <code>1.0</code> ,   <code>calculateFeedbackAmount</code>    , . <br>  <code>ProcessDoubleReplacing</code>     : <br> <br> <code class="cpp">leftOutput[i] = rightOutput[i] = mFilter.process(mOscillator.nextSample() * mEnvelopeGenerator.nextSample() * velocity / 127.0);</code> <br> <br>       .  <code>switch</code>   <code>Synthesis::OnParamChange</code> : <br> <br> <code class="cpp">case mFilterCutoff: mFilter.setCutoff(GetParam(paramIdx)-&gt;Value()); break; case mFilterResonance: mFilter.setResonance(GetParam(paramIdx)-&gt;Value()); break; case mFilterMode: mFilter.setFilterMode(static_cast&lt;Filter::FilterMode&gt;(GetParam(paramIdx)-&gt;Int())); break;</code> <br> <br>    .  -      . <br> <br>  <br> <br>  ‚Äî      .   ,   ,          . <br>      : <br> <br> <code class="cpp">buf0 += cutoff * (inputValue - buf0 + feedbackAmount * (buf0 - buf1));</code> <br> <br> ,   ,      ( <code>buf0 ‚Äì buf1</code> ),   <code>feedbackAmount</code> .    <code>calculateFeedbackAmount</code>  <code>feedbackAmount</code>  <code>resonance</code> , . .    ,   . <br> <br>  ,            .     ,  <i></i> ,      <a href="https://www.youtube.com/watch%3Fv%3DJWyMj6KxGHM"> </a> .    ,        ,       . <br> <br>  -12 /  -24 / <br>        !     24   .     <code>switch</code>  <code>Filter::process</code> : <br> <br> <code class="cpp">buf2 += cutoff * (buf1 - buf2); buf3 += cutoff * (buf2 ‚Äì buf3);</code> <br> <br>   :      ,       ,            .     ,       , , <a href="https://ccrma.stanford.edu/~Jos/filters/Filter_Stability.html"></a> (       ).     <code>switch</code> : <br> <br> <code class="cpp">switch (mode) { case FILTER_MODE_LOWPASS: return buf3; case FILTER_MODE_HIGHPASS: return inputValue - buf3; case FILTER_MODE_BANDPASS: return buf0 - buf3; default: return 0.0; }</code> <br> <br>   <code>buf1</code>  <code>buf3</code> ‚Äì      .    -24 /.     <code>buf2</code>  <code>buf3</code> ,        <code>private</code> <i>Filter.h</i> : <br> <br> <code class="cpp">double buf2; double buf3;</code> <br> <br>    ,   <code>buf0</code> c <code>buf1</code> : <br> <br> <code class="cpp">Filter() : // ... buf0(0.0), buf1(0.0), buf2(0.0), buf3(0.0) // ...</code> <br> <br>     , ,     :     .       . <br>          ? <br> <br>   <br>    .  ,           ,       . <br> -      <code>cutoff</code>   .      .    <code>cutoffMod</code> ,    ,       <code>cutoff</code>    .     <code>#include    private</code> : <br> <br> <code class="cpp">double cutoffMod;</code> <br> <br> : <br> <br> <code class="cpp">Filter() : cutoff(0.99), resonance(0.01), cutoffMod(0.0), // ...</code> <br> <br>         .   <code>private</code> : <br> <br> <code class="cpp">inline double getCalculatedCutoff() const { return fmax(fmin(cutoff + cutoffMod, 0.99), 0.01); };</code> <br> <br> <code>calculateFeedbackAmount</code>     : <br> <br> <code class="cpp">inline void calculateFeedbackAmount() { feedbackAmount = resonance + resonance/(1.0 - getCalculatedCutoff()); }</code> <br> <br>       <code>cutoffMod</code> .   <code>feedbackAmount</code>    ,     : <br> <br> <code class="cpp">inline void setCutoffMod(double newCutoffMod) { cutoffMod = newCutoffMod; calculateFeedbackAmount(); }</code> <br> <br> ,       .   <code>Filter::process</code>   : <br> <br> <code class="cpp">if (inputValue == 0.0) return inputValue; double calculatedCutoff = getCalculatedCutoff(); buf0 += calculatedCutoff * (inputValue - buf0 + feedbackAmount * (buf0 - buf1)); buf1 += calculatedCutoff * (buf0 - buf1); buf2 += calculatedCutoff * (buf1 - buf2); buf3 += calculatedCutoff * (buf2 ‚Äì buf3);</code> <br> <br>        ,    .    ,      ,   .     .     <code>cutoff</code>  <code>calculatedCutoff</code>   -. <br> <br> ,       ( <code>setCutoffMod</code> ),   <code>Synthesis</code>    ,     ,    .    ,        <code>cutoffMod</code> .    <code>filterEnvelopeAmount</code>    <code>-1</code>  <code>+1</code> .   GUI. <br> <br>   <code>private</code> <i>Synthesis.h</i>    : <br> <br> <code class="cpp">EnvelopeGenerator mFilterEnvelopeGenerator; double filterEnvelopeAmount;</code> <br> <br>       MIDI ,      <code>onNoteOn</code>  <code>onNoteOff</code> : <br> <br> <code class="cpp">inline void onNoteOn(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); mFilterEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); }; inline void onNoteOff(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); mFilterEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); };</code> <br> <br>    .   <code>ProcessDoubleReplacing</code>        : <br> <br> <code class="cpp">mFilter.setCutoffMod(mFilterEnvelopeGenerator.nextSample() * filterEnvelopeAmount);</code> <br> <br>  ,        <code>nextSample</code>  <code>filterEnvelopeAmount</code>     <code>cutoffMod</code> .     <code>filterEnvelopeAmount</code>  : <br> <br> <code class="cpp">Synthesis::Synthesis(IPlugInstanceInfo instanceInfo) : IPLUG_CTOR(kNumParams, kNumPrograms, instanceInfo), lastVirtualKeyboardNoteNumber(virtualKeyboardMinimumNoteNumber - 1), filterEnvelopeAmount(0.0) { // ... }</code> <br> <br>       <code>Synthesis::Reset</code> : <br> <br> <code class="cpp">mFilterEnvelopeGenerator.setSampleRate(GetSampleRate());</code> <br> <br>      <code>EParams</code> ,       .  <code>AttachGraphics</code>     : <br> <br> <code class="cpp">// Knobs for filter envelope // Attack knob GetParam(mFilterAttack)-&gt;InitDouble("Filter Env Attack", 0.01, 0.01, 10.0, 0.001); GetParam(mFilterAttack)-&gt;SetShape(3); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 139, 178, mFilterAttack, &amp;smallKnobBitmap)); // Decay knob: GetParam(mFilterDecay)-&gt;InitDouble("Filter Env Decay", 0.5, 0.01, 15.0, 0.001); GetParam(mFilterDecay)-&gt;SetShape(3); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 195, 178, mFilterDecay, &amp;smallKnobBitmap)); // Sustain knob: GetParam(mFilterSustain)-&gt;InitDouble("Filter Env Sustain", 0.1, 0.001, 1.0, 0.001); GetParam(mFilterSustain)-&gt;SetShape(2); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 251, 178, mFilterSustain, &amp;smallKnobBitmap)); // Release knob: GetParam(mFilterRelease)-&gt;InitDouble("Filter Env Release", 1.0, 0.001, 15.0, 0.001); GetParam(mFilterRelease)-&gt;SetShape(3); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 307, 178, mFilterRelease, &amp;smallKnobBitmap)); // Filter envelope amount knob: GetParam(mFilterEnvelopeAmount)-&gt;InitDouble("Filter Env Amount", 0.0, -1.0, 1.0, 0.001); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 363, 178, mFilterEnvelopeAmount, &amp;smallKnobBitmap));</code> <br> <br>     ,       <code>smallKnobBitmap</code> .                   .     ,    .  <code>Synthesis::OnParamChange</code>    <code>switch</code> : <br> <br> <code class="cpp">case mFilterAttack: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK, GetParam(paramIdx)-&gt;Value()); break; case mFilterDecay: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_DECAY, GetParam(paramIdx)-&gt;Value()); break; case mFilterSustain: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_SUSTAIN, GetParam(paramIdx)-&gt;Value()); break; case mFilterRelease: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE, GetParam(paramIdx)-&gt;Value()); break; case mFilterEnvelopeAmount: filterEnvelopeAmount = GetParam(paramIdx)-&gt;Value(); break;</code> <br> <br> ! <br>     !           (-   C1),   : <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/f5d/757/3f9/f5d7573f9b3a720fe5898d88ae477cfc.png"> <br> <br>        <code>EnvelopeGenerator</code>  .         .        ! <br> <br>    <a href=""></a> . <br> <br>        :) <br> <br>  : <br> <a href="http://martin-finke.de/blog/articles/audio-plugins-013-filter/">martin-finke.de/blog/articles/audio-plugins-013-filter</a></code></code> <pre> <code class="hljs erlang-repl"><code class="cpp">#include  <i>Filter.h</i> ( )     : <br> <br> class Filter { public: enum FilterMode { FILTER_MODE_LOWPASS = <span class="hljs-number"><span class="hljs-number">0</span></span>, FILTER_MODE_HIGHPASS, FILTER_MODE_BANDPASS, kNumFilterModes }; Filter() : cutoff(<span class="hljs-number"><span class="hljs-number">0.99</span></span>), resonance(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), mode(FILTER_MODE_LOWPASS), buf0(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), buf1(<span class="hljs-number"><span class="hljs-number">0.0</span></span>) { calculateFeedbackAmount(); }; double process(double inputValue); inline void setCutoff(double newCutoff) { cutoff = newCutoff; calculateFeedbackAmount(); }; inline void setResonance(double newResonance) { resonance = newResonance; calculateFeedbackAmount(); }; inline void setFilterMode(FilterMode newMode) { mode = newMode; } private: double cutoff; double resonance; FilterMode mode; double feedbackAmount; inline void calculateFeedbackAmount() { feedbackAmount = resonance + resonance/(<span class="hljs-number"><span class="hljs-number">1.0</span></span> - cutoff); } double buf0; double buf1; };</code> <br> <br>  <code>private</code>     <i> </i> <code>cutoff</code>  <i></i> <code>resonance</code> . <code>Mode</code>      (Lowpass, Highpass, Bandpass).  <code>feedbackAmount</code> , <code>buf0</code>  <code>buf1</code>    ,    . <br>          ( <code>calculateFeedbackAmount()</code> ).  <code>process</code>      .   <code>feedbackAmount</code>   <code>cutoff</code>  <code>resonance</code> ,    <code>calculateFeedbackAmount</code>      . <br> <br>   <i>Filter.cpp</i>  : <br> <br> <code class="cpp">// By Paul Kellett // http://www.musicdsp.org/showone.php?id=<span class="hljs-number"><span class="hljs-number">29</span></span> double Filter::process(double inputValue) { buf0 += cutoff * (inputValue - buf0); buf1 += cutoff * (buf0 - buf1); switch (mode) { case FILTER_MODE_LOWPASS: return buf1; case FILTER_MODE_HIGHPASS: return inputValue - buf0; case FILTER_MODE_BANDPASS: return buf0 - buf1; default: return <span class="hljs-number"><span class="hljs-number">0.0</span></span>; } }</code> <br> <br> , ?  ,         <i> </i> . ¬´ ¬ª   ,               (. .    <span class="hljs-number"><span class="hljs-number">6</span></span> ).     <code>buf0</code>  <code>buf1</code> :        .     <code>inputValue</code> ,  - <code>buf0</code> (  ).   .    <span class="hljs-number"><span class="hljs-number">6</span></span> /   <span class="hljs-number"><span class="hljs-number">12</span></span> /.  <code>switch</code> ,  <code>buf1</code>    . , ,    <code>buf0</code> ,       <span class="hljs-number"><span class="hljs-number">12</span></span>,   <span class="hljs-number"><span class="hljs-number">6</span></span> /,        . <br> <br>  <code>case</code> <code>FILTER_MODE_HIGHPASS</code>    . <code>buf0</code>       .   <code>inputValue</code>  <code>buf0</code> ,   .    <code>buf1</code> ,     . <br> <br>  <code>case</code> <code>FILTER_MODE_BANDPASS</code> ,  <code>buf0 - buf1</code>   .  <code>buf0</code>       ,     <code>buf1</code> . ,   . <br>  :    <i> </i>    <i> </i> ,   . <br> <br>  <code>buf1</code>     .       <a href="http://ru.wikipedia.org/wiki/%25D0%25A4%25D0%25B8%25D0%25BB%25D1%258C%25D1%2582%25D1%2580_%25D1%2581_%25D0%25B1%25D0%25B5%25D1%2581%25D0%25BA%25D0%25BE%25D0%25BD%25D0%25B5%25D1%2587%25D0%25BD%25D0%25BE%25D0%25B9_%25D0%25B8%25D0%25BC%25D0%25BF%25D1%2583%25D0%25BB%25D1%258C%25D1%2581%25D0%25BD%25D0%25BE%25D0%25B9_%25D1%2585%25D0%25B0%25D1%2580%25D0%25B0%25D0%25BA%25D1%2582%25D0%25B5%25D1%2580%25D0%25B8%25D1%2581%25D1%2582%25D0%25B8%25D0%25BA%25D0%25BE%25D0%25B9">    </a> ( <i>Infinite Impulse Response</i> ,  <i>IIR</i> ).  <a href="http://www.dspguide.com/ch14/1.htm"> </a> ,      .      ,         ,      . <br> <br>   <br>       ,     ,     .   ,  ,      ,  ,          .           ,  NI Massive,   ¬´ <a href="http://lurkmore.to/%25D0%25A2%25D1%2591%25D0%25BF%25D0%25BB%25D1%258B%25D0%25B9_%25D0%25BB%25D0%25B0%25D0%25BC%25D0%25BF%25D0%25BE%25D0%25B2%25D1%258B%25D0%25B9_%25D0%25B7%25D0%25B2%25D1%2583%25D0%25BA">  </a> ¬ª.       ,          ,   .        ,          (  Massive       ).      ¬´¬ª , , , AAS Ultra Analog,       ,     ,    ,        .         ,  ,    <a href="http://www.kvraudio.com/forum/viewtopic.php%3Ft%3D350246"></a> ,   ,      NI Reaktor. ,            ‚Äî    ,    ..     . <br> <br>   <br>     .   GUI.  <i>bg.png</i>   ( <i>‚ÄúMove to trash‚Äù</i>  Xcode),       : <br> <br> <a href="">filtermode.png</a> <a href="">knob_small.png</a> (  ,   <span class="hljs-number"><span class="hljs-number">50</span></span> <span class="hljs-number"><span class="hljs-number">50</span></span> ) <a href="">bg.png</a> (       ) <br> <br>    ID  <i>resource.h</i> : <br> <br> <code class="cpp">// Unique IDs for each image resource. #define BG_ID <span class="hljs-number"><span class="hljs-number">101</span></span> #define WHITE_KEY_ID <span class="hljs-number"><span class="hljs-number">102</span></span> #define BLACK_KEY_ID <span class="hljs-number"><span class="hljs-number">103</span></span> #define WAVEFORM_ID <span class="hljs-number"><span class="hljs-number">104</span></span> #define KNOB_ID <span class="hljs-number"><span class="hljs-number">105</span></span> #define KNOB_SMALL_ID <span class="hljs-number"><span class="hljs-number">106</span></span> #define FILTERMODE_ID <span class="hljs-number"><span class="hljs-number">107</span></span> // Image resource locations for this plug. #define BG_FN <span class="hljs-string"><span class="hljs-string">"resources/img/bg.png"</span></span> #define WHITE_KEY_FN <span class="hljs-string"><span class="hljs-string">"resources/img/whitekey.png"</span></span> #define BLACK_KEY_FN <span class="hljs-string"><span class="hljs-string">"resources/img/blackkey.png"</span></span> #define WAVEFORM_FN <span class="hljs-string"><span class="hljs-string">"resources/img/waveform.png"</span></span> #define KNOB_FN <span class="hljs-string"><span class="hljs-string">"resources/img/knob.png"</span></span> #define KNOB_SMALL_FN <span class="hljs-string"><span class="hljs-string">"resources/img/knob_small.png"</span></span> #define FILTERMODE_FN <span class="hljs-string"><span class="hljs-string">"resources/img/filtermode.png"</span></span></code> <br> <br>  <i>Synthesis.rc</i> : <br> <br> <code class="cpp">#include <span class="hljs-string"><span class="hljs-string">"resource.h"</span></span> BG_ID PNG BG_FN WHITE_KEY_ID PNG WHITE_KEY_FN BLACK_KEY_ID PNG BLACK_KEY_FN WAVEFORM_ID PNG WAVEFORM_FN KNOB_ID PNG KNOB_FN KNOB_SMALL_ID PNG KNOB_SMALL_FN FILTERMODE_ID PNG FILTERMODE_FN</code> <br> <br>   <code>#include <span class="hljs-string"><span class="hljs-string">"Filter.h"</span></span></code>  <i>Synthesis.h</i>    <code>private</code> : <br> <br> <code class="cpp">Filter mFilter;</code> <br> <br>  <code>EParams</code>  <i>Synthesis.cpp</i> : <br> <br> <code class="cpp">enum EParams { mWaveform = <span class="hljs-number"><span class="hljs-number">0</span></span>, mAttack, mDecay, mSustain, mRelease, mFilterMode, mFilterCutoff, mFilterResonance, mFilterAttack, mFilterDecay, mFilterSustain, mFilterRelease, mFilterEnvelopeAmount, kNumParams };</code> <br> <br>        : <br> <br> <code class="cpp">pGraphics-&gt;AttachControl(new ISwitchControl(this, <span class="hljs-number"><span class="hljs-number">24</span></span>, <span class="hljs-number"><span class="hljs-number">38</span></span>, mWaveform, &amp;waveformBitmap));</code> <br> <br>      .      (Lowpass, Highpass, Bandpass).    <code>AttachGraphics(pGraphics)</code> : <br> <br> <code class="cpp">GetParam(mFilterMode)-&gt;InitEnum(<span class="hljs-string"><span class="hljs-string">"Filter Mode"</span></span>, Filter::FILTER_MODE_LOWPASS, Filter::kNumFilterModes); IBitmap filtermodeBitmap = pGraphics-&gt;LoadIBitmap(FILTERMODE_ID, FILTERMODE_FN, <span class="hljs-number"><span class="hljs-number">3</span></span>); pGraphics-&gt;AttachControl(new ISwitchControl(this, <span class="hljs-number"><span class="hljs-number">24</span></span>, <span class="hljs-number"><span class="hljs-number">123</span></span>, mFilterMode, &amp;filtermodeBitmap));</code> <br> <br>         .    .     <i>knob_small.png</i> : <br> <br> <code class="cpp">// Knobs for filter cutoff and resonance IBitmap smallKnobBitmap = pGraphics-&gt;LoadIBitmap(KNOB_SMALL_ID, KNOB_SMALL_FN, <span class="hljs-number"><span class="hljs-number">64</span></span>); // Cutoff knob: GetParam(mFilterCutoff)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Cutoff"</span></span>, <span class="hljs-number"><span class="hljs-number">0.99</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">0.99</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); GetParam(mFilterCutoff)-&gt;SetShape(<span class="hljs-number"><span class="hljs-number">2</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-number"><span class="hljs-number">177</span></span>, mFilterCutoff, &amp;smallKnobBitmap)); // Resonance knob: GetParam(mFilterResonance)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Resonance"</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">61</span></span>, <span class="hljs-number"><span class="hljs-number">177</span></span>, mFilterResonance, &amp;smallKnobBitmap));</code> <br> <br>   ,           <code><span class="hljs-number"><span class="hljs-number">1.0</span></span></code> ,   <code>calculateFeedbackAmount</code>    , . <br>  <code>ProcessDoubleReplacing</code>     : <br> <br> <code class="cpp">leftOutput[i] = rightOutput[i] = mFilter.process(mOscillator.nextSample() * mEnvelopeGenerator.nextSample() * velocity / <span class="hljs-number"><span class="hljs-number">127.0</span></span>);</code> <br> <br>       .  <code>switch</code>   <code>Synthesis::OnParamChange</code> : <br> <br> <code class="cpp">case mFilterCutoff: mFilter.setCutoff(GetParam(paramIdx)-&gt;Value()); break; case mFilterResonance: mFilter.setResonance(GetParam(paramIdx)-&gt;Value()); break; case mFilterMode: mFilter.setFilterMode(static_cast&lt;Filter::FilterMode&gt;(GetParam(paramIdx)-&gt;Int())); break;</code> <br> <br>    .  -      . <br> <br>  <br> <br>  ‚Äî      .   ,   ,          . <br>      : <br> <br> <code class="cpp">buf0 += cutoff * (inputValue - buf0 + feedbackAmount * (buf0 - buf1));</code> <br> <br> ,   ,      ( <code>buf0 ‚Äì buf1</code> ),   <code>feedbackAmount</code> .    <code>calculateFeedbackAmount</code>  <code>feedbackAmount</code>  <code>resonance</code> , . .    ,   . <br> <br>  ,            .     ,  <i></i> ,      <a href="https://www.youtube.com/watch%3Fv%3DJWyMj6KxGHM"> </a> .    ,        ,       . <br> <br>  -<span class="hljs-number"><span class="hljs-number">12</span></span> /  -<span class="hljs-number"><span class="hljs-number">24</span></span> / <br>        !     <span class="hljs-number"><span class="hljs-number">24</span></span>   .     <code>switch</code>  <code>Filter::process</code> : <br> <br> <code class="cpp">buf2 += cutoff * (buf1 - buf2); buf3 += cutoff * (buf2 ‚Äì buf3);</code> <br> <br>   :      ,       ,            .     ,       , , <a href="https://ccrma.stanford.edu/~Jos/filters/Filter_Stability.html"></a> (       ).     <code>switch</code> : <br> <br> <code class="cpp">switch (mode) { case FILTER_MODE_LOWPASS: return buf3; case FILTER_MODE_HIGHPASS: return inputValue - buf3; case FILTER_MODE_BANDPASS: return buf0 - buf3; default: return <span class="hljs-number"><span class="hljs-number">0.0</span></span>; }</code> <br> <br>   <code>buf1</code>  <code>buf3</code> ‚Äì      .    -<span class="hljs-number"><span class="hljs-number">24</span></span> /.     <code>buf2</code>  <code>buf3</code> ,        <code>private</code> <i>Filter.h</i> : <br> <br> <code class="cpp">double buf2; double buf3;</code> <br> <br>    ,   <code>buf0</code> c <code>buf1</code> : <br> <br> <code class="cpp">Filter() : // ... buf0(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), buf1(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), buf2(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), buf3(<span class="hljs-number"><span class="hljs-number">0.0</span></span>) // ...</code> <br> <br>     , ,     :     .       . <br>          ? <br> <br>   <br>    .  ,           ,       . <br> -      <code>cutoff</code>   .      .    <code>cutoffMod</code> ,    ,       <code>cutoff</code>    .     <code><code>#include    private</code> : <br> <br> <code class="cpp">double cutoffMod;</code> <br> <br> : <br> <br> <code class="cpp">Filter() : cutoff(<span class="hljs-number"><span class="hljs-number">0.99</span></span>), resonance(<span class="hljs-number"><span class="hljs-number">0.01</span></span>), cutoffMod(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), // ...</code> <br> <br>         .   <code>private</code> : <br> <br> <code class="cpp">inline double getCalculatedCutoff() const { return fmax(fmin(cutoff + cutoffMod, <span class="hljs-number"><span class="hljs-number">0.99</span></span>), <span class="hljs-number"><span class="hljs-number">0.01</span></span>); };</code> <br> <br> <code>calculateFeedbackAmount</code>     : <br> <br> <code class="cpp">inline void calculateFeedbackAmount() { feedbackAmount = resonance + resonance/(<span class="hljs-number"><span class="hljs-number">1.0</span></span> - getCalculatedCutoff()); }</code> <br> <br>       <code>cutoffMod</code> .   <code>feedbackAmount</code>    ,     : <br> <br> <code class="cpp">inline void setCutoffMod(double newCutoffMod) { cutoffMod = newCutoffMod; calculateFeedbackAmount(); }</code> <br> <br> ,       .   <code>Filter::process</code>   : <br> <br> <code class="cpp">if (inputValue == <span class="hljs-number"><span class="hljs-number">0.0</span></span>) return inputValue; double calculatedCutoff = getCalculatedCutoff(); buf0 += calculatedCutoff * (inputValue - buf0 + feedbackAmount * (buf0 - buf1)); buf1 += calculatedCutoff * (buf0 - buf1); buf2 += calculatedCutoff * (buf1 - buf2); buf3 += calculatedCutoff * (buf2 ‚Äì buf3);</code> <br> <br>        ,    .    ,      ,   .     .     <code>cutoff</code>  <code>calculatedCutoff</code>   -. <br> <br> ,       ( <code>setCutoffMod</code> ),   <code>Synthesis</code>    ,     ,    .    ,        <code>cutoffMod</code> .    <code>filterEnvelopeAmount</code>    <code>-<span class="hljs-number"><span class="hljs-number">1</span></span></code>  <code>+<span class="hljs-number"><span class="hljs-number">1</span></span></code> .   GUI. <br> <br>   <code>private</code> <i>Synthesis.h</i>    : <br> <br> <code class="cpp">EnvelopeGenerator mFilterEnvelopeGenerator; double filterEnvelopeAmount;</code> <br> <br>       MIDI ,      <code>onNoteOn</code>  <code>onNoteOff</code> : <br> <br> <code class="cpp">inline void onNoteOn(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); mFilterEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); }; inline void onNoteOff(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); mFilterEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); };</code> <br> <br>    .   <code>ProcessDoubleReplacing</code>        : <br> <br> <code class="cpp">mFilter.setCutoffMod(mFilterEnvelopeGenerator.nextSample() * filterEnvelopeAmount);</code> <br> <br>  ,        <code>nextSample</code>  <code>filterEnvelopeAmount</code>     <code>cutoffMod</code> .     <code>filterEnvelopeAmount</code>  : <br> <br> <code class="cpp">Synthesis::Synthesis(IPlugInstanceInfo instanceInfo) : IPLUG_CTOR(kNumParams, kNumPrograms, instanceInfo), lastVirtualKeyboardNoteNumber(virtualKeyboardMinimumNoteNumber - <span class="hljs-number"><span class="hljs-number">1</span></span>), filterEnvelopeAmount(<span class="hljs-number"><span class="hljs-number">0.0</span></span>) { // ... }</code> <br> <br>       <code>Synthesis::Reset</code> : <br> <br> <code class="cpp">mFilterEnvelopeGenerator.setSampleRate(GetSampleRate());</code> <br> <br>      <code>EParams</code> ,       .  <code>AttachGraphics</code>     : <br> <br> <code class="cpp">// Knobs for filter envelope // Attack knob GetParam(mFilterAttack)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Filter Env Attack"</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">10.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); GetParam(mFilterAttack)-&gt;SetShape(<span class="hljs-number"><span class="hljs-number">3</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">139</span></span>, <span class="hljs-number"><span class="hljs-number">178</span></span>, mFilterAttack, &amp;smallKnobBitmap)); // Decay knob: GetParam(mFilterDecay)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Filter Env Decay"</span></span>, <span class="hljs-number"><span class="hljs-number">0.5</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">15.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); GetParam(mFilterDecay)-&gt;SetShape(<span class="hljs-number"><span class="hljs-number">3</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">195</span></span>, <span class="hljs-number"><span class="hljs-number">178</span></span>, mFilterDecay, &amp;smallKnobBitmap)); // Sustain knob: GetParam(mFilterSustain)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Filter Env Sustain"</span></span>, <span class="hljs-number"><span class="hljs-number">0.1</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>, <span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); GetParam(mFilterSustain)-&gt;SetShape(<span class="hljs-number"><span class="hljs-number">2</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">251</span></span>, <span class="hljs-number"><span class="hljs-number">178</span></span>, mFilterSustain, &amp;smallKnobBitmap)); // Release knob: GetParam(mFilterRelease)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Filter Env Release"</span></span>, <span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>, <span class="hljs-number"><span class="hljs-number">15.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); GetParam(mFilterRelease)-&gt;SetShape(<span class="hljs-number"><span class="hljs-number">3</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">307</span></span>, <span class="hljs-number"><span class="hljs-number">178</span></span>, mFilterRelease, &amp;smallKnobBitmap)); // Filter envelope amount knob: GetParam(mFilterEnvelopeAmount)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Filter Env Amount"</span></span>, <span class="hljs-number"><span class="hljs-number">0.0</span></span>, -<span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">363</span></span>, <span class="hljs-number"><span class="hljs-number">178</span></span>, mFilterEnvelopeAmount, &amp;smallKnobBitmap));</code> <br> <br>     ,       <code>smallKnobBitmap</code> .                   .     ,    .  <code>Synthesis::OnParamChange</code>    <code>switch</code> : <br> <br> <code class="cpp">case mFilterAttack: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK, GetParam(paramIdx)-&gt;Value()); break; case mFilterDecay: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_DECAY, GetParam(paramIdx)-&gt;Value()); break; case mFilterSustain: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_SUSTAIN, GetParam(paramIdx)-&gt;Value()); break; case mFilterRelease: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE, GetParam(paramIdx)-&gt;Value()); break; case mFilterEnvelopeAmount: filterEnvelopeAmount = GetParam(paramIdx)-&gt;Value(); break;</code> <br> <br> ! <br>     !           (-   C1),   : <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/f5d/757/3f9/f5d7573f9b3a720fe5898d88ae477cfc.png"> <br> <br>        <code>EnvelopeGenerator</code>  .         .        ! <br> <br>    <a href=""></a> . <br> <br>        :) <br> <br>  : <br> <a href="http://martin-finke.de/blog/articles/audio-plugins-013-filter/">martin-finke.de/blog/articles/audio-plugins-<span class="hljs-number"><span class="hljs-number">013</span></span>-filter</a></code></code> </pre> <code><code><code class="cpp">#include  <i>Filter.h</i> ( )     : <br> <br> class Filter { public: enum FilterMode { FILTER_MODE_LOWPASS = 0, FILTER_MODE_HIGHPASS, FILTER_MODE_BANDPASS, kNumFilterModes }; Filter() : cutoff(0.99), resonance(0.0), mode(FILTER_MODE_LOWPASS), buf0(0.0), buf1(0.0) { calculateFeedbackAmount(); }; double process(double inputValue); inline void setCutoff(double newCutoff) { cutoff = newCutoff; calculateFeedbackAmount(); }; inline void setResonance(double newResonance) { resonance = newResonance; calculateFeedbackAmount(); }; inline void setFilterMode(FilterMode newMode) { mode = newMode; } private: double cutoff; double resonance; FilterMode mode; double feedbackAmount; inline void calculateFeedbackAmount() { feedbackAmount = resonance + resonance/(1.0 - cutoff); } double buf0; double buf1; };</code> <br> <br>  <code>private</code>     <i> </i> <code>cutoff</code>  <i></i> <code>resonance</code> . <code>Mode</code>      (Lowpass, Highpass, Bandpass).  <code>feedbackAmount</code> , <code>buf0</code>  <code>buf1</code>    ,    . <br>          ( <code>calculateFeedbackAmount()</code> ).  <code>process</code>      .   <code>feedbackAmount</code>   <code>cutoff</code>  <code>resonance</code> ,    <code>calculateFeedbackAmount</code>      . <br> <br>   <i>Filter.cpp</i>  : <br> <br> <code class="cpp">// By Paul Kellett // http://www.musicdsp.org/showone.php?id=29 double Filter::process(double inputValue) { buf0 += cutoff * (inputValue - buf0); buf1 += cutoff * (buf0 - buf1); switch (mode) { case FILTER_MODE_LOWPASS: return buf1; case FILTER_MODE_HIGHPASS: return inputValue - buf0; case FILTER_MODE_BANDPASS: return buf0 - buf1; default: return 0.0; } }</code> <br> <br> , ?  ,         <i> </i> . ¬´ ¬ª   ,               (. .    6 ).     <code>buf0</code>  <code>buf1</code> :        .     <code>inputValue</code> ,  - <code>buf0</code> (  ).   .    6 /   12 /.  <code>switch</code> ,  <code>buf1</code>    . , ,    <code>buf0</code> ,       12,   6 /,        . <br> <br>  <code>case</code> <code>FILTER_MODE_HIGHPASS</code>    . <code>buf0</code>       .   <code>inputValue</code>  <code>buf0</code> ,   .    <code>buf1</code> ,     . <br> <br>  <code>case</code> <code>FILTER_MODE_BANDPASS</code> ,  <code>buf0 - buf1</code>   .  <code>buf0</code>       ,     <code>buf1</code> . ,   . <br>  :    <i> </i>    <i> </i> ,   . <br> <br>  <code>buf1</code>     .       <a href="http://ru.wikipedia.org/wiki/%25D0%25A4%25D0%25B8%25D0%25BB%25D1%258C%25D1%2582%25D1%2580_%25D1%2581_%25D0%25B1%25D0%25B5%25D1%2581%25D0%25BA%25D0%25BE%25D0%25BD%25D0%25B5%25D1%2587%25D0%25BD%25D0%25BE%25D0%25B9_%25D0%25B8%25D0%25BC%25D0%25BF%25D1%2583%25D0%25BB%25D1%258C%25D1%2581%25D0%25BD%25D0%25BE%25D0%25B9_%25D1%2585%25D0%25B0%25D1%2580%25D0%25B0%25D0%25BA%25D1%2582%25D0%25B5%25D1%2580%25D0%25B8%25D1%2581%25D1%2582%25D0%25B8%25D0%25BA%25D0%25BE%25D0%25B9">    </a> ( <i>Infinite Impulse Response</i> ,  <i>IIR</i> ).  <a href="http://www.dspguide.com/ch14/1.htm"> </a> ,      .      ,         ,      . <br> <br>   <br>       ,     ,     .   ,  ,      ,  ,          .           ,  NI Massive,   ¬´ <a href="http://lurkmore.to/%25D0%25A2%25D1%2591%25D0%25BF%25D0%25BB%25D1%258B%25D0%25B9_%25D0%25BB%25D0%25B0%25D0%25BC%25D0%25BF%25D0%25BE%25D0%25B2%25D1%258B%25D0%25B9_%25D0%25B7%25D0%25B2%25D1%2583%25D0%25BA">  </a> ¬ª.       ,          ,   .        ,          (  Massive       ).      ¬´¬ª , , , AAS Ultra Analog,       ,     ,    ,        .         ,  ,    <a href="http://www.kvraudio.com/forum/viewtopic.php%3Ft%3D350246"></a> ,   ,      NI Reaktor. ,            ‚Äî    ,    ..     . <br> <br>   <br>     .   GUI.  <i>bg.png</i>   ( <i>‚ÄúMove to trash‚Äù</i>  Xcode),       : <br> <br> <a href="">filtermode.png</a> <a href="">knob_small.png</a> (  ,   50 50 ) <a href="">bg.png</a> (       ) <br> <br>    ID  <i>resource.h</i> : <br> <br> <code class="cpp">// Unique IDs for each image resource. #define BG_ID 101 #define WHITE_KEY_ID 102 #define BLACK_KEY_ID 103 #define WAVEFORM_ID 104 #define KNOB_ID 105 #define KNOB_SMALL_ID 106 #define FILTERMODE_ID 107 // Image resource locations for this plug. #define BG_FN "resources/img/bg.png" #define WHITE_KEY_FN "resources/img/whitekey.png" #define BLACK_KEY_FN "resources/img/blackkey.png" #define WAVEFORM_FN "resources/img/waveform.png" #define KNOB_FN "resources/img/knob.png" #define KNOB_SMALL_FN "resources/img/knob_small.png" #define FILTERMODE_FN "resources/img/filtermode.png"</code> <br> <br>  <i>Synthesis.rc</i> : <br> <br> <code class="cpp">#include "resource.h" BG_ID PNG BG_FN WHITE_KEY_ID PNG WHITE_KEY_FN BLACK_KEY_ID PNG BLACK_KEY_FN WAVEFORM_ID PNG WAVEFORM_FN KNOB_ID PNG KNOB_FN KNOB_SMALL_ID PNG KNOB_SMALL_FN FILTERMODE_ID PNG FILTERMODE_FN</code> <br> <br>   <code>#include "Filter.h"</code>  <i>Synthesis.h</i>    <code>private</code> : <br> <br> <code class="cpp">Filter mFilter;</code> <br> <br>  <code>EParams</code>  <i>Synthesis.cpp</i> : <br> <br> <code class="cpp">enum EParams { mWaveform = 0, mAttack, mDecay, mSustain, mRelease, mFilterMode, mFilterCutoff, mFilterResonance, mFilterAttack, mFilterDecay, mFilterSustain, mFilterRelease, mFilterEnvelopeAmount, kNumParams };</code> <br> <br>        : <br> <br> <code class="cpp">pGraphics-&gt;AttachControl(new ISwitchControl(this, 24, 38, mWaveform, &amp;waveformBitmap));</code> <br> <br>      .      (Lowpass, Highpass, Bandpass).    <code>AttachGraphics(pGraphics)</code> : <br> <br> <code class="cpp">GetParam(mFilterMode)-&gt;InitEnum("Filter Mode", Filter::FILTER_MODE_LOWPASS, Filter::kNumFilterModes); IBitmap filtermodeBitmap = pGraphics-&gt;LoadIBitmap(FILTERMODE_ID, FILTERMODE_FN, 3); pGraphics-&gt;AttachControl(new ISwitchControl(this, 24, 123, mFilterMode, &amp;filtermodeBitmap));</code> <br> <br>         .    .     <i>knob_small.png</i> : <br> <br> <code class="cpp">// Knobs for filter cutoff and resonance IBitmap smallKnobBitmap = pGraphics-&gt;LoadIBitmap(KNOB_SMALL_ID, KNOB_SMALL_FN, 64); // Cutoff knob: GetParam(mFilterCutoff)-&gt;InitDouble("Cutoff", 0.99, 0.01, 0.99, 0.001); GetParam(mFilterCutoff)-&gt;SetShape(2); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 5, 177, mFilterCutoff, &amp;smallKnobBitmap)); // Resonance knob: GetParam(mFilterResonance)-&gt;InitDouble("Resonance", 0.01, 0.01, 1.0, 0.001); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 61, 177, mFilterResonance, &amp;smallKnobBitmap));</code> <br> <br>   ,           <code>1.0</code> ,   <code>calculateFeedbackAmount</code>    , . <br>  <code>ProcessDoubleReplacing</code>     : <br> <br> <code class="cpp">leftOutput[i] = rightOutput[i] = mFilter.process(mOscillator.nextSample() * mEnvelopeGenerator.nextSample() * velocity / 127.0);</code> <br> <br>       .  <code>switch</code>   <code>Synthesis::OnParamChange</code> : <br> <br> <code class="cpp">case mFilterCutoff: mFilter.setCutoff(GetParam(paramIdx)-&gt;Value()); break; case mFilterResonance: mFilter.setResonance(GetParam(paramIdx)-&gt;Value()); break; case mFilterMode: mFilter.setFilterMode(static_cast&lt;Filter::FilterMode&gt;(GetParam(paramIdx)-&gt;Int())); break;</code> <br> <br>    .  -      . <br> <br>  <br> <br>  ‚Äî      .   ,   ,          . <br>      : <br> <br> <code class="cpp">buf0 += cutoff * (inputValue - buf0 + feedbackAmount * (buf0 - buf1));</code> <br> <br> ,   ,      ( <code>buf0 ‚Äì buf1</code> ),   <code>feedbackAmount</code> .    <code>calculateFeedbackAmount</code>  <code>feedbackAmount</code>  <code>resonance</code> , . .    ,   . <br> <br>  ,            .     ,  <i></i> ,      <a href="https://www.youtube.com/watch%3Fv%3DJWyMj6KxGHM"> </a> .    ,        ,       . <br> <br>  -12 /  -24 / <br>        !     24   .     <code>switch</code>  <code>Filter::process</code> : <br> <br> <code class="cpp">buf2 += cutoff * (buf1 - buf2); buf3 += cutoff * (buf2 ‚Äì buf3);</code> <br> <br>   :      ,       ,            .     ,       , , <a href="https://ccrma.stanford.edu/~Jos/filters/Filter_Stability.html"></a> (       ).     <code>switch</code> : <br> <br> <code class="cpp">switch (mode) { case FILTER_MODE_LOWPASS: return buf3; case FILTER_MODE_HIGHPASS: return inputValue - buf3; case FILTER_MODE_BANDPASS: return buf0 - buf3; default: return 0.0; }</code> <br> <br>   <code>buf1</code>  <code>buf3</code> ‚Äì      .    -24 /.     <code>buf2</code>  <code>buf3</code> ,        <code>private</code> <i>Filter.h</i> : <br> <br> <code class="cpp">double buf2; double buf3;</code> <br> <br>    ,   <code>buf0</code> c <code>buf1</code> : <br> <br> <code class="cpp">Filter() : // ... buf0(0.0), buf1(0.0), buf2(0.0), buf3(0.0) // ...</code> <br> <br>     , ,     :     .       . <br>          ? <br> <br>   <br>    .  ,           ,       . <br> -      <code>cutoff</code>   .      .    <code>cutoffMod</code> ,    ,       <code>cutoff</code>    .     <code>#include    private</code> : <br> <br> <code class="cpp">double cutoffMod;</code> <br> <br> : <br> <br> <code class="cpp">Filter() : cutoff(0.99), resonance(0.01), cutoffMod(0.0), // ...</code> <br> <br>         .   <code>private</code> : <br> <br> <code class="cpp">inline double getCalculatedCutoff() const { return fmax(fmin(cutoff + cutoffMod, 0.99), 0.01); };</code> <br> <br> <code>calculateFeedbackAmount</code>     : <br> <br> <code class="cpp">inline void calculateFeedbackAmount() { feedbackAmount = resonance + resonance/(1.0 - getCalculatedCutoff()); }</code> <br> <br>       <code>cutoffMod</code> .   <code>feedbackAmount</code>    ,     : <br> <br> <code class="cpp">inline void setCutoffMod(double newCutoffMod) { cutoffMod = newCutoffMod; calculateFeedbackAmount(); }</code> <br> <br> ,       .   <code>Filter::process</code>   : <br> <br> <code class="cpp">if (inputValue == 0.0) return inputValue; double calculatedCutoff = getCalculatedCutoff(); buf0 += calculatedCutoff * (inputValue - buf0 + feedbackAmount * (buf0 - buf1)); buf1 += calculatedCutoff * (buf0 - buf1); buf2 += calculatedCutoff * (buf1 - buf2); buf3 += calculatedCutoff * (buf2 ‚Äì buf3);</code> <br> <br>        ,    .    ,      ,   .     .     <code>cutoff</code>  <code>calculatedCutoff</code>   -. <br> <br> ,       ( <code>setCutoffMod</code> ),   <code>Synthesis</code>    ,     ,    .    ,        <code>cutoffMod</code> .    <code>filterEnvelopeAmount</code>    <code>-1</code>  <code>+1</code> .   GUI. <br> <br>   <code>private</code> <i>Synthesis.h</i>    : <br> <br> <code class="cpp">EnvelopeGenerator mFilterEnvelopeGenerator; double filterEnvelopeAmount;</code> <br> <br>       MIDI ,      <code>onNoteOn</code>  <code>onNoteOff</code> : <br> <br> <code class="cpp">inline void onNoteOn(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); mFilterEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); }; inline void onNoteOff(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); mFilterEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); };</code> <br> <br>    .   <code>ProcessDoubleReplacing</code>        : <br> <br> <code class="cpp">mFilter.setCutoffMod(mFilterEnvelopeGenerator.nextSample() * filterEnvelopeAmount);</code> <br> <br>  ,        <code>nextSample</code>  <code>filterEnvelopeAmount</code>     <code>cutoffMod</code> .     <code>filterEnvelopeAmount</code>  : <br> <br> <code class="cpp">Synthesis::Synthesis(IPlugInstanceInfo instanceInfo) : IPLUG_CTOR(kNumParams, kNumPrograms, instanceInfo), lastVirtualKeyboardNoteNumber(virtualKeyboardMinimumNoteNumber - 1), filterEnvelopeAmount(0.0) { // ... }</code> <br> <br>       <code>Synthesis::Reset</code> : <br> <br> <code class="cpp">mFilterEnvelopeGenerator.setSampleRate(GetSampleRate());</code> <br> <br>      <code>EParams</code> ,       .  <code>AttachGraphics</code>     : <br> <br> <code class="cpp">// Knobs for filter envelope // Attack knob GetParam(mFilterAttack)-&gt;InitDouble("Filter Env Attack", 0.01, 0.01, 10.0, 0.001); GetParam(mFilterAttack)-&gt;SetShape(3); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 139, 178, mFilterAttack, &amp;smallKnobBitmap)); // Decay knob: GetParam(mFilterDecay)-&gt;InitDouble("Filter Env Decay", 0.5, 0.01, 15.0, 0.001); GetParam(mFilterDecay)-&gt;SetShape(3); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 195, 178, mFilterDecay, &amp;smallKnobBitmap)); // Sustain knob: GetParam(mFilterSustain)-&gt;InitDouble("Filter Env Sustain", 0.1, 0.001, 1.0, 0.001); GetParam(mFilterSustain)-&gt;SetShape(2); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 251, 178, mFilterSustain, &amp;smallKnobBitmap)); // Release knob: GetParam(mFilterRelease)-&gt;InitDouble("Filter Env Release", 1.0, 0.001, 15.0, 0.001); GetParam(mFilterRelease)-&gt;SetShape(3); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 307, 178, mFilterRelease, &amp;smallKnobBitmap)); // Filter envelope amount knob: GetParam(mFilterEnvelopeAmount)-&gt;InitDouble("Filter Env Amount", 0.0, -1.0, 1.0, 0.001); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 363, 178, mFilterEnvelopeAmount, &amp;smallKnobBitmap));</code> <br> <br>     ,       <code>smallKnobBitmap</code> .                   .     ,    .  <code>Synthesis::OnParamChange</code>    <code>switch</code> : <br> <br> <code class="cpp">case mFilterAttack: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK, GetParam(paramIdx)-&gt;Value()); break; case mFilterDecay: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_DECAY, GetParam(paramIdx)-&gt;Value()); break; case mFilterSustain: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_SUSTAIN, GetParam(paramIdx)-&gt;Value()); break; case mFilterRelease: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE, GetParam(paramIdx)-&gt;Value()); break; case mFilterEnvelopeAmount: filterEnvelopeAmount = GetParam(paramIdx)-&gt;Value(); break;</code> <br> <br> ! <br>     !           (-   C1),   : <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/f5d/757/3f9/f5d7573f9b3a720fe5898d88ae477cfc.png"> <br> <br>        <code>EnvelopeGenerator</code>  .         .        ! <br> <br>    <a href=""></a> . <br> <br>        :) <br> <br>  : <br> <a href="http://martin-finke.de/blog/articles/audio-plugins-013-filter/">martin-finke.de/blog/articles/audio-plugins-013-filter</a></code></code> <pre> <code class="hljs erlang-repl"><code class="cpp">#include  <i>Filter.h</i> ( )     : <br> <br> class Filter { public: enum FilterMode { FILTER_MODE_LOWPASS = <span class="hljs-number"><span class="hljs-number">0</span></span>, FILTER_MODE_HIGHPASS, FILTER_MODE_BANDPASS, kNumFilterModes }; Filter() : cutoff(<span class="hljs-number"><span class="hljs-number">0.99</span></span>), resonance(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), mode(FILTER_MODE_LOWPASS), buf0(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), buf1(<span class="hljs-number"><span class="hljs-number">0.0</span></span>) { calculateFeedbackAmount(); }; double process(double inputValue); inline void setCutoff(double newCutoff) { cutoff = newCutoff; calculateFeedbackAmount(); }; inline void setResonance(double newResonance) { resonance = newResonance; calculateFeedbackAmount(); }; inline void setFilterMode(FilterMode newMode) { mode = newMode; } private: double cutoff; double resonance; FilterMode mode; double feedbackAmount; inline void calculateFeedbackAmount() { feedbackAmount = resonance + resonance/(<span class="hljs-number"><span class="hljs-number">1.0</span></span> - cutoff); } double buf0; double buf1; };</code> <br> <br>  <code>private</code>     <i> </i> <code>cutoff</code>  <i></i> <code>resonance</code> . <code>Mode</code>      (Lowpass, Highpass, Bandpass).  <code>feedbackAmount</code> , <code>buf0</code>  <code>buf1</code>    ,    . <br>          ( <code>calculateFeedbackAmount()</code> ).  <code>process</code>      .   <code>feedbackAmount</code>   <code>cutoff</code>  <code>resonance</code> ,    <code>calculateFeedbackAmount</code>      . <br> <br>   <i>Filter.cpp</i>  : <br> <br> <code class="cpp">// By Paul Kellett // http://www.musicdsp.org/showone.php?id=<span class="hljs-number"><span class="hljs-number">29</span></span> double Filter::process(double inputValue) { buf0 += cutoff * (inputValue - buf0); buf1 += cutoff * (buf0 - buf1); switch (mode) { case FILTER_MODE_LOWPASS: return buf1; case FILTER_MODE_HIGHPASS: return inputValue - buf0; case FILTER_MODE_BANDPASS: return buf0 - buf1; default: return <span class="hljs-number"><span class="hljs-number">0.0</span></span>; } }</code> <br> <br> , ?  ,         <i> </i> . ¬´ ¬ª   ,               (. .    <span class="hljs-number"><span class="hljs-number">6</span></span> ).     <code>buf0</code>  <code>buf1</code> :        .     <code>inputValue</code> ,  - <code>buf0</code> (  ).   .    <span class="hljs-number"><span class="hljs-number">6</span></span> /   <span class="hljs-number"><span class="hljs-number">12</span></span> /.  <code>switch</code> ,  <code>buf1</code>    . , ,    <code>buf0</code> ,       <span class="hljs-number"><span class="hljs-number">12</span></span>,   <span class="hljs-number"><span class="hljs-number">6</span></span> /,        . <br> <br>  <code>case</code> <code>FILTER_MODE_HIGHPASS</code>    . <code>buf0</code>       .   <code>inputValue</code>  <code>buf0</code> ,   .    <code>buf1</code> ,     . <br> <br>  <code>case</code> <code>FILTER_MODE_BANDPASS</code> ,  <code>buf0 - buf1</code>   .  <code>buf0</code>       ,     <code>buf1</code> . ,   . <br>  :    <i> </i>    <i> </i> ,   . <br> <br>  <code>buf1</code>     .       <a href="http://ru.wikipedia.org/wiki/%25D0%25A4%25D0%25B8%25D0%25BB%25D1%258C%25D1%2582%25D1%2580_%25D1%2581_%25D0%25B1%25D0%25B5%25D1%2581%25D0%25BA%25D0%25BE%25D0%25BD%25D0%25B5%25D1%2587%25D0%25BD%25D0%25BE%25D0%25B9_%25D0%25B8%25D0%25BC%25D0%25BF%25D1%2583%25D0%25BB%25D1%258C%25D1%2581%25D0%25BD%25D0%25BE%25D0%25B9_%25D1%2585%25D0%25B0%25D1%2580%25D0%25B0%25D0%25BA%25D1%2582%25D0%25B5%25D1%2580%25D0%25B8%25D1%2581%25D1%2582%25D0%25B8%25D0%25BA%25D0%25BE%25D0%25B9">    </a> ( <i>Infinite Impulse Response</i> ,  <i>IIR</i> ).  <a href="http://www.dspguide.com/ch14/1.htm"> </a> ,      .      ,         ,      . <br> <br>   <br>       ,     ,     .   ,  ,      ,  ,          .           ,  NI Massive,   ¬´ <a href="http://lurkmore.to/%25D0%25A2%25D1%2591%25D0%25BF%25D0%25BB%25D1%258B%25D0%25B9_%25D0%25BB%25D0%25B0%25D0%25BC%25D0%25BF%25D0%25BE%25D0%25B2%25D1%258B%25D0%25B9_%25D0%25B7%25D0%25B2%25D1%2583%25D0%25BA">  </a> ¬ª.       ,          ,   .        ,          (  Massive       ).      ¬´¬ª , , , AAS Ultra Analog,       ,     ,    ,        .         ,  ,    <a href="http://www.kvraudio.com/forum/viewtopic.php%3Ft%3D350246"></a> ,   ,      NI Reaktor. ,            ‚Äî    ,    ..     . <br> <br>   <br>     .   GUI.  <i>bg.png</i>   ( <i>‚ÄúMove to trash‚Äù</i>  Xcode),       : <br> <br> <a href="">filtermode.png</a> <a href="">knob_small.png</a> (  ,   <span class="hljs-number"><span class="hljs-number">50</span></span> <span class="hljs-number"><span class="hljs-number">50</span></span> ) <a href="">bg.png</a> (       ) <br> <br>    ID  <i>resource.h</i> : <br> <br> <code class="cpp">// Unique IDs for each image resource. #define BG_ID <span class="hljs-number"><span class="hljs-number">101</span></span> #define WHITE_KEY_ID <span class="hljs-number"><span class="hljs-number">102</span></span> #define BLACK_KEY_ID <span class="hljs-number"><span class="hljs-number">103</span></span> #define WAVEFORM_ID <span class="hljs-number"><span class="hljs-number">104</span></span> #define KNOB_ID <span class="hljs-number"><span class="hljs-number">105</span></span> #define KNOB_SMALL_ID <span class="hljs-number"><span class="hljs-number">106</span></span> #define FILTERMODE_ID <span class="hljs-number"><span class="hljs-number">107</span></span> // Image resource locations for this plug. #define BG_FN <span class="hljs-string"><span class="hljs-string">"resources/img/bg.png"</span></span> #define WHITE_KEY_FN <span class="hljs-string"><span class="hljs-string">"resources/img/whitekey.png"</span></span> #define BLACK_KEY_FN <span class="hljs-string"><span class="hljs-string">"resources/img/blackkey.png"</span></span> #define WAVEFORM_FN <span class="hljs-string"><span class="hljs-string">"resources/img/waveform.png"</span></span> #define KNOB_FN <span class="hljs-string"><span class="hljs-string">"resources/img/knob.png"</span></span> #define KNOB_SMALL_FN <span class="hljs-string"><span class="hljs-string">"resources/img/knob_small.png"</span></span> #define FILTERMODE_FN <span class="hljs-string"><span class="hljs-string">"resources/img/filtermode.png"</span></span></code> <br> <br>  <i>Synthesis.rc</i> : <br> <br> <code class="cpp">#include <span class="hljs-string"><span class="hljs-string">"resource.h"</span></span> BG_ID PNG BG_FN WHITE_KEY_ID PNG WHITE_KEY_FN BLACK_KEY_ID PNG BLACK_KEY_FN WAVEFORM_ID PNG WAVEFORM_FN KNOB_ID PNG KNOB_FN KNOB_SMALL_ID PNG KNOB_SMALL_FN FILTERMODE_ID PNG FILTERMODE_FN</code> <br> <br>   <code>#include <span class="hljs-string"><span class="hljs-string">"Filter.h"</span></span></code>  <i>Synthesis.h</i>    <code>private</code> : <br> <br> <code class="cpp">Filter mFilter;</code> <br> <br>  <code>EParams</code>  <i>Synthesis.cpp</i> : <br> <br> <code class="cpp">enum EParams { mWaveform = <span class="hljs-number"><span class="hljs-number">0</span></span>, mAttack, mDecay, mSustain, mRelease, mFilterMode, mFilterCutoff, mFilterResonance, mFilterAttack, mFilterDecay, mFilterSustain, mFilterRelease, mFilterEnvelopeAmount, kNumParams };</code> <br> <br>        : <br> <br> <code class="cpp">pGraphics-&gt;AttachControl(new ISwitchControl(this, <span class="hljs-number"><span class="hljs-number">24</span></span>, <span class="hljs-number"><span class="hljs-number">38</span></span>, mWaveform, &amp;waveformBitmap));</code> <br> <br>      .      (Lowpass, Highpass, Bandpass).    <code>AttachGraphics(pGraphics)</code> : <br> <br> <code class="cpp">GetParam(mFilterMode)-&gt;InitEnum(<span class="hljs-string"><span class="hljs-string">"Filter Mode"</span></span>, Filter::FILTER_MODE_LOWPASS, Filter::kNumFilterModes); IBitmap filtermodeBitmap = pGraphics-&gt;LoadIBitmap(FILTERMODE_ID, FILTERMODE_FN, <span class="hljs-number"><span class="hljs-number">3</span></span>); pGraphics-&gt;AttachControl(new ISwitchControl(this, <span class="hljs-number"><span class="hljs-number">24</span></span>, <span class="hljs-number"><span class="hljs-number">123</span></span>, mFilterMode, &amp;filtermodeBitmap));</code> <br> <br>         .    .     <i>knob_small.png</i> : <br> <br> <code class="cpp">// Knobs for filter cutoff and resonance IBitmap smallKnobBitmap = pGraphics-&gt;LoadIBitmap(KNOB_SMALL_ID, KNOB_SMALL_FN, <span class="hljs-number"><span class="hljs-number">64</span></span>); // Cutoff knob: GetParam(mFilterCutoff)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Cutoff"</span></span>, <span class="hljs-number"><span class="hljs-number">0.99</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">0.99</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); GetParam(mFilterCutoff)-&gt;SetShape(<span class="hljs-number"><span class="hljs-number">2</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-number"><span class="hljs-number">177</span></span>, mFilterCutoff, &amp;smallKnobBitmap)); // Resonance knob: GetParam(mFilterResonance)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Resonance"</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">61</span></span>, <span class="hljs-number"><span class="hljs-number">177</span></span>, mFilterResonance, &amp;smallKnobBitmap));</code> <br> <br>   ,           <code><span class="hljs-number"><span class="hljs-number">1.0</span></span></code> ,   <code>calculateFeedbackAmount</code>    , . <br>  <code>ProcessDoubleReplacing</code>     : <br> <br> <code class="cpp">leftOutput[i] = rightOutput[i] = mFilter.process(mOscillator.nextSample() * mEnvelopeGenerator.nextSample() * velocity / <span class="hljs-number"><span class="hljs-number">127.0</span></span>);</code> <br> <br>       .  <code>switch</code>   <code>Synthesis::OnParamChange</code> : <br> <br> <code class="cpp">case mFilterCutoff: mFilter.setCutoff(GetParam(paramIdx)-&gt;Value()); break; case mFilterResonance: mFilter.setResonance(GetParam(paramIdx)-&gt;Value()); break; case mFilterMode: mFilter.setFilterMode(static_cast&lt;Filter::FilterMode&gt;(GetParam(paramIdx)-&gt;Int())); break;</code> <br> <br>    .  -      . <br> <br>  <br> <br>  ‚Äî      .   ,   ,          . <br>      : <br> <br> <code class="cpp">buf0 += cutoff * (inputValue - buf0 + feedbackAmount * (buf0 - buf1));</code> <br> <br> ,   ,      ( <code>buf0 ‚Äì buf1</code> ),   <code>feedbackAmount</code> .    <code>calculateFeedbackAmount</code>  <code>feedbackAmount</code>  <code>resonance</code> , . .    ,   . <br> <br>  ,            .     ,  <i></i> ,      <a href="https://www.youtube.com/watch%3Fv%3DJWyMj6KxGHM"> </a> .    ,        ,       . <br> <br>  -<span class="hljs-number"><span class="hljs-number">12</span></span> /  -<span class="hljs-number"><span class="hljs-number">24</span></span> / <br>        !     <span class="hljs-number"><span class="hljs-number">24</span></span>   .     <code>switch</code>  <code>Filter::process</code> : <br> <br> <code class="cpp">buf2 += cutoff * (buf1 - buf2); buf3 += cutoff * (buf2 ‚Äì buf3);</code> <br> <br>   :      ,       ,            .     ,       , , <a href="https://ccrma.stanford.edu/~Jos/filters/Filter_Stability.html"></a> (       ).     <code>switch</code> : <br> <br> <code class="cpp">switch (mode) { case FILTER_MODE_LOWPASS: return buf3; case FILTER_MODE_HIGHPASS: return inputValue - buf3; case FILTER_MODE_BANDPASS: return buf0 - buf3; default: return <span class="hljs-number"><span class="hljs-number">0.0</span></span>; }</code> <br> <br>   <code>buf1</code>  <code>buf3</code> ‚Äì      .    -<span class="hljs-number"><span class="hljs-number">24</span></span> /.     <code>buf2</code>  <code>buf3</code> ,        <code>private</code> <i>Filter.h</i> : <br> <br> <code class="cpp">double buf2; double buf3;</code> <br> <br>    ,   <code>buf0</code> c <code>buf1</code> : <br> <br> <code class="cpp">Filter() : // ... buf0(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), buf1(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), buf2(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), buf3(<span class="hljs-number"><span class="hljs-number">0.0</span></span>) // ...</code> <br> <br>     , ,     :     .       . <br>          ? <br> <br>   <br>    .  ,           ,       . <br> -      <code>cutoff</code>   .      .    <code>cutoffMod</code> ,    ,       <code>cutoff</code>    .     <code><code>#include    private</code> : <br> <br> <code class="cpp">double cutoffMod;</code> <br> <br> : <br> <br> <code class="cpp">Filter() : cutoff(<span class="hljs-number"><span class="hljs-number">0.99</span></span>), resonance(<span class="hljs-number"><span class="hljs-number">0.01</span></span>), cutoffMod(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), // ...</code> <br> <br>         .   <code>private</code> : <br> <br> <code class="cpp">inline double getCalculatedCutoff() const { return fmax(fmin(cutoff + cutoffMod, <span class="hljs-number"><span class="hljs-number">0.99</span></span>), <span class="hljs-number"><span class="hljs-number">0.01</span></span>); };</code> <br> <br> <code>calculateFeedbackAmount</code>     : <br> <br> <code class="cpp">inline void calculateFeedbackAmount() { feedbackAmount = resonance + resonance/(<span class="hljs-number"><span class="hljs-number">1.0</span></span> - getCalculatedCutoff()); }</code> <br> <br>       <code>cutoffMod</code> .   <code>feedbackAmount</code>    ,     : <br> <br> <code class="cpp">inline void setCutoffMod(double newCutoffMod) { cutoffMod = newCutoffMod; calculateFeedbackAmount(); }</code> <br> <br> ,       .   <code>Filter::process</code>   : <br> <br> <code class="cpp">if (inputValue == <span class="hljs-number"><span class="hljs-number">0.0</span></span>) return inputValue; double calculatedCutoff = getCalculatedCutoff(); buf0 += calculatedCutoff * (inputValue - buf0 + feedbackAmount * (buf0 - buf1)); buf1 += calculatedCutoff * (buf0 - buf1); buf2 += calculatedCutoff * (buf1 - buf2); buf3 += calculatedCutoff * (buf2 ‚Äì buf3);</code> <br> <br>        ,    .    ,      ,   .     .     <code>cutoff</code>  <code>calculatedCutoff</code>   -. <br> <br> ,       ( <code>setCutoffMod</code> ),   <code>Synthesis</code>    ,     ,    .    ,        <code>cutoffMod</code> .    <code>filterEnvelopeAmount</code>    <code>-<span class="hljs-number"><span class="hljs-number">1</span></span></code>  <code>+<span class="hljs-number"><span class="hljs-number">1</span></span></code> .   GUI. <br> <br>   <code>private</code> <i>Synthesis.h</i>    : <br> <br> <code class="cpp">EnvelopeGenerator mFilterEnvelopeGenerator; double filterEnvelopeAmount;</code> <br> <br>       MIDI ,      <code>onNoteOn</code>  <code>onNoteOff</code> : <br> <br> <code class="cpp">inline void onNoteOn(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); mFilterEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); }; inline void onNoteOff(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); mFilterEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); };</code> <br> <br>    .   <code>ProcessDoubleReplacing</code>        : <br> <br> <code class="cpp">mFilter.setCutoffMod(mFilterEnvelopeGenerator.nextSample() * filterEnvelopeAmount);</code> <br> <br>  ,        <code>nextSample</code>  <code>filterEnvelopeAmount</code>     <code>cutoffMod</code> .     <code>filterEnvelopeAmount</code>  : <br> <br> <code class="cpp">Synthesis::Synthesis(IPlugInstanceInfo instanceInfo) : IPLUG_CTOR(kNumParams, kNumPrograms, instanceInfo), lastVirtualKeyboardNoteNumber(virtualKeyboardMinimumNoteNumber - <span class="hljs-number"><span class="hljs-number">1</span></span>), filterEnvelopeAmount(<span class="hljs-number"><span class="hljs-number">0.0</span></span>) { // ... }</code> <br> <br>       <code>Synthesis::Reset</code> : <br> <br> <code class="cpp">mFilterEnvelopeGenerator.setSampleRate(GetSampleRate());</code> <br> <br>      <code>EParams</code> ,       .  <code>AttachGraphics</code>     : <br> <br> <code class="cpp">// Knobs for filter envelope // Attack knob GetParam(mFilterAttack)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Filter Env Attack"</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">10.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); GetParam(mFilterAttack)-&gt;SetShape(<span class="hljs-number"><span class="hljs-number">3</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">139</span></span>, <span class="hljs-number"><span class="hljs-number">178</span></span>, mFilterAttack, &amp;smallKnobBitmap)); // Decay knob: GetParam(mFilterDecay)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Filter Env Decay"</span></span>, <span class="hljs-number"><span class="hljs-number">0.5</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">15.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); GetParam(mFilterDecay)-&gt;SetShape(<span class="hljs-number"><span class="hljs-number">3</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">195</span></span>, <span class="hljs-number"><span class="hljs-number">178</span></span>, mFilterDecay, &amp;smallKnobBitmap)); // Sustain knob: GetParam(mFilterSustain)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Filter Env Sustain"</span></span>, <span class="hljs-number"><span class="hljs-number">0.1</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>, <span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); GetParam(mFilterSustain)-&gt;SetShape(<span class="hljs-number"><span class="hljs-number">2</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">251</span></span>, <span class="hljs-number"><span class="hljs-number">178</span></span>, mFilterSustain, &amp;smallKnobBitmap)); // Release knob: GetParam(mFilterRelease)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Filter Env Release"</span></span>, <span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>, <span class="hljs-number"><span class="hljs-number">15.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); GetParam(mFilterRelease)-&gt;SetShape(<span class="hljs-number"><span class="hljs-number">3</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">307</span></span>, <span class="hljs-number"><span class="hljs-number">178</span></span>, mFilterRelease, &amp;smallKnobBitmap)); // Filter envelope amount knob: GetParam(mFilterEnvelopeAmount)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Filter Env Amount"</span></span>, <span class="hljs-number"><span class="hljs-number">0.0</span></span>, -<span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">363</span></span>, <span class="hljs-number"><span class="hljs-number">178</span></span>, mFilterEnvelopeAmount, &amp;smallKnobBitmap));</code> <br> <br>     ,       <code>smallKnobBitmap</code> .                   .     ,    .  <code>Synthesis::OnParamChange</code>    <code>switch</code> : <br> <br> <code class="cpp">case mFilterAttack: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK, GetParam(paramIdx)-&gt;Value()); break; case mFilterDecay: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_DECAY, GetParam(paramIdx)-&gt;Value()); break; case mFilterSustain: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_SUSTAIN, GetParam(paramIdx)-&gt;Value()); break; case mFilterRelease: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE, GetParam(paramIdx)-&gt;Value()); break; case mFilterEnvelopeAmount: filterEnvelopeAmount = GetParam(paramIdx)-&gt;Value(); break;</code> <br> <br> ! <br>     !           (-   C1),   : <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/f5d/757/3f9/f5d7573f9b3a720fe5898d88ae477cfc.png"> <br> <br>        <code>EnvelopeGenerator</code>  .         .        ! <br> <br>    <a href=""></a> . <br> <br>        :) <br> <br>  : <br> <a href="http://martin-finke.de/blog/articles/audio-plugins-013-filter/">martin-finke.de/blog/articles/audio-plugins-<span class="hljs-number"><span class="hljs-number">013</span></span>-filter</a></code></code> </pre> <code><code><code class="cpp">#include  <i>Filter.h</i> ( )     : <br> <br> class Filter { public: enum FilterMode { FILTER_MODE_LOWPASS = 0, FILTER_MODE_HIGHPASS, FILTER_MODE_BANDPASS, kNumFilterModes }; Filter() : cutoff(0.99), resonance(0.0), mode(FILTER_MODE_LOWPASS), buf0(0.0), buf1(0.0) { calculateFeedbackAmount(); }; double process(double inputValue); inline void setCutoff(double newCutoff) { cutoff = newCutoff; calculateFeedbackAmount(); }; inline void setResonance(double newResonance) { resonance = newResonance; calculateFeedbackAmount(); }; inline void setFilterMode(FilterMode newMode) { mode = newMode; } private: double cutoff; double resonance; FilterMode mode; double feedbackAmount; inline void calculateFeedbackAmount() { feedbackAmount = resonance + resonance/(1.0 - cutoff); } double buf0; double buf1; };</code> <br> <br>  <code>private</code>     <i> </i> <code>cutoff</code>  <i></i> <code>resonance</code> . <code>Mode</code>      (Lowpass, Highpass, Bandpass).  <code>feedbackAmount</code> , <code>buf0</code>  <code>buf1</code>    ,    . <br>          ( <code>calculateFeedbackAmount()</code> ).  <code>process</code>      .   <code>feedbackAmount</code>   <code>cutoff</code>  <code>resonance</code> ,    <code>calculateFeedbackAmount</code>      . <br> <br>   <i>Filter.cpp</i>  : <br> <br> <code class="cpp">// By Paul Kellett // http://www.musicdsp.org/showone.php?id=29 double Filter::process(double inputValue) { buf0 += cutoff * (inputValue - buf0); buf1 += cutoff * (buf0 - buf1); switch (mode) { case FILTER_MODE_LOWPASS: return buf1; case FILTER_MODE_HIGHPASS: return inputValue - buf0; case FILTER_MODE_BANDPASS: return buf0 - buf1; default: return 0.0; } }</code> <br> <br> , ?  ,         <i> </i> . ¬´ ¬ª   ,               (. .    6 ).     <code>buf0</code>  <code>buf1</code> :        .     <code>inputValue</code> ,  - <code>buf0</code> (  ).   .    6 /   12 /.  <code>switch</code> ,  <code>buf1</code>    . , ,    <code>buf0</code> ,       12,   6 /,        . <br> <br>  <code>case</code> <code>FILTER_MODE_HIGHPASS</code>    . <code>buf0</code>       .   <code>inputValue</code>  <code>buf0</code> ,   .    <code>buf1</code> ,     . <br> <br>  <code>case</code> <code>FILTER_MODE_BANDPASS</code> ,  <code>buf0 - buf1</code>   .  <code>buf0</code>       ,     <code>buf1</code> . ,   . <br>  :    <i> </i>    <i> </i> ,   . <br> <br>  <code>buf1</code>     .       <a href="http://ru.wikipedia.org/wiki/%25D0%25A4%25D0%25B8%25D0%25BB%25D1%258C%25D1%2582%25D1%2580_%25D1%2581_%25D0%25B1%25D0%25B5%25D1%2581%25D0%25BA%25D0%25BE%25D0%25BD%25D0%25B5%25D1%2587%25D0%25BD%25D0%25BE%25D0%25B9_%25D0%25B8%25D0%25BC%25D0%25BF%25D1%2583%25D0%25BB%25D1%258C%25D1%2581%25D0%25BD%25D0%25BE%25D0%25B9_%25D1%2585%25D0%25B0%25D1%2580%25D0%25B0%25D0%25BA%25D1%2582%25D0%25B5%25D1%2580%25D0%25B8%25D1%2581%25D1%2582%25D0%25B8%25D0%25BA%25D0%25BE%25D0%25B9">    </a> ( <i>Infinite Impulse Response</i> ,  <i>IIR</i> ).  <a href="http://www.dspguide.com/ch14/1.htm"> </a> ,      .      ,         ,      . <br> <br>   <br>       ,     ,     .   ,  ,      ,  ,          .           ,  NI Massive,   ¬´ <a href="http://lurkmore.to/%25D0%25A2%25D1%2591%25D0%25BF%25D0%25BB%25D1%258B%25D0%25B9_%25D0%25BB%25D0%25B0%25D0%25BC%25D0%25BF%25D0%25BE%25D0%25B2%25D1%258B%25D0%25B9_%25D0%25B7%25D0%25B2%25D1%2583%25D0%25BA">  </a> ¬ª.       ,          ,   .        ,          (  Massive       ).      ¬´¬ª , , , AAS Ultra Analog,       ,     ,    ,        .         ,  ,    <a href="http://www.kvraudio.com/forum/viewtopic.php%3Ft%3D350246"></a> ,   ,      NI Reaktor. ,            ‚Äî    ,    ..     . <br> <br>   <br>     .   GUI.  <i>bg.png</i>   ( <i>‚ÄúMove to trash‚Äù</i>  Xcode),       : <br> <br> <a href="">filtermode.png</a> <a href="">knob_small.png</a> (  ,   50 50 ) <a href="">bg.png</a> (       ) <br> <br>    ID  <i>resource.h</i> : <br> <br> <code class="cpp">// Unique IDs for each image resource. #define BG_ID 101 #define WHITE_KEY_ID 102 #define BLACK_KEY_ID 103 #define WAVEFORM_ID 104 #define KNOB_ID 105 #define KNOB_SMALL_ID 106 #define FILTERMODE_ID 107 // Image resource locations for this plug. #define BG_FN "resources/img/bg.png" #define WHITE_KEY_FN "resources/img/whitekey.png" #define BLACK_KEY_FN "resources/img/blackkey.png" #define WAVEFORM_FN "resources/img/waveform.png" #define KNOB_FN "resources/img/knob.png" #define KNOB_SMALL_FN "resources/img/knob_small.png" #define FILTERMODE_FN "resources/img/filtermode.png"</code> <br> <br>  <i>Synthesis.rc</i> : <br> <br> <code class="cpp">#include "resource.h" BG_ID PNG BG_FN WHITE_KEY_ID PNG WHITE_KEY_FN BLACK_KEY_ID PNG BLACK_KEY_FN WAVEFORM_ID PNG WAVEFORM_FN KNOB_ID PNG KNOB_FN KNOB_SMALL_ID PNG KNOB_SMALL_FN FILTERMODE_ID PNG FILTERMODE_FN</code> <br> <br>   <code>#include "Filter.h"</code>  <i>Synthesis.h</i>    <code>private</code> : <br> <br> <code class="cpp">Filter mFilter;</code> <br> <br>  <code>EParams</code>  <i>Synthesis.cpp</i> : <br> <br> <code class="cpp">enum EParams { mWaveform = 0, mAttack, mDecay, mSustain, mRelease, mFilterMode, mFilterCutoff, mFilterResonance, mFilterAttack, mFilterDecay, mFilterSustain, mFilterRelease, mFilterEnvelopeAmount, kNumParams };</code> <br> <br>        : <br> <br> <code class="cpp">pGraphics-&gt;AttachControl(new ISwitchControl(this, 24, 38, mWaveform, &amp;waveformBitmap));</code> <br> <br>      .      (Lowpass, Highpass, Bandpass).    <code>AttachGraphics(pGraphics)</code> : <br> <br> <code class="cpp">GetParam(mFilterMode)-&gt;InitEnum("Filter Mode", Filter::FILTER_MODE_LOWPASS, Filter::kNumFilterModes); IBitmap filtermodeBitmap = pGraphics-&gt;LoadIBitmap(FILTERMODE_ID, FILTERMODE_FN, 3); pGraphics-&gt;AttachControl(new ISwitchControl(this, 24, 123, mFilterMode, &amp;filtermodeBitmap));</code> <br> <br>         .    .     <i>knob_small.png</i> : <br> <br> <code class="cpp">// Knobs for filter cutoff and resonance IBitmap smallKnobBitmap = pGraphics-&gt;LoadIBitmap(KNOB_SMALL_ID, KNOB_SMALL_FN, 64); // Cutoff knob: GetParam(mFilterCutoff)-&gt;InitDouble("Cutoff", 0.99, 0.01, 0.99, 0.001); GetParam(mFilterCutoff)-&gt;SetShape(2); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 5, 177, mFilterCutoff, &amp;smallKnobBitmap)); // Resonance knob: GetParam(mFilterResonance)-&gt;InitDouble("Resonance", 0.01, 0.01, 1.0, 0.001); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 61, 177, mFilterResonance, &amp;smallKnobBitmap));</code> <br> <br>   ,           <code>1.0</code> ,   <code>calculateFeedbackAmount</code>    , . <br>  <code>ProcessDoubleReplacing</code>     : <br> <br> <code class="cpp">leftOutput[i] = rightOutput[i] = mFilter.process(mOscillator.nextSample() * mEnvelopeGenerator.nextSample() * velocity / 127.0);</code> <br> <br>       .  <code>switch</code>   <code>Synthesis::OnParamChange</code> : <br> <br> <code class="cpp">case mFilterCutoff: mFilter.setCutoff(GetParam(paramIdx)-&gt;Value()); break; case mFilterResonance: mFilter.setResonance(GetParam(paramIdx)-&gt;Value()); break; case mFilterMode: mFilter.setFilterMode(static_cast&lt;Filter::FilterMode&gt;(GetParam(paramIdx)-&gt;Int())); break;</code> <br> <br>    .  -      . <br> <br>  <br> <br>  ‚Äî      .   ,   ,          . <br>      : <br> <br> <code class="cpp">buf0 += cutoff * (inputValue - buf0 + feedbackAmount * (buf0 - buf1));</code> <br> <br> ,   ,      ( <code>buf0 ‚Äì buf1</code> ),   <code>feedbackAmount</code> .    <code>calculateFeedbackAmount</code>  <code>feedbackAmount</code>  <code>resonance</code> , . .    ,   . <br> <br>  ,            .     ,  <i></i> ,      <a href="https://www.youtube.com/watch%3Fv%3DJWyMj6KxGHM"> </a> .    ,        ,       . <br> <br>  -12 /  -24 / <br>        !     24   .     <code>switch</code>  <code>Filter::process</code> : <br> <br> <code class="cpp">buf2 += cutoff * (buf1 - buf2); buf3 += cutoff * (buf2 ‚Äì buf3);</code> <br> <br>   :      ,       ,            .     ,       , , <a href="https://ccrma.stanford.edu/~Jos/filters/Filter_Stability.html"></a> (       ).     <code>switch</code> : <br> <br> <code class="cpp">switch (mode) { case FILTER_MODE_LOWPASS: return buf3; case FILTER_MODE_HIGHPASS: return inputValue - buf3; case FILTER_MODE_BANDPASS: return buf0 - buf3; default: return 0.0; }</code> <br> <br>   <code>buf1</code>  <code>buf3</code> ‚Äì      .    -24 /.     <code>buf2</code>  <code>buf3</code> ,        <code>private</code> <i>Filter.h</i> : <br> <br> <code class="cpp">double buf2; double buf3;</code> <br> <br>    ,   <code>buf0</code> c <code>buf1</code> : <br> <br> <code class="cpp">Filter() : // ... buf0(0.0), buf1(0.0), buf2(0.0), buf3(0.0) // ...</code> <br> <br>     , ,     :     .       . <br>          ? <br> <br>   <br>    .  ,           ,       . <br> -      <code>cutoff</code>   .      .    <code>cutoffMod</code> ,    ,       <code>cutoff</code>    .     <code>#include    private</code> : <br> <br> <code class="cpp">double cutoffMod;</code> <br> <br> : <br> <br> <code class="cpp">Filter() : cutoff(0.99), resonance(0.01), cutoffMod(0.0), // ...</code> <br> <br>         .   <code>private</code> : <br> <br> <code class="cpp">inline double getCalculatedCutoff() const { return fmax(fmin(cutoff + cutoffMod, 0.99), 0.01); };</code> <br> <br> <code>calculateFeedbackAmount</code>     : <br> <br> <code class="cpp">inline void calculateFeedbackAmount() { feedbackAmount = resonance + resonance/(1.0 - getCalculatedCutoff()); }</code> <br> <br>       <code>cutoffMod</code> .   <code>feedbackAmount</code>    ,     : <br> <br> <code class="cpp">inline void setCutoffMod(double newCutoffMod) { cutoffMod = newCutoffMod; calculateFeedbackAmount(); }</code> <br> <br> ,       .   <code>Filter::process</code>   : <br> <br> <code class="cpp">if (inputValue == 0.0) return inputValue; double calculatedCutoff = getCalculatedCutoff(); buf0 += calculatedCutoff * (inputValue - buf0 + feedbackAmount * (buf0 - buf1)); buf1 += calculatedCutoff * (buf0 - buf1); buf2 += calculatedCutoff * (buf1 - buf2); buf3 += calculatedCutoff * (buf2 ‚Äì buf3);</code> <br> <br>        ,    .    ,      ,   .     .     <code>cutoff</code>  <code>calculatedCutoff</code>   -. <br> <br> ,       ( <code>setCutoffMod</code> ),   <code>Synthesis</code>    ,     ,    .    ,        <code>cutoffMod</code> .    <code>filterEnvelopeAmount</code>    <code>-1</code>  <code>+1</code> .   GUI. <br> <br>   <code>private</code> <i>Synthesis.h</i>    : <br> <br> <code class="cpp">EnvelopeGenerator mFilterEnvelopeGenerator; double filterEnvelopeAmount;</code> <br> <br>       MIDI ,      <code>onNoteOn</code>  <code>onNoteOff</code> : <br> <br> <code class="cpp">inline void onNoteOn(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); mFilterEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); }; inline void onNoteOff(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); mFilterEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); };</code> <br> <br>    .   <code>ProcessDoubleReplacing</code>        : <br> <br> <code class="cpp">mFilter.setCutoffMod(mFilterEnvelopeGenerator.nextSample() * filterEnvelopeAmount);</code> <br> <br>  ,        <code>nextSample</code>  <code>filterEnvelopeAmount</code>     <code>cutoffMod</code> .     <code>filterEnvelopeAmount</code>  : <br> <br> <code class="cpp">Synthesis::Synthesis(IPlugInstanceInfo instanceInfo) : IPLUG_CTOR(kNumParams, kNumPrograms, instanceInfo), lastVirtualKeyboardNoteNumber(virtualKeyboardMinimumNoteNumber - 1), filterEnvelopeAmount(0.0) { // ... }</code> <br> <br>       <code>Synthesis::Reset</code> : <br> <br> <code class="cpp">mFilterEnvelopeGenerator.setSampleRate(GetSampleRate());</code> <br> <br>      <code>EParams</code> ,       .  <code>AttachGraphics</code>     : <br> <br> <code class="cpp">// Knobs for filter envelope // Attack knob GetParam(mFilterAttack)-&gt;InitDouble("Filter Env Attack", 0.01, 0.01, 10.0, 0.001); GetParam(mFilterAttack)-&gt;SetShape(3); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 139, 178, mFilterAttack, &amp;smallKnobBitmap)); // Decay knob: GetParam(mFilterDecay)-&gt;InitDouble("Filter Env Decay", 0.5, 0.01, 15.0, 0.001); GetParam(mFilterDecay)-&gt;SetShape(3); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 195, 178, mFilterDecay, &amp;smallKnobBitmap)); // Sustain knob: GetParam(mFilterSustain)-&gt;InitDouble("Filter Env Sustain", 0.1, 0.001, 1.0, 0.001); GetParam(mFilterSustain)-&gt;SetShape(2); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 251, 178, mFilterSustain, &amp;smallKnobBitmap)); // Release knob: GetParam(mFilterRelease)-&gt;InitDouble("Filter Env Release", 1.0, 0.001, 15.0, 0.001); GetParam(mFilterRelease)-&gt;SetShape(3); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 307, 178, mFilterRelease, &amp;smallKnobBitmap)); // Filter envelope amount knob: GetParam(mFilterEnvelopeAmount)-&gt;InitDouble("Filter Env Amount", 0.0, -1.0, 1.0, 0.001); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 363, 178, mFilterEnvelopeAmount, &amp;smallKnobBitmap));</code> <br> <br>     ,       <code>smallKnobBitmap</code> .                   .     ,    .  <code>Synthesis::OnParamChange</code>    <code>switch</code> : <br> <br> <code class="cpp">case mFilterAttack: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK, GetParam(paramIdx)-&gt;Value()); break; case mFilterDecay: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_DECAY, GetParam(paramIdx)-&gt;Value()); break; case mFilterSustain: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_SUSTAIN, GetParam(paramIdx)-&gt;Value()); break; case mFilterRelease: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE, GetParam(paramIdx)-&gt;Value()); break; case mFilterEnvelopeAmount: filterEnvelopeAmount = GetParam(paramIdx)-&gt;Value(); break;</code> <br> <br> ! <br>     !           (-   C1),   : <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/f5d/757/3f9/f5d7573f9b3a720fe5898d88ae477cfc.png"> <br> <br>        <code>EnvelopeGenerator</code>  .         .        ! <br> <br>    <a href=""></a> . <br> <br>        :) <br> <br>  : <br> <a href="http://martin-finke.de/blog/articles/audio-plugins-013-filter/">martin-finke.de/blog/articles/audio-plugins-013-filter</a></code></code> <pre> <code class="hljs erlang-repl"><code><code class="cpp"><code class="cpp">#include  <i>Filter.h</i> ( )     : <br> <br> class Filter { public: enum FilterMode { FILTER_MODE_LOWPASS = <span class="hljs-number"><span class="hljs-number">0</span></span>, FILTER_MODE_HIGHPASS, FILTER_MODE_BANDPASS, kNumFilterModes }; Filter() : cutoff(<span class="hljs-number"><span class="hljs-number">0.99</span></span>), resonance(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), mode(FILTER_MODE_LOWPASS), buf0(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), buf1(<span class="hljs-number"><span class="hljs-number">0.0</span></span>) { calculateFeedbackAmount(); }; double process(double inputValue); inline void setCutoff(double newCutoff) { cutoff = newCutoff; calculateFeedbackAmount(); }; inline void setResonance(double newResonance) { resonance = newResonance; calculateFeedbackAmount(); }; inline void setFilterMode(FilterMode newMode) { mode = newMode; } private: double cutoff; double resonance; FilterMode mode; double feedbackAmount; inline void calculateFeedbackAmount() { feedbackAmount = resonance + resonance/(<span class="hljs-number"><span class="hljs-number">1.0</span></span> - cutoff); } double buf0; double buf1; };</code> <br> <br>  <code>private</code>     <i> </i> <code>cutoff</code>  <i></i> <code>resonance</code> . <code>Mode</code>      (Lowpass, Highpass, Bandpass).  <code>feedbackAmount</code> , <code>buf0</code>  <code>buf1</code>    ,    . <br>          ( <code>calculateFeedbackAmount()</code> ).  <code>process</code>      .   <code>feedbackAmount</code>   <code>cutoff</code>  <code>resonance</code> ,    <code>calculateFeedbackAmount</code>      . <br> <br>   <i>Filter.cpp</i>  : <br> <br> <code class="cpp">// By Paul Kellett // http://www.musicdsp.org/showone.php?id=<span class="hljs-number"><span class="hljs-number">29</span></span> double Filter::process(double inputValue) { buf0 += cutoff * (inputValue - buf0); buf1 += cutoff * (buf0 - buf1); switch (mode) { case FILTER_MODE_LOWPASS: return buf1; case FILTER_MODE_HIGHPASS: return inputValue - buf0; case FILTER_MODE_BANDPASS: return buf0 - buf1; default: return <span class="hljs-number"><span class="hljs-number">0.0</span></span>; } }</code> <br> <br> , ?  ,         <i> </i> . ¬´ ¬ª   ,               (. .    <span class="hljs-number"><span class="hljs-number">6</span></span> ).     <code>buf0</code>  <code>buf1</code> :        .     <code>inputValue</code> ,  - <code>buf0</code> (  ).   .    <span class="hljs-number"><span class="hljs-number">6</span></span> /   <span class="hljs-number"><span class="hljs-number">12</span></span> /.  <code>switch</code> ,  <code>buf1</code>    . , ,    <code>buf0</code> ,       <span class="hljs-number"><span class="hljs-number">12</span></span>,   <span class="hljs-number"><span class="hljs-number">6</span></span> /,        . <br> <br>  <code>case</code> <code>FILTER_MODE_HIGHPASS</code>    . <code>buf0</code>       .   <code>inputValue</code>  <code>buf0</code> ,   .    <code>buf1</code> ,     . <br> <br>  <code>case</code> <code>FILTER_MODE_BANDPASS</code> ,  <code>buf0 - buf1</code>   .  <code>buf0</code>       ,     <code>buf1</code> . ,   . <br>  :    <i> </i>    <i> </i> ,   . <br> <br>  <code>buf1</code>     .       <a href="http://ru.wikipedia.org/wiki/%25D0%25A4%25D0%25B8%25D0%25BB%25D1%258C%25D1%2582%25D1%2580_%25D1%2581_%25D0%25B1%25D0%25B5%25D1%2581%25D0%25BA%25D0%25BE%25D0%25BD%25D0%25B5%25D1%2587%25D0%25BD%25D0%25BE%25D0%25B9_%25D0%25B8%25D0%25BC%25D0%25BF%25D1%2583%25D0%25BB%25D1%258C%25D1%2581%25D0%25BD%25D0%25BE%25D0%25B9_%25D1%2585%25D0%25B0%25D1%2580%25D0%25B0%25D0%25BA%25D1%2582%25D0%25B5%25D1%2580%25D0%25B8%25D1%2581%25D1%2582%25D0%25B8%25D0%25BA%25D0%25BE%25D0%25B9">    </a> ( <i>Infinite Impulse Response</i> ,  <i>IIR</i> ).  <a href="http://www.dspguide.com/ch14/1.htm"> </a> ,      .      ,         ,      . <br> <br>   <br>       ,     ,     .   ,  ,      ,  ,          .           ,  NI Massive,   ¬´ <a href="http://lurkmore.to/%25D0%25A2%25D1%2591%25D0%25BF%25D0%25BB%25D1%258B%25D0%25B9_%25D0%25BB%25D0%25B0%25D0%25BC%25D0%25BF%25D0%25BE%25D0%25B2%25D1%258B%25D0%25B9_%25D0%25B7%25D0%25B2%25D1%2583%25D0%25BA">  </a> ¬ª.       ,          ,   .        ,          (  Massive       ).      ¬´¬ª , , , AAS Ultra Analog,       ,     ,    ,        .         ,  ,    <a href="http://www.kvraudio.com/forum/viewtopic.php%3Ft%3D350246"></a> ,   ,      NI Reaktor. ,            ‚Äî    ,    ..     . <br> <br>   <br>     .   GUI.  <i>bg.png</i>   ( <i>‚ÄúMove to trash‚Äù</i>  Xcode),       : <br> <br> <a href="">filtermode.png</a> <a href="">knob_small.png</a> (  ,   <span class="hljs-number"><span class="hljs-number">50</span></span> <span class="hljs-number"><span class="hljs-number">50</span></span> ) <a href="">bg.png</a> (       ) <br> <br>    ID  <i>resource.h</i> : <br> <br> <code class="cpp">// Unique IDs for each image resource. #define BG_ID <span class="hljs-number"><span class="hljs-number">101</span></span> #define WHITE_KEY_ID <span class="hljs-number"><span class="hljs-number">102</span></span> #define BLACK_KEY_ID <span class="hljs-number"><span class="hljs-number">103</span></span> #define WAVEFORM_ID <span class="hljs-number"><span class="hljs-number">104</span></span> #define KNOB_ID <span class="hljs-number"><span class="hljs-number">105</span></span> #define KNOB_SMALL_ID <span class="hljs-number"><span class="hljs-number">106</span></span> #define FILTERMODE_ID <span class="hljs-number"><span class="hljs-number">107</span></span> // Image resource locations for this plug. #define BG_FN <span class="hljs-string"><span class="hljs-string">"resources/img/bg.png"</span></span> #define WHITE_KEY_FN <span class="hljs-string"><span class="hljs-string">"resources/img/whitekey.png"</span></span> #define BLACK_KEY_FN <span class="hljs-string"><span class="hljs-string">"resources/img/blackkey.png"</span></span> #define WAVEFORM_FN <span class="hljs-string"><span class="hljs-string">"resources/img/waveform.png"</span></span> #define KNOB_FN <span class="hljs-string"><span class="hljs-string">"resources/img/knob.png"</span></span> #define KNOB_SMALL_FN <span class="hljs-string"><span class="hljs-string">"resources/img/knob_small.png"</span></span> #define FILTERMODE_FN <span class="hljs-string"><span class="hljs-string">"resources/img/filtermode.png"</span></span></code> <br> <br>  <i>Synthesis.rc</i> : <br> <br> <code class="cpp">#include <span class="hljs-string"><span class="hljs-string">"resource.h"</span></span> BG_ID PNG BG_FN WHITE_KEY_ID PNG WHITE_KEY_FN BLACK_KEY_ID PNG BLACK_KEY_FN WAVEFORM_ID PNG WAVEFORM_FN KNOB_ID PNG KNOB_FN KNOB_SMALL_ID PNG KNOB_SMALL_FN FILTERMODE_ID PNG FILTERMODE_FN</code> <br> <br>   <code>#include <span class="hljs-string"><span class="hljs-string">"Filter.h"</span></span></code>  <i>Synthesis.h</i>    <code>private</code> : <br> <br> <code class="cpp">Filter mFilter;</code> <br> <br>  <code>EParams</code>  <i>Synthesis.cpp</i> : <br> <br> <code class="cpp">enum EParams { mWaveform = <span class="hljs-number"><span class="hljs-number">0</span></span>, mAttack, mDecay, mSustain, mRelease, mFilterMode, mFilterCutoff, mFilterResonance, mFilterAttack, mFilterDecay, mFilterSustain, mFilterRelease, mFilterEnvelopeAmount, kNumParams };</code> <br> <br>        : <br> <br> <code class="cpp">pGraphics-&gt;AttachControl(new ISwitchControl(this, <span class="hljs-number"><span class="hljs-number">24</span></span>, <span class="hljs-number"><span class="hljs-number">38</span></span>, mWaveform, &amp;waveformBitmap));</code> <br> <br>      .      (Lowpass, Highpass, Bandpass).    <code>AttachGraphics(pGraphics)</code> : <br> <br> <code class="cpp">GetParam(mFilterMode)-&gt;InitEnum(<span class="hljs-string"><span class="hljs-string">"Filter Mode"</span></span>, Filter::FILTER_MODE_LOWPASS, Filter::kNumFilterModes); IBitmap filtermodeBitmap = pGraphics-&gt;LoadIBitmap(FILTERMODE_ID, FILTERMODE_FN, <span class="hljs-number"><span class="hljs-number">3</span></span>); pGraphics-&gt;AttachControl(new ISwitchControl(this, <span class="hljs-number"><span class="hljs-number">24</span></span>, <span class="hljs-number"><span class="hljs-number">123</span></span>, mFilterMode, &amp;filtermodeBitmap));</code> <br> <br>         .    .     <i>knob_small.png</i> : <br> <br> <code class="cpp">// Knobs for filter cutoff and resonance IBitmap smallKnobBitmap = pGraphics-&gt;LoadIBitmap(KNOB_SMALL_ID, KNOB_SMALL_FN, <span class="hljs-number"><span class="hljs-number">64</span></span>); // Cutoff knob: GetParam(mFilterCutoff)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Cutoff"</span></span>, <span class="hljs-number"><span class="hljs-number">0.99</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">0.99</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); GetParam(mFilterCutoff)-&gt;SetShape(<span class="hljs-number"><span class="hljs-number">2</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-number"><span class="hljs-number">177</span></span>, mFilterCutoff, &amp;smallKnobBitmap)); // Resonance knob: GetParam(mFilterResonance)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Resonance"</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">61</span></span>, <span class="hljs-number"><span class="hljs-number">177</span></span>, mFilterResonance, &amp;smallKnobBitmap));</code> <br> <br>   ,           <code><span class="hljs-number"><span class="hljs-number">1.0</span></span></code> ,   <code>calculateFeedbackAmount</code>    , . <br>  <code>ProcessDoubleReplacing</code>     : <br> <br> <code class="cpp">leftOutput[i] = rightOutput[i] = mFilter.process(mOscillator.nextSample() * mEnvelopeGenerator.nextSample() * velocity / <span class="hljs-number"><span class="hljs-number">127.0</span></span>);</code> <br> <br>       .  <code>switch</code>   <code>Synthesis::OnParamChange</code> : <br> <br> <code class="cpp">case mFilterCutoff: mFilter.setCutoff(GetParam(paramIdx)-&gt;Value()); break; case mFilterResonance: mFilter.setResonance(GetParam(paramIdx)-&gt;Value()); break; case mFilterMode: mFilter.setFilterMode(static_cast&lt;Filter::FilterMode&gt;(GetParam(paramIdx)-&gt;Int())); break;</code> <br> <br>    .  -      . <br> <br>  <br> <br>  ‚Äî      .   ,   ,          . <br>      : <br> <br> <code class="cpp">buf0 += cutoff * (inputValue - buf0 + feedbackAmount * (buf0 - buf1));</code> <br> <br> ,   ,      ( <code>buf0 ‚Äì buf1</code> ),   <code>feedbackAmount</code> .    <code>calculateFeedbackAmount</code>  <code>feedbackAmount</code>  <code>resonance</code> , . .    ,   . <br> <br>  ,            .     ,  <i></i> ,      <a href="https://www.youtube.com/watch%3Fv%3DJWyMj6KxGHM"> </a> .    ,        ,       . <br> <br>  -<span class="hljs-number"><span class="hljs-number">12</span></span> /  -<span class="hljs-number"><span class="hljs-number">24</span></span> / <br>        !     <span class="hljs-number"><span class="hljs-number">24</span></span>   .     <code>switch</code>  <code>Filter::process</code> : <br> <br> <code class="cpp">buf2 += cutoff * (buf1 - buf2); buf3 += cutoff * (buf2 ‚Äì buf3);</code> <br> <br>   :      ,       ,            .     ,       , , <a href="https://ccrma.stanford.edu/~Jos/filters/Filter_Stability.html"></a> (       ).     <code>switch</code> : <br> <br> <code class="cpp">switch (mode) { case FILTER_MODE_LOWPASS: return buf3; case FILTER_MODE_HIGHPASS: return inputValue - buf3; case FILTER_MODE_BANDPASS: return buf0 - buf3; default: return <span class="hljs-number"><span class="hljs-number">0.0</span></span>; }</code> <br> <br>   <code>buf1</code>  <code>buf3</code> ‚Äì      .    -<span class="hljs-number"><span class="hljs-number">24</span></span> /.     <code>buf2</code>  <code>buf3</code> ,        <code>private</code> <i>Filter.h</i> : <br> <br> <code class="cpp">double buf2; double buf3;</code> <br> <br>    ,   <code>buf0</code> c <code>buf1</code> : <br> <br> <code class="cpp">Filter() : // ... buf0(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), buf1(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), buf2(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), buf3(<span class="hljs-number"><span class="hljs-number">0.0</span></span>) // ...</code> <br> <br>     , ,     :     .       . <br>          ? <br> <br>   <br>    .  ,           ,       . <br> -      <code>cutoff</code>   .      .    <code>cutoffMod</code> ,    ,       <code>cutoff</code>    .     <code>#include    private</code> : <br> <br> <code class="cpp">double cutoffMod;</code> <br> <br> : <br> <br> <code class="cpp">Filter() : cutoff(<span class="hljs-number"><span class="hljs-number">0.99</span></span>), resonance(<span class="hljs-number"><span class="hljs-number">0.01</span></span>), cutoffMod(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), // ...</code> <br> <br>         .   <code>private</code> : <br> <br> <code class="cpp">inline double getCalculatedCutoff() const { return fmax(fmin(cutoff + cutoffMod, <span class="hljs-number"><span class="hljs-number">0.99</span></span>), <span class="hljs-number"><span class="hljs-number">0.01</span></span>); };</code> <br> <br> <code>calculateFeedbackAmount</code>     : <br> <br> <code class="cpp">inline void calculateFeedbackAmount() { feedbackAmount = resonance + resonance/(<span class="hljs-number"><span class="hljs-number">1.0</span></span> - getCalculatedCutoff()); }</code> <br> <br>       <code>cutoffMod</code> .   <code>feedbackAmount</code>    ,     : <br> <br> <code class="cpp">inline void setCutoffMod(double newCutoffMod) { cutoffMod = newCutoffMod; calculateFeedbackAmount(); }</code> <br> <br> ,       .   <code>Filter::process</code>   : <br> <br> <code class="cpp">if (inputValue == <span class="hljs-number"><span class="hljs-number">0.0</span></span>) return inputValue; double calculatedCutoff = getCalculatedCutoff(); buf0 += calculatedCutoff * (inputValue - buf0 + feedbackAmount * (buf0 - buf1)); buf1 += calculatedCutoff * (buf0 - buf1); buf2 += calculatedCutoff * (buf1 - buf2); buf3 += calculatedCutoff * (buf2 ‚Äì buf3);</code> <br> <br>        ,    .    ,      ,   .     .     <code>cutoff</code>  <code>calculatedCutoff</code>   -. <br> <br> ,       ( <code>setCutoffMod</code> ),   <code>Synthesis</code>    ,     ,    .    ,        <code>cutoffMod</code> .    <code>filterEnvelopeAmount</code>    <code>-<span class="hljs-number"><span class="hljs-number">1</span></span></code>  <code>+<span class="hljs-number"><span class="hljs-number">1</span></span></code> .   GUI. <br> <br>   <code>private</code> <i>Synthesis.h</i>    : <br> <br> <code class="cpp">EnvelopeGenerator mFilterEnvelopeGenerator; double filterEnvelopeAmount;</code> <br> <br>       MIDI ,      <code>onNoteOn</code>  <code>onNoteOff</code> : <br> <br> <code class="cpp">inline void onNoteOn(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); mFilterEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); }; inline void onNoteOff(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); mFilterEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); };</code> <br> <br>    .   <code>ProcessDoubleReplacing</code>        : <br> <br> mFilter.setCutoffMod(mFilterEnvelopeGenerator.nextSample() * filterEnvelopeAmount); <br> <br>  ,        <code>nextSample</code>  <code>filterEnvelopeAmount</code>     <code>cutoffMod</code> .     <code>filterEnvelopeAmount</code>  : <br> <br> <code class="cpp">Synthesis::Synthesis(IPlugInstanceInfo instanceInfo) : IPLUG_CTOR(kNumParams, kNumPrograms, instanceInfo), lastVirtualKeyboardNoteNumber(virtualKeyboardMinimumNoteNumber - <span class="hljs-number"><span class="hljs-number">1</span></span>), filterEnvelopeAmount(<span class="hljs-number"><span class="hljs-number">0.0</span></span>) { // ... }</code> <br> <br>       <code>Synthesis::Reset</code> : <br> <br> <code class="cpp">mFilterEnvelopeGenerator.setSampleRate(GetSampleRate());</code> <br> <br>      <code>EParams</code> ,       .  <code>AttachGraphics</code>     : <br> <br> <code class="cpp">// Knobs for filter envelope // Attack knob GetParam(mFilterAttack)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Filter Env Attack"</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">10.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); GetParam(mFilterAttack)-&gt;SetShape(<span class="hljs-number"><span class="hljs-number">3</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">139</span></span>, <span class="hljs-number"><span class="hljs-number">178</span></span>, mFilterAttack, &amp;smallKnobBitmap)); // Decay knob: GetParam(mFilterDecay)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Filter Env Decay"</span></span>, <span class="hljs-number"><span class="hljs-number">0.5</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">15.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); GetParam(mFilterDecay)-&gt;SetShape(<span class="hljs-number"><span class="hljs-number">3</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">195</span></span>, <span class="hljs-number"><span class="hljs-number">178</span></span>, mFilterDecay, &amp;smallKnobBitmap)); // Sustain knob: GetParam(mFilterSustain)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Filter Env Sustain"</span></span>, <span class="hljs-number"><span class="hljs-number">0.1</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>, <span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); GetParam(mFilterSustain)-&gt;SetShape(<span class="hljs-number"><span class="hljs-number">2</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">251</span></span>, <span class="hljs-number"><span class="hljs-number">178</span></span>, mFilterSustain, &amp;smallKnobBitmap)); // Release knob: GetParam(mFilterRelease)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Filter Env Release"</span></span>, <span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>, <span class="hljs-number"><span class="hljs-number">15.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); GetParam(mFilterRelease)-&gt;SetShape(<span class="hljs-number"><span class="hljs-number">3</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">307</span></span>, <span class="hljs-number"><span class="hljs-number">178</span></span>, mFilterRelease, &amp;smallKnobBitmap)); // Filter envelope amount knob: GetParam(mFilterEnvelopeAmount)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Filter Env Amount"</span></span>, <span class="hljs-number"><span class="hljs-number">0.0</span></span>, -<span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">363</span></span>, <span class="hljs-number"><span class="hljs-number">178</span></span>, mFilterEnvelopeAmount, &amp;smallKnobBitmap));</code> <br> <br>     ,       <code>smallKnobBitmap</code> .                   .     ,    .  <code>Synthesis::OnParamChange</code>    <code>switch</code> : <br> <br> <code class="cpp">case mFilterAttack: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK, GetParam(paramIdx)-&gt;Value()); break; case mFilterDecay: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_DECAY, GetParam(paramIdx)-&gt;Value()); break; case mFilterSustain: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_SUSTAIN, GetParam(paramIdx)-&gt;Value()); break; case mFilterRelease: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE, GetParam(paramIdx)-&gt;Value()); break; case mFilterEnvelopeAmount: filterEnvelopeAmount = GetParam(paramIdx)-&gt;Value(); break;</code> <br> <br> ! <br>     !           (-   C1),   : <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/f5d/757/3f9/f5d7573f9b3a720fe5898d88ae477cfc.png"> <br> <br>        <code>EnvelopeGenerator</code>  .         .        ! <br> <br>    <a href=""></a> . <br> <br>        :) <br> <br>  : <br> <a href="http://martin-finke.de/blog/articles/audio-plugins-013-filter/">martin-finke.de/blog/articles/audio-plugins-<span class="hljs-number"><span class="hljs-number">013</span></span>-filter</a></code></code></code> </pre> <code><code><code class="cpp">#include  <i>Filter.h</i> ( )     : <br> <br> class Filter { public: enum FilterMode { FILTER_MODE_LOWPASS = 0, FILTER_MODE_HIGHPASS, FILTER_MODE_BANDPASS, kNumFilterModes }; Filter() : cutoff(0.99), resonance(0.0), mode(FILTER_MODE_LOWPASS), buf0(0.0), buf1(0.0) { calculateFeedbackAmount(); }; double process(double inputValue); inline void setCutoff(double newCutoff) { cutoff = newCutoff; calculateFeedbackAmount(); }; inline void setResonance(double newResonance) { resonance = newResonance; calculateFeedbackAmount(); }; inline void setFilterMode(FilterMode newMode) { mode = newMode; } private: double cutoff; double resonance; FilterMode mode; double feedbackAmount; inline void calculateFeedbackAmount() { feedbackAmount = resonance + resonance/(1.0 - cutoff); } double buf0; double buf1; };</code> <br> <br>  <code>private</code>     <i> </i> <code>cutoff</code>  <i></i> <code>resonance</code> . <code>Mode</code>      (Lowpass, Highpass, Bandpass).  <code>feedbackAmount</code> , <code>buf0</code>  <code>buf1</code>    ,    . <br>          ( <code>calculateFeedbackAmount()</code> ).  <code>process</code>      .   <code>feedbackAmount</code>   <code>cutoff</code>  <code>resonance</code> ,    <code>calculateFeedbackAmount</code>      . <br> <br>   <i>Filter.cpp</i>  : <br> <br> <code class="cpp">// By Paul Kellett // http://www.musicdsp.org/showone.php?id=29 double Filter::process(double inputValue) { buf0 += cutoff * (inputValue - buf0); buf1 += cutoff * (buf0 - buf1); switch (mode) { case FILTER_MODE_LOWPASS: return buf1; case FILTER_MODE_HIGHPASS: return inputValue - buf0; case FILTER_MODE_BANDPASS: return buf0 - buf1; default: return 0.0; } }</code> <br> <br> , ?  ,         <i> </i> . ¬´ ¬ª   ,               (. .    6 ).     <code>buf0</code>  <code>buf1</code> :        .     <code>inputValue</code> ,  - <code>buf0</code> (  ).   .    6 /   12 /.  <code>switch</code> ,  <code>buf1</code>    . , ,    <code>buf0</code> ,       12,   6 /,        . <br> <br>  <code>case</code> <code>FILTER_MODE_HIGHPASS</code>    . <code>buf0</code>       .   <code>inputValue</code>  <code>buf0</code> ,   .    <code>buf1</code> ,     . <br> <br>  <code>case</code> <code>FILTER_MODE_BANDPASS</code> ,  <code>buf0 - buf1</code>   .  <code>buf0</code>       ,     <code>buf1</code> . ,   . <br>  :    <i> </i>    <i> </i> ,   . <br> <br>  <code>buf1</code>     .       <a href="http://ru.wikipedia.org/wiki/%25D0%25A4%25D0%25B8%25D0%25BB%25D1%258C%25D1%2582%25D1%2580_%25D1%2581_%25D0%25B1%25D0%25B5%25D1%2581%25D0%25BA%25D0%25BE%25D0%25BD%25D0%25B5%25D1%2587%25D0%25BD%25D0%25BE%25D0%25B9_%25D0%25B8%25D0%25BC%25D0%25BF%25D1%2583%25D0%25BB%25D1%258C%25D1%2581%25D0%25BD%25D0%25BE%25D0%25B9_%25D1%2585%25D0%25B0%25D1%2580%25D0%25B0%25D0%25BA%25D1%2582%25D0%25B5%25D1%2580%25D0%25B8%25D1%2581%25D1%2582%25D0%25B8%25D0%25BA%25D0%25BE%25D0%25B9">    </a> ( <i>Infinite Impulse Response</i> ,  <i>IIR</i> ).  <a href="http://www.dspguide.com/ch14/1.htm"> </a> ,      .      ,         ,      . <br> <br>   <br>       ,     ,     .   ,  ,      ,  ,          .           ,  NI Massive,   ¬´ <a href="http://lurkmore.to/%25D0%25A2%25D1%2591%25D0%25BF%25D0%25BB%25D1%258B%25D0%25B9_%25D0%25BB%25D0%25B0%25D0%25BC%25D0%25BF%25D0%25BE%25D0%25B2%25D1%258B%25D0%25B9_%25D0%25B7%25D0%25B2%25D1%2583%25D0%25BA">  </a> ¬ª.       ,          ,   .        ,          (  Massive       ).      ¬´¬ª , , , AAS Ultra Analog,       ,     ,    ,        .         ,  ,    <a href="http://www.kvraudio.com/forum/viewtopic.php%3Ft%3D350246"></a> ,   ,      NI Reaktor. ,            ‚Äî    ,    ..     . <br> <br>   <br>     .   GUI.  <i>bg.png</i>   ( <i>‚ÄúMove to trash‚Äù</i>  Xcode),       : <br> <br> <a href="">filtermode.png</a> <a href="">knob_small.png</a> (  ,   50 50 ) <a href="">bg.png</a> (       ) <br> <br>    ID  <i>resource.h</i> : <br> <br> <code class="cpp">// Unique IDs for each image resource. #define BG_ID 101 #define WHITE_KEY_ID 102 #define BLACK_KEY_ID 103 #define WAVEFORM_ID 104 #define KNOB_ID 105 #define KNOB_SMALL_ID 106 #define FILTERMODE_ID 107 // Image resource locations for this plug. #define BG_FN "resources/img/bg.png" #define WHITE_KEY_FN "resources/img/whitekey.png" #define BLACK_KEY_FN "resources/img/blackkey.png" #define WAVEFORM_FN "resources/img/waveform.png" #define KNOB_FN "resources/img/knob.png" #define KNOB_SMALL_FN "resources/img/knob_small.png" #define FILTERMODE_FN "resources/img/filtermode.png"</code> <br> <br>  <i>Synthesis.rc</i> : <br> <br> <code class="cpp">#include "resource.h" BG_ID PNG BG_FN WHITE_KEY_ID PNG WHITE_KEY_FN BLACK_KEY_ID PNG BLACK_KEY_FN WAVEFORM_ID PNG WAVEFORM_FN KNOB_ID PNG KNOB_FN KNOB_SMALL_ID PNG KNOB_SMALL_FN FILTERMODE_ID PNG FILTERMODE_FN</code> <br> <br>   <code>#include "Filter.h"</code>  <i>Synthesis.h</i>    <code>private</code> : <br> <br> <code class="cpp">Filter mFilter;</code> <br> <br>  <code>EParams</code>  <i>Synthesis.cpp</i> : <br> <br> <code class="cpp">enum EParams { mWaveform = 0, mAttack, mDecay, mSustain, mRelease, mFilterMode, mFilterCutoff, mFilterResonance, mFilterAttack, mFilterDecay, mFilterSustain, mFilterRelease, mFilterEnvelopeAmount, kNumParams };</code> <br> <br>        : <br> <br> <code class="cpp">pGraphics-&gt;AttachControl(new ISwitchControl(this, 24, 38, mWaveform, &amp;waveformBitmap));</code> <br> <br>      .      (Lowpass, Highpass, Bandpass).    <code>AttachGraphics(pGraphics)</code> : <br> <br> <code class="cpp">GetParam(mFilterMode)-&gt;InitEnum("Filter Mode", Filter::FILTER_MODE_LOWPASS, Filter::kNumFilterModes); IBitmap filtermodeBitmap = pGraphics-&gt;LoadIBitmap(FILTERMODE_ID, FILTERMODE_FN, 3); pGraphics-&gt;AttachControl(new ISwitchControl(this, 24, 123, mFilterMode, &amp;filtermodeBitmap));</code> <br> <br>         .    .     <i>knob_small.png</i> : <br> <br> <code class="cpp">// Knobs for filter cutoff and resonance IBitmap smallKnobBitmap = pGraphics-&gt;LoadIBitmap(KNOB_SMALL_ID, KNOB_SMALL_FN, 64); // Cutoff knob: GetParam(mFilterCutoff)-&gt;InitDouble("Cutoff", 0.99, 0.01, 0.99, 0.001); GetParam(mFilterCutoff)-&gt;SetShape(2); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 5, 177, mFilterCutoff, &amp;smallKnobBitmap)); // Resonance knob: GetParam(mFilterResonance)-&gt;InitDouble("Resonance", 0.01, 0.01, 1.0, 0.001); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 61, 177, mFilterResonance, &amp;smallKnobBitmap));</code> <br> <br>   ,           <code>1.0</code> ,   <code>calculateFeedbackAmount</code>    , . <br>  <code>ProcessDoubleReplacing</code>     : <br> <br> <code class="cpp">leftOutput[i] = rightOutput[i] = mFilter.process(mOscillator.nextSample() * mEnvelopeGenerator.nextSample() * velocity / 127.0);</code> <br> <br>       .  <code>switch</code>   <code>Synthesis::OnParamChange</code> : <br> <br> <code class="cpp">case mFilterCutoff: mFilter.setCutoff(GetParam(paramIdx)-&gt;Value()); break; case mFilterResonance: mFilter.setResonance(GetParam(paramIdx)-&gt;Value()); break; case mFilterMode: mFilter.setFilterMode(static_cast&lt;Filter::FilterMode&gt;(GetParam(paramIdx)-&gt;Int())); break;</code> <br> <br>    .  -      . <br> <br>  <br> <br>  ‚Äî      .   ,   ,          . <br>      : <br> <br> <code class="cpp">buf0 += cutoff * (inputValue - buf0 + feedbackAmount * (buf0 - buf1));</code> <br> <br> ,   ,      ( <code>buf0 ‚Äì buf1</code> ),   <code>feedbackAmount</code> .    <code>calculateFeedbackAmount</code>  <code>feedbackAmount</code>  <code>resonance</code> , . .    ,   . <br> <br>  ,            .     ,  <i></i> ,      <a href="https://www.youtube.com/watch%3Fv%3DJWyMj6KxGHM"> </a> .    ,        ,       . <br> <br>  -12 /  -24 / <br>        !     24   .     <code>switch</code>  <code>Filter::process</code> : <br> <br> <code class="cpp">buf2 += cutoff * (buf1 - buf2); buf3 += cutoff * (buf2 ‚Äì buf3);</code> <br> <br>   :      ,       ,            .     ,       , , <a href="https://ccrma.stanford.edu/~Jos/filters/Filter_Stability.html"></a> (       ).     <code>switch</code> : <br> <br> <code class="cpp">switch (mode) { case FILTER_MODE_LOWPASS: return buf3; case FILTER_MODE_HIGHPASS: return inputValue - buf3; case FILTER_MODE_BANDPASS: return buf0 - buf3; default: return 0.0; }</code> <br> <br>   <code>buf1</code>  <code>buf3</code> ‚Äì      .    -24 /.     <code>buf2</code>  <code>buf3</code> ,        <code>private</code> <i>Filter.h</i> : <br> <br> <code class="cpp">double buf2; double buf3;</code> <br> <br>    ,   <code>buf0</code> c <code>buf1</code> : <br> <br> <code class="cpp">Filter() : // ... buf0(0.0), buf1(0.0), buf2(0.0), buf3(0.0) // ...</code> <br> <br>     , ,     :     .       . <br>          ? <br> <br>   <br>    .  ,           ,       . <br> -      <code>cutoff</code>   .      .    <code>cutoffMod</code> ,    ,       <code>cutoff</code>    .     <code>#include    private</code> : <br> <br> <code class="cpp">double cutoffMod;</code> <br> <br> : <br> <br> <code class="cpp">Filter() : cutoff(0.99), resonance(0.01), cutoffMod(0.0), // ...</code> <br> <br>         .   <code>private</code> : <br> <br> <code class="cpp">inline double getCalculatedCutoff() const { return fmax(fmin(cutoff + cutoffMod, 0.99), 0.01); };</code> <br> <br> <code>calculateFeedbackAmount</code>     : <br> <br> <code class="cpp">inline void calculateFeedbackAmount() { feedbackAmount = resonance + resonance/(1.0 - getCalculatedCutoff()); }</code> <br> <br>       <code>cutoffMod</code> .   <code>feedbackAmount</code>    ,     : <br> <br> <code class="cpp">inline void setCutoffMod(double newCutoffMod) { cutoffMod = newCutoffMod; calculateFeedbackAmount(); }</code> <br> <br> ,       .   <code>Filter::process</code>   : <br> <br> <code class="cpp">if (inputValue == 0.0) return inputValue; double calculatedCutoff = getCalculatedCutoff(); buf0 += calculatedCutoff * (inputValue - buf0 + feedbackAmount * (buf0 - buf1)); buf1 += calculatedCutoff * (buf0 - buf1); buf2 += calculatedCutoff * (buf1 - buf2); buf3 += calculatedCutoff * (buf2 ‚Äì buf3);</code> <br> <br>        ,    .    ,      ,   .     .     <code>cutoff</code>  <code>calculatedCutoff</code>   -. <br> <br> ,       ( <code>setCutoffMod</code> ),   <code>Synthesis</code>    ,     ,    .    ,        <code>cutoffMod</code> .    <code>filterEnvelopeAmount</code>    <code>-1</code>  <code>+1</code> .   GUI. <br> <br>   <code>private</code> <i>Synthesis.h</i>    : <br> <br> <code class="cpp">EnvelopeGenerator mFilterEnvelopeGenerator; double filterEnvelopeAmount;</code> <br> <br>       MIDI ,      <code>onNoteOn</code>  <code>onNoteOff</code> : <br> <br> <code class="cpp">inline void onNoteOn(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); mFilterEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); }; inline void onNoteOff(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); mFilterEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); };</code> <br> <br>    .   <code>ProcessDoubleReplacing</code>        : <br> <br> <code class="cpp">mFilter.setCutoffMod(mFilterEnvelopeGenerator.nextSample() * filterEnvelopeAmount);</code> <br> <br>  ,        <code>nextSample</code>  <code>filterEnvelopeAmount</code>     <code>cutoffMod</code> .     <code>filterEnvelopeAmount</code>  : <br> <br> <code class="cpp">Synthesis::Synthesis(IPlugInstanceInfo instanceInfo) : IPLUG_CTOR(kNumParams, kNumPrograms, instanceInfo), lastVirtualKeyboardNoteNumber(virtualKeyboardMinimumNoteNumber - 1), filterEnvelopeAmount(0.0) { // ... }</code> <br> <br>       <code>Synthesis::Reset</code> : <br> <br> <code class="cpp">mFilterEnvelopeGenerator.setSampleRate(GetSampleRate());</code> <br> <br>      <code>EParams</code> ,       .  <code>AttachGraphics</code>     : <br> <br> <code class="cpp">// Knobs for filter envelope // Attack knob GetParam(mFilterAttack)-&gt;InitDouble("Filter Env Attack", 0.01, 0.01, 10.0, 0.001); GetParam(mFilterAttack)-&gt;SetShape(3); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 139, 178, mFilterAttack, &amp;smallKnobBitmap)); // Decay knob: GetParam(mFilterDecay)-&gt;InitDouble("Filter Env Decay", 0.5, 0.01, 15.0, 0.001); GetParam(mFilterDecay)-&gt;SetShape(3); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 195, 178, mFilterDecay, &amp;smallKnobBitmap)); // Sustain knob: GetParam(mFilterSustain)-&gt;InitDouble("Filter Env Sustain", 0.1, 0.001, 1.0, 0.001); GetParam(mFilterSustain)-&gt;SetShape(2); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 251, 178, mFilterSustain, &amp;smallKnobBitmap)); // Release knob: GetParam(mFilterRelease)-&gt;InitDouble("Filter Env Release", 1.0, 0.001, 15.0, 0.001); GetParam(mFilterRelease)-&gt;SetShape(3); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 307, 178, mFilterRelease, &amp;smallKnobBitmap)); // Filter envelope amount knob: GetParam(mFilterEnvelopeAmount)-&gt;InitDouble("Filter Env Amount", 0.0, -1.0, 1.0, 0.001); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 363, 178, mFilterEnvelopeAmount, &amp;smallKnobBitmap));</code> <br> <br>     ,       <code>smallKnobBitmap</code> .                   .     ,    .  <code>Synthesis::OnParamChange</code>    <code>switch</code> : <br> <br> <code class="cpp">case mFilterAttack: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK, GetParam(paramIdx)-&gt;Value()); break; case mFilterDecay: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_DECAY, GetParam(paramIdx)-&gt;Value()); break; case mFilterSustain: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_SUSTAIN, GetParam(paramIdx)-&gt;Value()); break; case mFilterRelease: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE, GetParam(paramIdx)-&gt;Value()); break; case mFilterEnvelopeAmount: filterEnvelopeAmount = GetParam(paramIdx)-&gt;Value(); break;</code> <br> <br> ! <br>     !           (-   C1),   : <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/f5d/757/3f9/f5d7573f9b3a720fe5898d88ae477cfc.png"> <br> <br>        <code>EnvelopeGenerator</code>  .         .        ! <br> <br>    <a href=""></a> . <br> <br>        :) <br> <br>  : <br> <a href="http://martin-finke.de/blog/articles/audio-plugins-013-filter/">martin-finke.de/blog/articles/audio-plugins-013-filter</a></code></code> <pre> <code class="hljs erlang-repl"><code class="cpp">#include  <i>Filter.h</i> ( )     : <br> <br> class Filter { public: enum FilterMode { FILTER_MODE_LOWPASS = <span class="hljs-number"><span class="hljs-number">0</span></span>, FILTER_MODE_HIGHPASS, FILTER_MODE_BANDPASS, kNumFilterModes }; Filter() : cutoff(<span class="hljs-number"><span class="hljs-number">0.99</span></span>), resonance(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), mode(FILTER_MODE_LOWPASS), buf0(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), buf1(<span class="hljs-number"><span class="hljs-number">0.0</span></span>) { calculateFeedbackAmount(); }; double process(double inputValue); inline void setCutoff(double newCutoff) { cutoff = newCutoff; calculateFeedbackAmount(); }; inline void setResonance(double newResonance) { resonance = newResonance; calculateFeedbackAmount(); }; inline void setFilterMode(FilterMode newMode) { mode = newMode; } private: double cutoff; double resonance; FilterMode mode; double feedbackAmount; inline void calculateFeedbackAmount() { feedbackAmount = resonance + resonance/(<span class="hljs-number"><span class="hljs-number">1.0</span></span> - cutoff); } double buf0; double buf1; };</code> <br> <br>  <code>private</code>     <i> </i> <code>cutoff</code>  <i></i> <code>resonance</code> . <code>Mode</code>      (Lowpass, Highpass, Bandpass).  <code>feedbackAmount</code> , <code>buf0</code>  <code>buf1</code>    ,    . <br>          ( <code>calculateFeedbackAmount()</code> ).  <code>process</code>      .   <code>feedbackAmount</code>   <code>cutoff</code>  <code>resonance</code> ,    <code>calculateFeedbackAmount</code>      . <br> <br>   <i>Filter.cpp</i>  : <br> <br> <code class="cpp">// By Paul Kellett // http://www.musicdsp.org/showone.php?id=<span class="hljs-number"><span class="hljs-number">29</span></span> double Filter::process(double inputValue) { buf0 += cutoff * (inputValue - buf0); buf1 += cutoff * (buf0 - buf1); switch (mode) { case FILTER_MODE_LOWPASS: return buf1; case FILTER_MODE_HIGHPASS: return inputValue - buf0; case FILTER_MODE_BANDPASS: return buf0 - buf1; default: return <span class="hljs-number"><span class="hljs-number">0.0</span></span>; } }</code> <br> <br> , ?  ,         <i> </i> . ¬´ ¬ª   ,               (. .    <span class="hljs-number"><span class="hljs-number">6</span></span> ).     <code>buf0</code>  <code>buf1</code> :        .     <code>inputValue</code> ,  - <code>buf0</code> (  ).   .    <span class="hljs-number"><span class="hljs-number">6</span></span> /   <span class="hljs-number"><span class="hljs-number">12</span></span> /.  <code>switch</code> ,  <code>buf1</code>    . , ,    <code>buf0</code> ,       <span class="hljs-number"><span class="hljs-number">12</span></span>,   <span class="hljs-number"><span class="hljs-number">6</span></span> /,        . <br> <br>  <code>case</code> <code>FILTER_MODE_HIGHPASS</code>    . <code>buf0</code>       .   <code>inputValue</code>  <code>buf0</code> ,   .    <code>buf1</code> ,     . <br> <br>  <code>case</code> <code>FILTER_MODE_BANDPASS</code> ,  <code>buf0 - buf1</code>   .  <code>buf0</code>       ,     <code>buf1</code> . ,   . <br>  :    <i> </i>    <i> </i> ,   . <br> <br>  <code>buf1</code>     .       <a href="http://ru.wikipedia.org/wiki/%25D0%25A4%25D0%25B8%25D0%25BB%25D1%258C%25D1%2582%25D1%2580_%25D1%2581_%25D0%25B1%25D0%25B5%25D1%2581%25D0%25BA%25D0%25BE%25D0%25BD%25D0%25B5%25D1%2587%25D0%25BD%25D0%25BE%25D0%25B9_%25D0%25B8%25D0%25BC%25D0%25BF%25D1%2583%25D0%25BB%25D1%258C%25D1%2581%25D0%25BD%25D0%25BE%25D0%25B9_%25D1%2585%25D0%25B0%25D1%2580%25D0%25B0%25D0%25BA%25D1%2582%25D0%25B5%25D1%2580%25D0%25B8%25D1%2581%25D1%2582%25D0%25B8%25D0%25BA%25D0%25BE%25D0%25B9">    </a> ( <i>Infinite Impulse Response</i> ,  <i>IIR</i> ).  <a href="http://www.dspguide.com/ch14/1.htm"> </a> ,      .      ,         ,      . <br> <br>   <br>       ,     ,     .   ,  ,      ,  ,          .           ,  NI Massive,   ¬´ <a href="http://lurkmore.to/%25D0%25A2%25D1%2591%25D0%25BF%25D0%25BB%25D1%258B%25D0%25B9_%25D0%25BB%25D0%25B0%25D0%25BC%25D0%25BF%25D0%25BE%25D0%25B2%25D1%258B%25D0%25B9_%25D0%25B7%25D0%25B2%25D1%2583%25D0%25BA">  </a> ¬ª.       ,          ,   .        ,          (  Massive       ).      ¬´¬ª , , , AAS Ultra Analog,       ,     ,    ,        .         ,  ,    <a href="http://www.kvraudio.com/forum/viewtopic.php%3Ft%3D350246"></a> ,   ,      NI Reaktor. ,            ‚Äî    ,    ..     . <br> <br>   <br>     .   GUI.  <i>bg.png</i>   ( <i>‚ÄúMove to trash‚Äù</i>  Xcode),       : <br> <br> <a href="">filtermode.png</a> <a href="">knob_small.png</a> (  ,   <span class="hljs-number"><span class="hljs-number">50</span></span> <span class="hljs-number"><span class="hljs-number">50</span></span> ) <a href="">bg.png</a> (       ) <br> <br>    ID  <i>resource.h</i> : <br> <br> <code class="cpp">// Unique IDs for each image resource. #define BG_ID <span class="hljs-number"><span class="hljs-number">101</span></span> #define WHITE_KEY_ID <span class="hljs-number"><span class="hljs-number">102</span></span> #define BLACK_KEY_ID <span class="hljs-number"><span class="hljs-number">103</span></span> #define WAVEFORM_ID <span class="hljs-number"><span class="hljs-number">104</span></span> #define KNOB_ID <span class="hljs-number"><span class="hljs-number">105</span></span> #define KNOB_SMALL_ID <span class="hljs-number"><span class="hljs-number">106</span></span> #define FILTERMODE_ID <span class="hljs-number"><span class="hljs-number">107</span></span> // Image resource locations for this plug. #define BG_FN <span class="hljs-string"><span class="hljs-string">"resources/img/bg.png"</span></span> #define WHITE_KEY_FN <span class="hljs-string"><span class="hljs-string">"resources/img/whitekey.png"</span></span> #define BLACK_KEY_FN <span class="hljs-string"><span class="hljs-string">"resources/img/blackkey.png"</span></span> #define WAVEFORM_FN <span class="hljs-string"><span class="hljs-string">"resources/img/waveform.png"</span></span> #define KNOB_FN <span class="hljs-string"><span class="hljs-string">"resources/img/knob.png"</span></span> #define KNOB_SMALL_FN <span class="hljs-string"><span class="hljs-string">"resources/img/knob_small.png"</span></span> #define FILTERMODE_FN <span class="hljs-string"><span class="hljs-string">"resources/img/filtermode.png"</span></span></code> <br> <br>  <i>Synthesis.rc</i> : <br> <br> <code class="cpp">#include <span class="hljs-string"><span class="hljs-string">"resource.h"</span></span> BG_ID PNG BG_FN WHITE_KEY_ID PNG WHITE_KEY_FN BLACK_KEY_ID PNG BLACK_KEY_FN WAVEFORM_ID PNG WAVEFORM_FN KNOB_ID PNG KNOB_FN KNOB_SMALL_ID PNG KNOB_SMALL_FN FILTERMODE_ID PNG FILTERMODE_FN</code> <br> <br>   <code>#include <span class="hljs-string"><span class="hljs-string">"Filter.h"</span></span></code>  <i>Synthesis.h</i>    <code>private</code> : <br> <br> <code class="cpp">Filter mFilter;</code> <br> <br>  <code>EParams</code>  <i>Synthesis.cpp</i> : <br> <br> <code class="cpp">enum EParams { mWaveform = <span class="hljs-number"><span class="hljs-number">0</span></span>, mAttack, mDecay, mSustain, mRelease, mFilterMode, mFilterCutoff, mFilterResonance, mFilterAttack, mFilterDecay, mFilterSustain, mFilterRelease, mFilterEnvelopeAmount, kNumParams };</code> <br> <br>        : <br> <br> <code class="cpp">pGraphics-&gt;AttachControl(new ISwitchControl(this, <span class="hljs-number"><span class="hljs-number">24</span></span>, <span class="hljs-number"><span class="hljs-number">38</span></span>, mWaveform, &amp;waveformBitmap));</code> <br> <br>      .      (Lowpass, Highpass, Bandpass).    <code>AttachGraphics(pGraphics)</code> : <br> <br> <code class="cpp">GetParam(mFilterMode)-&gt;InitEnum(<span class="hljs-string"><span class="hljs-string">"Filter Mode"</span></span>, Filter::FILTER_MODE_LOWPASS, Filter::kNumFilterModes); IBitmap filtermodeBitmap = pGraphics-&gt;LoadIBitmap(FILTERMODE_ID, FILTERMODE_FN, <span class="hljs-number"><span class="hljs-number">3</span></span>); pGraphics-&gt;AttachControl(new ISwitchControl(this, <span class="hljs-number"><span class="hljs-number">24</span></span>, <span class="hljs-number"><span class="hljs-number">123</span></span>, mFilterMode, &amp;filtermodeBitmap));</code> <br> <br>         .    .     <i>knob_small.png</i> : <br> <br> <code class="cpp">// Knobs for filter cutoff and resonance IBitmap smallKnobBitmap = pGraphics-&gt;LoadIBitmap(KNOB_SMALL_ID, KNOB_SMALL_FN, <span class="hljs-number"><span class="hljs-number">64</span></span>); // Cutoff knob: GetParam(mFilterCutoff)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Cutoff"</span></span>, <span class="hljs-number"><span class="hljs-number">0.99</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">0.99</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); GetParam(mFilterCutoff)-&gt;SetShape(<span class="hljs-number"><span class="hljs-number">2</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-number"><span class="hljs-number">177</span></span>, mFilterCutoff, &amp;smallKnobBitmap)); // Resonance knob: GetParam(mFilterResonance)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Resonance"</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">61</span></span>, <span class="hljs-number"><span class="hljs-number">177</span></span>, mFilterResonance, &amp;smallKnobBitmap));</code> <br> <br>   ,           <code><span class="hljs-number"><span class="hljs-number">1.0</span></span></code> ,   <code>calculateFeedbackAmount</code>    , . <br>  <code>ProcessDoubleReplacing</code>     : <br> <br> <code class="cpp">leftOutput[i] = rightOutput[i] = mFilter.process(mOscillator.nextSample() * mEnvelopeGenerator.nextSample() * velocity / <span class="hljs-number"><span class="hljs-number">127.0</span></span>);</code> <br> <br>       .  <code>switch</code>   <code>Synthesis::OnParamChange</code> : <br> <br> <code class="cpp">case mFilterCutoff: mFilter.setCutoff(GetParam(paramIdx)-&gt;Value()); break; case mFilterResonance: mFilter.setResonance(GetParam(paramIdx)-&gt;Value()); break; case mFilterMode: mFilter.setFilterMode(static_cast&lt;Filter::FilterMode&gt;(GetParam(paramIdx)-&gt;Int())); break;</code> <br> <br>    .  -      . <br> <br>  <br> <br>  ‚Äî      .   ,   ,          . <br>      : <br> <br> <code class="cpp">buf0 += cutoff * (inputValue - buf0 + feedbackAmount * (buf0 - buf1));</code> <br> <br> ,   ,      ( <code>buf0 ‚Äì buf1</code> ),   <code>feedbackAmount</code> .    <code>calculateFeedbackAmount</code>  <code>feedbackAmount</code>  <code>resonance</code> , . .    ,   . <br> <br>  ,            .     ,  <i></i> ,      <a href="https://www.youtube.com/watch%3Fv%3DJWyMj6KxGHM"> </a> .    ,        ,       . <br> <br>  -<span class="hljs-number"><span class="hljs-number">12</span></span> /  -<span class="hljs-number"><span class="hljs-number">24</span></span> / <br>        !     <span class="hljs-number"><span class="hljs-number">24</span></span>   .     <code>switch</code>  <code>Filter::process</code> : <br> <br> <code class="cpp">buf2 += cutoff * (buf1 - buf2); buf3 += cutoff * (buf2 ‚Äì buf3);</code> <br> <br>   :      ,       ,            .     ,       , , <a href="https://ccrma.stanford.edu/~Jos/filters/Filter_Stability.html"></a> (       ).     <code>switch</code> : <br> <br> <code class="cpp">switch (mode) { case FILTER_MODE_LOWPASS: return buf3; case FILTER_MODE_HIGHPASS: return inputValue - buf3; case FILTER_MODE_BANDPASS: return buf0 - buf3; default: return <span class="hljs-number"><span class="hljs-number">0.0</span></span>; }</code> <br> <br>   <code>buf1</code>  <code>buf3</code> ‚Äì      .    -<span class="hljs-number"><span class="hljs-number">24</span></span> /.     <code>buf2</code>  <code>buf3</code> ,        <code>private</code> <i>Filter.h</i> : <br> <br> <code class="cpp">double buf2; double buf3;</code> <br> <br>    ,   <code>buf0</code> c <code>buf1</code> : <br> <br> <code class="cpp">Filter() : // ... buf0(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), buf1(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), buf2(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), buf3(<span class="hljs-number"><span class="hljs-number">0.0</span></span>) // ...</code> <br> <br>     , ,     :     .       . <br>          ? <br> <br>   <br>    .  ,           ,       . <br> -      <code>cutoff</code>   .      .    <code>cutoffMod</code> ,    ,       <code>cutoff</code>    .     <code><code>#include    private</code> : <br> <br> <code class="cpp">double cutoffMod;</code> <br> <br> : <br> <br> <code class="cpp">Filter() : cutoff(<span class="hljs-number"><span class="hljs-number">0.99</span></span>), resonance(<span class="hljs-number"><span class="hljs-number">0.01</span></span>), cutoffMod(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), // ...</code> <br> <br>         .   <code>private</code> : <br> <br> <code class="cpp">inline double getCalculatedCutoff() const { return fmax(fmin(cutoff + cutoffMod, <span class="hljs-number"><span class="hljs-number">0.99</span></span>), <span class="hljs-number"><span class="hljs-number">0.01</span></span>); };</code> <br> <br> <code>calculateFeedbackAmount</code>     : <br> <br> <code class="cpp">inline void calculateFeedbackAmount() { feedbackAmount = resonance + resonance/(<span class="hljs-number"><span class="hljs-number">1.0</span></span> - getCalculatedCutoff()); }</code> <br> <br>       <code>cutoffMod</code> .   <code>feedbackAmount</code>    ,     : <br> <br> <code class="cpp">inline void setCutoffMod(double newCutoffMod) { cutoffMod = newCutoffMod; calculateFeedbackAmount(); }</code> <br> <br> ,       .   <code>Filter::process</code>   : <br> <br> <code class="cpp">if (inputValue == <span class="hljs-number"><span class="hljs-number">0.0</span></span>) return inputValue; double calculatedCutoff = getCalculatedCutoff(); buf0 += calculatedCutoff * (inputValue - buf0 + feedbackAmount * (buf0 - buf1)); buf1 += calculatedCutoff * (buf0 - buf1); buf2 += calculatedCutoff * (buf1 - buf2); buf3 += calculatedCutoff * (buf2 ‚Äì buf3);</code> <br> <br>        ,    .    ,      ,   .     .     <code>cutoff</code>  <code>calculatedCutoff</code>   -. <br> <br> ,       ( <code>setCutoffMod</code> ),   <code>Synthesis</code>    ,     ,    .    ,        <code>cutoffMod</code> .    <code>filterEnvelopeAmount</code>    <code>-<span class="hljs-number"><span class="hljs-number">1</span></span></code>  <code>+<span class="hljs-number"><span class="hljs-number">1</span></span></code> .   GUI. <br> <br>   <code>private</code> <i>Synthesis.h</i>    : <br> <br> <code class="cpp">EnvelopeGenerator mFilterEnvelopeGenerator; double filterEnvelopeAmount;</code> <br> <br>       MIDI ,      <code>onNoteOn</code>  <code>onNoteOff</code> : <br> <br> <code class="cpp">inline void onNoteOn(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); mFilterEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); }; inline void onNoteOff(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); mFilterEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); };</code> <br> <br>    .   <code>ProcessDoubleReplacing</code>        : <br> <br> <code class="cpp">mFilter.setCutoffMod(mFilterEnvelopeGenerator.nextSample() * filterEnvelopeAmount);</code> <br> <br>  ,        <code>nextSample</code>  <code>filterEnvelopeAmount</code>     <code>cutoffMod</code> .     <code>filterEnvelopeAmount</code>  : <br> <br> <code class="cpp">Synthesis::Synthesis(IPlugInstanceInfo instanceInfo) : IPLUG_CTOR(kNumParams, kNumPrograms, instanceInfo), lastVirtualKeyboardNoteNumber(virtualKeyboardMinimumNoteNumber - <span class="hljs-number"><span class="hljs-number">1</span></span>), filterEnvelopeAmount(<span class="hljs-number"><span class="hljs-number">0.0</span></span>) { // ... }</code> <br> <br>       <code>Synthesis::Reset</code> : <br> <br> <code class="cpp">mFilterEnvelopeGenerator.setSampleRate(GetSampleRate());</code> <br> <br>      <code>EParams</code> ,       .  <code>AttachGraphics</code>     : <br> <br> <code class="cpp">// Knobs for filter envelope // Attack knob GetParam(mFilterAttack)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Filter Env Attack"</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">10.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); GetParam(mFilterAttack)-&gt;SetShape(<span class="hljs-number"><span class="hljs-number">3</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">139</span></span>, <span class="hljs-number"><span class="hljs-number">178</span></span>, mFilterAttack, &amp;smallKnobBitmap)); // Decay knob: GetParam(mFilterDecay)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Filter Env Decay"</span></span>, <span class="hljs-number"><span class="hljs-number">0.5</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">15.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); GetParam(mFilterDecay)-&gt;SetShape(<span class="hljs-number"><span class="hljs-number">3</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">195</span></span>, <span class="hljs-number"><span class="hljs-number">178</span></span>, mFilterDecay, &amp;smallKnobBitmap)); // Sustain knob: GetParam(mFilterSustain)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Filter Env Sustain"</span></span>, <span class="hljs-number"><span class="hljs-number">0.1</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>, <span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); GetParam(mFilterSustain)-&gt;SetShape(<span class="hljs-number"><span class="hljs-number">2</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">251</span></span>, <span class="hljs-number"><span class="hljs-number">178</span></span>, mFilterSustain, &amp;smallKnobBitmap)); // Release knob: GetParam(mFilterRelease)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Filter Env Release"</span></span>, <span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>, <span class="hljs-number"><span class="hljs-number">15.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); GetParam(mFilterRelease)-&gt;SetShape(<span class="hljs-number"><span class="hljs-number">3</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">307</span></span>, <span class="hljs-number"><span class="hljs-number">178</span></span>, mFilterRelease, &amp;smallKnobBitmap)); // Filter envelope amount knob: GetParam(mFilterEnvelopeAmount)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Filter Env Amount"</span></span>, <span class="hljs-number"><span class="hljs-number">0.0</span></span>, -<span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">363</span></span>, <span class="hljs-number"><span class="hljs-number">178</span></span>, mFilterEnvelopeAmount, &amp;smallKnobBitmap));</code> <br> <br>     ,       <code>smallKnobBitmap</code> .                   .     ,    .  <code>Synthesis::OnParamChange</code>    <code>switch</code> : <br> <br> <code class="cpp">case mFilterAttack: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK, GetParam(paramIdx)-&gt;Value()); break; case mFilterDecay: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_DECAY, GetParam(paramIdx)-&gt;Value()); break; case mFilterSustain: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_SUSTAIN, GetParam(paramIdx)-&gt;Value()); break; case mFilterRelease: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE, GetParam(paramIdx)-&gt;Value()); break; case mFilterEnvelopeAmount: filterEnvelopeAmount = GetParam(paramIdx)-&gt;Value(); break;</code> <br> <br> ! <br>     !           (-   C1),   : <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/f5d/757/3f9/f5d7573f9b3a720fe5898d88ae477cfc.png"> <br> <br>        <code>EnvelopeGenerator</code>  .         .        ! <br> <br>    <a href=""></a> . <br> <br>        :) <br> <br>  : <br> <a href="http://martin-finke.de/blog/articles/audio-plugins-013-filter/">martin-finke.de/blog/articles/audio-plugins-<span class="hljs-number"><span class="hljs-number">013</span></span>-filter</a></code></code> </pre> <code><code><code class="cpp">#include  <i>Filter.h</i> ( )     : <br> <br> class Filter { public: enum FilterMode { FILTER_MODE_LOWPASS = 0, FILTER_MODE_HIGHPASS, FILTER_MODE_BANDPASS, kNumFilterModes }; Filter() : cutoff(0.99), resonance(0.0), mode(FILTER_MODE_LOWPASS), buf0(0.0), buf1(0.0) { calculateFeedbackAmount(); }; double process(double inputValue); inline void setCutoff(double newCutoff) { cutoff = newCutoff; calculateFeedbackAmount(); }; inline void setResonance(double newResonance) { resonance = newResonance; calculateFeedbackAmount(); }; inline void setFilterMode(FilterMode newMode) { mode = newMode; } private: double cutoff; double resonance; FilterMode mode; double feedbackAmount; inline void calculateFeedbackAmount() { feedbackAmount = resonance + resonance/(1.0 - cutoff); } double buf0; double buf1; };</code> <br> <br>  <code>private</code>     <i> </i> <code>cutoff</code>  <i></i> <code>resonance</code> . <code>Mode</code>      (Lowpass, Highpass, Bandpass).  <code>feedbackAmount</code> , <code>buf0</code>  <code>buf1</code>    ,    . <br>          ( <code>calculateFeedbackAmount()</code> ).  <code>process</code>      .   <code>feedbackAmount</code>   <code>cutoff</code>  <code>resonance</code> ,    <code>calculateFeedbackAmount</code>      . <br> <br>   <i>Filter.cpp</i>  : <br> <br> <code class="cpp">// By Paul Kellett // http://www.musicdsp.org/showone.php?id=29 double Filter::process(double inputValue) { buf0 += cutoff * (inputValue - buf0); buf1 += cutoff * (buf0 - buf1); switch (mode) { case FILTER_MODE_LOWPASS: return buf1; case FILTER_MODE_HIGHPASS: return inputValue - buf0; case FILTER_MODE_BANDPASS: return buf0 - buf1; default: return 0.0; } }</code> <br> <br> , ?  ,         <i> </i> . ¬´ ¬ª   ,               (. .    6 ).     <code>buf0</code>  <code>buf1</code> :        .     <code>inputValue</code> ,  - <code>buf0</code> (  ).   .    6 /   12 /.  <code>switch</code> ,  <code>buf1</code>    . , ,    <code>buf0</code> ,       12,   6 /,        . <br> <br>  <code>case</code> <code>FILTER_MODE_HIGHPASS</code>    . <code>buf0</code>       .   <code>inputValue</code>  <code>buf0</code> ,   .    <code>buf1</code> ,     . <br> <br>  <code>case</code> <code>FILTER_MODE_BANDPASS</code> ,  <code>buf0 - buf1</code>   .  <code>buf0</code>       ,     <code>buf1</code> . ,   . <br>  :    <i> </i>    <i> </i> ,   . <br> <br>  <code>buf1</code>     .       <a href="http://ru.wikipedia.org/wiki/%25D0%25A4%25D0%25B8%25D0%25BB%25D1%258C%25D1%2582%25D1%2580_%25D1%2581_%25D0%25B1%25D0%25B5%25D1%2581%25D0%25BA%25D0%25BE%25D0%25BD%25D0%25B5%25D1%2587%25D0%25BD%25D0%25BE%25D0%25B9_%25D0%25B8%25D0%25BC%25D0%25BF%25D1%2583%25D0%25BB%25D1%258C%25D1%2581%25D0%25BD%25D0%25BE%25D0%25B9_%25D1%2585%25D0%25B0%25D1%2580%25D0%25B0%25D0%25BA%25D1%2582%25D0%25B5%25D1%2580%25D0%25B8%25D1%2581%25D1%2582%25D0%25B8%25D0%25BA%25D0%25BE%25D0%25B9">    </a> ( <i>Infinite Impulse Response</i> ,  <i>IIR</i> ).  <a href="http://www.dspguide.com/ch14/1.htm"> </a> ,      .      ,         ,      . <br> <br>   <br>       ,     ,     .   ,  ,      ,  ,          .           ,  NI Massive,   ¬´ <a href="http://lurkmore.to/%25D0%25A2%25D1%2591%25D0%25BF%25D0%25BB%25D1%258B%25D0%25B9_%25D0%25BB%25D0%25B0%25D0%25BC%25D0%25BF%25D0%25BE%25D0%25B2%25D1%258B%25D0%25B9_%25D0%25B7%25D0%25B2%25D1%2583%25D0%25BA">  </a> ¬ª.       ,          ,   .        ,          (  Massive       ).      ¬´¬ª , , , AAS Ultra Analog,       ,     ,    ,        .         ,  ,    <a href="http://www.kvraudio.com/forum/viewtopic.php%3Ft%3D350246"></a> ,   ,      NI Reaktor. ,            ‚Äî    ,    ..     . <br> <br>   <br>     .   GUI.  <i>bg.png</i>   ( <i>‚ÄúMove to trash‚Äù</i>  Xcode),       : <br> <br> <a href="">filtermode.png</a> <a href="">knob_small.png</a> (  ,   50 50 ) <a href="">bg.png</a> (       ) <br> <br>    ID  <i>resource.h</i> : <br> <br> <code class="cpp">// Unique IDs for each image resource. #define BG_ID 101 #define WHITE_KEY_ID 102 #define BLACK_KEY_ID 103 #define WAVEFORM_ID 104 #define KNOB_ID 105 #define KNOB_SMALL_ID 106 #define FILTERMODE_ID 107 // Image resource locations for this plug. #define BG_FN "resources/img/bg.png" #define WHITE_KEY_FN "resources/img/whitekey.png" #define BLACK_KEY_FN "resources/img/blackkey.png" #define WAVEFORM_FN "resources/img/waveform.png" #define KNOB_FN "resources/img/knob.png" #define KNOB_SMALL_FN "resources/img/knob_small.png" #define FILTERMODE_FN "resources/img/filtermode.png"</code> <br> <br>  <i>Synthesis.rc</i> : <br> <br> <code class="cpp">#include "resource.h" BG_ID PNG BG_FN WHITE_KEY_ID PNG WHITE_KEY_FN BLACK_KEY_ID PNG BLACK_KEY_FN WAVEFORM_ID PNG WAVEFORM_FN KNOB_ID PNG KNOB_FN KNOB_SMALL_ID PNG KNOB_SMALL_FN FILTERMODE_ID PNG FILTERMODE_FN</code> <br> <br>   <code>#include "Filter.h"</code>  <i>Synthesis.h</i>    <code>private</code> : <br> <br> <code class="cpp">Filter mFilter;</code> <br> <br>  <code>EParams</code>  <i>Synthesis.cpp</i> : <br> <br> <code class="cpp">enum EParams { mWaveform = 0, mAttack, mDecay, mSustain, mRelease, mFilterMode, mFilterCutoff, mFilterResonance, mFilterAttack, mFilterDecay, mFilterSustain, mFilterRelease, mFilterEnvelopeAmount, kNumParams };</code> <br> <br>        : <br> <br> <code class="cpp">pGraphics-&gt;AttachControl(new ISwitchControl(this, 24, 38, mWaveform, &amp;waveformBitmap));</code> <br> <br>      .      (Lowpass, Highpass, Bandpass).    <code>AttachGraphics(pGraphics)</code> : <br> <br> <code class="cpp">GetParam(mFilterMode)-&gt;InitEnum("Filter Mode", Filter::FILTER_MODE_LOWPASS, Filter::kNumFilterModes); IBitmap filtermodeBitmap = pGraphics-&gt;LoadIBitmap(FILTERMODE_ID, FILTERMODE_FN, 3); pGraphics-&gt;AttachControl(new ISwitchControl(this, 24, 123, mFilterMode, &amp;filtermodeBitmap));</code> <br> <br>         .    .     <i>knob_small.png</i> : <br> <br> <code class="cpp">// Knobs for filter cutoff and resonance IBitmap smallKnobBitmap = pGraphics-&gt;LoadIBitmap(KNOB_SMALL_ID, KNOB_SMALL_FN, 64); // Cutoff knob: GetParam(mFilterCutoff)-&gt;InitDouble("Cutoff", 0.99, 0.01, 0.99, 0.001); GetParam(mFilterCutoff)-&gt;SetShape(2); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 5, 177, mFilterCutoff, &amp;smallKnobBitmap)); // Resonance knob: GetParam(mFilterResonance)-&gt;InitDouble("Resonance", 0.01, 0.01, 1.0, 0.001); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 61, 177, mFilterResonance, &amp;smallKnobBitmap));</code> <br> <br>   ,           <code>1.0</code> ,   <code>calculateFeedbackAmount</code>    , . <br>  <code>ProcessDoubleReplacing</code>     : <br> <br> <code class="cpp">leftOutput[i] = rightOutput[i] = mFilter.process(mOscillator.nextSample() * mEnvelopeGenerator.nextSample() * velocity / 127.0);</code> <br> <br>       .  <code>switch</code>   <code>Synthesis::OnParamChange</code> : <br> <br> <code class="cpp">case mFilterCutoff: mFilter.setCutoff(GetParam(paramIdx)-&gt;Value()); break; case mFilterResonance: mFilter.setResonance(GetParam(paramIdx)-&gt;Value()); break; case mFilterMode: mFilter.setFilterMode(static_cast&lt;Filter::FilterMode&gt;(GetParam(paramIdx)-&gt;Int())); break;</code> <br> <br>    .  -      . <br> <br>  <br> <br>  ‚Äî      .   ,   ,          . <br>      : <br> <br> <code class="cpp">buf0 += cutoff * (inputValue - buf0 + feedbackAmount * (buf0 - buf1));</code> <br> <br> ,   ,      ( <code>buf0 ‚Äì buf1</code> ),   <code>feedbackAmount</code> .    <code>calculateFeedbackAmount</code>  <code>feedbackAmount</code>  <code>resonance</code> , . .    ,   . <br> <br>  ,            .     ,  <i></i> ,      <a href="https://www.youtube.com/watch%3Fv%3DJWyMj6KxGHM"> </a> .    ,        ,       . <br> <br>  -12 /  -24 / <br>        !     24   .     <code>switch</code>  <code>Filter::process</code> : <br> <br> <code class="cpp">buf2 += cutoff * (buf1 - buf2); buf3 += cutoff * (buf2 ‚Äì buf3);</code> <br> <br>   :      ,       ,            .     ,       , , <a href="https://ccrma.stanford.edu/~Jos/filters/Filter_Stability.html"></a> (       ).     <code>switch</code> : <br> <br> <code class="cpp">switch (mode) { case FILTER_MODE_LOWPASS: return buf3; case FILTER_MODE_HIGHPASS: return inputValue - buf3; case FILTER_MODE_BANDPASS: return buf0 - buf3; default: return 0.0; }</code> <br> <br>   <code>buf1</code>  <code>buf3</code> ‚Äì      .    -24 /.     <code>buf2</code>  <code>buf3</code> ,        <code>private</code> <i>Filter.h</i> : <br> <br> <code class="cpp">double buf2; double buf3;</code> <br> <br>    ,   <code>buf0</code> c <code>buf1</code> : <br> <br> <code class="cpp">Filter() : // ... buf0(0.0), buf1(0.0), buf2(0.0), buf3(0.0) // ...</code> <br> <br>     , ,     :     .       . <br>          ? <br> <br>   <br>    .  ,           ,       . <br> -      <code>cutoff</code>   .      .    <code>cutoffMod</code> ,    ,       <code>cutoff</code>    .     <code>#include    private</code> : <br> <br> <code class="cpp">double cutoffMod;</code> <br> <br> : <br> <br> <code class="cpp">Filter() : cutoff(0.99), resonance(0.01), cutoffMod(0.0), // ...</code> <br> <br>         .   <code>private</code> : <br> <br> <code class="cpp">inline double getCalculatedCutoff() const { return fmax(fmin(cutoff + cutoffMod, 0.99), 0.01); };</code> <br> <br> <code>calculateFeedbackAmount</code>     : <br> <br> <code class="cpp">inline void calculateFeedbackAmount() { feedbackAmount = resonance + resonance/(1.0 - getCalculatedCutoff()); }</code> <br> <br>       <code>cutoffMod</code> .   <code>feedbackAmount</code>    ,     : <br> <br> <code class="cpp">inline void setCutoffMod(double newCutoffMod) { cutoffMod = newCutoffMod; calculateFeedbackAmount(); }</code> <br> <br> ,       .   <code>Filter::process</code>   : <br> <br> <code class="cpp">if (inputValue == 0.0) return inputValue; double calculatedCutoff = getCalculatedCutoff(); buf0 += calculatedCutoff * (inputValue - buf0 + feedbackAmount * (buf0 - buf1)); buf1 += calculatedCutoff * (buf0 - buf1); buf2 += calculatedCutoff * (buf1 - buf2); buf3 += calculatedCutoff * (buf2 ‚Äì buf3);</code> <br> <br>        ,    .    ,      ,   .     .     <code>cutoff</code>  <code>calculatedCutoff</code>   -. <br> <br> ,       ( <code>setCutoffMod</code> ),   <code>Synthesis</code>    ,     ,    .    ,        <code>cutoffMod</code> .    <code>filterEnvelopeAmount</code>    <code>-1</code>  <code>+1</code> .   GUI. <br> <br>   <code>private</code> <i>Synthesis.h</i>    : <br> <br> <code class="cpp">EnvelopeGenerator mFilterEnvelopeGenerator; double filterEnvelopeAmount;</code> <br> <br>       MIDI ,      <code>onNoteOn</code>  <code>onNoteOff</code> : <br> <br> <code class="cpp">inline void onNoteOn(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); mFilterEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); }; inline void onNoteOff(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); mFilterEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); };</code> <br> <br>    .   <code>ProcessDoubleReplacing</code>        : <br> <br> <code class="cpp">mFilter.setCutoffMod(mFilterEnvelopeGenerator.nextSample() * filterEnvelopeAmount);</code> <br> <br>  ,        <code>nextSample</code>  <code>filterEnvelopeAmount</code>     <code>cutoffMod</code> .     <code>filterEnvelopeAmount</code>  : <br> <br> <code class="cpp">Synthesis::Synthesis(IPlugInstanceInfo instanceInfo) : IPLUG_CTOR(kNumParams, kNumPrograms, instanceInfo), lastVirtualKeyboardNoteNumber(virtualKeyboardMinimumNoteNumber - 1), filterEnvelopeAmount(0.0) { // ... }</code> <br> <br>       <code>Synthesis::Reset</code> : <br> <br> <code class="cpp">mFilterEnvelopeGenerator.setSampleRate(GetSampleRate());</code> <br> <br>      <code>EParams</code> ,       .  <code>AttachGraphics</code>     : <br> <br> <code class="cpp">// Knobs for filter envelope // Attack knob GetParam(mFilterAttack)-&gt;InitDouble("Filter Env Attack", 0.01, 0.01, 10.0, 0.001); GetParam(mFilterAttack)-&gt;SetShape(3); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 139, 178, mFilterAttack, &amp;smallKnobBitmap)); // Decay knob: GetParam(mFilterDecay)-&gt;InitDouble("Filter Env Decay", 0.5, 0.01, 15.0, 0.001); GetParam(mFilterDecay)-&gt;SetShape(3); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 195, 178, mFilterDecay, &amp;smallKnobBitmap)); // Sustain knob: GetParam(mFilterSustain)-&gt;InitDouble("Filter Env Sustain", 0.1, 0.001, 1.0, 0.001); GetParam(mFilterSustain)-&gt;SetShape(2); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 251, 178, mFilterSustain, &amp;smallKnobBitmap)); // Release knob: GetParam(mFilterRelease)-&gt;InitDouble("Filter Env Release", 1.0, 0.001, 15.0, 0.001); GetParam(mFilterRelease)-&gt;SetShape(3); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 307, 178, mFilterRelease, &amp;smallKnobBitmap)); // Filter envelope amount knob: GetParam(mFilterEnvelopeAmount)-&gt;InitDouble("Filter Env Amount", 0.0, -1.0, 1.0, 0.001); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 363, 178, mFilterEnvelopeAmount, &amp;smallKnobBitmap));</code> <br> <br>     ,       <code>smallKnobBitmap</code> .                   .     ,    .  <code>Synthesis::OnParamChange</code>    <code>switch</code> : <br> <br> <code class="cpp">case mFilterAttack: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK, GetParam(paramIdx)-&gt;Value()); break; case mFilterDecay: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_DECAY, GetParam(paramIdx)-&gt;Value()); break; case mFilterSustain: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_SUSTAIN, GetParam(paramIdx)-&gt;Value()); break; case mFilterRelease: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE, GetParam(paramIdx)-&gt;Value()); break; case mFilterEnvelopeAmount: filterEnvelopeAmount = GetParam(paramIdx)-&gt;Value(); break;</code> <br> <br> ! <br>     !           (-   C1),   : <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/f5d/757/3f9/f5d7573f9b3a720fe5898d88ae477cfc.png"> <br> <br>        <code>EnvelopeGenerator</code>  .         .        ! <br> <br>    <a href=""></a> . <br> <br>        :) <br> <br>  : <br> <a href="http://martin-finke.de/blog/articles/audio-plugins-013-filter/">martin-finke.de/blog/articles/audio-plugins-013-filter</a></code></code> <pre> <code class="hljs erlang-repl"><code><code class="cpp"><code class="cpp">#include  <i>Filter.h</i> ( )     : <br> <br> class Filter { public: enum FilterMode { FILTER_MODE_LOWPASS = <span class="hljs-number"><span class="hljs-number">0</span></span>, FILTER_MODE_HIGHPASS, FILTER_MODE_BANDPASS, kNumFilterModes }; Filter() : cutoff(<span class="hljs-number"><span class="hljs-number">0.99</span></span>), resonance(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), mode(FILTER_MODE_LOWPASS), buf0(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), buf1(<span class="hljs-number"><span class="hljs-number">0.0</span></span>) { calculateFeedbackAmount(); }; double process(double inputValue); inline void setCutoff(double newCutoff) { cutoff = newCutoff; calculateFeedbackAmount(); }; inline void setResonance(double newResonance) { resonance = newResonance; calculateFeedbackAmount(); }; inline void setFilterMode(FilterMode newMode) { mode = newMode; } private: double cutoff; double resonance; FilterMode mode; double feedbackAmount; inline void calculateFeedbackAmount() { feedbackAmount = resonance + resonance/(<span class="hljs-number"><span class="hljs-number">1.0</span></span> - cutoff); } double buf0; double buf1; };</code> <br> <br>  <code>private</code>     <i> </i> <code>cutoff</code>  <i></i> <code>resonance</code> . <code>Mode</code>      (Lowpass, Highpass, Bandpass).  <code>feedbackAmount</code> , <code>buf0</code>  <code>buf1</code>    ,    . <br>          ( <code>calculateFeedbackAmount()</code> ).  <code>process</code>      .   <code>feedbackAmount</code>   <code>cutoff</code>  <code>resonance</code> ,    <code>calculateFeedbackAmount</code>      . <br> <br>   <i>Filter.cpp</i>  : <br> <br> <code class="cpp">// By Paul Kellett // http://www.musicdsp.org/showone.php?id=<span class="hljs-number"><span class="hljs-number">29</span></span> double Filter::process(double inputValue) { buf0 += cutoff * (inputValue - buf0); buf1 += cutoff * (buf0 - buf1); switch (mode) { case FILTER_MODE_LOWPASS: return buf1; case FILTER_MODE_HIGHPASS: return inputValue - buf0; case FILTER_MODE_BANDPASS: return buf0 - buf1; default: return <span class="hljs-number"><span class="hljs-number">0.0</span></span>; } }</code> <br> <br> , ?  ,         <i> </i> . ¬´ ¬ª   ,               (. .    <span class="hljs-number"><span class="hljs-number">6</span></span> ).     <code>buf0</code>  <code>buf1</code> :        .     <code>inputValue</code> ,  - <code>buf0</code> (  ).   .    <span class="hljs-number"><span class="hljs-number">6</span></span> /   <span class="hljs-number"><span class="hljs-number">12</span></span> /.  <code>switch</code> ,  <code>buf1</code>    . , ,    <code>buf0</code> ,       <span class="hljs-number"><span class="hljs-number">12</span></span>,   <span class="hljs-number"><span class="hljs-number">6</span></span> /,        . <br> <br>  <code>case</code> <code>FILTER_MODE_HIGHPASS</code>    . <code>buf0</code>       .   <code>inputValue</code>  <code>buf0</code> ,   .    <code>buf1</code> ,     . <br> <br>  <code>case</code> <code>FILTER_MODE_BANDPASS</code> ,  <code>buf0 - buf1</code>   .  <code>buf0</code>       ,     <code>buf1</code> . ,   . <br>  :    <i> </i>    <i> </i> ,   . <br> <br>  <code>buf1</code>     .       <a href="http://ru.wikipedia.org/wiki/%25D0%25A4%25D0%25B8%25D0%25BB%25D1%258C%25D1%2582%25D1%2580_%25D1%2581_%25D0%25B1%25D0%25B5%25D1%2581%25D0%25BA%25D0%25BE%25D0%25BD%25D0%25B5%25D1%2587%25D0%25BD%25D0%25BE%25D0%25B9_%25D0%25B8%25D0%25BC%25D0%25BF%25D1%2583%25D0%25BB%25D1%258C%25D1%2581%25D0%25BD%25D0%25BE%25D0%25B9_%25D1%2585%25D0%25B0%25D1%2580%25D0%25B0%25D0%25BA%25D1%2582%25D0%25B5%25D1%2580%25D0%25B8%25D1%2581%25D1%2582%25D0%25B8%25D0%25BA%25D0%25BE%25D0%25B9">    </a> ( <i>Infinite Impulse Response</i> ,  <i>IIR</i> ).  <a href="http://www.dspguide.com/ch14/1.htm"> </a> ,      .      ,         ,      . <br> <br>   <br>       ,     ,     .   ,  ,      ,  ,          .           ,  NI Massive,   ¬´ <a href="http://lurkmore.to/%25D0%25A2%25D1%2591%25D0%25BF%25D0%25BB%25D1%258B%25D0%25B9_%25D0%25BB%25D0%25B0%25D0%25BC%25D0%25BF%25D0%25BE%25D0%25B2%25D1%258B%25D0%25B9_%25D0%25B7%25D0%25B2%25D1%2583%25D0%25BA">  </a> ¬ª.       ,          ,   .        ,          (  Massive       ).      ¬´¬ª , , , AAS Ultra Analog,       ,     ,    ,        .         ,  ,    <a href="http://www.kvraudio.com/forum/viewtopic.php%3Ft%3D350246"></a> ,   ,      NI Reaktor. ,            ‚Äî    ,    ..     . <br> <br>   <br>     .   GUI.  <i>bg.png</i>   ( <i>‚ÄúMove to trash‚Äù</i>  Xcode),       : <br> <br> <a href="">filtermode.png</a> <a href="">knob_small.png</a> (  ,   <span class="hljs-number"><span class="hljs-number">50</span></span> <span class="hljs-number"><span class="hljs-number">50</span></span> ) <a href="">bg.png</a> (       ) <br> <br>    ID  <i>resource.h</i> : <br> <br> <code class="cpp">// Unique IDs for each image resource. #define BG_ID <span class="hljs-number"><span class="hljs-number">101</span></span> #define WHITE_KEY_ID <span class="hljs-number"><span class="hljs-number">102</span></span> #define BLACK_KEY_ID <span class="hljs-number"><span class="hljs-number">103</span></span> #define WAVEFORM_ID <span class="hljs-number"><span class="hljs-number">104</span></span> #define KNOB_ID <span class="hljs-number"><span class="hljs-number">105</span></span> #define KNOB_SMALL_ID <span class="hljs-number"><span class="hljs-number">106</span></span> #define FILTERMODE_ID <span class="hljs-number"><span class="hljs-number">107</span></span> // Image resource locations for this plug. #define BG_FN <span class="hljs-string"><span class="hljs-string">"resources/img/bg.png"</span></span> #define WHITE_KEY_FN <span class="hljs-string"><span class="hljs-string">"resources/img/whitekey.png"</span></span> #define BLACK_KEY_FN <span class="hljs-string"><span class="hljs-string">"resources/img/blackkey.png"</span></span> #define WAVEFORM_FN <span class="hljs-string"><span class="hljs-string">"resources/img/waveform.png"</span></span> #define KNOB_FN <span class="hljs-string"><span class="hljs-string">"resources/img/knob.png"</span></span> #define KNOB_SMALL_FN <span class="hljs-string"><span class="hljs-string">"resources/img/knob_small.png"</span></span> #define FILTERMODE_FN <span class="hljs-string"><span class="hljs-string">"resources/img/filtermode.png"</span></span></code> <br> <br>  <i>Synthesis.rc</i> : <br> <br> <code class="cpp">#include <span class="hljs-string"><span class="hljs-string">"resource.h"</span></span> BG_ID PNG BG_FN WHITE_KEY_ID PNG WHITE_KEY_FN BLACK_KEY_ID PNG BLACK_KEY_FN WAVEFORM_ID PNG WAVEFORM_FN KNOB_ID PNG KNOB_FN KNOB_SMALL_ID PNG KNOB_SMALL_FN FILTERMODE_ID PNG FILTERMODE_FN</code> <br> <br>   <code>#include <span class="hljs-string"><span class="hljs-string">"Filter.h"</span></span></code>  <i>Synthesis.h</i>    <code>private</code> : <br> <br> <code class="cpp">Filter mFilter;</code> <br> <br>  <code>EParams</code>  <i>Synthesis.cpp</i> : <br> <br> <code class="cpp">enum EParams { mWaveform = <span class="hljs-number"><span class="hljs-number">0</span></span>, mAttack, mDecay, mSustain, mRelease, mFilterMode, mFilterCutoff, mFilterResonance, mFilterAttack, mFilterDecay, mFilterSustain, mFilterRelease, mFilterEnvelopeAmount, kNumParams };</code> <br> <br>        : <br> <br> <code class="cpp">pGraphics-&gt;AttachControl(new ISwitchControl(this, <span class="hljs-number"><span class="hljs-number">24</span></span>, <span class="hljs-number"><span class="hljs-number">38</span></span>, mWaveform, &amp;waveformBitmap));</code> <br> <br>      .      (Lowpass, Highpass, Bandpass).    <code>AttachGraphics(pGraphics)</code> : <br> <br> <code class="cpp">GetParam(mFilterMode)-&gt;InitEnum(<span class="hljs-string"><span class="hljs-string">"Filter Mode"</span></span>, Filter::FILTER_MODE_LOWPASS, Filter::kNumFilterModes); IBitmap filtermodeBitmap = pGraphics-&gt;LoadIBitmap(FILTERMODE_ID, FILTERMODE_FN, <span class="hljs-number"><span class="hljs-number">3</span></span>); pGraphics-&gt;AttachControl(new ISwitchControl(this, <span class="hljs-number"><span class="hljs-number">24</span></span>, <span class="hljs-number"><span class="hljs-number">123</span></span>, mFilterMode, &amp;filtermodeBitmap));</code> <br> <br>         .    .     <i>knob_small.png</i> : <br> <br> <code class="cpp">// Knobs for filter cutoff and resonance IBitmap smallKnobBitmap = pGraphics-&gt;LoadIBitmap(KNOB_SMALL_ID, KNOB_SMALL_FN, <span class="hljs-number"><span class="hljs-number">64</span></span>); // Cutoff knob: GetParam(mFilterCutoff)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Cutoff"</span></span>, <span class="hljs-number"><span class="hljs-number">0.99</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">0.99</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); GetParam(mFilterCutoff)-&gt;SetShape(<span class="hljs-number"><span class="hljs-number">2</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-number"><span class="hljs-number">177</span></span>, mFilterCutoff, &amp;smallKnobBitmap)); // Resonance knob: GetParam(mFilterResonance)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Resonance"</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">61</span></span>, <span class="hljs-number"><span class="hljs-number">177</span></span>, mFilterResonance, &amp;smallKnobBitmap));</code> <br> <br>   ,           <code><span class="hljs-number"><span class="hljs-number">1.0</span></span></code> ,   <code>calculateFeedbackAmount</code>    , . <br>  <code>ProcessDoubleReplacing</code>     : <br> <br> <code class="cpp">leftOutput[i] = rightOutput[i] = mFilter.process(mOscillator.nextSample() * mEnvelopeGenerator.nextSample() * velocity / <span class="hljs-number"><span class="hljs-number">127.0</span></span>);</code> <br> <br>       .  <code>switch</code>   <code>Synthesis::OnParamChange</code> : <br> <br> <code class="cpp">case mFilterCutoff: mFilter.setCutoff(GetParam(paramIdx)-&gt;Value()); break; case mFilterResonance: mFilter.setResonance(GetParam(paramIdx)-&gt;Value()); break; case mFilterMode: mFilter.setFilterMode(static_cast&lt;Filter::FilterMode&gt;(GetParam(paramIdx)-&gt;Int())); break;</code> <br> <br>    .  -      . <br> <br>  <br> <br>  ‚Äî      .   ,   ,          . <br>      : <br> <br> <code class="cpp">buf0 += cutoff * (inputValue - buf0 + feedbackAmount * (buf0 - buf1));</code> <br> <br> ,   ,      ( <code>buf0 ‚Äì buf1</code> ),   <code>feedbackAmount</code> .    <code>calculateFeedbackAmount</code>  <code>feedbackAmount</code>  <code>resonance</code> , . .    ,   . <br> <br>  ,            .     ,  <i></i> ,      <a href="https://www.youtube.com/watch%3Fv%3DJWyMj6KxGHM"> </a> .    ,        ,       . <br> <br>  -<span class="hljs-number"><span class="hljs-number">12</span></span> /  -<span class="hljs-number"><span class="hljs-number">24</span></span> / <br>        !     <span class="hljs-number"><span class="hljs-number">24</span></span>   .     <code>switch</code>  <code>Filter::process</code> : <br> <br> <code class="cpp">buf2 += cutoff * (buf1 - buf2); buf3 += cutoff * (buf2 ‚Äì buf3);</code> <br> <br>   :      ,       ,            .     ,       , , <a href="https://ccrma.stanford.edu/~Jos/filters/Filter_Stability.html"></a> (       ).     <code>switch</code> : <br> <br> <code class="cpp">switch (mode) { case FILTER_MODE_LOWPASS: return buf3; case FILTER_MODE_HIGHPASS: return inputValue - buf3; case FILTER_MODE_BANDPASS: return buf0 - buf3; default: return <span class="hljs-number"><span class="hljs-number">0.0</span></span>; }</code> <br> <br>   <code>buf1</code>  <code>buf3</code> ‚Äì      .    -<span class="hljs-number"><span class="hljs-number">24</span></span> /.     <code>buf2</code>  <code>buf3</code> ,        <code>private</code> <i>Filter.h</i> : <br> <br> <code class="cpp">double buf2; double buf3;</code> <br> <br>    ,   <code>buf0</code> c <code>buf1</code> : <br> <br> <code class="cpp">Filter() : // ... buf0(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), buf1(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), buf2(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), buf3(<span class="hljs-number"><span class="hljs-number">0.0</span></span>) // ...</code> <br> <br>     , ,     :     .       . <br>          ? <br> <br>   <br>    .  ,           ,       . <br> -      <code>cutoff</code>   .      .    <code>cutoffMod</code> ,    ,       <code>cutoff</code>    .     <code>#include    private</code> : <br> <br> <code class="cpp">double cutoffMod;</code> <br> <br> : <br> <br> <code class="cpp">Filter() : cutoff(<span class="hljs-number"><span class="hljs-number">0.99</span></span>), resonance(<span class="hljs-number"><span class="hljs-number">0.01</span></span>), cutoffMod(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), // ...</code> <br> <br>         .   <code>private</code> : <br> <br> <code class="cpp">inline double getCalculatedCutoff() const { return fmax(fmin(cutoff + cutoffMod, <span class="hljs-number"><span class="hljs-number">0.99</span></span>), <span class="hljs-number"><span class="hljs-number">0.01</span></span>); };</code> <br> <br> <code>calculateFeedbackAmount</code>     : <br> <br> <code class="cpp">inline void calculateFeedbackAmount() { feedbackAmount = resonance + resonance/(<span class="hljs-number"><span class="hljs-number">1.0</span></span> - getCalculatedCutoff()); }</code> <br> <br>       <code>cutoffMod</code> .   <code>feedbackAmount</code>    ,     : <br> <br> <code class="cpp">inline void setCutoffMod(double newCutoffMod) { cutoffMod = newCutoffMod; calculateFeedbackAmount(); }</code> <br> <br> ,       .   <code>Filter::process</code>   : <br> <br> <code class="cpp">if (inputValue == <span class="hljs-number"><span class="hljs-number">0.0</span></span>) return inputValue; double calculatedCutoff = getCalculatedCutoff(); buf0 += calculatedCutoff * (inputValue - buf0 + feedbackAmount * (buf0 - buf1)); buf1 += calculatedCutoff * (buf0 - buf1); buf2 += calculatedCutoff * (buf1 - buf2); buf3 += calculatedCutoff * (buf2 ‚Äì buf3);</code> <br> <br>        ,    .    ,      ,   .     .     <code>cutoff</code>  <code>calculatedCutoff</code>   -. <br> <br> ,       ( <code>setCutoffMod</code> ),   <code>Synthesis</code>    ,     ,    .    ,        <code>cutoffMod</code> .    <code>filterEnvelopeAmount</code>    <code>-<span class="hljs-number"><span class="hljs-number">1</span></span></code>  <code>+<span class="hljs-number"><span class="hljs-number">1</span></span></code> .   GUI. <br> <br>   <code>private</code> <i>Synthesis.h</i>    : <br> <br> <code class="cpp">EnvelopeGenerator mFilterEnvelopeGenerator; double filterEnvelopeAmount;</code> <br> <br>       MIDI ,      <code>onNoteOn</code>  <code>onNoteOff</code> : <br> <br> <code class="cpp">inline void onNoteOn(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); mFilterEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); }; inline void onNoteOff(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); mFilterEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); };</code> <br> <br>    .   <code>ProcessDoubleReplacing</code>        : <br> <br> <code class="cpp">mFilter.setCutoffMod(mFilterEnvelopeGenerator.nextSample() * filterEnvelopeAmount);</code> <br> <br>  ,        <code>nextSample</code>  <code>filterEnvelopeAmount</code>     <code>cutoffMod</code> .     <code>filterEnvelopeAmount</code>  : <br> <br> <code class="cpp">Synthesis::Synthesis(IPlugInstanceInfo instanceInfo) : IPLUG_CTOR(kNumParams, kNumPrograms, instanceInfo), lastVirtualKeyboardNoteNumber(virtualKeyboardMinimumNoteNumber - <span class="hljs-number"><span class="hljs-number">1</span></span>), filterEnvelopeAmount(<span class="hljs-number"><span class="hljs-number">0.0</span></span>) { // ... }</code> <br> <br>       <code>Synthesis::Reset</code> : <br> <br> mFilterEnvelopeGenerator.setSampleRate(GetSampleRate()); <br> <br>      <code>EParams</code> ,       .  <code>AttachGraphics</code>     : <br> <br> <code class="cpp">// Knobs for filter envelope // Attack knob GetParam(mFilterAttack)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Filter Env Attack"</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">10.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); GetParam(mFilterAttack)-&gt;SetShape(<span class="hljs-number"><span class="hljs-number">3</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">139</span></span>, <span class="hljs-number"><span class="hljs-number">178</span></span>, mFilterAttack, &amp;smallKnobBitmap)); // Decay knob: GetParam(mFilterDecay)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Filter Env Decay"</span></span>, <span class="hljs-number"><span class="hljs-number">0.5</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">15.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); GetParam(mFilterDecay)-&gt;SetShape(<span class="hljs-number"><span class="hljs-number">3</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">195</span></span>, <span class="hljs-number"><span class="hljs-number">178</span></span>, mFilterDecay, &amp;smallKnobBitmap)); // Sustain knob: GetParam(mFilterSustain)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Filter Env Sustain"</span></span>, <span class="hljs-number"><span class="hljs-number">0.1</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>, <span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); GetParam(mFilterSustain)-&gt;SetShape(<span class="hljs-number"><span class="hljs-number">2</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">251</span></span>, <span class="hljs-number"><span class="hljs-number">178</span></span>, mFilterSustain, &amp;smallKnobBitmap)); // Release knob: GetParam(mFilterRelease)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Filter Env Release"</span></span>, <span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>, <span class="hljs-number"><span class="hljs-number">15.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); GetParam(mFilterRelease)-&gt;SetShape(<span class="hljs-number"><span class="hljs-number">3</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">307</span></span>, <span class="hljs-number"><span class="hljs-number">178</span></span>, mFilterRelease, &amp;smallKnobBitmap)); // Filter envelope amount knob: GetParam(mFilterEnvelopeAmount)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Filter Env Amount"</span></span>, <span class="hljs-number"><span class="hljs-number">0.0</span></span>, -<span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">363</span></span>, <span class="hljs-number"><span class="hljs-number">178</span></span>, mFilterEnvelopeAmount, &amp;smallKnobBitmap));</code> <br> <br>     ,       <code>smallKnobBitmap</code> .                   .     ,    .  <code>Synthesis::OnParamChange</code>    <code>switch</code> : <br> <br> <code class="cpp">case mFilterAttack: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK, GetParam(paramIdx)-&gt;Value()); break; case mFilterDecay: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_DECAY, GetParam(paramIdx)-&gt;Value()); break; case mFilterSustain: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_SUSTAIN, GetParam(paramIdx)-&gt;Value()); break; case mFilterRelease: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE, GetParam(paramIdx)-&gt;Value()); break; case mFilterEnvelopeAmount: filterEnvelopeAmount = GetParam(paramIdx)-&gt;Value(); break;</code> <br> <br> ! <br>     !           (-   C1),   : <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/f5d/757/3f9/f5d7573f9b3a720fe5898d88ae477cfc.png"> <br> <br>        <code>EnvelopeGenerator</code>  .         .        ! <br> <br>    <a href=""></a> . <br> <br>        :) <br> <br>  : <br> <a href="http://martin-finke.de/blog/articles/audio-plugins-013-filter/">martin-finke.de/blog/articles/audio-plugins-<span class="hljs-number"><span class="hljs-number">013</span></span>-filter</a></code></code></code> </pre> <code><code><code class="cpp">#include  <i>Filter.h</i> ( )     : <br> <br> class Filter { public: enum FilterMode { FILTER_MODE_LOWPASS = 0, FILTER_MODE_HIGHPASS, FILTER_MODE_BANDPASS, kNumFilterModes }; Filter() : cutoff(0.99), resonance(0.0), mode(FILTER_MODE_LOWPASS), buf0(0.0), buf1(0.0) { calculateFeedbackAmount(); }; double process(double inputValue); inline void setCutoff(double newCutoff) { cutoff = newCutoff; calculateFeedbackAmount(); }; inline void setResonance(double newResonance) { resonance = newResonance; calculateFeedbackAmount(); }; inline void setFilterMode(FilterMode newMode) { mode = newMode; } private: double cutoff; double resonance; FilterMode mode; double feedbackAmount; inline void calculateFeedbackAmount() { feedbackAmount = resonance + resonance/(1.0 - cutoff); } double buf0; double buf1; };</code> <br> <br>  <code>private</code>     <i> </i> <code>cutoff</code>  <i></i> <code>resonance</code> . <code>Mode</code>      (Lowpass, Highpass, Bandpass).  <code>feedbackAmount</code> , <code>buf0</code>  <code>buf1</code>    ,    . <br>          ( <code>calculateFeedbackAmount()</code> ).  <code>process</code>      .   <code>feedbackAmount</code>   <code>cutoff</code>  <code>resonance</code> ,    <code>calculateFeedbackAmount</code>      . <br> <br>   <i>Filter.cpp</i>  : <br> <br> <code class="cpp">// By Paul Kellett // http://www.musicdsp.org/showone.php?id=29 double Filter::process(double inputValue) { buf0 += cutoff * (inputValue - buf0); buf1 += cutoff * (buf0 - buf1); switch (mode) { case FILTER_MODE_LOWPASS: return buf1; case FILTER_MODE_HIGHPASS: return inputValue - buf0; case FILTER_MODE_BANDPASS: return buf0 - buf1; default: return 0.0; } }</code> <br> <br> , ?  ,         <i> </i> . ¬´ ¬ª   ,               (. .    6 ).     <code>buf0</code>  <code>buf1</code> :        .     <code>inputValue</code> ,  - <code>buf0</code> (  ).   .    6 /   12 /.  <code>switch</code> ,  <code>buf1</code>    . , ,    <code>buf0</code> ,       12,   6 /,        . <br> <br>  <code>case</code> <code>FILTER_MODE_HIGHPASS</code>    . <code>buf0</code>       .   <code>inputValue</code>  <code>buf0</code> ,   .    <code>buf1</code> ,     . <br> <br>  <code>case</code> <code>FILTER_MODE_BANDPASS</code> ,  <code>buf0 - buf1</code>   .  <code>buf0</code>       ,     <code>buf1</code> . ,   . <br>  :    <i> </i>    <i> </i> ,   . <br> <br>  <code>buf1</code>     .       <a href="http://ru.wikipedia.org/wiki/%25D0%25A4%25D0%25B8%25D0%25BB%25D1%258C%25D1%2582%25D1%2580_%25D1%2581_%25D0%25B1%25D0%25B5%25D1%2581%25D0%25BA%25D0%25BE%25D0%25BD%25D0%25B5%25D1%2587%25D0%25BD%25D0%25BE%25D0%25B9_%25D0%25B8%25D0%25BC%25D0%25BF%25D1%2583%25D0%25BB%25D1%258C%25D1%2581%25D0%25BD%25D0%25BE%25D0%25B9_%25D1%2585%25D0%25B0%25D1%2580%25D0%25B0%25D0%25BA%25D1%2582%25D0%25B5%25D1%2580%25D0%25B8%25D1%2581%25D1%2582%25D0%25B8%25D0%25BA%25D0%25BE%25D0%25B9">    </a> ( <i>Infinite Impulse Response</i> ,  <i>IIR</i> ).  <a href="http://www.dspguide.com/ch14/1.htm"> </a> ,      .      ,         ,      . <br> <br>   <br>       ,     ,     .   ,  ,      ,  ,          .           ,  NI Massive,   ¬´ <a href="http://lurkmore.to/%25D0%25A2%25D1%2591%25D0%25BF%25D0%25BB%25D1%258B%25D0%25B9_%25D0%25BB%25D0%25B0%25D0%25BC%25D0%25BF%25D0%25BE%25D0%25B2%25D1%258B%25D0%25B9_%25D0%25B7%25D0%25B2%25D1%2583%25D0%25BA">  </a> ¬ª.       ,          ,   .        ,          (  Massive       ).      ¬´¬ª , , , AAS Ultra Analog,       ,     ,    ,        .         ,  ,    <a href="http://www.kvraudio.com/forum/viewtopic.php%3Ft%3D350246"></a> ,   ,      NI Reaktor. ,            ‚Äî    ,    ..     . <br> <br>   <br>     .   GUI.  <i>bg.png</i>   ( <i>‚ÄúMove to trash‚Äù</i>  Xcode),       : <br> <br> <a href="">filtermode.png</a> <a href="">knob_small.png</a> (  ,   50 50 ) <a href="">bg.png</a> (       ) <br> <br>    ID  <i>resource.h</i> : <br> <br> <code class="cpp">// Unique IDs for each image resource. #define BG_ID 101 #define WHITE_KEY_ID 102 #define BLACK_KEY_ID 103 #define WAVEFORM_ID 104 #define KNOB_ID 105 #define KNOB_SMALL_ID 106 #define FILTERMODE_ID 107 // Image resource locations for this plug. #define BG_FN "resources/img/bg.png" #define WHITE_KEY_FN "resources/img/whitekey.png" #define BLACK_KEY_FN "resources/img/blackkey.png" #define WAVEFORM_FN "resources/img/waveform.png" #define KNOB_FN "resources/img/knob.png" #define KNOB_SMALL_FN "resources/img/knob_small.png" #define FILTERMODE_FN "resources/img/filtermode.png"</code> <br> <br>  <i>Synthesis.rc</i> : <br> <br> <code class="cpp">#include "resource.h" BG_ID PNG BG_FN WHITE_KEY_ID PNG WHITE_KEY_FN BLACK_KEY_ID PNG BLACK_KEY_FN WAVEFORM_ID PNG WAVEFORM_FN KNOB_ID PNG KNOB_FN KNOB_SMALL_ID PNG KNOB_SMALL_FN FILTERMODE_ID PNG FILTERMODE_FN</code> <br> <br>   <code>#include "Filter.h"</code>  <i>Synthesis.h</i>    <code>private</code> : <br> <br> <code class="cpp">Filter mFilter;</code> <br> <br>  <code>EParams</code>  <i>Synthesis.cpp</i> : <br> <br> <code class="cpp">enum EParams { mWaveform = 0, mAttack, mDecay, mSustain, mRelease, mFilterMode, mFilterCutoff, mFilterResonance, mFilterAttack, mFilterDecay, mFilterSustain, mFilterRelease, mFilterEnvelopeAmount, kNumParams };</code> <br> <br>        : <br> <br> <code class="cpp">pGraphics-&gt;AttachControl(new ISwitchControl(this, 24, 38, mWaveform, &amp;waveformBitmap));</code> <br> <br>      .      (Lowpass, Highpass, Bandpass).    <code>AttachGraphics(pGraphics)</code> : <br> <br> <code class="cpp">GetParam(mFilterMode)-&gt;InitEnum("Filter Mode", Filter::FILTER_MODE_LOWPASS, Filter::kNumFilterModes); IBitmap filtermodeBitmap = pGraphics-&gt;LoadIBitmap(FILTERMODE_ID, FILTERMODE_FN, 3); pGraphics-&gt;AttachControl(new ISwitchControl(this, 24, 123, mFilterMode, &amp;filtermodeBitmap));</code> <br> <br>         .    .     <i>knob_small.png</i> : <br> <br> <code class="cpp">// Knobs for filter cutoff and resonance IBitmap smallKnobBitmap = pGraphics-&gt;LoadIBitmap(KNOB_SMALL_ID, KNOB_SMALL_FN, 64); // Cutoff knob: GetParam(mFilterCutoff)-&gt;InitDouble("Cutoff", 0.99, 0.01, 0.99, 0.001); GetParam(mFilterCutoff)-&gt;SetShape(2); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 5, 177, mFilterCutoff, &amp;smallKnobBitmap)); // Resonance knob: GetParam(mFilterResonance)-&gt;InitDouble("Resonance", 0.01, 0.01, 1.0, 0.001); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 61, 177, mFilterResonance, &amp;smallKnobBitmap));</code> <br> <br>   ,           <code>1.0</code> ,   <code>calculateFeedbackAmount</code>    , . <br>  <code>ProcessDoubleReplacing</code>     : <br> <br> <code class="cpp">leftOutput[i] = rightOutput[i] = mFilter.process(mOscillator.nextSample() * mEnvelopeGenerator.nextSample() * velocity / 127.0);</code> <br> <br>       .  <code>switch</code>   <code>Synthesis::OnParamChange</code> : <br> <br> <code class="cpp">case mFilterCutoff: mFilter.setCutoff(GetParam(paramIdx)-&gt;Value()); break; case mFilterResonance: mFilter.setResonance(GetParam(paramIdx)-&gt;Value()); break; case mFilterMode: mFilter.setFilterMode(static_cast&lt;Filter::FilterMode&gt;(GetParam(paramIdx)-&gt;Int())); break;</code> <br> <br>    .  -      . <br> <br>  <br> <br>  ‚Äî      .   ,   ,          . <br>      : <br> <br> <code class="cpp">buf0 += cutoff * (inputValue - buf0 + feedbackAmount * (buf0 - buf1));</code> <br> <br> ,   ,      ( <code>buf0 ‚Äì buf1</code> ),   <code>feedbackAmount</code> .    <code>calculateFeedbackAmount</code>  <code>feedbackAmount</code>  <code>resonance</code> , . .    ,   . <br> <br>  ,            .     ,  <i></i> ,      <a href="https://www.youtube.com/watch%3Fv%3DJWyMj6KxGHM"> </a> .    ,        ,       . <br> <br>  -12 /  -24 / <br>        !     24   .     <code>switch</code>  <code>Filter::process</code> : <br> <br> <code class="cpp">buf2 += cutoff * (buf1 - buf2); buf3 += cutoff * (buf2 ‚Äì buf3);</code> <br> <br>   :      ,       ,            .     ,       , , <a href="https://ccrma.stanford.edu/~Jos/filters/Filter_Stability.html"></a> (       ).     <code>switch</code> : <br> <br> <code class="cpp">switch (mode) { case FILTER_MODE_LOWPASS: return buf3; case FILTER_MODE_HIGHPASS: return inputValue - buf3; case FILTER_MODE_BANDPASS: return buf0 - buf3; default: return 0.0; }</code> <br> <br>   <code>buf1</code>  <code>buf3</code> ‚Äì      .    -24 /.     <code>buf2</code>  <code>buf3</code> ,        <code>private</code> <i>Filter.h</i> : <br> <br> <code class="cpp">double buf2; double buf3;</code> <br> <br>    ,   <code>buf0</code> c <code>buf1</code> : <br> <br> <code class="cpp">Filter() : // ... buf0(0.0), buf1(0.0), buf2(0.0), buf3(0.0) // ...</code> <br> <br>     , ,     :     .       . <br>          ? <br> <br>   <br>    .  ,           ,       . <br> -      <code>cutoff</code>   .      .    <code>cutoffMod</code> ,    ,       <code>cutoff</code>    .     <code>#include    private</code> : <br> <br> <code class="cpp">double cutoffMod;</code> <br> <br> : <br> <br> <code class="cpp">Filter() : cutoff(0.99), resonance(0.01), cutoffMod(0.0), // ...</code> <br> <br>         .   <code>private</code> : <br> <br> <code class="cpp">inline double getCalculatedCutoff() const { return fmax(fmin(cutoff + cutoffMod, 0.99), 0.01); };</code> <br> <br> <code>calculateFeedbackAmount</code>     : <br> <br> <code class="cpp">inline void calculateFeedbackAmount() { feedbackAmount = resonance + resonance/(1.0 - getCalculatedCutoff()); }</code> <br> <br>       <code>cutoffMod</code> .   <code>feedbackAmount</code>    ,     : <br> <br> <code class="cpp">inline void setCutoffMod(double newCutoffMod) { cutoffMod = newCutoffMod; calculateFeedbackAmount(); }</code> <br> <br> ,       .   <code>Filter::process</code>   : <br> <br> <code class="cpp">if (inputValue == 0.0) return inputValue; double calculatedCutoff = getCalculatedCutoff(); buf0 += calculatedCutoff * (inputValue - buf0 + feedbackAmount * (buf0 - buf1)); buf1 += calculatedCutoff * (buf0 - buf1); buf2 += calculatedCutoff * (buf1 - buf2); buf3 += calculatedCutoff * (buf2 ‚Äì buf3);</code> <br> <br>        ,    .    ,      ,   .     .     <code>cutoff</code>  <code>calculatedCutoff</code>   -. <br> <br> ,       ( <code>setCutoffMod</code> ),   <code>Synthesis</code>    ,     ,    .    ,        <code>cutoffMod</code> .    <code>filterEnvelopeAmount</code>    <code>-1</code>  <code>+1</code> .   GUI. <br> <br>   <code>private</code> <i>Synthesis.h</i>    : <br> <br> <code class="cpp">EnvelopeGenerator mFilterEnvelopeGenerator; double filterEnvelopeAmount;</code> <br> <br>       MIDI ,      <code>onNoteOn</code>  <code>onNoteOff</code> : <br> <br> <code class="cpp">inline void onNoteOn(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); mFilterEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); }; inline void onNoteOff(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); mFilterEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); };</code> <br> <br>    .   <code>ProcessDoubleReplacing</code>        : <br> <br> <code class="cpp">mFilter.setCutoffMod(mFilterEnvelopeGenerator.nextSample() * filterEnvelopeAmount);</code> <br> <br>  ,        <code>nextSample</code>  <code>filterEnvelopeAmount</code>     <code>cutoffMod</code> .     <code>filterEnvelopeAmount</code>  : <br> <br> <code class="cpp">Synthesis::Synthesis(IPlugInstanceInfo instanceInfo) : IPLUG_CTOR(kNumParams, kNumPrograms, instanceInfo), lastVirtualKeyboardNoteNumber(virtualKeyboardMinimumNoteNumber - 1), filterEnvelopeAmount(0.0) { // ... }</code> <br> <br>       <code>Synthesis::Reset</code> : <br> <br> <code class="cpp">mFilterEnvelopeGenerator.setSampleRate(GetSampleRate());</code> <br> <br>      <code>EParams</code> ,       .  <code>AttachGraphics</code>     : <br> <br> <code class="cpp">// Knobs for filter envelope // Attack knob GetParam(mFilterAttack)-&gt;InitDouble("Filter Env Attack", 0.01, 0.01, 10.0, 0.001); GetParam(mFilterAttack)-&gt;SetShape(3); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 139, 178, mFilterAttack, &amp;smallKnobBitmap)); // Decay knob: GetParam(mFilterDecay)-&gt;InitDouble("Filter Env Decay", 0.5, 0.01, 15.0, 0.001); GetParam(mFilterDecay)-&gt;SetShape(3); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 195, 178, mFilterDecay, &amp;smallKnobBitmap)); // Sustain knob: GetParam(mFilterSustain)-&gt;InitDouble("Filter Env Sustain", 0.1, 0.001, 1.0, 0.001); GetParam(mFilterSustain)-&gt;SetShape(2); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 251, 178, mFilterSustain, &amp;smallKnobBitmap)); // Release knob: GetParam(mFilterRelease)-&gt;InitDouble("Filter Env Release", 1.0, 0.001, 15.0, 0.001); GetParam(mFilterRelease)-&gt;SetShape(3); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 307, 178, mFilterRelease, &amp;smallKnobBitmap)); // Filter envelope amount knob: GetParam(mFilterEnvelopeAmount)-&gt;InitDouble("Filter Env Amount", 0.0, -1.0, 1.0, 0.001); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 363, 178, mFilterEnvelopeAmount, &amp;smallKnobBitmap));</code> <br> <br>     ,       <code>smallKnobBitmap</code> .                   .     ,    .  <code>Synthesis::OnParamChange</code>    <code>switch</code> : <br> <br> <code class="cpp">case mFilterAttack: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK, GetParam(paramIdx)-&gt;Value()); break; case mFilterDecay: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_DECAY, GetParam(paramIdx)-&gt;Value()); break; case mFilterSustain: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_SUSTAIN, GetParam(paramIdx)-&gt;Value()); break; case mFilterRelease: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE, GetParam(paramIdx)-&gt;Value()); break; case mFilterEnvelopeAmount: filterEnvelopeAmount = GetParam(paramIdx)-&gt;Value(); break;</code> <br> <br> ! <br>     !           (-   C1),   : <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/f5d/757/3f9/f5d7573f9b3a720fe5898d88ae477cfc.png"> <br> <br>        <code>EnvelopeGenerator</code>  .         .        ! <br> <br>    <a href=""></a> . <br> <br>        :) <br> <br>  : <br> <a href="http://martin-finke.de/blog/articles/audio-plugins-013-filter/">martin-finke.de/blog/articles/audio-plugins-013-filter</a></code></code> <pre> <code class="hljs erlang-repl"><code class="cpp">#include  <i>Filter.h</i> ( )     : <br> <br> class Filter { public: enum FilterMode { FILTER_MODE_LOWPASS = <span class="hljs-number"><span class="hljs-number">0</span></span>, FILTER_MODE_HIGHPASS, FILTER_MODE_BANDPASS, kNumFilterModes }; Filter() : cutoff(<span class="hljs-number"><span class="hljs-number">0.99</span></span>), resonance(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), mode(FILTER_MODE_LOWPASS), buf0(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), buf1(<span class="hljs-number"><span class="hljs-number">0.0</span></span>) { calculateFeedbackAmount(); }; double process(double inputValue); inline void setCutoff(double newCutoff) { cutoff = newCutoff; calculateFeedbackAmount(); }; inline void setResonance(double newResonance) { resonance = newResonance; calculateFeedbackAmount(); }; inline void setFilterMode(FilterMode newMode) { mode = newMode; } private: double cutoff; double resonance; FilterMode mode; double feedbackAmount; inline void calculateFeedbackAmount() { feedbackAmount = resonance + resonance/(<span class="hljs-number"><span class="hljs-number">1.0</span></span> - cutoff); } double buf0; double buf1; };</code> <br> <br>  <code>private</code>     <i> </i> <code>cutoff</code>  <i></i> <code>resonance</code> . <code>Mode</code>      (Lowpass, Highpass, Bandpass).  <code>feedbackAmount</code> , <code>buf0</code>  <code>buf1</code>    ,    . <br>          ( <code>calculateFeedbackAmount()</code> ).  <code>process</code>      .   <code>feedbackAmount</code>   <code>cutoff</code>  <code>resonance</code> ,    <code>calculateFeedbackAmount</code>      . <br> <br>   <i>Filter.cpp</i>  : <br> <br> <code class="cpp">// By Paul Kellett // http://www.musicdsp.org/showone.php?id=<span class="hljs-number"><span class="hljs-number">29</span></span> double Filter::process(double inputValue) { buf0 += cutoff * (inputValue - buf0); buf1 += cutoff * (buf0 - buf1); switch (mode) { case FILTER_MODE_LOWPASS: return buf1; case FILTER_MODE_HIGHPASS: return inputValue - buf0; case FILTER_MODE_BANDPASS: return buf0 - buf1; default: return <span class="hljs-number"><span class="hljs-number">0.0</span></span>; } }</code> <br> <br> , ?  ,         <i> </i> . ¬´ ¬ª   ,               (. .    <span class="hljs-number"><span class="hljs-number">6</span></span> ).     <code>buf0</code>  <code>buf1</code> :        .     <code>inputValue</code> ,  - <code>buf0</code> (  ).   .    <span class="hljs-number"><span class="hljs-number">6</span></span> /   <span class="hljs-number"><span class="hljs-number">12</span></span> /.  <code>switch</code> ,  <code>buf1</code>    . , ,    <code>buf0</code> ,       <span class="hljs-number"><span class="hljs-number">12</span></span>,   <span class="hljs-number"><span class="hljs-number">6</span></span> /,        . <br> <br>  <code>case</code> <code>FILTER_MODE_HIGHPASS</code>    . <code>buf0</code>       .   <code>inputValue</code>  <code>buf0</code> ,   .    <code>buf1</code> ,     . <br> <br>  <code>case</code> <code>FILTER_MODE_BANDPASS</code> ,  <code>buf0 - buf1</code>   .  <code>buf0</code>       ,     <code>buf1</code> . ,   . <br>  :    <i> </i>    <i> </i> ,   . <br> <br>  <code>buf1</code>     .       <a href="http://ru.wikipedia.org/wiki/%25D0%25A4%25D0%25B8%25D0%25BB%25D1%258C%25D1%2582%25D1%2580_%25D1%2581_%25D0%25B1%25D0%25B5%25D1%2581%25D0%25BA%25D0%25BE%25D0%25BD%25D0%25B5%25D1%2587%25D0%25BD%25D0%25BE%25D0%25B9_%25D0%25B8%25D0%25BC%25D0%25BF%25D1%2583%25D0%25BB%25D1%258C%25D1%2581%25D0%25BD%25D0%25BE%25D0%25B9_%25D1%2585%25D0%25B0%25D1%2580%25D0%25B0%25D0%25BA%25D1%2582%25D0%25B5%25D1%2580%25D0%25B8%25D1%2581%25D1%2582%25D0%25B8%25D0%25BA%25D0%25BE%25D0%25B9">    </a> ( <i>Infinite Impulse Response</i> ,  <i>IIR</i> ).  <a href="http://www.dspguide.com/ch14/1.htm"> </a> ,      .      ,         ,      . <br> <br>   <br>       ,     ,     .   ,  ,      ,  ,          .           ,  NI Massive,   ¬´ <a href="http://lurkmore.to/%25D0%25A2%25D1%2591%25D0%25BF%25D0%25BB%25D1%258B%25D0%25B9_%25D0%25BB%25D0%25B0%25D0%25BC%25D0%25BF%25D0%25BE%25D0%25B2%25D1%258B%25D0%25B9_%25D0%25B7%25D0%25B2%25D1%2583%25D0%25BA">  </a> ¬ª.       ,          ,   .        ,          (  Massive       ).      ¬´¬ª , , , AAS Ultra Analog,       ,     ,    ,        .         ,  ,    <a href="http://www.kvraudio.com/forum/viewtopic.php%3Ft%3D350246"></a> ,   ,      NI Reaktor. ,            ‚Äî    ,    ..     . <br> <br>   <br>     .   GUI.  <i>bg.png</i>   ( <i>‚ÄúMove to trash‚Äù</i>  Xcode),       : <br> <br> <a href="">filtermode.png</a> <a href="">knob_small.png</a> (  ,   <span class="hljs-number"><span class="hljs-number">50</span></span> <span class="hljs-number"><span class="hljs-number">50</span></span> ) <a href="">bg.png</a> (       ) <br> <br>    ID  <i>resource.h</i> : <br> <br> <code class="cpp">// Unique IDs for each image resource. #define BG_ID <span class="hljs-number"><span class="hljs-number">101</span></span> #define WHITE_KEY_ID <span class="hljs-number"><span class="hljs-number">102</span></span> #define BLACK_KEY_ID <span class="hljs-number"><span class="hljs-number">103</span></span> #define WAVEFORM_ID <span class="hljs-number"><span class="hljs-number">104</span></span> #define KNOB_ID <span class="hljs-number"><span class="hljs-number">105</span></span> #define KNOB_SMALL_ID <span class="hljs-number"><span class="hljs-number">106</span></span> #define FILTERMODE_ID <span class="hljs-number"><span class="hljs-number">107</span></span> // Image resource locations for this plug. #define BG_FN <span class="hljs-string"><span class="hljs-string">"resources/img/bg.png"</span></span> #define WHITE_KEY_FN <span class="hljs-string"><span class="hljs-string">"resources/img/whitekey.png"</span></span> #define BLACK_KEY_FN <span class="hljs-string"><span class="hljs-string">"resources/img/blackkey.png"</span></span> #define WAVEFORM_FN <span class="hljs-string"><span class="hljs-string">"resources/img/waveform.png"</span></span> #define KNOB_FN <span class="hljs-string"><span class="hljs-string">"resources/img/knob.png"</span></span> #define KNOB_SMALL_FN <span class="hljs-string"><span class="hljs-string">"resources/img/knob_small.png"</span></span> #define FILTERMODE_FN <span class="hljs-string"><span class="hljs-string">"resources/img/filtermode.png"</span></span></code> <br> <br>  <i>Synthesis.rc</i> : <br> <br> <code class="cpp">#include <span class="hljs-string"><span class="hljs-string">"resource.h"</span></span> BG_ID PNG BG_FN WHITE_KEY_ID PNG WHITE_KEY_FN BLACK_KEY_ID PNG BLACK_KEY_FN WAVEFORM_ID PNG WAVEFORM_FN KNOB_ID PNG KNOB_FN KNOB_SMALL_ID PNG KNOB_SMALL_FN FILTERMODE_ID PNG FILTERMODE_FN</code> <br> <br>   <code>#include <span class="hljs-string"><span class="hljs-string">"Filter.h"</span></span></code>  <i>Synthesis.h</i>    <code>private</code> : <br> <br> <code class="cpp">Filter mFilter;</code> <br> <br>  <code>EParams</code>  <i>Synthesis.cpp</i> : <br> <br> <code class="cpp">enum EParams { mWaveform = <span class="hljs-number"><span class="hljs-number">0</span></span>, mAttack, mDecay, mSustain, mRelease, mFilterMode, mFilterCutoff, mFilterResonance, mFilterAttack, mFilterDecay, mFilterSustain, mFilterRelease, mFilterEnvelopeAmount, kNumParams };</code> <br> <br>        : <br> <br> <code class="cpp">pGraphics-&gt;AttachControl(new ISwitchControl(this, <span class="hljs-number"><span class="hljs-number">24</span></span>, <span class="hljs-number"><span class="hljs-number">38</span></span>, mWaveform, &amp;waveformBitmap));</code> <br> <br>      .      (Lowpass, Highpass, Bandpass).    <code>AttachGraphics(pGraphics)</code> : <br> <br> <code class="cpp">GetParam(mFilterMode)-&gt;InitEnum(<span class="hljs-string"><span class="hljs-string">"Filter Mode"</span></span>, Filter::FILTER_MODE_LOWPASS, Filter::kNumFilterModes); IBitmap filtermodeBitmap = pGraphics-&gt;LoadIBitmap(FILTERMODE_ID, FILTERMODE_FN, <span class="hljs-number"><span class="hljs-number">3</span></span>); pGraphics-&gt;AttachControl(new ISwitchControl(this, <span class="hljs-number"><span class="hljs-number">24</span></span>, <span class="hljs-number"><span class="hljs-number">123</span></span>, mFilterMode, &amp;filtermodeBitmap));</code> <br> <br>         .    .     <i>knob_small.png</i> : <br> <br> <code class="cpp">// Knobs for filter cutoff and resonance IBitmap smallKnobBitmap = pGraphics-&gt;LoadIBitmap(KNOB_SMALL_ID, KNOB_SMALL_FN, <span class="hljs-number"><span class="hljs-number">64</span></span>); // Cutoff knob: GetParam(mFilterCutoff)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Cutoff"</span></span>, <span class="hljs-number"><span class="hljs-number">0.99</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">0.99</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); GetParam(mFilterCutoff)-&gt;SetShape(<span class="hljs-number"><span class="hljs-number">2</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-number"><span class="hljs-number">177</span></span>, mFilterCutoff, &amp;smallKnobBitmap)); // Resonance knob: GetParam(mFilterResonance)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Resonance"</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">61</span></span>, <span class="hljs-number"><span class="hljs-number">177</span></span>, mFilterResonance, &amp;smallKnobBitmap));</code> <br> <br>   ,           <code><span class="hljs-number"><span class="hljs-number">1.0</span></span></code> ,   <code>calculateFeedbackAmount</code>    , . <br>  <code>ProcessDoubleReplacing</code>     : <br> <br> <code class="cpp">leftOutput[i] = rightOutput[i] = mFilter.process(mOscillator.nextSample() * mEnvelopeGenerator.nextSample() * velocity / <span class="hljs-number"><span class="hljs-number">127.0</span></span>);</code> <br> <br>       .  <code>switch</code>   <code>Synthesis::OnParamChange</code> : <br> <br> <code class="cpp">case mFilterCutoff: mFilter.setCutoff(GetParam(paramIdx)-&gt;Value()); break; case mFilterResonance: mFilter.setResonance(GetParam(paramIdx)-&gt;Value()); break; case mFilterMode: mFilter.setFilterMode(static_cast&lt;Filter::FilterMode&gt;(GetParam(paramIdx)-&gt;Int())); break;</code> <br> <br>    .  -      . <br> <br>  <br> <br>  ‚Äî      .   ,   ,          . <br>      : <br> <br> <code class="cpp">buf0 += cutoff * (inputValue - buf0 + feedbackAmount * (buf0 - buf1));</code> <br> <br> ,   ,      ( <code>buf0 ‚Äì buf1</code> ),   <code>feedbackAmount</code> .    <code>calculateFeedbackAmount</code>  <code>feedbackAmount</code>  <code>resonance</code> , . .    ,   . <br> <br>  ,            .     ,  <i></i> ,      <a href="https://www.youtube.com/watch%3Fv%3DJWyMj6KxGHM"> </a> .    ,        ,       . <br> <br>  -<span class="hljs-number"><span class="hljs-number">12</span></span> /  -<span class="hljs-number"><span class="hljs-number">24</span></span> / <br>        !     <span class="hljs-number"><span class="hljs-number">24</span></span>   .     <code>switch</code>  <code>Filter::process</code> : <br> <br> <code class="cpp">buf2 += cutoff * (buf1 - buf2); buf3 += cutoff * (buf2 ‚Äì buf3);</code> <br> <br>   :      ,       ,            .     ,       , , <a href="https://ccrma.stanford.edu/~Jos/filters/Filter_Stability.html"></a> (       ).     <code>switch</code> : <br> <br> <code class="cpp">switch (mode) { case FILTER_MODE_LOWPASS: return buf3; case FILTER_MODE_HIGHPASS: return inputValue - buf3; case FILTER_MODE_BANDPASS: return buf0 - buf3; default: return <span class="hljs-number"><span class="hljs-number">0.0</span></span>; }</code> <br> <br>   <code>buf1</code>  <code>buf3</code> ‚Äì      .    -<span class="hljs-number"><span class="hljs-number">24</span></span> /.     <code>buf2</code>  <code>buf3</code> ,        <code>private</code> <i>Filter.h</i> : <br> <br> <code class="cpp">double buf2; double buf3;</code> <br> <br>    ,   <code>buf0</code> c <code>buf1</code> : <br> <br> <code class="cpp">Filter() : // ... buf0(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), buf1(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), buf2(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), buf3(<span class="hljs-number"><span class="hljs-number">0.0</span></span>) // ...</code> <br> <br>     , ,     :     .       . <br>          ? <br> <br>   <br>    .  ,           ,       . <br> -      <code>cutoff</code>   .      .    <code>cutoffMod</code> ,    ,       <code>cutoff</code>    .     <code><code>#include    private</code> : <br> <br> <code class="cpp">double cutoffMod;</code> <br> <br> : <br> <br> <code class="cpp">Filter() : cutoff(<span class="hljs-number"><span class="hljs-number">0.99</span></span>), resonance(<span class="hljs-number"><span class="hljs-number">0.01</span></span>), cutoffMod(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), // ...</code> <br> <br>         .   <code>private</code> : <br> <br> <code class="cpp">inline double getCalculatedCutoff() const { return fmax(fmin(cutoff + cutoffMod, <span class="hljs-number"><span class="hljs-number">0.99</span></span>), <span class="hljs-number"><span class="hljs-number">0.01</span></span>); };</code> <br> <br> <code>calculateFeedbackAmount</code>     : <br> <br> <code class="cpp">inline void calculateFeedbackAmount() { feedbackAmount = resonance + resonance/(<span class="hljs-number"><span class="hljs-number">1.0</span></span> - getCalculatedCutoff()); }</code> <br> <br>       <code>cutoffMod</code> .   <code>feedbackAmount</code>    ,     : <br> <br> <code class="cpp">inline void setCutoffMod(double newCutoffMod) { cutoffMod = newCutoffMod; calculateFeedbackAmount(); }</code> <br> <br> ,       .   <code>Filter::process</code>   : <br> <br> <code class="cpp">if (inputValue == <span class="hljs-number"><span class="hljs-number">0.0</span></span>) return inputValue; double calculatedCutoff = getCalculatedCutoff(); buf0 += calculatedCutoff * (inputValue - buf0 + feedbackAmount * (buf0 - buf1)); buf1 += calculatedCutoff * (buf0 - buf1); buf2 += calculatedCutoff * (buf1 - buf2); buf3 += calculatedCutoff * (buf2 ‚Äì buf3);</code> <br> <br>        ,    .    ,      ,   .     .     <code>cutoff</code>  <code>calculatedCutoff</code>   -. <br> <br> ,       ( <code>setCutoffMod</code> ),   <code>Synthesis</code>    ,     ,    .    ,        <code>cutoffMod</code> .    <code>filterEnvelopeAmount</code>    <code>-<span class="hljs-number"><span class="hljs-number">1</span></span></code>  <code>+<span class="hljs-number"><span class="hljs-number">1</span></span></code> .   GUI. <br> <br>   <code>private</code> <i>Synthesis.h</i>    : <br> <br> <code class="cpp">EnvelopeGenerator mFilterEnvelopeGenerator; double filterEnvelopeAmount;</code> <br> <br>       MIDI ,      <code>onNoteOn</code>  <code>onNoteOff</code> : <br> <br> <code class="cpp">inline void onNoteOn(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); mFilterEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); }; inline void onNoteOff(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); mFilterEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); };</code> <br> <br>    .   <code>ProcessDoubleReplacing</code>        : <br> <br> <code class="cpp">mFilter.setCutoffMod(mFilterEnvelopeGenerator.nextSample() * filterEnvelopeAmount);</code> <br> <br>  ,        <code>nextSample</code>  <code>filterEnvelopeAmount</code>     <code>cutoffMod</code> .     <code>filterEnvelopeAmount</code>  : <br> <br> <code class="cpp">Synthesis::Synthesis(IPlugInstanceInfo instanceInfo) : IPLUG_CTOR(kNumParams, kNumPrograms, instanceInfo), lastVirtualKeyboardNoteNumber(virtualKeyboardMinimumNoteNumber - <span class="hljs-number"><span class="hljs-number">1</span></span>), filterEnvelopeAmount(<span class="hljs-number"><span class="hljs-number">0.0</span></span>) { // ... }</code> <br> <br>       <code>Synthesis::Reset</code> : <br> <br> <code class="cpp">mFilterEnvelopeGenerator.setSampleRate(GetSampleRate());</code> <br> <br>      <code>EParams</code> ,       .  <code>AttachGraphics</code>     : <br> <br> <code class="cpp">// Knobs for filter envelope // Attack knob GetParam(mFilterAttack)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Filter Env Attack"</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">10.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); GetParam(mFilterAttack)-&gt;SetShape(<span class="hljs-number"><span class="hljs-number">3</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">139</span></span>, <span class="hljs-number"><span class="hljs-number">178</span></span>, mFilterAttack, &amp;smallKnobBitmap)); // Decay knob: GetParam(mFilterDecay)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Filter Env Decay"</span></span>, <span class="hljs-number"><span class="hljs-number">0.5</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">15.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); GetParam(mFilterDecay)-&gt;SetShape(<span class="hljs-number"><span class="hljs-number">3</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">195</span></span>, <span class="hljs-number"><span class="hljs-number">178</span></span>, mFilterDecay, &amp;smallKnobBitmap)); // Sustain knob: GetParam(mFilterSustain)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Filter Env Sustain"</span></span>, <span class="hljs-number"><span class="hljs-number">0.1</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>, <span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); GetParam(mFilterSustain)-&gt;SetShape(<span class="hljs-number"><span class="hljs-number">2</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">251</span></span>, <span class="hljs-number"><span class="hljs-number">178</span></span>, mFilterSustain, &amp;smallKnobBitmap)); // Release knob: GetParam(mFilterRelease)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Filter Env Release"</span></span>, <span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>, <span class="hljs-number"><span class="hljs-number">15.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); GetParam(mFilterRelease)-&gt;SetShape(<span class="hljs-number"><span class="hljs-number">3</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">307</span></span>, <span class="hljs-number"><span class="hljs-number">178</span></span>, mFilterRelease, &amp;smallKnobBitmap)); // Filter envelope amount knob: GetParam(mFilterEnvelopeAmount)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Filter Env Amount"</span></span>, <span class="hljs-number"><span class="hljs-number">0.0</span></span>, -<span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">363</span></span>, <span class="hljs-number"><span class="hljs-number">178</span></span>, mFilterEnvelopeAmount, &amp;smallKnobBitmap));</code> <br> <br>     ,       <code>smallKnobBitmap</code> .                   .     ,    .  <code>Synthesis::OnParamChange</code>    <code>switch</code> : <br> <br> <code class="cpp">case mFilterAttack: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK, GetParam(paramIdx)-&gt;Value()); break; case mFilterDecay: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_DECAY, GetParam(paramIdx)-&gt;Value()); break; case mFilterSustain: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_SUSTAIN, GetParam(paramIdx)-&gt;Value()); break; case mFilterRelease: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE, GetParam(paramIdx)-&gt;Value()); break; case mFilterEnvelopeAmount: filterEnvelopeAmount = GetParam(paramIdx)-&gt;Value(); break;</code> <br> <br> ! <br>     !           (-   C1),   : <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/f5d/757/3f9/f5d7573f9b3a720fe5898d88ae477cfc.png"> <br> <br>        <code>EnvelopeGenerator</code>  .         .        ! <br> <br>    <a href=""></a> . <br> <br>        :) <br> <br>  : <br> <a href="http://martin-finke.de/blog/articles/audio-plugins-013-filter/">martin-finke.de/blog/articles/audio-plugins-<span class="hljs-number"><span class="hljs-number">013</span></span>-filter</a></code></code> </pre> <code><code><code class="cpp">#include  <i>Filter.h</i> ( )     : <br> <br> class Filter { public: enum FilterMode { FILTER_MODE_LOWPASS = 0, FILTER_MODE_HIGHPASS, FILTER_MODE_BANDPASS, kNumFilterModes }; Filter() : cutoff(0.99), resonance(0.0), mode(FILTER_MODE_LOWPASS), buf0(0.0), buf1(0.0) { calculateFeedbackAmount(); }; double process(double inputValue); inline void setCutoff(double newCutoff) { cutoff = newCutoff; calculateFeedbackAmount(); }; inline void setResonance(double newResonance) { resonance = newResonance; calculateFeedbackAmount(); }; inline void setFilterMode(FilterMode newMode) { mode = newMode; } private: double cutoff; double resonance; FilterMode mode; double feedbackAmount; inline void calculateFeedbackAmount() { feedbackAmount = resonance + resonance/(1.0 - cutoff); } double buf0; double buf1; };</code> <br> <br>  <code>private</code>     <i> </i> <code>cutoff</code>  <i></i> <code>resonance</code> . <code>Mode</code>      (Lowpass, Highpass, Bandpass).  <code>feedbackAmount</code> , <code>buf0</code>  <code>buf1</code>    ,    . <br>          ( <code>calculateFeedbackAmount()</code> ).  <code>process</code>      .   <code>feedbackAmount</code>   <code>cutoff</code>  <code>resonance</code> ,    <code>calculateFeedbackAmount</code>      . <br> <br>   <i>Filter.cpp</i>  : <br> <br> <code class="cpp">// By Paul Kellett // http://www.musicdsp.org/showone.php?id=29 double Filter::process(double inputValue) { buf0 += cutoff * (inputValue - buf0); buf1 += cutoff * (buf0 - buf1); switch (mode) { case FILTER_MODE_LOWPASS: return buf1; case FILTER_MODE_HIGHPASS: return inputValue - buf0; case FILTER_MODE_BANDPASS: return buf0 - buf1; default: return 0.0; } }</code> <br> <br> , ?  ,         <i> </i> . ¬´ ¬ª   ,               (. .    6 ).     <code>buf0</code>  <code>buf1</code> :        .     <code>inputValue</code> ,  - <code>buf0</code> (  ).   .    6 /   12 /.  <code>switch</code> ,  <code>buf1</code>    . , ,    <code>buf0</code> ,       12,   6 /,        . <br> <br>  <code>case</code> <code>FILTER_MODE_HIGHPASS</code>    . <code>buf0</code>       .   <code>inputValue</code>  <code>buf0</code> ,   .    <code>buf1</code> ,     . <br> <br>  <code>case</code> <code>FILTER_MODE_BANDPASS</code> ,  <code>buf0 - buf1</code>   .  <code>buf0</code>       ,     <code>buf1</code> . ,   . <br>  :    <i> </i>    <i> </i> ,   . <br> <br>  <code>buf1</code>     .       <a href="http://ru.wikipedia.org/wiki/%25D0%25A4%25D0%25B8%25D0%25BB%25D1%258C%25D1%2582%25D1%2580_%25D1%2581_%25D0%25B1%25D0%25B5%25D1%2581%25D0%25BA%25D0%25BE%25D0%25BD%25D0%25B5%25D1%2587%25D0%25BD%25D0%25BE%25D0%25B9_%25D0%25B8%25D0%25BC%25D0%25BF%25D1%2583%25D0%25BB%25D1%258C%25D1%2581%25D0%25BD%25D0%25BE%25D0%25B9_%25D1%2585%25D0%25B0%25D1%2580%25D0%25B0%25D0%25BA%25D1%2582%25D0%25B5%25D1%2580%25D0%25B8%25D1%2581%25D1%2582%25D0%25B8%25D0%25BA%25D0%25BE%25D0%25B9">    </a> ( <i>Infinite Impulse Response</i> ,  <i>IIR</i> ).  <a href="http://www.dspguide.com/ch14/1.htm"> </a> ,      .      ,         ,      . <br> <br>   <br>       ,     ,     .   ,  ,      ,  ,          .           ,  NI Massive,   ¬´ <a href="http://lurkmore.to/%25D0%25A2%25D1%2591%25D0%25BF%25D0%25BB%25D1%258B%25D0%25B9_%25D0%25BB%25D0%25B0%25D0%25BC%25D0%25BF%25D0%25BE%25D0%25B2%25D1%258B%25D0%25B9_%25D0%25B7%25D0%25B2%25D1%2583%25D0%25BA">  </a> ¬ª.       ,          ,   .        ,          (  Massive       ).      ¬´¬ª , , , AAS Ultra Analog,       ,     ,    ,        .         ,  ,    <a href="http://www.kvraudio.com/forum/viewtopic.php%3Ft%3D350246"></a> ,   ,      NI Reaktor. ,            ‚Äî    ,    ..     . <br> <br>   <br>     .   GUI.  <i>bg.png</i>   ( <i>‚ÄúMove to trash‚Äù</i>  Xcode),       : <br> <br> <a href="">filtermode.png</a> <a href="">knob_small.png</a> (  ,   50 50 ) <a href="">bg.png</a> (       ) <br> <br>    ID  <i>resource.h</i> : <br> <br> <code class="cpp">// Unique IDs for each image resource. #define BG_ID 101 #define WHITE_KEY_ID 102 #define BLACK_KEY_ID 103 #define WAVEFORM_ID 104 #define KNOB_ID 105 #define KNOB_SMALL_ID 106 #define FILTERMODE_ID 107 // Image resource locations for this plug. #define BG_FN "resources/img/bg.png" #define WHITE_KEY_FN "resources/img/whitekey.png" #define BLACK_KEY_FN "resources/img/blackkey.png" #define WAVEFORM_FN "resources/img/waveform.png" #define KNOB_FN "resources/img/knob.png" #define KNOB_SMALL_FN "resources/img/knob_small.png" #define FILTERMODE_FN "resources/img/filtermode.png"</code> <br> <br>  <i>Synthesis.rc</i> : <br> <br> <code class="cpp">#include "resource.h" BG_ID PNG BG_FN WHITE_KEY_ID PNG WHITE_KEY_FN BLACK_KEY_ID PNG BLACK_KEY_FN WAVEFORM_ID PNG WAVEFORM_FN KNOB_ID PNG KNOB_FN KNOB_SMALL_ID PNG KNOB_SMALL_FN FILTERMODE_ID PNG FILTERMODE_FN</code> <br> <br>   <code>#include "Filter.h"</code>  <i>Synthesis.h</i>    <code>private</code> : <br> <br> <code class="cpp">Filter mFilter;</code> <br> <br>  <code>EParams</code>  <i>Synthesis.cpp</i> : <br> <br> <code class="cpp">enum EParams { mWaveform = 0, mAttack, mDecay, mSustain, mRelease, mFilterMode, mFilterCutoff, mFilterResonance, mFilterAttack, mFilterDecay, mFilterSustain, mFilterRelease, mFilterEnvelopeAmount, kNumParams };</code> <br> <br>        : <br> <br> <code class="cpp">pGraphics-&gt;AttachControl(new ISwitchControl(this, 24, 38, mWaveform, &amp;waveformBitmap));</code> <br> <br>      .      (Lowpass, Highpass, Bandpass).    <code>AttachGraphics(pGraphics)</code> : <br> <br> <code class="cpp">GetParam(mFilterMode)-&gt;InitEnum("Filter Mode", Filter::FILTER_MODE_LOWPASS, Filter::kNumFilterModes); IBitmap filtermodeBitmap = pGraphics-&gt;LoadIBitmap(FILTERMODE_ID, FILTERMODE_FN, 3); pGraphics-&gt;AttachControl(new ISwitchControl(this, 24, 123, mFilterMode, &amp;filtermodeBitmap));</code> <br> <br>         .    .     <i>knob_small.png</i> : <br> <br> <code class="cpp">// Knobs for filter cutoff and resonance IBitmap smallKnobBitmap = pGraphics-&gt;LoadIBitmap(KNOB_SMALL_ID, KNOB_SMALL_FN, 64); // Cutoff knob: GetParam(mFilterCutoff)-&gt;InitDouble("Cutoff", 0.99, 0.01, 0.99, 0.001); GetParam(mFilterCutoff)-&gt;SetShape(2); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 5, 177, mFilterCutoff, &amp;smallKnobBitmap)); // Resonance knob: GetParam(mFilterResonance)-&gt;InitDouble("Resonance", 0.01, 0.01, 1.0, 0.001); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 61, 177, mFilterResonance, &amp;smallKnobBitmap));</code> <br> <br>   ,           <code>1.0</code> ,   <code>calculateFeedbackAmount</code>    , . <br>  <code>ProcessDoubleReplacing</code>     : <br> <br> <code class="cpp">leftOutput[i] = rightOutput[i] = mFilter.process(mOscillator.nextSample() * mEnvelopeGenerator.nextSample() * velocity / 127.0);</code> <br> <br>       .  <code>switch</code>   <code>Synthesis::OnParamChange</code> : <br> <br> <code class="cpp">case mFilterCutoff: mFilter.setCutoff(GetParam(paramIdx)-&gt;Value()); break; case mFilterResonance: mFilter.setResonance(GetParam(paramIdx)-&gt;Value()); break; case mFilterMode: mFilter.setFilterMode(static_cast&lt;Filter::FilterMode&gt;(GetParam(paramIdx)-&gt;Int())); break;</code> <br> <br>    .  -      . <br> <br>  <br> <br>  ‚Äî      .   ,   ,          . <br>      : <br> <br> <code class="cpp">buf0 += cutoff * (inputValue - buf0 + feedbackAmount * (buf0 - buf1));</code> <br> <br> ,   ,      ( <code>buf0 ‚Äì buf1</code> ),   <code>feedbackAmount</code> .    <code>calculateFeedbackAmount</code>  <code>feedbackAmount</code>  <code>resonance</code> , . .    ,   . <br> <br>  ,            .     ,  <i></i> ,      <a href="https://www.youtube.com/watch%3Fv%3DJWyMj6KxGHM"> </a> .    ,        ,       . <br> <br>  -12 /  -24 / <br>        !     24   .     <code>switch</code>  <code>Filter::process</code> : <br> <br> <code class="cpp">buf2 += cutoff * (buf1 - buf2); buf3 += cutoff * (buf2 ‚Äì buf3);</code> <br> <br>   :      ,       ,            .     ,       , , <a href="https://ccrma.stanford.edu/~Jos/filters/Filter_Stability.html"></a> (       ).     <code>switch</code> : <br> <br> <code class="cpp">switch (mode) { case FILTER_MODE_LOWPASS: return buf3; case FILTER_MODE_HIGHPASS: return inputValue - buf3; case FILTER_MODE_BANDPASS: return buf0 - buf3; default: return 0.0; }</code> <br> <br>   <code>buf1</code>  <code>buf3</code> ‚Äì      .    -24 /.     <code>buf2</code>  <code>buf3</code> ,        <code>private</code> <i>Filter.h</i> : <br> <br> <code class="cpp">double buf2; double buf3;</code> <br> <br>    ,   <code>buf0</code> c <code>buf1</code> : <br> <br> <code class="cpp">Filter() : // ... buf0(0.0), buf1(0.0), buf2(0.0), buf3(0.0) // ...</code> <br> <br>     , ,     :     .       . <br>          ? <br> <br>   <br>    .  ,           ,       . <br> -      <code>cutoff</code>   .      .    <code>cutoffMod</code> ,    ,       <code>cutoff</code>    .     <code>#include    private</code> : <br> <br> <code class="cpp">double cutoffMod;</code> <br> <br> : <br> <br> <code class="cpp">Filter() : cutoff(0.99), resonance(0.01), cutoffMod(0.0), // ...</code> <br> <br>         .   <code>private</code> : <br> <br> <code class="cpp">inline double getCalculatedCutoff() const { return fmax(fmin(cutoff + cutoffMod, 0.99), 0.01); };</code> <br> <br> <code>calculateFeedbackAmount</code>     : <br> <br> <code class="cpp">inline void calculateFeedbackAmount() { feedbackAmount = resonance + resonance/(1.0 - getCalculatedCutoff()); }</code> <br> <br>       <code>cutoffMod</code> .   <code>feedbackAmount</code>    ,     : <br> <br> <code class="cpp">inline void setCutoffMod(double newCutoffMod) { cutoffMod = newCutoffMod; calculateFeedbackAmount(); }</code> <br> <br> ,       .   <code>Filter::process</code>   : <br> <br> <code class="cpp">if (inputValue == 0.0) return inputValue; double calculatedCutoff = getCalculatedCutoff(); buf0 += calculatedCutoff * (inputValue - buf0 + feedbackAmount * (buf0 - buf1)); buf1 += calculatedCutoff * (buf0 - buf1); buf2 += calculatedCutoff * (buf1 - buf2); buf3 += calculatedCutoff * (buf2 ‚Äì buf3);</code> <br> <br>        ,    .    ,      ,   .     .     <code>cutoff</code>  <code>calculatedCutoff</code>   -. <br> <br> ,       ( <code>setCutoffMod</code> ),   <code>Synthesis</code>    ,     ,    .    ,        <code>cutoffMod</code> .    <code>filterEnvelopeAmount</code>    <code>-1</code>  <code>+1</code> .   GUI. <br> <br>   <code>private</code> <i>Synthesis.h</i>    : <br> <br> <code class="cpp">EnvelopeGenerator mFilterEnvelopeGenerator; double filterEnvelopeAmount;</code> <br> <br>       MIDI ,      <code>onNoteOn</code>  <code>onNoteOff</code> : <br> <br> <code class="cpp">inline void onNoteOn(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); mFilterEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); }; inline void onNoteOff(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); mFilterEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); };</code> <br> <br>    .   <code>ProcessDoubleReplacing</code>        : <br> <br> <code class="cpp">mFilter.setCutoffMod(mFilterEnvelopeGenerator.nextSample() * filterEnvelopeAmount);</code> <br> <br>  ,        <code>nextSample</code>  <code>filterEnvelopeAmount</code>     <code>cutoffMod</code> .     <code>filterEnvelopeAmount</code>  : <br> <br> <code class="cpp">Synthesis::Synthesis(IPlugInstanceInfo instanceInfo) : IPLUG_CTOR(kNumParams, kNumPrograms, instanceInfo), lastVirtualKeyboardNoteNumber(virtualKeyboardMinimumNoteNumber - 1), filterEnvelopeAmount(0.0) { // ... }</code> <br> <br>       <code>Synthesis::Reset</code> : <br> <br> <code class="cpp">mFilterEnvelopeGenerator.setSampleRate(GetSampleRate());</code> <br> <br>      <code>EParams</code> ,       .  <code>AttachGraphics</code>     : <br> <br> <code class="cpp">// Knobs for filter envelope // Attack knob GetParam(mFilterAttack)-&gt;InitDouble("Filter Env Attack", 0.01, 0.01, 10.0, 0.001); GetParam(mFilterAttack)-&gt;SetShape(3); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 139, 178, mFilterAttack, &amp;smallKnobBitmap)); // Decay knob: GetParam(mFilterDecay)-&gt;InitDouble("Filter Env Decay", 0.5, 0.01, 15.0, 0.001); GetParam(mFilterDecay)-&gt;SetShape(3); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 195, 178, mFilterDecay, &amp;smallKnobBitmap)); // Sustain knob: GetParam(mFilterSustain)-&gt;InitDouble("Filter Env Sustain", 0.1, 0.001, 1.0, 0.001); GetParam(mFilterSustain)-&gt;SetShape(2); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 251, 178, mFilterSustain, &amp;smallKnobBitmap)); // Release knob: GetParam(mFilterRelease)-&gt;InitDouble("Filter Env Release", 1.0, 0.001, 15.0, 0.001); GetParam(mFilterRelease)-&gt;SetShape(3); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 307, 178, mFilterRelease, &amp;smallKnobBitmap)); // Filter envelope amount knob: GetParam(mFilterEnvelopeAmount)-&gt;InitDouble("Filter Env Amount", 0.0, -1.0, 1.0, 0.001); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 363, 178, mFilterEnvelopeAmount, &amp;smallKnobBitmap));</code> <br> <br>     ,       <code>smallKnobBitmap</code> .                   .     ,    .  <code>Synthesis::OnParamChange</code>    <code>switch</code> : <br> <br> <code class="cpp">case mFilterAttack: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK, GetParam(paramIdx)-&gt;Value()); break; case mFilterDecay: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_DECAY, GetParam(paramIdx)-&gt;Value()); break; case mFilterSustain: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_SUSTAIN, GetParam(paramIdx)-&gt;Value()); break; case mFilterRelease: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE, GetParam(paramIdx)-&gt;Value()); break; case mFilterEnvelopeAmount: filterEnvelopeAmount = GetParam(paramIdx)-&gt;Value(); break;</code> <br> <br> ! <br>     !           (-   C1),   : <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/f5d/757/3f9/f5d7573f9b3a720fe5898d88ae477cfc.png"> <br> <br>        <code>EnvelopeGenerator</code>  .         .        ! <br> <br>    <a href=""></a> . <br> <br>        :) <br> <br>  : <br> <a href="http://martin-finke.de/blog/articles/audio-plugins-013-filter/">martin-finke.de/blog/articles/audio-plugins-013-filter</a></code></code> <pre> <code class="hljs erlang-repl"><code class="cpp">#include  <i>Filter.h</i> ( )     : <br> <br> class Filter { public: enum FilterMode { FILTER_MODE_LOWPASS = <span class="hljs-number"><span class="hljs-number">0</span></span>, FILTER_MODE_HIGHPASS, FILTER_MODE_BANDPASS, kNumFilterModes }; Filter() : cutoff(<span class="hljs-number"><span class="hljs-number">0.99</span></span>), resonance(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), mode(FILTER_MODE_LOWPASS), buf0(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), buf1(<span class="hljs-number"><span class="hljs-number">0.0</span></span>) { calculateFeedbackAmount(); }; double process(double inputValue); inline void setCutoff(double newCutoff) { cutoff = newCutoff; calculateFeedbackAmount(); }; inline void setResonance(double newResonance) { resonance = newResonance; calculateFeedbackAmount(); }; inline void setFilterMode(FilterMode newMode) { mode = newMode; } private: double cutoff; double resonance; FilterMode mode; double feedbackAmount; inline void calculateFeedbackAmount() { feedbackAmount = resonance + resonance/(<span class="hljs-number"><span class="hljs-number">1.0</span></span> - cutoff); } double buf0; double buf1; };</code> <br> <br>  <code>private</code>     <i> </i> <code>cutoff</code>  <i></i> <code>resonance</code> . <code>Mode</code>      (Lowpass, Highpass, Bandpass).  <code>feedbackAmount</code> , <code>buf0</code>  <code>buf1</code>    ,    . <br>          ( <code>calculateFeedbackAmount()</code> ).  <code>process</code>      .   <code>feedbackAmount</code>   <code>cutoff</code>  <code>resonance</code> ,    <code>calculateFeedbackAmount</code>      . <br> <br>   <i>Filter.cpp</i>  : <br> <br> <code class="cpp">// By Paul Kellett // http://www.musicdsp.org/showone.php?id=<span class="hljs-number"><span class="hljs-number">29</span></span> double Filter::process(double inputValue) { buf0 += cutoff * (inputValue - buf0); buf1 += cutoff * (buf0 - buf1); switch (mode) { case FILTER_MODE_LOWPASS: return buf1; case FILTER_MODE_HIGHPASS: return inputValue - buf0; case FILTER_MODE_BANDPASS: return buf0 - buf1; default: return <span class="hljs-number"><span class="hljs-number">0.0</span></span>; } }</code> <br> <br> , ?  ,         <i> </i> . ¬´ ¬ª   ,               (. .    <span class="hljs-number"><span class="hljs-number">6</span></span> ).     <code>buf0</code>  <code>buf1</code> :        .     <code>inputValue</code> ,  - <code>buf0</code> (  ).   .    <span class="hljs-number"><span class="hljs-number">6</span></span> /   <span class="hljs-number"><span class="hljs-number">12</span></span> /.  <code>switch</code> ,  <code>buf1</code>    . , ,    <code>buf0</code> ,       <span class="hljs-number"><span class="hljs-number">12</span></span>,   <span class="hljs-number"><span class="hljs-number">6</span></span> /,        . <br> <br>  <code>case</code> <code>FILTER_MODE_HIGHPASS</code>    . <code>buf0</code>       .   <code>inputValue</code>  <code>buf0</code> ,   .    <code>buf1</code> ,     . <br> <br>  <code>case</code> <code>FILTER_MODE_BANDPASS</code> ,  <code>buf0 - buf1</code>   .  <code>buf0</code>       ,     <code>buf1</code> . ,   . <br>  :    <i> </i>    <i> </i> ,   . <br> <br>  <code>buf1</code>     .       <a href="http://ru.wikipedia.org/wiki/%25D0%25A4%25D0%25B8%25D0%25BB%25D1%258C%25D1%2582%25D1%2580_%25D1%2581_%25D0%25B1%25D0%25B5%25D1%2581%25D0%25BA%25D0%25BE%25D0%25BD%25D0%25B5%25D1%2587%25D0%25BD%25D0%25BE%25D0%25B9_%25D0%25B8%25D0%25BC%25D0%25BF%25D1%2583%25D0%25BB%25D1%258C%25D1%2581%25D0%25BD%25D0%25BE%25D0%25B9_%25D1%2585%25D0%25B0%25D1%2580%25D0%25B0%25D0%25BA%25D1%2582%25D0%25B5%25D1%2580%25D0%25B8%25D1%2581%25D1%2582%25D0%25B8%25D0%25BA%25D0%25BE%25D0%25B9">    </a> ( <i>Infinite Impulse Response</i> ,  <i>IIR</i> ).  <a href="http://www.dspguide.com/ch14/1.htm"> </a> ,      .      ,         ,      . <br> <br>   <br>       ,     ,     .   ,  ,      ,  ,          .           ,  NI Massive,   ¬´ <a href="http://lurkmore.to/%25D0%25A2%25D1%2591%25D0%25BF%25D0%25BB%25D1%258B%25D0%25B9_%25D0%25BB%25D0%25B0%25D0%25BC%25D0%25BF%25D0%25BE%25D0%25B2%25D1%258B%25D0%25B9_%25D0%25B7%25D0%25B2%25D1%2583%25D0%25BA">  </a> ¬ª.       ,          ,   .        ,          (  Massive       ).      ¬´¬ª , , , AAS Ultra Analog,       ,     ,    ,        .         ,  ,    <a href="http://www.kvraudio.com/forum/viewtopic.php%3Ft%3D350246"></a> ,   ,      NI Reaktor. ,            ‚Äî    ,    ..     . <br> <br>   <br>     .   GUI.  <i>bg.png</i>   ( <i>‚ÄúMove to trash‚Äù</i>  Xcode),       : <br> <br> <a href="">filtermode.png</a> <a href="">knob_small.png</a> (  ,   <span class="hljs-number"><span class="hljs-number">50</span></span> <span class="hljs-number"><span class="hljs-number">50</span></span> ) <a href="">bg.png</a> (       ) <br> <br>    ID  <i>resource.h</i> : <br> <br> <code class="cpp">// Unique IDs for each image resource. #define BG_ID <span class="hljs-number"><span class="hljs-number">101</span></span> #define WHITE_KEY_ID <span class="hljs-number"><span class="hljs-number">102</span></span> #define BLACK_KEY_ID <span class="hljs-number"><span class="hljs-number">103</span></span> #define WAVEFORM_ID <span class="hljs-number"><span class="hljs-number">104</span></span> #define KNOB_ID <span class="hljs-number"><span class="hljs-number">105</span></span> #define KNOB_SMALL_ID <span class="hljs-number"><span class="hljs-number">106</span></span> #define FILTERMODE_ID <span class="hljs-number"><span class="hljs-number">107</span></span> // Image resource locations for this plug. #define BG_FN <span class="hljs-string"><span class="hljs-string">"resources/img/bg.png"</span></span> #define WHITE_KEY_FN <span class="hljs-string"><span class="hljs-string">"resources/img/whitekey.png"</span></span> #define BLACK_KEY_FN <span class="hljs-string"><span class="hljs-string">"resources/img/blackkey.png"</span></span> #define WAVEFORM_FN <span class="hljs-string"><span class="hljs-string">"resources/img/waveform.png"</span></span> #define KNOB_FN <span class="hljs-string"><span class="hljs-string">"resources/img/knob.png"</span></span> #define KNOB_SMALL_FN <span class="hljs-string"><span class="hljs-string">"resources/img/knob_small.png"</span></span> #define FILTERMODE_FN <span class="hljs-string"><span class="hljs-string">"resources/img/filtermode.png"</span></span></code> <br> <br>  <i>Synthesis.rc</i> : <br> <br> <code class="cpp">#include <span class="hljs-string"><span class="hljs-string">"resource.h"</span></span> BG_ID PNG BG_FN WHITE_KEY_ID PNG WHITE_KEY_FN BLACK_KEY_ID PNG BLACK_KEY_FN WAVEFORM_ID PNG WAVEFORM_FN KNOB_ID PNG KNOB_FN KNOB_SMALL_ID PNG KNOB_SMALL_FN FILTERMODE_ID PNG FILTERMODE_FN</code> <br> <br>   <code>#include <span class="hljs-string"><span class="hljs-string">"Filter.h"</span></span></code>  <i>Synthesis.h</i>    <code>private</code> : <br> <br> <code class="cpp">Filter mFilter;</code> <br> <br>  <code>EParams</code>  <i>Synthesis.cpp</i> : <br> <br> <code class="cpp">enum EParams { mWaveform = <span class="hljs-number"><span class="hljs-number">0</span></span>, mAttack, mDecay, mSustain, mRelease, mFilterMode, mFilterCutoff, mFilterResonance, mFilterAttack, mFilterDecay, mFilterSustain, mFilterRelease, mFilterEnvelopeAmount, kNumParams };</code> <br> <br>        : <br> <br> <code class="cpp">pGraphics-&gt;AttachControl(new ISwitchControl(this, <span class="hljs-number"><span class="hljs-number">24</span></span>, <span class="hljs-number"><span class="hljs-number">38</span></span>, mWaveform, &amp;waveformBitmap));</code> <br> <br>      .      (Lowpass, Highpass, Bandpass).    <code>AttachGraphics(pGraphics)</code> : <br> <br> <code class="cpp">GetParam(mFilterMode)-&gt;InitEnum(<span class="hljs-string"><span class="hljs-string">"Filter Mode"</span></span>, Filter::FILTER_MODE_LOWPASS, Filter::kNumFilterModes); IBitmap filtermodeBitmap = pGraphics-&gt;LoadIBitmap(FILTERMODE_ID, FILTERMODE_FN, <span class="hljs-number"><span class="hljs-number">3</span></span>); pGraphics-&gt;AttachControl(new ISwitchControl(this, <span class="hljs-number"><span class="hljs-number">24</span></span>, <span class="hljs-number"><span class="hljs-number">123</span></span>, mFilterMode, &amp;filtermodeBitmap));</code> <br> <br>         .    .     <i>knob_small.png</i> : <br> <br> <code class="cpp">// Knobs for filter cutoff and resonance IBitmap smallKnobBitmap = pGraphics-&gt;LoadIBitmap(KNOB_SMALL_ID, KNOB_SMALL_FN, <span class="hljs-number"><span class="hljs-number">64</span></span>); // Cutoff knob: GetParam(mFilterCutoff)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Cutoff"</span></span>, <span class="hljs-number"><span class="hljs-number">0.99</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">0.99</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); GetParam(mFilterCutoff)-&gt;SetShape(<span class="hljs-number"><span class="hljs-number">2</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-number"><span class="hljs-number">177</span></span>, mFilterCutoff, &amp;smallKnobBitmap)); // Resonance knob: GetParam(mFilterResonance)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Resonance"</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">61</span></span>, <span class="hljs-number"><span class="hljs-number">177</span></span>, mFilterResonance, &amp;smallKnobBitmap));</code> <br> <br>   ,           <code><span class="hljs-number"><span class="hljs-number">1.0</span></span></code> ,   <code>calculateFeedbackAmount</code>    , . <br>  <code>ProcessDoubleReplacing</code>     : <br> <br> <code class="cpp">leftOutput[i] = rightOutput[i] = mFilter.process(mOscillator.nextSample() * mEnvelopeGenerator.nextSample() * velocity / <span class="hljs-number"><span class="hljs-number">127.0</span></span>);</code> <br> <br>       .  <code>switch</code>   <code>Synthesis::OnParamChange</code> : <br> <br> <code class="cpp">case mFilterCutoff: mFilter.setCutoff(GetParam(paramIdx)-&gt;Value()); break; case mFilterResonance: mFilter.setResonance(GetParam(paramIdx)-&gt;Value()); break; case mFilterMode: mFilter.setFilterMode(static_cast&lt;Filter::FilterMode&gt;(GetParam(paramIdx)-&gt;Int())); break;</code> <br> <br>    .  -      . <br> <br>  <br> <br>  ‚Äî      .   ,   ,          . <br>      : <br> <br> <code class="cpp">buf0 += cutoff * (inputValue - buf0 + feedbackAmount * (buf0 - buf1));</code> <br> <br> ,   ,      ( <code>buf0 ‚Äì buf1</code> ),   <code>feedbackAmount</code> .    <code>calculateFeedbackAmount</code>  <code>feedbackAmount</code>  <code>resonance</code> , . .    ,   . <br> <br>  ,            .     ,  <i></i> ,      <a href="https://www.youtube.com/watch%3Fv%3DJWyMj6KxGHM"> </a> .    ,        ,       . <br> <br>  -<span class="hljs-number"><span class="hljs-number">12</span></span> /  -<span class="hljs-number"><span class="hljs-number">24</span></span> / <br>        !     <span class="hljs-number"><span class="hljs-number">24</span></span>   .     <code>switch</code>  <code>Filter::process</code> : <br> <br> <code class="cpp">buf2 += cutoff * (buf1 - buf2); buf3 += cutoff * (buf2 ‚Äì buf3);</code> <br> <br>   :      ,       ,            .     ,       , , <a href="https://ccrma.stanford.edu/~Jos/filters/Filter_Stability.html"></a> (       ).     <code>switch</code> : <br> <br> <code class="cpp">switch (mode) { case FILTER_MODE_LOWPASS: return buf3; case FILTER_MODE_HIGHPASS: return inputValue - buf3; case FILTER_MODE_BANDPASS: return buf0 - buf3; default: return <span class="hljs-number"><span class="hljs-number">0.0</span></span>; }</code> <br> <br>   <code>buf1</code>  <code>buf3</code> ‚Äì      .    -<span class="hljs-number"><span class="hljs-number">24</span></span> /.     <code>buf2</code>  <code>buf3</code> ,        <code>private</code> <i>Filter.h</i> : <br> <br> <code class="cpp">double buf2; double buf3;</code> <br> <br>    ,   <code>buf0</code> c <code>buf1</code> : <br> <br> <code class="cpp">Filter() : // ... buf0(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), buf1(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), buf2(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), buf3(<span class="hljs-number"><span class="hljs-number">0.0</span></span>) // ...</code> <br> <br>     , ,     :     .       . <br>          ? <br> <br>   <br>    .  ,           ,       . <br> -      <code>cutoff</code>   .      .    <code>cutoffMod</code> ,    ,       <code>cutoff</code>    .     <code><code>#include    private</code> : <br> <br> <code class="cpp">double cutoffMod;</code> <br> <br> : <br> <br> <code class="cpp">Filter() : cutoff(<span class="hljs-number"><span class="hljs-number">0.99</span></span>), resonance(<span class="hljs-number"><span class="hljs-number">0.01</span></span>), cutoffMod(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), // ...</code> <br> <br>         .   <code>private</code> : <br> <br> <code class="cpp">inline double getCalculatedCutoff() const { return fmax(fmin(cutoff + cutoffMod, <span class="hljs-number"><span class="hljs-number">0.99</span></span>), <span class="hljs-number"><span class="hljs-number">0.01</span></span>); };</code> <br> <br> <code>calculateFeedbackAmount</code>     : <br> <br> <code class="cpp">inline void calculateFeedbackAmount() { feedbackAmount = resonance + resonance/(<span class="hljs-number"><span class="hljs-number">1.0</span></span> - getCalculatedCutoff()); }</code> <br> <br>       <code>cutoffMod</code> .   <code>feedbackAmount</code>    ,     : <br> <br> <code class="cpp">inline void setCutoffMod(double newCutoffMod) { cutoffMod = newCutoffMod; calculateFeedbackAmount(); }</code> <br> <br> ,       .   <code>Filter::process</code>   : <br> <br> <code class="cpp">if (inputValue == <span class="hljs-number"><span class="hljs-number">0.0</span></span>) return inputValue; double calculatedCutoff = getCalculatedCutoff(); buf0 += calculatedCutoff * (inputValue - buf0 + feedbackAmount * (buf0 - buf1)); buf1 += calculatedCutoff * (buf0 - buf1); buf2 += calculatedCutoff * (buf1 - buf2); buf3 += calculatedCutoff * (buf2 ‚Äì buf3);</code> <br> <br>        ,    .    ,      ,   .     .     <code>cutoff</code>  <code>calculatedCutoff</code>   -. <br> <br> ,       ( <code>setCutoffMod</code> ),   <code>Synthesis</code>    ,     ,    .    ,        <code>cutoffMod</code> .    <code>filterEnvelopeAmount</code>    <code>-<span class="hljs-number"><span class="hljs-number">1</span></span></code>  <code>+<span class="hljs-number"><span class="hljs-number">1</span></span></code> .   GUI. <br> <br>   <code>private</code> <i>Synthesis.h</i>    : <br> <br> <code class="cpp">EnvelopeGenerator mFilterEnvelopeGenerator; double filterEnvelopeAmount;</code> <br> <br>       MIDI ,      <code>onNoteOn</code>  <code>onNoteOff</code> : <br> <br> <code class="cpp">inline void onNoteOn(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); mFilterEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); }; inline void onNoteOff(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); mFilterEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); };</code> <br> <br>    .   <code>ProcessDoubleReplacing</code>        : <br> <br> <code class="cpp">mFilter.setCutoffMod(mFilterEnvelopeGenerator.nextSample() * filterEnvelopeAmount);</code> <br> <br>  ,        <code>nextSample</code>  <code>filterEnvelopeAmount</code>     <code>cutoffMod</code> .     <code>filterEnvelopeAmount</code>  : <br> <br> <code class="cpp">Synthesis::Synthesis(IPlugInstanceInfo instanceInfo) : IPLUG_CTOR(kNumParams, kNumPrograms, instanceInfo), lastVirtualKeyboardNoteNumber(virtualKeyboardMinimumNoteNumber - <span class="hljs-number"><span class="hljs-number">1</span></span>), filterEnvelopeAmount(<span class="hljs-number"><span class="hljs-number">0.0</span></span>) { // ... }</code> <br> <br>       <code>Synthesis::Reset</code> : <br> <br> <code class="cpp">mFilterEnvelopeGenerator.setSampleRate(GetSampleRate());</code> <br> <br>      <code>EParams</code> ,       .  <code>AttachGraphics</code>     : <br> <br> <code class="cpp">// Knobs for filter envelope // Attack knob GetParam(mFilterAttack)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Filter Env Attack"</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">10.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); GetParam(mFilterAttack)-&gt;SetShape(<span class="hljs-number"><span class="hljs-number">3</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">139</span></span>, <span class="hljs-number"><span class="hljs-number">178</span></span>, mFilterAttack, &amp;smallKnobBitmap)); // Decay knob: GetParam(mFilterDecay)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Filter Env Decay"</span></span>, <span class="hljs-number"><span class="hljs-number">0.5</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">15.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); GetParam(mFilterDecay)-&gt;SetShape(<span class="hljs-number"><span class="hljs-number">3</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">195</span></span>, <span class="hljs-number"><span class="hljs-number">178</span></span>, mFilterDecay, &amp;smallKnobBitmap)); // Sustain knob: GetParam(mFilterSustain)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Filter Env Sustain"</span></span>, <span class="hljs-number"><span class="hljs-number">0.1</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>, <span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); GetParam(mFilterSustain)-&gt;SetShape(<span class="hljs-number"><span class="hljs-number">2</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">251</span></span>, <span class="hljs-number"><span class="hljs-number">178</span></span>, mFilterSustain, &amp;smallKnobBitmap)); // Release knob: GetParam(mFilterRelease)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Filter Env Release"</span></span>, <span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>, <span class="hljs-number"><span class="hljs-number">15.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); GetParam(mFilterRelease)-&gt;SetShape(<span class="hljs-number"><span class="hljs-number">3</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">307</span></span>, <span class="hljs-number"><span class="hljs-number">178</span></span>, mFilterRelease, &amp;smallKnobBitmap)); // Filter envelope amount knob: GetParam(mFilterEnvelopeAmount)-&gt;InitDouble(<span class="hljs-string"><span class="hljs-string">"Filter Env Amount"</span></span>, <span class="hljs-number"><span class="hljs-number">0.0</span></span>, -<span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.001</span></span>); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, <span class="hljs-number"><span class="hljs-number">363</span></span>, <span class="hljs-number"><span class="hljs-number">178</span></span>, mFilterEnvelopeAmount, &amp;smallKnobBitmap));</code> <br> <br>     ,       <code>smallKnobBitmap</code> .                   .     ,    .  <code>Synthesis::OnParamChange</code>    <code>switch</code> : <br> <br> <code class="cpp">case mFilterAttack: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK, GetParam(paramIdx)-&gt;Value()); break; case mFilterDecay: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_DECAY, GetParam(paramIdx)-&gt;Value()); break; case mFilterSustain: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_SUSTAIN, GetParam(paramIdx)-&gt;Value()); break; case mFilterRelease: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE, GetParam(paramIdx)-&gt;Value()); break; case mFilterEnvelopeAmount: filterEnvelopeAmount = GetParam(paramIdx)-&gt;Value(); break;</code> <br> <br> ! <br>     !           (-   C1),   : <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/f5d/757/3f9/f5d7573f9b3a720fe5898d88ae477cfc.png"> <br> <br>        <code>EnvelopeGenerator</code>  .         .        ! <br> <br>    <a href=""></a> . <br> <br>        :) <br> <br>  : <br> <a href="http://martin-finke.de/blog/articles/audio-plugins-013-filter/">martin-finke.de/blog/articles/audio-plugins-<span class="hljs-number"><span class="hljs-number">013</span></span>-filter</a></code></code> </pre> <code><code><code class="cpp">#include  <i>Filter.h</i> ( )     : <br> <br> class Filter { public: enum FilterMode { FILTER_MODE_LOWPASS = 0, FILTER_MODE_HIGHPASS, FILTER_MODE_BANDPASS, kNumFilterModes }; Filter() : cutoff(0.99), resonance(0.0), mode(FILTER_MODE_LOWPASS), buf0(0.0), buf1(0.0) { calculateFeedbackAmount(); }; double process(double inputValue); inline void setCutoff(double newCutoff) { cutoff = newCutoff; calculateFeedbackAmount(); }; inline void setResonance(double newResonance) { resonance = newResonance; calculateFeedbackAmount(); }; inline void setFilterMode(FilterMode newMode) { mode = newMode; } private: double cutoff; double resonance; FilterMode mode; double feedbackAmount; inline void calculateFeedbackAmount() { feedbackAmount = resonance + resonance/(1.0 - cutoff); } double buf0; double buf1; };</code> <br> <br>  <code>private</code>     <i> </i> <code>cutoff</code>  <i></i> <code>resonance</code> . <code>Mode</code>      (Lowpass, Highpass, Bandpass).  <code>feedbackAmount</code> , <code>buf0</code>  <code>buf1</code>    ,    . <br>          ( <code>calculateFeedbackAmount()</code> ).  <code>process</code>      .   <code>feedbackAmount</code>   <code>cutoff</code>  <code>resonance</code> ,    <code>calculateFeedbackAmount</code>      . <br> <br>   <i>Filter.cpp</i>  : <br> <br> <code class="cpp">// By Paul Kellett // http://www.musicdsp.org/showone.php?id=29 double Filter::process(double inputValue) { buf0 += cutoff * (inputValue - buf0); buf1 += cutoff * (buf0 - buf1); switch (mode) { case FILTER_MODE_LOWPASS: return buf1; case FILTER_MODE_HIGHPASS: return inputValue - buf0; case FILTER_MODE_BANDPASS: return buf0 - buf1; default: return 0.0; } }</code> <br> <br> , ?  ,         <i> </i> . ¬´ ¬ª   ,               (. .    6 ).     <code>buf0</code>  <code>buf1</code> :        .     <code>inputValue</code> ,  - <code>buf0</code> (  ).   .    6 /   12 /.  <code>switch</code> ,  <code>buf1</code>    . , ,    <code>buf0</code> ,       12,   6 /,        . <br> <br>  <code>case</code> <code>FILTER_MODE_HIGHPASS</code>    . <code>buf0</code>       .   <code>inputValue</code>  <code>buf0</code> ,   .    <code>buf1</code> ,     . <br> <br>  <code>case</code> <code>FILTER_MODE_BANDPASS</code> ,  <code>buf0 - buf1</code>   .  <code>buf0</code>       ,     <code>buf1</code> . ,   . <br>  :    <i> </i>    <i> </i> ,   . <br> <br>  <code>buf1</code>     .       <a href="http://ru.wikipedia.org/wiki/%25D0%25A4%25D0%25B8%25D0%25BB%25D1%258C%25D1%2582%25D1%2580_%25D1%2581_%25D0%25B1%25D0%25B5%25D1%2581%25D0%25BA%25D0%25BE%25D0%25BD%25D0%25B5%25D1%2587%25D0%25BD%25D0%25BE%25D0%25B9_%25D0%25B8%25D0%25BC%25D0%25BF%25D1%2583%25D0%25BB%25D1%258C%25D1%2581%25D0%25BD%25D0%25BE%25D0%25B9_%25D1%2585%25D0%25B0%25D1%2580%25D0%25B0%25D0%25BA%25D1%2582%25D0%25B5%25D1%2580%25D0%25B8%25D1%2581%25D1%2582%25D0%25B8%25D0%25BA%25D0%25BE%25D0%25B9">    </a> ( <i>Infinite Impulse Response</i> ,  <i>IIR</i> ).  <a href="http://www.dspguide.com/ch14/1.htm"> </a> ,      .      ,         ,      . <br> <br>   <br>       ,     ,     .   ,  ,      ,  ,          .           ,  NI Massive,   ¬´ <a href="http://lurkmore.to/%25D0%25A2%25D1%2591%25D0%25BF%25D0%25BB%25D1%258B%25D0%25B9_%25D0%25BB%25D0%25B0%25D0%25BC%25D0%25BF%25D0%25BE%25D0%25B2%25D1%258B%25D0%25B9_%25D0%25B7%25D0%25B2%25D1%2583%25D0%25BA">  </a> ¬ª.       ,          ,   .        ,          (  Massive       ).      ¬´¬ª , , , AAS Ultra Analog,       ,     ,    ,        .         ,  ,    <a href="http://www.kvraudio.com/forum/viewtopic.php%3Ft%3D350246"></a> ,   ,      NI Reaktor. ,            ‚Äî    ,    ..     . <br> <br>   <br>     .   GUI.  <i>bg.png</i>   ( <i>‚ÄúMove to trash‚Äù</i>  Xcode),       : <br> <br> <a href="">filtermode.png</a> <a href="">knob_small.png</a> (  ,   50 50 ) <a href="">bg.png</a> (       ) <br> <br>    ID  <i>resource.h</i> : <br> <br> <code class="cpp">// Unique IDs for each image resource. #define BG_ID 101 #define WHITE_KEY_ID 102 #define BLACK_KEY_ID 103 #define WAVEFORM_ID 104 #define KNOB_ID 105 #define KNOB_SMALL_ID 106 #define FILTERMODE_ID 107 // Image resource locations for this plug. #define BG_FN "resources/img/bg.png" #define WHITE_KEY_FN "resources/img/whitekey.png" #define BLACK_KEY_FN "resources/img/blackkey.png" #define WAVEFORM_FN "resources/img/waveform.png" #define KNOB_FN "resources/img/knob.png" #define KNOB_SMALL_FN "resources/img/knob_small.png" #define FILTERMODE_FN "resources/img/filtermode.png"</code> <br> <br>  <i>Synthesis.rc</i> : <br> <br> <code class="cpp">#include "resource.h" BG_ID PNG BG_FN WHITE_KEY_ID PNG WHITE_KEY_FN BLACK_KEY_ID PNG BLACK_KEY_FN WAVEFORM_ID PNG WAVEFORM_FN KNOB_ID PNG KNOB_FN KNOB_SMALL_ID PNG KNOB_SMALL_FN FILTERMODE_ID PNG FILTERMODE_FN</code> <br> <br>   <code>#include "Filter.h"</code>  <i>Synthesis.h</i>    <code>private</code> : <br> <br> <code class="cpp">Filter mFilter;</code> <br> <br>  <code>EParams</code>  <i>Synthesis.cpp</i> : <br> <br> <code class="cpp">enum EParams { mWaveform = 0, mAttack, mDecay, mSustain, mRelease, mFilterMode, mFilterCutoff, mFilterResonance, mFilterAttack, mFilterDecay, mFilterSustain, mFilterRelease, mFilterEnvelopeAmount, kNumParams };</code> <br> <br>        : <br> <br> <code class="cpp">pGraphics-&gt;AttachControl(new ISwitchControl(this, 24, 38, mWaveform, &amp;waveformBitmap));</code> <br> <br>      .      (Lowpass, Highpass, Bandpass).    <code>AttachGraphics(pGraphics)</code> : <br> <br> <code class="cpp">GetParam(mFilterMode)-&gt;InitEnum("Filter Mode", Filter::FILTER_MODE_LOWPASS, Filter::kNumFilterModes); IBitmap filtermodeBitmap = pGraphics-&gt;LoadIBitmap(FILTERMODE_ID, FILTERMODE_FN, 3); pGraphics-&gt;AttachControl(new ISwitchControl(this, 24, 123, mFilterMode, &amp;filtermodeBitmap));</code> <br> <br>         .    .     <i>knob_small.png</i> : <br> <br> <code class="cpp">// Knobs for filter cutoff and resonance IBitmap smallKnobBitmap = pGraphics-&gt;LoadIBitmap(KNOB_SMALL_ID, KNOB_SMALL_FN, 64); // Cutoff knob: GetParam(mFilterCutoff)-&gt;InitDouble("Cutoff", 0.99, 0.01, 0.99, 0.001); GetParam(mFilterCutoff)-&gt;SetShape(2); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 5, 177, mFilterCutoff, &amp;smallKnobBitmap)); // Resonance knob: GetParam(mFilterResonance)-&gt;InitDouble("Resonance", 0.01, 0.01, 1.0, 0.001); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 61, 177, mFilterResonance, &amp;smallKnobBitmap));</code> <br> <br>   ,           <code>1.0</code> ,   <code>calculateFeedbackAmount</code>    , . <br>  <code>ProcessDoubleReplacing</code>     : <br> <br> <code class="cpp">leftOutput[i] = rightOutput[i] = mFilter.process(mOscillator.nextSample() * mEnvelopeGenerator.nextSample() * velocity / 127.0);</code> <br> <br>       .  <code>switch</code>   <code>Synthesis::OnParamChange</code> : <br> <br> <code class="cpp">case mFilterCutoff: mFilter.setCutoff(GetParam(paramIdx)-&gt;Value()); break; case mFilterResonance: mFilter.setResonance(GetParam(paramIdx)-&gt;Value()); break; case mFilterMode: mFilter.setFilterMode(static_cast&lt;Filter::FilterMode&gt;(GetParam(paramIdx)-&gt;Int())); break;</code> <br> <br>    .  -      . <br> <br>  <br> <br>  ‚Äî      .   ,   ,          . <br>      : <br> <br> <code class="cpp">buf0 += cutoff * (inputValue - buf0 + feedbackAmount * (buf0 - buf1));</code> <br> <br> ,   ,      ( <code>buf0 ‚Äì buf1</code> ),   <code>feedbackAmount</code> .    <code>calculateFeedbackAmount</code>  <code>feedbackAmount</code>  <code>resonance</code> , . .    ,   . <br> <br>  ,            .     ,  <i></i> ,      <a href="https://www.youtube.com/watch%3Fv%3DJWyMj6KxGHM"> </a> .    ,        ,       . <br> <br>  -12 /  -24 / <br>        !     24   .     <code>switch</code>  <code>Filter::process</code> : <br> <br> <code class="cpp">buf2 += cutoff * (buf1 - buf2); buf3 += cutoff * (buf2 ‚Äì buf3);</code> <br> <br>   :      ,       ,            .     ,       , , <a href="https://ccrma.stanford.edu/~Jos/filters/Filter_Stability.html"></a> (       ).     <code>switch</code> : <br> <br> <code class="cpp">switch (mode) { case FILTER_MODE_LOWPASS: return buf3; case FILTER_MODE_HIGHPASS: return inputValue - buf3; case FILTER_MODE_BANDPASS: return buf0 - buf3; default: return 0.0; }</code> <br> <br>   <code>buf1</code>  <code>buf3</code> ‚Äì      .    -24 /.     <code>buf2</code>  <code>buf3</code> ,        <code>private</code> <i>Filter.h</i> : <br> <br> <code class="cpp">double buf2; double buf3;</code> <br> <br>    ,   <code>buf0</code> c <code>buf1</code> : <br> <br> <code class="cpp">Filter() : // ... buf0(0.0), buf1(0.0), buf2(0.0), buf3(0.0) // ...</code> <br> <br>     , ,     :     .       . <br>          ? <br> <br>   <br>    .  ,           ,       . <br> -      <code>cutoff</code>   .      .    <code>cutoffMod</code> ,    ,       <code>cutoff</code>    .     <code>#include    private</code> : <br> <br> <code class="cpp">double cutoffMod;</code> <br> <br> : <br> <br> <code class="cpp">Filter() : cutoff(0.99), resonance(0.01), cutoffMod(0.0), // ...</code> <br> <br>         .   <code>private</code> : <br> <br> <code class="cpp">inline double getCalculatedCutoff() const { return fmax(fmin(cutoff + cutoffMod, 0.99), 0.01); };</code> <br> <br> <code>calculateFeedbackAmount</code>     : <br> <br> <code class="cpp">inline void calculateFeedbackAmount() { feedbackAmount = resonance + resonance/(1.0 - getCalculatedCutoff()); }</code> <br> <br>       <code>cutoffMod</code> .   <code>feedbackAmount</code>    ,     : <br> <br> <code class="cpp">inline void setCutoffMod(double newCutoffMod) { cutoffMod = newCutoffMod; calculateFeedbackAmount(); }</code> <br> <br> ,       .   <code>Filter::process</code>   : <br> <br> <code class="cpp">if (inputValue == 0.0) return inputValue; double calculatedCutoff = getCalculatedCutoff(); buf0 += calculatedCutoff * (inputValue - buf0 + feedbackAmount * (buf0 - buf1)); buf1 += calculatedCutoff * (buf0 - buf1); buf2 += calculatedCutoff * (buf1 - buf2); buf3 += calculatedCutoff * (buf2 ‚Äì buf3);</code> <br> <br>        ,    .    ,      ,   .     .     <code>cutoff</code>  <code>calculatedCutoff</code>   -. <br> <br> ,       ( <code>setCutoffMod</code> ),   <code>Synthesis</code>    ,     ,    .    ,        <code>cutoffMod</code> .    <code>filterEnvelopeAmount</code>    <code>-1</code>  <code>+1</code> .   GUI. <br> <br>   <code>private</code> <i>Synthesis.h</i>    : <br> <br> <code class="cpp">EnvelopeGenerator mFilterEnvelopeGenerator; double filterEnvelopeAmount;</code> <br> <br>       MIDI ,      <code>onNoteOn</code>  <code>onNoteOff</code> : <br> <br> <code class="cpp">inline void onNoteOn(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); mFilterEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); }; inline void onNoteOff(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); mFilterEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); };</code> <br> <br>    .   <code>ProcessDoubleReplacing</code>        : <br> <br> <code class="cpp">mFilter.setCutoffMod(mFilterEnvelopeGenerator.nextSample() * filterEnvelopeAmount);</code> <br> <br>  ,        <code>nextSample</code>  <code>filterEnvelopeAmount</code>     <code>cutoffMod</code> .     <code>filterEnvelopeAmount</code>  : <br> <br> <code class="cpp">Synthesis::Synthesis(IPlugInstanceInfo instanceInfo) : IPLUG_CTOR(kNumParams, kNumPrograms, instanceInfo), lastVirtualKeyboardNoteNumber(virtualKeyboardMinimumNoteNumber - 1), filterEnvelopeAmount(0.0) { // ... }</code> <br> <br>       <code>Synthesis::Reset</code> : <br> <br> <code class="cpp">mFilterEnvelopeGenerator.setSampleRate(GetSampleRate());</code> <br> <br>      <code>EParams</code> ,       .  <code>AttachGraphics</code>     : <br> <br> <code class="cpp">// Knobs for filter envelope // Attack knob GetParam(mFilterAttack)-&gt;InitDouble("Filter Env Attack", 0.01, 0.01, 10.0, 0.001); GetParam(mFilterAttack)-&gt;SetShape(3); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 139, 178, mFilterAttack, &amp;smallKnobBitmap)); // Decay knob: GetParam(mFilterDecay)-&gt;InitDouble("Filter Env Decay", 0.5, 0.01, 15.0, 0.001); GetParam(mFilterDecay)-&gt;SetShape(3); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 195, 178, mFilterDecay, &amp;smallKnobBitmap)); // Sustain knob: GetParam(mFilterSustain)-&gt;InitDouble("Filter Env Sustain", 0.1, 0.001, 1.0, 0.001); GetParam(mFilterSustain)-&gt;SetShape(2); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 251, 178, mFilterSustain, &amp;smallKnobBitmap)); // Release knob: GetParam(mFilterRelease)-&gt;InitDouble("Filter Env Release", 1.0, 0.001, 15.0, 0.001); GetParam(mFilterRelease)-&gt;SetShape(3); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 307, 178, mFilterRelease, &amp;smallKnobBitmap)); // Filter envelope amount knob: GetParam(mFilterEnvelopeAmount)-&gt;InitDouble("Filter Env Amount", 0.0, -1.0, 1.0, 0.001); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 363, 178, mFilterEnvelopeAmount, &amp;smallKnobBitmap));</code> <br> <br>     ,       <code>smallKnobBitmap</code> .                   .     ,    .  <code>Synthesis::OnParamChange</code>    <code>switch</code> : <br> <br> <code class="cpp">case mFilterAttack: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK, GetParam(paramIdx)-&gt;Value()); break; case mFilterDecay: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_DECAY, GetParam(paramIdx)-&gt;Value()); break; case mFilterSustain: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_SUSTAIN, GetParam(paramIdx)-&gt;Value()); break; case mFilterRelease: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE, GetParam(paramIdx)-&gt;Value()); break; case mFilterEnvelopeAmount: filterEnvelopeAmount = GetParam(paramIdx)-&gt;Value(); break;</code> <br> <br> ! <br>     !           (-   C1),   : <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/f5d/757/3f9/f5d7573f9b3a720fe5898d88ae477cfc.png"> <br> <br>        <code>EnvelopeGenerator</code>  .         .        ! <br> <br>    <a href=""></a> . <br> <br>        :) <br> <br>  : <br> <a href="http://martin-finke.de/blog/articles/audio-plugins-013-filter/">martin-finke.de/blog/articles/audio-plugins-013-filter</a></code></code> <h3> <code><code><code class="cpp">#include  <i>Filter.h</i> ( )     : <br> <br> class Filter { public: enum FilterMode { FILTER_MODE_LOWPASS = 0, FILTER_MODE_HIGHPASS, FILTER_MODE_BANDPASS, kNumFilterModes }; Filter() : cutoff(0.99), resonance(0.0), mode(FILTER_MODE_LOWPASS), buf0(0.0), buf1(0.0) { calculateFeedbackAmount(); }; double process(double inputValue); inline void setCutoff(double newCutoff) { cutoff = newCutoff; calculateFeedbackAmount(); }; inline void setResonance(double newResonance) { resonance = newResonance; calculateFeedbackAmount(); }; inline void setFilterMode(FilterMode newMode) { mode = newMode; } private: double cutoff; double resonance; FilterMode mode; double feedbackAmount; inline void calculateFeedbackAmount() { feedbackAmount = resonance + resonance/(1.0 - cutoff); } double buf0; double buf1; };</code> <br> <br>  <code>private</code>     <i> </i> <code>cutoff</code>  <i></i> <code>resonance</code> . <code>Mode</code>      (Lowpass, Highpass, Bandpass).  <code>feedbackAmount</code> , <code>buf0</code>  <code>buf1</code>    ,    . <br>          ( <code>calculateFeedbackAmount()</code> ).  <code>process</code>      .   <code>feedbackAmount</code>   <code>cutoff</code>  <code>resonance</code> ,    <code>calculateFeedbackAmount</code>      . <br> <br>   <i>Filter.cpp</i>  : <br> <br> <code class="cpp">// By Paul Kellett // http://www.musicdsp.org/showone.php?id=29 double Filter::process(double inputValue) { buf0 += cutoff * (inputValue - buf0); buf1 += cutoff * (buf0 - buf1); switch (mode) { case FILTER_MODE_LOWPASS: return buf1; case FILTER_MODE_HIGHPASS: return inputValue - buf0; case FILTER_MODE_BANDPASS: return buf0 - buf1; default: return 0.0; } }</code> <br> <br> , ?  ,         <i> </i> . ¬´ ¬ª   ,               (. .    6 ).     <code>buf0</code>  <code>buf1</code> :        .     <code>inputValue</code> ,  - <code>buf0</code> (  ).   .    6 /   12 /.  <code>switch</code> ,  <code>buf1</code>    . , ,    <code>buf0</code> ,       12,   6 /,        . <br> <br>  <code>case</code> <code>FILTER_MODE_HIGHPASS</code>    . <code>buf0</code>       .   <code>inputValue</code>  <code>buf0</code> ,   .    <code>buf1</code> ,     . <br> <br>  <code>case</code> <code>FILTER_MODE_BANDPASS</code> ,  <code>buf0 - buf1</code>   .  <code>buf0</code>       ,     <code>buf1</code> . ,   . <br>  :    <i> </i>    <i> </i> ,   . <br> <br>  <code>buf1</code>     .       <a href="http://ru.wikipedia.org/wiki/%25D0%25A4%25D0%25B8%25D0%25BB%25D1%258C%25D1%2582%25D1%2580_%25D1%2581_%25D0%25B1%25D0%25B5%25D1%2581%25D0%25BA%25D0%25BE%25D0%25BD%25D0%25B5%25D1%2587%25D0%25BD%25D0%25BE%25D0%25B9_%25D0%25B8%25D0%25BC%25D0%25BF%25D1%2583%25D0%25BB%25D1%258C%25D1%2581%25D0%25BD%25D0%25BE%25D0%25B9_%25D1%2585%25D0%25B0%25D1%2580%25D0%25B0%25D0%25BA%25D1%2582%25D0%25B5%25D1%2580%25D0%25B8%25D1%2581%25D1%2582%25D0%25B8%25D0%25BA%25D0%25BE%25D0%25B9">    </a> ( <i>Infinite Impulse Response</i> ,  <i>IIR</i> ).  <a href="http://www.dspguide.com/ch14/1.htm"> </a> ,      .      ,         ,      . <br> <br>   <br>       ,     ,     .   ,  ,      ,  ,          .           ,  NI Massive,   ¬´ <a href="http://lurkmore.to/%25D0%25A2%25D1%2591%25D0%25BF%25D0%25BB%25D1%258B%25D0%25B9_%25D0%25BB%25D0%25B0%25D0%25BC%25D0%25BF%25D0%25BE%25D0%25B2%25D1%258B%25D0%25B9_%25D0%25B7%25D0%25B2%25D1%2583%25D0%25BA">  </a> ¬ª.       ,          ,   .        ,          (  Massive       ).      ¬´¬ª , , , AAS Ultra Analog,       ,     ,    ,        .         ,  ,    <a href="http://www.kvraudio.com/forum/viewtopic.php%3Ft%3D350246"></a> ,   ,      NI Reaktor. ,            ‚Äî    ,    ..     . <br> <br>   <br>     .   GUI.  <i>bg.png</i>   ( <i>‚ÄúMove to trash‚Äù</i>  Xcode),       : <br> <br> <a href="">filtermode.png</a> <a href="">knob_small.png</a> (  ,   50 50 ) <a href="">bg.png</a> (       ) <br> <br>    ID  <i>resource.h</i> : <br> <br> <code class="cpp">// Unique IDs for each image resource. #define BG_ID 101 #define WHITE_KEY_ID 102 #define BLACK_KEY_ID 103 #define WAVEFORM_ID 104 #define KNOB_ID 105 #define KNOB_SMALL_ID 106 #define FILTERMODE_ID 107 // Image resource locations for this plug. #define BG_FN "resources/img/bg.png" #define WHITE_KEY_FN "resources/img/whitekey.png" #define BLACK_KEY_FN "resources/img/blackkey.png" #define WAVEFORM_FN "resources/img/waveform.png" #define KNOB_FN "resources/img/knob.png" #define KNOB_SMALL_FN "resources/img/knob_small.png" #define FILTERMODE_FN "resources/img/filtermode.png"</code> <br> <br>  <i>Synthesis.rc</i> : <br> <br> <code class="cpp">#include "resource.h" BG_ID PNG BG_FN WHITE_KEY_ID PNG WHITE_KEY_FN BLACK_KEY_ID PNG BLACK_KEY_FN WAVEFORM_ID PNG WAVEFORM_FN KNOB_ID PNG KNOB_FN KNOB_SMALL_ID PNG KNOB_SMALL_FN FILTERMODE_ID PNG FILTERMODE_FN</code> <br> <br>   <code>#include "Filter.h"</code>  <i>Synthesis.h</i>    <code>private</code> : <br> <br> <code class="cpp">Filter mFilter;</code> <br> <br>  <code>EParams</code>  <i>Synthesis.cpp</i> : <br> <br> <code class="cpp">enum EParams { mWaveform = 0, mAttack, mDecay, mSustain, mRelease, mFilterMode, mFilterCutoff, mFilterResonance, mFilterAttack, mFilterDecay, mFilterSustain, mFilterRelease, mFilterEnvelopeAmount, kNumParams };</code> <br> <br>        : <br> <br> <code class="cpp">pGraphics-&gt;AttachControl(new ISwitchControl(this, 24, 38, mWaveform, &amp;waveformBitmap));</code> <br> <br>      .      (Lowpass, Highpass, Bandpass).    <code>AttachGraphics(pGraphics)</code> : <br> <br> <code class="cpp">GetParam(mFilterMode)-&gt;InitEnum("Filter Mode", Filter::FILTER_MODE_LOWPASS, Filter::kNumFilterModes); IBitmap filtermodeBitmap = pGraphics-&gt;LoadIBitmap(FILTERMODE_ID, FILTERMODE_FN, 3); pGraphics-&gt;AttachControl(new ISwitchControl(this, 24, 123, mFilterMode, &amp;filtermodeBitmap));</code> <br> <br>         .    .     <i>knob_small.png</i> : <br> <br> <code class="cpp">// Knobs for filter cutoff and resonance IBitmap smallKnobBitmap = pGraphics-&gt;LoadIBitmap(KNOB_SMALL_ID, KNOB_SMALL_FN, 64); // Cutoff knob: GetParam(mFilterCutoff)-&gt;InitDouble("Cutoff", 0.99, 0.01, 0.99, 0.001); GetParam(mFilterCutoff)-&gt;SetShape(2); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 5, 177, mFilterCutoff, &amp;smallKnobBitmap)); // Resonance knob: GetParam(mFilterResonance)-&gt;InitDouble("Resonance", 0.01, 0.01, 1.0, 0.001); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 61, 177, mFilterResonance, &amp;smallKnobBitmap));</code> <br> <br>   ,           <code>1.0</code> ,   <code>calculateFeedbackAmount</code>    , . <br>  <code>ProcessDoubleReplacing</code>     : <br> <br> <code class="cpp">leftOutput[i] = rightOutput[i] = mFilter.process(mOscillator.nextSample() * mEnvelopeGenerator.nextSample() * velocity / 127.0);</code> <br> <br>       .  <code>switch</code>   <code>Synthesis::OnParamChange</code> : <br> <br> <code class="cpp">case mFilterCutoff: mFilter.setCutoff(GetParam(paramIdx)-&gt;Value()); break; case mFilterResonance: mFilter.setResonance(GetParam(paramIdx)-&gt;Value()); break; case mFilterMode: mFilter.setFilterMode(static_cast&lt;Filter::FilterMode&gt;(GetParam(paramIdx)-&gt;Int())); break;</code> <br> <br>    .  -      . <br> <br>  <br> <br>  ‚Äî      .   ,   ,          . <br>      : <br> <br> <code class="cpp">buf0 += cutoff * (inputValue - buf0 + feedbackAmount * (buf0 - buf1));</code> <br> <br> ,   ,      ( <code>buf0 ‚Äì buf1</code> ),   <code>feedbackAmount</code> .    <code>calculateFeedbackAmount</code>  <code>feedbackAmount</code>  <code>resonance</code> , . .    ,   . <br> <br>  ,            .     ,  <i></i> ,      <a href="https://www.youtube.com/watch%3Fv%3DJWyMj6KxGHM"> </a> .    ,        ,       . <br> <br>  -12 /  -24 / <br>        !     24   .     <code>switch</code>  <code>Filter::process</code> : <br> <br> <code class="cpp">buf2 += cutoff * (buf1 - buf2); buf3 += cutoff * (buf2 ‚Äì buf3);</code> <br> <br>   :      ,       ,            .     ,       , , <a href="https://ccrma.stanford.edu/~Jos/filters/Filter_Stability.html"></a> (       ).     <code>switch</code> : <br> <br> <code class="cpp">switch (mode) { case FILTER_MODE_LOWPASS: return buf3; case FILTER_MODE_HIGHPASS: return inputValue - buf3; case FILTER_MODE_BANDPASS: return buf0 - buf3; default: return 0.0; }</code> <br> <br>   <code>buf1</code>  <code>buf3</code> ‚Äì      .    -24 /.     <code>buf2</code>  <code>buf3</code> ,        <code>private</code> <i>Filter.h</i> : <br> <br> <code class="cpp">double buf2; double buf3;</code> <br> <br>    ,   <code>buf0</code> c <code>buf1</code> : <br> <br> <code class="cpp">Filter() : // ... buf0(0.0), buf1(0.0), buf2(0.0), buf3(0.0) // ...</code> <br> <br>     , ,     :     .       . <br>          ? <br> <br>   <br>    .  ,           ,       . <br> -      <code>cutoff</code>   .      .    <code>cutoffMod</code> ,    ,       <code>cutoff</code>    .     <code>#include    private</code> : <br> <br> <code class="cpp">double cutoffMod;</code> <br> <br> : <br> <br> <code class="cpp">Filter() : cutoff(0.99), resonance(0.01), cutoffMod(0.0), // ...</code> <br> <br>         .   <code>private</code> : <br> <br> <code class="cpp">inline double getCalculatedCutoff() const { return fmax(fmin(cutoff + cutoffMod, 0.99), 0.01); };</code> <br> <br> <code>calculateFeedbackAmount</code>     : <br> <br> <code class="cpp">inline void calculateFeedbackAmount() { feedbackAmount = resonance + resonance/(1.0 - getCalculatedCutoff()); }</code> <br> <br>       <code>cutoffMod</code> .   <code>feedbackAmount</code>    ,     : <br> <br> <code class="cpp">inline void setCutoffMod(double newCutoffMod) { cutoffMod = newCutoffMod; calculateFeedbackAmount(); }</code> <br> <br> ,       .   <code>Filter::process</code>   : <br> <br> <code class="cpp">if (inputValue == 0.0) return inputValue; double calculatedCutoff = getCalculatedCutoff(); buf0 += calculatedCutoff * (inputValue - buf0 + feedbackAmount * (buf0 - buf1)); buf1 += calculatedCutoff * (buf0 - buf1); buf2 += calculatedCutoff * (buf1 - buf2); buf3 += calculatedCutoff * (buf2 ‚Äì buf3);</code> <br> <br>        ,    .    ,      ,   .     .     <code>cutoff</code>  <code>calculatedCutoff</code>   -. <br> <br> ,       ( <code>setCutoffMod</code> ),   <code>Synthesis</code>    ,     ,    .    ,        <code>cutoffMod</code> .    <code>filterEnvelopeAmount</code>    <code>-1</code>  <code>+1</code> .   GUI. <br> <br>   <code>private</code> <i>Synthesis.h</i>    : <br> <br> <code class="cpp">EnvelopeGenerator mFilterEnvelopeGenerator; double filterEnvelopeAmount;</code> <br> <br>       MIDI ,      <code>onNoteOn</code>  <code>onNoteOff</code> : <br> <br> <code class="cpp">inline void onNoteOn(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); mFilterEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); }; inline void onNoteOff(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); mFilterEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); };</code> <br> <br>    .   <code>ProcessDoubleReplacing</code>        : <br> <br> <code class="cpp">mFilter.setCutoffMod(mFilterEnvelopeGenerator.nextSample() * filterEnvelopeAmount);</code> <br> <br>  ,        <code>nextSample</code>  <code>filterEnvelopeAmount</code>     <code>cutoffMod</code> .     <code>filterEnvelopeAmount</code>  : <br> <br> <code class="cpp">Synthesis::Synthesis(IPlugInstanceInfo instanceInfo) : IPLUG_CTOR(kNumParams, kNumPrograms, instanceInfo), lastVirtualKeyboardNoteNumber(virtualKeyboardMinimumNoteNumber - 1), filterEnvelopeAmount(0.0) { // ... }</code> <br> <br>       <code>Synthesis::Reset</code> : <br> <br> <code class="cpp">mFilterEnvelopeGenerator.setSampleRate(GetSampleRate());</code> <br> <br>      <code>EParams</code> ,       .  <code>AttachGraphics</code>     : <br> <br> <code class="cpp">// Knobs for filter envelope // Attack knob GetParam(mFilterAttack)-&gt;InitDouble("Filter Env Attack", 0.01, 0.01, 10.0, 0.001); GetParam(mFilterAttack)-&gt;SetShape(3); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 139, 178, mFilterAttack, &amp;smallKnobBitmap)); // Decay knob: GetParam(mFilterDecay)-&gt;InitDouble("Filter Env Decay", 0.5, 0.01, 15.0, 0.001); GetParam(mFilterDecay)-&gt;SetShape(3); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 195, 178, mFilterDecay, &amp;smallKnobBitmap)); // Sustain knob: GetParam(mFilterSustain)-&gt;InitDouble("Filter Env Sustain", 0.1, 0.001, 1.0, 0.001); GetParam(mFilterSustain)-&gt;SetShape(2); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 251, 178, mFilterSustain, &amp;smallKnobBitmap)); // Release knob: GetParam(mFilterRelease)-&gt;InitDouble("Filter Env Release", 1.0, 0.001, 15.0, 0.001); GetParam(mFilterRelease)-&gt;SetShape(3); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 307, 178, mFilterRelease, &amp;smallKnobBitmap)); // Filter envelope amount knob: GetParam(mFilterEnvelopeAmount)-&gt;InitDouble("Filter Env Amount", 0.0, -1.0, 1.0, 0.001); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 363, 178, mFilterEnvelopeAmount, &amp;smallKnobBitmap));</code> <br> <br>     ,       <code>smallKnobBitmap</code> .                   .     ,    .  <code>Synthesis::OnParamChange</code>    <code>switch</code> : <br> <br> <code class="cpp">case mFilterAttack: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK, GetParam(paramIdx)-&gt;Value()); break; case mFilterDecay: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_DECAY, GetParam(paramIdx)-&gt;Value()); break; case mFilterSustain: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_SUSTAIN, GetParam(paramIdx)-&gt;Value()); break; case mFilterRelease: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE, GetParam(paramIdx)-&gt;Value()); break; case mFilterEnvelopeAmount: filterEnvelopeAmount = GetParam(paramIdx)-&gt;Value(); break;</code> <br> <br> ! <br>     !           (-   C1),   : <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/f5d/757/3f9/f5d7573f9b3a720fe5898d88ae477cfc.png"> <br> <br>        <code>EnvelopeGenerator</code>  .         .        ! <br> <br>    <a href=""></a> . <br> <br>        :) <br> <br>  : <br> <a href="http://martin-finke.de/blog/articles/audio-plugins-013-filter/">martin-finke.de/blog/articles/audio-plugins-013-filter</a></code></code> </h3> <code><code><code class="cpp">#include  <i>Filter.h</i> ( )     : <br> <br> class Filter { public: enum FilterMode { FILTER_MODE_LOWPASS = 0, FILTER_MODE_HIGHPASS, FILTER_MODE_BANDPASS, kNumFilterModes }; Filter() : cutoff(0.99), resonance(0.0), mode(FILTER_MODE_LOWPASS), buf0(0.0), buf1(0.0) { calculateFeedbackAmount(); }; double process(double inputValue); inline void setCutoff(double newCutoff) { cutoff = newCutoff; calculateFeedbackAmount(); }; inline void setResonance(double newResonance) { resonance = newResonance; calculateFeedbackAmount(); }; inline void setFilterMode(FilterMode newMode) { mode = newMode; } private: double cutoff; double resonance; FilterMode mode; double feedbackAmount; inline void calculateFeedbackAmount() { feedbackAmount = resonance + resonance/(1.0 - cutoff); } double buf0; double buf1; };</code> <br> <br>  <code>private</code>     <i> </i> <code>cutoff</code>  <i></i> <code>resonance</code> . <code>Mode</code>      (Lowpass, Highpass, Bandpass).  <code>feedbackAmount</code> , <code>buf0</code>  <code>buf1</code>    ,    . <br>          ( <code>calculateFeedbackAmount()</code> ).  <code>process</code>      .   <code>feedbackAmount</code>   <code>cutoff</code>  <code>resonance</code> ,    <code>calculateFeedbackAmount</code>      . <br> <br>   <i>Filter.cpp</i>  : <br> <br> <code class="cpp">// By Paul Kellett // http://www.musicdsp.org/showone.php?id=29 double Filter::process(double inputValue) { buf0 += cutoff * (inputValue - buf0); buf1 += cutoff * (buf0 - buf1); switch (mode) { case FILTER_MODE_LOWPASS: return buf1; case FILTER_MODE_HIGHPASS: return inputValue - buf0; case FILTER_MODE_BANDPASS: return buf0 - buf1; default: return 0.0; } }</code> <br> <br> , ?  ,         <i> </i> . ¬´ ¬ª   ,               (. .    6 ).     <code>buf0</code>  <code>buf1</code> :        .     <code>inputValue</code> ,  - <code>buf0</code> (  ).   .    6 /   12 /.  <code>switch</code> ,  <code>buf1</code>    . , ,    <code>buf0</code> ,       12,   6 /,        . <br> <br>  <code>case</code> <code>FILTER_MODE_HIGHPASS</code>    . <code>buf0</code>       .   <code>inputValue</code>  <code>buf0</code> ,   .    <code>buf1</code> ,     . <br> <br>  <code>case</code> <code>FILTER_MODE_BANDPASS</code> ,  <code>buf0 - buf1</code>   .  <code>buf0</code>       ,     <code>buf1</code> . ,   . <br>  :    <i> </i>    <i> </i> ,   . <br> <br>  <code>buf1</code>     .       <a href="http://ru.wikipedia.org/wiki/%25D0%25A4%25D0%25B8%25D0%25BB%25D1%258C%25D1%2582%25D1%2580_%25D1%2581_%25D0%25B1%25D0%25B5%25D1%2581%25D0%25BA%25D0%25BE%25D0%25BD%25D0%25B5%25D1%2587%25D0%25BD%25D0%25BE%25D0%25B9_%25D0%25B8%25D0%25BC%25D0%25BF%25D1%2583%25D0%25BB%25D1%258C%25D1%2581%25D0%25BD%25D0%25BE%25D0%25B9_%25D1%2585%25D0%25B0%25D1%2580%25D0%25B0%25D0%25BA%25D1%2582%25D0%25B5%25D1%2580%25D0%25B8%25D1%2581%25D1%2582%25D0%25B8%25D0%25BA%25D0%25BE%25D0%25B9">    </a> ( <i>Infinite Impulse Response</i> ,  <i>IIR</i> ).  <a href="http://www.dspguide.com/ch14/1.htm"> </a> ,      .      ,         ,      . <br> <br>   <br>       ,     ,     .   ,  ,      ,  ,          .           ,  NI Massive,   ¬´ <a href="http://lurkmore.to/%25D0%25A2%25D1%2591%25D0%25BF%25D0%25BB%25D1%258B%25D0%25B9_%25D0%25BB%25D0%25B0%25D0%25BC%25D0%25BF%25D0%25BE%25D0%25B2%25D1%258B%25D0%25B9_%25D0%25B7%25D0%25B2%25D1%2583%25D0%25BA">  </a> ¬ª.       ,          ,   .        ,          (  Massive       ).      ¬´¬ª , , , AAS Ultra Analog,       ,     ,    ,        .         ,  ,    <a href="http://www.kvraudio.com/forum/viewtopic.php%3Ft%3D350246"></a> ,   ,      NI Reaktor. ,            ‚Äî    ,    ..     . <br> <br>   <br>     .   GUI.  <i>bg.png</i>   ( <i>‚ÄúMove to trash‚Äù</i>  Xcode),       : <br> <br> <a href="">filtermode.png</a> <a href="">knob_small.png</a> (  ,   50 50 ) <a href="">bg.png</a> (       ) <br> <br>    ID  <i>resource.h</i> : <br> <br> <code class="cpp">// Unique IDs for each image resource. #define BG_ID 101 #define WHITE_KEY_ID 102 #define BLACK_KEY_ID 103 #define WAVEFORM_ID 104 #define KNOB_ID 105 #define KNOB_SMALL_ID 106 #define FILTERMODE_ID 107 // Image resource locations for this plug. #define BG_FN "resources/img/bg.png" #define WHITE_KEY_FN "resources/img/whitekey.png" #define BLACK_KEY_FN "resources/img/blackkey.png" #define WAVEFORM_FN "resources/img/waveform.png" #define KNOB_FN "resources/img/knob.png" #define KNOB_SMALL_FN "resources/img/knob_small.png" #define FILTERMODE_FN "resources/img/filtermode.png"</code> <br> <br>  <i>Synthesis.rc</i> : <br> <br> <code class="cpp">#include "resource.h" BG_ID PNG BG_FN WHITE_KEY_ID PNG WHITE_KEY_FN BLACK_KEY_ID PNG BLACK_KEY_FN WAVEFORM_ID PNG WAVEFORM_FN KNOB_ID PNG KNOB_FN KNOB_SMALL_ID PNG KNOB_SMALL_FN FILTERMODE_ID PNG FILTERMODE_FN</code> <br> <br>   <code>#include "Filter.h"</code>  <i>Synthesis.h</i>    <code>private</code> : <br> <br> <code class="cpp">Filter mFilter;</code> <br> <br>  <code>EParams</code>  <i>Synthesis.cpp</i> : <br> <br> <code class="cpp">enum EParams { mWaveform = 0, mAttack, mDecay, mSustain, mRelease, mFilterMode, mFilterCutoff, mFilterResonance, mFilterAttack, mFilterDecay, mFilterSustain, mFilterRelease, mFilterEnvelopeAmount, kNumParams };</code> <br> <br>        : <br> <br> <code class="cpp">pGraphics-&gt;AttachControl(new ISwitchControl(this, 24, 38, mWaveform, &amp;waveformBitmap));</code> <br> <br>      .      (Lowpass, Highpass, Bandpass).    <code>AttachGraphics(pGraphics)</code> : <br> <br> <code class="cpp">GetParam(mFilterMode)-&gt;InitEnum("Filter Mode", Filter::FILTER_MODE_LOWPASS, Filter::kNumFilterModes); IBitmap filtermodeBitmap = pGraphics-&gt;LoadIBitmap(FILTERMODE_ID, FILTERMODE_FN, 3); pGraphics-&gt;AttachControl(new ISwitchControl(this, 24, 123, mFilterMode, &amp;filtermodeBitmap));</code> <br> <br>         .    .     <i>knob_small.png</i> : <br> <br> <code class="cpp">// Knobs for filter cutoff and resonance IBitmap smallKnobBitmap = pGraphics-&gt;LoadIBitmap(KNOB_SMALL_ID, KNOB_SMALL_FN, 64); // Cutoff knob: GetParam(mFilterCutoff)-&gt;InitDouble("Cutoff", 0.99, 0.01, 0.99, 0.001); GetParam(mFilterCutoff)-&gt;SetShape(2); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 5, 177, mFilterCutoff, &amp;smallKnobBitmap)); // Resonance knob: GetParam(mFilterResonance)-&gt;InitDouble("Resonance", 0.01, 0.01, 1.0, 0.001); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 61, 177, mFilterResonance, &amp;smallKnobBitmap));</code> <br> <br>   ,           <code>1.0</code> ,   <code>calculateFeedbackAmount</code>    , . <br>  <code>ProcessDoubleReplacing</code>     : <br> <br> <code class="cpp">leftOutput[i] = rightOutput[i] = mFilter.process(mOscillator.nextSample() * mEnvelopeGenerator.nextSample() * velocity / 127.0);</code> <br> <br>       .  <code>switch</code>   <code>Synthesis::OnParamChange</code> : <br> <br> <code class="cpp">case mFilterCutoff: mFilter.setCutoff(GetParam(paramIdx)-&gt;Value()); break; case mFilterResonance: mFilter.setResonance(GetParam(paramIdx)-&gt;Value()); break; case mFilterMode: mFilter.setFilterMode(static_cast&lt;Filter::FilterMode&gt;(GetParam(paramIdx)-&gt;Int())); break;</code> <br> <br>    .  -      . <br> <br>  <br> <br>  ‚Äî      .   ,   ,          . <br>      : <br> <br> <code class="cpp">buf0 += cutoff * (inputValue - buf0 + feedbackAmount * (buf0 - buf1));</code> <br> <br> ,   ,      ( <code>buf0 ‚Äì buf1</code> ),   <code>feedbackAmount</code> .    <code>calculateFeedbackAmount</code>  <code>feedbackAmount</code>  <code>resonance</code> , . .    ,   . <br> <br>  ,            .     ,  <i></i> ,      <a href="https://www.youtube.com/watch%3Fv%3DJWyMj6KxGHM"> </a> .    ,        ,       . <br> <br>  -12 /  -24 / <br>        !     24   .     <code>switch</code>  <code>Filter::process</code> : <br> <br> <code class="cpp">buf2 += cutoff * (buf1 - buf2); buf3 += cutoff * (buf2 ‚Äì buf3);</code> <br> <br>   :      ,       ,            .     ,       , , <a href="https://ccrma.stanford.edu/~Jos/filters/Filter_Stability.html"></a> (       ).     <code>switch</code> : <br> <br> <code class="cpp">switch (mode) { case FILTER_MODE_LOWPASS: return buf3; case FILTER_MODE_HIGHPASS: return inputValue - buf3; case FILTER_MODE_BANDPASS: return buf0 - buf3; default: return 0.0; }</code> <br> <br>   <code>buf1</code>  <code>buf3</code> ‚Äì      .    -24 /.     <code>buf2</code>  <code>buf3</code> ,        <code>private</code> <i>Filter.h</i> : <br> <br> <code class="cpp">double buf2; double buf3;</code> <br> <br>    ,   <code>buf0</code> c <code>buf1</code> : <br> <br> <code class="cpp">Filter() : // ... buf0(0.0), buf1(0.0), buf2(0.0), buf3(0.0) // ...</code> <br> <br>     , ,     :     .       . <br>          ? <br> <br>   <br>    .  ,           ,       . <br> -      <code>cutoff</code>   .      .    <code>cutoffMod</code> ,    ,       <code>cutoff</code>    .     <code>#include    private</code> : <br> <br> <code class="cpp">double cutoffMod;</code> <br> <br> : <br> <br> <code class="cpp">Filter() : cutoff(0.99), resonance(0.01), cutoffMod(0.0), // ...</code> <br> <br>         .   <code>private</code> : <br> <br> <code class="cpp">inline double getCalculatedCutoff() const { return fmax(fmin(cutoff + cutoffMod, 0.99), 0.01); };</code> <br> <br> <code>calculateFeedbackAmount</code>     : <br> <br> <code class="cpp">inline void calculateFeedbackAmount() { feedbackAmount = resonance + resonance/(1.0 - getCalculatedCutoff()); }</code> <br> <br>       <code>cutoffMod</code> .   <code>feedbackAmount</code>    ,     : <br> <br> <code class="cpp">inline void setCutoffMod(double newCutoffMod) { cutoffMod = newCutoffMod; calculateFeedbackAmount(); }</code> <br> <br> ,       .   <code>Filter::process</code>   : <br> <br> <code class="cpp">if (inputValue == 0.0) return inputValue; double calculatedCutoff = getCalculatedCutoff(); buf0 += calculatedCutoff * (inputValue - buf0 + feedbackAmount * (buf0 - buf1)); buf1 += calculatedCutoff * (buf0 - buf1); buf2 += calculatedCutoff * (buf1 - buf2); buf3 += calculatedCutoff * (buf2 ‚Äì buf3);</code> <br> <br>        ,    .    ,      ,   .     .     <code>cutoff</code>  <code>calculatedCutoff</code>   -. <br> <br> ,       ( <code>setCutoffMod</code> ),   <code>Synthesis</code>    ,     ,    .    ,        <code>cutoffMod</code> .    <code>filterEnvelopeAmount</code>    <code>-1</code>  <code>+1</code> .   GUI. <br> <br>   <code>private</code> <i>Synthesis.h</i>    : <br> <br> <code class="cpp">EnvelopeGenerator mFilterEnvelopeGenerator; double filterEnvelopeAmount;</code> <br> <br>       MIDI ,      <code>onNoteOn</code>  <code>onNoteOff</code> : <br> <br> <code class="cpp">inline void onNoteOn(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); mFilterEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); }; inline void onNoteOff(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); mFilterEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); };</code> <br> <br>    .   <code>ProcessDoubleReplacing</code>        : <br> <br> <code class="cpp">mFilter.setCutoffMod(mFilterEnvelopeGenerator.nextSample() * filterEnvelopeAmount);</code> <br> <br>  ,        <code>nextSample</code>  <code>filterEnvelopeAmount</code>     <code>cutoffMod</code> .     <code>filterEnvelopeAmount</code>  : <br> <br> <code class="cpp">Synthesis::Synthesis(IPlugInstanceInfo instanceInfo) : IPLUG_CTOR(kNumParams, kNumPrograms, instanceInfo), lastVirtualKeyboardNoteNumber(virtualKeyboardMinimumNoteNumber - 1), filterEnvelopeAmount(0.0) { // ... }</code> <br> <br>       <code>Synthesis::Reset</code> : <br> <br> <code class="cpp">mFilterEnvelopeGenerator.setSampleRate(GetSampleRate());</code> <br> <br>      <code>EParams</code> ,       .  <code>AttachGraphics</code>     : <br> <br> <code class="cpp">// Knobs for filter envelope // Attack knob GetParam(mFilterAttack)-&gt;InitDouble("Filter Env Attack", 0.01, 0.01, 10.0, 0.001); GetParam(mFilterAttack)-&gt;SetShape(3); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 139, 178, mFilterAttack, &amp;smallKnobBitmap)); // Decay knob: GetParam(mFilterDecay)-&gt;InitDouble("Filter Env Decay", 0.5, 0.01, 15.0, 0.001); GetParam(mFilterDecay)-&gt;SetShape(3); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 195, 178, mFilterDecay, &amp;smallKnobBitmap)); // Sustain knob: GetParam(mFilterSustain)-&gt;InitDouble("Filter Env Sustain", 0.1, 0.001, 1.0, 0.001); GetParam(mFilterSustain)-&gt;SetShape(2); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 251, 178, mFilterSustain, &amp;smallKnobBitmap)); // Release knob: GetParam(mFilterRelease)-&gt;InitDouble("Filter Env Release", 1.0, 0.001, 15.0, 0.001); GetParam(mFilterRelease)-&gt;SetShape(3); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 307, 178, mFilterRelease, &amp;smallKnobBitmap)); // Filter envelope amount knob: GetParam(mFilterEnvelopeAmount)-&gt;InitDouble("Filter Env Amount", 0.0, -1.0, 1.0, 0.001); pGraphics-&gt;AttachControl(new IKnobMultiControl(this, 363, 178, mFilterEnvelopeAmount, &amp;smallKnobBitmap));</code> <br> <br>     ,       <code>smallKnobBitmap</code> .                   .     ,    .  <code>Synthesis::OnParamChange</code>    <code>switch</code> : <br> <br> <code class="cpp">case mFilterAttack: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK, GetParam(paramIdx)-&gt;Value()); break; case mFilterDecay: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_DECAY, GetParam(paramIdx)-&gt;Value()); break; case mFilterSustain: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_SUSTAIN, GetParam(paramIdx)-&gt;Value()); break; case mFilterRelease: mFilterEnvelopeGenerator.setStageValue(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE, GetParam(paramIdx)-&gt;Value()); break; case mFilterEnvelopeAmount: filterEnvelopeAmount = GetParam(paramIdx)-&gt;Value(); break;</code> <br> <br> ! <br>     !           (-   C1),   : <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/f5d/757/3f9/f5d7573f9b3a720fe5898d88ae477cfc.png"> <br> <br>        <code>EnvelopeGenerator</code>  .         .        ! <br> <br>    <a href=""></a> . <br> <br>        :) <br> <br>  : <br> <a href="http://martin-finke.de/blog/articles/audio-plugins-013-filter/">martin-finke.de/blog/articles/audio-plugins-013-filter</a></code></code> </div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/227791/">https://habr.com/ru/post/227791/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../227781/index.html">How to make framework-independent controllers?</a></li>
<li><a href="../227783/index.html">Starting a nuclear reactor looks cooler than you think.</a></li>
<li><a href="../227785/index.html">Level 80 Watchmaker</a></li>
<li><a href="../227787/index.html">Get rid of annotations in your controllers!</a></li>
<li><a href="../227789/index.html">A quick look at the new tablets from Samsung</a></li>
<li><a href="../227793/index.html">The most efficient, responsible and sociable</a></li>
<li><a href="../227797/index.html">What do we know about transformers?</a></li>
<li><a href="../227799/index.html">Methods of Protecting Important Text</a></li>
<li><a href="../227801/index.html">Activit√©: a fitness tracker that does not look like all other trackers</a></li>
<li><a href="../227803/index.html">Auto-build boot images of KolibriOS in Linux on a single machine</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>