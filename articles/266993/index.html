<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Cleaning Dropbox backup storage by cron</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I had a chance to configure Akeeba Backup Pro for remote backup storage in Dropbox. And in the course of the process, it turned out that Akeeba can on...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Cleaning Dropbox backup storage by cron</h1><div class="post__text post__text-html js-mediator-article">  I had a chance to configure Akeeba Backup Pro for remote backup storage in Dropbox.  And in the course of the process, it turned out that Akeeba can only litter the very same Dropbox, but it will have to be manually cleaned up after it.  But manually - not comme il faut, and archives on gigabyte with small.  Therefore, you need to somehow get rid of obsolete hands. <br><br>  So, given - full backups upload to the " <i>full</i> " folder every three hours.  Mysql database - in the folder " <i>mysql</i> " every half hour.  So the owner of the site wants, he paid for this Dropbox Pro business. <br><br>  It is necessary - to delete all the old full archives, leaving one per day (and so that was!), And all the backups of Mysql, except for today. <br><a name="habracut"></a><br>  I'll warn you right away - I have been using CentOS recently, less than a year.  It is installed on the virtual machine as a test web server (LAMP), I am on the console once a month, and wrote ‚Äúbatch file‚Äù as good old MS-DOS 6.22, because everything described below was born in just a couple of hours from scratch and does not shine grace. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      First of all, I was puzzled by the question - what to get to Dropbox from the console?  After a brief search on the Internet, a wonderful bash script, <i><a href="https://github.com/andreafabrizi/Dropbox-Uploader">Dropbox_Uploader</a></i> , was <i><a href="https://github.com/andreafabrizi/Dropbox-Uploader">discovered</a></i> , which, as it turned out, can not only upload, but also other vital commands, including <i>list</i> and <i>delete</i> .  That's just bad luck - I didn‚Äôt understand right away if he was trained to delete ‚Äúaccording to the list‚Äù, so he designed it as a trite cycle (besides, it‚Äôs easier to debug by the piece). <br><br>  Installing dropbox_uploader is simple - download it with the command <br><pre><code class="bash hljs">curl <span class="hljs-string"><span class="hljs-string">"https://raw.githubusercontent.com/andreafabrizi/Dropbox-Uploader/master/dropbox_uploader.sh"</span></span> -o dropbox_uploader.sh</code> </pre> <br>  we give everyone rights to read and execute <br><pre> <code class="bash hljs">chmod +rx dropbox_uploader.sh</code> </pre><br>  then run <br><pre> <code class="bash hljs">./dropbox_uploader.sh</code> </pre><br>  configure access to Dropbox by following the prompts on the screen (create a new application on the Dropbox website and feed the APP key and APP secret to the script) and transfer the script to <i>/ usr / bin /</i> so that it is accessible to everyone, and most importantly - the crown. <br><br>  Dropbox_uploder at the command list full (recall, " <i>full</i> " for me - the name of the folder) gives something like <br><pre> <code class="bash hljs">&gt; Listing <span class="hljs-string"><span class="hljs-string">"/full"</span></span>... DONE [F] 1218610223 site-sitename.com-20150908-000001.jpa [F] 1218610223 site-sitename.com-20150908-030001.jpa [F] 1218610223 site-sitename.com-20150908-060001.jpa [F] 1218610223 site-sitename.com-20150908-090001.jpa [F] 1218610223 site-sitename.com-20150908-120001.jpa [F] 1218610223 site-sitename.com-20150908-150001.jpa [F] 1218610223 site-sitename.com-20150908-180001.jpa [F] 1218610223 site-sitename.com-20150908-210001.jpa ...  .. ... [F] 1218610223 site-sitename.com-20150915-150001.jpa [F] 1218610223 site-sitename.com-20150915-180001.jpa [F] 1218610223 site-sitename.com-20150915-210001.jpa</code> </pre><br>  We create our own <i>clean_dropbox.sh</i> script immediately in <i>/ usr / bin</i> (why not?), With the same rights 755, and in it: <br><br>  <b>1.</b> Create a list of unnecessary archives <br><pre> <code class="bash hljs">dropbox_uploader.sh list full *.jpa | cut -d <span class="hljs-string"><span class="hljs-string">' '</span></span> -f4 | grep -v $(date +%Y%m%d) | grep -v -e <span class="hljs-string"><span class="hljs-string">'-00'</span></span> | grep -v <span class="hljs-string"><span class="hljs-string">'full'</span></span> &gt; todel.txt</code> </pre><br>  in which the resulting list of * .jpa files from the full folder is filtered cut and several grep and saved to a file. <br>  Cut leaves only file names ( <i>-d ''</i> - separator space, <i>-f4</i> - 4th field).  Yes, the fourth, because  the line starts with a space. <br>  The first grep discards today's archives, the second excludes those created within an hour after midnight, and the third removes the line with the name of the folder "/ full" ... from the top of the list. <br><br>  <b>2.</b> The resulting file is read into the variable (array of strings) <br><pre> <code class="bash hljs">files=$(&lt;todel.txt)</code> </pre><br>  <b>3.</b> Cycle through the array and delete each file. <br><pre> <code class="bash hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> file <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-variable"><span class="hljs-variable">$files</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> dropbox_uploader.sh delete /full/<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">"</span></span> &gt;&gt; /var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/cleanup.log <span class="hljs-keyword"><span class="hljs-keyword">done</span></span></code> </pre><br>  Given that the script will work in the crown, just in case, we write the output to the log file. <br><br>  At this, the processing of complete archives can be considered complete, the mysql archives remain. <br>  It's all on the groove.  A list of files with simplified grep - we don‚Äôt need old backups at all, and we can wait a stack for the day, since their sizes are quite acceptable. <br><pre> <code class="bash hljs">dropbox_uploader.sh list mysql *.sql | cut -d <span class="hljs-string"><span class="hljs-string">' '</span></span> -f4 | grep -v $(date +%Y%m%d) | grep -v <span class="hljs-string"><span class="hljs-string">'mysql'</span></span> &gt; todel.txt</code> </pre><br>  Similarly, delete unnecessary in the loop <br><pre> <code class="bash hljs">dropbox_uploader.sh delete /mysql/<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">"</span></span> &gt;&gt; /var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/cleanup.log</code> </pre><br>  and finally we remove <s>the</s> list of files <br><pre> <code class="bash hljs">rm todel.txt</code> </pre><br>  That's all, now it‚Äôs enough to create a crown <br> <code>50 23 * * * clean_dropbox.sh <br></code> <br>  Voila! <br><br>  I understand that for the guru of Linux my post is almost useless, but Habr is read by such ignoramuses like me.  I hope someone will come in handy. </div><p>Source: <a href="https://habr.com/ru/post/266993/">https://habr.com/ru/post/266993/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../266977/index.html">How to unlock Android without knowing the password</a></li>
<li><a href="../266981/index.html">Outbound mail routing using Cisco ESA</a></li>
<li><a href="../266985/index.html">How to make friends C ++ and QML</a></li>
<li><a href="../266987/index.html">ABBYY helps to digitize rare editions of the Sakhalin Library</a></li>
<li><a href="../266991/index.html">Restricting Access to Web Applications in Synology DSM</a></li>
<li><a href="../266995/index.html">Home server for work and not only. The organization of the workplace of a lazy engineer</a></li>
<li><a href="../266997/index.html">The digest of interesting materials from the world of Drupal # 13</a></li>
<li><a href="../266999/index.html">Encapsulation of interfaces. We make API in C ++ convenient and understandable.</a></li>
<li><a href="../267001/index.html">Adaptive design alone is not enough: we need adaptive performance.</a></li>
<li><a href="../267003/index.html">Reinforced.Typings - more details</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>