<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Graylog2 has become more convenient and faster.</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Writing for the VPSVille three videos on Graylog realized that there was only one review article on Habr√©, and the manuals in any language are confuse...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Graylog2 has become more convenient and faster.</h1><div class="post__text post__text-html js-mediator-article">  Writing for the VPSVille <a href="https://www.youtube.com/user/vpsville">three videos</a> on <a href="https://www.graylog.org/">Graylog</a> realized that there was only one review <a href="https://habrahabr.ru/post/132116/">article</a> on Habr√©, and the manuals in any language are confused due to the different work of the components in different software versions.  Having spent the day on digesting all this beauty, I am writing a manual: how to set up a Graylog server to collect events from Windows and Linux. <br><br>  Who really wants to understand Linux, but does not understand where to start - I ask to my <a href="https://www.youtube.com/user/itsemaev">channel</a> . <br><br><img src="https://habrastorage.org/getpro/habr/post_images/4ed/139/b6d/4ed139b6dacc8e5c905fe8a58c2d5599.jpg" alt="image">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Instead of introducing: Graylog is open source software designed to collect logs in giant networks from a huge number of sources in various ways.  It is possible to conveniently organize the collection of events, filtering, search, automation (all kinds of alerts), etc.  There are many similar tools, but Graylog offers unrealistic performance using modern components, convenient analytics and a beautiful interface. <br>  To work, he needs <a href="https://www.java.com/ru/">Java</a> , he will store his configuration in <a href="https://www.mongodb.org/">MongoDB</a> , and use <a href="https://www.elastic.co/">ElasticSearch</a> to search and store logs.  About the collection of information from WIndows will be lower, but the spoiler - the agent no longer needs Java. <br><a name="habracut"></a><br>  So, we have an official <a href="http://docs.graylog.org/en/latest/pages/getting_started.html">manual</a> on which we should collect Graylog with you.  But a lot of things are missed in it, these are just pieces of information, so let's go step by step ourselves (I use Ubuntu 14.04, as the developers currently advise it).  Since Graylog was originally designed for the largest networks, it is recommended to install the database, the search engine and Graylog itself on different servers, create clusters, nodes from it all.  I take the simplest config in which everything is spinning on the same machine. <br><br>  <b>First part: installing graylog.</b>  <b>( <a href="https://www.youtube.com/watch%3Fv%3DGUX6hkfoqVg">video instruction</a> )</b> <br><br>  Java first (version 8 or higher): <br><pre><code class="bash hljs">sudo add-apt-repository ppa:webupd8team/java sudo apt-get update sudo apt-get install oracle-java8-installer</code> </pre> <br><br>  Then MongoDB (what if that changes, here's a <a href="https://docs.mongodb.org/manual/tutorial/install-mongodb-on-ubuntu/">manual for</a> you): <br><pre> <code class="bash hljs">sudo apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv EA312927 <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">'deb http://downloads-distro.mongodb.org/repo/debian-sysvinit dist 10gen'</span></span> | sudo tee /etc/apt/sources.list.d/mongodb.list sudo apt-get update sudo apt-get install mongodb-org</code> </pre><br><br>  Following ElasticSearch (which also has its own <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/setup-repositories.html">manual</a> ): <br><pre> <code class="bash hljs">sudo wget -qO - https://packages.elastic.co/GPG-KEY-elasticsearch | sudo apt-key add - <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"deb http://packages.elastic.co/elasticsearch/2.x/debian stable main"</span></span> | sudo tee -a /etc/apt/sources.list.d/elasticsearch-2.x.list sudo apt-get update sudo apt-get install elasticsearch</code> </pre><br><br>  Elastic need: <br>  autorun setting: <pre> <code class="bash hljs">sudo update-rc.d elasticsearch defaults 95 10</code> </pre><br>  Editing configuration file: <pre> <code class="bash hljs">sudo vi /etc/elasticsearch/elasticsearch.yml</code> </pre><br>  namely specify the name of the cluster, for example: <code>cluster.name: graylog <br></code> <code>cluster.name: graylog <br></code> <br>  and deny access to it over the network (since the whole system is on one machine): <code>network.bind_host: localhost <br></code> <code>network.bind_host: localhost <br></code> <br>  still recommend banning dynamic scripts, but I have an elastic on this option swears: <code>script.disable_dynamic: true <br></code> <code>script.disable_dynamic: true <br></code> <br><br>  Restart Elastic: <pre> <code class="bash hljs">sudo service elasticsearch restart</code> </pre><br>  And check <pre> <code class="bash hljs"> curl -XGET <span class="hljs-string"><span class="hljs-string">'http://localhost:9200/_cluster/health?pretty=true'</span></span></code> </pre><br>  If the output does not have frank errors, then everything is in order. <br><br>  Installing and trying to start Graylog: <br><pre> <code class="bash hljs">sudo apt-get install apt-transport-https wget https://packages.graylog2.org/repo/packages/graylog-2.0-repository_latest.deb sudo dpkg -i graylog-2.0-repository_latest.deb sudo apt-get update sudo apt-get install graylog-server sudo rm -f /etc/init/graylog-server.override sudo start graylog-server</code> </pre><br><br>  Now we set the password for access to it (I have ‚Äú123456789‚Äù), encrypted, as it should be in adults (who will not understand the meaning of the commands below: watch the <a href="https://www.youtube.com/watch%3Fv%3DGUX6hkfoqVg">video</a> , or write questions): <br><pre> <code class="bash hljs">sudo apt-get install pwgen SECRET=$(pwgen -s 96 1) sudo -E sed -i -e <span class="hljs-string"><span class="hljs-string">'s/password_secret =.*/password_secret = '</span></span><span class="hljs-variable"><span class="hljs-variable">$SECRET</span></span><span class="hljs-string"><span class="hljs-string">'/'</span></span> /etc/graylog/server/server.conf PASSWORD=$(<span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> -n 123456789 | shasum -a 256 | awk <span class="hljs-string"><span class="hljs-string">'{print $1}'</span></span>) sudo -E sed -i -e <span class="hljs-string"><span class="hljs-string">'s/root_password_sha2 =.*/root_password_sha2 = '</span></span><span class="hljs-variable"><span class="hljs-variable">$PASSWORD</span></span><span class="hljs-string"><span class="hljs-string">'/'</span></span> /etc/graylog/server/server.conf</code> </pre><br><br>  In the same configuration file I specify the ip of my future Graylog server and the prefix (it is the name of the Elastic cluster above). <br><pre> <code class="bash hljs">sudo vi /etc/graylog/server/server.conf rest_listen_uri = http://10.0.1.10:12900/ web_listen_uri = http://10.0.1.10:9000/ elasticsearch_index_prefix = graylog</code> </pre><br><br>  I restart Graylog and try to log in via the web interface: <blockquote>  <a href="http://10.0.1.10/">10.0.1.10</a> : 9000 / </blockquote>  (by itself, all ports specified in the config should be open).  When you start Graylog, you can fool around a few minutes and write in the web interface that everything is bad, do not accept the password and throw it on the main page.  Give it time to recover and try. <br><br>  <b>The second part: setting up logging to Graylog from Linux.</b>  <b>( <a href="https://www.youtube.com/watch%3Fv%3DpoFNT6X8tTk">video instruction</a> )</b> <br><br>  We don‚Äôt need to get into the console of the receiving log server anymore.  We go to a web muzzle and we create Input for logs.  To paint navigation through the web interface is a bad thing, because there is <a href="https://www.youtube.com/watch%3Fv%3DpoFNT6X8tTk">video</a> .  In short: <br><ul><li>  UDP Input is created in the ‚ÄúSystem‚Äù menu; </li><li>  syslog udp is specified; </li><li>  specifies the port (the default is 512, but for graylog to use ports below 1024 you need a lot of traffic), so for example 1234; </li><li>  the address for listening to incoming messages is indicated, I have 10.0.1.10; </li><li>  click Launch. </li></ul><br>  To test Input operation, you can perform graylog in the console of the same server. <pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"Hello Graylog"</span></span> | nc -w 1 -u 10.0.1.10 1234</code> </pre>  and look in the web interface for messages received at Input. <br><br>  The configuration of Linux machines to send logs, in principle, is simple.  Almost everywhere, syslogd releases behave the same.  Who does not remember anything about logging demons - refresh my memory on the <a href="http://it-semaev.ru/course/lpic1_102/lpic-1082-gurnali-sobitiy-68.html">channel</a> .  So debian and redhat. <br>  The rsyslog job file is created: <pre> <code class="bash hljs"> sudo vi /etc/rsyslog.d/90-graylog2.conf</code> </pre><br>  with text (the address and port is taken from the configured Input): <br> <code>$template GRAYLOGRFC5424,"&lt;%PRI%&gt;%PROTOCOL-VERSION% %TIMESTAMP:::date-rfc3339% %HOSTNAME% %APP-NAME% %PROCID% %MSGID% %STRUCTURED-DATA% %msg%\n" <br> *.* @10.0.1.10:1234;GRAYLOGRFC5424 <br></code> <br><br>  The log daemon is re-fetched by the command <pre> <code class="bash hljs">sudo service rsyslog restart</code> </pre>  (well, or whatever it is in your OS). <br>  And you can view received messages in the Graylog web interface. <br><br>  <b>The third part: setting up log reception in Graylog from Windows.</b>  <b>( <a href="https://www.youtube.com/watch%3Fv%3Dk2wmHy4qW_Q">video instruction</a> )</b> <br><br>  In versions of Graylog earlier than the second, the graylog collector on java was used.  In the second (actual) it is simply ignored and gives errors (I tried to repair it for half a day until I understood it).  Instead, it uses the <a href="https://www.graylog.org/blog/48-fifth-alpha-of-graylog-v2-0-released-with-message-processor-pipeline-and-collector-sidecar">graylog sidecar</a> , which receives the config from the Graylog server (which is very convenient, since there is no need to climb the screw servers to edit the settings) and sends it to <a href="http://nxlog.org/">nxlog</a> (or whatever you like), which it collects and sends. <br><img src="https://habrastorage.org/getpro/habr/post_images/f45/422/364/f4542236412baf60f9400a703ed88b65.jpg" alt="image"><br><br>  To receive messages from Windows, you need to create a separate Input via the web interface: <br><ul><li>  choose GELF UDP; </li><li>  specify the node, server ip graylog; </li><li>  remember or edit the message receiving port (by default 12201). </li></ul><br><br>  To create a configuration of sending logs for nxlog on Windows, you need to create a collector through the web interface in graylog: <br><ul><li>  choose Collectors; </li><li>  select Manage Configuration; </li><li>  create a configuration; </li><li>  specify the label (it is by the sidecar label on windows that it will understand what configuration for nxlog to download to itself on the machine); </li><li>  create Output for nxlog (in which we simply specify the Input settings from the previous step: GELF UDP Output, ip, port); </li><li>  we create Input for nxlog (we specify the simplest option: Windows Event Log). </li></ul><br><br>  Go to Windows, Download and install <a href="https://nxlog.org/products/nxlog-community-edition/download">nxlog</a> and <a href="https://github.com/Graylog2/collector-sidecar/releases">graylog-sidecar</a> . <br>  We remove as service nxlog, and set as service sidecar: <br> <code>'C:\Program Files (x86)\nxlog\nxlog.exe' -u <br> 'C:\Program Files (x86)\graylog\collector-sidecar\graylog-collector-sidecar.exe' -service install <br></code> <br><br>  We edit the Sidecar configuration file ( <i>C: \ Program Files (x86) \ graylog \ collector-sidecar \ collector_sidecar.yml</i> ), namely, we specify the global (12900) listening port, server ip, and most importantly: the label by which the config will be accepted.  It looks like this to me: <br> <code>server_url: http://10.0.1.10:12900 <br> node_id: graylog-collector-sidecar <br> collector_id: file:C:\Program Files (x86)\graylog\collector-sidecar\collector-id <br> tags: windows <br> log_path: C:\Program Files (x86)\graylog\collector-sidecar <br> update_interval: 10 <br> backends: <br> - name: nxlog <br> enabled: true <br> binary_path: C:\Program Files (x86)\nxlog\nxlog.exe <br> configuration_path: C:\Program Files (x86)\graylog\collector-sidecar\generated\nxlog.conf <br></code> <br><br>  Run sidecar <code>'C:\Program Files (x86)\graylog\collector-sidecar\graylog-collector-sidecar.exe' -service start <br></code> <code>'C:\Program Files (x86)\graylog\collector-sidecar\graylog-collector-sidecar.exe' -service start <br></code> <br>  Create <code>eventcreate /l Application /t INFORMATION /id 1 /d ‚ÄúSuck it‚Äù <br></code> event <code>eventcreate /l Application /t INFORMATION /id 1 /d ‚ÄúSuck it‚Äù <br></code> <code>eventcreate /l Application /t INFORMATION /id 1 /d ‚ÄúSuck it‚Äù <br></code> <br>  We look at the logs in its directory ( <i>C: \ Program Files (x86) \ graylog \ collector-sidecar \</i> ), and if everything is ok - go to the web-face to watch the logs of Windows on the server. <br><br>  <u>Nuances:</u> <br><ol><li>  it happens that the config file needs to be created manually empty C: \ Program Files (x86) \ graylog \ collector-sidecar \ generated \ nxlog.conf; </li><li>  it happens that you need to restart the Windows, so that all services are all grabbed; </li><li>  I had a cant with a typo in the name of the label, I killed an hour, figuring out; </li><li>  the label itself must be framed in the web interface, otherwise it is not a label. </li></ol><br><br>  Well, after that, work begins in the web interface: what logs where to get, how to react to what events, what to filter, etc.  Start digging - figure it out.  Just in case, once again <a href="http://docs.graylog.org/en/latest/pages/getting_started.html">manual</a> . </div><p>Source: <a href="https://habr.com/ru/post/282974/">https://habr.com/ru/post/282974/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../282958/index.html">Myths and legends about overflowing integers in Rust</a></li>
<li><a href="../282960/index.html">Android N: how Google "tightens the screws"</a></li>
<li><a href="../282962/index.html">Domains: Internet history</a></li>
<li><a href="../282968/index.html">Web performance: Why Performance Matters</a></li>
<li><a href="../282972/index.html">Uvloop released - advanced event loop implementation for asyncio in Python</a></li>
<li><a href="../282978/index.html">Microsoft DevCon 2016 - Introducing the Final Wave of Community Track Speakers</a></li>
<li><a href="../282984/index.html">How to choose a direction for the development of an IT project: 1cloud experience</a></li>
<li><a href="../282986/index.html">Why MIT is no longer studying SICP</a></li>
<li><a href="../282992/index.html">Transparent communication servers on java and nodejs through Vert</a></li>
<li><a href="../282996/index.html">How to hide your real IP address using a VPN server</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>