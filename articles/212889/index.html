<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Javascript: autocorrection timers</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the post, in a narrative and not very manner, it tells about various implementations of the ‚Äúexact‚Äù timers on JS. The material is designed for begi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Javascript: autocorrection timers</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/593/5c6/3f4/5935c63f4124cba6513a634994e6f2ef.png"><br><br>  In the post, in a narrative and not very manner, it tells about various implementations of the ‚Äúexact‚Äù timers on JS.  The material is designed for beginners ... Welcome under cat. <a name="habracut"></a><br><br>  As many have noticed, the picture for the post depicts the clock from Dali's work ‚ÄúTime is flowing‚Äù, the choice is by no means accidental and metaphorical in nature.  For, in the framework of programming on JS, time may not quite flow as we assume.  JS is single-threaded in its essence, which creates a queue for performing functions, and a queue implies an indispensable order of succession.  And if some of the computation steps turn out to be too resource-intensive, we have an obvious discrepancy between what is required and the result of the execution.  This is especially critical in cases of controlling transients without the use of libraries.  For example: performing a transition with a change in coordinate in time along a cubic curve ( <i>easing</i> ), or working with a rhythmic call of application logic to update the current state.  A couple of months ago, as a weekend project, I chose to write a simple <a href="http://ru.wikipedia.org/wiki/%25D0%25A1%25D0%25B5%25D0%25BA%25D0%25B2%25D0%25B5%25D0%25BD%25D1%2581%25D0%25BE%25D1%2580">step sequencer (wiki)</a> for myself, and faced the physical impossibility of precise timing on weak and weak systems using standard <i>setTimeout ()</i> and <i>setInterval ()</i> .  The mismatch reached irreconcilable in this case half a second.  In search of a solution, I came across an <a href="http://www.sitepoint.com/creating-accurate-timers-in-javascript/">excellent article</a> on this topic.  And the post itself, in a certain way, is a free translation thereof. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      As a result, the task of ‚Äúaccurate‚Äù timing is reduced to subtracting the delay of the previous execution of the function from the present.  You can simply measure the difference in system time between iterations and subtract it on the next call.  It sounds simple, and here is the code: <br><pre><code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> start = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Date</span></span>().getTime(), time = <span class="hljs-number"><span class="hljs-number">0</span></span>, elapsed = <span class="hljs-string"><span class="hljs-string">'0.0'</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">instance</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ time += <span class="hljs-number"><span class="hljs-number">100</span></span>; elapsed = <span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.floor(time / <span class="hljs-number"><span class="hljs-number">100</span></span>) / <span class="hljs-number"><span class="hljs-number">10</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.round(elapsed) == elapsed) { elapsed += <span class="hljs-string"><span class="hljs-string">'.0'</span></span>; } <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.title = elapsed; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> diff = (<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Date</span></span>().getTime() - start) - time; <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.setTimeout(instance, (<span class="hljs-number"><span class="hljs-number">100</span></span> - diff)); } <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.setTimeout(instance, <span class="hljs-number"><span class="hljs-number">100</span></span>);</code> </pre> <br><br>  It's pretty simple, look at the results.  Here is a <a href="http://jsfiddle.net/aLTLV/8/">demo</a> on JSfiddle with comments in Russian, for comparing the work of ordinary timers and timers with autocorrection. <br>  The best thing about this approach is that it does not really matter how inaccurate the timer is, since afterwards a slight constant delay (like 3-4ms in the last demo example) can be very easily compensated.  While the inaccuracy of a simple timer is cumulative, it accumulates with each iteration, which in the end leads to a hell of a noticeable difference. <br><br>  As mentioned above, I encountered this problem when writing an audio application.  Applications, of course, are very loudly said, rather just another regular mini-project.  After studying the material, this code was written here: <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//    "play/stop",     function preciousTimer (step) { //    ,  DateStamp   var start = new Date().getTime(), time = 0, /*            ,     (    )*/ it = 0; function instance () { //   time += step; //  var diff = (new Date().getTime()- start) - time; //    if (it == 4) { it = 0; /*     ,          . */ if (m == 8) { m = 0; }; for (var i = 0; i &lt; 4; i++) { if (noteArr[i][m]) { sound[i].play(); }; }; m++; }; it++; //       , //     if (pause) { return; }; //  ,    window.setTimeout(instance, (step - diff)); }; //      instance(), //      setTimeout(instance, step); };</span></span></code> </pre><br><br>  Someone has probably wondered: what about the overflow of the call stack.  In this particular case, its size ranges from 10 to 17 positions, which is not enough for any modern browser.  However, with an increase in pace, or together with an increase in the number of recalculated iterations, a choking attack may occur and you will need to think about implementing .tail () - like calls.  But this is a completely different story. <br><br>  We should also mention the <i>window.performance.now ()</i> method, which returns a floating-point number, a significant number of milliseconds elapsed from the page load (not quite an exact definition) Therefore, after the decimal point, we will have submillisecond resolution, which is very good .  Using this value, it is possible by a similar method to calculate the mismatch with an accuracy of one-tenth of a millisecond, and more accurately start the next iteration. <br><br>  You can see the sequencer live here: <a href="http://stepograph.hol.es/">stepograph.hol.es</a> (webkit required) <br>  Link to the original article, partially used in the post: <a href="http://www.sitepoint.com/creating-accurate-timers-in-javascript/">reating accurate timers in JavaScript</a> <br><br>  <b>Thanks for attention!</b> </div><p>Source: <a href="https://habr.com/ru/post/212889/">https://habr.com/ru/post/212889/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../212879/index.html">x3650 M4 - do you need HD?</a></li>
<li><a href="../212881/index.html">Documentation Development with DocBook</a></li>
<li><a href="../212883/index.html">Declarative event binding / handling</a></li>
<li><a href="../212885/index.html">Problem 10 million connections</a></li>
<li><a href="../212887/index.html">Keep the roots (to the 80th anniversary of Nicklaus Wirth)</a></li>
<li><a href="../212891/index.html">Ubiquiti AirGrid M5 HP 27dBi - Expansion of a network bridge. Personal experience</a></li>
<li><a href="../212893/index.html">From bubble sorting to genetic algorithms</a></li>
<li><a href="../212895/index.html">Analysis of application performance as a separate direction in IT</a></li>
<li><a href="../212897/index.html">Helper combining scripts and styles in one file for the old man ZF1</a></li>
<li><a href="../212899/index.html">Brief instruction on how to work with a web-designer (designer's view)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>