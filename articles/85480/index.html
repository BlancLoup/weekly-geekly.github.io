<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Program from one exe</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="As a rule, when writing .NET programs, not only classes from .NET BCL are used, but also third-party libraries. At runtime, all used libraries must be...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Program from one exe</h1><div class="post__text post__text-html js-mediator-article"><img align="left" src="https://habrastorage.org/getpro/habr/post_images/4e0/657/90e/4e065790e25157853ca8b24585bb113f.png">  As a rule, when writing .NET programs, not only classes from .NET BCL are used, but also third-party libraries.  At runtime, all used libraries must be found.  For this dependent dll put in the same folder with the exe file. <br><br>  However, there are programs that use third-party libraries, but at the same time consisting of a single file.  All utilities from <a href="http://technet.microsoft.com/en-us/sysinternals/bb842062.aspx">SysInternals</a> , as well as my favorite <a href="http://www.linqpad.net/">LINQPad,</a> are one file that contains everything that is required for work.  It is a pleasure to use such utilities - they are immediately ready for use, it is convenient to transfer and store them. <br><br>  The article describes how to create such stand-alone programs from a single file.  An example of how to compress the <a href="http://www.codeplex.com/AutoMapper">AutoMapper</a> library <a href="http://www.codeplex.com/AutoMapper">sewn</a> into the program and how to get it and use it is <a href="http://www.codeplex.com/AutoMapper">analyzed</a> . 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <a name="habracut"></a><br><h1>  Article Code </h1><br>  Article source code - <a href="">download</a> <br><br>  The program code uses a third-party <a href="http://www.codeplex.com/AutoMapper">AutoMapper</a> library.  To make sure that the library is working after it is sewn into resources, the program calls the code from the samples to the library.  This code is not given here, because this article is not about AutoMapper.  But the library itself is interesting and useful - I recommend to look at what it does in the code. <br><br><br><h1>  An approach </h1><br>  In order for .NET code to work, the assembly that contains the types used in the code must be loaded into the AppDomain using it.  If a type is in an assembly that has not yet been loaded into the AppDomain, the CLR searches for that assembly by its full name.  The search takes place in several places, exactly - it depends on the AppDomain settings.  For desktop applications, this is usually the GAC and the current folder. <br><br>  If the CLR cannot find the assembly, the AppDomain.AssemblyResolve event is raised.  The event allows you to load the desired assembly manually.  Therefore, to implement a standalone program consisting of a single exe file, it is sufficient to stitch all dependent assemblies into resources and load them in the AssemblyResolve handler. <br><br>  <font color="gray"><i>Details on the mechanism for finding assemblies can be found in the book <a href="http://www.amazon.com/Essential-NET-Common-Language-Runtime/dp/0201734117">Essential .NET, Volume 1: The Common Language Runtime (Don Box, Chris Sells)</a> - Chapter 8, AppDomains and the Assembly Resolver section.</i></font> <br><br><br><h1>  Archiving builds </h1><br>  It is convenient to put in the assembly resources in the archived form.  Archiving reduces the size of the final program by about 2 times.  The launch speed increases, but few people will notice these fractions of a second.  But reducing the file size will allow it to download over the network faster. <br><br>  In the .NET library there is an archiving stream - DeflateStream.  <a href="http://en.wikipedia.org/wiki/DEFLATE">In fact,</a> it produces zip archiving, it is not connected with patents only.  Compression of the assembly of the dependent library is as follows: <table border="1"><tbody><tr><td><code><font color="black"><font color="#0000FF">var</font> fileInputName = <font color="#A31515">@"OneExeProgram\Libraries\AutoMapper 1.0 RTW\AutoMapper.dll"</font> ; <br> <font color="#0000FF">var</font> assembly = <font color="#2B91AF">File</font> .ReadAllBytes( fileInputName ); <br> <br> <font color="#0000FF">var</font> fileOutputName = <font color="#A31515">@"OneExeProgram\Libraries\AutoMapper 1.0 RTW\AutoMapper.dll.deflated"</font> ; <br> <font color="#0000FF">using</font> ( <font color="#0000FF">var</font> file = <font color="#2B91AF">File</font> .Open( fileOutputName, <font color="#2B91AF">FileMode</font> .Create ) ) <br> <font color="#0000FF">using</font> ( <font color="#0000FF">var</font> stream = <font color="#0000FF">new</font> <font color="#2B91AF">DeflateStream</font> ( file, <font color="#2B91AF">CompressionMode</font> .Compress ) ) <br> <font color="#0000FF">using</font> ( <font color="#0000FF">var</font> writer = <font color="#0000FF">new</font> <font color="#2B91AF">BinaryWriter</font> ( stream ) ) <br> { <br> writer.Write( assembly ); <br> }</font></code> </td> </tr></tbody></table><br><h1>  Using assembly from resources </h1><br>  So, we have a working project using third-party libraries.  It would be desirable, that exe a file of the project was autonomous and did not demand presence dependent dll in the directory. <br><br>  We add the previously archived assembly to the project resources via Project Properties-Resources-Files.  Studio when adding a resource generates code that allows you to use the added resource through the Resources class. <br><br>  Register the AssemblyResolve handler (before using dependent library classes): <table border="1"><tbody><tr><td> <code><font color="black"><font color="#2B91AF">AppDomain</font> .CurrentDomain.AssemblyResolve += AppDomain_AssemblyResolve;</font></code> </td> </tr></tbody></table>  Handler Code: <table border="1"><tbody><tr><td> <code><font color="black"><font color="#0000FF">private</font> <font color="#0000FF">static</font> <font color="#2B91AF">Assembly</font> AppDomain_AssemblyResolve( <font color="#0000FF">object</font> sender, ResolveEventArgs args ) <br> { <br> <font color="#0000FF">if</font> ( args.Name.Contains( <font color="#A31515">"AutoMapper"</font> ) ) <br> { <br> <font color="#2B91AF">Console</font> .WriteLine( <font color="#A31515">"Resolving assembly: {0}"</font> , args.Name ); <br> <br> <font color="#008000">//     ,    </font> <br> <font color="#0000FF">using</font> ( <font color="#0000FF">var</font> resource = <font color="#0000FF">new</font> <font color="#2B91AF">MemoryStream</font> ( <font color="#2B91AF">Resources</font> .AutoMapper_dll ) ) <br> <font color="#0000FF">using</font> ( <font color="#0000FF">var</font> deflated = <font color="#0000FF">new</font> <font color="#2B91AF">DeflateStream</font> ( resource, <font color="#2B91AF">CompressionMode</font> .Decompress ) ) <br> <font color="#0000FF">using</font> ( <font color="#0000FF">var</font> reader = <font color="#0000FF">new</font> <font color="#2B91AF">BinaryReader</font> ( deflated ) ) <br> { <br> <font color="#0000FF">var</font> one_megabyte = 1024 * 1024; <br> <font color="#0000FF">var</font> buffer = reader.ReadBytes( one_megabyte ); <br> <font color="#0000FF">return</font> <font color="#2B91AF">Assembly</font> .Load( buffer ); <br> } <br> } <br> <br> <font color="#0000FF">return</font> <font color="#0000FF">null</font> ; <br> }</font></code> </td> </tr></tbody></table>  A sparse build takes up more than a megabyte, so reading should happen at once.  For good, you need to read a buffer with a size equal to the size of the stream content, but the DeflateStream does not support the Length property. <br><br>  For several dependent libraries, it is worthwhile to enter into an agreement according to which the name of the resource and the assembly sought are the same.  Then, using reflection, you can automatically search for the required library in the resources. <br><br>  By default, dependent libraries added via References are copied to the project output directory.  In order for AssemblyResolve to work, you must either copy the output exe file to another directory, or forbid copying dependent libraries to the final directory via References-AutoMapper-Properties-Copy Local = false. <br><br><br><h1>  Conclusion </h1><br>  The inclusion of dependent assemblies in the resources of the program itself allows it to work autonomously.  Only one exe file is required to run.  This is important for service utilities that are immediately ready for use. <br><br>  In fact, such stand-alone programs do not require installation and are conveniently transferred over the network or stored on a flash drive.  Archiving assemblies allows you to reduce the size of the program and place more such programs on a flash drive / pump it out faster from the network. </div><p>Source: <a href="https://habr.com/ru/post/85480/">https://habr.com/ru/post/85480/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../85472/index.html">What do sites want?</a></li>
<li><a href="../85475/index.html">T-shirt deck</a></li>
<li><a href="../85476/index.html">The results of the study "Salaries in IT - 2009": The study audience</a></li>
<li><a href="../85477/index.html">The results of the study "Salaries in IT - 2009": Salaries of project managers</a></li>
<li><a href="../85479/index.html">QSP Compo 2010 submission of applications ends February 28</a></li>
<li><a href="../85481/index.html">C ++ performance on modern PCs</a></li>
<li><a href="../85483/index.html">The source of inspiration for the creators of Habr</a></li>
<li><a href="../85484/index.html">Will the Nokia N900 go into basic holster from urbantool?</a></li>
<li><a href="../85486/index.html">GNOME 2.29.0 Shell with a new notification system</a></li>
<li><a href="../85487/index.html">New nomads</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>