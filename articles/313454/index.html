<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Create a library for authorization using AzureAD for Android</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="So, the purpose of this article is to show how to work with OAuth 2.0 using the example of authorization through the Azure AD API. As a result, we wil...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Create a library for authorization using AzureAD for Android</h1><div class="post__text post__text-html js-mediator-article">  So, the purpose of this article is to show how to work with OAuth 2.0 using the example of authorization through the Azure AD API.  As a result, we will have a full-fledged module that takes out the maximum possible amount of code from the project to which it will be connected. <br><br>  In this article, the libraries will be used Retrofit, rxJava, retrolambda.  Their use is due only to my desire to minimize the boilerplate, and nothing more.  Therefore, there should be no difficulties in translating to a fully vanilla assembly. <br><br>  The first thing we need to do is to realize what the OAuth 2.0 authorization protocol is (in this case only the code flow will be used) and what it will look like in relation to our goal: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <b>1.</b> If there is a cached token, skip to step 4. <br><br>  <b>2.</b> Initialize 'WebView', in which we open the authorization page of our application. <br><br>  <b>3.</b> After entering the data by the user and clicking on Sign in, there will be an automatic redirect to another page, in the query parameters of which there is a parameter code.  He is what we need! <br><br>  <b>4.</b> Exchange the code for the token via a POST request. <br><a name="habracut"></a><br>  Now what does this mean from the point of view of the developer directly? <br>  The first thing we need to do is to write down the constants we need in separate classes. <br><br><div class="spoiler">  <b class="spoiler_title">Endpoints.class</b> <div class="spoiler_text"><pre><code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Endpoints</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String OAUTH2_BASE_URL = <span class="hljs-string"><span class="hljs-string">"https://login.microsoftonline.com"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String OAUTH2_ENDPOINT = <span class="hljs-string"><span class="hljs-string">"/oauth2"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String OAUTH2_AUTHORIZATION_ENDPOINT = <span class="hljs-string"><span class="hljs-string">"/authorize"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String OAUTH2_TOKEN_ENDPOINT = <span class="hljs-string"><span class="hljs-string">"/token"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String OAUTH2_TENANT_PATH_FIELD = <span class="hljs-string"><span class="hljs-string">"/{tenant}"</span></span>; }</code> </pre> <br></div></div><br><div class="spoiler">  <b class="spoiler_title">QueryFields.class</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">QueryFields</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String QUERY_OAUTH2_CLIENT_ID = <span class="hljs-string"><span class="hljs-string">"client_id"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String QUERY_OAUTH2_RESPONSE_TYPE = <span class="hljs-string"><span class="hljs-string">"response_type"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String QUERY_OAUTH2_REDIRECT_URI = <span class="hljs-string"><span class="hljs-string">"redirect_uri"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String QUERY_OAUTH2_RESOURCE = <span class="hljs-string"><span class="hljs-string">"resource"</span></span>; }</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">RequestFields.class</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RequestFields</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String OAUTH2_CLIENT_ID = <span class="hljs-string"><span class="hljs-string">"client_id"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String OAUTH2_GRANT_TYPE = <span class="hljs-string"><span class="hljs-string">"grant_type"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String OAUTH2_RESOURCE = <span class="hljs-string"><span class="hljs-string">"resource"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String OAUTH2_CODE = <span class="hljs-string"><span class="hljs-string">"code"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String OAUTH2_REDIRECT_URI = <span class="hljs-string"><span class="hljs-string">"redirect_uri"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String OAUTH2_RAW_CODE_QUERY_FIELD = <span class="hljs-string"><span class="hljs-string">"?code"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String OAUTH2_CODE_QUERY_FIELD = <span class="hljs-string"><span class="hljs-string">"code"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String OAUTH2_RAW_QEURY_ERROR_FIELD = <span class="hljs-string"><span class="hljs-string">"error="</span></span>; }</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">RequestFieldValues.class</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RequestFieldValues</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String TENANT_COMMON = <span class="hljs-string"><span class="hljs-string">"common"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String GRANT_TYPE_REFRESH_TOKEN = <span class="hljs-string"><span class="hljs-string">"refresh_token"</span></span>; }</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">ResponseFields.class</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ResponseFields</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String OAUTH2_TOKEN_TYPE = <span class="hljs-string"><span class="hljs-string">"token_type"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String OAUTH2_TOKEN_EXPIRES_IN = <span class="hljs-string"><span class="hljs-string">"expires_in"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String OAUTH2_TOKEN_SCOPE = <span class="hljs-string"><span class="hljs-string">"scope"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String OAUTH2_TOKEN_EXPIRES_ON = <span class="hljs-string"><span class="hljs-string">"expires_on"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String OAUTH2_TOKEN_NOT_BEFORE = <span class="hljs-string"><span class="hljs-string">"not_before"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String OAUTH2_TOKEN_RESOURCE = <span class="hljs-string"><span class="hljs-string">"resource"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String OAUTH2_TOKEN_ACCESS_TOKEN = <span class="hljs-string"><span class="hljs-string">"access_token"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String OAUTH2_TOKEN_REFRESH_TOKEN = <span class="hljs-string"><span class="hljs-string">"refresh_token"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String OAUTH2_TOKEN_ID_TOKEN = <span class="hljs-string"><span class="hljs-string">"id_token"</span></span>; }</code> </pre><br></div></div><br>  Assign the parameters of the default OkHttp client at the same time: <br><br><div class="spoiler">  <b class="spoiler_title">Const.class</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Const</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> CONNECT_TIMEOUT = <span class="hljs-number"><span class="hljs-number">15</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> WRITE_TIMEOUT = <span class="hljs-number"><span class="hljs-number">60</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> TIMEOUT = <span class="hljs-number"><span class="hljs-number">60</span></span>; }</code> </pre><br></div></div><br>  Now let's get down to business.  In fact, the most important part of our library will consist of two files ‚Äî the <code>OAuth2</code> interface, which contains the request signatures and the API factory, and <code>OAuth2WebViewClient</code> , which is the customized WebViewClient. <br><br>  Let's start in order. <br><br>  The signatures of calls for exchanging code for token are as follows: <br><br><pre> <code class="java hljs"> <span class="hljs-meta"><span class="hljs-meta">@FormUrlEncoded</span></span> <span class="hljs-meta"><span class="hljs-meta">@POST</span></span>(OAUTH2_TENANT_PATH_FIELD + OAUTH2_ENDPOINT + OAUTH2_TOKEN_ENDPOINT) Observable&lt;Response&lt;Token&gt;&gt; tradeCodeForToken( <span class="hljs-meta"><span class="hljs-meta">@Path</span></span>(OAUTH2_TENANT_PATH_FIELD) String tenant, <span class="hljs-meta"><span class="hljs-meta">@Field</span></span>(OAUTH2_CLIENT_ID) String clientId, <span class="hljs-meta"><span class="hljs-meta">@Field</span></span>(OAUTH2_GRANT_TYPE) String grantType, <span class="hljs-meta"><span class="hljs-meta">@Field</span></span>(OAUTH2_RESOURCE) String resource, <span class="hljs-meta"><span class="hljs-meta">@Field</span></span>(OAUTH2_CODE) String code, <span class="hljs-meta"><span class="hljs-meta">@Field</span></span>(OAUTH2_REDIRECT_URI) String redirectUri );</code> </pre><br><pre> <code class="java hljs"> <span class="hljs-meta"><span class="hljs-meta">@FormUrlEncoded</span></span> <span class="hljs-meta"><span class="hljs-meta">@POST</span></span>(OAUTH2_TENANT_PATH_FIELD + OAUTH2_ENDPOINT + OAUTH2_TOKEN_ENDPOINT) Observable&lt;Response&lt;Token&gt;&gt; refreshToken( <span class="hljs-meta"><span class="hljs-meta">@Path</span></span>(OAUTH2_TENANT_PATH_FIELD) String tenant, <span class="hljs-meta"><span class="hljs-meta">@Field</span></span>(OAUTH2_CLIENT_ID) String clientId, <span class="hljs-meta"><span class="hljs-meta">@Field</span></span>(OAUTH2_GRANT_TYPE) String grantType, <span class="hljs-meta"><span class="hljs-meta">@Field</span></span>(OAUTH2_RESOURCE) String resource, <span class="hljs-meta"><span class="hljs-meta">@Field</span></span>(OAUTH2_TOKEN_REFRESH_TOKEN) String refreshToken, <span class="hljs-meta"><span class="hljs-meta">@Field</span></span>(OAUTH2_REDIRECT_URI) String redirectUri );</code> </pre><br>  Here, the first method is the signature of the request described in clause 4, and the second is the token refresh, which will be periodically required, since the session token is most often validated within an hour. <br><br>  Now we are going to create an API factory.  So what will she represent?  During my close friendship with Retrofit, I have come to this version of the implementation of this mechanism: <br><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Factory</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> OAuth2 </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">buildOAuth2API</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">boolean</span></span></span></span><span class="hljs-function"><span class="hljs-params"> enableDebug)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> buildRetrofit(OAUTH2_BASE_URL, enableDebug).create(OAuth2.class); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> Retrofit </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">buildRetrofit</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String baseUrl, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">boolean</span></span></span></span><span class="hljs-function"><span class="hljs-params"> enableDebug)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Retrofit.Builder() .baseUrl(baseUrl) .addConverterFactory(GsonConverterFactory.create(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> GsonBuilder().create())) .addCallAdapterFactory(RxJavaCallAdapterFactory.create()) .client(buildClient(enableDebug)) .build(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> OkHttpClient </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">buildClient</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">boolean</span></span></span></span><span class="hljs-function"><span class="hljs-params"> enableDebug)</span></span></span><span class="hljs-function"> </span></span>{ OkHttpClient.Builder builder = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> OkHttpClient.Builder() .connectTimeout(Const.CONNECT_TIMEOUT, TimeUnit.SECONDS) .writeTimeout(Const.WRITE_TIMEOUT, TimeUnit.SECONDS) .readTimeout(Const.TIMEOUT, TimeUnit.SECONDS); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(enableDebug) { builder.addInterceptor( <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HttpLoggingInterceptor().setLevel(HttpLoggingInterceptor.Level.BODY) ); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> builder.build(); } }</code> </pre><br>  This class must be in the previously described interface. <br><br><div class="spoiler">  <b class="spoiler_title">Full code under the cut</b> <div class="spoiler_text"><pre> <code class="hljs kotlin"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">OAuth2</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** The request signature that returns a deserialized token */</span></span> <span class="hljs-meta"><span class="hljs-meta">@FormUrlEncoded</span></span> <span class="hljs-meta"><span class="hljs-meta">@POST(OAUTH2_TENANT_PATH_FIELD + OAUTH2_ENDPOINT + OAUTH2_TOKEN_ENDPOINT)</span></span> Observable&lt;Response&lt;Token&gt;&gt; tradeCodeForToken( <span class="hljs-meta"><span class="hljs-meta">@Path(OAUTH2_TENANT_PATH_FIELD)</span></span> String tenant, <span class="hljs-meta"><span class="hljs-meta">@Field(OAUTH2_CLIENT_ID)</span></span> String clientId, <span class="hljs-meta"><span class="hljs-meta">@Field(OAUTH2_GRANT_TYPE)</span></span> String grantType, <span class="hljs-meta"><span class="hljs-meta">@Field(OAUTH2_RESOURCE)</span></span> String resource, <span class="hljs-meta"><span class="hljs-meta">@Field(OAUTH2_CODE)</span></span> String code, <span class="hljs-meta"><span class="hljs-meta">@Field(OAUTH2_REDIRECT_URI)</span></span> String redirectUri ); <span class="hljs-comment"><span class="hljs-comment">/** The request signature that returns a raw json object instead of deserealized token */</span></span> <span class="hljs-meta"><span class="hljs-meta">@FormUrlEncoded</span></span> <span class="hljs-meta"><span class="hljs-meta">@POST(OAUTH2_TENANT_PATH_FIELD + OAUTH2_ENDPOINT + OAUTH2_TOKEN_ENDPOINT)</span></span> Observable&lt;Response&lt;JsonObject&gt;&gt; tradeCodeForTokenRaw( <span class="hljs-meta"><span class="hljs-meta">@Path(OAUTH2_TENANT_PATH_FIELD)</span></span> String tenant, <span class="hljs-meta"><span class="hljs-meta">@Field(OAUTH2_CLIENT_ID)</span></span> String clientId, <span class="hljs-meta"><span class="hljs-meta">@Field(OAUTH2_GRANT_TYPE)</span></span> String grantType, <span class="hljs-meta"><span class="hljs-meta">@Field(OAUTH2_RESOURCE)</span></span> String resource, <span class="hljs-meta"><span class="hljs-meta">@Field(OAUTH2_CODE)</span></span> String code, <span class="hljs-meta"><span class="hljs-meta">@Field(OAUTH2_REDIRECT_URI)</span></span> String redirectUri ); <span class="hljs-comment"><span class="hljs-comment">/** The request signature that allows refreshing token */</span></span> <span class="hljs-meta"><span class="hljs-meta">@FormUrlEncoded</span></span> <span class="hljs-meta"><span class="hljs-meta">@POST(OAUTH2_TENANT_PATH_FIELD + OAUTH2_ENDPOINT + OAUTH2_TOKEN_ENDPOINT)</span></span> Observable&lt;Response&lt;Token&gt;&gt; refreshToken( <span class="hljs-meta"><span class="hljs-meta">@Path(OAUTH2_TENANT_PATH_FIELD)</span></span> String tenant, <span class="hljs-meta"><span class="hljs-meta">@Field(OAUTH2_CLIENT_ID)</span></span> String clientId, <span class="hljs-meta"><span class="hljs-meta">@Field(OAUTH2_GRANT_TYPE)</span></span> String grantType, <span class="hljs-meta"><span class="hljs-meta">@Field(OAUTH2_RESOURCE)</span></span> String resource, <span class="hljs-meta"><span class="hljs-meta">@Field(OAUTH2_TOKEN_REFRESH_TOKEN)</span></span> String refreshToken, <span class="hljs-meta"><span class="hljs-meta">@Field(OAUTH2_REDIRECT_URI)</span></span> String redirectUri ); <span class="hljs-comment"><span class="hljs-comment">/** The request signature that allows refreshing token and returns a raw json instead of deserialized token */</span></span> <span class="hljs-meta"><span class="hljs-meta">@FormUrlEncoded</span></span> <span class="hljs-meta"><span class="hljs-meta">@POST(OAUTH2_TENANT_PATH_FIELD + OAUTH2_ENDPOINT + OAUTH2_TOKEN_ENDPOINT)</span></span> Observable&lt;Response&lt;Token&gt;&gt; refreshTokenRaw( <span class="hljs-meta"><span class="hljs-meta">@Path(OAUTH2_TENANT_PATH_FIELD)</span></span> String tenant, <span class="hljs-meta"><span class="hljs-meta">@Field(OAUTH2_CLIENT_ID)</span></span> String clientId, <span class="hljs-meta"><span class="hljs-meta">@Field(OAUTH2_GRANT_TYPE)</span></span> String grantType, <span class="hljs-meta"><span class="hljs-meta">@Field(OAUTH2_RESOURCE)</span></span> String resource, <span class="hljs-meta"><span class="hljs-meta">@Field(OAUTH2_TOKEN_REFRESH_TOKEN)</span></span> String refreshToken, <span class="hljs-meta"><span class="hljs-meta">@Field(OAUTH2_REDIRECT_URI)</span></span> String redirectUri ); <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Factory</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> static OAuth2 buildOAuth2API(boolean enableDebug) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> buildRetrofit(OAUTH2_BASE_URL, enableDebug).create(OAuth2.<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> static Retrofit buildRetrofit(String baseUrl, boolean enableDebug) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new Retrofit.Builder() .baseUrl(baseUrl) .addConverterFactory(GsonConverterFactory.create(new GsonBuilder().create())) .addCallAdapterFactory(RxJavaCallAdapterFactory.create()) .client(buildClient(enableDebug)) .build(); } <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> static OkHttpClient buildClient(boolean enableDebug) { OkHttpClient.Builder builder = new OkHttpClient.Builder() .connectTimeout(Const.CONNECT_TIMEOUT, TimeUnit.SECONDS) .writeTimeout(Const.WRITE_TIMEOUT, TimeUnit.SECONDS) .readTimeout(Const.TIMEOUT, TimeUnit.SECONDS); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(enableDebug) { builder.addInterceptor( new HttpLoggingInterceptor().setLevel( HttpLoggingInterceptor.Level.BODY ) ); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> builder.build(); } } }</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Token dto</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Token</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@SerializedName</span></span>(OAUTH2_TOKEN_TYPE) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String tokenType; <span class="hljs-meta"><span class="hljs-meta">@SerializedName</span></span>(OAUTH2_TOKEN_EXPIRES_IN) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String expiresIn; <span class="hljs-meta"><span class="hljs-meta">@SerializedName</span></span>(OAUTH2_TOKEN_SCOPE) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String scope; <span class="hljs-meta"><span class="hljs-meta">@SerializedName</span></span>(OAUTH2_TOKEN_EXPIRES_ON) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String expiresOn; <span class="hljs-meta"><span class="hljs-meta">@SerializedName</span></span>(OAUTH2_TOKEN_NOT_BEFORE) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String notBefore; <span class="hljs-meta"><span class="hljs-meta">@SerializedName</span></span>(OAUTH2_TOKEN_RESOURCE) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String resource; <span class="hljs-meta"><span class="hljs-meta">@SerializedName</span></span>(OAUTH2_TOKEN_ACCESS_TOKEN) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String accessToken; <span class="hljs-meta"><span class="hljs-meta">@SerializedName</span></span>(OAUTH2_TOKEN_REFRESH_TOKEN) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String refreshToken; <span class="hljs-meta"><span class="hljs-meta">@SerializedName</span></span>(OAUTH2_TOKEN_ID_TOKEN) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String idToken; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Token</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String tokenType, String expiresIn, String scope, String expiresOn, String notBefore, String resource, String accessToken, String refreshToken, String idToken)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.tokenType = tokenType; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.expiresIn = expiresIn; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.scope = scope; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.expiresOn = expiresOn; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.notBefore = notBefore; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.resource = resource; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.accessToken = accessToken; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.refreshToken = refreshToken; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.idToken = idToken; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getTokenType</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> tokenType; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setTokenType</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String tokenType)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.tokenType = tokenType; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getExpiresIn</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> expiresIn; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setExpiresIn</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String expiresIn)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.expiresIn = expiresIn; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getScope</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> scope; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setScope</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String scope)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.scope = scope; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getExpiresOn</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> expiresOn; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setExpiresOn</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String expiresOn)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.expiresOn = expiresOn; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getNotBefore</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> notBefore; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setNotBefore</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String notBefore)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.notBefore = notBefore; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getResource</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> resource; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setResource</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String resource)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.resource = resource; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getAccessToken</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> accessToken; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setAccessToken</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String accessToken)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.accessToken = accessToken; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getRefreshToken</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> refreshToken; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setRefreshToken</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String refreshToken)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.refreshToken = refreshToken; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getIdToken</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> idToken; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setIdToken</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String idToken)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.idToken = idToken; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">toString</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"MicrosoftAzureOAuthToken{"</span></span> + <span class="hljs-string"><span class="hljs-string">"tokenType='"</span></span> + tokenType + <span class="hljs-string"><span class="hljs-string">'\''</span></span> + <span class="hljs-string"><span class="hljs-string">", expiresIn='"</span></span> + expiresIn + <span class="hljs-string"><span class="hljs-string">'\''</span></span> + <span class="hljs-string"><span class="hljs-string">", scope='"</span></span> + scope + <span class="hljs-string"><span class="hljs-string">'\''</span></span> + <span class="hljs-string"><span class="hljs-string">", expiresOn='"</span></span> + expiresOn + <span class="hljs-string"><span class="hljs-string">'\''</span></span> + <span class="hljs-string"><span class="hljs-string">", notBefore='"</span></span> + notBefore + <span class="hljs-string"><span class="hljs-string">'\''</span></span> + <span class="hljs-string"><span class="hljs-string">", resource='"</span></span> + resource + <span class="hljs-string"><span class="hljs-string">'\''</span></span> + <span class="hljs-string"><span class="hljs-string">", accessToken='"</span></span> + accessToken + <span class="hljs-string"><span class="hljs-string">'\''</span></span> + <span class="hljs-string"><span class="hljs-string">", refreshToken='"</span></span> + refreshToken + <span class="hljs-string"><span class="hljs-string">'\''</span></span> + <span class="hljs-string"><span class="hljs-string">", idToken='"</span></span> + idToken + <span class="hljs-string"><span class="hljs-string">'\''</span></span> + <span class="hljs-string"><span class="hljs-string">'}'</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">toJsonString</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Gson().toJson(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, Token.class); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> Token </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fromJsonString</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String jsonString)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Gson().fromJson(jsonString, Token.class); } }</code> </pre><br></div></div><br>  Let's start implementation of custom WebViewClient.  To do this, we need to decide what we want to do.  In fact, when it is initialized, the input should contain links to callbacks, or to BehaviourSubjects (to taste, I like the first one in this case).  There will be three of them in total: the first will trigger when the code is received successfully, the second - if there is an 'error =' substring in the url after the redirect and the third one that listens to all other transitions. <br><br>  To implement, we need to override two <code>WebViewClient</code> methods: <code>shouldOverrideUrlLoading(WebView webView, String url)</code> and <code>onPageFinished(WebView webView, String url)</code> . <br><br><div class="spoiler">  <b class="spoiler_title">OAuth2WebViewClient</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">OAuth2WebViewClient</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WebViewClient</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Action1&lt;String&gt; onSuccess; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Action1&lt;String&gt; onError; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Action1&lt;String&gt; onUnknownUrlPassed; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OAuth2WebViewClient</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Action1&lt;String&gt; onSuccess, Action1&lt;String&gt; onError, Action1&lt;String&gt; onUnknownUrlPassed)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.onSuccess = onSuccess; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.onUnknownUrlPassed = onUnknownUrlPassed; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.onError = onError; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">shouldOverrideUrlLoading</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(WebView view, String url)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(url.contains(OAUTH2_RAW_CODE_QUERY_FIELD) || url.contains(OAUTH2_RAW_QEURY_ERROR_FIELD)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { view.loadUrl(url); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onPageFinished</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(WebView view, String url)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.onPageFinished(view, url); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(url.contains(OAUTH2_RAW_CODE_QUERY_FIELD)) { Uri uri = Uri.parse(url); onSuccess.call(uri.getQueryParameter(OAUTH2_CODE_QUERY_FIELD)); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(url.contains(OAUTH2_RAW_CODE_QUERY_FIELD)) { onError.call(url); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { onUnknownUrlPassed.call(url); } } }</code> </pre><br></div></div><br>  In fact, everything is ready for use, but you can add a couple more classes for more flexible functionality in order to reduce the boilerplate by a bit more. <br><br><div class="spoiler">  <b class="spoiler_title">AzureAuthenticationWebView</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AzureAuthenticationWebView</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WebView</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AzureAuthenticationWebView</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Context context)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(context); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AzureAuthenticationWebView</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Context context, AttributeSet attrs)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(context, attrs); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AzureAuthenticationWebView</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Context context, AttributeSet attrs, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> defStyleAttr)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(context, attrs, defStyleAttr); } <span class="hljs-meta"><span class="hljs-meta">@TargetApi</span></span>(Build.VERSION_CODES.LOLLIPOP) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AzureAuthenticationWebView</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Context context, AttributeSet attrs, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> defStyleAttr, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> defStyleRes)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(context, attrs, defStyleAttr, defStyleRes); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">init</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(OAuth2WebViewClient client, String query)</span></span></span><span class="hljs-function"> </span></span>{ WebSettings settings = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.getSettings(); settings.setJavaScriptEnabled(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); settings.setSupportMultipleWindows(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.setWebViewClient(client); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.loadUrl(query); } }</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">AzureStorageManager</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AzureStorageManager</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> ObscuredSharedPreferences preferences; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AzureStorageManager</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ObscuredSharedPreferences preferences)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.preferences = preferences; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Token </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">readToken</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ String rawToken = preferences.getString(TOKEN_JSON_KEY, <span class="hljs-string"><span class="hljs-string">""</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Token.fromJsonString(rawToken); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">writeToken</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Token token)</span></span></span><span class="hljs-function"> </span></span>{ ObscuredSharedPreferences.Editor editor = preferences.edit(); editor.putString(TOKEN_JSON_KEY, token.toJsonString()); editor.commit(); } }</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">QueryStringBuilder</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">QueryStringBuilder</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String query; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">QueryStringBuilder</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String tenant)</span></span></span><span class="hljs-function"> </span></span>{ query = OAUTH2_BASE_URL.concat(<span class="hljs-string"><span class="hljs-string">"/"</span></span>).concat(tenant).concat(OAUTH2_ENDPOINT).concat(OAUTH2_AUTHORIZATION_ENDPOINT).concat(<span class="hljs-string"><span class="hljs-string">"?"</span></span>); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> QueryStringBuilder </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setClientId</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String clientId)</span></span></span><span class="hljs-function"> </span></span>{ query = prepareQuery(query); query = query.concat(QUERY_OAUTH2_CLIENT_ID).concat(<span class="hljs-string"><span class="hljs-string">"="</span></span>).concat(clientId); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> QueryStringBuilder </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setResponseType</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String responseType)</span></span></span><span class="hljs-function"> </span></span>{ query = prepareQuery(query); query = query.concat(QUERY_OAUTH2_RESPONSE_TYPE).concat(<span class="hljs-string"><span class="hljs-string">"="</span></span>).concat(responseType); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> QueryStringBuilder </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setRedirectUri</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String redirectUri)</span></span></span><span class="hljs-function"> </span></span>{ query = prepareQuery(query); query = query.concat(QUERY_OAUTH2_REDIRECT_URI).concat(<span class="hljs-string"><span class="hljs-string">"="</span></span>).concat(redirectUri); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> QueryStringBuilder </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setResource</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String resource)</span></span></span><span class="hljs-function"> </span></span>{ query = prepareQuery(query); query = query.concat(QUERY_OAUTH2_RESOURCE).concat(<span class="hljs-string"><span class="hljs-string">"="</span></span>).concat(resource); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">build</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> query; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">prepareQuery</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String query)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(query != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> &amp;&amp; query.length() != <span class="hljs-number"><span class="hljs-number">0</span></span> &amp;&amp; !(String.valueOf(query.charAt(query.length() - <span class="hljs-number"><span class="hljs-number">1</span></span>)).equals(<span class="hljs-string"><span class="hljs-string">"?"</span></span>))) { query = query.concat(<span class="hljs-string"><span class="hljs-string">"&amp;"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> query; } }</code> </pre><br></div></div><br>  In principle, this can be stopped if we only implement the authorization process, but it seemed to me that the token manager would also be relevant, since very often I had to perform some manipulations with tokens.  Therefore, as a bonus, there is another class that, in addition to the previous ones, implements the storage of tokens, as well as a simple refresh.  Voila: <br><br><div class="spoiler">  <b class="spoiler_title">Tokenmanager</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TokenManager</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Subscription subscription = Subscriptions.empty(); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> AzureStorageManager storageManager; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String tenantType; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String clientId; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String redirectUri; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TokenManager</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(AzureStorageManager storageManager, String tenantType, String clientId, String redirectUri)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.storageManager = storageManager; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.tenantType = tenantType; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.clientId = clientId; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.redirectUri = redirectUri; } <span class="hljs-comment"><span class="hljs-comment">/** Performs (code -&gt; token) exchange using MS OAuth2 API * Caches the token if the response code is equals to HTTP_OK */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">tradeCodeForToken</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String code, String resource, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Action1&lt;Token&gt; onSuccess, Action1&lt;Integer&gt; onHttpError, Action1&lt;Throwable&gt; onFailure)</span></span></span><span class="hljs-function"> </span></span>{ subscription = OAuth2.Factory.buildOAuth2API(<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>) .tradeCodeForToken( tenantType, clientId, GRANT_TYPE_REFRESH_TOKEN, resource, code, redirectUri ) .subscribeOn(Schedulers.io()) .observeOn(AndroidSchedulers.mainThread()) .filter(response -&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(response.code() != HTTP_OK) { onHttpError.call(response.code()); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; }) .map(Response::body) .subscribe( token -&gt; { storageManager.writeToken(token); onSuccess.call(token); }, e -&gt; { onFailure.call(e); subscription.unsubscribe(); }, () -&gt; subscription.unsubscribe() ); } <span class="hljs-comment"><span class="hljs-comment">/** Refreshes expired token * Caches the token if the response code is equals to HTTP_OK */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">refreshToken</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Token expiredToken, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Action1&lt;Token&gt; onSuccess, Action1&lt;Integer&gt; onHttpError, Action1&lt;Throwable&gt; onFailure)</span></span></span><span class="hljs-function"> </span></span>{ subscription = OAuth2.Factory.buildOAuth2API(<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>) .refreshToken( tenantType, clientId, GRANT_TYPE_REFRESH_TOKEN, expiredToken.getResource(), expiredToken.getRefreshToken(), redirectUri ) .subscribeOn(Schedulers.io()) .observeOn(AndroidSchedulers.mainThread()) .filter(response -&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(response.code() != HTTP_OK) { onHttpError.call(response.code()); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; }) .map(Response::body) .subscribe( token -&gt; { storageManager.writeToken(token); onSuccess.call(token); }, e -&gt; { onFailure.call(e); subscription.unsubscribe(); }, () -&gt; subscription.unsubscribe() ); } }</code> </pre><br></div></div><br>  That's it, the full authorization library is ready.  It is easily customizable, and, most importantly, it works! <br><br>  A small note - in case you want to use WebView in the dialogue - be sure to set a specific height for it, because otherwise it will simply have a zero height. <br><br>  The article was written based on my coursework, which I am doing at the moment, due to the fact that I am waiting for me to be given an Azure AD account in which you can delegate the permissions necessary for the further work to applications.  In the future there will be a few more articles devoted to working with the OneNote for Business API (mainly with the classNotebooks section of their api). <br><br>  That's all.  I would be grateful for constructive criticism, and I will also be happy to answer your questions. </div><p>Source: <a href="https://habr.com/ru/post/313454/">https://habr.com/ru/post/313454/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../313442/index.html">Caller ID in a virtual PBX: there, here and back</a></li>
<li><a href="../313444/index.html">Mirai botnet was used for powerful DDoS attacks on Dyn</a></li>
<li><a href="../313448/index.html">Useful details in the data center: Wi-Fi IP KVM</a></li>
<li><a href="../313450/index.html">A person. C ++ Creator Bjarne Straustrup, who ‚Äúnever loved‚Äù programming languages</a></li>
<li><a href="../313452/index.html">Pigeons brutalize Monty Hall's paradox better than people.</a></li>
<li><a href="../313456/index.html">How to improve the process of finding a new job? Inside view</a></li>
<li><a href="../313458/index.html">We invite you to the II International GDG DevFest 2016 in Nizhny Novgorod</a></li>
<li><a href="../313460/index.html">Danger and Security - Virtual Arms Race</a></li>
<li><a href="../313464/index.html">ODBC Firebird Postgresql, execution of requests in Powershell</a></li>
<li><a href="../313466/index.html">The opening of a mobile development studio from scratch in St. Petersburg - 3.5 years later. Reincarnation. Part 1</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>