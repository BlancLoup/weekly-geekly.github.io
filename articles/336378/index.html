<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Minimal value types</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This article is a translation of a specification that describes the minimum implementation of value types in Java, which has been eagerly awaited for ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Minimal value types</h1><div class="post__text post__text-html js-mediator-article"><p>  This article is a translation of a <a href="http://cr.openjdk.java.net/~jrose/values/shady-values.html">specification</a> that describes the minimum implementation of value types in Java, which has been eagerly awaited for several years.  Welcome to MVT! </p><br><h1 id="zamechaniya-k-perevodu">  Notes on translation </h1><br><p>  This text is intended primarily for developers of the Java platform.  We even argued a bit with the developers: how interesting could such a text be to the general public?  There are too many extraneous, very precise details about internal magic. </p><a name="habracut"></a><br><p>  To make it clearer, we will talk about including the <a href="https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-4.html">class file format</a> and <a href="https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-6.html">the JVM instruction set</a> , and these web pages may well have to be kept in front of your eyes in order not to get lost in the text.  Personally, Vladimir Ivanov and his reports helped me to deal with this (for such cases there are discussion zones at <a href="https://jokerconf.com/">the Joker conference</a> ). </p><br><p>  But let's take a look at it from the other side.  In the Russian-speaking community, there is a tendency to view Java as a kind of bloody ideal of the enterprise, unchanging, unbreakable, and staying in an unbroken stagnation almost from its very appearance.  Legend has it that the most fun happens in JavaScript and so on, and the share of java accounts for boring Legacy tinkering.  A real hacker absolutely can‚Äôt find anything worthy of applying his extraordinary abilities. </p><br><p>  There is a community, a kind of common culture, consisting of experienced programmers and network wizards, whose history can be traced back to the first time-sharing minicomputers and the earliest experiments with the ARPAnet network.  The members of this culture gave birth to the term ‚Äúhacker‚Äù.  Hackers have created the Internet.  Hackers have made the Unix operating system what it is today.  Hackers created Java and JVM. </p><br><p>  It should be clearly understood that the modern hacker world is not limited to marginal tasks in (yet / already) unknown languages, and hacking of the FBI site as in the movie Swordfish.  Sometimes graceful tasks that require a lot of strength and talent appear in such well-known things as the Java platform - in the things about which they write notes on Habr√© today, and tomorrow half of the world will use them.  Sometimes you look at a piece of Java code and you are amazed - what unknown logic led to such a sophisticated technical solution.  <em>Well, here it is, this logic</em> is described in the following text. </p><br><p>  This is an article for Java developers.  But it can and should be read today to catch the moment.  <strong>Because tomorrow everything will change</strong> . </p><br><p>  <em><strong>Note</strong></em> : it is already being updated, right now!  <em>Pot, do not boil!</em>  Updates based on data from the JVM Language Summit and the most recent developments will be presented in the following articles.  Most likely, in the same place we will write a certain review article, giving a top-level, more practical, understanding of MVT.  If you need such an article, please write about it in the comments. </p><br><h1 id="vvedenie">  Introduction </h1><br><p>  Three years ago we published the <a href="http://cr.openjdk.java.net/~jrose/values/values.html">first version of this document</a> in open access.  Three years of <a href="http://mail.openjdk.java.net/pipermail/valhalla-dev/">heated discussions</a> and violent prototyping of the Java compiler, class-file format and virtual machine.  The goal was to integrate primitives, references, and values ‚Äã‚Äãinto a common platform that would support efficient generalized object-oriented programming. </p><br><p> Much of the discussion focused on the <a href="http://www.oracle.com/technetwork/java/jvmls2015-goetz-2637900.pdf">specialization of generics</a> as a way to implement full parametric polymorphism in Java and JVM.  We concentrated on this on purpose, and it bore fruit: it helped to find situations where primitives are not combined with links, which, in turn, forced us to expand the bytecode model.  Having dealt with <code>List&lt;int&gt;</code> , it was already much easier to go to <code>List&lt;Complex&lt;int&gt;&gt;</code> . </p><br><p>  The remaining discussions focused on the <a href="http://mail.openjdk.java.net/pipermail/valhalla-spec-experts/2016-April/000118.html">development of semantics</a> and on specific tactics for <a href="http://mail.openjdk.java.net/pipermail/valhalla-dev/2016-June/001981.html">implementing</a> new bytecodes that can work with values.  In several experiments, APIs were implemented that were similar to what was needed and which did useful things such as <a href="http://youtu.be/Z2XgO1H6xPM%3Flist%3DPLX8CzqL3ArzUY6rQAQTwI_jKvqJxrRrP_">looping vectorization</a> . </p><br><p>  Returning from the past to the present, at the JVM Language Summit (2016), and at the Valhalla EG meeting, we were asked many times to provide an ‚Äúearly access‚Äù build that could be played with vectorization, GPU and Panama.  This document schematically shows which subset of JVM experimental features (and to a lesser extent, language and libraries) are suitable for the first experiments with value types. </p><br><p>  Looking back, it makes sense to assess the scale of the task: thousands of engineering-hours devoted to working out the bright future in which we live now.  Now is the best time to use this in <em>and out</em> and, finally, choose the first option, something like ‚Äúhello world‚Äù for a type-value system. </p><br><p>  This document offers a minimal, but still sufficiently working, subset of the functionality of value types to achieve the following goals: </p><br><ul><li>  Must simply be implemented in HotSpot JVM (in the reference implementation) </li><li>  There should be no significant restrictions on the subsequent development of the Java language or virtual machine </li><li>  Advanced users must cope with use for experiments and prototyping. </li><li>  The class-file format should change as little as possible. </li><li>  The use of such changes should be strictly limited to experimental zones only. </li><li>  Users should be able to develop using standard toolchains. </li></ul><br><p>  In addition to the goals, we definitely will not: </p><br><ul><li>  To implement absolutely all well-suited language type constructions </li><li>  Modify Java language syntax and overall bytecode design. </li><li>  Add the ability to use value types in Java code </li><li>  Approve final bytecode format </li><li>  Spread it all for general use (not at the start, not at all, most likely) </li><li>  Require developers participating in the experiment, vertical update toolchain </li></ul><br><p>  In other words, before retrieving our value types to the light of day, we have to create their prototype in a certain gray zone, on the border between daily discussions and the release of public specification.  Such a prototype, even if very limited, would be very useful.  It will allow to experiment with various approaches to the design and implementation of value types.  Approaches that have not proven their viability can always be thrown away - this is just a prototype!  Also, as soon as advanced users begin to experiment, we can make more accurate estimates of performance and usability. </p><br><h1 id="funkcionalnost">  Functionality </h1><br><p>  Specific functionality for our minimal (but still working) support for value types can be formulated as follows: </p><br><ul><li>  Several special value-capable classes (abbreviated as VCC. <code>Int128</code> , etc.), each of which a virtual machine can associate with its derived value type </li><li>  Descriptor Syntax (‚ÄúQ-types‚Äù) to describe new types of values ‚Äã‚Äãin class files </li><li>  Constant Pool Update - the ability to interact with these descriptors. </li><li>  A small set of bytecode instructions ( <code>vload</code> , etc.) for moving between JVM local variables and the stack </li><li>  Limited reflection for value types (similar to <code>int.class</code> ) </li><li>  Boxing and anboxing, allowing to express values ‚Äã‚Äã(as primitives) in terms of the javasky universal type Object </li><li>  Factories referring to methods that provide access to value operations (access to members, etc.) </li></ul><br><p>  Special value-capable classes that support value types can be developed in modern toolchains as <em>standard POJOs</em> .  Then, the usual Java source code, including generic classes and methods, can only access values ‚Äã‚Äãin their boxed form.  At the same time, references to methods and a specially generated byte code can work with values ‚Äã‚Äãin their original, non-box form. </p><br><p>  This job is for JVM, not language.  Therefore, we are <strong>not</strong> going to do the following: </p><br><ul><li>  Syntax to define or use value types directly from Java code </li><li>  Specialized generics in Java code that can store non-box values ‚Äã‚Äã(or primitives) </li><li>  Library Value Types or Evolved Value Classes of Type <code>java.util.Optional</code> </li><li>  Access to values ‚Äã‚Äãfrom arbitrary modules.  (In a normal situation, special value-capable classes should not be exported). </li></ul><br><p>  While the slogan <em>"looks like a class, works like an int"</em> expresses our common vision of value types, this minimal set of functionality will provide something like <em>"it works as an int if you can catch it in boxing or a link</em> . <em>"</em> </p><br><p>  We have limited the scope of this work specifically so that useful experiments on the product JVM can be started much earlier than if we rolled out the entire functionality stack of value types at once. </p><br><p>  Support for new functionality at the JVM level will instantly prototype new language features and tools that directly use these features.  But the minimal project <em>does not depend</em> on such features of the language and tools. </p><br><h1 id="klassy-vcc">  VCC Classes </h1><br><p>  A class can be marked with a special annotation <code>@DeriveValueType</code> (or, perhaps, an attribute).  The class so marked is called the <em>value-capable class</em> (abbreviated <em>VCC</em> ).  This means that in addition to its own type, this class can be assigned to the <em>derived value type</em> ( <em>derived value type</em> , or abbreviated <em>DVT</em> ). </p><br><p>  The use of the annotation will be somehow limited, for example, it can be unlocked only using the command line options, associating it with some <a href="http://openjdk.java.net/jeps/11">module of the incubator</a> . </p><br><p>  Example: </p><br><pre> <code class="hljs java"><span class="hljs-meta"><span class="hljs-meta">@jvm</span></span>.internal.value.DeriveValueType <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DoubleComplex</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> re, im; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DoubleComplex</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">double</span></span></span></span><span class="hljs-function"><span class="hljs-params"> re, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">double</span></span></span></span><span class="hljs-function"><span class="hljs-params"> im)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.re = re; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.im = im; } ... <span class="hljs-comment"><span class="hljs-comment">// toString/equals/hashCode, accessors, math functions, etc. }</span></span></code> </pre> <br><p>  The semantics of the marked class will be the same as if the annotation had not been affixed.  But this annotation will allow the JVM, in addition to everything else, to try using the marked class as the source for the associated derived value type. </p><br><p>  The superclass of this VCC must be <code>Object</code> (there was a similar requirement in the full set of functionality, in which superclasses were prohibited). </p><br><p>  A class labeled as VCC must meet the requirements for <a href="http://docs.oracle.com/javase/8/docs/api/java/lang/doc-files/ValueBased.html">value-based classes</a> , since its instances will be used as boxes for the values ‚Äã‚Äãof the associated value type.  In particular, a class and all its fields must be marked as <code>final</code> , and the constructor must be private. </p><br><p>  A class marked as VCC must not use any methods provided from <code>Object</code> on all its instances, since  Such use would lead to uncertain consequences of operations on the box version.  The <code>equals</code> , <code>hashCode</code> and <code>toString</code> methods must be completely replaced without attempting to call <code>Object</code> using <code>super</code> . </p><br><p>  As an exception, you can freely use the <code>getClass</code> method;  it behaves as if it were replaced in VCC with a method that returns a constant. </p><br><p>  Like all value-based classes, the remaining methods ( <code>clone</code> , <code>finalize</code> , <code>wait</code> , <code>notify</code> and <code>notifyAll</code> ) should not be used either.  This feature we put on the user, he must achieve this manually.  In the full version of the functionality, we will try to find ways to achieve the same automatically. <br>  Summarizing, the JVM will do the following structural checks against the VCC: </p><br><ul><li>  Class must be marked as <code>final</code> </li><li>  The class must be the correct class (not the interface) </li><li>  Superclass must be <code>Object</code> </li><li>  All non-static fields are marked as <code>final</code> </li><li>  The following <code>Object</code> methods must be redefined: <code>equals</code> , <code>hashCode</code> , <code>toString</code> </li><li>  The following <code>Object</code> methods should not be overridden: <code>clone</code> , <code>finalize</code> </li></ul><br><p>  These structural checks are performed when the JVM creates a DVT from VCC.  The phases of this process are described below. </p><br><p>  In addition to the limitations described above, VCC can do everything that ordinary value-based classes do.  For example, the definition of constructors, methods, fields and nested types, the implementation of interfaces, the definition of type variables on themselves or on methods.  There are no special restrictions on field types. </p><br><p>  As we will see later, derived value types contain <em>only fields</em> .  They will contain the same set of fields as the VCC from which they are derived.  But the JVM will not add methods, constructors, nested types or super-types to them.  (In the full set of functionality, of course, value types will be "encoded as classes" and support all these features). </p><br><p>  <strong>Note</strong> : VCCs that are compiled using the standard javac compiler will not be able to define nested fields (more precisely, ‚Äúinline sub-value‚Äù), which themselves are value types.  The maximum that can be done is to enter fields with their associated reference types ("L-types").  An updated version of Java will be able to declare such sub-values ‚Äã‚Äãimmediately as real "Q-types".  This javac version will give developers the ability to work with value types directly, without using focus to create a separate derived value type from VCC.  Therefore, if you see a field in VCC that is typed as VCC by itself, this is most likely an error, as it will lead to unintended boxing of the sub-value. </p><br><p>  Here is a slightly more detailed example of a VCC that describes a super-large long: </p><br><pre> <code class="hljs java"><span class="hljs-meta"><span class="hljs-meta">@DeriveValueType</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Int128</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Comparable</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Int128</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> x0, x1; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Int128</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params"> x0, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params"> x1)</span></span></span><span class="hljs-function"> </span></span>{ ... } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> Int128 </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">zero</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ ... } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> Int128 </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">from</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> x)</span></span></span><span class="hljs-function"> </span></span>{ ... } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> Int128 </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">from</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params"> x)</span></span></span><span class="hljs-function"> </span></span>{ ... } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> Int128 </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">from</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params"> hi, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params"> lo)</span></span></span><span class="hljs-function"> </span></span>{ ... } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">long</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">high</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Int128 i)</span></span></span><span class="hljs-function"> </span></span>{ ... } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">long</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">low</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Int128 i)</span></span></span><span class="hljs-function"> </span></span>{ ... } <span class="hljs-comment"><span class="hljs-comment">// possibly array input/output methods public static boolean equals(Int128 a, Int128 b) { ... } public static int hashCode(Int128 a) { ... } public static String toString(Int128 a) { ... } public static Int128 plus(Int128 a, Int128 b) { ... } public static Int128 minus(Int128 a, Int128 b) { ... } // more arithmetic ops, bit-shift ops public int compareTo(Int128 i) { ... } public boolean equals(Int128 i) { ... } public int hashCode() { ... } public boolean equals(Object x) { ... } public String toString() { ... } }</span></span></code> </pre> <br><p>  <a href="">Similar types were</a> used in the prototype of vectoring cycles.  This example is contained in the java.lang prototype package.  But those VCCs that are described in this minimal document will <em>not</em> be included in any public API.  Their visibility will be strictly limited, for example, by a system of modules. </p><br><p>  <strong>Note</strong> : first of all, VCCs will appear to extend numeric types, for example, <code>long</code> .  Therefore, they must immediately follow some standard and have a consistent set of arithmetic and bit operations.  Sooner or later, you will need to create a set of interfaces that express the general structure of operations for numerical primitives and numeric values. </p><br><h2 id="tip-znachenie-i-tip-obekt">  Type-value and type-object </h2><br><p>  When a JVM loads a VCC, it can either aggressively create a derived type-value, or vice versa, set a flag on the class that indicates that the value-type should be created on demand.  (It is recommended to use the second method). </p><br><p>  <strong>Note: the</strong> minimum set of functionality may not consider this order and leave it undefined.  As for the full version, the question is controversial, because  derived type values ‚Äã‚Äãand VCC are identical in it. </p><br><p>  The VCC itself does not change at all during the boot phase.  It remains the usual POJO for the value-based class. </p><br><p>  The corresponding type-value is created as a copy of this class, but with the following critical changes: </p><br><ul><li>  Derived type-value is marked accordingly (as "value-type") </li><li>  The derived value type is assigned a new name, derived from the original VCC </li><li>  All super types of the original VCC are erased. </li><li>  Non-static fields of the original VCC are transferred unchanged. </li></ul><br><p>  The name given to DVT is hidden inside the implementation.  Instead, the name VCC is used to designate both types, and it is argued that there is always enough information to resolve uncertainty.  In bytecode descriptors, the letters <code>Q</code> and <code>L</code> are used to reflect this difference, we denote VCC as Q-type and DVT as L-type. </p><br><p>  DVT creation should occur at some point after VCC loading, but before the first DVT instance is created.  This is controlled by the semantics of those specific instructions that trigger the initialization of DVT in exactly the same way as the formerly existing instructions (such as <code>getstatic</code> or <code>new</code> ) trigger the initialization of normal classes.  Details will be described below. </p><br><p>  Let's start again with the <code>DoubleComplex</code> class <code>DoubleComplex</code> : </p><br><pre> <code class="hljs java"><span class="hljs-meta"><span class="hljs-meta">@jvm</span></span>.internal.value.DeriveValueType <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DoubleComplex</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> re, im; ... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">double</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">realPart</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> re; } }</code> </pre> <br><p>  When the JVM decides to synthesize the derived value type for the <code>DobuleComplex</code> type, it makes a fresh copy, cutting out all the class members except the <code>double</code> fields.  It is important to note that, in order to transform a synthetic class into a value-type, the JVM uses not just the type-object, but special internal magic. </p><br><p>  Inside the JVM, the resulting type-value will look something like this: </p><br><pre> <code class="hljs java"><span class="hljs-meta"><span class="hljs-meta">@jvm</span></span>.internal.value.DeriveValueType <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">L</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DoubleComplex</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> re, im; ... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">double</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">realPart</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $value.re; } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> __ByValue <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Q</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DoubleComplex</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> re, im; }</code> </pre> <br><p>  The hypothetical keyword <code>__ByValue</code> indicates that instead of references, values ‚Äã‚Äãare determined.  Until we seriously improve the whole stack, such things cannot be directly written in the source code, but it is reasonable and useful to do this at the class loading stage. </p><br><p>  Notice that the derived type value has no constructors.  This would normally be a problem, since the JVM requires that the class has at least one constructor.  But in this case, the JVM resolves this because it knows about the value types.  (Such a restriction is not necessary if we talk about meanings in general - <em>but this story is too long to fit it here in the margin notes</em> ).  In any case, the derived value type will borrow the constructors of its VCC, as we will see in the next section. </p><br><p>  <strong>Note</strong> : this design can be called "box-first", the design based on boxing.  The point is that the JVM loads only boxes, and the value type is created as a side effect of the load.  In the end, we come to this design when the values ‚Äã‚Äãthemselves become the starting point of the design, but the current box-first design imposes far fewer restrictions on the tools used to read and write class files, including JVM and javac.  Therefore, despite some oddity, this box-first design is currently the best solution. </p><br><h2 id="boksing-anboksing-i-zaimstvovaniya">  Boxing, anboxing and borrowing </h2><br><p>  Under the hood of a JVM, for converting between VCC and value type, boxing and anboxing operations are arranged.  The semantics of these operations is simple bit-wise copying between them.  It is obviously well defined, so the list of fields is identical. </p><br><p>  A synthetic anboxing operation allows derived value types to contact the constructors of their VCC, though not directly.  Using the constructor, the programmer can make the box, and unpack it to get the constructed value.  The JVM just copies the fields from inside this box, and then the box is erased.  (In the full version, types-values ‚Äã‚Äãcan have real designers, they will not need to borrow anything from their boxes). </p><br><p>  Also, synthetic anboxing operation allows value types to access VCC methods.  In the same way, a programmer can temporarily go to a value, and call on him any methods from the VCC, and throw out the box as soon as the method is completed.  Since the boxes are short-lived, most likely, the JVM will be able to optimize or throw them away, at least for simple methods.  (In the full version, value types can have real methods, they will not need to borrow anything from boxes. On the contrary, boxes will be able to borrow methods from values). </p><br><p>  Notice that the synthetic boxing operation creates a new instance of VCC <em>without performing a constructor</em> .  Normally this would be a problem, but in this case, these two classes are so strongly connected that it is safe to assume that any values ‚Äã‚Äãwill be created (first of all) using the well-designed boxing anboxing.  The boxing and anboxing pattern is very similar to the serialization and deserialization pattern.  In both patterns, the second action overrides the normal creation of the object. </p><br><p>  The synthetic anboxing operation also allows the derived value type to use the interfaces of its VCC, but not directly.  Again, if the derived type-value is transferred somewhere where the interface is needed, the developer can simply box it and pass the link to the box.  (In the full version, we want to give the value to work directly with the interfaces so that no boxing developer can be seen. This will require careful work on the interaction of values ‚Äã‚Äãand interfaces). </p><br><p>  Finally, since static methods and fields are not copied into a derived type-value, the programmer can access them only through VCC, that is, through boxing. </p><br><h1 id="deskriptory-znacheniy">  Value descriptors </h1><br><p>  When using value-capable modules (VCM), the class-file description language is extended by Q-types, which directly denote value-types (without boxing).  Descriptor Syntax: <code>QBinaryName;</code>  where <code>BinaryName</code> is the internal form of the VCC name (the internal form is different in that all the slashes in it are replaced by dots).  In fact, the class name is derived from the name of the corresponding VCC. </p><br><p>  For comparison, the standard reference type descriptor is called the L-type.   C  VCC,     Q-,  L-. ,   L-      Q-. ,        , ,   . </p><br><p>  Q-       ,   VCM.            ( <code>CONSTANT_Fieldref</code> )    (  VCM!),             <code>getfield</code> . </p><br><p> ( <strong>:</strong>    ,  ,      ,   ,    .   ,       .) </p><br><p>  Q-       ,  VCM ( ,     VCM,   ,      -. <strong>   </strong>   ,       ).     ,     ,            . </p><br><p>   Q-  <em> -</em>   -,   <code>null</code> .   - (  ,  )     -   .          ,    <code>MethodHandles.empty</code> . </p><br><p> ( ,       -   <code>null</code> , <code>false</code> , <code>\0</code>  <code>0.0</code> .     Java    ,   .      ,     ,     ). </p><br><p>  Q-            .   ,       ,   Q- (   L-    ). </p><br><p>     ( <code>CONSTANT_Methodref</code>  <code>CONSTANT_InterfaceMethodRef</code> )   Q-  .    ,        ,    ,      Q-. </p><br><p>  ,  <code>CONSTANT_Fieldref</code>   Q-    . </p><br><p> ,   Java       Q-   .   ,          .  ,  Valhalla      ,     Q-    . </p><br><h1 id="instrukcii-i-konstantnyy-pul">     </h1><br><p>   ,   -        ,        ,    Q-,      . </p><br><p>  ,      ,       Q-.           . </p><br><p>  ,       ¬´¬ª  ,      ( <code>L</code>   ;  ).  ,  <code>CONSTANT__Class</code>   ( )    ,          .   ,      ? </p><br><p>    <code>ldc</code>  <code>ldc_w</code> ,    , <code>CONSTANT_Class</code> ,    ,     <code>Class</code>   .  ,     ,  <code>CONSTANT_Dynamic</code> (   <a href="http://bugs.openjdk.java.net/browse/JDK-8177279">JDK-8177279</a> ). </p><br><p>         <code>CONSTANT_Methodref</code>  <code>CONSTANT_Fieldref</code> , <code>CONSTANT_Class</code>      ,  ¬´¬ª  -  ¬´¬ª. ,  <em></em>     ,  ,    Q  L .   ¬´¬ª       <em></em> ,     <code>getfield</code>   L-,  vgetfield ‚Äî  Q-. </p><br><p> ( <strong>:</strong>   ¬´¬ª      ,  JVM          <code>CONSTANT_Fieldref</code> ,     <code>getfield</code>   <code>vgetfield</code> ,     ,         L-   Q-     .       .         JVM,    Q-  L-   ,       .   ,    -    U-). </p><br><p>   API <code>MethodHandles.Lookup</code> ,   Q-  L- ( ,  )     <code>Class</code> ,      API,   <code>Lookup.findGetter</code> .   <code>findGetter</code>     Q-,        .      (L-), , ,       ,       . </p><br><h2 id="ogranicheniya-na-q-rezhim-i-vyzovy-metodov">   Q-    </h2><br><p>      Q- (  Q-),      <code>java.lang.Object</code> ; JVM      ,        .  , Q-    <code>Object</code> .  ,      ,     <code>Object</code> ,    ,   value-based ,        <code>Object</code> . </p><br><p>  ,  <code>Object.getClass</code>   ,       <code>Class</code> ,  VCC. </p><br><p> <strong>:</strong>   ,  <code>getClass</code>   -  ,    .    . </p><br><p>       ,   Q-    <code>vinvoke</code> (  ). </p><br><h2 id="izmeneniya-v-jvm-neobhodimye-dlya-podderzhki-q-tipov">   JVM,    Q- </h2><br><p> Q-,      ,     .  : </p><br><ul><li>     (UTF8    <code>method_info</code>  <code>field_info</code> ) </li><li>      (UTF8   <code>CONSTANT_NameAndType</code> ) </li><li>   (UTF8    <code>CONSTANT_Class</code> ) </li><li>    (   <code>[</code> )    </li><li>   stack map  (     Q-) </li><li>  ( <code>CONSTANT_Class</code> ) -  ( ) </li></ul><br><p> JVM      Q-      . ,      -, ..      . </p><br><p>     Q-       ( ),  ,  ,       -,    (   )  <code>null</code> L-. </p><br><p> ,    ,    Q-,        Q-,       Q-     .     ,        ,   Q-. </p><br><p>  -    ,       -,         . </p><br><p> ( <strong></strong> :      ¬´ ¬ª,         .    <em></em>   - ,     ,    . ,    -     ,  , / -,  ,        ‚Äî     ,   ,     .   <em></em>     .   API,     ,         . <strong> !</strong> ) </p><br><p>  ,    ,     ,      Q-.       L-,    ,  <code>Integer[].class</code>   <code>int[].class</code> .   , -     <code>Object</code> (   <code>int[]</code> ),   -   .           ,             . </p><br><p>   JVM,         <code>new</code> ,    (  ,       -    <code>getstatic</code> ).     -,   ,       -.  -    ,      (        ). </p><br><p>  ,      (  ¬´¬ª)  Q-     Q- ( -)     -,  ,        <em></em> ,  ,    .        ,         :    ( , ),    ( )  <em></em> ,  ¬´¬ª    ,    ,    . (           -).      ,    ,  ,        (   ,   ),     . </p><br><p>    , DVT    ,     . ,      ,   ,    <code>vdefault</code>  <code>vunbox</code> .  DVT   VCC,   DVT ,   ,   VCC. </p><br><p> ,   <code>vunbox</code> ,       ,      VCC,  ,     ‚Äî  DVT  ,      ,       . </p><br><h1 id="baytkody-znacheniy">   </h1><br><p>     : </p><br><ul><li> <code>vload</code>   (Q-)     </li><li> <code>vstore</code>   (Q-)     </li><li> <code>vreturn</code>   (Q-)        </li><li> <code>vbox</code>  <code>vunbox</code>    Q-  L- </li><li> <code>vaload</code>  <code>vastore</code>    ¬´¬ª  Q- </li><li> <code>vdefault</code>     -,     Q- </li><li> <code>vgetfield</code>  Q-   ,   Q- </li><li> <code>vwithfield</code>  Q-   ,    Q- </li></ul><br><p>     ,     ,     <code>long</code>  <code>double</code> (,    ). </p><br><p>    ‚Äî    .       ,    ,    .      <code>CONSTANT_Fieldref</code> . , <code>vbox</code> , <code>vunbox</code>  <code>vdefault</code>      . </p><br><p> JVM    Q-      Q-    ,   ¬´¬ª     .   , JVM        ( value-capable L-,  -     )      . </p><br><p> ,    ,   ,     .    ,   JVM         ¬´-¬ª   -  ,    ,   ¬´¬ª  -,          -   . </p><br><p>    <code>invokevirtual</code> , <code>invokespecial</code>  <code>invokeinterface</code>   Q-,       Q-.   , <code>invokestatic</code>  <code>invokedynamic</code>       Q-,      .     ,   ,   Q-     L-,           Java,     . </p><br><p> ( <strong></strong> :  ,             Q-, .. <code>vinvoke</code> ,         .  U-,  <code>uninvoke</code> ,    U-,          -,     Q-,  L-.       , , -,       ,        ,        ,     .) </p><br><h2 id="vzaimodeystvie-s-verifikatorom">    </h2><br><p>       ,  Q-     ,  ,    Q- ( L-!)      . </p><br><p>    ,      Q-,   Q-     . </p><br><p>    (  ),    Q-  ,  Q-      .  ,      Q-,  Q-      . </p><br><p>        <code>int</code>  <code>float</code> , Q-           ,   - <code>oneWord</code>  <code>top</code> .        ,       . Q-    L-,      - ( <code>Object</code> , )  L-   . </p><br><p>  , <code>vload</code> , <code>vstore</code> , <code>vreturn</code>    <code>invoke</code> ,  ,       Q- ‚Äî  <code>pop</code> , <code>pop2</code> , <code>swap</code> ,    <code>dup</code> .      .     Q-. </p><br><p>  <code>vaload</code>  <code>vastore</code>         .      ¬´-¬ª,       - Q-,    .       . </p><br><p>  <code>vgetfield</code>   ,   <code>getfield</code> .   - -   ,           . </p><br><p>   <code>vwithfield</code>     ,     .       -    .     <code>putfield</code>  final-,    ,     ,    ,     .  VCC  DVT         , JVM   VCC  <code>vwithfield</code>    DVT.  ,     ,   VCC -     <code>vwithfield</code> . </p><br><p> ( <strong></strong> :   -     -,     ‚Äî final.    . JVM ,  <code>putfield</code>    final ,    .  Java  , ,       <em>   </em> ,         .   ,      -,    JVM     ,     <code>vwithfield</code>  .        final ,  <code>vwithfield</code>       .) </p><br><p>  Lookup API  VCC  DVT         ,      nestmates.     <code>vwithfield</code> .  DVT    ,    ,    ,     . </p><br><p> ( <strong></strong> :   JVM    nestmates   VM,           .    JVM,  <code>vwithfield</code>     nestmates   -.  , <code>vwithfield</code>    ¬´¬ª,      ). </p><br><p>  <code>vdefault</code> , ,  ¬´¬ª    -,       .   -   JVM   ,       -   -. ,   ,   ¬´¬ª  <code>vdefault</code> .        -   Q-. </p><br><h2 id="q-tipy-i-baytkody"> Q-   </h2><br><p>       Q-,    : </p><br><ul><li>   :        Q-.  (   <code>Methodref</code> )     ,     </li><li> <code>ldc</code>  <code>ldc_w</code> (Q-,  ,   ) </li><li> <code>anrearray</code> , <code>multianewarray</code>      Q- </li></ul><br><p>        : </p><br><ul><li> <code>getfield</code> , <code>putfield</code> , <code>getstatic</code> , <code>putstatic</code> (  Q-) </li></ul><br><p>  ,  JVM    ,    Q-,          .   , workaround      ,      Q-    . </p><br><p> (,         ,     javac. VCC     Q-,    javac    ). </p><br><h1 id="refleksiya-tipov-znacheniy">  - </h1><br><p>   -,   ,      - , <code>java.lang.Class</code> .   -,   ,   Class-   ¬´  ¬ª.    ‚Äî     <code>int.class</code> ,       .   -,         Class-.  ,  -      ,    Q-,   ‚Äî L-.        <code>int.class</code>  <code>Integer.class</code> ,                  . (  U-,    .        ). </p><br><p>   ,      <em> </em>   <em> </em> ,       .   ,   ¬´¬ª,   ,       .        <em></em>  <em> </em> . </p><br><p> ( <strong></strong> :      ,  ,  <code>Integer.class</code>        <code>int.class</code> . ,      - ,             ). </p><br><p>     -,     ,  Class-  DVT  VCC,    VCC    ,  DVT ‚Äî . </p><br><p>   ,   <code>jdk.experimental.value.ValueType</code> (  )     runtime-  . </p><br><p> <code>ValueType</code>        Q-: </p><br><pre> <code class="hljs java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ValueType</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">classHasValueType</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Class&lt;T&gt; x)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> ValueType&lt;T&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">forClass</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Class&lt;T&gt; x)</span></span></span></span>; <span class="hljs-function"><span class="hljs-function">Class&lt;T&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">valueClass</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-comment"><span class="hljs-comment">// DVT, secondary mirror Class&lt;T&gt; boxClass(); // VCC, principal mirror ... }</span></span></code> </pre> <br><p>  <code>classHasValueType</code>  ,  ,   Q-  VCC ( L-).  <code>forClass</code>   Q-   ,   VCC. (       <code>IllegalArgumentException</code> .    ,     <code>classHasValueType</code> ). </p><br><p>   <code>valueClass</code>  <code>boxClass</code> , ,     <code>java.lang.Class</code>  Q-,   (VCC) L-. </p><br><p>    <code>ValueType.forClass(vt.valueClass())</code>   <code>vt</code> ,     <code>boxClass</code> . ,  Class -        <code>ValueType</code> . </p><br><p>   <code>Class.forName</code>   <code>boxClass</code> ,   .     ,    . ( ,   <code>T.class</code>      -    ,  <code>T</code> ,    ¬´  <code>int</code> ¬ª. </p><br><p>   Q-        ,   <code>getDeclaredMethods</code> .    ,  DVT,   VCC,      .  ,     ,  . </p><br><p>   ,    -,      VCC ( <code>boxClass</code> ). (   ,     ).    ,   VCC      POJO,  DVT      . </p><br><p>    Q-      API   ,    - ( <code>int.class</code> ).  API      ( <code>Class</code>    <code>java.lang.reflect</code> ),    API  <code>java.lang.invoke</code> ,   <code>MethodType</code>  <code>MethodHandles.Lookup</code> .   ,     ,    Q-   ,   L-,        <code>Class</code> . </p><br><p> (    ,    ¬´crass¬ª ‚Äî ¬´¬ª.     ,           .   ‚Äî  ,   <code>Class.forName</code> ,         .   , ¬´¬ª ‚Äî    ,      <code>java.lang.Class</code> . <a href="http://cr.openjdk.java.net/~mcimadamore/reflection-manifesto.html">  </a>    ¬´ ¬ª       ). </p><br><p>  , API         ,    ,        .  Q- ,   ,      ,  JVM       ,      . </p><br><p> ,     (  <code>asType</code> )      -   ,         . ,      ,    <code>DobuleComplex</code>   : </p><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">Class</span></span>&lt;DoubleComplex&gt; srcType = DoubleComplex.<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">Class</span></span>&lt;DoubleComplex&gt; qt = ValueType.forClass(srcType).valueClass(); MethodHandle mh = <span class="hljs-keyword"><span class="hljs-keyword">identity</span></span>(qt).asType(methodType(<span class="hljs-keyword"><span class="hljs-keyword">Object</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>, qt));</code> </pre> <br><p> ,   <code>MethodHandle.invoke</code>          Q-:     ,         Java,  (  )  ,   Q-. </p><br><h1 id="boksovye-znacheniya">   </h1><br><p>       Q-  API,       <code>Object</code>   -  .   (  , ,  - <code>println</code> ),      <code>Object</code> ,      . VCC L-  Q- (,            Q-)        ,  ,  ,     . </p><br><p>    ,  VCC (  L-),          Q-. API         -,       ,       . </p><br><p> VCC L-         Q-,  <code>toString</code> ‚Äî       Java    L-.               ( <code>this</code> ),          (HotSpot JVM      ,     ). </p><br><p>  ,           ,      . ,      ,    ,      <code>println</code> . </p><br><p>   VCC  value-based,      ,  -     ,    ,    null   . </p><br><p> ( <em></em> :  ,  ,   ,       ). </p><br><p>   JVM <em></em>    (  )    ,       ,      (     escape analysis). </p><br><p>   ,            . ,    Q- ,    ,     ,  Q- , ,     null. </p><br><h1 id="fabriki-znacheniy">   </h1><br><p>      ,    Q-,    ()        .  : </p><br><ul><li>   (  ) </li><li>   -  Q- </li><li>  Q- </li><li>  Q- </li><li>  ,   Q- </li><li>   Q- </li><li>   Q- </li><li>     (  ),  Q- </li><li> ,     Q- </li></ul><br><p> <code>MethodHandles.Lookup</code>  API <code>MethodHandles</code>    Q- (  Class-),   ,       . </p><br><p> ( <strong>:</strong>          .      <code>invokedynamic</code> ,    ,    .   ,      ¬´¬ª      JVM,    <code>invokedynamic</code>   ). </p><br><p>  API        : </p><br><ul><li>  <code>MethodType</code>    <code>Class</code> ,  Q-,   ,      . </li><li> <code>invoke</code> , <code>asType</code>  <code>explicitCastArguments</code>     Q-/L-  ,      /. </li><li> <code>Lookup.in</code>       Q-/L- (   ) </li><li>    Q-     ,      Q- (  L-) </li><li> <code>Lookup.findVirtual</code>      Q-,     Q-. </li><li> <code>Lookup.findConstructor</code>      VCC,   Q-,     L-.      ,   <code>findConstructor</code>    ,     Q-. </li><li>  <code>findVirtual</code>  <code>findConstructor</code>    ad-hoc pattern matching ( <em> !</em> )     <code>private static</code> ,   L-,           Q-. (   ,          L-). </li><li>  <code>identity</code>   Q- </li><li>  <code>empty</code>   Q-,     ,    -   . </li><li>  ,   ,   Q-,    ,     Q-. ( <code>arrayConstructor</code> , <code>arrayLength</code> , <code>arrayElementGetter</code> , and <code>arrayElementSetter</code> ,    var-handle.  ,        ,       ). </li><li>       ,    Q-,   ,       . </li></ul><br><p> ( <strong>:</strong> ,  -,    <code>findVirtual</code> ,   ,      final .    ‚Äî    <code>findSpecial</code> ,    API <code>findDirect</code> ,  ,   .   Java     ¬´final virtual¬ª ,  -    .) </p><br><p>      L-,  ,    ,   ,  (     )     L-   ,          ,     -. ,   L-,     ,     L-,   Q-. </p><br><p>   ,   ,        private static  L-,     ,          Q-.            ,   JVM   .  ,       ,     ,  <em></em>   Q-.   ,            JVM. </p><br><p>    value-based , VCC       <code>Object</code> .  Q- <em></em> ,       <code>Object</code> .      ,         (,    <code>toString</code> ). </p><br><p>  ,     , ( <em>  </em> )    API <code>MethodHandle</code> ,       <code>jdk.experimental.value.ValueType</code> . </p><br><p> <code>ValueType</code>    : </p><br><pre> <code class="hljs cpp"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ValueType</span></span></span><span class="hljs-class">&lt;T&gt; {</span></span> ... <span class="hljs-function"><span class="hljs-function">MethodHandle </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">defaultValueConstant</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-function">MethodHandle </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">substitutabilityTest</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-function">MethodHandle </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">substitutabilityHashCode</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-function">MethodHandle </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">findWither</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Lookup lookup, Class&lt;?&gt; refc, String name, Class&lt;?&gt; type)</span></span></span></span>; }</code> </pre> <br><p>  <code>defaultValueConstant</code>    ,    ,    -   Q-.   ( ,   )        -    . </p><br><p>  <code>substitutabilityTest</code>    ,      Q-        ().  ,      ,        .         ,         <code>==</code>  Java, <em></em>    float  double,     ¬´ ¬ª,    . </p><br><p>  ,  <code>substitutabilityHashCode</code>    ,     ,     Q-,   -,        ,   ,     -   . </p><br><p> (   ,      -  64 .  ,        32-  -  -,    -.  -, ,      base-31 ,    ,      ). </p><br><p>  <code>findWither</code>   <code>Lookup.findSetter</code> ,   ,         ,    ,   ,        .       ,  ‚Äî       . </p><br><p>     ¬´wither¬ª ,  <code>refc</code>       Q-  <code>ValueType</code> .          Q-,   .       . - , ,   winther-   ,     .   ,     <code>withfield</code> ,        ,            . </p><br><p> (  <em>wither</em>   ¬´¬ª  ¬´¬ª -,       .       ,      .     <code>c.withRe(0)</code> ,     ,   .    , <code>c.setRe(0)</code> , ..  <em></em> ,    ,       . -     ,     wither-    . ,  ,   ,    ,  ,  wither',             (get, set, wither).    -   ,    <code>withRe(0)</code>    <code>re(0)</code> ). </p><br><p>  ,     <code>ValueType</code>      <code>Lookup</code> ,    <code>MethodHandles</code> ,     . </p><br><p>           ,           <a href="http://docs.oracle.com/javase/8/docs/api/java/lang/invoke/MethodHandles.Lookup.html"> </a>  . </p><br><p>   ,             -.        ,      .   ,      Q-,      <code>Q</code>  .  <code>QC</code> ,  ,  -,    .   <code>VT&lt;QC&gt;</code>   <code>ValueType</code> ,    Q-. </p><br><p>  <code>RC</code>       Q-   ,   L-. ,  Q- (¬´  int!¬ª)          . </p><br><p>        ,      Q-,         .       ,  <code>findStaticGetter</code> , <code>findStaticSetter</code> , <code>findVirtual</code> , <code>findStatic</code> , <code>findStaticSetter</code> , <code>arrayElementSetter</code> , <code>identity</code> , <code>constant</code> , , . </p><br><h1 id="vsyo-eto-skoro-izmenitsya">     </h1><br><p>     API <code>   </code> -  Java. ,     ,        ,    . </p><br><h1 id="dalneyshaya-rabota">  Further work </h1><br><p>   ,    .        ,     .           ,    ,    ,    ,      ,     . </p><br><p>   ,  -,    .   .        ,    ,    ,   ,     . </p><br><h2 id="q-tipy-v-ishodnom-kode-na-yazyke-java"> Q-      Java </h2><br><p>    ,     Q-    .    JVM (VCC),          ‚Äî      -.          ,          Q- (  ). </p><br><p>   ,        .  ,     <code>javac</code>      Q-     ,   Java  (     ). </p><br><p>  ,                -. (   ‚Äî final,          -).    ,  javac            VCC). </p><br><p>   ,   Java       -         -,           <code>invokedynamic</code> ,      . </p><br><h2 id="q-podstanovki-v-vcc"> Q-  VCC </h2><br><p> VCC,     Java,     (  , )     ,     Q-   ,   ,      VCC. </p><br><p>    ,   Q-  Q-.   L-     Q-.    ,   (  )  ,   L-  ,  Q-.        <a href="http://bugs.openjdk.java.net/browse/JDK-8164889">JDK-8164889</a> . </p><br><p>     Q-   ,      ,      Q-      Java.  ,  ,      Valhalla,    ‚Äî    ,      . </p><br><h2 id="esche-bolshe-baytkodov">    </h2><br><ul><li>     <code>defaultValueConstant</code>     <code>vdefault</code> ,   <code>aconst_null</code>  . </li><li>   <code>substitutabilityTest</code>       <code>vcmp</code> ,  <code>if_acmpeq</code>  . </li><li>  <code>findWither</code>       <code>vwithfield</code> . </li><li> <code>findGetter</code>        <code>getfield</code> </li><li> <code>arrayConstructor</code>      <code>anewarray</code>   <code>multianewarray</code> . </li><li> <code>arrayElementGetter</code>     <code>vaload</code> ,  <code>aaload</code>   </li><li> <code>arrayElementSetter</code>     <code>vastore</code>  <code>aastore</code>  . </li><li> <code>arrayLength</code>     <code>arraylength</code> </li></ul><br><p>   ,       :      <em> </em> ( -  ),      ,   ,      ,    Q-.  ¬´ ¬ª    ,  <code>uload</code> , <code>ustore</code> , <code>uinvoke</code> , <code>ucmp</code> , <code>u2u</code> , .       ,       v. </p><br><p>      <code>I</code> ,   JVM    int, short, boolean, char  byte,   <code>L</code> ( )     L-,      <code>Q</code> ( )     K-.  ,    ,  I-  ,  L-    ,  JVM    -,         . (   -  long, float  double). ,   L- ‚Äî    ,   ,    Q-  ,     ,   ¬´¬ª  - ,            ( ,    GC).  ,       .   ,  Q- ‚Äî       ,       ( Java,  C,  ). </p><br><h2 id="bolshe-struktur-dannyh">    </h2><br><p>       -,        .       .  ,     -    .       : </p><br><ul><li>  -     (Q-  L-) </li><li>       - </li><li>       (, <code>volatile</code> ) </li><li>    -  ( ,    ,   JVM,   64- ) </li><li>   (¬´unsafe¬ª)     -  JVM </li><li>  -    ,     (, <code>unsigned</code>  C)  -   (,   +  +  ) </li><li>        . </li><li> -         value-based ,   <code>Integer</code>   Q-. ,       . </li><li>   ,    -. </li><li>       -,   ,  default-  . </li><li>  ,      Q-,   L-. </li><li>       ,    ,   . </li><li>   ,   Q-,  . (    !) </li></ul><br><p>  -     , Q-   <code>default</code> -  .  ‚Äî          (    <code>TreeMap</code> ).   ,      default-  ,         .   ,          -.  ,   ,   ,   default-       - ( ,  null, ,  <code>==</code> , ).       . </p><br><p> ,         <code>QT[]</code> ,    - <code>I[]</code> ,    <code>I</code>    - <code>QT</code> .      JVM, ,    .   <code>I</code>     L-,   ,    ‚Äî   ,    <code>Object[]</code> .   - <code>QT</code>         . </p><br><h2 id="brige-o-matic"> Brige-o-matic </h2><br><p>   ,    API,    Q-      .  ,  ,       -,   ( )    -.            ,     <code>equals</code> , <code>hashCode</code>  <code>toString</code> .        <a href="http://bugs.openjdk.java.net/browse/JDK-8164891">JDK-8164891</a> . </p><br><h2 id="nastoyaschie-jvm-native-klassfayly-tipov-znacheniy">  (JVM-native)  - </h2><br><p>     ,   , ..   POJO          .  ,     POJO,           .  ,       -,       POJO. </p><br><p>     ,     ,     ,         -. </p><br><p>   ,   ,    POJO,  ,       POJO,     -  . </p><br><p>      ,     -   (, , IDE, ).      ,     -.    ,          ,  <em></em>   ,        .    : </p><br><ul><li>   ,     - (  <code>ACC_VALUE</code>  ) </li><li>  Q-        </li><li>      Q-,     Q- </li><li>      Q- </li><li>   -  , ,  </li></ul><br><h2 id="geyzenboksy">  </h2><br><p>    , L-    value-based,   -  JVM    : </p><br><ul><li>   Q-   ,  <code>IllegalMonitorStateException</code> </li><li>   ( <code>==</code>  Java,   <code>acmp</code> )   <code>true</code>      Q-,         . ,        Q-.  ,        ,     . </li><li>          Q-  ,   -  <code>setAccessible</code> . </li><li>          ,   -  <code>setAccessible</code> . </li></ul><br><p> ,         ,  ¬´¬ª.   ,   ( <code>==</code> , <code>acmp</code> )          ,            ,  ,  Q-  .    -     ,     ,        .        ,  ,       ,       ‚Ä¶      <a href="http://bugs.openjdk.java.net/browse/JDK-8163133">JDK-8163133</a> . </p><br><h1 id="avtory">  The authors </h1><br><p>  <strong>John Rose</strong> is a JVM engineer and architect at Oracle.  Lead Engineer Da Vinci Machine Project (part of OpenJDK).  Lead Engineer JSR 292 (Supporting Dynamically Typed Languages ‚Äã‚Äãon the Java Platform), deals with the specification of dynamic calls and related issues such as type profiling and advanced compiler optimizations.  Previously, he worked on inner classes, did the original HotSpot port on SPARC, the Unsafe API, and also developed many dynamic, parallel and hybrid languages, including Common Lisp, Scheme ("esh"), dynamic binding for C ++. </p><br><p> <strong> </strong> ‚Äî Senior Java Language Architect  Oracle,       Java. C  Sun Oracle-      ,  Value Types.     ,         Java,    ,  .        Java Concurrency in Practice.     ,       Java,  , ,   . </p><br><h1 id="perevodchiki">  Translators </h1><br><p>  <strong>Oleg Chirukhin</strong> - at the time of writing this text, he is working as an architect in the company Sberbank-Technologies, developing architecture for automated business process management systems.  Before moving to Sberbank-Technologies, he participated in the development of several state information systems, including state services and the electronic medical map, as well as in the development of online games.  Speaker at <a href="https://jokerconf.com/">JUG.ru conferences</a> (JPoint, JBreak).  Current research interests include virtual machines, compilers, and programming languages. </p><br><h1 id="blagodarnosti">  Thanks </h1><br><p>   <a href="https://jokerconf.com/2017/talks/3k7h62vzooscoysmwkgqo8/"> </a>  <a href="http://2016.jokerconf.com/speakers/vladimir-ivanov/"> </a> ,       .      ,  -     :-) </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/336378/">https://habr.com/ru/post/336378/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../336362/index.html">Barclays Bank installed spyware sensors to track employees in the workplace</a></li>
<li><a href="../336364/index.html">Games for programmers, part two</a></li>
<li><a href="../336368/index.html">Go 1.9 release</a></li>
<li><a href="../336372/index.html">TM visiting Booking.com</a></li>
<li><a href="../336376/index.html">Technical implementation of the new Yota product for smartphones</a></li>
<li><a href="../336380/index.html">A little bit about vpxuser</a></li>
<li><a href="../336382/index.html">The book "Introduction to Drupal 8"</a></li>
<li><a href="../336384/index.html">‚ÄúThe State in the Clouds‚Äù and one GIS example from our practice</a></li>
<li><a href="../336386/index.html">Weather and routes in MajorDoMo</a></li>
<li><a href="../336388/index.html">Welcome to Rust Gamedev Mitap September 14</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>