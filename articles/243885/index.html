<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Deploying IBM Security Network Protection to Open vSwitch</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good day to all habrewers! 

 In this article, you can learn how to configure IBM Security Network Protection (XGS5100) in an Open vSwitch software-co...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Deploying IBM Security Network Protection to Open vSwitch</h1><div class="post__text post__text-html js-mediator-article">  Good day to all habrewers! <br><br>  In this article, you can learn how to configure IBM Security Network Protection (XGS5100) in an Open vSwitch software-configured network (SDN) and protect all your virtual assets. <br><br>  Open vSwitch is an OpenFlow based virtual switch widely used in cloud environments. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Software-defined Networking (SDN) is a cloud deployment technology that provides a scalable and flexible environment suitable for the dynamic nature of this cloud itself. <br><br>  You will learn how to deploy IBM Security Network Protection (ISNP) within an OpenFlow SDN-enabled switch ‚Äî Open vSwitch and see how easy ISNP can be deployed in an SDN environment. <br><img src="https://habrastorage.org/files/dfd/308/b18/dfd308b18c5748e0a5e6d465bd619212.png" alt="image"><br><a name="habracut"></a><br><br><h1>  Software configurable networks </h1><br><br>  SDN is a new architectural approach whose goal is to provide network flexibility suitable for the dynamics of a modern environment.  Existing network technologies are inherently static and difficult to change, since small network changes often require substantial reconfiguration of all, or most, switches, routers, and firewalls.  Not only that <br>  This process takes a lot of time for the administrator and is not solved with the help of one tambourine, it also carries the danger of getting a lot of mistakes. <br><br>  In the software-configured network architecture, there are two levels: <br>  the infrastructure level at which the network switches and data transmission channels operate, and the management level ‚Äî a set of software tools physically separated from the infrastructure level, ensuring the implementation of mechanisms for managing the infrastructure level devices. <br><br>  In traditional networks, the control layer is implemented in data transfer devices, and this implementation is vendor specific. <br>  In SDN, these levels are divided, <br>  management is centralized for all network equipment within the enterprise (regardless of the manufacturer of the equipment).  This architecture provides an easy and fast way to manage traffic flow. <br><br>  Cloud environments require dynamic resource allocation.  Open and private clouds have virtual applications and storage, so the next logical step is network virtualization.  Why not?! <br><br>  SDN provides a platform for network virtualization, which makes it possible to create a fully dynamic environment for storing data, network and applications. <br><br><h1>  Openflow </h1><br><br>  SDN requires the interaction of a centralized management layer with an infrastructure layer (implemented in physical devices).  The OpenFlow protocol from the <a href="https://www.opennetworking.org/index.php%3Flang%3Den">Open Networking Foundation</a> is the SDN protocol that provides this connection.  OpenFlow allows detailed control of traffic on all switches and routers in a network, like <br>  physical and virtual, regardless of software vendor <br>  security <br><br>  Thus, the OpenFlow protocol eliminates the need to configure the device of each vendor separately through its own interface. <br><br><h1>  Open vSwitch </h1><br><br>  Open vSwitch is a virtual switch under the Apache 2.0 license.  It is usually installed on a server to control traffic in the hypervisor, providing a dynamic network environment. <br><br>  Open vSwitch supports a variety of traffic management protocols, including NetFlow, sFlow, SPAN, RSPAN, CLI, 802.1ag, and OpenFlow. <br><br><h1>  ISNP </h1><br><br>  ISNP is a product that combines the functions of an intrusion prevention system and sophisticated application control. <br>  It allows you to control all user activity by analyzing each connection and determining the applications used.  Depending on the reputation of the application, ISNP may allow or block the connection.  ISNP can also record application information, which can be useful for refining policies, including bandwidth. <br><br>  Integrated with other protective functions, the intrusion prevention system provides fast deployment and easy administration. <br><br>  <em>Training</em> <br><br>  We will use 64-bit Ubuntu 12.04 LTS with support until April 2017. We installed Ubuntu on bare metal, not on a virtual machine.  Using bare metal to install a KVM hypervisor gives good performance for the VM. <br><br>  The server must have at least three network interfaces: one for remote access, and two for connecting to <br>  ISNP directly to the protection ports (as shown in Figure 1). <br><br>  Pic1 <br><img src="https://habrastorage.org/files/1ce/142/798/1ce142798d574b7a8810f1409f22277c.png" alt="image"><br><br><h1>  Configuring KVM Hypervisor </h1><br><br>  A virtual machine (KVM) is a virtualization infrastructure for the Linux kernel, and turns it into a hypervisor. <br>  Before you install Ubuntu, activate the <a href="http://software.intel.com/en-us/blogs/2009/02/24/step-by-step-guide-on-how-to-enable-vt-d-and-perform-direct-device-assignment/">VT-d</a> command set in the CPU, in the BIOS settings, <br><br>  The recommended distribution is Ubuntu 12.04 LTS. <br><br>  After booting the system to your hard drive, you will be prompted to select additional components of Ubuntu out of the box. <br><br>  In the <em>software selection</em> section, select <em>Virtual Machine host</em> and <em>OpenSSH server.</em> <br><br>  Pic2 <br><img src="https://habrastorage.org/files/416/4b6/b5a/4164b6b5a99146c19b182b6262191cfb.png" alt="image"><br><br>  For me, as well as for all unexpectedly blinded or missing the right line, or for some reason who forgot to choose <em>Virtual Machine host</em> , it is possible to install the necessary KVM components using the following command: <em># sudo apt-get install qemu-kvm libvirt- bin.</em> <br><br>  To complete the installation of the KVM hypervisor, follow these steps: <br><br><ol><li>  Make sure the system distribution is updated: <em># sudo apt-get update &amp;&amp; apt-get dist-upgrade</em> </li><li>  Make sure your processor supports KVM: # <em>sudo kvm-ok.</em> </li><li>  Ensure that the VT-d function is activated in the BIOS and that your processor is not too ‚Äúold‚Äù to work with KVM. </li><li>  Add a user to the kvm group: <em># sudo gpasswd -a $ USER kvm</em> </li><li>  Add a user to the libvirtd group: <em># sudo gpasswd -a $ USER libvirtd</em> </li></ol><br><br>  Then, enter <em>/etc/libvirt/qemu.conf</em> and add the following parameters: <br><br><pre><code class="hljs pgsql"># sudo vi /etc/libvirt/qemu.conf <span class="hljs-keyword"><span class="hljs-keyword">user</span></span> = "root" <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> = "kvm" security_driver = "none" cgroup_device_acl = [ "/dev/null", "/dev/full", "/dev/zero", "/dev/random", "/dev/urandom", "/dev/ptmx", "/dev/kvm", "/dev/kqemu", "/dev/rtc", "/dev/hpet", "/dev/net/tun", ] clear_emulator_capabilities = <span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre> <br><br>  DO NOT FORGET TO EXPAND THE ABOVE SETTINGS (REMOVE # AT THE BEGINNING OF EACH LINE) <br><br>  Restart libvirt-bin to load and install qemu settings: <em># sudo service libvirt-bin restart.</em> <br><br>  If you wish, you can install virt-manager: <em># sudo apt-get install virt-manager.</em>  It is claimed that he has a convenient interface for configuring virtual machines. <br><br><h1>  Configuring Open vSwitch </h1><br><br>  To configure Open vSwitch, you will have to install all the necessary Open vSwitch components ( <a href="http://openvswitch.org/">Open vSwitch 1.4.0 will do</a> ): <br><br><pre> <code class="hljs swift"># sudo apt-<span class="hljs-keyword"><span class="hljs-keyword">get</span></span> install openvswitch-controller openvswitch-<span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> openvswitch-datapath-source openvswitch-datapath-dkms</code> </pre> <br><br>  <em>Note:</em> When installing these packages on the 3.8 kernel, you may encounter some problems, but Ubuntu employees are working hard to solve them while I write the article.  And now about the pleasant - in the kernel 3.8 there is already a native openvswitch module, so there is no need to build it yourself. <br>  As soon as the openvswitch module is loaded, your system will be ready for use right away. <br><br>  Oh yeah, make sure you still download the openvswitch module and you haven't had a dream about it: <em># lsmod |</em>  <em>grep openvswitch.</em>  And if you suddenly want to check whether the <em>ovsdb-server</em> and <em>ovs-vswitchd are running</em> , use this command: <em># sudo service openvswitch-switch status</em> <br><br>  You should see this: <br><pre> <code class="hljs pgsql">ovsdb-<span class="hljs-keyword"><span class="hljs-keyword">server</span></span> <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> running <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> pid xxxx ovs-vswitchd <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> running <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> pid yyyy</code> </pre> <br><br>  Configuring Open vSwitch <br><br>  The next step demonstrates how to configure Open vSwitch and use the eth0 interface as the uplink port <br>  After that, the Virtual Machines will connect to the switch and gain access to the network. <br><br>  To make sure once again that you are ‚Äúsmart,‚Äù your Open vSwitch is ready for use and you did everything correctly, run these commands: <br><br><ol><li>  Make sure you download the Open vSwitch module: <em># lsmod |</em>  <em>grep openvswitch</em> . <br>  You should see something like this: <em># openvswitch 47849 0</em> </li><li>  Check the status of all Open vSwitch services: <em># sudo service openvswitch-switch status.</em> </li></ol><br><br>  You should see this: <br><pre> <code class="hljs pgsql">ovsdb-<span class="hljs-keyword"><span class="hljs-keyword">server</span></span> <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> running <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> pid xxxx ovs-vswitchd <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> running <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> pid yyyy</code> </pre> <br><br>  We kindly ask you to do the configuration after you make sure that all the Open vSwitch services work correctly. <br><br>  Reset eth0 settings: <br><pre> <code class="hljs vala"><span class="hljs-meta"><span class="hljs-meta"># sudo ifconfig eth0 0</span></span></code> </pre> <br><br>  Create a new vSwitch: <br><pre> <code class="hljs pgsql"># sudo ovs-vsctl <span class="hljs-keyword"><span class="hljs-keyword">add</span></span>-br ovs-<span class="hljs-type"><span class="hljs-type">internal</span></span></code> </pre> <br><br>  Add eth0 to ovs-internal: <br><pre> <code class="hljs pgsql"># sudo ovs-vsctl <span class="hljs-keyword"><span class="hljs-keyword">add</span></span>-port ovs-<span class="hljs-type"><span class="hljs-type">internal</span></span> eth0</code> </pre> <br><br>  Raise ovs-internal: <br><pre> <code class="hljs vala"><span class="hljs-meta"><span class="hljs-meta"># sudo ifconfig ovs-internal up</span></span></code> </pre> <br><br>  Set the IP address for ovs-internal: <br><br>  Static IP: <br><pre> <code class="hljs objectivec"><span class="hljs-meta"><span class="hljs-meta"># sudo ifconfig ovs-internal </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;ip&gt;</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;netmask&gt;</span></span></span><span class="hljs-meta"> # sudo route add default gw </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;gw_ip&gt;</span></span></span></span></code> </pre> <br><br>  DHCP: <br><pre> <code class="hljs vala"><span class="hljs-meta"><span class="hljs-meta"># sudo dhclient ovs-internal</span></span></code> </pre> <br><br>  Add eth1 and eth2 to ovs-internal.  Enter commands in the following order: <br><br><pre> <code class="hljs vhdl"># sudo ovs-vsctl add-<span class="hljs-keyword"><span class="hljs-keyword">port</span></span> ovs-internal eth1 # sudo ovs-ofctl <span class="hljs-keyword"><span class="hljs-keyword">mod</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">port</span></span> ovs-internal eth1 down # sudo ovs-ofctl <span class="hljs-keyword"><span class="hljs-keyword">mod</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">port</span></span> ovs-internal eth1 noflood # sudo ovs-vsctl add-<span class="hljs-keyword"><span class="hljs-keyword">port</span></span> ovs-internal eth2 # sudo ovs-ofctl <span class="hljs-keyword"><span class="hljs-keyword">mod</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">port</span></span> ovs-internal eth2 down # sudo ovs-ofctl <span class="hljs-keyword"><span class="hljs-keyword">mod</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">port</span></span> ovs-internal eth2 noflood</code> </pre> <br><br>  After the introduction of these commands, the eth1 and eth2 network interfaces are deactivated and the noflood options installed on them. <br>  You must follow the order of entering commands, or you will get a loop.  These 2 ports will work when the ISNP device is ready and the cables are plugged into eth1 and eth2. <br><br>  After the installation of Open vSwitch is complete, you can use ovs-vsctl and see the status of your switches. <br><br><pre> <code class="hljs pgsql"># sudo ovs-vsctl <span class="hljs-keyword"><span class="hljs-keyword">show</span></span> ed1f5e9a<span class="hljs-number"><span class="hljs-number">-8</span></span>c2e<span class="hljs-number"><span class="hljs-number">-4</span></span>a1e<span class="hljs-number"><span class="hljs-number">-9</span></span>fe8<span class="hljs-number"><span class="hljs-number">-73740</span></span>f57589c Bridge ovs-<span class="hljs-type"><span class="hljs-type">internal</span></span> Port ovs-<span class="hljs-type"><span class="hljs-type">internal</span></span> Interface ovs-<span class="hljs-type"><span class="hljs-type">internal</span></span> <span class="hljs-keyword"><span class="hljs-keyword">type</span></span>: <span class="hljs-type"><span class="hljs-type">internal</span></span> Port "eth2" Interface "eth2" Port "eth1" Interface "eth1" Port "eth0" Interface "eth0" ovs_version: "1.4.0+build0"</code> </pre> <br><br>  If you do not want to configure Open vSwitch every time, go to / etc / network / interfaces and add "permanent" settings <br><br>  For static IP configuration, you need to change the settings so that it looks like this: <br><br><pre> <code class="hljs css"># <span class="hljs-selector-tag"><span class="hljs-selector-tag">The</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">loopback</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">network</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">interface</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">auto</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">lo</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">iface</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">lo</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">inet</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">loopback</span></span> # <span class="hljs-selector-tag"><span class="hljs-selector-tag">The</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">uplink</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">on</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ovs-internal</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">auto</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">eth0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">iface</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">eth0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">inet</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">static</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">address</span></span> 0<span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span> # <span class="hljs-selector-tag"><span class="hljs-selector-tag">The</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">interface</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">for</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">connecting</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">to</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">the</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">protection</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ports</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">on</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ISNP</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">auto</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">eth1</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">iface</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">eth1</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">inet</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">static</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">address</span></span> 0<span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span> # <span class="hljs-selector-tag"><span class="hljs-selector-tag">The</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">interface</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">for</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">connecting</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">to</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">the</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">protection</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ports</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">on</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ISNP</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">auto</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">eth2</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">iface</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">eth2</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">inet</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">static</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">address</span></span> 0<span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span> # <span class="hljs-selector-tag"><span class="hljs-selector-tag">The</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Open</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">vSwitch</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">setting</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">auto</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ovs-internal</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">iface</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ovs-internal</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">inet</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">static</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">address</span></span> 10<span class="hljs-selector-class"><span class="hljs-selector-class">.40</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.28</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.1</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">netmask</span></span> 255<span class="hljs-selector-class"><span class="hljs-selector-class">.255</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.128</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">network</span></span> 10<span class="hljs-selector-class"><span class="hljs-selector-class">.40</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">broadcast</span></span> 10<span class="hljs-selector-class"><span class="hljs-selector-class">.40</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.127</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.255</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">gateway</span></span> 10<span class="hljs-selector-class"><span class="hljs-selector-class">.40</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.1</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dns-nameservers</span></span> 10<span class="hljs-selector-class"><span class="hljs-selector-class">.40</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.1</span></span></code> </pre> <br><br>  And in order to configure DHCP, the settings should be similar to this: <br><br><pre> <code class="hljs pgsql"># The loopback network interface auto lo iface lo <span class="hljs-type"><span class="hljs-type">inet</span></span> loopback # The uplink <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> ovs-<span class="hljs-type"><span class="hljs-type">internal</span></span> auto eth0 iface eth0 <span class="hljs-type"><span class="hljs-type">inet</span></span> static address <span class="hljs-number"><span class="hljs-number">0.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> # The interface <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> connecting <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> the protection ports <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> ISNP auto eth1 iface eth1 <span class="hljs-type"><span class="hljs-type">inet</span></span> static address <span class="hljs-number"><span class="hljs-number">0.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> # The interface <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> connecting <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> the protection ports <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> ISNP auto eth2 iface eth2 <span class="hljs-type"><span class="hljs-type">inet</span></span> static address <span class="hljs-number"><span class="hljs-number">0.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> # The <span class="hljs-keyword"><span class="hljs-keyword">primary</span></span> network interface auto ovs-<span class="hljs-type"><span class="hljs-type">internal</span></span> iface ovs-<span class="hljs-type"><span class="hljs-type">internal</span></span> <span class="hljs-type"><span class="hljs-type">inet</span></span> dhcp</code> </pre> <br><br>  It is important to install noflood on eth1 and eth2.  This is not desirable in / etc / network / interfaces, so you will need to enter the following commands in /etc/rc.local: <br><br><pre> <code class="hljs vhdl"># sudo vi /etc/rc.local ovs-ofctl <span class="hljs-keyword"><span class="hljs-keyword">mod</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">port</span></span> ovs-internal eth1 noflood ovs-ofctl <span class="hljs-keyword"><span class="hljs-keyword">mod</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">port</span></span> ovs-internal eth2 noflood</code> </pre> <br><br><h1>  ISNP Setup </h1><br><br>  Configure your ISNP and connect eth1 and eth2 to the device ports (as shown in Figure 1). <br>  When the installation is complete, you can enter the interface and see the ISNP control panel. <br><br>  Pic.3 <br><img src="https://habrastorage.org/files/ade/036/7c3/ade0367c3c4e45a78902a8638815d175.jpg" alt="image"><br><br>  For this article, ISNP was used as IPS.  We used the default X-Force IPS, not the user and application control network policy.  As a result, only the ‚Äúany any‚Äù rule was activated.  The remaining rules specified in the initial settings are shipped with the XGS5100 (version 5.1) <br><br>  Pic.4 <br><img src="https://habrastorage.org/files/314/36d/0b5/31436d0b52864f9e84b922f999a819ac.jpg" alt="image"><br><br>  After configuring ISNP, connect the cables and bring up the eth1 and eth2 ports on the ovs-internal: <br><br><pre> <code class="hljs vhdl"># sudo ovs-ofctl <span class="hljs-keyword"><span class="hljs-keyword">mod</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">port</span></span> ovs-internal eth1 up # sudo ovs-ofctl <span class="hljs-keyword"><span class="hljs-keyword">mod</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">port</span></span> ovs-internal eth2 up</code> </pre> <br><br>  Recheck if you installed noflood on eth1 and eth2 correctly, because if not, you will get a loop when connecting cables. <br><br><h1>  Creating the first virtual machine and connecting it to ovs-internal </h1><br><br>  First, you need to prepare a script for connecting your virtual NIC in your virtual machine to ovs-internal. <br><br>  Copy this code into / etc / ovs-ifup: <br><pre> <code class="hljs mel"># sudo vi /etc/ovs-ifup #!/bin/sh <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span>=<span class="hljs-string"><span class="hljs-string">'ovs-internal'</span></span> /sbin/ifconfig $1 <span class="hljs-number"><span class="hljs-number">0.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> up ovs-vsctl add-port ${switch} $1</code> </pre> <br><br>  Add permission to execute the script: <em># sudo chmod + x / etc / ovs-ifup.</em> <br><br><h1>  Creating a new virtual machine </h1><br><br>  To create a virtual machine, use virt-manager.  Since Ubuntu 12.04 server was used here and we did not install the X server, we will not be able to run any program with the GUI. <br>  But if suddenly you decide to use the Desktop Edition, the problem will be solved and you can access the virt-manager directly. <br><br>  To run virt-manager on your KVM, use <a href="http://unix.stackexchange.com/questions/12755/how-to-forward-x-over-ssh-from-ubuntu-machine/">X forwarding</a> (to view GUI programs on your local server) <br><br>  If you are working under Linux, then in order to connect to a remote KVM, you must run an X forwarding command.  (X forwarding connection to the server using the SSH protocol): <em># ssh -X user @ &lt;server_ip&gt;.&gt;</em> . <br><br>  Instead of eth0, you need to get the IP address of your server from ovs-internal: <em># ifconfig ovs-internal&gt;</em> . <br><br>  After logging in to the remote KVM, run virt-manager: <em># virt-manager.</em> <br>  If everything is correct, the GUI of the program will be displayed. <br><br>  Pic.5 <br><img src="https://habrastorage.org/files/121/cbd/598/121cbd598a3844f99be6d89414a8e15c.jpg" alt="image"><br><br>  Now we create the first virtual machine. <br><br>  Pic.6 <br><img src="https://habrastorage.org/files/20f/111/3d3/20f1113d364d477c968c89b5958bf0b0.jpg" alt="image"><br><br>  Fig.7 <br><img src="https://habrastorage.org/files/c4d/9b9/932/c4d9b99324524db4a9e270d89ecf70c1.png" alt="image"><br><br>  It must have at least one vNIC (Virtualized Network Interface) <br><br>  Fig.8 <br><img src="https://habrastorage.org/files/936/392/5f5/9363925f569f4acda92802cbb4d1d082.png" alt="image"><br><br>  The vNICs will be configured later, for now close the created virtual machine and manually edit its XML file: Edit /etc/libvirt/qemu/.xml. <br><br>  Initially, the settings of the XML file should look like this: <br><br><pre> <code class="hljs pgsql"># sudo vi /etc/libvirt/qemu/&lt;VM <span class="hljs-type"><span class="hljs-type">NAME</span></span>&gt;.xml &lt;interface <span class="hljs-keyword"><span class="hljs-keyword">type</span></span>=<span class="hljs-string"><span class="hljs-string">'bridge'</span></span>&gt; &lt;mac address=<span class="hljs-string"><span class="hljs-string">'xx:xx:xx:xx:xx:xx'</span></span>/&gt; &lt;source bridge=<span class="hljs-string"><span class="hljs-string">'xxxx'</span></span>/&gt; &lt;model <span class="hljs-keyword"><span class="hljs-keyword">type</span></span>=<span class="hljs-string"><span class="hljs-string">'virtio'</span></span>/&gt; &lt;address <span class="hljs-keyword"><span class="hljs-keyword">type</span></span>=<span class="hljs-string"><span class="hljs-string">'pci'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">domain</span></span>=<span class="hljs-string"><span class="hljs-string">'0x0000'</span></span> bus=<span class="hljs-string"><span class="hljs-string">'0x00'</span></span> slot=<span class="hljs-string"><span class="hljs-string">'0x03'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">function</span></span>=<span class="hljs-string"><span class="hljs-string">'0x0'</span></span>/&gt; &lt;/interface&gt;</code> </pre> <br><br>  Modify the XML file settings so that it looks like this: <br><br><pre> <code class="hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">interface</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'ethernet'</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">mac</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">address</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'xx:xx:xx:xx:xx:xx'</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">path</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'/etc/ovs-ifup'</span></span></span><span class="hljs-tag">/&gt;</span></span><span class="xml"><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">model</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">'virtio'</span></span></span></span><span class="xml"><span class="hljs-tag">/&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">address</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">'pci'</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">domain</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">'0x0000'</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">bus</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">'0x00'</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">slot</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">'0x03'</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">function</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">'0x0'</span></span></span></span><span class="xml"><span class="hljs-tag">/&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">interface</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span></code> </pre> <br><br>  Give the KVM command to upload the updated XML file: # sudo virsh define /etc/libvirt/qemu/.xml. <br><br>  Everything!  ‚ÄúConquer and share‚Äù on the virtual machine you created. <br>  Having executed the following commands you should see the created port on ovs-internal. <br><br><pre> <code class="hljs pgsql"># sudo ovs-vsctl <span class="hljs-keyword"><span class="hljs-keyword">show</span></span> # sudo ovs-ofctl <span class="hljs-keyword"><span class="hljs-keyword">show</span></span> ovs-<span class="hljs-type"><span class="hljs-type">internal</span></span></code> </pre> <br><br>  Try installing any operating system on your virtual machine and try to connect to the network. <br><br>  When your virtual machine is connected to Open vSwitch, the network (in bridge mode) and the DHCP server should work on it.  If a DHCP server is not available, then you will have to manually assign an IP address to the virtual machine. <br><br>  Due to an error in libvirt, the ovs-ifdown script is not specified in the description file.  You must shut down the virtual machine and disconnect the tap (Ethernet) device from the switch.  If this is not done, an error message will appear on subsequent launches of the virtual machine. <br><br>  Fig.9 <br><img src="https://habrastorage.org/files/f81/18d/54e/f8118d54ead04c3e8897e977b78e35a1.png" alt="image"><br><br>  To disconnect a tap device from ovs-internal, enter this command: # sudo ovs-vsctl del-port ovs-internal tapN. <br><br>  from the error message we can find out which device is disconnected from the switch.  (Fig.9) <br><br><h1>  Protecting the virtual machine from external traffic </h1><br><br>  Now you need to "train" ovs-internal packet inspection, when sending traffic to ISNP.  Use the ovs-ofctl command to set SDN rules on ovs-internal.  The structure of the rules when working with the switch is determined by the OpenFlow standard.  Repeat the same to protect other virtual machines. <br><br>  If you set the wrong rules, your virtual machine will not be able to use the network.  To restore the network connection, you must reset the switch using the following commands: <br><br><pre> <code class="hljs pgsql"># sudo ovs-ofctl del-flows ovs-<span class="hljs-type"><span class="hljs-type">internal</span></span> # sudo ovs-ofctl <span class="hljs-keyword"><span class="hljs-keyword">add</span></span>-flow ovs-<span class="hljs-type"><span class="hljs-type">internal</span></span> action=normal</code> </pre> <br><br>  You need to know two attributes from the first virtual machine: the MAC address and the port number through which your Virtual Machine connects to ovs-internal. <br><br>  You can see the MAC address of your virtual NIC here: <br><br>  /etc/libvirt/qemu/.xml: <br><br><pre> <code class="hljs xml">#sudo vi /etc/libvirt/qemu/<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">VM</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">NAME</span></span></span><span class="hljs-tag">&gt;</span></span>.xml <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">interface</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'ethernet'</span></span></span><span class="hljs-tag">&gt;</span></span> ... <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">mac</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">address</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'xx:xx:xx:xx:xx:xx'</span></span></span><span class="hljs-tag">/&gt;</span></span> ... <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">interface</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><br>  You can also see the MAC address assigned to each network device directly on the virtual machine itself. <br><br>  Now you need the port number through which your Virtual Machine connects to ovs-internal.  To get the status of the port on ovs-internal, you must run the following command: # sudo ovs-ofctl show ovs-internal. <br><br>  The output of the command should look like this: <br><br><pre> <code class="hljs pgsql">OFPT_FEATURES_REPLY (xid=<span class="hljs-number"><span class="hljs-number">0x1</span></span>): ver:<span class="hljs-number"><span class="hljs-number">0x1</span></span>, dpid:<span class="hljs-number"><span class="hljs-number">0000e41</span></span>f136c4952 n_tables:<span class="hljs-number"><span class="hljs-number">255</span></span>, n_buffers:<span class="hljs-number"><span class="hljs-number">256</span></span> features: capabilities:<span class="hljs-number"><span class="hljs-number">0xc7</span></span>, actions:<span class="hljs-number"><span class="hljs-number">0xfff</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>(eth0): addr:e4:<span class="hljs-number"><span class="hljs-number">1</span></span>f:<span class="hljs-number"><span class="hljs-number">13</span></span>:<span class="hljs-number"><span class="hljs-number">6</span></span>c:<span class="hljs-number"><span class="hljs-number">49</span></span>:<span class="hljs-number"><span class="hljs-number">52</span></span> config: <span class="hljs-number"><span class="hljs-number">0</span></span> state: <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">current</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>GB-FD COPPER AUTO_NEG advertised: <span class="hljs-number"><span class="hljs-number">10</span></span>MB-HD <span class="hljs-number"><span class="hljs-number">10</span></span>MB-FD <span class="hljs-number"><span class="hljs-number">100</span></span>MB-HD <span class="hljs-number"><span class="hljs-number">100</span></span>MB-FD <span class="hljs-number"><span class="hljs-number">1</span></span>GB-FD AUTO_NEG supported: <span class="hljs-number"><span class="hljs-number">10</span></span>MB-HD <span class="hljs-number"><span class="hljs-number">10</span></span>MB-FD <span class="hljs-number"><span class="hljs-number">100</span></span>MB-HD <span class="hljs-number"><span class="hljs-number">100</span></span>MB-FD <span class="hljs-number"><span class="hljs-number">1</span></span>GB-FD COPPER AUTO_NEG <span class="hljs-number"><span class="hljs-number">2</span></span>(eth1): addr:e4:<span class="hljs-number"><span class="hljs-number">1</span></span>f:<span class="hljs-number"><span class="hljs-number">13</span></span>:<span class="hljs-number"><span class="hljs-number">6</span></span>c:aa:<span class="hljs-number"><span class="hljs-number">56</span></span> config: NO_FLOOD state: <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">current</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>GB-FD COPPER AUTO_NEG advertised: <span class="hljs-number"><span class="hljs-number">10</span></span>MB-HD <span class="hljs-number"><span class="hljs-number">10</span></span>MB-FD <span class="hljs-number"><span class="hljs-number">100</span></span>MB-HD <span class="hljs-number"><span class="hljs-number">100</span></span>MB-FD <span class="hljs-number"><span class="hljs-number">1</span></span>GB-FD AUTO_NEG supported: <span class="hljs-number"><span class="hljs-number">10</span></span>MB-HD <span class="hljs-number"><span class="hljs-number">10</span></span>MB-FD <span class="hljs-number"><span class="hljs-number">100</span></span>MB-HD <span class="hljs-number"><span class="hljs-number">100</span></span>MB-FD <span class="hljs-number"><span class="hljs-number">1</span></span>GB-FD COPPER AUTO_NEG <span class="hljs-number"><span class="hljs-number">3</span></span>(eth2): addr:e4:<span class="hljs-number"><span class="hljs-number">1</span></span>f:<span class="hljs-number"><span class="hljs-number">13</span></span>:<span class="hljs-number"><span class="hljs-number">6</span></span>c:ab:<span class="hljs-number"><span class="hljs-number">57</span></span> config: NO_FLOOD state: <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">current</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>GB-FD COPPER AUTO_NEG advertised: <span class="hljs-number"><span class="hljs-number">10</span></span>MB-HD <span class="hljs-number"><span class="hljs-number">10</span></span>MB-FD <span class="hljs-number"><span class="hljs-number">100</span></span>MB-HD <span class="hljs-number"><span class="hljs-number">100</span></span>MB-FD <span class="hljs-number"><span class="hljs-number">1</span></span>GB-FD AUTO_NEG supported: <span class="hljs-number"><span class="hljs-number">10</span></span>MB-HD <span class="hljs-number"><span class="hljs-number">10</span></span>MB-FD <span class="hljs-number"><span class="hljs-number">100</span></span>MB-HD <span class="hljs-number"><span class="hljs-number">100</span></span>MB-FD <span class="hljs-number"><span class="hljs-number">1</span></span>GB-FD COPPER AUTO_NEG <span class="hljs-number"><span class="hljs-number">4</span></span>(tap0): addr:be:cc:<span class="hljs-number"><span class="hljs-number">7</span></span>b:<span class="hljs-number"><span class="hljs-number">8</span></span>b:c0:<span class="hljs-number"><span class="hljs-number">04</span></span> config: <span class="hljs-number"><span class="hljs-number">0</span></span> state: <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">current</span></span>: <span class="hljs-number"><span class="hljs-number">10</span></span>MB-FD COPPER <span class="hljs-keyword"><span class="hljs-keyword">LOCAL</span></span>(ovs-<span class="hljs-type"><span class="hljs-type">internal</span></span>): addr:e4:<span class="hljs-number"><span class="hljs-number">1</span></span>f:<span class="hljs-number"><span class="hljs-number">13</span></span>:<span class="hljs-number"><span class="hljs-number">6</span></span>c:<span class="hljs-number"><span class="hljs-number">49</span></span>:<span class="hljs-number"><span class="hljs-number">52</span></span> config: <span class="hljs-number"><span class="hljs-number">0</span></span> state: <span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre> <br><br>  The numbers (from 1 to 4) are the port number, followed by the name in the brackets of the device connected to the port. <br><br>  Each vNIC on the virtual machine is displayed as a hypervisor tap device.  Thus, we can see that the first virtual machine is connected to port 4 on ovs-internal, eth2 to port 2, and eth3 to port 3.  You will see all these values ‚Äã‚Äãin the switch management rules. <br><br>  Note that the port number on the switch can be changed after the server is rebooted. <br><br>  You must use the correct port number in subsequent ovs-internal management rules, otherwise network traffic will not pass through the ISNP device ... <br>  <strong>Note: eth0 will not always be on the first port.</strong> <br><br>  Suppose the MAC address of the first Virtual Machine is 52: 54: 00: AA: BB: CC. <br>  Set new rules for ovs-internal. <br><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">Rule</span></span> <span class="hljs-number"><span class="hljs-number">01</span></span>: # sudo ovs-ofctl del-flows ovs-<span class="hljs-type"><span class="hljs-type">internal</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Rule</span></span> <span class="hljs-number"><span class="hljs-number">02</span></span>: # sudo ovs-ofctl <span class="hljs-keyword"><span class="hljs-keyword">add</span></span>-flow ovs-<span class="hljs-type"><span class="hljs-type">internal</span></span> priority=<span class="hljs-number"><span class="hljs-number">100</span></span>,in_port=<span class="hljs-number"><span class="hljs-number">1</span></span>,dl_dst=<span class="hljs-number"><span class="hljs-number">52</span></span>:<span class="hljs-number"><span class="hljs-number">54</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:ac:bb:cc,idle_timeout=<span class="hljs-number"><span class="hljs-number">0</span></span>,action=output:<span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Rule</span></span> <span class="hljs-number"><span class="hljs-number">03</span></span>: # sudo ovs-ofctl <span class="hljs-keyword"><span class="hljs-keyword">add</span></span>-flow ovs-<span class="hljs-type"><span class="hljs-type">internal</span></span> priority=<span class="hljs-number"><span class="hljs-number">100</span></span>,in_port=<span class="hljs-number"><span class="hljs-number">3</span></span>,dl_dst=<span class="hljs-number"><span class="hljs-number">52</span></span>:<span class="hljs-number"><span class="hljs-number">54</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:ac:bb:cc,idle_timeout=<span class="hljs-number"><span class="hljs-number">0</span></span>,action=output:<span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Rule</span></span> <span class="hljs-number"><span class="hljs-number">04</span></span>: # sudo ovs-ofctl <span class="hljs-keyword"><span class="hljs-keyword">add</span></span>-flow ovs-<span class="hljs-type"><span class="hljs-type">internal</span></span> priority=<span class="hljs-number"><span class="hljs-number">100</span></span>,in_port=<span class="hljs-number"><span class="hljs-number">4</span></span>,idle_timeout=<span class="hljs-number"><span class="hljs-number">0</span></span>,action=output:<span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Rule</span></span> <span class="hljs-number"><span class="hljs-number">05</span></span>: # sudo ovs-ofctl <span class="hljs-keyword"><span class="hljs-keyword">add</span></span>-flow ovs-<span class="hljs-type"><span class="hljs-type">internal</span></span> priority=<span class="hljs-number"><span class="hljs-number">0</span></span>,action=normal</code> </pre> <br><br>  <em>Rules by rules</em> <br><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">Rule</span></span> <span class="hljs-number"><span class="hljs-number">01</span></span>: Flush every <span class="hljs-keyword"><span class="hljs-keyword">rule</span></span> <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> ovs-<span class="hljs-type"><span class="hljs-type">internal</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Rule</span></span> <span class="hljs-number"><span class="hljs-number">02</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">If</span></span> the flow <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> sent <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> the uplink (eth0 @ port #<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> the destination MAC <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> ‚Äú<span class="hljs-number"><span class="hljs-number">52</span></span>:<span class="hljs-number"><span class="hljs-number">54</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:aa:bb:cc‚Äù <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> forward the flow <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> eth1@port#<span class="hljs-number"><span class="hljs-number">2.</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Rule</span></span> <span class="hljs-number"><span class="hljs-number">03</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">After</span></span> ISNP inspected the flow, it will be forwarded <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> eth2@port#<span class="hljs-number"><span class="hljs-number">3.</span></span> Therefore, <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> the flow <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> sent <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> port#<span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> the destination MAC <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> ‚Äú<span class="hljs-number"><span class="hljs-number">52</span></span>:<span class="hljs-number"><span class="hljs-number">54</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:aa:bb:cc‚Äù <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> it should be forward the port that the first VM <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> connected <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> (port#<span class="hljs-number"><span class="hljs-number">4</span></span>). <span class="hljs-keyword"><span class="hljs-keyword">Rule</span></span> <span class="hljs-number"><span class="hljs-number">04</span></span>: Forward every packets sent <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> the first VM (port#<span class="hljs-number"><span class="hljs-number">4</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> eth2 (port #<span class="hljs-number"><span class="hljs-number">3</span></span>). <span class="hljs-keyword"><span class="hljs-keyword">Rule</span></span> <span class="hljs-number"><span class="hljs-number">05</span></span>: It <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> the <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-keyword"><span class="hljs-keyword">rule</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> handle the broadcast/multicast traffic. This <span class="hljs-keyword"><span class="hljs-keyword">rule</span></span> has the lowest priority.</code> </pre> <br><br>  Blue lines in fig.  10 demonstrate how the switch forwards traffic from an external computer to an ISNP and then to the first virtual machine. <br>  Pic.10 <br><img src="https://habrastorage.org/files/e0f/2ee/391/e0f2ee3919aa46c49a0d10f499b65dab.png" alt="image"><br><br>  With this command you can dump all current rules on ovs-internal and see how many packets have killed each rule: # sudo ovs-ofctl dump-flows ovs-internal. <br><br>  The output should look something like this: <br><br><pre> <code class="hljs lua">NXST_FLOW reply (<span class="hljs-number"><span class="hljs-number">0x4</span></span>): cookie=<span class="hljs-number"><span class="hljs-number">0x0</span></span>, duration=<span class="hljs-number"><span class="hljs-number">4345.083</span></span>s, <span class="hljs-built_in"><span class="hljs-built_in">table</span></span>=<span class="hljs-number"><span class="hljs-number">0</span></span>, n_packets=<span class="hljs-number"><span class="hljs-number">4637</span></span>, n_bytes=<span class="hljs-number"><span class="hljs-number">441598</span></span>, priority=<span class="hljs-number"><span class="hljs-number">100</span></span>,in_port=<span class="hljs-number"><span class="hljs-number">4</span></span> actions=<span class="hljs-built_in"><span class="hljs-built_in">output</span></span>:<span class="hljs-number"><span class="hljs-number">3</span></span> cookie=<span class="hljs-number"><span class="hljs-number">0x0</span></span>, duration=<span class="hljs-number"><span class="hljs-number">4399.466</span></span>s, <span class="hljs-built_in"><span class="hljs-built_in">table</span></span>=<span class="hljs-number"><span class="hljs-number">0</span></span>, n_packets=<span class="hljs-number"><span class="hljs-number">4618</span></span>, n_bytes=<span class="hljs-number"><span class="hljs-number">449256</span></span>, priority=<span class="hljs-number"><span class="hljs-number">100</span></span>,in_port=<span class="hljs-number"><span class="hljs-number">1</span></span>,dl_dst=<span class="hljs-number"><span class="hljs-number">52</span></span>:<span class="hljs-number"><span class="hljs-number">54</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:aa:bb:cc actions=<span class="hljs-built_in"><span class="hljs-built_in">output</span></span>:<span class="hljs-number"><span class="hljs-number">2</span></span> cookie=<span class="hljs-number"><span class="hljs-number">0x0</span></span>, duration=<span class="hljs-number"><span class="hljs-number">4363.898</span></span>s, <span class="hljs-built_in"><span class="hljs-built_in">table</span></span>=<span class="hljs-number"><span class="hljs-number">0</span></span>, n_packets=<span class="hljs-number"><span class="hljs-number">4618</span></span>, n_bytes=<span class="hljs-number"><span class="hljs-number">449256</span></span>, priority=<span class="hljs-number"><span class="hljs-number">100</span></span>,in_port=<span class="hljs-number"><span class="hljs-number">3</span></span>,dl_dst=<span class="hljs-number"><span class="hljs-number">52</span></span>:<span class="hljs-number"><span class="hljs-number">54</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:aa:bb:cc actions=<span class="hljs-built_in"><span class="hljs-built_in">output</span></span>:<span class="hljs-number"><span class="hljs-number">4</span></span> cookie=<span class="hljs-number"><span class="hljs-number">0x0</span></span>, duration=<span class="hljs-number"><span class="hljs-number">4324.14</span></span>s, <span class="hljs-built_in"><span class="hljs-built_in">table</span></span>=<span class="hljs-number"><span class="hljs-number">0</span></span>, n_packets=<span class="hljs-number"><span class="hljs-number">24095</span></span>, n_bytes=<span class="hljs-number"><span class="hljs-number">1916023</span></span>, priority=<span class="hljs-number"><span class="hljs-number">0</span></span> actions=NORMAL</code> </pre> <br><br>  Now you can test ISNP and run penetration tests on the first virtual machine. <br><br>  In the section, ‚ÄúVerify that your virtual machines are protecting your virtual machines‚Äù there are a few simple tests to check your virtual machine‚Äôs ISNP protection. <br><br><h1>  Creating a second virtual machine and connecting it to Open vSwitch </h1><br><br>  You can create a second virtual machine by cloning the first one using virt-manager, or manually, as you did earlier <br><br>  Do not forget to change the XML file so that the virtual machine automatically connects to ovs-internal <br><br><h1>  Protection of the Virtual Machine from internal traffic </h1><br><br>  To get the port number used by the second Virtual Machine, run the ovs-ofctl command again: # sudo ovs-ofctl show ovs-internal. <br><br>  The result will look something like this: <br><pre> <code class="hljs pgsql">OFPT_FEATURES_REPLY (xid=<span class="hljs-number"><span class="hljs-number">0x1</span></span>): ver:<span class="hljs-number"><span class="hljs-number">0x1</span></span>, dpid:<span class="hljs-number"><span class="hljs-number">0000e41</span></span>f136c4952 n_tables:<span class="hljs-number"><span class="hljs-number">255</span></span>, n_buffers:<span class="hljs-number"><span class="hljs-number">256</span></span> features: capabilities:<span class="hljs-number"><span class="hljs-number">0xc7</span></span>, actions:<span class="hljs-number"><span class="hljs-number">0xfff</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>(eth0): addr:e4:<span class="hljs-number"><span class="hljs-number">1</span></span>f:<span class="hljs-number"><span class="hljs-number">13</span></span>:<span class="hljs-number"><span class="hljs-number">6</span></span>c:<span class="hljs-number"><span class="hljs-number">49</span></span>:<span class="hljs-number"><span class="hljs-number">52</span></span> config: <span class="hljs-number"><span class="hljs-number">0</span></span> state: <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">current</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>GB-FD COPPER AUTO_NEG advertised: <span class="hljs-number"><span class="hljs-number">10</span></span>MB-HD <span class="hljs-number"><span class="hljs-number">10</span></span>MB-FD <span class="hljs-number"><span class="hljs-number">100</span></span>MB-HD <span class="hljs-number"><span class="hljs-number">100</span></span>MB-FD <span class="hljs-number"><span class="hljs-number">1</span></span>GB-FD AUTO_NEG supported: <span class="hljs-number"><span class="hljs-number">10</span></span>MB-HD <span class="hljs-number"><span class="hljs-number">10</span></span>MB-FD <span class="hljs-number"><span class="hljs-number">100</span></span>MB-HD <span class="hljs-number"><span class="hljs-number">100</span></span>MB-FD <span class="hljs-number"><span class="hljs-number">1</span></span>GB-FD COPPER AUTO_NEG <span class="hljs-number"><span class="hljs-number">2</span></span>(eth1): addr:e4:<span class="hljs-number"><span class="hljs-number">1</span></span>f:<span class="hljs-number"><span class="hljs-number">13</span></span>:<span class="hljs-number"><span class="hljs-number">6</span></span>c:aa:<span class="hljs-number"><span class="hljs-number">56</span></span> config: NO_FLOOD state: <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">current</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>GB-FD COPPER AUTO_NEG advertised: <span class="hljs-number"><span class="hljs-number">10</span></span>MB-HD <span class="hljs-number"><span class="hljs-number">10</span></span>MB-FD <span class="hljs-number"><span class="hljs-number">100</span></span>MB-HD <span class="hljs-number"><span class="hljs-number">100</span></span>MB-FD <span class="hljs-number"><span class="hljs-number">1</span></span>GB-FD AUTO_NEG supported: <span class="hljs-number"><span class="hljs-number">10</span></span>MB-HD <span class="hljs-number"><span class="hljs-number">10</span></span>MB-FD <span class="hljs-number"><span class="hljs-number">100</span></span>MB-HD <span class="hljs-number"><span class="hljs-number">100</span></span>MB-FD <span class="hljs-number"><span class="hljs-number">1</span></span>GB-FD COPPER AUTO_NEG <span class="hljs-number"><span class="hljs-number">3</span></span>(eth2): addr:e4:<span class="hljs-number"><span class="hljs-number">1</span></span>f:<span class="hljs-number"><span class="hljs-number">13</span></span>:<span class="hljs-number"><span class="hljs-number">6</span></span>c:ab:<span class="hljs-number"><span class="hljs-number">57</span></span> config: NO_FLOOD state: <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">current</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>GB-FD COPPER AUTO_NEG advertised: <span class="hljs-number"><span class="hljs-number">10</span></span>MB-HD <span class="hljs-number"><span class="hljs-number">10</span></span>MB-FD <span class="hljs-number"><span class="hljs-number">100</span></span>MB-HD <span class="hljs-number"><span class="hljs-number">100</span></span>MB-FD <span class="hljs-number"><span class="hljs-number">1</span></span>GB-FD AUTO_NEG supported: <span class="hljs-number"><span class="hljs-number">10</span></span>MB-HD <span class="hljs-number"><span class="hljs-number">10</span></span>MB-FD <span class="hljs-number"><span class="hljs-number">100</span></span>MB-HD <span class="hljs-number"><span class="hljs-number">100</span></span>MB-FD <span class="hljs-number"><span class="hljs-number">1</span></span>GB-FD COPPER AUTO_NEG <span class="hljs-number"><span class="hljs-number">4</span></span>(tap0): addr:be:cc:<span class="hljs-number"><span class="hljs-number">7</span></span>b:<span class="hljs-number"><span class="hljs-number">8</span></span>b:c0:<span class="hljs-number"><span class="hljs-number">04</span></span> config: <span class="hljs-number"><span class="hljs-number">0</span></span> state: <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">current</span></span>: <span class="hljs-number"><span class="hljs-number">10</span></span>MB-FD COPPER <span class="hljs-number"><span class="hljs-number">5</span></span>(tap1): addr:be:cc:<span class="hljs-number"><span class="hljs-number">7</span></span>b:<span class="hljs-number"><span class="hljs-number">8</span></span>b:c0:<span class="hljs-number"><span class="hljs-number">05</span></span> config: <span class="hljs-number"><span class="hljs-number">0</span></span> state: <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">current</span></span>: <span class="hljs-number"><span class="hljs-number">10</span></span>MB-FD COPPER <span class="hljs-keyword"><span class="hljs-keyword">LOCAL</span></span>(ovs-<span class="hljs-type"><span class="hljs-type">internal</span></span>): addr:e4:<span class="hljs-number"><span class="hljs-number">1</span></span>f:<span class="hljs-number"><span class="hljs-number">13</span></span>:<span class="hljs-number"><span class="hljs-number">6</span></span>c:<span class="hljs-number"><span class="hljs-number">49</span></span>:<span class="hljs-number"><span class="hljs-number">52</span></span> config: <span class="hljs-number"><span class="hljs-number">0</span></span> state: <span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre> <br><br>  Here we see that the new tap device is connected to ovs-internal through the fifth port. <br><br>  Suppose the MAC address of the second Virtual Machine is 52: 54: 00: AA: CC: DD.  You must set the following rules for ovs-internal to protect it from external traffic and from traffic between Virtual Machines. <br><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">Rule</span></span> <span class="hljs-number"><span class="hljs-number">06</span></span>: # sudo ovs-ofctl <span class="hljs-keyword"><span class="hljs-keyword">add</span></span>-flow ovs-<span class="hljs-type"><span class="hljs-type">internal</span></span> priority=<span class="hljs-number"><span class="hljs-number">100</span></span>,in_port=<span class="hljs-number"><span class="hljs-number">1</span></span>,dl_dst=<span class="hljs-number"><span class="hljs-number">52</span></span>:<span class="hljs-number"><span class="hljs-number">54</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:ac:cc:dd,idle_timeout=<span class="hljs-number"><span class="hljs-number">0</span></span>,action=output:<span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Rule</span></span> <span class="hljs-number"><span class="hljs-number">07</span></span>: # sudo ovs-ofctl <span class="hljs-keyword"><span class="hljs-keyword">add</span></span>-flow ovs-<span class="hljs-type"><span class="hljs-type">internal</span></span> priority=<span class="hljs-number"><span class="hljs-number">100</span></span>,in_port=<span class="hljs-number"><span class="hljs-number">3</span></span>,dl_dst=<span class="hljs-number"><span class="hljs-number">52</span></span>:<span class="hljs-number"><span class="hljs-number">54</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:ac:cc:dd,idle_timeout=<span class="hljs-number"><span class="hljs-number">0</span></span>,action=output:<span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Rule</span></span> <span class="hljs-number"><span class="hljs-number">08</span></span>: # sudo ovs-ofctl <span class="hljs-keyword"><span class="hljs-keyword">add</span></span>-flow ovs-<span class="hljs-type"><span class="hljs-type">internal</span></span> priority=<span class="hljs-number"><span class="hljs-number">100</span></span>,in_port=<span class="hljs-number"><span class="hljs-number">5</span></span>,idle_timeout=<span class="hljs-number"><span class="hljs-number">0</span></span>,action=output:<span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Rule</span></span> <span class="hljs-number"><span class="hljs-number">09</span></span>: sudo ovs-ofctl <span class="hljs-keyword"><span class="hljs-keyword">add</span></span>-flow ovs-<span class="hljs-type"><span class="hljs-type">internal</span></span> priority=<span class="hljs-number"><span class="hljs-number">100</span></span>,in_port=<span class="hljs-number"><span class="hljs-number">2</span></span>,dl_dst=<span class="hljs-number"><span class="hljs-number">52</span></span>:<span class="hljs-number"><span class="hljs-number">54</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:ac:bb:cc,idle_timeout=<span class="hljs-number"><span class="hljs-number">0</span></span>,action=output:<span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Rule</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span>: sudo ovs-ofctl <span class="hljs-keyword"><span class="hljs-keyword">add</span></span>-flow ovs-<span class="hljs-type"><span class="hljs-type">internal</span></span> priority=<span class="hljs-number"><span class="hljs-number">100</span></span>,in_port=<span class="hljs-number"><span class="hljs-number">2</span></span>,dl_dst=<span class="hljs-number"><span class="hljs-number">52</span></span>:<span class="hljs-number"><span class="hljs-number">54</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:ac:cc:dd,idle_timeout=<span class="hljs-number"><span class="hljs-number">0</span></span>,action=output:<span class="hljs-number"><span class="hljs-number">5</span></span></code> </pre> <br><br>  <em>Rules by rules</em> <br><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">Rule</span></span> <span class="hljs-number"><span class="hljs-number">06</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">08</span></span>: These rules protect the second VM <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> the <span class="hljs-keyword"><span class="hljs-keyword">external</span></span> traffic. <span class="hljs-keyword"><span class="hljs-keyword">Rule</span></span> <span class="hljs-number"><span class="hljs-number">09</span></span>: Because you must take care <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> the inter-vm traffic now, you need <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> tell the switch how <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> forward the inter-vm traffic <span class="hljs-keyword"><span class="hljs-keyword">after</span></span> ISNP inspects it. This <span class="hljs-keyword"><span class="hljs-keyword">rule</span></span> says that <span class="hljs-keyword"><span class="hljs-keyword">after</span></span> ISNP <span class="hljs-keyword"><span class="hljs-keyword">returns</span></span> the traffic ‚Äî <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> the destination <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> the first VM ‚Äî the traffic should be forwarded <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> port #<span class="hljs-number"><span class="hljs-number">4.</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Rule</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">After</span></span> ISNP inspects the traffic, it will be forwarded <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> port #<span class="hljs-number"><span class="hljs-number">2.</span></span> This <span class="hljs-keyword"><span class="hljs-keyword">rule</span></span> forwards the traffic <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> port #<span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> the destination <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> the second VM.</code> </pre> <br><br>  The red lines in Figure 11 show the new rules set for the switch (protecting the traffic between two virtual machines). <br><br>  Figure 11 <br><img src="https://habrastorage.org/files/0f3/bcc/f63/0f3bccf63eb641cfb07cabbcdf124a57.png" alt="image"><br><br>  Make sure that all the rules set for ovs-internal are correct: # sudo ovs-ofctl dump-flows ovs-internal. <br><br>  Here you can also test ISNP performance by running penetration testing from one virtual machine to another. <br><br><h1>  ISNP protection for your virtual machines (some simple tests) </h1><br><br>  1) The easiest way to make sure that network traffic went through ISNP is to use <em>Network Graphs</em> in the ISNP management interface.  Before Network Graphs starts checking you need to send some traffic to virtual machines. <br><br>  Before checking, we have the opportunity to choose the schedule that interests us. <br><br>  Fig.12 <br><img src="https://habrastorage.org/files/18a/0c7/b6a/18a0c7b6a3a84818919fb71ce09434c6.png" alt="image"><br><br>  It is recommended to use " <em>Detail by User</em> ".  In this case, if the IP addresses of your virtual machines appear in the network statistics, the graph will be similar to what we see in Figure 13. <br><br>  Fig.13 <br><img src="https://habrastorage.org/files/b19/ccb/31c/b19ccb31c7dd41459df6ecd0524d9fcc.png" alt="image"><br><br>  2) You can send a harmless attack to your virtual machines and see if your ISNP is blocking them. <br><br>  If ISNP works correctly, the attacks will be blocked, and a security event will appear in the program‚Äôs control interface. <br><br>  3) Run the web server on your virtual machine.  If it works under Linux, use this command, and start the web server on port 8000: # python -m SimpleHTTPServer. <br><br>  While the web server is running, send the <a href="http://www.iss.net/security_center/reference/vuln/HTTP_URL_Many_Slashes.htm">URL_MANY_SLASHES</a> attack to <a href="http://www.iss.net/security_center/reference/vuln/HTTP_URL_Many_Slashes.htm">it</a> .  You can also send an attack from an external device or from one virtual machine to another.  In both cases, ISNP will block all attacks. <br><br>  Send URL_MANY_SLASHES attack easily: <br><br><ul><li>  To trigger an event, enter more than 500 slashes in the HTTP request. </li><li>  Open a web browser, and enter this URL: http: //: 8000 /////////////...../////////// /////////// <br><br><br>  To send the URL_MANY_SLASHES attack, you can also use the command: <br><br><pre> <code class="hljs objectivec"><span class="hljs-meta"><span class="hljs-meta"># wget http://10.40.25.10:8000/`python -c </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"print '/'*500"</span></span></span><span class="hljs-meta">`</span></span></code> </pre> <br><br>  After sending the attack, check the security events in the Event Log view. <br><br>  Select IPS Events (IPS Events) and you can see all ISNP blocked security events.  (Fig.14) <br><br>  Fig.14 <br><img src="https://habrastorage.org/files/530/3f6/d44/5303f6d44628411e9c92df5c90dea93e.png" alt="image">  . </li></ul></div><p>Source: <a href="https://habr.com/ru/post/243885/">https://habr.com/ru/post/243885/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../243869/index.html">With a decade, Firefox!</a></li>
<li><a href="../243871/index.html">Evernote for Android appeared scanning business cards</a></li>
<li><a href="../243873/index.html">High Frequency Neighborhood Trading - Part II</a></li>
<li><a href="../243875/index.html">Memes in Parallels: "The release will be on May 1 ... And today what is May?"</a></li>
<li><a href="../243877/index.html">New LittleBits - now banana (actually with Wi-Fi)</a></li>
<li><a href="../243887/index.html">Cisco CCENT certification: you should [not] pass</a></li>
<li><a href="../243889/index.html">"Protection against a fool" or how to prohibit changing / deleting important folders</a></li>
<li><a href="../243891/index.html">Opera application store will replace the Nokia Store in smartphones and Nokia phones</a></li>
<li><a href="../243895/index.html">Security Virtualization. Part 2</a></li>
<li><a href="../243897/index.html">Honeymoon Manager: Part 2</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>