<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>My system is testing and improving the quality of the GSM gateway. Part two</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the first part of the article I told the background of the FXS GSM gateway with the recording of the conversation, explained what mistakes were mad...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>My system is testing and improving the quality of the GSM gateway. Part two</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/6b3/e9a/d14/6b3e9ad148694fcdaaba870fb1df3684.png"><br><br>  <a href="http://habrahabr.ru/post/262531/">In the first part of the article</a> I told the background of the FXS GSM gateway with the recording of the conversation, explained what mistakes were made in the first version, as were corrected in the second version.  The heart of the gateway has become a microcontroller that manages everything: power, sound (digital and analog), telephone line. <br><br>  A self-diagnostic function has been implemented in the circuit.  For this purpose, measuring circuits, power control and handset lifting circuits, a circuit for load testing of power and critical nodes were added to the gateway.  For communication with a PC and flashing a USB-USART bridge is installed, which can work as a programmer. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In this and the next article I will talk about the test firmware: how it tests all the peripherals, what ideas were embedded in it and how they were implemented using the example of test log analysis. <br>  Test firmware checks: <br><ul><li>  Clock frequency, accurate to ppm. </li><li>  All power lines. </li><li>  All the legs of the processor. </li><li>  LEDs. </li><li>  The source of the telephone line. </li><li>  Sending and receiving sound from the telephone line.  <abbr title="Amplitude frequency response">Frequency response</abbr> , <abbr title="The coefficient of non-linear distortion, it is THD">SOI</abbr> noise level. </li><li>  GSM module. </li><li>  SD card. </li></ul><br>  <a href="http://pastebin.com/3BtixAGx">Test log entirely</a> <br><br>  I did not find a single article on the habr about the program of production testing of an actual product.  Therefore, I hope I am the first.  If not, I would love to read articles from others. <br><a name="habracut"></a><br><br><h2>  Elements of the diagnostic system </h2><br>  <b>Test firmware</b> for the initial diagnosis and screening after assembly.  Performed in the device.  Makes all diagnostics without the help of a PC.  Produces results in a production program on a PC.  When you first start, it runs all the tests.  Subsequent requests that what to do: either run all the tests, or one group of tests to choose from, or manual control mode. <br><br>  <b>The main firmware</b> for customers.  Performed in the device.  It is flashed automatically by the production program after successful tests without a single error. <br><br>  <b>The PC production program</b> is a complex of several programs that flushes the gateway with test or basic firmware for the client.  It connects to the device and logs data from it.  Sends the pressed buttons F1 ... F9, ESC to the running firmware.  Keeps an archive of logs.  Logs IMEI, serials, firmware versions and user action logs.  Calculates statistics, the number of errors.  Performs synchronization between the workplaces of builders, developer and metrologist.  Allows you to cut logs for a given parameter, etc.  About this in the third part of the article. <br><br>  <b>The test echo gateway</b> is a gateway with a special firmware, which in the echo mode produces a received sound to the GSM network.  Used in the test firmware for a trial outgoing call, for testing the sound over the GSM channel and checking the stability of the GSM module. <br><br>  <b>A simple firmware program</b> , a simplified version of the production program, allows you only to flash and get the log from the device without the ability to control the firmware and keep the remaining logs with a statistics calculation.  It is provided to clients for diagnosis.  It also allows you to update the firmware through our bootloader with firmware encryption. <br><br>  <b>The web server is</b> used to synchronize data, archive and backup logs and reports, to issue the firmware GPRS-loader. <br><br><h2>  Ideas implemented in the test program </h2><br>  <b>Log convenient for production.</b>  In this log, all data of the same type must be aligned into tables, the values ‚Äã‚Äãare signed with clear values, the limits of tolerances are indicated.  All actions are shown, including dummy messages that help you understand whether the program is frozen or not. <br><br>  <b>Log convenient for the developer.</b>  Intermediate indicators are derived, on the basis of which final indicators are calculated, on which conclusions are made.  In the log should be service information: the date of the source, a unique ID from the MK. <br><br>  <b>Log convenient for a metrologist.</b>  All measurements must be excessively accurate (for example, millivolts, millidebicles, etc.).  This allows you to see how close the value has come to the border of the range or how much it has exceeded the border.  If there is a lot of data and the limits are not indicated for the entire line, then the rating of the indicator, which deviated the most, is displayed.  Due to this, it is convenient to run through the eyes of the rating figures and see that some indicator has come close to the range boundary.  The rating is at the end of the line the last digit from -9 to +9, where 0 is the middle of the allowed range. <br><br>  <b>Indication of communication channel failure.</b>  The log displays characters only in 7-bit ASCII mode, only in Latin on my curve aglitsky.  The serial port is configured for 8 bits with parity.  In a production program that displays a log, all lines with characters that have code less than 32 or more than 127 are counted as errors and are displayed in bright red. <br><br>  <b>Convenient processing by third-party programs.</b>  For this, all measured values ‚Äã‚Äãand tables of values ‚Äã‚Äãare framed by tabs.  This format is convenient to use in the database or Excell.  The production program should be able to highlight the rate of one color, and the error - a different color.  For this, the standard is signed with the word ‚ÄúOK‚Äù, and the error - ‚ÄúERROR‚Äù.  Norms and errors are counted, their statistics and indexing are in progress. <br><br>  <b>The possibility of statistics.</b>  Each parameter must have its own unique name.  By this name in the production program, you can cut across all the logs, see how the selected parameter has changed, and build a graph. <br><br>  <b>Self sufficiency.</b>  Tests should test multiple parameters many times and in different ways.  They must be redundant.  As many indicators as possible should be duplicated by other direct and indirect measurements made by other algorithms and methods.  Otherwise, it will be unclear what fails: the circuit, the board, the testing algorithm itself or the wrong actions.  Yes, and in the analysis it is much easier to see the totality than to make yourself a ‚Äúkeyhole‚Äù into one single measurement. <br><br>  <b>The log should not be huge.</b>  Part of the parameters had to be done without a signature limit, because  There are a lot of them, and the log should not exceed ten pages. <br><br>  The hardest part was to combine all these requirements.  Due to the size limit, we had to sacrifice the convenience for production and make a crutch with a rating of -9 ... +9.  Other things, such as the definition of email.  parameters of each pin, also had to be turned into "magic numbers", adding some kind of conclusion for each pin.  Production still criticizes me that there are quite a few obscure meanings, but this is such a compromise.  Something was left, simply because it was crookedly done, and it was too late to redo it - people got used to it. <br><br><h1>  Testing Log Description </h1><br><br><h3>  Enable and service information <br><img src="https://habrastorage.org/files/de0/77f/780/de077f7800bd4289b50b81d05ff4fb5d.png"><br></h3>  At the start of the test firmware, the header and the compilation dates of all files included in the project are displayed.  Next, a unique Chip ID number is issued in three formats, two of which are protected from manual modification with a 16-bit hash, which is considered to be two different algorithms. <br><br>  Next, the serial number is displayed, and it defines the type of gateway and selects a testing profile.  At the moment there are three types of gateways: with recording of conversations, without recording of conversations, small size and budget without recording of conversations and without USB.  Circuit design of all three is the same, except for the presence of USB and SD-card. <br><br>  Further the flag of the first start is checked and reset.  If the first run, then run all the tests.  If not, a launch menu is displayed. <br><br><h3>  Check quartz clock frequency <br><img src="https://habrastorage.org/files/86a/131/5c9/86a1315c9689421fb5a14676d4c03a50.png"><br></h3>  The following is checked: whether external quartz is running at 8 MHz, if the quartz instability protection has not worked, whether both <abbr title="PLL, also known as PLL - phase locked loop">PLLs</abbr> are running and working stably, whether the final frequency corresponds to the required one.  One PLL for peripherals and cores multiplies the frequency up to 160 MHz, and the other divides the frequency up to 256 kHz for digital <abbr title="an electrical serial bus interface standard used to connect digital audio devices">I2S</abbr> sound into a GSM module. <br>  Only after checking the clock frequency does it make sense to check the remaining parameters. <br><br><h3>  Check quartz watch <br><img src="https://habrastorage.org/files/91a/ebc/9ad/91aebc9ad6b84481b797cf336b88c64c.png"><br></h3>  Quartz is launched, the time for which it was launched is displayed.  Next, one second is measured in base frequency clock, and the deviation is calculated in ppm relative to the base frequency of 160 MHz. <br><br><h3>  Verification of main voltages <br><img src="https://habrastorage.org/files/1ee/31f/f41/1ee31ff41fba43c387f659b3281db9bc.png"><br></h3> Within a second, 100,000 samples are taken over a specific ADC channel. <br>  and the following indicators are calculated (from left to right): <br><ul><li>  constant component (in millivolts taking into account dividers on resistors); </li><li>  low frequency component (if it is significantly higher than the high frequency component, then these are pickups from the network); </li><li>  high-frequency component (if it is significantly larger than the low-frequency component, then it is a crash or an unstable ADC); </li><li>  maximum range in ADC samples; </li><li>  The worst score is from -9 to +9. </li></ul>  Low-frequency and high-frequency components are measured in thousandths of the ADC.  On the ADC, there is almost always some white noise, so it‚Äôs normal when both these indicators are approximately equal or the HF is slightly higher than the LF. <br>  This test is used further in many other tests. <br><br>  Measured values: <br><ul><li>  <b>DIAG_SENS</b> - GSM-module power sensor (in the initial state it is turned off and should not ‚Äúmiss‚Äù and make noise); </li><li>  <b>SLIC_LINEU</b> - voltage in the telephone line (in the initial state, the line should be turned off and not make noise); </li><li>  <b>FXS_ADC</b> - sound from the telephone line (not issued during the test - it means there should be silence and half power); </li><li>  <b>DVCC</b> - digital power supply MK (there should be no noise); </li><li>  <b>SD_VCC</b> - digital power to the SD card (must be turned off); </li><li>  <b>12V_PWR</b> - general power supply 12 V; </li><li>  <b>DVCC-Vbat</b> - digital power supply of the watch module from a lithium tablet battery; </li><li>  <b>VrefInt</b> - internal reference voltage of 1.2 V (they check analog power supply and ADC support); </li><li>  <b>Temp in C</b> - temperature and its change after the second measurement after running all the tests (the gateway should not heat up). </li></ul>  These measurements are done twice: at the beginning of all other tests and after them.  This is done in order to verify that after the rest of the tests the equipment has returned to its original state.  Temperature measurement controls the self-heating or cooling of the board, if it was put into testing immediately after assembly and melting in the furnace. <br><br><h3>  Check for short circuit legs MK to the ground or power <br><img src="https://habrastorage.org/files/d61/6e3/812/d616e38121ef4dc4b07755aa708409de.png"><br></h3>  All MK legs are checked, not even connected.  This is done to control the quality of the soldering. <br>  They are checked by writing ‚Äú0‚Äù and checking that ‚Äú0‚Äù is read.  Then ‚Äú1‚Äù is written and the reading of ‚Äú1‚Äù is checked.  So 100 times, because different peripherals are connected to a number of legs, which can give a false positive with a single test. <br><br><h3>  Check for short-circuit adjacent legs MK among themselves <br><img src="https://habrastorage.org/files/846/784/5eb/8467845eb2d648da936874451fc2fae5.png"><br></h3>  Similar to the previous test, only the recording is made on one leg of the MK, and the reading is from the next.  There are also 100 attempts: 50 of them in one direction, 50 in another.  Numbers indicate successful attempts.  The values ‚Äã‚Äã25 ... 50 are obtained because part of the legs is connected to a working circuit, and a fixed value of ‚Äú0‚Äù or ‚Äú1‚Äù is fed to them, therefore, part of the tests reveal false positives.  Because of this, the threshold is chosen close to 100. <br><br><h3>  Checking the electrical parameters of the legs MK <br><img src="https://habrastorage.org/files/3a1/27c/3d8/3a127c3d882e43f7b743aa2b228cf910.png"><br></h3>  And here is the magic that works like this: <br>  1. The foot is adjusted to the output "1", then transferred to the input mode and measured the time it takes to go to "0". <br>  2. The foot is adjusted to the output "0", then transferred to the input mode and the time is measured, during which it will go to "1". <br>  3. and 4. Similarly to p. 1 and p. 2, but translated into a mode with a lift to the ground or power - this helps to quickly move to "0" or "1". <br>  These actions can measure the capacity at the leg and the presence of braces, even high resistance.  But the measurement is very rough, because the delays depend on the size of the suspender inside the MC, and it can change 10 times.  There is also a dependence on temperature, which can vary widely. <br>  Time values ‚Äã‚Äãare presented on a logarithmic scale.  According to the results of the implementation of paragraphs 1..4, these values ‚Äã‚Äãare written in the first four numbers in each line. <br>  All legs are checked, including the UART.  In this case, the UART are bad symbols. <br><br>  The types of parameters in this test are: <br><ul><li>  <b>hi_Z</b> is a high-impedance state with a very small capacity, less than 10 pF; </li><li>  <b>hi_Z + C_pF</b> - high-impedance state with a capacity of 10 ... 1000 pF; </li><li>  <b>hi_Z + C_nF</b> is a high-impedance state with a capacity of 1 ... 1000 nF; </li><li>  <b>hi_Z + C_uF</b> is a high-impedance state with a capacity of 1 ¬µF and above; </li><li>  <b>Pull_Down</b> - low impedance lift to the ground; </li><li>  <b>Pull_Down_M</b> - high impedance lift to the ground; </li><li>  <b>Pull_Up</b> - low impedance power supply; </li><li>  <b>Pull_Up_M</b> - high impedance power lift; </li><li>  <b>FIXED</b> - the condition of the legs does not depend on the actions on it; </li><li>  <b>(empty line)</b> - the state could not be determined (for example, on the leg to which the OU output of the sound from the line is connected). </li></ul><br><br><h3>  Check two color LEDs <br><img src="https://habrastorage.org/files/80d/1f8/0a1/80d1f80a18a54192bd3979726f54f2ab.png"><br></h3>  Each two-color LED represents two oppositely-on LEDs of different colors.  The essence of the test lies in the fact that 1 or 0 is fed to one leg of the LED, or a pull-up to ground or power, or high impedance.  And on the other leg of the LED, the reaction of the electrical state to this effect is checked.  Then they switch places and the decision is made based on the results. <br>  For example, at the 62 terminals, we turn on the ‚ÄúVD1_MCU_62 pull up‚Äù power-up pull-up, measure the state of the 61-pin - it also became a pull-up, but high-resistance ‚ÄúVD1_MCU_61 Pull_UP_M‚Äù. <br><br>  Not all LEDs are turned on equally, some have braces or other functions.  This is taken into account in the LED test log.  For example, this behavior can be seen on the test results, if you look at the <a href="http://pastebin.com/3BtixAGx">full log</a> and compare it with <a href="">the MK scheme from the first article</a> . <br><br>  In the next part, I will tell you how the telephone line is checked (voltage source, sound output and reception), SD card, power supply under load, and how their parameters are calculated.  And at the end of the article I will draw conclusions and conclusions on the test firmware. </div><p>Source: <a href="https://habr.com/ru/post/264045/">https://habr.com/ru/post/264045/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../264035/index.html">Chat assistant to the site using Telegram in 15 minutes</a></li>
<li><a href="../264037/index.html">Advanced CSS filters</a></li>
<li><a href="../264039/index.html">Free grid control for Xamarin from DevExpress</a></li>
<li><a href="../264041/index.html">Will GCC C ++ be better for AVR and Arduino?</a></li>
<li><a href="../264043/index.html">FP9: The ability to dig and dig</a></li>
<li><a href="../264047/index.html">NGFW. Part 3 - Demonstration of DDoS Protection</a></li>
<li><a href="../264049/index.html">Third extra: how we implemented mail collection using OAuth 2.0</a></li>
<li><a href="../264051/index.html">Office as Platform issue 2: Power BI - a new approach to creating business intelligence</a></li>
<li><a href="../264057/index.html">InterSystems Ensemble 2015.1 and 2015.2 release</a></li>
<li><a href="../264059/index.html">We limit the load on the server. Cheap and angry</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>