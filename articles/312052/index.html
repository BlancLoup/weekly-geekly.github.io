<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Pro security in phpBB</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good afternoon friends! I will begin with the fact that with php and phpbb I am familiar with the need that we use this forum on our project, since we...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Pro security in phpBB</h1><div class="post__text post__text-html js-mediator-article">  Good afternoon friends!  I will begin with the fact that with php and phpbb I am familiar with the need that we use this forum on our project, since we have not found a more worthy alternative.  In addition to periodic updates with php, I do not come across and the features of the work of this forum are not familiar with. <br><br>  Recently a terrible thing happened - our server with uptime a little less than a year (after the last migration) rebooted.  On the server, the actual site and forum phpbb 3.0.12 is deployed. <br><a name="habracut"></a><br>  The /var/log/auth.log is uninformative <br><br><pre><code class="bash hljs">Oct 6 09:36:21 fsr sudo: pam_unix(sudo:auth): auth could not identify password <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> [www-data] Oct 6 09:36:21 fsr sudo: www-data : user NOT <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> sudoers ; TTY=unknown ; PWD=/ ; USER=root ; COMMAND=...</code> </pre> <br>  Not finding any more details restored the work site.  The next day I discovered more important information. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre> <code class="bash hljs">Oct 5 22:55:55 fsr su[18114]: pam_unix(su:auth): authentication failure; logname= uid=33 euid=0 tty=/dev/pts/21 ruser=www-data rhost= user=admin Oct 5 22:55:57 fsr su[18114]: FAILED su <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> admin by www-data Oct 5 22:55:57 fsr su[18114]: - /dev/pts/21 www-data:admin Oct 5 22:57:50 fsr su[18310]: pam_unix(su:auth): authentication failure; logname= uid=33 euid=0 tty=/dev/pts/21 ruser=www-data rhost= user=admin Oct 5 22:57:52 fsr su[18310]: FAILED su <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> admin by www-data Oct 5 22:57:52 fsr su[18310]: - /dev/pts/21 www-data:admin Oct 5 22:58:39 fsr su[18384]: Successful su <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> admin by www-data Oct 5 22:58:39 fsr su[18384]: + /dev/pts/21 www-data:admin</code> </pre><br>  That is, access has been obtained.  This time, several interesting processes were found running from www-data. <br><br><pre> <code class="bash hljs">ps aux|grep www-data</code> </pre> <br><pre> <code class="bash hljs">perl /tmp/bp.pl 31337 /bin/sh -i import pty; pty.spawn( /bin/sh )</code> </pre> <br>  First of all I update the forum to the latest version of phpBB 3.1.9 at the moment.  After that, I kill the processes and wait for new entries in auth.log.  It turned out that it is not necessary at all - after a while the nailed processes appeared again. <br><br>  Go to / var / www / forum, do: <br><br><pre> <code class="bash hljs">ack-grep -l <span class="hljs-string"><span class="hljs-string">'\.pl'</span></span></code> </pre><br>  Especially you need to pay attention to the files * .php, marked as executable.  My attention was drawn to a file called <b>members.php</b> with the flag turned on for execution, in which both <b>bp.pl</b> and the well-known port 31337 were encountered. This file is not in the list of files from the phpBB archive.  I delete the file, in the logs of nginx and apache constant requests to this file were found.  I do grep again, <b>lo</b> and <b>behold</b> - this time the executable <b>ucpi.php is found</b> , with the same content.  By the way, the initial exploit code was found on github, it helped a lot. <br><br>  The process of updating phpBB is quite convenient - the main part of the folder is updated, but there are folders that are transferred from the previous version of the project.  I have thus exploits migrated to the updated forum. <br><br>  Now it seems the problem has been solved, but from time to time I will look at auth.log, the list of processes and the source code should be checked.  Maybe my opinion is not objective, but even for our forum this is not the first invasion of hackers and this is one of the reasons for my cool attitude to php in general and phpBB in particular. <br><br>  I would be interested to know how relevant this information is and how widespread this vulnerability is. <br><br>  Thanks for attention. <br><br>  <b>UPD.</b>  Thank you for the warm welcome and support.  Your feedback really came in handy for me!  The server was successfully recaptured.  <a href="https://habrahabr.ru/users/paulatreides/" class="user_link">Special</a> thanks for the help of <a href="https://habrahabr.ru/users/paulatreides/" class="user_link">PaulAtreides</a> . </div><p>Source: <a href="https://habr.com/ru/post/312052/">https://habr.com/ru/post/312052/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../312040/index.html">IaaS and GaaS: The Cloudy Future of Video Games</a></li>
<li><a href="../312042/index.html">‚ÄúWhat is the benefit?‚Äù: Feasibility study of using IaaS</a></li>
<li><a href="../312044/index.html">IaaS Digest: Introducing Virtual Infrastructure</a></li>
<li><a href="../312046/index.html">2D magic in detail. Part two. Structure</a></li>
<li><a href="../312048/index.html">Possible innovations of C #</a></li>
<li><a href="../312054/index.html">Immersion in the blockchain technology: Combating counterfeit goods</a></li>
<li><a href="../312056/index.html">Finding Java bytecode vulnerabilities: what to do with the results?</a></li>
<li><a href="../312058/index.html">How we helped conduct a medical census in the Republic of Bangladesh</a></li>
<li><a href="../312060/index.html">The logic of consciousness. Explanation "on the fingers"</a></li>
<li><a href="../312062/index.html">How to choose an in-memory NoSQL database wisely. Testing performance</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>