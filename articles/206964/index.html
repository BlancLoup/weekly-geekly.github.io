<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Install and configure Asterisk under iD Phone (iDPhone)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This manual describes how to install and make the initial setup of computer telephony based on Asterisk from scratch with connection to the Kazakh Tel...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Install and configure Asterisk under iD Phone (iDPhone)</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/f20/af2/1ea/f20af21eac9d77fe66b6b12ecf925401.jpg"><br><br>  This manual describes how to install and make the initial setup of computer telephony based on Asterisk from scratch with connection to the Kazakh Telecom company‚Äôs iD Phone service from scratch. <br><br>  I got some ideas from this article: <a href="http://habrahabr.ru/post/198684/">‚ÄúA step-by-step guide on binding SIP numbers to Elastix (FreePBX, Asterisk) using the example of the Megaline iDPhone provider‚Äù</a> (many thanks to <a href="http://habrahabr.ru/users/asdforever/" class="user_link">asdForever</a> for this), but: <br><ul><li>  first, the system did not work for me according to the instructions; </li><li>  secondly, I do not agree with all the decisions in it; </li><li>  thirdly, we will configure not ‚ÄúElastix‚Äù, but ‚ÄúAsteriskNow‚Äù; </li><li>  Fourth, I tried to write instructions as detailed as possible - for people with little knowledge of Linux systems and Asterisk (which I myself am). </li></ul><br>  Given: <br><ol><li>  The operating system will be installed from scratch.  The distribution package ‚ÄúAsteriskNOW‚Äù will be used - this is the operating system ‚ÄúCentOS‚Äù with the pre-installed software ‚ÄúAsterisk‚Äù and the web interface for its management ‚ÄúFreePBX‚Äù.  In other words, in this manual there is no block in which the installation of ‚ÄúAsterisk‚Äù on an already deployed Linux system would be described. </li><li>  Kazakhtelecom does not provide the iD Phone service via the Internet, but by connecting subscribers to its special SIP network.  Physically, of course, this is most often one channel (ADSL or optics) together with the Internet and / or ‚ÄúiD TV‚Äù.  The router also provides the services provided to different ports.  We believe that we already have a configured router that sends Internet from one port, and iD Phone from another. </li><li>  The computer has two network cards: one of them looks into the Internet, the other - into the Kazakhtelecom's SIP-network. </li></ol><br>  Task: <br>  Get a working IP PBX with Internet access. <br><a name="habracut"></a><br>  Decision: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Download ‚ÄúAsteriskNOW‚Äù from here: <a href="http://www.asterisk.org/downloads">http://www.asterisk.org/downloads</a> <br><br>  Install AsteriskNOW: <br><div class="spoiler">  <b class="spoiler_title">AsteriskNOW installation screenshots</b> <div class="spoiler_text"><img src="https://habrastorage.org/getpro/habr/post_images/7c6/765/3fc/7c67653fc2d3c4e27183e045a79bca55.jpg"><br><br><img src="https://habrastorage.org/getpro/habr/post_images/ae2/f64/2a8/ae2f642a826e4892978a5f76d77994b2.jpg"><br><br><img src="https://habrastorage.org/getpro/habr/post_images/c6a/c08/cca/c6ac08cca12d06d3c7b5196a4a12c814.jpg"><br><br><img src="https://habrastorage.org/getpro/habr/post_images/4c3/333/5b0/4c33335b06514b563b81c8a0adf7db9f.jpg"><br><br><img src="https://habrastorage.org/getpro/habr/post_images/d9a/233/e7c/d9a233e7cb4b0e81b004c1f33501736a.jpg"><br><br><img src="https://habrastorage.org/getpro/habr/post_images/4bc/582/e8e/4bc582e8e566d453f66aee58fea7e6b4.jpg"></div></div><br>  We log in as root and password, which was set during installation. <br><br>  I use the Midnight Commander file manager to edit files.  To install it, issue the following command: <br><pre><code class="bash hljs">yum install mc</code> </pre> <br>  This command will work if your computer has already gained access to the Internet.  This may not happen for the reasons described below.  Then you can temporarily disconnect the network cable from the interface, which looks into the Kazakhtelecom's SIP network. <br>  We agree on everything.  When you need to edit a file, run the "Midnight Commander" command: <br><pre> <code class="bash hljs">mc</code> </pre> <br>  Add the Russian language to the operating system.  To do this, first install the language settings management utility: <br><pre> <code class="bash hljs">yum install system-config-language</code> </pre> <br>  Install the Russian language.  To do this, run the installed utility: <br><pre> <code class="bash hljs">system-config-language</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">Screenshots of the Russian language installation</b> <div class="spoiler_text"><img src="https://habrastorage.org/getpro/habr/post_images/07f/401/306/07f401306b5e824f51eecb4597659b15.jpg"><br><br><img src="https://habrastorage.org/getpro/habr/post_images/221/56e/d7a/22156ed7a282d66985428ee0ccd0b6cf.jpg"></div></div><br>  In order for the changes to take effect, you must exit the terminal and enter it again.  After that, for example, in ‚ÄúMidnight Commander‚Äù the interface will be in Russian. <br><br>  We check that both network interfaces work.  We give the command: <br><pre> <code class="bash hljs">ifconfig</code> </pre> <br>  I have the following conclusion: <br><div class="spoiler">  <b class="spoiler_title">Output of the ifconfig command on a single interface</b> <div class="spoiler_text"><pre> <code class="bash hljs">eth0 Link encap:Ethernet HWaddr 00:15:5D:7B:4F:18 inet addr:192.168.0.52 Bcast:192.168.0.255 Mask:255.255.255.0 inet6 addr: fe80::215:5dff:fe7b:4f18/64 Scope:Link UP BROADCAST RUNNING MULTICAST MTU:1500 Metric:1 RX packets:5695 errors:0 dropped:0 overruns:0 frame:0 TX packets:3363 errors:0 dropped:0 overruns:0 carrier:0 collisions:0 txqueuelen:1000 RX bytes:7623500 (7.2 MiB) TX bytes:241151 (235.4 KiB) Interrupt:9 Base address:0xc000 lo Link encap:Local Loopback inet addr:127.0.0.1 Mask:255.0.0.0 inet6 addr: ::1/128 Scope:Host UP LOOPBACK RUNNING MTU:16436 Metric:1 RX packets:0 errors:0 dropped:0 overruns:0 frame:0 TX packets:0 errors:0 dropped:0 overruns:0 carrier:0 collisions:0 txqueuelen:0 RX bytes:0 (0.0 b) TX bytes:0 (0.0 b)</code> </pre> </div></div><br>  This means that only one interface is active.  Activate the second interface.  To do this, you must edit the file <b>/ etc / sysconfig / network-scripts / ifcfg-eth1</b> .  The value of the ONBOOT parameter must be changed from ‚Äúno‚Äù to ‚Äúyes‚Äù. <br>  We give the command to restart the network interfaces: <br><pre> <code class="bash hljs">service network restart</code> </pre> <br>  Once again we give the command: <br><pre> <code class="bash hljs">ifconfig</code> </pre> <br>  And we already have a new conclusion: <br><div class="spoiler">  <b class="spoiler_title">Output of the ifconfig command via two interfaces</b> <div class="spoiler_text"><pre> <code class="bash hljs">eth0 Link encap:Ethernet HWaddr 00:15:5D:7B:4F:18 inet addr:192.168.0.52 Bcast:192.168.0.255 Mask:255.255.255.0 inet6 addr: fe80::215:5dff:fe7b:4f18/64 Scope:Link UP BROADCAST RUNNING MULTICAST MTU:1500 Metric:1 RX packets:5981 errors:0 dropped:0 overruns:0 frame:0 TX packets:3503 errors:0 dropped:0 overruns:0 carrier:0 collisions:0 txqueuelen:1000 RX bytes:7646872 (7.2 MiB) TX bytes:281444 (274.8 KiB) Interrupt:9 Base address:0xc000 eth1 Link encap:Ethernet HWaddr 00:15:5D:7B:4F:19 inet addr:10.2.XX Bcast:255.255.255.255 Mask:255.255.255.0 inet6 addr: fe80::215:5dff:fe7b:4f19/64 Scope:Link UP BROADCAST RUNNING MULTICAST MTU:1500 Metric:1 RX packets:2 errors:0 dropped:0 overruns:0 frame:0 TX packets:21 errors:0 dropped:0 overruns:0 carrier:0 collisions:0 txqueuelen:1000 RX bytes:684 (684.0 b) TX bytes:4379 (4.2 KiB) Interrupt:9 Base address:0xe000 lo Link encap:Local Loopback inet addr:127.0.0.1 Mask:255.0.0.0 inet6 addr: ::1/128 Scope:Host UP LOOPBACK RUNNING MTU:16436 Metric:1 RX packets:0 errors:0 dropped:0 overruns:0 frame:0 TX packets:0 errors:0 dropped:0 overruns:0 carrier:0 collisions:0 txqueuelen:0 RX bytes:0 (0.0 b) TX bytes:0 (0.0 b)</code> </pre></div></div><br>  Now it is clear that both interfaces were activated.  We will understand which of them is looking. <br>  eth0 received the address from the subnet 192.168.0.X - this is the interface that looks to the Internet.  It is from this subnet that the router's DHCP server distributes addresses. <br>  eth1 received an address from the 10.XXX subnet - this is an interface that looks into the Kazakhtelecom's SIP network.  It is from this subnet that the Kazakhtelecom‚Äôs DHCP server distributes addresses. <br><br>  But now we are closer to the problem that hinders the simultaneous functioning of access to the Internet and to the Kazakhtelecom SIP network.  For a better understanding, we will give the command: <br><pre> <code class="bash hljs">route</code> </pre><br>  We get the output: <br><div class="spoiler">  <b class="spoiler_title">Route command output</b> <div class="spoiler_text"><pre> <code class="bash hljs">Kernel IP routing table Destination Gateway Genmask Flags Metric Ref Use Iface 192.168.0.0 * 255.255.255.0 U 0 0 0 eth0 10.2.X.0 * 255.255.255.0 U 0 0 0 eth1 link-local * 255.255.0.0 U 1002 0 0 eth0 link-local * 255.255.0.0 U 1003 0 0 eth1 default 10.2.X.1 0.0.0.0 UG 0 0 0 eth1</code> </pre></div></div><br>  What conclusion can be made from this?  We have a default gateway 192.168.0.1 (the IP-address of the router) assigned to the first interface.  But along with obtaining the IP address, the gateway address comes to the second interface from the Kazakhtelecom's DHCP server, which interrupts the one installed on the first interface.  After that, all Internet traffic starts to go to Kazakhtelecom's SIP network.  Let's remember the address of the Kazakhtelecom gateway - we may need it further.  In my case, 10.2.X.1. <br>  To eliminate the problem of gateway conflict, let the second interface get only those parameters from the DHCP server that do not interfere with the first interface operation.  To do this, create the file <b>/etc/dhclient-eth1.conf</b> - this is the configuration file of the DHCP client.  The following lines should be added to the file: <br><pre> <code class="bash hljs">reject 192.168.0.1; send host-name <span class="hljs-string"><span class="hljs-string">"asterisk"</span></span>; request subnet-mask, broadcast-address, time-offset, host-name;</code> </pre> <br>  Concerning the first line.  I had a problem with one of the D-Link routers - even when the DHCP server was disabled, the router assigned an address to the interface connected to Kazakhtelecom's SIP network.  The first line of the configuration file prevents the eth1 interface from receiving an IP address from a DHCP server from 192.168.0.1. <br>  So, we have achieved that the default gateway remains a router.  This solution creates another problem - part of the telephony traffic would have to go to the SIP network, but it will go to the Internet.  For the normal functioning of telephony, it is necessary that the SIP-network interface leaves not only the traffic having a subnet 10.2.X.X (in my case), but all the traffic for the 10.X.X.X. subnet.  To do this, create the file <b>/ etc / sysconfig / network-scripts / route-eth1</b> and add the following line to it: <br><pre> <code class="bash hljs">10.0.0.0/8 dev eth1</code> </pre> <br>  Sometimes this line is not enough.  In Petropavlovsk, for example, the above option works, but in Astana it was required to clearly indicate the address of the gateway to the Kazakhtelecom subnetwork.  It is done this way: <br><pre> <code class="bash hljs">10.0.0.0/8 via 10.2.X.1 dev eth1</code> </pre> <br>  10.2.X.1 is the address of Kazakhtelecom‚Äôs gateway for my case.  I don‚Äôt really like this decision because  Kazakhtelecom may change the address of its gateway at any time, but I don‚Äôt know how to do it better.  In theory, you must first somehow get the gateway address via DHCP, and then create a route through this address. <br><br>  We configure a static IP address on the interface that looks to the Internet, and in combination to a local area network, where SIP clients of our IP PBX will be deployed in the future.  For this we give the command: <br><pre> <code class="bash hljs">system-config-network</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">Screenshots of static IP settings</b> <div class="spoiler_text"><img src="https://habrastorage.org/getpro/habr/post_images/880/fba/902/880fba902c9d1e13042d970bdd05835c.jpg"><br><br><img src="https://habrastorage.org/getpro/habr/post_images/6f1/942/cf4/6f1942cf47a86638d7ed1c689d74b4e4.jpg"><br><br><img src="https://habrastorage.org/getpro/habr/post_images/306/efb/14f/306efb14fe8e2622d422514c38c4df0d.jpg"><br><br><img src="https://habrastorage.org/getpro/habr/post_images/691/168/c6a/691168c6a6f404be7fe34dd94e387fb1.jpg"><br><br><img src="https://habrastorage.org/getpro/habr/post_images/a9c/494/1c1/a9c4941c1817d1b2aaf942ed98ebb2a2.jpg"><br><br><img src="https://habrastorage.org/getpro/habr/post_images/ea0/26b/d96/ea026bd96ce2c8ad9e0e20fdb912dc93.jpg"><br><br><img src="https://habrastorage.org/getpro/habr/post_images/904/ac0/d54/904ac0d54d89c617cea6e8a64585f59d.jpg"></div></div><br>  We give the command to restart the network interfaces: <br><pre> <code class="bash hljs">service network restart</code> </pre> <br>  In the further configuration of our IP PBX, we will repeatedly refer to the name of the SIP server of Kazakhtelecom: sip.telecom.kz.  With the current configuration of our computer, this name is resolved to the white IP address 92.46.61.21.  We need to ensure that this name is resolved to the IP address of the Kazakhtelecom SIP network. <br>  First you need to know the internal IP address of the server that is defined for your region.  To do this, open the following page: <a href="http://idphone.kz/%3Fpage_id%3D1010">http://idphone.kz/?page_id=1010</a> .  It has an Outbound Proxy address table when setting up an iD Phone service via pvc 0/41.  It is in it that we look for the address we need. <br>  Just in case, I will quote this table here: <br><blockquote>  Aktau 10.0.0.44 <br>  Aktobe 10.0.0.36 <br>  Almatytelecom 10.0.0.12 <br>  Astanatelecom 10.0.0.20 <br>  Atyrau 10.0.0.28 <br>  Karaganda 10.0.0.148 <br>  Kokshetau 10.0.0.140 <br>  Kostanay 10.0.0.129 <br>  Kyzylorda 10.0.0.60 <br>  Pavlodar 10.0.0.108 <br>  Petropavlovsk 10.0.0.116 <br>  Semey 10.0.0.92 <br>  Shymkent 10.0.0.68 <br>  Taldy-Korgan 10.0.0.84 <br>  Taraz 10.0.0.76 <br>  Uralsk 10.0.0.52 <br>  Ust-Kamenogorsk 10.0.0.100 <br>  Zhezkazgan 10.0.0.156 </blockquote><br>  Now add the following line to the <b>/ etc / hosts</b> file: <br><pre> <code class="bash hljs">10.0.0.116 sip.telecom.kz</code> </pre> <br>  This is for Petropavlovsk (my case).  Replace the address 10.0.0.116 with the appropriate one for your region. <br><br>  Make sure everything works correctly.  We give the command: <br><pre> <code class="bash hljs">ping 8.8.8.8</code> </pre> <br>  If ping goes, then the computer has access to the Internet. <br>  We give the command: <br><pre> <code class="bash hljs">ping ya.ru</code> </pre> <br>  If the name is resolved, then DNS is working correctly. <br>  We give the command: <br><pre> <code class="bash hljs">ping 10.0.0.1</code> </pre> <br>  If ping goes, then the computer has access to Kazakhtelecom's SIP network.  At the time of writing this article in the Kazakhtelecom network, the addresses were pinged 10.0.0.1, 10.0.0.2, 10.0.0.3.  But, in fact, the lack of ping can not 100% say that you have problems with the setting.  The fact is that Kazakhtelecom can close the ping on its servers at any time.  For example, the address 10.0.0.116 at the time of this writing was not pinging. <br>  We give the command: <br><pre> <code class="bash hljs">ping sip.telecom.kz</code> </pre> <br>  If the name is resolved to the address that was specified in the <b>/ etc / hosts file</b> , then this time setting is correct.  As it is written above, ping on sip.telecom.kz can not go. <br><br>  We will update the operating system modules.  For this we give the command: <br><pre> <code class="bash hljs">yum update</code> </pre> <br>  We agree to all questions of the system. <br><br>  We‚Äôve finished with setting up the operating system and now it‚Äôs time to move on to setting up Asterisk.  First we need to find out our connection parameters to the Kazakhtelecom SIP-server.  To do this, go to the personal account of the service ‚ÄúID Phone‚Äù: <a href="https://cabinet.idphone.kz/">https://cabinet.idphone.kz</a> .  Be careful: this site opens only for Internet users from Kazakhtelecom.  Those.  if you are, for example, a happy user of wired Internet from Beeline, then your office will not open. <br>  In the office we follow the section with connection parameters: <br><div class="spoiler">  <b class="spoiler_title">Screenshots of the path to the ID Phone connection options</b> <div class="spoiler_text"><img src="https://habrastorage.org/getpro/habr/post_images/f41/7e4/82e/f417e482eb24a62e0a74a8609ee1525c.jpg"><br><br><img src="https://habrastorage.org/getpro/habr/post_images/4ce/46b/b42/4ce46bb42d58d54db3ca1ff5a11866c7.jpg"><br><br><img src="https://habrastorage.org/getpro/habr/post_images/7e9/420/77f/7e942077fe3398d6fdea0fe7bd8c960d.jpg"><br><br><img src="https://habrastorage.org/getpro/habr/post_images/36c/dc0/f02/36cdc0f020deee6c336ec513a27850e3.jpg"><br><br><img src="https://habrastorage.org/getpro/habr/post_images/b9b/adc/b7f/b9badcb7f78f7492fa899196dc152b61.jpg"><br><br><img src="https://habrastorage.org/getpro/habr/post_images/5a5/002/74e/5a500274e8777c9824a8891123cc69ef.jpg"><br><br><img src="https://habrastorage.org/getpro/habr/post_images/5e3/bdb/cfa/5e3bdbcfa47bd3a24106b2385be047e0.jpg"></div></div><br>  The values ‚Äã‚Äãin the fields ‚ÄúLine / Port‚Äù and ‚ÄúLogin‚Äù are the same for me.  You, too, most likely, because  These fields for editing are closed.  We agree in the future to call this value &lt;SIP-login&gt;.  Well, the value from the "Password" field will be called &lt;SIP-password&gt;. <br><br>  Open the Asterisk web management interface, called FreePBX.  To do this, on any computer in the local network, open a web browser and in the address bar type the address assigned by ‚ÄúAsterisk‚Äù.  In our case: <br><pre> <code class="bash hljs">192.168.0.3</code> </pre> <br>  First of all, we will update all FreePBX modules to the latest versions. <br><div class="spoiler">  <b class="spoiler_title">Screenshots of the path to the upgrade section of the FreePBX modules</b> <div class="spoiler_text"><img src="https://habrastorage.org/getpro/habr/post_images/bfd/049/286/bfd0492862aa2289172764e3514d8bc5.jpg"><br><br><img src="https://habrastorage.org/getpro/habr/post_images/c86/331/7fb/c863317fbc5fa0adb7ab88d91bd71fe5.jpg"><br><br>  The pre-set login parameters for admin are: login - admin, password - admin: <br><img src="https://habrastorage.org/getpro/habr/post_images/b6e/82f/b58/b6e82fb58b74caf94ae2bfeb86052b90.jpg"><br><br><img src="https://habrastorage.org/getpro/habr/post_images/3e7/6ed/bef/3e76edbef73b65bdf45e8bfac97e1c38.jpg"></div></div><br>  In this section, we press the buttons in this order: ‚ÄúCheck online‚Äù - ‚ÄúUpdate all‚Äù - ‚ÄúStart process‚Äù - ‚ÄúConfirm‚Äù and after completion of the update ‚ÄúReturn‚Äù.  Some modules depend on others, i.e.  the order of updating modules is important, and therefore you may need to do this process several times. <br><div class="spoiler">  <b class="spoiler_title">Screenshots of the update process for FreePBX modules</b> <div class="spoiler_text"><img src="https://habrastorage.org/getpro/habr/post_images/026/6b1/ad9/0266b1ad90915c180b4189e477e3df3a.jpg"><br><br><img src="https://habrastorage.org/getpro/habr/post_images/f8f/433/63d/f8f43363d8b0fc08ca2af2c8be3695e0.jpg"><br><br><img src="https://habrastorage.org/getpro/habr/post_images/909/9af/4a1/9099af4a1f8ddc0df39f17c5d8e3537e.jpg"><br><br><img src="https://habrastorage.org/getpro/habr/post_images/f4d/404/f82/f4d404f829feffb27c82264f66eb214d.jpg"><br><br><img src="https://habrastorage.org/getpro/habr/post_images/aaf/18c/466/aaf18c466eae7b1bf0d7b266a7e8ee0d.jpg"></div></div><br>  Click the big red button ‚ÄúApply Config‚Äù (do not forget to press it every time it appears - without this, our settings will not work): <br><div class="spoiler">  <b class="spoiler_title">Screenshot of the big red button</b> <div class="spoiler_text"><img src="https://habrastorage.org/getpro/habr/post_images/4dc/805/d49/4dc805d49d9692b1014193dab8aadadf.jpg"></div></div><br>  We are going to configure the trunk, i.e.  connection between our Asterisk and Kazakhtelecom's SIP server: <br><div class="spoiler">  <b class="spoiler_title">Screenshots of the path to the trunk settings</b> <div class="spoiler_text"><img src="https://habrastorage.org/getpro/habr/post_images/efd/a0b/e7e/efda0be7eac8e8428ae1d0be0bcd6bd8.jpg"><br><br><img src="https://habrastorage.org/getpro/habr/post_images/0c4/4a6/735/0c44a67355650084d2e1427957ccf00e.jpg"></div></div><br>  Insert the following text into the "options for PEER" section: <br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=friend username=&lt;SIP-&gt; secret=&lt;SIP-&gt; host=sip.telecom.kz nat=no fromuser=&lt;SIP-&gt; fromdomain=sip.telecom.kz dtmfmode=rfc2833 insecure=port,invite canreinvite=nonat qualify=yes disallow=all allow=alaw</code> </pre> <br>  Insert the following text into the ‚ÄúUSER options‚Äù section: <br><pre> <code class="bash hljs">fromuser=&lt;SIP-&gt; canreinvite=no secret=&lt;SIP-&gt; <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=user context=from-trunk</code> </pre> <br>  The field "Registration line" is filled with the following line: <br><pre> <code class="bash hljs">&lt;SIP-&gt;:&lt;SIP-&gt;@sip.telecom.kz/502000</code> </pre> <br>  I fill in the remaining fields with the value of the phone number and its derivatives: <br><img src="https://habrastorage.org/getpro/habr/post_images/ef7/26a/37f/ef726a37f81c0b7f265c64fdfed053e1.jpg"><br><br>  Check in the operating system console that the trunk is registered.  To do this, you first need to get into the Asterisk command line interface.  We collect: <br><pre> <code class="bash hljs">asterisk -r</code> </pre> <br>  Next, type: <br><pre> <code class="bash hljs">sip show registry</code> </pre> <br>  Our trunk should be displayed and its status should be Registered.  Here is an example of my output: <br><div class="spoiler">  <b class="spoiler_title">Command output</b> <div class="spoiler_text"><pre> <code class="bash hljs">[root@asterisk ~]<span class="hljs-comment"><span class="hljs-comment"># asterisk -r Privilege escalation protection disabled! See https://wiki.asterisk.org/wiki/x/1gKfAQ for more details. Asterisk 11.6.1, Copyright (C) 1999 - 2013 Digium, Inc. and others. Created by Mark Spencer &lt;markster@digium.com&gt; Asterisk comes with ABSOLUTELY NO WARRANTY; type 'core show warranty' for details. This is free software, with components licensed under the GNU General Public License version 2 and other licenses; you are welcome to redistribute it under certain conditions. Type 'core show license' for details. ========================================================================= Connected to Asterisk 11.6.1 currently running on asterisk (pid = 1607) asterisk*CLI&gt; sip show registry Host dnsmgr Username Refresh State Reg.Time sip.telecom.kz:5060 N XXXXXXXXX 85 Registered Sun, 22 Dec 2013 13:53:45 1 SIP registrations.</span></span></code> </pre> </div></div><br>  We create outbound routing (we explain the system what to do when someone from the PBX users tries to call outside): <br><div class="spoiler">  <b class="spoiler_title">Screenshot of the path to the outgoing route settings</b> <div class="spoiler_text"><img src="https://habrastorage.org/getpro/habr/post_images/e31/809/fda/e31809fda95dcb6ae4739bbed858289a.jpg"></div></div><br>  In the configuration of the outgoing route, you must specify: <br><ul><li>  its name ("outside", for example); </li><li>  the number pattern that this route will work on (the pattern ‚Äú9 |.‚Äù means that all numbers that begin with ‚Äú9‚Äù will be worked out by this route, while the nine will be removed from the number when the number goes to the trunk); </li><li>  the trunk that we created earlier, and to which we want to send all our calls ("502000"). </li></ul><br><img src="https://habrastorage.org/getpro/habr/post_images/386/df6/4f1/386df64f1a3b7a74e1e9aa510ab6c1d4.jpg"><br><br>  Create an internal number: <br><div class="spoiler">  <b class="spoiler_title">Screenshots of the path to the internal number settings</b> <div class="spoiler_text"><img src="https://habrastorage.org/getpro/habr/post_images/507/ecf/7e5/507ecf7e5cfa811b80a8b345c4352b65.jpg"><br><img src="https://habrastorage.org/getpro/habr/post_images/3de/fde/d1b/3defded1b4f4263f0fe9b2bd728b509f.jpg"></div></div><br>  In the settings of the extension number you must specify: <br><ul><li>  the number itself (for example, ‚Äú101‚Äù); </li><li>  how the caller from this number will be displayed on the screen (for example, also ‚Äú101‚Äù); </li><li>  internal number password (at least 6 characters, at least two letters, at least two numbers - for example, ‚Äúpwd101‚Äù). </li></ul><br><img src="https://habrastorage.org/getpro/habr/post_images/dbc/c09/d21/dbcc09d21c453d8862dd436706811f0c.jpg"><br><br>  We create incoming routing (we explain to the system what to do when someone calls our trunk outside): <br><div class="spoiler">  <b class="spoiler_title">Screenshot of the path to the settings of the incoming route</b> <div class="spoiler_text"><img src="https://habrastorage.org/getpro/habr/post_images/cec/0c2/fed/cec0c2fed7e9c48c5a8d7789f89dc8c9.jpg"></div></div><br>  In the settings of the incoming route, you must specify: <br><ul><li>  its description (for example, "inside"); </li><li>  where to send the incoming call (in our case we send to the internal number ‚Äú101‚Äù). </li></ul><br><img src="https://habrastorage.org/getpro/habr/post_images/4ae/3e6/64b/4ae3e664be68e69e367c9ee263d12a12.jpg"><br><br>  Well, we have finished setting up our PBX.  It's time to check how everything works.  To do this, install the soft-background and register at our PBX for the internal number "101". <br>  Downloading ‚ÄúX-lite‚Äù from here <a href="http://www.counterpath.com/x-lite-for-windows-download.html">http://www.counterpath.com/x-lite-for-windows-download.html</a> .  Install on one of the computers on the local network. <br><br>  Configuring "X-lite": <br><div class="spoiler">  <b class="spoiler_title">Screenshot of the path to the X-lite settings</b> <div class="spoiler_text"><img src="https://habrastorage.org/getpro/habr/post_images/ee8/c16/5c3/ee8c165c3b8fcdb29de070d69bb6f2bb.jpg"></div></div><br>  In the account settings, specify: <br><ul><li>  internal number for which we want to register (in our case, "101"); </li><li>  IP-PBX address in the local network (in our case "192.168.0.3"); </li><li>  internal number password (in our case ‚Äúpwd101‚Äù). </li></ul><br><img src="https://habrastorage.org/getpro/habr/post_images/c4f/c39/994/c4fc399946bdfa1a77b67f551db63d2b.jpg"><br><br>  If we did everything correctly, then ‚ÄúAvailable‚Äù will appear in the status of the soft background: <br><div class="spoiler">  <b class="spoiler_title">Screenshot of the connected X-lite</b> <div class="spoiler_text"><img src="https://habrastorage.org/getpro/habr/post_images/24b/660/1d5/24b6601d58242a7e0e93ec93c002510c.jpg"></div></div><br>  And now really everything!  We try to call from the soft background to the city, and then from the city, to our ID Phone number. <br><br>  Russify IVR (a set of voice messages that PBX can say).  To do this, we give a number of commands: <br><pre> <code class="bash hljs">mkdir /var/lib/asterisk/sounds/ru mkdir /tmp/asteriskru <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /tmp/asteriskru wget --no-check-certificate https://github.com/pbxware/asterisk-sounds/tarball/master tar xfz master --strip-components 1 -C /var/lib/asterisk/sounds/ru/ rm master wget --no-check-certificate https://github.com/pbxware/asterisk-sounds-additional/tarball/master tar xfz master --strip-components 1 -C /var/lib/asterisk/sounds/ru/ rm -rf /tmp/asteriskru</code> </pre> <br>  I download the russification package from github, since  there is no package with additional sounds on the official resource ( <a href="http://downloads.asterisk.org/pub/telephony/sounds/">http://downloads.asterisk.org/pub/telephony/sounds/</a> ), and without them, the PBX will only speak Russian partially. <br><br>  Now you need to add the line to the <b>/etc/asterisk/sip_general_custom.conf</b> file: <br><pre> <code class="bash hljs">language=ru</code> </pre> <br>  Restart the PBX and call the number * 60.  If everything is done correctly, then the PBX in the correct Russian language will tell us the current time. <br><br>  As a bonus, for those who are just as paranoid as I am, a bit of security. <br><br>  First, let's make FreePBX available via https.  To do this, install the appropriate package: <br><pre> <code class="bash hljs">yum install mod_ssl</code> </pre> <br>  Restart the web server: <br><pre> <code class="bash hljs">service httpd restart</code> </pre> <br>  For security reasons, we will allow you to work with our PBX only from our local network - if someone from the Kazakhtelecom subnet tries our PBX for strength.  We configure the firewall with a group of commands (based on <a href="http://habrahabr.ru/post/200636/">‚ÄúAsterisk + iptables is the easiest way to configure‚Äù</a> - thanks to <a href="http://habrahabr.ru/users/varnav/" class="user_link">varnav</a> for this): <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#    localhost iptables -A INPUT -i lo -j ACCEPT #      iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT #    ping iptables -A INPUT -p icmp -s 192.168.0.0/24 --icmp-type echo-request -j ACCEPT #  SSH iptables -A INPUT -p tcp -s 192.168.0.0/24 --dport 22 -j ACCEPT #  HTTPS (FreePBX) iptables -A INPUT -p tcp -s 192.168.0.0/24 --dport 443 -j ACCEPT #  SIP iptables -A INPUT -p udp -s 192.168.0.0/24 --dport 5060 -j ACCEPT #  RTP iptables -A INPUT -p udp --dport 10000:20000 -j ACCEPT #  IAX2     (      - 192.168.2.3) iptables -A INPUT -p udp -s 192.168.2.3 --dport 4569 -j ACCEPT #    Asterisk Manager API (    1   ) iptables -A INPUT -p tcp -s 192.168.0.0/24 --dport 5038 -j ACCEPT #    mysql (       ) iptables -A INPUT -p tcp -s 192.168.0.0/24 --dport 3306 -j ACCEPT #  ,   ,    iptables -P INPUT DROP iptables -P FORWARD DROP</span></span></code> </pre> <br>  We keep our rules: <br><pre> <code class="bash hljs">service iptables save</code> </pre> <br>  To make sure we didn‚Äôt miss anything, we‚Äôll see a list of firewall rules: <br><pre> <code class="bash hljs">iptables -L -v</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">Change management history</b> <div class="spoiler_text">  12/22/2013 - The first version of the manual. <br>  12/24/2013 - Added block on updating FreePBX modules. <br>  01/07/2014 - A block on the Russification of the operating system has been added, information on the creation of a route to the Kazakhtelecom subnetwork has been modified. <br>  01/11/2014 - Added block on security. <br>  01/14/2014 - Trunk settings corrected. <br>  02/01/2014 - Minor additions to the security block. <br>  02/03/2014 - Minor additions to the security block. <br>  03/04/2014 - Added a block on the Russification of IVR. </div></div></div><p>Source: <a href="https://habr.com/ru/post/206964/">https://habr.com/ru/post/206964/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../206952/index.html">Automatic generation of resources for Android applications using scripts for Adobe Photoshop</a></li>
<li><a href="../206956/index.html">About variables in CSS and abstractions in web programming</a></li>
<li><a href="../206958/index.html">When does a sales manager become a programmer?</a></li>
<li><a href="../206960/index.html">DIY: HTPC with external video card</a></li>
<li><a href="../206962/index.html">Localizing ApplicationBar with Binding</a></li>
<li><a href="../206966/index.html">Released unattached jailbreak for iOS 7.x</a></li>
<li><a href="../206968/index.html">A passion for programming. Chapter 13. Find a Mentor</a></li>
<li><a href="../206972/index.html">Google Platform. 10+ years</a></li>
<li><a href="../206974/index.html">Computer generated acoustic field generation</a></li>
<li><a href="../206980/index.html">Cubli: robotic cube with almost perfect balancing</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>