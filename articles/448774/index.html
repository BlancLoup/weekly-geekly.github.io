<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>SQL to CSV using DBMS_SQL</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Often, when solving problems of system integration, it is required to present a certain amount of data in one format or another. In this case, the con...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>SQL to CSV using DBMS_SQL</h1><div class="post__text post__text-html js-mediator-article">  Often, when solving problems of system integration, it is required to present a certain amount of data in one format or another.  In this case, the consumer of data can be anyone, but the source is almost always the corporate database.  For example, a manufacturer may require periodic reports from the supplier on the movement of its goods in the XLSX or XML format, etc. <br><br>  There are many tools for converting data into various formats, and their use depends on the technology stack adopted by the enterprise and the software architecture.  At the same time, you always want the chain consisting of various libraries, frameworks, system layers used to transform the source data to be as short as possible.  This would reduce the time spent on developing a solution and increase its productive efficiency. <br><br>  If we accept that, in fact, the SQL query is at the root of the data sampling process, then ideally we would like to see a chain of conversions like this: <br><p></p><p><math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><div class="MathJax_SVG_Display" style="text-align: center;"><span class="MathJax_SVG" id="MathJax-Element-1-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;><msup><mi>d</mi><mo>&amp;#x2032;</mo></msup><mo>=</mo><mi>f</mi><mo stretchy=&quot;false&quot;>(</mo><mi>S</mi><mi>Q</mi><mi>L</mi><mo stretchy=&quot;false&quot;>(</mo><mi>d</mi><mo stretchy=&quot;false&quot;>)</mo><mo stretchy=&quot;false&quot;>)</mo></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="16.035ex" height="2.78ex" viewBox="0 -883.9 6903.8 1197.1" role="img" focusable="false" style="vertical-align: -0.728ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/448774/&amp;xid=25657,15700023,15700186,15700191,15700253,15700256,15700259&amp;usg=ALkJrhhEapRZtggYf20p82cW-Ate9xZV2A#MJMATHI-64" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/448774/&amp;xid=25657,15700023,15700186,15700191,15700253,15700256,15700259&amp;usg=ALkJrhhEapRZtggYf20p82cW-Ate9xZV2A#MJMAIN-2032" x="741" y="583"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/448774/&amp;xid=25657,15700023,15700186,15700191,15700253,15700256,15700259&amp;usg=ALkJrhhEapRZtggYf20p82cW-Ate9xZV2A#MJMAIN-3D" x="1097" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/448774/&amp;xid=25657,15700023,15700186,15700191,15700253,15700256,15700259&amp;usg=ALkJrhhEapRZtggYf20p82cW-Ate9xZV2A#MJMATHI-66" x="2153" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/448774/&amp;xid=25657,15700023,15700186,15700191,15700253,15700256,15700259&amp;usg=ALkJrhhEapRZtggYf20p82cW-Ate9xZV2A#MJMAIN-28" x="2703" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/448774/&amp;xid=25657,15700023,15700186,15700191,15700253,15700256,15700259&amp;usg=ALkJrhhEapRZtggYf20p82cW-Ate9xZV2A#MJMATHI-53" x="3093" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/448774/&amp;xid=25657,15700023,15700186,15700191,15700253,15700256,15700259&amp;usg=ALkJrhhEapRZtggYf20p82cW-Ate9xZV2A#MJMATHI-51" x="3738" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/448774/&amp;xid=25657,15700023,15700186,15700191,15700253,15700256,15700259&amp;usg=ALkJrhhEapRZtggYf20p82cW-Ate9xZV2A#MJMATHI-4C" x="4530" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/448774/&amp;xid=25657,15700023,15700186,15700191,15700253,15700256,15700259&amp;usg=ALkJrhhEapRZtggYf20p82cW-Ate9xZV2A#MJMAIN-28" x="5211" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/448774/&amp;xid=25657,15700023,15700186,15700191,15700253,15700256,15700259&amp;usg=ALkJrhhEapRZtggYf20p82cW-Ate9xZV2A#MJMATHI-64" x="5601" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/448774/&amp;xid=25657,15700023,15700186,15700191,15700253,15700256,15700259&amp;usg=ALkJrhhEapRZtggYf20p82cW-Ate9xZV2A#MJMAIN-29" x="6124" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/448774/&amp;xid=25657,15700023,15700186,15700191,15700253,15700256,15700259&amp;usg=ALkJrhhEapRZtggYf20p82cW-Ate9xZV2A#MJMAIN-29" x="6514" y="0"></use></g></svg><span class="MJX_Assistive_MathML MJX_Assistive_MathML_Block" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><msup><mi>d</mi><mo>‚Ä≤</mo></msup><mo>=</mo><mi>f</mi><mo stretchy="false">(</mo><mi>S</mi><mi>Q</mi><mi>L</mi><mo stretchy="false">(</mo><mi>d</mi><mo stretchy="false">)</mo><mo stretchy="false">)</mo></math></span></span></div><script type="math/tex;mode=display" id="MathJax-Element-1"> d '= f (SQL (d)) </script></p><br>  Where <br><math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-2-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>d</mi></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.216ex" height="2.057ex" viewBox="0 -780.1 523.5 885.9" role="img" focusable="false" style="vertical-align: -0.246ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/448774/&amp;xid=25657,15700023,15700186,15700191,15700253,15700256,15700259&amp;usg=ALkJrhhEapRZtggYf20p82cW-Ate9xZV2A#MJMATHI-64" x="0" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>d</mi></math></span></span><script type="math/tex" id="MathJax-Element-2"> d </script>  - initial data, <br><math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-3-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>S</mi><mi>Q</mi><mi>L</mi><mo stretchy=&quot;false&quot;>(</mo><mi>d</mi><mo stretchy=&quot;false&quot;>)</mo></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="7.946ex" height="2.66ex" viewBox="0 -832 3421 1145.2" role="img" focusable="false" style="vertical-align: -0.728ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/448774/&amp;xid=25657,15700023,15700186,15700191,15700253,15700256,15700259&amp;usg=ALkJrhhEapRZtggYf20p82cW-Ate9xZV2A#MJMATHI-53" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/448774/&amp;xid=25657,15700023,15700186,15700191,15700253,15700256,15700259&amp;usg=ALkJrhhEapRZtggYf20p82cW-Ate9xZV2A#MJMATHI-51" x="645" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/448774/&amp;xid=25657,15700023,15700186,15700191,15700253,15700256,15700259&amp;usg=ALkJrhhEapRZtggYf20p82cW-Ate9xZV2A#MJMATHI-4C" x="1437" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/448774/&amp;xid=25657,15700023,15700186,15700191,15700253,15700256,15700259&amp;usg=ALkJrhhEapRZtggYf20p82cW-Ate9xZV2A#MJMAIN-28" x="2118" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/448774/&amp;xid=25657,15700023,15700186,15700191,15700253,15700256,15700259&amp;usg=ALkJrhhEapRZtggYf20p82cW-Ate9xZV2A#MJMATHI-64" x="2508" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/448774/&amp;xid=25657,15700023,15700186,15700191,15700253,15700256,15700259&amp;usg=ALkJrhhEapRZtggYf20p82cW-Ate9xZV2A#MJMAIN-29" x="3031" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>S</mi><mi>Q</mi><mi>L</mi><mo stretchy="false">(</mo><mi>d</mi><mo stretchy="false">)</mo></math></span></span><script type="math/tex" id="MathJax-Element-3"> SQL (d) </script>  - SQL query for data retrieval, <br><math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-4-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>f</mi></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.279ex" height="2.419ex" viewBox="0 -780.1 550.5 1041.5" role="img" focusable="false" style="vertical-align: -0.607ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/448774/&amp;xid=25657,15700023,15700186,15700191,15700253,15700256,15700259&amp;usg=ALkJrhhEapRZtggYf20p82cW-Ate9xZV2A#MJMATHI-66" x="0" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>f</mi></math></span></span><script type="math/tex" id="MathJax-Element-4"> f </script>  - a function that converts the sample into the required format, <br><math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-5-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msup><mi>d</mi><mo>&amp;#x2032;</mo></msup></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.903ex" height="2.178ex" viewBox="0 -832 819.3 937.7" role="img" focusable="false" style="vertical-align: -0.246ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/448774/&amp;xid=25657,15700023,15700186,15700191,15700253,15700256,15700259&amp;usg=ALkJrhhEapRZtggYf20p82cW-Ate9xZV2A#MJMATHI-64" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/448774/&amp;xid=25657,15700023,15700186,15700191,15700253,15700256,15700259&amp;usg=ALkJrhhEapRZtggYf20p82cW-Ate9xZV2A#MJMAIN-2032" x="741" y="513"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><msup><mi>d</mi><mo>‚Ä≤</mo></msup></math></span></span><script type="math/tex" id="MathJax-Element-5"> d '</script>  - data in the required format. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      For Oracle PL / SQL, there are a number of built-in and third-party packages that implement this functionality.  These are DBMS_XMLGEN, DBMS_XMLQUERY, AS_XLSX, PL / JSON and others. <br><br>  However, when there was a question about converting data into CSV format, for some reason, there were no ready-made solutions.  I had to do it myself, then it will be shown how. <a name="habracut"></a><br><br>  Formulation of the problem <br><br>  Create a tool (PL / SQL package), which accepts an arbitrary SELECT query as a string or as a cursor variable, and returns a CLOB object that encapsulates data in CSV format.  In case of any error, it should return NULL.  The CSV format itself does not need to be presented - these are lines whose elements are separated by a certain character, most often ";", but in general, an arbitrary character can act as a separator.  We assume that the characters 0x0D + 0x0A are used to separate the lines.  The first row in a CSV file is usually the header and defines the column names. <br><br>  Define the package interface <br><br><pre><code class="pgsql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR REPLACE</span></span> PACKAGE pp_csv <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PROCEDURE</span></span> query2sheet( stmt <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> VARCHAR2, sheet <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OUT</span></span> CLOB, delimeter <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> VARCHAR2 <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-string"><span class="hljs-string">';'</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">PROCEDURE</span></span> query2sheet( ref_cursor <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OUT</span></span> SYS_REFCURSOR, sheet <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OUT</span></span> CLOB, delimeter <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> VARCHAR2 <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-string"><span class="hljs-string">';'</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>;</code> </pre> <br>  Here are two overloaded procedures, the difference between them is that one of them accepts the request as a string, and the other as a reference to the cursor.  The second parameter is the output, this is the desired result in the CLOB object.  Finally, the third parameter is the CSV delimiter. <br><br>  The implementation of these procedures will be helped by the built-in DBMS_SQL package, which allows working with dynamic cursors, when it is not known in advance (at compile stage) how many columns are involved in the sample. <br><br>  DBMS_SQL features allow you to dynamically parse and execute arbitrary queries.  For a procedure that accepts a request as a string, this happens as follows: <br><br><pre> <code class="pgsql hljs"><span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> cur PLS_INTEGER := DBMS_SQL.OPEN_CURSOR; <span class="hljs-comment"><span class="hljs-comment">--     DBMS_SQL ignore INTEGER; BEGIN DBMS_SQL.PARSE(cur, stmt, DBMS_SQL.NATIVE); ignore := DBMS_SQL.EXECUTE(cur);</span></span></code> </pre> <br>  For a procedure that accepts a cursor variable, everything is simpler - starting with version 11 of Oracle, the conversion ‚Äúcursor variable ‚Üí number of SQL cursor‚Äù has become available. <br><br>  The DBMS_SQL.TO_CURSOR_NUMBER function converts the REFCURSOR variable (strongly or weakly typed) into the number of the SQL cursor, which can then be passed to the DBMS_SQL subroutines.  In this case, the cursor variable must be opened before its transfer to the DBMS_SQL.TO_CURSOR_NUMBER function. <br><br><pre> <code class="pgsql hljs">cur PLS_INTEGER := DBMS_SQL.TO_CURSOR_NUMBER(ref_cursor);</code> </pre> <br>  Thus, both call options were reduced to obtaining the <i>number of the</i> dynamic cursor and the associated data set.  The next step is to get information about the columns of this set and extract the data itself. <br><br>  The DMBS_SQL package allows you to describe the columns of a dynamic cursor, returning information about each column in an associative array of records. <br><br>  To do this, you must declare a PL / SQL collection based on the DBMS_SQL.DESC_TAB collection type (or DESC_TAB2, if the query can return column names that are longer than 30 characters).  You can then use the collection methods to iterate through the table and retrieve information about the cursor. <br><br><pre> <code class="pgsql hljs"><span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> cols DBMS_SQL.DESC_TAB2; ncols NUMBER; <span class="hljs-comment"><span class="hljs-comment">--     col_val_chr VARCHAR2(32767); BEGIN DBMS_SQL.DESCRIBE_COLUMNS2(cur, ncols, cols);</span></span></code> </pre> <br>  Next, the DBMS_SQL package needs to report the type of each column selected using a dynamic query.  This is done by calling DEFINE_COLUMN. <br><br><pre> <code class="pgsql hljs"><span class="hljs-keyword"><span class="hljs-keyword">FOR</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> .. ncols <span class="hljs-keyword"><span class="hljs-keyword">LOOP</span></span> DBMS_SQL.DEFINE_COLUMN(cur, i, col_val_chr, <span class="hljs-number"><span class="hljs-number">32767</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LOOP</span></span>;</code> </pre> <br>  In the second argument DEFINE_COLUMN, a number is passed - the consecutive position of the column in the list.  The third argument specifies the data type of the cursor column.  It is passed an expression of the appropriate type.  In other words, DBMS_SQL.DEFINE_COLUMN is not passed a string with a type name (say, ‚ÄúVARCHAR2‚Äù), but a variable defined with type VARCHAR2. <br><br>  When defining a character type column in the fourth argument, you must specify the maximum length of the values ‚Äã‚Äãthat can be loaded into the cursor. <br><br>  The preparatory operations are completed, you can now form a header line and start extracting data. <br><br><pre> <code class="pgsql hljs"><span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> cap CLOB; <span class="hljs-comment"><span class="hljs-comment">--    CSV- BEGIN DBMS_LOB.CREATETEMPORARY(cap, TRUE, DBMS_LOB.SESSION); FOR i IN 1 .. ncols LOOP DBMS_LOB.APPEND(cap, cols(i).col_name || delimeter); END LOOP;</span></span></code> </pre> <br>  Data is retrieved line by line using DBMS_SQL.FETCH_ROWS and subsequent calls to DBMS_SQL.COLUMN_VALUE to retrieve the value of individual columns. <br><br><pre> <code class="pgsql hljs"><span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> bod CLOB; <span class="hljs-comment"><span class="hljs-comment">--   CSV- c_line_break CONSTANT VARCHAR2(2) := chr(13) || chr(10); BEGIN DBMS_LOB.CREATETEMPORARY(bod, TRUE, DBMS_LOB.SESSION); WHILE DBMS_SQL.FETCH_ROWS(ur) &gt; 0 LOOP FOR i IN 1 .. ncols LOOP DBMS_SQL.COLUMN_VALUE(cur, i, col_val_chr); DBMS_LOB.APPEND(bod, col_val_chr || delimeter); END LOOP; DBMS_LOB.APPEND(bod, c_line_break); END LOOP;</span></span></code> </pre> <br>  It remains only to collect the resulting CSV <br><br><pre> <code class="pgsql hljs">DBMS_LOB.APPEND(sheet, cap); DBMS_LOB.APPEND(sheet, c_line_break); DBMS_LOB.APPEND(sheet, bod);</code> </pre> <br>  Handle errors <br><br><pre> <code class="pgsql hljs"><span class="hljs-keyword"><span class="hljs-keyword">EXCEPTION</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> OTHERS <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> sheet := <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>;</code> </pre> <br>  And close the cursor <br><br><pre> <code class="pgsql hljs">DBMS_SQL.CLOSE_CURSOR(cur);</code> </pre> <br>  Package Usage Options <br><br><pre> <code class="pgsql hljs"><span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> csv CLOB; <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> DBMS_LOB.CREATETEMPORARY(csv, <span class="hljs-keyword"><span class="hljs-keyword">TRUE</span></span>, DBMS_LOB.<span class="hljs-keyword"><span class="hljs-keyword">SESSION</span></span>); pp_csv.query2sheet(<span class="hljs-string"><span class="hljs-string">'SELECT empcode, fio FROM employee WHERE ROWNUM &lt; 10'</span></span>, csv); DBMS_OUTPUT.PUT_LINE(csv); DBMS_LOB.FREETEMPORARY(csv); <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>;</code> </pre> <br><pre> <code class="pgsql hljs"><span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> csv CLOB; cur SYS_REFCURSOR; <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OPEN</span></span> cur <span class="hljs-keyword"><span class="hljs-keyword">FOR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> empcode, fio <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> employee <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> ROWNUM &lt; <span class="hljs-number"><span class="hljs-number">10</span></span>; DBMS_LOB.CREATETEMPORARY(csv, <span class="hljs-keyword"><span class="hljs-keyword">TRUE</span></span>, DBMS_LOB.<span class="hljs-keyword"><span class="hljs-keyword">SESSION</span></span>); pp_csv.query2sheet(cur, csv); DBMS_OUTPUT.PUT_LINE(csv); DBMS_LOB.FREETEMPORARY(csv); <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>;</code> </pre> <br>  Here, actually, and all, <a href="https://github.com/PrilukovPA/pp_csv">source codes are attached</a> . <br><br>  The book helped to develop <br>  Feierstein S., Profit B. - Oracle PL / SQL.  For professionals. </div><p>Source: <a href="https://habr.com/ru/post/448774/">https://habr.com/ru/post/448774/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../448758/index.html">Smartwatch with BASIC on the physical 6502</a></li>
<li><a href="../448760/index.html">Development in the cloud, information security and personal data: digest for reading at the weekend from 1cloud</a></li>
<li><a href="../448762/index.html">Riot on Picaba. Users massively go to Reddit</a></li>
<li><a href="../448766/index.html">Create a mono-repository with lerna & yarn workspaces</a></li>
<li><a href="../448768/index.html">Multi-level lighting control: fault tolerance solutions and products</a></li>
<li><a href="../448780/index.html">What gives software for recruiting money</a></li>
<li><a href="../448782/index.html">Python Testing with pytest. Getting started with pytest, Chapter 1</a></li>
<li><a href="../448786/index.html">Python Testing with pytest. CHAPTER 3 pytest Fixtures</a></li>
<li><a href="../448788/index.html">Python Testing with pytest. Chapter 2, Writing Test Functions</a></li>
<li><a href="../448790/index.html">SpaceVIL - cross-platform GUI framework for development on .Net Core, .Net Standard and JVM</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>