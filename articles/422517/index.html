<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>TelegramBot in the Wolfram Cloud</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introduction 


 The period passed when every second article on Habrahabr was devoted to writing its telegram bot. Also, a period of time passed when ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>TelegramBot in the Wolfram Cloud</h1><div class="post__text post__text-html js-mediator-article"><h2 id="vvedenie">  Introduction </h2><br><p>  The period passed when every second article on Habrahabr was devoted to writing its telegram bot.  Also, a period of time passed when the bot could easily be placed on your computer or hosting in Russia.  Just six months ago, my bot ran just on a laptop and did not experience any problems connecting to the API.  But now, when I thought about getting him back to work, I realized that it would not be so easy.  I did not want to search and configure a proxy server, and even more so abroad.  Also, before that, I wrote a bot on Wolfram Language and had no idea how the language works with proxy servers, since I have not used them yet.  And then there was a great idea!  Use the Wolfram Cloud.  In this article I want to show how simple it is to register, but without SMS you can run your simple telegram bot written in Wolfram Language.  From the tools you need for this only the browser. </p><a name="habracut"></a><br><h2 id="nemnogo-pro-oblako-wolfram">  A bit about the Wolfram cloud </h2><br><p>  To access the cloud you need to create a Wolfram account.  To do this, go to <a href="https://account.wolfram.com/">https://account.wolfram.com</a> and follow the instructions after clicking the Create One button. </p><br><p><img src="https://habrastorage.org/webt/rl/er/tc/rlertcegmrslt0ner2zebqfajts.png"></p><br><p>  After all the manipulations done on the main cloud page at <a href="https://www.wolframcloud.com/">https://www.wolframcloud.com</a> all products and their usage plans will be displayed.  You must select the Development Platform and create a new notepad. </p><br><p><img src="https://habrastorage.org/webt/ji/nc/2i/jinc2iwgotacltqm6yh7n2gfboe.png"></p><br><p>  All the code given below will be executed in this cloud notebook. </p><br><h2 id="sovsem-nemnogo-o-telegramm-botah">  Just a little bit about telegram bots </h2><br><p>  There are many articles devoted to them.  Here you just have to say that before you perform all further actions, you need to create a bot in a standard way.  That is, just start a chat with the @BotFather bot and send it the command: </p><br><pre><code class="hljs">/newbot</code> </pre> <br><p>  Then you just need to follow the instructions and enter the name and login.  Let his name be Wolfram Cloud Bot and login @ WolframCloud5973827Bot. </p><br><p><img src="https://habrastorage.org/webt/ne/s1/xx/nes1xxki5xcpaumq5f0e6ykboxa.gif"></p><br><h2 id="realizaciya-api">  API implementation </h2><br><p>  We will use the @BotFather recommendations and briefly examine the HTTP API of telegram bots.  Tasks for the implementation of the entire API is not yet worth it.  For writing a bot, only a small part is enough.  Check that the API is available and the bot with the above token exists.  To do this, just run one line: </p><br><pre> <code class="hljs objectivec">URLExecute[<span class="hljs-string"><span class="hljs-string">"https://api.telegram.org/bot753681357:AAFqdRFN_QoODJxsBy3VN2sVwWTPKJEqteY/getMe"</span></span>]</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">Out [..]: = ...</b> <div class="spoiler_text"><pre> <code class="hljs erlang-repl">{<span class="hljs-string"><span class="hljs-string">"ok"</span></span> -&gt; True, <span class="hljs-string"><span class="hljs-string">"result"</span></span> -&gt; {<span class="hljs-string"><span class="hljs-string">"id"</span></span> -&gt; <span class="hljs-number"><span class="hljs-number">753681357</span></span>, <span class="hljs-string"><span class="hljs-string">"is_bot"</span></span> -&gt; True, <span class="hljs-string"><span class="hljs-string">"first_name"</span></span> -&gt; <span class="hljs-string"><span class="hljs-string">"Wolfram Cloud Bot"</span></span>, <span class="hljs-string"><span class="hljs-string">"username"</span></span> -&gt; <span class="hljs-string"><span class="hljs-string">"WolframCloud5973827Bot"</span></span>}}</code> </pre> </div></div><br><p>  The command above is the easiest way to perform an HTTP request from Wolfram Language.  But let's complicate it a bit so that it is easy to implement all other API methods.  Create a common method for executing an API request: </p><br><pre> <code class="hljs rust">TelegramBot::usage = <span class="hljs-string"><span class="hljs-string">"TelegramBot[token]"</span></span>; $telegramAPI = <span class="hljs-string"><span class="hljs-string">"https://api.telegram.org"</span></span>; telegramExecute[ TelegramBot[token_String], method_String, parameters: {(_<span class="hljs-built_in"><span class="hljs-built_in">String</span></span> -&gt; _)...}: {} ] := Module[{ request, requestURL, requestRules, requestBody, response, responseBody }, requestURL = URLBuild[{$telegramAPI, <span class="hljs-string"><span class="hljs-string">"bot"</span></span> &lt;&gt; token, method}]; requestRules = DeleteCases[parameters, _[_<span class="hljs-built_in"><span class="hljs-built_in">String</span></span>, Automatic | Null | <span class="hljs-literal"><span class="hljs-literal">None</span></span>]]; requestBody = ImportString[ExportString[requestRules, <span class="hljs-string"><span class="hljs-string">"JSON"</span></span>], <span class="hljs-string"><span class="hljs-string">"Text"</span></span>]; request = HTTPRequest[requestURL, &lt;| Method -&gt; <span class="hljs-string"><span class="hljs-string">"POST"</span></span>, <span class="hljs-string"><span class="hljs-string">"ContentType"</span></span> -&gt; <span class="hljs-string"><span class="hljs-string">"application/json; charset=utf-8"</span></span>, <span class="hljs-string"><span class="hljs-string">"Body"</span></span> -&gt; requestBody |&gt;]; response = URLRead[request]; responseBody = response[<span class="hljs-string"><span class="hljs-string">"Body"</span></span>]; Return[ImportString[responseBody, <span class="hljs-string"><span class="hljs-string">"RawJSON"</span></span>]] ]</code> </pre> <br><p>  Check if this works on the method already tested above: </p><br><pre> <code class="hljs objectivec">token = <span class="hljs-string"><span class="hljs-string">"753681357:AAFqdRFN_QoODJxsBy3VN2sVwWTPKJEqteY"</span></span>; bot = TelegramBot[token]; telegramExecute[bot, <span class="hljs-string"><span class="hljs-string">"getMe"</span></span>]</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">Out [..]: = ...</b> <div class="spoiler_text"><pre> <code class="hljs erlang-repl">&lt;|<span class="hljs-string"><span class="hljs-string">"ok"</span></span> -&gt; True, <span class="hljs-string"><span class="hljs-string">"result"</span></span> -&gt; &lt;|<span class="hljs-string"><span class="hljs-string">"id"</span></span> -&gt; <span class="hljs-number"><span class="hljs-number">753681357</span></span>, <span class="hljs-string"><span class="hljs-string">"is_bot"</span></span> -&gt; True, <span class="hljs-string"><span class="hljs-string">"first_name"</span></span> -&gt; <span class="hljs-string"><span class="hljs-string">"Wolfram Cloud Bot"</span></span>, <span class="hljs-string"><span class="hljs-string">"username"</span></span> -&gt; <span class="hljs-string"><span class="hljs-string">"WolframCloud5973827Bot"</span></span>|&gt;|&gt;</code> </pre> </div></div><br><p>  Fine.  Let's create a separate function to perform a bot check: </p><br><ul><li>  <a href="https://core.telegram.org/bots/api">getMe</a> - bot information </li></ul><br><pre> <code class="hljs pgsql">getMe::<span class="hljs-keyword"><span class="hljs-keyword">usage</span></span>="getMe[bot]"; TelegramBot /: getMe[bot_TelegramBot] := telegramExecute[bot, "getMe"] getMe[bot]</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">Out [..]: = ...</b> <div class="spoiler_text"><pre> <code class="hljs erlang-repl">&lt;|<span class="hljs-string"><span class="hljs-string">"ok"</span></span> -&gt; True, <span class="hljs-string"><span class="hljs-string">"result"</span></span> -&gt; &lt;|<span class="hljs-string"><span class="hljs-string">"id"</span></span> -&gt; <span class="hljs-number"><span class="hljs-number">753681357</span></span>, <span class="hljs-string"><span class="hljs-string">"is_bot"</span></span> -&gt; True, <span class="hljs-string"><span class="hljs-string">"first_name"</span></span> -&gt; <span class="hljs-string"><span class="hljs-string">"Wolfram Cloud Bot"</span></span>, <span class="hljs-string"><span class="hljs-string">"username"</span></span> -&gt; <span class="hljs-string"><span class="hljs-string">"WolframCloud5973827Bot"</span></span>|&gt;|&gt;</code> </pre> </div></div><br><p>  Now, in this way, it remains to add the basic methods that are needed to create a bot in the cloud: </p><br><ul><li>  <a href="https://core.telegram.org/bots/api">getUpdates</a> - gets all the latest posts written to bot </li></ul><br><pre> <code class="hljs rust">getUpdates::usage = <span class="hljs-string"><span class="hljs-string">"getUpdates[bot, opts]"</span></span>; Options[getUpdates] = { <span class="hljs-string"><span class="hljs-string">"offset"</span></span> -&gt; Automatic, <span class="hljs-string"><span class="hljs-string">"limit"</span></span> -&gt; Automatic, <span class="hljs-string"><span class="hljs-string">"timeout"</span></span> -&gt; Automatic, <span class="hljs-string"><span class="hljs-string">"allowed_updates"</span></span> -&gt; Automatic }; TelegramBot /: getUpdates[bot_TelegramBot, opts: OptionsPattern[getUpdates]] := telegramExecute[bot, <span class="hljs-string"><span class="hljs-string">"getUpdates"</span></span>, Flatten[{opts}]]</code> </pre> <br><ul><li>  <a href="https://core.telegram.org/bots/api">setWebhook</a> - sets the server address for handling updates </li></ul><br><pre> <code class="hljs rust">setWebhook::usage = <span class="hljs-string"><span class="hljs-string">"setWebhook[bot, url, opts]"</span></span>; Options[setWebhook] = { <span class="hljs-string"><span class="hljs-string">"certificate"</span></span> -&gt; Automatic, <span class="hljs-string"><span class="hljs-string">"max_connections"</span></span> -&gt; Automatic, <span class="hljs-string"><span class="hljs-string">"allowed_updates"</span></span> -&gt; Automatic }; TelegramBot /: setWebhook[bot_TelegramBot, url_String, opts: OptionsPattern[setWebhook]] := telegramExecute[bot, <span class="hljs-string"><span class="hljs-string">"setWebhook"</span></span>, Join[{<span class="hljs-string"><span class="hljs-string">"url"</span></span> -&gt; url}, Flatten[{opts}]]]</code> </pre> <br><ul><li>  <a href="https://core.telegram.org/bots/api">deleteWebhook</a> - deletes a handler </li></ul><br><pre> <code class="hljs pgsql">deleteWebhook::<span class="hljs-keyword"><span class="hljs-keyword">usage</span></span> = "deleteWebhook[bot]"; TelegramBot /: deleteWebhook[bot_TelegramBot] := telegramExecute[bot, "deleteWebhook"]</code> </pre> <br><ul><li>  <a href="https://core.telegram.org/bots/api">getWebhookInfo</a> - information about the handler </li></ul><br><pre> <code class="hljs pgsql">getWebhookInfo::<span class="hljs-keyword"><span class="hljs-keyword">usage</span></span> = "getWebhookInfo[bot]"; TelegramBot /: getWebhookInfo[bot_TelegramBot] := telegramExecute[bot, "getWebhookInfo"]</code> </pre> <br><ul><li>  <a href="https://core.telegram.org/bots/api">sendMessage</a> - send chat message </li></ul><br><pre> <code class="hljs rust">sendMessage::usage = <span class="hljs-string"><span class="hljs-string">"sendMessage[bot, chat, text]"</span></span>; Options[sendMessage] = { <span class="hljs-string"><span class="hljs-string">"parse_mode"</span></span> -&gt; Automatic, <span class="hljs-string"><span class="hljs-string">"disable_web_page_preview"</span></span> -&gt; Automatic, <span class="hljs-string"><span class="hljs-string">"disable_notification"</span></span> -&gt; Automatic, <span class="hljs-string"><span class="hljs-string">"reply_to_message_id"</span></span> -&gt; Automatic, <span class="hljs-string"><span class="hljs-string">"reply_markup"</span></span> -&gt; Automatic }; TelegramBot /: sendMessage[bot_TelegramBot, chat_Integer, text_String, opts: OptionsPattern[sendMessage]] := telegramExecute[ bot, <span class="hljs-string"><span class="hljs-string">"sendMessage"</span></span>, Join[{<span class="hljs-string"><span class="hljs-string">"chat_id"</span></span> -&gt; chat, <span class="hljs-string"><span class="hljs-string">"text"</span></span> -&gt; text}, Flatten[{opts}]] ]</code> </pre> <br><p>  Minimal API version is ready.  Let's check how sending a message and receiving updates work.  To do this, create a chat with our bot.  When creating a bot, the first message with the / start text will be sent.  Let's see whether it got into the list of updates: </p><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">updates</span></span> = getUpdates[bot]</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">Out [..]: = ...</b> <div class="spoiler_text"><pre> <code class="hljs erlang-repl">&lt;|<span class="hljs-string"><span class="hljs-string">"ok"</span></span> -&gt; True, <span class="hljs-string"><span class="hljs-string">"result"</span></span> -&gt; {&lt;|<span class="hljs-string"><span class="hljs-string">"update_id"</span></span> -&gt; <span class="hljs-number"><span class="hljs-number">570790461</span></span>, <span class="hljs-string"><span class="hljs-string">"message"</span></span> -&gt; &lt;|<span class="hljs-string"><span class="hljs-string">"message_id"</span></span> -&gt; <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"from"</span></span> -&gt; &lt;|<span class="hljs-string"><span class="hljs-string">"id"</span></span> -&gt; <span class="hljs-number"><span class="hljs-number">490138492</span></span>, <span class="hljs-string"><span class="hljs-string">"is_bot"</span></span> -&gt; False, <span class="hljs-string"><span class="hljs-string">"first_name"</span></span> -&gt; <span class="hljs-string"><span class="hljs-string">"Kirill"</span></span>, <span class="hljs-string"><span class="hljs-string">"last_name"</span></span> -&gt; <span class="hljs-string"><span class="hljs-string">"Belov"</span></span>, <span class="hljs-string"><span class="hljs-string">"username"</span></span> -&gt; <span class="hljs-string"><span class="hljs-string">"KirillBelovTest"</span></span>|&gt;, <span class="hljs-string"><span class="hljs-string">"chat"</span></span> -&gt; &lt;|<span class="hljs-string"><span class="hljs-string">"id"</span></span> -&gt; <span class="hljs-number"><span class="hljs-number">490138492</span></span>, <span class="hljs-string"><span class="hljs-string">"first_name"</span></span> -&gt; <span class="hljs-string"><span class="hljs-string">"Kirill"</span></span>, <span class="hljs-string"><span class="hljs-string">"last_name"</span></span> -&gt; <span class="hljs-string"><span class="hljs-string">"Belov"</span></span>, <span class="hljs-string"><span class="hljs-string">"username"</span></span> -&gt; <span class="hljs-string"><span class="hljs-string">"KirillBelovTest"</span></span>, <span class="hljs-string"><span class="hljs-string">"type"</span></span> -&gt; <span class="hljs-string"><span class="hljs-string">"private"</span></span>|&gt;, <span class="hljs-string"><span class="hljs-string">"date"</span></span> -&gt; <span class="hljs-number"><span class="hljs-number">1542182547</span></span>, <span class="hljs-string"><span class="hljs-string">"text"</span></span> -&gt; <span class="hljs-string"><span class="hljs-string">"/start"</span></span>, <span class="hljs-string"><span class="hljs-string">"entities"</span></span> -&gt; {&lt;|<span class="hljs-string"><span class="hljs-string">"offset"</span></span> -&gt; <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">"length"</span></span> -&gt; <span class="hljs-number"><span class="hljs-number">6</span></span>, <span class="hljs-string"><span class="hljs-string">"type"</span></span> -&gt; <span class="hljs-string"><span class="hljs-string">"bot_command"</span></span>|&gt;}|&gt;|&gt;}|&gt;</code> </pre> </div></div><br><p>  You can get the latest update data from the list of updates: </p><br><pre> <code class="hljs markdown">lastUpdate = updates[<span class="hljs-string"><span class="hljs-string">"result"</span></span>][<span class="hljs-symbol"><span class="hljs-symbol">[-1</span></span>]]</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">Out [..]: = ...</b> <div class="spoiler_text"><pre> <code class="hljs erlang-repl">&lt;|<span class="hljs-string"><span class="hljs-string">"update_id"</span></span> -&gt; <span class="hljs-number"><span class="hljs-number">570790461</span></span>, <span class="hljs-string"><span class="hljs-string">"message"</span></span> -&gt; &lt;|<span class="hljs-string"><span class="hljs-string">"message_id"</span></span> -&gt; <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"from"</span></span> -&gt; &lt;|<span class="hljs-string"><span class="hljs-string">"id"</span></span> -&gt; <span class="hljs-number"><span class="hljs-number">490138492</span></span>, <span class="hljs-string"><span class="hljs-string">"is_bot"</span></span> -&gt; False, <span class="hljs-string"><span class="hljs-string">"first_name"</span></span> -&gt; <span class="hljs-string"><span class="hljs-string">"Kirill"</span></span>, <span class="hljs-string"><span class="hljs-string">"last_name"</span></span> -&gt; <span class="hljs-string"><span class="hljs-string">"Belov"</span></span>, <span class="hljs-string"><span class="hljs-string">"username"</span></span> -&gt; <span class="hljs-string"><span class="hljs-string">"KirillBelovTest"</span></span>|&gt;, <span class="hljs-string"><span class="hljs-string">"chat"</span></span> -&gt; &lt;|<span class="hljs-string"><span class="hljs-string">"id"</span></span> -&gt; <span class="hljs-number"><span class="hljs-number">490138492</span></span>, <span class="hljs-string"><span class="hljs-string">"first_name"</span></span> -&gt; <span class="hljs-string"><span class="hljs-string">"Kirill"</span></span>, <span class="hljs-string"><span class="hljs-string">"last_name"</span></span> -&gt; <span class="hljs-string"><span class="hljs-string">"Belov"</span></span>, <span class="hljs-string"><span class="hljs-string">"username"</span></span> -&gt; <span class="hljs-string"><span class="hljs-string">"KirillBelovTest"</span></span>, <span class="hljs-string"><span class="hljs-string">"type"</span></span> -&gt; <span class="hljs-string"><span class="hljs-string">"private"</span></span>|&gt;, <span class="hljs-string"><span class="hljs-string">"date"</span></span> -&gt; <span class="hljs-number"><span class="hljs-number">1542182547</span></span>, <span class="hljs-string"><span class="hljs-string">"text"</span></span> -&gt; <span class="hljs-string"><span class="hljs-string">"/start"</span></span>, <span class="hljs-string"><span class="hljs-string">"entities"</span></span> -&gt; {&lt;|<span class="hljs-string"><span class="hljs-string">"offset"</span></span> -&gt; <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">"length"</span></span> -&gt; <span class="hljs-number"><span class="hljs-number">6</span></span>, <span class="hljs-string"><span class="hljs-string">"type"</span></span> -&gt; <span class="hljs-string"><span class="hljs-string">"bot_command"</span></span>|&gt;}|&gt;|&gt;</code> </pre> </div></div><br><p>  And this is how you can get the chat from which the message came and the message text itself: </p><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">chat</span></span> = <span class="hljs-literal"><span class="hljs-literal">last</span></span>Update[<span class="hljs-string"><span class="hljs-string">"message"</span></span>, <span class="hljs-string"><span class="hljs-string">"chat"</span></span>, <span class="hljs-string"><span class="hljs-string">"id"</span></span>] text = <span class="hljs-literal"><span class="hljs-literal">last</span></span>Update[<span class="hljs-string"><span class="hljs-string">"message"</span></span>, <span class="hljs-string"><span class="hljs-string">"text"</span></span>]</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">Out [..]: = ...</b> <div class="spoiler_text"><pre> <code class="hljs pgsql"><span class="hljs-number"><span class="hljs-number">490138492</span></span> /<span class="hljs-keyword"><span class="hljs-keyword">start</span></span></code> </pre> </div></div><br><p>  As can be seen from the result of the execution - everything is in place.  Now we will send a message on behalf of the bot using sendMessage. </p><br><pre> <code class="hljs objectivec">sendMessage[bot, chat, <span class="hljs-string"><span class="hljs-string">"hello"</span></span>]</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">Out [..]: = ...</b> <div class="spoiler_text"><pre> <code class="hljs erlang-repl">&lt;|<span class="hljs-string"><span class="hljs-string">"ok"</span></span> -&gt; True, <span class="hljs-string"><span class="hljs-string">"result"</span></span> -&gt; &lt;|<span class="hljs-string"><span class="hljs-string">"message_id"</span></span> -&gt; <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-string"><span class="hljs-string">"from"</span></span> -&gt; &lt;|<span class="hljs-string"><span class="hljs-string">"id"</span></span> -&gt; <span class="hljs-number"><span class="hljs-number">753681357</span></span>, <span class="hljs-string"><span class="hljs-string">"is_bot"</span></span> -&gt; True, <span class="hljs-string"><span class="hljs-string">"first_name"</span></span> -&gt; <span class="hljs-string"><span class="hljs-string">"Wolfram Cloud Bot"</span></span>, <span class="hljs-string"><span class="hljs-string">"username"</span></span> -&gt; <span class="hljs-string"><span class="hljs-string">"WolframCloud5973827Bot"</span></span>|&gt;, <span class="hljs-string"><span class="hljs-string">"chat"</span></span> -&gt; &lt;|<span class="hljs-string"><span class="hljs-string">"id"</span></span> -&gt; <span class="hljs-number"><span class="hljs-number">490138492</span></span>, <span class="hljs-string"><span class="hljs-string">"first_name"</span></span> -&gt; <span class="hljs-string"><span class="hljs-string">"Kirill"</span></span>, <span class="hljs-string"><span class="hljs-string">"last_name"</span></span> -&gt; <span class="hljs-string"><span class="hljs-string">"Belov"</span></span>, <span class="hljs-string"><span class="hljs-string">"username"</span></span> -&gt; <span class="hljs-string"><span class="hljs-string">"KirillBelovTest"</span></span>, <span class="hljs-string"><span class="hljs-string">"type"</span></span> -&gt; <span class="hljs-string"><span class="hljs-string">"private"</span></span>|&gt;, <span class="hljs-string"><span class="hljs-string">"date"</span></span> -&gt; <span class="hljs-number"><span class="hljs-number">1542182601</span></span>, <span class="hljs-string"><span class="hljs-string">"text"</span></span> -&gt; <span class="hljs-string"><span class="hljs-string">"hello"</span></span>|&gt;| &gt;</code> </pre> </div></div><br><p><img src="https://habrastorage.org/webt/df/-j/gd/df-jgdfzo0uejbmzxxbuja3koou.gif"></p><br><p>  In general, this set of functions is already enough.  However, using the getUpdates method is not very convenient.  You need to think of a way to handle messages using a webhook. </p><br><h2 id="sozdanie-webhook">  Create webhook </h2><br><p>  Wolram Langauge has a special kind of function that is created using the APIFunction.  Here is an example of one of these: </p><br><pre> <code class="hljs erlang-repl">apiFunc = APIFunction[{<span class="hljs-string"><span class="hljs-string">"n"</span></span> -&gt; <span class="hljs-string"><span class="hljs-string">"Integer"</span></span>}, Plot[Sin[#n * x], {x, -<span class="hljs-number"><span class="hljs-number">2</span></span>Pi, <span class="hljs-number"><span class="hljs-number">2</span></span>Pi}]&amp;, <span class="hljs-string"><span class="hljs-string">"PNG"</span></span>]; apiFunc[{<span class="hljs-string"><span class="hljs-string">"n"</span></span>-&gt;<span class="hljs-number"><span class="hljs-number">3</span></span>}]</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">Out [..]: = ...</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/tg/jk/vj/tgjkvjwyaje9k8yfqfspnpnwwpi.png"></p></div></div><br><p>  These features are specifically designed for deployment in the cloud.  This function will accept one request parameter as input.  To deploy it in the cloud, it is enough to transfer the function itself to CloudDeploy. </p><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">apiObject</span></span> = CloudDeploy[apiFunc, <span class="hljs-string"><span class="hljs-string">"Deploy/apiObject"</span></span>]</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">Out [..]: = ...</b> <div class="spoiler_text"><pre> <code class="hljs ruby">CloudObject[<span class="hljs-symbol"><span class="hljs-symbol">https:</span></span>/<span class="hljs-regexp"><span class="hljs-regexp">/www.wolframcloud.com/objects</span></span><span class="hljs-regexp"><span class="hljs-regexp">/kirillbelovtest/api</span></span>Object]</code> </pre> </div></div><br><p>  Then you can follow the received link in the browser and add a query parameter: </p><br><p><img src="https://habrastorage.org/webt/__/th/nt/__thntqsmtke_w8lx_ysyiqagey.gif"></p><br><p>  The function above handled the request parameters.  So you need to create the same function to process the HTTP request body, received from the telegram bot in the form of an Update object.  To generate an address, we use a token to access the cloud object was more difficult.  It is also necessary to indicate that the object has public access, otherwise the telegrams will not be able to get on the webhook. </p><br><pre> <code class="hljs pgsql">deployWebhook[bot_TelegramBot, handler_] := CloudDeploy[APIFunction[{}, <span class="hljs-keyword"><span class="hljs-keyword">handler</span></span>[HTTPRequestData["Body"]] &amp;], "Deploy/Webhooks/" &lt;&gt; Hash[bot, "SHA", "HexString"], Permissions -&gt; "Public" ]</code> </pre> <br><p>  handler is another handler function.  Let the handler turn the request body string into an association, get the chat identifier from there and send back the word "hello". </p><br><pre> <code class="hljs markdown">handlerHello[<span class="hljs-string"><span class="hljs-string">bot_TelegramBot</span></span>][<span class="hljs-symbol"><span class="hljs-symbol">body_String</span></span>] := Block[{json = ImportString[body, "RawJSON"], chat}, chat = json["message", "chat", "id"]; sendMessage[bot, chat, "hello"]; ]</code> </pre> <br><p>  Now we will deploy a function in the cloud. </p><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">webhookObject</span></span> = deployWebhook[bot, handlerHello[bot]]</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">Out [..]: = ...</b> <div class="spoiler_text"><pre> <code class="hljs ruby">CloudObject[<span class="hljs-symbol"><span class="hljs-symbol">https:</span></span>/<span class="hljs-regexp"><span class="hljs-regexp">/www.wolframcloud.com/objects</span></span><span class="hljs-regexp"><span class="hljs-regexp">/kirillbelovtest/</span></span>Deploy/Webhooks/b9bd74f89348faecd6b683ba02637dd4d4028a28]</code> </pre> </div></div><br><p>  And the last step - give the address of this object telegram-bot. </p><br><pre> <code class="hljs lua">setWebhook[bot, webhookObject<span class="hljs-string"><span class="hljs-string">[[1]]</span></span>]</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">Out [..]: = ...</b> <div class="spoiler_text"><pre> <code class="hljs erlang-repl">&lt;|<span class="hljs-string"><span class="hljs-string">"ok"</span></span> -&gt; True, <span class="hljs-string"><span class="hljs-string">"result"</span></span> -&gt; True, <span class="hljs-string"><span class="hljs-string">"description"</span></span> -&gt; <span class="hljs-string"><span class="hljs-string">"Webhook was set"</span></span>|&gt;</code> </pre> </div></div><br><p>  Now we‚Äôll write something to the bot and see what it says: </p><br><p><img src="https://habrastorage.org/webt/3l/ft/by/3lftbys5dvmtauvrmvom1wtggtc.gif"></p><br><p>  The dialogue can be considered valid.  In order to change the logic of an already existing handler, it is sufficient to redeploy the cloud object.  At the same time, installing the webhook for the bot is no longer required. </p><br><h2 id="logika-otvetov">  Response logic </h2><br><p>  This will be the last part in the process of creating a bot in the Wolfram cloud.  Further in the same way you can complicate the logic and add new API methods.  Now about the dialogue itself.  Let, after sending the command / start, the bot returns the answer "Hello" and changes the user's keyboard.  The keyboard remains only two buttons: "Hello" and "Who are you?".  We realize the dialogue in the form of an association.  The keys are the commands that the user sends to the bot.  Values ‚Äã‚Äãof keys - the answer of the bot and the new keyboard.  At the same time, the set of keys and buttons must completely coincide.  Otherwise, a situation may appear when the bot does not know what to answer.  In such cases, of course, you can add a default answer. </p><br><pre> <code class="hljs rust">keyboard[buttons : {__<span class="hljs-built_in"><span class="hljs-built_in">String</span></span>}] := {<span class="hljs-string"><span class="hljs-string">"keyboard"</span></span> -&gt; {Table[{<span class="hljs-string"><span class="hljs-string">"text"</span></span> -&gt; button}, {button, buttons}]}, <span class="hljs-string"><span class="hljs-string">"resize_keyboard"</span></span> -&gt; True} $answers = &lt;| (*user_text-&gt;&lt;|<span class="hljs-string"><span class="hljs-string">"answer"</span></span>-&gt;bot_text,<span class="hljs-string"><span class="hljs-string">"keyboard"</span></span>-&gt;next_text|&gt;*) <span class="hljs-string"><span class="hljs-string">"/start"</span></span>-&gt;&lt;|<span class="hljs-string"><span class="hljs-string">"answer"</span></span>-&gt;<span class="hljs-string"><span class="hljs-string">""</span></span>,<span class="hljs-string"><span class="hljs-string">"keyboard"</span></span>-&gt; keyboard[{<span class="hljs-string"><span class="hljs-string">""</span></span>,<span class="hljs-string"><span class="hljs-string">" ?"</span></span>}]|&gt;, <span class="hljs-string"><span class="hljs-string">""</span></span>-&gt;&lt;|<span class="hljs-string"><span class="hljs-string">"answer"</span></span>-&gt;<span class="hljs-string"><span class="hljs-string">" ?"</span></span>, <span class="hljs-string"><span class="hljs-string">"keyboard"</span></span> -&gt; keyboard[{<span class="hljs-string"><span class="hljs-string">" ?"</span></span>}]|&gt; , <span class="hljs-string"><span class="hljs-string">" ?"</span></span>-&gt;&lt;|<span class="hljs-string"><span class="hljs-string">"answer"</span></span>-&gt;<span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-string"><span class="hljs-string">"keyboard"</span></span> -&gt; keyboard[{<span class="hljs-string"><span class="hljs-string">""</span></span>}]|&gt; , <span class="hljs-string"><span class="hljs-string">" ?"</span></span>-&gt;&lt;|<span class="hljs-string"><span class="hljs-string">"answer"</span></span>-&gt;<span class="hljs-string"><span class="hljs-string">"   Wolfram Language   "</span></span>, <span class="hljs-string"><span class="hljs-string">"keyboard"</span></span>-&gt;keyboard[{<span class="hljs-string"><span class="hljs-string">" ?"</span></span>,<span class="hljs-string"><span class="hljs-string">" ?"</span></span>}]|&gt; , <span class="hljs-string"><span class="hljs-string">" ?"</span></span>-&gt;&lt;|<span class="hljs-string"><span class="hljs-string">"answer"</span></span>-&gt;<span class="hljs-string"><span class="hljs-string">"   :\nhttps://habr.com/post/422517/"</span></span>, <span class="hljs-string"><span class="hljs-string">"keyboard"</span></span>-&gt;keyboard[{<span class="hljs-string"><span class="hljs-string">""</span></span>,<span class="hljs-string"><span class="hljs-string">" ?"</span></span>}]|&gt; , <span class="hljs-string"><span class="hljs-string">" ?"</span></span>-&gt;&lt;|<span class="hljs-string"><span class="hljs-string">"answer"</span></span>-&gt;<span class="hljs-string"><span class="hljs-string">"  :\n@KirillBelovTest"</span></span>, <span class="hljs-string"><span class="hljs-string">"keyboard"</span></span>-&gt;keyboard[{<span class="hljs-string"><span class="hljs-string">" ?"</span></span>,<span class="hljs-string"><span class="hljs-string">""</span></span>}]|&gt; , <span class="hljs-string"><span class="hljs-string">""</span></span>-&gt;&lt;|<span class="hljs-string"><span class="hljs-string">"answer"</span></span>-&gt;<span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-string"><span class="hljs-string">"keyboard"</span></span>-&gt;keyboard[{<span class="hljs-string"><span class="hljs-string">""</span></span>,<span class="hljs-string"><span class="hljs-string">" ?"</span></span>}]|&gt; |&gt;; answer[text_String] /; KeyExistsQ[$answers, text] := $answers[text]</code> </pre> <br><p>  Now create a handler: </p><br><pre> <code class="hljs markdown">handlerAbout[<span class="hljs-string"><span class="hljs-string">bot_TelegramBot</span></span>][<span class="hljs-symbol"><span class="hljs-symbol">body_String</span></span>] := Block[<span class="hljs-string"><span class="hljs-string">{json = ImportString[body, "RawJSON"</span></span>], chat, text}, chat = json[<span class="hljs-string"><span class="hljs-string">"message", "chat", "id"</span></span>]; text = json[<span class="hljs-string"><span class="hljs-string">"message", "text"</span></span>]; sendMessage[<span class="hljs-string"><span class="hljs-string">bot, chat, answer[text</span></span>][<span class="hljs-symbol"><span class="hljs-symbol">"answer"</span></span>], "reply_markup" -&gt; answer[<span class="hljs-string"><span class="hljs-string">text</span></span>][<span class="hljs-symbol"><span class="hljs-symbol">"keyboard"</span></span>]]; ]</code> </pre> <br><p>  And redeploy the cloud object: </p><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">deployWebhook</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[bot, handlerAbout[bot]</span></span>];</code> </pre> <br><p>  Gain that happened in the chat with the bot.  But first, let's clear the message history: </p><br><p><img src="https://habrastorage.org/webt/ar/rr/j0/arrrj0gaxdyrhcysog_vxleb4hw.gif"></p><br><h2 id="rasshirenie-funkcionalnosti">  Expansion of functionality </h2><br><p>  So far, there are no fundamental differences from the huge number of existing bots.  Maybe there is no point in his drinking either?  The meaning of all the work done above will be, if you understand the actual benefits of such a bot!  After all, he can use all the features of Wolfram Language and Wolrfam Cloud.  It is necessary that the robot was able to solve equations?  It is very easy!  It is only necessary to determine the answer! </p><br><pre> <code class="hljs markdown">answer[<span class="hljs-string"><span class="hljs-string">text_String</span></span>][<span class="hljs-symbol"><span class="hljs-symbol">"keyboard"</span></span>] /; StringContainsQ[<span class="hljs-string"><span class="hljs-string">text, "  "</span></span>] := Automatic answer[<span class="hljs-string"><span class="hljs-string">text_String</span></span>][<span class="hljs-symbol"><span class="hljs-symbol">"answer"</span></span>] /; StringContainsQ[text, "  "] := ToString[Flatten[Block[{args = StringSplit[text, "  "]}, Solve[ToExpression[args[[1]]], ToExpression[args[[2]]]] ]]] deployWebhook[bot, handlerAbout[bot]];</code> </pre> <br><p><img src="https://habrastorage.org/webt/ei/wc/ex/eiwcexe7iqdlhdtolosjrialh8q.gif"></p><br><p>  If someone additionally has an interest in the capabilities of the cloud, then a good description of its functionality is <a href="https://www.youtube.com/watch%3Fv%3DXv8vugvu32c">here</a> . </p><br><h2 id="ogranicheniya">  Restrictions </h2><br><p>  Wolfram Cloud is a platform that allows you to use the Wolfram language for free, while the main product of Wolfram Research is Mathematica worth the money.  Accordingly, there are restrictions on the use and in my opinion they are very strong.  When using the free version of the Development Platform, a user is given 1000 cloud credits per month.  Each cloud loan gives time to calculate a different type.  Since the article talks about CloudDeploy + APIFunction, such objects stored in the cloud spend 1 credit in 0.1 seconds of computing time.  It is easy to calculate that the user is given out just 1 minute and 40 seconds of server time for the operation of his application (in this case, the bot).  I have nothing to add here - it is very, very small.  The main focus is on users who work in the Development Platform independently using a browser.  Indeed, in this mode there are no time limits, but only on the duration of the session and the resources allocated.  With this use, the Development Platform is almost a complete Mathematica, but does not require installation and a license. </p><br><p>  ‚Üí <a href="">Article in the Wolfram Cloud</a> </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/422517/">https://habr.com/ru/post/422517/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../422507/index.html">PHP 7.3. What's new</a></li>
<li><a href="../422509/index.html">Summary of the book "Never Eat Alone"</a></li>
<li><a href="../422511/index.html">Data loading in Splunk: Universal Forwarder vs Heavy Forwarder. What is the difference?</a></li>
<li><a href="../422513/index.html">7 tips on how not to infuriate a colleague-tester on his holiday</a></li>
<li><a href="../422515/index.html">Two Apache Ignite Meetings and In-Memory Computing Webinar in September</a></li>
<li><a href="../422519/index.html">Distributing freebies: non-braking threads in Java. Project loom</a></li>
<li><a href="../422521/index.html">Premonition of the inevitable</a></li>
<li><a href="../422525/index.html">"The matrix of friendship." The oldest social graph for the smallest</a></li>
<li><a href="../422527/index.html">Digest news from the world of PostgreSQL. Issue number 10</a></li>
<li><a href="../422529/index.html">Special Course Group-IB: ‚ÄúMobile Application Security‚Äù</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>