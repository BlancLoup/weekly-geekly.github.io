<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Security asterisk</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good day, to you, inhabitants of Habr. 
 It so happened that I took a distance learning course on the topic of ‚ÄúInformation Security‚Äù, after which it ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Security asterisk</h1><div class="post__text post__text-html js-mediator-article"> Good day, to you, inhabitants of Habr. <br>  It so happened that I took a distance learning course on the topic of ‚ÄúInformation Security‚Äù, after which it was necessary to protect my final work.  I chose ‚ÄúAsterisk Security‚Äù as the topic for this work, a lot of articles and publications are written about this topic, but in my opinion they are either incomplete or do not fully disclose this topic, or there is no indication of the relevance of this issue.  He took the liberty of collecting ‚Äúeverything‚Äù in one document, which resulted in his final work.  He defended himself successfully, the diploma was received - he decided to share this work with the community. <br><a name="habracut"></a><br><br>  <b>1. The risks associated with Asterisk IP-PBX</b> <br><br>  Everyone knows that in the age of information technology, huge losses to organizations are caused by the actions of intruders (hackers).  As a rule, the most painful are attacks aimed at causing harm to the organization or direct theft of funds.  Despite the fact that Asterisk is a telephone exchange based on a computer platform, but due to the fact that communication channels go via the Internet (some system services are open to the outside world), hackers have the opportunity to gain unauthorized access to the system. <br>  When building a security system for IP telephony solutions, it is important to be aware of the risks involved.  In general, they can be distinguished as follows: <br>  1. Breach of confidentiality and distortion of content.  Interception session. <br>  2. Penetration into the organization's network through vulnerabilities that appeared during the deployment of IP telephony. <br>  3. Actions aimed at the deterioration of services (Dos-attacks). <br>  4. Resale of traffic (Toll-Fraud). <br>  Resale traffic is one of the most convenient ways to make money by hackers.  Having hacked the station and sent calls to expensive international destinations, the hacker receives a certain reward on his e-wallets, which are then cashed out and real money is received.  Let us consider in more detail the typical traffic resale scheme. <br>  There is a hacker who wants to earn money by reselling traffic.  He goes to the stock exchange of drain traffic, registers and receives some pool of numbers that can identify him further.  Further, through some dummy servers are detected and if, it turns out, IP-ATC servers are hacked.  Further to the numbers that were provided to the hacker on the exchange of drain traffic, calls start to go.  Calls are paid.  Suppose a call costs 10 rubles.  (payment of the victim to the operator).  The call is usually sent abroad (usually Cuba, Palestine, Romania, Latvia, etc.) to countries where due attention is not paid to cyber crime, that is, where there is an opportunity to engage in this type of business.  And so the Victim pays the OS (Telecom Operator) 10 rubles per minute.  The operating system goes to international lines through OMT (international traffic operator), to which it pays around 8 rubles.  per minute, then OMT sends a call to a local operator (Cuba, Palestine, and others), who launches voice traffic and pays him already 6 rubles.  per minute, this operator is in the share and he distributes the money as follows - part of the money goes to him in payment for services (so to say, earns this amount - leaves in his account), and sends the honor of money to the exchange of drain traffic, where the hacker is registered .  Next, the exchange, leaving one ruble, two pays a hacker.  Visually, the scheme is shown in Fig.1. <br>  <b>Fig.1.</b>  <b>Voip traffic resale scheme</b> <br><img src="https://habrastorage.org/getpro/habr/post_images/9f3/0b8/70b/9f30b870b25bc2849aad3d4f137d978c.jpg" alt="image">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Taking into account the fact that the directions are chosen expensive and the flow of calls is intense, the hacker gets not a bad profit.  And due to the fact that sometimes the systems are not properly protected, the hacking occurs quickly and without any laborious and financially costly things - Asterisk becomes a ‚Äúred rag‚Äù.  Well, after all the manipulations, the victim will receive a large bill (10-100 000 rubles) by telephony. <br>  Unfortunately, this kind of problem has recently become frequent.  Therefore, many believe that Asterisk is an insecure system.  However, this thesis wants to challenge.  First, if we talk about the possibility of Asterisk itself, then it has a very rich set of security tools.  The toolkit is protected by Asterisk stronger than many competitors.  However, Asterisk is very often hacked.  How so?  Why is that?  It's all about the administrator of this system.  There is no single checkbox for activating Asterisk security.  Asterisk security is the adoption of a series of comprehensive measures that, as a rule, administrators forget about, thereby exposing Asterisk to threats. <br><br>  <b>2. Multi-Level IP-PBX Asterisk Protection</b> <br><br>  Speaking about the security of the IP-ATC solution as a whole, you need to understand that security is not only based on the security of Asterisk itself, it is also necessary to ensure the security of the Asterisk environment. <br>  The IP-ATC security system is built on several levels. <br>  1. Network protection. <br>  2. Network design. <br>  3. Analysis of the logs. <br>  4. Asterisk configuration. <br>  5. Protection plan call routing (dialplan). <br>  6. Linux configuration. <br>  7. Protection of peripheral devices. <br>  8. Administrative measures. <br>  If you define globally what the Asterisk problem is in terms of security, as mentioned above, this problem is not the competence of the Asterisk administrator. <br>  Due to the fact that there are ‚Äúboxed solutions‚Äù - installed and working, we get a very large number of installed Asterisk servers without proper security settings and the necessary administrator qualifications, resulting in hacked Asterisk, loss of organization‚Äôs funds, and a shadow on Asterisk‚Äôs name.  Either a not competent integrator has not properly installed the server and after payment it disappears.  And the client later receives huge bills by telephone or the operator blocks their directions. <br>  Consider the typical mistakes that novice Asterisk administrators make. <br>  1. Weak passwords on internal numbers (No passwords, the password is the same as ext). <br>  2. Lack of a firewall (Lack of iptables, either iptables is turned off, or not configured correctly). <br>  3. Older distributions and Software (Older software may contain vulnerabilities. Constant system updates are required. As an example, the trixbox is no longer supported, is not updated ‚Äî there are vulnerabilities). <br>  4. Standard logins and passwords (Web interface, Sql, equipment). <br>  5. Network design (Asterisk and equipment working with it on an external address, but without protection - this is a tasty morsel for hackers). <br>  6. Errors in the configuration. <br>  7. Lack of control over the system (Set and forget, there is no control logs). <br><br>  <b>2.1 Network Protection</b> <br>  When deploying a system, it is important to use a firewall.  Linux has a powerful and flexible IPTables tool that is controlled by commands.  By default IPTables is configured as follows. <br>  <i>-A INPUT ‚Äìm state --state ESTABLISHED, RELATED ‚Äìj ACCEPT</i> (allow packets for already established connections) <br>  <i>-A INPUT ‚Äìp icmp ‚Äìj ACCEPT</i> (allow icmp protocol packets) <br>  <i>-A INPUT ‚Äìi lo ‚Äìj ACCEPT</i> (allow traffic from the lo interface) <br>  <i>-A INPUT ‚Äìm state --state NEW ‚Äìm tcp ‚Äìp tcp ‚Äìdport 22 ‚Äìj ACCEPT</i> (allow new ssh connection) <br>  <i>-A INPUT ‚Äìj REJECT --reject-with icmp-host-prohibited</i> (we prohibit all other incoming connections) <br>  <i>-A FORWARD ‚Äìj REJECT - reject-with icmp-host-prohibited</i> (we prohibit all transit connections) <br>  <i>COMMIT</i> <br>  This "config" defines - We allow connections initiated by us, we prohibit all incoming connections except ssh.  Next, customize your tasks.  The config is here / etc / sysconfig / iptables.  To configure IPTables, the main thing is to understand the philosophy of this tool.  The essence of writing the rules is to create "chains" into which traffic is driven according to certain classifiers (-s source, -p protocol, -i interface ... ..), where action takes place over traffic - either allowed or denied, or forward to another the chain.  If the traffic ran through all the chains and did not fall under any rule - unspecified traffic (more than one classifier did not work), the traffic is prohibited.  That is, for example, in order to connect to the Asterisk server ip-phones, softphones from the internal network, we need to write a rule <br>  <i>-A INPUT ‚Äìs xxx.xxx.xxx.xxx/24 ‚Äìj ACCEPT</i> <br>  By this rule, we allow incoming connections from the xxx.xxx.xxx.xxx \ 24 network.  Since the packet passes by rules from top to bottom, it should be understood that this rule will work if we write it higher than the prohibiting rules.  Thus, you can configure the firewall, that Asterisk will serve only those directions and only those packages that we obviously trust, and it will be almost impossible for an attacker to get to the server.  It is possible to more flexibly adjust the logic of the firewall ‚Äî we create our own chain for each packet group (Admin, SIP, IAX2, ...) with its own rules, and in the main INPUT chain, according to the rules, the packets are sent along their own chains, where appropriate actions are taken. <br><br>  <b>2.2 Network Design</b> <br>  When designing and implementing a system, you need to pay attention to the network design. <br>  Often, without any need, Asterisk is connected to the network according to the most vulnerable scheme shown in Fig.  2 <br>  <b>Fig.2.</b>  <b>Not recommended Asterisk connection to an external address</b> <br><img src="https://habrastorage.org/getpro/habr/post_images/872/998/af0/872998af091c0e3e57e5a3aad0a6c31f.jpg" alt="image"><br>  The fact that Asterisk is available from the Internet is the main threat to the security of the entire system.  Any weak password or any vulnerability in the Asterisk source code can be used by attackers to gain unauthorized access to the PBX and call at the expense of the company that owns Asterisk.  At best, the attackers target may be denial of service. <br>  Strong passwords and regular updates, of course, reduce the risk.  Even more, it can be reduced by specialized means of protection, namely, firewalls (ME).  If you connect Asterisk as shown in Fig.  3, the server will be safely closed outside the perimeter of the local network. <br>  <b>Fig.</b>  <b>3. Recommended wiring diagram for Asterisk using ME</b> <br><img src="https://habrastorage.org/getpro/habr/post_images/c1d/87d/dad/c1d87ddad9de29d986a9ab38f761cce4.jpg" alt="image"><br>  The ME passes outgoing traffic from the Asterisk server to the SIP provider and back through dynamic NAT rules.  And the ability to connect users of remote offices is provided through a VPN-tunnel.  The user first connects via VPN to the enterprise network, and only then, via a virtual channel, to the Asterisk server.  Asterisk is no longer visible from the external network, unavailable to the attacker. <br>  We also note another important aspect that needs attention - the separation of data.  It is important to separate voice and data through the construction of a Vlan.  Computers, servers, other network equipment must be in one Vlan, and equipment working with Asterisk (the server itself, gate, ip-phones ...) in another Vlan.  This is done so that the users themselves, as well as possible viruses on user machines, could not harm IP-ATC and vice versa.  The scheme with Vlan is presented in fig.  four. <br><br>  <b>Fig.</b>  <b>4. Separation of voice and data in different Vlan.</b> <br><img src="https://habrastorage.org/getpro/habr/post_images/656/93b/033/65693b03359e88363db0a3fe0722cdf4.jpg" alt="image"><br><br>  <b>2.3 Log Analysis</b> <br>  During the IP-ATC system, Asterisk and other applications log all their actions.  Since the log contains data on both authorized actions and unauthorized actions, it is very important to periodically review them for incidents.  It is necessary to monitor connections, control the selection of passwords, track multiple connection attempts, monitor unplanned activity. <br>  In the Asterisk toolkit, there is no such tool as a log analyzer that would, under certain conditions, take certain actions on the connection.  There is an unplanned activity, which is important to monitor in order to prevent the possibility of hacking Asterisk server, one of such activities is the selection of passwords (brute force passwords in the dictionary).  There is no such tool that would prevent Asterisk from overwriting passwords, and since this is an important point in security, it is proposed to use the external service Fail2Ban, which can work with many services, such as Asterisk, Apache, ssh, ftp and others.  The operation of this service is based on the same principle ‚ÄúDetect and eliminate‚Äù, the service ‚Äúreads‚Äù the logs, analyzes them and, upon detection of multiple login attempts, blocks this connection at the IPTables level.  Figure 5 shows the operation of the Fail2Ban service. <br>  <b>Fig.</b>  <b>5. The principle of Fail2Ban</b> <br><img src="https://habrastorage.org/getpro/habr/post_images/134/a87/737/134a8773792c588478aaeaa72ec5333e.jpg" alt="image"><br>  I would also like to note one more recommendation - it is desirable that the logs (logs) about events in the system be either stored remotely or constantly copied to a remote resource.  This is due to the fact that the attacker, having gained access to the device, in particular to the IP PBX, tries to hide its presence and actions by removing all events from the log files.  If the logs are sent to a remote server, it will make it difficult or impossible to hide your presence. <br><br>  <b>2.4 Asterisk Configuration</b> <br>  In this chapter, we will look at system security at the Asterisk configuration level.  And so, what we have to configure in Asterisk itself, which would increase the security of IP-ATC. <br>  If Asterisk is ‚Äúsitting‚Äù on an external address and there is no possibility to use IPTables (a situation when you need to connect a device with a dynamic ip address), or not using vpn, then the first thing to do is change the standard port 5060 (sip) to any other.  Thus, we will withdraw from our suspicions that our Asterisk server will not attack it further.  Let us protect ourselves from the BruteForce attacks outside. <br>  How to do it.  Rule sip.conf file <br>  <i>[general]</i> <br>  <i>; bindport = 5060</i> ;  Commented out the standard option. <br>  <i>bindport = 9060</i> ;  Changing the default port to another free is for security reasons. <br>  Do not forget on the endpoint devices to indicate the port to which we changed the standard one.  Since by default devices will strive to connect to Asterisk on port 5060, and nothing happens. <br>  How else can we improve system security at the sip.conf configuration level. <br>  <i>[general]</i> <br>  <i>alwaysauthreject = yes</i> ;  We protect the server from brute force by numbers.  If the value is no, the server will honestly respond that there is no such subscriber, until the attacker guesses the existing ext, then the server will answer that the password is not correct.  Thus, the attacker learns about the existence of an internal number, it remains only to find the password.  Next is already going over the password for a very specific internal number.  The yes option allows you to reject authentication requests for existing users with the same reason as for non-existing users.  Thus, we make it more difficult for fraudsters to find out the existing ext. <br>  <i>allowguest = no</i> ;  We prohibit connections to the server in the mode of direct sip calls, the so-called guest calls, when you can call the subscriber by his E-mail. <br>  <i>bindaddr = xxx.xxx.xxx.xxx</i> ;  At what address will Asterisk listen to network connections using the sip protocol?  This is if the server is connected to different networks, it is better to explicitly indicate from which network to accept sip. <br>  <i>[1000]</i> <br>  <i>deny = 0.0.0.0 / 0.0.0.0</i> ;  We prohibit connection from all addresses <br>  <i>permit = xxx.xxx.xxx.xxx / 24</i> ;  Allow connections from the xxx.xxx.xxx.xxx network <br>  <i>secret = bdDfg12312fc</i> ;  Requires strong passwords that are different from standard things (admin, ext, 1000, password ...) <br>  <i>call-limit = 2</i> ;  We set a limit on the number of simultaneous lines for the subscriber. <br><br>  <b>2.5 Protection by call routing plan (dialplan)</b> <br>  With the help of well-written dialplan (call routing plan), you can significantly increase security.  The first thing recommended is the division of subscribers into contexts with their own routing rules. <br>  <i>In sip.conf</i> <i><br></i>  <i>[1000]</i> <i><br></i>  <i>context = from_chef</i> <i><br></i>  <i>[1001]</i> <i><br></i>  <i>context = from_it</i> <i><br></i>  <i>[1002]</i> <i><br></i>  <i>context = from_fin</i> <br>  Separation by contexts gives us the opportunity to endow telephone subscribers with different rights.  This is important, since not everyone needs, say, to call international destinations.  Further to contexts we assign rules.  In extension.  conf <br>  <i>[allow]</i> <br>  <i>exten =&gt; _ X., n, Dial (SIP / operator / $ {EXTEN})</i> ;  Allow any calls through the Operator <br>  <i>exten =&gt; _ [12] XXX, n, Dial (SIP / $ {EXTEN})</i> ;  Allow internal connections <br>  <i>[from_chef]</i> <br>  <i>exten =&gt; _X., n, Goto (allow, $ {EXTEN}, 1)</i> ;  All calls are directed to the context [allow] <br>  <i>[from_it]</i> <br>  <i>exten =&gt; _9810., n, Hungup ()</i> ;  We limit international destinations <br>  <i>exten =&gt; _X., n, Goto (allow, $ {EXTEN}, 1)</i> ;  All calls are directed to the context [allow] <br>  <i>[from_fin]</i> <br>  <i>exten =&gt; _9810., n, Hungup ()</i> ;  We limit international destinations <br>  <i>exten =&gt; _989., n, Hungup ()</i> ;  We limit directions to cellular directions. <br>  <i>exten =&gt; _X., n, Goto (allow, $ {EXTEN}, 1)</i> ;  All calls are directed to the context [allow] <br>  Thus, the financial department prohibits calls to international destinations and cellular directions.  It division prohibited only international destinations.  Well, the head allow any connections. <br>  In order to receive information about the banned calls to the post office, we will teach Asterisk to discourage violations.  To do this, add another context [alarm]. <br>  <i>[alarm]</i> <br>  <i>exten =&gt; _9810X., 1, playback (zapresheno)</i> ;  We notify the subscriber that this direction is prohibited to him. <br>  <i>exten =&gt; _9810X., n, System (echo "To" $ {EXTEN} "Ext" $ {CALLERID (num)} | mail -s "8-10 ALARM" it_admin@list.ru)</i> ;  Fiscalit mail if there are international calls. <br>  <i>exten =&gt; _9810X., n, Hangup ()</i> ;  hang up <br><br>  And send prohibited calls to this context. <br>  <i>[allow]</i> <br>  <i>exten =&gt; _ X., n, Dial (SIP / operator / $ {EXTEN})</i> ;  Allow any calls through the Operator <br>  <i>exten =&gt; _ [12] XXX, n, Dial (SIP / $ {EXTEN})</i> ;  Allow internal connections <br>  <i>[from_chef]</i> <br>  <i>exten =&gt; _X., n, Goto (allow, $ {EXTEN}, 1)</i> ;  All calls are directed to the context [allow] <br>  <i>[from_it]</i> <br>  <i>exten =&gt; _9810., n, Goto (alarm, $ {EXTEN}, 1)</i> ;  We direct international calls in context [alarm] <br>  <i>exten =&gt; _X., n, Goto (allow, $ {EXTEN}, 1)</i> ;  All calls are directed to the context [allow] <br>  <i>[from_fin]</i> <br>  <i>exten =&gt; _9810., n, Goto (alarm, $ {EXTEN}, 1)</i> ;  We direct international calls in context [alarm] <br>  <i>exten =&gt; _989., n, Hungup ()</i> ;  We limit directions to cellular directions. <br>  <i>exten =&gt; _X., n, Goto (allow, $ {EXTEN})</i> ;  All calls are directed to the context [allow] <br>  Thus, not only we block the forbidden directions, but in the event of an incident we get a message who (ext) is trying to reach.  Thus, we can understand in time that the server is hacked, but not when huge bills for communication come. <br>  That's good Asterisk, dilplan allows you to flexibly configure routing.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We can prohibit directions by various parameters, we can differentiate the rights to subscribers, we can set up notifications about barred calls, you can also set up call restriction by time, we can set up calls to enter a pin-code and much more, which allows to increase the security of IP-ATC. Pin code is recommended for remote users with a dynamic ip-address, since the restriction on permit / deny and iptables is impossible, in this case it is desirable to close international destinations, change the standard port (5060) to something of your own, and call the calls by pin-code. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2.6 Linux configuration</font></font></b> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Both in Asterisk itself and in Linux itself there are services that are started by default, but they are not needed for work. Therefore, one of the recommendations is the need to disable unused services (modules) in both Asterisk and Linux. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Asterisk loads a large number of modules, which in principle may never be useful - various codecs, commands, tools for working with databases, channels. Disabling unnecessary modules will not only free up memory, but also make IP-ATC less vulnerable. What we seek. And since it can be done.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In the /etc/asterisk/modules.conf file, the autoload = yes parameter is specified, which causes Asterisk to initialize and start all services that are in the / usr / lib / asterisk / modules folder when it is loaded. In order to prohibit the launch of this or that unnecessary service, it is necessary in the file /etc/asterisk/modules.conf to prescribe the following lines </font></font><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">noload =&gt; chan_gtalk.so</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ; Gtalk channel module. </font></font><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">noload =&gt; app_morsecode.so</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ; Transfer the specified string to Morse code. </font></font><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">noload =&gt; cdr_pgsql.so</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ; Module for storing CDR data in a PostgreSQL database. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and others depending on which modules are needed and which are not.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Also directly in Linux itself, there are services that are loaded, but perhaps not needed for IP-ATC operation - it is also desirable to disable them. Using the chkconfig ‚Äìlist command, you can see which services are started and determine which services are superfluous. Suppose, on CentOS 5, the bluetooth service is loaded by default, this service is not needed at the Asterisk telephone exchange, we‚Äôll remove it from the startup with the command chkconfig bluetooth off. We will do the same with other unnecessary services. All these manipulations need to be done very carefully and thoughtfully, otherwise you can ‚Äúput‚Äù both the OS itself and the Asterisk server.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">To administer the OS and Asterisk, the IP-ATC administrator needs remote access. It is not recommended to use protocols for remote access without encryption (for example, telnet) it is recommended to use SSH (Secure SHell). The SSH service used to log in remotely to the server is the main door to the PBX control center. To increase security, the PBX administrator is recommended to perform the following measures. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1. Change port. The default SSH port is the 22nd. Many hackers scan the Internet for servers with open port 22, then try to hack them. You need to think of another port, in the range of 1-65535, and specify it in the Port directive in the ssh configuration. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We also forget to specify this port in the client when connecting to the server.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2. Explicit enumeration of users who have access to the system via the SSH protocol in the [AllowUsers] directive. In the event that it is still necessary to provide access to the system to a number of proxies, list them. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3. It is recommended to use only SSH protocol version 2. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4. Disable direct root user access. This will significantly complicate and most likely make it impossible for the password brute force attack, since the root user will be denied access to the system, even if the correct password is entered. Use the sudo subsystem to gain root access if necessary and only after remote login to the system under an unprivileged account.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">5. Use a temporary password restriction or certificates. Setting the minimum possible time to enter a password, for example, 1 second, can well confuse the attacker. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">All the above recommendations are reflected in the configuration file / etc / ssh / sshd_config </font></font><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Port 30222 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AllowUsers ats admin </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Protocol 2 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PermitRootLogin no </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LoginGraceTime 1s</font></font></i> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> It is also a good practice to log in to SSH using certificates. If you often use SSH to connect to a remote host, one of the ways to ensure the security of a connection is to use a public / private SSH key, since no password is transmitted over the network and the system is resistant to brute-force attacks.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Creating a public / private SSH key in Linux is very simple. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1. In the console, enter ssh-keygen ‚Äìt rsa In this case, RSA is an asymmetric encryption algorithm. You can also use DSA (Digital Signature Algorithm). </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2. Further it is proposed to specify a place for key saving. By default, this is the .ssh folder in your home directory. In order to accept the default settings, just press ‚ÄúEnter‚Äù. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3. Next we are asked to enter an ID phrase. This is not the passphrase for connecting to a remote host. This is the passphrase for unlocking the private key, so it will not help you access the remote server, even if your private key is stored on it. Entering an ID phrase is optional. To leave it empty, press "Enter".</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4. Our keys are generated. Go to the home directory in the folder .ssh, there should be generated our keys id_rsa and id_rsa.pub. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">5. Next, edit the configuration file / etc / ssh / sshd_config </font></font><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RSAAuthentication yes </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PubkeyAuthentication yes </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PasswordAuthentication no</font></font></i> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Thus, we only allow ssh login using a certificate. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">6. Copy the contents of the id_rsa.pub file to the newly created authorized_keys file. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Copy and create the file with the cat id_rsa.pub &gt;&gt; authorized_keys command </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">7. Install the read and write permissions to the file </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">chmod 600 authorized_keys </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">8. Copy the private id_rsa key to the computer from which we will Connect to the server via SSH.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">9. In order for the client (Putty) to understand this private key, run (load) it through the puttygen program. At the exit (Save private key) we get a private key (* .ppk). </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">10. Now add the key to the session. We start PuTTY, load the necessary session or enter data for the connection and go to ‚ÄúSSH - Auth‚Äù, choose our private key, which was obtained through the processing ‚Äúputtygen‚Äù. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">11. Go to the menu "Connection - Data" and in the field "Auto-login username" enter the login under which generated the key. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">12. Save the session, restart the SSH service on the server /etc/init.d/ssh reload </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">13. Connect. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Thus, we have improved the security of the SSH connection. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2.7 Peripheral Protection</font></font></b> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">One of the important points is the protection of equipment that is connected in one way or another to Asterisk, such equipment are ip-phones, voip-gate and others. An IP-ATC system cannot be secure unless peripheral devices are protected. To protect this equipment, it is proposed to conduct a number of activities: </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1. This is a software update of the equipment. It is important to monitor this aspect in the event of a new ‚Äúfirmware‚Äù release, update it on the appropriate device. Many vulnerabilities are fixed with updates. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2. This point has already been discussed above. If possible, put the ip-equipment in a separate Vlan from the data. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3. Place equipment behind the network screen. It is not desirable to give ip-equipment external ip-addresses.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4. The vulnerability is the Web-based hardware interface. In order to protect equipment from hacking via a web interface, it is recommended to disable it for ip phones, since it does not carry much meaning, or to set a strong password for voip-gate. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">5. Change of service ports. As in the case of Astersik, on ip-phones and voip-gate it is recommended to change the sip port from 5060 to any other. Thereby we increase resistance to scanning. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If we are talking about a softphone that is installed on a computer, then it is hard to talk about security. The only effective measure in this case is limited contexts with the possibility of notifying the administrator about an attempt to make a barred call. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2.8 Administrative measures</font></font></b> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Even if all the recommendations described above are implemented, the system can still be hacked - there is no absolute security. Therefore, administrative measures are important. Consider them. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1. If the organization does not need international calls, then you can block international destinations at the carrier level. If there are very few such calls, then you can agree with the provider on some monitoring of this direction - in case of a large number of calls to international destinations - to block these connections.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2. You can also go for a simple, but effective method - this is to limit the amount of the bill for communication at the operator level. You can ask the telecom operator to set a limit, which we determine for ourselves (average annual monthly payment for communication + a certain%), and if the limit is reached, the connection is blocked. This measure will not let go into a deep minus in the case of hacking IP-ATC. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3. Protection of workstations with softphones. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4. Change passwords when changing admin. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">5. Increase staff awareness.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">6. One of the most important moments is not to forget that there is no absolute protection. It is necessary to constantly monitor and audit the system for new vulnerabilities, new risks, etc., and if something is revealed, take it into account in the system security system. That is, the "Deming cycle" is required in application to this system.</font></font><br><br>  <b>Conclusion</b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I hope that this work reveals the thesis that if the system is properly configured, Asterisk can be made one of the safest systems with more functionality in the field of telephony, and this system is not inferior to commercial solutions from leading vendors such as Cisco, Avaya, etc. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Well, the fact that, according to statistics, Asterisk is more often cracked, is determined by the fact that Asterisk has a lower threshold for entry than other systems. That is, a small IT specialist, after reading a couple of articles on the Internet, can deploy Asterisk, and since there is still not enough qualifications, the system is usually working, but vulnerable. And for the deployment of commercial solutions, you need experts in your business who pay due attention to security issues. This is the reason why Asterisk is being cracked more often.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IP-ATC Asterisk is a secure system when properly configured. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">References</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 1. Meggelen J., Madsen L., Smith J. Asterisktm: The Future of Telephony, 2nd Edition. - Per.</font></font> from English<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- SPb: Symbol Plus, 2009. - 656 s., Ill. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2. Platov M. Asterisk and Linux - mission IP-telephony [Text] / M. Platov // System Administrator. - 2005 - No. 31. - p. 12-19. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3. Platov M. Asterisk and Linux: the mission of IP-telephony. Action 2 [Text] / M. Platov // System Administrator. - 2005 - No. 32. - p. 32-38. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4. Platov M. Asterisk and Linux: the mission of IP-telephony. Step 3 [Text] / M. Platov // System Administrator. - 2005 - ‚Ññ 33. - p. 10-19. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">5. Asterisk Knowledge Base [Electronic resource]. - access mode: </font></font><a href="http://asterisk.ru/knowledgebase"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">asterisk.ru/knowledgebase</font></font></a> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 6. Knowledge base Voxlink [Electronic resource]. - access mode: </font></font><a href="http://www.voxlink.ru/kb/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">www.voxlink.ru/kb</font></font></a> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 7. HabrHabr. Security in VoIP networks [Electronic resource]. - access mode: </font></font><a href="http://habrahabr.ru/post/145206/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">habrahabr.ru/post/145206</font></font></a> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">8. Roslyakov A.V., Samsonov M.Yu., Shibaeva I.V. </font><font style="vertical-align: inherit;">IP telephony. </font><font style="vertical-align: inherit;">‚ÄìM .: Eco-Trend, 2003. -252 pp., Ill. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">9. Goldstein B.S., Pinchuk A.V., Sukhovitsky A.L. </font><font style="vertical-align: inherit;">IP telephony. </font><font style="vertical-align: inherit;">‚ÄìM .: Radio and Communication, 2001. -336 pp., Ill. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">10. CITForum. </font><font style="vertical-align: inherit;">IP telephony security - field sketches. </font><font style="vertical-align: inherit;">A. Veselov [Electronic resource]. </font><font style="vertical-align: inherit;">- access mode: </font></font><a href="http://citforum.ru/security/articles/ipsec/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">citforum.ru/security/articles/ipsec</font></font></a> <br><br>  PS <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Separately, thanks for the understanding of this issue to Sergey Voxlink CEO Sergey Grushko and his work. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I understand that the topic is beaten and it seems everyone knows everything, but at the same time there are no fewer cracked IP stations. </font><font style="vertical-align: inherit;">I hope that the article will be at least useful to someone.</font></font></div><p>Source: <a href="https://habr.com/ru/post/188440/">https://habr.com/ru/post/188440/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../188424/index.html">3G Modem and MikroTik</a></li>
<li><a href="../188430/index.html">Seven skills of a professional programmer</a></li>
<li><a href="../188432/index.html">First PyPy3 beta released with Python 3 support</a></li>
<li><a href="../188436/index.html">Habrahabr now accepts images for blog posts for permanent storage</a></li>
<li><a href="../188438/index.html">Dependency Injection in Unity3d</a></li>
<li><a href="../188444/index.html">To-do: Filter everything and everything</a></li>
<li><a href="../188446/index.html">How I collected a silent computer</a></li>
<li><a href="../188448/index.html">Regular expressions in nuclear transmutation calculations</a></li>
<li><a href="../188450/index.html">This is a mythical word team</a></li>
<li><a href="../188454/index.html">MGTS GPon subscribers under threat of hacking, new networks - new problems</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>