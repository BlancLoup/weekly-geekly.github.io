<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Rewrite the message database VKontakte from scratch and survive</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Our users write each other messages without knowing fatigue. 

 This is quite a lot. If you set out to read all the messages of all users, it would ta...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Rewrite the message database VKontakte from scratch and survive</h1><div class="post__text post__text-html js-mediator-article">  Our users write each other messages without knowing fatigue. <br><img src="https://habrastorage.org/webt/u_/fr/z4/u_frz4yk-f7x5tc_vspho6lm8bw.png"><br>  This is quite a lot.  If you set out to read all the messages of all users, it would take more than 150 thousand years.  Provided that you are pretty pumped reader and spend on each message no more than a second. <br><br>  With this amount of data, it is critical that the storage and access logic is optimally constructed.  Otherwise, in one not so beautiful moment, it may turn out that soon everything will go wrong. <br><br>  For us, this moment came a year and a half ago.  How we came to this and what happened in the end - we tell in order. <a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h3>  Background </h3><br>  In the very first implementation of the message VKontakte worked on a bunch of PHP-backend and MySQL.  This is quite a normal solution for a small student site.  However, this site was growing uncontrollably and began to demand to optimize data structures for themselves. <br><br>  At the end of 2009, the first text-engine storage was written, and in 2010 messages were transferred to it. <br><br>  The text-engine messages were stored lists - a kind of "mailboxes".  Each such list is determined by the uid, the user-owner of all these messages.  A message has a set of attributes: interlocutor ID, text, attachments, and so on.  The message identifier inside the ‚Äúbox‚Äù is local_id, it never changes and is assigned sequentially to new messages.  The ‚Äúboxes‚Äù are independent and with each other inside the engine are not synchronized in any way, the connection between them takes place already at the PHP level.  Look at the data structure and capabilities of the text-engine from the inside <a href="">here</a> . <br><img src="https://habrastorage.org/webt/z8/yp/bw/z8ypbwxfbob9_lxpw-3qucmyt_k.png"><br>  This was quite enough for the correspondence of two users.  Guess what happened next? <br><br>  In May 2011, VKontakte appeared conversations with several participants - multi chat.  To work with them, we raised two new clusters - member-chats and chat-members.  The first one stores data about chats by users, the second one - data about users by chats.  In addition to the lists themselves, this is, for example, the inviting user and the time of adding to the chat. <br><br>  ‚ÄúPHP, let's send a message to the chat,‚Äù says the user. <br>  ‚ÄúCome on, {username},‚Äù says PHP. <br><img src="https://habrastorage.org/webt/lw/yy/kg/lwyykgwv04yycznys8qh9gv-how.png"><br>  There are downsides to this scheme.  Synchronization is still assigned to PHP.  Big chats and users who simultaneously send messages to them is a dangerous story.  Since the text-engine instance depends on the uid, the chat participants could receive the same message with a time difference.  You could live with that if progress stood still.  But do not happen this. <br><br>  At the end of 2015, we launched community posts, and at the beginning of 2016, an API for them.  With the advent of large chat bots in the communities, it was possible to forget about the even distribution of the load. <br><br>  A good bot generates several million messages per day - even the most talkative users cannot boast of such.  And this means that some text-engine instances, on which such bots lived, began to fall in full. <br><br>  Message engines in 2016 are 100 instances of chat-members and member-chats, and 8000 text-engine.  They were located on thousands of servers, each with 64 GB of memory.  As a first emergency measure, we increased the memory by another 32 GB.  Estimated predictions.  Without fundamental changes, this would be enough for about a year.  It is necessary either to get rich with iron, or to optimize the databases themselves. <br><br>  Due to the nature of the architecture, it only makes sense to build up iron.  That is, at least double the number of cars - obviously, this is quite an expensive way.  We will optimize. <br><br><h3>  New concept </h3><br>  The central essence of the new approach is chat.  The chat has a list of messages that relate to it.  User has a chat list. <br><br>  The required minimum is two new databases: <br><br><ul><li>  chat-engine.  This is a repository of chat vectors.  Each chat has a vector of messages that relate to it.  Each message has a text and a unique message identifier within the chat - chat_local_id. </li><li>  user-engine  This is a repository of users - user links.  Each user has a peer_id vector (interlocutors - other users, multi-chat or communities) and a message vector.  Each peer_id has a vector of messages that apply to it.  Each message has a chat_local_id and the unique message identifier for this user is user_local_id. </li></ul><br><img src="https://habrastorage.org/webt/qp/0v/ub/qp0vubjw4r438fzuykmcjil93no.png"><br>  New clusters communicate with each other using TCP - this ensures that the order of the requests does not change.  The requests and confirmations for them are written to the hard drive - so we can restore the queue status at any time after a failure or restart of the engine.  Since the user-engine and chat-engine are 4,000 shards each, the queue of requests between the clusters will be evenly distributed (but in reality it is not at all - and it works very quickly). <br><br>  Working with the disk in our databases in most cases is based on a combination of a binary change log (binlog), static images and a partial image in memory.  Changes during the day are written in binlog, periodically a snapshot of the current state is created.  A snapshot is a set of data structures optimized for our purposes.  It consists of a header (meta-index snapshot) and a set of metafiles.  The header is permanently stored in RAM and indicates where to look for data from the snapshot.  Each metafile includes data that is likely to be needed at close moments in time ‚Äî for example, pertaining to a single user.  When requesting a database, the necessary metafile is read using a snapshot header, and then the changes in the binlog that have taken place after the snapshot creation are taken into account.  Read more about the benefits of this approach <a href="">here</a> . <br><br>  At the same time, the data on the hard disk itself is changed only once a day - late at night in Moscow, when the load is minimal.  Thanks to this (knowing that the structure on the disk is constant over the course of a day) we can afford to replace the vectors with arrays of a fixed size - and thereby win in memory. <br><br>  Sending a message in the new scheme looks like this: <br><br><ol><li>  PHP backend calls the user-engine with a request to send a message. </li><li>  The user-engine proxies the request to the required chat-engine instance, which returns the chat_local_id, the unique identifier of the new message within this chat, to the user-engine.  Then chat_engine sends the message to all recipients in the chat. </li><li>  The user-engine accepts chat_local_id from the chat-engine and returns to PHP user_local_id - the unique message identifier for this user.  This identifier is then used, for example, to work with messages through the API. </li></ol><br><img src="https://habrastorage.org/webt/qa/pf/vh/qapfvhbktt8x5-zdyvcw5yik954.png"><br>  But in addition to actually sending messages, you need to implement a few more important things: <br><br><ul><li>  Sublists are, for example, the most recent messages that you see when opening the list of conversations.  Unread messages, messages with labels (‚ÄúImportant‚Äù, ‚ÄúSpam‚Äù, etc.). </li><li>  Compress messages in chat-engine </li><li>  User-engine message caching </li><li>  Search (for all conversations and within the specific). </li><li>  Real time update (Longpolling). </li><li>  Storing history for implementing caching on mobile clients. </li></ul><br>  All sublists are rapidly changing structures.  To work with them, we use <a href="https://habrahabr.ru/company/spbau/blog/210296/">Splay-trees</a> .  This choice is explained by the fact that at the top of the tree we sometimes have a whole segment of messages from the snapshot - for example, after a night re-indexing, the tree consists of one vertex, in which all messages of the sublist lie.  A splay tree makes it easy to perform an insert operation in the middle of such a vertex, without thinking about balancing.  In addition, Splay does not store unnecessary data, and it saves us memory. <br><br>  Messages involve a large amount of information, mainly text, which is useful to be able to compress.  At the same time it is important that we can unarchive even one single message accurately.  To compress messages, we use <a href="https://habrahabr.ru/post/144200/">the Huffman algorithm</a> with our own heuristics ‚Äî for example, we know that in messages, words alternate with ‚Äúnot words‚Äù ‚Äîspaces, punctuation, and we also remember some peculiarities of using symbols for the Russian language. <br><br>  Since there are far fewer users than chat rooms, in order to save random-access disk requests in the chat-engine, we cache messages in the user-engine. <br><br>  Search by message is implemented as a diagonal request from the user-engine to all chat-engine instances that contain the chats of this user.  The results are already combined in the user-engine itself. <br><br>  Well, all the details have been taken into account, it remains to switch to a new scheme - and preferably so that users do not notice. <br><br><h3>  Data migration </h3><br>  So, we have a text-engine, which stores messages by users, and two clusters of chat-members and member-chats, which store data about multichats and users in them.  How to move from this to the new user-engine and chat-engine? <br><br>  The member-chats in the old scheme was used primarily for optimization.  We quickly transferred the necessary data from it to chat-members, and then he did not participate in the migration process anymore. <br><br>  Queue for chat-members.  It includes 100 copies, while the chat-engine - 4 thousand.  For the transfer of data, you need to bring them in line - for this, chat-members were broken into the same 4,000 instances, and after they turned on the reading of the binlog chat-members into the chat-engine. <br><img src="https://habrastorage.org/webt/as/iz/ul/asizulymdpagp3uhlrswxtkerem.png"><br>  Now the chat-engine knows about chat-members multi-chat, but so far he doesn‚Äôt know anything about conversations with two interlocutors.  Such dialogs lie in the text-engine with reference to users.  Here we took the data "in the forehead": each instance of the chat-engine asked all instances of the text-engine if they had the dialogue it needed. <br><br>  Great - the chat engine knows what multi chat is and knows what dialogue there are. <br>  It is necessary to combine messages in multicat - so that in the end for each chat to get a list of messages in it.  First, the chat-engine retrieves from the text-engine all user messages from this chat.  In some cases, there are quite a few of them (up to hundreds of millions), but with very few exceptions, the chat is completely placed in the RAM.  We have unordered messages, each in several copies - after all, they are all pulled out of different text-engine instances corresponding to the users.  The task is to sort the messages and get rid of copies that take up extra space. <br><br>  Each message has a timestamp containing the dispatch time and text.  We use time for sorting - we place pointers to the oldest messages of the participants of the multi chat and compare the hashes from the text of the intended copies, moving in the direction of increasing the timestamp.  It is logical that the copies will have the same hash and timestamp, but in practice this is not always the case.  As you remember, the synchronization in the old scheme was carried out by PHP - and in rare cases, the time to send the same message was different for different users.  In these cases, we allowed ourselves to edit the timestamp - usually within a second.  The second problem is the different order of messages for different recipients.  In such cases, we allowed the creation of an extra copy, with different versions of the order for different users. <br><br>  After this, the data on messages in multi-chat is sent to the user-engine.  And here comes the unpleasant feature of the imported messages.  In normal operation, messages that arrive in the engine are ordered strictly in ascending order by user_local_id.  The messages imported from the old engine in the user-engine lost this useful property.  At the same time for the convenience of testing, you need to be able to quickly contact them, look for something in them and add new ones. <br><br>  To store the imported messages, we use a special data structure. <br><br>  It is a size vector. <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-1-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>n</mi><mo>=</mo><msup><mn>2</mn><mrow class=&quot;MJX-TeXAtom-ORD&quot;><msub><mi>a</mi><mn>0</mn></msub></mrow></msup><mo>+</mo><msup><mn>2</mn><mrow class=&quot;MJX-TeXAtom-ORD&quot;><msub><mi>a</mi><mn>1</mn></msub></mrow></msup><mo>+</mo><mo>.</mo><mo>.</mo><mo>.</mo><mo>+</mo><msup><mn>2</mn><mrow class=&quot;MJX-TeXAtom-ORD&quot;><msub><mi>a</mi><mi>k</mi></msub></mrow></msup><mi>n</mi><mo>=</mo><msup><mn>2</mn><mrow class=&quot;MJX-TeXAtom-ORD&quot;><msub><mi>a</mi><mn>0</mn></msub></mrow></msup><mo>+</mo><msup><mn>2</mn><mrow class=&quot;MJX-TeXAtom-ORD&quot;><msub><mi>a</mi><mn>1</mn></msub></mrow></msup><mo>+</mo><mo>.</mo><mo>.</mo><mo>.</mo><mo>+</mo><msup><mn>2</mn><mrow class=&quot;MJX-TeXAtom-ORD&quot;><msub><mi>a</mi><mi>k</mi></msub></mrow></msup></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="46.211ex" height="2.178ex" viewBox="0 -780.1 19896.2 937.7" role="img" focusable="false" style="vertical-align: -0.366ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/vk/blog/342570/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhgy_6mHX9m8MXzBRUf1478ecPSRGA#MJMATHI-6E" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/vk/blog/342570/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhgy_6mHX9m8MXzBRUf1478ecPSRGA#MJMAIN-3D" x="878" y="0"></use><g transform="translate(1934,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/vk/blog/342570/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhgy_6mHX9m8MXzBRUf1478ecPSRGA#MJMAIN-32" x="0" y="0"></use><g transform="translate(500,393)"><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/vk/blog/342570/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhgy_6mHX9m8MXzBRUf1478ecPSRGA#MJMATHI-61" x="0" y="0"></use><use transform="scale(0.5)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/vk/blog/342570/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhgy_6mHX9m8MXzBRUf1478ecPSRGA#MJMAIN-30" x="748" y="-213"></use></g></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/vk/blog/342570/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhgy_6mHX9m8MXzBRUf1478ecPSRGA#MJMAIN-2B" x="3452" y="0"></use><g transform="translate(4453,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/vk/blog/342570/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhgy_6mHX9m8MXzBRUf1478ecPSRGA#MJMAIN-32" x="0" y="0"></use><g transform="translate(500,393)"><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/vk/blog/342570/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhgy_6mHX9m8MXzBRUf1478ecPSRGA#MJMATHI-61" x="0" y="0"></use><use transform="scale(0.5)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/vk/blog/342570/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhgy_6mHX9m8MXzBRUf1478ecPSRGA#MJMAIN-31" x="748" y="-213"></use></g></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/vk/blog/342570/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhgy_6mHX9m8MXzBRUf1478ecPSRGA#MJMAIN-2B" x="5749" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/vk/blog/342570/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhgy_6mHX9m8MXzBRUf1478ecPSRGA#MJMAIN-2E" x="6527" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/vk/blog/342570/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhgy_6mHX9m8MXzBRUf1478ecPSRGA#MJMAIN-2E" x="6972" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/vk/blog/342570/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhgy_6mHX9m8MXzBRUf1478ecPSRGA#MJMAIN-2E" x="7418" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/vk/blog/342570/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhgy_6mHX9m8MXzBRUf1478ecPSRGA#MJMAIN-2B" x="7863" y="0"></use><g transform="translate(8641,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/vk/blog/342570/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhgy_6mHX9m8MXzBRUf1478ecPSRGA#MJMAIN-32" x="0" y="0"></use><g transform="translate(500,393)"><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/vk/blog/342570/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhgy_6mHX9m8MXzBRUf1478ecPSRGA#MJMATHI-61" x="0" y="0"></use><use transform="scale(0.5)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/vk/blog/342570/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhgy_6mHX9m8MXzBRUf1478ecPSRGA#MJMATHI-6B" x="748" y="-213"></use></g></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/vk/blog/342570/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhgy_6mHX9m8MXzBRUf1478ecPSRGA#MJMATHI-6E" x="9948" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/vk/blog/342570/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhgy_6mHX9m8MXzBRUf1478ecPSRGA#MJMAIN-3D" x="10826" y="0"></use><g transform="translate(11882,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/vk/blog/342570/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhgy_6mHX9m8MXzBRUf1478ecPSRGA#MJMAIN-32" x="0" y="0"></use><g transform="translate(500,393)"><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/vk/blog/342570/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhgy_6mHX9m8MXzBRUf1478ecPSRGA#MJMATHI-61" x="0" y="0"></use><use transform="scale(0.5)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/vk/blog/342570/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhgy_6mHX9m8MXzBRUf1478ecPSRGA#MJMAIN-30" x="748" y="-213"></use></g></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/vk/blog/342570/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhgy_6mHX9m8MXzBRUf1478ecPSRGA#MJMAIN-2B" x="13400" y="0"></use><g transform="translate(14401,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/vk/blog/342570/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhgy_6mHX9m8MXzBRUf1478ecPSRGA#MJMAIN-32" x="0" y="0"></use><g transform="translate(500,393)"><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/vk/blog/342570/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhgy_6mHX9m8MXzBRUf1478ecPSRGA#MJMATHI-61" x="0" y="0"></use><use transform="scale(0.5)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/vk/blog/342570/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhgy_6mHX9m8MXzBRUf1478ecPSRGA#MJMAIN-31" x="748" y="-213"></use></g></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/vk/blog/342570/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhgy_6mHX9m8MXzBRUf1478ecPSRGA#MJMAIN-2B" x="15697" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/vk/blog/342570/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhgy_6mHX9m8MXzBRUf1478ecPSRGA#MJMAIN-2E" x="16475" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/vk/blog/342570/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhgy_6mHX9m8MXzBRUf1478ecPSRGA#MJMAIN-2E" x="16921" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/vk/blog/342570/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhgy_6mHX9m8MXzBRUf1478ecPSRGA#MJMAIN-2E" x="17366" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/vk/blog/342570/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhgy_6mHX9m8MXzBRUf1478ecPSRGA#MJMAIN-2B" x="17811" y="0"></use><g transform="translate(18589,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/vk/blog/342570/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhgy_6mHX9m8MXzBRUf1478ecPSRGA#MJMAIN-32" x="0" y="0"></use><g transform="translate(500,393)"><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/vk/blog/342570/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhgy_6mHX9m8MXzBRUf1478ecPSRGA#MJMATHI-61" x="0" y="0"></use><use transform="scale(0.5)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/vk/blog/342570/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhgy_6mHX9m8MXzBRUf1478ecPSRGA#MJMATHI-6B" x="748" y="-213"></use></g></g></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>n</mi><mo>=</mo><msup><mn>2</mn><mrow class="MJX-TeXAtom-ORD"><msub><mi>a</mi><mn>0</mn></msub></mrow></msup><mo>+</mo><msup><mn>2</mn><mrow class="MJX-TeXAtom-ORD"><msub><mi>a</mi><mn>1</mn></msub></mrow></msup><mo>+</mo><mo>.</mo><mo>.</mo><mo>.</mo><mo>+</mo><msup><mn>2</mn><mrow class="MJX-TeXAtom-ORD"><msub><mi>a</mi><mi>k</mi></msub></mrow></msup><mi>n</mi><mo>=</mo><msup><mn>2</mn><mrow class="MJX-TeXAtom-ORD"><msub><mi>a</mi><mn>0</mn></msub></mrow></msup><mo>+</mo><msup><mn>2</mn><mrow class="MJX-TeXAtom-ORD"><msub><mi>a</mi><mn>1</mn></msub></mrow></msup><mo>+</mo><mo>.</mo><mo>.</mo><mo>.</mo><mo>+</mo><msup><mn>2</mn><mrow class="MJX-TeXAtom-ORD"><msub><mi>a</mi><mi>k</mi></msub></mrow></msup></math></span></span><script type="math/tex" id="MathJax-Element-1"> n = 2 ^ {a_0} + 2 ^ {a_1} + ... + 2 ^ {a_k} n = 2 ^ {a_0} + 2 ^ {a_1} + ... + 2 ^ {a_k} </script>  where everything is <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-2-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>a</mi><mi>i</mi></msub></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.029ex" height="1.817ex" viewBox="0 -520.7 873.8 782.1" role="img" focusable="false" style="vertical-align: -0.607ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/vk/blog/342570/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhgy_6mHX9m8MXzBRUf1478ecPSRGA#MJMATHI-61" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/vk/blog/342570/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhgy_6mHX9m8MXzBRUf1478ecPSRGA#MJMATHI-69" x="748" y="-213"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><msub><mi>a</mi><mi>i</mi></msub></math></span></span><script type="math/tex" id="MathJax-Element-2"> a_i </script>  - are different and ordered in descending order, with a special order of elements.  In each segment with indices <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-3-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mo stretchy=&quot;false&quot;>[</mo><mn>0</mn><mo>,</mo><msup><mn>2</mn><mrow class=&quot;MJX-TeXAtom-ORD&quot;><msub><mi>a</mi><mn>0</mn></msub></mrow></msup><mo stretchy=&quot;false&quot;>)</mo><mo>,</mo><mo stretchy=&quot;false&quot;>[</mo><msup><mn>2</mn><mrow class=&quot;MJX-TeXAtom-ORD&quot;><msub><mi>a</mi><mn>0</mn></msub></mrow></msup><mo>,</mo><msup><mn>2</mn><mrow class=&quot;MJX-TeXAtom-ORD&quot;><msub><mi>a</mi><mn>0</mn></msub></mrow></msup><mo>+</mo><msup><mn>2</mn><mrow class=&quot;MJX-TeXAtom-ORD&quot;><msub><mi>a</mi><mn>1</mn></msub></mrow></msup><mo stretchy=&quot;false&quot;>)</mo><mo>,</mo><mo stretchy=&quot;false&quot;>[</mo><msup><mn>2</mn><mrow class=&quot;MJX-TeXAtom-ORD&quot;><msub><mi>a</mi><mn>0</mn></msub></mrow></msup><mo>+</mo><msup><mn>2</mn><mrow class=&quot;MJX-TeXAtom-ORD&quot;><msub><mi>a</mi><mn>1</mn></msub></mrow></msup><mo>,</mo><msup><mn>2</mn><mrow class=&quot;MJX-TeXAtom-ORD&quot;><msub><mi>a</mi><mn>0</mn></msub></mrow></msup><mo>+</mo><msup><mn>2</mn><mrow class=&quot;MJX-TeXAtom-ORD&quot;><msub><mi>a</mi><mn>1</mn></msub></mrow></msup><mo>+</mo><msup><mn>2</mn><mrow class=&quot;MJX-TeXAtom-ORD&quot;><msub><mi>a</mi><mn>2</mn></msub></mrow></msup><mo stretchy=&quot;false&quot;>)</mo><mo>,</mo><mo>.</mo><mo>.</mo><mo>.</mo></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="53.185ex" height="2.66ex" viewBox="0 -832 22899 1145.2" role="img" focusable="false" style="vertical-align: -0.728ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/vk/blog/342570/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhgy_6mHX9m8MXzBRUf1478ecPSRGA#MJMAIN-5B" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/vk/blog/342570/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhgy_6mHX9m8MXzBRUf1478ecPSRGA#MJMAIN-30" x="278" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/vk/blog/342570/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhgy_6mHX9m8MXzBRUf1478ecPSRGA#MJMAIN-2C" x="779" y="0"></use><g transform="translate(1224,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/vk/blog/342570/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhgy_6mHX9m8MXzBRUf1478ecPSRGA#MJMAIN-32" x="0" y="0"></use><g transform="translate(500,393)"><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/vk/blog/342570/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhgy_6mHX9m8MXzBRUf1478ecPSRGA#MJMATHI-61" x="0" y="0"></use><use transform="scale(0.5)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/vk/blog/342570/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhgy_6mHX9m8MXzBRUf1478ecPSRGA#MJMAIN-30" x="748" y="-213"></use></g></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/vk/blog/342570/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhgy_6mHX9m8MXzBRUf1478ecPSRGA#MJMAIN-29" x="2520" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/vk/blog/342570/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhgy_6mHX9m8MXzBRUf1478ecPSRGA#MJMAIN-2C" x="2909" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/vk/blog/342570/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhgy_6mHX9m8MXzBRUf1478ecPSRGA#MJMAIN-5B" x="3354" y="0"></use><g transform="translate(3633,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/vk/blog/342570/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhgy_6mHX9m8MXzBRUf1478ecPSRGA#MJMAIN-32" x="0" y="0"></use><g transform="translate(500,393)"><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/vk/blog/342570/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhgy_6mHX9m8MXzBRUf1478ecPSRGA#MJMATHI-61" x="0" y="0"></use><use transform="scale(0.5)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/vk/blog/342570/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhgy_6mHX9m8MXzBRUf1478ecPSRGA#MJMAIN-30" x="748" y="-213"></use></g></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/vk/blog/342570/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhgy_6mHX9m8MXzBRUf1478ecPSRGA#MJMAIN-2C" x="4929" y="0"></use><g transform="translate(5374,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/vk/blog/342570/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhgy_6mHX9m8MXzBRUf1478ecPSRGA#MJMAIN-32" x="0" y="0"></use><g transform="translate(500,393)"><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/vk/blog/342570/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhgy_6mHX9m8MXzBRUf1478ecPSRGA#MJMATHI-61" x="0" y="0"></use><use transform="scale(0.5)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/vk/blog/342570/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhgy_6mHX9m8MXzBRUf1478ecPSRGA#MJMAIN-30" x="748" y="-213"></use></g></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/vk/blog/342570/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhgy_6mHX9m8MXzBRUf1478ecPSRGA#MJMAIN-2B" x="6892" y="0"></use><g transform="translate(7893,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/vk/blog/342570/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhgy_6mHX9m8MXzBRUf1478ecPSRGA#MJMAIN-32" x="0" y="0"></use><g transform="translate(500,393)"><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/vk/blog/342570/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhgy_6mHX9m8MXzBRUf1478ecPSRGA#MJMATHI-61" x="0" y="0"></use><use transform="scale(0.5)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/vk/blog/342570/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhgy_6mHX9m8MXzBRUf1478ecPSRGA#MJMAIN-31" x="748" y="-213"></use></g></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/vk/blog/342570/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhgy_6mHX9m8MXzBRUf1478ecPSRGA#MJMAIN-29" x="9188" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/vk/blog/342570/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhgy_6mHX9m8MXzBRUf1478ecPSRGA#MJMAIN-2C" x="9578" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/vk/blog/342570/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhgy_6mHX9m8MXzBRUf1478ecPSRGA#MJMAIN-5B" x="10023" y="0"></use><g transform="translate(10302,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/vk/blog/342570/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhgy_6mHX9m8MXzBRUf1478ecPSRGA#MJMAIN-32" x="0" y="0"></use><g transform="translate(500,393)"><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/vk/blog/342570/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhgy_6mHX9m8MXzBRUf1478ecPSRGA#MJMATHI-61" x="0" y="0"></use><use transform="scale(0.5)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/vk/blog/342570/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhgy_6mHX9m8MXzBRUf1478ecPSRGA#MJMAIN-30" x="748" y="-213"></use></g></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/vk/blog/342570/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhgy_6mHX9m8MXzBRUf1478ecPSRGA#MJMAIN-2B" x="11820" y="0"></use><g transform="translate(12820,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/vk/blog/342570/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhgy_6mHX9m8MXzBRUf1478ecPSRGA#MJMAIN-32" x="0" y="0"></use><g transform="translate(500,393)"><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/vk/blog/342570/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhgy_6mHX9m8MXzBRUf1478ecPSRGA#MJMATHI-61" x="0" y="0"></use><use transform="scale(0.5)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/vk/blog/342570/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhgy_6mHX9m8MXzBRUf1478ecPSRGA#MJMAIN-31" x="748" y="-213"></use></g></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/vk/blog/342570/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhgy_6mHX9m8MXzBRUf1478ecPSRGA#MJMAIN-2C" x="14116" y="0"></use><g transform="translate(14561,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/vk/blog/342570/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhgy_6mHX9m8MXzBRUf1478ecPSRGA#MJMAIN-32" x="0" y="0"></use><g transform="translate(500,393)"><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/vk/blog/342570/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhgy_6mHX9m8MXzBRUf1478ecPSRGA#MJMATHI-61" x="0" y="0"></use><use transform="scale(0.5)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/vk/blog/342570/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhgy_6mHX9m8MXzBRUf1478ecPSRGA#MJMAIN-30" x="748" y="-213"></use></g></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/vk/blog/342570/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhgy_6mHX9m8MXzBRUf1478ecPSRGA#MJMAIN-2B" x="16080" y="0"></use><g transform="translate(17080,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/vk/blog/342570/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhgy_6mHX9m8MXzBRUf1478ecPSRGA#MJMAIN-32" x="0" y="0"></use><g transform="translate(500,393)"><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/vk/blog/342570/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhgy_6mHX9m8MXzBRUf1478ecPSRGA#MJMATHI-61" x="0" y="0"></use><use transform="scale(0.5)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/vk/blog/342570/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhgy_6mHX9m8MXzBRUf1478ecPSRGA#MJMAIN-31" x="748" y="-213"></use></g></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/vk/blog/342570/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhgy_6mHX9m8MXzBRUf1478ecPSRGA#MJMAIN-2B" x="18598" y="0"></use><g transform="translate(19599,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/vk/blog/342570/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhgy_6mHX9m8MXzBRUf1478ecPSRGA#MJMAIN-32" x="0" y="0"></use><g transform="translate(500,393)"><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/vk/blog/342570/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhgy_6mHX9m8MXzBRUf1478ecPSRGA#MJMATHI-61" x="0" y="0"></use><use transform="scale(0.5)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/vk/blog/342570/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhgy_6mHX9m8MXzBRUf1478ecPSRGA#MJMAIN-32" x="748" y="-213"></use></g></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/vk/blog/342570/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhgy_6mHX9m8MXzBRUf1478ecPSRGA#MJMAIN-29" x="20895" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/vk/blog/342570/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhgy_6mHX9m8MXzBRUf1478ecPSRGA#MJMAIN-2C" x="21284" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/vk/blog/342570/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhgy_6mHX9m8MXzBRUf1478ecPSRGA#MJMAIN-2E" x="21730" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/vk/blog/342570/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhgy_6mHX9m8MXzBRUf1478ecPSRGA#MJMAIN-2E" x="22175" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/vk/blog/342570/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhgy_6mHX9m8MXzBRUf1478ecPSRGA#MJMAIN-2E" x="22620" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mo stretchy="false">[</mo><mn>0</mn><mo>,</mo><msup><mn>2</mn><mrow class="MJX-TeXAtom-ORD"><msub><mi>a</mi><mn>0</mn></msub></mrow></msup><mo stretchy="false">)</mo><mo>,</mo><mo stretchy="false">[</mo><msup><mn>2</mn><mrow class="MJX-TeXAtom-ORD"><msub><mi>a</mi><mn>0</mn></msub></mrow></msup><mo>,</mo><msup><mn>2</mn><mrow class="MJX-TeXAtom-ORD"><msub><mi>a</mi><mn>0</mn></msub></mrow></msup><mo>+</mo><msup><mn>2</mn><mrow class="MJX-TeXAtom-ORD"><msub><mi>a</mi><mn>1</mn></msub></mrow></msup><mo stretchy="false">)</mo><mo>,</mo><mo stretchy="false">[</mo><msup><mn>2</mn><mrow class="MJX-TeXAtom-ORD"><msub><mi>a</mi><mn>0</mn></msub></mrow></msup><mo>+</mo><msup><mn>2</mn><mrow class="MJX-TeXAtom-ORD"><msub><mi>a</mi><mn>1</mn></msub></mrow></msup><mo>,</mo><msup><mn>2</mn><mrow class="MJX-TeXAtom-ORD"><msub><mi>a</mi><mn>0</mn></msub></mrow></msup><mo>+</mo><msup><mn>2</mn><mrow class="MJX-TeXAtom-ORD"><msub><mi>a</mi><mn>1</mn></msub></mrow></msup><mo>+</mo><msup><mn>2</mn><mrow class="MJX-TeXAtom-ORD"><msub><mi>a</mi><mn>2</mn></msub></mrow></msup><mo stretchy="false">)</mo><mo>,</mo><mo>.</mo><mo>.</mo><mo>.</mo></math></span></span><script type="math/tex" id="MathJax-Element-3"> [0,2 ^ {a_0}), [2 ^ {a_0}, 2 ^ {a_0} + 2 ^ {a_1}), [2 ^ {a_0} + 2 ^ {a_1}, 2 ^ {a_0} + 2 ^ {a_1} + 2 ^ {a_2}), ... </script>  items are sorted.  The search for an element in such a structure is performed in time. <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-4-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>O</mi><mo stretchy=&quot;false&quot;>(</mo><mi>l</mi><mi>o</mi><msup><mi>g</mi><mn>2</mn></msup><mi>n</mi><mo stretchy=&quot;false&quot;>)</mo></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="8.971ex" height="2.901ex" viewBox="0 -935.7 3862.4 1249" role="img" focusable="false" style="vertical-align: -0.728ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/vk/blog/342570/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhgy_6mHX9m8MXzBRUf1478ecPSRGA#MJMATHI-4F" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/vk/blog/342570/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhgy_6mHX9m8MXzBRUf1478ecPSRGA#MJMAIN-28" x="763" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/vk/blog/342570/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhgy_6mHX9m8MXzBRUf1478ecPSRGA#MJMATHI-6C" x="1153" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/vk/blog/342570/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhgy_6mHX9m8MXzBRUf1478ecPSRGA#MJMATHI-6F" x="1451" y="0"></use><g transform="translate(1937,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/vk/blog/342570/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhgy_6mHX9m8MXzBRUf1478ecPSRGA#MJMATHI-67" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/vk/blog/342570/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhgy_6mHX9m8MXzBRUf1478ecPSRGA#MJMAIN-32" x="680" y="513"></use></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/vk/blog/342570/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhgy_6mHX9m8MXzBRUf1478ecPSRGA#MJMATHI-6E" x="2872" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/vk/blog/342570/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhgy_6mHX9m8MXzBRUf1478ecPSRGA#MJMAIN-29" x="3472" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>O</mi><mo stretchy="false">(</mo><mi>l</mi><mi>o</mi><msup><mi>g</mi><mn>2</mn></msup><mi>n</mi><mo stretchy="false">)</mo></math></span></span><script type="math/tex" id="MathJax-Element-4"> O (log ^ 2n) </script>  through <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-5-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>l</mi><mi>o</mi><mi>g</mi><mspace width=&quot;mediummathspace&quot; /><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>n</mi></mrow></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.848ex" height="2.419ex" viewBox="0 -780.1 2087.2 1041.5" role="img" focusable="false" style="vertical-align: -0.607ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/vk/blog/342570/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhgy_6mHX9m8MXzBRUf1478ecPSRGA#MJMATHI-6C" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/vk/blog/342570/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhgy_6mHX9m8MXzBRUf1478ecPSRGA#MJMATHI-6F" x="298" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/vk/blog/342570/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhgy_6mHX9m8MXzBRUf1478ecPSRGA#MJMATHI-67" x="784" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/vk/blog/342570/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhgy_6mHX9m8MXzBRUf1478ecPSRGA#MJMATHI-6E" x="1486" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>l</mi><mi>o</mi><mi>g</mi><mspace width="mediummathspace"></mspace><mrow class="MJX-TeXAtom-ORD"><mi>n</mi></mrow></math></span></span><script type="math/tex" id="MathJax-Element-5"> log \: {n} </script>  binary searches.  Adding item is depreciated for <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-6-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>O</mi><mo stretchy=&quot;false&quot;>(</mo><mi>l</mi><mi>o</mi><msup><mi>g</mi><mn>2</mn></msup><mi>n</mi><mo stretchy=&quot;false&quot;>)</mo></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="8.971ex" height="2.901ex" viewBox="0 -935.7 3862.4 1249" role="img" focusable="false" style="vertical-align: -0.728ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/vk/blog/342570/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhgy_6mHX9m8MXzBRUf1478ecPSRGA#MJMATHI-4F" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/vk/blog/342570/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhgy_6mHX9m8MXzBRUf1478ecPSRGA#MJMAIN-28" x="763" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/vk/blog/342570/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhgy_6mHX9m8MXzBRUf1478ecPSRGA#MJMATHI-6C" x="1153" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/vk/blog/342570/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhgy_6mHX9m8MXzBRUf1478ecPSRGA#MJMATHI-6F" x="1451" y="0"></use><g transform="translate(1937,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/vk/blog/342570/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhgy_6mHX9m8MXzBRUf1478ecPSRGA#MJMATHI-67" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/vk/blog/342570/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhgy_6mHX9m8MXzBRUf1478ecPSRGA#MJMAIN-32" x="680" y="513"></use></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/vk/blog/342570/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhgy_6mHX9m8MXzBRUf1478ecPSRGA#MJMATHI-6E" x="2872" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/vk/blog/342570/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhgy_6mHX9m8MXzBRUf1478ecPSRGA#MJMAIN-29" x="3472" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>O</mi><mo stretchy="false">(</mo><mi>l</mi><mi>o</mi><msup><mi>g</mi><mn>2</mn></msup><mi>n</mi><mo stretchy="false">)</mo></math></span></span><script type="math/tex" id="MathJax-Element-6"> O (log ^ 2n) </script>  . <br><br>  So, we figured out how to transfer data from old engines to new ones.  But this process takes several days - and it‚Äôs unlikely for these days our users will give up the habit of writing to each other.  In order not to lose messages during this time, we switch to the work scheme, which involves both old and new clusters. <br><br>  Data recording goes to chat-members and user-engine (and not to the text-engine, as during normal operation according to the old scheme).  The user-engine proxies the request to the chat-engine - and here the behavior depends on whether this chat is already or not.  If the chat is not yet confused, the chat-engine does not write a message to itself, and it is processed only in the text-engine.  If the chat is already chatted in the chat-engine, it returns chat_local_id to the user-engine and sends the message to all recipients.  The user-engine proxies all the data in the text-engine - so that in case of anything, we can always roll back, having all the actual data in the old engine.  The text-engine returns a user_local_id, which the user-engine keeps and returns to the backend. <br><img src="https://habrastorage.org/webt/xb/co/fk/xbcofk5_vjtqx2swd-ptevpbbuk.png"><br>  As a result, the transition process looks like this: we connect empty user-engine clusters and chat-engine.  chat-engine reads all chat-members binlogs, then proxies are started according to the scheme described above.  Pouring old data, we get two synchronized clusters (old and new).  It remains only to switch the reading from the text-engine to the user-engine and disable proxying. <br><br><h3>  results </h3><br>  Thanks to the new approach, all metrics of engine performance have improved, problems with data consistency have been resolved.  Now we can more quickly implement new features in messages (and have already begun to do this - increased the maximum number of chat participants, implemented a search on forwarded messages, launched pinned messages, and raised the limit on the total number of messages from one user). <br><br>  The changes in logic are really grand.  And I want to note that this does not always mean whole years of development by a huge team and a myriad lines of code.  chat-engine and user-engine, along with all the additional stories like Huffman for compressing messages, Splay-trees and the structure for imported messages, are less than 20 thousand lines of code.  And they were written by 3 developers in just 10 months (however, it should be borne in mind that <a href="https://vk.com/de">all</a> <a href="https://vk.com/kunyavskiy">three</a> <a href="https://vk.com/bminaiev">developers</a> are world champions <a href="https://vk.com/blog/code-contests">in sports programming</a> ). <br><br>  Moreover, instead of doubling the number of servers, we came to reduce their number by half - now the user-engine and chat-engine live on 500 physical machines, while the new scheme has a large margin on load.  We saved a lot of money on equipment - about $ 5 million + $ 750 thousand per year due to operating expenses. <br><br>  We strive to find the best solutions for the most complex and large-scale tasks.  We have plenty of them - and therefore we are looking for talented developers in the database department.  If you like and are able to solve such problems, well know the algorithms and data structures, we invite you to join the team.  Contact our <a href="https://vk.com/hr">HR</a> to find out more. <br><br>  Even if this story is not about you, please note that we appreciate the recommendations.  Tell a friend about the <a href="https://vk.com/jobs">developer</a> ‚Äôs <a href="https://vk.com/jobs">job</a> , and if he successfully passes the probationary period, you will receive a bonus of 100 thousand rubles. </div><p>Source: <a href="https://habr.com/ru/post/342570/">https://habr.com/ru/post/342570/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../342556/index.html">Not a simple coordinate system, but a gold one.</a></li>
<li><a href="../342560/index.html">Telegram conference bot (start)</a></li>
<li><a href="../342562/index.html">Vim as an esoteric text editing language</a></li>
<li><a href="../342564/index.html">CubeDB: minimalistic storage of meters with multidimensional keys</a></li>
<li><a href="../342566/index.html">How to write your swagger and not regret it</a></li>
<li><a href="../342572/index.html">Classification of the humanities and techies by comments in VK</a></li>
<li><a href="../342574/index.html">We pick a cryptograph, let's call it - ‚Äúnekema‚Äù</a></li>
<li><a href="../342576/index.html">User survey Habra</a></li>
<li><a href="../342578/index.html">Jest and Puppeteer: automation of testing web interfaces</a></li>
<li><a href="../342580/index.html">ShellCheck Static Analyzer and Script Improvement for Linux and Unix</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>