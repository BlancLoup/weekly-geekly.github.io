<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Zabbix + Iostat: monitoring the disk subsystem</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Zabbix + Iostat: monitoring the disk subsystem. 

 What for? 
 The disk subsystem is one of the important server subsystems and very much depends on t...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Zabbix + Iostat: monitoring the disk subsystem</h1><div class="post__text post__text-html js-mediator-article">  Zabbix + Iostat: monitoring the disk subsystem. <br><img src="https://habrastorage.org/getpro/habr/post_images/bd6/ad0/f06/bd6ad0f06c460edb3edb071bc18b0960.jpg" alt="image" align="right"><br>  <b>What for?</b> <br>  The disk subsystem is one of the important server subsystems and very much depends on the level of the load on the disk subsystem, for example, the speed of content delivery or how quickly the database will respond.  This largely applies to mail or file servers, database servers.  In general, disk performance indicators need to be monitored.  Based on the performance graphs of the disk subsystem, we can decide on the need to increase capacity long before the rooster bites.  And in general, it is useful to glance from release to release as the work of developers affects the level of workload. <br><br>  Under the cut, on monitoring and how to configure. <br><a name="habracut"></a><br>  <b>Dependencies:</b> <br>  Monitoring is implemented through a zabbix agent and two utilities: awk and iostat (sysstat package).  If awk comes in distributions by default, then iostat needs to be installed with the <a href="http://sebastien.godard.pagesperso-orange.fr/features.html">sysstat package</a> (thanks to Sebastien Godard and co-workers). <br><br>  <b>Known limitations:</b> <br>  For monitoring, you need sysstat starting from version 9.1.2, since  there is a very important change: "Added r_await and w_await fields to iostat's extended statistics".  So you should be careful, in some distros, for example, CentOS has a slightly ‚Äústable‚Äù and less feature-free version of sysstat. <br>  If you start from the version of zabbix (2.0 or 2.2), then the question is not fundamental, it works on both versions.  At 1.8 it does not work.  Low level discovery is used. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <b>Opportunities</b> (purely subjective, as the utility decreases): <br><ul><li>  Low level discovery (hereinafter simply LLD) for automatic detection of block devices on the monitored node; </li><li>  utilization of the block device in% - a convenient metric for tracking the total load on the device; </li><li>  latency or responsiveness - both general responsiveness and responsiveness to read / write operations are available; </li><li>  the size of the queue (in requests) and the average size of the request (in sectors) - allows you to assess the nature of the load and the degree of congestion of the device; </li><li>  the current read / write speed on the device in kilobytes understandable; </li><li>  the number of read / write requests (per second) combined when queued for execution; </li><li>  iops - the value of read / write operations per second; </li><li>  average request service time (svctm).  In general, it is deprecated, the developers promise to cut it for a long time, but all the hands do not reach. </li></ul><br>  In general, as you can see, all the metrics that are available in iostat are available here (those who are unfamiliar with this utility, I strongly recommend that you look into man iostat). <br><br>  <b>Available graphics:</b> <br>  Graphs are drawn per-device, LLD detects devices that fall under the regular expression "(xvd | sd | hd | vd) [az]", so if your disks have different names, you can easily make the appropriate changes.  Such a regular schedule is made to detect devices that will be parental to other partitions, LVM volumes, MDRAID arrays, etc.  In general so as not to collect too much.  A little distracted, so the list of graphs: <br><ul><li>  Disk await - device responsiveness (r_await, w_await); </li><li>  Disk merges - merge operations in the queue (rrqm / s, wrqm / s); </li><li>  Disk queue - the queue status (avgrq-sz, avgqu-sz); </li><li>  Disk read and write - the current read / write values ‚Äã‚Äãon the device (rkB / s, wkB / s); </li><li>  Disk utilization - disk utilization and IOPS value (% util, r / s, w / s) - makes it possible to track jumps in utilization and what they were caused by reading or writing. </li></ul><br>  <b>Analogs and differences:</b> <br>  Zabbix has boxed options for similar monitoring, these are the keys <i>vfs.dev.read</i> and <i>vfs.dev.write</i> .  They are good and work fine, but less informative than iostat.  For example, iostat has metrics like latency and utilization. <br>  There is also a similar pattern from <a href="http://michael.nomanlab.org/2012/09/zabbix-iostat.html">Michael Noman.</a> In my opinion, the only difference is one, it is sharpened on the old versions of iostat, well, and + small syntactic changes. <br><br>  <b>Where to get:</b> <br>  So, monitoring consists of a configuration file for the agent, two scripts for collecting / receiving data and a template for the web interface.  All this is available in the repository on <a href="https://github.com/lesovsky/zabbix-extensions/tree/master/files/iostat">Github</a> , so by any available means (git clone, wget, curl, etc ...) we download them to the machines we want to monitor and proceed to the next item. <br><br>  <b>How to setup:</b> <br><ul><li>  iostat.conf - the contents of this file should be placed in the zabbix agent configuration file, or put in the configuration directory specified in the Include option of the main agent configuration.  In general, it depends on the policy of the party.  I use the second option, for custom configs I have a separate directory. </li><li>  scripts / iostat-collect.sh and scripts / iostat-parse.sh - this two working scripts should be copied to / usr / libexec / zabbix-extensions / scripts /.  Here you can also use a location that is convenient for you, but in this case do not forget to correct the paths in the parameters defined in iostat.conf.  Do not forget to check that they are executable (mode = 755). </li></ul><br>  Now everything is ready, we start the agent and go to the monitoring server and execute the command (do not forget to change the agent_ip): <br><pre><code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># zabbix_get -s agent_ip -k iostat.discovery</span></span></code> </pre> <br>  Thus, we check from the monitoring server that iostat.conf is loaded and gives information, at the same time we are watching that LLD works.  JSON with the names of detected devices will be returned as an answer.  If the answer has not come, then something did wrong. <br><br>  There is also such a moment that the zabbix server does not wait for the execution of some item'ov by agents (iostat.collect).  To do this, increase the timeout values. <br><br>  <b>How to configure the web interface:</b> <br>  Now the iostat-disk-utilization-template.xml template remains.  Via the web interface, we import it into the templates section and assign it to our host.  It's simple.  Now it remains to wait about one hour, this time is set in the LLD rule (also configurable).  Or you can glance in the Latest Data of the monitored host, in the Iostat section.  As soon as the values ‚Äã‚Äãappeared there, you can go to the graphs section and observe the first data. <br><br>  And finally, the top three screenshots of graphs c localhost))): <br>  Directly data in Latest Data: <br><img src="https://habrastorage.org/getpro/habr/post_images/316/788/ce5/316788ce54a67c4c12b08bedce211f7b.png" alt="image"><br><br>  Responsiveness Graphics (Latency): <br><img src="https://habrastorage.org/getpro/habr/post_images/f24/c17/f3d/f24c17f3db2a1535befd2439862c4a2f.png" alt="image"><br><br>  Recycling schedule and IOPS: <br><img src="https://habrastorage.org/getpro/habr/post_images/e1b/ac9/1eb/e1bac91ebc743d9581f1cc34fd41620e.png" alt="image"><br><br>  That's all, thank you for your attention. <br>  Well, according to tradition, I take this opportunity to convey greetings to Fedorov Sergey (Alekseevich) :) </div><p>Source: <a href="https://habr.com/ru/post/220073/">https://habr.com/ru/post/220073/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../220061/index.html">Print and play sound on paper</a></li>
<li><a href="../220065/index.html">Useful materials for mobile developer # 49 (April 14-20)</a></li>
<li><a href="../220067/index.html">Nike leaves the market of wearable technology?</a></li>
<li><a href="../220069/index.html">Micro tools: centralized logging and viewer of icon sets Fontello</a></li>
<li><a href="../220071/index.html">Will mini drones be recharged from power lines?</a></li>
<li><a href="../220075/index.html">Challenge from Richard Feynman</a></li>
<li><a href="../220077/index.html">Text recognition methods</a></li>
<li><a href="../220079/index.html">XSLT conversion of an internal table to ABAP with a generic reference type field</a></li>
<li><a href="../220081/index.html">Convenient development in Notepad ++</a></li>
<li><a href="../220083/index.html">Shit and sword</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>