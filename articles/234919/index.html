<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Synchronizer for the exchange of encrypted files between the CyberSafe program and cloud resources</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The CyberSafe cloud encryption feature allows you to automatically copy encrypted files to ‚Äúclouds‚Äù, such as Google Drive (this article discusses this...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Synchronizer for the exchange of encrypted files between the CyberSafe program and cloud resources</h1><div class="post__text post__text-html js-mediator-article">  The <a href="http://cybersafesoft.com/rus/">CyberSafe</a> cloud encryption <a href="http://cybersafesoft.com/rus/">feature</a> allows you to automatically copy encrypted files to ‚Äúclouds‚Äù, such as Google Drive (this article discusses this cloud resource) and any others.  At the same time, if several users simultaneously work with a cloud folder, <i>synchronization of encrypted files</i> on computers of each of them is implemented.  The general principles of working with the cloud encryption function were described <a href="http://habrahabr.ru/company/cybersafe/blog/229719/">here</a> , in this article we will focus on the work of the synchronizer itself. <br><br>  During its development, the technical problem was that when you synchronize files from the <i>Google Disk folder</i> on the user's computer with <i>Google web folder</i> in the cloud, the service information about the encrypted files recorded in ADS is not transmitted and is lost.  That is, files on other devices after synchronization are encrypted, but the user cannot decrypt them. <a name="habracut"></a><br><br>  To solve this problem, a variant was created with creating a <i>CyberSafe Cloud</i> folder, which is a <b>mirror</b> for the <i>Google Drive folder</i> .  In this folder, the user copies the new unencrypted files that are automatically encrypted by the <i>Alfa Transparent File Encryptor Driver</i> .  Service information for an encrypted file (encryption key identifier hash) of 4096 bytes in size is recorded in ADS and is available to the driver for work.  At the same time, encrypted files are sent to the <i>Google Drive folder</i> itself with the service information recorded in the file header, without using ADS, which allows you to save it when transferring to the "cloud". 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The mirror folder is created by CyberSafe automatically when you add a <i>Google Drive folder</i> to the program: <br><br><img src="https://habrastorage.org/files/ecc/a0e/598/ecca0e59833c47099358a9ba58df722c.jpg"><br><br>  The administrator of this folder is the first to add it to CyberSafe and assign the keys of other users, which are recorded in the form of a digital envelope in the ADS folder (for more details, see <a href="http://habrahabr.ru/company/cybersafe/blog/211012/">here</a> ).  In <i>the Google Drive folder, the</i> program creates a <b>cybersafe.cloud.conf</b> file.  This file contains information similar to the information in the ADS encrypted folder, namely: a symmetric encryption key, protected by the public keys of the authorized users, the ID of this key, a list of used certificates. <br><br>  <i>Cybersafe.cloud.conf</i> ‚Äútravels‚Äù on the Internet and extends to the computers of users who have access to an encrypted folder.  By adding the <i>Google Drive folder</i> to CyberSafe on their computers, users no longer assign keys ‚Äî information is overwritten in the ADS of this folder on their computers from <i>cybersafe.cloud.conf</i> . <br><br>  Now about how the synchronizer works.  The program has two separate processes <b>CloudSync.exe</b> and <b>loudSync2.exe</b> , which synchronize between the <i>CyberSafe mirror folder</i> and the <i>Google Drive folder</i> . <br><br>  <b>CloudSync.exe</b> copies encrypted files with service information placed in the header from the mirror folder to the Google Drive folder.  This process is added to the list of ‚Äúexcluded‚Äù for the encryption driver, which allows it to ‚Äúsee‚Äù the files in the mirrored folder encrypted and with service information in the header (the driver automatically displays information from ADS in the file header for such processes). <br><br>  The CloudSync.exe process does not have access to the ADS file separately. <br><br>  <b>loudSync2.exe</b> is a normal process that ‚Äúsees‚Äù files in the mirrored folder decrypted, has access to ADS, can copy files from the <i>Google Disk folder</i> to the mirror and then automatically encrypt the driver. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/712/34c/2a2/71234c2a2a6446b18358dba4c0d45139.jpg"></div><br><br>  In the process of file synchronization there are several options for the development of events: <br><br>  <b>1. A new file is copied to the Google Drive folder.</b>  It may already be encrypted, being copied there directly from the cloud as a result of actions performed on other users' computers, or not encrypted - the user himself copies the new unencrypted file to the Google Drive folder on his computer. <br><br>  The presence of the service header at the beginning of the file is checked. <br><br>  <b>1.1 If the header is, then we consider the file encrypted.</b>  Whether the file is encrypted or not is determined by the CloudSync.exe process.  For this, the first 4096 bytes of the file are analyzed for the presence of the ATE_HEADER header structure with the fields filled in: <br><br> <code>ATE_HEADER = Record</code> <br> <code>KeyIDLength, KeyXOR: DWORD;</code> <br> <code>Data: Array[1..ATE_KEY_ID_SIZE div sizeof(DWORD)] Of DWORD;</code> <br> <code>KeyIDLength2, KeyXOR2: DWORD;</code> <br> <code>Data2: Array[1..ATE_KEY_ID_SIZE div sizeof(DWORD)] Of DWORD;</code> <br> <code>Flags, Flags2: DWORD;</code> <br> <code>cData: Array[0..3575] Of AnsiChar;</code> <br> <code>End;</code> <br> <br>  The check function is encrypted file or not: <br><br> <code>function isFileHasRightHeader(FileName: string): Boolean;</code> <br> <code>var</code> <br> <code>HEADER: ATE_HEADER;</code> <br> <code>fs: TFileStream;</code> <br> <code>begin</code> <br> <code>Result := False;</code> <br> <code>try</code> <br> <code>fs := TFileStream.Create(FileName, fmOpenRead);</code> <br> <code>try</code> <br> <code>fs.Read(HEADER, SIZE_OF_ATE_HEADER);</code> <br> <code>Result := (HEADER.KeyIDLength = ATE_KEY_ID_SIZE) and (HEADER.KeyIDLength2 = ATE_KEY_ID_SIZE);</code> <br> <code>finally</code> <br> <code>fs.Free;</code> <br> <code>end;</code> <br> <code>except</code> <br> <code>on E: Exception do</code> <br> <code>WriteToLog('!!! isFileHasRightHeader: ' + E.Message + #13 + FileName);</code> <br> <code>end;</code> <br> <code>end;</code> <br> <br>  The CloudSync.exe process copies the first 4096 bytes to a temporary file with the .ads extension.  Next, it copies the rest of the file with the encrypted content into a temporary file.  Next, it stores the service information (header from the temporary file with the .ads extension) into the ADS temporary file (: AlfaFileEncryptor).  Next, it moves the temporary file to the mirror folder. <br><br>  <b>Another technical problem</b> : how to make sure that when copying the encrypted files from the Google Drive folder to the mirrored folder, they are not repeatedly encrypted by the driver?  The solution of this issue is displayed by the code, due to which the driver does not perform any actions with the file when the file is moved to the controlled encrypted folder and therefore the file is not re-encrypted: <br><br> <code>function TrimHeaderAndMoveFile(SyncIndex: Integer; FileNameFrom, FileNameTo: TFileName): Boolean;</code> <br> <code>// FileNameFrom -    "" </code> <br> <code>// FileNameTo -     </code> <br> <code>// PS FileNameFrom  FileNameTo    1- </code> <br> <code>var</code> <br> <code>fs, fs1: TFileStream;</code> <br> <code>fn: string;</code> <br> <code>begin</code> <br> <code>Result := False;</code> <br> <code>//    </code> <br> <code>fn := GetTempFileName(SyncIndex, FileNameFrom);</code> <br> <code>try</code> <br> <code>try</code> <br> <code>//      </code> <br> <code>fs := TFileStream.Create(FileNameFrom, fmOpenRead);</code> <br> <code>try</code> <br> <code>try</code> <br> <code>//      .ads    </code> <br> <code>fs1 := TFileStream.Create(fn + '.ads', fmCreate);</code> <br> <code>try</code> <br> <code>fs1.CopyFrom(fs, SIZE_OF_ATE_HEADER); // 4096 </code> <br> <code>finally</code> <br> <code>fs1.Free;</code> <br> <code>end;</code> <br> <code>except</code> <br> <code>on E: Exception do</code> <br> <code>WriteToLog('!!! TrimHeaderAndMoveFile: ' + E.Message + #13 + fn);</code> <br> <code>end;</code> <br> <br> <code>try</code> <br> <code>if fs.Size &gt; SIZE_OF_ATE_HEADER then //      </code> <br> <code>begin</code> <br> <code>fs1 := TFileStream.Create(fn, fmCreate);</code> <br> <code>try</code> <br> <code>fs1.CopyFrom(fs, fs.Size - SIZE_OF_ATE_HEADER); //         </code> <br> <code>finally</code> <br> <code>fs1.Free;</code> <br> <code>end;</code> <br> <code>end</code> <br> <code>else</code> <br> <code>begin</code> <br> <code>CreateEmptyFile(fn); //   ,     </code> <br> <code>end;</code> <br> <code>except</code> <br> <code>on E: Exception do</code> <br> <code>WriteToLog('!!! TrimHeaderAndMoveFile: ' + E.Message + #13 + fn);</code> <br> <code>end;</code> <br> <code>finally</code> <br> <code>fs.Free;</code> <br> <code>end;</code> <br> <code>WriteADS(fn, fn + '.ads', 'AlfaFileEncryptor'); //  ADS            .ads <br> DeleteFile(fn + '.ads'); //      .ads</code> <br> <br> <code>//           CloudSync2.exe</code> <br> <code>if RemoteIsFileExists(FileNameTo) then</code> <br> <code>begin</code> <br> <code>//          CloudSync2.exe</code> <br> <code>RemoteDeleteFile(FileNameTo);</code> <br> <code>end;</code> <br> <code>//      </code> <br> <code>RenameFile(fn, FileNameTo);</code> <br> <br> <code>Result := True;</code> <br> <code>except</code> <br> <code>end;</code> <br> <code>finally</code> <br> <code>if FileExists(fn) then</code> <br> <code>begin</code> <br> <code>try</code> <br> <code>DeleteFile(fn);</code> <br> <code>except</code> <br> <code>end;</code> <br> <code>end;</code> <br> <code>if FileExists(fn + '.ads') then</code> <br> <code>begin</code> <br> <code>try</code> <br> <code>DeleteFile(fn + '.ads');</code> <br> <code>except</code> <br> <code>end;</code> <br> <code>end;</code> <br> <code>end;</code> <br> <code>end;</code> <br> <br>  <b>1.2 If the header is not, consider the file is not encrypted.</b>  The CloudSync2.exe process copies the file to the mirror folder, after which it is automatically encrypted by the driver.  An unencrypted file is deleted from the Google Drive folder.  Further, the process CloudSync.exe copies the encrypted file to the <i>Google Drive folder</i> from the mirrored file, after which it is automatically sent to the ‚Äúcloud‚Äù and goes to other users. <br><br>  <b>2. The file is copied or edited in the CyberSafe mirror folder.</b> <br><br>  If a new file is copied by the user to the CyberSafe mirror folder, it is automatically encrypted by the driver.  When editing an existing file in a mirrored folder, it is saved to disk in an encrypted form also automatically.  Next, the encrypted file is sent by the CloudSync.exe process to the Google Drive folder with service information in the header and from there it goes to the ‚Äúcloud‚Äù. <br><br>  To properly synchronize and respond to changes to files in Google Drive and Mirror folders, the CloudSync.exe and CloudSync2.exe processes monitor the activity in these folders and perform the appropriate copy operations described above. </div><p>Source: <a href="https://habr.com/ru/post/234919/">https://habr.com/ru/post/234919/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../234907/index.html">Site analysis. Where to get the data?</a></li>
<li><a href="../234909/index.html">PostgreSQL 9.4 What's New?</a></li>
<li><a href="../234913/index.html">A new version of the distribution for the creation of a pfSense 2.1.5 firewall has been released.</a></li>
<li><a href="../234915/index.html">Samsung has introduced a new smart watch Gear S c OS Tizen and 3G-module</a></li>
<li><a href="../234917/index.html">Gentleman's Set for Amazon Kindle Paperwhite</a></li>
<li><a href="../234923/index.html">New Microsoft update KB2993651 can also cause BSOD</a></li>
<li><a href="../234927/index.html">Online universities, or our answer Coursera</a></li>
<li><a href="../234929/index.html">Experience in applying online courses at Computer Science Center</a></li>
<li><a href="../234931/index.html">Chrome: let personal remain personal</a></li>
<li><a href="../234933/index.html">The evolution of ATM skimmers</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>