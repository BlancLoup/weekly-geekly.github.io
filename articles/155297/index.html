<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Encode base64 on the fly and shoot MongoDB from JMeter with BeanShell</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I work in load testing for a relatively short time, and one of my main tools is Apache Jmeter . However, most of my colleagues did not use Beanshell i...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Encode base64 on the fly and shoot MongoDB from JMeter with BeanShell</h1><div class="post__text post__text-html js-mediator-article">  I work in load testing for a relatively short time, and one of my main tools is <a title="Apache jmeter" href="http://jmeter.apache.org/">Apache Jmeter</a> .  However, most of my colleagues did not use Beanshell in JMeter, and in this article I want to show a couple of ways how it can simplify and reduce the time for preparing for the tests themselves.  And I'll show it on the example of text conversion to base64-encoding and simple firing in MongoDB. <br><a name="habracut"></a><br><br><h2>  Foreword </h2><br>  This article is designed for those who already have some experience with JMeter, but did not use beanshell, so if you do not understand something, please do not hesitate to ask. <br><br><h2>  What is Beanshell and why is it needed? </h2><br>  JMeter is a opensource load testing tool written in Java.  It is easy to build your Samplers (objects that shoot) into it, but for this you need to open an IDE, inherit from the class from the JMeter packages, and write 4 methods.  Export jar.  And paste it.  And for good you need to make a beautiful wrapper for this all, with buttons, checkboxes and all-all-all. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Okay, so what are beanshell and why is it needed?  <a title="http://www.beanshell.org" href="http://www.beanshell.org/">Beanshell</a> is a java interpreter.  Using beanshell you can write java-code immediately in JMeter, which will be executed during the test. <br><br><h2>  Java?  Interpreter?  Load Testing?  This is a joke? </h2><br>  Using the interpreter, you should be aware of all the disadvantages and advantages of this approach.  The main disadvantage is the performance of the interpreter.  It will always be lower than the Sampler you compile.  Of the benefits - the speed of development.  You can always jot down a prototype of the sampler in beanshell, and when you‚Äôll run into its performance, throw all the logic into a full-fledged sampler. <br><br>  Moreover, in beanshell, you can write not only samplers, but pre-processors (perform actions before the shot), post-processors (perform actions after the shots) and listeners (receive reports on all shots of samplers / transactions). <br><br>  It all sounds great, but why do many people know about JMeter, but so little about the interpreter?  The whole problem in the documentation, namely its absence.  On the wiki there is only <a title="BeanShellSampler Reference" href="http://wiki.apache.org/jmeter/UserManual/Reference/BeanShellSampler">one page with a description</a> , and <a title="Escaped urls" href="http://wiki.apache.org/jmeter/EscapedURLs">one with an example</a> . <br><br><h2>  Base64 example </h2><br>  Imagine that we have two services that communicate with each other by transferring messages in base64 encoding.  Our task is to load one of these services.  We need to emit messages from one to another.  Of course, we can immediately accumulate a base64-encoded data pool, but working with it, we, the testers, will be very uncomfortable.  I would like to have a data pool in a meaningful, customary way for us, and that the information on the server is already in the necessary encoding.  Moreover, situations are possible when we do not even have a pool of data.  When the service itself gives us information, and we use it to send new requests. <br><br>  We have a service (http://base64.nomanlab.org/?key=base64_key), to which we must pass the value as a GET parameter.  I raised the service just for example.  During the publication of the article, it will work, you can play around, but sincerely I ask, do not kill it, load testers =) <br><br>  Let's first create our use-case test-plan.  We add Thread Group, and in it HTTP Request.  The test plan will look something like this. <br> <a href="http://fotki.yandex.ru/users/epihin-m/view/576419/"><img src="https://habrastorage.org/getpro/habr/post_images/21a/e5a/be8/21ae5abe8c04917a11664530921fe9c1.png" width="287" height="183"></a> <br><br>  The key (base64_key) is described separately, I used the User Defined Variables for an example and gave it the name key. <br> <a href="http://fotki.yandex.ru/users/epihin-m/view/576423/"><img src="https://habrastorage.org/getpro/habr/post_images/a7c/f85/276/a7cf8527684223b3ea5a6b44658272f5.png" width="500" height="56"></a> <br><br>  And the HTTP Request itself has this form. <br> <a href="http://fotki.yandex.ru/users/epihin-m/view/576418/"><img src="https://habrastorage.org/getpro/habr/post_images/a8a/3f0/ed5/a8a3f0ed5fd6743c0a2a49739b8aa6b7.png" width="500" height="133"></a> <br><br>  But it is necessary for us that <strong>before a shot</strong> with the data in the cartridge something happened.  Therefore, we select beanshell preprocessor and add it as a child to http request.  And in it we write java-code.  Java code?  But how will he be connected with our patron?  For this there are objects that link our test plan and the code in the interpreter. <br><br> <a href="http://fotki.yandex.ru/users/epihin-m/view/576424/"><img src="https://habrastorage.org/getpro/habr/post_images/930/511/f97/930511f97dd6a51b8809b8c6b9362bc8.png" width="377" height="36"></a> <br>  Now we are replacing the key variable, so we need access to it.  Its value for a given thread (thread) is stored in the vars object (which is something like a map). <br>  Java code: <br><pre><code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">//   ,      Apache JMeter import org.apache.commons.codec.binary.Base64; // ,   / Base64 magicBox = new Base64(); //   ,   String key = new String (magicBox.encodeBase64(vars.get("key").getBytes())); //      vars.put("key", key);</span></span></code> </pre> <br><br><br>  And here is the result: <br> <a href="http://fotki.yandex.ru/users/epihin-m/view/576446/"><img src="https://habrastorage.org/getpro/habr/post_images/cc3/4f0/f32/cc34f0f323a6965234ad2d6bec69d8c6.png" width="500" height="95"></a> <br><br>  Our key has been changed to a base64-encoded value.  If we receive a response from the service in base64, and it needs to be parsed, we first use the post-processor Regular Expression Extractor to remove the message, and then we go through it using the same BeanShell post-processor.  The code will be as follows: <br><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">//   ,      Apache JMeter import org.apache.commons.codec.binary.Base64; // ,   / Base64 magicBox = new Base64(); //   ,   String key = new String (magicBox.decodeBase64(vars.get("key").getBytes())); //      vars.put("key", key);</span></span></code> </pre><br><br><br><h2>  MongoDB Example </h2><br>  And now for the sake of what all came here.  Shooting in MongoDB.  It is possible to use a similar method for loading MongoDB only in extreme cases when it is necessary to shoot at slow requests in order to understand their limit in Mong. <br><br><h3>  Connection pool </h3><br>  To shoot we need an object through which we will do it.  We need an object with which we will manage the number of connections, their parameters.  And before shooting, these connections need to be established, so the poets will share the logic of shooting and making connections.  Installation will make in a separate ThreadGroup, which should start before the test.  For this reason, choose setUp Thread Group.  In it we set the options so that the semler is executed only 1 time and, of course, the BeanShell Sampler itself.  And in it the following code: <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.mongodb.DB; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.mongodb.Mongo; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.mongodb.MongoOptions; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.mongodb.ServerAddress; <span class="hljs-comment"><span class="hljs-comment">//bsh.shared      beanshell  bsh.shared.mongo = null; bsh.shared.mongoOptions = new MongoOptions(); bsh.shared.db = null; //    bsh.shared.mongoOptions.autoConnectRetry = true; bsh.shared.mongoOptions.connectionsPerHost = 50; bsh.shared.mongoOptions.socketKeepAlive = true; bsh.shared.mongoOptions.socketTimeout = 10000; // precise-mongodb-amd64    bsh.shared.mongo = new Mongo(new ServerAddress("precise-mongodb-amd64", 27017), bsh.shared.mongoOptions); //   test   bsh.shared.db = bsh.shared.mongo.getDB("test"); if(bsh.shared.db.getStats().ok() == false) { System.err.println("MongoDB Connection error"); }</span></span></code> </pre><br><br><br><h3>  Shoot !! </h3><br>  Now we have objects through which we can shoot, it remains to make a sampler, which will simply use them. <br>  The test plan looks like this: <br> <a href="http://fotki.yandex.ru/users/epihin-m/view/576449/"><img src="https://habrastorage.org/getpro/habr/post_images/2d7/bb5/248/2d7bb5248438b8882ae8a35cdc0d640e.png" width="277" height="187"></a> <br><br>  I just shot at checking the status (DB.getStats (). Ok ()), and rested not at BeanShell, but at 1 Mong kernel, which I gave it to KVM on the local laptop. <br>  Let's make a separate ThreadGroup and in it a BeanShell Sampler with this code: <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.mongodb.DB; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(bsh.shared.db.getStats().ok() == <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) { IsSuccess = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; }<span class="hljs-keyword"><span class="hljs-keyword">else</span></span> IsSuccess = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>;</code> </pre><br><br>  And of course, beautiful graphics that show our performance. <br> <a href="http://fotki.yandex.ru/users/epihin-m/view/576451/"><img src="https://habrastorage.org/getpro/habr/post_images/562/575/8d9/5625758d9839d295aca999acc26ba0ea.png" width="500" height="189"></a> <br><br> <a href="http://fotki.yandex.ru/users/epihin-m/view/576450/"><img src="https://habrastorage.org/getpro/habr/post_images/56a/ba9/169/56aba91699f2b9480b2afd064472f76e.png" width="500" height="189"></a> <br><br>  At the end, 1 failure is visible, but this is due to the fact that I manually completed the test. <br><br>  But with DB access, you can create a collection object (DBCollection) and play with it.  It is possible inserts, it is possible cunning, maybe something else.  You just need to know the <a href="http://api.mongodb.org/java/current/">Java API for MongoDB</a> . <br><br>  But in reality, to test Mongi, or any other database, it‚Äôs better to write your full-fledged sampler.  I just wanted to show how you can do without them. <br><br><h2>  Files </h2><br>  <a href="http://yadi.sk/d/Nq9VeaAs0GGFD">Download Base64 Test Plan</a> <br>  <a href="http://yadi.sk/d/zUTNWQKd0GNi3">Download a test plan with Monga</a> <br><br><br><h2>  Epilogue </h2><br>  Something like this, with simple actions, without getting into the IDE, you can do a lot of interesting things. <br></div><p>Source: <a href="https://habr.com/ru/post/155297/">https://habr.com/ru/post/155297/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../155283/index.html">Bob Dorf: How to work on a startup</a></li>
<li><a href="../155285/index.html">Convenient service for replacing images</a></li>
<li><a href="../155289/index.html">ELF - an application on your LG phone?</a></li>
<li><a href="../155291/index.html">Amazon Founder Calls on Governments to End Patent Wars</a></li>
<li><a href="../155295/index.html">Stages of censorship on the Internet 2007-2012</a></li>
<li><a href="../155299/index.html">Gmail can block your paid account for more than 24 hours</a></li>
<li><a href="../155301/index.html">Habrasorsing</a></li>
<li><a href="../155303/index.html">Group artificial intelligence for Oracle SQL XE stacker robots</a></li>
<li><a href="../155309/index.html">Google introduced Samsung Chromebook for 249 dollars</a></li>
<li><a href="../155317/index.html">Konstantin Kalinov, founder of Aviasales: we went to develop horizontally</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>