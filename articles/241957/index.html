<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Update timezone in logstash</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello! For a couple of months already, our company has successfully used in production a bundle of logstash-elasticsearch-kibana for collecting and pr...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Update timezone in logstash</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/d42/f39/846/d42f3984667a4e8ba268f9a0ff1f78f7.png" align="left">  Hello!  For a couple of months already, our company has successfully used in production a bundle of logstash-elasticsearch-kibana for collecting and processing a sufficiently large amount of logs.  Looking at the kibana after the transfer of the clock it was found that all the logs come with a time lag of 1 hour.  Under the cut I want to share a solution to the problem with timezones in a bunch of logstash-elasticsearch-kibana and the finished build of logstash with updated timezones. <br><a name="habracut"></a><br>  I will not particularly delve into how the change of timezone influenced the final view of the logs, but in fact in kibana we received events created at the current time as events an hour earlier.  It turned out quite a funny picture, given that not all rsyslogd restarted automatically and picked up the new timezone, a couple of servers continued to work on the old time zones. <br><br>  Of course, you can solve the problem with the logstash configuration crutch, but I decided to fully update the timezone in logstash. <br><img src="https://habrastorage.org/files/96d/245/555/96d245555a1142b286e43066e3a801bd.png" align="right"><br><br clear="left">  In <i>fig.</i>  <b>schedule of events</b> at the time of transition to logstash with the correct timezones. <br>  At Logstash, three sources of time zones are possible at once - one in <i>java</i> , the second in the <i>ruby tzinfo gem</i> , the third is compiled into <i>jruby</i> (the joda-time artifact and joda-timezones). <br><br><ol><li><h4>  Let's start with a simple one - update tzdata in java: </h4><br>  To do this, use the utility from Oracle <a href="http://www.oracle.com/us/technologies/java/tzupdater-readme-136440.html">tzupdater</a> , you can <a href="http://www.oracle.com/technetwork/java/javase/downloads/tzupdater-download-513681.html">download from the Oracle website</a> . 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The update takes place literally in one command: <br><br><pre><code class="bash hljs">java -jar tzupdater.jar -V tzupdater version 1.4.7-b01 JRE time zone data version: tzdata2014c Embedded time zone data version: tzdata2014g java -jar tzupdater.jar -u java -jar tzupdater.jar -V tzupdater version 1.4.7-b01 JRE time zone data version: tzdata2014g Embedded time zone data version: tzdata2014g</code> </pre> <br></li><li><h4>  Build jruby with new tzdata: </h4><br><ol><li>  First, let's collect the joda-time artifact with new timezones: <br>  Before building, install the maven and ant packages: <pre> <code class="bash hljs">apt-get install maven ant</code> </pre>  Download the latest available joda-timezones package, replace the tzdata version in it, and specify the more recent joda-time (2.5 dated October 3, 2014) in dependencies: <pre> <code class="bash hljs">mkdir joda-time <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> joda-time wget http://search.maven.org/remotecontent?filepath=org/jruby/joda-timezones/2013d/joda-timezones-2013d.pom -O pom.xml sed -i <span class="hljs-string"><span class="hljs-string">'s/2013d/2014g/'</span></span> pom.xml sed -i <span class="hljs-string"><span class="hljs-string">'s/&lt;version&gt;2.2/&lt;version&gt;2.5/'</span></span> pom.xml mvn package mvn instal</code> </pre>  Now, maven has received the current version of joda-timezones. </li><li>  Download the source version of jruby, which is used in logstash (for logstash 1.4, this is jruby-1.7.11): <pre> <code class="bash hljs">wget https://github.com/jruby/jruby/archive/1.7.11.tar.gz tar -xvf 1.7.11.tar.gz <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> jruby-1.7.11/</code> </pre>  Replace the artifact version in ./core/pom.xml: <pre> <code class="bash hljs">sed -i <span class="hljs-string"><span class="hljs-string">'s/&lt;tzdata.version&gt;2013d/&lt;tzdata.version&gt;2014g/'</span></span> ./core/pom.xml sed -i <span class="hljs-string"><span class="hljs-string">'s/&lt;tzdata.jar.version&gt;2013d/&lt;tzdata.jar.version&gt;2014g/'</span></span> ./core/pom.xml</code> </pre>  In ./pom.xml: <br><pre> <code class="bash hljs">sed -i <span class="hljs-string"><span class="hljs-string">'s/&lt;joda.time.version&gt;2.3/&lt;joda.time.version&gt;2.5/'</span></span> ./pom.xml</code> </pre>  Putting jruby: <pre> <code class="bash hljs">~/jruby-1.7.11<span class="hljs-comment"><span class="hljs-comment"># mvn -Pcomplete</span></span></code> </pre>  After the build, check which version of tz will be answered by jruby, at the same time we will compare the time with the real one (at the end I start the http-server, which would be more convenient to collect logstash): <pre> <code class="bash hljs">~/jruby-1.7.11<span class="hljs-comment"><span class="hljs-comment"># java -jar ./maven/jruby-complete/target/jruby-complete-1.7.11.jar -rrbconfig -e 'p RbConfig::CONFIG["tzdata.version"]' "2014g" ~/jruby-1.7.11# java -jar ./maven/jruby-complete/target/jruby-complete-1.7.11.jar -e 'p Time.now' 2014-10-29 14:58:07 +0500 ~/jruby-1.7.11# cd ./maven/jruby-complete/target/;python -m SimpleHTTPServer</span></span></code> </pre><br></li></ol></li><li><h4>  We collect logstash: </h4><br>  Download unpack: <br><pre> <code class="bash hljs">wget https://github.com/elasticsearch/logstash/archive/v1.4.2.tar.gz tar -xvf v1.4.2.tar.gz mv logstash-1.4.2 logstash-contrib;<span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> logstash-contrib</code> </pre>  Make changes: <pre> <code class="diff hljs">diff --git a/Makefile b/Makefile index 0ec3da1..7fcca1a 100644 --- a/Makefile +++ b/Makefile @@ -7,7 +7,7 @@ ELASTICSEARCH_VERSION=1.1.1 WITH_JRUBY=java -jar $(shell pwd)/$(JRUBY) -S JRUBY=vendor/jar/jruby-complete-$(JRUBY_VERSION).jar -JRUBY_URL=http://jruby.org.s3.amazonaws.com/downloads/$(JRUBY_VERSION)/jruby-complete-$(JRUBY_VERSION).jar +JRUBY_URL=http://127.0.0.1:8000/jruby-complete-$(JRUBY_VERSION).jar JRUBY_CMD=bin/logstash env java -jar $(JRUBY) ELASTICSEARCH_URL=http://download.elasticsearch.org/elasticsearch/elasticsearch diff --git a/logstash.gemspec b/logstash.gemspec index 4917d83..6ba8ae4 100644 --- a/logstash.gemspec +++ b/logstash.gemspec @@ -23,6 +23,7 @@ Gem::Specification.new do |gem| gem.add_runtime_dependency "stud" #(Apache 2.0 license) gem.add_runtime_dependency "clamp" # for command line args/flags (MIT license) gem.add_runtime_dependency "i18n", ["&gt;=0.6.6"] #(MIT license) + gem.add_runtime_dependency "tzinfo", ["&gt;=1.2.2"]#(MIT license) # Web dependencies gem.add_runtime_dependency "ftw", ["~&gt; 0.0.39"] #(Apache 2.0 license) diff --git a/tools/Gemfile.jruby-1.9.lock b/tools/Gemfile.jruby-1.9.lock index dc11fd5..41e4362 100644 --- a/tools/Gemfile.jruby-1.9.lock +++ b/tools/Gemfile.jruby-1.9.lock @@ -169,7 +165,7 @@ GEM http_parser.rb (~&gt; 0.5.0) json (~&gt; 1.8) simple_oauth (~&gt; 0.2.0) - tzinfo (1.1.0) + tzinfo (1.2.2) thread_safe (~&gt; 0.1) user_agent_parser (2.1.2) uuidtools (2.1.4)</code> </pre><br>  And run the assembly: <pre> <code class="bash hljs">make tarball</code> </pre><br>  Upon completion of the assembly we get ./build/logstash-1.4.2.tar.gz - ready logstash with updated tzdata! </li></ol><br><br>  PS All manipulations were done on ubuntu 14.04 with Oracle Java (TM) Development Kit (JDK) 7 installed (build 1.7.0_72-b14) <br><br>  The finished build of logstash 1.4.3 with updated timezone can be downloaded from <a href="https://yadi.sk/d/iYu3Y6AMcN3Vb">yandex-disk</a> or <a href="">mail.ru.</a> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/0a8/f92/77a/0a8f9277ae064ad89647e3cbc3546dae.jpg"></div></div><p>Source: <a href="https://habr.com/ru/post/241957/">https://habr.com/ru/post/241957/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../241943/index.html">Cohesion in Enterprise Applications</a></li>
<li><a href="../241947/index.html">Gikporn 5 or why open the chip</a></li>
<li><a href="../241949/index.html">[SetNet & Console Application] First steps. SetNet.Server. Part 1</a></li>
<li><a href="../241951/index.html">Online Advertising Roulette: Yandex.Direct, Google AdWords</a></li>
<li><a href="../241955/index.html">Bureaucracy bug tracker</a></li>
<li><a href="../241961/index.html">The power of attraction of IT companies to each other</a></li>
<li><a href="../241965/index.html">Effective management of personal files</a></li>
<li><a href="../241967/index.html">Correlation Analysis or Why Strange Correlations Exist</a></li>
<li><a href="../241975/index.html">Closing the entrepreneur: how to minimize the business</a></li>
<li><a href="../241979/index.html">SA 3009008 to disable SSL 3.0 in MS IE</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>