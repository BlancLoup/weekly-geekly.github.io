<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Creating a bot to participate in the AI ‚Äã‚Äãmini cup. GPU Experience</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Continuation of Article 1 and Article 2 . 


 Below the cut, I‚Äôll tell you about the author‚Äôs experience in using the GPU for calculations, including ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Creating a bot to participate in the AI ‚Äã‚Äãmini cup. GPU Experience</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://habrastorage.org/webt/0y/a5/cb/0ya5cbi1psai9jbzlfxhlhnzx4w.jpeg"></p><br><p>  Continuation of <a href="https://habr.com/post/417657/">Article 1</a> and <a href="https://habr.com/post/417657/">Article 2</a> . </p><br><p>  Below the cut, I‚Äôll tell you about the author‚Äôs experience in using the GPU for calculations, including as part of creating a bot to participate in the AI ‚Äã‚Äãmini cup.  But rather it is an <a href="https://ru.wikipedia.org/wiki/%25D0%25AD%25D1%2581%25D1%2581%25D0%25B5">essay</a> on the GPU. </p><br><p>  - Your name is magic ... <br>  - What's up, Joel? .. The magic goes away ... </p><a name="habracut"></a><br><p>  As a child, we talk about that age when they are still undergoing chemistry or are just beginning to pass, the author was fascinated by the burning reaction, it turned out that the parents did not hinder him and the Moscow wasteland near the house was occasionally lit up with flashes of various children's activities, rockets on homemade black gunpowder, on sugar-nitrate caramel and so on.  Two circumstances limited children's fantasies: the reaction of nitroglycerin decomposition in the home laboratory with a acid sizzling ceiling and a drive to the nursery of the police in an attempt to get chemical reagents at one of the defense enterprises scattered around the Aviamotornaya district. </p><br><p>  And then there was a physics school with computers yamaha msx, a programmable calculator MK at home and it was not up to chemistry.  The interests of the child shifted to computers.  And what the author lacked from the first acquaintance with a computer was a burning reaction, his programs smoldered, there was no such feeling of natural power.  It was possible to see the process of optimizing calculations in games, but at that time the author did not know how to replace sin () with a table of the values ‚Äã‚Äãof this function, there was no Internet ... </p><br><p>  So the feeling of joy from computing power, clean burning, the author was able to get used in the calculations of the GPU. </p><br><p>  On Habr√© there are several good articles about computing on the GPU.  There are also many examples on the Internet, so it was decided to simply write on Saturday morning about personal feelings and maybe push others towards mass parallelism. </p><br><p>  Let's start with simple forms.  Computing on the GPU supports several frameworks, but the most famous are NVIDIA CUDA and OpenCL.  We will take CUDA and immediately we will have to narrow down our set of programming languages ‚Äã‚Äãto C ++.  There are libraries for connecting to CUDA in other programming languages, for example, ALEA GPU in C #, but this is more likely a topic for a separate review article. </p><br><p>  It was not possible at the time to make a massive car with a jet engine, although some of its indicators are higher than that of an internal combustion engine, parallel computing is not always possible to apply in real-world problems.  The main application for parallel computing: we need a task containing some element of mass, multiplicity.  In our case of creating a bot, a neural network (many neurons, neural connections) and a population of bots (calculation of motion dynamics, collisions for each bot take some time, if the bots are 300-1000, then the CPU will surrender and you will see just slow corruption of your program, for example, long pauses between frames of visualization). </p><br><p>  The best variant of mass character is when each element of the computation does not depend on the result of computations on another element of the list, for example, the simple task of sorting an array already acquires all sorts of tricks, since the position of the number in the array depends on the other numbers and cannot be picked up at the <strong>parallel loop</strong> .  To simplify the wording even more: the first sign of a successful mass character is that if you do not need to change the position of an element in an array, you can freely perform calculations on it, take other elements for this, but do not move it.  Something like a fairy tale: do not change the order of the elements, otherwise the GPU will turn into a pumpkin. </p><br><p>  In modern programming languages, there are constructions capable of running in parallel on several CPU cores or logical threads and they are widely used, but the author focuses the reader‚Äôs attention on mass parallelism when the number of executing modules exceeds hundreds or thousands of units. </p><br><p>  The first elements of parallel structures appeared: a <strong>parallel loop</strong> .  For most tasks it will be enough.  In a broad sense, this is the <a href="https://ru.wikipedia.org/wiki/%25D0%259A%25D0%25B2%25D0%25B8%25D0%25BD%25D1%2582%25D1%258D%25D1%2581%25D1%2581%25D0%25B5%25D0%25BD%25D1%2586%25D0%25B8%25D1%258F">quintessence.</a> <br>  parallel computing. </p><br><p>  Example of recording the main loop in CUDA (kernel): </p><br><pre><code class="hljs perl"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> tid = blockIdx.x * blockDim.x + threadIdx.x; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> threadN = gridDim.x * blockDim.x; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">pos</span></span> = tid; <span class="hljs-keyword"><span class="hljs-keyword">pos</span></span> &lt; numElements; <span class="hljs-keyword"><span class="hljs-keyword">pos</span></span> += threadN) { <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>    <span class="hljs-keyword"><span class="hljs-keyword">pos</span></span>,     ,       thread     pos.  :    thread    ,  thread   <span class="hljs-keyword"><span class="hljs-keyword">pos</span></span>=<span class="hljs-number"><span class="hljs-number">1146</span></span>     thread c  <span class="hljs-keyword"><span class="hljs-keyword">pos</span></span>=<span class="hljs-number"><span class="hljs-number">956</span></span>.        .           . }</code> </pre> <br><p>  Much is written in the <a href="http://www.nvidia.ru/object/cuda_state_university_courses_new_ru.html">documentation and reviews to CUDA</a> , about GPU blocks, about Threads that are produced in these blocks, how to parallelize the task on them.  But if you have an array of data and it clearly consists of mass elements, use the above cycle form, since it visually looks like a normal cycle in form, which is pleasant, but unfortunately not in content. </p><br><p>  I think the reader is already becoming clear that the class of tasks in relation to mass parallel programming is rapidly narrowing.  If we are talking about the creation of games, 3d <a href="https://ru.wikipedia.org/wiki/%25D0%25A0%25D0%25B5%25D0%25BD%25D0%25B4%25D0%25B5%25D1%2580%25D0%25B8%25D0%25BD%25D0%25B3">rendering engines</a> , neural networks, video editing and other similar tasks, then the clearing for independent actions of the reader is heavily trampled, there are big programs, small programs, frameworks, libraries known and unknown for these tasks.  That is, the area remains just from the topic, to create your own small computing rocket, not SpaceX and Roscosmos, but something homely, but quite evil for yourself before calculations. </p><br><p><img src="https://habrastorage.org/webt/p6/f-/yt/p6f-ytvdsye66m74evqa0xisslc.png"></p><br><p>  Here is a picture of a rocket flame itself. </p><br><p>  Speaking of tasks that the parallel loop in your hands cannot solve.  And the creators of CUDA on behalf of NVIDIA developers have already thought about this. </p><br><p>  There is a Thrust library in some places useful until "without options" is done differently.  By the way, did not find its full review on Habr√©. </p><br><p>  To understand the principle of its work, you first need to say three sentences about the principles of work of CUDA.  If you need more words, then the link can be <a href="https://habr.com/post/54707/">read</a> . </p><br><p>  CUDA working principles: </p><br><p>  The computations are performed on the GPU programmatically which is the kernel (kernel) and you have to write it in the C language. The kernel in turn only communicates with the GPU memory and you have to load data into the video processor memory from the main program and unload it back into the program.  Sophisticated algorithms at CUDA require mental flexibility. </p><br><p>  So, the Thrust library removes the routine and takes on some of the ‚Äúdifficult‚Äù tasks for CUDA, such as summing up arrays or sorting them.  You no longer need to write a separate kernel, load pointers into memory, and copy data from these pointers to the GPU memory.  The whole mystery will happen in front of you in the main program and at a speed slightly lower than CUDA.  The Thrust library is written in CUDA, so this is a single berry field in terms of performance. </p><br><p>  What you need to do in Thrust is to create an array (thrust :: vector) within its library that is compatible with regular arrays (std :: vector).  That is, of course, not so simple, but the meaning of what was said by the author is similar to the truth.  Indeed, two arrays, one on the GPU (device), the other in the main program (host). </p><br><p>  An example will show the simplicity of the syntax (X, Y, Z arrays): </p><br><pre> <code class="hljs vhdl">// initialize X <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>, .... thrust::<span class="hljs-keyword"><span class="hljs-keyword">sequence</span></span>(X.<span class="hljs-keyword"><span class="hljs-keyword">begin</span></span>(), X.<span class="hljs-keyword"><span class="hljs-keyword">end</span></span>()); // compute Y = -X thrust::transform(X.<span class="hljs-keyword"><span class="hljs-keyword">begin</span></span>(), X.<span class="hljs-keyword"><span class="hljs-keyword">end</span></span>(), Y.<span class="hljs-keyword"><span class="hljs-keyword">begin</span></span>(), thrust::negate&lt;int&gt;()); // fill Z <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> twos thrust::fill(Z.<span class="hljs-keyword"><span class="hljs-keyword">begin</span></span>(), Z.<span class="hljs-keyword"><span class="hljs-keyword">end</span></span>(), <span class="hljs-number"><span class="hljs-number">2</span></span>); // compute Y = X <span class="hljs-keyword"><span class="hljs-keyword">mod</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> thrust::transform(X.<span class="hljs-keyword"><span class="hljs-keyword">begin</span></span>(), X.<span class="hljs-keyword"><span class="hljs-keyword">end</span></span>(), Z.<span class="hljs-keyword"><span class="hljs-keyword">begin</span></span>(), Y.<span class="hljs-keyword"><span class="hljs-keyword">begin</span></span>(), thrust::modulus&lt;int&gt;()); // replace <span class="hljs-keyword"><span class="hljs-keyword">all</span></span> the ones <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> Y <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> tens thrust::replace(Y.<span class="hljs-keyword"><span class="hljs-keyword">begin</span></span>(), Y.<span class="hljs-keyword"><span class="hljs-keyword">end</span></span>(), <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">10</span></span>);</code> </pre> <br><p>  You can see how it looks innocuously against the background of the creation of the CUDA core, and the set of functions in Thrust is <a href="https://docs.nvidia.com/cuda/thrust/">big</a> .  Starting from working with random variables, which is done in CUDA by a separate library cuRAND (it is desirable to run as a separate kernel), to sorting, summing and writing its functions in functionality close to the functions of the kernel. </p><br><p>  The author has little experience using CUDA and C ++, for two months.  Before that, about a year C #.  This, of course, slightly contradicts the beginning of an article about his early acquaintance with computers, physics and mathematics and applied mathematics as an education.  I say it happened.  But why am I writing this article, no, not that I learned it all, but that C ++ turned out to be a comfortable language (I used to be afraid of it, against the background of articles in a hambre like "lambda function ‚Üí overloading of internal operators, like redefine everything "), it is clear that the years of its development led to quite friendly development environments (IDE).  The language itself in its latest version, it seems as it collects garbage from memory, I don‚Äôt know how it was before.  At least, the programs written by the author on the most simple algorithmic constructions, drove computational algorithms for bots for days and there were no memory leaks and other failures under high loads.  This also applies to CUDA, at first it seems difficult, but it is based on simple principles and of course it is time-consuming to initialize arrays on the GPU if there are a lot of them, but then you will have your own little rocket, with a smoke from the video card. </p><br><p>  From classes of objects for training with a GPU, the author recommends <a href="https://ru.wikipedia.org/wiki/%25D0%259A%25D0%25BB%25D0%25B5%25D1%2582%25D0%25BE%25D1%2587%25D0%25BD%25D1%258B%25D0%25B9_%25D0%25B0%25D0%25B2%25D1%2582%25D0%25BE%25D0%25BC%25D0%25B0%25D1%2582">cellular automata</a> .  At one time there was an increase in popularity and fashion for them, but then neural networks intercepted the minds of developers. <br>  Up to: </p><br><p>  "Every quantity in physics, including time and space, is finite and discrete." <br>  than not a cellular automaton. </p><br><p>  But it's beautiful when three simple formulas can create this: </p><br><iframe width="560" height="315" src="https://www.youtube.com/embed/wNiBFQgrNp8" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><p>  If it is interesting to read about cellular automata on CUDA, write in the comments, there is a material for a small article typed. <br>  And this is the original source for cellular automata (under the video there are links to sources): </p><br><iframe width="560" height="315" src="https://www.youtube.com/embed/KJe9H6qS82I" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><p>  The idea to write an article after breakfast, in the same breath seems to me to have turned out.  Second coffee time.  Have a nice weekend reader. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/417757/">https://habr.com/ru/post/417757/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../417747/index.html">Re: "Comparison of JS frameworks: React, Vue and Hyperapp"</a></li>
<li><a href="../417749/index.html">Project Loon as a commercial project: the first contract is signed</a></li>
<li><a href="../417751/index.html">Kunstkamera: E-Meter ‚Äî The Scientology Thetan Device</a></li>
<li><a href="../417753/index.html">Compression of large arrays of prime numbers</a></li>
<li><a href="../417755/index.html">Study: 80% of ICO 2017 found to be fraudulent</a></li>
<li><a href="../417759/index.html">Be my rubber duck</a></li>
<li><a href="../417761/index.html">GitLab moves from Azure to the Google Cloud Platform. Moving news and maintenance dates</a></li>
<li><a href="../417763/index.html">MVIDroid: review of the new MVI library (Model-View-Intent)</a></li>
<li><a href="../417767/index.html">Text analysis using convolutional neural networks</a></li>
<li><a href="../417769/index.html">User Memory Design: How to Design Ages</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>