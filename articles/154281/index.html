<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Migrating from MDaemon to Exim + Dovecot</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I welcome you, residents of Habr. 

 Recently, a situation has arisen at work: it was necessary to raise a new mail server and transfer all current ac...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Migrating from MDaemon to Exim + Dovecot</h1><div class="post__text post__text-html js-mediator-article">  I welcome you, residents of Habr. <br><br>  Recently, a situation has arisen at work: it was necessary to raise a new mail server and transfer all current accounts and the structure of their mail folders from the old server to it.  This need arose for several reasons: <br><ol><li>  The number of accounts was limited to 250 accounts; </li><li>  Recently, the mail server began to constantly hang so that only a hard reset helped (at one time noticed that before this HDD was rather persistently used); </li></ol><br>  Here's what happened at that time (on the SuperMicro platform): <br><ul><li>  <b>PC:</b> Intel¬Æ Xeon¬Æ X3440 2.53GHz 2.53GHz CPU, 4GB RAM, 1TB HDD </li><li>  <b>OS:</b> Windows Server 2008 Enterprise Service Pack 2 </li><li>  <b>MTA:</b> Alt-N MDaemon (SMTP (S) / POP (S) / IMAP (S) server, SpamD, WorldClient) </li></ul><br>  About 240 accounts were used and the Users folder (all mail here) weighed about 200 GB. <br><br>  What happened (Dell PowerEdge 2850 platform) <br><ul><li>  <b>PC:</b> CPUx2 Intel¬Æ Xeon¬Æ E5430 2.66GHz 2.67GHz, 4GB RAM, 408GB HDD (RAID: 0) </li><li>  <b>OS:</b> FreeBSD 9.0 </li><li>  <b>MTA:</b> Exim + DoveCot + SpamAssassin </li></ul><br>  Well, now everything is in order. <a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <b>1. Installing FreeBSD, Exim, DoveCot, SpamAssassin</b> <br>  <b>1.1.</b>  <b>Installing FreeBSD</b> <br>  The choice fell on FreeBSD 9.0.  No problems with installation.  I downloaded an iso-image from ftp, cut it to disk and booted from it.  The installation process begins (sorry, that without the screenshots). <br><br>  We wait for a while, then a window appears to begin the installation of the system.  Click the Install button, select the keyboard layout, encoding, or just click No.  Next, select the components of interest for installation.  I left everything that was chosen, except for games (why do we need games on the server, Exim is also a good toy), added ports and continued on.  I made the disk layout manually, according to the following scheme: <br><br><pre><code class="hljs swift"># <span class="hljs-type"><span class="hljs-type">Device</span></span> <span class="hljs-type"><span class="hljs-type">Mountpoint</span></span> <span class="hljs-type"><span class="hljs-type">FStype</span></span> <span class="hljs-type"><span class="hljs-type">Size</span></span> /dev/mfid0p2 / ufs 20G /dev/mfid0p3 /<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ufs 50G /dev/mfid0p4 /home ufs 328G /dev/mfid0p5 <span class="hljs-keyword"><span class="hljs-keyword">none</span></span> <span class="hljs-built_in"><span class="hljs-built_in">swap</span></span> 4G</code> </pre> <br><br>  / Home contains all the maildir's. <br><br>  After marking we wait for the installation of the system, enter the password for root.  Next, configure the network, users and reboot (there is no need for a detailed description of the installation, since all this can be found on the Internet). <br><br>  After installation, respectively, setting up, installing any sudo, perl, etc. <br><br>  <b>1.2.</b>  <b>Install Exim</b> <br>  I‚Äôll focus on the Exim installation. <br>  To begin with, we will define the tasks and necessary conditions: <br><br>  1) Mailbox format - maildir; <br>  2) SMTP authorization; <br>  3) Support for SPF, DKIM (in the future, has not yet turned); <br>  4) quote support (for now only in appendfile, then dovecot quota plugin); <br>  5) MySQL support; <br>  6) SSL support. <br><br>  Start by installing MySQL 5.1. <br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"DEFAULT_MYSQL_VER=51"</span></span> &gt;&gt; /etc/make.conf <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /usr/ports/databases/mysql51-server make install clean <span class="hljs-comment"><span class="hljs-comment">#   Mysql mysql_install_db #   echo 'mysql_enable="YES"' &gt;&gt; /etc/rc.conf echo 'mysql_db_dir="/var/db/mysql"' &gt;&gt; /etc/rc.conf /usr/local/etc/rc.d/mysql start</span></span></code> </pre><br>  If everything went smoothly, the muscle will start, and it remains only to set the root password <br><pre> <code class="bash hljs">mysqladmin -u root password my_password</code> </pre><br>  Create a user for exim <br><pre> <code class="bash hljs">pw useradd exim -s /sbin/nologin -b /var/mail/mqueue -g mail</code> </pre><br>  Create a database: <br><pre> <code class="bash hljs">mysqladmin -u root -p create database exim_db</code> </pre><br>  DB structure: <br><pre> <code class="hljs sql"><span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> <span class="hljs-string"><span class="hljs-string">`accounts`</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-string"><span class="hljs-string">`accounts`</span></span> ( <span class="hljs-string"><span class="hljs-string">`login`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">128</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">COLLATE</span></span> utf8_bin <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-string"><span class="hljs-string">`password`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">128</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">COLLATE</span></span> utf8_bin <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-string"><span class="hljs-string">`uid`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-string"><span class="hljs-string">'1002'</span></span>, <span class="hljs-string"><span class="hljs-string">`gid`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-string"><span class="hljs-string">'6'</span></span>, <span class="hljs-string"><span class="hljs-string">`domain`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">128</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">COLLATE</span></span> utf8_bin <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-string"><span class="hljs-string">'domain.ru'</span></span>, <span class="hljs-string"><span class="hljs-string">`quota`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">16</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">COLLATE</span></span> utf8_bin <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-string"><span class="hljs-string">'250M'</span></span>, <span class="hljs-string"><span class="hljs-string">`status`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-string"><span class="hljs-string">'1'</span></span>, PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> (<span class="hljs-string"><span class="hljs-string">`login`</span></span>,<span class="hljs-string"><span class="hljs-string">`domain`</span></span>) ) <span class="hljs-keyword"><span class="hljs-keyword">ENGINE</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">InnoDB</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CHARSET</span></span>=utf8 <span class="hljs-keyword"><span class="hljs-keyword">COLLATE</span></span>=utf8_bin; <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> <span class="hljs-string"><span class="hljs-string">`aliases`</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-string"><span class="hljs-string">`aliases`</span></span> ( <span class="hljs-string"><span class="hljs-string">`address`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">128</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">COLLATE</span></span> utf8_bin <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`goto`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">128</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">COLLATE</span></span> utf8_bin <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`domain`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">128</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">COLLATE</span></span> utf8_bin <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-string"><span class="hljs-string">'domain.ru'</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">ENGINE</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">InnoDB</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CHARSET</span></span>=utf8 <span class="hljs-keyword"><span class="hljs-keyword">COLLATE</span></span>=utf8_bin; <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> <span class="hljs-string"><span class="hljs-string">`domains`</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-string"><span class="hljs-string">`domains`</span></span> ( <span class="hljs-string"><span class="hljs-string">`domain`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">128</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">COLLATE</span></span> utf8_bin <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-string"><span class="hljs-string">`status`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-string"><span class="hljs-string">'1'</span></span>, PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> (<span class="hljs-string"><span class="hljs-string">`domain`</span></span>) ) <span class="hljs-keyword"><span class="hljs-keyword">ENGINE</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">InnoDB</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CHARSET</span></span>=utf8 <span class="hljs-keyword"><span class="hljs-keyword">COLLATE</span></span>=utf8_bin;</code> </pre><br>  The uid and gid fields are the UID and GID of an Exim user in our system.  I turned out to be UID = 1002 and GID = 6.  For convenience, we make the table fields set by default with these values. <br>  Add Exim DB User <br><pre> <code class="bash hljs">mysql -u root -p Password: *** mysql&gt; grant all privileges on exim_newdb.* to exim@localhost identified by <span class="hljs-string"><span class="hljs-string">'exim_password'</span></span>; mysql&gt; \q</code> </pre><br>  Create a certificate for SSL connections: <br><pre> <code class="bash hljs">mkdir -p /etc/ssl/certs <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /etc/ssl/certs openssl req -x509 -newkey rsa:1024 -keyout favmail.pem -out favmail.pem -days 9999 -nodes</code> </pre><br>  We answer a bunch of questions, and the certificate is ready. <br>  Preliminary steps for installing Exim have been completed; now you can proceed with its installation and configuration. <br>  Install Exim: <br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /usr/ports/mail/exim make install clean</code> </pre><br>  Select the options that interest us and remove unnecessary ones.  I chose maildir, spf, dkim, mysql support.  We are waiting for the end of the installation.  Exim builds with a bunch of dependencies, but it doesn't take that long. <br>  Turn off sendmail <br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">'sendmail_enable="NONE"'</span></span> &gt;&gt; /etc/rc.conf /etc/rc.d/sendmail stop</code> </pre><br>  and rule /etc/mail/mailer.conf <br><pre> <code class="bash hljs">cat /etc/mail/mailer.conf <span class="hljs-comment"><span class="hljs-comment"># $FreeBSD: release/9.0.0/etc/mail/mailer.conf 93858 2002-04-05 04:25:14Z gshapiro $ # # Execute the "real" sendmail program, named /usr/libexec/sendmail/sendmail # sendmail /usr/local/sbin/exim send-mail /usr/local/sbin/exim mailq /usr/local/sbin/exim -bp newaliases /usr/local/sbin/exim -bi hoststat /usr/local/sbin/exim purgestat /usr/local/sbin/exim</span></span></code> </pre><br><br>  After installation, go to edit the config.  I set up a config for three different manuals, here are their sources: <br><ul><li>  <a href="">Installing an Exim-based mail server under FreeBSD</a> </li><li>  <a href="http://www.lissyara.su/articles/freebsd/mail/exim%2Bcourier-imap/">A bunch of exim and courier-imap</a> </li><li>  <a href="http://www.lissyara.su/articles/freebsd/mail/exim%2Bdovecot%2Bpostfixadmin/">A bunch of exim and dovecot with postfixadmin web interface</a> </li></ul><br>  Here's what happened: <br><pre> <code class="bash hljs">cat /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/etc/exim/configure primary_hostname = domain.ru hide mysql_servers = localhost/exim_db/exim/exim_password domainlist local_domains = <span class="hljs-variable"><span class="hljs-variable">${lookup mysql{select domain from domains where domain='${domain}</span></span><span class="hljs-string"><span class="hljs-string">'}} domainlist relay_to_domains = ${lookup mysql{select domain from domains where domain='</span></span><span class="hljs-variable"><span class="hljs-variable">${domain}</span></span><span class="hljs-string"><span class="hljs-string">'}} hostlist relay_from_hosts = localhost : 127.0.0.1 acl_smtp_rcpt = acl_check_rcpt acl_smtp_data = acl_check_data tls_certificate = /etc/ssl/certs/favmail.pem tls_privatekey = /etc/ssl/certs/favmail.pem daemon_smtp_ports = 25 : 465 tls_on_connect_ports = 465 qualify_domain = domain.ru allow_domain_literals = false exim_user = exim exim_group = mail never_users = root host_lookup = * rfc1413_hosts = * rfc1413_query_timeout = 5s ignore_bounce_errors_after = 2h timeout_frozen_after = 7d return_size_limit = 10K split_spool_directory = true syslog_timestamp = no begin acl acl_check_rcpt: acl_check_rcpt: accept hosts = : deny domains = +local_domains local_parts = ^[.] : ^.*[@%!/|] deny domains = !+local_domains local_parts = ^[./|] : ^.*[@%!] : ^.*/\\.\\./ accept senders=${lookup mysql{SELECT senders FROM whitelist \ WHERE senders='</span></span><span class="hljs-variable"><span class="hljs-variable">${quote_mysql:$sender_address}</span></span><span class="hljs-string"><span class="hljs-string">'}} deny message = HELO/EHLO required by SMTP RFC condition = ${if eq{$sender_helo_name}{}{yes}{no}} deny message = Go Away! You are spammer. condition = ${if match{$sender_host_name} \ {bezeqint\\.net|net\\.il|dialup|dsl|pool|peer|dhcp} \ {yes}{no}} deny message = rejected because $sender_host_address \ is in a black list at $dnslist_domain\n$dnslist_text hosts = !+relay_from_hosts !authenticated = * log_message = found in $dnslist_domain dnslists = bl.spamcop.net : \ cbl.abuseat.org : \ dnsbl.njabl.org : \ pbl.spamhaus.org warn set acl_m0 = 25s warn hosts = +relay_from_hosts set acl_m0 = 0s warn authenticated = * set acl_m0 = 0s warn logwrite = Delay $acl_m0 for $sender_host_name \ [$sender_host_address] with HELO=$sender_helo_name. Mail \ from $sender_address to $local_part@$domain. delay = $acl_m0 drop message = Rejected - Sender Verify Failed log_message = Rejected - Sender Verify Failed hosts = * !verify = sender/no_details/callout=2m,defer_ok !condition = ${if eq{$sender_verify_failure}{}} accept domains = +local_domains endpass message = unknown user verify = recipient accept domains = +relay_to_domains endpass message = unrouteable address verify = recipient accept hosts = +relay_from_hosts accept authenticated = * deny message = relay not permitted acl_check_data: warn message = X-Spam-Score: $spam_score ($spam_bar) hosts = !+relay_from_hosts spam = nobody:true warn message = X-Spam-Report: $spam_report hosts = !+relay_from_hosts spam = nobody:true warn message = Subject: [***SPAM***] $h_Subject: hosts = !+relay_from_hosts spam = nobody deny message = This message scored $spam_score spam points. spam = nobody:true hosts = !+relay_from_hosts condition = ${if &gt;{$spam_score_int}{120}{1}{0}} deny message = Blacklisted file extension detected ($mime_filename) condition = ${if match \ {${lc:$mime_filename}} \ {\N(\.exe|\.pif|\.bat|\.scr|\.lnk|\.com|\.vbs|\.cpl)$\N} \ {1}{0}} accept begin routers dnslookup: driver = dnslookup domains = ! +local_domains transport = remote_smtp ignore_target_hosts = 0.0.0.0 : 127.0.0.0/8 no_more system_aliases: driver = redirect allow_fail allow_defer data = ${lookup mysql{select goto from aliases where address='</span></span><span class="hljs-variable"><span class="hljs-variable">${quote_mysql:$local_part}</span></span><span class="hljs-string"><span class="hljs-string">' and domain='</span></span><span class="hljs-variable"><span class="hljs-variable">${quote_mysql:$domain}</span></span><span class="hljs-string"><span class="hljs-string">'}} user = exim group = mail file_transport = address_file pipe_transport = address_pipe userforward: driver = redirect check_local_user no_verify no_expn check_ancestor file_transport = address_file pipe_transport = address_pipe reply_transport = address_reply data = ${lookup mysql{select goto from aliases where address='</span></span><span class="hljs-variable"><span class="hljs-variable">${quote_mysql:$local_part}</span></span><span class="hljs-string"><span class="hljs-string">' and domain='</span></span><span class="hljs-variable"><span class="hljs-variable">${quote_mysql:$domain}</span></span><span class="hljs-string"><span class="hljs-string">'}} localuser: driver = accept domains = ${lookup mysql{select domain from domains where domain='</span></span><span class="hljs-variable"><span class="hljs-variable">${domain}</span></span><span class="hljs-string"><span class="hljs-string">'}} local_parts = ${lookup mysql{select login from accounts where login='</span></span><span class="hljs-variable"><span class="hljs-variable">${local_part}</span></span><span class="hljs-string"><span class="hljs-string">' and domain='</span></span><span class="hljs-variable"><span class="hljs-variable">${domain}</span></span><span class="hljs-string"><span class="hljs-string">'}} transport = local_delivery cannot_route_message = Unknown user begin transports remote_smtp: driver = smtp local_delivery: driver = appendfile maildir_format maildir_tag = ,S=$message_size directory = /home/mail/$domain/$local_part create_directory delivery_date_add envelope_to_add return_path_add group = mail mode = 0660 no_mode_fail_narrower address_pipe: driver = pipe return_output address_file: driver = appendfile delivery_date_add envelope_to_add return_path_add address_reply: driver = autoreply begin retry * * F,2h,15m; G,16h,1h,1.5; F,4d,6h begin rewrite begin authenticators auth_plain: driver = plaintext server_set_id = $2 server_prompts = : public_name = PLAIN server_condition = ${lookup mysql{select login from accounts where login='</span></span><span class="hljs-variable"><span class="hljs-variable">${quote_mysql:${local_part:$2}</span></span>}<span class="hljs-string"><span class="hljs-string">' and password='</span></span><span class="hljs-variable"><span class="hljs-variable">${quote_mysql:$3}</span></span><span class="hljs-string"><span class="hljs-string">'}{yes}{no}} auth_login: driver = plaintext public_name = LOGIN server_set_id = $1 server_prompts = Username:: : Password:: server_condition = ${lookup mysql{select login from accounts where login='</span></span><span class="hljs-variable"><span class="hljs-variable">${quote_mysql:${local_part:$1}</span></span>}<span class="hljs-string"><span class="hljs-string">' and password='</span></span><span class="hljs-variable"><span class="hljs-variable">${quote_mysql:$2}</span></span><span class="hljs-string"><span class="hljs-string">'}{yes}{no}} auth_cram_md5: driver = cram_md5 public_name = CRAM-MD5 server_secret = ${lookup mysql{select password from accounts where login='</span></span><span class="hljs-variable"><span class="hljs-variable">${quote_mysql:${local_part:$1}</span></span>}<span class="hljs-string"><span class="hljs-string">'}{$value}fail} server_set_id = $1</span></span></code> </pre><br>  Checking the config: <br><pre> <code class="bash hljs">exim -bV Exim version 4.77 <span class="hljs-comment"><span class="hljs-comment">#0 (FreeBSD 9.0) built 04-Jul-2012 19:16:56 Copyright (c) University of Cambridge, 1995 - 2007 Probably Berkeley DB version 1.8x (native mode) Support for: crypteq iconv() use_setclassresources PAM Perl Expand_dlfunc OpenSSL Content_Scanning DKIM Experimental_SPF Lookups (built-in): lsearch wildlsearch nwildlsearch iplsearch cdb dbm dbmnz dnsdb dsearch mysql nis nis0 passwd Authenticators: cram_md5 dovecot plaintext spa Routers: accept dnslookup ipliteral manualroute queryprogram redirect Transports: appendfile/maildir autoreply lmtp pipe smtp Fixed never_users: 0 Size of off_t: 8 Configuration file is /usr/local/etc/exim/configure</span></span></code> </pre><br>  OK, no error was detected.  Rotate the logs for exim: <br><pre> <code class="hljs perl">crontab -u exim -e @daily /usr/<span class="hljs-keyword"><span class="hljs-keyword">local</span></span>/exim/exicyclog</code> </pre><br>  We check the recognition of local users: <br><pre> <code class="bash hljs">exim -bt admin admin@domain.ru router = localuser, transport = local_delivery</code> </pre><br>  And non-local <br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">exim</span></span> -bt user<span class="hljs-variable"><span class="hljs-variable">@www</span></span>.com user<span class="hljs-variable"><span class="hljs-variable">@www</span></span>.com router = dnslookup, transport = remote_smtp host ASPMX.L.GOOGLE.com [<span class="hljs-number"><span class="hljs-number">173.194.71.27</span></span>] MX=<span class="hljs-number"><span class="hljs-number">10</span></span> host ALT2.ASPMX.L.GOOGLE.com [<span class="hljs-number"><span class="hljs-number">209.85.225.26</span></span>] MX=<span class="hljs-number"><span class="hljs-number">20</span></span> host ALT1.ASPMX.L.GOOGLE.com [<span class="hljs-number"><span class="hljs-number">173.194.77.26</span></span>] MX=<span class="hljs-number"><span class="hljs-number">20</span></span> host ASPMX4.GOOGLEMAIL.com [<span class="hljs-number"><span class="hljs-number">173.194.78.27</span></span>] MX=<span class="hljs-number"><span class="hljs-number">30</span></span> host ASPMX5.GOOGLEMAIL.com [<span class="hljs-number"><span class="hljs-number">74.125.130.27</span></span>] MX=<span class="hljs-number"><span class="hljs-number">30</span></span> host ASPMX3.GOOGLEMAIL.com [<span class="hljs-number"><span class="hljs-number">74.125.127.27</span></span>] MX=<span class="hljs-number"><span class="hljs-number">30</span></span> host ASPMX2.GOOGLEMAIL.com [<span class="hljs-number"><span class="hljs-number">173.194.69.27</span></span>] MX=<span class="hljs-number"><span class="hljs-number">30</span></span></code> </pre><br>  Great, you can run <br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">'exim_enable="YES"'</span></span> &gt;&gt; /etc/rc.conf /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/etc/rc.d/exim start</code> </pre><br>  Check Exim authorization.  How to do this is described in detail <a href="">here</a> . <br>  At this point you can finish exim configuration. <br>  <b>1.3.</b>  <b>Dovecot installation</b> <br>  We put dovecot also from ports <br><pre> <code class="hljs sql">cd /usr/ports/mail/dovecot make <span class="hljs-keyword"><span class="hljs-keyword">install</span></span> clean</code> </pre><br>  And customizable (also configured on the above links) <br><pre> <code class="bash hljs">cat /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/etc/dovecot.conf base_dir=/var/run/dovecot/ protocols=imap imaps pop3 pop3s ssl=yes ssl_cert_file=/etc/ssl/certs/favmail.pem ssl_key_file=/etc/ssl/certs/favmail.pem protocol imap { listen=*:143 ssl_listen=*:993 } protocol pop3 { listen=*:110 ssl_listen=*:995 } disable_plaintext_auth=no shutdown_clients=yes log_timestamp=<span class="hljs-string"><span class="hljs-string">"%b %d %H:%M:%S "</span></span> syslog_facility=mail login_dir=/var/run/dovecot/login login_chroot=yes login_user=dovecot login_process_size=64 login_process_per_connection=yes login_processes_count=3 login_max_processes_count=3 login_greeting=Dovecot ready login_log_format_elements=user=&lt;%u&gt; method=%m rip=%r lip=%l %c login_log_format=%$: %s first_valid_uid=1002 first_valid_gid=6 mail_access_groups=mail mail_debug=yes verbose_proctitle = yes mail_location=maildir:/home/mail/%d/%n protocol imap { imap_client_workarounds=delay-newmail outlook-idle netscape-eoh tb-extra-mailbox-sep } protocol pop3 { pop3_uidl_format=%08Xu%08Xv pop3_client_workarounds=outlook-no-nuls oe-ns-eoh } protocol lda { postmaster_address=admin@domain.ru auth_socket_path=/var/run/dovecot/auth-master } auth default { default_realm=domain.ru mechanisms=plain socket listen { master { path=/var/run/dovecot/auth-master mode=0600 user=exim } } passdb sql { args=/usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/etc/dovecot-sql.conf } userdb sql { args=/usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/etc/dovecot-sql.conf } user=root verbose=yes } plugin { } <span class="hljs-comment"><span class="hljs-comment">####################################### cat /usr/local/etc/dovecot-sql.conf driver=mysql connect=host=127.0.0.1 dbname=exim_db user=exim password=exim_password! default_pass_scheme=PLAIN password_query=select password from accounts where login='%n' and domain='%d' user_query=select uid, gid from accounts where login='%n' and domain='%d'</span></span></code> </pre><br>  Run the daemon: <br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">'dovecot_enable="YES"'</span></span> &gt;&gt; /etc/rc.conf /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/etc/rc.d/dovecot start</code> </pre><br>  Check POP (S), IMAP (S) telnet or any client.  If everything is OK, then you can finish the configuration of Dovecot. <br><br>  <b>1.4.</b>  <b>Install SpamAssassin and configure Exim for it</b> <br>  SpamAssassin can be installed in two ways: <br><br>  1) perl -MCPAN -e shell; <br>  2) From ports. <br><br>  I set out the ports.  SpamAssassin is a barley module, and installing it requires a bunch of dependencies from the same barley modules.  Install them: <br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /usr/ports/security/p5-Digest-MD5 make install clean <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /usr/ports/www/p5-HTML-Parser make install clean <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /usr/ports/dns/p5-Net-DNS make install clean <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /usr/ports/japanese/p5-Mail-SpamAssassin make install clean</code> </pre><br>  During the installation there will be a huge pile of issues related to the functionality of various modules. <br>  After installation, configure SpamAssassin.  Here I will give my local.cf, which I have been using for several years: <br><pre> <code class="bash hljs">cat /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/etc/mail/spamassassin/local.cf trusted_networks 192.168.2/24 required_score 5.0 report_safe 0 rewrite_header subject [***SPAM***] use_bayes 1 bayes_path /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/etc/mail/spamassassin/bayes/ bayes_file_mode 0666 bayes_min_spam_num 1 bayes_min_ham_num 1 bayes_learn_to_journal 1 skip_rbl_checks 0 bayes_auto_learn 0 ok_languages ru en ok_locales ru_en score BAYES_00 0.0001 0.0001 -6.0 -6.0 score BAYES_05 0.0001 0.0001 -3.0 -3.0 score BAYES_20 0.0001 0.0001 -1.0 -1.0 score BAYES_50 0.0001 0.0001 1.6 1.6 score BAYES_60 0.0001 0.0001 2.0 2.0 score BAYES_80 0.0001 0.0001 4.0 4.0 score BAYES_95 0.0001 0.0001 6.5 6.5 score BAYES_99 0.0001 0.0001 10.0 10.0 score RDNS_NONE 0.0001 0.0001 3.0 3.0 score SUBJ_FULL_OF_8BITS 0.00 score HTML_COMMENT_8BITS 0.01 score HEADER_8BITS 0.00 score TO_NO_USER 0.01 score FORGED_MUA_OUTLOOK 0.5 score X_AUTH_WARNING 0.01 score SUBJ_HAS_UNIQ_ID 9.99 score HTTP_USERNAME_USED 9.99 score FORGED_YAHOO_RCVD 9.99 score FORGED_JUNO_RCVD 16 score UNWANTED_LANGUAGE_BODY 1.02 score MLM 5.55 score RCVD_NUMERIC_HELO 4.95</code> </pre><br>  I transferred it from my old server to MDaemon, since  SpamD is a SpamAssassin stripped down to disgrace. <br>  Now we add a line to the Exim config to acl <br><pre> <code class="bash hljs">spamd_address = 127.0.0.1 783</code> </pre><br>  and in ACLs in the <i>acl_check_data</i> rule <br><pre> <code class="bash hljs">acl_check_data: <span class="hljs-comment"><span class="hljs-comment">#deny message = Virus found ($malware_name) #malware = * warn message = X-Spam-Score: $spam_score ($spam_bar) hosts = !+relay_from_hosts spam = nobody:true warn message = X-Spam-Report: $spam_report hosts = !+relay_from_hosts spam = nobody:true warn message = Subject: [***SPAM***] $h_Subject: hosts = !+relay_from_hosts spam = nobody deny message = This message scored $spam_score spam points. spam = nobody:true hosts = !+relay_from_hosts condition = ${if &gt;{$spam_score_int}{120}{1}{0}} accept</span></span></code> </pre><br>  Run spamd and restart exim <br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">'spamd_enable="YES"'</span></span> &gt;&gt; /etc/rc.conf /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/etc/rc.d/sa-spamd start /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/etc/rc.d/exim restart</code> </pre><br>  Is done.  Now we have a new mail server and you can do the migration of users <br><br>  <b>2. Migrate users from MDaemon to Exim</b> <b><br></b>  <b>2.1.</b>  <b>Accounts and Aliases</b> <br><br>  Mdaemon stores all user accounts in DAT files that are in his app directory.  In fact, this is a plain text file and it would be possible to parse it directly, but the same MDaemon can export the account to a CSV file.  So, we export all accounts using the menu command: Accounts-&gt; Export-&gt; Export accounts to a text file separated by commas (yes, a very long name for the menu. <s>And religion did not allow writing ‚ÄúExport to CSV‚Äù</s> ).  In the app directory, an Accounts.csv file will be created, so we need it. <br>  There are accounts, now aliases.  Here you have to take the dat file.  He is called Alias.dat.  We copy it and rule it to the state so that only aliases remain in it, and all comments are in the firebox. <br>  To parse these files and add uchetok to the Exim database, I wore a small script on Perl, here is its contents: <br><pre> <code class="perl hljs"><span class="hljs-keyword"><span class="hljs-keyword">use</span></span> strict; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> Digest::MD5 <span class="hljs-string"><span class="hljs-string">qw(md5_hex)</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> DBI; <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> $dsn=<span class="hljs-string"><span class="hljs-string">'DBI:mysql:exim_db:192.168.2.7'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> $db_user=<span class="hljs-string"><span class="hljs-string">'exim'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> $db_pass=<span class="hljs-string"><span class="hljs-string">'exim_password!'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> $dbh=DBI-&gt;<span class="hljs-keyword"><span class="hljs-keyword">connect</span></span>($dsn, $db_user, $db_pass) <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-keyword"><span class="hljs-keyword">die</span></span> <span class="hljs-string"><span class="hljs-string">"Cann\'t connect to DB\n"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> $acc_file=<span class="hljs-string"><span class="hljs-string">"c:\\Accounts.csv"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> $alias_file=<span class="hljs-string"><span class="hljs-string">"c:\\Alias.dat"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">open</span></span>(ACFILE, $acc_file); <span class="hljs-keyword"><span class="hljs-keyword">open</span></span>(ALIASFILE, $alias_file); <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> @line=&lt;ACFILE&gt;; <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> @alias=&lt;ALIASFILE&gt;; <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> @arr; <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> @arr1; <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> $login; <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> $password; <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> $mquota; <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> $mdir; <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> $sq <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">sub</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sql_query</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> ($query)=@_; <span class="hljs-comment"><span class="hljs-comment">#print $query."\n"; my $sth=$dbh-&gt;prepare($query); $sth-&gt;execute; $sth-&gt;finish; } print "Adding user accounts\n"; foreach my $s(@line) { @arr=split(/,/, $s); if ($arr[0] =~ m/Email/g) { next; } $login=$arr[0]; $password=$arr[5]; $login =~ s/\"//g; $login =~ s/\@domain.ru//; if($arr[17]&gt;0) { $mquota=$arr[17]/1000; } else { $mquota=0; } $sql=qq(INSERT INTO accounts(login, password, quota) VALUES("$login", $password, $mquota)); sql_query($sql); print $login." added OK\n"; } print "\nAdding aliases\n"; foreach my $s(@alias) { @arr1=split(/ /, $s); $arr1[2] =~ s/\n//; $arr1[0] =~ s/\@domain.ru//; $arr1[2] =~ s/\@domain.ru//; my $goto=$arr1[2]; my $address=$arr1[0]; #print $goto."\n"; $sql=qq(insert into aliases(address, goto) values('$address', '$goto')); sql_query($sql); print "Alias ".$address." =&gt; ".$goto." added OK\n"; }</span></span></code> </pre><br>  Well, almost everything.  It remains to drag mail users. <br><br>  <b>2.2.</b>  <b>Mailbox sync</b> <br>  To synchronize user boxes, I used the imapsync utility, which I was told about on LORa, when I raised the topic of migration there. <br>  We put imapsync from ports <br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /usr/ports/mail/imapsync make install clean</code> </pre><br>  Next, I wrote a couple of scripts, although it would be possible to do with one.  The first script generates a csv file for imapsync, and the second launches it.  Here are their contents. <br><pre> <code class="perl hljs"><span class="hljs-comment"><span class="hljs-comment"># Creating CSV file for imapsync # #!//usr/bin/perl use strict; use DBI; my $dsn="DBI:mysql:exim_db:localhost"; my $db_user="exim"; my $db_password="exim_password"; my $dbh=DBI-&gt;connect($dsn, $db_user, $db_password) or die "Cannt connect to DB"; my $f_csv="imap_users.csv"; open(CSV, "&gt;".$f_csv); my $sql="select login, password from accounts"; my $result=$dbh-&gt;prepare($sql); $result-&gt;execute; while ((my $login, my $password)=$result-&gt;fetchrow_array) { print CSV $login.";".$password.";".$login.";".$password."\n"; } print "File $f_csv is created\n"; close(CSV); $result-&gt;finish; #------------------------------------------------------------------- # imapsync #!/usr/bin/perl my $f_csv="imap_users.csv"; my $src="192.168.2.3"; my $dst="127.0.0.1"; open(CSV, $f_csv); while(&lt;CSV&gt;) { chomp; my ($u1, $p1, $u2, $p2)=split(";"); #print $p1."\n"; print "Sync user $u1\n"; my $r_sync=system("imapsync --debug --host1 $src --user1 $u1 --password1 $p1 --host2 $dst --user2 $u2 --password2 $p2"); } close(CSV);</span></span></code> </pre><br>  After the launch of the latter, we wait for a long, long, long time until all 200GB migrate from the old server to the new one. <br><br>  <b>3. Results</b> <br>  A few hours later, I just finished this article, was synchronized.  I checked several mailboxes with a variety of clients.  Changes are not noticed, everything as it was, remains.  All letters are in place.  The only drawback is that if you use POP3, then all the letters will be supposedly unread, but it does not matter. <br>  I hope this article will help someone.  If you have any questions, ask them in the comments. <br><br>  <b>Thanks for attention.</b> </div><p>Source: <a href="https://habr.com/ru/post/154281/">https://habr.com/ru/post/154281/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../154265/index.html">We connect fonts even faster</a></li>
<li><a href="../154267/index.html">$ 99 Pocket Cluster</a></li>
<li><a href="../154269/index.html">30 years with QNX: QNX demo diskette</a></li>
<li><a href="../154273/index.html">Gave a bribe? Catch the top ten. Analyzing the Bribr iPhone App</a></li>
<li><a href="../154275/index.html">IBM supercomputer models the development of the universe</a></li>
<li><a href="../154283/index.html">Thermoelectric charging for gadgets and for cooking</a></li>
<li><a href="../154285/index.html">Music Scape by Brian Eno for iPad</a></li>
<li><a href="../154287/index.html">Runetology (168): Shahar Weiser, founder of GetTaxi</a></li>
<li><a href="../154289/index.html">Mail for the domain. Top 10</a></li>
<li><a href="../154291/index.html">Be kind to programmers</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>