<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Development of MiniFilter driver</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I had a chance at work to face the task of controlling access and redirecting requests to the file system within certain processes. It was necessary t...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Development of MiniFilter driver</h1><div class="post__text post__text-html js-mediator-article">  I had a chance at work to face the task of controlling access and redirecting requests to the file system within certain processes.  It was necessary to implement a simple, easily configurable solution. <br><br>  I decided to develop a MiniFilter driver that can be configured using a text file. <br><br>  Consider what MiniFilter represents in general: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Filtering is carried out through the so-called Filter Manager, which comes with the Windows operating system, is activated only when loading mini filters.  Filter Manager connects directly to the file system stack.  Mini filters are registered for processing data on I / O operations using the Filter Manager function, thus obtaining indirect access to the file system.  After registration and start-up, the mini filter receives a set of data on I / O operations that were specified during configuration and, if necessary, can make changes to this data, thus affecting the operation of the file system. <br><br><a name="habracut"></a><br>  The following diagram shows a simplified view of how the Filter Manager functions. <br><img src="https://habrastorage.org/storage2/4bf/494/4d1/4bf4944d166f97ce7f5feb91aee2aa1f.png"><br>  More detailed theoretical information can be obtained on the MSDN website using the link at the end of the article.  Not bad enough all sorted out. <br><br>  We will move towards development and consider some basic structures that need to be filled. <br><br>  General global data. <br><pre><code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> _</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MINIFILTER</span></span></span><span class="hljs-class"> {</span></span> PDRIVER_OBJECT pDriverObject; PFLT_FILTER pFilter; } MINIFILTER, *PMINIFILTER; MINIFILTER fileManager;</code> </pre> <br><br>  In this structure, we will store the link to the object of our driver and the link to the filter instance.  I want to note that PFLT_FILTER uniquely identifies the mini filter and remains constant for the entire duration of the driver.  Used when activating or stopping the filtering process. <br><br>  Register filter <br><pre> <code class="cpp hljs">CONST FLT_REGISTRATION FilterRegistration = { <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>( FLT_REGISTRATION ), <span class="hljs-comment"><span class="hljs-comment">// Size FLT_REGISTRATION_VERSION, // Version 0, // Flags NULL, // Context Callbacks, // Operation callbacks FilterUnload, // FilterUnload FilterLoad, // InstanceSetup NULL, // InstanceQueryTeardown NULL, // InstanceTeardownStart NULL, // InstanceTeardownComplete NULL, // GenerateFileName NULL // NormalizeNameComponent };</span></span></code> </pre><br><br>  Here it is necessary to dwell on several fields: <br><ol><li>  Callbacks - a link to a structure that defines what and with what functions we are going to process. </li><li>  FilterUnload is the function that will be called when the filter is disabled. </li><li>  FilterLoad is a function that will be called when the filter is initialized. </li></ol><br><br>  Next, consider the structure of Callbacks: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> FLT_OPERATION_REGISTRATION Callbacks[] = { { IRP_MJ_CREATE, <span class="hljs-number"><span class="hljs-number">0</span></span>, PreFileOperationCallback, PostFileOperationCallback }, { IRP_MJ_OPERATION_END } };</code> </pre><br><br>  Here we indicate that we will intercept the CreateFile operation, also indicate the functions that will be called, respectively, before and after the operation on the file. <br><br>  Next, I provide the code for the functions that are called when the filter is initialized and disabled. <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">NTSTATUS </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">FilterLoad</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(IN PCFLT_RELATED_OBJECTS FltObjects, IN FLT_INSTANCE_SETUP_FLAGS Flags, IN DEVICE_TYPE VolumeDeviceType, IN FLT_FILESYSTEM_TYPE VolumeFilesystemType)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (VolumeDeviceType == FILE_DEVICE_NETWORK_FILE_SYSTEM) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> STATUS_FLT_DO_NOT_ATTACH; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> STATUS_SUCCESS; } <span class="hljs-function"><span class="hljs-function">NTSTATUS </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">FilterUnload</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( IN FLT_FILTER_UNLOAD_FLAGS Flags )</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> STATUS_SUCCESS; }</code> </pre><br><br>  I think the code does not need additional comments, since everything is fairly standard.  I note only that our driver will not work for the network. <br><br>  Now let's look at the driver initialization function: <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">NTSTATUS </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DriverEntry</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( IN PDRIVER_OBJECT theDriverObject, IN PUNICODE_STRING theRegistryPath )</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i; NTSTATUS status; PCHAR ConfigInfo; UNICODE_STRING test; DbgPrint(<span class="hljs-string"><span class="hljs-string">"MiniFilter: Started."</span></span>); <span class="hljs-comment"><span class="hljs-comment">// Register a dispatch function for (i = 0; i &lt; IRP_MJ_MAXIMUM_FUNCTION; i++) { theDriverObject-&gt;MajorFunction[i] = OnStubDispatch; } theDriverObject-&gt;DriverUnload = OnUnload; fileManager.pDriverObject = theDriverObject; status = FltRegisterFilter(theDriverObject, &amp;FilterRegistration, &amp;fileManager.pFilter); if (!NT_SUCCESS(status)) { DbgPrint("MiniFilter: Driver not started. ERROR FltRegisterFilter - %08x\n", status); return status; } ConfigInfo = ReadConfigurationFile(); if(ConfigInfo != NULL &amp;&amp; NT_SUCCESS(ParseConfigurationFile(ConfigInfo))) { ExFreePool(ConfigInfo); DbgPrint("MiniFilter: Configuration finished."); }else { if(ConfigInfo != NULL)ExFreePool(ConfigInfo); FltUnregisterFilter( fileManager.pFilter ); DbgPrint("MiniFilter: Driver configuration was failed. Driver not started."); return STATUS_DEVICE_CONFIGURATION_ERROR; } status = FltStartFiltering( fileManager.pFilter ); if (!NT_SUCCESS( status )) { FltUnregisterFilter( fileManager.pFilter ); FreeConfigInfo(); DbgPrint("MiniFilter: Driver not started. ERROR FltStartFiltering - %08x\n", status); return status; } DbgPrint("MiniFilter: Filter was started and configured."); return STATUS_SUCCESS; }</span></span></code> </pre><br>  Registration of the mini filter is done by calling the FltRegisterFilter function, to which we pass the FilterRegistration structure received at the input of theDriverObject, described earlier, and a link to the variable where the created instance of the filter fileManager.pFilter will be placed.  To start the filtering process, you need to call the FltStartFiltering function (fileManager.pFilter). <br><br>  Also note that the loading of the configuration file and its processing is performed by the following calls ConfigInfo = ReadConfigurationFile ();  and ParseConfigurationFile (ConfigInfo), respectively. <br><br>  Data from the configuration file is converted to the next set of structures. <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FILE_REDIRECT_RULE</span></span></span><span class="hljs-class"> {</span></span> UNICODE_STRING From; UNICODE_STRING To; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FILE_REDIRECT_RULE</span></span></span><span class="hljs-class"> *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NextRule</span></span></span><span class="hljs-class">;</span></span> }FileRedirectRule, *PFileRedirectRule; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PROCESS_CONFIGURATION_RULE</span></span></span><span class="hljs-class"> {</span></span> UNICODE_STRING ProcessName; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FILE_REDIRECT_RULE</span></span></span><span class="hljs-class"> *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Rule</span></span></span><span class="hljs-class">;</span></span> }; <span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CONFIGURATION_MAP</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PROCESS_CONFIGURATION_RULE</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ProcessRule</span></span></span><span class="hljs-class">;</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">REDIRECT_MAP</span></span></span><span class="hljs-class"> *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NextItem</span></span></span><span class="hljs-class">;</span></span> }ConfigurationMap ,*PConfigurationMap;</code> </pre><br><br>  The head structure is the CONFIGURATION_MAP, which stores a link to the description of the ProcessRule process, as well as a pointer to the next element.  In turn, PROCESS_CONFIGURATION_RULE stores a link to the process name and directly to the structure of I / O redirection rules, which, like REDIRECT_MAP, is a linked list. <br><br>  Consider the driver unloading function, it is quite simple: <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">VOID </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnUnload</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( IN PDRIVER_OBJECT DriverObject )</span></span></span><span class="hljs-function"> </span></span>{ FltUnregisterFilter(fileManager.pFilter); FreeConfigInfo(); DbgPrint(<span class="hljs-string"><span class="hljs-string">"MiniFilter: Unloaded"</span></span>); }</code> </pre><br><br>  Here we just remove the filter registration and release all our configuration structures. <br><br>  Now let's turn to the most interesting part, namely the function that redirects I / O operations.  Since we have a fairly simple driver, we will do this directly in the PreFileOperationCallback. <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">FLT_PREOP_CALLBACK_STATUS </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">PreFileOperationCallback</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( __inout PFLT_CALLBACK_DATA Data, __in PCFLT_RELATED_OBJECTS FltObjects, __deref_out_opt PVOID *CompletionContext )</span></span></span><span class="hljs-function"> </span></span>{ NTSTATUS status; PFILE_OBJECT FileObject; PFileRedirectRule redirectRuleItem; PFLT_FILE_NAME_INFORMATION pFileNameInformation; PConfigurationMap rule; UNICODE_STRING fullPath; UNICODE_STRING processName; PWCHAR Volume; FLT_PREOP_CALLBACK_STATUS returnStatus = FLT_PREOP_SUCCESS_NO_CALLBACK; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(FLT_IS_FS_FILTER_OPERATION(Data)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> FLT_PREOP_SUCCESS_NO_CALLBACK; }</code> </pre><br><br>  We define the main variables, and also check whether we have already received something filtered, and if so, then this operation should be skipped, otherwise we can get a recursion of calls, which may entail a BSOD. <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (FltObjects-&gt;FileObject != <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> &amp;&amp; Data != <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) { FileObject = Data-&gt;Iopb-&gt;TargetFileObject; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(FileObject != <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> &amp;&amp; Data-&gt;Iopb-&gt;MajorFunction == IRP_MJ_CREATE) {</code> </pre><br><br>  Here we refer to the data structures obtained from FilterManager.  PFLT_CALLBACK_DATA structure - stores data on the current I / O operation, the FilterManager is guided by the fields of this structure when accessing the file system.  Accordingly, if we want to change the behavior of Windows when accessing files or directories, we need to reflect this in PFLT_CALLBACK_DATA.  More specifically, we are interested in the Data-&gt; Iopb-&gt; TargetFileObject field, using it we can get the path to the file in the current section and later change it if necessary, thus changing the behavior of the OS.  PCFLT_RELATED_OBJECTS - contains objects associated with this input / output operation, such as a link to a file, a section, and so on.  Let us verify that the elements of the structure we need are filled.  Also check that the function in the context of which we are running is really MJ_CREATE. <br><br><pre> <code class="cpp hljs">processName.Length = <span class="hljs-number"><span class="hljs-number">0</span></span>; processName.MaximumLength = NTSTRSAFE_UNICODE_STRING_MAX_CCH * <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(WCHAR); processName.Buffer = ExAllocatePoolWithTag(NonPagedPool, processName.MaximumLength,CURRENT_PROCESS_TAG); RtlZeroMemory(processName.Buffer, processName.MaximumLength); status = GetProcessImageName(&amp;processName);</code> </pre><br><br>  In this section of code, we allocate memory for the path and process name.  I can not imagine what size the string will be, so we select the maximum possible WCHAR string.  I will not consider the source code for GetProcessImageName, I will only say that it returns the full path to the file in the following form: \ Device \ HarddiskVolume4 \ Windows \ notepad.exe.  Ie section, well, actually, the path to the file. <br><pre> <code class="cpp hljs"> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(NT_SUCCESS(status)) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(LoggingEnabled()== <span class="hljs-number"><span class="hljs-number">1</span></span>) { DbgPrint(<span class="hljs-string"><span class="hljs-string">"MiniFilter: Process: %ws"</span></span>, processName.Buffer); } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> FLT_PREOP_SUCCESS_NO_CALLBACK; } rule = FindRuleByProcessName(&amp;processName,GetRedirectionMap());</code> </pre><br><br>  The FindRuleByProcessName function, if successful, returns the first element of the linked list containing the redirection rules for the current process, otherwise NULL. <br><br><pre> <code class="cpp hljs">ExFreePool(processName.Buffer); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(rule != <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>){ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(LoggingEnabled() == <span class="hljs-number"><span class="hljs-number">1</span></span>) { DbgPrint(<span class="hljs-string"><span class="hljs-string">"MiniFilter: File name %ws"</span></span>, FileObject-&gt;FileName.Buffer); } redirectRuleItem = rule-&gt;ProcessRule.Rule;</code> </pre><br>  We release unnecessary memory and check that we have received some object, but not NULL.  redirectRuleItem = rule-&gt; ProcessRule.Rule - call to the first rule for this process. <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(redirectRuleItem) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(RtlCompareUnicodeString(&amp;FileObject-&gt;FileName ,&amp;redirectRuleItem-&gt;From, FALSE) == <span class="hljs-number"><span class="hljs-number">0</span></span>) { status = FltGetFileNameInformation( Data, FLT_FILE_NAME_NORMALIZED | FLT_FILE_NAME_QUERY_ALWAYS_ALLOW_CACHE_LOOKUP, &amp;pFileNameInformation );</code> </pre><br>  We start the pass by all the rules for this process, compare the link to the current file with what we have in the configuration.  If it coincides, we try to get additional information about the file, for example, to which section it belongs.  To do this, use the FltGetFileNameInformation function. <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(NT_SUCCESS(status)) { fullPath.Length = <span class="hljs-number"><span class="hljs-number">0</span></span>; fullPath.MaximumLength = NTSTRSAFE_UNICODE_STRING_MAX_CCH * <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(WCHAR); fullPath.Buffer = ExAllocatePoolWithTag(NonPagedPool, fullPath.MaximumLength, FULL_PATH_TAG); RtlZeroMemory(fullPath.Buffer, fullPath.MaximumLength); Volume = wcssplt(pFileNameInformation-&gt;Volume.Buffer, redirectRuleItem-&gt;From.Buffer ); RtlAppendUnicodeToString(&amp;fullPath, Volume); RtlAppendUnicodeToString(&amp;fullPath, redirectRuleItem-&gt;To.Buffer); ExFreePool(Volume); ExFreePool(FileObject-&gt;FileName.Buffer);</code> </pre><br><br>  If everything is ok, we try to select a section, after which we form the final line.  Final Path = Current Section + Where to send an I / O request. <br><pre> <code class="cpp hljs"> FileObject-&gt;FileName.Length = fullPath.Length; FileObject-&gt;FileName.MaximumLength = fullPath.MaximumLength; FileObject-&gt;FileName.Buffer = fullPath.Buffer; Data-&gt;Iopb-&gt;TargetFileObject-&gt;RelatedFileObject = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; Data-&gt;IoStatus.Information = IO_REPARSE; Data-&gt;IoStatus.Status = STATUS_REPARSE; DbgPrint(<span class="hljs-string"><span class="hljs-string">"MiniFilter: Redirect done %ws"</span></span>, fullPath.Buffer); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> FLT_PREOP_COMPLETE;</code> </pre><br>  Next, we configure the system structures so that the File Manager processes the request once again, but only now in a different way.  For this, it is important to set the following values ‚Äã‚Äãfor the Data-&gt; IoStatus.Information = IO_REPARSE and Data-&gt; IoStatus.Status = STATUS_REPARSE; fields, as well as specify the new path to the FileObject-&gt; FileName.Buffer = fullPath.Buffer ;.  As a result of the function, we return FLT_PROP_COMPLETE. <br><br><pre> <code class="cpp hljs"> } } redirectRuleItem = redirectRuleItem-&gt;NextRule; } } } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> FLT_PREOP_SUCCESS_NO_CALLBACK; }</code> </pre><br>  Do not forget to go to the next item in the list of redirects.  FLT_PREOP_SUCCESS_NO_CALLBACK is returned if you do nothing with the current Filter Manger operation. <br><br>  At the moment, redefinition of I / O works only within one section, as soon as I debug the version with support for several sections, I‚Äôll post. <br><br>  It is necessary to install a mini filter using a specially designed inf file, an example which you will find in the source code for this article. <br><br>  The configuration file is as follows: <br><pre> <code class="vala hljs"><span class="hljs-meta"><span class="hljs-meta">#minifilter config start { #logging : off #process : \Device\HarddiskVolume4\Windows\notepad.exe { #rule : redirect { #from : \test.txt #to : \data\test.txt } #rule : redirect { #from : \ioman.log #to : \IRCCL.ini } } }</span></span></code> </pre><br>  The file must be located in the root of drive C, the name must be: minifilter.conf. <br><br>  So we have the ability to redirect file I / O requests, however, in addition to, say, implementing a mechanism to deny access to a file is quite simple.  It is necessary to select the file, access to which should be denied and specify the following value for the field of the system structure Data-&gt; IoStatus.Status = STATUS_ACCESS_DENIED ;.  Remember to return FLT_PROP_COMPLETE as the result of a function. <br><br>  To start or stop the service I use KMD Manager.  For the analysis of memory leaks PoolTag.  As for debugging, you can use DbgView, however, for Windows Vista and higher, debugging messages need to be activated, for this you need to create a DWORD key in the registry using the following path HKEY_LOCAL_MACHINE \ SYSTEM \ CurrentControlSet \ Control \ Session Manager \ Debug Print Filter with the name DEFAULT and value eight. <br><br>  To run the driver in the 64-bit version of Windows 7, you will need to disable driver signature verification, to do this, restart the computer, press F8 at system start and select Disable Driver Signature Enforcement, or use the Driver Signature Enforcement Overrider (DSEO) utility.  This utility will allow you to activate the test debug mode of the drivers and sign the necessary driver with a fake certificate, which ultimately will allow using it without any problems. <br><br>  Regardless of whether logging is enabled or not, after starting the service in DbgView you should observe something similar. <br><img src="https://habrastorage.org/storage2/bc1/6ec/6fe/bc16ec6fe7555c05e0bfb2941029f977.png"><br><br>  And so our driver will look like in DeviceTree <br><img src="https://habrastorage.org/storage2/e8a/4df/315/e8a4df3154dc55e4f5e68ef645ef7e36.png"><br><br>  I can add that the code is still quite raw and needs some work, but in general it functions normally.  Actually, if you have a BSOD, I'm not guilty).  Tested only on Windows 7 X86 and Windows 7 IA64. <br><br>  Link to source codes and utilities: <a href="">publish.rar</a> <br><br>  <b>What to read:</b> <br><ol><li>  <a href="http://msdn.microsoft.com/ru-RU/library/windows/hardware/ff540402%2528v%3Dvs.85%2529.aspx">MSDN Documentation</a> </li><li>  <a href="http://fsfilters.blogspot.ru/">File Systems and Filters Blog</a> </li></ol><br><br>  Ps.  I want to note that I am not a professional in system programming, so this article does not pretend to be complete.  By the nature of my business I am engaged in development under Microsoft Dynamics CRM (.net, asp.net, etc.). <br><br>  I will be glad to your comments. <br><br></div><p>Source: <a href="https://habr.com/ru/post/176739/">https://habr.com/ru/post/176739/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../176721/index.html">EasyMapping, or JSON Journey</a></li>
<li><a href="../176723/index.html">Google will change the appearance of search results for Europe, "give odds" to competitive services</a></li>
<li><a href="../176725/index.html">Work in PHP with Tokenizer</a></li>
<li><a href="../176727/index.html">Railway physics engine</a></li>
<li><a href="../176735/index.html">Creating and storing database backup</a></li>
<li><a href="../176741/index.html">Finding the fundamental matrix "for dummies"</a></li>
<li><a href="../176749/index.html">Programmatic placement of coefficients in chemical equations</a></li>
<li><a href="../176751/index.html">Nontrivial task with callback + DID in Asterisk</a></li>
<li><a href="../176759/index.html">Small storage for small files</a></li>
<li><a href="../176763/index.html">Class methods in ruby</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>