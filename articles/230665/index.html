<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚Äú65K methods will be enough for everyone‚Äù or how to deal with the limit of DEX methods in Android</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This happened suddenly. You just wrote the code for your Android application, you liked it, and you enjoyed the process. You have added a cool library...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>‚Äú65K methods will be enough for everyone‚Äù or how to deal with the limit of DEX methods in Android</h1><div class="post__text post__text-html js-mediator-article"> This happened suddenly.  You just wrote the code for your Android application, you liked it, and you enjoyed the process.  You have added a cool library to get additional features and write simpler code.  But instead of a working application at the output, you get a terrifying inscription: <br><br> <code>Unable to execute dex: method ID not in [0, 0xffff]: 65536</code> <br> <code>Conversion to Dalvik format failed: Unable to execute dex: method ID not in [0, 0xffff]: 65536</code> <br> <br>  And you are in a stupor, you are unable to create a DEX file for an APK.  You have no idea what this is and how to fix it.  And whatever you do, it will lead you to the most logical state: <b>PANIC</b> . <br><a name="habracut"></a><br><h4>  Meet the enemy </h4><br>  After you have tried all your usual tricks (in the following order: cleaning the project, restarting the IDE, building through the command line, rebooting the laptop, calling a friend, and even a ten-minute break in the hope that the problem will disappear by itself), you have to admit the cruel truth : the problem is still here.  Therefore, it would be nice to know what caused it. <br><br>  There are many posts on the Internet about this problem: <a href="http://stackoverflow.com/questions/15209831/unable-to-execute-dex-method-id-not-in-0-0xffff-65536">here is one of them</a> , <a href="http://stackoverflow.com/questions/15508477/android-my-application-is-too-large-and-gives-unable-to-execute-dex-method-id">one more</a> , <a href="http://stackoverflow.com/questions/15436956/how-to-solve-the-issue-with-dalvik-compiler-limitation-on-64k-methods">and one more</a> ;  Oh, and <a href="http://android-developers.blogspot.in/2011/07/custom-class-loading-in-dalvik.html">this</a> and <a href="https://github.com/mmin18/Dex65536">this, too</a> .  So what happened?  Essentially, it looks like you are faced with something that is often (and mistakenly) called Dalvik 65K methods limit.  Briefly (thanks <a href="http://stackoverflow.com/a/21492160/1367571">fadden</a> ): 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <i>You can refer to a very large number of methods in the DEX file, but you can only call the first 65536, because this is all the memory you have for the method call instruction.</i> <br>  <i>[...] the number of methods you can refer to is limited, and not the number of methods you define.</i>  <i>In other words, if your DEX file contains only a few methods, but together they call 70,000 different externally-defined methods, you will exceed the limit.</i> <br><br>  What we have?  Your application has too many methods written by you or enclosed in library JAR files.  For this reason, the dx tool cannot write the addresses of some methods simply because they do not fit into the field defined for this in the DEX file (which in turn contains the compiled Java classes).  And that is why the problem should be called DEX 65K methods limit. <br><br>  And yes, you understood everything correctly.  This problem will not disappear even when the android switches to a new ART runtime, until Google decides to ‚Äúfix‚Äù the DEX format or replace it with something else. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/e95/733/029/e95733029c943e85f20e686cca5aa6ce.jpg"><br><br><h4>  Let's count </h4><br>  You are probably surprised how you managed to bury more than 65,000 methods in your precious APK.  Or maybe not.  In any case, there must be a way to count these methods and determine their source. <br><br>  The DEX file header already contains information on the number of method references (for clarity, this number represents unique method references, not the sum of calls for each method).  But we also want to see which package adds an inordinate number of these methods. <br><br>  The best tool I found was made by <a href="http://stackoverflow.com/users/343108/mihai-parparita">Mihai Parparita</a> , who wrote a simple bash script called <a href="https://github.com/mihaip/dex-method-counts">dex-method-counts</a> .  The script is very smart and on output gives XML, which matches the name of the package with the number of its methods.  Another solution belongs to Jake Wharton, it gives the exact same result, but it takes much longer because of its recursive nature (Jake also wrote an <a href="http://jakewharton.com/play-services-is-a-monolith/">interesting article</a> on this topic). <br><br>  Now we have a good tool in our hands, so why don't we test it on a small test application?  Let's call it SampleApp.  Here is the code that is contained in our simple Activity: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> com.whyme.example; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> android.app.Activity; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> android.os.Bundle; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SampleActivity</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Activity</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onCreate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Bundle savedInstanceState)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.onCreate(savedInstanceState); dummyMethod(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">dummyMethod</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ System.out.println(‚ÄúOh gosh.‚Äù); } }</code> </pre><br><br>  I also included Google Play Services 5.0.77 in the app, although I don‚Äôt use this library at all.  The meaning of my act is clarified in several lines below.  Now, let's analyze the dex-method-counts output (compressed, for simplicity): <br><br><pre> <code class="bash hljs">Read <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> 20332 method IDs. &lt;root&gt;: 20332 : 2 android: 834 [‚Ä¶] com: 18802 google: 18788 [‚Ä¶] whyme: 14 example: 14 dalvik: 2 system: 2 java: 624 [‚Ä¶] javax: 5 [‚Ä¶] org: 63 apache: 24 [‚Ä¶] json: 39</code> </pre><br><br>  Wait.  WHAT?  I just defined one method in my Activity and already have 20,000 methods in my DEX file? <br><br><img src="https://habrastorage.org/getpro/habr/post_images/32b/019/c8f/32b019c8f0cdd0508c63b82ce0ee0076.gif"><br><br>  The culprit is obvious. <br><br><h4>  Google Play Services: mixed feelings </h4><br>  There is a non-zero probability that you are familiar with <a href="https://developer.android.com/google/play-services/index.html">Google Play Services</a> .  Google‚Äôs smart move to support the API of many of its services, up to Android 2.3 Gingerbread, with a new release every six weeks. <br><br>  However, everything has its price, which in this case was in the form of a HUGE number of methods that Play Services carries in itself.  We are talking about about 19,000 methods.  And with a limit of 65536, this means that a third of all the methods that we can include have already been exhausted.  Like this. <br><br>  Now, before we get to the ‚Äúsolution‚Äù of this problem, I think a little reflection would be appropriate.  Some developers, both inside and outside Google, share a common point of view, which says: ‚ÄúIf you encounter a restriction, then you are a bad, very bad developer, you deserve punishment (and you must also burn in hell)‚Äù.  From a more impartial point of view, this means that you have recklessly included too many libraries, either because you are too lazy, or because your application does too much.  Personally, I do not share this view.  I think these are just excuses for two simple things: <br><br>  1. I do not want to admit the problem / I do not want to fix it. <br>  2. I did not go beyond the limit, then I am a cool developer, and you are doing something wrong. <br><br>  Maybe the limit was set for the following reasons: ‚ÄúThis limit will define the line between a good and a bad programmer for all future generations.  So be it. ‚ÄùBut I doubt it. <br><br><h4>  Throw away all unnecessary </h4><br>  In a world where justice prevails, Google realized the depth of the problem and decided to reduce the damage it does by dividing the giant Play Services into modules that can be included depending on the functionality your application uses.  For example, if my application is not related to games, it makes absolutely no sense to include all the Play Games API in it.  This is the most reasonable move that can be taken and which is possible to carry out. <br><br>  However, Google does not fully understand the problem, so better we will find another way to solve it on our own.  As it was said, we‚Äôll throw out parts of google-play-services.jar, those parts of the API that we don‚Äôt need. <br><br>  There are a couple of ways to do this.  You can do it manually, but remember that you have to do it every six weeks. <br><br>  You can rely on the <a href="https://code.google.com/p/jarjar/">JarJar</a> library <a href="https://code.google.com/p/jarjar/">,</a> which allows you to remove desired packages from the jar file.  Clear and simple. <br><br>  If you, like me, prefer the good old command line, then you can use the script that I use for your projects, which is called (you will not believe) <a href="https://gist.github.com/dextorer/a32cad7819b7f272239b">strip_play_services.sh</a> .  The script can be controlled using the strip.conf configuration file that comes with it.  Using it, you can select the Play Services Library modules that should be disabled.  Essentially the script does the following: <br><br>  1. Extract content from google-play-services.jar <br>  2. Checks whether strip.conf exists, and if it exists, it uses it for configuration; if not, it creates a new one, writing all the modules from the Play Services Library there. <br>  3. Based on strip.conf, removes unnecessary modules from the library <br>  4. Repack the remaining modules in the google-play-services-STRIPPED.jar file <br><br>  Here is a simple configuration for the strip.conf file: <br><br><blockquote>  actions = true <br>  ads = true <br>  analytics = true <br>  appindexing = true <br>  appstate = true <br>  auth = true <br>  cast = true <br>  common = true <br>  drive = false <br>  dynamic = true <br>  games = false <br>  gcm = true <br>  identity = true <br>  internal = true <br>  location = false <br>  maps = false <br>  panorama = false <br>  plus = true <br>  security = true <br>  tagmanager = true <br>  wallet = false <br>  wearable = true </blockquote><br><br>  And that's all.  Now for an example, let's calculate the number of methods of our test application again and see what has changed: <br><br><pre> <code class="bash hljs">Read <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> 11216 method IDs. &lt;root&gt;: 11216 [...]</code> </pre><br><br>  This is already something.  By choosing the right configuration based on the needs of your application, you can control the ‚Äúthickness‚Äù of Google Play Services and leave more room for the methods that you (probably) really need. <br><br>  But you must also be very careful.  Play Services Library is very well built (in terms of modularity), and you can safely remove the ‚Äúgames‚Äù module without affecting the ‚Äúmaps‚Äù module.  But if you remove a module that is used by others (internal, in simple terms), then nothing will work.  Use trial and error! <br><br><img src="https://habrastorage.org/getpro/habr/post_images/88c/cc8/b47/88ccc8b4700fdb80bf654af34dbc4891.jpg"><br><br><h4>  Is there any other way? </h4><br>  Of course have.  Running <a href="http://developer.android.com/tools/help/proguard.html">ProGuard</a> for your application can help, as it removes unnecessary methods from your code and in addition reduces the size of the APK.  But do not expect a big reduction, this will not happen. <br><br>  Another solution is to create a second DEX file, which contains a part of your code, which you will access through interfaces / reflections and which you will load through a custom ClassLoader ( <a href="http://android-developers.blogspot.it/2011/07/custom-class-loading-in-dalvik.html">more</a> ).  This solution may be more effective in some cases.  However, this path is very nontrivial. <br><br>  I found another solution from my good friend <a href="https://twitter.com/dmarcato">Dario Marcato</a> .  He created the Gradle task to remove unnecessary modules.  If you use Gradle, be sure to <a href="https://gist.github.com/dmarcato/d7c91b94214acd936e42">try it!</a>  . <br><br><h4>  Afterword </h4><br>  This is a translation of the original article by <a href="https://medium.com/%40rotxed">Sebastiano Gottardo</a> , <a href="https://medium.com/%40rotxed/dex-skys-the-limit-no-65k-methods-is-28e6cb40cf71">[DEX] Sky's the limit?</a>  <a href="https://medium.com/%40rotxed/dex-skys-the-limit-no-65k-methods-is-28e6cb40cf71">No, 65K methods is</a> .  If the translation seems to be ‚Äúclumsy‚Äù or you have found spelling / syntactic / factual errors in the text, please write me in the LAN. </div><p>Source: <a href="https://habr.com/ru/post/230665/">https://habr.com/ru/post/230665/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../230655/index.html">Beaver mysql logger or how to find an error in the MySql application</a></li>
<li><a href="../230657/index.html">Ulefone U7 - thin phablet</a></li>
<li><a href="../230659/index.html">Home library of the modern child</a></li>
<li><a href="../230661/index.html">Web server in 5 minutes based on PIC and W5100</a></li>
<li><a href="../230663/index.html">Java Garbage Collection on Infobox Jelastic cloud hosting</a></li>
<li><a href="../230667/index.html">NASA is considering the placement of cosmonaut settlements on the moon in lunar caves</a></li>
<li><a href="../230669/index.html">Interactive - a new scientific term or a manifesto of love for games</a></li>
<li><a href="../230671/index.html">Chart rendering: not as easy as it sounds</a></li>
<li><a href="../230673/index.html">How to return the domain "with interest"</a></li>
<li><a href="../230675/index.html">Pandor - end-to-end encryption email correspondence</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>