<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>STM32 weather station, analogue display</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="After studying the comments on the article immediately went to work. Appeared goal: 

 As a result: the interface was refined, debug information was r...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>STM32 weather station, analogue display</h1><div class="post__text post__text-html js-mediator-article">  After studying the comments on the <a href="http://habrahabr.ru/post/153395/">article</a> immediately went to work.  Appeared goal: <br><img src="https://habrastorage.org/storage2/a45/dcb/558/a45dcb558a16d7024d91d7e818f31ecd.jpg"><br>  As a result: the interface was refined, debug information was removed from the start screen;  LCD display module (LCD) of the display has been improved - pressure and humidity graphs have appeared;  Added external RTC (FrV) with ionistor.  And the most important thing is the dial indicator. <a name="habracut"></a><br><br><h4>  Arrow indication and DAC </h4><br>  The easiest way to get an arrow indication is to apply voltage to the head of the measuring device.  The desired voltage will form the digital-to-analog converter of the microcontroller.  The STM32L has a dual-channel multifunctional <a href="http://easystm32.ru/for-beginners/37-dac-stm32">DAC</a> .  At the flea market, the first available device was purchased in good condition: <br><img src="https://habrastorage.org/storage2/6d6/e11/4a3/6d6e114a36a6ac9c156398972b39bcb4.jpg"><br>  First of all, the circuit board with the parts was thrown out of the device. <br><img src="https://habrastorage.org/storage2/3f5/283/895/3f52838955feacedc98099ce1c1f3056.jpg"><br>  Draw a scale: <br><img src="https://habrastorage.org/storage2/b36/950/e9d/b36950e9d726e70d1fc9796d19a52356.png"><br>  Initializing D / A and Ports: <br><pre><code class="cpp hljs">GPIO_InitStructure.GPIO_Pin = GPIO_Pin_4; GPIO_InitStructure.GPIO_Mode = GPIO_Mode_AN; GPIO_InitStructure.GPIO_PuPd = GPIO_PuPd_NOPULL; GPIO_Init(GPIOA, &amp;GPIO_InitStructure); <span class="hljs-comment"><span class="hljs-comment">// DAC: RCC_APB1PeriphClockCmd(RCC_APB1Periph_DAC, ENABLE); // DAC: DAC_InitTypeDef DAC_InitStructure; /* DAC channel1 Configuration */ DAC_InitStructure.DAC_Trigger = DAC_Trigger_None; DAC_InitStructure.DAC_WaveGeneration = DAC_WaveGeneration_None; DAC_InitStructure.DAC_OutputBuffer = DAC_OutputBuffer_Enable; /* DAC Channel1 Init */ DAC_Init(DAC_Channel_1, &amp;DAC_InitStructure); /* Enable DAC Channel1 */ DAC_Cmd(DAC_Channel_1, ENABLE);</span></span></code> </pre> <br>  write value: <br><pre> <code class="cpp hljs"> DAC_SetChannel1Data(DAC_Align_12b_R, <span class="hljs-number"><span class="hljs-number">160</span></span> + temperature * <span class="hljs-number"><span class="hljs-number">3</span></span>);</code> </pre> <br>  The output signal is quite enough to control the arrow, the voltage does not sag, the microcontroller is not heated.  A value of 160 displays an arrow in the middle of the scale.  As a result, we have the following picture at +25: <br><img src="https://habrastorage.org/storage2/e26/f4b/530/e26f4b530dd499ec9c6ef785b16a9f47.jpg"><br><br><h4>  Graphics and LCD </h4><br>  The graphic mode was given not simply, I did not want to give the memory of the microcontroller to the storage of the output information, and for this it was necessary to implement reading from the LCD.  It was not possible to configure the port for input and output at the same time, so you have to read or write to it before each entry or reading. <br>  Port configurations: output - <pre> <code class="cpp hljs"> GPIO_InitStructure.GPIO_Pin = DATA_PIN0 | DATA_PIN1 | DATA_PIN2 | DATA_PIN3 | DATA_PIN4 | DATA_PIN5 | DATA_PIN6 | DATA_PIN7; GPIO_InitStructure.GPIO_Mode = GPIO_Mode_OUT; GPIO_InitStructure.GPIO_OType = GPIO_OType_OD; GPIO_InitStructure.GPIO_PuPd = GPIO_PuPd_UP; GPIO_InitStructure.GPIO_Speed = GPIO_Speed_2MHz; GPIO_Init( DATA_PORT, &amp;GPIO_InitStructure);</code> </pre><br>  to receive data - <pre> <code class="cpp hljs"> GPIO_InitStructure.GPIO_Pin = DATA_PIN0 | DATA_PIN1 | DATA_PIN2 | DATA_PIN3 | DATA_PIN4 | DATA_PIN5 | DATA_PIN6 | DATA_PIN7; GPIO_InitStructure.GPIO_Mode = GPIO_Mode_IN; GPIO_InitStructure.GPIO_Speed = GPIO_Speed_10MHz; GPIO_Init( DATA_PORT, &amp;GPIO_InitStructure);</code> </pre><br>  There was also a pitfall ‚Äúdumy read‚Äù - after setting the address, the first reading gives garbage, the second data. <br>  After that, the function PutPixel, DrawLine, Rectangle (remembered childhood). <br><img src="https://habrastorage.org/storage2/32d/564/645/32d564645b3295c4d51bc70bde1e4c88.jpg">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  CRV </h4><br>  ChrV chip was chosen DS2417 with one-wire interface, it famously got along on the same bus with DS18B20. <br><img src="https://habrastorage.org/storage2/1f4/0e1/a29/1f40e1a291f5859225ac578aac31dc74.png"><br>  Device selection is the same commands 55h + id but reading from DS2417 66h and DS18B20 BEh.  The ionistor included in the power supply circuit ensures the operation of the clock even when the supply voltage is disconnected. <br><br>  <a href="">Sources of the project</a> . </div><p>Source: <a href="https://habr.com/ru/post/154355/">https://habr.com/ru/post/154355/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../154343/index.html">Visualization of the characteristic function</a></li>
<li><a href="../154345/index.html">Destroying common myths about D</a></li>
<li><a href="../154347/index.html">Windy - jQuery plugin slider with a very beautiful effect</a></li>
<li><a href="../154349/index.html">Multicast streaming video files using tsplay</a></li>
<li><a href="../154351/index.html">I want to cry from Russian real estate sites</a></li>
<li><a href="../154357/index.html">How we taught the robot to help support</a></li>
<li><a href="../154359/index.html">How bitcoins are stored</a></li>
<li><a href="../154361/index.html">Search for a contact by phone number</a></li>
<li><a href="../154365/index.html">Bullseye on a silver platter, or How the AppCode logo was created</a></li>
<li><a href="../154369/index.html">Error Propagation Algorithm with Regularization on c #</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>