<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>"Perfect" cluster. Part 2.2: Highly available and scalable web server, the best technologies to guard your business</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In continuation of the series of articles on the ‚ÄúIdeal‚Äù cluster, I want to share recipes for creating reliable, productive and easy-to-manage web-sys...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>"Perfect" cluster. Part 2.2: Highly available and scalable web server, the best technologies to guard your business</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/870/2a4/467/8702a4467b4a4be626e04e1c48d73dc8.jpg"><br><br><h4>  In continuation of the series of articles on the ‚ÄúIdeal‚Äù cluster, I want to share recipes for creating reliable, productive and easy-to-manage web-systems. </h4><br><br>  In order to ensure reliable and fast work of websites and web-systems, our company conducted an examination of the technical means available on the market.  We were guided by a simple goal: to achieve scalability and at the same time high performance of our systems. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The cluster, in fact, was built from scratch.  There was a frontend-backend architecture.  The databases went to MariaDB Galera, all sites moved to unified web nodes. <br><br>  In the course of long work, disputes and discussions, ready-made solutions were born, which <a href="http://habrahabr.ru/company/acronis/">Acronis is</a> happy to share with you.  We exist to help. <br><br><a name="habracut"></a><br><br>  <b>My other publications on the ‚ÄúIdeal‚Äù cluster</b> <br><ul><li>  <a href="http://habrahabr.ru/post/264487/">Acceleration and optimization of PHP-site.</a>  <a href="http://habrahabr.ru/post/264487/">What technologies should be chosen when setting up a server for PHP</a> </li><li>  <a href="http://habrahabr.ru/post/253869/">"Perfect" cluster.</a>  <a href="http://habrahabr.ru/post/253869/">Part 3.1 Implementing MySQL Multi-Master Cluster</a> </li><li>  <a href="http://habrahabr.ru/company/acronis/blog/209934/">"Perfect" cluster.</a>  <a href="http://habrahabr.ru/company/acronis/blog/209934/">Part 2.2: Highly available and scalable web server, the best technologies to guard your business</a> </li><li>  <a href="http://habrahabr.ru/company/acronis/blog/204190/">About virtual hetzner cluster</a> </li><li>  <a href="http://habrahabr.ru/company/acronis/blog/198934/">Frontend: NGINX + Keepalived (vrrp) on CentOS</a> </li><li>  <a href="http://habrahabr.ru/company/acronis/blog/198448/">HAPRoxy for Percona or Galera on CentOS.</a>  <a href="http://habrahabr.ru/company/acronis/blog/198448/">Its configuration and monitoring in Zabbix</a> </li><li>  <a href="http://habrahabr.ru/company/acronis/blog/198354/">Zabbix 2.2 riding on nginx + php-fpm and mariadb</a> </li></ul><br><br><h5>  Now we will talk about several important aspects: </h5><br><br><ul><li>  How to deploy a secure, scalable web-system on the example of a virtual cluster in Proxmox-based Hetzner </li><li>  How to easily manage all systems from one free and convenient control panel </li><li>  How, using the most modern technologies, to achieve maximum performance and safety </li></ul><br><br><h5>  You may ask, how is this article different from hundreds of others? </h5><br><br><ul><li>  how to set up a free CentOS-based ISPConfig web-based control panel (official documentation talks about using the panel in a Debian environment) </li><li>  How to configure the ISPConfig web panel itself to work without apache2 (The documentation strongly suggests using it with apache2) </li><li>  I will share the recipe for creating a productive php application server using nginx + php-phm and apache2 + php-fpm / mod_ph backends. </li><li>  I'll tell you about the installation and configuration of MariaDB, instead of MySQL </li></ul><br><br><h5>  Concept: </h5><br><ul><li>  Take, for example, the hypervisor based on the free Proxmox system </li><li>  For each service, we will create our own virtual environment based on OpenVZ (thanks to colleagues from <a href="http://habrahabr.ru/company/parallels/">Parallels</a> for a great product) </li><li>  We have a gw.local container, it forwards individual ports to other containers using iptables </li><li>  There is isp.  local where the nginx + php-fpm-based ISPConfig control panel is running </li><li>  There is front01.local. Nginx is working on it in the traffic proxying mode on one of its upstream (servers of the execution of our sites) </li><li>  There is app01.local on which the php execution environment lives.  It can be apache + php-fpm / mod_php or nginx + php-fpm </li><li>  There is db.local on which lives the main database MariaDB </li></ul><br><br>  On all servers except app01.local, all unsolicited services, including ssh, have been removed, the interaction between them takes place through a gray private network.  Only those ports that are necessary for the operation of our sites are open to the public network (80, 443, etc.) <br><br><h4>  Proxmox Known issues </h4><br><br>  Do not forget to include autoloading containers created <br><br><img src="https://habrastorage.org/getpro/habr/post_images/b06/ad0/e28/b06ad0e289ea665dae2522358f6bbadf.png"><br><br>  When you create a network for the bridge <b>vmbr1</b> , Proxmox assigns it a virtual name <b>eth0</b> , so you have to delete the created network and redo everything correctly <br><br><img src="https://habrastorage.org/getpro/habr/post_images/89e/ee1/cdc/89eee1cdc4005222fba9f0b374bc63a9.png"><br><br>  In order to enter the container, it is necessary to start it and in the terminal enter the <b>vzctl enter command number_container</b> <br><br>  In the article about Proxmox (link to it at the very beginning), we said that we use a file where the firewall rules of our official public network are written, which ideally nobody should know about except us. <br><br><pre><code class="bash hljs">nano /etc/iptables.up.rules</code> </pre> <br><br><pre> <code class="bash hljs">*nat :PREROUTING ACCEPT [2164:136969] :POSTROUTING ACCEPT [58:3659] :OUTPUT ACCEPT [0:0] <span class="hljs-comment"><span class="hljs-comment"># Nat -A POSTROUTING -o vmbr0 -j MASQUERADE # ISPConfig Web Panel -A PREROUTING -d *.*.*182/32 -p tcp -m tcp --dport 8080 -j DNAT --to-destination 192.168.8.3:8080 -A PREROUTING -d *.*.*.182/32 -p tcp -m tcp --dport 8081 -j DNAT --to-destination 192.168.8.3:8081 # app01. ssh server -A PREROUTING -d *.*.*.182/32 -p tcp -m tcp --dport 22 -j DNAT --to-destination 192.168.8.4:22 COMMIT</span></span></code> </pre> <br><br>  <b># Change the ssh port of our hypervisor to 2222</b> <br><br><pre> <code class="bash hljs">nano /etc/ssh/sshd_config</code> </pre> <br><br><pre> <code class="bash hljs">Port 2222</code> </pre> <br><br><h4>  General presets for all our containers </h4><br><br>  <b># Be sure to add to the hosts file, on all containers where the ISPConfig agents will be, these lines:</b> <br><br><pre> <code class="bash hljs">nano /etc/hosts</code> </pre> <br><br><pre> <code class="bash hljs">192.168.8.1 gw.local 192.168.8.2 front01.local 192.168.8.3 isp.local 192.168.8.4 app01.local 192.168.8.5 db01.local</code> </pre> <br><br>  <b># Change the time zone to your</b> <br><br><pre> <code class="bash hljs">ln -sf /usr/share/zoneinfo/Europe/Moscow /etc/localtime</code> </pre> <br><br><pre> <code class="bash hljs">yum install wget nano wget ntpdate -y</code> </pre> <br><br>  <b># These repositories should be, because here we will find a lot of packages that are not in the basic repositories.</b> <br><br><pre> <code class="bash hljs">wget http://dl.fedoraproject.org/pub/epel/6/x86_64/epel-release-6-8.noarch.rpm wget http://rpms.famillecollet.com/enterprise/remi-release-6.rpm sudo rpm -Uvh remi-release-6*.rpm epel-release-6*.rpm rm *.rpm -f</code> </pre> <br><br>  <b># This repository is useful to us, but we will turn it off by default.</b> <br><pre> <code class="bash hljs">rpm --import http://dag.wieers.com/rpm/packages/RPM-GPG-KEY.dag.txt <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /tmp wget http://dag.wieers.com/rpm/packages/rpmforge-release/rpmforge-release-0.3.6-1.el5.rf.x86_64.rpm &amp;&amp; rpm -ivh rpmforge-release-0.3.6-1.el5.rf.x86_64.rpm</code> </pre> <br><br>  <b># Turn off, we will use through --enablerepo = rpmforge</b> <br><br><pre> <code class="bash hljs">sed -i <span class="hljs-string"><span class="hljs-string">'s/enabled = 1/enabled = 0/g'</span></span> /etc/yum.repos.d/rpmforge.repo</code> </pre> <br><br>  <b># And this is a gem for web systems and not only, there really is a lot of things that an administrator needs in his work.</b>  <b>Musthave</b> <br><br><pre> <code class="bash hljs">wget -q -O - http://www.atomicorp.com/installers/atomic | sh</code> </pre> <br><br>  <b># We put useful software</b> <br><br><pre> <code class="bash hljs">yum install nano mc screen sudo nscd htop ntp zip unzip pigz iotop sysstat lsof strace atop multitail -y yum --enablerepo=rpmforge install htop -y</code> </pre> <br><br>  <b># Remove unwanted service for this container</b> <br><br><pre> <code class="bash hljs">yum remove -y sendmail httpd sshd samba <span class="hljs-built_in"><span class="hljs-built_in">bind</span></span> openssh -y</code> </pre> <br><br>  <b># Update the system</b> <br><br><pre> <code class="bash hljs">yum update -y</code> </pre> <br><br>  <b># Remove mysql</b> <br><br><pre> <code class="bash hljs">yum remove mysql* mysql-*</code> </pre> <br><br>  <b># Install mariadb for service purposes ISPConfig</b> <br><br><pre> <code class="bash hljs">yum install mariadb-server mariadb-devel mariadb-client -y</code> </pre> <br><br>  <b># Install cron</b> <br><br><pre> <code class="bash hljs">yum install -y cronie cronie-anacron crontabs sysstat -y</code> </pre> <br><br>  <b># Add cron to autoload and run</b> <br><br><pre> <code class="bash hljs"> /etc/init.d/crond start &amp;&amp; chkconfig crond on</code> </pre> <br><br>  <b># Customize mariadb</b> <br><br><pre> <code class="bash hljs">nano /etc/my.cnf</code> </pre> <br><br><pre> <code class="bash hljs">[mysqld] skip-name-resolve default_storage_engine=InnoDB innodb_file_per_table = 1 <span class="hljs-comment"><span class="hljs-comment"># network connect_timeout = 60 wait_timeout = 28800 max_connections = 200 max_allowed_packet = 512M max_connect_errors = 1000 # performance query_cache_size = 32M tmp_table_size = 32M max_heap_table_size = 32M thread_cache_size = 16 table_open_cache = 600 innodb_flush_log_at_trx_commit = 2 innodb_flush_method = O_DIRECT transaction-isolation = READ-COMMITTED log_error = /var/log/mysql/mysql-error.log #slow_query_log_file = /var/log/mysql/mysql-slow.log</span></span></code> </pre> <br><br>  <b># Add mariadb to autoload</b> <br><br><pre> <code class="bash hljs">chkconfig --levels 235 mysqld on &amp;&amp; /etc/init.d/mysqld start</code> </pre> <br><br><h4>  Setting up the gw.local environment </h4><br>  You need to create an OpenVZ (New CT) container with the CentOS 64 environment. This virtual machine will serve our public and private network. <br><br>  <b>We will need the vmbr0 network interfaces named eth0 (our public network of the provider) and vmbr1 for the eth1 network (a private network for interacting with other containers).</b> <br><br><img src="https://habrastorage.org/getpro/habr/post_images/36b/1a9/9c8/36b1a99c85e3f8d162c39a34c3ac3613.png"><br>  <b>This virtual machine will require no more than 128 MB of RAM.</b> <br><br><img src="https://habrastorage.org/getpro/habr/post_images/bd0/a36/5d4/bd0a365d4a3a339ccd2fbb613e01b47a.png"><br><br>  We start to configure the network in the container gw.local <br><br>  <b>Network inside the container:</b> <br><br><pre> <code class="bash hljs">vi /etc/sysconfig/network-scripts/ifcfg-eth0</code> </pre> <br><br><pre> <code class="bash hljs">DEVICE=eth0 BOOTPROTO=static ONBOOT=yes IPADDR=xxx237 NETMASK=255.255.255.0 GATEWAY=xxx1</code> </pre> <br><br><pre> <code class="bash hljs">vi /etc/sysconfig/network-scripts/ifcfg-eth1</code> </pre> <br><br><pre> <code class="bash hljs">DEVICE=eth1 BOOTPROTO=static ONBOOT=yes IPADDR=192.168.8.1 NETWORK=192.168.8.0</code> </pre> <br><br>  <b># Save current iptables rules</b> <br><br><pre> <code class="bash hljs"> /etc/init.d/iptables save</code> </pre> <br><br>  <b># Add rules to the * nat section for our external business address</b> <br><br><pre> <code class="bash hljs">vi /etc/sysconfig/iptables</code> </pre> <br><br><pre> <code class="bash hljs">-A PREROUTING -d *.*.*.237/32 -p tcp -m tcp --dport 80 -j DNAT --to-destination 192.168.8.2:80 -A PREROUTING -d *.*.*.237/32 -p tcp -m tcp --dport 443 -j DNAT --to-destination 192.168.8.2:443 -A PREROUTING -d *.*.*.237/32 -p tcp -m tcp --dport 25 -j DNAT --to-destination 192.168.8.5:25 -A PREROUTING -d *.*.*.237/32 -p tcp -m tcp --dport 110 -j DNAT --to-destination 192.168.8.5:110 -A PREROUTING -d *.*.*.237/32 -p tcp -m tcp --dport 145 -j DNAT --to-destination 192.168.8.5:145 -A PREROUTING -d *.*.*.237/32 -p tcp -m tcp --dport 995 -j DNAT --to-destination 192.168.8.5:995 -A PREROUTING -d *.*.*.237/32 -p tcp -m tcp --dport 465 -j DNAT --to-destination 192.168.8.5:465 -A PREROUTING -d *.*.*.237/32 -p tcp -m tcp --dport 587 -j DNAT --to-destination 192.168.8.5:587 -A PREROUTING -d *.*.*.237/32 -p tcp -m tcp --dport 143 -j DNAT --to-destination 192.168.8.5:143 -A PREROUTING -d *.*.*.237/32 -p tcp -m tcp --dport 993 -j DNAT --to-destination 192.168.8.5:993 -A POSTROUTING -o eth0 -j MASQUERADE</code> </pre> <br><br>  <b># We allow traffic forwarding</b> <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"net.ipv4.ip_forward = 1"</span></span> &gt;&gt; /etc/sysctl.conf sysctl -p</code> </pre> <br><br><h4>  Setting up the front01.local environment </h4><br><br>  It is necessary to create an OpenVZ (New CT) container with the CentOS 64 environment. This virtual machine will serve ports 80 and 443, thrown from our gw.local.  This container has nginx installed, which proxies all requests to our sites on app01.local <br>  The nginx configuration procedure itself is well described in this article <a href="http://habrahabr.ru/company/acronis/blog/198934/">‚ÄúPerfect‚Äù www cluster.</a>  <a href="http://habrahabr.ru/company/acronis/blog/198934/">Part 1. Frontend: NGINX + Keepalived (vrrp) on CentOS</a> <br><br>  This container will have an address in the private network ( <b>vmbr1</b> ) <b>192.168.8.2</b> , for work, no more than <b>1024</b> MB of RAM will be required <br><br>  This is how the network should look like in the container itself: <br><br><pre> <code class="bash hljs">vi /etc/sysconfig/network-scripts/ifcfg-eth1</code> </pre> <br><br><pre> <code class="bash hljs">DEVICE=eth1 BOOTPROTO=static ONBOOT=yes IPADDR=192.168.8.2 NETWORK=192.168.8.0 GATEWAY=192.168.8.1</code> </pre> <br><br><h4>  Setting up the isp environment. </h4><br>  You need to create an OpenVZ (New CT) container with the CentOS 64 environment. This virtual machine will serve our ISPConfig control panel.  At the beginning of the article we showed that the panel will be served by the service public address and will be available on ports 8080 and 8081. <br><br>  This container will have an address in a private network ( <b>vmbr1</b> ) <b>192.168.8.3</b> , and will need about 384 MB of RAM. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/bfa/3d3/e82/bfa3d3e82cfc289e95392bc4067892af.png"><br><br>  <b># Network settings for this container:</b> <br><br><pre> <code class="bash hljs">/etc/sysconfig/network-scripts/ifcfg-eth1</code> </pre> <br><br><pre> <code class="bash hljs">DEVICE=eth1 BOOTPROTO=static ONBOOT=yes IPADDR=192.168.8.3 NETWORK=192.168.8.0 GATEWAY=192.168.8.100</code> </pre> <br><br>  <b># Install web server components for ISPConfig panel</b> <br><br><pre> <code class="bash hljs">yum install php-mysql php nginx php-fpm postfix patch -y</code> </pre> <br><br>  <b># Remove configs with standard nginx greeting</b> <br><br><pre> <code class="bash hljs">rm -f /etc/nginx/conf.d/default.conf rm -f /etc/nginx/conf.d/virtual.conf rm -f /etc/nginx/conf.d/ssl.conf</code> </pre> <br><br>  <b># Add nginx and php-fpm to autoload and run</b> <br><br><pre> <code class="bash hljs">chkconfig --levels 235 php-fpm on &amp;&amp; /etc/init.d/php-fpm start chkconfig --levels 235 nginx on &amp;&amp; /etc/init.d/nginx start</code> </pre> <br><br>  <b># Allow ISPConfig agents to connect to the central isp.local database for their parameters</b> <br><br><pre> <code class="bash hljs">mysql</code> </pre> <br><br><pre> <code class="bash hljs">CREATE USER <span class="hljs-string"><span class="hljs-string">'root'</span></span>@<span class="hljs-string"><span class="hljs-string">'192.168.8.%'</span></span> IDENTIFIED BY <span class="hljs-string"><span class="hljs-string">'c2HZqsMmiBKa'</span></span>; GRANT ALL PRIVILEGES ON * . * TO <span class="hljs-string"><span class="hljs-string">'root'</span></span>@<span class="hljs-string"><span class="hljs-string">'192.168.8.%'</span></span> IDENTIFIED BY <span class="hljs-string"><span class="hljs-string">'c2HZqsMmiBKa'</span></span> WITH GRANT OPTION; flush privileges;</code> </pre> <br><br>  <b># Install phpMyAdmin</b> <br><br><pre> <code class="bash hljs">yum install phpmyadmin -y</code> </pre> <br><br>  <b># Create a phpMyAdmin simlink on phpmyadmin</b> <br><br><pre> <code class="bash hljs">ln -s /usr/share/phpMyAdmin/ /usr/share/phpmyadmin</code> </pre> <br><br><pre> <code class="bash hljs">nano /etc/phpMyAdmin/config.inc.php</code> </pre> <br><br><pre> <code class="bash hljs"><span class="hljs-variable"><span class="hljs-variable">$cfg</span></span>[<span class="hljs-string"><span class="hljs-string">'blowfish_secret'</span></span>] = <span class="hljs-string"><span class="hljs-string">'46a30e4ed1cf83.14522379'</span></span>; /* YOU MUST FILL IN THIS FOR COOKIE AUTH! */ <span class="hljs-variable"><span class="hljs-variable">$cfg</span></span>[<span class="hljs-string"><span class="hljs-string">'Servers'</span></span>][<span class="hljs-variable"><span class="hljs-variable">$i</span></span>][<span class="hljs-string"><span class="hljs-string">'host'</span></span>] = <span class="hljs-string"><span class="hljs-string">'db01.local'</span></span>; // MySQL hostname or IP address <span class="hljs-variable"><span class="hljs-variable">$cfg</span></span>[<span class="hljs-string"><span class="hljs-string">'Servers'</span></span>][<span class="hljs-variable"><span class="hljs-variable">$i</span></span>][<span class="hljs-string"><span class="hljs-string">'port'</span></span>] = <span class="hljs-string"><span class="hljs-string">'3306'</span></span>; // MySQL port - leave blank <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> default port <span class="hljs-variable"><span class="hljs-variable">$cfg</span></span>[<span class="hljs-string"><span class="hljs-string">'Servers'</span></span>][<span class="hljs-variable"><span class="hljs-variable">$i</span></span>][<span class="hljs-string"><span class="hljs-string">'auth_type'</span></span>] = <span class="hljs-string"><span class="hljs-string">'cookie'</span></span>; // Authentication method (config, http or cookie based)?</code> </pre> <br><br>  <b># Install ISPConfig</b> <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /usr/src/ wget http://www.ispconfig.org/downloads/ISPConfig-3-stable.tar.gz tar xfz ISPConfig-3-stable.tar.gz <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ispconfig3_install/install/ php -q install.php</code> </pre> <br><br>  <b># Answering the questions of the interactive installation wizard</b> <br><blockquote>  &gt;&gt; Initial configuration <br><br>  Operating System: Redhat or compatible, unknown version. <br><br>  If so, be careful. <br>  Default values ‚Äã‚Äãare in [brackets] and can be accepted with. <br>  Tap in "quit" (without the quotes) to stop the installer. <br><br>  Select language (en, de) [ <b>en</b> ]: <br><br>  Installation mode (standard, expert) [standard]: <b>expert</b> <br><br>  Full qualified hostname (FQDN) of the server, eg server1.domain.tld [ <b>isp.local</b> ]: <br><br>  MySQL server hostname [ <b>localhost</b> ]: <br><br>  MySQL root username [ <b>root</b> ]: <br><br>  MySQL root password []: <br><br>  MySQL database to create [ <b>dbispconfig</b> ]: <br><br>  MySQL charset [ <b>utf8</b> ]: <br><br>  The next two questions are about the internal ISPConfig database user and password. <br>  It is recommended to accept the defaults which are 'ispconfig' as username and random password. <br>  If you use the password <br><br>  ISPConfig mysql database username [ <b>ispconfig</b> ]: <br><br>  ISPConfig mysql database password [ <b>1850fcffe2fc0b1ca2707c3e27c5eec4</b> ]: <br><br>  Shall this server join an existing ISPConfig multiserver setup (y, n) [ <b>n</b> ]: <br><br>  Apache and nginx detected.  Select server to use for ISPConfig: (apache, nginx) [apache]: <b>nginx</b> <br><br>  Adding ISPConfig server record to database. <br><br>  Configure Mail (y, n) [y]: <b>n</b> <br><br>  Configure Jailkit (y, n) [y]: <b>n</b> <br><br>  Configure FTP Server (y, n) [y]: <b>y</b> <br><br>  Configuring Pureftpd <br>  Configure DNS Server (y, n) [y]: <b>n</b> <br><br>  Hint: If this is the ISPConfig interface, select the 'y' in the 'Configure nginx Server' option. <br><br>  Configure nginx Server (y, n) [y]: <b>y</b> <br><br>  Configuring nginx <br>  Configuring Apps vhost <br>  Configure Firewall Server (y, n) [y]: <b>y</b> <br><br>  Configuring Bastille Firewall <br>  Install ISPConfig Web Interface (y, n) [y]: <b>y</b> <br><br>  Installing ISPConfig <br>  ISPConfig Port [ <b>8080</b> ]: <br><br>  Enable SSL for the ISPConfig web interface (y, n) [y]: <b>y</b> <br><br>  Generating RSA private key, 4096 bit long modulus <br>  .................................................. .............. ++ <br>  .................................................. .................................................. ................... ++ <br>  e is 65537 (0x10001) <br>  You are included <br>  into your certificate request. <br>  What is a Distinguished Name or a DN? <br>  You can leave some blank <br>  For some fields there will be a default value, <br>  If you enter '.', The field will be left blank. <br>  - Country Name (2 letter code) [XX]: <b>Ru</b> <br>  State or Province Name (full name) []: <b>Moscow</b> <br>  Locality Name (eg, city) [Default City]: <b>Moscow</b> <br>  Organization Name (eg, company) [Default Company Ltd]: <b>isp.local</b> <b><br></b>  Organizational Unit Name (eg, section) []: <b>IT</b> <br>  Common Name (eg, your server or your server‚Äôs hostname) []: <b>isp.local</b> <br>  Email Address []: <br><br>  Please enter the following extra attributes <br>  to be sent with your certificate request <br>  A challenge password []: <br>  An optional company name []: <br>  writing RSA key <br>  Configuring DBServer <br>  Installing ISPConfig crontab <br>  no crontab for root <br>  Reloading php-fpm: [OK] <br>  Reloading nginx: [OK] <br>  <b>Installation completed.</b> <br><br></blockquote><br><br>  <b># Our ISPConfig panel is forwarded to port 8080 of the service public interface</b> <br><br><pre> <code class="bash hljs">https://__ip:8080/</code> </pre> <br><br><img src="https://habrastorage.org/getpro/habr/post_images/4eb/d63/931/4ebd63931808fcab8727ef1c5a112d87.png"><br><br>  Default login and password: <b>admin</b> <br><br>  <b># Check for known problems in the installed version of ISPConfig on <a href="http://www.ispconfig.org/page/en/ispconfig/patches.html">this</a> site.</b>  <b>If there are patches with updates, apply them.</b> <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/ispconfig/server/scripts wget http://www.ispconfig.org/downloads/ispconfig_patch chmod 700 ispconfig_patch chown root:root ispconfig_patch ln -s /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/ispconfig/server/scripts/ispconfig_patch /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/bin/ispconfig_patch</code> </pre> <br><br>  <b># Here is a list of available, at the time of writing, patches</b> <br><blockquote>  Patches for <b>ISPConfig 3.0.5.3</b> <br><br>  Patch ID: <b>3053_langedit</b> <br>  Date: 2013-09-25 <br>  Description: This patch solves a UTF-8 encoding issue in the language file editor. <br><br>  Patch ID: <b>3053_langimport</b> <br>  Description: This patch adds a language to the language file importer. <br><br>  Patch ID: <b>3053_backupdownload</b> <br>  Description: This is a patch backups website. <br><br>  Patch ID: <b>3053_apsdelete</b> <br>  Description: deletes APS instances. <br><br>  Patch ID: <b>3053_ftpuser</b> <br>  Description: This patch fixes FS # 3089 - FTP User Options - ERROR You have no permission for this domain. <br><br>  Patch ID: <b>3053_phpversion</b> <br>  Description for your website.  Php select user interface is ‚Äúdefault‚Äù. <br><br>  Patch ID: <b>3053_sysini</b> <br>  Description: This patch fixes FS # 3086 - SQL query warning about sys_ini access in multiserver setups. <br><br>  Patch ID: <b>3053_dashboard</b> <br>  Description: This patch fixes on the dashboard. </blockquote><br><br>  <b># Uncomment the section responsible for phpMyAdmin</b> <br><br><pre> <code class="bash hljs">nano /etc/nginx/sites-enabled/000-ispconfig.vhost</code> </pre> <br><br><pre> <code class="bash hljs">location /phpmyadmin { root /usr/share/; index index.php index.html index.htm; location ~ ^/phpmyadmin/(.+\.php)$ { try_files <span class="hljs-variable"><span class="hljs-variable">$uri</span></span> =404; root /usr/share/; include /etc/nginx/fastcgi_params; fastcgi_pass unix:/var/lib/php5-fpm/ispconfig.sock; fastcgi_param HTTPS on; fastcgi_index index.php; fastcgi_param SCRIPT_FILENAME <span class="hljs-variable"><span class="hljs-variable">$request_filename</span></span>; } location ~* ^/phpmyadmin/(.+\.(jpg|jpeg|gif|css|png|js|ico|html|xml|txt))$ { root /usr/share/; } } location /phpMyAdmin { rewrite ^/* /phpmyadmin last; }</code> </pre> <br><br><pre> <code class="bash hljs"> /etc/init.d/nginx reload</code> </pre> <br><br><h4>  Setting app01.local environment (apache2 + php-fpm) </h4><br><br>  You need to create an OpenVZ (New CT) container with the CentOS 64 environment. This virtual machine will serve our sites written in php.  In general, apache2 is much slower than nginx gives static files (graphics, scripts, styles, etc.), and in combination with mod_php it also spends a lot of memory on serving incoming requests.  This is due to the apache2 architecture itself.  If the problem of memory consumption can be defeated using php-fpm, then with the slow static we can only accept and partially compensate for this with the cache on the nginx side in front.local. <br>  It makes sense to use apache2 only when it is necessary to use .htaccess or modules specific only apache2. <br>  For this virtual machine, the ssh port is forwarded from the service public address, port 80 is proxied from our front.local <br><br>  This container will have an address in a private network ( <b>vmbr1</b> ) <b>192.168.8.4</b> , saving on RAM for this virtual machine is not worth it, in general, I put from 4 to 20 GB. <br><br>  <b># Network settings for this container:</b> <br><br><pre> <code class="bash hljs">vi /etc/sysconfig/network-scripts/ifcfg-eth1</code> </pre> <br><br><pre> <code class="bash hljs">DEVICE=eth1 BOOTPROTO=static ONBOOT=yes IPADDR=192.168.8.4 NETWORK=192.168.8.0 GATEWAY=192.168.8.100</code> </pre> <br><br>  <b># Install the web server components</b> <br><br><pre> <code class="bash hljs">yum install mod_rpaf memcached ntp httpd php php-mysql php-mbstring php-mcrypt rpm-build openssl-devel cyrus-sasl-devel pkgconfig zlib-devel pcre-devel openldap-devel postgresql-devel expect libtool-ltdl-devel openldap-servers libtool gdbm-devel pam-devel gamin-devel mod_ssl php-fpm php-cli php-gd php-imap php-ldap php-odbc php-pear php-xml php-xmlrpc php-pecl-apc php-magpierss php-snmp php-tidy spawn-fcgi openssl perl-TimeDate httpd-devel ruby ruby-devel webalizer perl-DateTime-Format-HTTP perl-DateTime-Format-Builder perl-TimeDate libevent-devel php-pecl-memcache mod_fcgid subversion git php-soap -y yum install --enablerepo=rpmforge mod_fastcgi mod_suphp -y</code> </pre> <br><br>  <b># Add services to autoload and run them</b> <br><br><pre> <code class="bash hljs">chkconfig --levels 235 php-fpm on &amp;&amp; /etc/init.d/php-fpm start chkconfig --levels 235 httpd on &amp;&amp; /etc/init.d/httpd start chkconfig --levels 235 memcached on &amp;&amp; /etc/init.d/memcached start</code> </pre> <br><br>  <b># To manually build php modules, install the developer components</b> <br><br><pre> <code class="bash hljs">yum groupinstall <span class="hljs-string"><span class="hljs-string">'Development Tools'</span></span> -y</code> </pre> <br><br>  <b># Minimal changes in php.ini</b> <br><br><pre> <code class="bash hljs">sed -i <span class="hljs-string"><span class="hljs-string">"s/^error_reporting =.*/error_reporting = E_ALL \&amp; \~E_NOTICE/g"</span></span> /etc/php.ini sed -i <span class="hljs-string"><span class="hljs-string">"s/^;cgi.fix_pathinfo =.*/cgi.fix_pathinfo = 1/g"</span></span> /etc/php.ini sed -i <span class="hljs-string"><span class="hljs-string">"s/^;date.timezone =.*/date.timezone = Europe\/Moscow/g"</span></span> /etc/php.ini sed -i <span class="hljs-string"><span class="hljs-string">"s/^max_execution_time =.*/max_execution_time = 600/g"</span></span> /etc/php.ini sed -i <span class="hljs-string"><span class="hljs-string">"s/^max_input_time =.*/max_input_time = 600/g"</span></span> /etc/php.ini sed -i <span class="hljs-string"><span class="hljs-string">"s/^memory_limit =.*/memory_limit = 512M/g"</span></span> /etc/php.ini sed -i <span class="hljs-string"><span class="hljs-string">"s/^post_max_size =.*/post_max_size = 500M/g"</span></span> /etc/php.ini sed -i <span class="hljs-string"><span class="hljs-string">"s/^upload_max_filesize =.*/upload_max_filesize = 2000M/g"</span></span> /etc/php.ini sed -i <span class="hljs-string"><span class="hljs-string">"s/^max_file_uploads =.*/max_file_uploads = 200/g"</span></span> /etc/php.ini sed -i <span class="hljs-string"><span class="hljs-string">"s/^short_open_tag =.*/short_open_tag = On/g"</span></span> /etc/php.ini sed -i <span class="hljs-string"><span class="hljs-string">"s/^upload_max_filesize =.*/upload_max_filesize = 500M/g"</span></span> /etc/php.ini sed -i <span class="hljs-string"><span class="hljs-string">"s/;realpath_cache_size =.*/realpath_cache_size = 4096k/g"</span></span> /etc/php.ini</code> </pre> <br><br>  <b># Building the xdebug module (useful for debugging code and identifying problems)</b> <br><br><pre> <code class="bash hljs">yum install php-devel php-pear pecl install Xdebug</code> </pre> <br><br><pre> <code class="bash hljs">nano /etc/php.d/xdebug.ini</code> </pre> <br><br><pre> <code class="bash hljs">[xdebug] zend_extension=<span class="hljs-string"><span class="hljs-string">"/usr/lib64/php/modules/xdebug.so"</span></span> xdebug.remote_enable = 1</code> </pre> <br><br><pre> <code class="bash hljs">php -v</code> </pre> <br><br><pre> <code class="bash hljs">No <span class="hljs-built_in"><span class="hljs-built_in">log</span></span> handling enabled - turning on stderr logging Created directory: /var/lib/net-snmp/mib_indexes PHP 5.4.24 (cli) (built: Jan 13 2014 12:36:47) Copyright (c) 1997-2013 The PHP Group Zend Engine v2.4.0, Copyright (c) 1998-2013 Zend Technologies with Xdebug v2.2.3, Copyright (c) 2002-2013, by Derick Retha</code> </pre> <br><br>  <b># Install the php module - Zend Guard</b> <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /usr/src/ &amp;&amp; wget wget http://downloads.zend.com/guard/6.0.0/ZendGuardLoader-70429-PHP-5.4-linux-glibc23-x86_64.tar.gz tar xzvf ZendGuardLoader-7* -C /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/ chmod -R 755 /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/ZendGuardLoader-70429-PHP-5.4-linux-glibc23-x86_64/ mv /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/ZendGuardLoader-70429-PHP-5.4-linux-glibc23-x86_64/ /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/Zend</code> </pre> <br><br><pre> <code class="bash hljs">nano /etc/php.d/zend.ini</code> </pre> <br><br><pre> <code class="bash hljs">zend_extension=/usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/Zend/php-5.4.x/ZendGuardLoader.so</code> </pre> <br><br><pre> <code class="bash hljs">php -v</code> </pre> <br><br><pre> <code class="bash hljs">PHP 5.4.24 (cli) (built: Jan 13 2014 12:36:47) Copyright (c) 1997-2013 The PHP Group Zend Engine v2.4.0, Copyright (c) 1998-2013 Zend Technologies with Xdebug v2.2.3, Copyright (c) 2002-2013, by Derick Rethans with Zend Guard Loader v3.3, Copyright (c) 1998-2013, by Zend Technologies</code> </pre> <br><br>  <b># Enable the opcode caching module for php - apc</b> <br><br><pre> <code class="bash hljs">sed -i <span class="hljs-string"><span class="hljs-string">"s/^apc.enabled=.*/apc.enabled=1/g"</span></span> /etc/php.d/apc.ini sed -i <span class="hljs-string"><span class="hljs-string">"s/^apc.shm_size=.*/apc.shm_size=256M/g"</span></span> /etc/php.d/apc.ini sed -i <span class="hljs-string"><span class="hljs-string">"s/;apc.num_files_hint=.*/apc.num_files_hint=20000/g"</span></span> /etc/php.d/apc.ini sed -i <span class="hljs-string"><span class="hljs-string">"s/;apc.user_entries_hint=.*/apc.user_entries_hint=20000/g"</span></span> /etc/php.d/apc.ini sed -i <span class="hljs-string"><span class="hljs-string">"s/;apc.ttl=.*/apc.ttl=86400/g"</span></span> /etc/php.d/apc.ini sed -i <span class="hljs-string"><span class="hljs-string">"s/;apc.user_ttl=.*/apc.user_ttl=7200/g"</span></span> /etc/php.d/apc.ini sed -i <span class="hljs-string"><span class="hljs-string">"s/;apc.gc_ttl=.*/apc.gc_ttl=86400/g"</span></span> /etc/php.d/apc.ini sed -i <span class="hljs-string"><span class="hljs-string">"s/;apc.cache_by_default=.*/apc.cache_by_default=1/g"</span></span> /etc/php.d/apc.ini sed -i <span class="hljs-string"><span class="hljs-string">"s/;apc.max_file_size=.*/apc.max_file_size=10M/g"</span></span> /etc/php.d/apc.ini</code> </pre> <br><br>  <b># Configure the suphp module</b> <br><br><pre> <code class="bash hljs">mkdir -p /root/backup/etc mv /etc/httpd/conf.d/suphp.conf /root/backup/ &amp;&amp; nano /etc/httpd/conf.d/suphp.conf</code> </pre> <br><br><pre> <code class="bash hljs">LoadModule suphp_module modules/mod_suphp.so suPHP_Engine on suPHP_ConfigPath /etc/suphp.conf</code> </pre> <br><br><pre> <code class="bash hljs">mv /etc/suphp.conf /root/backup/etcsuphp.conf &amp;&amp; nano /etc/suphp.conf</code> </pre> <br><br><pre> <code class="bash hljs">[global] ;Path to logfile logfile=/var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/httpd/suphp.log ;Loglevel loglevel=info ;User Apache is running as webserver_user=apache ;Path all scripts have to be <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> docroot=/ ;Path to chroot() to before executing script ;chroot=/mychroot ; Security options allow_file_group_writeable=<span class="hljs-literal"><span class="hljs-literal">true</span></span> allow_file_others_writeable=<span class="hljs-literal"><span class="hljs-literal">false</span></span> allow_directory_group_writeable=<span class="hljs-literal"><span class="hljs-literal">true</span></span> allow_directory_others_writeable=<span class="hljs-literal"><span class="hljs-literal">false</span></span> ;Check wheter script is within DOCUMENT_ROOT check_vhost_docroot=<span class="hljs-literal"><span class="hljs-literal">true</span></span> ;Send minor error messages to browser errors_to_browser=<span class="hljs-literal"><span class="hljs-literal">false</span></span> ;PATH environment variable env_path=/bin:/usr/bin ;Umask to <span class="hljs-built_in"><span class="hljs-built_in">set</span></span>, specify <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> octal notation <span class="hljs-built_in"><span class="hljs-built_in">umask</span></span>=0077 ; Minimum UID min_uid=100 ; Minimum GID min_gid=100 [handlers] ;Handler <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> php-scripts x-httpd-suphp=<span class="hljs-string"><span class="hljs-string">"php:/usr/bin/php-cgi"</span></span> ;Handler <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> CGI-scripts x-suphp-cgi=<span class="hljs-string"><span class="hljs-string">"execute:!self"</span></span></code> </pre> <br><br>  <b># Configure mod_rpaf, the third address is the public web address of our server</b> <br><br><pre> <code class="bash hljs">nano /etc/httpd/conf.d/mod_rpaf.conf</code> </pre> <br><br><pre> <code class="bash hljs">&lt;IfModule mod_rpaf.c&gt; RPAF_Enable On RPAF_ProxyIPs 127.0.0.1 192.168.8.2 *.*.*.237 RPAF_Header X-Forwarded-For RPAF_SetHostName On RPAF_SetHTTPS On RPAF_SetPort On &lt;/IfModule&gt;</code> </pre> <br><br>  <b># Turn off FastCgiWrapper</b> <br><br><pre> <code class="bash hljs">nano /etc/httpd/conf.d/fastcgi.conf</code> </pre> <br><br><pre> <code class="bash hljs">sed -i <span class="hljs-string"><span class="hljs-string">"s/^FastCgiWrapper .*/FastCgiWrapper Off/g"</span></span> /etc/httpd/conf.d/fastcgi.conf</code> </pre> <br><br>  <b># Install ISPConfig</b> <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /usr/src/ wget http://www.ispconfig.org/downloads/ISPConfig-3-stable.tar.gz tar xfz ISPConfig-3-stable.tar.gz <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ispconfig3_install/install/ php -q install.php</code> </pre> <br><br>  <b># Answering the questions of the interactive installation wizard</b> <br><br><blockquote>  &gt;&gt; Initial configuration <br><br>  Operating System: Redhat or compatible, unknown version. <br><br>  If so, be careful. <br>  Default values ‚Äã‚Äãare in [brackets] and can be accepted with. <br>  Tap in "quit" (without the quotes) to stop the installer. <br><br>  Select language (en, de) [ <b>en</b> ]: <br><br>  Installation mode (standard, expert) [standard]: <b>expert</b> <br><br>  Full qualified hostname (FQDN) of the server, eg server1.domain.tld [ <b>app01.local</b> ]: <br><br>  MySQL server hostname [ <b>localhost</b> ]: <br><br>  MySQL root username [ <b>root</b> ]: <br><br>  MySQL root password []: <br><br>  MySQL database to create [ <b>dbispconfig</b> ]: <br><br>  MySQL charset [ <b>utf8</b> ]: <br><br>  The next two questions are about the internal ISPConfig database user and password. <br>  It is recommended to accept the defaults which are 'ispconfig' as username and random password. <br>  If you use the password <br><br>  ISPConfig mysql database username [ <b>ispconfig</b> ]: <br><br>  ISPConfig mysql database password [ <b>8b8295ae2a50a39a1a00da65df0bee72</b> ]: <br><br>  Shall this server join an existing ISPConfig multiserver setup (y, n) [n]: <b>y</b> <br><br>  MySQL master server hostname []: <b>isp.local</b> <br><br>  MySQL master server root username [ <b>root</b> ]: <br><br>  MySQL master server root password []: <b>c2HZqsMmiBKa</b> <br><br>  MySQL master server database name [ <b>dbispconfig</b> ]: <br><br>  Adding ISPConfig server record to database. <br><br>  Configure Mail (y, n) [y]: <b>n</b> <br><br>  Configure Jailkit (y, n) [y]: <b>n</b> <br><br>  Configure FTP Server (y, n) [y]: <b>y</b> <br><br>  Configuring Pureftpd <br>  Stopping pure-ftpd: [OK] <br>  Starting pure-ftpd: [OK] <br>  Configure DNS Server (y, n) [y]: <b>n</b> <br><br>  Hint: If this is the ISPConfig interface, select the 'y' in the 'Configure Apache Server' option. <br><br>  Configure Apache Server (y, n) [y]: <b>y</b> <br>  Configuring apache <br>  Configuring Vlogger <br>  Configuring Apps vhost <br>  Configure Firewall Server (y, n) [y]: <b>y</b> <br><br>  Configuring Bastille Firewall <br>  Install ISPConfig Web Interface (y, n) [n]: <b>n</b> <br><br>  Configuring DBServer <br>  Installing ISPConfig crontab <br>  no crontab for root <br>  Stopping httpd: [OK] <br>  [Thu Jan 23 13:46:44 2014] [warn] NameVirtualHost *: 80 has no VirtualHosts <br>  [Thu Jan 23 13:46:44 2014] [warn] NameVirtualHost *: 443 has no VirtualHosts <br>  [Thu Jan 23 13:46:44 2014] [warn] NameVirtualHost *: 80 has no VirtualHosts <br>  Starting httpd: [OK] <br>  <b>Installation completed.</b> <br></blockquote><br><br><h4>  Setting environment db01. </h4><br><br>  It is necessary to create an OpenVZ (New CT) container with the CentOS 64 environment. This vitrual machine will have mariadb for our sites. <br>  I will only describe the addition of this node to the ISPConfig cluster.  I‚Äôll leave MySQL optimization questions for the following articles. <br><br>  This container will have an address in a private network ( <b>vmbr1</b> ) <b>192.168.8.5</b> , you should not save on the amount of RAM for the database server, in our case it will be <b>4</b> GB of RAM, but 20 GB will not be enough for serious tasks. <br><br>  This is how the network should look like in the container itself: <br><br><pre> <code class="bash hljs">vi /etc/sysconfig/network-scripts/ifcfg-eth1</code> </pre> <br><br><pre> <code class="bash hljs">DEVICE=eth1 BOOTPROTO=static ONBOOT=yes IPADDR=192.168.8.5 NETWORK=192.168.8.0 GATEWAY=192.168.8.100</code> </pre> <br><br>  <b># Install php components for ISPConfig panel</b> <br><br><pre> <code class="bash hljs">yum install php-mysql php -y</code> </pre> <br><br>  <b># Remove from startup and turn off apache2</b> <br><br><pre> <code class="bash hljs">chkconfig httpd off &amp;&amp; /etc/init.d/httpd stop</code> </pre> <br><br>  <b># Install ISPConfig</b> <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /usr/src/ wget http://www.ispconfig.org/downloads/ISPConfig-3-stable.tar.gz tar xfz ISPConfig-3-stable.tar.gz <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ispconfig3_install/install/ php -q install.php</code> </pre> <br><br>  <b># Answering the questions of the interactive installation wizard</b> <br><br><blockquote>  &gt;&gt; Initial configuration <br><br>  Operating System: Redhat or compatible, unknown version. <br><br>  If so, be careful. <br>  Default values ‚Äã‚Äãare in [brackets] and can be accepted with. <br>  Tap in "quit" (without the quotes) to stop the installer. <br><br>  Select language (en, de) [en]: <b>en</b> <br><br>  Installation mode (standard, expert) [standard]: <b>expert</b> <br><br>  Full qualified hostname (FQDN) of the server, eg server1.domain.tld [ <b>db01.local</b> ]: <br><br>  MySQL server hostname [ <b>localhost</b> ]: <br><br>  MySQL root username [ <b>root</b> ]: <br><br>  MySQL root password []: <br><br>  MySQL database to create [ <b>dbispconfig</b> ]: <br><br>  MySQL charset [ <b>utf8</b> ]: <br><br>  The next two questions are about the internal ISPConfig database user and password. <br>  It is recommended to accept the defaults which are 'ispconfig' as username and random password. <br>  If you use the password <br><br>  ISPConfig mysql database username [ <b>ispconfig</b> ]: <br><br>  ISPConfig mysql database password [ <b>06cd6c11370b50a83eb0a3d3907a3581</b> ]: <br><br>  Shall this server join an existing ISPConfig multiserver setup (y, n) [n]: <b>y</b> <br><br>  MySQL master server hostname []: <b>isp.local</b> <br><br>  MySQL master server root username [ <b>root</b> ]: <br><br>  MySQL master server root password []: <b>c2HZqsMmiBKa</b> <br><br>  MySQL master server database name [ <b>dbispconfig</b> ]: <br><br>  Adding ISPConfig server record to database. <br><br>  Configure Mail (y, n) [y]: <b>n</b> <br><br>  Configure Jailkit (y, n) [y]: <b>n</b> <br><br>  Configure FTP Server (y, n) [y]: <b>n</b> <br><br>  Configure DNS Server (y, n) [y]: <b>n</b> <br><br>  Hint: If this is the ISPConfig interface, select the 'y' in the 'Configure Apache Server' option. <br><br>  Configure Apache Server (y, n) [y]: <b>n</b> <br><br>  Configure Firewall Server (y, n) [y]: <b>y</b> <br><br>  Configuring Bastille Firewall <br>  Install ISPConfig Web Interface (y, n) [n]: <b>n</b> <br><br>  Configuring DBServer <br>  Installing ISPConfig crontab <br>  no crontab for root <br>  Stopping httpd: [FAILED] <br>  Starting httpd: [OK] <br>  <b>Installation completed.</b> <br></blockquote><br><br><h5>  Introduction to ISPConfig: </h5><br><br>  After logging in to the ISPConfig web panel, you are taken to the start page: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/1dd/eb4/4b8/1ddeb44b86ed6e83557e7d2800e91d6a.png"><br><br>  <b>Tools</b> - <b>Password and Language</b> , change the language and create a strong password to access the control panel. <br><br>  <b>System</b> - <b>Server services</b> , remove extra roles for servers. <br>  I want to draw your attention to the fact that ISPConfig can make a separate node a mirror of another.  Those.  You will have the same configuration of services and users on multiple servers simultaneously.  You need to choose which of the nodes is a mirror in the <b>Server Mirror</b> <br><br>  <b>Server configuration</b> - in each server in the <b>server</b> section we set <b>Loglevel</b> to Debug.  Now we can view all the actions that ISPConfig performs on the nodes of our cluster <br><br><pre> <code class="bash hljs">tail -f -n 1000 /var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/ispconfig/ispconfig.log</code> </pre> <br>  There is also a <b>Web</b> section in the <b>Server Configuration,</b> there are <b>Permissions</b> in it, if you have several web server mirrors on the same file storage (ceph, ocfs2, etc.), you need to check the <b>Set folder permissions on update</b> <b>checkbox</b> and <b>Connect Linux userid to webid</b> .  This will avoid problems with the distinction of guid / uid and users and groups and their names / groups on different mirrors.  If you want to change the folder structure of your users, then uncheck the <b>Make web folders immutable (extended attributes)</b> box.  If you forget to do this, the <b>chattr -i command</b> will come to your rescue.  The next important section: <b>Rescue</b> , enable the automatic launch of important services if they fail, but do not forget to disable the restart of those services that should not be restarted. <br><br>  Let's create a test user: <b>Client</b> - <b>Add Client</b> , <b>Address</b> , Be sure to fill in the <b>Contact Person</b> , <b>Login</b> and <b>Password</b> (there is a convenient password generator right there).  Next in <b>Limits</b> : select the <b>default Web-server</b> and allowed modes of the web-server: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/dfd/503/8c7/dfd5038c7cd2440bd758d6c48fc15ec7.png"><br>  We configured app01.local to support php-fpm and mod_php at the same time.  We return to the list of clients and enter the newly created: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/a05/d4b/823/a05d4b823c115458c40f771d661433f6.png"><br>  <b>Sites</b> - <b>Add a new website</b> <br><br><img src="https://habrastorage.org/getpro/habr/post_images/c9b/b5c/cdc/c9bb5ccdce1942def51541a393e6c4b7.png"><br>  Specify the site name and the required php backend. <br><br>  Note that ISPConfig in a cluster configuration takes time to propagate all changes. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/c75/e25/98f/c75e2598fc009b9c4c87f1c7bf1af679.png"><br><br>  As a means of accessing the files of our sites, we will use <b>ssh</b> , under windows it is convenient to use <a href="http://winscp.net/eng/download.php">WinSCP</a> .  This method is much safer than traditional FTP. <br>  To access, we need to create an SSH user, in the <b>User Shell</b> section. <br>  You need to specify a username, password and, if necessary, a key.  Please note that your account is prefixed with your account in your personal account of ISPConfig. <br><br>  To work with MySQL, you need to create its user in the <b>Database users</b> section, your ID is added to the login in the ISPConfig system. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/95d/4c0/083/95d4c0083167a65be81ff6d53abd933e.png"><br><br>  Create a database for one of our sites in the <b>Database</b> section, you must specify the name of the new database, do not forget to specify the site to which this database belongs, select the newly created user and put a tick <b>Remote access</b> (our database server is a remote server in relation to the application server).  Do not forget that the prefix is ‚Äã‚Äãadded to the name. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/54b/a92/236/54ba92236ed55ad4d67c0389d510ea55.png"><br><br>  To access phpMyAdmin, you can click on the corresponding icon next to any database in the <b>Database</b> section <b>.</b> <br><br><img src="https://habrastorage.org/getpro/habr/post_images/61b/bef/c26/61bbefc261cf82d6b09a527f85d16a29.png"><br><br>  and find ourselves in phpMyAdmin <br><br><img src="https://habrastorage.org/getpro/habr/post_images/b08/307/677/b08307677760c3421495495ca1e0dd6b.png"><br><br><h5>  The final </h5><br><br>  <b>app01.local</b> where our sites live are available in the public service network on port <b>22</b> .    <b>WinSCP</b>    ,     : <br><br><img src="https://habrastorage.org/getpro/habr/post_images/01f/66d/af1/01f66daf18a9b4fb708d785459b95899.png"><br><br> ,       <b>web</b> <br><br><img src="https://habrastorage.org/getpro/habr/post_images/2a9/17d/8e0/2a917d8e0251351a544ad79fe8c7b2ee.png"><br><br>   <b>index.html</b>   <b>index.php</b> <br><br><pre> <code class="bash hljs">&lt;?php //   ,   INFO_ALL phpinfo(); //      . // phpinfo(8)    . phpinfo(INFO_MODULES); ?&gt;</code> </pre> <br><br> ,    php-fpm/mod_php      <br><br><img src="https://habrastorage.org/getpro/habr/post_images/b30/392/bde/b30392bdee66ba329ff439561f5755ad.png"><br><br><img src="https://habrastorage.org/getpro/habr/post_images/b74/71a/74d/b7471a74d552287eda7505f039d7b208.png"><br><br> <b>    ,    : <br>    <a href="http://habrahabr.ru/users/sycraft/"></a></b> </div><p>Source: <a href="https://habr.com/ru/post/209934/">https://habr.com/ru/post/209934/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../209922/index.html">Designer review Android 4.4 KitKat. Part 1</a></li>
<li><a href="../209924/index.html">Burn after reading</a></li>
<li><a href="../209926/index.html">New beta Yandex. Browser 14.2: improved download manager and view office documents</a></li>
<li><a href="../209928/index.html">The main events of 2013 through the eyes of Chris Graft (Kris Graft), editor in chief of Gamasutra</a></li>
<li><a href="../209932/index.html">Testing Stored Functions with pgTAP</a></li>
<li><a href="../209936/index.html">Deep immersion in test-driven javascript</a></li>
<li><a href="../209940/index.html">Intel Quark. Better late than never</a></li>
<li><a href="../209944/index.html">Who is who: Smart watches</a></li>
<li><a href="../209946/index.html">Bitcoin cryptocurrency began to take in Las Vegas</a></li>
<li><a href="../209948/index.html">Performance testing and OpenStack profiling</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>