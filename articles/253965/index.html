<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Another smart home, in three parts. Part two, software and server. + Bonus</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the first part, I talked about the iron part. Now it is time to talk about the software. 

 So, in the beginning there was a word. There was a four...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Another smart home, in three parts. Part two, software and server. + Bonus</h1><div class="post__text post__text-html js-mediator-article">  In the <a href="http://habrahabr.ru/post/253505/">first part,</a> I talked about the iron part.  Now it is time to talk about the software. <br><br>  So, in the beginning <s>there was a word. There</s> was a four-channel light switch, with different sensors connected to it.  The physical interface is RS485.  Over RS485 implemented a simplified version of MODBUS ASCII.  Implemented only functions 03 and 06, in contrast to the standard addressing of byte registers starts from zero.  Plus, added support for broadcast messages, the answer to which is not issued.  They set the time, or all outputs are disabled.  Through the RS485 adapter - RS232 controller was connected to the COM port. <br><a name="habracut"></a><br>  In those days, smartphones, tablets, and uniformity did not exist in browsers, so the very first version of the control program was for a regular PC.  Here is this: <br><br><h3>  Option 1: PC + Windows </h3><br><img src="https://habrastorage.org/files/390/8e8/7a4/3908e87a4a674b9ba5cf593b5a0f71f0.png" alt="image">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Everything was written in Delphi, a lot of buttons, a lot of digits, everything works, but there is one thing - why should I, at home, turn on the lights at home through a computer?  Unclear.  Therefore, the development of a network version has begun.  And it turned out: <br><br><h3>  Option 2: PC + Windows + Internet </h3><br>  A small service was written that worked as a gateway between the Internet and the internal instrument network.  The program has been finalized to work on the network.  Everything is good, everything works, but there is one thing - why should you always carry a laptop or USB flash drive with the program to turn on the lights at home?  Unclear.  Therefore, further development continued.  And it turned out: <br><br><h3>  Option 3: PC + Windows + Internet + Mobile Phone </h3><br><img src="https://habrastorage.org/files/c04/230/47b/c0423047b50943e0b30ebfdcb89775bf.png" alt="image"><br><br>  In those old times, smartphones were a rarity, browsers on mobile phones could do almost nothing, the maximum that could be calculated - J2ME.  As an experiment, an ICQ client was added to the server part, and one of the many useful clients was also installed on the mobile phone.  Everything worked, but every time <s>saying ‚ÄúOK, Google‚Äù</s> to write on the telephone keypad ‚ÄúHome, turn on the lights in the hallway and show me the state of the other lamps and sensors‚Äù was not very comfortable.  Therefore, the development of a J2ME application began, on the basic ideas of which one of the interfaces is now based.  The bottom line was that there were several tabs or screens, each of which corresponded to one controller.  Everything worked, everything was fine, but the next one appeared - the progress did not stand still, the browsers from the programs for displaying pages with pictures learned a lot more.  And to keep three branches in parallel - Win32, J2ME and Web - was too lazy.  Yes, and smartphones with tablets briskly walked around the planet.  Therefore, the development continued and resulted in the final today: <br><br><h3>  Option 4: LAMP + Internet + Web </h3><br>  In the client part, it was decided not to spray on different technologies, but to leave only one - HTML + JS.  Fortunately, mobile and desktop browsers have learned to do a lot and most importantly - in the same way. <br><br>  The ideology of the entire system was completely revised, if earlier the server part was just a gateway between the hardware and the application, now several additional tasks have appeared: <br><br><ul><li>  Clients (either a script in a router or a gateway) periodically send their address to the server at which the server will work with them later.  Kind of dyndns </li><li>  Once an hour, the server synchronizes the time on all controllers, since there is no real-time clock in them, but there is only software </li><li>  Once a minute, the server polls all controllers and writes answers to the database. </li></ul><br><br>  Also in the settings you can set the parameters, when changing which the server sent the letter, and recorded the event in the log.  Having a base with accumulated values, you can build different graphs - temperature, for example, or voltage, or power consumption. <br><br>  All this worked in my home, first in the Asus WL-500gP V2 router, interchanged with the firmware <a href="http://wl500g.info/forum.php">‚Äúfrom Oleg and enthusiasts‚Äù</a> on which Lighttpd + PHP5 + MySQL were installed.  A USB-RS232 adapter was connected to the router and ser2net was configured.  The database stores settings and logs, admin and services are written in PHP.  Then the Ethernet-RS485 gateway was developed, and it all moved to one of the cloud hosting sites. <br><br><h3>  Bonus </h3><br>  Since there were a lot of pictures in the last part, I decided to tell about one of the projects in this part.  At the same time we will consider the problems of scalability and the difference between wired and wireless interfaces, about which there was a lot of controversy in the last part.  The project is important, but, unfortunately, with vague prospects.  So, let's begin. <br><br>  Suppose there is a plot.  It has several lighting zones, such as the entrance, the path, the parking lot.  Separately - the gate with an electric lock, and the entrance gate with electric drive.  There is a garage so as not to waste your time on trifles - two floors, two lighting zones on each, and with separate heating.  There is video surveillance and internet. <br><br>  On the first floor are installed: <br><br><img src="https://habrastorage.org/files/25a/609/0bb/25a6090bbb92428b8c5235c4a78b668b.jpg" alt="image"><br><br>  Above - a lighting and heating controller for the 1st floor, an RCD and a circuit breaker with an independent release.  The second row is a power protection controller with a 100A relay, a 12V power supply from the bottom and an on-site lighting controller.  At the very bottom is a two-channel receiver, which, through the lighting controller, allows you to turn on the light at the entrance and open the gate lock while on the street. <br><br>  On the second floor: <br><br><img src="https://habrastorage.org/files/27f/03d/88b/27f03d88ba1940a98afcd12bb1d80248.jpg" alt="image"><br><br>  Top - electronics from the window air conditioner, it is in itself.  The second row is the Ethernet-RS485 gateway, from the bottom - the second floor lighting and heating controller and power relays for convectors. <br><br>  Temperature sensors indoors and coolant temperature (air from the convector in this case): <br><br><img src="https://habrastorage.org/files/a20/507/c69/a20507c694064d7189e4a525b180f820.jpg" alt="image"><br><br>  In the attic - air conditioning, video recorders, routers, antennas, fashion, and more: <br><br><img src="https://habrastorage.org/files/cfe/53a/72a/cfe53a72a8d440f9b3c8c017cd913236.jpg" alt="image"><br><br>  All this worked well for the winter, spring came, and after it summer.  And in the summer that the main thing?  Brazier, gazebo and watering.  A pit was dug, water valves were diluted in it: <br><br><img src="https://habrastorage.org/files/c3f/75e/e52/c3f75ee52fb1465ab6f175fa26cf9372.jpg" alt="image"><br><br>  On the left - filter, inlet pressure sensor, water flow sensor.  In the center there is a leakage sensor, on the right there are two irrigation valves, a pressure reduction gearbox and a pressure sensor downstream of the gearbox.  Two controllers are installed - arbor lighting and water supply.  In the arbor itself there are two zones - decorative lighting and main light: <br><br><img src="https://habrastorage.org/files/af4/bf2/d04/af4bf2d047d6475599c62d46efe11824.jpg" alt="image"><br><br>  In the box above, there is an arbor lighting controller, in the center is a 24V power supply for valves and a water supply controller. <br><br>  It turned out something like this - the second floor of the garage and a gazebo: <br><br><img src="https://habrastorage.org/files/787/d6d/a66/787d6da6677848f9aefae557034db3d1.jpg" alt="image"><br><br>  Between the pit and the rest of the controllers - about 15 meters, a wall of 30cm of aerated concrete and 10cm of the ceiling of the pit of reinforced screed.  Wireless sensors and switches?  No thanks.  A 3x4 power cable and a 4x0.22 signal cable are stretched, connected to the power shield - and everything, there is light, watering, everything is controlled and shows the status of the sensors.  As for me - no problems with scalability, nor with the lack of wireless technology. <br><br>  With the software-server part on it all, in the next part I will describe the most interesting - the user interface. </div><p>Source: <a href="https://habr.com/ru/post/253965/">https://habr.com/ru/post/253965/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../253949/index.html">Lenovo and IBM x86: what to expect in the near future?</a></li>
<li><a href="../253953/index.html">The era of phablets: Designing for large screens</a></li>
<li><a href="../253957/index.html">How to make a lightbirder based on Arduino</a></li>
<li><a href="../253959/index.html">How we built a new School of Managers Stratoplan: an invitation to a presentation</a></li>
<li><a href="../253961/index.html">Device and operation of input / output ports of AVR microcontrollers. Part 2</a></li>
<li><a href="../253967/index.html">Swedish data center with zero environmental impact will heat local households</a></li>
<li><a href="../253969/index.html">Search Engine Optimization for AppStore and Google Play or ASO</a></li>
<li><a href="../253973/index.html">Snacks from the new PHPixie Template</a></li>
<li><a href="../253979/index.html">Igor Ashmanov about the future of home robots. Home robots: on the eve of a tornado</a></li>
<li><a href="../253981/index.html">Gauss electromagnetic gun on a microcontroller</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>