<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Experiments on the Olympiad problem</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="It so happened that I got into the magistracy, and as it was walking past the department, the 1C Olympiad challenge came across. Briefly, the task is:...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Experiments on the Olympiad problem</h1><div class="post__text post__text-html js-mediator-article">  It so happened that I got into the magistracy, and as it was walking past the department, the 1C Olympiad challenge came across.  Briefly, the task is: ‚ÄúThere are sales records for each day, you need to find the largest period when the plan was executed.‚Äù  And then when I was walking with a sleeping daughter, I had a question, and how many ways it can be done in SQL.  Solutions will be based on MS SQL. <br><a name="habracut"></a><br>  Create a table and begin <br><br><div class="spoiler">  <b class="spoiler_title">Text SQL script to create a table</b> <div class="spoiler_text"><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> [tmp].[forFindDate]( [<span class="hljs-built_in"><span class="hljs-built_in">date</span></span>] [datetime] <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>] [<span class="hljs-built_in"><span class="hljs-built_in">int</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> [PK_forFindDate] PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> CLUSTERED ( [<span class="hljs-built_in"><span class="hljs-built_in">date</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">ASC</span></span> )<span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> (PAD_INDEX = <span class="hljs-keyword"><span class="hljs-keyword">OFF</span></span>, STATISTICS_NORECOMPUTE = <span class="hljs-keyword"><span class="hljs-keyword">OFF</span></span>, IGNORE_DUP_KEY = <span class="hljs-keyword"><span class="hljs-keyword">OFF</span></span>, ALLOW_ROW_LOCKS = <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span>, ALLOW_PAGE_LOCKS = <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [PRIMARY] ) <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [PRIMARY] <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> [tmp].[forFindDate] ([<span class="hljs-built_in"><span class="hljs-built_in">date</span></span>], [<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>]) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-string"><span class="hljs-string">'20170401'</span></span>, <span class="hljs-number"><span class="hljs-number">10</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> [tmp].[forFindDate] ([<span class="hljs-built_in"><span class="hljs-built_in">date</span></span>], [<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>]) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-string"><span class="hljs-string">'20170402'</span></span>, <span class="hljs-number"><span class="hljs-number">20</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> [tmp].[forFindDate] ([<span class="hljs-built_in"><span class="hljs-built_in">date</span></span>], [<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>]) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-string"><span class="hljs-string">'20170403'</span></span>, <span class="hljs-number"><span class="hljs-number">20</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> [tmp].[forFindDate] ([<span class="hljs-built_in"><span class="hljs-built_in">date</span></span>], [<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>]) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-string"><span class="hljs-string">'20170404'</span></span>, <span class="hljs-number"><span class="hljs-number">20</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> [tmp].[forFindDate] ([<span class="hljs-built_in"><span class="hljs-built_in">date</span></span>], [<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>]) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-string"><span class="hljs-string">'20170405'</span></span>, <span class="hljs-number"><span class="hljs-number">10</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> [tmp].[forFindDate] ([<span class="hljs-built_in"><span class="hljs-built_in">date</span></span>], [<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>]) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-string"><span class="hljs-string">'20170406'</span></span>, <span class="hljs-number"><span class="hljs-number">10</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> [tmp].[forFindDate] ([<span class="hljs-built_in"><span class="hljs-built_in">date</span></span>], [<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>]) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-string"><span class="hljs-string">'20170407'</span></span>, <span class="hljs-number"><span class="hljs-number">30</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> [tmp].[forFindDate] ([<span class="hljs-built_in"><span class="hljs-built_in">date</span></span>], [<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>]) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-string"><span class="hljs-string">'20170408'</span></span>, <span class="hljs-number"><span class="hljs-number">36</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> [tmp].[forFindDate] ([<span class="hljs-built_in"><span class="hljs-built_in">date</span></span>], [<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>]) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-string"><span class="hljs-string">'20170409'</span></span>, <span class="hljs-number"><span class="hljs-number">35</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> [tmp].[forFindDate] ([<span class="hljs-built_in"><span class="hljs-built_in">date</span></span>], [<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>]) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-string"><span class="hljs-string">'20170410'</span></span>, <span class="hljs-number"><span class="hljs-number">30</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> [tmp].[forFindDate] ([<span class="hljs-built_in"><span class="hljs-built_in">date</span></span>], [<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>]) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-string"><span class="hljs-string">'20170411'</span></span>, <span class="hljs-number"><span class="hljs-number">30</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> [tmp].[forFindDate] ([<span class="hljs-built_in"><span class="hljs-built_in">date</span></span>], [<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>]) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-string"><span class="hljs-string">'20170412'</span></span>, <span class="hljs-number"><span class="hljs-number">20</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> [tmp].[forFindDate] ([<span class="hljs-built_in"><span class="hljs-built_in">date</span></span>], [<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>]) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-string"><span class="hljs-string">'20170413'</span></span>, <span class="hljs-number"><span class="hljs-number">10</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> [tmp].[forFindDate] ([<span class="hljs-built_in"><span class="hljs-built_in">date</span></span>], [<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>]) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-string"><span class="hljs-string">'20170414'</span></span>, <span class="hljs-number"><span class="hljs-number">40</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> [tmp].[forFindDate] ([<span class="hljs-built_in"><span class="hljs-built_in">date</span></span>], [<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>]) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-string"><span class="hljs-string">'20170415'</span></span>, <span class="hljs-number"><span class="hljs-number">40</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> [tmp].[forFindDate] ([<span class="hljs-built_in"><span class="hljs-built_in">date</span></span>], [<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>]) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-string"><span class="hljs-string">'20170416'</span></span>, <span class="hljs-number"><span class="hljs-number">10</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> [tmp].[forFindDate] ([<span class="hljs-built_in"><span class="hljs-built_in">date</span></span>], [<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>]) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-string"><span class="hljs-string">'20170417'</span></span>, <span class="hljs-number"><span class="hljs-number">50</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> [tmp].[forFindDate] ([<span class="hljs-built_in"><span class="hljs-built_in">date</span></span>], [<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>]) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-string"><span class="hljs-string">'20170418'</span></span>, <span class="hljs-number"><span class="hljs-number">52</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> [tmp].[forFindDate] ([<span class="hljs-built_in"><span class="hljs-built_in">date</span></span>], [<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>]) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-string"><span class="hljs-string">'20170419'</span></span>, <span class="hljs-number"><span class="hljs-number">53</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> [tmp].[forFindDate] ([<span class="hljs-built_in"><span class="hljs-built_in">date</span></span>], [<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>]) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-string"><span class="hljs-string">'20170420'</span></span>, <span class="hljs-number"><span class="hljs-number">53</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> [tmp].[forFindDate] ([<span class="hljs-built_in"><span class="hljs-built_in">date</span></span>], [<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>]) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-string"><span class="hljs-string">'20170421'</span></span>, <span class="hljs-number"><span class="hljs-number">50</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> [tmp].[forFindDate] ([<span class="hljs-built_in"><span class="hljs-built_in">date</span></span>], [<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>]) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-string"><span class="hljs-string">'20170422'</span></span>, <span class="hljs-number"><span class="hljs-number">51</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> [tmp].[forFindDate] ([<span class="hljs-built_in"><span class="hljs-built_in">date</span></span>], [<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>]) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-string"><span class="hljs-string">'20170423'</span></span>, <span class="hljs-number"><span class="hljs-number">52</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> [tmp].[forFindDate] ([<span class="hljs-built_in"><span class="hljs-built_in">date</span></span>], [<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>]) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-string"><span class="hljs-string">'20170424'</span></span>, <span class="hljs-number"><span class="hljs-number">50</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> [tmp].[forFindDate] ([<span class="hljs-built_in"><span class="hljs-built_in">date</span></span>], [<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>]) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-string"><span class="hljs-string">'20170425'</span></span>, <span class="hljs-number"><span class="hljs-number">50</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> [tmp].[forFindDate] ([<span class="hljs-built_in"><span class="hljs-built_in">date</span></span>], [<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>]) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-string"><span class="hljs-string">'20170426'</span></span>, <span class="hljs-number"><span class="hljs-number">50</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> [tmp].[forFindDate] ([<span class="hljs-built_in"><span class="hljs-built_in">date</span></span>], [<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>]) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-string"><span class="hljs-string">'20170427'</span></span>, <span class="hljs-number"><span class="hljs-number">10</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> [tmp].[forFindDate] ([<span class="hljs-built_in"><span class="hljs-built_in">date</span></span>], [<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>]) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-string"><span class="hljs-string">'20170428'</span></span>, <span class="hljs-number"><span class="hljs-number">10</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> [tmp].[forFindDate] ([<span class="hljs-built_in"><span class="hljs-built_in">date</span></span>], [<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>]) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-string"><span class="hljs-string">'20170429'</span></span>, <span class="hljs-number"><span class="hljs-number">10</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> [tmp].[forFindDate] ([<span class="hljs-built_in"><span class="hljs-built_in">date</span></span>], [<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>]) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-string"><span class="hljs-string">'20170430'</span></span>, <span class="hljs-number"><span class="hljs-number">10</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span></code> </pre> </div></div><br>  <b>The first way is</b> through joining oneself (via join). <br><br><div class="spoiler">  <b class="spoiler_title">Join SQL queries</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> @planValue <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> = <span class="hljs-number"><span class="hljs-number">15</span></span> <span class="hljs-comment"><span class="hljs-comment">--  left select top 1 '  ', BeginDate, DATEADD(Day, -1, EndDate) EndDate from (select s.date BeginDate, ISNULL(min(e.date), '20170501') EndDate from [tmp].[forFindDate] s left join [tmp].[forFindDate] e on s.date &lt; e.date and not e.value &gt; @planValue where s.value &gt; @planValue group by s.date) tmp order by DATEDIFF(day, BeginDate, EndDate) desc --       with ;with periodDate1 as( select s.date BeginDate, ISNULL(min(e.date), '20170501') EndDate from [tmp].[forFindDate] s left join [tmp].[forFindDate] e on s.date &lt; e.date and not e.value &gt; @planValue where s.value &gt; @planValue group by s.date ) select top 1 '   (with left)' title, BeginDate, DATEADD(Day, -1, EndDate) EndDate from periodDate1 order by DATEDIFF(day, BeginDate, EndDate) desc --  full ;with periodDate2 as( select s.date BeginDate, ISNULL(min(e.date), '20170501') EndDate from [tmp].[forFindDate] s full join [tmp].[forFindDate] e on s.date &lt; e.date and not e.value &gt; @planValue where s.value &gt; @planValue group by s.date ) select top 1 '   (with full)' title, BeginDate, DATEADD(Day, -1, EndDate) EndDate from periodDate2 order by DATEDIFF(day, BeginDate, EndDate) desc --  right ;with periodDate3 as( select ISNULL(max(s.date), '20170401') BeginDate, e.date EndDate from [tmp].[forFindDate] s right join [tmp].[forFindDate] e on s.date &lt; e.date and not s.value &gt; @planValue where e.value &gt; @planValue group by e.date ) select top 1 '   (with right)' title, DATEADD(Day, 1, BeginDate) BeginDate, EndDate from periodDate3 order by DATEDIFF(day, BeginDate, EndDate) desc</span></span></code> </pre></div></div><br>  And for any join, we get exactly the same plan (via NESTED LOOP (left outer join)). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <div class="spoiler">  <b class="spoiler_title">Join execution plans</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/7c5/25f/612/7c525f612b1e47319d27298e7ed1ef80.png"><br><img src="https://habrastorage.org/files/e32/75a/a65/e3275aa650ae475ba8beea4578141da0.png"><br><img src="https://habrastorage.org/files/233/b0c/b5e/233b0cb5e05443c2add0194b709134d0.png"><br><img src="https://habrastorage.org/files/8c3/187/cff/8c3187cff5994ab18c8a6916eb5158d4.png"><br></div></div><br>  <b>The second way</b> through the correlation query <br><br><div class="spoiler">  <b class="spoiler_title">SQL queries via correlation query</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> @planValue <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> = <span class="hljs-number"><span class="hljs-number">15</span></span> ;<span class="hljs-keyword"><span class="hljs-keyword">with</span></span> periodDate4 <span class="hljs-keyword"><span class="hljs-keyword">as</span></span>( <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> s.date BeginDate, <span class="hljs-keyword"><span class="hljs-keyword">ISNULL</span></span>((<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DATEADD</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">DAY</span></span>, <span class="hljs-number"><span class="hljs-number">-1</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">isNull</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">min</span></span>(d.date), <span class="hljs-string"><span class="hljs-string">'20170501'</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> [tmp].[forFindDate] d <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> d.date &gt; s.date <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> d.value &gt; @planValue), <span class="hljs-string"><span class="hljs-string">'20170501'</span></span>) EndDate <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> [tmp].[forFindDate] s <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> s.value &gt; @planValue ) <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> top <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-string"><span class="hljs-string">' '</span></span>, p.BeginDate, p.EndDate <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> periodDate4 p <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DATEDIFF</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">DAY</span></span>, p.BeginDate, p.EndDate) <span class="hljs-keyword"><span class="hljs-keyword">desc</span></span></code> </pre></div></div><br>  In this case, we get the NESTED LOOP (inner join)). <br><br><div class="spoiler">  <b class="spoiler_title">Correlation Query Execution Plans</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/e93/01b/45f/e9301b45ffd44e718c59cee4e85cb24b.png"><br></div></div><br>  <b>The third way</b> is still not interesting, now let's take the function APPLY (appeared in MS SQL 2005).  In fact, for each line we will do on request. <br><br><div class="spoiler">  <b class="spoiler_title">SQL queries via outer apply</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> @planValue <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> = <span class="hljs-number"><span class="hljs-number">15</span></span> ;<span class="hljs-keyword"><span class="hljs-keyword">with</span></span> periodDate5 <span class="hljs-keyword"><span class="hljs-keyword">as</span></span>( <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> s.date BeginDate, <span class="hljs-keyword"><span class="hljs-keyword">ISNULL</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">min</span></span>(e.date), <span class="hljs-string"><span class="hljs-string">'20170501'</span></span>) EndDate <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> [tmp].[forFindDate] s <span class="hljs-keyword"><span class="hljs-keyword">outer</span></span> <span class="hljs-keyword"><span class="hljs-keyword">apply</span></span> ( <span class="hljs-comment"><span class="hljs-comment">--   (  ) select top 1 ee.date from [tmp].[forFindDate] ee where s.date &lt; ee.date and not ee.value &gt; @planValue ) e where s.value &gt; @planValue group by s.date ) select top 1 'sql 2005 apply' title, BeginDate, DATEADD(Day, -1, EndDate) EndDate from periodDate5 order by DATEDIFF(day, BeginDate, EndDate) desc</span></span></code> </pre></div></div><br>  In this case, we again get NESTED LOOP (left outer join), but this method is the most optimal at the moment (at least MS SQL thinks so). <br><br><div class="spoiler">  <b class="spoiler_title">Apply execution plans</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/9c7/939/882/9c7939882a40495fa984e17a4e3527cd.png"><br></div></div><br>  So far everything was boring and mundane. <br><br>  <b>The fourth way to</b> play with recursion: to the current line we will glue the data if the date is one day older and the sales plan is executed.  Thus we will expand the interval. <br><br>  Since  there is not much data, the sequence length is short, as is the call stack depth (CTE recursive is possible from 2005). <br><br><div class="spoiler">  <b class="spoiler_title">SQL queries recursion</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> @planValue <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> = <span class="hljs-number"><span class="hljs-number">15</span></span> ;<span class="hljs-keyword"><span class="hljs-keyword">with</span></span> periodDate6 <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> f.date BeginDate, <span class="hljs-keyword"><span class="hljs-keyword">DATEADD</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">day</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, f.date) EndDate <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> [tmp].[forFindDate] f <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> f.date = <span class="hljs-string"><span class="hljs-string">'20170417'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> f.value &gt; @planValue <span class="hljs-keyword"><span class="hljs-keyword">union</span></span> all <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> r.BeginDate, <span class="hljs-keyword"><span class="hljs-keyword">DATEADD</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">day</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, f.date) EndDate <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> [tmp].[forFindDate] f <span class="hljs-keyword"><span class="hljs-keyword">inner</span></span> <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> periodDate6 r <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> r.EndDate = f.Date <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> &gt; @planValue ) <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> top <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-string"><span class="hljs-string">'recursive'</span></span> title, BeginDate, <span class="hljs-keyword"><span class="hljs-keyword">DATEADD</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">Day</span></span>, <span class="hljs-number"><span class="hljs-number">-1</span></span>, EndDate) EndDate <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> periodDate6 <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DATEDIFF</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">day</span></span>, BeginDate, EndDate) <span class="hljs-keyword"><span class="hljs-keyword">desc</span></span></code> </pre></div></div><br><div class="spoiler">  <b class="spoiler_title">Correlation Query Execution Plans</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/cf2/05b/93b/cf205b93b3384ccf966bf5801b7a6aeb.png"><br></div></div><br>  <b>The fifth way,</b> we turn to the possibilities of MS SQL 2012 to the analytical functions LEAD (window functions).  The LEAD function returns the following values ‚Äã‚Äãwith a shift within the sections for sorting.  We have two sections in the data: fulfillment and non-fulfillment of the plan, sorting is needed by dates, in order to find the maximum period we will act slyly: we will look for gaps in non-fulfillment of the plan, i.e.  then when we move the dates of the beginning forward, and the end back, we get the segments of the implementation of the plan.  In this case, we are interested only in the section not fulfilling its plan and take it, but in general, the division can be done <pre> <code class="sql hljs">OVER ( PARTITION BY iif(f.value &lt; @planValue, 1, 0) order by f.date)</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">LEAD SQL queries</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> @planValue <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> = <span class="hljs-number"><span class="hljs-number">15</span></span> <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> tmp <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-string"><span class="hljs-string">'20170331'</span></span> [<span class="hljs-built_in"><span class="hljs-built_in">date</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">union</span></span> all <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-built_in"><span class="hljs-built_in">date</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> [tmp].[forFindDate] f <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> f.value &lt; @planValue <span class="hljs-keyword"><span class="hljs-keyword">union</span></span> all <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-string"><span class="hljs-string">'20170501'</span></span> ), periodDate4 <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-built_in"><span class="hljs-built_in">date</span></span> beforDate, <span class="hljs-keyword"><span class="hljs-keyword">lead</span></span>(f.date, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">'20170501'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">OVER</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> f.date) afterDate <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> tmp f ) <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> top <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-string"><span class="hljs-string">'func 2012 t'</span></span> title, <span class="hljs-keyword"><span class="hljs-keyword">DATEADD</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">Day</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, beforDate) BeginDate, <span class="hljs-keyword"><span class="hljs-keyword">DATEADD</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">Day</span></span>, <span class="hljs-number"><span class="hljs-number">-1</span></span>, afterDate) EndDate <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> periodDate4 <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DATEDIFF</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">day</span></span>, beforDate, afterDate) <span class="hljs-keyword"><span class="hljs-keyword">desc</span></span></code> </pre></div></div><br>  The execution plan shows that the tables do not join, with the exception of adding dates outside the segment for correct work with the ends of the segments. <br><br><div class="spoiler">  <b class="spoiler_title">LEAD execution plans</b> <div class="spoiler_text">  &lt;img src = " <img src="https://habrastorage.org/web/236/032/9f9/2360329f9d174b8e8b4ed94de28848ac"><br></div></div><br>  <b>The sixth method</b> And now let's pamper ourselves by multiplying the table by ourselves: we will find all possible combinations of dates (30 * 30 = 900), select those whose start date is less than the end date and there is no plan execution event in this interval. <br><br><div class="spoiler">  <b class="spoiler_title">SQL queries recursion</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> @planValue <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> = <span class="hljs-number"><span class="hljs-number">15</span></span> ;<span class="hljs-keyword"><span class="hljs-keyword">with</span></span> periodDate8 <span class="hljs-keyword"><span class="hljs-keyword">as</span></span>( <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ISNULL</span></span>(s.date, <span class="hljs-string"><span class="hljs-string">'20170401'</span></span>) BeginDate, <span class="hljs-keyword"><span class="hljs-keyword">ISNULL</span></span>(e.date, <span class="hljs-string"><span class="hljs-string">'20170501'</span></span>) EndDate <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> [tmp].[forFindDate] s, [tmp].[forFindDate] e ) <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> top <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-string"><span class="hljs-string">'for Fun'</span></span>, p.BeginDate, p.EndDate <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> periodDate8 p <span class="hljs-keyword"><span class="hljs-keyword">left</span></span> <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> [tmp].[forFindDate] b <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> b.date <span class="hljs-keyword"><span class="hljs-keyword">between</span></span> p.BeginDate <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> p.EndDate <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> b.value &gt; @planValue <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> p.BeginDate &lt; p.EndDate <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> b.date <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DATEDIFF</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">day</span></span>, BeginDate, EndDate) <span class="hljs-keyword"><span class="hljs-keyword">desc</span></span></code> </pre></div></div><br>  The slowest and hardest way.  But we do not pursue productivity, but for the number of solutions to the problem. <br><br><div class="spoiler">  <b class="spoiler_title">Table Multiplication Execution Plans</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/e3b/484/d1f/e3b484d1fce343db8e05f25655ed93e2.png"><br></div></div><br>  <b>Seventh way</b> Normal cursor.  We iterate over the data for which the plan has been executed, and we are looking for the maximum sequential segment. <br><br><div class="spoiler">  <b class="spoiler_title">SQL queries with the cursor</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> @planValue <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> = <span class="hljs-number"><span class="hljs-number">15</span></span> <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> @endDate datetime = <span class="hljs-literal"><span class="hljs-literal">null</span></span>, @Intervat <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> = <span class="hljs-number"><span class="hljs-number">0</span></span>, @maxIntervat <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> = <span class="hljs-number"><span class="hljs-number">0</span></span>, @old_date datetime = <span class="hljs-string"><span class="hljs-string">'20170401'</span></span>, @cur_date datetime <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> date_cursor <span class="hljs-keyword"><span class="hljs-keyword">CURSOR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FOR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-built_in"><span class="hljs-built_in">date</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> [tmp].[forFindDate] <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> &gt; @planValue <span class="hljs-keyword"><span class="hljs-keyword">OPEN</span></span> date_cursor <span class="hljs-keyword"><span class="hljs-keyword">FETCH</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NEXT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> date_cursor <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> @cur_date <span class="hljs-keyword"><span class="hljs-keyword">WHILE</span></span> @@FETCH_STATUS = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> (@cur_date = <span class="hljs-keyword"><span class="hljs-keyword">DATEADD</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">DAY</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, @old_date)) <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @Intervat = @Intervat + <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>(@Intervat &gt; @maxIntervat) <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @maxIntervat = @Intervat <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @endDate = @cur_date <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> @Intervat = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @old_date = @cur_date <span class="hljs-keyword"><span class="hljs-keyword">FETCH</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NEXT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> date_cursor <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> @cur_date <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CLOSE</span></span> date_cursor; <span class="hljs-keyword"><span class="hljs-keyword">DEALLOCATE</span></span> date_cursor; <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-string"><span class="hljs-string">'cursor'</span></span> title, <span class="hljs-keyword"><span class="hljs-keyword">DATEADD</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">DAY</span></span>, - @maxIntervat, @endDate) BeginDate, @endDate EndDate</code> </pre></div></div><br>  So far this is all I could think of.  Waiting for more options in the comments. <br><br>  <b>UPD1::</b> Option from stotsky71@outlook.com.  Through windowed functions we will find transitions, between states it is executed / not implementation of the plan.  And then the selection of intervals.  There may be problems due to the fact that the interval began with the fulfillment of the plan or the fulfillment of the plan ended, then the transition will not occur and the data will not be selected correctly. <br><br><div class="spoiler">  <b class="spoiler_title">LEAD and LAG SQL queries</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> @planValue <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> = <span class="hljs-number"><span class="hljs-number">15</span></span> ;<span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> Step01 <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> tmp.forFindDate <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> &gt; @planValue ) , Step02 <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-built_in"><span class="hljs-built_in">date</span></span> , <span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> <span class="hljs-built_in"><span class="hljs-built_in">date</span></span> - LAG([<span class="hljs-built_in"><span class="hljs-built_in">date</span></span>], <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">'20170401'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">OVER</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-built_in"><span class="hljs-built_in">date</span></span>) &gt; <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> isStart , <span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LEAD</span></span>([<span class="hljs-built_in"><span class="hljs-built_in">date</span></span>], <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">'20170430'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">OVER</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-built_in"><span class="hljs-built_in">date</span></span>) - <span class="hljs-built_in"><span class="hljs-built_in">date</span></span> &gt; <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> isEnd <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> Step01) , Step03 <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-built_in"><span class="hljs-built_in">date</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> rangestart , <span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> isEnd = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-built_in"><span class="hljs-built_in">date</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LEAD</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">date</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">OVER</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-built_in"><span class="hljs-built_in">date</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> rangeend , isstart <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> Step02 <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> isstart = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> isend = <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> TOP <span class="hljs-number"><span class="hljs-number">1</span></span> rangestart , rangeend , <span class="hljs-keyword"><span class="hljs-keyword">DATEDIFF</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">day</span></span>, rangestart, rangeend) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">''</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> Step03 <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> isstart = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-string"><span class="hljs-string">''</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DESC</span></span></code> </pre></div></div><br><br>  A variant from the letters helped to optimize my LEAD request (got rid of PARTITION BY in the request) <br><br>  <b>UPD2:</b> Option from the correspondence.  From the definition of intervals on the shift of dates: successive dates have the same increment by day, like a normal increment in rows.  On this property, you can get some kind of offset and if the offset for several dates coincides with the growth of the increment, then these dates go sequentially. <br><div class="spoiler">  <b class="spoiler_title">SQL ROW_NUMBER</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> @planValue <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> = <span class="hljs-number"><span class="hljs-number">15</span></span> ;<span class="hljs-keyword"><span class="hljs-keyword">with</span></span> internals <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">dateadd</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">day</span></span>, -ROW_NUMBER() <span class="hljs-keyword"><span class="hljs-keyword">OVER</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-built_in"><span class="hljs-built_in">date</span></span>), [<span class="hljs-built_in"><span class="hljs-built_in">date</span></span>]) fake_start, [<span class="hljs-built_in"><span class="hljs-built_in">date</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> tmp.forFindDate <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> &gt; <span class="hljs-number"><span class="hljs-number">15</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> TOP <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-string"><span class="hljs-string">'new method'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> title, <span class="hljs-keyword"><span class="hljs-keyword">MIN</span></span>([<span class="hljs-built_in"><span class="hljs-built_in">date</span></span>]) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> BeginDate, <span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>([<span class="hljs-built_in"><span class="hljs-built_in">date</span></span>]) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> EndDate <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> internals <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> fake_start <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COUNT</span></span>(*) <span class="hljs-keyword"><span class="hljs-keyword">DESC</span></span></code> </pre></div></div></div><p>Source: <a href="https://habr.com/ru/post/327862/">https://habr.com/ru/post/327862/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../327838/index.html">We live and work not in capitals: software development market in Nizhny Novgorod</a></li>
<li><a href="../327842/index.html">MP3 finally goes public domain</a></li>
<li><a href="../327844/index.html">Dell EMC Announces ESG 2017 IT Transformation Maturity Curve Survey Results</a></li>
<li><a href="../327858/index.html">What voice does your company say?</a></li>
<li><a href="../327860/index.html">New processor architecture solves the problem of combinatorial optimization</a></li>
<li><a href="../327866/index.html">Continuation of the experiment: passers-by draw famous logos from memory</a></li>
<li><a href="../327868/index.html">Authentication in OpenSSH Putty by JaCarta PKI</a></li>
<li><a href="../327872/index.html">Benefits of the Hierarchical Work Structure (WBS) for IT project managers</a></li>
<li><a href="../327874/index.html">Support for Visual Studio 2017 and Roslyn 2.0 in PVS-Studio: sometimes using ready-made solutions is not so easy</a></li>
<li><a href="../327882/index.html">Pitfalls during project team meetings</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>