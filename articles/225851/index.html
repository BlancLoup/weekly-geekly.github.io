<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Phalcon Framework in production</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In recent times, the phalcon framework, which is an extension of the language, is gaining popularity. I think that many people are interested in findi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Phalcon Framework in production</h1><div class="post__text post__text-html js-mediator-article">  In recent times, the phalcon framework, which is an extension of the language, is gaining popularity.  I think that many people are interested in finding out what the framework is in a battle, but for one reason or another they cannot afford to use it in development.  In my company, they decided to make such an adventure, and I hasten to share what I saw and felt.  Welcome under cat. <br><a name="habracut"></a><br><h4>  Where the legs grow </h4><br>  The company has a project for which a dispatcher is required.  Roughly speaking, this is a mechanism for proxying and balancing widgets, depending on the user's preference.  The current dispatcher inherited felts from the Incas, felts of the Aztecs, which gave rise within the collective to the belief that the dispatcher was always without him, too, that with the Earth without the Mayan calendar.  In other words, the code is scary, confused, but it works and requires support.  The dispatcher is written on Zend Framework 1, the code is located on the Amazon nodes, namely on c3.xlarge, APC is used.  With peak loads it reaches 8-10 thousand hits per minute and at such moments 5 nodes work.  This state of affairs did not suit me at all, since the dispatcher himself does not contain complex functionality, working with the database at a primitive level, the results of which are cached, and everything that can be done is added to the cache.  The main load is php and Zend.  Php will not be rejected, but with the second option you can try, all the more so for the dispatcher of power and flexibility of the framework was not required at all, and in the first place was the speed and resource consumption. <br><br>  I followed the development of Phalcon for a long time, because its <a href="http://www.techempower.com/benchmarks/">benchmark</a> was <a href="http://docs.phalconphp.com/en/latest/reference/benchmark/hello-world.html">still</a> , and I also really liked it and wanted to try it in something loaded.  Well, it was his turn and I quickly, rewriting the critical code of the dispatcher on Phalcon, decided to drive it on the test node (m3.medium) with the APC.  For testing, I used <a href="http://jmeter.apache.org/">jmeter</a> , created simple load tests and ran them in 500 threads. <br><br>  Load testing showed that memory consumption was halved compared to Zend.  Measure each request with memory_get_usage (). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Since then I did not think that I would write an article, so I did not take screenshots of the console and Amazon charts.  I will give a comparison in the table: <br><br><table><tbody><tr><th>  Framework </th><th>  Threads </th><th>  Loop </th><th>  Hits </th><th>  Max load average </th><th>  Test runtime </th><th>  Average response, ms </th><th>  Median, ms </th><th>  Min, ms </th><th>  Error </th></tr><tr><td>  Zend </td><td>  500 </td><td>  60 </td><td>  30,000 </td><td>  125 </td><td>  03:30:00 </td><td>  3,083 </td><td>  2,028 </td><td>  271 </td><td>  2.83% </td></tr><tr><td>  Phalcon </td><td>  500 </td><td>  60 </td><td>  30,000 </td><td>  76 </td><td>  01:55:00 </td><td>  1.549 </td><td>  947 </td><td>  138 </td><td>  0.86% </td></tr></tbody></table><br><br><h5>  Release </h5><br>  The results pleased and it was decided to transfer the project to Phalcon.  After a little refactoring of the code, the implementation of the DI container code was tested and ready for production. <br><br>  I want to emphasize that the code was not significantly optimized, in many places the code received only cosmetic refactoring.  When the time came "H" with a sinking heart rolled out the code on nodes and began to monitor the state of the system.  Here is the schedule: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/cfa/efb/fb5/cfaefbfb5cbf7a04229e845bb161c5f6.png" alt="image"><br><br>  What we see: the release was at peak load time - 5 nodes worked on Zend, with CPU load at 80%.  After updating the 5 nodes on Phalcon, the load fell below 20%.  The graph shows that there is a return to 5 Zend nodes - this was done to make sure that all Zend monitoring schedules coincide with Phalcon.  Everything was fine, so I decided to turn off the three nodes and see how Phalcon will cope.  Two nodes used a little more than 45% of the CPU, which made it possible to try the adventure and leave one node.  CPU rested on 100% and the 500th error went, but the problem was not with Phalcon, but with Nginx, which was hard to keep a large number of connections.  Immediately I returned one node to the balancer, and set myself a task for the future to tweak Nginx.  Replacing Zend with Phalcon made it possible to switch from 5 nodes to 2 nodes, which lowered spending on Amazon, and also helped deploy and monitor the system. <br><br><h5>  A few words about the framework itself. </h5><br>  I will not describe the framework itself, since the <a href="http://docs.phalconphp.com/en/latest/index.html">documentation</a> on the site is good, it is in Russian and the purpose of the article is different. <br><br>  At the time of refactoring, the current version of the framework was 1.2.6, which was used.  The framework didn‚Äôt seem raw at all - no bugs with the functionality that we needed were noticed.  Also note that Phalcon can do quite a lot of things and everything worked in accordance with the documentation. <br><br>  Used to work with models with built-in Active Record.  Models are powerful, they can do a lot of things - validation, caching, connections, virtual foreign keys and so on.  For sophisticated queries, there is a <a href="http://docs.phalconphp.com/en/latest/reference/phql.html">PHQL</a> meta-language.  For those interested - a <a href="http://docs.phalconphp.com/en/latest/reference/models.html">link</a> to the documentation. <br><br>  During development, there were problems with the cache - at some point I noticed that data is very strangely cached, there is a connection with memcache more than once, there is not always a cache, although there is data in memcache.  The problem was that I didn‚Äôt use the DI container correctly.  I added the cache via the set () method, and when accessing the DI container each time I received a new instance of the class, with a new connection to the memkes. <br>  And in order to return the same object every time, you need to put it in a container like this: <br> <code>$di-&gt;setShared('cache', $cacheObject);</code> <br>  Correcting the error, everything worked as expected.  This approach allowed to abandon all Singleton in the project, which was done with pleasure. <br><br>  After the release, the next version of the framework, 1.3, was released, which was installed and worked without problems with the project code.  I had to fix only a couple of places with a DI container to start the application. <br><br><h5>  Working with CLI </h5><br>  Working with console tasks in Phalcon is quite simple and so far has no great potential compared to, for example, Zend.  It is not possible to specify the default settings, and mandatory - ask to add when you call the task right in the console.  Working with parameters is reduced to an independent parsing <code>$argv;</code>  Also, there are no beautiful with color texts, backgrounds, so that decorate the console with a rainbow will not work.  But on the other hand, although the functionality is not rich, it still performs its function.  And over time, there will be gadgets and whistles. <br><br><h5>  A little bit of tar </h5><br>  Upset the lack of an elementary LogNull in the framework for logging, which had to be added to php. <br>  Also surprised by the lack of opportunity merdzhit configs. <br>  UPD: as suggested in the comments - the possibility <a href="http://docs.phalconphp.com/ru/latest/api/Phalcon_Config.html">is</a> <br><br>  Of the shortcomings that can be a serious argument for someone to refuse is the inability to correct the code of the framework.  If you find a vulnerability, you can‚Äôt do anything about it - the sources are compiled.  However, the developers rewrite Phalcon to <a href="http://zephir-lang.com/">Zephir</a> (I‚Äôll try to write a separate article in more detail about Zephir), which will make it possible to edit the framework itself, as well as write extensions to it for C. <br><br>  This will be done in the version of Phalcon 2.0, which today has the status of Beta 1. I hope that soon we will see a stable release. <br><br>  There is something else to tell about the framework, but I think that this is a topic for a separate article, therefore I will summarize in brief the result of using it on a loaded Phalcon project: <br>  - performance is not comparable with Zend (similar to php frameworks) <br>  - easy to learn if you have experience with frameworks <br>  - the framework does not look raw and unfinished, however there is much to grow and develop <br>  - it is impossible to fix the code of the framework </div><p>Source: <a href="https://habr.com/ru/post/225851/">https://habr.com/ru/post/225851/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../225837/index.html">Notification during call pickup in Asterisk</a></li>
<li><a href="../225841/index.html">Swift programming language. Russian version</a></li>
<li><a href="../225845/index.html">Hexapod-robot running ROS</a></li>
<li><a href="../225847/index.html">ImEx.js will decorate your code</a></li>
<li><a href="../225849/index.html">Cisco has updated the product line of video communications equipment</a></li>
<li><a href="../225853/index.html">CoreMark processor rating</a></li>
<li><a href="../225855/index.html">Nokia and SEL introduced a new type of flexible OLED display.</a></li>
<li><a href="../225857/index.html">Acer Chromebook C720 Laptop Video Review</a></li>
<li><a href="../225865/index.html">Xbox One in Russia on September 5th. GTA V on PC, Xbox One and PS4 also fall</a></li>
<li><a href="../225869/index.html">Software 3.0: silent revolution</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>