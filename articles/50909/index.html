<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Developing a module for Apache 2.x</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Foreword 

 Recently I had to face the need to develop my own small module for the Apache 2.2.x web server. After spending several hours in search of ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Developing a module for Apache 2.x</h1><div class="post__text post__text-html js-mediator-article"><h2>  Foreword </h2><br><br>  Recently I had to face the need to develop my own small module for the Apache 2.2.x web server.  After spending several hours in search of suitable information, I was confronted with the fact that very few people speak Russian about it.  Therefore, the idea arose to write this article.  Below, I will try to share my experience in as much detail as possible, step by step to describe the stages of creating a module, and provide various useful links on this topic. <br><br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h2>  Introduction </h2><br><br>  The first thing that a new developer encounters, who has never encountered writing modules for Apache, is the question ‚ÄúWhere to start?‚Äù. <br><br>  Start by recognizing the fact that, without any extra movements, you will have to deal with pure C without any ++.  And maybe this is for the best. <br><br>  Next, check whether your system has APXS installed, if not, install it.  On Debian (Ubuntu) Linux systems, this can be done fairly simply by running the command: <br><br><pre>  apt-get install apache2-threaded-dev </pre><br><br>  or <br><br><pre>  apt-get install apache2-prefork-dev </pre><br>  depending on the corresponding version of apache you are using. <br><br>  You need this to build and compile the module. <br><br>  Now everything is ready, and you can proceed directly to the development of the module itself.  We will study everything with an example, so let's create a small module that brings all the HTML tags that the web server gives to uppercase. <br><br>  So, let's call our module without extra tricks - uptags.  Create a folder with the same name and in it the source file mod_uptags.c, as well as the README and config.m4 files.  This is how our file structure will look like: <br><br><pre>  uptags /
     config.m4
     mod_uptags.c
     README </pre><br><br>  You can immediately place these files in the source code of Apache, and you can do it after, act on your own. <br><br>  In principle, for the successful creation of the module, we would only have enough of the C source file; nevertheless, the README would be at least a good tone, and config.m4 would be useful for automatically assembling the module when compiling the entire web server. <br><br>  API to Apache modules involves the implementation of several functions and structures, which can logically be attributed to several groups, which are discussed below. <br><br>  However, before we start the analysis of functions, you should connect the necessary libraries and declare the module itself in our source code mod_uppertags.c: <br><br><blockquote><code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">#include <font color="#A31515">"apr_general.h"</font> <br> #include <font color="#A31515">"apr_lib.h"</font> <br> #include <font color="#A31515">"apr_buckets.h"</font> <br> #include <font color="#A31515">"apr_strings.h"</font> <br> #include <font color="#A31515">"ap_config.h"</font> <br> #include <font color="#A31515">"util_filter.h"</font> <br> #include <font color="#A31515">"httpd.h"</font> <br> #include <font color="#A31515">"http_config.h"</font> <br> #include <font color="#A31515">"http_request.h"</font> <br> #include <font color="#A31515">"http_core.h"</font> <br> #include <font color="#A31515">"http_protocol.h"</font> <br> #include <font color="#A31515">"http_log.h"</font> <br> #include <font color="#A31515">"http_main.h"</font> <br> #include <font color="#A31515">"util_script.h"</font> <br> #include <font color="#A31515">"http_core.h"</font> <br> #include &lt; <font color="#0000ff">string</font> .h&gt; <br> #include &lt;stdio.h&gt; <br> #include &lt;ctype.h&gt; <br> #include &lt;sys/stat.h&gt; <br> <br> module AP_MODULE_DECLARE_DATA uptags_module;</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><h2>  Configuration Management Features </h2><br>  As you know, Apache is a highly customizable web server. <br><br>  From the point of view of the system administrator, there are several types of directives that can be defined in different scopes, such as the global server configuration, &lt;VirtualHost&gt;, &lt;Directory&gt; (as well as &lt;Files&gt; or &lt;Location&gt;) and .htaccess files. <br><br>  Directive conflicts defined in different scopes, by default, are resolved by the server itself according to the following rules: <br><br><ul><li>  <strong>Main config</strong> <br>  The directives in this file (with the exception of those defined in some containers) are applied globally.  Most directives can be used here. </li><li>  <strong>Virtual Host &lt;VirtualHost&gt;</strong> <br>  Each virtual host can have its own (virtual) server config inside the &lt;VirtualHost&gt; container.  Directives that can be used in the global config can also be used here and vice versa. </li><li>  <strong>Directory</strong> <br>  The &lt;Directory&gt;, &lt;Files&gt; and &lt;Location&gt; containers define at different levels how the global settings can be redefined.  In this article, we will refer to them as configs of directories. </li><li>  <strong>.Htaccess files</strong> <br>  Also refer to the directory settings.  In these files, users can define the directive settings themselves, based on the value of the AllowOverride directive set for each of them by the server administrator. </li></ul><br><br>  When writing a module, you can independently define directives and containers, determine their scope and change the rules for their redefinition. <br><br>  To do this, first of all, you need to create appropriate structures in which configuration data will be stored in memory.  It should be noted that in the general case, you can define separate structures for server configuration and directory configuration.  This should be done if the sets of directives are different.  Otherwise, you can use the same structure for storing settings. <br><br>  Since the module that we create is quite simple and will have minimal settings, we will follow a simple path and combine both types of settings (server and for directories) into one data structure.  Let's define a flag to enable and disable the operation of our module: <br><br><blockquote>  engine = On / Off - will allow you to enable / disable the work of the entire module. <br></blockquote><br><br>  That is, our structure will look like this: <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">typedef <font color="#0000ff">struct</font> uptags_cfg { <br> <font color="#0000ff">int</font> engine; <br> } uptags_cfg;</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  Now for each separate type of configuration we need to write data retrieval functions: <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#008000">/**</font> <br> <font color="#008000">*      </font> <br> <font color="#008000">*     </font> <br> <font color="#008000">*/</font> <br> <font color="#0000ff">static</font> uptags_cfg *uptags_dconfig( <font color="#0000ff">const</font> request_rec *r) { <br> <font color="#0000ff">return</font> (uptags_cfg *) ap_get_module_config( r-&gt;per_dir_config, &amp;uptags_module); <br> } <br> <br> <font color="#008000">/**</font> <br> <font color="#008000">*      </font> <br> <font color="#008000">*  </font> <br> <font color="#008000">*/</font> <br> <font color="#0000ff">static</font> uptags_cfg *uptags_sconfig( <font color="#0000ff">const</font> server_rec *s) { <br> <font color="#0000ff">return</font> (uptags_cfg *) ap_get_module_config( s-&gt;module_config, &amp;uptags_module); <br> } <br></font> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  Now is the time to take care of the default settings.  To do this, we write the following two functions: <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#008000">/**</font> <br> <font color="#008000">*   -  </font> <br> <font color="#008000">*/</font> <br> <font color="#0000ff">static</font> <font color="#0000ff">void</font> *uptags_create_dir_config( apr_pool_t *p, <font color="#0000ff">char</font> *dirspec) { <br> uptags_cfg *cfg; <br> <br> <font color="#008000">/**</font> <br> <font color="#008000">*        </font> <br> <font color="#008000">*/</font> <br> cfg = (uptags_cfg *) apr_pcalloc( p, <font color="#0000ff">sizeof</font> ( uptags_cfg)); <br> <br> <font color="#008000">/**</font> <br> <font color="#008000">*        </font> <br> <font color="#008000">*/</font> <br> cfg-&gt;engine = 1; <br> <br> <font color="#0000ff">return</font> ( <font color="#0000ff">void</font> *) cfg; <br> } <br> <br> <font color="#008000">/**</font> <br> <font color="#008000">*      </font> <br> <font color="#008000">*/</font> <br> <font color="#0000ff">static</font> <font color="#0000ff">void</font> *uptags_create_server_config( apr_pool_t *p, server_rec *s) { <br> uptags_cfg *cfg; <br> cfg = (uptags_cfg *) apr_pcalloc( p, <font color="#0000ff">sizeof</font> ( uptags_cfg)); <br> <br> cfg-&gt;engine = 1; <br> <br> <font color="#0000ff">return</font> ( <font color="#0000ff">void</font> *) cfg; <br> }</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  Since in the web server structure there may actually be several configurations in different blocks (for example, an entry can be created for the directory configuration in the virtual host structure in the &lt;Directory&gt; &lt;/ Directory&gt;, &lt;Files&gt; &lt;/ Files&gt; or &lt;Location &gt; &lt;/ Location&gt;, and, at the same time, a .htaccess file can be created), we may need to define our own rules for combining these configs.  Thank God, the Apache API allows us to do this quite simply by defining the rules for server and directory settings.  To do this, simply define the following functions: <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#008000">/**</font> <br> <font color="#008000">*        </font> <br> <font color="#008000">*          </font> <br> <font color="#008000">*  </font> <br> <font color="#008000">*/</font> <br> <font color="#0000ff">static</font> <font color="#0000ff">void</font> *uptags_merge_dir_config( apr_pool_t *p, <font color="#0000ff">void</font> *parent_conf, <font color="#0000ff">void</font> *newloc_conf) { <br> uptags_cfg *megred_conf = (uptags_cfg *) apr_pcalloc( p, <font color="#0000ff">sizeof</font> ( uptags_cfg)); <br> uptags_cfg *pconf = (uptags_cfg *) parent_conf; <br> uptags_cfg *nconf = (uptags_cfg *) newloc_conf; <br> <br> <font color="#008000">/**</font> <br> <font color="#008000">* ...</font> <br> <font color="#008000">*      </font> <br> <font color="#008000">*/</font> <br> <br> <font color="#0000ff">return</font> ( <font color="#0000ff">void</font> *) merged_conf; <br> } <br> <br> <font color="#008000">/**</font> <br> <font color="#008000">*    </font> <br> <font color="#008000">*/</font> <br> <font color="#0000ff">static</font> <font color="#0000ff">void</font> *uptags_merge_server_config( apr_pool_t *p, <font color="#0000ff">void</font> *srv1conf, <font color="#0000ff">void</font> *srv2conf) { <br> uptags_cfg *merged_config = (uptags_cfg *) apr_pcalloc( p, <font color="#0000ff">sizeof</font> ( uptags_cfg)); <br> uptags_cfg *s1conf = (uptags_cfg *) srv1conf; <br> uptags_cfg *s2conf = (uptags_cfg *) srv2conf; <br> <br> <font color="#008000">/**</font> <br> <font color="#008000">* ...</font> <br> <font color="#008000">*      </font> <br> <font color="#008000">*/</font> <br> <br> <font color="#0000ff">return</font> ( <font color="#0000ff">void</font> *) merged_config; <br> }</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  However, keep in mind that merge rules should be applied only if the server rules do not suit you by default, i.e.  you want to change them.  Otherwise, just do not write these functions and everything will happen by itself. <br><br><h2>  Definition of configuration directives (commands) </h2><br><br>  After we have defined the structure of our configuration and the function for its filling, the processing union, it is not at all superfluous to define the directives themselves, so they will have to be specified in the configs: <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">static</font> command_rec uptags_directives[] = { <br> AP_INIT_FLAG( <br> <font color="#A31515">"UptagsEngine"</font> , <br> ap_set_flag_slot, <br> ( <font color="#0000ff">void</font> *) APR_OFFSETOF( uptags_cfg, engine), <br> OR_OPTIONS, <br> <font color="#A31515">"uptags module switcher"</font> <br> ), <br> <br> {NULL} <br> };</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  We‚Äôll stop here a bit to see the various features that the Apache web server API provides for handling configuration directives. <br><br>  The definition of the directive structure always ends with a NULL structure, and the implementation macros are defined in the http_config.h file.  AP_INIT_FLAG is one of many such macros, in general, the non-NULL structure contains the following elements: <br><br><ul><li>  The name of the directive is how the directive will be set in configs (in fact, mapping strings from configs and the structure we created earlier in memory is exactly this place) </li><li>  The function that implements the directive.  ap_set_flag_slot is a standard Apache API function that parses a switch parameter or a flag (just what suits us - On / Off) </li><li>  Pointer to the data structure (using APR_OFFSETOF we map the data to the structure we defined) </li><li>  Macro defining where the directive is allowed (OR_OPTIONS - the directive is allowed for directories and .htaccess files if the value of the AllowOverride directive is set by the administrator with the Options tag) </li><li>  Description of directive for help functions. </li></ul><br><br>  Often the standard functions that implement the command provided by the Apache API are enough to solve the problem.  These functions are also described in the http_config.h file.  Here they are: <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#008000">/**</font> <br> <font color="#008000">*      </font> <br> <font color="#008000">*/</font> <br> AP_DECLARE_NONSTD( <font color="#0000ff">const</font> <font color="#0000ff">char</font> *) ap_set_string_slot( cmd_parms *cmd, <font color="#0000ff">void</font> *struct_ptr, <font color="#0000ff">const</font> <font color="#0000ff">char</font> *arg); <br> <br> <font color="#008000">/**</font> <br> <font color="#008000">*      </font> <br> <font color="#008000">*/</font> <br> <br> AP_DECLARE_NONSTD( <font color="#0000ff">const</font> <font color="#0000ff">char</font> *) ap_set_int_slot( cmd_parms *cmd, <font color="#0000ff">void</font> *struct_ptr, <font color="#0000ff">const</font> <font color="#0000ff">char</font> *arg); <br> <br> <font color="#008000">/**</font> <br> <font color="#008000">*      ,    </font> <br> <font color="#008000">*/</font> <br> AP_DECLARE_NONSTD( <font color="#0000ff">const</font> <font color="#0000ff">char</font> *) ap_set_string_slot_lower( cmd_parms *cmd, <font color="#0000ff">void</font> *struct_ptr, <font color="#0000ff">const</font> <font color="#0000ff">char</font> *arg); <br> <br> <font color="#008000">/**</font> <br> <font color="#008000">*       ( On/Off)</font> <br> <font color="#008000">*/</font> <br> AP_DECLARE_NONSTD( <font color="#0000ff">const</font> <font color="#0000ff">char</font> *) ap_set_flag_slot( cmd_parms *cmd, <font color="#0000ff">void</font> *struct_ptr, <font color="#0000ff">const</font> <font color="#0000ff">char</font> *arg); <br> <br> <font color="#008000">/**</font> <br> <font color="#008000">*      ,   -   </font> <br> <font color="#008000">*/</font> <br> AP_DECLARE_NONSTD( <font color="#0000ff">const</font> <font color="#0000ff">char</font> *) ap_set_file_slot( cmd_parms *cmd, <font color="#0000ff">void</font> *struct_ptr, <font color="#0000ff">const</font> <font color="#0000ff">char</font> *arg); <br> <br> <font color="#008000">/**</font> <br> <font color="#008000">*      , :</font> <br> <font color="#008000">* AP_INIT_RAW_ARGS("Foo", ap_set_deprecated, NULL, OR_ALL,</font> <br> <font color="#008000">*     " Foo   ,   Bar")</font> <br> <font color="#008000">*/</font> <br> AP_DECLARE_NONSTD( <font color="#0000ff">const</font> <font color="#0000ff">char</font> *) ap_set_deprecated( cmd_parms *cmd, <font color="#0000ff">void</font> *struct_ptr, <font color="#0000ff">const</font> <font color="#0000ff">char</font> *arg);</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  Macros defining the data directive type can be the following: <br><br><ul><li>  <strong>AP_INIT_NO_ARGS</strong> - directive without arguments </li><li>  <strong>AP_INIT_FLAG</strong> - switch directive (On / Off) </li><li>  <strong>AP_INIT_TAKE1</strong> - one argument - string </li><li>  <strong>AP_INIT_TAKE2</strong> , <strong>AP_INIT_TAKE3</strong> , <strong>AP_INIT_TAKE12</strong> - directives take several different arguments </li><li>  <strong>AP_INIT_ITERATE</strong> - a function will be applied to each argument of the directory </li><li>  <strong>AP_INIT_ITERATE2</strong> - the function will be called with two arguments passed to it </li><li>  <strong>AP_INIT_RAW_ARGS</strong> - a function will be called with all directive arguments passed to it </li></ul><br><br>  Macros defining the scope of a directive are: <br><br><ul><li>  <strong>OR_NONE</strong> - not available anywhere in the config </li><li>  <strong>OR_LIMIT</strong> - in server configurations inside &lt;Directory&gt; or &lt;Location&gt; containers and inside .htaccess files, if the AllowOverride directive has the Limit keyword </li><li>  <strong>OR_OPTIONS</strong> - anywhere, including .htaccess, if the AllowOverride directive has the Options keyword </li><li>  <strong>OR_FILEINFO</strong> - anywhere, including .htaccess, if the AllowOverride directive has the keyword FileInfo </li><li>  <strong>OR_AUTHCFG</strong> - in server configurations inside &lt;Directory&gt; or &lt;Location&gt; containers and in .htaccess files, if the AllowOverride directory has the keyword AuthConfig </li><li>  <strong>OR_INDEXES</strong> - anywhere, including .htaccess files, if the AllowOverride directive has the Indexes keyword </li><li>  <strong>OR_UNSET</strong> - remove directive in Allow </li><li>  <strong>ACCESS_CONF</strong> - in server configs inside &lt;Directory&gt; or &lt;Location&gt; containers </li><li>  <strong>RSRC_CONF</strong> - in server configurations outside the &lt;Directory&gt; or &lt;Location&gt; containers </li><li>  <strong>EXEC_ON_READ</strong> - forces the directive to execute an external command that changes the configuration (like connecting an external file or IFModule) </li><li>  <strong>OR_ALL</strong> - directive is allowed anywhere </li></ul><br><br>  Now that we have decided to configure our module, we can proceed directly to the development of its functionality. <br><br><h2>  Request Handlers </h2><br><br>  You can create your own Apache request handlers, which will issue the appropriate documents for the corresponding request using the SetHandler and AddHandler directives. <br><br>  Since data handlers send data directly to the output, you need to ensure that the response headers are sent before the content is rendered.  This can be done using the send_http_header () function.  You can also set your own headers. <br><br>  Any handler function accepts, as an argument, a pointer to the request structure.  Return values ‚Äã‚Äãcan be: <br><br><ul><li>  OK - everything is fine, we have successfully processed the request </li><li>  DECLINED - request rejected </li><li>  HTTP_ [error code] - report an HTTP protocol error, for example HTTP_401 - Authorization required </li></ul><br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">static</font> <font color="#0000ff">int</font> uptags_handler( request_rec *r) { <br> <font color="#0000ff">if</font> (strcmp( r-&gt;handler, <font color="#A31515">"uptags-handler"</font> )) { <br> <font color="#0000ff">return</font> DECLINED; <br> } <br> <br> r-&gt;content_type = <font color="#A31515">"text/html"</font> ; <br> <br> <font color="#008000">/**</font> <br> <font color="#008000">*     -     </font> <br> <font color="#008000">*/</font> <br> <font color="#0000ff">if</font> (r-&gt;header_only) { <br> <font color="#0000ff">return</font> OK; <br> } <br> <br> <font color="#008000">/**</font> <br> <font color="#008000">*  ,   :</font> <br> <font color="#008000">*/</font> <br> ap_rputs( DOCTYPE_HTML_4_0_STRICT, r); <br> ap_rputs( <font color="#A31515">"&lt;HTML&gt;\n"</font> , r); <br> ap_rputs( <font color="#A31515">" &lt;HEAD&gt;\n"</font> , r); <br> ap_rputs( <font color="#A31515">" &lt;TITLE&gt;Example Title&lt;/TITLE&gt;\n"</font> , r); <br> ap_rputs( <font color="#A31515">" &lt;/HEAD&gt;\n"</font> , r); <br> ap_rputs( <font color="#A31515">" &lt;BODY&gt;\n"</font> , r); <br> ap_rputs( <font color="#A31515">" &lt;H1&gt;Example content&lt;/H1&gt;\n"</font> , r); <br> ap_rputs( <font color="#A31515">" &lt;P&gt;Example text&lt;/P&gt;\n"</font> , r); <br> ap_rputs( <font color="#A31515">" &lt;/BODY&gt;\n"</font> , r); <br> ap_rputs( <font color="#A31515">"&lt;/HTML&gt;\n"</font> , r); <br> <br> <font color="#0000ff">return</font> OK; <br> }</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  Now we can add our handler to the web server config: <br><br><pre> &lt;Location / uptags-handler-example&gt;
         SetHandler uptags-handler
 &lt;/ Location&gt;
</pre><br><br>  In fact, this module has nothing to do with the module that we write, so we do not need this functionality.  We just looked at an example of writing our handler.  This task may arise if you want, for example, to write your website content management system as a module to a web server.  Or you will embed your interpreted language. <br><br>  To solve the problem we have set, the work with filters is more suitable, which we will consider in the next section. <br><br><h2>  Filters </h2><br><br>  Filters allow you to manipulate the current content, which Apache gives on request.  Just the right place to solve our problem. <br><br>  Here you should deviate a little from the solution itself and talk a little about the principles of functioning of the web server and how it processes and sends the data. <br><br>  The Apache 2 filter architecture is the main innovation of this web server, which, along with its power and versatility, has a negative connotation in the matter of learning and understanding the concept of baskets and brigades (buckets and brigades). <br><br>  Apache's low-level API allows you to manipulate ‚Äúbaskets‚Äù and ‚Äúbrigades‚Äù directly.  Below we will look at the principles of how this is done. <br><br><h3>  What is the "basket" and "brigade"? </h3><br><br>  <strong>A recycle</strong> bin is a data container that can contain data of any type.  Nevertheless, the most common type is a block of memory, which may already contain both a file on disk and a stream of data transmitted from one source to another, such as a separate program. <br><br>  In principle, there are several different types of ‚Äúbaskets‚Äù - with different types of data, as well as ‚Äúbaskets‚Äù with metadata, such as an end-of-day sign (EOS) or FLUSH- ‚Äúbasket‚Äù, which flushes the data buffer to the output stream. <br><br>  <strong>A brigade</strong> is a container that combines a cycle of "baskets" and a subdivision that is passed from filter to filter. <br><br>  Baskets and brigades provide efficient manipulation of memory blocks typical of filter applications. <br><br>  To manipulate the baskets and brigades, Apache 2 provides us with a set of data types, structures, macros, and API functions described in the apr_buckets.h file.  Their description can be found <a href="http://apr.apache.org/docs/apr-util/0.9/group__APR__Util__Bucket__Brigades.html">here</a> . <br><br>  It should be noted that in order to solve the task, we need to create two filters - input (in) and output (out): <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#008000">/**</font> <br> <font color="#008000">*  </font> <br> <font color="#008000">*/</font> <br> <font color="#0000ff">static</font> <font color="#0000ff">void</font> uptags_in_filter( request_rec *r) { <br> <font color="#008000">/**</font> <br> <font color="#008000">*       ,       </font> <br> <font color="#008000">*/</font> <br> ap_add_output_filter( <font color="#A31515">"Uptags"</font> , NULL, r, r-&gt;connection); <br> } <br> <br> <font color="#008000">/**</font> <br> <font color="#008000">*   -       </font> <br> <font color="#008000">*/</font> <br> <font color="#0000ff">static</font> apr_status_t uptags_out_filter( ap_filter_t *f, apr_bucket_brigade *pbbIn) { <br> <br> request_rec    *r = f-&gt;r; <br> conn_rec      *c = r-&gt;connection; <br> apr_bucket     *pbktIn; <br> apr_bucket_brigade *pbbOut; <br> uptags_cfg     *cfg = uptags_dconfig( f-&gt;r); <br> <br> <font color="#008000">/**</font> <br> <font color="#008000">* ,      .   -      </font> <br> <font color="#008000">*     ,      HTML</font> <br> <font color="#008000">*/</font> <br> <font color="#0000ff">if</font> (!cfg-&gt;engine || strcmp( r-&gt;content_type, <font color="#A31515">"text/html"</font> ) != 0) { <br> <font color="#0000ff">return</font> ap_pass_brigade( f-&gt;next, pbbIn); <br> } <br> <br> <font color="#008000">/*     */</font> <br> pbbOut = apr_brigade_create( r-&gt;pool, c-&gt;bucket_alloc); <br> <br> <font color="#008000">/**</font> <br> <font color="#008000">*      </font> <br> <font color="#008000">*/</font> <br> <font color="#0000ff">for</font> (pbktIn = APR_BRIGADE_FIRST( pbbIn); pbktIn != APR_BRIGADE_SENTINEL( pbbIn); pbktIn = APR_BUCKET_NEXT( pbktIn)) { <br> <font color="#0000ff">const</font> <font color="#0000ff">char</font> *data; <br> apr_size_t len; <br> <font color="#0000ff">char</font> *buf; <br> apr_bucket *pbktOut; <br> <br> <font color="#008000">/*   "" -  -  -           */</font> <br> <font color="#0000ff">if</font> (APR_BUCKET_IS_EOS( pbktIn)) { <br> apr_bucket *pbktEOS = apr_bucket_eos_create( c-&gt;bucket_alloc); <br> APR_BRIGADE_INSERT_TAIL( pbbOut,pbktEOS); <br> <font color="#0000ff">continue</font> ; <br> } <br> <br> <font color="#008000">/*   */</font> <br> apr_bucket_read( pbktIn, &amp;data, &amp;len, APR_NONBLOCK_READ); <br> <br> <font color="#008000">/**</font> <br> <font color="#008000">*     </font> <br> <font color="#008000">* !      -      .</font> <br> <font color="#008000">*    .</font> <br> <font color="#008000">*/</font> <br> buf = apr_bucket_alloc( len, c-&gt;bucket_alloc); <br> memset( buf, 0, <font color="#0000ff">sizeof</font> ( buf)); <br> <br> uptags_tags_to_uppercase( data, buf); <br> <br> <font color="#008000">/*    */</font> <br> pbktOut = apr_bucket_heap_create( buf, len, apr_bucket_free, c-&gt;bucket_alloc); <br> APR_BRIGADE_INSERT_TAIL( pbbOut, pbktOut); <br> } <br> <br> apr_brigade_cleanup( pbbIn); <br> <font color="#0000ff">return</font> ap_pass_brigade( f-&gt;next, pbbOut); <br> } <br></font> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  Naturally.  we also need to implement our uptags_tags_to_uppercase () function, which, in fact, does all the necessary data manipulations, and place its declaration before declaring filters: <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#008000">/**</font> <br> <font color="#008000">*        </font> <br> <font color="#008000">*/</font> <br> <font color="#0000ff">void</font> uptags_tags_to_uppercase( <font color="#0000ff">const</font> <font color="#0000ff">char</font> *data, <font color="#0000ff">char</font> *str) { <br> <font color="#0000ff">int</font> i, s = strlen( data), tag_opened = 0; <br> <font color="#0000ff">for</font> (i = 0; i &lt; s; i++) { <br> str[i] = data[i]; <br> <font color="#0000ff">if</font> (str[i] == <font color="#A31515">'&lt;'</font> ) { <br> tag_opened = 1; <br> } <font color="#0000ff">else</font> <font color="#0000ff">if</font> (str[i] == <font color="#A31515">'&gt;'</font> ) { <br> tag_opened = 0; <br> } <br> <font color="#0000ff">if</font> (tag_opened &amp;&amp; str[i] != <font color="#A31515">'\0'</font> ) { <br> str[i] = apr_toupper( str[i]); <br> } <br> } <br> } <br></font> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  We have written a fairly simple function that in real life will not always behave as it should.  But our task is quite simple, so for testing purposes, it is quite suitable for us. <br><br>  At this, the development of filters for our module can be considered complete and we can proceed to the final stage. <br><br><h2>  Module definition </h2><br><br>  After we have defined all the functions of our module, we need to ‚Äúexplain‚Äù to the web server how to use them. <br><br>  To do this, it is enough to list them in the corresponding cells of the Apache module structure: <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#008000">/**</font> <br> <font color="#008000">*    Apache</font> <br> <font color="#008000">*/</font> <br> module AP_MODULE_DECLARE_DATA uptags_module = { <br> STANDARD20_MODULE_STUFF, <br> uptags_create_dir_config, <font color="#008000">/*    */</font> <br> NULL, <font color="#008000">/*    */</font> <br> uptags_create_server_config, <font color="#008000">/*    */</font> <br> NULL, <font color="#008000">/*    */</font> <br> uptags_directives, <font color="#008000">/*    */</font> <br> uptags_register_hooks <font color="#008000">/*   */</font> <br> }; <br></font> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  As we can see, we lack only a small function uptags_register_hooks, which will take over the work of registering all the handlers we need for this module. <br><br>  Let's write it: <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#008000">/**</font> <br> <font color="#008000">*     </font> <br> <font color="#008000">*/</font> <br> <font color="#0000ff">static</font> <font color="#0000ff">void</font> uptags_register_hooks( apr_pool_t *p) { <br> ap_hook_insert_filter( uptags_in_filter, NULL, NULL, APR_HOOK_MIDDLE); <br> ap_register_output_filter( <font color="#A31515">"Uptags"</font> , uptags_out_filter, NULL, AP_FTYPE_RESOURCE); <br> } <br></font> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  You can download the full source of the module <a href="">from here</a> . <br><br><h2>  Compiling and building a module </h2><br><br>  The easiest way to compile and connect a module is to assemble it as a DSO (Dynamically Shared Object).  To do this, run the command in the source directory: <br><br><pre>  apxs2 -c mod_uppertags.c </pre><br><br>  If the compilation was successful, the .libs folder should appear, and in it the file mod_uptegs.so.  This file should be copied to the directory with Apache loadable modules.  On Debian (Ubuntu) Linux, this is usually the / usr / lib / apache2 / modules / directory <br><br>  Now in the main Apache config you need to enter directives: <br><br><pre> LoadModule uptags_module /usr/lib/apache2/modules/mod_uptags.so<font></font>
<font></font>
 &lt;IfModule mod_uptags.c&gt;
     Uptagsengine on
 &lt;/ IfModule&gt;
</pre><br><br>  Next, restart the web server: <br><br><pre> /etc/init.d/apache2 restart
</pre><br><br>  Now you can check the result by viewing any page that your web server gives out. <br><br>  It is also useful to write the contents of the config.m4 file: <br><br><pre> APACHE_MODPATH_INIT (uptags)
 APACHE_MODULE (uptags, reformatting all HTML tags to upercase,,, no)
 APACHE_MODPATH_FINISH
</pre><br><br>  This will allow you to automatically compile the module with a common Apache build.  In order to build a module statically when building an entire web server, it is now sufficient to specify the option --enable-uptags when running the command ./configure: <br><br><pre> ./configure --enable-uptags
</pre><br><br>  And, of course, do not forget to give other people the necessary instructions, describing them in the README file. <br><br><h2>  Links (in English) </h2><br><br>  <a href="http://www.apachetutor.org/dev/config">Configuration for Modules</a> <br>  <a href="http://www.apachetutor.org/dev/brigades">Introduction to Buckets and Brigades</a> <br>  <a href="http://www.apachetutor.org/dev/pools">Basic Resource Management in Apache: the APR Pools</a> <br>  <a href="http://www.apachetutor.org/dev/request">Request Processing in Apache</a> <br>  <a href="http://apr.apache.org/docs/apr/1.3/">Apache Portable Runtime (APR) Documentation</a> <br><br><h2>  Conclusion </h2><br><br>  As we have seen, developing your own modules for the Apache web server is not so difficult.  It is enough to arm ourselves with patience and references to the relevant documentation, and the task becomes quite solvable. <br><br>  I hope that this guide will help the reader become more familiar with the Apache API for writing modules and become the starting point for this interesting matter. <br><br>  Good luck in development! <br><br>  PS This is a cross-posting of the <a href="http://mikhailstadnik.com/developing-apache-module">original article</a> from my blog. </div><p>Source: <a href="https://habr.com/ru/post/50909/">https://habr.com/ru/post/50909/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../50896/index.html">At the Imagine Cup 2009</a></li>
<li><a href="../50900/index.html">Waiting for the fourth version of ESET NOD32 and ESET NOD32 Smart Security</a></li>
<li><a href="../50903/index.html">Chi.mp: Streaming + OpenID with a free second-level domain.</a></li>
<li><a href="../50904/index.html">Apple iMac - using disk images with the .mds extension - .mdf</a></li>
<li><a href="../50908/index.html">Facebook figured out how to monetize private data</a></li>
<li><a href="../50911/index.html">Chess</a></li>
<li><a href="../50912/index.html">The life of a startup during cr * sis</a></li>
<li><a href="../50917/index.html">In-circuit programmer debugger ICD2 + Ubuntu</a></li>
<li><a href="../50922/index.html">Are high performance C ++ web applications real?</a></li>
<li><a href="../50923/index.html">Rubik 360 - Rubik's Ball</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>