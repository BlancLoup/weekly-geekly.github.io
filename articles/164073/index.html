<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Simple mocking of requests to the server + unit-testing of block callbacks in Objective-C</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="What for 
 1. Why replace the server response? 
 I have always been and will be a supporter of the approach, when everyone is responsible for his doma...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Simple mocking of requests to the server + unit-testing of block callbacks in Objective-C</h1><div class="post__text post__text-html js-mediator-article"><h5>  What for </h5><br>  <i>1. Why replace the server response?</i> <br>  I have always been and will be a supporter of the approach, when everyone is responsible for his domain domain.  And let's say, if the server with the API fails, then the back-end unit tests, and not the fallen tests of my iOS application, should detect this. <br><br>  <i>2. Why use blocks, why not target-action, delegation, and so on?</i> <br>  This is a personal preference of everyone, in almost all situations, the objects I develop will have block callbacks and not call delegate methods.  For me it works and I have not experienced any special problems with this approach.  In the end, the blocks - it is stylish, fashionable, youth! <br><br><a name="habracut"></a><h5>  Asynchronous unit tests </h5><br>  Let's not stretch the article and omit some details.  I think most readers know that the test below will never fail (authorizeWithLogin ... is an asynchronous operation): 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre><code class="objectivec hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)testMyAwesomeAPI { [api authorizeWithLogin:kLogin password:kPassword completion:^(<span class="hljs-built_in"><span class="hljs-built_in">NSString</span></span> *nickname) { STAssertTrue([nickname isEqualToString:<span class="hljs-string"><span class="hljs-string">@"John"</span></span>], <span class="hljs-string"><span class="hljs-string">@""</span></span>); <span class="hljs-comment"><span class="hljs-comment">//code } error:^(NSError *error) { STAssertTrue(false, @""); //code }]; }</span></span></code> </pre> <br>  How to make the test wait for the operation to complete? <br><br>  In fact, making mass.  But most of all I liked the idea of ‚Äã‚Äãa certain 'Marin Todorov'.  Its slightly revised class is shown below: <br><br><pre> <code class="objectivec hljs"><span class="hljs-meta"><span class="hljs-meta">#import </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;Foundation/Foundation.h&gt;</span></span></span><span class="hljs-meta"> @interface TestSemaphor : NSObject @property (strong, atomic) NSMutableDictionary* flags; + (TestSemaphor *)sharedInstance; - (BOOL)isLifted:(NSString*)key; - (void)lift:(NSString*)key; - (BOOL)waitForKey:(NSString*)key; - (BOOL)waitForKey:(NSString *)key timeout:(NSTimeInterval)timeout; @end</span></span></code> </pre> <br><br><pre> <code class="objectivec hljs"><span class="hljs-meta"><span class="hljs-meta">#import </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"TestSemaphor.h"</span></span></span><span class="hljs-meta"> @implementation TestSemaphor @synthesize flags; +(TestSemaphor *)sharedInstance { static TestSemaphor *sharedInstance = nil; static dispatch_once_t once; dispatch_once(&amp;once, ^{ sharedInstance = [TestSemaphor alloc]; sharedInstance = [sharedInstance init]; }); return sharedInstance; } - (id)init { self = [super init]; if (self != nil) { self.flags = [NSMutableDictionary dictionary]; } return self; } - (BOOL)isLifted:(NSString*)key { return [self.flags objectForKey:key] != nil; } - (void)lift:(NSString*)key { [self.flags setObject:@</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"YES"</span></span></span><span class="hljs-meta"> forKey:key]; } - (BOOL)waitForKey:(NSString *)key timeout:(NSTimeInterval)timeout { BOOL keepRunning; NSDate *timeoutDate = [NSDate dateWithTimeIntervalSinceNow:timeout]; do { [[NSRunLoop currentRunLoop] runMode:NSDefaultRunLoopMode beforeDate:timeoutDate]; keepRunning = ![[TestSemaphor sharedInstance] isLifted:key]; if([timeoutDate timeIntervalSinceNow] </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt; 0.0) { [self lift:key]; return NO; } } while (keepRunning); return YES; } - (BOOL)waitForKey:(NSString*)key { return [self waitForKey:key timeout:10.0]; } @end</span></span></span></span></code> </pre> <br>  We will be interested in the methods <i>lift:</i> and <i>waitForKey:.</i>  Let's go straight to the example: <br><br><pre> <code class="objectivec hljs"><span class="hljs-built_in"><span class="hljs-built_in">NSString</span></span> *key = [<span class="hljs-built_in"><span class="hljs-built_in">NSString</span></span> UUID]; [api authorizeWithLogin:kLogin password:kPassword completion:^(<span class="hljs-built_in"><span class="hljs-built_in">NSString</span></span> *nickname) { STAssertTrue([nickname isEqualToString:<span class="hljs-string"><span class="hljs-string">@"John"</span></span>], <span class="hljs-string"><span class="hljs-string">@""</span></span>); [[TestSemaphor sharedInstance] lift:key]; <span class="hljs-comment"><span class="hljs-comment">//code } error:^(NSError *error) { STAssertTrue(false, @""); //code }]; STAssertTrue([[TestSemaphor sharedInstance] waitForKey:key], @"Failed due timeout");</span></span></code> </pre> <br>  The <i>testMyAwesomeAPI</i> method <i>will</i> not transfer control higher until the completion block is called or the wait time is exceeded. <br>  UUID - a unique identifier, the 'key' for this test. <br><br>  But, as I said, this test has a very annoying problem - it will not be executed if the Internet is not available or the server with the API has fallen. <br><br><h5>  Server independent unit tests </h5><br>  In order to abandon the server, its response must be replaced.  There are many solutions to this problem, but perhaps the most elegant one I've ever met is <a href="https://github.com/AliSoftware/OHHTTPStubs">OHHTTPStubs</a> .  According to tradition, an example at once (in my opinion, something more convenient is simply impossible to invent): <br><br><pre> <code class="objectivec hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)testMyAwesomeAPI { [OHHTTPStubs addRequestHandler:^OHHTTPStubsResponse*(<span class="hljs-built_in"><span class="hljs-built_in">NSURLRequest</span></span> *request, <span class="hljs-built_in"><span class="hljs-built_in">BOOL</span></span> onlyCheck) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [OHHTTPStubsResponse responseWithFile:<span class="hljs-string"><span class="hljs-string">@"login.json"</span></span> contentType:<span class="hljs-string"><span class="hljs-string">@"text/json"</span></span> responseTime:<span class="hljs-number"><span class="hljs-number">0.0</span></span>]; }]; <span class="hljs-built_in"><span class="hljs-built_in">NSString</span></span> *key = [<span class="hljs-built_in"><span class="hljs-built_in">NSString</span></span> UUID]; [api authorizeWithLogin:kLogin password:kPassword completion:^(<span class="hljs-built_in"><span class="hljs-built_in">NSString</span></span> *nickname) { STAssertTrue([nickname isEqualToString:<span class="hljs-string"><span class="hljs-string">@"John"</span></span>], <span class="hljs-string"><span class="hljs-string">@""</span></span>); [[TestSemaphor sharedInstance] lift:key]; <span class="hljs-comment"><span class="hljs-comment">//code } error:^(NSError *error) { STAssertTrue(false, @""); //code }]; STAssertTrue([[TestSemaphor sharedInstance] waitForKey:key], @"Failed due timeout"); }</span></span></code> </pre> <br>  Everything!  The next request to the network will be replaced and in response we will receive the contents of the login.json file. <br>  In fact, OHHTTPSpubs is not as simple as it seems, and allows you to configure your behavior quite flexibly, but you can read about it in the project wiki.  The only thing worth mentioning explicitly: <b>OHHTTPStubs uses the Private API, make sure that the production code does not use the library</b> . <br><br>  That's all.  Thanks for attention! </div><p>Source: <a href="https://habr.com/ru/post/164073/">https://habr.com/ru/post/164073/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../164055/index.html">Anatomy of a gadget: digging into the filling of Samsung GALAXY Note II</a></li>
<li><a href="../164057/index.html">PHDays CTF Quals: BINARY 500, or how to hide the flag below the baseboard</a></li>
<li><a href="../164059/index.html">How I paid for my free Android application</a></li>
<li><a href="../164061/index.html">Evenings on Gamersweb.ru - podcast about games, movies, books, and much more</a></li>
<li><a href="../164063/index.html">Promotion for startups. Results</a></li>
<li><a href="../164077/index.html">Post-mortem: Divine Space on Kickstarter.com</a></li>
<li><a href="../164083/index.html">The lessons of writing utilities for $ 1 000 000</a></li>
<li><a href="../164085/index.html">MySQL: we destroy stereotypes</a></li>
<li><a href="../164087/index.html">Center for collective development of microelectronics in Russia, stage I</a></li>
<li><a href="../164089/index.html">ABBYY-Habra-blog: results of the year</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>