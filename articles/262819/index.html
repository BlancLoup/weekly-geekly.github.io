<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Mail Protocol Diagnostics</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This article is about diagnosing mail protocols. It is intended for novice administrators who want to learn more about the tools for quickly testing t...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Mail Protocol Diagnostics</h1><div class="post__text post__text-html js-mediator-article">  This article is about diagnosing mail protocols.  It is intended for novice administrators who want to learn more about the tools for quickly testing the authorization / sending / receiving of e-mail messages both by the server and by the client.  But it can also serve as a good reminder of the relevant teams for more experienced administrators. <br><br>  The material is broken down as follows: <br><br>  <a href="https://habr.com/company/truevds/blog/262819/">1. Introduction</a> <br>  <a href="https://habr.com/company/truevds/blog/262819/">2. Examples of sessions</a> <br>  <a href="https://habr.com/company/truevds/blog/262819/">3. Check authorization on the server (LOGIN, PLAIN, CRAM-MD5), Base64</a> <br>  <a href="https://habr.com/company/truevds/blog/262819/">4. Check SSL / TLS encryption</a> <br>  <a href="https://habr.com/company/truevds/blog/262819/">5. Analysis of mail traffic using tshark.</a>  <a href="https://habr.com/company/truevds/blog/262819/">SSL / TLS decryption</a> <br>  <a href="https://habr.com/company/truevds/blog/262819/">6. Links to materials</a> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/files/89d/97c/55a/89d97c55a8414129a8beaa2d27afe8c1.jpg"><br><br><a name="habracut"></a><br><br><a name="intro"></a><h1>  1. Introduction </h1><br>  There are enough materials on individual points in the network, but everything is scattered in different places and, when there is a need to perform this or that operation, you have to recall authorization nuances, methods of fast encoding in base64, keys to openssl and tshark for various resources.  Here everything is gathered together, and information about SSL / TLS traffic decryption has been added. <br><br><h3>  Legend </h3><br>  $ - an invitation in a regular shell, the command specified after it is executed from a regular user <br><br>  # - invitation in the root shell, the command specified after it is executed with administrator rights <br><br>  ## - line with the comment <br><br>  Client request in mail sessions is in bold. <br><br><h3>  Post ports </h3><br>  The main ports used in the work of mail servers by RFC (documents regulating the work of the Internet and its main components): <br><br><h5>  SMTP </h5><br><ul><li>  25 / tcp SMTP (standard port) </li><li>  465 / tcp SMTPS (outdated) </li><li>  587 / tcp submission (port for customer service) </li></ul><br><br><h5>  Pop3 </h5><br><ul><li>  110 / tcp POP3 (standard port) </li><li>  995 / tcp POP3S (port with pre-installed SSL / TLS connection) </li></ul><br><br><h5>  IMAP </h5><br><ul><li>  143 / tcp IMAP (standard port) </li><li>  993 / tcp IMAPS (port with pre-set SSL / TLS connection) </li></ul><br><br>  Only the main ones are listed here; in addition to these, different server implementations can use other ports for their service purposes, for the user and administrative web interface, cluster nodes communication, etc. <br><br><h3>  Used and recommended utilities </h3><br>  The article uses telnet, openssl, tshark.  For clarity, the interaction between the server and the client, the use of protocol commands.  On a regular basis and to automate some processes, you can use utilities that hide all these details from us, but which are easier included in the scripts.  Of these utilities, I can recommend the perl <b>smtp-cli script</b> (http://www.logix.cz/michal/devel/smtp-cli/), which has broad functionality, including SMTP authorization.  I also recommend the <b>imtest</b> utility from cyrus-clients that you can use to test the IMAP protocol.  <b>smtp-sink</b> , a postfix utility that emulates a mail server.  With its help, you can debug the work of your mail client in the event that you do not have access to existing mail servers or the ability to enable detailed logging in the client settings. <br><br>  With the help of <b>nmap,</b> you can quickly check if the ports are accessible from the outside, that is, if they listen to the programs and if the firewall is not closed: <br><br><pre><code class="markdown hljs"><span class="hljs-section"><span class="hljs-section"># nmap -v -p25,110,143,465,587,993,995 127.0.0.1 Starting Nmap 4.11 ( http://www.insecure.org/nmap/ ) at 2014-10-31 15:59 MSK Initiating SYN Stealth Scan against localhost.localdomain (127.0.0.1) [7 ports] at 15:59 Discovered open port 25/tcp on 127.0.0.1 Discovered open port 465/tcp on 127.0.0.1 Discovered open port 143/tcp on 127.0.0.1 Discovered open port 993/tcp on 127.0.0.1 The SYN Stealth Scan took 0.00s to scan 7 total ports. Host localhost.localdomain (127.0.0.1) appears to be up ... good. Interesting ports on localhost.localdomain (127.0.0.1): PORT STATE SERVICE 25/tcp open smtp 110/tcp closed pop3 143/tcp open imap 465/tcp open smtps 587/tcp closed submission 993/tcp open imaps 995/tcp closed pop3s Nmap finished: 1 IP address (1 host up) scanned in 0.004 seconds Raw packets sent: 7 (308B) | Rcvd: 17 (724B)</span></span></code> </pre> <br>  This conclusion shows that the server has SMTP / IMAP ports available, but ports for <br>  POP3 protocol. <br><br>  Through <b>netstat</b> you can see not only the ports that are being listened to and used, as is often assumed, but also the processes associated with these ports.  Here is the netstat output for the same mail server: <br><br><pre> <code class="markdown hljs"><span class="hljs-section"><span class="hljs-section"># netstat -lnpvut ( -anpvut,       ) Active Internet connections (only servers) Proto Recv-Q Send-Q Local Address Foreign Address State PID/Program name tcp 0 0 0.0.0.0:143 0.0.0.0:* LISTEN 477/dovecot tcp 0 0 0.0.0.0:2000 0.0.0.0:* LISTEN 477/dovecot tcp 0 0 0.0.0.0:465 0.0.0.0:* LISTEN 603/master tcp 0 0 127.0.0.1:53 0.0.0.0:* LISTEN 430/unbound tcp 0 0 0.0.0.0:22 0.0.0.0:* LISTEN 10042/sshd tcp 0 0 0.0.0.0:25 0.0.0.0:* LISTEN 603/master tcp 0 0 0.0.0.0:1025 0.0.0.0:* LISTEN 603/master tcp 0 0 0.0.0.0:993 0.0.0.0:* LISTEN 477/dovecot tcp 0 0 127.0.0.1:1953 0.0.0.0:* LISTEN 430/unbound tcp 0 0 127.0.0.1:1026 0.0.0.0:* LISTEN 603/master tcp 0 0 127.0.0.1:2025 0.0.0.0:* LISTEN 603/master tcp 0 0 :::22 :::* LISTEN 10042/sshd udp 0 0 127.0.0.1:53 0.0.0.0:* 430/unbound</span></span></code> </pre><br>  In this example, postfix is ‚Äã‚Äãused as the SMTP server and dovecot is used as the IMAP.  POP3 is missing from the list, as this protocol is disabled in the dovecot settings as unused. <br><br>  In modern distributions, the net-tools package is often not installed, it is considered obsolete.  The <b>ss</b> utility from iproute is used as a replacement.  It is more narrowly sharpened and in its own area is probably a more functional utility with the ability to configure filters as in tcpdump / tshark.  But I, for one, do not like the way the output of information is formatted.  To fix this a bit, you can use sed: <br><br><pre> <code class="markdown hljs"><span class="hljs-section"><span class="hljs-section"># ss -lntp | sed -r 's/\t/ /g' Recv-Q Send-Q Local Address:Port Peer Address:Port 0 0 *:143 *:* users:(("dovecot",477,6),("imap-login",14400,4),("imap-login",15370,4),("imap-login",15372,4)) 0 0 *:2000 *:* users:(("dovecot",477,8),("managesieve-log",10229,4),("managesieve-log",10230,4),("managesieve-log",21149,4)) 0 0 *:465 *:* users:(("master",603,31)) 0 0 127.0.0.1:53 *:* users:(("unbound",430,4)) 0 0 *:22 *:* users:(("sshd",10042,4)) 0 0 *:25 *:* users:(("master",603,19)) 0 0 *:1025 *:* users:(("master",603,12)) 0 0 *:993 *:* users:(("dovecot",477,7),("imap-login",14400,5),("imap-login",15370,5),("imap-login",15372,5)) 0 0 127.0.0.1:1953 *:* users:(("unbound",430,5)) 0 0 127.0.0.1:1026 *:* users:(("master",603,16)) 0 0 127.0.0.1:2025 *:* users:(("master",603,28)) 0 0 :::22 :::* users:(("sshd",10042,3))</span></span></code> </pre><br>  *) for ease of use, you can put the following bash function in ~ / .bashrc <br><br><pre> <code class="markdown hljs">ss() { /sbin/ss $@ | sed -r 's/\t/ /g'; }</code> </pre><br><br><a name="examples"></a><h1>  2. Examples of sessions </h1><br>  Here are examples of sessions on SMTP / IMAP / POP3 protocols.  The connection uses a telnet client, which is either installed by default in the system or installed from the repositories: <br><br><h5>  Debian / Ubuntu </h5><br><pre> <code class="markdown hljs"><span class="hljs-section"><span class="hljs-section"># apt-cache search telnet # apt-get install telnet</span></span></code> </pre><br><h5>  RHEL / CentOS / Fedora </h5><br><pre> <code class="markdown hljs"><span class="hljs-section"><span class="hljs-section"># yum search telnet # yum install telnet</span></span></code> </pre><br><br>  Commands entered in the text <b>in</b> bold. <br><br><h5>  SMTP </h5><br><pre> <code class="markdown hljs">$ telnet 127.0.0.1 25 Trying 127.0.0.1... Connected to 127.0.0.1. Escape character is '^]'. 220 mailserver at mail.server.net greets you. Make love not war!</code> </pre><pre> <b><code class="markdown hljs">HELO localhost.localdomain</code></b> </pre> <pre> <code class="markdown hljs">250 mail.server.net</code> </pre><pre> <b><code class="markdown hljs">MAIL FROM:<span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;&gt;</span></span></span></span></code></b> </pre> <pre> <code class="markdown hljs">250 2.1.0 Ok</code> </pre><pre> <b><code class="markdown hljs">RCPT TO:<span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">user@mail.server.net</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span></code></b> </pre> <pre> <code class="markdown hljs">250 2.1.5 Ok</code> </pre><pre> <b><code class="markdown hljs">DATA</code></b> </pre> <pre> <code class="markdown hljs">354 End data with <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">CR</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span><span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">LF</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span>.<span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">CR</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span><span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">LF</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span> FROM: root@localhost.localdomain TO: user@mail.server.net SUBJECT: test mail from test subject test body</code> </pre><pre> <b><code class="markdown hljs">.</code></b> </pre> <pre> <code class="markdown hljs">250 2.0.0 Ok: queued as 1CF5FC0AAE QUIT 221 2.0.0 Bye Connection closed by foreign host.</code> </pre><br><br><h5>  IMAP </h5><br><pre> <code class="markdown hljs">$ telnet 127.0.0.1 143 Trying 127.0.0.1... Connected to 127.0.0.1. Escape character is '^]'. * OK IMAP Server at mail.server.net ready</code> </pre><pre> <b><code class="markdown hljs">001 LOGIN user@mail.server.net testpass</code></b> </pre> <pre> <code class="markdown hljs">001 OK completed</code> </pre><pre> <b><code class="markdown hljs">002 CAPABILITY</code></b> </pre> <pre> <code class="markdown hljs"><span class="hljs-bullet"><span class="hljs-bullet">* </span></span>CAPABILITY IMAP4 IMAP4REV1 ACL NAMESPACE UIDPLUS IDLE LITERAL+ QUOTA ID MULTIAPPEND LISTEXT CHILDREN BINARY LOGIN-REFERRALS STARTTLS AUTH=LOGIN AUTH=PLAIN AUTH=CRAM-MD5 AUTH=DIGEST-MD5 AUTH=MSN 002 OK completed</code> </pre><pre> <b><code class="markdown hljs">003 SELECT Inbox</code></b> </pre> <pre> <code class="markdown hljs"><span class="hljs-bullet"><span class="hljs-bullet">* </span></span>FLAGS (\Answered \Flagged \Deleted \Seen \Draft $MDNSent) <span class="hljs-bullet"><span class="hljs-bullet">* OK [PERMANENTFLAGS (\Answered \Flagged \Deleted \Seen \Draft $MDNSent)] limited *</span></span> 7214 EXISTS <span class="hljs-bullet"><span class="hljs-bullet">* 0 RECENT *</span></span> OK [UIDVALIDITY 306349424] UIDs valid * OK [UNSEEN 1] message 1 is first unseen 003 OK [READ-WRITE] SELECT completed</code> </pre><pre> <b><code class="markdown hljs">004 FETCH 7214 body[header]</code></b> </pre> <pre> <code class="markdown hljs"><span class="hljs-bullet"><span class="hljs-bullet">* </span></span>7214 FETCH (BODY[header] {639} Return-Path: <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;&gt;</span></span></span></span> X-Antispam-passed: yes X-Antispam: yes X-Real-To: user@mail.server.net Received: from [127.0.0.1] (HELO mail.server.net) by mail.server.net ( SMTP 4.1.8) with ESMTP id 22561074 for user@mail.server.net; Sat, 01 Nov 2014 03:21:16 +0300 Received: from localhost.localdomain (localhost [127.0.0.1]) by mail.server.net (Postfix) with SMTP id 1CF5FC0AAE for <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">user@mail.server.net</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span>; Sat, 1 Nov 2014 03:20:09 +0300 (MSK) FROM: root@localhost.localdomain TO: user@mail.server.net SUBJECT: test mail from test subject Message-Id: <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">20141101002009.1CF5FC0AAE@mail.server.net</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span> Date: Sat, 1 Nov 2014 03:20:09 +0300 (MSK) FLAGS (\Seen)) 004 OK completed</code> </pre><pre> <b><code class="markdown hljs">004 FETCH 7214 body</code></b> </pre> <pre> <code class="markdown hljs"><span class="hljs-bullet"><span class="hljs-bullet">* </span></span>7214 FETCH (BODY ("text" "plain" NIL NIL NIL "8bit" 13 2)) 004 OK completed 004 FETCH 7214 body[] * 7214 FETCH (BODY[] {652} Return-Path: <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;&gt;</span></span></span></span> X-Antispam-passed: yes X-Antispam: yes X-Real-To: user@mail.server.net Received: from [127.0.0.1] (HELO mail.server.net) by mail.server.net ( SMTP 4.1.8) with ESMTP id 22561074 for user@mail.server.net; Sat, 01 Nov 2014 03:21:16 +0300 Received: from localhost.localdomain (localhost [127.0.0.1]) by mail.server.net (Postfix) with SMTP id 1CF5FC0AAE for <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">user@mail.server.net</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span>; Sat, 1 Nov 2014 03:20:09 +0300 (MSK) FROM: root@localhost.localdomain TO: user@mail.server.net SUBJECT: test mail from test subject Message-Id: <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">20141101002009.1CF5FC0AAE@mail.server.net</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span> Date: Sat, 1 Nov 2014 03:20:09 +0300 (MSK) test body ) 004 OK completed</code> </pre><pre> <b><code class="markdown hljs">005 LOGOUT</code></b> </pre> <pre> <code class="markdown hljs"><span class="hljs-bullet"><span class="hljs-bullet">* </span></span>BYE IMAP closing connection 005 OK completed Connection closed by foreign host.</code> </pre><br><br><h5>  Pop3 </h5><br><pre> <code class="markdown hljs">$ telnet 127.0.0.1 110 Trying 127.0.0.1... Connected to 127.0.0.1. Escape character is '^]'. +OK POP3 Server 4.1.8 ready <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">137.1414802293@mail.server.net</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span></code> </pre><pre> <b><code class="markdown hljs">USER test@mail.server.net</code></b> </pre> <pre> <code class="markdown hljs">+OK please send the PASS</code> </pre><pre> <b><code class="markdown hljs">PASS testpass</code></b> </pre> <pre> <code class="markdown hljs">+OK 7214 messages (174404489 bytes)</code> </pre><pre> <b><code class="markdown hljs">NOOP</code></b> </pre> <pre> <code class="markdown hljs">+OK cool</code> </pre><pre> <b><code class="markdown hljs">TOP 7214</code></b> </pre> <pre> <code class="markdown hljs">+OK message follows Return-Path: <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;&gt;</span></span></span></span> X-Antispam-passed: yes X-Antispam: yes X-Real-To: test@mail.server.net Received: from [127.0.0.1] (HELO mail.server.net) by mail.server.net ( SMTP 4.1.8) with ESMTP id 22561074 for test@mail.server.net; Sat, 01 Nov 2014 03:21:16 +0300 Received: from localhost.localdomain (localhost [127.0.0.1]) by mail.server.net (Postfix) with SMTP id 1CF5FC0AAE for <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">test@mail.server.net</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span>; Sat, 1 Nov 2014 03:20:09 +0300 (MSK) FROM: root@localhost.localdomain TO: test@mail.server.net SUBJECT: test mail from test subject Message-Id: <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">20141101002009.1CF5FC0AAE@mail.server.net</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span> Date: Sat, 1 Nov 2014 03:20:09 +0300 (MSK) .</code> </pre><pre> <b><code class="markdown hljs">RETR 7214</code></b> </pre> <pre> <code class="markdown hljs">+OK 652 bytes will follow Return-Path: <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;&gt;</span></span></span></span> X-Antispam-passed: yes X-Antispam: yes X-Real-To: test@mail.server.net Received: from [127.0.0.1] (HELO mail.server.net) by mail.server.net ( SMTP 4.1.8) with ESMTP id 22561074 for test@mail.server.net; Sat, 01 Nov 2014 03:21:16 +0300 Received: from localhost.localdomain (localhost [127.0.0.1]) by mail.server.net (Postfix) with SMTP id 1CF5FC0AAE for <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">test@mail.server.net</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span>; Sat, 1 Nov 2014 03:20:09 +0300 (MSK) FROM: root@localhost.localdomain TO: test@mail.server.net SUBJECT: test mail from test subject Message-Id: <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">20141101002009.1CF5FC0AAE@mail.server.net</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span> Date: Sat, 1 Nov 2014 03:20:09 +0300 (MSK) test body .</code> </pre><pre> <b><code class="markdown hljs">DELE 7214</code></b> </pre> <pre> <code class="markdown hljs">+OK marked deleted</code> </pre><pre> <b><code class="markdown hljs">QUIT</code></b> </pre> <pre> <code class="markdown hljs">+OK POP3 Server connection closed Connection closed by foreign host.</code> </pre><br><br><a name="auth"></a><br><h1>  3. Check authorization on the server </h1><br>  Existing authorization methods: LOGIN, PLAIN, CRAM-MD5, DIGEST-MD5, GSSAPI, NTLM / MSN, EXTERNAL.  Their list is even wider, we consider only the most common ones, namely LOGIN, PLAIN and CRAM-MD5. <br><br>  The first step is to find out the list of methods supported by the server.  For each of the mail protocols there are commands that allow you to get this data along with other information about the available protocol extensions.  Please note that, depending on the settings of the mail server, LOGIN and PLAIN, which transmit data in the clear, may not be available without prior initialization of encryption via SSL / TLS <br><br>  So, the output of the available authentication methods: <br><br><h4>  SMTP protocol </h4><br><h5>  EHLO domainname command </h5><br><pre> <code class="markdown hljs">$ telnet 127.0.0.1 25 Trying 127.0.0.1... Connected to 127.0.0.1. Escape character is '^]'. 220 mailserver ESMTP ready.</code> </pre><pre> <b><code class="markdown hljs">EHLO localhost.localdomain</code></b> </pre> <pre> <code class="markdown hljs">250-mal.server.net 250-PIPELINING 250-SIZE 104857600 250-ETRN 250-STARTTLS 250-AUTH PLAIN LOGIN DIGEST-MD5 CRAM-MD5 250-AUTH=PLAIN LOGIN DIGEST-MD5 CRAM-MD5 250-ENHANCEDSTATUSCODES 250 8BITMIME ^] telnet&gt; quit Connection closed.</code> </pre><br><br><h4>  IMAP protocol </h4><br><h5>  Team 001 CAPABILITY </h5><br>  Some e-mail servers can display this information in the ‚Äúserver greeting,‚Äù for example, dovecot. <br><br><pre> <code class="markdown hljs">$ telnet 127.0.0.1 143 Trying 127.0.0.1... Connected to 127.0.0.1. Escape character is '^]'. * OK [CAPABILITY IMAP4rev1 LITERAL+ SASL-IR LOGIN-REFERRALS ID ENABLE STARTTLS AUTH=PLAIN AUTH=LOGIN AUTH=DIGEST-MD5 AUTH=CRAM-MD5] Dovecot ready.</code> </pre><pre> <b><code class="markdown hljs">001 CAPABILITY</code></b> </pre> <pre> <code class="markdown hljs"><span class="hljs-bullet"><span class="hljs-bullet">* </span></span>CAPABILITY IMAP4rev1 LITERAL+ SASL-IR LOGIN-REFERRALS ID ENABLE SORT SORT=DISPLAY THREAD=REFERENCES THREAD=REFS MULTIAPPEND UNSELECT IDLE CHILDREN NAMESPACE UIDPLUS LIST-EXTENDED I18NLEVEL=1 CONDSTORE QRESYNC ESEARCH ESORT SEARCHRES WITHIN CONTEXT=SEARCH LIST-STATUS XEXEC QUOTA STARTTLS AUTH=PLAIN AUTH=LOGIN AUTH=DIGEST-MD5 AUTH=CRAM-MD5 001 OK Capability completed.</code> </pre><pre> <b><code class="markdown hljs">002 LOGOUT</code></b> </pre> <pre> <code class="markdown hljs"><span class="hljs-bullet"><span class="hljs-bullet">* </span></span>BYE Logging out 002 OK Logout completed. Connection closed by foreign host.</code> </pre><br><br><h4>  POP3 protocol </h4><br><h5>  AUTH or CAPA Commands </h5><br><pre> <code class="markdown hljs">$ telnet pop.mail.ru 110 Trying 217.69.139.74... Connected to pop.mail.ru. Escape character is '^]'. +OK</code> </pre><pre> <b><code class="markdown hljs">AUTH</code></b> </pre> <pre> <code class="markdown hljs">+OK methods supported: LOGIN PLAIN .</code> </pre><pre> <b><code class="markdown hljs">CAPA</code></b> </pre> <pre> <code class="markdown hljs">+OK Capability list follows TOP USER LOGIN-DELAY 120 EXPIRE NEVER UIDL IMPLEMENTATION Mail.Ru SASL LOGIN PLAIN STLS .</code> </pre><pre> <b><code class="markdown hljs">QUIT</code></b> </pre> <pre> <code class="markdown hljs">+OK POP3 server at signing off Connection closed by foreign host.</code> </pre><br><br><h2>  Authorization Examples and Format Used </h2><br><h4>  LOGIN </h4><br><h5>  SMTP protocol </h5><br><pre> <code class="markdown hljs">$ telnet 127.0.0.1 25 Trying 127.0.0.1... Connected to 127.0.0.1. Escape character is '^]'. 220 mail.server.net ESMTP Server</code> </pre><pre> <b><code class="markdown hljs">EHLO client.server.net</code></b> </pre> <pre> <code class="markdown hljs">250-mail.server.net Hello client.server.net 250-AUTH LOGIN PLAIN CRAM-MD5 DIGEST-MD5 GSSAPI 250-ENHANCEDSTATUSCODES 250 STARTTLS</code> </pre><pre> <b><code class="markdown hljs">AUTH LOGIN</code></b> </pre> <pre> <code class="markdown hljs">334 VXNlcm5hbWU6</code> </pre><pre> <b><code class="markdown hljs">dGVzdA==</code></b> </pre> <pre> <code class="markdown hljs">334 UGFzc3dvcmQ6</code> </pre><pre> <b><code class="markdown hljs">dGVzdHBhc3M=</code></b> </pre> <pre> <code class="markdown hljs">235 2.7.0 Authentication successful</code> </pre><pre> <b><code class="markdown hljs">QUIT</code></b> </pre> <pre> <code class="markdown hljs">221 2.0.0 Bye</code> </pre><br><br>  Where 'dGVzdA ==' is the login and 'dGVzdHBhc3M =' is the password in base64 format.  About him a little lower.  Please note that both login and password must be encoded without a line break. <br><br><h4>  Plain </h4><br><h5>  SMTP protocol </h5><br><pre> <code class="markdown hljs">$ telnet 127.0.0.1 25 Trying 127.0.0.1... Connected to 127.0.0.1. Escape character is '^]'. 220 mail.server.net ESMTP Server</code> </pre><pre> <b><code class="markdown hljs">EHLO client.server.net</code></b> </pre> <pre> <code class="markdown hljs">250-mail.server.net Hello client.server.net 250-AUTH LOGIN PLAIN CRAM-MD5 DIGEST-MD5 GSSAPI 250-ENHANCEDSTATUSCODES 250 STARTTLS</code> </pre><pre> <b><code class="markdown hljs">AUTH PLAIN dGVzdAB0ZXN0AHRlc3RwYXNz</code></b> </pre> <pre> <code class="markdown hljs">235 2.7.0 Authentication successful</code> </pre><pre> <b><code class="markdown hljs">QUIT</code></b> </pre> <pre> <code class="markdown hljs">221 2.0.0 Bye</code> </pre><br>  Where 'dGVzdAB0ZXN0AHRlc3RwYXNz' is the login password in base64 format.  Below will be considered options for converting to base64 format and back. <br><br><h4>  CRAM-MD5 </h4><br>  Unlike the previous CRAM-MD5 authorization methods, the password is not transmitted in the clear, the hash comparison is used instead.  Manual verification of this method of authorization can be a problem, since it will be necessary to perform several transformations, and the time to enter commands is limited.  To simplify the process, the following is a simple perl script that accepts a username, password and a ‚Äúcode word‚Äù (issued by the server) and converts them into a string in base64 format. <br><br>  The script will need an additional perl module ‚ÄúDigest-HMAC‚Äù.  In Debian / Ubuntu, you can find and install it as follows: <br><br><pre> <code class="markdown hljs"><span class="hljs-section"><span class="hljs-section"># apt-cache search perl | grep -i digest # apt-get install libdigest-hmac-perl</span></span></code> </pre><br>  For RHEL / CentOS / Fedora: <br><br><pre> <code class="markdown hljs"><span class="hljs-section"><span class="hljs-section"># yum search perl | grep -i digest # yum install perl-Digest-HMAC</span></span></code> </pre><br>  In distributions whose repositories do not have this package (which is unlikely), you can use the installation module from CPAN. <br><br>  Script and sample session using it: <br><br><pre> <code class="perl hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/perl -W use strict; use MIME::Base64 qw(encode_base64 decode_base64); use Digest::HMAC_MD5; die "Usage: $0 username password ticket\n" unless $#ARGV == 2; my ($username, $password, $ticket64) = @ARGV; my $ticket = decode_base64($ticket64) or die ("Unable to decode Base64 encoded string '$ticket64'\n"); my $password_md5 = Digest::HMAC_MD5::hmac_md5_hex($ticket, $password); print encode_base64 ("$username $password_md5", "");</span></span></code> </pre><br><br><h5>  SMTP protocol </h5><br><pre> <code class="markdown hljs">$ telnet 127.0.0.1 25 Trying 127.0.0.1... Connected to 127.0.0.1. Escape character is '^]'. 220 mail.server.net ESMTP Server</code> </pre><pre> <b><code class="markdown hljs">EHLO client.server.net</code></b> </pre> <pre> <code class="markdown hljs">250-mail.server.net Hello client.server.net 250-AUTH LOGIN PLAIN CRAM-MD5 DIGEST-MD5 GSSAPI 250-ENHANCEDSTATUSCODES 250 STARTTLS</code> </pre><pre> <b><code class="markdown hljs">AUTH CRAM-MD5</code></b> </pre> <pre> <code class="markdown hljs"><span class="hljs-section"><span class="hljs-section">##  ,  : PDMzMjE2NDkzMTA1OTExNDQuMTQxNDc5NTExOUBtYWlsLnNlcnZlci5uZXQ+</span></span></code> </pre><pre> <b><code class="markdown hljs">dGVzdCAxNTU0YTQwNzA1NTgxZjUwZmI1MmNjZDhlZDhjM2EyYg==</code></b> </pre> <pre> <code class="markdown hljs">235 2.7.0 Authentication successful</code> </pre><pre> <b><code class="markdown hljs">QUIT</code></b> </pre> <pre> <code class="markdown hljs">221 2.0.0 Bye # ./md5cram.pl test testpass PDMzMjE2NDkzMTA1OTExNDQuMTQxNDc5NTExOUBtYWlsLnNlcnZlci5uZXQ+ dGVzdCAxNTU0YTQwNzA1NTgxZjUwZmI1MmNjZDhlZDhjM2EyYg==</code> </pre><br><br><h5>  IMAP protocol </h5><br><pre> <code class="markdown hljs">$ telnet 127.0.0.1 143 Trying 127.0.0.1... Connected to 127.0.0.1. Escape character is '^]'. * OK [CAPABILITY IMAP4rev1 LITERAL+ SASL-IR LOGIN-REFERRALS ID ENABLE STARTTLS AUTH=PLAIN AUTH=LOGIN AUTH=DIGEST-MD5 AUTH=CRAM-MD5] Dovecot ready.</code> </pre><pre> <b><code class="markdown hljs">01 AUTHENTICATE CRAM-MD5</code></b> </pre> <pre> <code class="markdown hljs"><span class="hljs-bullet"><span class="hljs-bullet">+ </span></span>PDgxOTAyMjA2NTYwNzcyMzEuMTQxNDc5NzA3MkBtYWlsLnNlcnZlci5uZXQ+</code> </pre><pre> <b><code class="markdown hljs">dGVzdCA1YTZlNjYwMDlmZGJlZWNjYWRlNDY5M2FlMjU5YTA2ZQ==</code></b> </pre> <pre> <code class="markdown hljs">01 OK [CAPABILITY IMAP4rev1 LITERAL+ SASL-IR LOGIN-REFERRALS ID ENABLE SORT SORT=DISPLAY THREAD=REFERENCES THREAD=REFS MULTIAPPEND UNSELECT IDLE CHILDREN NAMESPACE UIDPLUS LIST-EXTENDED I18NLEVEL=1 CONDSTORE QRESYNC ESEARCH ESORT SEARCHRES WITHIN CONTEXT=SEARCH LIST-STATUS XEXEC QUOTA] Logged in</code> </pre><pre> <b><code class="markdown hljs">02 LOGOUT</code></b> </pre> <pre> <code class="markdown hljs"><span class="hljs-bullet"><span class="hljs-bullet">* </span></span>BYE Logging out 02 OK Logout completed. Connection closed by foreign host. # ./md5cram.pl test testpass PDgxOTAyMjA2NTYwNzcyMzEuMTQxNDc5NzA3MkBtYWlsLnNlcnZlci5uZXQ+ dGVzdCA1YTZlNjYwMDlmZGJlZWNjYWRlNDY5M2FlMjU5YTA2ZQ==</code> </pre><br><br><h2>  Converting text to and from base64 </h2><br>  Authorization involves the exchange of strings encoded in base64.  For Linux, there are many utilities for converting to base64 and back.  We will indicate a few, including how to launch them.  For Windows, you can use cross-platform perl, python, php, examples will also be provided. <br><br><h3>  Utility (package) </h3><br><h4>  base64 (coreutils) </h4><br><pre> <code class="markdown hljs">$ printf 'test\0test\0testpass' | base64 dGVzdAB0ZXN0AHRlc3RwYXNz $ echo dGVzdAB0ZXN0AHRlc3RwYXNz | base64 -d testtesttestpass</code> </pre><br><h4>  uueencode / uudecode (sharutils) </h4><br><pre> <code class="markdown hljs">$ printf 'test\0test\0testpass' | uuencode -m - begin-base64 644 - dGVzdAB0ZXN0AHRlc3RwYXNz ====</code> </pre><br>  To decode, you need to add the first and last line.  This can be done, for example, in the following ways; <br><br><pre> <code class="markdown hljs">printf 'begin-base64 644 -\ndGVzdAB0ZXN0AHRlc3RwYXNz\n====' | uudecode</code> </pre><br>  or <br><br><pre> <code class="markdown hljs">$ uudecode<span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;&lt;</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">EOF</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">begin-base64</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">644</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">-</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">dGVzdAB0ZXN0AHRlc3RwYXNz</span></span></span></span><span class="xml"><span class="hljs-tag"> ==== </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">EOF</span></span></span></span></span></span></code> </pre><br><h4>  mmencode (xemacs21-bin) </h4><br><pre> <code class="markdown hljs">$ printf 'test\0test\0testpass' | mmencode dGVzdAB0ZXN0AHRlc3RwYXNz $ echo dGVzdAB0ZXN0AHRlc3RwYXNz | mmencode -u testtesttestpass</code> </pre><br><h4>  python (python) </h4><br><pre> <code class="markdown hljs">$ printf 'test\0test\0testpass' | python -m base64 dGVzdAB0ZXN0AHRlc3RwYXNz $ echo dGVzdAB0ZXN0AHRlc3RwYXNz | python -m base64 -d</code> </pre><br><h4>  php (php-cli) </h4><br><pre> <code class="markdown hljs">$ printf 'test\0test\0testpass' | php -r 'echo base64<span class="hljs-emphasis"><span class="hljs-emphasis">_encode(fgets(STDIN));' dGVzdAB0ZXN0AHRlc3RwYXNz $ php -r 'echo base64_</span></span>decode($argv[1]);' dGVzdAB0ZXN0AHRlc3RwYXNz testtesttestpass</code> </pre><br><h4>  perl (perl) </h4><br>  The MMIME :: Base64 module comes bundled as standard. <br><br><pre> <code class="markdown hljs">$ perl -MMIME::Base64 -e 'print encode<span class="hljs-emphasis"><span class="hljs-emphasis">_base64("test\0test\0testpass")' dGVzdAB0ZXN0AHRlc3RwYXNz $ perl -MMIME::Base64 -e 'print decode_</span></span>base64("dGVzdAB0ZXN0AHRlc3RwYXNz")' testtesttestpass</code> </pre><br><br><h4>  openssl (openssl) </h4><br><pre> <code class="markdown hljs">$ printf 'test\0test\0testpass' | openssl base64 dGVzdAB0ZXN0AHRlc3RwYXNz $ echo dGVzdAB0ZXN0AHRlc3RwYXNz | openssl base64 -d testtesttestpass</code> </pre><br><br><a name="crypt"></a><br><h1>  4. Check SSL / TLS encryption. </h1><br>  SSL / TLS in two options is used to encrypt traffic in mail protocols between the client and the server.  Using special ports, when connecting with which you first install SSL / TLS, after which normal mail traffic goes over it.  This method, by the way, is deprecated, relative to SMTP for sure.  The second option, the preferred one, is a connection to a normal port for the service and the session transition to an encrypted form using the STARTTLS extension. <br><br>  To test the mail server over SSL / TLS, you can use the openssl utility, further acting as in a normal telnet session. <br><br><h4>  SMTP </h4><br><pre> <code class="markdown hljs">$ openssl s<span class="hljs-emphasis"><span class="hljs-emphasis">_client -starttls smtp -crlf -connect mail.truevds.ru:25 $ openssl s_</span></span>client -starttls smtp -crlf -connect mail.truevds.ru:587 $ openssl s_client -crlf -connect mail.truevds.ru:465</code> </pre><br><br><h4>  Pop3 </h4><br><pre> <code class="markdown hljs">$ openssl s<span class="hljs-emphasis"><span class="hljs-emphasis">_client -connect mail.truevds.ru:995 $ openssl s_</span></span>client -starttls pop3 -crlf -connect mail.truevds.ru:110</code> </pre><br><br><h4>  IMAP </h4><br><pre> <code class="markdown hljs">$ openssl s<span class="hljs-emphasis"><span class="hljs-emphasis">_client -crlf -connect mail.truevds.ru:993 $ openssl s_</span></span>client -starttls imap -crlf -connect mail.truevds.ru:143</code> </pre><br><br>  You can explicitly specify what to use for encryption, ssl3 or tls1, as well as specific algorithms: <br><br><pre> <code class="markdown hljs">$ openssl s_client -ssl3 -starttls smtp -crlf -connect mail.truevds.ru:25</code> </pre><br><br>  View a list of supported protocols in your openssl version: <br><br><pre> <code class="markdown hljs">$ openssl ciphers -ssl3 $ openssl ciphers -tls1</code> </pre><br><br>  Below, in the tshark chapter, this feature will be used for practical purposes. <br><br><a name="analize"></a><h1>  5. Analysis of mail traffic using tshark.  SSL / TLS decryption </h1><br>  If you need more complex diagnostics in the case when the logs do not provide enough information about problems in the server or client, you can use tcpdump / wireshark to analyze the session itself between the client and the server.  Both in real time and saving the dump session for later analysis.  For quick analysis it is convenient to use the console version of wireshark - tshark.  It requires root privileges. <br><br>  Tshark provides information in a clear form and in use is quite simple. <br><br><h4>  SMTP </h4><br><pre> <code class="markdown hljs"><span class="hljs-section"><span class="hljs-section"># tshark -i eth0 -f "port 25" -R smtp</span></span></code> </pre><br><br><h4>  IMAP </h4><br><pre> <code class="markdown hljs"><span class="hljs-section"><span class="hljs-section"># tshark -i eth0 -f "port 143" -R imap</span></span></code> </pre><br><br><h4>  Pop3 </h4><br><pre> <code class="markdown hljs"><span class="hljs-section"><span class="hljs-section"># tshark -i eth0 -f "port 110" -R pop</span></span></code> </pre><br><br>  Record traffic for further analysis using tcpdump | dumpcap utilities (from wireshark): <br><br><pre> <code class="markdown hljs"><span class="hljs-section"><span class="hljs-section"># tcpdump -s0 -nn -i eth0 -w smtps.pcap port 465 and host HOSTIP # dumpcap -s0 -i eth0 -w smtp.pcap -f 'port 25 and host HOSTIP'</span></span></code> </pre><br><br>  where HOSTIP is the IP address of the opposite party, server or client, the session with which we are analyzing.  And the following reading: <br><br><pre> <code class="markdown hljs"><span class="hljs-section"><span class="hljs-section"># tshark -n -r smtp.pcap -R smtp</span></span></code> </pre><br><br>  In many cases, mail protocols actively use encryption, and in this way the session is no longer viewed.  Nevertheless, this question as a whole is also resolved.  tshark can decrypt SSL / TLS traffic "from the server side" if you have access to the server's private key (for the client there is an option using the Master-Key, <a href="http://wiki.wireshark.org/SSL">learn</a> more <a href="http://wiki.wireshark.org/SSL">about wiki.wireshark.org/SSL</a> ).  Fortunately or unfortunately, wireshark with a private key can not decrypt all algorithms used.  For example DHE- * EXP- *, EDH- * do not work.  Perhaps some of these algorithms are added in later versions of the program. <br><br>  In the process of testing, the openssl utility was used with an explicit indication when connecting with specific algorithms.  Proven options with which traffic decryption was successful: <br><br><ul><li>  ssl3: RC4-SHA, RC4-MD5, DES-CBC-SHA, AES128-SHA </li><li>  tls1: RC4-MD5, AES256-SHA, DES-CBC-SHA, DES-CBC3-SHA </li></ul><br><br>  View a list of supported protocols in your openssl version: <br><br><pre> <code class="markdown hljs"><span class="hljs-section"><span class="hljs-section"># openssl ciphers -ssl3 # openssl ciphers -tls1</span></span></code> </pre><br><br>  To analyze a real session, you can turn off in the mail server configuration (only for the duration of the test!) All algorithms, except for obviously working ones. <br><br>  Tshark runs on the server, where the key is, and the openssl client on the local computer.  But, of course, it is not necessary, it is quite possible to run tshark on the client in another console, it just requires copying the private key to the local computer.  And openssl can be launched in screen in a window next to tshark. <br><br>  So run: <br><br><pre> <code class="markdown hljs"><span class="hljs-section"><span class="hljs-section"># tshark -i eth0 -n -o "ssl.keys_list:94.127.66.53,25,smtp,/etc/pki/tls/private/server.key" -R smtp $ printf "EHLO RC4-MD5\nEXIT" | openssl s_client -starttls smtp -crlf -tls1 -cipher RC4-MD5 -connect mail.truevds.ru:25 # tshark -i eth0 -n -o "ssl.keys_list:94.127.66.53,465,smtp,/etc/pki/tls/private/server.key" -R smtp $ printf "EHLO RC4-MD5\nEXIT" | openssl s_client -ssl3 -cipher RC4-SHA -connect mail.truevds.ru:465 # tshark -i eth0 -n -o "ssl.keys_list:94.127.66.53,143,imap,/etc/pki/tls/private/server.key" -R imap $ printf "* CAPABILITY\nLOGOUT" | openssl s_client -starttls imap -crlf -tls1 -cipher RC4-MD5 -connect mail.truevds.ru:143 # tshark -i eth0 -n -o "ssl.keys_list:94.127.66.53,993,imap,/etc/pki/tls/private/server.key" -R imap $ printf "* CAPABILITY\nLOGOUT" | openssl s_client -crlf -ssl3 -cipher RC4-MD5 -connect mail.truevds.ru:993 # tshark -i eth0 -n -o "ssl.keys_list:94.127.66.53,110,pop,/etc/pki/tls/private/server.key" -R pop $ printf "USER RC4-MD5\nEXIT" | openssl s_client -starttls pop -crlf -tls1 -cipher RC4-MD5 -connect mail.truevds.ru:110 # tshark -i eth0 -n -o "ssl.keys_list:94.127.66.53,995,pop,/etc/pki/tls/private/server.key" -R pop $ printf "USER RC4-MD5\nEXIT" | openssl s_client -crlf -ssl3 -cipher RC4-MD5 -connect mail.truevds.ru:995</span></span></code> </pre><br><br>  Here <code>94.127.66.53</code> is the ip address of the server to which the client connects, <code>/etc/pki/tls/private/server.key</code> is the path to the private key of the server.  The private key is usually located in <code>/etc/pki</code> or <code>/etc/ssl</code> , depending on the server.  This information can be viewed in the settings of the mail server itself. <br><br>  Postfix example: <br><br><pre> <code class="markdown hljs">$ grep key<span class="hljs-emphasis"><span class="hljs-emphasis">_file /etc/postfix/main.cf smtpd_</span></span>tls<span class="hljs-emphasis"><span class="hljs-emphasis">_key_</span></span>file = /etc/pki/tls/private/server.key smtp<span class="hljs-emphasis"><span class="hljs-emphasis">_tls_</span></span>key_file = /etc/pki/tls/private/server.key</code> </pre><br><br>  For ports where starttls are used instead of the port, it is recommended to use start_tls in the official documentation.  For example, <code>ssl.keys_list:94.127.66.53,start_tls,smtp,/etc/pki/tls/private/server.key</code> instead of <code>ssl.keys_list:94.127.66.53,25,smtp,/etc/pki/tls/private/server.key</code> .  But this option did not work for me, traffic only showed up before encryption was initialized. <br><br>  To debug the SSL / TLS decryption process, use the <code>-o "ssl.debug_file: /tmp/debug.log"</code> <br><br>  Example output of decrypted traffic: <br><br><pre> <code class="markdown hljs"><span class="hljs-section"><span class="hljs-section"># tshark -i eth0 -n -o "ssl.keys_list:94.127.66.53,25,smtp,/etc/pki/tls/private/server.key" -R "smtp" Running as user "root" and group "root". This could be dangerous. Capturing on eth0 0.178964 94.127.66.21 -&gt; 94.127.66.53 SMTP C: EHLO RC4-MD5 | EXIT 0.179357 94.127.66.53 -&gt; 94.127.66.21 SMTP 250-mail.truevds.ru | 250-PIPELINING | 250-SIZE 104857600 | 250-ETRN |</span></span></code> </pre><br><br><a name="links"></a><br><h1>  6. Links to materials </h1><br><ul><li>  <a href="http://wiki.wireshark.org/">Wireshark</a> Network Analyzer Documentation: <a href="http://wiki.wireshark.org/">wiki.wireshark.org</a> </li><li>  SMTP: <a href="http://www.ietf.org/rfc/rfc2821.txt">RFC 2821</a> </li><li>  SMTP Authorization: <a href="">RFC 4954</a> </li><li>  POP3: <a href="">RFC 3501</a> </li><li>  IMAP: <a href="http://www.ietf.org/rfc/rfc1939.txt">RFC 1939</a> </li><li>  Smtp-cli website: <a href="http://www.logix.cz/michal/devel/smtp-cli">www.logix.cz/michal/devel/smtp-cli</a> </li></ul><br>  Good luck in solving mail problems! <br><br><img src="https://habrastorage.org/files/420/bf3/114/420bf31146d84d9e9a65461dbeccad5e.jpg"></div><p>Source: <a href="https://habr.com/ru/post/262819/">https://habr.com/ru/post/262819/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../262807/index.html">Notes on distributed systems for beginners</a></li>
<li><a href="../262809/index.html">How can artificial intelligence be used to solve SEO problems?</a></li>
<li><a href="../262813/index.html">How to make beautiful documentation for the Web API, for which it will not be a shame</a></li>
<li><a href="../262815/index.html">Design for Dyslexics, Part One</a></li>
<li><a href="../262817/index.html">Overview of authentication methods and protocols in web applications</a></li>
<li><a href="../262821/index.html">Intel Edison. Using Intel Cloud on the example of distance sensor implementation</a></li>
<li><a href="../262823/index.html">2 years of burry reviews - the history of the amateur show Old-Hard</a></li>
<li><a href="../262827/index.html">Testing password policies of the largest web services</a></li>
<li><a href="../262831/index.html">Unreal real estate developers, or why years of experience do not say anything</a></li>
<li><a href="../262833/index.html">Star rating on CSS with font-awesome font icons</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>