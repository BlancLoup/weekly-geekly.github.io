<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Time back ...</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="That died down the first of April. Someone on this day sniffing their devices in the new Google Nose service, someone was playing ‚ÄúField of Miracles‚Äù ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Time back ...</h1><div class="post__text post__text-html js-mediator-article"><img align="right" src="https://habrastorage.org/storage2/94b/73e/6e1/94b73e6e1fff45f0a5b1be689c8e0cf6.gif">  That died down the first of April.  Someone on this day sniffing their devices in the new <a href="https://www.google.ru/intl/ru/landing/nose/">Google Nose</a> service, someone was playing <a href="http://www.yandex.ru/">‚ÄúField of Miracles‚Äù</a> , and someone, having forgotten the fatal date, simply sullenly brushed off the chalk from the chalk <br><br>  I, inspired by the <a href="http://habrahabr.ru/post/174593">article</a> about the hidden possibilities for customizing the explorer.exe process, also decided to do something funny. <br>  Let today my second hand of the clock in Windows goes in the opposite direction!  Not the most, of course, useful in the fashion industry, but for academic and recreational purposes it will fit perfectly :) <br><blockquote>  I left the hour and minute hands in the right direction.  Sometimes you still have to watch for hours on the tray - let them show the time with an accuracy of at least a minute ... </blockquote><a name="habracut"></a><h4>  Training </h4><br>  The sequence of actions is approximately as follows: <br><ol><li>  Explore explorer.exe and understand how it counts time. </li><li>  Something to change something in logic so that the clock goes back </li></ol><br>  There is no difficulty in changing the logic of a 32-bit usermode process: there is a long-time <a href="http://www.ollydbg.de/">OllyDbg</a> debugger, which has plenty of tutorials on which is even in Russian.  Therefore, to give a zest, it was decided to implement the task on my 64-bit Windows 7 - I have long wanted to know what processes live there with doubled digit capacity ... <br><br>  In the 64-bit world at the disassembler level, unfortunately, life is not very sweet: neither you are comfortable with Olly for debugging, nor you with the most comfortable <abbr title="Library of low-level interaction from Microsoft itself, which allows, among other things, to install hooks on library functions">Detours</abbr> , for which they ask to pay as much as $ 9,999.95 (well, thank you for not $ 10k - marketers know how to make the price more attractive).  Even old 32-bit <abbr title="A utility for embedding code in someone else's process">injectors</abbr> cannot be used to embed 64-bit dll.  Apparently, my default search engine will have a hard time working ... 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Forgive me, the fans of static analysis, I didn‚Äôt have a relationship with IDA Pro, so I had almost no choice - the old WinDbg waited in the wings. <br><blockquote>  In matters of working with WinDbg, the most valuable source of information is the <a href="http://www.windbg.info/doc/1-common-cmds.html">windbg.info</a> resource <a href="http://www.windbg.info/doc/1-common-cmds.html">.</a> </blockquote><br><h4>  Explore explorer.exe </h4><br>  Connect to the process and look for something related to the word " <i>clock</i> ": <br><br><img src="https://habrastorage.org/storage2/cf0/833/15d/cf083315de90ae4d167b9aefd4515028.png"><br><br>  Looking closer at the list of functions, you can see the inconspicuous function <code>explorer!CClockCtl::_RecalcCurTime</code> .  Is the first shot at once in the goal?  Let's see what's inside: <br><br><img src="https://habrastorage.org/storage2/652/120/9e0/6521209e02309763891a025eda36bea7.png"><br><br>  That's right, right after the function prologue we see a call to <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/ms724338%2528v%3Dvs.85%2529.aspx">GetLocalTime</a> , which, as you know, returns the local time and date.  If we can influence the return result of this function, we can also change the direction of the second hand - all that remains is to put a <abbr title="A function that will be called every time instead of">hook</abbr> on this function. <br><br>  To realize our plans, we need to somehow get into the address space of the explorer.exe process.  And with this, the <a href="http://code.google.com/p/injector/">CLI DLL-Injector</a> command line utility will help us.  Not only does it support 32 and 64 bits, it can also inject dll in two ways: via LoadLibrary injection, and using direct code writing via WriteProcessMemory followed by transfer of relocs. <br><br>  Directly to install the hooks inside the explorer.exe process, we use the simple and reliable <a href="http://www.codeproject.com/Articles/44326/MinHook-The-Minimalistic-x86-x64-API-Hooking-Libra">MinHook</a> library. <br><blockquote>  It is worth noting that behind the seeming simplicity of the library, there is a very thoughtful logic inside, which works even in rather complicated cases.  So, the <a href="http://www.codeproject.com/Articles/21414/Powerful-x86-x64-Mini-Hook-Engine">Powerful x86 / x64 Mini Hook-Engine</a> library, which I tried to use at first, caused Access Violation because the first instruction of the GetLocalTime function is a relative JMP transition.  In this case, the task is complicated by the need to recalculate the offset. </blockquote><br><h4>  Implementation </h4><br>  Determined with the tools.  Now it remains to write the dll, which when DLL_PROCESS_ATTACH will put a hook on the GetLocalTime function: <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;windows.h&gt; #include "MinHook.h" //    libMinHook.dll #pragma comment(lib, "libMinHook.x64.lib") //    GetLocalTime static void (WINAPI *GetLocalTime_)(LPSYSTEMTIME lpSystemTime); void WINAPI MyGetLocalTime(LPSYSTEMTIME lpSystemTime) { //   GetLocalTime GetLocalTime_(lpSystemTime); //   : 59 -&gt; 0, 0 -&gt; 59 lpSystemTime-&gt;wSecond = 59 - lpSystemTime-&gt;wSecond; } BOOL APIENTRY DllMain(HMODULE hModule, DWORD dwReason, LPVOID lpReserved) { switch (dwReason) { case DLL_PROCESS_ATTACH: //     ! //    ,  DllMain()       //   libMinHook if (MH_Initialize() != MH_OK) { return FALSE; } //   (      ) if (MH_CreateHook(&amp;GetLocalTime, &amp;MyGetLocalTime, reinterpret_cast&lt;void**&gt;(&amp;GetLocalTime_)) != MH_OK) { return FALSE; } //   if (MH_EnableHook(&amp;GetLocalTime) != MH_OK) { return FALSE; } } return TRUE; }</span></span></span></span></code> </pre><br><h4>  Use the resulting dll </h4><br>  Now you can embed dll.  Run the injector in the console with the following command: <br><br><img src="https://habrastorage.org/storage2/0ad/73a/b1b/0ad73ab1b8b20ed481820c624d60faa5.png"><br><br><blockquote>  In the key --lib it is important to pass the full path to the dll, for more details why this is done, see the <a href="https://habr.com/ru/post/175025/">comment</a> </blockquote><br>  Everything, you can enjoy the results!  (gently hypnotizes) <br><br>  Source codes (projects for VS2010) and binaries for self-tinkering can be found <a href="https://github.com/glowfall/reverse-clock">here</a> . </div><p>Source: <a href="https://habr.com/ru/post/175025/">https://habr.com/ru/post/175025/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../175007/index.html">Continuous Deployment to Windows Instance</a></li>
<li><a href="../175011/index.html">Human digitization: we are not ready</a></li>
<li><a href="../175013/index.html">BitTorrent alpha version of SyncApp will be available for public use by the end of April.</a></li>
<li><a href="../175017/index.html">Lun hovercraft</a></li>
<li><a href="../175023/index.html">About Amazon Clouds and MPLS Transport</a></li>
<li><a href="../175027/index.html">Bootstrap Dropdown Menus Enhancement</a></li>
<li><a href="../175029/index.html">Does JavaScript need classes?</a></li>
<li><a href="../175031/index.html">Want your company to develop? Get rid of managers!</a></li>
<li><a href="../175033/index.html">Fanless HTPC based HD-Plex chassis overview</a></li>
<li><a href="../175035/index.html">How I searched implemented or typical problems of introducing PDM systems in post-Soviet production</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>