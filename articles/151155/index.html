<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Delayed array processing</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Once, when developing a complex application in JavaScript, an insurmountable problem arose - a large array in Internet Explorer (hereafter IE). Since ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Delayed array processing</h1><div class="post__text post__text-html js-mediator-article">  Once, when developing a complex application in JavaScript, an insurmountable problem arose - a large array in Internet Explorer (hereafter IE).  Since I initially checked the work in Chrome, I did not notice any problems when using arrays.  I will say more - the nested arrays did not cause fear.  Chrome easily coped with difficult tasks.  However, IE, in a very rigid form, pointed out all my flaws and shortcomings of the code, especially the processing of large arrays. <br><a name="habracut"></a><br><h4>  In a nutshell </h4><br>  The developed application had to, in real time, respond to events coming from the server.  For these purposes, they used the <a href="http://socket.io/">Socket.IO</a> library, which made it easy to implement two-way communication with the server.  At the same time, the application was also tied to a third-party service, to which I had access only through the external REST API. <br><br>  The weak link turned out to be a large cycle that was supposed to process an array of data received just from a third-party service.  In this case, it was necessary to simultaneously change the DOM model in a loop.  In these cases, IE went into a state of deep thought and naturally tore the connection.  Superficially, it was unacceptable - locking the application and constantly spinning the download icon could not satisfy the customer.  Yes, many can rightly point out the high costs of changing the DOM model.  And I must assure you that this part of the problem was solved by moving all changes out of the cycle.  However, the main problem is that the connection was broken during array processing. <br><br>  Full refactoring was scary because thousands of lines of code had already been written.  In addition, time is running out.  It was in such conditions that the idea of ‚Äã‚Äãa ‚Äúdelayed‚Äù, partial processing of an array was born. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Algorithm </h4><br>  The array is logically divided into several ranges, the processing of each of which is done with a delay.  The essence of the work is presented in the figure: <br><br><img src="https://habrastorage.org/storage2/199/bc7/31f/199bc731fd602d384898f15f2a6630c2.png"><br><br>  Thus, having a single global array, the <b>Array</b> function processes it in parts, with a predetermined delay.  For asynchronous language, which is JavaScript, this technique allows you to unload the main stream (just one) when processing very large arrays. <br><br>  The main body of the handler: <br><pre><code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//Lazy array processing /** * Input parameters * params = { * outerFuntion : function(array, start, stop), * mainArray: [] * startIndex: Int, * stepRange Int, * timeOut: Int, * callback: function() *} */ var lazyProcessing = function(params) { var innerFunction = (function(_) { return function() { var arrayLength = _.mainArray.length, stopIndex = _.startIndex + _.stepRange; if(arrayLength &lt; stopIndex) { _.outerFunction( _.mainArray, _.startIndex, arrayLength - _.startIndex); if(_.callback != undefined) { _.callback(); } return; } else { _.outerFunction( _.mainArray, _.startIndex, stopIndex); _.startIndex += _.stepRange; lazyProcessing(_); } } })(params); setTimeout(innerFunction, params.timeOut); }; //Outer function works with mainArray in given range var func = function(mainArray, start, stop) { //</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">TODO:</span></span></span><span class="hljs-comment"> this should be everything you want to do with elements of for (var i = start; i &lt; stop; ++i) { // do something } };</span></span></code> </pre> <br>  In the body of the <b>lazyProcessing</b> function, a local function <b>called</b> <b>innerFunction</b> is created, which closes in itself the obtained <b>params</b> parameters.  This allows each time, when recursively calling the <b>lazyProcessing</b> function from itself, to save unique parameters. <br><br>  The <b>innerFunction</b> function returns a nameless function that performs the following fairly simple operations: <br><ol><li>  Checks for reaching the end of a global array </li><li>  Calls the <b>outermost outerfuntion</b> function with different <b>stop</b> values. </li><li>  In case of reaching the end of the array, it calls the <b>callback</b> function. </li><li>  Otherwise, it will recursively call <b>lazyProcessing</b> . </li></ol><br>  The outer function <b>outerFuntion</b> is passed to the array itself (due to its global <b>nature</b> , this could not be done, but visibility will suffer as well), as well as the indices of the beginning and end of the cycle.  In this case, the processing results can be either stored in an array or in other global variables.  It all depends on the current task. <br><br>  When the end of the array is reached, a callback function may be called, but this is optional. <br><br><h4>  Pros and cons </h4><br>  Naturally, this solution has its pitfalls and disadvantages: <br><ol><li>  If you set the <b>stepRange to be</b> minimal, with a sufficiently large <b>mainArray</b> array, you can <b>tritely</b> "fall" over the stack overflow </li><li>  The thread will still be blocked when calling the outer outerFunction.  Those.  performance will directly depend on the algorithm for processing the elements of the array </li><li>  ‚ÄúNoodles‚Äù of nested and returned functions does not look very friendly </li></ol><br>  At the same time, partial processing of an array at regular intervals does not block the program execution flow.  That allows you to handle other callback functions. <br><br><div class="spoiler">  <b class="spoiler_title">Full working example:</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//Test array var test = []; for(var i = 0; i &lt; 100000; ++i) { test[i] = i; } //Lazy array processing /* params = { outerFuntion : function(array, start, stop), mainArray: [] startIndex: Int, stepRange Int, timeOut: Int, callback: function() } */ var lazyProcessing = function(params) { var _params = params; var innerFunction = (function(_) { return function() { var arrayLength = _.mainArray.length, stopIndex = _.startIndex + _.stepRange; if(arrayLength &lt; stopIndex) { _.outerFunction( .mainArray, _.startIndex, arrayLength - _.startIndex); if(_.callback != undefined) { _.callback(); } return; } else { _.outerFunction( _.mainArray, _.startIndex, stopIndex); _.startIndex += _.stepRange; lazyProcessing(_); } } })(_params); setTimeout(innerFunction, _params.timeOut); }; //Test function works with array var func = function(mainArray, start, stop) { //</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">TODO:</span></span></span><span class="hljs-comment"> this should be everything //you want to do with elements of mainArray var _t = 0; for (var i = start; i &lt; stop; ++i) { mainArray[i] = mainArray[i]+2; _t += mainArray[i]; } }; lazyProcessing({ outerFunction: func, mainArray: test, startIndex: 0, stepRange: 1000, timeOut: 100, callback: function() { alert("Done"); } });</span></span></code> </pre><br></div></div><br><br>  Ps.  The user <a href="http://habrahabr.ru/users/zimorodok/" class="user_link">zimorodok took</a> off a wonderful example - the same in spirit and in essence.  I can not add it. <br>  Passing through an array with a callback for each element with the ability to set timeOut: <br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">/* example of use var arr = ['masha','nadya', 'elena']; iterate_async(arr, function (el, index, arr) { console.log(el + ' is #' + (index + 1)); }, 99); */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">iterate_async</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">arr, callback, timeout</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> item_to_proceed; item_to_proceed = <span class="hljs-number"><span class="hljs-number">0</span></span>; (<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">proceed_next</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (item_to_proceed &lt; arr.length) { setTimeout(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ callback.call(arr, arr[item_to_proceed], item_to_proceed, arr); item_to_proceed += <span class="hljs-number"><span class="hljs-number">1</span></span>; proceed_next(); }, timeout || <span class="hljs-number"><span class="hljs-number">50</span></span>); } }()); }</code> </pre></div><p>Source: <a href="https://habr.com/ru/post/151155/">https://habr.com/ru/post/151155/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../15115/index.html">Silverlight sIFR port</a></li>
<li><a href="../151150/index.html">web and MVC: debriefing</a></li>
<li><a href="../151151/index.html">The solution of the traveling salesman problem by recursive brute force</a></li>
<li><a href="../151152/index.html">Client for SOAP API Russian Post in Python</a></li>
<li><a href="../151153/index.html">How to avoid Internet autism?</a></li>
<li><a href="../151156/index.html">Optimization of custom firmware HTC Desire HD (Virtuous Infinity)</a></li>
<li><a href="../151157/index.html">Fast blur according to Gauss</a></li>
<li><a href="../151159/index.html">Find IT - job fair for IT-specialists</a></li>
<li><a href="../15116/index.html">Opera 9.24 / Opera 9.50</a></li>
<li><a href="../151161/index.html">Hard Drive Soldering Stand</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>