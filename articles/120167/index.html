<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Installing and configuring rtorrent + rutorrent + nginx + php-fpm in Arch Linux</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Prehistory 
 To work with torrents, I used ktorrent for a long time. This client completely satisfied my needs for convenient download management, unt...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Installing and configuring rtorrent + rutorrent + nginx + php-fpm in Arch Linux</h1><div class="post__text post__text-html js-mediator-article"><h4>  Prehistory </h4><br>  To work with torrents, I used ktorrent for a long time.  This client completely satisfied my needs for convenient download management, until I noticed that on popular torrents the processor load reached 50% ( <i>and with uTP even more</i> ), and the memory consumption in the already fat KDE became unpleasantly evident. <br><br>  It was decided to change KDE to xfce ( <i>this is a separate story</i> ), and choose a program for torrents with good functionality and convenient controls.  Having tried transmission, deluge and rtorrent, I stopped at the last. <br><br>  How to configure rtorrent + rutorrent + nginx + php-fpm, and will be under the cut. <br><a name="habracut"></a><br><h4>  Why is that? </h4><br>  I want to answer right away why the above mentioned tools are chosen. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <b>Arch Linux</b> .  You can talk about this distribution for a long time, I like its organization and philosophy in general, and I can use it for myself with maximum efficiency.  To whom it is interesting to read about it in more detail, look <a href="https://wiki.archlinux.org/index.php/Arch_Linux">here</a> and <a href="https://wiki.archlinux.org/index.php/The_Arch_Way">here</a> . <br><br>  <b>nginx</b> .  I am impressed with how this little thing does its job, saving memory, flexibly tuning and providing all the functionality I need. <br><br>  <b>php-fpm</b> .  You can configure the number of worker threads, in conjunction with nginx, it gives excellent performance. <br><br>  <b>rtorrent</b> .  Low resource consumption, well tuned. <br><br>  <b>rutorrent</b> .  Actively developing, has a nice interface. <br><br><h4>  Install the necessary software </h4><br><br>  Let us proceed from the fact that Arch Linux is already on the computer, and the user is familiar with its package system. <br><br>  To install the bundle web part, execute the following command: <br><br> <code>sudo pacman -S nginx php-fpm</code> <br> <br>  I recommend installing rtorrent and librtorrent from AUR, there is a wonderful PKGBUILD called rtorrent-color that makes a boring console interface more enjoyable ( <i>if you use it</i> ), and libtorrent-extended, which has additional patches.  Therefore, we execute the command: <br><br> <code>yaourt rtorrent-color</code> <br> <br>  and <br><br> <code>yaourt libtorrent-extended</code> <br> <br>  To get the rutorrent, you need to clone it from svn using the command: <br><br> <code><a href="http://rutorrent.googlecode.com/svn/trunk/"></a> svn checkout rutorrent.googlecode.com/svn/trunk rutorrent-read-only <br></code> <br><br>  The files will appear in the ‚Äúrutorrent-read-only‚Äù directory, then we will take them from there. <br><br><h4>  Customization </h4><br><br>  In the /etc/php/php-fpm.conf file you need to set the following parameters: <br><br><ul><li>  <b>listen = 127.0.0.1:9000</b> , so that php-fpm listens on the specified network socket; </li><li>  <b>pm = static</b> so that the number of worker threads is constant; </li><li>  <b>pm.max_children = 2</b> to set the number of worker threads equal to the number of physical threads ( <i>I have a dual-core processor, so 2 is installed here</i> ). </li></ul><br><br>  The /etc/nginx/conf/nginx.conf file is as follows: <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">worker_processes</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">error_log</span></span> /var/log/nginx/error.log; <span class="hljs-attribute"><span class="hljs-attribute">pid</span></span> /var/run/nginx.pid; <span class="hljs-section"><span class="hljs-section">events</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">worker_connections</span></span> <span class="hljs-number"><span class="hljs-number">1024</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">use</span></span> <span class="hljs-literal"><span class="hljs-literal">epoll</span></span>; } <span class="hljs-section"><span class="hljs-section">http</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">include</span></span> /etc/nginx/conf/mime.types; <span class="hljs-attribute"><span class="hljs-attribute">default_type</span></span> application/octet-stream; <span class="hljs-attribute"><span class="hljs-attribute">upstream</span></span> backend { <span class="hljs-attribute"><span class="hljs-attribute">server</span></span> <span class="hljs-number"><span class="hljs-number">127.0.0.1:9000</span></span>; } <span class="hljs-attribute"><span class="hljs-attribute">upstream</span></span> backendrtorrent { <span class="hljs-attribute"><span class="hljs-attribute">server</span></span> unix:/home/pf/.rtorrent.sock; } <span class="hljs-attribute"><span class="hljs-attribute">sendfile</span></span> <span class="hljs-literal"><span class="hljs-literal">on</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">keepalive_timeout</span></span> <span class="hljs-number"><span class="hljs-number">65</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">include</span></span> /etc/nginx/conf/sites-enabled/*; <span class="hljs-attribute"><span class="hljs-attribute">include</span></span> /etc/nginx/conf/conf.d/*; }</code> </pre> <br><br>  Please note that the <b>backend</b> subsection points to php-fpm, and the <b>backendrtorrent indicates the rtorrent</b> socket file (more <i>on this later</i> ). <br><br>  Create directories <b>/ etc / nginx / conf / sites-enabled</b> and <b>/ etc / nginx / conf / sites-available</b> .  In the second, we will create a configuration file <b>rutorrent.eternity with the</b> following content and make a symbolic link to it in the first directory: <br><br><pre> <code class="hljs nginx"><span class="hljs-section"><span class="hljs-section">server</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">listen</span></span> <span class="hljs-number"><span class="hljs-number">80</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">server_name</span></span> localhost; <span class="hljs-attribute"><span class="hljs-attribute">access_log</span></span> /srv/http/nginx/rutorrent.eternity/logs/access.log; <span class="hljs-attribute"><span class="hljs-attribute">error_log</span></span> /srv/http/nginx/rutorrent.eternity/logs/errors.log; <span class="hljs-attribute"><span class="hljs-attribute">location</span></span> / { <span class="hljs-attribute"><span class="hljs-attribute">root</span></span> /srv/http/nginx/rutorrent.eternity/htdocs; <span class="hljs-attribute"><span class="hljs-attribute">index</span></span> index.php index.html index.htm; } <span class="hljs-attribute"><span class="hljs-attribute">location</span></span> /RPC2 { <span class="hljs-attribute"><span class="hljs-attribute">include</span></span> /etc/nginx/conf/scgi_params; <span class="hljs-attribute"><span class="hljs-attribute">scgi_pass</span></span> backendrtorrent; } <span class="hljs-attribute"><span class="hljs-attribute">location</span></span> <span class="hljs-regexp"><span class="hljs-regexp">~ /\.ht</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">deny</span></span> all; } <span class="hljs-attribute"><span class="hljs-attribute">location</span></span> <span class="hljs-regexp"><span class="hljs-regexp">~* \.(jpg|jpeg|gif|bmp|ico|png|css|js|swf)$</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">root</span></span> /srv/http/nginx/rutorrent.eternity/htdocs; <span class="hljs-attribute"><span class="hljs-attribute">access_log</span></span> <span class="hljs-literal"><span class="hljs-literal">off</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">expires</span></span> <span class="hljs-number"><span class="hljs-number">30d</span></span>; } <span class="hljs-attribute"><span class="hljs-attribute">location</span></span> <span class="hljs-regexp"><span class="hljs-regexp">~ .php$</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">fastcgi_split_path_info</span></span><span class="hljs-regexp"><span class="hljs-regexp"> ^(.+\.php)(.*)$</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">fastcgi_pass</span></span> backend; <span class="hljs-attribute"><span class="hljs-attribute">fastcgi_index</span></span> index.php; <span class="hljs-attribute"><span class="hljs-attribute">fastcgi_param</span></span> SCRIPT_FILENAME /srv/http/nginx/rutorrent.eternity/htdocs<span class="hljs-variable"><span class="hljs-variable">$fastcgi_script_name</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">include</span></span> fastcgi_params; <span class="hljs-attribute"><span class="hljs-attribute">fastcgi_param</span></span> QUERY_STRING <span class="hljs-variable"><span class="hljs-variable">$query_string</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">fastcgi_param</span></span> REQUEST_METHOD <span class="hljs-variable"><span class="hljs-variable">$request_method</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">fastcgi_param</span></span> CONTENT_TYPE <span class="hljs-variable"><span class="hljs-variable">$content_type</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">fastcgi_param</span></span> CONTENT_LENGTH <span class="hljs-variable"><span class="hljs-variable">$content_length</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">fastcgi_intercept_errors</span></span> <span class="hljs-literal"><span class="hljs-literal">on</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">fastcgi_ignore_client_abort</span></span> <span class="hljs-literal"><span class="hljs-literal">off</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">fastcgi_connect_timeout</span></span> <span class="hljs-number"><span class="hljs-number">60</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">fastcgi_send_timeout</span></span> <span class="hljs-number"><span class="hljs-number">180</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">fastcgi_read_timeout</span></span> <span class="hljs-number"><span class="hljs-number">180</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">fastcgi_buffer_size</span></span> <span class="hljs-number"><span class="hljs-number">128k</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">fastcgi_buffers</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-number"><span class="hljs-number">256k</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">fastcgi_busy_buffers_size</span></span> <span class="hljs-number"><span class="hljs-number">256k</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">fastcgi_temp_file_write_size</span></span> <span class="hljs-number"><span class="hljs-number">256k</span></span>; } }</code> </pre> <br><br>  Notice the location of the error and access <i><b>logs</b></i> ( <i><b>/srv/http/nginx/rutorrent.eternity/logs</b></i> ), as well as the root directory of web documents ( <i><b>/srv/http/nginx/rutorrent.eternity/htdocs</b></i> ).  These directories must exist.  Also pay attention to the <b>location / RPC2 block</b> , it is mandatory for the rutorrent.  I do not provide a description of the remaining parameters here, detailed documentation on the Internet is sufficient. <br><br>  In the <b>/ etc / hosts file</b> add this line: <br><br> <code>127.0.0.1 localhost.localdomain localhost eternity rutorrent.eternity</code> <br> <br>  <b>eternity</b> is the name of my system, it may be different with you.  In this case, it needs to be changed everywhere in the configuration files. <br><br>  You can run nginx and php-fpm: <br><br> <code>sudo /etc/rc.d/nginx start <br> sudo /etc/rc.d/php-fpm start</code> <br> <br>  You can now test the bundle web part by uploading a simple php file to the root directory of web documents.  When you go to the web browser at <a href="http://rutorrent.eternity/">rutorrent.eternity,</a> it should display correctly. <br><br>  Now you need to install rutorrent.  Transfer the <b>contents</b> of the above directory <b>rutorrent-read-only / rtorrent</b> to the root directory of web documents ( <i><b>remember</b> , this is the directory <b>/srv/http/nginx/rutorrent.eternity/htdocs</b></i> ).  Do the same with the <b>rutorrent-read-only / plugins</b> directory, copy it over the existing plugins directory in the rutorrent file tree.  Garbage type <b>.svn</b> can be removed. <br><br>  Open the <b>/srv/http/nginx/rutorrent.eternity/htdocs/conf/config.php</b> file and replace it with just two lines: <br><br> <code>$scgi_port = 0; <br> $scgi_host = "unix:///home/pf/.rtorrent.sock";</code> <br> <br>  The socket file must match the one mentioned above. <br><br>  The web interface is ready, now you need to configure rtorrent itself. <br><br>  Create a .rtorrent.rc file in your home directory with the following contents: <br><br> <code>scgi_local = /home/pf/.rtorrent.sock <br> max_memory_usage = 268435456 <br> system.file_allocate.set = yes <br> done_fg_color = 2 <br> done_bg_color = 0 <br> active_fg_color = 4 <br> active_bg_color = 0 <br> download_rate = 250 <br> upload_rate = 250 <br> directory = /home/pf/work/downloads/torrents <br> session = /home/pf/work/downloads/torrents/.session <br> port_range = 29292-29292 <br> check_hash = no <br> use_udp_trackers = yes <br> encryption = allow_incoming,try_outgoing,enable_retry,prefer_plaintext <br> dht = auto <br> dht_port = 6881 <br> peer_exchange = yes <br></code> <br><br>  The line <b>system.file_allocate.set = yes</b> makes sense if libtorrent is compiled with the option --with-posix-fallocate, which on modern file systems allows you to instantly allocate the necessary space for the torrent.  Options like <b>* g_color</b> apply only to rtorrent-color.  Catalogs, ports and speed set up at your discretion. <br><br>  The final touch is the script for running rtorrent.  Place the following contents in <b>/etc/rc.d/rtorrentd</b> : <br><br><pre> <code class="hljs mel">#!/usr/bin/<span class="hljs-keyword"><span class="hljs-keyword">env</span></span> bash . /etc/rc.conf . /etc/rc.d/functions rtorrent_user=<span class="hljs-string"><span class="hljs-string">"pf"</span></span> rtorrent_socket=<span class="hljs-string"><span class="hljs-string">"/home/pf/.rtorrent.sock"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">"$1"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> start) stat_busy <span class="hljs-string"><span class="hljs-string">"Starting rtorrent"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [ -S $rtorrent_socket ]; then rm $rtorrent_socket fi su $rtorrent_user -c <span class="hljs-string"><span class="hljs-string">'LANG=uk_UA.UTF-8 screen -d -m -S rtorrent rtorrent'</span></span> &amp;&gt; /dev/null <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [ $? -gt <span class="hljs-number"><span class="hljs-number">0</span></span> ]; then stat_fail <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> [ ! -S $rtorrent_socket ] <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> printf <span class="hljs-string"><span class="hljs-string">"%10s \r"</span></span> waiting done chmod <span class="hljs-number"><span class="hljs-number">666</span></span> $rtorrent_socket add_daemon rtorrent stat_done fi ;; stop) stat_busy <span class="hljs-string"><span class="hljs-string">"Stopping rtorrent"</span></span> killall -w -s <span class="hljs-number"><span class="hljs-number">2</span></span> /usr/bin/rtorrent &amp;&gt; /dev/null <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [ -S $rtorrent_socket ]; then rm $rtorrent_socket fi <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [ $? -gt <span class="hljs-number"><span class="hljs-number">0</span></span> ]; then stat_fail <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> rm_daemon rtorrent stat_done fi ;; restart) $0 stop sleep <span class="hljs-number"><span class="hljs-number">1</span></span> $0 start ;; *) echo <span class="hljs-string"><span class="hljs-string">"usage: $0 {start|stop|restart}"</span></span> esac exit <span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre> <br><br>  Naturally, the screen should be installed.  Variables <b>rtorrent_user</b> and <b>rtorrent_socket</b> correct for your environment.  If rtorrent autoload is needed, place it in the <b>/etc/rc.conf</b> file in the <b>DAEMONS</b> array. <br><br>  Everything.  Run the rtorrent command <br><br> <code>sudo /etc/rc.d/rtorrentd start</code> <br> <br>  go to the <a href="http://rutorrent.eternity/">rutorrent.eternity</a> website in your browser and enjoy. </div><p>Source: <a href="https://habr.com/ru/post/120167/">https://habr.com/ru/post/120167/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../120159/index.html">Recognition of handwritten mathematical expressions</a></li>
<li><a href="../120160/index.html">Mouse. Inside view</a></li>
<li><a href="../120161/index.html">Google closed Google Translate API</a></li>
<li><a href="../120162/index.html">Idea Success Analyzer</a></li>
<li><a href="../120165/index.html">The citation index of scientific articles in the CIS is extremely low</a></li>
<li><a href="../120168/index.html">A simple image loader in tinyMCE for MVC web application</a></li>
<li><a href="../120169/index.html">Google Inc. launched Google Correlate Experimental Service</a></li>
<li><a href="../120170/index.html">Multi-threaded perl server? Easy!</a></li>
<li><a href="../120171/index.html">MTS Glonass 945</a></li>
<li><a href="../120172/index.html">Another mechanical arm created by Shadow Robot Company</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>