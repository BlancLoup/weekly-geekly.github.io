<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Second honorary. Notes of the participant of the contest Dstl Satellite Imagery Feature Detection</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Recently, the Dstl Satellite Imagery Feature Detection Machine Learning Competition ended in which as many as three Avito employees took part. I want ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Second honorary. Notes of the participant of the contest Dstl Satellite Imagery Feature Detection</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/3d5/92b/22e/3d592b22e0547ba9e21306807c4b1a27.png"><br><br>  Recently, the <a href="https://www.kaggle.com/c/dstl-satellite-imagery-feature-detection">Dstl Satellite Imagery Feature Detection</a> Machine Learning <a href="https://www.kaggle.com/c/dstl-satellite-imagery-feature-detection">Competition</a> ended in which as many as three Avito employees took part.  I want to share the experience of participation on my behalf and talk about the decision. <br><a name="habracut"></a><br><h2>  Task Description </h2><br>  The task was to develop an algorithm for segmentation of objects on satellite images. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/99a/865/1ea/99a8651ea034f29075318a076077dc22.png">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Given multispectral images taken in different wavelength ranges.  The pictures also differ in resolution and due to the nature of the shooting, some channels are slightly offset relative to each other. <br><br>  You need to predict objects of 10 classes: <br><br>  Class 1: Buildings (just buildings, nothing remarkable) <br>  Class 2: Structures (fences that are even a few pixels wide even on the largest shots) <br>  Class 3: Roads (asphalt roads and highways) <br>  Class 4: Dirt Roads <br>  Class 5: Trees (can grow both singly and in groups) <br>  Class 6: Fields (distinguished by growing something on them) <br>  Class 7: Fast water (rivers, fragments of the sea, large bodies of water) <br>  Class 8: Slow water (lakes, dry rivers) <br>  Class 9: Large transport (trucks, buses) <br>  Class 10: Small transport (cars and motorcycles). <br><br>  The metric is the Average Jaccard Index averaged over all classes, which is defined as the ratio of the intersection area to the area of ‚Äã‚Äãthe union.  In this case, intersection and union are class masks.  At the same time, each class made the same contribution to the general metric, but the areas of each class were very different.  The histogram shows the proportion of the area of ‚Äã‚Äãeach class relative to the entire area.  For class 6 (fields), the area share was 0.6, and for the last two classes, 0.0001. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/e58/e99/3d9/e58e993d9122b6a3bdbe5a1954d40159.png"><br><br>  Separately, it is worth noting the amount of data.  We were given 25 marked areas.  While there were 425 of them in the test. Of these, the public leaderboard was built at 19% each, and the rest was 81% private.  As usual, the public served as a matter of fact in order to check his decision and compare the result with other participants.  And the final rating was made only for the private part.  However, it was obvious to me that once in public 81 shots, this check is much safer than any local validation of 25 shots, and if I got a discrepancy between the metrics on the local check and the leaderboard, I trusted the leaderboard.  How wrong I was ... But about that closer to the end. <br><br><h2>  Lyrical digression </h2><br>  There were quite a few participants in the competition and I understand perfectly why, because I myself could not decide to participate for a long time, because there were a lot of problems in the organization.  First, the orgs gave out the masks not in the form of pictures, but in the form of polygons in the csv file and it was necessary to convert them into the required size.  Secondly, each time to predict 425 pictures of the test is a long time.  Thirdly, it was necessary to send the organizers not masks in the form of pixels, as the algorithm usually produces, but the same csv file with polygons as from the training set.  And each stage affects the final metric, and since this is a contest, you will have to lick each procedure.  But I still decided for three reasons: <br><br><ul><li>  work colleague <a href="https://www.kaggle.com/u1234x1234">Dmitry Tsybulevsky</a> has already participated and told that the contest is interesting, it allows you to try many tricks and experiment with the architecture of the neural networks (well, even solving problems with converting masks is more interesting than just teaching xgboost on top of obfuscated features); <br><br></li><li>  also <a href="https://www.kaggle.com/iglovikov">Vladimir Iglovikov</a> aggressively agitated to participate in <a href="https://habrahabr.ru/company/ods">ODS Slack</a> and argued that there would be a struggle for something meaningful, and not for the 4th decimal in the metric (how wrong he was ...); <br><br></li><li>  Well, in the end, I made the final decision when <a href="https://www.kaggle.com/lopuhin">Konstantin Lopukhin</a> laid out a <a href="https://www.kaggle.com/lopuhin/dstl-satellite-imagery-feature-detection/full-pipeline-demo-poly-pixels-ml-poly">script</a> that solved the last problem with converting masks into polygons. <br></li></ul><br><h2>  Baseline </h2><br>  Before rushing to clone repositories with State of the Art segmentation solutions, I decided to make a simple solution that could continuously improve.  In my opinion, this is a good practice not only for almost any competition, but in general for any machine learning task. <br><br>  Accordingly, I chose the scripts posted on the forum and collected the following pipeline from them: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/22b/1d6/ce2/22b1d6ce2d9e74b3cd2dff004a230229.png"><br><br><h3>  Preprocessing and data preparation </h3><br>  I took all the images from the M-band, scaled them to the same size for convenience (with the resize being no more than 1%) and collected a large 5x5 mosaic of them.  He did the same with masks.  Then, from the same for the image and the mask of random places, I cut crocs with the size of a network input and output (128 x 128 pixels), thereby forming a queue for learning.  However, not all samples were taken, but only those with a fraction of the class mask area of ‚Äã‚Äãthe total area above the threshold.  I picked up the thresholds for each class with my hands so that sampling was more or less evenly.  Then the images in each queue were brought to the range (-1, 1).  Also for validation, I cut a small strip from the picture, which contained all the classes and replaced it with a copy of the next piece of the picture in the train. <br><br><h3>  Neural network training </h3><br>  As a neural network, I chose <a href="https://arxiv.org/abs/1505.04597">U-net</a> .  This neural network is similar in structure to a normal encoder-decoder, but with forwarding features from the encoder-part to the decoder at stages corresponding in size. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/cdf/52f/999/cdf52f99903a93bd403db1b073f19ba0.png"><br><br>  U-net performed well in another Kaggle contest with nerve segmentation.  In addition, I found the <a href="https://github.com/jocicmarko/ultrasound-nerve-segmentation">code</a> with her for Keras.  As a loss function, the target metric approximation was used.  The optimizer was taken by Adam, because as a rule, I got good results with him in tasks, when it is not clear by what criterion to reduce the learning rate. <br><br><h3>  Predictions </h3><br>  To predict the mask, I used a regular sliding window.  Those.  each dough picture is cut into patches, they are predicted and then collected back.  By construction, the neural network gives the probability that each class is in a particular pixel.  Accordingly, in order to get a binary mask, you need to select a threshold, which I did on the basis of the maximum metric on local validation.  Predicting the masks, I used the Bones script and received my submit. <br><br>  As a result, Caggle even accepted it.  I decided that it was a success and ran to form my code in the form of <a href="https://www.kaggle.com/drn01z3/dstl-satellite-imagery-feature-detection/end-to-end-baseline-with-u-net-keras">kernel</a> .  At that time, no one laid out the full pipeline from the beginning to the end, so the script was adopted very positively.  And then for several days I saw new people appear on the leaderboard with about my speed.  Well, the kernel got the most votes and comments in this competition. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/329/e46/9a5/329e469a551323b03ddcc7b3c0eb88a8.png"><br><br>  However, my joy was short-lived.  I had an objectively low speed, and I could not understand the reason.  She was found by Rasim Akhunzyanov.  For some reason, after bringing all the images to the range (0, 1), I translated floats into ints.  This fact was noted in the comments to the script and from that moment on anyone could get a working version of the script. <br><br>  However, I did not fix the bug in the code.  Firstly, it is instructive to read at least the comments, and even better to understand the code, and not to run mindlessly a 4-page canvas.  Secondly, even with a bug, the code perfectly performed its function, namely: attracting new participants.  Thirdly, even with a bug, it still fit into the concept of a simple solution that can be continuously improved. <br><br>  An example of successful use of the script is the result of <a href="https://www.kaggle.com/greenwolf">Misha Kamenshchikov</a> .  In Avito, he is engaged in recommendations and I decided to plant him on the DL, having sold this contest to him.  Misha fixed bugs, over the weekend he trained his model with minor modifications and used another public <a href="https://www.kaggle.com/resolut/dstl-satellite-imagery-feature-detection/waterway-0-095-lb">script for water</a> .  This allowed him to finish in 46th place and get the first silver medal. <br><br><h2>  My decision </h2><br>  Generally speaking, my decision was not very different from Baseline in terms of the overall campaign, but I made a number of significant improvements. <br><br><ol><li>  Conv + ReLu ‚Üí Conv + BN + ReLu. <br>  In vanilla U-net, the normalization batch layer was not used.  I added it.  And so did almost all the participants.  He improved the convergence of all. <br></li><li>  Augmentation: rotation at an arbitrary angle, vertical and horizontal flip.  The obvious thing, without which training of picture neural networks is now complete. <br></li><li>  Hard negative mining. <br></li></ol><br>  It is worth staying in more detail.  I refused to sample patches with a fraction of the class mask above the threshold and decided to take all the samples.  But after learning the neural network on the sample set, I predicted the masks on it.  And for each class I chose the top 100 samples, where there is a class mask and where the metric is the worst.  And then add these samples to the next iteration.  Thus, I killed two birds with one stone: Now in each era there were samples of each class and in each era there were "difficult" samples.  I didn‚Äôt make a direct comparison, but it felt like the network converged much faster. <br><br>  With such improvements, I trained two more networks that entered the final ensemble.  But the best, in my opinion, find was a network with three entrances: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/aa2/18a/810/aa218a810a33d5ff8d26b409c7e5497a.png"><br><br>  This concept was born in the process of discussion with Dmitry Tsybulevsky.  The problem with pictures in this contest is that different channels have very different resolutions and if you want to use all the information, then you need to bring everything to the same size.  But if you decrease it, the resolution is lost and such classes as man-made structures will disappear altogether.  Well, if you bring everything to the largest size, then you need to increase, say, A-band by 20 times, which looks extremely unwise.  On the other hand, the image when passing through a neural network after each layer with pulling becomes effectively smaller. <br><br>  Accordingly, the idea was born to add new pictures as the size of the main brunch of the U-net encoder part decreases.  To do this, RGB and P-bands in the size of 224x224 were fed to the first output, after two pullings, the main branch was concatenated with the M-band and then after two more A-band pulling.  At the same time, all the bands had the same physical area.  To do this, I still had to increase the smallest channel 1.5 times, but this is acceptable.  Each channel concocted after a layer of convolution.  This was done in order not to concatenate the grid view and the raw images as features of different nature.  In this regard, I received a fair criticism that this is still not enough, because the picture in the main branch went through more layers of bundles than the picture from the second and especially the third entry.  And, most likely, this is true, and the architecture with large numbers of bundles for each subsequent input will work better, but I did not do this kind of optimization of hyperparameters.  <a href="">Complete scheme</a> <br><br><h2>  Features of training </h2><br>  As a rule, the learning process of deep convolutional neural networks for image recognition is quite understandable.  Especially after the weights of the State of Art Architecture with Imagenet were developed and laid out.  However, in this task it was not easy to just take and train a neural network so that it flew smoothly into the global minimum.  First, for a long time in ODS Slack no one could offer a reliable local validation scheme that would give an unambiguous correspondence with the leaderboard, and in the end we learned why.  Secondly, the network was quite loose from epoch to epoch, and sometimes neighboring epochs for one architecture differed more in the quality of predictions than the predictions of another neural network. <br><br>  If you build a learning log on local validation, it looks like this: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/cdb/902/9a2/cdb9029a28daa27c5c03f7febeb25d12.png"><br><br>  The diagrams are jacquard for the first 7 classes and on the bottom right is the average metric for all classes.  It can be seen that different classes are trained for a different number of iterations, even with the alignment of samples, since all the same the areas of some classes are larger than others.  Dips and waits are also visible.  I was interested to know what happens to the predictions, and for each era I visualized them for validation.  From these predictions <a href="https://www.kaggle.com/zfturbo">Roman Soloviev made a</a> wonderful video: <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/OfGsiPyx94I" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><br>  The video shows how the predictions of each class vary from era to era.  The colors are marked: blue - class mask (False Negative), green - incorrect predictions (False Positive), blue - correct predictions (intersection of the mask and predictions) (True Positive).  I personally like the moments when the network first predicts something irrelevant, and then clarifies its predictions, such as, for example, with fast water and highway classes.  Also, in all classes, there is a wobble in the predictions.  You can also notice the artifacts associated with the fact that the entire mask is predicted by a sliding window.  Well, the main conclusion that I made for myself - a visual analysis of the results solves. <br><br>  So I did such a thing. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/6f0/f4b/ccd/6f0f4bccd4d68016c8a5b1052b813660.png"><br><br>  This is a mosaic of stripes of images from dough, which seemed to me difficult for one reason or another.  I spent the whole evening to pautatirovat pictures of the test and prediction, so these colors.  For example, the leftmost part contains houses and quarries, which often gave false positives to houses and water.  Then comes a piece of the sea with water of such a hue that was not in the training set.  Next comes a piece of a large river with ripples on the water, respectively, such large rivers and ripples were not there either.  I also chose difficult sections of the highway that were poorly defined. <br><br>  And then, at each epoch, besides the train pool (for complex examples) and validation, I also predicted this piece of test.  Then I selected the best epochs visually and then checked them on the leaderboard and if they gave a profit, then I averaged their predictions in order to stabilize the solution.  The averaging trick also gave an increase, but I did not manage to check many epochs in this way. <br><br>  The final pipeline before merging with Roman looks like this: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/39c/1eb/92c/39c1eb92cb7ebc1827c031d098f3d304.png"><br><br>  But then Roman wrote to me and offered to unite.  It seemed to me that it was extremely reasonable, because we both used Keras with Theano as a backend and direct combining our results with the best classes gave top2 results even without averaging or combining the predictions for individual classes.  About my decision, I hope, Roman will write a separate post. <br><br><h2>  Afterword </h2><br>  About the data.  What was my surprise and surprise of all the participants of ODS Slack, when, after the end of the competition, the orgs were informed that in fact they had only marked 32 snapshots from the test.  The rest were just fake.  Well, respectively, public is 6 shots, and private 26. It is precisely because of this that we can assume that the competition had to some extent the nature of a lottery.  Well, it also explains the frequent discrepancies between local validation and public, because they were often comparable in size. <br><br>  About the organizers.  According to the description, the contest was supposed to end on March 7th at 3 nights in Moscow.  I personally waited for this moment much more than any new year.  And you can imagine the level of burnout of ODS Slack participants when the results were not published, and a message appeared on the forum that we are all great and the results will be in a week.  Like, due to the fact that customers are preparing a press release.  A week later, a <a href="https://www.gov.uk/government/news/dstls-kaggle-competition-has-been-a-great-success">press release appeared</a> in which it was reported that the data was already being analyzed (yeah, of course, because no one had sent the decision yet).  And Dstl also liked the format of the competition so much that they decided to <a href="https://www.datasciencechallenge.org/">file their Kaggl</a> with drones and topic modeling.  Two contests have already been launched on this site, but do not rush to rub the radiators of video cards and import xgboost'y.  Only citizens of countries with a corruption index higher than 37 (Transparency International's Corruption Perceptions Index 2014) can apply for prizes in this contest.  Accordingly, the citizens of Zambia and Burkina Faso can participate, but the Russians can not.  Any competition has its zest, and it seems that Dstl found it - it burns. <br><br>  About the overall experience of participation.  Despite the fact that I killed a lot of time for this contest, I definitely liked it and I got a lot of profit even without a prize.  This experience of working with image segmentation, a bunch of tricks for learning neural networks, do not forget about new acquaintances with people who are also interested in participating in competitions.  Avito will soon hold <a href="http://dataring.ru/competitions/avito-recommendations/%3Fms%3D00a9b14f">its competition, which will be dedicated to recommender systems</a> .  I urge everyone to take part in it! <br><br>  Record from training: <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/yUyaYL_x4kQ" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><br>  Presentation of the report <a href="https://docs.google.com/presentation/d/1RqlipUCESV0jx3AShGfgUN3PPnDapmV0_PePfygtc_M/edit%3Fusp%3Dsharing">here</a> . <br><br>  UPD: <br>  In anticipation of the post from Roman, I decided to make a picture with our common pipeline: <br><img src="https://habrastorage.org/getpro/habr/post_images/0d7/013/4f8/0d70134f872e2ce38e2b2c59ec0d7612.jpg" alt="image"><br><br>  UPD2: <br>  <a href="https://habrahabr.ru/company/ods/blog/325096/">Post Vladimir about the same competition</a> </div><p>Source: <a href="https://habr.com/ru/post/325632/">https://habr.com/ru/post/325632/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../325622/index.html">Apache Spark Mitap</a></li>
<li><a href="../325624/index.html">13 years of bad code in games</a></li>
<li><a href="../325626/index.html">Build a project in python3 & PyQT5 for Windows using PyInstaller</a></li>
<li><a href="../325628/index.html">React Native: another ‚Äúsilver bullet‚Äù for cross-platform development?</a></li>
<li><a href="../325630/index.html">Details that matter</a></li>
<li><a href="../325634/index.html">Google Benchmark Library</a></li>
<li><a href="../325636/index.html">StakeOverflow Developer Survey (2017)</a></li>
<li><a href="../325638/index.html">Why do the Russian labor market need women programmers?</a></li>
<li><a href="../325640/index.html">We write the mnemonic editor for SCADA-system on Fabric.js. Part 2</a></li>
<li><a href="../325642/index.html">Top PostgreSQL Development Tools</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>