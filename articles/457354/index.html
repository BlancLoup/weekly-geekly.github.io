<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Obfuscation of data for performance tests</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="ClickHouse users know that its main advantage is the high speed of processing analytical queries. But how can we make such statements? This should be ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Obfuscation of data for performance tests</h1><div class="post__text post__text-html js-mediator-article">  ClickHouse users know that its main advantage is the high speed of processing analytical queries.  But how can we make such statements?  This should be confirmed by performance tests that can be trusted.  We will talk about them today. <br><br> <a href="https://habr.com/ru/company/yandex/blog/457354/"><img src="https://habrastorage.org/webt/ds/2m/sd/ds2msd5-4zeahpzlzptlqz8wgs8.png"></a> <br><br>  We started conducting such tests in 2013, long before the product became available in the open source.  Like now, then we were most interested in the speed of data service Yandex.Metrica.  We have already stored data in ClickHouse since January 2009.  Some of the data has been recorded in the database since 2012, and some has been <a href="https://habrahabr.ru/company/yandex/blog/273305">converted</a> from <a href="https://habrahabr.ru/company/yandex/blog/273305">OLAPServer and Metrage</a> , the data structures that Yandex.Metric has used before.  Therefore, for tests, we took the first available subset of 1 billion pageview data.  There were no queries in the Metric yet, and we came up with the queries that were most interesting to us (all sorts of filtering, aggregation and sorting). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      ClickHouse has been tested against similar systems, such as Vertica and MonetDB.  For the integrity of testing, it was conducted by an employee who had not previously been a ClickHouse developer, and special cases in the code were not optimized before receiving the results.  Similarly, we obtained a data set for functional tests. <br><br>  After ClickHouse came to open source in 2016, there are more questions for the tests. <br><br><a name="habracut"></a><h2>  Disadvantages of closed data tests </h2><br>  Performance tests: <br><br><ol><li>  Not reproducible from the outside, because to run it requires a closed data that can not be published.  For the same reason, some of the functional tests are not available to external users. </li><li>  Do not develop.  There is a need to significantly expand their set, so that changes in the speed of operation of individual parts of the system can be insulated in an isolated manner. </li><li>  Do not run on the commit and for pull requests, external developers cannot check their code for performance regression. </li></ol><br>  You can solve these problems by discarding old tests and making new ones based on open data.  Among the open data, you can take <a href="https://clickhouse.yandex/docs/en/getting_started/example_datasets/ontime">flight data to the United States</a> , <a href="https://clickhouse.yandex/docs/en/getting_started/example_datasets/nyc_taxi">taxi trips to New York,</a> or use ready-made benchmarks TPC-H, TPC-DS, <a href="https://clickhouse.yandex/docs/en/getting_started/example_datasets/star_schema">Star Schema Benchmark</a> .  The inconvenience is that this data is far from Yandex.Metrica data, and I would like to keep the test queries. <br><br><h2>  It is important to use real data. </h2><br>  Testing the performance of the service is necessary only on real data from the production.  Consider a few examples. <br><br>  <strong>Example 1</strong> <br><br>  Suppose you populate a database with uniformly distributed pseudo-random numbers.  In this case, data compression will not work.  But data compression is an important feature for analytical DBMSs.  Choosing the right compression algorithm and the right way to integrate it into the system is a non-trivial task, in which there is no one correct solution, because data compression requires a compromise between the speed of compression and decompression and the potential degree of compression.  Systems that cannot compress data are guaranteed to lose.  But if uniformly distributed pseudo-random numbers are used for tests, this factor is not considered, and all other results will be distorted. <br><br>  Conclusion: test data should have a realistic compression ratio. <br><br>  I talked about optimizing data compression algorithms in ClickHouse in a <a href="https://habr.com/ru/company/yandex/blog/452778/">previous post</a> . <br><br>  <strong>Example 2</strong> <br><br>  Let us be interested in the speed of the SQL query: <br><br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> RegionID, uniq(UserID) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> visitors     <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> test.hits     <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> RegionID     <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> visitors <span class="hljs-keyword"><span class="hljs-keyword">DESC</span></span>     <span class="hljs-keyword"><span class="hljs-keyword">LIMIT</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span></code> </pre> <br>  This is a typical query for Yandex. Metrics.  What is important for the speed of its work? <br><br><ul><li>  <a href="https://www.youtube.com/watch%3Fv%3DSrucFOs8Y6c">How is GROUP BY</a> . </li><li>  What data structure is used to calculate the uniq aggregate function. </li><li>  How many different RegionIDs are there and how many RAMs each state of the uniq function requires. </li></ul><br>  But it is also very important that the amount of data for different regions is unevenly distributed.  (Probably, it is distributed according to a power law. I plotted the log-log scale, but I am not sure.) And if so, then it is important for us that the states of the uniq aggregate function with a small number of values ‚Äã‚Äãuse little memory.  When there are a lot of aggregation keys, the count goes to units of bytes.  How to get the generated data that has all these properties?  Of course, it is better to use real data. <br><br>  Many DBMSs implement the HyperLogLog data structure for an approximate calculation of COUNT (DISTINCT), but they all work relatively poorly because this data structure uses a fixed amount of memory.  And in ClickHouse there is a function that uses a <a href="https://clickhouse.yandex/docs/ru/query_language/agg_functions/reference/">combination of three different data structures</a> , depending on the size of the set. <br><br>  Conclusion: test data should represent the properties of the distribution of values ‚Äã‚Äãin the data - cardinality (the number of values ‚Äã‚Äãin the columns) and mutual cardinality of several different columns. <br><br>  <strong>Example 3</strong> <br><br>  Okay, let us test the performance of non-analytical ClickHouse DBMS, but something simpler, for example, hash tables.  For hash tables, the correct choice of hash function is very important.  For std :: unordered_map, it is slightly less important because it is a hash table based on chains, and a prime number is used as the size of the array.  In the implementation of the standard library in gcc and clang, the default hash function for numeric types is the trivial hash function.  But std :: unordered_map is not the best choice when we want to get maximum speed.  When using open-addressing hash tables, choosing the right hash function becomes a decisive factor, and we cannot use the trivial hash function. <br><br>  It is easy to find the performance tests of hash tables on random data, without considering the hash functions used.  It is also easy to find tests of hash functions with an emphasis on the speed of computation and some quality criteria, although apart from the data structures used.  But the fact is that hash tables and HyperLogLog require different quality criteria for hash functions. <br><br><img src="https://habrastorage.org/webt/bp/3h/32/bp3h320eztrirqzhm-lexeuhmbq.png"><br><br>  Read more about this in the report <a href="https://www.youtube.com/watch%3Fv%3DEoX82TEz2sQ">‚ÄúHow hash tables are organized in ClickHouse‚Äù</a> .  It is a bit outdated, as <a href="https://abseil.io/blog/20180927-swisstables">swiss tables are</a> not considered in it. <br><br><h2>  Task </h2><br>  We want to obtain data for testing the performance of the structure is the same as Yandex.Metrica data, for which all properties important for benchmarks are saved, but so that no trace of real site visitors is left in these data.  That is, the data must be anonymized, while maintaining: <br><br><ul><li>  compression ratios </li><li>  cardinality (the number of different values), </li><li>  mutual cardinality of several different columns, </li><li>  properties of probability distributions that can be used to model data (for example, if we assume that regions are distributed according to a power law, then the exponent ‚Äî the distribution parameter ‚Äî artificial data should be about the same as this). </li></ul><br>  And what do you need for data to have a similar compression ratio?  For example, if LZ4 is used, the substrings in the binary data should be repeated at approximately the same distances and the repetitions should be approximately the same length.  For ZSTD, a byte entropy match is added. <br><br>  The maximum task: to make a tool available to external people, with which everyone can anonymize their data set for publication.  So that we can debug and test the performance on someone else's data similar to production data.  And I would also like the generated data to be interesting to watch. <br><br>  This is an informal formulation of the problem.  However, no one was going to give a formal statement. <br><br><h2>  Attempts to solve </h2><br>  We should not exaggerate the importance of this task for us.  In fact, it was never in the plans and no one was even going to do it.  I just did not leave hopes that something would come up by itself, and suddenly I will have a good mood and a lot of things that can be put off until later. <br><br><h2>  Explicit Probabilistic Models </h2><br>  The first idea is to select for each column of the table a family of probability distributions that models it.  Then, based on the statistics of the data, select the parameters (model fitting) and use the selected distribution to generate new data.  You can use a pseudo-random number generator with a predefined seed to get a reproducible result. <br><br>  For text fields you can use Markov chains - a clear model for which you can make an effective implementation. <br><br>  True, some tricks will be required: <br><br><ul><li>  We want to preserve the continuity of the time series - it means that for some data types, it is necessary to model not the value itself, but the difference between the neighboring ones. </li><li>  To simulate the conditional cardinality of the columns (for example, that one visitor ID usually has few IP addresses), you will also have to write dependencies between the columns explicitly (for example, to generate an IP address, the hash from the visitor ID is used as a seed, but some other pseudo-random data is added). </li><li>  It is not clear how to express the dependence that one visitor frequently visits URL addresses with matching domains approximately at the same time. </li></ul><br>  All this is presented in the form of a program in which all distributions and dependencies are hard coded ‚Äî the so-called ‚ÄúC ++ script‚Äù.  However, Markov models are still calculated from the sum of statistics, smoothing and desensitization using noise.  I started writing this script, but for some reason after I wrote the model for ten columns explicitly, it suddenly became unbearably boring.  And in the hits table in Yandex.Metrica back in 2012 there were more than 100 columns. <br><br><pre> <code class="cpp hljs">EventTime.day(<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::discrete_distribution&lt;&gt;({    <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">13</span></span>, <span class="hljs-number"><span class="hljs-number">30</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">14</span></span>, <span class="hljs-number"><span class="hljs-number">42</span></span>, <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-number"><span class="hljs-number">6</span></span>, <span class="hljs-number"><span class="hljs-number">31</span></span>, <span class="hljs-number"><span class="hljs-number">17</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">23</span></span>, <span class="hljs-number"><span class="hljs-number">10</span></span>, ...})(random)); EventTime.hour(<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::discrete_distribution&lt;&gt;({    <span class="hljs-number"><span class="hljs-number">13</span></span>, <span class="hljs-number"><span class="hljs-number">7</span></span>, <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-number"><span class="hljs-number">6</span></span>, <span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-number"><span class="hljs-number">16</span></span>, <span class="hljs-number"><span class="hljs-number">20</span></span>, <span class="hljs-number"><span class="hljs-number">23</span></span>, <span class="hljs-number"><span class="hljs-number">24</span></span>, <span class="hljs-number"><span class="hljs-number">23</span></span>, <span class="hljs-number"><span class="hljs-number">18</span></span>, <span class="hljs-number"><span class="hljs-number">19</span></span>, <span class="hljs-number"><span class="hljs-number">19</span></span>, ...})(random)); EventTime.minute(<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::uniform_int_distribution&lt;UInt8&gt;(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">59</span></span>)(random)); EventTime.second(<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::uniform_int_distribution&lt;UInt8&gt;(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">59</span></span>)(random)); UInt64 UserID = hash(<span class="hljs-number"><span class="hljs-number">4</span></span>, powerLaw(<span class="hljs-number"><span class="hljs-number">5000</span></span>, <span class="hljs-number"><span class="hljs-number">1.1</span></span>)); UserID = UserID / <span class="hljs-number"><span class="hljs-number">10000000000U</span></span>LL * <span class="hljs-number"><span class="hljs-number">10000000000U</span></span>LL    + <span class="hljs-keyword"><span class="hljs-keyword">static_cast</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">time_t</span></span>&gt;(EventTime) + UserID % <span class="hljs-number"><span class="hljs-number">1000000</span></span>; random_with_seed.seed(powerLaw(<span class="hljs-number"><span class="hljs-number">5000</span></span>, <span class="hljs-number"><span class="hljs-number">1.1</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> get_random_with_seed = [&amp;]{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> random_with_seed(); };</code> </pre><br>  This approach to the problem was a failure.  If I approached her more diligently, surely the script would have been written. <br><br>  Advantages: <br><br><ul><li>  ideological simplicity. </li></ul><br>  Disadvantages: <br><br><ul><li>  the complexity of the implementation, </li><li>  The implemented solution is only suitable for one kind of data. </li></ul><br>  And I would like a more general solution - so that it can be applied not only for Yandex.Metrica data, but also for obfuscation of any other data. <br><br>  However, improvements are possible here.  You can not manually select the models, but implement the catalog of models and choose the best among them (best fit + some kind of regularization).  Or maybe you can use Markov models for all types of fields, and not just for text.  The dependencies between the data can also be understood automatically.  To do this, calculate the <a href="https://en.wikipedia.org/wiki/Kullback%25E2%2580%2593Leibler_divergence">relative entropy</a> (relative amount of information) between the columns, or, more simply, the relative cardinality (something like ‚Äúhow many are on average different values ‚Äã‚Äãof A for a fixed value B‚Äù) for each pair of columns.  This will allow you to understand, for example, that URLDomain depends entirely on the URL, and not vice versa. <br><br>  But I also refused this idea, because there are too many options for what needs to be taken into account, and it will take a long time to write. <br><br><h2>  Neural networks </h2><br>  I have already told how important this task is for us.  No one even thought about making any attempts to implement it.  Fortunately, a colleague Ivan Puzyrevsky then worked as a teacher at the HSE and at the same time worked on the development of the YT core.  He asked if I had any interesting tasks that could be offered to students as a diploma topic.  I offered him this one, and he assured me that it was suitable.  So I gave this task to a good person ‚Äúfrom the street‚Äù - Sharif Anvardinov (the NDA is signed to work with the data). <br><br>  He told him about all his ideas, but most importantly - explained that the problem can be solved in any way.  And it would be a good option to use those approaches that I absolutely do not understand: for example, to generate a text dump of data using LSTM.  This looked encouraging thanks to the <a href="http://karpathy.github.io/2015/05/21/rnn-effectiveness/">article The Unreasonable Effectiveness of Recurrent Neural Networks</a> , which then caught my eye. <br><br>  The first feature of the task is that you need to generate structured data, and not just text.  It was not obvious whether the recurrent neural network could generate data with the desired structure.  This can be solved in two ways.  The first is to use separate models for the generation of the structure and for the ‚Äúfiller‚Äù: the neural network should only generate values.  But this option was postponed until later, after which they never did.  The second way is to simply generate a TSV dump as text.  Practice has shown that in the text of the lines will not match the structure, but these lines can be thrown out when loading. <br><br>  The second feature - the recurrent neural network generates a sequence of data, and the dependencies in the data can follow only in the order of this sequence.  But in our data, perhaps, the order of the columns is reversed with respect to the dependencies between them.  With this feature, we did not do anything. <br><br>  Closer to the summer, the first working Python script appeared that generated the data.  At first glance, the quality of the data is decent: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/6f4/816/f70/6f4816f70912c3fb348f505d3073eded.jpg"><br><br>  The truth revealed difficulties: <br><br><ol><li>  The size of the model is about a gigabyte.  And we tried to create a model for data whose size was of the order of several gigabytes (for a start).  The fact that the resulting model is so large causes concern: what if it will be possible to get real data from which it has been trained.  Most likely no.  But I don‚Äôt understand machine learning and neural networks. I didn‚Äôt read the Python code from this person, so how can I be sure?  Then there were articles about how to compress neural networks without loss of quality, but this was left without implementation.  On the one hand, this does not look like a problem - you can refuse to publish the model and publish only the generated data.  On the other hand, in the case of retraining, the generated data may contain some part of the original data. </li><li>  On one machine with a CPU, the data generation rate is approximately 100 lines per second.  We had a task - to generate at least a billion lines.  The calculation showed that this could not be done before the diploma defense.  And to use another iron is inexpedient, because I had a goal - to make the data generation tool available for wide use. </li></ol><br>  Sharif tried to study the quality of the data by comparing statistics.  For example, I calculated the frequency with which different characters are encountered in the source and in the generated data.  The result was stunning - the most frequent symbols are √ê and √ë. <br><br>  Do not worry - he defended his diploma perfectly well, after which we safely forgot about this work. <br><br><h2>  Compressed Data Mutation </h2><br>  Suppose that the statement of the problem has decreased to one point: you need to generate data for which the compression ratios will be exactly the same as for the original data, and the data should be decompressed with exactly the same speed.  How to do it?  You need to edit the bytes of the compressed data directly!  Then the size of the compressed data will not change, but the data itself will change.  Yes, and everything will work quickly.  When this idea appeared, I immediately wanted to implement it, despite the fact that it solves some other task instead of the original one.  It always happens. <br><br>  How to edit a compressed file directly?  Suppose we are only interested in LZ4.  Compressed using LZ4 data consists of commands of two types: <br><br><ol><li>  Literal (literals): copy the following N bytes as is. </li><li>  Match (match, minimum repetition length is 4): repeat N bytes that were in the file at a distance M. </li></ol><br>  Initial data: <br>  <code>Hello world Hello</code> . <br><br>  Compressed data (conditionally): <br>  <code>literals 12 "Hello world " match 5 12</code> . <br><br>  In the compressed file, we leave match as it is, and in the literals we will change the values ‚Äã‚Äãof bytes.  As a result, after releasing, we get a file in which all repeating sequences of length not less than 4 are also repeated, and they are repeated at the same distances, but at the same time consist of another set of bytes (figuratively speaking, in the modified file not a single byte was taken ). <br><br>  But how to change bytes?  This is not obvious, because in addition to column types, the data also has its own internal, implicit structure that we would like to preserve.  For example, text is often stored in UTF-8 encoding - and we want valid UTF-8 in the generated data too.  I made a simple heuristic to satisfy several conditions: <br><br><ul><li>  the null bytes and the ASCII control characters were kept as is, </li><li>  some punctuation preserved </li><li>  ASCII was translated to ASCII, and for the rest, the most significant bit was preserved (or you can explicitly write an if set for different UTF-8 lengths).  Among one class of bytes, a new value is chosen uniformly at random; </li><li>  and also to keep <code>https://</code> fragments and similar ones, otherwise everything looks too stupid. </li></ul><br>  The peculiarity of this approach is that the source data itself serves as a model for the data, which means that the model cannot be published.  It allows you to generate the amount of data not more than the original.  For comparison, in previous approaches it was possible to create a model and generate an unlimited amount of data on its basis. <br><br>  Example for URL: <br><br> <code>http://ljc.she/kdoqdqwpgafe/klwlpm&amp;qw=962788775I0E7bs7OXeAyAx <br> http://ljc.she/kdoqdqwdffhant.am/wcpoyodjit/cbytjgeoocvdtclac <br> http://ljc.she/kdoqdqwpgafe/klwlpm&amp;qw=962788775I0E7bs7OXe <br> http://ljc.she/kdoqdqwdffhant.am/wcpoyodjit/cbytjgeoocvdtclac <br> http://ljc.she/kdoqdqwdbknvj.s/hmqhpsavon.yf#aortxqdvjja <br> http://ljc.she/kdoqdqw-bknvj.s/hmqhpsavon.yf#aortxqdvjja <br> http://ljc.she/kdoqdqwpdtu-Unu-Rjanjna-bbcohu_qxht <br> http://ljc.she/kdoqdqw-bknvj.s/hmqhpsavon.yf#aortxqdvjja <br> http://ljc.she/kdoqdqwpdtu-Unu-Rjanjna-bbcohu_qxht <br> http://ljc.she/kdoqdqw-bknvj.s/hmqhpsavon.yf#aortxqdvjja <br> http://ljc.she/kdoqdqwpdtu-Unu-Rjanjna-bbcohu-702130 <br></code> <br>  I was pleased with the result - it was interesting to watch the data.  But still something was wrong.  The structure of the URLs was preserved, but in some places it was too easy to guess yandex or avito.  Made heuristics, which sometimes rearranges some bytes in places. <br><br>  Worried and other considerations.  For example, sensitive information can be represented in a column of the type FixedString in binary form and for some reason consist of ASCII control characters and punctuation, which I decided to keep.  And I do not consider data types. <br><br>  Another problem: if data of the ‚Äúlength, value‚Äù type is stored in one column (this is how String type columns are stored), then how to ensure that the length remains correct after the mutation?  When I tried to fix it, the task immediately became uninteresting. <br><br><h2>  Random permutations </h2><br>  But the problem is not solved.  We conducted several experiments, and it only got worse.  It remains only to do nothing and read random pages on the Internet, because the mood is already spoiled.  Fortunately, on one of these pages was an <a href="http://fabiensanglard.net/fizzlefade/index.php">analysis of the algorithm for</a> rendering the scene of the death of the main character in the game Wolfenstein 3D. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/a5d/8a2/291/a5d8a229119786bc45f48fb74cfb956d.gif" width="640" height="480"><br><br>  Beautiful animation - the screen is filled with blood.  The article explains that this is actually a pseudo-random permutation.  A random permutation is a randomly chosen one-to-one transformation of a set.  That is, the display of the entire set, in which the results for different arguments are not repeated.  In other words, it is a way to iterate over all the elements of a set in a random order.  It is this process that is shown in the picture - we paint over each pixel, selected in random order from all, without repetitions.  If we simply chose a random pixel at each step, it would take us a long time to fill in the last one. <br><br>  The game uses a very simple algorithm for a pseudo-random permutation - <a href="https://en.wikipedia.org/wiki/Linear-feedback_shift_register">LFSR</a> (linear feedback shift register).  Like pseudo-random number generators, random permutations, or rather their key parametrized families, can be cryptographically resistant ‚Äî we just need this for data conversion.  Although there may be unclear details.  For example, cryptographically strong encryption of N bytes to N bytes with a pre-fixed key and initialization vector, it would seem, can be used as a pseudo-random permutation of a set of N-byte strings.  Indeed, such a transformation is one-to-one and looks random.  But if we use the same transformation for all our data, the result may be subject to analysis, because the same value is the initialization vector and the key is used several times.  This is similar to the <a href="https://en.wikipedia.org/wiki/Block_cipher_mode_of_operation">Electronic Codebook</a> mode of block cipher operation. <br><br>  What are some ways to get a pseudo-random permutation?  You can take simple one-to-one transformations and assemble from them a fairly complex function that will look random.  I will give as an example some of my favorite one-to-one transformations: <br><br><ul><li>  multiplication by an odd number (for example, a large prime number) in two's complement arithmetic, </li><li>  xor-shift: <code>x ^= x &gt;&gt; N</code> , </li><li>  CRC-N, where N is the number of bits of the argument. </li></ul><br>  For example, from three multiplications and two xor-shift operations, the <a href="">murmurhash</a> finalizer is <a href="">compiled</a> .  This operation is a pseudo-random permutation.  But just in case, I note that hash functions, even N bits to N bits, are not required to be one-to-one. <br><br>  Or another interesting <a href="https://preshing.com/20121224/how-to-generate-a-sequence-of-unique-random-integers/">example from elementary number theory</a> from the site of Jeff Preshing. <br><br>  How can pseudo-random permutations be used for our task?  With their help, you can convert all numeric fields.  Then it will be possible to preserve all the cardinality and mutual cardinality of all combinations of fields.  That is, COUNT (DISTINCT) will return the same value as before the conversion, moreover with any GROUP BY. <br><br>  It is worth noting that the preservation of all cardinality is a bit contrary to the formulation of the problem of anonymizing data. ,  ,         ,      10  ,        .           10   ‚Äî   ,    .    ,    ,     ,         ‚Äî ,    ,    .       . ,    ,         ,     Google,       ,  -          Google.       ‚Äî ,      ,          ( )     ( ).  ,        ,   <a href="https://medium.com/georgian-impact-blog/a-brief-introduction-to-differential-privacy-eacf8722283b"></a> . <br><br>           ,      . ,       10,        .  How to achieve this? <br><br> ,       size classes         (  ).       size class        ,    .  0  1    .  2  3   1/2        1/2      .   1024..2047     1024! () .  And so on.        . <br><br>  ,     . ,      -.    ,      . <br><br>       ,     ,      ,             . <br><br>    ‚Äî             ,       .   .            .   Fabien Sanglard   c <a href="https://news.ycombinator.com/item%3Fid%3D15122540">Hackers News</a> ,      .      <a href="http://antirez.com/news/113">    Redis</a> ‚Äî  .    ,            <a href="https://en.wikipedia.org/wiki/Feistel_cipher"> </a> . <br><br>     .   ‚Äî  ,        . ,   . <br><br><ol><li>      : <br> <code>arg: xxxxyyyy <br> <font color="#0fc000">arg_l</font> : xxxx <br> <font color="#0000ff">arg_r</font> : yyyy</code> </li> <li>      .      xor        : <br> <code>res: yyyyzzzz <br> <font color="#0000ff">res_l</font> = yyyy = <font color="#0000ff">arg_r</font> <br> <font color="#FF6600">res_r</font> = zzzz = <font color="#0fc000">arg_l</font> ^ F( <font color="#0000ff">arg_r</font> )</code> </li> </ol><br>   ,     F            4 ,      . <br><br>   :  ,       ,      ‚Äî      ,       ,     ! <br><br>         .  ,    ,      ,    .     : <br><br><ul><li>     ,  ,  Electronic Codebook mode of operation; </li><li>        (  )   ,     ,      . </li></ul><br>           . ,     LZ4     ,             ,        . <br><br><h2>   </h2><br>    ,  ,  ,         .   ‚Äî     .  , ,      ,    .                ( ,    ).          ? <br><br> -,         : ,  256^10     10 ,      ,          . -,      ,     . <br><br>        ,      . ,    ,       .    ,       .    ,   -   . <br><br>             ,       ‚Äî  ,     N   . N ‚Äî   . , N = 5,       ¬´¬ª   ¬´¬ª.       Order-N. <br><br> <code>P( <font color="#ff0000"></font> | ) = 0.9 <br> P( <font color="#ff0000"></font> | ) = 0.05 <br> P( <font color="#ff0000"></font> | ) = 0.01 <br> ...</code> <br> <br>         <a href="https://yandex.ru/referats/">.</a> ( vesna.yandex.ru).      LSTM,           N,    ,  .          ‚Äî           ,    .  :      ,  ,      . <br><br>   Title: <br><br><blockquote>   ‚Äî . ‚Äî     ,   .   ,   ,      ‚Äî .@Mail.Ru ‚Äî   ‚Äî -    . ) ‚Äî AUTO.ria.ua        </blockquote><br> ,       ,          .       () ,           ‚Äî   .        0  N,         N    N ‚àí 1). <br><br>       . ,      123456   URL,          .                    .      -.       .      ,    . <br><br>   :         URL,        ,   -. : <code>https://www.yandex.ru/images/cats/?id=xxxxxx</code> .  ,      URL,      ,   . : <code>http://ftp.google.kz/cgi-bin/index.phtml?item=xxxxxx</code> .                  -     ,      8    . <br><br> <code>https://www.yandex.ru/ <font color="#0fc000">images/c</font> ats/?id=12345 <br> ^^^^^^^^ <br> <br> distribution: [aaaa][b][cc][dddd][e][ff][g <font color="#ff0000">g</font> ggg][h]... <br> hash(" <font color="#0fc000">images/c</font> ") % total_count:           ^ <br> <br></code> <code>http://ftp.google.kz/c <font color="#ff0000">g</font> ...</code> <br> <br>    ,  .     : <br><br><blockquote><pre> -        | . -    <font></font>
-  ‚Äî .:      Lore - dfghf ‚Äî . -   )  473682  -  <font></font>
- !   ¬ª  -  ‚Äî      <font></font>
- !   ¬ª , <font></font>
-  .  c      @Mail.Ru - <font></font>
-     ,  2010 |  . <font></font>
- !    : 820 0000 .,    -<font></font>
-   - DoramaTv.ru -   . -  ..    <font></font>
-  .  2013 ,       -&gt;  80 .<font></font>
-  -    (.    , ,  <font></font>
-   . 5, 69,  W* - ., ,      World of Tanks<font></font>
- ,     . 2     @Mail.Ru<font></font>
-      ,  .   <font></font>
</pre></blockquote><br><h2>  Result </h2><br>        ,     - ,        -   .          ,  .      clickhouse-obfuscator,     :          (, CSV, JSONEachRow),        (   )    ( ,       ).         . <br><br>     clickhouse-client,         Linux.        ,   ClickHouse. ,         MySQL  PostgreSQL ,        . <br><br> <code>clickhouse-obfuscator \ <br> --seed "$(head -c16 /dev/urandom | base64)" \ <br> --input-format TSV --output-format TSV \ <br> --structure 'CounterID UInt32, URLDomain String, \ <br> URL String, SearchPhrase String, Title String' \ <br> &lt; table.tsv &gt; result.tsv <br> <br> clickhouse-obfuscator --help <br></code> <br>    ,        .     ,   ?      ,        ,    .        ,    ,      .   ,     (  <code>--help</code> )   . <br><br>     <a href="https://clickhouse.yandex/docs/ru/getting_started/example_datasets/metrica/">   </a> ,        . <br><br> <a href="">clickhouse-datasets.s3.yandex.net/hits/tsv/hits_v1.tsv.xz</a> <br> <a href="">clickhouse-datasets.s3.yandex.net/visits/tsv/visits_v1.tsv.xz</a> <br><br>                ClickHouse.          ,       ClickHouse  . </div><p>Source: <a href="https://habr.com/ru/post/457354/">https://habr.com/ru/post/457354/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../457340/index.html">10 PostCSS plugins that will save time for your coder</a></li>
<li><a href="../457342/index.html">Signs from above: how did we save cartographers from unnecessary work and red eyes</a></li>
<li><a href="../457348/index.html">Deploy to PythonAnywhere from GitHub</a></li>
<li><a href="../457350/index.html">Why does the oscilloscope support cryptography?</a></li>
<li><a href="../457352/index.html">Information output on the customer‚Äôs display</a></li>
<li><a href="../45736/index.html">nginx: another allocator</a></li>
<li><a href="../457362/index.html">Action from RUVDS: prepare the server in the summer</a></li>
<li><a href="../457366/index.html">A fanatic, a iron player or a spectator - what kind of gamer are you?</a></li>
<li><a href="../45737/index.html">Mumbai terrorists and new US IT policy</a></li>
<li><a href="../457370/index.html">Creating a 3-level menu using the Htmlix framework</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>