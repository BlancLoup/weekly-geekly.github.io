<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>When is a string not a string?</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="As part of my ‚Äúwork‚Äù on standardization of C # 5 in the ECMA-334 TC49-TG2 technical group, I was lucky to see several interesting ways that Vladimir R...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>When is a string not a string?</h1><div class="post__text post__text-html js-mediator-article">  As part of my ‚Äúwork‚Äù on standardization of C # 5 in the <a href="http://www.ecma-international.org/memento/TC49-TG2.HTM">ECMA-334 TC49-TG2</a> technical group, I was lucky to see several interesting ways that <a href="https://twitter.com/vreshetnikov">Vladimir Reshetnikov</a> tested C # for strength.  This article describes one of the problems that he raised.  Of course, it most likely will not affect 99.999% C # developers in any way ... but it's still interesting to understand. <br><br>  Specifications used in the article: <br><br><ul><li>  <a href="http://www.unicode.org/versions/Unicode7.0.0/">Unicode</a> Standard <a href="http://www.unicode.org/versions/Unicode7.0.0/">7.0.0</a> - in particular, <a href="http://www.unicode.org/versions/Unicode7.0.0/ch03.pdf">Chapter 3</a> </li><li>  <a href="http://www.microsoft.com/en-us/download/details.aspx%3Fid%3D7029">C # 5</a> (Word Document) </li><li>  <a href="http://www.ecma-international.org/publications/standards/Ecma-335.htm">ECMA-335</a> (CLI Specification) </li></ul><br><h3>  What is a string? </h3><br>  How would you declare the type <code>string</code> (or <code>System.String</code> )?  I can suggest several answers to this question, from vague to fairly specific: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ul><li>  "Any text in quotes" </li><li>  Character string </li><li>  Unicode character sequence </li><li>  16-bit sequence </li><li>  UTF-16 word sequence </li></ul><br>  Only the last statement is completely true.  The C # 5 specification (Section 1.3) reads: <br><br><blockquote>  Handling strings and characters in C # uses UTF-16.  The type <code>char</code> represents the word UTF-16, and the type string represents the sequence of words UTF-16. <br></blockquote><br>  So far, so good.  But this is C #.  What about IL?  What is used there and does it matter?  It turns out that it has ... Strings should be declared in IL as constants, and the nature of this presentation method is important - not only the encoding, but also the interpretation of this encoded data.  In particular, a sequence of UTF-16 words may not always be represented as a sequence of UTF-8 words. <a name="habracut"></a><br><br><h3>  Everything is very bad (formed) </h3><br>  For example, take the string literal <code>‚ÄúX\uD800Y‚Äù</code> .  This is a string representation of the following UTF-16 words: <br><br><ul><li>  <code>0x0058</code> - 'X' </li><li>  <code>0xD800</code> - the first part of the surrogate pair </li><li>  <code>0x0059</code> - 'Y' </li></ul><br>  This is a completely normal string ‚Äî it is even a Unicode string according to the specification (section D80).  But it is poorly formed (section D84).  This is because the word UTF-16 <code>0xD800</code> does not correspond to any scalar Unicode value (section D76) - the surrogate pairs are explicitly excluded from the list of scalar values. <br><br>  For those who first hear about surrogate pairs: UTF-16 uses only 16-bit words, and therefore cannot fully cover all valid Unicode values, the range of which is <code>U+0000</code> to <code>U+10FFFF</code> inclusive.  If you need to represent in UTF-16 a symbol with a code greater than <code>U+FFFF</code> , then two words are used: the first part of the surrogate pair (in the range from <code>0xD800</code> to <code>0xDBFF</code> ) and the second ( <code>0xDC00 ‚Ä¶ 0xDFFF</code> ).  Thus, only the first part of the surrogate pair does not in itself make any sense ‚Äî it is the correct word of UTF-16, but it only gets a value if the second part follows. <br><br><h3>  Show the code! </h3><br>  And how does all this relate to C #?  Well, constants should be somehow represented at the IL level.  It turns out that there are two ways of representing here - in most cases, UTF-16 is used, but for the arguments of the attribute constructor, UTF-8. <br><br>  Here is an example: <br><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.ComponentModel; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Text; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Linq; [Description(Value)] <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Test</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Value = <span class="hljs-string"><span class="hljs-string">"X\ud800Y"</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Main</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> description = (DescriptionAttribute) <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(Test).GetCustomAttributes(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(DescriptionAttribute), <span class="hljs-literal"><span class="hljs-literal">true</span></span>)[<span class="hljs-number"><span class="hljs-number">0</span></span>]; DumpString(<span class="hljs-string"><span class="hljs-string">""</span></span>, description.Description); DumpString(<span class="hljs-string"><span class="hljs-string">""</span></span>, Value); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DumpString</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> name, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> text</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> utf16 = text.Select(c =&gt; ((<span class="hljs-keyword"><span class="hljs-keyword">uint</span></span>) c).ToString(<span class="hljs-string"><span class="hljs-string">"x4"</span></span>)); Console.WriteLine(<span class="hljs-string"><span class="hljs-string">"{0}: {1}"</span></span>, name, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Join(<span class="hljs-string"><span class="hljs-string">" "</span></span>, utf16)); } }</code> </pre><br>  In .NET, the output of this program will be as follows: <br><br><pre> <code class="hljs">: 0058 fffd fffd 0059 : 0058 d800 0059</code> </pre><br>  As you can see, the ‚Äúconstant‚Äù remained unchanged, but the <code>U+FFFD</code> characters appeared in the attribute property value (a <a href="http://www.fileformat.info/info/unicode/char/0fffd/index.htm">special code</a> used to mark the dead data when decoding binary values ‚Äã‚Äãinto text).  Let's take a deeper look and look at the IL code describing the attribute and constant: <br><br><pre> <code class="hljs cpp">.custom instance <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> [System]System.ComponentModel.DescriptionAttribute::.ctor(<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>) = ( <span class="hljs-number"><span class="hljs-number">01</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">05</span></span> <span class="hljs-number"><span class="hljs-number">58</span></span> ED A0 <span class="hljs-number"><span class="hljs-number">80</span></span> <span class="hljs-number"><span class="hljs-number">59</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> ) .field <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> literal <span class="hljs-built_in"><span class="hljs-built_in">string</span></span> Value = bytearray (<span class="hljs-number"><span class="hljs-number">58</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> D8 <span class="hljs-number"><span class="hljs-number">59</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> )</code> </pre><br>  The format of the constant ( <code>Value</code> ) is quite simple - it is UTF-16 with a byte order from low to high ( <i>little-endian</i> ).  The attribute format is described in the ECMA-335 specification in section II.23.3.  We analyze it in detail: <br><br><ul><li>  Prologue (01 00) </li><li>  Fixed Arguments (for the selected constructor) </li><li>  05 58 ED A0 80 59 (one packed string) <br><ul><li>  05 (length equal to 5 - PackedLen) </li><li>  58 ED A0 80 59 (UTF-8 encoded string value) </li></ul></li><li>  Number of named arguments (00 00) </li><li>  Named arguments themselves (there are none) </li></ul><br>  The most interesting part here is "UTF-8 encoded string value".  The value is not a valid UTF-8 string because it is poorly formed.  The compiler took the first word of the surrogate pair, determined that it was not followed by the second, and simply processed it in the same way as it should handle any other characters in the range from <code>U+0800</code> to <code>U+FFFF</code> inclusive. <br><br>  It should be noted that if we had a whole surrogate pair, UTF-8 would encode it as one scalar Unicode value, using 4 bytes.  For example, change the <code>Value</code> declaration to the following: <br><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Value = <span class="hljs-string"><span class="hljs-string">"X\ud800\udc00Y"</span></span>;</code> </pre><br>  In this case, at the IL level, we get the following set of bytes: <code>58 F0 90 80 80 59</code> - where <code>F0 90 80 80</code> is the representation of the words UTF8 under the number <code>U+10000</code> .  This string is formed correctly and its values ‚Äã‚Äãin the attribute and the constant would be the same. <br><br>  However, in our original example, the value of the constant is decoded without checking whether it is correctly formed, while for the value of the attribute an additional check is used that detects and replaces incorrect codes. <br><br><h3>  Coding behavior </h3><br>  So which approach is the right one?  According to the Unicode specification (section C10), both are true: <br><br><blockquote>  When a process interprets a sequence of codes, which may be an encoded Unicode character, poorly formed sequences should cause an error condition, rather than being treated as characters. </blockquote><br>  And at the same time: <br><br><blockquote>  Processes that comply with this specification should not interpret poorly formed sequences.  However, the specification does not prohibit the handling of codes that are not encoded Unicode characters.  For example, to improve performance, low-level string operations can process codes without interpreting them as characters. </blockquote><br>  It is not completely clear to me whether the values ‚Äã‚Äãof the constants and arguments of the attributes ‚Äúshould be encoded Unicode characters‚Äù.  In my experience, the specification almost never states whether a correctly formed string is required or not necessary. <br><br>  In addition, implementations of <code>System.Text.Encoding</code> can be customized by specifying the behavior in case of attempts to encode or decode poorly formed data.  For example: <br><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">Encoding</span></span>.UTF8.GetBytes(<span class="hljs-keyword"><span class="hljs-keyword">Value</span></span>)</code> </pre><br>  It will return the byte sequence <code>58 EF BF BD 59</code> - in other words, it will detect incorrect data and replace it with <code>U+FFFD</code> , and decoding will take place without problems.  But: <br><br><pre> <code class="hljs pgsql"><span class="hljs-built_in"><span class="hljs-built_in">new</span></span> UTF8Encoding(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>).GetBytes(<span class="hljs-keyword"><span class="hljs-keyword">Value</span></span>)</code> </pre><br>  Throw an exception.  The first argument of the constructor indicates the need to generate a <abbr title="Byte order mark">BOM</abbr> , the second - how to deal with incorrect data (the <code>EncoderFallback</code> and <code>DecoderFallback</code> properties are also used). <br><br><h3>  Language behavior </h3><br>  So should this code be compiled at all?  <i>At the moment,</i> the language specification does not prohibit this - but the specification can be fixed :) <br><br>  Generally speaking, both <code>csc</code> and Roslyn still prohibit the use of poorly formed strings in some attributes, for example, the <code>DllImportAttribute</code> : <br><br><pre> <code class="hljs cs">[<span class="hljs-meta"><span class="hljs-meta">DllImport(Value)</span></span>] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">extern</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Foo</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>;</code> </pre><br>  This code will generate a compiler error if the <code>Value</code> value is poorly formed: <br><br><blockquote>  error CS0591: DvalImport attribute </blockquote><br>  Perhaps there are other attributes with the same behavior - not sure. <br><br>  If we assume that the attribute argument value will not be decoded into the original form when an attribute instance is created, it can be considered with a clear conscience an error at the compilation stage.  (Unless, of course, we change the execution environment so that it keeps exactly the value of a poorly formed string) <br><br>  But what to do with the constant?  Should this be valid?  Could this make sense?  In the form in which the string is used in the example is unlikely, but there may be a case where the string must end with the first part of the surrogate pair, then add it to another string starting from the second part and get the correct string.  Of course, extreme caution is needed here - in the <a href="http://www.unicode.org/reports/tr36/">Unicode Technical Report # 36 (Security Considerations), there</a> are quite alarming possibilities for errors. <br><br><h3>  Implications of the foregoing </h3><br>  One of the interesting aspects of all this is that "string encoding arithmetic" may not work the way you think: <br><br><pre> <code class="hljs pgsql">//  ! string SplitEncodeDecodeAndRecombine(string <span class="hljs-keyword"><span class="hljs-keyword">input</span></span>, <span class="hljs-type"><span class="hljs-type">int</span></span> splitPoint, <span class="hljs-keyword"><span class="hljs-keyword">Encoding</span></span> <span class="hljs-keyword"><span class="hljs-keyword">encoding</span></span>) { byte[] firstPart = <span class="hljs-keyword"><span class="hljs-keyword">encoding</span></span>.GetBytes(<span class="hljs-keyword"><span class="hljs-keyword">input</span></span>.Substring(<span class="hljs-number"><span class="hljs-number">0</span></span>, splitPoint)); byte[] secondPart = <span class="hljs-keyword"><span class="hljs-keyword">encoding</span></span>.GetBytes(<span class="hljs-keyword"><span class="hljs-keyword">input</span></span>.Substring(splitPoint)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">encoding</span></span>.GetString(firstPart) + <span class="hljs-keyword"><span class="hljs-keyword">encoding</span></span>.GetString(secondPart); }</code> </pre><br>  It may seem to you that there can be no errors if there is no <code>null</code> anywhere, and the <code>splitPoint</code> value is in the range.  However, if you fall in the middle of a surrogate couple, everything will be very sad.  There may also be additional problems because of things like a form of normalization - most likely, of course not, but by this time I am not 100% sure of anything. <br><br>  If it seems to you that this example is divorced from reality, then imagine a large piece of text divided into several network packets or files - it does not matter.  It may seem to you that you are quite prudent and take care that the binary data is not shared among the UTF-16 code pair - but even this will not save you.  Oh oh. <br><br>  It breaks me downright to abandon word processing at all.  Floating point numbers are a nightmare, dates and times ... well, you know what I think of them.  I wonder if there are any projects in which only whole numbers are used, which are guaranteed to never overflow?  If you have such a project - let me know! <br><br><h3>  Conclusion </h3><br>  Text is hard! <br><br>  <i>Translator's Note:</i> <i><br></i>  <i>I found a link to the original of this article in the post <a href="http://habrahabr.ru/company/enterra/blog/243371/">‚ÄúLet's talk about the differences between Mono and MS.NET‚Äù</a> .</i>  <i>Thank you <a href="https://habrahabr.ru/users/dreamwalker/" class="user_link">DreamWalker</a> !</i>  <i>In his blog, by the way, there is also a small <a href="http://aakinshin.blogspot.ru/2014/11/mono-utf8-conversions.html">note</a> on the <a href="http://aakinshin.blogspot.ru/2014/11/mono-utf8-conversions.html">topic</a> of how the same example behaves under Mono.</i> </div><p>Source: <a href="https://habr.com/ru/post/243523/">https://habr.com/ru/post/243523/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../243513/index.html">Examination of the task on the example of the task of checking the analyzer RBNF declarations</a></li>
<li><a href="../243515/index.html">Learning Swift is now easier.</a></li>
<li><a href="../243517/index.html">Prototype data center on methane</a></li>
<li><a href="../243519/index.html">How I learned from my mistakes or how to make the second game better.</a></li>
<li><a href="../243521/index.html">Innovations in ecommerce that can change online shopping</a></li>
<li><a href="../243527/index.html">November 21 - online conference - about the new Visual Studio 2015 and other announcements of Connect ();</a></li>
<li><a href="../243529/index.html">Through thorns to Unity3D</a></li>
<li><a href="../243531/index.html">How to remove a bucket with 400 million files on Amazon S3</a></li>
<li><a href="../243535/index.html">Ultrastar He6 - the world's first helium HDD with a capacity of 6 TB</a></li>
<li><a href="../243537/index.html">What is memory leak in android, how to check the program for their absence and how to prevent them from appearing</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>