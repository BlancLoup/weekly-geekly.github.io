<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>2 million points on the map? easy!</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Not so long ago, to create a service (and put a module ‚Äúin store‚Äù), it was necessary to think of a way to quickly select the points located on the map...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>2 million points on the map? easy!</h1><div class="post__text post__text-html js-mediator-article">  Not so long ago, to create a service (and put a module ‚Äúin store‚Äù), it was necessary to think of a way to quickly select the points located on the map from the sql database. <br>  There will be little code that will not distract from understanding the system as a whole. <br><br><img src="https://habrastorage.org/storage2/49a/14c/76a/49a14c76a73c8b72bf72df64efe67371.png"><br><br><a name="habracut"></a><br><h4>  TK </h4><br>  And so, at the ‚Äúentrance‚Äù it has a base of 2 million points (so far only a test one, since the real one is still small), a Google map (or Yandex, not fundamentally) each point has coordinates.  The user must navigate the map, see all the points, the server should not be the size of the floor rack, taking into account the "desired" attendance of 200 people per second. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h5>  Ideas? </h5><br><br>  There are many points.  Lots of.  Variants with checks on the entry of a point into the map boundaries do not fit (like (x1 &lt;x &lt;x2) and (y1 &lt;y &lt;y2)), since such a request was made in 20‚Äì50 ms and we had to do it every time the map was moved + the amount of data went to tens of kilobytes (and given the fact that a ‚Äúbalun‚Äù with textual information can be added to a point, then megabytes).  Query caching does not actually make sense because of low efficiency. <br><br>  In the search for solutions came to the following points: <br>  1. work with tile map (square, block) <br>  2. store in the database at the point qtree tiles <br>  3. when moving around the map without changing the scale, load only points from the ‚Äúnew‚Äù tiles <br><br>  For understanding qtree <a href="http://en.wikipedia.org/wiki/Quadtree">en.wikipedia.org/wiki/Quadtree</a> <br>  To understand what will <a href="http://koti.mbnet.fi/ojalesa/quadtree/quadtree_intro.htm">come</a> out of this <a href="http://koti.mbnet.fi/ojalesa/quadtree/quadtree_intro.htm">koti.mbnet.fi/ojalesa/quadtree/quadtree_intro.htm</a> <br><br>  The string with the ‚Äútree‚Äù for each point in the database looks like 01320232312222100231210323203 (the number of digits is equal to the maximum zoom level). <br>  In fact, it means that if the world map is divided into 4 parts 2x2, then the point is in 1 block (numbering from zero and the ‚Äúmain block‚Äù with number 0 we missed for simplicity), if this block is divided again into 2x2, then it will be in block 3 and so on.  With each level of scaling we must look ‚Äúdeeper‚Äù into our ‚Äútree‚Äù. <br><br><img src="http://habrastorage.org/storage2/17f/627/559/17f627559f65a43e513aa8eafc575533.png"><br><br>  What is the beauty of data storage in this form? <br>  The beauty is that knowing the coordinates of the tile and the scale, we get a qtree of the form 132023231, and to find all the points included in this area on the map at a given scale level, you must make a request with the condition <b>point_qtree LIKE '132023231%'</b> (we are looking for the occurrence of a substring in the line with first character).  In this case, the point_qtree field, we must remember to index, that the speed of the samples will raise to the maximum level.  SQL will build a qtree tree, which will simplify the task for it as much as possible. <br><br>  Hooray.  The sample of points began to take many times less time. <br><br><h5>  Make a card </h5><br>  When moving around the map, we must do a number of things: <br><ul><li>  determine which tiles we see </li><li>  determine for which tiles we have already loaded the points </li></ul><br><br>  To determine the visible tiles in any map API, you can query the coordinates of the map window and the zoom level.  And based on these data, get a tile of the upper left and lower right and list all the others between them. <br><br>  We will have an array of the form 012, 013, 021, 020. <br><br>  Save it to a variable that we call oldTile. <br><br>  Each time we move around the map, we calculate all the tiles and compare them with the current array oldTile, while we should have an array of newTile which lists all the tiles that are not yet in oldTile.  Next, we need to send ajax request to the server for sampling points for each tile (in the request we can send an array of new tiles, but I will explain further the purpose of splitting into separate requests), let's say / point / 012, add new points to the map (without clearing the old ones) .  Next, do a simple oldTile = oldTile + oldTile. <br><br>  When changing the map scale, we will have to clear oldTile (and points on the map, one of the options. The second option: do not clean the points, but then the oldTile array should also not be cleared, but recalculated, for example, from 01 we should get 010, 011, 012, 013 ).  And after that, ‚Äúaccording to plan‚Äù, calculate visible tiles of the map, etc. <br><br>  What gives us this method: <br><ul><li>  we are requesting only new points from new places displayed on the map </li><li>  we get a good opportunity to answer the server with memekash and, setting up Nginx to work with it, get points in the tiles already from it (that's why we stopped at several requests to a particular tile, and do not do the sampling ‚Äúin bulk‚Äù. </li><li>  reduce the number of requests to the server database </li><li>  reduce traffic </li></ul><br><br>  As the next stage of system optimization: <br>  1. When adding a new point to the database, forcibly update all the arrays of the entire tree branch to the memcache.  Thus, we can ensure that requests for further nginx + memcache will not go away and the data will always be relevant, which will allow to move from memokash to radishes and not be afraid of ‚Äúcold starts‚Äù. </div><p>Source: <a href="https://habr.com/ru/post/147744/">https://habr.com/ru/post/147744/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../147738/index.html">Mathematical model of communication</a></li>
<li><a href="../147739/index.html">Read more about the implementation of GCM support on the Android client</a></li>
<li><a href="../147741/index.html">How I became a Robocode Champion</a></li>
<li><a href="../147742/index.html">Poster app for iOS: buying movie tickets, viewing trailers, adding photos and places</a></li>
<li><a href="../147743/index.html">Data access speed: the battle for the future</a></li>
<li><a href="../147745/index.html">Improving search relevance in sphinxsearch</a></li>
<li><a href="../147746/index.html">Real-time 3D rendering for architecture and industrial design</a></li>
<li><a href="../147748/index.html">Hacked androidforums.com</a></li>
<li><a href="../147750/index.html">Active Directory Audit Powershell Change Alert. Part 1</a></li>
<li><a href="../147751/index.html">Installing ZTE AX226 in Ubuntu 11.04 and 12.04</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>