<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>AssetManager: how to force the user to receive updated statics</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="When developing web applications, there is one well-known problem. We, programmers, write new javascript code, styles in css, change statics ... And t...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>AssetManager: how to force the user to receive updated statics</h1><div class="post__text post__text-html js-mediator-article">  When developing web applications, there is one well-known problem.  We, programmers, write new javascript code, styles in css, change statics ... And this static is usually cached by the user's browser and can remain in the cache for quite a long time (and this is actually correct, because it can speed up page loading at times) . <br><br>  But what to do if we changed the statics?  How to force the user to reset the cache and update these files?  There are some common ways, for example, adding a versioned label to a file name, or adding a timestamp in a GET parameter when a file is connected. <br><br>  In case you use the Yii framework, you can also specify versions or time stamps of the script files and styles when connecting, however, you need to constantly monitor this, and in the case of Yii also monitor the absence of conflicts (for example, when the widget and the use the same script, but with different timestamps). <br>  In fact, in Yii, you can organize a more civilized approach to this matter. <br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Step 1. Preparing files. </h4><br>  Create a subfolder of <i>assets</i> in the <i>protected</i> folder of your web application. <br>  We place all the statics in this folder.  Some files may have to be left in the root of the web application, if they need permanent external links (for example, favicon, logo, some documents). <br>  The file structure might look something like this: <br><pre> / protected
     / assets
         / css
             /main.css
         / img
             /bg.png
             /sprite.png
             /extra_icons.png
         / js
             /main.js
             /form.js
             /etc.js
</pre><br><br><h4>  Step 2. Preparation of tools. </h4><br>  Most likely, you already have an overridden <b>Controller</b> class, which you use as the base class for all other controllers. <br>  We will change it a bit to ensure work with assets: <br><pre><code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Controller</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CController</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $_assetsBase; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getAssetsBase</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_assetsBase === <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_assetsBase = Yii::app()-&gt;assetManager-&gt;publish( Yii::getPathOfAlias(<span class="hljs-string"><span class="hljs-string">'application.assets'</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>, <span class="hljs-number"><span class="hljs-number">-1</span></span>, YII_DEBUG ); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_assetsBase; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> $menu=<span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> $items=<span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> $breadcrumbs=<span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(); }</code> </pre> <br>  It's simple. <br>  Here we added a getter, which for the first time publishes the assets from the <i>/ protected / assets</i> folder and saves the path to the <b>_assetsBase</b> private property, and in subsequent times simply returns the value of this private property. <br>  The <b>publish ()</b> method of the <b>CAssetManager</b> class has several interesting parameters. <br><br>  Here is the method signature: <br><pre> <code class="php hljs">publish(string $path, boolean $hashByName=<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>, integer $level=<span class="hljs-number"><span class="hljs-number">-1</span></span>, boolean $forceCopy=<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>)</code> </pre><br>  And a brief description of the parameters: <br><br>  <b>$ path</b> - actually the path to the folder of assets, which we will publish; <br>  <b>$ hashByName</b> - determines whether to publish the folder name as it is, or to hash it.  Thanks to this parameter, all the magic happens, which will be discussed later; <br>  <b>$ level</b> - determines the degree of nesting of folders for publication ( <b>-1</b> - all subfolders are recursive); <br>  <b>$ forceCopy</b> - determines whether to force files to be copied, even if they already exist.  We set this parameter to <b>YII_DEBUG</b> , due to which our scripts will be constantly updated on the local machine, and on production - only if necessary (on production <b>YII_DEBUG</b> must be set to <b>false</b> ). <br><br><h4>  Step 3. We use the prepared tools above the prepared files. </h4><br>  That property <b>assetsBase</b> , for which we wrote a getter a little higher, can now be used everywhere. <br>  Now in the views and layouts we can write something as like: <br><pre> <code class="php hljs">&lt;link rel=<span class="hljs-string"><span class="hljs-string">"stylesheet"</span></span> type=<span class="hljs-string"><span class="hljs-string">"text/css"</span></span> href=<span class="hljs-string"><span class="hljs-string">"&lt;?=$this-&gt;assetsBase?&gt;/css/main.css"</span></span> /&gt;</code> </pre>  or <pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?</span></span>Yii::app()-&gt;clientScript-&gt;registerScriptFile(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;assetsBase.<span class="hljs-string"><span class="hljs-string">'/js/utils.js'</span></span>)<span class="hljs-meta"><span class="hljs-meta">?&gt;</span></span></code> </pre><br>  And we can write this way because <b>$ this</b> in this case is an instance of the <b>Controller</b> class from which all our controllers are inherited and which is passed to the views and layouts. <br><br>  With widgets, the situation is a little different; you need your own approach, because widget views are executed not in the context of the controller, but in the context of the widget, therefore, to connect the Javascript file in the widget's view, we will write: <br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?</span></span>Yii::app()-&gt;clientScript-&gt;registerScriptFile(Yii::app()-&gt;controller-&gt;assetsBase.<span class="hljs-string"><span class="hljs-string">'/js/widget.js'</span></span>)<span class="hljs-meta"><span class="hljs-meta">?&gt;</span></span></code> </pre><br><br><h4>  Step 4. Update the production version and force the user's browser to download the updated files. </h4><br>  This is the most important point and it is precisely that many developers overlooked it, including me once. <br>  Reading many articles on Yii, it may seem that in order for a user to get updated statics files, it‚Äôs enough to upload them to <i>/ protected / assets to</i> clean the <i>/ assets folder</i> in the site root (if <b>AssetManager is</b> used of <b>course</b> ) and voila - the user will <b>update</b> everything by itself. <br>  <b>But this is not the case at all!</b> <br><br>  Auto-generated subfolders names in the <i>/ assets</i> folder in the root of the web application are based on the hash of the folder name <i>/ protected / assets</i> and <b>do not</b> change from time to time, even if you clean the <i>/ assets folder</i> in the root of the web application.  They are restored in its original form.  This means that the user's browser does not "skip" that something has changed until the caching time expires. <br><br>  At least it was until recently.  And this problem was discussed in <a href="http://www.yiiframework.com/forum/index.php/topic/23055-asset-manager" title="Go to the forum Yii">this topic</a> , after which Alexander Makarov found a workaround and with his <a href="http://code.google.com/p/yii/source/detail%3Fspec%3Dsvn3602%26r%3D3441">commit</a> on November 8, 2011, he corrected the situation. <br>  Now, the second parameter of the <b>CAssetManager</b> class's <b>publish ()</b> <b>method</b> ‚Äî the <b>$ hashByName</b> parameter set to <b>false</b> ‚Äî forces Yii to build the names of the subfolders in the <i>/ assets</i> folder in the root of the web application based on the hash of the name of the folder with statics, <u>as well as the modification date of this folder</u> . <br><br>  Due to this, we can make a very simple trick with the deployment of application static files: <br><pre> <code class="bash hljs">touch /path/to/your/website/protected/assets</code> </pre><br>  we execute this command in the console of your linux server (we assume that the site is still deployed under linux) and the next time you use the static Yii will generate new asset names! <br>  This means that the user who opened the page will download absolutely new, fresh, improved scripts, styles, images, etc. <br><br><h4>  To put it in a nutshell </h4><br>  You just need to: <br><ol><li>  All static should be placed in the / protected / assets folder </li><li>  Expand the base controller class as described above. </li><li>  Use assetsBase everywhere as a basis for static paths. </li><li>  When updating statics on the site, execute the command <pre> <code class="bash hljs">touch /path/to/your/website/protected/assets</code> </pre>  which will lead to a change in the modification date of the <i>/ protected / assets</i> folder, which means the generation of a new hash in the <i>/ assets</i> folder in the site root </li><li>  Benefit: you can be sure that users get the latest version of your scripts, styles, etc. </li></ol><br><br><h4>  A little about the other </h4><br>  By the way, as far as I know, for example, in Ruby on Rails this problem has already been solved. <br>  In Yii version 2, which is under development, this problem is also likely to be resolved. <br>  In discussing the solution to this problem for Yii 2, you can participate in the <a href="http://www.yiiframework.com/forum/index.php%3F/topic/23147-asset-manager/" title="Go to the forum Yii">forum</a> (access is open only to active participants). <br><br>  Also, another interesting feature is the automatic minification of scripts and css.  At the moment it is not implemented at the framework level, but implemented in some extensions, but this is a topic for another article ... <br><br><h4>  Useful links on the topic </h4><br><ol><li>  <a href="http://www.yiiframework.com/doc/api/1.1/CAssetManager">Documentation</a> for the CAssetManager class. </li><li>  <a href="http://www.yiiframework.com/forum/index.php/topic/23055-asset-manager">Discussion of</a> this topic on the forum Yii </li><li>  <a href="http://www.yiiframework.com/forum/index.php%3F/topic/23147-asset-manager/">Discussion of</a> this problem for the new version of Yii 2 (available for active users only) </li><li>  Extensions for minification: <br><ul><li>  <a href="http://www.yiiframework.com/extension/escriptboost">escriptboost</a> </li><li>  <a href="http://www.yiiframework.com/extension/clientscriptpacker">clientcriptpacker</a> </li><li>  <a href="http://www.yiiframework.com/extension/minscript">minscript</a> </li><li>  <a href="http://www.yiiframework.com/extension/minifyclientscript">minifyclientscript</a> </li><li>  <a href="http://www.yiiframework.com/extension/dynamicres/">dynamicres</a> </li></ul></li><li>  <a href="http://www.yiiframework.com/wiki/311/assetmanager-clearing-browser-s-cache-on-site-update/">English version of</a> this article </li><li>  <a href="http://www.yiiframework.com/wiki/148/understanding-assets">Another article</a> describing how to work with CAssetManager </li></ol><br><br>  PS: I note that this article is neither a translation nor a crosspost, because I also wrote the English version of the article for the Yii knowledge base, but the Russian version is more qualitative and understandable (due to different levels of knowledge of languages). </div><p>Source: <a href="https://habr.com/ru/post/139166/">https://habr.com/ru/post/139166/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../139157/index.html">Dell is changing the direction of the company</a></li>
<li><a href="../139158/index.html">3 minutes per month on Google+</a></li>
<li><a href="../139159/index.html">Sort text field as numbers and as strings simultaneously in MySQL</a></li>
<li><a href="../139163/index.html">Windows 8 Consumer Preview Review</a></li>
<li><a href="../139165/index.html">How to / Installing Zabbix-server (FreeBSD, PostgreSQL, Nginx)</a></li>
<li><a href="../139167/index.html">Haskell - Design</a></li>
<li><a href="../139170/index.html">Laptop Batteries - Fantasy and Reality</a></li>
<li><a href="../139172/index.html">Microsoft pushes the Secure Boot equivalent on the ARM architecture</a></li>
<li><a href="../139173/index.html">Because I am an independent child</a></li>
<li><a href="../139175/index.html">Production of MTS 945 GLONASS is suspended</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>