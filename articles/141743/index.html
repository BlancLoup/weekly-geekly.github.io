<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Creating a state machine for parsing an HTTP request</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Deterministic state machine can be used to implement a very fast way to parse the input sequence. It requires only one pass through the input sequence...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Creating a state machine for parsing an HTTP request</h1><div class="post__text post__text-html js-mediator-article"> Deterministic state machine can be used to implement a very fast way to parse the input sequence.  It requires only one pass through the input sequence, and minimal steps at each step.  Unfortunately, this model has limitations - it is not always possible to build a DFA for the existing Nondeterministic finite state machine (regular expression, grammar).  Or even if it is possible to build, an automaton may have too many states. <br><br>  Nevertheless, I decided to try to create a parser for an HTTP request based on DKA.  The main task is not just to verify the correctness of the HTTP request, but to select elements in the input line that correspond to certain values ‚Äã‚Äãof the HTTP request fields.  The machine should be generated from the BNF rules (scattered over) RFC2616.  Everything is implemented in C #, the automaton at the output is also in C #.  Although it is clear that when the machine is ready, to generate it in any language, in any form is not a problem. <br><a name="habracut"></a><br>  To generate the DCA, the following chain of actions is implemented: <br>  1. Analysis of BNF rules <br>  2. Creation of an NCA based on them <br>  3. Convert NCA to DCA <br>  4. Minimize DCA <br>  5. Creating files with source text and jump table <br><br>  I used <a href="http://irony.codeplex.com/">Irony</a> to parse BNF grammar, ABNF grammar is well described in RFC5234.  According to the syntax tree, the program builds the NCA according to the rules of Thomson.  I used standard algorithms to convert the NCA to the DCA, and to minimize, I will not describe them either. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Since the HTTP message is a relatively simple object, the output of the parser is a class (this is enough), with fields corresponding to HTTP headers.  In order for the automaton to parse the message during the passage, simple actions modifying class variables are added to the DFA during generation.  For example, you need to get the value of the Host header, the class has two variables, the beginning and end of the header.  In the states that are triggered when the machine goes to the value of the Host field, actions are added to change these variables.  In the DCA itself, it is impossible to determine which state is responsible for what.  Therefore, the states are marked when creating an NCA, and then these labels are preserved, with all the transformations of the automaton.  To simplify the marking of states and the assignment of actions, a simple language was made, in which the names of variables are specified and what values ‚Äã‚Äãthey will receive.  On the basis of this data, a class is then generated and in which the parser places the result of the work. <br><br>  A similar approach is used in regular expressions (although not all implementations do a conversion to a DFA).  But with direct access to the machine, it is possible to make a number of interesting optimizations.  For example, the Content-Lenght field contains the length of the message body; for this field, conversion to a number occurs directly in the machine; at the output, we have a field of the int ContentLenght class.  Another interesting optimization, for example, for the HTTP request is a set of methods (GET, HOST ...).  At the output of the parser, you can immediately get a constant corresponding to the method.  And all this in one pass. <br><br>  It is also very important that the parser accepts an array of bytes as input, this is especially true for modern languages ‚Äã‚Äãlike C #, where the string is not an array of bytes as in C ++, and simply casting a pointer will not work. <br><br>  In general, the system looks like this.  There is a BNF grammar, and a description of the class that we want to get at the output.  All this is fed to the input of the generator, and we get a DKA on C #.  With a ready-made machine, you can work as follows: <br><br> <code>dfa.SetDefaultValue(); <br> dfa.Parse(message0, 0, message0.Length); <br> dfa.SetArray(message0); <br> <br> Console.WriteLine("Method: {0}", dfa.Method); <br> Console.WriteLine("Request-URI: |{0}|", dfa.RequestUri.ToString()); <br> Console.WriteLine("Host: |{0}|", dfa.Host.ToString()); <br> Console.WriteLine("Content-Type: |{0}|", dfa.ContentType.Value.ToString()); <br> Console.WriteLine("Content-Length: {0}", dfa.ContentLength); <br> Console.WriteLine("Referer: |{0}|", dfa.Referer.ToString()); <br></code> <br><br>  In practice, a DFA for an HTTP request contains before minimizing 150K states, after 1K-2K.  It is clear, firstly, that 1K-2K is quite acceptable value for real use.  In the second 150K states, it requires some memory and time to compute (at least in my implementation) - minutes x-tsat. <br><br>  The speed of the parser is very high, the formal rough estimate for this approach is ~ C * O (n), and it is probably difficult to fundamentally improve it.  In reality, the C # parser on my machine managed to parse 1M times in 3.3 seconds a message 220 bytes long. <br><br>  Project source code is available: <a href="http://code.google.com/p/siprevo/">code.google.com/p/siprevo</a> <br><br>  The code at the output of the generator tried to be accurate, but the gene generator itself was slightly (if not more) in the draft version.  It‚Äôs good (but not during debugging) that such systems almost cannot fail, it either works or does not work, in this case it works. <br><br>  <b>Update: the</b> <i>‚Äúcompiler‚Äù of the</i> automaton as a separate utility <i>lives</i> <a href="https://github.com/vf1/bnf2dfa">here</a> . </div><p>Source: <a href="https://habr.com/ru/post/141743/">https://habr.com/ru/post/141743/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../141738/index.html">Total BANAN, or wonders of spoofing poppy addresses in Win7</a></li>
<li><a href="../141739/index.html">How to promote the "Social Network Ark", if this is a fantastic trilogy</a></li>
<li><a href="../141740/index.html">Modder has equipped a controller for SNES wireless module</a></li>
<li><a href="../141741/index.html">‚ÄúRunet today‚Äù, April 9, 2012. Experts of the issue: Alexey Belyaev, Evgeny Etin</a></li>
<li><a href="../141742/index.html">Startup WebcamTelecom. A look at the communications of the future</a></li>
<li><a href="../141744/index.html">Cross-platform multithreaded applications</a></li>
<li><a href="../141745/index.html">fc.tape - js-library for simple animation of sprites</a></li>
<li><a href="../141746/index.html">Assignments in conditions</a></li>
<li><a href="../141747/index.html">Creating a RESTful API in Google App Engine based on Flask</a></li>
<li><a href="../141748/index.html">Toshiba Portege Z830 Ultrabook Video Review</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>