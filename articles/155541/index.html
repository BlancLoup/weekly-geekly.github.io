<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Top comments Habra - service, implementation details, and some statistics (C #)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Some time ago, the "Best Comments" page was removed from Habr (details here: habrahabr.ru/qa/18401 ). 
 Nevertheless, I used to be interesting to look...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Top comments Habra - service, implementation details, and some statistics (C #)</h1><div class="post__text post__text-html js-mediator-article">  Some time ago, the "Best Comments" page was removed from Habr (details here: <a href="http://habrahabr.ru/qa/18401/">habrahabr.ru/qa/18401</a> ). <br>  Nevertheless, I used to be interesting to look there - and for the sake of lulz, and sometimes interesting articles come across from those that were missed in the tape.  So I decided to make my own small service.  I hope the administration will not mind. <br><br>  <b>Current Service URL: <a href="http://habrastats.comyr.com/">habrastats.comyr.com</a></b> <br><br><img src="https://habrastorage.org/storage2/b2f/d06/fe6/b2fd06fe6b658be2b18d1074f500710d.png"><br><a name="habracut"></a><br>  The first "version" displayed the top comments from the last N posts, was written in LINQPad in two hours and occupied one screen ( <a href="http://pastebin.com/DcAwTna3">pastebin</a> ).  It became clear that ‚Äúon request‚Äù it is unrealistic to generate even for posts in the last 24 hours (download speeds of 1-2 posts per second), which means that it is necessary to make a periodic update.  From here came the idea to turn the service on a home machine (always on) and upload static results to a free hosting. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Briefly about implementation </h4><br>  Code: <a href="http://code.google.com/p/habra-stats/">code.google.com/p/habra-stats</a> <br>  - Windows Service on C # (4.5, VS2012 - new features are not used, you can build under 4.0) <br>  - Parsing Regexp (and yes, I know: <a href="http://stackoverflow.com/questions/1732348/regex-match-open-tags-except-xhtml-self-contained-tags/1732454">You can't parse HTML with regex</a> , but it will do here) <br>  - MS SQL Express + Entity Framework (well, very convenient ORM) <br>  - XSLT to generate HTML (layout and css taken from Habr, forgive me again the administration) <br><br>  Once every two hours, the service wakes up, parses the <a href="http://habrahabr.ru/posts/collective/new">habrahabr.ru/posts/collective/new</a> page and gets the Id of the newest post, then loads posts in reverse order until the publication date reaches the threshold (older than 3 days).  Post parsytsya and put in the database. <br>  Previously all existing posts were loaded into the database (it took two days). <br>  Then, ‚Äúreports‚Äù are generated from the database, such as ‚Äúbest for a day‚Äù, ‚Äúworst for a month with a picture‚Äù, etc.  The data for the report is simply a collection of ‚ÄúComment‚Äù objects that are serialized and transformed by XSLT.  The results are uploaded via FTP to the hosting. <br><br>  For generating reports and navigating between them there is a small trick: each of the filtering methods (BackDown, Week, Best, Worst, etc.) is marked with the attribute: <br><pre><code class="hljs json">[CommentReport(Category = <span class="hljs-string"><span class="hljs-string">""</span></span> , Name = <span class="hljs-string"><span class="hljs-string">" "</span></span> , CategoryOrder = <span class="hljs-number"><span class="hljs-number">0</span></span>)]</code> </pre> <br>  Through Reflection we get all the combinations of such methods by categories, get data from the database and generate the navigation.  Thus, to add one more ‚Äúreport‚Äù (for example, ‚Äúin three days‚Äù), it is enough to add a method with an attribute.  Glory to the LINQ and Entity Framework <s>robots</s> . <br><br><h4>  Few of the problems and solutions </h4><br>  Initially I thought to do without the database and do everything as simple as possible: store raw HTML on disk, load it into memory and process it there.  But the scale of the disaster was underestimated: 150 thousand posts in HTML occupied more than 10 gigabytes.  Even on an SSD, loading and parsing times is unacceptable. <br><br>  Then I tried SQL Compact Edition (in-process database, supports the entity framework).  Rested in the 4GB limit on the size of the database file.  At that time there was only one Comments table with duplicate (denormalized) data.  After the transition to SQL Express, I partially removed duplication, adding the Posts table, and deleted comments without votes (of which there were about 30%).  As a result, the size of the base is now about 2GB. <br><br>  In the process of parsing I learned that recklessly used RegexOptions.IgnoreCase reduces performance by several times. <br><br><h4>  Some statistics </h4><br>  At the time of writing this article in the database: <br>  <b>90619</b> posts <br>  <b>18</b> comments on the publication on average (no comments in the database without votes) <br>  <b>15</b> of them with a positive rating <br><br>  <b>1676593</b> comments total <br>  <b>721</b> comments per day <br><br>  <b>Average number of comments by day of the week</b> <br><img src="https://habrastorage.org/storage2/833/4bf/b13/8334bfb1348ef038ee907fe1c78eacf5.png"><br><br>  <b>Comments per week: time dynamics</b> <br><img src="https://habrastorage.org/storage2/5fc/797/1ec/5fc7971ec541c0a7a85399a911dc278e.png"><br><br><h4>  Finally, links! </h4><br>  Site: <br>  <b><a href="http://habrastats.comyr.com/">http://habrastats.comyr.com/</a></b> <br><br>  Code again: <a href="http://code.google.com/p/habra-stats/">code.google.com/p/habra-stats</a> <br><br><h4>  In the plans </h4><br>  RSS with the best for the previous day <br><br>  <b>PS</b> Offer more interesting requests <br><br>  <b>PPS</b> famous comment on the famous topic about pornolab is not displayed because the author of the publication is blocked. <br>  Posted by <a href="https://habrahabr.ru/users/nforce/" class="user_link">nForce</a> , you can see the comment here: <a href="http://habrahabr.ru/users/nforce/comments/page2/">habrahabr.ru/users/nforce/comments/page2</a> </div><p>Source: <a href="https://habr.com/ru/post/155541/">https://habr.com/ru/post/155541/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../155527/index.html">Canonical tries to transfer Ubuntu Linux to tablet PCs</a></li>
<li><a href="../155529/index.html">Six charging stations for Tesla Model S built in California</a></li>
<li><a href="../155531/index.html">How to make a silent computer</a></li>
<li><a href="../155533/index.html">Practical application of the Vodyanova bonus system in the countryside</a></li>
<li><a href="../155535/index.html">Unusual design of the robot MorpHex</a></li>
<li><a href="../155545/index.html">Active Record Pattern</a></li>
<li><a href="../155547/index.html">Graphic format JNG - what is useful, how it works, what to convert, view and download</a></li>
<li><a href="../155551/index.html">Correct social share buttons</a></li>
<li><a href="../155553/index.html">TNW: October 29, Google will show the 10-inch tablet Nexus "Manta" and the 3G version of the Nexus 7</a></li>
<li><a href="../155555/index.html">Transfer site (s) without downtime and data loss between dedicated servers</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>