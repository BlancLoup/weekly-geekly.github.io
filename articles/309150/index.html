<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Constants do not change: a small excursion into the depths of dotNet</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Greetings. I recently stumbled upon Comrade Dywar 's article “Interesting Notes on C # and CLR” and became interested in paragraph 13: 

 “The constan...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">🔎</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">📜</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">⬆️</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">⬇️</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Constants do not change: a small excursion into the depths of dotNet</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/c9d/b0b/d1b/c9db0bd1b6374cd1b14a449f14b02086.jpg" alt="image" align="left">  Greetings.  I recently stumbled upon Comrade <a href="https://habrahabr.ru/users/dywar/" class="user_link">Dywar</a> <a href="https://habrahabr.ru/post/256819/">'s</a> article <a href="https://habrahabr.ru/post/256819/">“Interesting Notes on C # and CLR”</a> and became interested in paragraph 13: <br><br>  “The <i>constants are placed in the assembly metadata, so if there were changes, you need to recompile all the assemblies that use it.</i>  <i>Since</i>  <i>DLL with a constant may not even load.</i>  " <br><br>  Come on, I thought, and it was useful to set up experiments.  Created a TestConstants project, in it a class, 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Master</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Const = <span class="hljs-string"><span class="hljs-string">"Hello world"</span></span>; }</code> </pre> <br>  then the TestConstantsSlave project, <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Main</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { Console.WriteLine(Master.Const); Console.ReadKey(); }</code> </pre><br>  Replaced the constant with “Hello habr”, rebuilt the main project, launched F5 ... <br><a name="habracut"></a><br>  “Hello habr” flashed on the console.  Apparently, the studio also rebuilt the Slave project.  In principle, it was possible to calm down on this, but I wanted to experiment a little. <br><br>  First of all, I replaced the constant with “Greetings, sir von Neumann”, rebooted the main project, and launched Slave through the conductor → TestConstantsSlave.exe.  “Hello habr” shone on the console, forgive me the great Neumann.  I copied a fresh library to Slave - still “Hello habr”.  Removed the TestConstants library - again “Hello habr”.  <s>Habr was silent.</s> <br><br>  Is it really a constant copied to metadata?  Open ildasm.  In the Slave manifest, everything is standard: version, headers, tokens.  There is no constant (which is reasonable).  Ran through classes - no metadata was explicitly detected. <br><br>  But in the Slave code there is “Hello habr” explicitly. <br><br><img src="https://habrastorage.org/files/0e2/686/3b1/0e26863b151f49d3873f9ae437b08e0a.jpg" alt="ildasm"><br><br>  See the description of the ldstr instruction on <a href="https://msdn.microsoft.com/en-us/library/system.reflection.emit.opcodes.ldstr(v%3Dvs.110).aspx">msdn</a> .  “Pushes a string reference for a metadata”.  Apparently, the metadata is hidden for ildasm.  Just in case, I checked dotPeek - the result is similar (but it is clear that the Slave project does not refer to TestConstants). <br><br>  Checking a constant of another type: using an Int32 constant gives another il code: ldc.i4.5.  Here we have a simple push into the stack (which is again reasonable - the lines are long, it makes sense to cache them, but the overhead of pulling the inta out of the cache outweighs the exhaust).  Apparently, in the original article and msdn, metadata means part of the string interning mechanism ( <a href="https://habrahabr.ru/post/172627/">tuna</a> , <a href="https://habrahabr.ru/post/172627/">tynz</a> ), which, by the way, explains the lack of metadata in ildasm - a pool of lines is generated for the process. <br><br><h3>  So, what is next? </h3><br>  Nothing wrong.  The studio is a correct build, and the constants do not change every day.  On the other hand, I have already worked with the project, where the SDK and the utilities using it were in different solutions, and updating the SDK could generate a “constant bug”. </div><p>Source: <a href="https://habr.com/ru/post/309150/">https://habr.com/ru/post/309150/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../309132/index.html">Once again about the benefits of backups or the story of my failure</a></li>
<li><a href="../309136/index.html">ADM interface - what is “Tetrad”</a></li>
<li><a href="../309138/index.html">Learning OpenGL ES2 for Android Lesson №4. Textures</a></li>
<li><a href="../309142/index.html">Private unstructured types and type reuse</a></li>
<li><a href="../309144/index.html">About alignment of memory on ARM processors on a simple example</a></li>
<li><a href="../309152/index.html">Review of computer vision problems in medicine</a></li>
<li><a href="../309154/index.html">Some examples of the practical use of RxJava</a></li>
<li><a href="../309156/index.html">Testing IVR on Asterisk with ... Asterisk</a></li>
<li><a href="../309158/index.html">Survey: Programmer and Salary</a></li>
<li><a href="../309160/index.html">Russian Post for Dummies</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>