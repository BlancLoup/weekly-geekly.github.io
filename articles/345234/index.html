<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>DIY. Spying on visitors</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Task 


 Sometimes owners of services, project managers and SEO-specialists have a desire to peek at the user, how he presses the buttons and what he ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>DIY. Spying on visitors</h1><div class="post__text post__text-html js-mediator-article"><h1 id="zadacha">  Task </h1><br><p>  Sometimes owners of services, project managers and SEO-specialists have a desire to peek at the user, how he presses the buttons and what he splits his forehead.  It happens that such a desire to pry allows you to identify interface problems, which may indirectly affect the efficiency of the service, and even profit. </p><br><p>  I know several ways to solve this problem: </p><br><ol><li>  recruit a group of test subjects for usability testing; </li><li>  integrate a third-party service to the site that records user actions; </li><li>  write your decision. </li></ol><a name="habracut"></a><br><h1 id="gruppa-testirovaniya">  Testing group </h1><br><p>  Quite an option that requires, nevertheless, the solution of a number of issues: </p><br><ol><li>  It is necessary to carefully select the composition of the testing team so that it includes as many users as possible from different age groups (from the target audience, of course), different qualifications and experience of use.  At the same time, the size of the team also plays a role - a larger number will allow to get more data for analysis, but it will also be costly; </li><li>  need to equip a place for research.  At a minimum, office space, computing, audio and video; </li><li>  it is necessary to distract employees from the main process or to attract additional ones to organize the process and analyze the results. </li></ol><br><p>  Even the successful solution of the above questions does not guarantee a more or less reliable result, and the costs of organizing the process are already frightening.  In addition, there is a risk of loss of boundary cases, which are not so rare when used in combat. </p><br><p>  Perhaps not this time. </p><br><h1 id="storonniy-servis-analitiki">  Third-party analytics service </h1><br><p>  Most services offer heat maps of clicks and scrolling states, which allows you to more or less reliably determine what users saw on the site and what they noticed. </p><br><p>  Some offer analysis of forms, key logging, and tracking of selection and copying, which also makes it possible to track complex human-machine interaction schemes. </p><br><p>  Offhand found a couple of services: </p><br><ol><li>  WebVisor from Yandex; </li><li>  HotJar. </li></ol><br><p>  For lack of an economically sound goal, take WebVisor.  The service promised to remember and lose for us the entire user session, i.e.  repeat user behavior on the resource from start to finish.  Primary integration is trivial, just add the code on the page. </p><br><p>  <strong>Immediately it should be noted that requests that are deliberately destructive for the session state (that is, all but GET) are ignored.</strong> </p><br><p>  There are two versions.  The principle of their work is about the same.  First, we get the user authentication parameters and transfer to the server, which downloads the current page and saves it.  On the client side, it collects user actions: mouse movements, clicks, data entry, and so on.  The embedded code transmits actions to a server with a timestamp (delta from the beginning or date / time, did not figure out). </p><br><p>  Later, you can go to the user sessions page in the Yandex.Metric service and play user actions.  It seems all is well, but there are a number of problems. </p><br><p>  Version one: </p><br><ol><li>  incorrectly transmits click events to a complex, modifiable interface.  In the particular case, clicking on the cross icon of the modal window does not close this modal window; </li><li>  any actions leading to AJAX requests, with the exception of GET, break off and the interface behavior is played incorrectly, which again does not give an understanding of what the user saw; </li><li>  arbitrarily loses user actions. </li></ol><br><p>  The second version is in beta testing and contains the same flaws, plus sometimes, like a decent beta, it does not work from the word ‚Äúat all‚Äù. </p><br><p>  Hands did not reach HotJar.  If you have experience of integration with SPA - share, please, but I have suspicions that there will be the same suffering. </p><br><h1 id="popytka-sobrat-svoe-reshenie">  Attempt to collect your decision </h1><br><p>  And here we smoothly approach the moment ‚Äúa, give, I will try!‚Äù. </p><br><p>  What you need to implement: </p><br><ol><li>  getting the initial state of the page.  Do not lose the user's context (for different users the page may differ significantly); </li><li>  tracking the size of the window object; </li><li>  tracking the scrolling of page elements, including the document itself; </li><li>  registration of user activity.  Follow the movement of the mouse, clicks, data entry in the form fields; </li><li>  compact exchange protocol with the server. </li></ol><br><p>  Collecting analytics should be considered for two options for the quality of the network connection - for a low-speed unstable channel and for more favorable cases. </p><br><h2 id="nachalnoe-sostoyanie">  Initial state </h2><br><p>  The initial state can be obtained in two ways: </p><br><ol><li>  take HTML and styles on the window.load event.  This will create a load on the network, so if the quality of the network is poor, this option will have to be abandoned; </li><li>  request a page on the server side.  You must pass the user context.  You can implicitly steal a cookie or ask you to explicitly pass the URL and authorization parameters at the time of library initialization. </li></ol><br><p>  In both cases, you need to disable all scripts from the saved page, since we will do the interface response to user actions yourself by recording user actions. </p><br><p>  The question remains with styles and static data.  In general, they can be left as they are, but special effects are possible if the statics changes at the time between receiving the initial state and when viewing the recorded activity. </p><br><p>  At the time of loading the page save the current size of the window object. </p><br><h2 id="otslezhivanie-sobytiy">  Event Tracking </h2><br><p>  You need to keep track of all DOM subtree events regardless of the use of stopImmediatePropagation () / stopPropagation ().  For this we will use addEventListener () with the parameter useCapture = true. </p><br><p>  To track changes in the document structure and attributes, you can use the mechanism - MutationObserver.  DOM Node for registering handlers will be taken in the initialization parameters, by default - document. </p><br><p>  You also need to keep track of the scrolling position of the document.scroll window and the resizing of the window.resize window. </p><br><p>  To identify the event object, we will build a CSS selector. </p><br><h2 id="protokol-obmena">  Exchange protocol </h2><br><p>  For lack of practical data, we will use the JSON format for exchange.  To fight with ad blockers and any other things, you should use GET requests and return a small image, say, GIF format.  For example, the URL / path / to / api / [JSON string] .gif. </p><br><p>  It is worth remembering that the URL is not rubber, it has a limit of 2000 characters.  It is a rather small value, taking into account the sending of information about the change in the document structure, so you should immediately attend to data compression, for example, using the GZIP algorithm, a JavaScript implementation of which exists.  To transfer compressed data, you will have to additionally encode them in BASE64. You also need to provide for transmission in parts, but to test the concept it will be unnecessary at this stage. </p><br><h2 id="prakticheskiy-rezultat">  Bottom line </h2><br><p>  The source code for the client library prototype is <a href="https://github.com/relabsoss/underhand">here</a> . </p><br><p>  For experiments the real project was chosen: </p><br><ol><li>  adaptive layout (HTML5, CSS3); </li><li>  Elm.  Widgets (registration / authorization forms, multi-step forms for creating custom content) and user profile (SPA); </li><li>  built-in google maps. </li></ol><br><p>  Integration of problems did not cause, the performance of the browser is not visually observed. </p><br><p>  The generated traffic was not as great as expected.  Taking into account the limitations, save once every 10 seconds or, according to accumulation, 100 events, the data did not exceed 4 kilobytes.  The compression ratio floats heavily from a few to dozens, but for fairly large volumes (tens of kilobytes) lies around tens, which is logical, since  data is text and there are many duplicate substrings. </p><br><h1 id="v-suhom-ostatke">  In the dry residue </h1><br><p>  The prototype showed its viability.  To make it completely clear, you need to implement the player and the server side, where a number of problems are foreseen: </p><br><ol><li>  getting an initial state, fighting duplicate data.  You may need to cache related data.  There is a suspicion that you will have to use a headless browser for the initial playback of user activity in order to determine static elements; </li><li>  cross browser support player.  Zoo and interversion variety has not been canceled. </li></ol><br><p>  You should not forget about the features when changing attributes.  For example, the style attribute cannot simply be taken through a collection of attributes (Element.attributes); you will have to use the HTMLElement.style.cssText property.  The number of such nuances at the moment can not be assessed. </p><br><p>  If you use a headless browser with pre-playing user activity, you should consider recording video.  In this case, there is no need for a player, but the required amount of computing resources and the size of the storage of the resulting data increase, which may not always be rational. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/345234/">https://habr.com/ru/post/345234/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../345224/index.html">Live broadcast of the Waves Platform in Digital October</a></li>
<li><a href="../345226/index.html">10 RecSys materials on recommendation systems that everyone should read</a></li>
<li><a href="../345228/index.html">How we raiffeisen.ru redesigned</a></li>
<li><a href="../345230/index.html">Who needs these CRM systems?</a></li>
<li><a href="../345232/index.html">The history of the Nigerian developer: from programming on the button phone to work in the startup MIT</a></li>
<li><a href="../345236/index.html">React Component Testing</a></li>
<li><a href="../345238/index.html">10 of the most important English words of 2017 according to Merriam-Webster</a></li>
<li><a href="../345240/index.html">Servlet 4.0: We do more faster. Server push</a></li>
<li><a href="../345242/index.html">How a non-refundable cost error can ruin a game developer</a></li>
<li><a href="../345244/index.html">The backend of the World in Conflict game server is publicly available.</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>