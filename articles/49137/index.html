<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We use 2+ providers (first part)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Here I want to talk about setting up a gateway on Linux, for using 2 (or more) Internet providers. 
 To configure, we will use the capabilities of ipt...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We use 2+ providers (first part)</h1><div class="post__text post__text-html js-mediator-article">  Here I want to talk about setting up a gateway on Linux, for using 2 (or more) Internet providers. <br>  To configure, we will use the capabilities of iptables and the ip utilities from the package, which is usually called iproute2.  And to solve this problem, we will route packets based on ‚Äúpolicy routing‚Äù (ie, policy-based routing), and not ‚Äúdestination routing‚Äù (routing based on the recipient's address). <br><a name="habracut"></a><br>  So let's get started.  First, let's define the variables: <br><blockquote>  #! / bin / bash <br><br>  IF1 = eth1 <br>  IF2 = eth2 <br></blockquote><br>  IF are network interfaces that look to the Internet through our providers. <br><blockquote>  IP1 = 10.10.10.10 <br>  IP2 = 20.20.20.20 <br></blockquote><br>  IPs are our external IP addresses that providers have given us <br><blockquote>  P1 = 10.10.10.1 <br>  P2 = 20.20.20.1 <br></blockquote><br>  P is the default gateway of our providers. <br>  Policy routing allows you to perform routing based on the source address, so we will list the servers that will participate: <br><blockquote>  SRV11 = 192.168.0.11 <br>  SRV12 = 192.168.0.12 <br></blockquote><br>  Here, SRV11 and SRV12 are two IPs of the same server (this is important!), This allows one server to handle incoming connections from two providers.  Of course, there are other options to realize this opportunity, but I will use the IPs, it seems to me to begin with, it will be easier. <br>  And now the most interesting thing is to write a rule for routing. <br>  The first thing we need to do is add our own routing tables, for this you need to edit the file / etc / iproute2 / rt_tables, for example: <br><blockquote>  #echo "101 T1" &gt;&gt; / etc / iproute2 / rt_tables <br>  #echo "102 T2" &gt;&gt; / etc / iproute2 / rt_tables <br></blockquote><br>  Fill in the first table: <br><blockquote>  ip route add $ P1_NET dev $ IF1 src $ IP1 table T1 <br>  ip route add default via $ P1 table T1 <br></blockquote><br>  Ie, we add routes in which we indicate that we can get into the subnet of the first provider through the first interface.  In the second line, we add the default gateway. <br>  The same in the second: <br><blockquote>  ip route add $ P2_NET dev $ IF2 src $ IP2 table T2 <br>  ip route add default via $ P2 table T2 <br></blockquote><br>  Then we will deal with the main table, which is called "main".  We see it when we type ip route: <br><blockquote>  ip route add $ P1_NET dev $ IF1 src $ IP1 <br>  ip route add $ P2_NET dev $ IF2 src $ IP2 <br>  ip route add default via $ P1 metric 10 <br></blockquote><br>  The first two lines are similar to the previous entries, only the "table main" is omitted.  The third line sets the default route with the metric. <br>  On this we figured out the routing, to see what we have in the routing table, you can run the command ‚Äúip route show table &lt;table name&gt;‚Äù.  Now let's get down to the rules.  Just according to the rules, it will be decided which packet will be routed according to which table. <br><blockquote>  ip rule add from $ IP1 table T1 <br>  ip rule add from $ IP2 table T2 <br></blockquote><br>  Here we indicated that if the source address is equal to the first external address, then routing is performed on table T1.  Similarly, the second entry. <br>  And finally the most interesting: <br><blockquote>  ip rule add from $ srv11 fwmark 10 table T1 <br>  ip rule add from $ srv12 fwmark 20 table T2 <br></blockquote>  Using iptables we can label the packets of interest to us and route them based on these labels.  Actually here we added two rules: for packages with a label 10, use table T1, for packages with a label 20 - T2.  Now it may not be very clear why this may be necessary, but everything will become clear from the iptables rules.  To view the rules, we perform ‚Äúip rule‚Äù, when routing, they are checked in order. <br>  Well, half the work is done, it remains to write the rules for iptables, we'll talk about this in the second part. <br><br>  <a href="http://habrahabr.ru/blogs/linux/55132/">The second part</a> . <br>  original article on my blog <a href="http://hexbot.blogspot.com/2009/03/2.html">Use 2+ provider (first part)</a> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      ps Written to understand yourself and tell others. </div><p>Source: <a href="https://habr.com/ru/post/49137/">https://habr.com/ru/post/49137/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../49129/index.html">GNOME: Turning off the dull effect of minimizing windows</a></li>
<li><a href="../49130/index.html">Twitter on C #</a></li>
<li><a href="../49131/index.html">Taxes on the Internet?</a></li>
<li><a href="../49133/index.html">Windows 7 - just no words!</a></li>
<li><a href="../49136/index.html">An interesting problem in .htaccess or special characters, mod_rewrite and C ++ tag.</a></li>
<li><a href="../49139/index.html">New Year's UX Russia Community Online Seminar: ‚ÄúFlow State: An Introduction‚Äù</a></li>
<li><a href="../49142/index.html">Submit and Archive</a></li>
<li><a href="../49144/index.html">Steve Jobs leaves Apple before the end of June.</a></li>
<li><a href="../49147/index.html">Who is the main commercial IT project? "All are important" leave until next time.</a></li>
<li><a href="../49149/index.html">Let's beat Ruby together! Drop eight</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>