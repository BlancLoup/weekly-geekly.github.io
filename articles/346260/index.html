<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Calculations on the video card, manual, easy level</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This guide explains the work of a simple program that performs calculations on the GPU. Here is a link to the Unity project of this program: 

 link t...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Calculations on the video card, manual, easy level</h1><div class="post__text post__text-html js-mediator-article">  This guide explains the work of a simple program that performs calculations on the GPU.  Here is a link to the Unity project of this program: <br><br>  <a href="https://drive.google.com/open%3Fid%3D1NlaEh0NiRRtmunTBDyPGTNlgtsLACAzq">link to the project file .unitypackage</a> <br><br>  She draws a Mandelbrot fractal. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      I will not explain each line of code, I will only indicate the necessary actions for the implementation of GPU calculations.  Therefore, it is best to open the program code in Unity and there to see how the lines of code explained by me are used. <br><br>  The shader that draws the fractal is written in the HLSL language.  Below is the text.  I briefly commented on meaningful lines, and detailed explanations will be below. <br><a name="habracut"></a><br><pre><code class="css hljs">//   <span class="hljs-selector-tag"><span class="hljs-selector-tag">GPU</span></span>       : <span class="hljs-selector-tag"><span class="hljs-selector-tag">RWTexture2D</span></span>&lt;<span class="hljs-selector-tag"><span class="hljs-selector-tag">float4</span></span>&gt; <span class="hljs-selector-tag"><span class="hljs-selector-tag">textureOut</span></span>; //  ,       <span class="hljs-selector-tag"><span class="hljs-selector-tag">RWStructuredBuffer</span></span>&lt;<span class="hljs-selector-tag"><span class="hljs-selector-tag">double</span></span>&gt; <span class="hljs-selector-tag"><span class="hljs-selector-tag">rect</span></span>; //      ,    <span class="hljs-selector-tag"><span class="hljs-selector-tag">RWStructuredBuffer</span></span>&lt;<span class="hljs-selector-tag"><span class="hljs-selector-tag">float4</span></span>&gt; <span class="hljs-selector-tag"><span class="hljs-selector-tag">colors</span></span>; //    ,      <span class="hljs-selector-tag"><span class="hljs-selector-tag">CPU</span></span>     <span class="hljs-selector-id"><span class="hljs-selector-id">#pragma</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">kernel</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">pixelCalc</span></span> //    ,          <span class="hljs-selector-tag"><span class="hljs-selector-tag">CPU</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[numthreads(32,32,1)]</span></span> //     ,      <span class="hljs-selector-tag"><span class="hljs-selector-tag">void</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">pixelCalc</span></span> (<span class="hljs-selector-tag"><span class="hljs-selector-tag">uint3</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">id</span></span> : <span class="hljs-selector-tag"><span class="hljs-selector-tag">SV_DispatchThreadID</span></span>){ //     .  id   ,      float k = 0.0009765625; //       10241024     22   double dx, dy; double p, q; double x, y, xnew, ynew, d = 0; //    ,           uint itn = 0; dx = rect[2] - rect[0]; dy = rect[3] - rect[1]; p = rect[0] + ((int)id.x) * k * dx; q = rect[1] + ((int)id.y) * k * dy; x = p; y = q; while (itn &lt; 255 &amp;&amp; d &lt; 4){ //   :      ,      2x2 xnew = x * x - y * y + p; ynew = 2 * x * y + q; x = xnew; y = ynew; d = x * x + y * y; itn++; } <span class="hljs-selector-tag"><span class="hljs-selector-tag">textureOut</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[id.xy]</span></span> = <span class="hljs-selector-tag"><span class="hljs-selector-tag">colors</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[itn]</span></span>; //      :    ,    <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span>   }</code> </pre> <br>  The attentive reader will say: the author, explain!  The size of the texture is 1024x1024, and the number of threads is 32x32.  How does the id.xy parameter address all pixels of a texture? <br>  Attentive, but inexperienced in matters of computing on the GPU reader will interrupt: let me!  And where does it mean that the number of threads is 32x32?  And how to understand "id.xy"? <br><br>  To the second, I will answer this way: the directive [numthreads (32,32,1)] says that we have 32x32x1 threads.  In this case, the streams form a three-dimensional grid, because the id parameter takes values ‚Äã‚Äãin the form of coordinates of the space 32x32x1.  The range of values ‚Äã‚Äãid.x [0, 31], the range of values ‚Äã‚Äãid.y [0, 31], and id.z is 0. And id.xy is a short uint2 record (id.x, id.y) <br><br>  We would have 32x32 threads (I‚Äôm already responding to the first attentive reader) if we called this kernel from the CPU side with the command <br><br><pre> <code class="css hljs"><span class="hljs-selector-tag"><span class="hljs-selector-tag">ComputeShader</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Dispatch</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">kernelIndex</span></span>, 1, 1, 1)</code> </pre> <br>  See these three units?  This is the same as the digits in the [numthreads (32,32,1)] directive, they are multiplied with each other. <br><br>  If we started the shader with the following parameters: <br><br><pre> <code class="css hljs"><span class="hljs-selector-tag"><span class="hljs-selector-tag">ComputeShader</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Dispatch</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">kernelIndex</span></span>, 2, 4, 1)</code> </pre> <br>  We would have 32 * 2 = 64 along the x axis, 32 * 4 = 128 along the y axis, that is, in total - 64x128 streams.  Parameters are simply multiplied along each axis. <br><br>  But in our case, the kernel is launched like this: <br><br><pre> <code class="css hljs"><span class="hljs-selector-tag"><span class="hljs-selector-tag">ComputeShader</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Dispatch</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">kernelIndex</span></span>, 32, 32, 1)</code> </pre> <br>  What gives us in the end 1024x1024 flow.  And it means that id.xy index will take values ‚Äã‚Äãcovering the whole texture space of 1024x1024 <br><br>  This is done for convenience.  Data is stored in arrays, each stream performs the same operation on a data unit, and we create the number of threads equal to the number of data units, so that the flow index addresses its data unit.  Very comfortably. <br><br>  That's all you need to know about the shader code of our fractalizing program. <br><br>  Now let's look at what we did on the CPU side to run the shader code. <br><br>  We declare variables: shader, buffer and texture <br><br><pre> <code class="css hljs"><span class="hljs-selector-tag"><span class="hljs-selector-tag">ComputeShader</span></span> _<span class="hljs-selector-tag"><span class="hljs-selector-tag">shader</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">RenderTexture</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">outputTexture</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ComputeBuffer</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">colorsBuffer</span></span></code> </pre> <br>  We initialize the texture without forgetting to enable enableRandomWrite <br><br><pre> <code class="css hljs"><span class="hljs-selector-tag"><span class="hljs-selector-tag">outputTexture</span></span> = <span class="hljs-selector-tag"><span class="hljs-selector-tag">new</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">RenderTexture</span></span>(1024, 1024, 32); <span class="hljs-selector-tag"><span class="hljs-selector-tag">outputTexture</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.enableRandomWrite</span></span> = <span class="hljs-selector-tag"><span class="hljs-selector-tag">true</span></span>; <span class="hljs-selector-tag"><span class="hljs-selector-tag">outputTexture</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Create</span></span>();</code> </pre> <br>  Initialize the buffer by specifying the number of objects and the size of the object.  And write the data of the pre-filled array of colors in the video memory <br><br><pre> <code class="css hljs"><span class="hljs-selector-tag"><span class="hljs-selector-tag">colorsBuffer</span></span> = <span class="hljs-selector-tag"><span class="hljs-selector-tag">new</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ComputeBuffer</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">colorArray</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Length</span></span>, 4 * 4); <span class="hljs-selector-tag"><span class="hljs-selector-tag">colorsBuffer</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.SetData</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">colorArray</span></span>);</code> </pre> <br>  Initialize the shader and set the texture and buffer for the kernel so that it can write data to them <br><br><pre> <code class="css hljs">_<span class="hljs-selector-tag"><span class="hljs-selector-tag">shader</span></span> = <span class="hljs-selector-tag"><span class="hljs-selector-tag">Resources</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Load</span></span>&lt;<span class="hljs-selector-tag"><span class="hljs-selector-tag">ComputeShader</span></span>&gt;("<span class="hljs-selector-tag"><span class="hljs-selector-tag">csFractal</span></span>"); <span class="hljs-selector-tag"><span class="hljs-selector-tag">kiCalc</span></span> = _<span class="hljs-selector-tag"><span class="hljs-selector-tag">shader</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.FindKernel</span></span>("<span class="hljs-selector-tag"><span class="hljs-selector-tag">pixelCalc</span></span>"); _<span class="hljs-selector-tag"><span class="hljs-selector-tag">shader</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.SetBuffer</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">kiCalc</span></span>, "<span class="hljs-selector-tag"><span class="hljs-selector-tag">colors</span></span>", <span class="hljs-selector-tag"><span class="hljs-selector-tag">colorsBuffer</span></span>); _<span class="hljs-selector-tag"><span class="hljs-selector-tag">shader</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.SetTexture</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">kiCalc</span></span>, "<span class="hljs-selector-tag"><span class="hljs-selector-tag">textureOut</span></span>", <span class="hljs-selector-tag"><span class="hljs-selector-tag">outputTexture</span></span>);</code> </pre> <br>  This is the preparation of the data.  Now it only remains to run the shader kernel <br><br><pre> <code class="css hljs">_<span class="hljs-selector-tag"><span class="hljs-selector-tag">shader</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Dispatch</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">kiCalc</span></span>, 32, 32, 1);</code> </pre> <br>  After executing this command, the texture is filled with colors that we immediately see, because the RenderTexture texture is used as the mainTexture for the Image component that the camera is looking at. </div><p>Source: <a href="https://habr.com/ru/post/346260/">https://habr.com/ru/post/346260/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../346250/index.html">Troubleshooting the Xbox 360 processor architecture</a></li>
<li><a href="../346252/index.html">Cheat Sheet by OTP (Erlang)</a></li>
<li><a href="../346254/index.html">Preparing a working environment for the Erlang project</a></li>
<li><a href="../346256/index.html">Tanchiki in the console, article three: "Server and client"</a></li>
<li><a href="../346258/index.html">Writing a Python clicker bot for Lineage 2</a></li>
<li><a href="../346262/index.html">Apache Ignite vs Oracle DBMS</a></li>
<li><a href="../346264/index.html">Technical Debt Management</a></li>
<li><a href="../346266/index.html">The effect of group polarization and its mathematical modeling</a></li>
<li><a href="../346268/index.html">Physical simulation on the GPU using the compute shader in the Unity3D environment</a></li>
<li><a href="../346270/index.html">We work with smart cards using Python (part 1)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>