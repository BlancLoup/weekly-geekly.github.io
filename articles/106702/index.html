<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We write the driver under Linux</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I want to admit at once that I kind of deceived you, because the driver, according to Wikipedia, is a computer program with which another program (usu...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We write the driver under Linux</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage/habraeffect/65/68/6568edc0a07ab2cc49a2d6fd0d985a9c.jpg" alt="image"><br><br>  I want to admit at once that I kind of deceived you, because the driver, according to <a href="http://ru.wikipedia.org/wiki/%25D0%2594%25D1%2580%25D0%25B0%25D0%25B9%25D0%25B2%25D0%25B5%25D1%2580">Wikipedia,</a> is <i>a computer program with which another program (usually the operating system) gets access to the hardware of a device</i> .  And today we will create some kind of a blank for the driver, since  in fact, we will not work with any hardware.  You can add this useful functionality yourself if you wish. <br><br>  What we are creating today will be more correct to call <b>LKM</b> (Linux Kernel Module or the kernel load module).  It is worth saying that the driver is one of the varieties of LKM. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      We will write the module under the kernel 2.6.  LKM for 2.6 is different from 2.4.  I will not dwell on the differences, because it does not fall within the framework of the post. <br><br>  We will create a character device / dev / test, which will be processed by our module.  I want to make a reservation right away that placing a character device is not necessarily in the / dev directory, it‚Äôs just part of an ‚Äúancient magic ritual.‚Äù <br><br><a name="habracut"></a><br><h4>  A bit of theory </h4><br>  In short, LKM is an object that contains code to extend the capabilities of an already running Linux kernel.  Those.  it works in kernel space, not user space.  So you should not experiment on a working server.  In case of an error that has crept into the module, get a kernel panic.  We assume that I warned you. <br><br>  A kernel module must have at least 2 functions: an initialization function and an exit function.  The first is called when the module is loaded into the kernel space, and the second, respectively, when it is unloaded.  These functions are set using macros: <b>module_init</b> and <b>module_exit</b> . <br><br>  It is worth saying a few words about the <b>printk ()</b> function.  The main purpose of this function is to implement the mechanism for registering events and warnings.  In other words, this function is for recording some information in the kernel log. <br><br>  Because  the driver works in the kernel space, it is delimited from the user's address space.  And we would like to be able to return a certain result.  To do this, use the <b>put_user ()</b> function.  It is exactly what is involved in transferring data from kernel space to user space. <br><br>  I also want to say a few words about character devices. <br><br>  Run the <code>ls -l /dev/sda*</code> .  You will see something like: <br> <code>brw-rw---- 1 root disk 8, 0 2010-10-11 10:23 /dev/sda <br> brw-rw---- 1 root disk 8, 1 2010-10-11 10:23 /dev/sda1 <br> brw-rw---- 1 root disk 8, 2 2010-10-11 10:23 /dev/sda2 <br> brw-rw---- 1 root disk 8, 5 2010-10-11 10:23 /dev/sda5 <br></code> <br><br>  Between the word "disk" and the date there are two numbers separated by a comma.  The first number is called the highest number of the device.  The leading number indicates which driver is used to service this device.  Each driver has its own unique major number. <br><br>  Device files are created using <b>mknod commands</b> , for example: <code>mknod /dev/test c 12</code> .  With this command we will create the device / dev / test and specify the major number for it (12). <br><br>  I will not go deep into theory because  Anyone interested - he can read about it in more detail.  I will give a link at the end. <br><br><h4>  Before you start </h4><br><br>  You need to know a few "magic" commands: <br><ul><li>  insmod - add a module to the kernel </li><li>  rmmod - remove, respectively </li><li>  lsmod - list current modules </li><li>  modinfo - display information about the module </li></ul><br><br>  To compile the module, we need the headers of the current kernel. <br><br>  In debian / ubutnu, you can easily put them like this (for example, for 2.6.26-2-686): <br> <code>apt-get install linux-headers-2.6.26-2-686</code> <br>  Or build the package for your current kernel yourself: <code>fakeroot make-kpkg kernel_headers</code> <br><br><h4>  Source code </h4><br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">#include &lt;linux/kernel.h&gt; <font color="#008000">/*  printk()  .. */</font> <br> #include &lt;linux/module.h&gt; <font color="#008000">/*    ,    */</font> <br> #include &lt;linux/init.h&gt; <font color="#008000">/*   */</font> <br> #include &lt;linux/fs.h&gt; <br> #include &lt;asm/uaccess.h&gt; <font color="#008000">/* put_user */</font> <br> <br> <font color="#008000">//      ,       Modinfo</font> <br> MODULE_LICENSE( <font color="#A31515">"GPL"</font> ); <br> MODULE_AUTHOR( <font color="#A31515">"Alex Petrov &lt;petroff.alex@gmail.com&gt;"</font> ); <br> MODULE_DESCRIPTION( <font color="#A31515">"My nice module"</font> ); <br> MODULE_SUPPORTED_DEVICE( <font color="#A31515">"test"</font> ); <font color="#008000">/* /dev/testdevice */</font> <br> <br> <font color="#0000ff">#define</font> SUCCESS 0 <br> <font color="#0000ff">#define</font> DEVICE_NAME <font color="#A31515">"test"</font> <font color="#008000">/*    */</font> <br> <br> <font color="#008000">//    </font> <br> <font color="#0000ff">static</font> <font color="#0000ff">int</font> device_open( <font color="#0000ff">struct</font> inode *, <font color="#0000ff">struct</font> file * ); <br> <font color="#0000ff">static</font> <font color="#0000ff">int</font> device_release( <font color="#0000ff">struct</font> inode *, <font color="#0000ff">struct</font> file * ); <br> <font color="#0000ff">static</font> ssize_t device_read( <font color="#0000ff">struct</font> file *, <font color="#0000ff">char</font> *, size_t, loff_t * ); <br> <font color="#0000ff">static</font> ssize_t device_write( <font color="#0000ff">struct</font> file *, <font color="#0000ff">const</font> <font color="#0000ff">char</font> *, size_t, loff_t * ); <br> <br> <font color="#008000">//  ,   static,   .</font> <br> <font color="#0000ff">static</font> <font color="#0000ff">int</font> major_number; <font color="#008000">/*      */</font> <br> <font color="#0000ff">static</font> <font color="#0000ff">int</font> is_device_open = 0; <font color="#008000">/*    ? */</font> <br> <font color="#0000ff">static</font> <font color="#0000ff">char</font> text[ 5 ] = <font color="#A31515">"test\n"</font> ; <font color="#008000">/* ,          */</font> <br> <font color="#0000ff">static</font> <font color="#0000ff">char</font> * text_ptr = text; <font color="#008000">/*       */</font> <br> <br> <font color="#008000">//     </font> <br> <font color="#0000ff">static</font> <font color="#0000ff">struct</font> file_operations fops = <br> { <br> .read = device_read, <br> .write = device_write, <br> .open = device_open, <br> .release = device_release <br> }; <br> <br> <font color="#008000">//   .  .      main()</font> <br> <font color="#0000ff">static</font> <font color="#0000ff">int</font> __init test_init( <font color="#0000ff">void</font> ) <br> { <br> printk( KERN_ALERT <font color="#A31515">"TEST driver loaded!\n"</font> ); <br> <br> <font color="#008000">//       </font> <br> major_number = register_chrdev( 0, DEVICE_NAME, &amp;fops ); <br> <br> <font color="#0000ff">if</font> ( major_number &lt; 0 ) <br> { <br> printk( <font color="#A31515">"Registering the character device failed with %d\n"</font> , major_number ); <br> <font color="#0000ff">return</font> major_number; <br> } <br> <br> <font color="#008000">//      </font> <br> printk( <font color="#A31515">"Test module is loaded!\n"</font> ); <br> <br> printk( <font color="#A31515">"Please, create a dev file with 'mknod /dev/test c %d 0'.\n"</font> , major_number ); <br> <br> <font color="#0000ff">return</font> SUCCESS; <br> } <br> <br> <font color="#008000">//   </font> <br> <font color="#0000ff">static</font> <font color="#0000ff">void</font> __exit test_exit( <font color="#0000ff">void</font> ) <br> { <br> <font color="#008000">//  </font> <br> unregister_chrdev( major_number, DEVICE_NAME ); <br> <br> printk( KERN_ALERT <font color="#A31515">"Test module is unloaded!\n"</font> ); <br> } <br> <br> <font color="#008000">//      </font> <br> module_init( test_init ); <br> module_exit( test_exit ); <br> <br> <font color="#0000ff">static</font> <font color="#0000ff">int</font> device_open( <font color="#0000ff">struct</font> inode *inode, <font color="#0000ff">struct</font> file *file ) <br> { <br> text_ptr = text; <br> <br> <font color="#0000ff">if</font> ( is_device_open ) <br> <font color="#0000ff">return</font> -EBUSY; <br> <br> is_device_open++; <br> <br> <font color="#0000ff">return</font> SUCCESS; <br> } <br> <br> <font color="#0000ff">static</font> <font color="#0000ff">int</font> device_release( <font color="#0000ff">struct</font> inode *inode, <font color="#0000ff">struct</font> file *file ) <br> { <br> is_device_open--; <br> <font color="#0000ff">return</font> SUCCESS; <br> } <br> <br> <font color="#0000ff">static</font> ssize_t <br> <br> device_write( <font color="#0000ff">struct</font> file *filp, <font color="#0000ff">const</font> <font color="#0000ff">char</font> *buff, size_t len, loff_t * off ) <br> { <br> printk( <font color="#A31515">"Sorry, this operation isn't supported.\n"</font> ); <br> <font color="#0000ff">return</font> -EINVAL; <br> } <br> <br> <font color="#0000ff">static</font> ssize_t device_read( <font color="#0000ff">struct</font> file *filp, <font color="#008000">/* include/linux/fs.h */</font> <br> <font color="#0000ff">char</font> *buffer, <font color="#008000">/* buffer */</font> <br> size_t length, <font color="#008000">/* buffer length */</font> <br> loff_t * offset ) <br> { <br> <font color="#0000ff">int</font> byte_read = 0; <br> <br> <font color="#0000ff">if</font> ( *text_ptr == 0 ) <br> <font color="#0000ff">return</font> 0; <br> <br> <font color="#0000ff">while</font> ( length &amp;&amp; *text_ptr ) <br> { <br> put_user( *( text_ptr++ ), buffer++ ); <br> length--; <br> byte_read++; <br> } <br> <br> <font color="#0000ff">return</font> byte_read; <br> } <br></font> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br><h4>  Module assembly </h4><br><br>  Well, now we can write a small <b>Makefile</b> : <br><br> <code>obj-m += test.o <br> all: <br> make -C /lib/modules/$(shell uname -r)/build M=$(PWD) modules <br> clean: <br> make -C /lib/modules/$(shell uname -r)/build M=$(PWD) clean <br></code> <br><br>  And check its performance: <br><br>  <b>root @ joker: / tmp / test # <i>make</i></b> <br> <code><i>make -C /lib/modules/2.6.26-2-openvz-amd64/build M=/tmp/test modules <br> make[1]: Entering directory `/usr/src/linux-headers-2.6.26-2-openvz-amd64' <br> CC [M] /tmp/1/test.o <br> Building modules, stage 2. <br> MODPOST 1 modules <br> CC /tmp/test/test.mod.o <br> LD [M] /tmp/test/test.ko <br> make[1]: Leaving directory `/usr/src/linux-headers-2.6.26-2-openvz-amd64'</i> <br></code> <br><br>  Let's see what we did: <br><br>  <b>root @ joker: / tmp / test # <i>ls -la</i></b> <br> <code><i>drwxr-xr-x 3 root root 4096  21 12:32 . <br> drwxrwxrwt 12 root root 4096  21 12:33 .. <br> -rw-r--r-- 1 root root 219  21 12:30 demo.sh <br> -rw-r--r-- 1 root root 161  21 12:30 Makefile <br> -rw-r--r-- 1 root root 22  21 12:32 modules.order <br> -rw-r--r-- 1 root root 0  21 12:32 Module.symvers <br> -rw-r--r-- 1 root root 2940  21 12:30 test.c <br> -rw-r--r-- 1 root root 10364  21 12:32 test.ko <br> -rw-r--r-- 1 root root 104  21 12:32 .test.ko.cmd <br> -rw-r--r-- 1 root root 717  21 12:32 test.mod.c <br> -rw-r--r-- 1 root root 6832  21 12:32 test.mod.o <br> -rw-r--r-- 1 root root 12867  21 12:32 .test.mod.o.cmd <br> -rw-r--r-- 1 root root 4424  21 12:32 test.o <br> -rw-r--r-- 1 root root 14361  21 12:32 .test.o.cmd <br> drwxr-xr-x 2 root root 4096  21 12:32 .tmp_versions</i> <br></code> <br><br>  Now let's take a look at the information about the newly compiled module: <br><br>  <b>root @ joker: / tmp / test # <i>modinfo test.ko</i></b> <br> <code>filename: test.ko <br> description: My nice module <br> author: Alex Petrov &lt;druid@joker.botik.ru&gt; <br> license: GPL <br> depends: <br> vermagic: 2.6.26-2-openvz-amd64 SMP mod_unload modversions <br></code> <br><br>  Finally, install the module in the kernel: <br><br>  <b>root @ joker: / tmp / test # <i>insmod test.ko</i></b> <br><br>  Let's see if our module is listed: <br><br>  <b>root @ joker: / tmp / test # <i>lsmod |</i></b>  <b><i>grep test</i></b> <br><br> <code>test 6920 0 <br></code> <br><br>  And what fell into the logs: <br><br>  <b>root @ joker: / tmp / test # <i>dmesg |</i></b>  <b><i>tail</i></b> <br><br> <code>[829528.598922] Test module is loaded! <br> [829528.598926] Please, create a dev file with 'mknod /dev/test c 249 0'. <br></code> <br><br>  Our module tells us what to do. <br><br>  Follow his advice: <br><br>  <b>root @ joker: / tmp / test # <i>mknod / dev / test c 249 0</i></b> <br><br>  Finally, let us check if our module is working: <br><br>  <b>root @ joker: / tmp / test # <i>cat / dev / test</i></b> <br><br> <code>test</code> <br> <br>  Our module does not support receiving data from the user: <br><br>  <b>root @ joker: / tmp / test # <i>echo 1&gt; / dev / test</i></b> <br><br> <code>bash: echo:  :  </code> <br> <br>  Let's see what the module says to our actions: <br><br>  <b>root @ joker: / tmp / test # <i>dmesg |</i></b>  <b><i>tail</i></b> <br><br> <code>[829528.598922] Test module is loaded! <br> [829528.598926] Please, create a dev file with 'mknod /dev/test c 249 0'. <br> [829747.462715] Sorry, this operation isn't supported. <br></code> <br><br>  Delete it: <br><br>  <b>root @ joker: / tmp / test # <i>rmmod test</i></b> <br><br>  And let's see what he says to us at parting: <br><br>  <b>root @ joker: / tmp / test # <i>dmesg |</i></b>  <b><i>tail</i></b> <br><br> <code>[829528.598922] Test module is loaded! <br> [829528.598926] Please, create a dev file with 'mknod /dev/test c 249 0'. <br> [829747.462715] Sorry, this operation isn't supported. <br> [829893.681197] Test module is unloaded! <br></code> <br><br>  Delete the device file so that it does not confuse us: <br><br>  <b>root @ joker: / tmp / test # <i>rm / dev / test</i></b> <br><br><h4>  Conclusion </h4><br><br>  Further development of this ‚Äúblank‚Äù depends only on you.  You can turn it into a real driver that will provide the interface to your device, or use it to further explore the Linux kernel. <br><br>  I just had a completely crazy idea to make sudo through a device file.  Those.  send the command to / dev / test and it is executed as root. <br><br><h4>  Literature </h4><br><br>  And in the end I will give a link to the spell book <a href="http://www.linuxcenter.ru/lib/books/lkmpg.phtml">LKMPG (Linux Kernel Module Programming Guide)</a> <br><br>  <b>UPD:</b> <br>  Some may not have a module compiled via the Makefile described above. <br>  Decision: <br>  Create a Makefile with only one line: <i>obj-m + = test.o</i> <br>  And run the assembly like this: <br>  <i>make -C / usr / src / linux-headers-`uname -r` SUBDIRS = $ PWD modules</i> <br><br>  <b>UPD2:</b> <br>  Corrected the error in the source. <br>  The parser is buggy and keeps 'MODULE_DEscriptION ("My nice module");'.  Naturally in the module_description all letters are capitalized. <br><br>  <b>UPD3:</b> <br>  <a href="https://habrahabr.ru/users/segoon/" class="user_link">segoon</a> sent several amendments to the post: <br><br>  1) In the device_open () function is the race condition: <br><br>  static int device_open (struct inode * inode, struct file * file) <br>  { <br>  text_ptr = text; <br><br>  if (is_device_open) &lt;&lt;&lt;&lt; <br>  return -EBUSY; <br><br>  is_device_open ++;  &lt;&lt;&lt;&lt; <br><br>  return SUCCESS; <br>  } <br><br>  If one process increases is_device_open during execution by another <br>  command process between if (is_device_open) and is_device_open ++, then <br>  As a result, the file will open 2 times.  For <a href="http://www.mjmwired.net/kernel/Documentation/atomic_ops.txt">atomic actions</a> you need to use <br>  function from the atomic_XXX () series. <br><br>  Atomic operations need to be used in all places of work with data.  In this case, and in close (). <br><br>  2) device_write () could not write at all, because  handler for <br>  By default, write () itself returns an error. <br><br>  3) put_user () MUST verify the result.  If not zero, then <br>  need either <br>  a) return the -EFAULT result and pretend that there was nothing (i.e. <br>  do not completely remove the read data from internal buffers in this <br>  case, the data is constant and nothing needs to be changed) <br>  b) return the number of ALREADY written byte (this is called partial read, <br>  allowed by POSIX).  At the same time, care must be taken not to return 0: <br>  read () = 0 means that the file has come to an end, but it is not. <br><br>  4) In the kernel, 0 is used as the successful exit code, not <br>  Defined constant SUCCESS.  There are exceptions, for example, in <br>  a network packet handler, but where either -EXXX is returned (the code <br>  errors), or 0 (everything is fine), it is the constant 0 that is used. <br><br>  Many more functions can be replaced by more suitable counterparts, but this <br>  would complicate the understanding of the article by beginners :) </div><p>Source: <a href="https://habr.com/ru/post/106702/">https://habr.com/ru/post/106702/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../106689/index.html">About Toshiba in Moscow</a></li>
<li><a href="../106695/index.html">Ukraine - registration of the phone purchased in the online store in the IMEI database</a></li>
<li><a href="../106696/index.html">Opening an affiliate program</a></li>
<li><a href="../106698/index.html">Why blocklists are amateurishness</a></li>
<li><a href="../106700/index.html">Canobuvosti, 62 edition</a></li>
<li><a href="../106703/index.html">Understanding the advanced features of DOM IE9</a></li>
<li><a href="../106704/index.html">Business increasingly trusts the clouds or how the Three Hardships of Modern Task Managers are resolved at MTH</a></li>
<li><a href="../106705/index.html">GeekDad appreciated features of a search engine for children</a></li>
<li><a href="../106706/index.html">38th issue of Russian Full Circle Magazine</a></li>
<li><a href="../106707/index.html">Military robots for over 65 years!</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>