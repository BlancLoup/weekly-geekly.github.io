<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>IOS development techniques used by me in the Pictograph contest</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Recently passed three rounds of the Vkontakte competition for creating a photo application for the iOS platform. Link to the competition: http://vk.co...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>IOS development techniques used by me in the Pictograph contest</h1><div class="post__text post__text-html js-mediator-article">  Recently passed three rounds of the Vkontakte competition for creating a photo application for the iOS platform.  Link to the competition: <a href="http://vk.com/photo_contest">http://vk.com/photo_contest</a> .  In the process of developing the application of the first round, I found some interesting solutions to some problems.  I wanted to share these decisions with the public.  For older iOS developers, I‚Äôll hardly discover something new, I don‚Äôt think the article will work for novices either.  I suppose that the article will be of interest to developers under iOS with experience of 2-5 applications. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/storage2/518/2bb/0ac/5182bb0ac8d553cd097db0bd89847dd5.jpg"></div><br><a name="habracut"></a><br><h3>  Horizontal scrolling tape with <br>  latest photos from the device‚Äôs memory </h3><br>  Firstly, it is very competent that from the very beginning not exactly 4 or 5 pictures are seen in the tape, but 4 and 1/3.  This makes the user instantly aware that the list of photos is scrolling horizontally. <br><br>  There are several questions: <br><ul><li>  How many photos to upload to this tape? </li><li>  How to organize dynamic uploading of photos so that they all do not hang in RAM? </li></ul><br>  At first I decided that I would display all the photos from the device‚Äôs memory in the tape, in case of problems with download speed I promised myself to return to this issue. <br>  Immediately there was a problem with getting all the photos from the device‚Äôs memory in the correct order, because it was required to display the newest photos at the beginning of the tape.  Immediately it turned out that the newest photos I have are not in the album with the saved photos, but in the Photostream, which my brother shared with me on that day. <br>  It was decided to display the latest photos from the album with the saved photos at the beginning of the tape, and all the others are already behind this album.  Inside each album of a photo I began to locate since the last.  Here is the source code that receives the <code>ALAsset</code> array in the order described: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre> <code class="hljs objectivec"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">@implementation</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ALAssetsLibrary</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Extension</span></span></span><span class="hljs-class">) - (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class">)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">latestAssetsAndCall</span></span></span><span class="hljs-class">:(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class"> (^)(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NSMutableArray</span></span></span><span class="hljs-class"> *))</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">callback</span></span></span><span class="hljs-class"> </span></span>{ __block <span class="hljs-built_in"><span class="hljs-built_in">NSMutableArray</span></span> * assets = [<span class="hljs-built_in"><span class="hljs-built_in">NSMutableArray</span></span> arrayWithCapacity:<span class="hljs-number"><span class="hljs-number">5000</span></span>]; [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> enumerateGroupsWithTypes:ALAssetsGroupAll usingBlock:^(ALAssetsGroup *group, <span class="hljs-built_in"><span class="hljs-built_in">BOOL</span></span> *stop) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (group == <span class="hljs-literal"><span class="hljs-literal">nil</span></span>) { callback(assets); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } ALAssetsGroupType groupType = [[group valueForProperty:ALAssetsGroupPropertyType] intValue]; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> insertIndex = (groupType == ALAssetsGroupSavedPhotos) ? <span class="hljs-number"><span class="hljs-number">0</span></span> : assets.count; [group enumerateAssetsUsingBlock:^(ALAsset *result, <span class="hljs-built_in"><span class="hljs-built_in">NSUInteger</span></span> index, <span class="hljs-built_in"><span class="hljs-built_in">BOOL</span></span> *stop) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result != <span class="hljs-literal"><span class="hljs-literal">nil</span></span>) [assets insertObject:result atIndex:insertIndex]; }]; } failureBlock:^(<span class="hljs-built_in"><span class="hljs-built_in">NSError</span></span> *error) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (error) <span class="hljs-built_in"><span class="hljs-built_in">NSLog</span></span>(<span class="hljs-string"><span class="hljs-string">@"%@"</span></span>, error); }]; } <span class="hljs-keyword"><span class="hljs-keyword">@end</span></span></code> </pre> <br>  As for the second question, I didn‚Äôt find anything better than using <code>UITableView</code> , because it‚Äôs just created to scroll through long lists, dynamically load content and reuse similar table cells.  The only thing that - the table must be rotated 90 ¬∞ counterclockwise.  Given that the transformation is carried out relative to the center of the object, we place the center of <code>UITableView</code> in the estimated location of the center of the tape and perform: <br><br><pre> <code class="hljs objectivec"><span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.tableView.transform = <span class="hljs-built_in"><span class="hljs-built_in">CGAffineTransformMakeRotation</span></span>(-M_PI_2);</code> </pre> <br>  When creating table cells, it is necessary to perform the reverse transformation - rotation 90 ¬∞ clockwise: <br><br><pre> <code class="hljs objectivec">- (<span class="hljs-built_in"><span class="hljs-built_in">UItableViewCell</span></span> *)tableView:(<span class="hljs-built_in"><span class="hljs-built_in">UITableView</span></span> *)tableView cellForRowAtIndexPath:(<span class="hljs-built_in"><span class="hljs-built_in">NSIndexPath</span></span> *)indexPath { <span class="hljs-built_in"><span class="hljs-built_in">UITableViewCell</span></span> *cell = [tableView dequeueReusableCellWithIdentifier:<span class="hljs-string"><span class="hljs-string">@"BottomRollCell"</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cell == <span class="hljs-literal"><span class="hljs-literal">nil</span></span>) { cell = [[<span class="hljs-built_in"><span class="hljs-built_in">UITableViewCell</span></span> alloc] initWithStyle:<span class="hljs-built_in"><span class="hljs-built_in">UITableViewCellStyleDefault</span></span> reuseIdentifier:<span class="hljs-string"><span class="hljs-string">@"BottomRollCell"</span></span>]; cell.contentView.transform = <span class="hljs-built_in"><span class="hljs-built_in">CGAffineTransformMakeRotation</span></span>(M_PI_2); <span class="hljs-comment"><span class="hljs-comment">//     } //       }</span></span></code> </pre> <br>  What do we have in the end?  The table as it scrolls asks us for the contents of its cells.  Having an array of <code>ALAsset</code> , we get <a href="http://developer.apple.com/library/ios/documentation/AssetsLibrary/Reference/ALAsset_Class/Reference/Reference.html">thumbnails of the</a> images and fill them with table cells.  The table scrolls very smoothly, lags with uploading photos are not noticed.  Regarding the time of receiving all the photos - getting 2500 photos takes less than 1 second of time, but it is critical to start the application.  We make animation of table dropout from right to left upon receipt of <code>ALAsset</code> .  It turns out very nice and the delay of half a second is almost not noticeable.  Moreover, the request is not all assets, but through the task of a set of speed increase indices does not give, it even discouraged me a little.  Thus, optimization with fast preloading of the first photos - did not roll. <br><br><h3>  Animation of opening and closing photos </h3><br>  It was decided to expand the photos directly from the thumbnails from the ribbon when they were opened and to turn them back when the editing was canceled.  In order to get the coordinates of a rectangle of a specific table cell, I used the method of the <code>UITableView</code> class: <br><br><pre> <code class="hljs objectivec">- (<span class="hljs-built_in"><span class="hljs-built_in">CGRect</span></span>)rectForRowAtIndexPath:(<span class="hljs-built_in"><span class="hljs-built_in">NSIndexPath</span></span> *)indexPath;</code> </pre> <br>  I had to spend some <a href="http://ru.wikipedia.org/wiki/%25D0%259C%25D0%25B0%25D0%25BD%25D0%25B0_(%25D0%25BC%25D0%25B0%25D0%25B3%25D0%25B8%25D1%258F)">manna</a> to determine the exact coordinates of the picture, taking into account its rotation, etc.  After receiving the coordinates of the miniature image in the main view, on top of the miniature, I placed a smaller full-size image and animatedly resized and positioned the image.  Ideally, I would like the image to jump out of a tape with a non-linear trajectory, but there is no time left for it ... <br><br>  In order to track changes in device photos, you need to subscribe to the <a href="http://developer.apple.com/library/ios/documentation/AssetsLibrary/Reference/ALAssetsLibrary_Class/Reference/Reference.html">ALAssetsLibraryChangedNotification</a> event for which you need to reload the <code>ALAsset</code> array.  To prevent the tape from being updated when the photo is saved by the application itself, you must use the internal flag to cancel the tape redraw during the next update and manually add a new <code>ALAsset</code> to the beginning of the <code>ALAsset</code> array. <br>  I save to the leftmost position, I shift the table to the right by the width of one image, I animate the image fly into the ribbon, move the table back without animation and manually call <code>reloadData</code> . <br><br>  In order to animate the opening and closing of images performed smoothly and as quickly as possible, I had to do one interesting thing.  If you open a photo, change its scale and press the cancel button, the photo will fly to the tape exactly in the form in which we left it after scaling.  The photo will remain there in this view until it is hidden outside the screen and reloaded.  To achieve this effect, I used <code>NSMutableDictionary</code> with <code>NSMutableDictionary</code> URLs as keys and an <code>NSValue</code> containing <code>CGRect</code> as values.  Unfortunately, I forgot to remove this property in the video review, but it was one of the most interesting problems for me. <br><br><h3>  Smooth scaling and positioning of photos using effects </h3><br>  I really wanted to make the scaling and positioning of the photo with the simultaneous application of the selected effect and in the previews also move everything synchronously and apply the effect.  In general, if you try to do so - to brake this joy will be godless.  An interesting solution was found to apply the selected effect to the main photo and take the photo reduced five times (more precisely 320.0 / 56.0) and apply other effects to it, and in the process of scaling and positioning synchronize the thumbnail scrolls with the main <code>UIScrollView</code> .  This method works quickly, smoothly and without jambs. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/storage2/f91/e0b/21b/f91e0b21bfe9015ae6ad901be96894fc.png"></div><br><br>  The code that synchronizes thumbnail scrolls with the main scroll (these are the <code>UIScrollViewDelegate</code> delegate methods): <br><br><pre> <code class="hljs objectivec">- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)scrollViewDidScroll:(<span class="hljs-built_in"><span class="hljs-built_in">UIScrollView</span></span> *)scrollView { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">UITableViewCell</span></span> * cell <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.filtersTable visibleCells]) { <span class="hljs-built_in"><span class="hljs-built_in">UIScrollView</span></span> * filterScrollView = (<span class="hljs-built_in"><span class="hljs-built_in">UIScrollView</span></span> *)[cell.contentView viewWithTag:<span class="hljs-number"><span class="hljs-number">125</span></span>]; filterScrollView.contentOffset = <span class="hljs-built_in"><span class="hljs-built_in">CGPointMake</span></span>(scrollView.contentOffset.x*<span class="hljs-number"><span class="hljs-number">56</span></span>/<span class="hljs-number"><span class="hljs-number">320</span></span>, scrollView.contentOffset.y*<span class="hljs-number"><span class="hljs-number">56</span></span>/<span class="hljs-number"><span class="hljs-number">320</span></span>); } } - (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)scrollViewDidZoom:(<span class="hljs-built_in"><span class="hljs-built_in">UIScrollView</span></span> *)scrollView { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">UITableViewCell</span></span> * cell <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.filtersTable visibleCells]) { <span class="hljs-built_in"><span class="hljs-built_in">UIScrollView</span></span> * filterScrollView = (<span class="hljs-built_in"><span class="hljs-built_in">UIScrollView</span></span> *)[cell.contentView viewWithTag:<span class="hljs-number"><span class="hljs-number">125</span></span>]; filterScrollView.zoomScale = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.scrollView.zoomScale; filterScrollView.contentOffset = <span class="hljs-built_in"><span class="hljs-built_in">CGPointMake</span></span>(scrollView.contentOffset.x*<span class="hljs-number"><span class="hljs-number">56</span></span>/<span class="hljs-number"><span class="hljs-number">320</span></span>, scrollView.contentOffset.y*<span class="hljs-number"><span class="hljs-number">56</span></span>/<span class="hljs-number"><span class="hljs-number">320</span></span>); } }</code> </pre> <br><br><h3>  Saving result </h3><br>  Since for us the most important thing is the speed of the application and the quality of the pictures in general, the conditions of the competition are not regulated, I decided to save the pictures of 640x640 (retina).  And the easiest way to do this is through rendering the main view in the context of an image with an upward shift: <br><br><pre> <code class="hljs objectivec">- (<span class="hljs-built_in"><span class="hljs-built_in">UIImage</span></span> *)renderImageForSaving { <span class="hljs-built_in"><span class="hljs-built_in">UIGraphicsBeginImageContextWithOptions</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.scrollView.bounds.size, <span class="hljs-literal"><span class="hljs-literal">YES</span></span>, <span class="hljs-number"><span class="hljs-number">0.0</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">CGContextTranslateCTM</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">UIGraphicsGetCurrentContext</span></span>(), <span class="hljs-number"><span class="hljs-number">0</span></span>, -<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.scrollView.frame.origin.y); [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.view.layer renderInContext:<span class="hljs-built_in"><span class="hljs-built_in">UIGraphicsGetCurrentContext</span></span>()]; <span class="hljs-built_in"><span class="hljs-built_in">UIImage</span></span> * image = <span class="hljs-built_in"><span class="hljs-built_in">UIGraphicsGetImageFromCurrentImageContext</span></span>(); <span class="hljs-built_in"><span class="hljs-built_in">UIGraphicsEndImageContext</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> image; }</code> </pre> <br>  This is fast and without additional problems with the inscriptions, etc.  Yes, the resolution could be saved and more - but this is a completely different problem, requiring time and patience) <br><br>  Video <s>with my naughty dog</s> , demonstrating the work of the application: <br><br><iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/_reOwO2N-pA%3Ffeature%3Doembed&amp;xid=17259,15700021,15700186,15700190,15700253,15700255,15700259&amp;usg=ALkJrhiaQCxINS6GNl2_XEiuV1n3Z4SGcw" frameborder="0" allowfullscreen=""></iframe><br><br>  I think you can give a link (ok?).  The application is free and without advertising, respectively. <br>  Link to the application: <a href="https://itunes.apple.com/app/pictography/id570470169">https://itunes.apple.com/app/pictography/id570470169</a> <br>  Under iOS5, several different glitches are now observed, an update with fixes has been sent for review and is expected by the end of the week ... <br><br>  <b>PS</b> And finally, many thanks to Vkontakte for organizing and holding such contests.  After all, they motivate / stimulate programmers to start developing promising platforms for them (for some reason it seems to me that there are a lot of newbies among the participants in relation to the platform).  Very pleased with the input data for the contest - all the images were like a selection.  Not a single extra pixel stuck anywhere ... </div><p>Source: <a href="https://habr.com/ru/post/154209/">https://habr.com/ru/post/154209/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../154197/index.html">Call Manager & Skype connect via CUBE</a></li>
<li><a href="../154199/index.html">Mail.Ru Mail for WP7: development, close-up</a></li>
<li><a href="../154203/index.html">Office supplies that may disappear in the future</a></li>
<li><a href="../154205/index.html">NetApp: Compatibility Matrix</a></li>
<li><a href="../154207/index.html">Microsoft creates a prototype wearable manipulator in 3D space</a></li>
<li><a href="../154211/index.html">CSS internal shadows</a></li>
<li><a href="../154213/index.html">EPAM IT Share: Cloud Connect Chicago 2012 Conference Report</a></li>
<li><a href="../154217/index.html">Beautiful Ukrainian game Contre Jour ported to HTML5</a></li>
<li><a href="../154219/index.html">Broadcast jump from a height of 36 kilometers</a></li>
<li><a href="../154221/index.html">ObjectScript API, integration with C ++. Part 4: Connecting Custom Classes and Functions in C ++</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>