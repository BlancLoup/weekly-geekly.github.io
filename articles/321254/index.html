<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Pass to the ground - how Apple Pay and Samsung Pay were launched in Yandex.Money</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the wake of the universal hobby of contactless payment, I want to share the engine experience of Yandex. Money on the launch of Apple Pay and Samsu...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Pass to the ground - how Apple Pay and Samsung Pay were launched in Yandex.Money</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://habrastorage.org/web/991/75e/842/99175e842e8b48839cb48220f79186d1.png" alt="image alt text"></p><br><p>  In the wake of the universal hobby of contactless payment, I want to share the engine experience of Yandex. Money on the launch of Apple Pay and Samsung Pay.  Our team had to coordinate with MasterCard and smartphone makers.  Making friends with this company and not going crazy - the task itself is not trivial.  In addition, we were in the first wave of those who came to the "holiday", and many decisions had to run in on the go. </p><br><p>  Under the cut details about connecting contactless payments in Yandex.Money, testing and features of the security systems with a new type of payments. <a name="habracut"></a></p><br><p>  <strong>In this post we will talk about the payment systems Apple Pay and Samsung Pay, which are based on similar principles and differ in details.</strong>  <strong>For simplicity, I'll just call them * Pay wherever the details are not fundamental.</strong> </p><br><h1 id="zachem-vse-eto">  Why all this </h1><br><p>  You can pay for the goods from your phone a long time ago - just install your bank‚Äôs mobile application, which should have the contactless payment option (the Yandex.Money application will work, too, by the way).  Card data is stored securely on the user's device and is available using HCE technology - this is a software analogue of a bank card chip. </p><br><p>  There are also separate programs like the <a href="https://cardsmobile.ru/">Wallet</a> , which offer wireless payment options for partner banks and, as a bonus, the storage of discount cards. </p><br><p>  That is why earlier contactless payment required additional ‚Äúlayers‚Äù: </p><br><ol><li><p>  Owners of the iPhone could not pay without contact, because the NFC interface in Apple smartphones cannot be directly used for payment in third-party applications.  In addition, NFC appeared only in the iPhone 6 and SE. </p><br></li><li>  Many modern smartphones have a separate Secure Element (SE) device, which serves as an EMV chip of a bank card and is not tied to a specific bank or card.  Such a unified solution is more convenient for the user and easier to sell to the bank, which previously did not have to pay with a smartphone. </li></ol><br><blockquote>  Apple Pay and Samsung Pay are needed first of all in order to make payment from a smartphone via NFC <strong>standardized</strong> and secure. </blockquote><br><div class="spoiler">  <b class="spoiler_title">A small excursion into the emergence of Secure Element and card security</b> <div class="spoiler_text"><p>  Initially, payment cards were issued only with a magnetic stripe, on which the card number was recorded.  Naturally, the number was easily copied, so the <strong>EMVCo</strong> organization, which developed the more secure <a href="https://en.wikipedia.org/wiki/EMV">EMV</a> chip, took up the case.  This measure has significantly reduced the number of fraudulent transactions, but did not completely solve the problem.  In addition, the payment process was imperfect and therefore continued work on further improvements. </p><br><p>  Then there were contactless payments on plastic (MasterCard PayPass, VISA PayWave), and then the payment functions of the card began to partially transfer to mobile devices. </p><br><p>  The path was thorny, and among other payment systems tried the following options: </p><br><ul><li><p>  SIM-card with built-in Secure Element chip, produced jointly by the cellular operator and the issuing bank; </p><br></li><li><p>  sticker on the phone with built-in wireless module and Secure Element; </p><br></li><li>  Using the phone‚Äôs built-in NFC adapter and Secure Element (HCE) software emulation. </li></ul><br><p>  Ultimately, MasterCard "shuffled the cards" and secured the functions of storing card data and making payments for mobile device manufacturers.  This is how the <a href="http://newsroom.mastercard.com/2014/09/10/mastercard-digital-enablement-service-mdes-making-digital-payments-happen/">MasterCard Digital Enablement Service</a> (MDES) from MasterCard appeared, and then * Pay. </p><br><p>  But HCE still did not completely disappear, as it allows banks to use their own mobile applications for contactless payment.  That is, the bank can add the function of payment from the card to its application.  Plus, in the application, you can implement any brand-name amenities like paying utilities. </p><br><p>  By the way, the contactless payment option via HCE also remained in Yandex.Money Mobile - for all those who for various reasons cannot use * Pay. </p></div></div><br><h1 id="podruzhit-vseh-so-vsemi">  Make friends all with all </h1><br><p>  I hope that now all the causal relationships have been restored, so let's return to the Yandex.Money contactless payment project. </p><br><p>  <strong>If all the same something remains vague - be sure to ask in the comments.</strong> </p><br><p>  I will illustrate all further scenarios using the Yandex.Money cards as an example, for which the most information was accumulated. </p><br><p>  So that the user can easily pay for the goods from the phone, you need close cooperation between the four parties: </p><br><ol><li><p>  contactless payment service from a smartphone manufacturer (Apple Pay and Samsung Pay); </p><br></li><li><p>  payment system (MasterCard); </p><br></li><li><p>  card issuer (Yandex.Money); </p><br></li><li>  seller's acquiring bank. </li></ol><br><p>  Thus, the Yandex.Money team had to agree with Apple, Samsung, Mastercard and implement support for the updated payment protocols on their side.  It was also necessary to add acceptance of payments through Apple Pay and Samsung Pay to Yandex.Money - a payment solution for business.  But that's another story. </p><br><p><img src="https://habrastorage.org/files/b66/540/2ae/b665402ae8b64ba28848c2f944b0f3c6.jpg" alt="image alt text"></p><br><p>  The illustration does not have enough acquiring bank - removed it for simplicity. </p><br><p>  When a user adds a card to a wallet, Apple Wallet generates a cryptogram with encrypted card data and a digital signature, and then sends it to MasterCard.  There, the cryptogram is decoded and tokenization occurs.  Tokenization is the formation of a DPAN number, which is a synonym for the original map, unique to each physical device. </p><br><div class="spoiler">  <b class="spoiler_title">Memo on DPAN and its features</b> <div class="spoiler_text"><p>  Digital Primary Account Number (DPAN) is a special number-token that the payment system issues to a specific device for using one of the user's cards.  This number is unique for each device and, therefore, is generated each time the same card is added to the wallet of the next device. </p><br><p>  The token is needed in order not to store real billing data on a mobile device. </p></div></div><br><p>  But DPAN will not be generated until MasterCard verifies * Pay support on the issuer‚Äôs side, that is, Yandex.Money.  For this you need: </p><br><ol><li><p>  Wait for Apple or Samsung to check whether the device can be used as a payment (is the phone stolen, are there Root rights, etc.). </p><br></li><li><p>  Connect to the MasterCard Digital Enablement Service (MDES).  Details about such applications almost completely fall under the NDA, so those who wish will have to request documentation directly from MasterCard. </p><br></li><li><p>  Implement support for specific requests * Pay. </p><br></li><li>  Test the system with Apple, Samsung and MasterCard.  Testing is partially offsite, so everything is not as simple as it may seem. </li></ol><br><p>  But the user may want to add a map not manually, but from the Yandex.Money application.  Such an opportunity exists, but a slightly different mechanism is used. </p><br><h1 id="krasnyy-zheltyy-zelenyy">  Red, yellow, green </h1><br><p>  When a user adds a card to the phone‚Äôs wallet, one of three future scenarios is triggered, depending on the degree of risk: </p><br><ul><li><p>  <strong>Green</strong>  It is used when the request for adding a card comes from the issuer's mobile application (Yandex.Money) and it contains a special key confirming user authentication in the banking application.  No additional checks are required. </p><br></li><li><p>  <strong>Yellow</strong>  Usually used when adding a card manually or using a telephone camera (OCR).  The wallet asks for the CVV code of the card and asks for additional authentication. </p><br></li><li>  <strong>Orange</strong> .  Actually means refusing to add a card. </li></ul><br><p>  If you do not yet have a Yandex.Money plastic card, then for a sample of a pen, you can issue a virtual one directly in the application. </p><br><p>  But we do not live in a perfect spherical world, so the yellow path will often be used.  So that it also runs smoothly and at the stage of recognizing card details with the camera there were no problems, we sent more than 200 photos of test cards to Apple.  Without this training, the recognition algorithm was periodically mistaken and tried to add a card with incorrect data to the wallet. </p><br><h1 id="predpoletnaya-podgotovka">  Preflight preparation </h1><br><p>  When the necessary software on the backend was ready, and the beta version of Yandex.Money was trained on the Apple Pay tricks (for Samsung Pay, the tokenization option through our mobile application is not yet available), the tedious testing time has come. </p><br><p>  By the way, to connect to the "banquet" is not enough to implement everything and inform MasterCard about readiness - the payment system and phone manufacturers will check you personally.  For example, about Apple Pay, a friend from UL came to us with a set of all kinds of Apple gadgets.  He had only 6 iPhones - 3 generations in 2 versions (Simple and Plus).  With their help, the auditor checked many payment scenarios, including a refund. </p><br><p>  The updated Yandex.Money processing worked in the isolated test segment, so the white list of the cards was used for the checkout - for them, MasterCard simply turned on * Pay payments.  But there were some difficulties with Apple‚Äôs test environment. </p><br><p>  For example, there was no separate payment infrastructure for running in, therefore Yandex.Money testers had to transfer their smartphones and Apple ID to the ‚ÄúUSA‚Äù region and select answers to some queries on their own. </p><br><p>  But the devil is in the details, and the mistakes are on the last mile.  It turned out that by no means all banks monitor the updating of the firmware of their terminals, and most modern technology is alien to cashiers. </p><br><p><img src="https://habrastorage.org/files/4b3/a09/a80/4b3a09a80e48424e9688ec6fab61ad4f.jpg" alt="image alt text"></p><br><blockquote>  Let's get the map ... </blockquote><p>  There are quite a lot of payment terminal models and firmware for them, and the most ancient of them were crazy about * Pay.  I had to understand and forgive, at the same time telling in support of the respective banks about ‚Äúminor difficulties with the POS terminal‚Äù. </p><br><p>  When everything seemed to be working, for some transactions, sums began to arrive in the mobile wallet with a dash.  This clearly meant problems outside the Yandex.Money systems.  Of course, such reports did not affect the payment itself, but cognitive dissonance was present. </p><br><h1 id="nelazeyka-dlya-moshennikov">  (Un) loophole for scammers </h1><br><p>  Tokenization of cards by Yandex. Money, like other banks, is accompanied by checking such requests for fraudulent patterns.  To do this, Yandex.Money has a separate mechanism with its complex logic and powers to block extremely suspicious operations - the anti-fraud system. </p><br><p>  Since the system operates on the basis of certain rules, a potential security issue was discovered during tokenization of someone else‚Äôs card on the device.  For this you need the card number, expiration date and CVC2.  Yes, the issuer will most likely request additional validation, but even in the case of the SMS password, phishing and social engineering work.  With a payment amount of up to 1000 rubles, the terminal will not even ask the pin-code, and not all cardholders have included SMS alerts. </p><br><p>  Such threats can be dealt with at the processing level.  Each user action with his account or card is considered online by the fraud machine: if at least one blocking rule is triggered, the transaction will be rejected. </p><br><p>  For each Yandex.Money user, an individual behavioral profile is formed: what he likes and dislikes, how and when he usually pays, typical periods of activity and many other signs.  On the basis of this information and with the help of machine learning, a prediction of future values ‚Äã‚Äãis built, that is, the most likely human actions.  If the anti-fraud notices deviations of the actual indicators from their prediction, it can request additional authentication or reject the transaction. </p><br><p>  About machine learning in security systems, you can tell a lot of interesting things in connection with its long-term implementation in Yandex.Money, but this is a topic for a separate article. </p><br><p>  <strong>If you are at work faced with other nuances of connecting to * Pay - share in the comments, many will be curious.</strong> </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/321254/">https://habr.com/ru/post/321254/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../321244/index.html">Work with Flexbox in gifs</a></li>
<li><a href="../321246/index.html">How to create a Viber bot using PHP</a></li>
<li><a href="../321248/index.html">How IT professionals work. Nikolai Grigoriev, architect of mobile games and applications</a></li>
<li><a href="../321250/index.html">We write the easiest and fastest input type file</a></li>
<li><a href="../321252/index.html">Tarantool: Good, Bad, Angry</a></li>
<li><a href="../321256/index.html">The logic of consciousness. Part 11. Natural coding of visual and sound information</a></li>
<li><a href="../321258/index.html">ReactOS at FOSDEM 2017</a></li>
<li><a href="../321260/index.html">Procedural level generation for MERC in Unity</a></li>
<li><a href="../321262/index.html">Logging with rsyslog, file names in tags, multi-line messages and fault tolerance</a></li>
<li><a href="../321266/index.html">Standard exchange 1C-Bitrix on BASH: Detailed parsing of the script of incremental unloading</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>