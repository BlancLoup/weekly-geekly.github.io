<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Game client download tracking system</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Downloading a game is a rather complicated mechanism that takes place in several stages, each of which may fail for one reason or another, whether it ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Game client download tracking system</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/499/b0f/83f/499b0f83f3c641b6a3419b2baa701e2f.jpg"><br><br>  Downloading a game is a rather complicated mechanism that takes place in several stages, each of which may fail for one reason or another, whether it is a disconnection, a hardware failure, a banal firewall or restrictions on the provider side. <br><br>  Diagnosing errors that occur during the download of the game client, in such a variety of conditions, is not at all a trivial task.  And even the use of advanced solutions such as Google Analytics, does not allow to fully solve the problem.  That is why we had to design and write our own system for tracking the download of the game client. <br><a name="habracut"></a><br>  First, let's take a closer look at the download process of the game client.  In a social network, our application is an iframe element with an HTML page (hereinafter referred to simply as a canvas), which is physically located on our servers.  After loading the canvas, the game client is initialized, at the same stage we determine the availability of the flash player and its version.  Then the game client is embedded in the page as an object tag.  After that there are 3 main stages that are most interesting to us: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ol><li>  Actually downloading a file from a CDN (about 3 MB). </li><li>  Connecting to the social network API and getting the necessary data. </li><li>  Authorization on the game server and download resources. </li></ol><br>  Force majeure situations can occur at every stage, so we keep track of them.  The game client, using the external interface, informs the canvas on the result of each of the steps (both successful and not).  Canvas, in turn, contains a small javascript library, which stores the transmitted information.  After all stages of the download data is sent to the server. <br><br>  Based on this, you can briefly describe the main tasks in designing the system and highlight the following requirements for it: <br><br><ul><li>  processing a large number of simultaneous requests ‚Äî notifications and the fastest response to the request; </li><li>  identification of the country and region of the user by IP-address in real time; </li><li>  logging of various data that can be expanded or supplemented over time, and the provision of aggregated statistics, including in real time. </li><li>  providing statistics for many simultaneously connected clients in real time. </li></ul><br>  Obviously, the system must be able to cache data in order to quickly provide information for online monitoring, as well as dynamically scale.  Since the data is received continuously, and statistics on countries and regions may be needed at any time, it is necessary to determine the geo-information as they arrive. <br><br>  There was also the issue of updating data on the client side and the load on the server with simultaneous requests.  To view statistics from the server, you must somehow get the data, and for this usually use the so-called technology of long polling. <br><br>  When using long polling technology, the client sends an Ajax request to the server and waits for new data to appear on the server.  After receiving the data, the server sends them to the client, after which the client sends a new request and waits again.  The question arises: what will happen if several clients simultaneously execute such requests and the volume of data processed on them will be significant?  Obviously, the server load will increase greatly.  Knowing that in the overwhelming majority of cases the same requests are sent to the server, we wanted the server to process the unique request once and send the data to the users.  That is, the push notification mechanism was used. <br><br>  <b>Selection of tools and technology</b> <br><br>  It was decided to implement the server part of the application on the .net architecture using classic ASHX handlers for incoming requests from gaming clients.  Such handlers are a basic solution for processing web requests in the .net architecture, they have been used for a long time and work quickly due to the fact that the request is quickly passed through the IIS pipeline of the web server.  We need only one handler, which handles requests from the client, sent via pixel.  This refers to the approach when a 1x1 image is inserted on the client, where the URL is designed to transmit the necessary data to the server.  Thus, a regular GET request is performed.  On the server side, for each such request, it is necessary to determine the geo-information by IP address and save the data to the cache and database.  These operations are ‚Äúexpensive‚Äù, that is, they require a certain time.  Therefore, we use asynchronous handlers: during the request, only data validation is expected (performed quickly), after which the data is queued for asynchronous processing, and the client immediately receives a response. <br><br>  For data storage, we chose the NoSQL database - MongoDB, which allows you to store entities on the principle of Code First, that is, the database structure defines the entity in the code.  In addition, entities can be dynamically modified without the need to change the database structure each time, which allows you to save arbitrary objects transmitted from the client in JSON format and subsequently make various selections on them.  In addition, you can dynamically create new collections for new data types, which is great for horizontal scaling.  Virtually every unique tracking object is stored in its collection. <br><br>  After analyzing the requests from the client, we realized that overwhelmingly the same requests are sent to the server from different clients, and only in specific cases they are different (for example, when the query criteria change).  As an alternative to lond polling, we decided to use <a href="http://habrahabr.ru/post/79038/">web sockets</a> (WebSocket), allowing to organize two-way client ‚Äì ‚Äã‚Äãserver interaction and send requests only for opening / closing a channel and changing states.  Thus, the number of client ‚Äì ‚Äã‚Äãserver requests is reduced.  This approach allows you to update data on the server once and send push notifications to all subscribers.  As a result, the data is updated instantly, as a result of an event on the server side, and the number of processed requests on the server is reduced. <br>  In addition, you can organize work without using a web server directly (for example, in a service), and some trivial problems with cross-domain queries and security are also eliminated. <br><br>  <b>Notification processing</b> <br><br>  An asynchronous handler is a boxed solution, because in order to write your asynchronous handler, it is enough to inherit a class from IHttpAsyncHandler and implement the necessary methods and properties.  We implemented a wrapper as an abstract class (HttpTaskAsyncHandler) that implements IHttpAsyncHandler.  IAsyncResult was implemented through Tasks.  As a result, HttpTaskAsyncHandler contains one mandatory implementation method that accepts HttpContext and returns Task: <br><br><pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">abstract</span></span></span><span class="hljs-function"> Task </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ProcessRequestAsync</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">HttpContext context</span></span></span><span class="hljs-function">)</span></span>;</code> </pre> <br>  To implement an asynchronous ASHX handler, it is enough to inherit it from HttpTaskAsyncHandler and implement ProcessRequestAsync: <br><br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">YourAsyncHandler</span></span> : <span class="hljs-title"><span class="hljs-title">HttpTaskAsyncHandler</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> Task </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ProcessRequestAsync</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">HttpContext context</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Task(() =&gt; { <span class="hljs-comment"><span class="hljs-comment">//  }); } }</span></span></code> </pre><br>  Actually, the Task itself is created through the overridden ProcessRequestAsync in context: <br><br><pre> <code class="cs hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> IAsyncResult </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">BeginProcessRequest</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">HttpContext context, AsyncCallback callback, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> extraData</span></span></span><span class="hljs-function">)</span></span> { Task task = ProcessRequestAsync(context); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (task == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> returnValue = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TaskWrapperAsyncResult(task, extraData); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (callback != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) task.ContinueWith(_ =&gt; callback(returnValue )); <span class="hljs-comment"><span class="hljs-comment">//  . return retVal; }</span></span></code> </pre><br>  TaskWrapperAsyncResult is a wrapper class that implements IAsyncResult: <br><br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> AsyncState { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> WaitHandle AsyncWaitHandle { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ((IAsyncResult)Task).AsyncWaitHandle; } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> CompletedSynchronously { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ((IAsyncResult)Task).CompletedSynchronously; } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> IsCompleted { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ((IAsyncResult)Task).IsCompleted; } }</code> </pre><br>  The EndProcessRequest method checks that the task is executed: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">EndProcessRequest</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IAsyncResult result</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArgumentNullException(); } <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> castResult = (TaskWrapperAsyncResult)result; castResult.Task.Wait(); }</code> </pre><br>  The asynchronous processing itself takes place via the ContinueWith call for our wrapper.  Since ASHX handlers are far from new, standard calls to them look ugly: ../handlerName.ashx.  As a result, you can write HandlerFactory, implementing IHttpHandlerFactory, or write a routing, implementing IRouteHandler: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">HttpHandlerRoute</span></span>&lt;<span class="hljs-title"><span class="hljs-title">T</span></span>&gt; : <span class="hljs-title"><span class="hljs-title">IRouteHandler</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> String _virtualPath; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">HttpHandlerRoute</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">String virtualPath</span></span></span><span class="hljs-function">)</span></span> { _virtualPath = virtualPath; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> IHttpHandler </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetHttpHandler</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">RequestContext requestContext</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> httpHandler = (IHttpHandler)BuildManager.CreateInstanceFromVirtualPath(_virtualPath, <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(T)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> httpHandler; } }</code> </pre><br>  After that, during initialization, you need to set routes for handlers: <br><br><pre> <code class="cs hljs">RouteTable.Routes.Add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Route(<span class="hljs-string"><span class="hljs-string">"notify"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HttpHandlerRoute&lt;IHttpAsyncHandler&gt;(<span class="hljs-string"><span class="hljs-string">"~/Notify.ashx"</span></span>)));</code> </pre><br>  When receiving a notification, the definition of the geodata by IP address is performed (the determination process will be described later), the information is stored in the cache and database. <br><br>  <b>Data caching</b> <br><br>  The cache is implemented on the basis of <a href="https://msdn.microsoft.com/en-us/library/system.runtime.caching.memorycache%2528v%3Dvs.110%2529.aspx">MemoryCache</a> .  It is cyclical and automatically deletes old data after the specified period of the instance has passed or when the specified amount is exceeded in memory.  C cache is convenient to work and configure, for example, through .config: <br><br><pre> <code class="cs hljs">&lt;system.runtime.caching&gt; &lt;memoryCache&gt; &lt;namedCaches&gt; &lt;<span class="hljs-keyword"><span class="hljs-keyword">add</span></span> name=<span class="hljs-string"><span class="hljs-string">"NotificationsCache"</span></span> cacheMemoryLimitMegabytes=<span class="hljs-string"><span class="hljs-string">"3000"</span></span> physicalMemoryLimitPercentage=<span class="hljs-string"><span class="hljs-string">"95"</span></span> pollingInterval=<span class="hljs-string"><span class="hljs-string">"00:05:00"</span></span> /&gt; &lt;/namedCaches&gt; &lt;/memoryCache&gt; &lt;/system.runtime.caching&gt;</code> </pre><br>  The storage of data in the cache was organized in a distributed form, which made it possible to quickly obtain data for certain periods of time.  The following is the cache layout: <br><br><img src="https://habrastorage.org/files/5ef/a19/fb5/5efa19fb53624a7b93bb8eb05afea464.png"><br><br>  In essence, the cache is a collection of key ‚Äì value.  Where key is a timestamp (String), and value is an event queue (Queue). <br><br>  Cache events are stored in queues.  Each queue has its own time key, in our case it is one minute.  As a result, the key looks like [year_month_day_hour_minute].  Example format: ‚ÄúntnKey_ {0: y_MM_dd_HH_mm}‚Äù. <br><br>  When a new event is added (notification), a temporary key is determined in the cache and a queue is located, then the notification is added there.  If the queue does not exist, a new key is created for the current key.  Thus, to obtain data for a certain period, it is sufficient to determine temporary keys and receive queues with events.  Further data can be converted as needed. <br><br>  <b>Data storage in MongoDB</b> <br><br>  In parallel with the caching, the notification is saved in <a href="https://www.mongodb.org/">MongoDB</a> .  You can read about all the features and advantages of this database on the official website.  Now there are many different NoSQL databases, so the choice must be made based on personal preferences and tasks.  From myself I want to say that it is easy and pleasant to work with Mongo, it is developing dynamically (version 3.0 was recently released with the new WiredTiger engine), there are .net providers for working with it, which are also optimized and updated.  However, it is worth noting that the use of NoSQL databases is suitable for solving certain tasks and should be used as a replacement for relational databases only after in-depth analysis.  Nowadays, an integrated approach is increasingly common - the use of two types in large applications.  Typical applications include replacing the logging mechanism, working in conjunction with NodeJS without a backend, storing dynamically changing data and collections, projects with the CQRS + Event Sourcing architecture, and so on.  If you need to select data from several collections and / or perform various manipulations with samples, it is better to use relational databases. <br><br><img src="https://habrastorage.org/files/0a6/753/69d/0a675369d7344006ade829b77b304026.jpg"><br><br>  In the specific case, MongoDB came up perfectly and was used for quick uploading with grouping statistics, cyclic storage (the ability to set the lifetime of records using a special index), as well as geoservice (which will be described later). <br><br>  The MongoDB C # /. NET Driver was used to work with the database (at the time of writing - version 1.1, version 2.0 was recently released).  In general, the driver works well, but is embarrassed by the cumbersome use of objects like BsonDocument when writing queries. <br>  Fragment: <br><br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> countryCodeExistsMatch = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BsonDocument { { <span class="hljs-string"><span class="hljs-string">"$match"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BsonDocument { { <span class="hljs-string"><span class="hljs-string">"CountryCode"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BsonDocument { {<span class="hljs-string"><span class="hljs-string">"$exists"</span></span>, <span class="hljs-literal"><span class="hljs-literal">true</span></span>}, {<span class="hljs-string"><span class="hljs-string">"$ne"</span></span>, BsonNull.Value} } } } } };</code> </pre><br>  In version 1.1 there is already support for LINQ queries: <br><br><pre> <code class="cs hljs">Collection.AsQueryable().Where(s =&gt; s.Date &gt; DateTime.UtcNow.AddMinutes(<span class="hljs-number"><span class="hljs-number">-1</span></span> * <span class="hljs-number"><span class="hljs-number">10</span></span>) .OrderBy(d =&gt; d.Date);</code> </pre><br>  But, as it turned out in practice when analyzing through a profiler, such requests are not converted to native (BsonDocument) requests.  As a result, the entire collection is loaded into memory and moved, which is not very good for performance.  Therefore it was necessary to write requests through BsonDocument and directives of base.  Hopefully, the situation is fixed in the recently released .NET 2.0 Driver. <br><br>  Mongo supports <a href="http://docs.mongodb.org/manual/core/bulk-write-operations/">bulk operations</a> (inserting / modifying / deleting several instances at once in a single operation), which is very useful and allows you to cope well with peak loads.  We just save the events in the queue and have a working background-process that periodically gets N notifications and saves it via the Bulk Insert to the database.  All you need to do is synchronize the streams or use Concurrent collections. <br><br>  The database works fairly quickly in read mode, but <a href="http://docs.mongodb.org/manual/core/indexes-introduction/">indexes are</a> recommended to increase the speed.  As a result of proper indexing, the sampling rate can increase by about 10 times.  Accordingly, when indexing increases the size of the database. <br><br>  Another feature of Mongo is that it is maximally loaded into RAM, that is, when prompted, data remains in RAM and is unloaded as needed.  You can set the maximum value of RAM available for the database. <br>  There is also an interesting mechanism called <a href="http://docs.mongodb.org/manual/core/aggregation-pipeline/">Aggregation Pipeline</a> .  It allows you to perform several operations with data upon request.  The results are transmitted through the pipeline and transformed at each stage. <br>  An example would be a task when you need to select and group data and present the results in some form.  This task can be represented as: <br><br>  sample grouping provision ($ match, $ group, $ project and $ sort). <br><br>  Below is an example of an event selection code grouped by country code: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> countryCodeExistsMatch = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BsonDocument { { <span class="hljs-string"><span class="hljs-string">"$match"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BsonDocument { { <span class="hljs-string"><span class="hljs-string">"CountryCode"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BsonDocument { {<span class="hljs-string"><span class="hljs-string">"$exists"</span></span>, <span class="hljs-literal"><span class="hljs-literal">true</span></span>}, {<span class="hljs-string"><span class="hljs-string">"$ne"</span></span>, BsonNull.Value} } } } } }; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> groupping = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BsonDocument { { <span class="hljs-string"><span class="hljs-string">"$group"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BsonDocument { { <span class="hljs-string"><span class="hljs-string">"_id"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BsonDocument {{<span class="hljs-string"><span class="hljs-string">"CountryCode"</span></span>, <span class="hljs-string"><span class="hljs-string">"$CountryCode"</span></span>}} }, { <span class="hljs-string"><span class="hljs-string">"value"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BsonDocument {{<span class="hljs-string"><span class="hljs-string">"$sum"</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>}} } } } }; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> project = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BsonDocument { { <span class="hljs-string"><span class="hljs-string">"$project"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BsonDocument { {<span class="hljs-string"><span class="hljs-string">"_id"</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>}, {<span class="hljs-string"><span class="hljs-string">"hc-key"</span></span>,<span class="hljs-string"><span class="hljs-string">"$_id.CountryCode"</span></span>}, {<span class="hljs-string"><span class="hljs-string">"value"</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>}, } } }; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> sort = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BsonDocument { { <span class="hljs-string"><span class="hljs-string">"$sort"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BsonDocument { { <span class="hljs-string"><span class="hljs-string">"value"</span></span>, <span class="hljs-number"><span class="hljs-number">-1</span></span> } } } }; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> pipelineMathces = requestData.GetPipelineMathchesFromRequest(); <span class="hljs-comment"><span class="hljs-comment">//   var pipeline = new List&lt;BsonDocument&gt;(pipelineMathces) { countryCodeExistsMatch, groupping, project, sort }; var aggrArgs = new AggregateArgs { Pipeline = pipeline, OutputMode = AggregateOutputMode.Inline };</span></span></code> </pre><br>  The result of the selection will be an IEnumerable, which if necessary is easily converted to json: <br><br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> result = Notifications.Aggregate(aggrArgs).ToJson(JsonWriterSettings);</code> </pre><br>  An interesting feature of working with the database is the ability to save a JSON object directly into a BSON document.  Thus, it is possible to organize the storage of data from the client into the database, and the .net environment does not even need to know which object it is processing.  Similarly, you can make and requests to the database from the client side.  More details about all the features and features can be found <a href="http://docs.mongodb.org/manual/">in the official documentation.</a> <br><br>  In the next part of the article we will talk about the GeoIP service, which determines the geodata by request IP-address, web sockets, polling server implementations, AngularJS, Highcharts and will conduct a brief analysis of the system. </div><p>Source: <a href="https://habr.com/ru/post/267707/">https://habr.com/ru/post/267707/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../267697/index.html">Command line utilities can be 235 times faster than your Hadoop cluster</a></li>
<li><a href="../267699/index.html">How yoga kodit and live helps: personal experience</a></li>
<li><a href="../267701/index.html">Playing on bare HTML / CSS</a></li>
<li><a href="../267703/index.html">Putting gnome-screenshot from source to change the format of the screenshot file name</a></li>
<li><a href="../267705/index.html">Violet M-125</a></li>
<li><a href="../267709/index.html">Oracle hardware and software systems - open topic</a></li>
<li><a href="../267711/index.html">The benefits of iron, or familiarity with GPS / GLONASS trackers</a></li>
<li><a href="../267713/index.html">Centralized configuration management: Puppet + Foreman. Part II</a></li>
<li><a href="../267715/index.html">Why Vue?</a></li>
<li><a href="../267717/index.html">Unicorns ... Unicorns everywhere</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>