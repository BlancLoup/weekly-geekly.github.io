<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>The system of tracking the degree of icy streets: machine learning + Microsoft Azure + Android</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello to all! Every winter in the Russian (and not only) cities appears harmful ice. A lot of people slip and injure various parts of the body. You wi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>The system of tracking the degree of icy streets: machine learning + Microsoft Azure + Android</h1><div class="post__text post__text-html js-mediator-article"><p>  Hello to all!  Every winter in the Russian (and not only) cities appears harmful ice.  A lot of people slip and injure various parts of the body.  You will say that this problem should be solved by public utilities - yes, it is, but they often do not understand the state of the sidewalks and yard paths, and maybe they just do not know where to look.  In order to somehow improve the situation, modern technologies should increasingly be included in the solution of the problem.  A possible improvement is an application in which people can determine for themselves the safest route from point A to point B by looking at an ice map.  So, today we will talk about creating a system for assessing the degree of icy streets, based on statistics of people's falls.  Under the cut machine learning, clouds and mobile applications. </p><br> <a href=""><img src="https://habrastorage.org/files/d49/3df/d76/d493dfd767f74f8aab9889ff138d2af5.png" alt="3 examples of using the system"></a> <br><a name="habracut"></a><br><h2>  Where else could be useful? </h2><br><p>  Let me name two more applications of the future system (with the necessary changes).  In addition to the falls, considered globally in an urban environment, we want to monitor the condition of our loved ones (especially the elderly).  Here, information about the fall (heart attack, loss of consciousness, etc.) and the immediate notification of relatives will allow you to react as quickly as possible and call an ambulance for your grandmother / grandfather, not being directly next to them. </p><br><p>  Another useful application would be getting the trainer information about the fall of his athletes on long runs: skiers, runners, etc. All three <s>hallucinations</s> useful in the opinion of the author of the case are shown in the picture above for a more complete understanding of the problems.  The author also presents an analysis of the implementation of the system for the urban case and calls it Sleet Monitor.  The system will be implemented in a bundle of mobile Android applications and the cloud component.  At once I will say that all the code is in the <a href="https://github.com/VladVin/SleetMonitor">repository on GitHub</a> </p><br><h2>  What is the difficulty? </h2><br><p>  First of all, it is necessary to solve the problem of determining the fact of a fall.  The filling of the system will be represented by the fall classifier.  The complexity of its construction is mainly in the data that we get from smartphones.  Data is the accelerometer readings on three axes, collected continuously.  The picture below shows two examples of one and a half second frames: the left one corresponds to a fall, the right one - not to a fall. </p><br> <a href=""><img src="https://habrastorage.org/files/2bd/989/689/2bd98968971140fd8b4ae40c16419a6d.png" alt="Data examples"></a> <br><br><p>  Due to the different characteristics of smartphones, the data may be sparse, and the time resolution is not constant for the same device (the operating system for some reason does not return data with the same frequency on many devices).  Also the direction of the accelerometer axes can vary from device to device.  A plus to the above will be the problem of ‚Äúfreezing‚Äù the application (in the locked mode, the OS may very rarely give accelerometer readings, and may unexpectedly bring a whole wad of data). </p><br><p>  Currently, the first and partially the last problem is solved by using data interpolation.  Due to the listed difficulties and the fact that it is difficult to develop a classifier of falls based on some heuristics, the glance fell on machine learning approaches. </p><br><h2>  Data collection </h2><br><p><a href=""><img src="https://habrastorage.org/files/d09/2c3/818/d092c381858e429ca7aa870a85d33fe1.jpg" alt="Screenshot of data collection application" width="300" align="left"></a>  To teach a car something, you need to show it something, and it is even better to point out what is good and what is bad.  To collect the data, a separate Android application was written that collects accelerometer readings as often as possible and writes them to a file.  The frame size does not exceed 1.5 seconds (the author suggested that the average person falls during this period of time). <br><br>  The data is a string of the following format: <code>time_offset: x_value y_value z_value ... time_offset: x_value y_value z_value is_fall</code> .  Accelerometer readings are normalized to the maximum possible value for a particular type of accelerometer.  The number of tuples <code>(time_offset, x_value, y_value, z_value)</code> per line depends on the frequency of data provided by the operating system.  Here it is worth noting that the entire sample was collected on a LG Nexus 5 smartphone, which gives stable data every 5 ms with a non-locked screen.  Thus, in 1.5 seconds we have 300 data tuples with a time stamp. </p><br><p>  All data had to be collected by independent falls with the help of his friend Dmitry Kruchinin.  Thus, the collected data is based on a sample of the falls of two people.  All collected data (dirty and cleaned) are in the <code>ml/data</code> directory in the repository. </p><br><div class="spoiler">  <b class="spoiler_title">Additional features of the application</b> <div class="spoiler_text"><p>  In the application interface, you can specify what is being recorded at the moment - a fall or not a fall.  There is also a system to get rid of incorrect data - buttons <code>1</code> , <code>2</code> , <code>3</code> are designed to add <code>Label1</code> , <code>Label2</code> , <code>Label3</code> tags to the end of the file, signaling that the last measurements in <code>Label3</code> 1, 2 or 3 are incorrect.  In the future, the researcher will delete this data from the file.  There is also a separate <code>GOOD</code> tag, which a person can put to say that all previous measurements are guaranteed to be correct. </p><br><p>  There are also <code>Falls</code> and <code>Non-Falls</code> fields on the screen, corresponding to the number of recorded measurements in this session of the application for each type of state.  When a new application is launched, the system will write the <code>DataWriter was initialized</code> line to the file, which will allow the researcher to see the new session of the application and, in case of errors in the data, narrow the search to remove them. </p><br></div></div><br><p>  Here it is also worth noting the interface with sound signals in the application.  It was designed specifically to collect positive (falling) examples.  When a person makes a fall, he cannot get a smartphone out of his pocket to stop or start recording, because in this case the data will be corrupted (do not correspond to reality).  The picture below explains how the interface works with audio signals. </p><br> <a href=""><img src="https://habrastorage.org/files/6bd/7b3/504/6bd7b3504f904362a2c83ba7e33c7c60.jpg" alt="Voice Signal Interface"></a> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <div class="spoiler">  <b class="spoiler_title">Detailed explanation of the interface with signals</b> <div class="spoiler_text"><br><p>  After pressing the <code>PLAY</code> button, the system waits for the vibrations of the smartphone to become insignificant - a person holds the phone in his hand, or puts it in his pocket before recording.  As soon as the oscillations become insignificant, the system realizes that the person is ready to record, and it is also ready - a short Beep sound comes out.  Next comes the state of <i>Idle</i> (idleness), which lasts until the person starts to move, or starts to sway the smartphone in his hand.  Then the system starts recording data (in the figure, this stage is called <i>Failing</i> ).  The recording takes 1.5 seconds and ends with a long Beep signal (the system has written data to a file).  While the person is lying, he does not move (again the stage is <i>Idle</i> ).  As soon as the person began to move, and with it the smartphone in his pocket, the system understands that the person rises.  From this moment the cycle repeats.  For recording not falling, everything works exactly the same. </p><br></div></div><br><h2>  Architecture </h2><br><p>  Since the system is based on statistical data from a multitude of users, it requires <s>air support for the</s> central system that processes the data.  It consists of several machines and services deployed in the Microsoft Azure cloud, which are divided into three types according to their tasks: <br><br></p><ol><li>  Receive data from a smartphone </li><li>  Fall Detection </li><li>  REST API for getting ice map of streets </li></ol><p></p><br><p>  All machines are in the same network and ‚Äúcommunicate‚Äù through the <a href="http://cassandra.apache.org/">Apache Cassandra</a> database.  This NoSQL DBMS was chosen due to its main feature - it works efficiently with a large data stream coming in real time from multiple devices.  Immediately here it is worth mentioning the design of the database.  The database has two tables with the following schemes: <br><br></p><ul><li>  <code><b>sensor_data(user_id: varchar, x: float, y: float, z: float, lat: double, lon: double, timestamp: bigint, fall_status: int)</b></code> .  All tuples of data coming from Android devices are stored here.  Why do we keep everything?  It is believed that these data may be useful in the future, for example, to train any algorithm without a teacher.  The physical storage of rows in this table is arranged in descending order of the <code><b>timestamp</b></code> value so that you can work effectively with more recent tuples of data. <br><br></li><li>  <code><b>update_info(user_id: varchar, is_updated: boolean)</b></code> .  This table is only needed in order for the detector application to determine from which users the new data came.  Added not to look for fresh records for each user in a large table <code><b>sensor_data</b></code> , but to immediately know who has the updates. </li></ul><p></p><br><p>  The picture shows the complete system architecture, followed by a more detailed description of each component. </p><br> <a href=""><img src="https://habrastorage.org/files/2d1/b1c/de8/2d1b1cde8d114418b644e3c782b6704b.png" alt="Architecture"></a> <br><br><div class="spoiler">  <b class="spoiler_title">A bit of help on the current state of the cloud infrastructure</b> <div class="spoiler_text"><p>  Currently, Microsoft Azure has deployed one Linux machine with the <a href="https://www.datastax.com/products/datastax-enterprise">DataStax Enterprise</a> package, which includes the pre-installed Apache Cassandra.  Machine features: 4-core 2.4 GHz Intel Xeon E5-2673 v3 (Haswell), 14 GB RAM, 200 GB SSD.  The author rents a car for the funds received monthly under the <a href="http://microsoft.com/bizspark">Microsoft Bizspark</a> program. </p><br></div></div><br><h2>  Receive data from a smartphone </h2><br><p>  For sending and receiving data from a smartphone, <a href="https://azure.microsoft.com/en-us/services/event-hubs">Azure Event Hub</a> was used, specifically designed for a large flow of short messages.  On the server side there is a machine running a Java application that reads data from the Event Hub‚Äôs queue and writes it to the Cassandra database. </p><br><p>  Data is presented in JSON format.  Each message from the client contains accelerometer readings, timestamps, and GPS coordinates for all measurements taken within 1 minute. </p><br><div class="spoiler">  <b class="spoiler_title">Comment</b> <div class="spoiler_text"><p>  If you are going to implement the Azure Event Hub sender on Android, then the author can advise you to immediately look at the HTTPS API, since there is no Android (or the author could not find) a suitable implementation of the AMQP protocol that is used by all Azure Event Hub SDK. </p><br></div></div><br><h2>  Fall Detector </h2><br><p>  To handle the flow of data from users in the cloud running a machine with a Python application.  Why choose Python?  Just because machine learning studies were conducted in Python using the scikit-learn library, and rewriting the application using other technologies just to run it on the server at this stage was superfluous. </p><br> <a href=""><img src="https://habrastorage.org/files/728/ceb/acf/728cebacfe5d4a2096c17455a00b7453.png" alt="The principle of the fall detector"></a> <br><br><p>  The fall detector works on the principle of a sliding window (eng. - sliding window).  The window slides over the interpolated data (yes, each piece of fresh data taken from the base is interpolated due to the problem described at the beginning) and starts the classifier to determine if it has fallen.  The decision of the classifier 1 (fall) or -1 (not fall) is written back to the database for the first extracted tuple in the examined piece of data.  Naturally, this whole procedure is performed independently for each user, which is determined by the <code>user_id</code> in the table. </p><br><h2>  Classifier </h2><br><p>  We should also talk about the classifier.  It is based on the classical (without using neural networks) machine learning algorithm.  The quality of classification is evaluated by the F1-score metric.  The following was in the study field: <br><br></p><ol><li>  <b>Machine learning algorithm and its parameters</b> .  Candidates for the title of the best fall classifier were exposed to the Random Forest Classifier, Support Vector Classification / Regression and Linear Regression.  After several launches, it was revealed that the Random Forest Classifier with the number of trees 10 and the other default parameters ( <a href="http://scikit-learn.org/stable/modules/generated/sklearn.ensemble.RandomForestClassifier.html">set by</a> scikit-learn) shows the best results. <br><br></li><li>  <b>Dataset</b> .  Here varied test and training samples according to the ratio of &lt;number of positives&gt;: &lt;number of negatives&gt; and the set of negatives themselves changed.  The final training sample of negatives includes examples of simple movements of the smartphone in the air, walking around the room, throwing, as well as examples in which the classifier gave false positives in combat conditions (that is, when the entire system cycle was implemented and the author intentionally walked around the room and jumping without falling).  Total dataset was 84 positive examples and 400 negative.  Of these, 80% of random examples were assigned for training, the remaining 20% ‚Äã‚Äãfor testing. <br><br></li><li>  <b>Accelerometer axis set</b> .  Studies have shown that the set of axes <code>{x, z}</code> gives the best results in the classification, which also has a positive effect on the reduction of user's Internet traffic.  But here it is worth making a reservation.  The fact is that the data of the falls were collected by the author with the smartphone in a constant position in the pocket with its upper part down.  This direction corresponds to the direction of <code>y</code> on the LG Nexus 5. The algorithm retrained on the data along the <code>y</code> axis, and despite the fact that it showed good results on the test sample, under combat conditions, it gave a lot of false positives by simply turning the smartphone "upside down ".  This problem can be solved by creating a more representative sample.  But at the moment, the result with only two axes is very good. <br><br></li><li>  <b>Interpolation parameters</b>  As mentioned earlier, due to the large zoo of devices on Android, you have to work with sparse data.  This is where linear interpolation helps.  And since we take on interpolation, it would be nice to try to reduce the data resolution to reduce Internet traffic from the user and to reduce the server load on the fall detection.  Let me remind you that the base dataset contains one and a half second data frames divided into 300 tuples <code>(x, y, z, timestamp)</code> (one tuple of 5 ms).  When the resolution is reduced to one tuple of 50 ms, a still acceptable classification quality is observed, but the data volume is reduced 10 times! </li></ol><p></p><br><p>  The total F1-score maximum for several training eras with all the specified best parameters and taking into account the intentional dilution of data is 10 times at the level of ~ 90%.  Without dilution - ~ 95%. </p><br><div class="spoiler">  <b class="spoiler_title">Internet traffic notice</b> <div class="spoiler_text"><p>  The amount of data sent from an Android application in a binary representation is small.  In fact, <code>2(- ) * 4 (   ) + 4 ( timestamp) + 8 ( ) = 20 </code> is the size of one data tuple.  <code>1000  / 50  = 20</code> - the maximum number of tuples per second.  <code>20  * 20 = 400 </code> per second.  Further <code>400  * 60 * 60 * 24 * 30 = 1 036 800 000 </code> or <code>~980 </code> per month.  This is provided that the user walks 24 hours a day, and the application continuously sends data.  But in reality, on average, the user spends no more than a third of the day on the move.  Given this rough assumption, we get a traffic load in the region of 300 MB, which can be considered very adequate. </p><br></div></div><br><h2>  REST API and mapping points on the map </h2><br><p>  To obtain updates by all users of the Sleet Monitor application about the degree of icy streets, a simple Java REST API was written using the <a href="http://sparkjava.com/">spark-java</a> library.  The application refers all to the same Cassandra database and gets the fresh coordinates of those points for which the value <code>fall_status = 1</code> (a fall was detected at this place).  In an amicable way, here you can do some data cleaning, like checking for the coincidence of coordinates of several points.  At the moment, without additional processing, the coordinates are added to the R-Tree to quickly search the rectangular area that comes in the request from the client. </p><br><p>  To display the points on the map, my friend Cooper Bogdan implemented the principle of heat map, borrowed from the <a href="https://developers.google.com/maps/documentation/android-api/utility/heatmap">Google example</a> for Android.  The principle is that when the map is zoomed up, the drawn points collapse so that, where the density of the points in the neighborhood is greater, the larger the spot on the map looks. </p><br><p>  The figure below shows an example of the drawn drop points.  These are real falls, "attacked" by the author in the snow specifically to demonstrate the operation of the system.  In the red areas, the author intentionally fell several times to show that the crash classifier works well, and there were no false alarms during the recording, while the recording was made continuously with the same street walk speed. </p><br> <a href=""><img src="https://habrastorage.org/files/35c/b70/72f/35cb7072f91f4150bfd3898b39d52742.png" alt="Screenshots of the application with real drops"></a> <br><br><h2>  Conclusion </h2><br><p>  So, a slight improvement in the urban life of people is possible.  The system of tracking people falls is implemented.  Naturally, there can and should be done many optimizations to reduce both the server load and the load on the user's Internet traffic ‚Äî to train the model directly on more sparse data, thereby reducing the computational cost of the crash detector;  increase the pitch of the running window in the detector;  to reduce the traffic to transfer data from the Android device in binary form, and not as it is now in JSON;  and etc. </p><br><p>  Improvements can always be made, many of them are trivial, and at the same time they can bring a significant reduction in costs both for the server part and for user traffic.  The goal of the development was to gain experience in launching a complete pipeline, including a mobile application and a high-loaded server part, processing a huge data flow in real time.  But in order to launch this system in real conditions, you need to significantly expand the fleet of machines in the cloud and distribute the mobile application with the achievement of a high concentration of users in at least one city.  And with monetization, nothing is clear yet. </p><br><p>  Anticipating this problem at the stage of conceiving an idea, it was immediately decided to make the project open.  Let me remind you, all the code is in the <a href="https://github.com/VladVin/SleetMonitor">repository on GitHub</a> .  The goal of writing a debut for the author of an article on Habrahabr was not only to talk about the experience gained in building such systems, but also to get some feedback from the community.  Therefore, comments are very welcome, as well as suggestions for further development of the system.  Thanks for attention. </p></div><p>Source: <a href="https://habr.com/ru/post/318470/">https://habr.com/ru/post/318470/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../318458/index.html">On a combinatorial problem</a></li>
<li><a href="../318460/index.html">How long does it take to learn a new technology?</a></li>
<li><a href="../318464/index.html">Data Storage Architecture in Facetz.DCA</a></li>
<li><a href="../318466/index.html">Comparison of monitoring systems: Shinken vs Sensu vs Icinga 2 vs Zabbix</a></li>
<li><a href="../318468/index.html">Computers of Soviet Russia with the ternary balanced number system</a></li>
<li><a href="../318472/index.html">Front-end JavaScript framework Evolution :: release 1.5.7</a></li>
<li><a href="../318474/index.html">Framework for working with Telegraph API</a></li>
<li><a href="../318476/index.html">Shielded VM Technology in Windows Server 2016</a></li>
<li><a href="../318478/index.html">Microsoft‚Äôs .NET open source translation brought tangible benefits</a></li>
<li><a href="../318480/index.html">ASP.NET Core, Angular 2, SignalR for Dummies</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>