<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>MSP430, learn to program and debug hardware</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Today, a respected user, I will try to fill in some space formed in MSP430 articles, namely, the basics and the approach to programming devices on thi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>MSP430, learn to program and debug hardware</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage2/e59/aac/829/e59aac829e587062f7506a857fae95a3.jpg" align="left"><br>  Today, a respected user, I will try to fill in some space formed in MSP430 articles, namely, the basics and the approach to programming devices on this microcontroller. <br>  This article is primarily aimed at newbies, as I will consider a number of fairly simple tasks, such as working with SPI, blinking a light bulb, and debugging in proteus. <br><a name="habracut"></a><br><br><h4>  Introduction </h4><br>  This article will discuss the device, which is based on the <a href="http://www.ti.com/tool/ez430-rf2500">eZ430-RF2500</a> debug board.  The board contains the MSP430F2274 microcontroller and the CC2500 wireless module, which, it should be noted, will not be discussed further. <br>  My colleague, S. A. Sokolov, made a small add-in for this debug kit, it is attached to all the conclusions.  On the superstructure is the accelerometer LIS331DLH, with which we will interact with SPI. <br><img src="https://habrastorage.org/storage2/3bd/f45/7ba/3bdf457ba6c382d6491d330baebaabc3.jpg"><br>  I should note that STMicroelectronics devices working on SPI are very similar and, accordingly, working with them will look about the same. <br><br><h4>  What we need </h4><br><h5>  Development environment </h5><br>  First you need to download and install the development environment and compiler.  To date, there are three options - <a href="http://www.ti.com/tool/ccstudio">Code Composer Studio</a> , <a href="http://www.iar.com/en/Products/IAR-Embedded-Workbench/TI-MSP430/">IAR Embedded Workbench for TI MSP430</a> and <a href="http://mspgcc.sourceforge.net/">mspgcc</a> . <br>  I will use Workbench KickStart Edition.  <a href="http://supp.iar.com/Download/SW/%3Fitem%3DEW430-KS4">KickStart is</a> free, it has a limit on the amount of code, but to study this is more than enough. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h5>  Debug Tool </h5><br>  If you do not have an oscilloscope or logic analyzer at hand, then there are often difficulties associated with misunderstanding what actually happens in your device.  Understanding the reasons why the device refuses to work often helps Proteus. <br>  It can find very many MSP430 microcontrollers.  Unfortunately, there was no MSP430F2274 in Proteus, but there is an analogue - MSP430F2272, and we will use it. <br><br><h4>  Let's start writing code </h4><br><h5>  Creating a project </h5><br>  At this stage, difficulties should arise.  As a programming language, choose C ++. <br><ul><li>  Replace the standard #include "io430.h" with #include "msp430f2274.h" (header file for our microcontroller); </li><li>  In the properties of the project on the Debugger tab, select Driver: FET Debugger; </li><li>  On the General Options tab in the Device window, select MSP430F2274; </li><li>  In order to make sure that everything is done correctly, press Ctrl + D (Download and Debug).  As soon as the controller firmware is loaded, press F5 to execute it. </li></ul><br>  <i>If you need to compile a file for Proteus, on the Debugger tab in the Driver window, select Simulator, and on the Linker Output tab in the Format window, select Other and Output format, select intel-standart, and in the Output file window, change the extension to hex.</i> <br><br><h5>  Work with ports </h5><br>  The first thing to learn in a microcontroller is working with ports.  Let's look at a small example. <br><blockquote><br>  <font color="#339900">#include "msp430f2274.h"</font> <br><br>  <font color="#0000ff">void</font> main <font color="#008000">(</font> <font color="#0000ff">void</font> <font color="#008000">)</font> <br>  <font color="#008000">{</font> <br>  WDTCTL <font color="#000080">=</font> WDTPW <font color="#000040">+</font> WDTHOLD <font color="#008080">;</font> <br><br>  P1DIR <font color="#000040">&amp;</font> <font color="#000080">=</font> ~ BIT2 <font color="#008080">;</font> <br>  P1REN <font color="#000040">|</font>  <font color="#000080">=</font> BIT2 <font color="#008080">;</font> <br><br>  P1DIR <font color="#000040">|</font>  <font color="#000080">=</font> BIT1 <font color="#000040">+</font> BIT0 <font color="#008080">;</font> <br><br>  <font color="#0000ff">while</font> <font color="#008000">(</font> <font color="#0000ff">true</font> <font color="#008000">)</font> <br>  <font color="#008000">{</font> <br>  <font color="#0000ff">if</font> <font color="#008000">(</font> P1IN <font color="#000040">&amp;</font> BIT2 <font color="#008000">)</font> <br>  <font color="#008000">{</font> <br>  P1OUT <font color="#000040">|</font>  <font color="#000080">=</font> BIT1 <font color="#008080">;</font> <br>  P1OUT <font color="#000040">&amp;</font> <font color="#000080">=</font> ~ BIT0 <font color="#008080">;</font> <br>  <font color="#008000">}</font> <br>  <font color="#0000ff">else</font> <br>  <font color="#008000">{</font> <br>  P1OUT <font color="#000040">|</font>  <font color="#000080">=</font> BIT0 <font color="#008080">;</font> <br>  P1OUT <font color="#000040">&amp;</font> <font color="#000080">=</font> ~ BIT1 <font color="#008080">;</font> <br>  <font color="#008000">}</font> <br>  <font color="#008000">}</font> <br>  <font color="#008000">}</font> <br></blockquote><br><br>  <b>PxDIR</b> is responsible for the direction of port 1. When a specific bit of this register is set to 0, the corresponding pin works as input.  Conversely, if the corresponding bit is set to 1, then the pin works on the output.  In the example, there are 3 pins: P1.2 - button, P1.0 - red LED, P1.1 - green LED. <br><br>  <b>PxREN</b> includes an internal <b>pull-</b> up resistor.  The button closes the pin to the ground, and, accordingly, puts it in the zero state.  When the button is not pressed, the pin is not connected to anything and in order to provide a logical unit on it, it is required to connect it via a resistor to the power supply, which is what the P1REN register does. <br><br>  <b>PxIN</b> and <b>PxOUT</b> contain the status of the port pins.  By setting zero or one in the PxOUT register, we change the voltage on the microcontroller's foot, thereby turning the LED on and off.  Reading a specific bit from the PxIN register, we get a logical signal, which is now fed to the pin. <br><br>  <b>PxSEL</b> selects pin function.  In the datasheet on the image of the microcontroller, functions are usually indicated by the sign ‚Äú/‚Äù. <br><img src="https://habrastorage.org/storage2/f24/7e2/3e6/f247e23e64a428a28fc9112ed497f474.png"><br>  For example, in Figure P2.7 it works like a normal pin if P2SEL has 0 in the corresponding digit.  By default, in this case, the unit is set there, which means that this foot is intended to connect an external watch crystal. <br><br>  The constants <b>BIT0..BITF</b> are contained in the file msp430f2274.h and are 16-bit words in a given digit which contain 1, all other digits contain 0. <br><br>  <i>It should be noted that the msp430f2274.h file contains a lot of useful information.</i>  <i>There are all the constants of the controller with comments in English.</i> <br><br>  In the example, bitwise C operations are used, ‚Äú| =‚Äù will set the bit corresponding to the value on the right in the register to the left into one, and ‚Äú&amp; = ~‚Äù will set it to 0. <br><br>  What happened: <br><br><iframe width="420" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/kHYrAAgZ_q4%3Ffeature%3Doembed&amp;xid=17259,15700022,15700186,15700190,15700253,15700255,15700259&amp;usg=ALkJrhgkEk145weAlczcCCC8kvSVlKTckg" frameborder="0" allowfullscreen=""></iframe><br><br><h5>  Work with SPI </h5><br>  Immediately start with an example <br><blockquote><br>  <font color="#339900">#include "msp430f2274.h"</font> <br><br>  <font color="#0000ff">unsigned</font> <font color="#0000ff">char</font> spi <font color="#008000">(</font> <font color="#0000ff">unsigned</font> <font color="#0000ff">char</font> data, <font color="#0000ff">unsigned</font> <font color="#0000ff">char</font> dataEx <font color="#000080">=</font> <font color="#208080">0x00</font> <font color="#008000">)</font> <font color="#008080">;</font> <br><br>  <font color="#0000ff">void</font> main <font color="#008000">(</font> <font color="#0000ff">void</font> <font color="#008000">)</font> <br>  <font color="#008000">{</font> <br>  WDTCTL <font color="#000080">=</font> WDTPW <font color="#000040">+</font> WDTHOLD <font color="#008080">;</font> <br><br>  P1DIR <font color="#000040">|</font>  <font color="#000080">=</font> BIT0 <font color="#000040">+</font> BIT1 <font color="#008080">;</font> <br>  P1OUT <font color="#000040">&amp;</font> <font color="#000080">=</font> ~ BIT0 <font color="#008080">;</font> <br>  P1OUT <font color="#000040">&amp;</font> <font color="#000080">=</font> ~ BIT1 <font color="#008080">;</font> <br><br>  P3SEL <font color="#000080">=</font> BIT1 <font color="#000040">+</font> BIT2 <font color="#000040">+</font> BIT3 <font color="#008080">;</font> <br>  P3DIR <font color="#000040">|</font>  <font color="#000080">=</font> BIT0 <font color="#008080">;</font> <br>  P3OUT <font color="#000040">|</font>  <font color="#000080">=</font> BIT0 <font color="#008080">;</font>  <font color="#666666">// Disable the CC2500 (set 1 to CS)</font> <br><br>  P2SEL <font color="#000040">&amp;</font> <font color="#000080">=</font> ~ BIT6 <font color="#008080">;</font> <br>  P2SEL <font color="#000040">&amp;</font> <font color="#000080">=</font> ~ BIT7 <font color="#008080">;</font> <br>  P2DIR <font color="#000040">|</font>  <font color="#000080">=</font> BIT6 <font color="#000040">+</font> BIT7 <font color="#008080">;</font> <br>  P2OUT <font color="#000040">|</font>  <font color="#000080">=</font> BIT6 <font color="#008080">;</font>  <font color="#666666">// Turn off the temperature sensor (also connected to SPI)</font> <br>  P2OUT <font color="#000040">|</font>  <font color="#000080">=</font> BIT7 <font color="#008080">;</font>  <font color="#666666">// Disable Accelerometer</font> <br><br><br>  <font color="#666666">// Configure SPI</font> <br>  UCB0CTL0 <font color="#000040">|</font>  <font color="#000080">=</font> UCMSB <font color="#000040">+</font> UCMST <font color="#000040">+</font> UCSYNC <font color="#008080">;</font> <br>  UCB0CTL1 <font color="#000040">|</font>  <font color="#000080">=</font> UCSSEL_2 <font color="#008080">;</font> <br>  UCB0BR0 <font color="#000080">=</font> <font color="#208080">0x02</font> <font color="#008080">;</font> <br>  UCB0BR1 <font color="#000080">=</font> <font color="#0000dd">0</font> <font color="#008080">;</font> <br>  UCB0CTL1 <font color="#000040">&amp;</font> <font color="#000080">=</font> ~ UCSWRST <font color="#008080">;</font> <br><br>  <font color="#0000ff">if</font> <font color="#008000">(</font> spi <font color="#008000">(</font> <font color="#208080">0x8F</font> <font color="#008000">)</font> <font color="#000080">==</font> <font color="#208080">0x32</font> <font color="#008000">)</font> <br>  <font color="#008000">{</font> <br>  P1OUT <font color="#000040">|</font>  <font color="#000080">=</font> BIT1 <font color="#008080">;</font>  <font color="#666666">// Red LED</font> <br>  <font color="#008000">}</font> <br>  P1OUT <font color="#000040">|</font>  <font color="#000080">=</font> BIT0 <font color="#008080">;</font>  <font color="#666666">// Green LED</font> <br>  <font color="#008000">}</font> <br><br>  <font color="#0000ff">unsigned</font> <font color="#0000ff">char</font> spi <font color="#008000">(</font> <font color="#0000ff">unsigned</font> <font color="#0000ff">char</font> data, <font color="#0000ff">unsigned</font> <font color="#0000ff">char</font> dataEx <font color="#008000">)</font> <br>  <font color="#008000">{</font> <br>  <font color="#0000ff">unsigned</font> <font color="#0000ff">char</font> RX <font color="#008080">;</font> <br><br>  P2OUT <font color="#000040">&amp;</font> <font color="#000080">=</font> ~ BIT7 <font color="#008080">;</font>  <font color="#666666">// Turn On Accelerometer</font> <br><br>  <font color="#0000ff">while</font> <font color="#008000">(</font> <font color="#000040">!</font> <font color="#008000">(</font> IFG2 <font color="#000040">&amp;</font> UCB0TXIFG <font color="#008000">)</font> <font color="#008000">)</font> <font color="#008080">;</font>  <font color="#666666">// Waiting for send buffer</font> <br>  UCB0TXBUF <font color="#000080">=</font> data <font color="#008080">;</font> <br>  <font color="#0000ff">while</font> <font color="#008000">(</font> <font color="#000040">!</font> <font color="#008000">(</font> IFG2 <font color="#000040">&amp;</font> UCB0RXIFG <font color="#008000">)</font> <font color="#008000">)</font> <font color="#008080">;</font>  <font color="#666666">// Waiting for receive buffer</font> <br>  RX <font color="#000080">=</font> UCB0RXBUF <font color="#008080">;</font> <br><br>  <font color="#0000ff">while</font> <font color="#008000">(</font> <font color="#000040">!</font> <font color="#008000">(</font> IFG2 <font color="#000040">&amp;</font> UCB0TXIFG <font color="#008000">)</font> <font color="#008000">)</font> <font color="#008080">;</font> <br>  UCB0TXBUF <font color="#000080">=</font> dataEx <font color="#008080">;</font> <br>  <font color="#0000ff">while</font> <font color="#008000">(</font> <font color="#000040">!</font> <font color="#008000">(</font> IFG2 <font color="#000040">&amp;</font> UCB0RXIFG <font color="#008000">)</font> <font color="#008000">)</font> <font color="#008080">;</font> <br>  RX <font color="#000080">=</font> UCB0RXBUF <font color="#008080">;</font> <br><br>  P2OUT <font color="#000040">|</font>  <font color="#000080">=</font> BIT7 <font color="#008080">;</font> <br><br>  <font color="#0000ff">return</font> RX <font color="#008080">;</font> <br>  <font color="#008000">}</font> </blockquote><br>  In the example, the register value is requested at the address 0x8F, it contains a code that identifies the device.  This code is listed in the datasheet.  This ensures that the data is exchanged.  If successful, turn on the red LED. <br>  Accordingly, all other devices connected to the SPI must be disconnected from the interface.  For this, the CS on them is set to one. <br><br><h4>  Conclusion </h4><br>  Next time I will try to tell you more about working with LIS331DLH, get to interrupts, work with the USB-UART bridge built into the programmer and tell you a little about watchdog. <br><br>  I hope this article has been helpful to you, reader. </div><p>Source: <a href="https://habr.com/ru/post/137205/">https://habr.com/ru/post/137205/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../137199/index.html">Atoms, neurons, internet and aliens</a></li>
<li><a href="../137201/index.html">OpenCart Forum</a></li>
<li><a href="../137202/index.html">A sign of waiting for an Ajax response on Habr√© is, but not used</a></li>
<li><a href="../137203/index.html">Uppza - use feedback to the fullest!</a></li>
<li><a href="../137204/index.html">Facebook may hold IPO next week</a></li>
<li><a href="../137206/index.html">Python lessons from Google</a></li>
<li><a href="../137208/index.html">Locum + Capistrano + git on Windows: A Little Placement Adventure</a></li>
<li><a href="../137211/index.html">How to cook HDD</a></li>
<li><a href="../137213/index.html">Google offers to standardize form auto-completion.</a></li>
<li><a href="../137214/index.html">FreeNAS 7 (0.7.x) officially stops development today?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>