<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Yii connection many to many</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introduction 
 Hi, Habr! Many probably faced the need to implement many-to-many communication functionality in Yii. It would seem that there is nothin...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Yii connection many to many</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/bcd/a02/ff7/bcda02ff74595ced049aaf1b04e83f6c.png" alt="many-to-many"><br><br><h4>  Introduction </h4><br>  Hi, Habr!  Many probably faced the need to implement many-to-many communication functionality in Yii.  It would seem that there is nothing complicated here, and most likely the developers of the framework have already tried to implement the necessary communication functionality for us, and we just need to prescribe the necessary connections in the model, and using the usual methods, save the data. <br><a name="habracut"></a><br>  But Yii doesn‚Äôt provide such functionality, it seems that such an opportunity will appear in later versions or will be expanded only with additional extensions.  As a result, we have to implement the connection ourselves. <br>  Of course, everyone wriggles out as they can, someone uses extensions that have shown themselves well in battle.  For example: with-related-behavior <a href="https://github.com/yiiext/with-related-behavior">project repository</a> <br>  Someone writes a link directly in the method when saving or updating data.  But this approach has a big minus.  When there are a lot of connections between entities in a project, it is necessary to duplicate the code in the methods, which will further affect the fall in readability and its support. <br>  But what if there are a lot of entities and you need to bind a lot of data? <br>  We will try to write a simple implementation, which, if necessary, can be easily rewritten and later supported in your project. <br><br><h4>  Some theory </h4><br>  With a many-to-many relationship type, a record from one table is associated with several records of another table, and a record from the second table is associated with several records in the first table. <br>  This type of relationship requires the creation of a third table, called a pivot table.  The pivot table contains the primary keys of the first two tables as foreign keys. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Implementation </h4><br>  Take as an example the task in which a product can be made from several materials: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/b4b/8e4/9d4/b4b8e49d494da4dbb7fd3cc0d70f3eb1.png" alt="many-to-many"><br>  Here is the migration of the ProductMaterial summary entity, to which foreign keys on the Product and Material entities are added: <br><br><pre><code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">#protected/migrations/m140314_091505_addProductMaterialTable.php class m140314_091505_addProductMaterialTable extends CDbMigration { public function safeUp() { $prefix = $this-&gt;getDbConnection()-&gt;tablePrefix; $this-&gt;createTable('{{productMaterial}}', array( 'id' =&gt; 'int(10) unsigned NOT NULL AUTO_INCREMENT', 'productId' =&gt; 'int(10) unsigned NOT NULL', 'materialId' =&gt; 'int(10) unsigned NOT NULL', 'PRIMARY KEY (`id`)', ), 'ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT=\'style (to which productMaterial should belong)\';'); $this-&gt;addForeignKey($prefix.'productMaterial_product_fk_constraint', '{{productMaterial}}', 'productId', '{{product}}', 'id', 'RESTRICT', 'CASCADE'); $this-&gt;addForeignKey($prefix.'productMaterial_material_fk_constraint', '{{productMaterial}}', 'materialId', '{{material}}', 'id', 'RESTRICT', 'CASCADE'); } }</span></span></code> </pre> <br>  Now we describe the behavior that will preserve, and add, and change our connections: <br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">#protected/extensions/ManyToManyRelationBehavior.php class ManyToManyRelationBehavior extends CBehavior{ /** * @var string name model Relation */ public $modelNameRelation; /** * @var string field name for the relationship with the current models */ public $fieldNameModelCurrent = null; /** * @var string field name for the relationship with the external models */ public $fieldNameModelRelation = null; /** * @var array list of values ‚Äã‚Äãof the current model */ public $relationList = array(); public function events() { return array_merge(parent::events(), array( 'onAfterSave' =&gt; 'afterSave', )); } public function afterSave($event){ if (is_array($this-&gt;relationList)){ $model = $this-&gt;modelNameRelation; $delete = $model::model()-&gt;deleteAll("{$this-&gt;fieldNameModelCurrent} =:param", array( ":param" =&gt; $this-&gt;owner-&gt;id, )); foreach ($this-&gt;relationList as $value){ $model = new $this-&gt;modelNameRelation; $model-&gt;{$this-&gt;fieldNameModelRelation} = intval($value); $model-&gt;{$this-&gt;fieldNameModelCurrent} = $this-&gt;owner-&gt;id; if (!$model-&gt;save()){ Yii::log('Unable to save relation: '.serialize($model-&gt;getErrors()), 'warning'); return false; } } } return true; } }</span></span></code> </pre><br>  An example of using behavior when creating a new product: <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">actionCreate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $model=<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Product; $materialList = $_POST[<span class="hljs-string"><span class="hljs-string">'Product'</span></span>][<span class="hljs-string"><span class="hljs-string">'materialId'</span></span>]; $model-&gt;attachBehavior(<span class="hljs-string"><span class="hljs-string">'ManyToManyRelationBehavior'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'class'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'ext.ManyToManyRelationBehavior'</span></span>, <span class="hljs-string"><span class="hljs-string">'modelNameRelation'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'ProductMaterial'</span></span>, <span class="hljs-comment"><span class="hljs-comment">//     'fieldNameModelCurrent' =&gt; 'productId',//      Product 'fieldNameModelRelation' =&gt; 'materialId', //      Material 'relationList' =&gt; $materialList, // array id material ));</span></span></code> </pre><br>  To quickly receive materials of goods through the model, add the necessary Relation to the Product model, linking them through the through parameter. <br><br><pre> <code class="php hljs"> <span class="hljs-comment"><span class="hljs-comment">#protected/models/Product.php public function relations() { return $this-&gt;moderationRelations(array( 'materialAll' =&gt; array(self::HAS_MANY, 'ProductMaterial', 'productId'), 'materialRelation' =&gt; array(self::HAS_MANY, 'Material', 'materialId', 'through' =&gt; 'materialAll'), )); }</span></span></code> </pre><br>  Now the materials of the goods can be obtained simply: <br><br><pre> <code class="php hljs">$model = Material::model()-&gt;findByPk($pk); $model-&gt;materialAll;</code> </pre><br><h4>  Conclusion </h4><br>  It is clear that the developers of Yii can not include in the framework all the functionality that may be required.  But they gave us a great opportunity to easily write extensions with transparent access to them that can be transferred from one project to another.  It is also not always convenient to take existing extensions.  You can spend a lot of time studying them and finalizing the functional.  During this time, you can write your own implementation, which in the future is easy to maintain and refine. <br><br>  <a href="https://github.com/yuzic/ManyToManyRelation">Behavior repository</a> </div><p>Source: <a href="https://habr.com/ru/post/216605/">https://habr.com/ru/post/216605/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../216591/index.html">Useful for Android developer from Github</a></li>
<li><a href="../216597/index.html">The defeat of robots: the ups and downs of high-frequency trading (Part 2)</a></li>
<li><a href="../216599/index.html">Short life and one game adventures</a></li>
<li><a href="../216601/index.html">We ride the floppy and study the promising router. (In this article, not a single TP-Link MR3020 and TL-WR703N were injured, and HAME MPR A100 (A2) got off lightly)</a></li>
<li><a href="../216603/index.html">Oculus presented the Rift Development Kit 2 at the GDC 2014 conference</a></li>
<li><a href="../216609/index.html">The history of the creation of a torrent render for 3ds max</a></li>
<li><a href="../216615/index.html">Cubieboard A10. Learning to control the system from a remote control</a></li>
<li><a href="../216619/index.html">Volvo makes sure you don't fall asleep</a></li>
<li><a href="../216621/index.html">Competition from Veeam! The main prize is a $ 25,000 round-the-world trip for two, and not only</a></li>
<li><a href="../216623/index.html">Managing JavaScript UI stream using WinJS scheduler</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>