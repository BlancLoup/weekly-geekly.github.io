<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Failover Service with CARP</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Brief introduction 
 About the protocol itself is very well written in Wikipedia. Who are interested in the details and history - there . In a few wor...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Failover Service with CARP</h1><div class="post__text post__text-html js-mediator-article"><h4>  Brief introduction </h4><br>  About the protocol itself is very well written in Wikipedia.  Who are interested in the details and history - <a href="http://en.wikipedia.org/wiki/Common_Address_Redundancy_Protocol">there</a> .  In a few words about it you can say this: it is a redundancy protocol that allows two or more computers on the same subnet to have the same IP address at the same time, while setting up this group of computers interchangeably is possible (the main computer has disconnected / broken - instead the same is taken for the work of another, whose priority is higher) and so on in a circle, thus ensuring almost 100% availability of services.  ARP is native to OpenBSD, FreeBSD, and NetBSD.  On Linux with a kernel above 2.4 is available through ucarp. <br><br>  A little messy, but in the future, I hope, the situation will become clearer. <br><a name="habracut"></a><br><h4>  Environment </h4><br>  For this description, I used Debian GNU / Linux 4.0 under VMWare ESX.  We will test the Apache web server service. <br><br><h4>  Start.  Installation </h4><br>  The first thing we put ucarp.  Under debian everything is very simple: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <blockquote><code>apt-get install ucarp</code> </blockquote> <br><br>  The installation of the sorcers should not cause too much difficulty. <br><br><blockquote> <code><a href=""></a> wget download.pureftpd.org/pub/ucarp/ucarp-1.2.tar.bz2 <br> tar jxf ucarp-1.2.tar.bz2 <br> cd ucarp-1.2 <br> ./configure <br> make <br> make install</code> </blockquote> <br><br>  At the same time we put a web server <br><br><blockquote> <code>apt-get install apache2</code> </blockquote> <br><br><h4>  UCARP Configuration </h4><br>  The main part of the configuration is common for both the master and the slave (we will look at the differences separately) <br><br>  First of all, we will create a .conf file in which we will write the parameters for the start of ucarp and the configuration of virtual interfaces <br><br><blockquote> <code>mkdir /etc/ucarp <br> touch /etc/ucarp/ucarp.conf</code> </blockquote> <br><br>  /etc/ucarp/ucarp.conf: <br><br><blockquote> <code>#      ucarp <br> UCARP_INTERFACE=eth0 <br> <br> #       ip  <br> UCARP_IF_ALIAS=eth0:0 <br> <br> #  ip .       . <br> UCARP_SRCIP=172.16.0.11 <br> <br> # CARP ID   <br> UCARP_VHID=1 <br> <br> #    ,  . <br> #   ,     <br> UCARP_ADVBASE=1 <br> <br> #   hmac   ( sha1). <br> UCARP_PASS=geheim <br> <br> #  ip      <br> UCARP_ADDR=172.16.0.1 <br> <br> #     <br> UCARP_MASK=255.255.0.0 <br> <br> #        /  <br> UCARP_UPSCRIPT=/etc/ucarp/ucarp-up.sh <br> UCARP_DOWNSCRIPT=/etc/ucarp/ucarp-down.sh</code> </blockquote> <br><br>  Now it's time to write scripts that will raise the virtual interface when management (master status) will go to the current host and vice versa. <br><br><blockquote> <code>cd /etc/ucarp <br> touch ./ucarp-up.sh <br> touch ./ucarp-down.sh</code> </blockquote> <br><br>  /etc/ucarp/ucarp-up.sh <br><br><blockquote> <code>#!/bin/bash <br> source /etc/ucarp/ucarp.conf <br> ifconfig $UCARP_IF_ALIAS $UCARP_ADDR netmask $UCARP_NETMASK</code> </blockquote> <br><br>  /etc/ucarp/ucarp-down.sh <br><br><blockquote> <code>#!/bin/bash <br> source /etc/ucarp/ucarp.conf <br> ifconfig $UCARP_IF_ALIAS down</code> </blockquote> <br><br>  ucarp-up.sh will be launched when the node is activated.  Parameters for alias, virtual interface, address and mask are taken from the ucarp.conf file.  As soon as the node loses master status, ucarp-down.sh is launched and the virtual interface is disabled. <br><br>  The next step is to create a script for running UCARP itself (alternatively, you can create an init script).  The script is called start.sh and put in / etc / ucarp. <br><br><blockquote> <code>source /etc/ucarp/ucarp.conf <br> <br> ucarp / <br> --interface=$UCARP_INTERFACE / <br> --srcip=$UCARP_SRCIP / <br> --vhid=$UCARP_VHID / <br> --pass=$UCARP_PASS / <br> --advbase=$UCARP_ADVBASE / <br> --preempt / <br> --addr=$UCARP_ADDR / <br> --daemonize / <br> --upscript=$UCARP_UPSCRIPT / <br> --downscript=$UCARP_DOWNSCRIPT</code> </blockquote> <br><br>  The first line connects our config ucarp.conf, all variables are taken from there.  The --daemonize option starts UCARP in daemon mode.  Important is the option --preemt which will be present only for the wizard.  The final step is to make our scripts run from under the root. <br><br><blockquote> <code>chmod 0700 /etc/ucarp/*.sh</code> </blockquote> <br><br>  To start testing, I cloned MasterVm and made changes to the following parameters. <br><br>  - ip address <br>  - Hostname <br>  - UCARP_SRCIP in /etc/ucarp/ucarp.conf <br><br>  also in the /var/www/apache2-default/index.html file I specified the server name in order to know which node I‚Äôd hit. <br><br><h4>  Go </h4><br>  We start the master and the slave using the /etc/ucarp/start.sh script.  Since we specified the --daemonize parameter, no messages will be displayed.  Through ifconfig on the wizard, we see the running virtual interface: <br><br><pre>  eth0 Link encap: Ethernet HWaddr 00: 22: 15: 6a: 80: d8
           inet addr: 172.16.0.11 Bcast: 172.16.255.255 Mask: 255.255.0.0
           inet6 addr: fe80 :: 250: 56ff: fe82: 352c / 64 
           UP BROADCAST RUNNING MULTICAST MTU: 1500 Metric: 1
           RX packets: 402618 errors: 0 dropped: 0 overruns: 0 frame: 0
           TX packets: 9019 errors: 0 dropped: 0 overruns: 0 carrier: 0
           collisions: 0 txqueuelen: 1000
           RX bytes: 34064624 (32.4 MiB) TX bytes: 623570 (608.9 KiB)
           Interrupt: 177

 eth0: 0 Link encap: Ethernet HWaddr 00: 22: 15: 6a: 80: d8
           inet addr: 172.16.0.1 Bcast: 172.20.255.255 Maske: 255.255.0.0
           UP BROADCAST RUNNING MULTICAST MTU: 1500 Metric: 1
           Interrupt: 177 </pre><br><br>  There is no virtual interface on the slave, of course not, it will only be launched when the master status is transferred.  The status of the ucap node is written to / var / log / syslog.  It looks like this: <br><br>  On the master: <br><br><blockquote> <code>Nov 26 03:49:17 vmdebian01 ucarp[2327]: [WARNING] Switching to state: MASTER <br> Nov 26 03:49:17 vmdebian01 ucarp[2327]: [WARNING] Spawning [/etc/ucarp/ucarp-up.sh eth0]</code> </blockquote> <br><br>  On the slave <br><br><blockquote> <code>Nov 26 03:50:24 vmdebian02 ucarp[3802]: [WARNING] Switching to state: BACKUP <br> Nov 26 03:50:24 vmdebian02 ucarp[3802]: [WARNING] Spawning [/etc/ucarp/ucarp-down.sh eth0]</code> </blockquote> <br><br>  When accessing the virtual ip, we find ourselves on server number 1 (running as a master).  When the wizard is disconnected from the network, the slave immediately changes its status and starts the interface that is accessible via the cluster ip / mac.  Reloading the page in the browser shows that we are already number 2 on the server. When the wizard is connected, everything returns to its place. <br><br><h4>  Total </h4><br>  Of course, all of the above is a simplified version of the ucarp configuration.  in real life, you will also have to think about synchronization of the application level, sessions if it is a web server, files in the case of FTP, etc. </div><p>Source: <a href="https://habr.com/ru/post/76610/">https://habr.com/ru/post/76610/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../76596/index.html">How to make a great company</a></li>
<li><a href="../76598/index.html">Netbook with two displays will be available in December.</a></li>
<li><a href="../76599/index.html">App Rejections: directory of applications rejected</a></li>
<li><a href="../76600/index.html">Another blow to spammers</a></li>
<li><a href="../76609/index.html">When you need a lot, really a lot of servers</a></li>
<li><a href="../76611/index.html">Physics on Flash. Box2D Engine</a></li>
<li><a href="../76613/index.html">The late news of the departure of Valery Lanovenko</a></li>
<li><a href="../76619/index.html">Deploying Django Projects with Fabric</a></li>
<li><a href="../76622/index.html">fasten Idea plugins to WebIde</a></li>
<li><a href="../76623/index.html">About a cruel serpent post</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>