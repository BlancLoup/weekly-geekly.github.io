<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Watchdog timer for 4G-modem on CentOS 7</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This article is a supplement to my previous post about setting up a home router / file server. Here we will talk about the problem of automatic reconn...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Watchdog timer for 4G-modem on CentOS 7</h1><div class="post__text post__text-html js-mediator-article">  This article is a supplement to my previous <a href="http://habrahabr.ru/post/273547/">post</a> about setting up a home router / file server.  Here we will talk about the problem of automatic reconnection to the Internet when a 4G modem hangs.  I do not pretend to the originality of the idea, I just want to share my decision with the readers. <br><img src="https://habrastorage.org/files/d7c/477/ed9/d7c477ed972e4803959a0bb3108c53fd.png"><br><a name="habracut"></a><br>  In the process of constant work, about once a month, it happened that the USB modem was hanging.  This gave me a certain inconvenience: the inability to remotely get on the home computer, to pre-load movies.  It was impossible to eliminate this problem remotely; only a modem reboot by power helped.  The only way out was to write a script that at a certain time checks the availability of a node on the Internet and, if necessary, reloads the modem. <br><br>  I found several implementations on the Internet, but not one of them worked normally for me.  Therefore, I decided to write my watchdog timer <a href="http://lurkmore.to/%25D0%2591%25D0%25BB%25D1%258D%25D0%25BA%25D0%25B4%25D0%25B6%25D0%25B5%25D0%25BA_%25D0%25B8_%25D1%2588%25D0%25BB%25D1%258E%25D1%2585%25D0%25B8">with preference and young ladies</a> .  The script was taken from <a href="https://www.linux.org.ru/forum/admin/7985276">this</a> topic.  Rewritten, as far as my qualification allows me, and added new features such as external options. <br><br><div class="spoiler">  <b class="spoiler_title">Installing and configuring a USB 4G modem in CentOS 7.</b> <div class="spoiler_text">  First you need to download the missing packages. <br><pre><code class="bash hljs">yum install usb_modeswitch usb_modeswitch-data</code> </pre> <br>  Connect the modem and see how it is defined in the system. <br><pre> <code class="bash hljs">dmesg ip a</code> </pre><br>  Next, you need to configure the interface 4G modem. <br><pre> <code class="bash hljs">vim /etc/sysconfig/network-scripts/ifcfg-wwp6s0u1i1</code> </pre><br><pre> <code class="bash hljs">DEVICE=<span class="hljs-string"><span class="hljs-string">"wwp6s0u1i1"</span></span> NAME=<span class="hljs-string"><span class="hljs-string">"wwp6s0u1i1"</span></span> TYPE=<span class="hljs-string"><span class="hljs-string">"Ethernet"</span></span> ONBOOT=<span class="hljs-string"><span class="hljs-string">"yes"</span></span> BOOTPROTO=<span class="hljs-string"><span class="hljs-string">"dhcp"</span></span> HWADDR=<span class="hljs-string"><span class="hljs-string">"XX:XX:XX:XX:XX:XX"</span></span> NM_CONTROLLED=<span class="hljs-string"><span class="hljs-string">"no"</span></span> DNS1=127.0.0.1 DNS2=127.0.0.1 DNS3=127.0.0.1 NOZEROCONF=<span class="hljs-string"><span class="hljs-string">"yes"</span></span> IPV4_FAILURE_FATAL=<span class="hljs-string"><span class="hljs-string">"no"</span></span> IPV6INIT=<span class="hljs-string"><span class="hljs-string">"no"</span></span> ZONE=<span class="hljs-string"><span class="hljs-string">"external"</span></span></code> </pre><br>  We create scripts to activate and deactivate the Internet when the interface is turned on or off. <br><pre> <code class="bash hljs">vim /sbin/ifup-pre-local</code> </pre><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash # PREUP="/etc/sysconfig/network-scripts/pre-up-${1:6}" if [ -x $PREUP ]; then exec $PREUP fi</span></span></code> </pre><br><pre> <code class="bash hljs">vim /sbin/ifdown-pre-local</code> </pre><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash # PREDOWN="/etc/sysconfig/network-scripts/pre-down-$1" if [ -x $PREDOWN ]; then exec $PREDOWN fi</span></span></code> </pre><br><pre> <code class="bash hljs">vim /etc/sysconfig/network-scripts/pre-up-wwp6s0u1i1</code> </pre><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash # echo -en 'AT^NDISDUP=1,1,"internet.yota"\r\n' &gt; /dev/ttyUSB0</span></span></code> </pre><br><pre> <code class="bash hljs">vim /etc/sysconfig/network-scripts/pre-down-wwp6s0u1i1</code> </pre><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash # echo -en 'AT^NDISDUP=1,0,"internet.yota"\r\n' &gt; /dev/ttyUSB0</span></span></code> </pre><br>  Here ttyUSB0 is the modem port. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      We raise the interface and check the connection. <br><pre> <code class="bash hljs">ifup wwp6s0u1i1 ip a</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">The script itself</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash export PATH="$PATH:/usr/sbin" SN="$(basename "$0")" function print_help() { printf "\n" printf ": %s options...\n" "$SN" printf ":\n" printf " -s  .\n" printf " -i   .\n" printf " -d     lsusb -t.\n" printf " -n   .\n" printf " -m  ,   lsusb.\n" printf " -h .\n" printf "\n" } #     ,  . if [[ $# = 0 ]]; then print_help &amp;&amp; exit 1 fi while getopts ":s:i:d:n:m:h" opt ; do case $opt in s) SITE=$OPTARG; ;; i) IF=$OPTARG; ;; d) DEV=$OPTARG; ;; n) EP=$OPTARG; ;; m) MM=$OPTARG; ;; h) print_help exit 1 ;; *) printf " \n"; printf "    %s -h\n" "$SN"; exit 1 ;; esac done if [[ "$SITE" == "" ]] || [[ "$IF" == "" ]] || [[ "$DEV" == "" ]] || [[ "$EP" == "" ]] || [[ "$MM" == "" ]] ; then printf "\n" printf "     .\n" printf "  : %s -h\n" "$SN" printf "\n" exit 1 fi M="$(lsusb | grep -w "$MM")" #   lsusb if [[ "$M" != "" ]]; then #  ,    if grep -w -q "$IF" /proc/net/dev; then #    printf "\n" printf "  %s   %s\n" "$SITE" "$IF" printf "\n" if [[ "$EP" -ge 6 ]]; then printf "        5\n" exit 1 else printf " ...\n" flag="0" for i in {1..5}; do # 5    timeout -k 2 -s TERM 16 ping -w 14 -s 8 -c 1 -I "$IF" "$SITE" || flag=$((flag+1)) &amp;&amp; printf ":%s/5 (:%s)\n" "$i" "$flag" #   -   if (("$flag" &gt;= "$EP")); then break else read -r -t 1 &gt; /dev/null fi done printf " : %s  %s\n" "$flag" "$i" printf "\n" if (("$flag" &gt;= "$EP")); then #    2 M="$(lsusb | grep "$MM")" #     -    printf "  :\n" printf "%s\n" "$M" | cut -c 34- if ! [[ -d /sys/bus/usb/drivers/usb/"$DEV" ]]; then printf "  Bus  Port .\n" exit 1 else ifdown "$IF" #  printf "%s" "$DEV" &gt; "/sys/bus/usb/drivers/usb/unbind" &amp;&amp; printf "%s" "$DEV" &gt; "/sys/bus/usb/drivers/usb/bind" #  # read -r -t 1 &gt; /dev/null ifup "$IF" #  fi fi fi else printf "\n" printf " %s  \n" "$IF" printf "\n" exit 1 fi else printf " %s  .\n" "$MM" fi</span></span></code> </pre><br></div></div><br>  The script is located in / usr / local / bin /. <br>  To start the script automatically, every five minutes, add the task to cron. <br><pre> <code class="bash hljs">crontab -e</code> </pre><br><pre> <code class="bash hljs">*/5 * * * * /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/bin/watchdog -m Huawei -s ya.ru -i wwp6s0u2i1 -n 3 -d 1-1 &gt; /dev/null 2&gt;&amp;1</code> </pre><br>  This is the output of dmesg, it shows a modem reset during the execution of the script. <br><pre> <code class="bash hljs">[181709.595498] option1 ttyUSB0: GSM modem (1-port) converter now disconnected from ttyUSB0 [181709.595568] option 1-1:1.0: device disconnected [181709.595798] huawei_cdc_ncm 1-1:1.1 wwp6s0u2i1: unregister <span class="hljs-string"><span class="hljs-string">'huawei_cdc_ncm'</span></span> usb-0000:06:00.0-1, Huawei CDC NCM device [181709.615005] option 1-1:1.0: GSM modem (1-port) converter detected [181709.616597] usb 1-1: GSM modem (1-port) converter now attached to ttyUSB0 [181709.623449] usb 1-1: MAC-Address: 0c:5b:8f:27:9a:64 [181709.623958] huawei_cdc_ncm 1-1:1.1: cdc-wdm0: USB WDM device [181709.624341] huawei_cdc_ncm 1-1:1.1 wwan0: register <span class="hljs-string"><span class="hljs-string">'huawei_cdc_ncm'</span></span> at usb-0000:06:00.0-1, Huawei CDC NCM device, XX:XX:XX:XX:XX:XX</code> </pre><br>  I‚Äôll say right away that the script is very far from ideal, so I‚Äôm happy to accept advice and valid criticism. <br>  Separately, I want to thank the user with <a href="https://toster.ru/">Toster.ru</a> under the nickname <a href="https://toster.ru/user/AlekseyNemiro">@AlekseyNemiro</a> , for their help in optimizing the script. <br><br>  <b>UPD 01.22.16</b> Completed the script with the command to add the path to the PATH variable. </div><p>Source: <a href="https://habr.com/ru/post/275551/">https://habr.com/ru/post/275551/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../275539/index.html">Why is HTTPS not commonly used yet?</a></li>
<li><a href="../275541/index.html">2 ^ 74207281-1 - a prime number</a></li>
<li><a href="../275545/index.html">New interface for getting process attributes in Linux</a></li>
<li><a href="../275547/index.html">Some interesting and useful for all</a></li>
<li><a href="../275549/index.html">Whitelisting with Windows Firewall</a></li>
<li><a href="../275553/index.html">How IaaS provider to choose a data center to host the cloud: IT-GRAD Experience</a></li>
<li><a href="../275555/index.html">We do FTP for Windows Azure Pack</a></li>
<li><a href="../275561/index.html">ASP.NET 5 is dead - introducing ASP.NET Core 1.0 and .NET Core 1.0</a></li>
<li><a href="../275563/index.html">Minimal HTTP Endpoint API using Elixir</a></li>
<li><a href="../275565/index.html">A dangerous 0day vulnerability has been discovered in the Linux kernel.</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>