<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>The inner world of Razor. Part 1 - Recursive Ping Pong</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This is the first article about a new ASP.NET parser - Razor. Over which we worked for a long time, and I would like to tell the readers how it works....">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">🔎</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">📜</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">⬆️</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">⬇️</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>The inner world of Razor. Part 1 - Recursive Ping Pong</h1><div class="post__text post__text-html js-mediator-article"><img align="left" src="http://img685.imageshack.us/img685/8305/mrk37g.jpg" hspace="15">  This is the first article about a new ASP.NET parser - Razor.  Over which we worked for a long time, and I would like to tell the readers how it works. <br><br>  Razor parser is very different from the existing ASPX parser.  In fact, an ASPX parser is almost entirely built on regular expressions, because the syntax is fairly simple to parse.  Razor parser is divided into three components: <br><ol><li>  A markup parser that has a basic understanding of HTML syntax. </li><li>  Parser code that has a basic representation of C # or VB. </li><li>  And the main “conductor” who knows how to put two parsers together. </li></ol><br>  When I say “basic presentation” I mean the basics, we are not talking about a completely independent C # and HTML parser.  In our team, we joke by calling them “Markup Identifier” and “Code Thinking” :) <br><a name="habracut"></a><br>  Total on the stage Razor plays three “actors”: the Core Parser, the Markup Parser and the Code Parser.  All three work together to parse the Razor document.  Now let's take the Razor file and conduct a full review of the parsing procedure using the data from the actors.  We will use the following example: <br><br><img src="http://img638.imageshack.us/img638/7907/capture2q.png">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      So let's start at the top.  In fact, the Razor parser is in one of the states at any moment of parsing: parsing the document markup, parsing the block markup, or parsing the code block.  The first two are processed by the markup parser, and the last by the code parser.  When the kernel parser is launched for the first time, it calls the markup parser and asks it to parse the document markup and return the result.  Now the parser is in the state of parsing document markup.  In this state, it simply searches for the “@” symbol, it doesn’t matter what tags it comes across and all that concerns HTML, the main goal is “@”.  When he found @, he decides - is this a switch to the code or email address?  This solution is based on the symbols before and after @, checking the validity of the email address.  This is just a standard procedure, there is a sequence of checks to switch to code mode. <br><br>  In this case, when we see the first “@” character, it is preceded by a space, which is not valid for an email address.  So we know for sure that we need to switch to code mode.  The markup parser calls inside the code parser and asks to disassemble the code block.  The block, in the definition of the Razor parser, is basically a single piece of code or markup with a clear start and end.  So “foreach” in our case is an example of a block of code.  It starts with the character “f” and ends with “}”.  The code parser knows enough about C # to understand this, so it starts parsing the code.  The code parser does some simple tracing of C # operators, so when it gets to “&lt;li&gt;”, it understands that the tag is at the beginning of the C # expression.  “&lt;Li&gt;” cannot be placed at the beginning of a C # expression, so the code parser knows that the markup block starts from this point.  Therefore, it returns to the call to the parser markup, in order to parse the block of HTML.  This creates a kind of <strong>recursive ping-pong</strong> between code and markup parsers.  We started with the markup, then we called the code inside, then the markup again, and so on, until we got the result of the entire call chain: <br><br><img src="http://img683.imageshack.us/img683/7416/captureezn.png"><br><br>  (Understandably, I have excluded from the list many auxiliary methods :). <br><br>  This sheds light on the fundamental difference between ASPX and Razor.  In aspx files, you can think of code and markup as two parallel threads.  You write markup, then jump over and write code, then come back and write markup, etc.  Razor same files as a tree.  You write the markup, then put the code into it, then put the markup in the code, etc. <br><br>  So, we just called the markup parser to parse the markup block, the block starts with “&lt;li&gt;” and ends with “&lt;/ li&gt;”.  Until we find “&lt;/ li&gt;”, we will not decide that the markup unit is over.  So, if you have “}” somewhere inside “&lt;li&gt;” it will not complete “foreach”, since we have not advanced far enough up the stack. <br><br>  During parsing “&lt;li&gt;”, the markup parser sees a lot of “@” characters, from which there are many calls to the code parser.  Thus the call stack increases: <br><br><img src="http://img200.imageshack.us/img200/5443/capture1lw.png"><br><br>  I will go into the details of processing the blocks later, because the process is a bit complicated, as a result we ended up with these block codes and returned to the “&lt;li&gt;” block.  Next, we see “&lt;/ li&gt;”, so we complete this block and return to the “foreach” block.  “}” Closes the block, so now we're back at the top of the stack — the markup document.  After that, we read until we reach the end of the file, without finding more “@” characters.  And voila!  We parsed this file! " <br><br>  I hope the overall structure of the parsing algorithm is clear.  The main thing is to stop thinking that the code parser and markup work in separate threads, and instead the constructions are located one inside the other.  Hint, inspirational, we drew from PowerShell;). </div><p>Source: <a href="https://habr.com/ru/post/98958/">https://habr.com/ru/post/98958/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../98953/index.html">The iPhone 4 has problems with antenna design, not with the formula</a></li>
<li><a href="../98954/index.html">Making the boot and installation flash drive</a></li>
<li><a href="../98955/index.html">Google's web metric</a></li>
<li><a href="../98956/index.html">Skype about Fring solution</a></li>
<li><a href="../98957/index.html">$ 5 million will be spent on amateur video financing</a></li>
<li><a href="../98959/index.html">Report on the Krasnodar PhotoCamp</a></li>
<li><a href="../98960/index.html">How to create a successful startup in two days? No</a></li>
<li><a href="../98963/index.html">Second Symfony Camp UA - Ended!</a></li>
<li><a href="../98964/index.html">Media Center with your own hands</a></li>
<li><a href="../98966/index.html">Predicting the results of World Cup matches</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>