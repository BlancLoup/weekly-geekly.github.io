<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How we designed themes for Mail</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the summer of 2011, we introduced Mail.Ru Mail. The interface has changed not only visually, but has been completely redone in technical terms, whi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How we designed themes for Mail</h1><div class="post__text post__text-html js-mediator-article">  <i>In the summer of 2011, we introduced Mail.Ru Mail.</i>  <i>The interface has changed not only visually, but has been completely redone in technical terms, which greatly accelerated its speed and convenience.</i>  <i>But it was also necessary to implement a very desirable feature for users - interface themes.</i>  <i>I want to tell about how we introduced topics in the Post in this post.</i> <br><br><img src="https://habrastorage.org/storage2/d45/5ce/bf0/d455cebf0c5706475d716e03dfbdb9bd.jpg"><br><a name="habracut"></a><br>  Just a week before, we completed the translation of the main BEM pages ( <a href="http://bem.github.com/bem-method/pages/beginning/beginning.ru.html">http://bem.github.com/bem-method/pages/beginning/beginning.ru.html</a> ).  It was decided to do thematic mail customization only on CSS.  But pure CSS is not enough, we need a tool for generating CSS - and we chose SASS ( <a href="http://sass-lang.com/">http://sass-lang.com/</a> ). <br><br>  As I wrote above, by the time we started making topics on the Post, the main pages were already translated into independent blocks. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre><code class="hljs">/css /blocks /messages ... /pages main.css</code> </pre> <br><br>  The plus we got right away is the lack of cascadability.  If you repaint a block, you repaint only this block, it doesn't shoot anything anywhere and doesn't explode. <br><br>  The theme is pictures on the background as well as colors (font, background, border ...).  We took block by block and took out the whole color part separately. <br><br><pre> <code class="hljs ruby">/css /blocks /messages /<span class="hljs-regexp"><span class="hljs-regexp">/   /themes</span></span> /default /messages /<span class="hljs-regexp"><span class="hljs-regexp">/     default.scss /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/      default.vars.scss /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/     /theme</span></span> theme.scss /<span class="hljs-regexp"><span class="hljs-regexp">/     theme.vars.scss /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ ‚Äú‚Äù   /pages</span></span> ‚Ä¶</code> </pre><br><br>  Naturally, we needed an assembly system.  SASS approached.  It allows you to collect scss in one large css-file plus allows you to use variables. <br><br>  The styling of one of the blocks is constructed as follows: <br><br><pre> <code class="hljs actionscript">/css/blocks/messages/messages.scss .messages{ padding:<span class="hljs-number"><span class="hljs-number">20</span></span>px; } /css/pages/mail.scss @<span class="hljs-meta"><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">import</span></span></span><span class="hljs-meta"> url(../messages/messages.scss);</span></span> /css/themes/<span class="hljs-keyword"><span class="hljs-keyword">default</span></span>/messages/messages.scss .messages{ background:$messages-background; } /css/blocks/<span class="hljs-keyword"><span class="hljs-keyword">default</span></span>/<span class="hljs-keyword"><span class="hljs-keyword">default</span></span>.scss @<span class="hljs-meta"><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">import</span></span></span><span class="hljs-meta"> url(messages/messages.scss);</span></span></code> </pre><br><br>  In these style files, all css-property values ‚Äã‚Äãare variables that are defined in a particular topic. <br><br><pre> <code class="hljs cpp">/css/themes/theme/theme.vars.scss $messages-background: #FFF; /css/themes/theme/theme.scss @<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">import</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">url</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(theme.vars.scss)</span></span></span></span>; @<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">import</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">url</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(../</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">default</span></span></span></span><span class="hljs-function"><span class="hljs-params">/</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">default</span></span></span></span><span class="hljs-function"><span class="hljs-params">.scss)</span></span></span></span>;</code> </pre><br><br>  After SASS, we get a file with the geometry of all the blocks: <br><br><pre> <code class="hljs">/css/pages/mail.css</code> </pre> <br><br>  and files with color design, broken down by topic: <br><br><pre> <code class="hljs">/css/themes/theme/theme.css;</code> </pre> <br><br>  The user uploads two files - the geometry and styles of the selected theme. <br><br>  <strong>Switch themes</strong> <br><br>  Because  the design is separated from the geometry, there is no need to reload the page to change the design.  All you need to do is load asynchronously the styles of the new theme, and then delete the old ones. <br><br>  To work with themes, a JS-class has been created, the main methods of which we are interested in are setTheme and switchThemeCss. <br><br>  A callback system for asynchronous work with themes built using deferred. <br><br>  The setTheme method is an ‚Äúentry point‚Äù for setting a theme.  Accepts the id of the theme and returns deferred, which expects two methods to be executed: switchThemeCss (changing the styles of the design) and an AJAX request to save the selected theme.  Both of these methods also work with deferred. <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $.when(AJAX.post(...), switchThemeCss(themeId));</code> </pre> <br><br>  The most interesting thing happens inside switchThemeCss.  Based on the passed themeId, the function builds the path to the style file and tries to load it. <br><br>  At this point, the project already used a plugin for loading jquery.getCSS styles, and we decided to use it.  But, unfortunately, it doesn‚Äôt allow us to determine if the styles really loaded, or the request ‚Äúfell off‚Äù by timeout due to the lack of a network connection, which is very important for us, because  deleting the styles of the old theme is necessary only after successfully applying the styles of the new one. <br><br>  We solved this problem with the help of many, probably well-known, but successfully forgotten methods, which consist in the following. <br><br>  A hidden block is added to the page, onto which styles unique for each theme are ‚Äúhung‚Äù.  After downloading the file of styles, we check if the styles of the hidden block have changed, and if they have changed, it means that the theme has been successfully loaded. <br><br>  In our case, 100% uniqueness has a theme id.  But this id has nothing to do with the possible values ‚Äã‚Äãof CSS properties, which means that, in general, styles will not be applied. <br><br>  We needed some property, the value of which can be an arbitrary string.  The content and font-family properties are suitable for this, but with some reservations. <br><br>  Some browsers do not apply the content property to the non-pseudo-elements for which it is intended.  But others do not use the font-family property if such a family does not exist in reality, but at the same time apply the content property.  We decided to use both properties, and in browsers that return the empty value of the content property, look into the font-family property. <br><br>  The result was approximately the following code (schematically): <br><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getApplyedThemeId</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ff = hiddenElement.css(<span class="hljs-string"><span class="hljs-string">'font-family'</span></span>), content = hiddenElement.css(<span class="hljs-string"><span class="hljs-string">'content'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> content || ff; }, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">switchThemeCss</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">themeId</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> url = getThemeCssUrl(themeId) , deferred = newDeferred(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> oldThemeId = getApplyedThemeId(); <span class="hljs-comment"><span class="hljs-comment">//   themeId $.getCSS( url, function(link){ var newThemeId =getApplyedThemeId(); //   themeId //  id   ‚Äì   if (newThemeId !== oldThemeId){ $ThemeCSS.remove(); //    $ThemeCSS = $(link); //   deferred.resolve(); //   } else { //   -    $(link).remove(); //  link    deferred.reject(); //  ‚Äú ‚Äù } } ); }</span></span></code> </pre><br><br>  As a result, we got themes that are easy to maintain.  In addition, their download is easy to manage, and the download code can be used with any interface solution to select topics on any page. <br><br>  The technical implementation, the creation of 12 topics, debugging and production release took 2 months of work by one person. <br><br>  <b>Finally - fun statistics about the most popular topics:</b> <br><br>  Zombies are set mostly by boys 12-25.  And this is the favorite topic of the Mail.ru Mail team :) <br><img src="https://habrastorage.org/storage2/c81/d37/0a9/c81d370a94a9288319fe6008ca0cb7c3.jpg"><br><br>  The game of snowballs keeps leadership in the segment about winter, at the moment it has already been established by more than 300,000 people, 2/3 of whom are women of the fair sex 25-34 <br><img src="https://habrastorage.org/storage2/50e/62c/e6d/50e62ce6dc2a951cd9103bee327843b7.jpg"><br><br>  The most girly theme Anime (girls 12-17 years old) <br><img src="https://habrastorage.org/storage2/d45/5ce/bf0/d455cebf0c5706475d716e03dfbdb9bd.jpg"><br><br>  The most geeky theme is Blackboard.  It can not be turned on from the interface at all!  But you can turn on the cheat link <a href="http://e.mail.ru/cgi-bin/msglist%3Ffolder%3D0%26setTheme%3Dt1026">http://e.mail.ru/cgi-bin/msglist?folder=0&amp;setTheme=t1026</a> <br><br>  Simons Kat - themes for young women 25-34 <br><img src="https://habrastorage.org/storage2/6fa/a69/102/6faa691024889b12bc7e6843f6067490.jpg"><br><br>  PS: Opening the veil of secrecy - in the near future the first two topics will be released for fans of the games Allods and Legend. <br><br>  Andrey Sumin, <br>  client development manager </div><p>Source: <a href="https://habr.com/ru/post/137552/">https://habr.com/ru/post/137552/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../137545/index.html">Come to Kharkov and burn with us at Ciklum Mobile Subbotnik and iPhoneDevCamp 2012</a></li>
<li><a href="../137548/index.html">Fair voting on the Internet using sms</a></li>
<li><a href="../137549/index.html">iPhoneDevCamp 2012 - Kharkiv, February 11</a></li>
<li><a href="../137550/index.html">Canobuvosti, 129th edition</a></li>
<li><a href="../137551/index.html">What else is important to know the inhabitant about patents. We continue the educational program</a></li>
<li><a href="../137554/index.html">Free ebook on agile development methodologies</a></li>
<li><a href="../137557/index.html">The first "StartupDay" in Chelyabinsk</a></li>
<li><a href="../137558/index.html">How to implement the HMVC pattern in Rails</a></li>
<li><a href="../137560/index.html">Android, Huawei and logs</a></li>
<li><a href="../137561/index.html">Testing in Java. Spock framework</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>