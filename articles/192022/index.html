<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Attachment of the link layer ARP-spoofing and how to protect the Cisco switch</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This article is not a guide for kulhackers. Everything written below is part of a Cisco SECURE course study. 
 In this article, I will show how in pra...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Attachment of the link layer ARP-spoofing and how to protect the Cisco switch</h1><div class="post__text post__text-html js-mediator-article">  This article is not a guide for kulhackers.  Everything written below is part of a Cisco SECURE course study. <br>  In this article, I will show how in practice to conduct a data link attack on a Cisco switch, and also show how to protect my network from this.  For the lab stand, I used the Cisco 881 and the Catalyst 3750G. <br>  Probably everyone who has come across a bit with networks knows what ARP is. <br>  Briefly recall.  ARP is used to convert an IP address to a MAC address.  Consider this topology: <br><br><img src="https://habrastorage.org/storage3/7fc/823/f9c/7fc823f9ca793dee8d523a90777c4aed.png"><br><a name="habracut"></a><br>  What happens if you ping the Gateway from the H1 host?  First of all, the ARP protocol will work.  H1 will send a broadcast request (ARP-request), which will indicate the MAC and IP of the H1 host and the recipient IP (GATEWAY).  Then GATEWAY will receive a request and seeing that the recipient's IP field contains its address, appends its MAC to it and sends an ARP-reply reply.  Host H1 receives the answer and puts it into the ARP table. <br><br>  How can I intercept traffic going from H1 to GATEWAY?  Suppose an attacker (ATTACKER) is in the same broadcast domain as GATEWAY and H1.  If an attacker launches a sniffer, for example, Wireshark, then he will not see anything interesting in the sniffer, except for his broadcasts and other proprietary information.  You can use ARP weaknesses to intercept traffic.  This protocol has no protection, no authentication requests.  And it is also possible to send ARP responses without ARP requests, this is the so-called gratuitous-ARP. <br>  This is just what you need.  We will use Cain &amp; Abel software for the attack, but first we will look at the ARP tables on the H1 host and on ATTACKER: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      H1 ARP table <br><br><img src="https://habrastorage.org/storage3/7d5/e36/042/7d5e3604276d40a406850909e56a63b7.png"><br><br>  ATTACKER ARP table <br><br><img src="https://habrastorage.org/storage3/fc2/dda/c47/fc2ddac47d508754921492f4a6496095.png"><br><br>  Next, run Cain &amp; Abel, turn on the sniffer and add all the hosts from the broadcast domain. <br><br><img src="https://habrastorage.org/storage3/213/918/c2b/213918c2b1894836cf4501e96b111365.png"><br><br>  Next, go to the ARP tab, click + and select the gateway address and the host from which we will intercept traffic. <br><br><img src="https://habrastorage.org/storage3/867/bb3/137/867bb31378c435416111f380d2435876.png"><br><br>  We press the ARP-poisoning button and the process of changing the ARP table on the H1 host has started. <br><br><img src="https://habrastorage.org/storage3/3cb/ef3/61a/3cbef361add08c381200e4b9763b55c1.png"><br><br>  Now let's see how the ARP table has changed on the H1 host. <br><br><img src="https://habrastorage.org/storage3/4cb/872/c23/4cb872c2386f8916c7d20e8e70824332.png"><br><br>  We see the substitution of the MAC address for IP 192.168.1.1 <br><br>  Now we will run putty on the H1 host and try to access GATEWAY via the insecure telnet protocol.  Since the telnet protocol transmits data in plain text, the attacker in the sniffer will have to see all the necessary information, that is, the login and password.  Go and enter the login / password and password enable. <br><br><img src="https://habrastorage.org/storage3/322/d0c/0d7/322d0c0d789d498d3d5b4b117fe74a4f.png"><br><br>  Now on ATTACKER in sniffer, Passwords tab.  It can be seen that some information caught <br><br><img src="https://habrastorage.org/storage3/edc/f53/5ad/edcf535adc20370f5f98f671e7f682de.png"><br><br>  We look at this entry and see the text of this content: <br><blockquote>  ============================================ <br>  === Cain's Telnet sniffer generated file === <br>  ============================================ <br>  ya ya yae yae <br><br>  User Access Verification <br><br>  Username: ya ya ya ya'yae ya ya ya P P yar yu yaryayu ya y y XTERMyarya y yay $ admin <br><br>  Password: cisco <br><br>  Router&gt; eennaa <br><br>  Password: Cisco <br></blockquote><br><br>  Everything.  Password from telnet intercepted. <br><br>  And now the most important thing.  How to protect your network from such attacks.  We come to the aid of the tool Dynamic ARP Inspection (DAI). <br>  DAI is designed to adjust ARP requests, that is, decides which ones to skip and which ones to drop.  Roughly speaking, DAI fully protects the network from ARP-spoofing attacks, which occur at the link level, due to the unprotectedness of the ARP protocol. <br>  A little bit about how DAI works.  In order for this mechanism to work, we need to use DHCP on the network and DHCP snooping must be enabled on the switch.  If the network uses static addressing, then DAI will not work. <br>  How does DHCP snooping work?  Suppose we have a DHCP server configured for GATEWAY.  The ATTACKER attacker decided to raise his dhcp server and distribute some of his addresses.  DHCP snooping is designed to adjust requests and will discard requests from the attacker's server.  Everything is very simple.  There are Untrusted and Trusted ports.  With a reliable port, we assign the port that leads to GATEWAY, since we will have it as an authorized DHCP server.  All other ports will be unreliable and server requests from them will be dropped. <br><br><img src="https://habrastorage.org/storage3/750/42c/e8c/75042ce8cad967c207fd22afdbc2aaef.png"><br><br>  At the same time, a dchp snooping database address matching table is built.  We turn on the SW switch DHCP snooping function <br><br> <code>ip dhcp snooping vlan 1</code> <br> <br> <code>ip dhcp snooping database flash:/dhcp-snoop.db</code> <br> <code>ip dhcp snooping</code> <br> <br>  On the port looking towards GATEWAY <br><br> <code>SW(config-if)# ip dhcp snooping trust <br> <br></code> <br><br>  We look what happened <br><br><blockquote>  SW # sh ip dhcp snooping <br>  Switch DHCP snooping is enabled <br>  DHCP snooping is configured on the following VLANs: <br>  one <br>  DHCP snooping is configured on the following Interfaces: <br>  Insertion of option 82 is enabled <br>  circuit-id format: vlan-mod-port <br>  remote-id format: MAC <br>  Option 82 on untrusted port is not allowed <br>  Verification of hwaddr field is enabled <br>  Interface Trusted Rate limit (pps) <br>  - - - FastEthernet1 / 0/47 yes unlimited </blockquote><br><br>  And see what appears in the correspondence table. <br><br><blockquote>  SW # sh ip dhcp snooping binding <br>  MacAddress IpAddress Lease (sec) Type VLAN Interface <br><br>  - - - - - - E8: 03: 9A: BE: 0C: D8 192.168.1.50 26268 dhcp-snooping 1 FastEthernet1 / 0/13 <br>  50: B7: C3: 78: B4: 1A 192.168.1.10 69421 dhcp-snooping 1 FastEthernet1 / 0/1 <br>  Total number of bindings: 2 </blockquote><br><br><br>  Now, if an attacker wants to become a dhcp server, his switch will discard requests. <br><br>  Based on the dhcp snooping database, which contains the correspondence of all MAC and IP addresses and the Dynamic ARP Inspection mechanism will work. <br><br>  Let's go to the setting.  On the Cisco switch, this tool is enabled for each vlan separately.  In our case, it is enough to give the command on the SW switch: <br> <code>SW(config)#ip arp inspection vlan 1</code> <br> <br>  Both the host and the gateway are in vlan 1. DAI for switch ports has two settings: Trusted and Untrusted.  By default, all switch ports <br>  Untrusted, that is unreliable.  The port that goes to the gateway or the port to which another switch is connected to the trunk can be made Trusted, then ARP requests coming through it will be considered reliable. <br><br> <code>SW(config-if)#ip arp inspection trust</code> <br> <br>  Now repeat the attack from the beginning.  We try to do ARP-poisoning through Cain &amp; Abel.  The attack fails and the following entries appear in the switch logs: <br><br><blockquote>  18:11:19:% SW_DAI-4-DHCP_SNOOPING_DENY: 1 Invalid ARPs (Req) on Fa1 / 0/1, vlan 1. ([50b7.c378.b41a / 192.168.1.10 / 0000.0000.0000 / 192.168.1.1 / 18 : 11: 19 UTC Mon Mar 1 1993]) <br>  18:11:19:% SW_DAI-4-DHCP_SNOOPING_DENY: 1 Invalid ARPs (Res) on Fa1 / 0/1, vlan 1. ([50b7.c378.b41a / 192.168.1.10 / 001d.4641.02b4 / 192.168.1.1 / 18:11:19 UTC Mon Mar 1 1993]) <br>  18:11:19:% SW_DAI-4-DHCP_SNOOPING_DENY: 1 Invalid ARPs (Res) on Fa1 / 0/13, vlan 1. ([e803.9abe.0cd8 / 192.168.1.1 / 50b7.c378.b41a / 192.168.1.10 (18: 11: 19 UTC Mon Mar 1 1993]) <br>  18:11:19:% SW_DAI-4-DHCP_SNOOPING_DENY: 1 Invalid ARPs (Res) on Fa1 / 0/13, vlan 1. ([e803.9abe.0cd8 / 192.168.1.10 / 001d.4641.02b4 / 192.168.1.1 / 18:11:19 UTC Mon Mar 1 1993]) <br>  18:11:21:% SW_DAI-4-DHCP_SNOOPING_DENY: 1 Invalid ARPs (Res) on Fa1 / 0/1, vlan 1. ([50b7.c378.b41a / 192.168.1.10 / 001d.4641.02b4 / 192.168.1.1 / 18:11:21 UTC Mon Mar 1 1993]) <br>  18:11:21:% SW_DAI-4-DHCP_SNOOPING_DENY: 1 Invalid ARPs (Res) on Fa1 / 0/13, vlan 1. ([e803.9abe.0cd8 / 192.168.1.1 / 50b7.c378.b41a / 192.168.1.10 (18: 11: 21 UTC Mon Mar 1 1993]) <br>  18:11:21:% SW_DAI-4-DHCP_SNOOPING_DENY: 1 Invalid ARPs (Res) on Fa1 / 0/13, vlan 1. ([e803.9abe.0cd8 / 192.168.1.10 / 001d.4641.02b4 / 192.168.1.1 / 18:11:21 UTC Mon Mar 1 1993]) <br>  18:11:24:% SW_DAI-4-DHCP_SNOOPING_DENY: 1 Invalid ARPs (Req) on Fa1 / 0/1, vlan 1. ([50b7.c378.b41a / 192.168.1.10 / 001d.4641.02b4 / 192.168.1.1 / 18:11:24 UTC Mon Mar 1 1993]) <br>  18:11:25:% SW_DAI-4-DHCP_SNOOPING_DENY: 1 Invalid ARPs (Res) on Fa1 / 0/1, vlan 1. ([50b7.c378.b41a / 192.168.1.10 / 001d.4641.02b4 / 192.168.1.1 / 18:11:25 UTC Mon Mar 1 1993]) </blockquote><br><br>  The switch discards "incorrect" arp requests.  Now the attacker will not be able to intercept. <br>  Let's include another additional DAI check. <br><br> <code>SW(config)#errdisable recovery cause arp-inspection</code> <br> <br>  This option allows you to restore the port and the state of errdisabled after 300 seconds.  If, of course, the MAC-IP mismatch continues on this port, the port will not be restored. <br><br>  You can view the trusted and untrusted ports and statistics with the command <br><br> <code>SW#show ip arp inspection interfaces</code> <br> <br>  That's all. <br>  Thanks for attention. <br><hr><br><br>  UPD added about dhcp-snooping </div><p>Source: <a href="https://habr.com/ru/post/192022/">https://habr.com/ru/post/192022/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../192010/index.html">RailsClub'Moscow 2013 (September 28). Conference news</a></li>
<li><a href="../192012/index.html">Several interesting and useful things for a web developer (release 2)</a></li>
<li><a href="../192014/index.html">Facebook attacks generate $ 200 million in profits for attackers every year</a></li>
<li><a href="../192016/index.html">The Chinese offer 10TB for everyone</a></li>
<li><a href="../192020/index.html">The fs module interface from the Node.js API is partially ported to browser (client) JavaScript</a></li>
<li><a href="../192024/index.html">A quick note about utf-8 in Mojolicious</a></li>
<li><a href="../192028/index.html">[NES] Writing level editor for Prince of Persia. Chapter Three First lines of code</a></li>
<li><a href="../192036/index.html">MS Lync 2013 integration with Aastra MX-ONE 5.0 (Direct SIP)</a></li>
<li><a href="../192038/index.html">About prime numbers, cryptography and brain damage</a></li>
<li><a href="../192044/index.html">GPSS-WORLD basics of simulation using live examples</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>