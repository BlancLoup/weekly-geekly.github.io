<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Swift + VK.API, or the story of SwiftyVK</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Today I want to tell you about how I once met the Swift programming language and decided to write an application on it for the VKontakte social networ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Swift + VK.API, or the story of SwiftyVK</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/e05/f15/a03/e05f15a03d9f4a1c984fd8043cf5e5c4.jpg"><br><br>  Today I want to tell you about how I once met the Swift programming language and decided to write an application on it for the VKontakte social network under OSX (which, unfortunately, has not yet been completed).  What pitfalls I had to face while curbing, at that time, a new language and crossing it with VK.API.  To share with the public the result of what it all turned out and to try to justify why it was necessary to invent another bike in the form of a library to work with VK.API. <br>  If someone is interested, then welcome under cat. <br><a name="habracut"></a><br><h4>  Part One: Hello, Swift! </h4><br>  It was the evening of the 2nd of June 2014.  Being a user of Apple products and a novice objc developer, I was chained to the screen of my laptop, on which footage of the WWDC 2014 presentation flashed one after another. Spending one evening a year watching the broadcast has become a standard rite.  This time was no exception.  As expected, nothing supernatural was introduced, and the new OSX interface even left a touch of frustration.  I had already fully intended to watch the remaining 15 minutes and go on my worldly affairs.  But here, under the guise of the next update of Xcode, without the famous ‚Äúone more thing‚Äù, unceremoniously, Craig Federigi represents a new programming language, whose name is Swift. <br><br>  It was exactly what I was waiting for.  How much I did not try to get used to the objc syntax, but many moments caused great inconvenience.  It was like a fatal itch that periodically reminded of itself in the process of writing code.  I remember that a couple of weeks before this very day, I dreamed of objc being more human and readable.  I even came across an <a href="http://habrahabr.ru/post/129993/">article on the subject about this</a> , but considered the solution a crutch, which would only interfere more than bring benefits.  And so, it was accomplished.  I could not believe it.  but the rest of the evening was definitely lost.  All plans are relegated to the background.  At first, the task was advanced rather to pull off a new Xcode and find out what this strange bird is.  I played with the novelty until the moment when the kingdom of dreams did not beckon me to myself, but there was no longer any strength to resist.  But stocking the book ‚ÄúThe Swift Programming Language‚Äù has sworn itself that in the morning I‚Äôll come close to learning all the subtleties of the swift brought to light. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      No sooner said than done.  I enthusiastically took up the task set to myself.  I re-read the entire above-mentioned book and tried very hard to parse code samples from it in order to understand what was happening.  And when it was finished, successfully owned the main structures and fell in love with this language.  Simplified readable syntax, static typing, optional values, generics, and many other things Swift did not leave me indifferent.  Going back to the old man objc absolutely no longer wanted (although still, probably, it will take a long time). <br><br><h4>  Part Two: Forward and with a song </h4><br>  So.  The language teaching materials were learned, the fundamentals were disassembled, and we wanted to delve further into subtleties so much that a slightly rash decision was made to write the application in a language that was still in beta status. <br><br>  It should be said that before that I had written only small programs for automating routine actions.  Not to say that these were some kind of scripts.  No, these were small applications on objc, using OOP, multithreading, graphical interfaces, and even some design patterns that still work successfully and daily simplify life.  Only now they solve problems specific to me, and it is unlikely for this reason that someone will be very useful (although there is an idea to bring them to the appropriate state and put them on the page. Suddenly I am mistaken). <br><br>  The motivation for all my offspring was one thought - if this thing doesn‚Äôt exist or is not implemented as I would like, and I know how I would like to see it, then I need to do it myself.  This time I followed the same logic.  For some time, the idea of ‚Äã‚Äãcreating an application for the social network VKontakte under OSX was in my head, since the analogs did not suit me (I will not say what application it is, since it is still far from the release. .  The project was coming much larger than what I usually did and demanded more labor and brainstorming than usual.  I thought that this is a good opportunity to delve into the development of Swift, to also implement a pending idea.  Moreover, one friend of mine was already familiar with the work of VK.API and also wanted to learn Swift.  This inspired me even more. <br><br>  And so, I began to try to build in my head a clearer concept of what I would like to see after the work.  Only one, since my friend this idea, apparently, caught fire less.  But with the API, he still helped me, for which a special thank you to him. <br><br>  The first thing that came to mind was to find a library for working with VK.API for Objective-C (the benefit of Swift allows you to use objc code in your projects).  This should greatly simplify the development, would not have to bother with the logic of requests / responses, but only to receive data, scatter them in the model and just as easy to send new data to the server. <br><br>  Having rummaged in the official VK documentation I first of all paid attention to the <a href="https://github.com/VKCOM/vk-ios-sdk">official SDK</a> .  It was created for iOS, but can it be somehow screwed to OSX?  It turned out not.  In addition to the requests themselves, there is a lot that is tied to UIKit, and it was almost impossible to twist the nuts under AppKit.  Desperate search in Google also did not give anything.  All libraries were developed either exclusively under iOS, or were already some years ago, the author thrown on the dusty shelf subquality.  No option came up to me.  This, of course, saddened me, but since I took up the implementation of the idea, I did not stop.  No library?  Do without it! <br><br><h4>  Part Three: We will build our own house </h4><br>  The first thing to do was figure out the authorization process.  It all turned out just because it passes through the oAuth protocol.  At least log in and rip out the token with certain rights from the address bar of the browser to start trying to send test requests to the API turned out quickly.  Then, which is a bit more complicated, you had to implement it in the application itself.  WebView was created, which loaded the authorization page and its WebFrameLoadDelegate looked at the URL of the page and caught the token.  At first, there were only three options for action: If there is a token in the URL, then pick it up and remove the WebView.  If the user rejected the authorization, then we close the application altogether, and if you suddenly decide to go to some other page, then we don‚Äôt allow it to do so and return it to the authorization. <br><br>  Requests I sent using NSURLConnection, and simultaneously.  Parsil answers using NSJSONSerialization and as a result received such constructions: <br><br><pre><code class="hljs objectivec">(((jsonObject as? <span class="hljs-built_in"><span class="hljs-built_in">NSDictionary</span></span>)?[<span class="hljs-string"><span class="hljs-string">"phoneNumbers"</span></span>] as? <span class="hljs-built_in"><span class="hljs-built_in">NSArray</span></span>)?[<span class="hljs-number"><span class="hljs-number">0</span></span>] as? <span class="hljs-built_in"><span class="hljs-built_in">NSDictionary</span></span>)?[<span class="hljs-string"><span class="hljs-string">"number"</span></span>] as? <span class="hljs-built_in"><span class="hljs-built_in">NSString</span></span></code> </pre> <br>  Agree, not the most pleasant sight.  At this point, working with optional turns into hell.  Read more about the problem <a href="http://habrahabr.ru/post/228949/">here</a> . <br><br>  Somewhere here it began to become clear that everything that happens is not good and convenient.  Plus, the API may return errors, authorization requests, authentication, captcha input.  These things need to be foreseen and processed.  After some deliberation, it was decided that it would be most logical to abstract all the logic of working with the API into a separate library.  Firstly, it will allow not to smear the communication code with VK on the application, and secondly, it will be possible to reuse and eliminate errors more locally.  Since there are a bunch of libraries for iOS and objc (although one official SDK is enough), I decided to make my own exclusively for Swift and OSX. <br><br>  In general, it should be said that if I wrote on iOS, then such a problem would not have arisen, but since I am a desktop, or rather notebook, user and I love OSX more than iOS, then all the things that I do for myself - I do naturally under that platform, which I use more actively.  Yes, and opportunities which, in my humble opinion, more.  But the taste and color ... <br><br><h4>  Part Four: Development.  Or a quick overview of SwiftyVK </h4><br>  The first structure appeared under the laconic name VK - the entry point, authorization, creation of requests and just a SwiftyVK conductor.  At first, it had only methods for authorization and deauthorization + a draft delegate protocol that needs to be implemented in the class of the application using. <br><br>  Next, it was necessary to implement a full authorization.  The basis was taken already existing solution and brought to mind.  When authorization application must transfer the rights that it wants to get.  In the official SDK, the list of rights is transmitted as an array of strings.  I decided to use the static typing of Swift and made an enumeration (of enum) from rights, which allows for authorization to transfer an array like this: <br><br><pre> <code class="hljs json">[.messages,.offline,.friends,.wall,.photos,.audio,.video,.docs]</code> </pre><br>  Previously, the token received after authorization was stored as a variable until the program was closed.  Now just needed to take care of its storage better.  If you don‚Äôt go deep into details, then this is an object of the Token class that stores directly the string with the token, the logic of its return and the relevance check.  If the token is outdated, then a new one will be requested.  Token supports the NSCoding protocol and can be saved to NSUserDefaults or any other place to choose from.  The object itself exists as a singleton, since we naturally do not need two tokens. <br><br>  Authorization can be run in any window in the form of a sheet, or in a separate window.  After passing the authorization, we begin to send API requests.  It was necessary to implement the logic of sending and receiving a response.  This is done by the Request / Connection, Connection, Response and NSURLFabric class / structure group.  Outside the library itself, only the first is visible - Request and some of its properties / methods, which allow you to set up a request and send it to distant distances to VKontakte servers.  Connection - the logic of sending a request, waiting for a response, handling errors and calling a callback.  NSURLFabric is a factory with static methods that assembles an NSURLRequest configured and ready for dispatch from Request.  Well, Response is a simple structure with the fields request, error, success and the logic of parsing the response from the server into an error or a successful answer. <br><br>  Above it was shown how to parse JSON using NSJSONSerialization.  To get more convenient and Swift-native methods for obtaining values, the library from the article in the same article describing this problem was first used, but since it still left many places where question marks were used during <a href="https://github.com/SwiftyJSON/SwiftyJSON">parsing</a> , the transition to <a href="https://github.com/SwiftyJSON/SwiftyJSON">SwiftyJSON was</a> made later. me, very convenient library.  With its help, the problem was solved completely. <br><br>  Errors are implemented in the Error class, which resembles NSError.  Error objects can even be initialized with NSError, but more often it comes from JSON.  Some errors are handled directly in SwiftyVK.  For example, if the application sent a request that requires authorization, but we are not authorized, the error message will return, the authorization window will appear, and after passing it, the request will be redirected.  Similarly with captcha.  To disable this feature, you need to set the queryErrors query parameter to false.  Then, even if a known SwiftyVK error is returned, the error handling block will be executed. <br><br>  For a long time I suffered with synchronous and asynchronous requests.  Not in terms of complexity of multithreading and asynchrony.  There is nothing complicated.  Problems were caused by sending synchronous requests in the main thread.  Could get this situation - the application sends a synchronous request.  The stream from which it was sent is blocked until the response or error block is called.  The API returns an error that indicates the need for authorization / input captcha before calling the error block.  The window needs to be shown from main thread, and it is already blocked waiting for a response.  As a result, deadlock and hang tightly.  How much I did not try to invent crutches to circumvent this ‚Äî somewhere, something went wrong.  Output - to synchronous requests with error checking from the main thread will work assert with the description that you should not send them.  Of course, not the best way, but anything better than a deaf hang. <br><br>  Since Swift is a strictly typed language, I wanted to strictly type everything so that there are as few places as possible to make mistakes in the future.  Perhaps the most controversial for someone is to typify query arguments.  In the official SDK, they are transmitted as a string.  I decided to introduce the Arg: String intersection, in which I listed all the possible query arguments at the moment.  In addition to minimizing errors, this allows auto-completion in Xcode to be used when specifying arguments. <br><br>  For even more convenience, an API structure has been introduced, which by group-substructures contains methods for quickly creating a request to a specific API method.  As a result, the creation of the request is something like this: <br><br><pre> <code class="hljs swift"> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> req = <span class="hljs-type"><span class="hljs-type">VK</span></span>.<span class="hljs-type"><span class="hljs-type">API</span></span>.<span class="hljs-type"><span class="hljs-type">Friends</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>([ .<span class="hljs-built_in"><span class="hljs-built_in">count</span></span> : <span class="hljs-string"><span class="hljs-string">"1"</span></span>, .fields : <span class="hljs-string"><span class="hljs-string">"city,domain"</span></span> ])</code> </pre> <br>  As for me, very simple, readable and concise. <br><br>  In addition to sending simple requests, it is possible to send requests with a custom method name (by passing it a string), calling execute, or remote procedures.  Plus, the implementation of loading files (which most other libraries do not have) and LongPool client (this is not found anywhere). <br><br><h4>  Part Five.  Last </h4><br>  Principle, this is all SwiftyVK consists of.  For a long time I did not post it, because I tested it and brought it to mind.  I think he is now ready to meet with the public.  I tried to make the most simple and clear library for working with VK.API using the advantages of the new language.  I would like to say that at the end of development I gave up on the idea of ‚Äã‚Äãdoing it only under OSX and added equal support for iOS.  I wanted to do more for tvOS, but there is no WebView there yet and it is impossible to log in using oAuth.  As soon as possible - so soon.  Under watchOS I decided not to do it, because I don‚Äôt know who might need it.  I'm not even sure that this library may even be needed by anyone except me.  But if I am mistaken and someone is interested in SwiftyVK, then thanks a lot and good luck with your use.  Please write about all the wishes - we will do. <br><br>  You can read the documentation in curved English and the source code <a href="https://github.com/WE-St0r/SwiftyVK">here</a> . <br><br>  PS: If you have read this far, thank you so much for your time. </div><p>Source: <a href="https://habr.com/ru/post/269741/">https://habr.com/ru/post/269741/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../269731/index.html">Why Go is a badly designed programming language.</a></li>
<li><a href="../269733/index.html">Concepts of natural language versus formal classifications in OpenStreetMap</a></li>
<li><a href="../269735/index.html">How lighthouses work: iBeacon Physics Technology</a></li>
<li><a href="../269737/index.html">Secure crypto programming. Part 2, final</a></li>
<li><a href="../269739/index.html">Conference on web analytics and internet marketing CONVERT.2015 will be held in Yekaterinburg on December 7</a></li>
<li><a href="../269743/index.html">We continue to fight the frontend-routine</a></li>
<li><a href="../269745/index.html">Learning machine learning</a></li>
<li><a href="../269747/index.html">Why google voice neural nets search?</a></li>
<li><a href="../269751/index.html">Attackers exploit a vulnerability in the Ksoft Uploader software! for installing Gh0st RAT</a></li>
<li><a href="../269753/index.html">Testing the functionality of Symantec Backup Hot-Add. Increased speed of copying and restoring data</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>