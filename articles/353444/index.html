<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We write the plugin for Unity correctly. Part 2: Android</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the previous part, we looked at the main problems of writing native plugins on Unity for iOS and Android, as well as methods for solving them for i...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We write the plugin for Unity correctly. Part 2: Android</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/webt/4j/c1/tz/4jc1tzdizrc1zsjrxgiqkmtg4eq.png"><br><br>  In the <a href="https://habrahabr.ru/company/pixonic/blog/353088/">previous</a> part, we looked at the main problems of writing native plugins on Unity for iOS and Android, as well as methods for solving them for iOS.  In this article, I will describe the basic recipes for solving these problems for Android, trying to maintain a similar interaction structure and the order of their consideration. <a name="habracut"></a><br><br>  Libraries for Android in Unity can be represented as Jar (compiled java code only), Aar (compiled java code along with resources and a manifest), and source codes.  It is desirable to store in the source code only the code specific for this project with minimal functionality, and this is not necessarily and not very convenient.  The best option is to have a separate gradle project (you can directly in the repository with the main Unity project), in which you can place not only the library code, but also unit tests, and a test Android project with an Activity for quickly assembling and checking the library functionality.  And in the gradle script build of this project, you can immediately add a task that will copy the compiled Aar to Assets: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre><code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">/* gradle.properties */</span></span> deployAarPath=../Assets/Plugins/Android <span class="hljs-comment"><span class="hljs-comment">/* build.gradle */</span></span> <span class="hljs-function"><span class="hljs-function">task </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">clearLibraryAar</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">type: Delete</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-function"><span class="hljs-function">delete </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fileTree</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"${deployAarPath}"</span></span></span></span></span><span class="hljs-function">)</span></span> { include <span class="hljs-string"><span class="hljs-string">'my-plugin-**.aar'</span></span> } } <span class="hljs-function"><span class="hljs-function">task </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">deployLibraryAar</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">type: Copy, dependsOn: clearLibraryAar</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">from</span></span>(<span class="hljs-string"><span class="hljs-string">'build/outputs/aar/'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">into</span></span>(<span class="hljs-string"><span class="hljs-string">"${deployAarPath}"</span></span>) include(<span class="hljs-string"><span class="hljs-string">'my-plugin-release.aar'</span></span>) rename(<span class="hljs-string"><span class="hljs-string">'my-plugin-release.aar'</span></span>, <span class="hljs-string"><span class="hljs-string">'my-plugin-'</span></span> + android.defaultConfig.versionName + <span class="hljs-string"><span class="hljs-string">'.aar'</span></span>) doLast { fileTree(<span class="hljs-string"><span class="hljs-string">"${deployAarPath}"</span></span>){ include { it.file.name ==~ <span class="hljs-string"><span class="hljs-string">"^my-plugin-([0-9.]+).aar.meta\$"</span></span> }}.each { f -&gt; f.renameTo(file(<span class="hljs-string"><span class="hljs-string">"${deployAarPath}/my-plugin-"</span></span> + android.defaultConfig.versionName + <span class="hljs-string"><span class="hljs-string">".aar.meta"</span></span>)) } } } tasks.whenTaskAdded { task -&gt; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (task.name == <span class="hljs-string"><span class="hljs-string">'bundleRelease'</span></span>) { task.finalizedBy <span class="hljs-string"><span class="hljs-string">'deployLibraryAar'</span></span> } }</code> </pre> <br>  Here my-plugin is the name of the library project;  deployAarPath - the path by which the compiled file is copied, can be any. <br><br>  It is also undesirable to use Jar now, because Unity has long learned to support Aar, and it provides more features: in addition to the code, you can include resources and your AndroidManifest.xml, which will merge with the main one during the gradle build.  The library files themselves do not need to be added to Assets / Plugins / Android.  The rule is the same as for iOS: if you are writing a third-party library, put everything in a subfolder inside your specific folder with code and native code for iOS - it will be easier to update or delete packages later.  In other cases, you can store where you want, in the Unity import settings you can specify whether to include the file in the Android assembly or not. <br><br>  Let's try to organize interaction between Java and Unity code without using GameObject in the same way as examples for iOS, by implementing our UnitySendMessage and the ability to transfer callbacks from C #.  For this we need AndroidJavaProxy - C # classes used as implementations of Java interfaces.  Class names leave the same as in the previous article.  If desired, their code can be combined with the code from the first part for a multiplatform implementation. <br><br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">/* MessageHandler.cs */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> UnityEngine; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">MessageHandler</span></span> { <span class="hljs-comment"><span class="hljs-comment">//     Java Interface,    private class JavaMessageHandler : AndroidJavaProxy { private JavaMessageHandler() : base("com.myplugin.JavaMessageHandler") {} public void onMessage(string message, string data) { //      MessageRouter.RouteMessage(message, data); } } //        Unity Engine   [RuntimeInitializeOnLoadMethod] private static void Initialize() { #if !UNITY_EDITOR //   JavaMessageHandler    new AndroidJavaClass("com.myplugin.UnityBridge").CallStatic("registerMessageHandler", new JavaMessageHandler()); #endif } }</span></span></code> </pre> <br>  On the Java side, we define an interface for receiving messages and a class that will register and then delegate calls to the above-described JavaMessageHandler.  Along the way, we will solve the problem of redirecting threads.  Since, unlike iOS, on Android, Unity creates its own stream having a loop circle, you can create android.os.Handler during initialization and transfer execution to it. <br><br><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">/* com.myplugin.JavaMessageHandler */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">package</span></span> com.myplugin; <span class="hljs-comment"><span class="hljs-comment">//  ,    public interface JavaMessageHandler { void onMessage(String message, String data); } /* com.myplugin.UnityBridge */ package com.myplugin; import android.os.Handler; public final class UnityBridge { //    C#   private static JavaMessageHandler javaMessageHandler; //    Unity  private static Handler unityMainThreadHandler; public static void registerMessageHandler(JavaMessageHandler handler) { javaMessageHandler = handler; if(unityMainThreadHandler == null) { //         Unity, //         , //    Handler unityMainThreadHandler = new Handler(); } } //     Unity ,    public static void runOnUnityThread(Runnable runnable) { if(unityMainThreadHandler != null &amp;&amp; runnable != null) { unityMainThreadHandler.post(runnable); } } //  - ,      Unity public static void SendMessageToUnity(final String message, final String data) { runOnUnityThread(new Runnable() { @Override public void run() { if(javaMessageHandler != null) { javaMessageHandler.onMessage(message, data); } } }); } }</span></span></code> </pre> <br>  Now let's add the ability to call Java functions with callbacks using the same AndroidJavaProxy. <br><br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">/* MonoJavaCallback.cs */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> UnityEngine; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">MonoJavaCallback</span></span> { <span class="hljs-comment"><span class="hljs-comment">//  ,    Java //      Action private class AndroidCallbackHandler&lt;T&gt; : AndroidJavaProxy { private readonly Action&lt;T&gt; _resultHandler; public AndroidCallbackHandler(Action&lt;T&gt; resultHandler) : base("com.myplugin.CallbackJsonHandler") { _resultHandler = resultHandler; } //     JSONObject //       , //        public void onHandleResult(AndroidJavaObject result) { if(_resultHandler != null) { //  json    var resultJson = result == null ? null : result.Call&lt;string&gt;("toString"); //      C#  _resultHandler.Invoke(Newtonsoft.Json.JsonConvert.DeserializeObject&lt;T&gt;(resultJson)); } } } //         C#  public static AndroidJavaProxy ActionToJavaObject&lt;T&gt;(Action&lt;T&gt; action) { return new AndroidCallbackHandler&lt;T&gt;(action); } }</span></span></code> </pre> <br>  On the Java side, we declare a callback interface, which we will later use in all exported functions with a callback: <br><br><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">/* CallbackJsonHandler.java */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">package</span></span> com.myplugin; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.json.JSONObject; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CallbackJsonHandler</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onHandleResult</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(JSONObject result)</span></span></span></span>; }</code> </pre> <br>  I used Json as the callback argument, as well as in the first part, because it eliminates the need to describe the interfaces and AndroidJavaProxy for each set of different types of arguments needed in the project.  Perhaps your project is more suitable string or array.  I give an example of use with the description of a test serializable class as a type for a callback. <br><br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">/* Example.cs */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Example</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ResultData</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> Success; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ValueStr; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> ValueInt; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetSomeData</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> key, Action&lt;ResultData&gt; completionHandler</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AndroidJavaClass(<span class="hljs-string"><span class="hljs-string">"com.myplugin.Example"</span></span>).CallStatic(<span class="hljs-string"><span class="hljs-string">"getSomeDataWithCallback"</span></span>, key, MonoJavaCallback.ActionToJavaObject&lt;ResultData&gt;(completionHandler)); } } <span class="hljs-comment"><span class="hljs-comment">/* Example.java */</span></span> package com.myplugin; import org.json.JSONException; import org.json.JSONObject; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Example</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getSomeDataWithCallback</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">String key, CallbackJsonHandler callback</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-comment"><span class="hljs-comment">//     -   background  new Thread(new Runnable() { @Override public void run() { doSomeStuffWithKey(key); //     Unity  UnityBridge.runOnUnityThread(new Runnable() { @Override public void run() { try { callback.OnHandleResult(new JSONObject().put("Success", true).put("ValueStr", someResult).put( "ValueInt", 42)); } catch (JSONException e) { e.printStackTrace(); } } }); }); } }</span></span></code> </pre> <br>  A typical problem when writing plugins for Android for Unity is to catch the life cycles of the gaming Activity, as well as onActivityResult and launching Application.  Typically, this is suggested to inherit from UnityPlayerActivity and override the class at the launch activity in the manifest.  You can do the same for Application.  But in this article we are writing a plugin.  There may be several such plug-ins in large projects, inheritance will not help.  It is necessary to integrate as transparently as possible without the need for modifications to the main classes of the game.  ActivityLifecycleCallbacks and ContentProvider will come to the rescue. <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">InitProvider</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ContentProvider</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onCreate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ Context context = getContext(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (context != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> &amp;&amp; context <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> Application) { <span class="hljs-comment"><span class="hljs-comment">// ActivityLifecycleListener ‚Äî    Application.ActivityLifecycleCallbacks ((Application) context).registerActivityLifecycleCallbacks(new ActivityLifecycleListener(context)); } return false; } //     }</span></span></code> </pre> <br>  Do not forget to register the InitProvider in the manifest (Aar libraries, not mostly): <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">provider</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">".InitProvider"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:authorities</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"${applicationId}.InitProvider"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:enabled</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:exported</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"false"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:initOrder</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"200"</span></span></span><span class="hljs-tag"> /&gt;</span></span></code> </pre> <br>  It uses the fact that Application at the start creates all the declared Content Provider.  And even if it does not provide any data that a normal Content Provider should return, in the onCreate method you can do something that is usually done at the start of the Application, for example, register our ActivityLifecycleCallbacks.  And it will already receive onActivityCreated, onActivityStarted, onActivityResumed, onActivityPaused, onActivityStopped, onActivitySaveInstanceState, and onActivityDestroyed events.  True, events will come from all activations, but to determine the main one and react only to it does not cost anything: <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isLaunchActivity</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Activity activity)</span></span></span><span class="hljs-function"> </span></span>{ Intent launchIntent = activity.getPackageManager().getLaunchIntentForPackage(activity.getPackageName()); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> launchIntent != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> &amp;&amp; launchIntent.getComponent() != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> &amp;&amp; activity.getClass().getName().equals(launchIntent.getComponent().getClassName()); }</code> </pre> <br>  Also in the manifest was specified the variable $ {applicationId}, which when building gradle will be replaced with the packageName of the application. <br><br>  The only thing missing is onActivityResult, which is usually required to return the result from showing the native screen on top of the game.  Unfortunately, this call cannot be received directly.  But you can create a new Activity, which will show the desired Activity, then get the result from it, return it to us and finish.  The main thing is to exclude it from the history and make it transparent, specifying the subject in the manifesto, so that when you open it, the white screen does not flash: <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">activity</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">".ProxyActivity"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:excludeFromRecents</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:exported</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"false"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:configChanges</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"fontScale|keyboard|keyboardHidden|locale|mnc|mcc|navigation|orientation|screenLayout|screenSize|smallestScreenSize|uiMode|touchscreen"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:theme</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"@android:style/Theme.Translucent.NoTitleBar"</span></span></span><span class="hljs-tag"> /&gt;</span></span></code> </pre> <br>  Thus, you can implement the necessary functionality without resorting to modifying the basic Unity Java classes, and carefully pack the manifest with code and resources into the Aar library.  But what to do with dependency packages from the maven repositories that are required by our plugin?  Unity generates a gradle project in which all the java project libraries are added to the libs of the exported project and are connected locally.  There should be no duplicates.  Other dependencies will not be included automatically.  Putting dependencies next to compiled Aar is not always a good idea: most often other Unity plugins also need these dependencies.  And if they put their version in unitypackage too, there will be a conflict of versions, gradle when building will swear at the duplicate of classes.  Also, dependencies depend on other packages, and manually composing this dependency chain by extorting everything you need from the maven repository is not a simple task. <br><br>  To look for duplicates in the project is also tiring.  I want an automated solution that itself downloads the necessary libraries of the required versions into the project, removing duplicates.  And there <a href="https://github.com/googlesamples/unity-jar-resolver">is such a solution</a> .  This package can be downloaded independently, and also it comes with Google Play Services and Firebase.  The idea is that in the Unity project we create xml files with a list of dependencies required by plugins with syntax similar to the definition in build.gradle (with minimum versions): <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependencies</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">iosPods</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">iosPods</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">androidPackages</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">androidPackage</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">spec</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"com.android.support:appcompat-v7:23+"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">androidSdkPackageIds</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">androidSdkPackageId</span></span></span><span class="hljs-tag">&gt;</span></span>extra-google-m2repository<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">androidSdkPackageId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">androidSdkPackageId</span></span></span><span class="hljs-tag">&gt;</span></span>extra-android-m2repository<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">androidSdkPackageId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">androidSdkPackageIds</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">androidPackage</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">androidPackage</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">spec</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"com.android.support:cardview-v7:23+"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">androidSdkPackageIds</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">androidSdkPackageId</span></span></span><span class="hljs-tag">&gt;</span></span>extra-google-m2repository<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">androidSdkPackageId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">androidSdkPackageId</span></span></span><span class="hljs-tag">&gt;</span></span>extra-android-m2repository<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">androidSdkPackageId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">androidSdkPackageIds</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">androidPackage</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">androidPackage</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">spec</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"com.android.support:design:23+"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">androidSdkPackageIds</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">androidSdkPackageId</span></span></span><span class="hljs-tag">&gt;</span></span>extra-google-m2repository<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">androidSdkPackageId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">androidSdkPackageId</span></span></span><span class="hljs-tag">&gt;</span></span>extra-android-m2repository<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">androidSdkPackageId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">androidSdkPackageIds</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">androidPackage</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">androidPackage</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">spec</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"com.android.support:recyclerview-v7:23+"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">androidSdkPackageIds</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">androidSdkPackageId</span></span></span><span class="hljs-tag">&gt;</span></span>extra-google-m2repository<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">androidSdkPackageId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">androidSdkPackageId</span></span></span><span class="hljs-tag">&gt;</span></span>extra-android-m2repository<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">androidSdkPackageId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">androidSdkPackageIds</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">androidPackage</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">androidPackages</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependencies</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  Next, after installing or changing dependencies in the project, select in the Unity menu of the editor Assets ‚Üí Play Services Resolver ‚Üí Android Resolver ‚Üí Resolve and voila!  The utility will scan the xml ads, create a dependency graph and download all the necessary dependency packages of the required versions from the maven repositories in Assets / Plugins / Android.  And she notes in a special file the downloaded one and next time replaces it with new versions, and she will not touch those files that we put.  There is also a settings window where you can turn on automatic resolution of dependencies, in order not to click Resolve via the menu, and many other options.  It requires Android Sdk installed on the computer along with Unity and the target target selected is Android.  In the same file, you can write CocoaPods dependencies for iOS builds, and in the settings set Unity to generate xcworkspace with the included dependencies for the main Xcode project. <br><br>  Unity relatively recently began to fully support the gradle collector for Android, and ADT announced it as legacy.  Now it is possible to create a template for the gradle configuration of the exported project, full support for Aar and variables in manifests, merging manifests.  But third-party sdk plugins have not yet managed to adapt to these changes and do not use the features that the editor provides.  Therefore, my advice, it is better to modify the imported library under modern realities: remove the dependencies and declare them via xml for the Unity Jar Resolver, compile all the java code and resources in Aar.  Otherwise, each subsequent integration will break the previous ones and take more and more time. </div><p>Source: <a href="https://habr.com/ru/post/353444/">https://habr.com/ru/post/353444/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../353432/index.html">How to write an exchange with 50 suppliers and do not go crazy</a></li>
<li><a href="../353434/index.html">Choose Yii2 or laravel</a></li>
<li><a href="../353436/index.html">How the Internet of Things shifts analytics to the periphery</a></li>
<li><a href="../353438/index.html">Features of setting up and launching PVS-Studio in Docker using the example of Azure Service Fabric code</a></li>
<li><a href="../353440/index.html">Shine and Poverty Java for Desktop</a></li>
<li><a href="../353446/index.html">Operators?. ?? and |>: future JavaScript features you'll like</a></li>
<li><a href="../353448/index.html">Great, we are going to devOps-ping. So, 15 years of planning?</a></li>
<li><a href="../353458/index.html">Code generation during application operation: real examples and techniques</a></li>
<li><a href="../353460/index.html">RTCP REMB: we twist the video call settings in the browser</a></li>
<li><a href="../353462/index.html">How to get into Microsoft, Amazon or Twitter without a prestigious college diploma</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>