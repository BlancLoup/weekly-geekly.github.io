<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>The device of special effects for games under NES. Part 1</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="There are several series of articles about programming under NES, one of them has even been translated into Russian on Habr√© . However, none of them g...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>The device of special effects for games under NES. Part 1</h1><div class="post__text post__text-html js-mediator-article">  There are several series of articles about programming under NES, one of them has even been translated into Russian on <a href="https://habrahabr.ru/post/348022/">Habr√©</a> .  However, none of them goes further than a review of the basic capabilities of the console ‚Äî the overall architecture of the console, the fundamentals of the assembler are discussed, briefly describes how to display sprites on the screen, mentions something about music and mappers, and the cycle ends. <br><br>  I will try to continue the story about the withdrawal of graphics for NES games from the place where other tutorials end.  Understanding yourself how to program animation effects is quite difficult, due to the small amount of information about this, both in Russian and in English.  But you shouldn‚Äôt get upset, because you can use the code from classic games as documentation, which are now easy to find in the network in the form of ROM-files. <br><br>  Therefore, before you program something, you have to figure out how these or other effects are arranged for NES, and the article will be devoted to how to do it.  There are many articles from the category " <a href="https://habrahabr.ru/post/132441/">Games that squeezed out of the NES maximum</a> ", we will try to understand how all the main effects are made in these games, and also create tools that can be used to find other games that are no less technologically advanced. <br><a name="habracut"></a><br><h4>  Disclaimer </h4><br>  In any descriptions of the iron prefix NES or the use of terms, I could be wrong and, most likely, wrong.  In the description of the program part, the information is supposedly more accurate, verified by disassembling and debugging scripts.  Links to all the tools used in the article are listed at the end.  If the text refers to an "emulator" without specifying the name, <a href="http://www.fceux.com/web/home.html">Fceux is</a> implied.  Particularly important or interesting, in my opinion, moments are highlighted with exclamation marks. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Summary of NES Graphics Output Capabilities </h4><br>  Suppose you read the <a href="https://nesdoug.com/">nesdoug</a> 'articles in <a href="https://habrahabr.ru/users/bubavv/" class="user_link">BubaVV</a> , and already know the basic things about graphics programming for NES.  I will not write about it in detail, but only describe briefly and in a simplified way (you can skip this part and return to it when you have questions, why any effect is made this way and not otherwise): <br><br><ol><li>  The NES video processor has four screen pages (and several modes of operation with them, most often two pages simply copy the contents of the other two), which contain data about displayed tiles and attributes of these tiles.  A block of 2x2 tiles can be painted with just 3 different colors + use 1 background color. </li><li>  Also, the video processor is able to do hardware scrolling of pictures between multiple screen pages.  This means that a portion of the first screen and a portion of the second can be drawn on the screen.  The screen pages when rendering are "looped" in the order of 1-2-1-2-1-2 .., i.e.  if the video processor has reached the end of one of the pages, it takes data from the beginning of the next.  This is easier than it sounds, you can open any game in the emulator, and turn on the debugging screen display screen to see how it works. <br>  (analysis of the scrolling device with pictures <a href="https://wiki.nesdev.com/w/index.php/PPU_scrolling">here</a> ) <br></li><li>  The picture on the screen is drawn by tiles from a CHR memory bank, in which there are 256 memory tiles at one time.  The video processor "sees" two such banks, one for drawing sprites, the other for drawing the background. <br><br>  At the same time, there is an 8x16 drawing mode for sprites, in which you can draw sprites with data from both banks at once. <br><br>  This memory is on the cartridge, so depending on the ‚Äúfilling‚Äù of the cartridge, the banks can be arranged differently - programmatically switched banks with ROM memory (most often 1, 2 or 4 kilobyte each), or RAM memory into which you can write data (most often data is copied from banks with a code). </li><li>  Tiles from banks are 8x8 pixels in 2-bit color.  Two bits of the tile attribute color (common to all tile pixels) are added to these two bits.  The result is a 4-bit color index in a palette of 16 colors.  At the same time, two palettes are active in the video processor - for background tiles and sprites. </li><li>  In addition to the background, the video processor renders up to 64 sprites.  There is also a limit on the number of sprites displayed on a single line, beyond which the video processor skips sprites that it does not have time to draw. </li></ol><br>  I will not analyze these features of NES in detail, they are ‚Äúchewed‚Äù in review articles, for example, <a href="https://habrahabr.ru/post/229187/">here</a> .  I brought them just to list the 5 basic ways to create animations and effects on NES - <i><b>animation by writing to the screen, animating by changing the scrolling position, animating by changing the contents of the CHR-bank, animating by changing the palette and animating the drawing of sprites</b></i> . <br><br>  It may be worthwhile to isolate a separate way of <i><b>animation by changing the state processor's bit</b></i> , for example, turning on and off rendering, changing the brightness of color channels, changing the active screen, or alternately changing two active banks between each other. <br><br>  Now, attention, <b>all the graphical effects on the NES are done in one of these ways or a combination of them</b> ! <br><br>  Below, I will examine examples of the effects of each type and tell you how to determine exactly how the game creates this or that effect.  But before that, some more theory, which is very important to understand. <br><br><h4>  Synchronization of the central processor console and video processor </h4><br>  The video processor is controlled by the instructions of the console's central processor, but it works in parallel with it.  To create a smooth animation, you need to make changes in the video memory only at the moment when the video processor is not busy drawing a frame, otherwise the user will replace a sudden change of state on the screen!  At best, at worst, the user will also see a frantic ‚Äújerkiness‚Äù of the picture, since the change in the state of the video processor is recorded in his memory, and this leads to a loss of information in his internal registers that control the position of the raster drawing the picture on the screen.  So you can write to the video memory only when the rendering of the background and sprites is turned off in the video processor. <br><br>  <i>Modern graphics systems usually do not allow changing the contents of the current frame, and use double buffering - they draw a picture in an invisible memory area, which the video card then displays on the screen as a whole.</i>  <i>The old video processors did not have enough speed to prepare a whole frame in time while the previous one was being drawn.</i> <br><br>  To give commands to the video processor, the program has a very short time interval between the end of one frame and the beginning of the next!  In order to have time to do it at the right time, the video processor at the end of the frame generates an interrupt.  The program must install the interrupt handler.  It is in this place that the fastest and most optimized code is written, and the most cunning tricks are found. <br><br>  However, despite all the difficulties, many games perform operations with changing video memory not only in this processor (between frames), but also during frame rendering! <br>  So all effects are further subdivided into <b>interframe</b> (change is made between frames) and <b>midframe</b> (change is made right during the drawing of one frame). <br><br>  It uses several possible synchronization options for the central and video console processors. <br><br><ul><li>  <b>Using a mapper</b> that generates interrupts at the end of the drawing of each row, either by timer or by some other condition.  The interrupt tells the central processor "drop everything, only now you can quickly write a few bytes into the video memory, this is more important, you will return to the rest later."  The program can install an interrupt handler - and execute some code while the beam on the screen is extinguished to go from one line to another.  This is the easiest approach for the developer.  The most common of these mappers is <a href="https://wiki.nesdev.com/w/index.php/MMC3">MMC3</a> .  ‚ÄúIron‚Äù part of the organization of this is very interesting, think about it - using the chip on the CARTRIDGE added a new opportunity to use the video processor on the CONSOLE. </li><li>  If mapper does not allow generating interrupts, perversions begin.  The program should make an idle cycle, waiting for the appearance of any specially adjusted condition, indicating that the video processor has reached the drawing of a certain place on the screen (for this, sprites can be used or even console functions for sound output). <br><br>  Another way is to <b>measure the number of clocks</b> on instructions that were executed (in this case, the program should ensure equality in the execution time of the two branches of the conditional operator, and ensure that instructions working with dynamically composed addresses do not go beyond the 256-byte memory page ).  But even in this case, the CPU and PPU clock cycles do not exactly match, so the developers try to do such tricks in those parts of the screen where the user does not notice pixel blinks.  Look at the screenshot: <br><br><img src="https://habrastorage.org/webt/5k/co/yh/5kcoyhy0j_ynaqhfcu0wvxnrdic.png"><br><br>  Pay attention to the width of the highlighted bar at the bottom of the screen - as long as the beam drawing the picture passes in this place, magic happens.  Like a magician who only needs one flash to fool the viewer, the processor very quickly executes some code in order to have time to update that part of the video memory for which he didn‚Äôt have enough time between frames. </li></ul><br>  About both ways of synchronization between the CPU and PPU in the middle of the frame (interrupt, and according to the condition of checking on the CPU), if there is interest, I will tell in another article with code examples, now it‚Äôs enough to understand that changing the memory can be done between frames (and even Developers should do this quickly enough!), and even during the frame drawing. <br>  Now you can proceed to the analysis of what can be achieved in one way or another. <br><br><h2>  Animation palette change </h2><br><h3>  Interframe </h3><br>  Changing the palette between frames is one of the easiest to implement effects.  There are several types of effects that are implemented with the help of animation palette. <br><br>  The easiest of them - the usual flicker, when one color is replaced by another.  Another effect is ‚Äúrunning waves of color,‚Äù for example, waves of a waterfall, quicksand, or fire.  Finally, the third type of effects is flashing one of the colors in the palette of one frame of the image while simultaneously blanking other colors, so you can show a moving particle of rain, snow, or another particle effect.  If you carefully read the theory, you can calculate that such an animation will have a maximum of three frames, if you do not combine it with the animation by writing to the screen page (tiles are limited to two bits of color, one of which is occupied by background).  All three types of such animation can be seen in different levels of the game <i>Duck Tales 2</i> : <br><iframe width="560" height="315" src="https://www.youtube.com/embed/PeaBHPGMgY4" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>  The video shows the animation playing in both directions. <br>  Unfortunately, the rain effect is hard to see in the video, so here it is on the gif: <br><br><img src="https://habrastorage.org/webt/hp/vf/w-/hpvfw-tyqgvvpedkx7wlnjvo9dm.gif"><br><br>  Identifying this type of animation is very easy, and special tools are not needed for this.  Open the <i><b>PPU Viewer</b></i> window in the emulator and see if the palette changes or not.  For ease of learning "flashing" frames with raindrops slow down the speed. <br><br><h3>  In the middle of the frame (midframe) </h3><br>  Changing the palette completely in the middle of the frame is difficult, but <a href="https://wiki.nesdev.com/w/index.php/Palette_change_mid_frame">possible</a> . <br><br>  For animation in the game process, this method is not used, but occasionally used in static parts of the frame.  The obvious effect is to draw an interface using a palette other than the level palette. <br><br><img src="https://habrastorage.org/webt/4-/ox/o6/4-oxo6titag8o8j9fvtsec3lqgw.png"><br><br>  Less obvious is changing colors from one to another all the time to create a gradient effect. <br><br>  <b>How to recognize</b> <br><br>  The emulator allows you to see which palette was loaded at the time of drawing any line of the frame.  See the screensaver <i>Indiana Jones and the Last Crusade</i> : <br><br><img src="https://habrastorage.org/webt/69/k1/or/69k1ormkaoh-8ttmq2j7u_x7nom.png"><br>  <i>Indiana Jones and Gradient Fill</i> <br><br>  Please note that the game does not switch the entire palette, but changes only one color.  And the more she had not had time for the time that the beam moves from one line to another. <br><br><h2>  Animation by writing to screen page </h2><br><h3>  Interframe </h3><br>  This is the most common <b>background animation by</b> changing the tile number that will draw the video processor, more often it is always performed once for one object.  It is not interesting to disassemble such animations, and it makes no sense - almost any ordinary game animation is made like this (but more often the interactive part, for example, the lid of the opening chest, is drawn with a sprite).  An example is the display of exploding objects in <i>Contra</i> or <i>Super C.</i> <br><br><img src="https://habrastorage.org/webt/__/gd/lf/__gdlfsk8fdihw1jpnznypfnxxk.png"><br>  <i>In this game, with the explosion of a cannon, doors or gates, a logical "block" is updated, with a size of 4x4 tiles.</i> <br><br>  <b>Create an illusion of tiles smaller than 8x8</b> <br><br>  Well described in the <a href="https://habrahabr.ru/post/142126/">article</a> with the analysis of <i>Battle City</i> .  In short, for each 8x8 tile, several variants of the same type are created with missing 4x4 parts, as a result of the programmatic replacement of tiles, you can create the illusion that the game uses 4x4 pixel tiles: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/9ca/fdb/025/9cafdb025f43ff2ce5ef34caac875e77.png" alt="image"><br><br>  In combination with the <b>scrolling</b> position change, a classic <b>screen scrolling</b> effect is created <b>on a large level</b> , present in almost any game with levels greater than a couple of screens in width or height (I‚Äôll note only that the update takes place in the invisible part of the screen in advance so that the player can see already drawn part to the moment when the scroll reaches the new area).  I will analyze the types of scrolling in the section of animations created by changing the position of scrolling. <br><br><h3>  Midframe </h3><br>  It makes no sense to display the change in the screen page before the frame is finished drawing, normal people can wait until the next frame 1/24 second. <br><br><h2>  Sprites animation </h2><br><h3>  Interframe </h3><br>  <b>Animation of characters</b> .  An elementary example, in fact, is what sprites are for ‚Äî moving them around the screen, depicting the characters of the game, so that gamers become interested. <br><br>  Sprites can also <b>draw particles</b> , as well as <b>add additional details to the background</b> .  Background tiles should be aligned to 8 pixels, sprites can be drawn anywhere on the screen, in addition, they are drawn from the second bank and another palette - due to this, limits on the number of colors in the picture are increased. <br><br>  There is also the inappropriate use of sprites - in order to synchronize the processor and the video processor (for example, <a href="https://wiki.nesdev.com/w/index.php%3Ftitle%3DSprite-0_hit%26redirect%3Dno">Sprite Zero Hit</a> and <a href="https://wiki.nesdev.com/w/index.php/Sprite_overflow_games">Sprite Overflow</a> ) with the help of them. <br><br>  Interestingly, to distinguish the effects made by sprites from other effects "by eye" will not work, it is too easy to mask the background under the sprite and the sprite under the background and fool the player. <br><br>  Emulators allow you to disable the layer of sprites and backgrounds in the settings, but playing in this mode is very inconvenient, so for easier detection of sprites, I wrote a <a href="https://github.com/spiiin/CadEditor/tree/master/Stuff/nes_lua/render_sprite_numbers">lua-script</a> , which, when turned on, does not interfere much with playing and at the same time uniquely emphasizes the sprites on the screen. <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/OxC1JruZLnU" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>  The video may seem a bit strange, but if you know the games shown in it well, you will understand what is happening on the screen in the shown episodes.  Now you can accurately separate the sprite effects in games from others, and give specific examples. <br><br>  <b>Particle rendering</b> <br><br>  Rendering rain in <i>Mitsume ga tooru</i> . <br><br><img src="https://habrastorage.org/webt/wv/ym/r1/wvymr1avkxh9tsbtvkxbydir8_o.png"><br><br>  Here you can see that the game uses 8x16 sprites (it is more advantageous to use such sprites in terms of the number of graphics shown on the screen at the same time, because regardless of the size of the sprites - 8x8 or 8x16, you can draw 64 sprites).  You can also notice that the game draws raindrops through the frame, which makes it seem to the player that there are twice as many drops as there really are - because the sprites also need the game to draw the main character, projectiles and the boss, which also consists many particles of bees. <br><br>  Drawing through a frame is possible only for small and fast moving objects (the human brain is designed in such a way that it represents the missing frames for fast moving objects, and the position of the objects is interpolated).  In other cases, the player will notice the flickering of the object disappearing and appearing through the frame. <br><br>  A similar effect is the rendering of stars in <i>Galaxian</i> or <i>Addams Family</i> . <br><br><img src="https://habrastorage.org/webt/er/0a/k7/er0ak71gguuusuiyzvi0fxbupzk.png"><br><br>  <b>Shadow display</b> <br><br>  In 2,5-D games, such as <i>Jurassic Park</i> , sprites are used to display shadows under objects ‚Äî so the player can determine the height at which the object is located. <br><br><img src="https://habrastorage.org/webt/o0/pg/zu/o0pgzuj6sf4gnmx7hom1p7mxkme.png"><br><br>  <b>Finishing details of the background</b> - often used in screensavers or cut-scenes, where you need large and high-quality pictures. <br><br><img src="https://habrastorage.org/webt/ch/xi/t5/chxit5hkzqeryw25gktctznmark.png"><br><br><img src="https://habrastorage.org/webt/vz/3y/my/vz3ymyjmgtf4cnxaiy70ubvhoq0.png"><br><br>  Here, I think, comments are unnecessary, screensavers without sprites can be simply scary. <br><br>  <b>Disguise sprites under the background</b> <br><br>  A special trick of designers, one of those for which the game is recorded in the "best graphics for nes".  It is difficult to notice it, but it‚Äôs easy to find a sprite detection script.  Most often, the developers created an illusion of a separate background layer with sprites (the NES video processor does not support layers, which is why people who are not familiar with the console device think that the game does something impossible for the console). <br><br>  Examples: <br><br><img src="https://habrastorage.org/webt/cg/df/0w/cgdf0wxsvav9pwmh9bpuuyor3p8.gif"><br>  <i>In <i>Mitsume ga Tooru</i> , in addition to the separate speed of the truck and the background, to enhance the effect of the sprites, a pole is drawn, as if on a separate layer, moving at a slow speed.</i> <br><br><img src="https://habrastorage.org/webt/em/r2/_f/emr2_feorzrrtokkvclm3z1sflw.png"><br>  <i>In the famous screensaver of <i>Megaman 2, the</i> sprites create the effect that the whole house is on a separate layer, although this is not so.</i> <i><br></i> <br><img src="https://habrastorage.org/webt/1d/5g/fb/1d5gfbaqxpdhveg-x0uluejyymm.png"><br>  <i>In <i>Bucky O'Hare</i> there is both a parallax effect (a separate moving layer is highlighted with green lines), and additionally for the illusion of water movement, sprites onto a fixed layer are added below.</i> <br><br><img src="https://habrastorage.org/webt/bm/ry/ki/bmrykiktjvcqae3bxs9elfexkxg.gif"><br>  <i>The big wheel at the beginning of the tower after the first level in <i>Castlevania 3</i> .</i>  <i>It seems as if the wheel is spinning, but the moving gears are sprites, driving as if they are one with the base of the wheel.</i>  <i>In addition, small gears are also animated by switching memory banks, this effect will be described later, in the example with <i>Power Blade 2</i> .</i> <br><br>  There are also reverse effects when the <b>background is disguised as a sprite</b> (technically, this is NOT an animation of sprites, although it seems to her).  For example, a whole boss may be drawn in the background.  They do this because 64 sprites would not be enough to draw a huge boss.  This effect will be considered in the group of effects by changing the position of the scroll. <br><br>  Separately mention games in which the <b>sprites go into the background and back</b> unnoticed by the player. <br><br>  For example, <i>Galaxian</i> .  The reason for this cunning aliens - to render them all sprites would not work, because they are too many. <br><br><img src="https://habrastorage.org/webt/cx/s5/o1/cxs5o1-ipypqbtlxk7j0vqcsnzy.png"><br><br>  This technique is often used in <i>Capcom games</i> to show interaction with interactive blocks ‚Äî broken stones in <i>Duck Tales 1-2</i> , boxes in the <i>Chip and Dale Rescue Rangers 1-2</i> , shells in <i>Little Mermaid</i> . <br><br><img src="https://habrastorage.org/webt/rj/dl/mq/rjdlmqdqm0_qhpmkhs8xsppqiga.png"><br>  <i>On the screenshot are two boxes from <i>Chip &amp; Dale</i> , one of which is drawn in the background, and the second is thrown by the player and is a sprite.</i>  <i>You may also notice that the colors in the object palette are slightly different.</i> <br><br>  The <i>Prince of Persia</i> technique is more advanced.  In those moments (and only in them), when a player runs through the ‚Äúgates‚Äù drawn on the background, and must pass between two columns, the same column as the background that covers the player is drawn on top of the character with sprites.  So both pillars in the background remain behind the character, but the third pillar temporarily appears in front of the character in order to preserve the illusion of the correct order of the objects. <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/WCVK8qQYqVQ" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>  <b>Sprite Translucency Effects</b> <br>  The video processor does not support the translucency of sprites, so the developers had to show them not very realistic, but now they are already known in all ways - by drawing a sprite through the frame.  As a result, all the players knew that if a character or boss ‚Äúflashes‚Äù - then he is most likely invulnerable at this time. <br><br>  <b>Translucent / Opaque Background Effect</b> <br><br>  But it is possible to show the translucency of the background.  For each sprite on the screen, the flag ‚Äú <i>draw the sprite behind the background or in front of it</i> ‚Äù is allocated in the video processor‚Äôs memory.  If all pixels of the background tile are opaque, that sprite will be completely invisible behind the background.  If the part of the background pixels is transparent and the other is not, then the character behind the background will ‚Äúshine through‚Äù. <br><br><img src="https://habrastorage.org/webt/cg/yx/wm/cgyxwmrdztnlups0hbzlx-ejehm.png"><br>  <i>My favorite example of a translucent background is the secret passages in <i>Duck Tales 2</i> .</i> <br><br>  If you exit the passage in slow motion frame by frame, you can notice the problem of organizing translucency in this way - the bit ‚Äúbehind the background / in front of the background‚Äù is set for the whole 8x8 sprite - therefore Scrooge briefly falls for the torches in the place where he partially stands in the aisle, and partly already got out of it. <br><br>  The solution to this problem is <b>to close the sprite partially with another sprite</b> - this will enable you to increase the display accuracy up to 1 pixel.  This effect can be observed in detail in <i>Mystery World Dizzy</i> or <i>Nightshade</i> . <br><br><img src="https://habrastorage.org/webt/qp/5n/1s/qp5n1ss0ueyjo5oxvz8g1qo7stg.png"><br>  <i>The character is displayed partially behind the column, and partially in front of the wall, as it should.</i>  <i>This effect is detailed <a href="https://forums.nesdev.com/viewtopic.php%3Fp%3D210736">here.</a></i> <br><br>  <b>The effect of the Cat Felix bag</b> <br>  Finally, the reception from the category of "dirty hacks" from the game <i>Felix the Cat</i> .  See how Felix hides in the bag - the lower part of the sprite disappears smoothly in the bag, and the top remains visible in front of the background. <br><br><img src="https://habrastorage.org/webt/wm/qg/_4/wmqg_4lif-q329_gwy3alyby1oq.gif"><br><br>  If you enable the sprite display script, you get the following image: <br><br><img src="https://habrastorage.org/webt/k8/gh/eh/k8ghehad97mfq3ceflubub7zbt4.png"><br><br>  On the left side there are 3 strange sprites (it is worth noting that the script displays sprites a bit wrong - the game uses 8x16 sprites, and the script draws only 8x8 pixels, so in fact they follow each other vertically). <br><br>  If you look at a little more detail, namely, to enable the logging of the coordinates of sprites in the script, it will become noticeable that these are not 3 sprites, but 24, 8 each line.  This is the maximum that can manage to render the video processor in one line.  He does it from left to right, so after 8 sprites are drawn in the invisible area of ‚Äã‚Äãthe screen, Felix's sprites getting into the bag no longer have time to draw in these lines.  In such a clever way, the disguise of that part of the sprites that are below the dive boundary is done <br><br>  There are not so many games with such a masking effect (see <a href="https://wiki.nesdev.com/w/index.php/Sprite_overflow_games">here the</a> section " <i>Use of excess sprites for masking effects"</i> ) <br><br>  Also note the number of sprites on the right, which create a solid line that hides the scrolling defects in the game engine.  I will come back to this ‚Äúeffect‚Äù in the next part of the article, when I will analyze the scrolling effects. <br><br><h2>  Animations by changing the contents of the CHR-bank </h2><br>  For a start, it is worth a little more detail to consider the differences between the cartridges with CHR-ROM and CHR-RAM (there are also those on which both types of memory are present).  For a programmer, the difference is that playing with CHR-ROM allows you to quickly switch entire banks of memory.  Types of mappers have different sizes of "banks" - 1, 2, 4 kilobytes each.  This makes it possible to have a common part of the bank and switchable.  Switching is carried out by several commands to the mapper, and can be done at a speed several times per frame. <br><br>  Cartridges with CHR-RAM require to ‚Äúswitch‚Äù the direct recording of the required number of bytes into the memory of the PPU address space (for a program, through recording at a specific CPU address).  That is, to change one entire video memory tile, 16 recording commands are required. <br><br>  More details on the differences and applications of different types of memory can be explored <a href="https://wiki.nesdev.com/w/index.php/CHR_ROM_vs._CHR_RAM">here</a> .<font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Animation effects are possible with both types of memory, however there are some differences. </font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Interframe animation </font></font></h3><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The effect of changing the background</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> animation by switching banks. </font><font style="vertical-align: inherit;">The easiest way to select a few whole banks of CHR-ROM under the animation and switch them frame by frame. </font><font style="vertical-align: inherit;">If the mapper supports small banks, they often make a common part of the tiles and switchable to save the number of banks needed. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">An example of such an animation is mechanical objects in factories in the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Power Blade 2</font></font></i> <font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> levels. </font></font><br><br><img src="https://habrastorage.org/webt/wd/mj/td/wdmjtdtu8hcoiggjncj64ozzzwa.gif"><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Animated mechanisms </font></font></i> <br><br><img src="https://habrastorage.org/webt/lz/cu/xp/lzcuxpdn2rnju6mtd-vppun5yiy.png"><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Individual animation frames by banks (the lower half of the bank is switched). </font></font><br></i> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">You can explore the contents of CHR-ROM banks using any tile editor, for example, </font></font><a href="https://www.romhacking.net/utilities/108/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TLP</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">This also makes it possible to determine the size of the bank switched by the game.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Animation in CHR-RAM requires direct writing of tiles into memory and it is more difficult to track statically - data can be stored in a compressed form or even generated on-the-fly procedurally. Therefore, to track such effects, I wrote a couple of scripts. </font></font><br><br> <a href=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">One</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> of them counts the number of records in CHR-RAM per frame in order to understand how many tiles the game animates. </font></font><a href=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The other</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> allows you to dump all the different CHR-RAM contents into files in separate files - you just need to start the game, go to the right place and examine the results of the script. All the results of the study of games in this section are obtained using these scripts. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">One of the most "extreme" games using CHR-RAM animations is </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Battletoads</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">First of all, it uses changing the contents of CHR-RAM to </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">animate the characters</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> !</font></font> Those.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">only one frame is stored in memory for each toad and it is constantly updated. </font><font style="vertical-align: inherit;">This effect allows you to store more data in the memory bank. </font></font><br><br><img src="https://habrastorage.org/webt/4j/ot/re/4jotrem_ckkzq9o4lj7jnn_cjdi.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Now let's run the script for counting the number of bytes transmitted per frame. </font><font style="vertical-align: inherit;">The script is written for the </font></font><a href="https://www.mesen.ca/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mesen</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> emulator </font><font style="vertical-align: inherit;">, because it only allows you to track the desired video processor events from lua. </font></font><br><br><img src="https://habrastorage.org/webt/r2/-w/ho/r2-whotojh_k1zghnj49jbgv1w0.png"><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">As you can see, at the 2nd level, the game transmits up to 256 bytes per frame. </font><font style="vertical-align: inherit;">Moreover, the toad is animated on even frames, and the background on odd frames (the game still needs to update screen pages when scrolling, they are also written to the PPU, as well as the animation of the second player).</font></font><br></i> <br>         .      ,    ,            ,    ,          ( ): <br><br><img src="https://habrastorage.org/webt/ad/sp/iu/adspiu9xovqcns1b05lm7hertk4.png"><br><br>  <b>  </b> CHR-RAM ‚Äì     2x2   <i>Gun Smoke</i> .      ¬´¬ª  ¬´¬ª     <a href="https://github.com/spiiin/CadEditor">CadEditor</a> : <br><br><img src="https://habrastorage.org/webt/a4/hk/il/a4hkil8hsi_wo7up0xk3yd26qyc.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This simple technique allows you to increase the number of game elements almost 2 times. If you look at the contents of PPU during the passage of a level, you can see how slowly it works, mirroring the entire memory bank takes a few seconds. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In order for the player not to notice flicker, the game does this at the moment when the character is walking along a long wasteland, on which there are no asymmetrical objects. So if the game forces you to go through a long empty corridor (best to black) - most likely this is required in order to seamlessly switch or load the memory bank. Such a version of the ‚Äúhuge seamless world without reloading‚Äù of the NES era.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It is worthwhile to analyze in more detail the most beautiful animation effect of bank switching (possible with both CHR-ROM and CHR-RAM), achieved in combination with the scrolling effect - </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">parallax simulation</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (separate layer moving with a different speed than the main one). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">For the presence of this effect, the game automatically falls into the ratings of the ‚Äúbest graphic games on nes‚Äù. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">To determine it, if you have some experience, you can visually - a separate layer consists of only a few looped animated blocks. But for reliability, it is worth running the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dump_animated_chr.lua</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> script </font><font style="vertical-align: inherit;">, which I mentioned above, in order not to be mistaken with the fact that parallax was made in this way (there is another way to implement parallax, with other limitations on capabilities).</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Distinctive examples of creating a layer in this way are a looped ‚Äúmosaic‚Äù animated background, and also the possibility of ‚Äúparallax vertically‚Äù or ‚Äúparallax behind a window‚Äù that cannot be achieved in another way. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Examples of games:</font></font><br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/dWHPNnrTmKs" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bucky O'Hare</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Parallax in the windows is an illusion of a separate layer. </font></font><br><br><img src="https://habrastorage.org/webt/0z/mh/2m/0zmh2mz45hwstjjn82cgmfteyxg.gif"><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Battletoads</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Vertical Parallax - the walls of the well moves faster than the back wall, as they are closer. </font></font><br><br><img src="https://habrastorage.org/webt/-z/xg/9q/-zxg9q3x_jgupdpjbsihpuiqp1k.gif"><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mitsume ga Tooru</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">The wall is separate from the platforms. </font></font><br><br><img src="https://habrastorage.org/webt/p-/3f/7t/p-3f7ttzehkfrhbtrgyymqz2jlq.gif"><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Micro Mashines</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Paul "checkers" - with simultaneous horizontal and vertical parallax. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Let us analyze these beautiful effects in more detail. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Here is the </font></font><a href=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">script</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> for the CadEditor editor, which takes all the snapshots of the video memory and draws them in the form of png-pictures. </font><font style="vertical-align: inherit;">The result of the work: </font></font><br><br><img src="https://habrastorage.org/webt/qi/dl/fa/qidlfa69i9rwxrhwnwwyypq3sci.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Then use the command for </font></font><a href="https://www.imagemagick.org/script/index.php"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ImageMagic</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> to glue the frames together:</font></font><br><br><pre><code class="bash hljs">convert -delay 1x24 -loop 0 *.png animation.gif</code> </pre> <br>  It turns out this gif (for <i>Bucky O'Hare</i> ): <br><br><img src="https://habrastorage.org/webt/ia/0r/84/ia0r84tuknjftltvwjjovdmj8ne.gif"><br><br>  Look closely at the bottom right part of the image and you will see that 4 tiles are used for animation (‚Äúcrawling‚Äù and flowing into each other) in 16 different banks, and the banks themselves are used in other places of the game, and only for these 4 tiles the place was specifically left. in each of the banks. <br><br>  Similarly, it is possible to calculate that for combat toads in a well, for a vertical parallax effect, an animation of a wall block of 32 frames is 6 kilobytes of data for 1 block of 4x4 animation only! <br><br><img src="https://habrastorage.org/webt/o3/cj/5h/o3cj5hacq2hacqbjnbjjpr7gwlm.gif"><br><br>  Here you can see that when using CHR-RAM (in Combat Toads), unlike CHR-ROM (in Bucky), it is not necessary to allocate a whole bank or carefully plan a place in other banks in advance.  However, the charge for this is more complex code and the inability to animate the entire bank. <br><br>  Another way to study the effects of parallax is to destroy the illusion by placing an animated block in a place where it will not be stitched smoothly with other blocks.  For example, open a level with a well in the <i>CadEditor</i> and add a ‚Äúblock indicator‚Äù: <br><br><img src="https://habrastorage.org/webt/jh/wg/2s/jhwg2s7gornyv2n65y4chsgozc4.png"><br><br>  Load the modified level into the emulator and see the result: <br><br><img src="https://habrastorage.org/webt/gd/td/az/gdtdaz9cloangsffsyy4njowzwy.gif"><br><br>  Now the device of this effect should finally become clear, and it may even be possible to try to repeat it in your code in one of the following articles. <br><br>  Another ‚Äúeffect‚Äù, demonstrates <i>Jurassic Park</i> immediately after launching the game.  This is just a <b>recording of beautiful animation in several banks in a row frame by frame</b> and scrolling it without any interactivity.  I will not demonstrate it from the resentment of the developers, because they are so carried away by the demo effects at the start of the game, that they have no place for a beautiful ending, I think many players were disappointed by this. <br><br><h3>  Midframe animation </h3><br>  <b>Switching banks in the middle of a frame</b> is a great way to expand the number of tiles available for drawing.  After all, the upper part of the frame will be drawn in blocks from the old bank and will not change, and the lower one will use tiles of another bank! <br><br>  The obvious use of this is to <b>draw the interface with one bank, and the game screen with another</b> .  You can also select some part of the screen (better separated horizontally from the main part).  In <i>Teenage Mutant Ninja Turtles 3</i> there are both of these effects - the background of the beach is drawn with tiles from one bank, the beach with others, and the beautiful interface with turtles faces the third. <br><br><img src="https://habrastorage.org/webt/ez/fa/-w/ezfa-wbl-9g1mfa1oqgdtrzk-rm.png"><br><br>  A more technological effect is to <b>switch the bank so as to draw one big beautiful picture</b> .  An example is <i>Robocop 3</i> . <br><br><img src="https://habrastorage.org/webt/cs/co/uu/cscouuvwf6enaew6ekcu_jgsi9e.png"><br><br>  More examples of title screens with bank switching can be found in the Shiru <a href="https://shiru.untergrund.net/articles/nes_fullscreen_gfx.htm">article</a> <br><br>  The effect is tracked by simply exploring the <i>Debug-&gt; Name Table Viewer</i> window in the emulator ‚Äî only one of the tile sets is displayed in this window, the second at this moment looks like a ‚Äúporridge‚Äù. <br><br><h2>  An animation of scrolling position changes </h2><br>  Finally, the last group of effects, perhaps the most interesting and extensive, as well as perfectly combined with other effects.  For these effects, I will highlight a separate article (along with the effects of changing the state of the PPU). <br><br>  The number of examples in it will depend on the results of the survey. <br><br>  Scripts from the article can explore the effects of other games, throw up examples of games with beautiful and unusual effects (preferably, which are not yet in <a href="https://imgur.com/a/XJmb7">this list</a> ), let's deal with their device. <br><br><h4>  Tools used </h4><br>  <a href="https://ci.appveyor.com/project/zeromus/fceux/build/artifacts">Fceux</a> is an emulator, it is necessary to take an assembly from the latest versions of the developers' sources, the public version has not been updated for a long time and there are no parts of the lua-functions needed for debugging. <br>  <a href="https://github.com/spiiin/CadEditor/tree/master/Stuff/nes_lua/render_sprite_numbers">render_sprites_numbers.lua</a> - script for fceux for visual display of the numbers of sprites tiles on the screen, as well as their positions and display flags. <br><br>  <a href="https://github.com/spiiin/CadEditor/tree/master/Stuff/nes_lua/dump_chr_and_pal">dump_animated_chr.lua</a> - a script for fceux to save the contents of the unique CHR banks of the video processor to files for analyzing how an animation is made from them. <br><br>  <a href="https://www.mesen.ca/">Mesen</a> is an emulator that is best suited for debugging graphics effects, scripts written for it that are impossible to implement for fceux. <br>  <a href="">mesen_chrRamWriteCounter.lua</a> - a script for mesen to display the lines on which the game changes the contents of the video processor's memory and count the number of such changes between frames and during the frame. <br><br>  mesen_makeScreensEveryFrame.lua - a script for mesen to save screenshots each frame, used to create gif-animations. <br><br>  <a href="https://github.com/spiiin/CadEditor">CadEditor</a> is a universal editor of NES-game levels, currently contains configs for displaying 1172 different levels for 118 games (the list is periodically expanded). <br><br>  <a href="">Script-ExportAllChrsToPng.cs</a> is a script for CadEditor for building tile-pictures from binary files with PPU memory contents and palettes in the same way as NES emulators do. </div><p>Source: <a href="https://habr.com/ru/post/353726/">https://habr.com/ru/post/353726/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../353716/index.html">IPv6 support in CleanTalk Security for WordPress</a></li>
<li><a href="../353718/index.html">It's all about the combination: the history of the security system of one site</a></li>
<li><a href="../353720/index.html">How to create custom components for monitoring devices and automating IT tasks</a></li>
<li><a href="../353722/index.html">Guide to create your own shaders in the Unreal Engine</a></li>
<li><a href="../353724/index.html">Why it is not necessary to always obtain consent for the processing of personal data within the framework of the GDPR</a></li>
<li><a href="../353728/index.html">How to increase the number of friends in the company</a></li>
<li><a href="../353730/index.html">Mikrotik RoS, useful things</a></li>
<li><a href="../353732/index.html">Crypto Trading Automation with Django and Celery</a></li>
<li><a href="../353734/index.html">Concepts of distributed architecture, which I met when building a large payment system</a></li>
<li><a href="../353736/index.html">Digest news from the world of PostgreSQL. Issue number 5</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>