<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>novtable optimization</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The Microsoft compiler allows you to add the ‚Äúnovtable‚Äù extension to the ‚Äú__declspec‚Äù attribute when declaring a class. 

 The stated goal is to signi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>novtable optimization</h1><div class="post__text post__text-html js-mediator-article"><div style="text-align:center;"><img src="https://habrastorage.org/webt/py/7c/hg/py7chgcvugycee-wnogzvn5pkog.png"></div><br>  The Microsoft compiler allows you to add the ‚Äúnovtable‚Äù extension to the ‚Äú__declspec‚Äù attribute when declaring a class. <br><br>  The stated goal is to significantly reduce the size of the generated code.  On experiments with our components, the reduction was from 0.6 to 1.2 percent of the size of the DLL. <br><br>  Applicability: classes not intended to create instances directly from them. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      For example: pure interface classes. <br><br>  In code, it looks like this: <br><br><pre><code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> __</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">declspec</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">novtable</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IDrawable</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Draw</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span><span class="hljs-function"> </span></span>= <span class="hljs-number"><span class="hljs-number">0</span></span>; };</code> </pre> <br>  <i>Note: The struct keyword was used to declare an interface class to eliminate the example of irrelevant details;</i>  <i>whereas in the case of using a class, we would have to use public to indicate the ‚Äúpublicity‚Äù of the methods.</i>  <i>For the same reason, I will not add a virtual destructor to the interface class in this article.</i> <br><br>  The name ‚Äúnovtable‚Äù promises that there will be no virtual table ... But how does the mechanism for calling virtual functions work in the following code: <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">//   ,   IDrawable: class Rectangle : public IDrawable { virtual void Draw() const override { } int width; int height; }; ‚Ä¶ IDrawable* drawable = new Rectangle; drawable-&gt;Draw(); //   Rectangle::Draw ‚Ä¶</span></span></code> </pre><br><a name="habracut"></a><br>  Recall what is added when declaring a virtual function in a class: <br><br><ol><li>  Definition of the table of virtual functions.  One instance of this table is used for all instances of the class. </li><li>  A pointer to a virtual function table is added to the class data members. </li><li>  The code for initializing this pointer in the class constructor. </li></ol><br>  Thus, in our example, there will be a declaration of two tables of virtual functions: for IDrawable and for Rectangle.  When creating a Rectangle object, the IDrawable constructor is first executed, which initializes a pointer to its virtual function table.  Schematically it looks like this: <br><br><img src="https://habrastorage.org/webt/38/dk/dm/38dkdmuwzkydh8bkg9ttmojen60.png"><br>  Since the draw function in IDrawable is declared pure-virtual (indicated by "= 0" instead of the function body), the address of the purecall function generated by the compiler is written in the virtual functions table. <br><br>  Then the Rectangle constructor is executed, which initializes the same pointer, but to its virtual function table: <br><br><img src="https://habrastorage.org/webt/f7/s6/pn/f7s6pnrpvifpt59sangs9njm83a.png"><br><br><h1>  What does ‚Äúnovtable‚Äù do, and why does Microsoft promise to reduce the size of the code? </h1><br>  It is the unnecessary definition of the table of virtual functions IDrawable and the initialization of a pointer to it in the IDrawable constructor that are excluded from the resulting code when adding ‚Äúnovtable‚Äù. <br><br>  In this case, when constructing an IDrawable, the pointer to the virtual function table will contain an unpredictable value.  But this should not worry us, since the creation of an implementation with reference to virtual functions before the complete construction of the object, as a rule, is an error.  If, for example, in the constructor of the base class to call a non-virtual function of this class, which in turn calls a virtual function, then without notable the purecall function will be called, and with novtable there will be unpredictable behavior;  none of the options can be acceptable. <br><br>  Note that there is not only a reduction in size, but also some acceleration of the program. <br><br><h1>  RTTI </h1><br>  As you know, std :: dynamic_cast allows you to cast pointers and references from one class instance to a pointer and a link to another if these classes are linked by a hierarchy and are polymorphic (contain a table of virtual functions).  In turn, the typeid operator allows you to get information about an object at runtime using a pointer (reference) to the object passed to it.  These capabilities are provided by the RTTI mechanism, which uses type information located with reference to the vtable class.  Details of the structure and location depend on the compiler.  In the case of the Microsoft compiler, it looks like this: <br><br><img src="https://habrastorage.org/webt/ru/kf/ir/rukfir6ii448tjdtrhpzt84naa4.png"><br><br>  Therefore, if the compiler is ordered to include RTTI when building, then novtable also excludes the creation of a type_info definition for the IDrawable and the service data required for it. <br>  Note that if you somehow have the knowledge that the pointer (reference) to the base class points to the implementation of the derivative, then std :: static_cast is more efficient and does not require RTTI. <br><br><h1>  Microsoft specific </h1><br>  In addition to MSVC, this feature with the same syntax is present in Clang when compiled under Windows. <br><br><h1>  findings </h1><br><ol><li>  __declspec (novtable) - does not affect the amount of memory occupied by instances of the class. </li><li>  Reducing the size and some acceleration of the program is provided by eliminating the definition of unused virtual function tables, RTTI service data and eliminating the initialization code of the pointer to the virtual functions table in the interface class constructors. </li></ol></div><p>Source: <a href="https://habr.com/ru/post/442340/">https://habr.com/ru/post/442340/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../442328/index.html">Typical programmer errors when applying for a job</a></li>
<li><a href="../442330/index.html">Some tasks of school mathematics. Part II</a></li>
<li><a href="../442332/index.html">Anticipation in developing a dialogue with a chat bot</a></li>
<li><a href="../442336/index.html">Planning poker: notes about the first developer experience</a></li>
<li><a href="../442338/index.html">Redis changes license again</a></li>
<li><a href="../442342/index.html">500 Gbit / s - record speed in fiber optic networks</a></li>
<li><a href="../442344/index.html">Improving Development Productivity with Vue - Part 2</a></li>
<li><a href="../442346/index.html">Redux-symbiote - we write actions and reducers almost without pain</a></li>
<li><a href="../442348/index.html">What do they ask for in an interview at juna, or how did I look for my second job in IT?</a></li>
<li><a href="../442350/index.html">Non-technology companies are beginning to use artificial intelligence on a large scale.</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>