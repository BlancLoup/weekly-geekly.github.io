<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Ideas about the self-limiting protection mechanism in Windows</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Parents know best what their child can do and what not. Similarly, the programmer of a particular program knows better than others what actions the pr...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Ideas about the self-limiting protection mechanism in Windows</h1><div class="post__text post__text-html js-mediator-article">  Parents know best what their child can do and what not.  Similarly, the programmer of a particular program knows better than others what actions the program should perform and which not.  But not everything is as good as we would like.  Malicious programs often interfere with the work of other programs.  The consequences of exploiting vulnerabilities in network programs are not at all predictable.  All this somehow violates information security not only in enterprises, but also on computers of ordinary users. <br><br>  And how it would be nice if the program itself knew what actions it doesn‚Äôt need and turned off them just in case. <br><br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Antiviruses and other similar systems try to take on the role of defenders, but all protection comes down to a set of rules that are the same for many and do not take into account the specifics of the programs being protected.  This approach sometimes leads to unpleasant situations.  Here are some examples: <br><ul><li>  Embedded malicious code in the browser - gets unhindered access to network functions. </li><li>  Embedded malicious code in the mail program - will freely get access to the mail database files, despite the fact that the antivirus will protect these files. </li><li>  Exploiting vulnerabilities in network programs - sometimes allows access to the system or elevation of rights, despite the fact that the user may have minimal rights. </li></ul><br><br>  But as mentioned above - the author of the program knows best what his program should do.  So why not give him the opportunity to put restrictions on certain actions?  And not for the whole program, but for specific streams. <br><br><h5>  Efficiency of the idea </h5><br>  Thanks to this, you can achieve: <br><ul><li>  The processing and visualization flows could not work with the network. </li><li>  Network workflows could not launch another program or be implemented in another process. </li><li>  Malicious code embedded in the program, could not use its level of trust among antiviruses. </li></ul><br><br>  Speaking from a more realistic point, one could: <br><ul><li>  The browser itself could prohibit the launch of third-party programs. </li><li>  The mail program could have access to the database files, but the code embedded in it could not. </li><li>  Any program could learn about its abnormal activity. </li></ul><br><br><h5>  Features of the implementation and use of ideas </h5><br>  To implement the idea you need in the Windows kernel: <br><ul><li>  Make edits in two system structures. </li><li>  Add one system call. </li><li>  Write code for 50-100 lines. </li></ul><br><br>  In kernel32.dll add one function to control the protection.  Which also will not be very big. <br><br>  These actions under the force of any programmer (and in one day).  But the biggest difficulty is that Microsoft itself has to do it.  That is why this protection mechanism remains in dreams. <br><br><h5>  Theoretical retreat </h5><br>  Since any restrictions in user mode (user mode) are easily bypassed or removed, it is necessary to implement all the protection in the kernel. <br><br>  The basic principle of calling system functions in Windows can be represented as the following diagram: <br><br><img src="https://habrastorage.org/storage2/f90/33f/b27/f9033fb273983dc84a794ea8687d76f1.png"><br><br>  After calling sysenter / syscall / int 0x2E or call dword ptr fs: [0xC0] (depending on the windows version), further control will go to the kernel, where the KiSystemService function looks at the table of system service addresses (SDT) and by the service number (transmitted in the eax register) ) finds the address of the desired function and then transfers control to it.  In this way, the function is called. <br><br>  The system uses two tables - one is responsible directly for the system and is processed by the kernel, and the second is responsible for the work of the GUI and is processed by the win32.sys driver.  We are interested in the first table. <br><br>  Thanks to this architecture, it is possible to put access restrictions on the call of any system function.  To do this, simply insert a simple check into the KiSystemService function. <br><br>  We have already found the place of verification, now it is necessary to find <s>a</s> place for storing the access matrix. <br><br>  In Windows operating systems, the kernel uses the KTHREAD structure to describe the flow, which is different for each thread.  This is where the access matrix can be stored.  But now it will not be a matrix, but a line list (since each stream will store information only about itself). <br><br>  Everything is good, but there is also a network, work with which is organized through special drivers.  But even here, the problem is solved in processing some IRP requests to the devices \\ Device \ Tcp, \\ Device \ Udp, \\ Device \ Raw, which will also allow you to transparently check the ability to access the network from certain streams. <br><br><h5>  How we will implement protection </h5><br>  The implementation of protection is seen as follows: <br><ul><li>  In the structure of the description of each stream there is a prohibition table consisting of bits.  In Windows 7, there are 360 ‚Äã‚Äãfunctions in the SDT, so an array of 512 bits (64 bytes) is enough above the roof. </li><li>  By default, all bits are cleared (i.e. there is no prohibition) </li><li>  There is also a 64 bit key field, which will be discussed later. </li><li>  There is also a 32/64 bit field that stores the address of the callback function. </li><li>  Total we have data on 76/80 bytes </li><li>  Another system call has been added to the kernel, which fills the structure according to the following rules: <br><ul><li>  Bits can always be set. </li><li>  You can reset the bits only by specifying the security key. </li><li>  Special key can be obtained only once. </li><li>  Callback function can be set only once or unlimited number using the key. </li></ul><br></li><li>  In kernel32.dll and ntdll.dll, an interface function is added to the system call organizing protection management. </li></ul><br><br>  Protection work progress: <br><ul><li>  In KiSystemService or the network driver request IRP handler, we get a pointer to the PTHREAD structure </li><li>  Check the index boundaries (in the case of a number in the SDT) </li><li>  Check the bit is set or not.  If set then return STATUS_ACCESS_DENIED </li><li>  If the bit is set and the callback function is specified, then call it.  Thereby notifying the process that a thread has attempted to perform prohibited actions. </li></ul><br><br>  I would like to pay special attention to the protection installation function.  She sees the prototype as: <br>  DWORD QuerySystemSecurity (HANDLE hThread, DWORD Flag, QWORD * Key, VOID * Data); <br><ul><li>  <b>hThread</b> is a thread descriptor for which protection is being installed.  Or 0xFFFFFFFF in the case of the current thread. </li><li>  <b>Flag</b> - parameters transmitted or requested: <br><ul><li>  Get the key. </li><li>  Set a ban on the function. </li><li>  Set a ban on the list of functions. </li><li>  Set a ban on a group of functions.  - for example, working with files or processes. </li><li>  Set callback function. </li><li>  Remove the ban on the function. </li><li>  Inherit the protection table or not. </li><li>  Forbid to remove protection even if the key is set. </li><li>  Deny getting the key. </li></ul></li><li>  <b>Key</b> - key address or NULL. </li><li>  <b>Data</b> - data depending on the Flag. </li></ul><br><br>  Also in QuerySystemSecurity there should be a table of correspondence to the number of the function to be prohibited and its number from the SDT.  the latter changes from version to version. <br><br><h5>  Conclusion </h5><br>  Thanks to one simple function and a small modification of the kernel, you can get quite flexible and fast protection.  The programmer himself will be able to forbid abnormal actions to his programs.  That would be very useful in network programs and primarily in browsers. <br>  Protection based on this approach would be able to more flexibly control the execution of third-party code in programs (not only malicious, but also plug-ins from other authors).  If small developers would not be interested in such protection, then large developers could easily use it to enhance the protection of their programs against the interference of someone else's code. <br><br>  Of course, such protection can be implemented not only by Microsoft itself, but also by third-party developers, but this will already be a crutch and will not work as effectively (due to the fact that you have to refuse to store data in PTHREAD) well, and will not have such a global scale. <br><br>  <i>But as always, these are only personal dreams about the existence of protection, which are unlikely to be realized by Microsoft.</i> </div><p>Source: <a href="https://habr.com/ru/post/145174/">https://habr.com/ru/post/145174/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../145167/index.html">Will we ever ... pass the Turing test for computers?</a></li>
<li><a href="../145168/index.html">1935 Brunsviga Nova Adding Instrument - Overview and Demonstration of a Mechanical Calculator</a></li>
<li><a href="../145170/index.html">Building effective business systems. Chapter 2.2 Business Processes: Local Optimization</a></li>
<li><a href="../145172/index.html">In shtatovskoy military chip made in China found password-protected "back door"</a></li>
<li><a href="../145173/index.html">Erlang Factory Lite in Moscow. June 22, 2012</a></li>
<li><a href="../145175/index.html">Atomic force microscopy</a></li>
<li><a href="../145176/index.html">DroidParts - library for Android 8-in-1</a></li>
<li><a href="../145177/index.html">Comparative performance testing of OpenOffice and LibreOffice</a></li>
<li><a href="../145178/index.html">Effective use of WebAPI: self hosting REST services</a></li>
<li><a href="../145180/index.html">Who works here or how to quickly find out information about callback for Drupal‚Äôs menu</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>