<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>My experience of writing a program for Android</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello! 
 In this article I would like to tell you about writing a program for the Android platform for sending animated messages. It will be more a sm...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>My experience of writing a program for Android</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage1/3becb82e/243b0e2b/ebe40b7e/1b60386d.gif"><br><br>  Hello! <br>  In this article I would like to tell you about writing a program for the Android platform for sending animated messages.  It will be more a small story of creation than a recess in programming. <br>  It was about two months ago, I thought a lot about what you can write now, so that it will be in demand, the users like it and it is original.  Considering how much the market is already cluttered up, it seemed to me difficult to even come up with an idea.  There were already all sorts of system utilities, hundreds of animated wallpapers, programs for cameras, clients for social networks, games and even antiviruses (which are for some reason wildly popular!).  Of course, the Chinese city is most of all there, which has become less noticeable with the advent of the new market. <br><a name="habracut"></a><br>  The idea came quite suddenly and pushed me to her site <a href="http://livetyping.ru/">livetyping.ru</a> .  ‚ÄúWhy not?‚Äù I thought and began to think how it would look and how to write it.  Who was too lazy to go to the site, I will explain that the point is that the user wrote the text, and then it was generated in the hyphae file, displaying the process of writing, including all the changes.  It turns out quite funny, you can write a message with one meaning, then wipe everything and write with the opposite.  In general, the user is limited only by his imagination. <br>  Someone will say that the idea of ‚Äã‚Äãthe program is not very ... because many Android phones do not know how to view animated gifs with built-in tools.  And partly it will be right, as judging by the reviews on the Internet, many Androids do not have this support.  But, as it turned out, my phone with firmware 2.3.3 can do this, which gave me hope that in the future manufacturers will add support to all devices.  Maybe a little optimistic, but at the <a href="http://developer.android.com/guide/appendix/media-formats.html">office.</a>  <a href="http://developer.android.com/guide/appendix/media-formats.html">This</a> Android should be able to decode the hyphae (although it is not said what). <br><br><h4>  Development </h4><br><h5>  Core program </h5><br>  The first difficulty was that the generated text should be formatted in exactly the same way as the original.  There were two options: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ol><li>  Make a server to which to send all the text typed by the user, the size of the field, the size and color of the font, generate the hyphae and give back the link or the file itself. </li><li>  Generate everything on the client. </li></ol><br>  Immediately, the second option was chosen, since I am not friends with the web, I don‚Äôt need server costs. <br>  In order to make the gif animation, it was necessary to first generate all the frames, and then collect them in a heap.  Thinking that this operation would work faster on C, and not on Java, I rummaged through the internet and found the source code of the <a href="http://jiggawatt.org/badc0de/android/">class</a> I needed, which I successfully compiled using NDK.  This class allowed to add a frame as an array of pixels obtained from an instance of the Bitmap class, generating an animated gif file at the end. <br>  Just as it is written in the example at the link: <br><br><pre><code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">static</span></span> { System.loadLibrary(<span class="hljs-string"><span class="hljs-string">"gifflen"</span></span>); } .... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> native </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Init</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String gifName, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> w, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> h, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> numColors, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> quality, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> frameDelay)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> native </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Close</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> native </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AddFrame</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] inArray)</span></span></span></span>; .... <span class="hljs-comment"><span class="hljs-comment">// Filename, width, height, colors, quality, frame delay if(Init("/sdcard/foo.gif", width, height, 256, 100, 4) != 0) { Log.e("gifflen", "Init failed"); } int[] pixels = new int[width*height]; // bitmap should be 32-bit ARGB, eg like the ones you get when decoding // a JPEG using BitmapFactory bitmap.getPixels(pixels, 0, width, 0, 0, width, height); // Convert to 256 colors and add to foo.gif AddFrame(pixels); Close();</span></span></code> </pre> <br>  The next task was to figure out how to render the typed text in a Bitmap.  Rummaging through the Android API, the StaticLayout class was found, which allows you to draw this text using Paint in Canvas, which in turn in Bitmap.  It all looks something like this: <br><br><pre> <code class="java hljs">Canvas canvas = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Canvas(); TextPaint paint = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TextPaint(Paint.LINEAR_TEXT_FLAG | Paint.ANTI_ALIAS_FLAG); Bitmap bitmap; paint.setStyle(Paint.Style.FILL); paint.setColor(fontColor); paint.setTextSize((<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>) (fontSizeDP * mDensityScale + <span class="hljs-number"><span class="hljs-number">0.5f</span></span>)); paint.setAntiAlias(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); paint.setTypeface(font); paint.setTextAlign(Align.LEFT); StaticLayout[] layoutTexts = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StaticLayout[mLiveTypeStringArray.size()]; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; layoutTexts.length; i++) { layoutTexts[i] = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StaticLayout(mLiveTypeStringArray.get(i), paint, (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>) (gifWidthDP * mDensityScale + <span class="hljs-number"><span class="hljs-number">0.5f</span></span>), Alignment.ALIGN_NORMAL, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(gifHeight &lt; layoutTexts[i].getHeight()) gifHeight = layoutTexts[i].getHeight(); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(gifHeight == <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; bitmap = Bitmap.createBitmap((<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>) (gifWidthDP * mDensityScale + <span class="hljs-number"><span class="hljs-number">0.5f</span></span>), gifHeight, Bitmap.Config.RGB_565); canvas.setBitmap(bitmap); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; layoutTexts.length; i++) { canvas.drawColor(backColor); layoutTexts[i].draw(canvas); gifEncoder.addFrame(bitmap); }</code> </pre><br>  Fine!  The typed text, more precisely, each of its changes, was rendered to the Bitmaps from which the gif file was collected. <br>  Then came the next problem.  Gif files turned out huge!  On average, hyphae up to 200 frames took 3-5 mb.  This is a lot, especially if you want to send it from a mobile device.  Then I noticed that these gifs take much less on livetyping (30-50 kb) and asked the author how he achieved this result.  The answer was the <a href="http://www.lcdf.org/gifsicle/">Gifsicle</a> library, which could very well and <a href="http://www.lcdf.org/gifsicle/">efficiently</a> optimize gifs.  A similar result was achieved due to not saving each hotel frame, but only the difference between them, which was ideally suited for us to save animated text. <br>  Then I started porting Gifsicle to Android using NDK, which was soon successfully completed. <br>  Who cares, here is my Android.mk: <br><pre> <code class="hljs ruby">LOCAL_PATH <span class="hljs-symbol"><span class="hljs-symbol">:</span></span>= $(call my-dir) <span class="hljs-keyword"><span class="hljs-keyword">include</span></span> $(CLEAR_VARS) LOCAL_MODULE <span class="hljs-symbol"><span class="hljs-symbol">:</span></span>= malloc LOCAL_SRC_FILES <span class="hljs-symbol"><span class="hljs-symbol">:</span></span>= fmalloc.c dmalloc.c LOCAL_ARM_MODE <span class="hljs-symbol"><span class="hljs-symbol">:</span></span>= arm LOCAL_CFLAGS <span class="hljs-symbol"><span class="hljs-symbol">:</span></span>= -DFPM_ARM -ffast-math -O3 LOCAL_C_INCLUDES <span class="hljs-symbol"><span class="hljs-symbol">:</span></span>= $(LOCAL_PATH)/<span class="hljs-keyword"><span class="hljs-keyword">include</span></span> <span class="hljs-keyword"><span class="hljs-keyword">include</span></span> $(BUILD_STATIC_LIBRARY) <span class="hljs-keyword"><span class="hljs-keyword">include</span></span> $(CLEAR_VARS) LOCAL_MODULE <span class="hljs-symbol"><span class="hljs-symbol">:</span></span>= gifwrite LOCAL_SRC_FILES <span class="hljs-symbol"><span class="hljs-symbol">:</span></span>= ungifwrt.c LOCAL_ARM_MODE <span class="hljs-symbol"><span class="hljs-symbol">:</span></span>= arm LOCAL_CFLAGS <span class="hljs-symbol"><span class="hljs-symbol">:</span></span>= -DFPM_ARM -ffast-math -O3 LOCAL_C_INCLUDES <span class="hljs-symbol"><span class="hljs-symbol">:</span></span>= $(LOCAL_PATH)/<span class="hljs-keyword"><span class="hljs-keyword">include</span></span> <span class="hljs-keyword"><span class="hljs-keyword">include</span></span> $(BUILD_STATIC_LIBRARY) <span class="hljs-keyword"><span class="hljs-keyword">include</span></span> $(CLEAR_VARS) LOCAL_MODULE <span class="hljs-symbol"><span class="hljs-symbol">:</span></span>= gifopt LOCAL_SRC_FILES <span class="hljs-symbol"><span class="hljs-symbol">:</span></span>= clp.c giffunc.c gifread.c gifunopt.c \ merge.c optimize.c quantize.c support.c xform.c \ gifsicle.c LOCAL_ARM_MODE <span class="hljs-symbol"><span class="hljs-symbol">:</span></span>= arm LOCAL_CFLAGS <span class="hljs-symbol"><span class="hljs-symbol">:</span></span>= -DFPM_ARM -ffast-math -O3 LOCAL_C_INCLUDES <span class="hljs-symbol"><span class="hljs-symbol">:</span></span>= $(LOCAL_PATH)/<span class="hljs-keyword"><span class="hljs-keyword">include</span></span> LOCAL_LDLIBS <span class="hljs-symbol"><span class="hljs-symbol">:</span></span>= -llog LOCAL_STATIC_LIBRARIES <span class="hljs-symbol"><span class="hljs-symbol">:</span></span>= gifwrite malloc <span class="hljs-keyword"><span class="hljs-keyword">include</span></span> $(BUILD_SHARED_LIBRARY)</code> </pre> <br>  What was my surprise when I saw that it was working incorrectly on a mobile device.  Generating and optimizing the same file hyphae each time gave a different result.  Very different, the spread was from 50kb to 2 mb.  Then I started compiling again, recompiling with different parameters, looking for a memory leak, etc ... anything to explain this phenomenon.  But I did not find anything.  So two weeks have passed. <br>  One fine morning, I realized that Gifsicle might not fail, because its author also could not understand what the problem was, but the first library (class) that generates the hyphae.  I turned off the optimization and looked at the result: the files were almost always the same size, only sometimes differed by 1-2kb.  Strange, but not deadly.  Not wanting to poke around in someone else‚Äôs raw C code, I found a similar <a href="http://www.java2s.com/Code/Java/2D-Graphics-GUI/AnimatedGifEncoder.htm">library</a> in Java ME, and ported it to Android.  I also noticed for myself the striking similarity of the Java ME and Android API - many almost identical functions (I hadn‚Äôt dealt with ME before).  Now everything has become normal. <br><br>  But again, not for long ... it turned out that after optimizing when playing a gif file on my Android device using the standard Image Viewer, sometimes there are horrible glitches of colors and loss of frames.  At the same time on the computer the same file was viewed perfectly.  I thought that this was all due to the poor support of the LZW compression viewer and disconnected it in the sifs of Gifsicle.  Now everything really became good, although the files began to occupy a little more than before. <br><br><h5>  Interface </h5><br>  Up to this point I spent about a month.  For the second month was to write the program interface.  I always wanted to use some kind of Android UI pattern, I chose Dashboard from all possible.  Since ‚Äúeverything is already written to us,‚Äù I downloaded the Google IO source and took the code from there.  It turned out somewhere like this: <br><img src="http://habrastorage.org/storage1/667cbc90/77675050/c79df87c/7bf86449.png"><br><br>  The window for writing a new message was: <br><img src="http://habrastorage.org/storage1/79b9d5fe/265601da/27363efc/c5617af2.png"><br>  You can view the written animated message or generate it in the hyphal animation, then the Share button appears with the ability to send by email, mms, twitter, etc. <br><br>  The height of the field for typing was chosen so that the keyboard did not cover it on different screens.  The smallest screens were banned, because there the keyboard takes well a lot of space.  Of course, it would be possible to make the height depending on the size of the screen, but ... it became lazy. <br><br>  Then settings were made based on the standard PreferenceActivity class: <br><img src="http://habrastorage.org/storage1/7cfb5524/46a59474/bfe7509f/846946ce.png"><br><br>  And also a list of my posts. <br>  On the memory card is saved only an array of texts (frames) in binary form.  When viewing a message, it is possible to generate it anew, after changing the settings (font color and size, background color, animation speed). <br><br><h4>  Result </h4><br>  At first two versions were planned: free and paid.  Now only free is implemented, which is in the market for about 20 days.  In the paid plan, more fonts were planned, more font and background colors, more frame limits ‚Äî 500 (now 140).  But, unfortunately, the success of the free version leaves much to be desired: there are 583 installations in total, of which 227 are active, that is, more than half of the downloads have already been deleted.  Apparently the idea is not rolled =) <br>  Therefore, the development of the program is suspended and is unlikely to be continued. <br><br>  That's all, thank you all for your attention!  I will answer your questions in the comments.  Also apologize for any errors. <br><br>  Update: Several mini-reviews on foreign sites: <br>  <a href="http://www.androidapplog.com/2011/09/android-app-reviews/animado-animated-messaging-app-review/">www.androidapplog.com/2011/09/android-app-reviews/animado-animated-messaging-app-review</a> <br>  <a href="http://www.addictivetips.com/mobile/animado-for-android-share-animated-text-messages-as-gif-files/">www.addictivetips.com/mobile/animado-for-android-share-animated-text-messages-as-gif-files</a> <br><br>  Who cares here is a link to the <a href="https://market.android.com/details%3Fid%3Dcom.illidane.animado">market</a> . <br><img src="http://habrastorage.org/storage1/fec53e93/72546c6f/1f3ec1c7/99e0009d.png"></div><p>Source: <a href="https://habr.com/ru/post/130087/">https://habr.com/ru/post/130087/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../130081/index.html">Japanese cloned teeth</a></li>
<li><a href="../130082/index.html">Creating a simple module for CMS Datalife Engine (DLE)</a></li>
<li><a href="../130084/index.html">Excel Add-in Guide for Beginners</a></li>
<li><a href="../130085/index.html">Encryption / decryption of data on the client in web-based systems</a></li>
<li><a href="../130086/index.html">PHP sample development case using TDD</a></li>
<li><a href="../130088/index.html">Writing a Redmine Plugin</a></li>
<li><a href="../130089/index.html">Imitation of named variables in LESS (with an example in jsFiddle)</a></li>
<li><a href="../130090/index.html">Firewalls - a bit of theory for beginners or what you need to know before you buy</a></li>
<li><a href="../130091/index.html">Free software at school or three days spent with benefit</a></li>
<li><a href="../130092/index.html">CPIO under the microscope</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>