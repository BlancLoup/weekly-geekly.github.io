<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Two and a half times when working with argparse</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The techniques described here are in the official documentation for the argparse module (I use Python 2.7), I did not invent anything new, just using ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Two and a half times when working with argparse</h1><div class="post__text post__text-html js-mediator-article"><div style="text-align:center;"><img src="https://habrastorage.org/files/86b/6fe/7c0/86b6fe7c0126439b9fed65edd480ddd1.png"></div><br>  The techniques described here are in the official documentation for the <i>argparse</i> module (I use Python 2.7), I did not invent anything new, just using them for a while, I became convinced of their power.  They allow you to improve the structure of the program and solve the following tasks: <br><br><ol><li>  Call a specific function in response to a specified command line parameter with concise dispatching. </li><li>  Encapsulation of the processing and validation of user input. </li></ol><br><a name="habracut"></a><br>  The discussion in the toaster about this issue was the motivation for writing this note: <blockquote>  how to call a specific function in response to a command line parameter </blockquote>  and answers to it in the spirit <blockquote>  I use argparse and if / elif </blockquote><blockquote>  look towards sys.argv </blockquote><br><br>  As an experimental, take a spherical script with two branches of parameters. <br><pre><code class="bash hljs">userdb.py append &lt;username&gt; &lt;age&gt; userdb.py show &lt;userid&gt;</code> </pre> <br>  The goal, which allows the first reception, will be: <br>  <b><i>I want for each branch of the arguments to call its own function, which will be responsible for processing all the arguments of the branch, and that this function is automatically selected by the argparse module, without any if / elif, and also ... stop, it is enough for now.</i></b> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Consider the first technique in the example of the first branch of the arguments to <b>append</b> . <br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> argparse def create_new_user(args): """      """ #   ,     age = <span class="hljs-type"><span class="hljs-type">int</span></span>(args.age) <span class="hljs-keyword"><span class="hljs-keyword">User</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">add</span></span>(<span class="hljs-type"><span class="hljs-type">name</span></span>=args.username, age=args.age) def parse_args(): """ argparse""" parser = argparse.ArgumentParser(description=<span class="hljs-string"><span class="hljs-string">'User database utility'</span></span>) subparsers = <span class="hljs-keyword"><span class="hljs-keyword">parser</span></span>.add_subparsers() parser_append = subparsers.add_parser(<span class="hljs-string"><span class="hljs-string">'append'</span></span>, help=<span class="hljs-string"><span class="hljs-string">'Append a new user to database'</span></span>) parser_append.add_argument(<span class="hljs-string"><span class="hljs-string">'username'</span></span>, help=<span class="hljs-string"><span class="hljs-string">'Name of user'</span></span>) parser_append.add_argument(<span class="hljs-string"><span class="hljs-string">'age'</span></span>, help=<span class="hljs-string"><span class="hljs-string">'Age of user'</span></span>) parser_append.set_defaults(func=create_new_user) #     <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">parser</span></span>.parse_args() def main(): """ ,        """ args = parse_args() args.func(args)</code> </pre><br>  Now, if the user launches our script with parameters, for example: <br><pre> <code class="bash hljs">userdb.py append RootAdminCool 20</code> </pre> <br>  in the depths of the program, the <i>create_new_user ()</i> function will be called, which will do everything.  Since we have our own function configured for each branch, the <i>main ()</i> entry point is spartan short.  As you have already noticed, the whole trick lies in calling the <i>set_defaults ()</i> method, which allows you to set a fixed parameter with a preset value, in our case there must be a <b>func</b> parameter in all branches with a value ‚Äî the called object that takes one argument. <br>  By the way, the user, if he has such a desire, will not be able to "outside" slip his parameter as a func, without getting into the script (I did not get it, at least). <br><br>  Now, nothing remains but to consider the second technique on the second branch of the arguments of our userdb.py. <br><pre> <code class="bash hljs">userdb.py show &lt;userid&gt;</code> </pre> <br><br>  The goal for the second trick is as follows: <b>I want the data that the user transmits not only to be validated, <s>it is too simple,</s> but also for my program to operate with more complex objects, formed on the basis of the user's data.</b>  <b>In our example, I want the program, instead of userid, to receive an ORM object corresponding to the user with the specified ID.</b> <br><br>  Notice how, in the first <i>method</i> , in the <i>create_new_user ()</i> function, we did ‚Äútedious checks‚Äù on the validity of the data.  Now we will learn to transfer them to where they belong. <br><br>  In <i>argparse</i> , to help us, there is a parameter that can be set for each argument - <b>type</b> .  The <b>type</b> can be any executable object that returns a value that is written to the property of the <i>args</i> object.  The simplest examples of using <i>type</i> are <br><pre> <code class="python hljs">parser.add_argument(..., type=file) parser.add_argument(..., type=int)</code> </pre><br>  but we'll go this way a little further: <br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> argparse <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">user_from_db</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(user_id)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">""" -,  id  ,   . """</span></span> <span class="hljs-comment"><span class="hljs-comment">#  user_id id = int(user_id) return User.select(id=id) #   ORM     def print_user(args): """   .    ,  args.userid    ID,   ORM.   ,       (  -  !) """ user_obj = args.userid print str(user_obj) def parse_args(): """ argparse""" parser = argparse.ArgumentParser(description='User database utility') #     subparsers = parser.add_subparsers() parser_show = subparsers.add_parser('show', help='Show information about user') parser_show.add_argument('userid', type=user_from_db, help='ID of user') parser_show.set_defaults(func=print_user) return parser.parse_args()</span></span></code> </pre><br>  Entry point <i>main ()</i> does not change! <br><br>  Now, if we later understand that forcing a user to enter an ID as a parameter is cruel, we can safely switch to, for example, username.  To do this, we will only need to change the <i>user_from_db ()</i> code, and the <i>print_user ()</i> function <i>will</i> not know about anything. <br><br>  Using the <b>type</b> parameter, you should pay attention to the fact that exceptions that occur inside executable objects that are passed as values ‚Äã‚Äãof this parameter are processed inside <i>argparse</i> , the user is informed about the error in the corresponding argument. <br><br><h5>  Half-reception. </h5><br>  This trick did not deserve the title of full-fledged reception, since it is an extension of the second, but this does not diminish its benefits.  If you look at the documentation (I‚Äôm talking about __doc__) to <i>print_user (),</i> we see that the input is <i>args.userid</i> , in which, in fact, no longer an ID, but a more complex object with complete information about the user.  It confuses the code, requires a comment that is ugly.  The root of evil is the discrepancy between the information that the user operates on and the information that our program operates on. <br>  It's time to formulate the task: <br>  <b>I want the names of the parameters to be understandable to the user, but at the same time that the code that works with these parameters is expressive.</b> <br>  For this, the positional arguments in <i>argparse</i> have a <b>metavar</b> parameter that specifies the argument name displayed to the user (for optional arguments, the <b>dest</b> parameter is more appropriate). <br><br>  Now we will try to modify the code from the second example to solve the problem. <br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">print_user</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(args)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">"""   """</span></span> <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> str(args.user_dbobj) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">parse_args</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">""" argparse"""</span></span> <span class="hljs-comment"><span class="hljs-comment">#     parser = argparse.ArgumentParser(description='User database utility') subparsers = parser.add_subparsers() parser_show = subparsers.add_parser('show', help='Show information about user') parser_show.add_argument('user_dbobj', type=user_from_db, metavar='userid', help='ID of user') parser_show.set_defaults(func=print_user) return parser.parse_args()</span></span></code> </pre><br>  Now the user sees the <i>userid</i> property, and the parameter handler - <i>user_dbobj</i> . <br>  In my opinion, it turned out to solve both 2.5 tasks.  As a result, the code that processes data from the user is separated from the main program code, the program entry point is not overloaded with branches, and the user and the program each work in their own terms. <br><br>  The working code of the example, where all at once ‚Äúby Feng Shui‚Äù is located <a href="https://gist.github.com/brake/a1a002d4238c66ee186a">here</a> . </div><p>Source: <a href="https://habr.com/ru/post/252333/">https://habr.com/ru/post/252333/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../252323/index.html">ECMAScript 6</a></li>
<li><a href="../252325/index.html">How to win in computer games [3]: now the complete book</a></li>
<li><a href="../252327/index.html">SummaryJS Release 4</a></li>
<li><a href="../252329/index.html">FREAK dangerous vulnerability detected in desktop and mobile OS</a></li>
<li><a href="../252331/index.html">The shape of the future 5G</a></li>
<li><a href="../252337/index.html">Angular 2: Built on TypeScript</a></li>
<li><a href="../252339/index.html">Experience of using the game designer Game salad</a></li>
<li><a href="../252343/index.html">Introducing the new Intel¬Æ IoT Developer Kit v1.0</a></li>
<li><a href="../252345/index.html">Discover FireUI</a></li>
<li><a href="../252347/index.html">Mobile Developer Rankings 2015 Results</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>