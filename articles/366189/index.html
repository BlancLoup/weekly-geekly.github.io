<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>The miracle happened. Released "untied" version of the Arduino Mega Server</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The revolution about which the Bolsheviks spoke for so long took place. Now you can take a microSD memory card, burn AMS distribution files onto it, a...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>The miracle happened. Released "untied" version of the Arduino Mega Server</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/40f/794/78a/40f79478a07e40c69a0fa51365b65fa2.jpg" alt="image"><br><br>  The revolution about which the Bolsheviks spoke for so long took place.  Now you can take a microSD memory card, burn AMS distribution files onto it, and your Arduino turn into a small (or large, how to see) miracle.  You no longer need "crutches" with the support of a third-party server, the <a href="http://hi-lab.ru/arduino-mega-server">Arduino Mega Server has</a> become completely autonomous and completely "usable" in a single mode.  And this opens up very interesting prospects for all of us. <br><a name="habracut"></a><br>  There was a lot of talk about the fact that this is impossible and that the limitations of the microcontroller and the network card will not allow this, there have been many discussions and experiments, but now all this is over, we managed to solve all the problems and overcome all obstacles and still make it work like this how to. <br><br>  In the <a href="http://geektimes.ru/post/259248/">first article</a> about the Arduino Mega Server, I described the project in detail, talked about the technology and outlined approximate prospects for the development and use of AMS, in this article I will talk about how we managed to achieve autonomous server operation and what opportunities are already open to us. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h2>  Battle for autonomy </h2><br>  Autonomy of work is a fundamental moment.  If you are ‚Äútied‚Äù to a third-party server, then this drastically limits the possibilities of using your projects.  Judge for yourself that a small controller works, it needs support in the form of installation and configuration of a large MajorDoMo server.  Therefore, all the forces were thrown to solve this problem, but ... it was not there.  On the way to bring AMS to autonomous navigation, there were many unexpected and formidable obstacles. <br><br>  The first obstacle is the low speed of reading files from a microSD card.  In the first article, I mentioned that the bottleneck in this system is the speed of the memory card, so it turned out to be not quite so.  The problem is not in the microSD card, but in the algorithm of the function <br><br><pre><code class="java hljs">File.read();</code> </pre> <br>  It performs byte reads from the file and thus slows down the whole process.  The average read speed in this mode is 25 kilobytes per second.  The output was a switch to block reading with a buffer size from 32 to 256 bytes.  The optimal resource / performance ratio was 128 bytes, and this increased the speed of reading from the memory card 10 (!) Times, to about 260 kilobytes per second.  And this, as you understand, is a completely different calico.  The read speed of 25 kilobytes per second simply put an end to the whole project because, in principle, it is impossible to transfer files in such a reasonable time with such speed. <br><br><pre> <code class="java hljs">File.read(buff, MAX_BUFFER_SIZE);</code> </pre><br>  We successfully overcame the first obstacle, but when I measured the speed of uploading files to the network, I was in deep shock: 4.1 kilobytes per second.  That is, all our efforts to speed up the reading of data from the disk broke against the wall of the tortoise rate of return of this data to the network. <br><br><pre> <code class="java hljs">client.write(data);</code> </pre><br>  You have probably already guessed what the problem is and how it can be solved.  That's right, replace the byte output to the network by block.  What was done and gave a speed increase of 14 (!) Times up to about 57 kilobytes per second.  And here our server became similar to the real one, it finally began to work, and not crawl with a snail's speed.  By the way, version 0.11 works at a speed of 4.1 kilobytes per second and only the tandem mode saves it. <br><br><pre> <code class="java hljs">client.write(buff, size);</code> </pre><br>  It was very cool, but as it turned out, it was still too early to relax, the real difficulties had not yet begun.  The next epic problem was the delay in the responses of the server, which was devoted to an <a href="http://geektimes.ru/post/259898/">entire article</a> (do not miss the fascinating reading).  In short, it turned out that the standard Ethernet library, supplied with the Arduino development environment for many years, contains a genetic defect that makes it incompetent.  It does not work correctly with requests and simply "hangs" non-single requests.  In the meantime, the standard Arduino Ethernet library has been fixed. <br><br>  Reducing the delay of server responses, in combination with the speed of reading files from a memory card and data transfer to the network, raised to a normal level, made the Arduino Mega Server a ‚Äúserious‚Äù and truly workable system. <br><br><h2>  Iron wall </h2><br>  And here we rested in the circumstances of force majeure called the chip W5100 (I am aware of more advanced options, but this is a slightly different story).  Its four hardware sockets impose very severe restrictions on networking with it.  You can‚Äôt just take and download a webpage with a dozen links to CSS, JavaScript and HTML files through it.  Each link generates a new request and a new connection and ... when there are more than four of them, then problems start with a delay in response.  And in order for all this to work, you need to organize network interaction taking into account this feature of the W5100 chip. <br><br><img src="https://habrastorage.org/files/29f/4fd/99a/29f4fd99ab894c1c8b74e3586544ad49.jpg" alt="image"><br><br>  To solve this problem, a kind of server-side programming language (macros) was introduced, which allows you to collect pages on the server side and, most importantly, allows you to manipulate the assembly of pages from sketches on Arduino and from the download pages themselves.  This gives complete freedom and you become like a magician or a wizard and can do anything you want with the output pages. <br><br><img src="https://habrastorage.org/files/b8d/7dc/0d1/b8d7dc0d1a4c4f408721a9992c620170.png" alt="image"><br><br>  For example, on the fly, change the style, design and functionality of the displayed pages.  One can imagine this in the form of a certain three-dimensional matrix: one axis is the functional of the site, the second axis is design (visual presentation), the third axis is the topology of the site.  In other words, one site turns into many sites, each with its own design, its own functionality and its topology.  And the work of many sites provides a single core. <br><br>  And all this happens on the eight-bit Arduino microcontroller. <br><br><h2>  beauty </h2><br>  Since we got our hands on such a powerful tool as AMS Matrix Engine, it would be a sin not to use it, and as a demonstration three additional sites were created to which you can switch with one click on the go (even reloading the AMS page will be done carefully).  By the way, it was possible to make not three, but thirty three sites or one hundred thirty three sites (visually - topologically - functional presentation of information) - your Arduino will easily maintain them (not at the same time, of course, but we don‚Äôt need it). <br><br><img src="https://habrastorage.org/files/2da/6d3/7e5/2da6d37e5f534d2a97276b43500ea7a9.jpg" alt="image"><br><br>  Default (geek mod, you'll like it) <br><br><img src="https://habrastorage.org/files/6bb/bae/6b3/6bbbae6b36ec4bc3acfd7afe93e9046f.jpg" alt="image"><br><br>  Home (calm design and ‚Äúquiet‚Äù features) <br><br><img src="https://habrastorage.org/files/289/fdd/010/289fdd010f40402a94d3e3f3712897de.jpg" alt="image"><br><br>  Modern ("modern" design and functionality to taste) <br><br><img src="https://habrastorage.org/files/96d/ade/877/96dade87753444f5b2eafd1c15d477fa.jpg" alt="image"><br><br>  Ampere (branding for your company, online store, school or laboratory) <br><br><img src="https://habrastorage.org/files/750/91f/1f8/75091f1f87b942e1b24e53344d5153e5.png" alt="image"><br><br>  I will explain, because not everyone could understand what was written above.  You have a powerful microcontroller and dozens of pins and serving more than fifty sensors.  Among them are temperature, current, security and others.  Each group of sensors forms a logical cluster, for example, protection, climate, the health of your favorite cactus, etc. So, for each logical cluster, AMS Matrix Engine allows you to create a separate site with a separate design and functionality.  It will not even occur to the user that all this wealth works on a ‚Äúdead‚Äù and nondescript microcontroller gathering dust in the corner. <br><br><h2>  Perspectives of use </h2><br>  <strong>Your projects</strong> .  Take the controller, fill it with AMS firmware and insert a microSD memory card with files from the distribution kit.  It's all.  The system will start and you can work with it.  If you are not satisfied with the functionality, then you simply change and append everything you need. <br><br>  <strong>Sellers Arduino iron</strong> .  Instead of selling bare metal, you can sell ready-made configurations and (boxed) solutions for customers.  The benefit is obvious - the threshold of entry decreases and the market expands.  The client buys a set for his task and uses it.  For this, he does not need either a soldering iron or programming knowledge: he works with the equipment, as with a regular site.  The configuration is assembled as <a href="https://geektimes.ru/post/259336/">from Lego cubes without a soldering iron</a> . <br><br><img src="https://habrastorage.org/files/d71/1ae/cae/d711aecaeec341b396373393a86d99b8.jpg" alt="image"><br><br>  <strong>Branding</strong>  Your company, your online store, your startup, your laboratory, in case you work with Arduino-iron, can supply your products with a branded AMS version with the functionality you need. <br><br>  <strong>The creators of training sets</strong> .  From AMS you can make an excellent training set.  The controller itself will contain documentation, sketches, examples, ready-made experiments, etc. In combination with sensors that are connected with one click (without a soldering iron) and wireless sensors, this will be a fascinating set that ‚Äúdeactivates‚Äù any child for a long time. <br><br>  <strong>Schools and training centers</strong> .  On the basis of AMS, you can conduct training on the whole range of modern technologies: microcontrollers, robotics, Smart Home, programming, web technologies, website building, interface design, etc., etc. <br><br><h2>  Alternatives </h2><br>  I often hear that it is easier to take ‚ÄúMalinka‚Äù with more advanced network capabilities, but what about purely microcontroller functions?  Mega has 16 analog pins and 54 digital ones (not counting other advantages).  How do I (or you) connect the 14-channel voltage and current control unit to the Malinka?  And where should I connect dozens of sensors and actuators on the Malinka?  And here we get a powerful microcontroller and luxurious control over the network in one bottle. <br><br><h2>  Are there any disadvantages? </h2><br>  A conditional disadvantage of technology can be called a high threshold of entry (not for use, everything is just fine here, but for self-modification and addition).  You need to know a lot of modern technology and be quite skilled user.  As well as the early stage of the project itself and the lack of quality documentation. <br><br>  But if you are not afraid of such difficulties, then you will not find a better simulator for mastering the whole range of modern technologies. <br><br><h2>  Latest current version </h2><br>  You can download the latest version from the official site of the <a href="http://hi-lab.ru/arduino-mega-server">Arduino Mega Server</a> project.  And ask any questions - on the <a href="http://majordomo.smartliving.ru/forum/viewtopic.php%3Ff%3D4%26t%3D2347">forum</a> .  For those interested: a typical page loading time in a single mode is four seconds, sometimes slightly less, sometimes slightly more, but on average about four seconds.  In tandem mode - about twice as fast.  The scope for optimization is huge, but in general it is quite possible to use it. <br><br>  <strong>Supplement</strong> .  The channel on Youtube is open and here is the <a href="http://www.youtube.com/watch%3Fv%3Djmu0MkIlywU">promo video for the</a> Arduino Mega Server, which demonstrates how to work with a real system. </div><p>Source: <a href="https://habr.com/ru/post/366189/">https://habr.com/ru/post/366189/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../366179/index.html">Roscosmos expects to create a launch vehicle with a returnable first stage</a></li>
<li><a href="../366181/index.html">Just5 Blaster 2 Review: A New Designer Smartphone From The Brand Overtaken In The Sales Of The iPhone And Samsung *</a></li>
<li><a href="../366183/index.html">Hyperloop: another step towards reality</a></li>
<li><a href="../366185/index.html">Audiofly AF56</a></li>
<li><a href="../366187/index.html">Imgur Pro is now free for everyone.</a></li>
<li><a href="../366191/index.html">Webinar Record - Windows Server "10": What's New in Virtualization</a></li>
<li><a href="../366193/index.html">Microsoft gives free 100 Gb in the cloud storage to everyone</a></li>
<li><a href="../366197/index.html">Smart LED bulbs: what can the market offer?</a></li>
<li><a href="../366199/index.html">Roskomnadzor intends to block Wikipedia today</a></li>
<li><a href="../366203/index.html">Fans of old games launched a campaign to protect the right to keep their own servers for obsolete toys.</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>