<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ASLR in the latest releases of Windows</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="We have repeatedly mentioned ASLR, according to MS, this technology allows making exploit development a much more costly measure, because in addition ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>ASLR in the latest releases of Windows</h1><div class="post__text post__text-html js-mediator-article">  We have repeatedly mentioned ASLR, according to MS, this technology allows making exploit development a much more costly measure, because in addition to exploiting the vulnerability in the software, the attacker must rely on certain predictable addresses in the memory at the time of operation, which ASLR deprives of it.  As we can see, recently, including the release of the newest Windows 8 / 8.1, MS decided to take a more serious approach to the deployment of this feature in the system.  If in the narrow sense, ASLR is understood as simply moving the image to unpredictable addresses with each reboot, then in a more general sense, this possibility at the system level should deprive the attackers of any opportunity to catch on with certain addresses of system library functions and other system objects (ASLR bypass mitigation / Address Space Information Disclosure Hardening) in those several dozen bytes of shellcode that can be executed bypassing DEP (ROP). <br><br>  We will not touch upon the history of ASLR, which is already known to almost everyone, let us note only some of the not quite obvious possibilities that Microsoft uses to improve ASLR in its flagship OS Windows 7-8-8.1. <br><br><a name="habracut"></a>  <b>ASLR rules</b> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Microsoft uses a similar approach to DLP in relation to ASLR, that is, allow its use as needed if the application is compiled with support.  This practice is applied in view of the obvious compatibility problems that may arise when working with technology programs to which they may not respond adequately.  But in the case of the ASLR, this situation works with more restrictions.  For example, on modern releases of Windows 8 / 8.1, DEP is always enabled for applications, regardless of whether they are compiled with its support or not (at least on a 64-bit processor and regardless of the bitness of the OS and the boot loader setting).  With ASLR, the situation is different, even when working on Windows 8 / 8.1, it relies on the rules of its support by the application itself and does not include image randomization if the header does not have this flag. <br><br>  Attackers can use the ‚Äúbenefits‚Äù of a system library that is not compiled with ASLR support for their own purposes, for example, to implement a stable ROP chain that will work in all supported OSs.  As practice has shown in recent years, this opportunity has been used more than once in the organization of targeted attacks.  The following are such in-the-wild exploited vulnerabilities like RCE (drive-by download). <br><br><img src="https://habrastorage.org/getpro/habr/post_images/d14/4e7/76c/d144e776cfa54870ebd4fafff3cda545.png"><br><br>  As you can see, the MS Office library (hxds.dll) does not support ASLR (Office 2007-2010) and the attackers were able to use its unchanged download address to successfully exploit the vulnerability.  As part of the December patch tuesday, the company closed this mistake (called Security Feature Bypass) using <a href="https://technet.microsoft.com/en-us/security/bulletin/ms13-106">MS13-106</a> , providing Windows users who work with this version of Office with the proper level of protection. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/79f/829/971/79f8299719249aefe752bc6fab84cd3d.png"><br><br>  One of the main opportunities for ASLR support that MS introduced with Windows 8 is the Force ASLR (Force ASLR) function.  This function is somewhat similar to the OptIn parameter of the DEP policy for the entire system.  Now using the registry key Image File Execution Options (IFEO) HKEY_LOCAL_MACHINE \ SOFTWARE \ Microsoft \ Windows NT \ CurrentVersion \ Image File Execution Options and the MitigationOptions parameter, the user can manually enable ASLR for executable PE files.  The table below shows the behavior of the OS when an executable file is loaded into memory with and without ForceASLR. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/b12/4ae/d6c/b124aed6c19b0df25ecbdde6b4d02f54.png"><br><br>  A similar feature is also available for Windows 7 users when installing the optional update <a href="http://support.microsoft.com/kb/2639308/en-us">KB2639308</a> . <br><br>  In order to make Internet Explorer (10+) more secure, the company introduced support for the ASLR enforcement function (on Windows 8+ and on Windows 7 with <a href="http://support.microsoft.com/kb/2639308/en-us">KB2639308</a> installed) for all libraries loaded into the browser process address space (ForceASLR).  Thus, if any of the libraries or plug-ins are initially compiled without the support of this function, it will be applied to it by force. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/e34/641/87d/e3464187db905186b1ee26f0af58ada4.png"><br><br>  Attackers take advantage of Windows, which applies some optimization when working with virtual memory through sequential allocation of adjacent regions of the right size for clients (processes) via <i>VirtualAlloc</i> .  An application can request a way to allocate a block of virtual memory as bottom-up (the default), top-down (MEM_TOP_DOWN), or at a fixed address (the address specified by the function).  By default, Windows uses a bottom-up selection method, i.e., from lower to upper addresses, it will look for a block of the required size in order to give it to the application. <br><br>  Starting with Windows 8, allocating virtual memory can be affected by ASLR.  This policy before Windows 8 was already used to allocate blocks of memory on the heap, when reserving blocks for stacks of threads, as well as TEB and PEB.  The latter two structures are very useful for attackers because they potentially contain a certain number of pointers to various system functions, thus revealing the location of the libraries in memory.  In Windows 8, <i>VirtualAlloc</i> also distinguishes top-down and bottom-up selection options, but now the base address of the beginning of these allocations is fixed by ASLR every time the OS boots up, i.e. it cannot be predictable.  Obviously, in the address space it is impossible to allocate memory completely chaotic due to the rapid fragmentation, therefore, through ASLR, it is the base address of the beginning of the allocation of blocks for processes that is fixed.  According to MS for the process, such an option is enabled only if the ASLR supports its executable file ( <a href="http://msdn.microsoft.com/en-us/library/bb384887.aspx">/ DYNAMICBASE</a> ). <br><br>  <b>High Entropy ASLR</b> <br><br>  ASLR can potentially work more efficiently in a 64-bit address space, because there is a much greater opportunity for arbitrary memory placement in such a large address space.  Obviously, its use itself is already a complicating factor for heap spray.  See <a href="http://habrahabr.ru/company/eset/blog/200156/">Internet Explorer EPM for Windows 7 x64</a> .  At the same time, OSs prior to Windows 8 do not use ASLR on x64 in the most complete way.  This mainly concerns the possibility of entropy (that is, the degree of arbitrariness / predictability of address selection) and how many bits of the address will be used to calculate the arbitrariness of this allocation.  In Windows 8, this feature is called High Entropy Randomization. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/60e/330/2a5/60e3302a54722f780b0e8d470f284604.png"><br><br>  Windows 8+ contains features that implement High Entropy Randomization and this technology extends to both the virtual memory blocks allocated by the process and downloadable executable files.  For 64-bit applications bundled with the <a href="http://msdn.microsoft.com/en-us/library/wz223b1z.aspx">/ LARGEADDRESSAWARE</a> flag, Windows 8 allocates 8 TB of virtual memory for use (128 TB for Windows 8.1).  For comparison, in 32-bit applications, the size of the user part of the address space is limited to 2 GB.  In this case, the High Entropy Randomization feature allows you to apply ASLR for the base address of the bottom-up memory allocation reference, using 24 address bits for entropy and for the top-down selection, 17 bits for the entropy address.  To use this level of ASLR and using bottom-up selections (default), a 64-bit application must be compiled with the <a href="http://msdn.microsoft.com/en-us/library/vstudio/jj835761.aspx">/ HIGHENTROPYVA</a> and <a href="http://msdn.microsoft.com/en-us/library/bb384887.aspx">/ DYNAMICBASE flags</a> . <br><br><img src="https://habrastorage.org/getpro/habr/post_images/cc6/999/9b7/cc69999b7ac790eaccbff340088c3699.png"><br><br>  It should be noted that / HIGHENTROPYVA itself is used as an OptIn restriction mode of using HEASLR in the OS.  That is, <i>VirtualAlloc</i> in its usual behavior (block-to-bottom allocation) on Windows 8 will not use enhanced ASLR for applications that are compiled without this flag.  This limitation is related to compatibility issues and the possible unpredictable behavior of these applications in this situation.  As stated above, the High Entropy Randomization feature also applies to 64-bit executables. <br><br>  Internet Explorer 10+ uses High Entropy ASLR (x64).  Below is a property of its running process on Windows 8. Note that all system executable files that Microsoft supplies in Windows 8 use HEASLR. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/526/3dd/dc1/5263dddc1cdba93ef2c5a0418b5c2d64.png"><br><br>  <b>ASLR bypass mitigations (aka Address Space Information Disclosure Hardening)</b> <br><br>  With the release of Windows 8, the company tried to follow the strategy of hiding various addresses of system functions and objects.  Some of these features were delivered as updates for Windows 7. The presence of such information at predictable addresses for attackers greatly reduces the capabilities of existing DEP &amp; ASLR technologies and increases the likelihood of attackers' success in exploitation. <br><br>  One striking example is the <a href="http://technet.microsoft.com/en-us/security/bulletin/ms13-031">MS13-031</a> update, which introduces a limit on memory allocation for a zero page (Windows 7+).  Placing the code on this page and then exploiting the vulnerability in the driver is used by the attackers as LPE, that is, raising their privileges to system privileges and executing their code in kernel mode.  The kernel uses the <i>EPROCESS! LowVaAccessible field</i> to handle such situations, namely, to find the minimum address from which virtual memory regions can be backed up. <br><br>  Another example is the <a href="https://technet.microsoft.com/en-us/security/bulletin/ms13-063">MS13-063</a> update for Windows Vista + (Windows 8 by default).  This update removes from UserSharedData (KUSER_SHARED_DATA) a pointer to <i>ntdll! LdrHotPatchRoutine</i> , which was used to quickly load the necessary attacking library into memory.  UserSharedData is very useful for attackers, because it is available at the same address in all processes, and is also used in kernel mode. <br><br>  In Windows 8.1, it became possible to hide information about the addresses of kernel objects for untrusted applications (whose Integrity Level &lt;Medium).  In more detail about this function we wrote <a href="http://habrahabr.ru/company/eset/blog/202548/">here</a> .  Important ntoskrnl functions return an error status for a request to obtain information about the addresses of various kernel objects. <br><br>  PS You can use Microsoft's free <a href="http://www.microsoft.com/en-us/download/details.aspx%3Fid%3D11910">BinScope</a> tool to test the modules of your programs for ASLR support (iTunes is taken as an example). <br><br><img src="https://habrastorage.org/getpro/habr/post_images/9ad/280/802/9ad2808025f9dbd6d536cf351a08d714.png"><br><br><img src="https://habrastorage.org/getpro/habr/post_images/83d/3c3/f5b/83d3c3f5be911e29def97be3aabf6398.png"><br><br>  <a href="http://blogs.technet.com/b/srd/archive/2013/12/11/software-defense-mitigating-common-exploitation-techniques.aspx">blogs.technet.com/b/srd/archive/2013/12/11/software-defense-mitigating-common-exploitation-techniques.aspx</a> </div><p>Source: <a href="https://habr.com/ru/post/206244/">https://habr.com/ru/post/206244/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../206230/index.html">Filtering SharePoint lists, address bar settings</a></li>
<li><a href="../206234/index.html">Tasks for interviews in Yandex</a></li>
<li><a href="../206236/index.html">Per capita e-rubbish - an interactive map shows the reality of each country</a></li>
<li><a href="../206238/index.html">Distributing servers: December contest</a></li>
<li><a href="../206242/index.html">Developers from Google have made the Amiga 500 emulator for Chrome</a></li>
<li><a href="../206248/index.html">Bitcoin try to integrate with torrents</a></li>
<li><a href="../206250/index.html">3D printer Thinker Thing will print your thoughts</a></li>
<li><a href="../206252/index.html">Roofs, water and iron pipes - Nokia Lumia 1020 in the hands of photoextreme</a></li>
<li><a href="../206256/index.html">Python Meetup: November Meeting</a></li>
<li><a href="../206258/index.html">How and why I decided to start my own business</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>