<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Graphic VGA-controller on SoC without HDL knowledge</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello! 
 In a previous article, my colleague Des333 implemented a framebuffer for an LCD that runs on an ILI9341 graphics controller. However, writing...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Graphic VGA-controller on SoC without HDL knowledge</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/427/307/1ac/4273071acff64abdbc563cca9e4bb357.jpg"><br>  Hello! <br>  In <a href="https://habrahabr.ru/company/metrotek/blog/263571/">a previous article,</a> my colleague <a href="https://habrahabr.ru/users/des333/" class="user_link">Des333</a> implemented a framebuffer for an LCD that runs on an <a href="http://www.newhavendisplay.com/app_notes/ILI9341.pdf">ILI9341</a> graphics controller.  However, writing it required substantial experience in developing the RTL code. <br><br>  In addition, not everyone has an embedded LCD display at hand, but for sure there is a monitor with a VGA input. What can you do if there is not enough development experience for FPGA, but there is SoC, but do you want to do something interesting? <br><br>  In this article we will describe how to develop a graphics controller, having a board with SoC (Altera Cyclone V), a display with VGA and minimal knowledge of HDL languages ‚Äã‚Äã(in our case, Verilog). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      For example, we will use our scarves, but everything described will work on others. <br>  Who cares, I ask under the cat. <br><br><a name="habracut"></a><br><br>  I plan to tell in the following order: <br><ol><li>  First, a little about the interaction architecture </li><li>  Briefly about connecting to VGA </li><li>  How to get the firmware using only Quartus Qsys </li><li>  How to explain to the kernel that there is a graphics controller.  I'll tell you what to add to dtb and build drivers </li><li>  How to get the terminal and X on the display </li></ol><br><br>  I will use the <a href="http://metrotek.spb.ru/cbcvsom.html">CB-CV-SOM</a> debug card that works in conjunction with the <a href="http://metrotek.spb.ru/cyclonevsom.html">CV-SE-SOM</a> SoDIMM module: <br><img src="https://habrastorage.org/files/9d4/ca0/9d4/9d4ca09d479f4318a6288234cbe28d55.jpg"><br>  We have a shield for this debug board, in addition to VGA there are many interesting things (see <a href="http://metrotek.spb.ru/cbcvsom.html">metrotek.spb.ru/cbcvsom.html</a> ) <br><br><h1>  <font color="#000000">Architecture</font> </h1><br><br>  To display the image on the display, we need a <a href="https://ru.wikipedia.org/wiki/Linux_framebuffer">framebuffer</a> , a driver and a scanning module, which will provide a link between the processor and the display, as well as provide a continuous frame update. <br><br>  In SoC, the ARM (also called HPS - Hard Processing System) is connected to DDR3 memory (1 GB in our case), and it will contain our framebuffer.  And in the FPGA there will be a module that we will need to do with Qsys. <br><br>  Here is the diagram: <br><br><img src="https://habrastorage.org/files/a54/2d4/39c/a542d439c753479d8f9d9c2050d791a6.JPG"><br><br>  Everything will work like this: <br><ul><li>  The driver configures the module in the FPGA: after that, the module is ready to receive data from the SDRAM controller and ‚Äúdeploy‚Äù it to the display </li><li>  In <b>/ dev / fb0</b> write the picture.  Data gets into framebuffer in DDR </li><li>  A module in the FPGA continuously reads the framebuffer and updates the screen. </li></ul><br><br><h1>  <font color="#000000">How does VGA work</font> </h1><br><br>  VGA (Video Graphics Array) is a video interface that uses an analog signal to transmit color information.  The format of the signals and their behavior are similar to the television signal. <br>  List of signals: <br>  <b>vga_vs_o</b> - vertical sync <br>  <b>vga_hs_o</b> - horizontal sync <br>  <b>vga_r_o</b> - data of the red pixel component <br>  <b>vga_g_o</b> - data of the green pixel component <br>  <b>vga_b_o</b> - data is the blue component of the pixel <br><br>  Shield supports 16 bits per color, which means that 5 bits are allocated to blue and red, and 6 bits to green. DAC is made according to the R2R scheme. <br><br>  Monitors have different resolutions and image refresh rates.  These parameters are adjusted in VGA using vertical and horizontal synchronization.  Which have the following parameters: <br><ol><li>  The clock frequency of the appearance of new pixels. </li><li>  Front porch - sync pulse quenching time. </li><li>  Back porch is the rise time of the sync pulse. </li><li>  Sync - the duration of synchronization. </li><li>  Display Area is the point in time when information is transmitted. </li></ol><br><br>  Timeliness looks like this: <br><br><img src="https://habrastorage.org/files/2ad/423/790/2ad42379031441c4b21ddaed599e2e10.png"><br><br>  We will use the VGA 800x600 mode at 60 Hz, so the parameters are as follows ( <a href="https://marsohod.org/projects/marsohod2/278-vhdlvga">parameters for other modes</a> ): <br>  Clock frequency 40 MHz <br>  Horizontal sync: <br><ul><li>  Front porch 40 pixels </li><li>  Back porch 88 pixels </li><li>  Sync 128 pixels </li><li>  Display Area 800 pixels </li></ul><br>  Vertical sync: <ul><li>  Front porch 1 lines </li><li>  Back porch 23 lines </li><li>  Sync 4 lines </li><li>  Display Area 600 lines </li></ul><br><br><h1>  <font color="#000000">FPGA Firmware</font> </h1><br><br>  To get the firmware, we need the following modules in Qsys: <br><ul><li>  <b>HPS</b> is our processor. </li><li>  <b>Frame Reader</b> is an IP core that reads frames stored in external memory and displays them as a video stream. </li><li>  <b>Clocked Video Output</b> is an IP core, from Avalon-ST it makes a VGA output in a similar format. </li><li>  <b>Altera PLL</b> - PLL to change the clock frequency: we need to get 40 MHz from 25 MHz, which is on the board. </li></ul><br><br>  The processor comes with <a href="http://www.gstitt.ece.ufl.edu/courses/fall15/eel4720_5721/labs/refs/AXI4_specification.pdf">AXI</a> H2F and F2H interfaces, the Altera IP cores have <a href="http://www.altera.com/literature/manual/mnl_avalon_spec.pdf">Avalon-ST and Avalon-MM</a> interfaces, so an Interconnect module is also needed, which must convert from one interface to another and multiplex data streams.  It will appear automatically when generating files. <br><br>  Learn more about Frame Reader and Clocked Video Output <a href="https://www.altera.com/literature/ug/ug_vip.pdf">here</a> . <br>  How to assemble the firmware and what settings are needed for HPS can be found in this <a href="https://habrahabr.ru/company/metrotek/blog/235707/">article</a> . <br><br><h3>  <font color="#000000">Altera pll</font> </h3><br>  PLL settings. <br><div class="spoiler">  <b class="spoiler_title">Altera pll</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/03a/8f9/b1a/03a8f9b1a5c14eedb92dc96b0db4d03f.jpg"><br></div></div><br><br><h3>  <font color="#000000">Frame reader</font> </h3><br>  Here are configured: <br><ul><li>  FIFO Parameters at the Module Input </li><li>  Data transfer settings </li><li>  Number of active pixels </li></ul><br>  The parameters <b>Bits per pixel per color plane</b> and <b>Number of color planes in parallel</b> are associated with the driver and are explained below.  Please note that the dimension of the interface with HPS coincides with the dimension of the <b>Master port width</b> . <br><div class="spoiler">  <b class="spoiler_title">Frame reader</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/db9/ae3/4ef/db9ae34efde64046a5b6ded9e63e49cd.png"><br></div></div><br><h3>  <font color="#000000">Clocked Video Output</font> </h3><br>  Here: <br><ul><li>  Sync settings (vga_vs_o, vga_hs_o), which were described above </li><li>  The way in which the data comes (it is the same as that of the Frame Reader) </li></ul><br><div class="spoiler">  <b class="spoiler_title">Clocked Video Output</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/3f5/0ce/ee9/3f50ceee92e94d4fa6f64e6b5b4772f7.jpg"><br></div></div><br><br><h3>  <font color="#000000">Qsys Connections</font> </h3><br>  And now we connect everything.  Settings for the Frame Reader module are ‚Äúhooked‚Äù to the h2f master, an interface for transferring f2h slave data.  We connect Clocked Video Output with Frame Reader avalon_streaming_source -&gt; din.  Everything is outclk0 clocked. <br><div class="spoiler">  <b class="spoiler_title">Qsys Connections</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/7f1/510/a0f/7f1510a0f92d4f81af6bd2d5ec44fae0.jpg"><br></div></div><br><br>  And generate files by clicking <b>Generate HDL ....</b> <br><br>  As mentioned above, the board is 16 bits, and 32 bits come out of the module, so you need to carefully assign the pins in the qsf file, or edit the output for yourself conveniently in the top project file.  We need high bits of each color, they are more informative than low bits. <br><br>  Please note that this is the first and only place where we edit the code.  This is no longer required. <br><br><pre><code class="vhdl hljs">logic vga_v_sync; logic vga_h_sync; logic [<span class="hljs-number"><span class="hljs-number">31</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>] vga_data; logic [<span class="hljs-number"><span class="hljs-number">7</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>] vid_r; logic [<span class="hljs-number"><span class="hljs-number">7</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>] vid_g; logic [<span class="hljs-number"><span class="hljs-number">7</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>] vid_b; assign vga_r_o = vid_r[<span class="hljs-number"><span class="hljs-number">7</span></span>:<span class="hljs-number"><span class="hljs-number">3</span></span>]; assign vga_g_o = vid_g[<span class="hljs-number"><span class="hljs-number">7</span></span>:<span class="hljs-number"><span class="hljs-number">2</span></span>]; assign vga_b_o = vid_b[<span class="hljs-number"><span class="hljs-number">7</span></span>:<span class="hljs-number"><span class="hljs-number">3</span></span>]; assign vga_hs_o = vga_h_sync; assign vga_vs_o = vga_v_sync; assign { vid_r, vid_g, vid_b } = vga_data;</code> </pre> <br><br><h1>  <font color="#000000">Driver and dtb</font> </h1><br><br>  We need an <a href="">altvipfb</a> driver. <br><br>  Let us return to the parameters <b>Bits per pixel per color plane</b> and <b>Number of color planes in parallel</b> in <b>Frame Reader</b> .  The driver says: <br><pre> <code class="objectivec hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (bits_per_color != <span class="hljs-number"><span class="hljs-number">8</span></span>) { dev_err(&amp;fbdev-&gt;pdev-&gt;dev, <span class="hljs-string"><span class="hljs-string">"bits-per-color is set to %i. Curently only 8 is supported."</span></span>, bits_per_color); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> -ENODEV; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!(fbdev-&gt;mem_word_width &gt;= <span class="hljs-number"><span class="hljs-number">32</span></span> &amp;&amp; fbdev-&gt;mem_word_width % <span class="hljs-number"><span class="hljs-number">32</span></span> == <span class="hljs-number"><span class="hljs-number">0</span></span>)) { dev_err(&amp;fbdev-&gt;pdev-&gt;dev, <span class="hljs-string"><span class="hljs-string">"mem-word-width is set to %i. must be &gt;= 32 and multiple of 32."</span></span>, fbdev-&gt;mem_word_width); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> -ENODEV; }</code> </pre><br><br>  The number of bits per color is only 8 and the word width must be greater or a multiple of 32. What is the reason for this restriction?  Look further and see: <br><br><pre> <code class="objectivec hljs"><span class="hljs-comment"><span class="hljs-comment">/* settings for 32bit pixels */</span></span> info-&gt;var.red.offset = <span class="hljs-number"><span class="hljs-number">16</span></span>; info-&gt;var.red.length = <span class="hljs-number"><span class="hljs-number">8</span></span>; info-&gt;var.red.msb_right = <span class="hljs-number"><span class="hljs-number">0</span></span>; info-&gt;var.green.offset = <span class="hljs-number"><span class="hljs-number">8</span></span>; info-&gt;var.green.length = <span class="hljs-number"><span class="hljs-number">8</span></span>; info-&gt;var.green.msb_right = <span class="hljs-number"><span class="hljs-number">0</span></span>; info-&gt;var.blue.offset = <span class="hljs-number"><span class="hljs-number">0</span></span>; info-&gt;var.blue.length = <span class="hljs-number"><span class="hljs-number">8</span></span>; info-&gt;var.blue.msb_right = <span class="hljs-number"><span class="hljs-number">0</span></span>;</code> </pre><br><br>  It becomes clear that the driver works in the <b>True color</b> mode, writing the color in a 32-bit word (it is more convenient to align than 24), and it works only in this mode. <br><br>  In order to build this driver, the following changes need to be made in the kernel config. <br><br><pre> <code class="objectivec hljs">CONFIG_FB_CFB_FILLRECT=m CONFIG_FB_CFB_COPYAREA=m CONFIG_FB_CFB_IMAGEBLIT=m CONFIG_FB_ALTERA_VIP=m</code> </pre><br><br>  In order for linux to know that we have a frame from Altera in the FPGA, the following magic words need to be written in dtb: <br><pre> <code class="objectivec hljs">hps_0_h2f: bridge@<span class="hljs-number"><span class="hljs-number">0xc0000000</span></span> { compatible = <span class="hljs-string"><span class="hljs-string">"altr,bridge-1.0"</span></span>, <span class="hljs-string"><span class="hljs-string">"simple-bus"</span></span>; reg = &lt; <span class="hljs-number"><span class="hljs-number">0xc0000000</span></span> <span class="hljs-number"><span class="hljs-number">0x20000000</span></span> &gt;; <span class="hljs-meta"><span class="hljs-meta">#address-cells = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt; 1 &gt;</span></span></span><span class="hljs-meta">; #size-cells = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt; 1 &gt;</span></span></span><span class="hljs-meta">; ranges = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;0x00000000 0xc0000000 0x4080 &gt;</span></span></span><span class="hljs-meta">; alt_vip_vfr_1: vip2@0x0 { compatible = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ALTR,vip-frame-reader-13.0"</span></span></span><span class="hljs-meta">, </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ALTR,vip-frame-reader-9.1"</span></span></span><span class="hljs-meta">; reg = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt; 0x4000 0x00000080 &gt;</span></span></span><span class="hljs-meta">; max-width = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt; 800 &gt;</span></span></span><span class="hljs-meta">; /* MAX_IMAGE_WIDTH type NUMBER */ max-height = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt; 600 &gt;</span></span></span><span class="hljs-meta">; /* MAX_IMAGE_HEIGHT type NUMBER */ mem-word-width = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt; 0x80 &gt;</span></span></span><span class="hljs-meta">; bits-per-color = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt; 0x8 &gt;</span></span></span><span class="hljs-meta">; }; };</span></span></code> </pre><br><br>  In the <b>range</b> parameter, the range of valid addresses from which the driver will read, and in <b>reg = &lt;0x4000 0x00000080&gt;</b> , the starting address and how many addresses are occupied by alt_vip.  <b>Mem-word-width</b> is the <b>Master port width</b> parameter in <b>Frame Reader</b> . <br><br>  Read more about <a href="https://habrahabr.ru/company/metrotek/blog/271983/">dtb</a> . <br><br><h1>  <font color="#000000">Starting the terminal and X's</font> </h1><br><br>  Go to the device and load the driver: <br><pre> <code class="bash hljs">modprobe altvipfb modprobe fbcon</code> </pre><br><br>  Then we check if everything is good with the help of dmesg, and see if there is a similar line: <br><pre> <code class="bash hljs">[ 66.424283] altvipfb c0000000.vip2: fb0: altvipfb frame buffer device at 0x2c000000+0x12c000</code> </pre><br><br>  Hooray!  Fb0 appeared: <br><pre> <code class="bash hljs">ls -l /dev/fb0 crw-rw---T 1 root fb 29, 0 Nov 26 10:13 /dev/fb0</code> </pre><br><br>  Then we display the console on the screen connected to the board: <br><pre> <code class="bash hljs">/sbin/getty 38400 tty1</code> </pre><br>  Set <a href="https://ru.wikipedia.org/wiki/IceWM">icewm</a> and start with startx: <br><br><pre> <code class="bash hljs">apt-get install icewm icewm-themes startx</code> </pre><br><br><div class="spoiler">  <b class="spoiler_title">Icewm</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/f9d/58f/b4e/f9d58fb4e109441394bd32fe42b5da17.jpg"><br></div></div><br><br>  Total: we got a graphics controller, with minimal knowledge of HDL languages. </div><p>Source: <a href="https://habr.com/ru/post/282189/">https://habr.com/ru/post/282189/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../282175/index.html">ITMO University Digest: # 1 Education and Science</a></li>
<li><a href="../282179/index.html">How I hacked Facebook and found someone else's backdoor</a></li>
<li><a href="../282181/index.html">Features of national management</a></li>
<li><a href="../282183/index.html">3D printer calibration</a></li>
<li><a href="../282187/index.html">VoIP Part 1</a></li>
<li><a href="../282191/index.html">Rendering UTF-8 text using an SDF font</a></li>
<li><a href="../282193/index.html">"Peeped" - the path from the idea for the VK Mobile Challenge to the real product</a></li>
<li><a href="../282195/index.html">On the way to creating your own online store engine</a></li>
<li><a href="../282197/index.html">The release of Ubuntu 16.04 LTS - Snap, OpenStack and other innovations. There may be problems with AMD video cards</a></li>
<li><a href="../282199/index.html">Robokassa stopped working with individual entrepreneurs and individuals</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>