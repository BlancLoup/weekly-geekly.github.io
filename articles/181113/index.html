<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>New in Cach√© 2013.1 DBMS: Integrated WebSockets Support</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In one of the previous articles , work with WebSocket was already considered using the example of its own server implementation of this protocol over ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>New in Cach√© 2013.1 DBMS: Integrated WebSockets Support</h1><div class="post__text post__text-html js-mediator-article">  In one of the previous <a href="http://habrahabr.ru/company/intersystems/blog/144311/">articles</a> , work with WebSocket was already considered using the example of its own server implementation of this protocol over ordinary sockets. <br><br>  In Cach√© 2013.1, the CSP Gateway now includes support for the HTML 5 specification for WebSocket connections between a web server and an HTML 5 compatible browser.  This feature is available for Apache 2.2 and higher, and for IIS 8.0, which is part of Windows Server 2012. <br><br>  Since Apache 2.4 is already built into Cach√© 2013.1, we‚Äôll run our examples on it. <br>  For the implementation of the client part, the <a href="http://www.intersystems.ru/cache/technology/components/zen/index.html">ZEN</a> framework was used, but you can convert examples to <a href="http://www.intersystems.ru/cache/technology/components/csp/index.html">CSP</a> technology or any other. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <a name="habracut"></a>  So let's get started. <br><br><h4>  Theory </h4><br>  As mentioned above, now all the internal logic for WebSocket support on the server side of the Cach√© DBMS takes over.  The programmer is only required to create his own class, inheriting it from the <b>% CSP.WebSocket</b> class, and override several methods in it. <br>  The object of class <b>% CSP.WebSocket</b> serves as an event handler for communication between the client and server using the WebSocket protocol.  All WebSocket servers are inherited from <b>% CSP.WebSocket</b> . <br>  A detailed description of the methods and properties of the <a href="">% CSP.WebSocket</a> class can be found in the class reference. <br>  Here I will note briefly some of them: <br><table><tbody><tr><th>  Method / Property </th><th>  Description </th></tr><tr><td>  <i>Read ()</i> </td><td>  get data from client </td></tr><tr><td>  <i>Write ()</i> </td><td>  send data to customer </td></tr><tr><td>  <i>OnPreServer ()</i> </td><td>  PreServer event handler: called before starting the WebSocket server </td></tr><tr><td>  <i>OnPostServer ()</i> </td><td>  event handler PostServer: called after stopping WebSocket server </td></tr><tr><td>  <i>Server ()</i> </td><td>  actually the websocket server itself </td></tr><tr><td>  <i>EndServer ()</i> </td><td>  stop websocket server </td></tr><tr><td>  <i>AtEnd</i> </td><td>  the property is true (1) when, while reading, the WebSocket server reaches the end of the current data frame </td></tr><tr><td>  <i>SharedConnection</i> </td><td>  the property determines whether the information exchange between the client and the WebSocket server will occur over a dedicated CSP-Gateway connection or through a pool of shared connections (not yet used) </td></tr></tbody></table><br><h4>  Practice </h4><br>  Let's look at a simple example of how all this can be used in practice. <br>  First, create a ZEN page in the <b><font color="green">USER</font></b> Studio - the <b>demo.WebSocket</b> class - and inherit it from the <b>% CSP.WebSocket</b> class: <blockquote>  <font color="#000080">Class demo.WebSocket Extends</font> <font color="#000000">(</font> <font color="#000080">% ZEN.Component.page</font> <font color="#000000">,</font> <font color="#000080">% CSP.WebSocket</font> <font color="#000000">)</font> <font color="#000000"><br></font>  <font color="#000000">{</font> <font color="#000000"><br><br></font>  <font color="#000080">XData</font> <font color="#000000">Contents [</font> <font color="#000080">XMLNamespace</font> <font color="#000000">=</font> <font color="#800080">" <a href="http://www.intersystems.com/zen%2522%25C2%25A0">www.intersystems.com/zen"</a></font> <font color="#000000">]</font> <font color="#000000"><br></font>  <font color="#000000">{</font> <font color="#000000"><br></font>  <font color="#000000">&lt;</font> <font color="#000080">page</font> <font color="#800000">xmlns</font> <font color="#000000">=</font> <font color="#008000">" <a href="http://www.intersystems.com/zen%2522%25C2%25A0">www.intersystems.com/zen"</a></font> <font color="#800000">title</font> <font color="#000000">=</font> <font color="#008000">""</font> <font color="#000000">&gt;</font> <font color="#000000"><br></font>  <font color="#000000">&lt;/</font> <font color="#000080">page</font> <font color="#000000">&gt;</font> <font color="#000000"><br></font>  <font color="#000000">}</font> <font color="#000000"><br><br></font>  <font color="#000000">}</font> </blockquote><br>  Connect the <i>zenCSLM.js</i> file to support working with JSON: <blockquote>  <font color="#000080">Parameter</font> <font color="#000000">JSINCLUDES =</font> <font color="#800080">"zenCSLM.js"</font> <font color="#000000">;</font> </blockquote><br>  We implement methods for connecting the client via WebSocket and processing the corresponding events: <blockquote>  <font color="#000080">/// This client event, if present, is the fired when the page is loaded.</font> <font color="#000080"><br></font>  <font color="#000080">ClientMethod</font> <font color="#000000">onloadHandler () [</font> <font color="#000080">Language</font> <font color="#000000">= javascript]</font> <font color="#000000"><br></font>  <font color="#000000">{</font> <font color="#000000"><br></font>  <font color="#000000">ws</font> <font color="#000080">=</font> <font color="#000000">null;</font> <font color="#000000"><br><br></font>  <font color="#000000">url</font> <font color="#000080">=</font> <font color="#000000">((window.location.protocol</font> <font color="#000080">==</font> <font color="#800000">'https:'</font> <font color="#000000">)</font> <font color="#000080">?</font> <font color="#800000">'wss:'</font> <font color="#000080">:</font> <font color="#800000">'ws:'</font> <font color="#000000">)</font> <font color="#000080">+</font> <font color="#800000">'//'</font> <font color="#000080">+</font> <font color="#000000">window.location.host</font> <font color="#000080">+</font> <font color="#000000">window.location.pathname;</font> <font color="#000000"><br><br></font>  <font color="#000000">wsCtor</font> <font color="#000080">=</font> <font color="#000000">window [</font> <font color="#800000">'MozWebSocket'</font> <font color="#000000">]</font> <font color="#000080">?</font>  <font color="#000000">MozWebSocket</font> <font color="#000080">:</font> <font color="#000000">window [</font> <font color="#800000">'WebSocket'</font> <font color="#000000">]</font> <font color="#000080">?</font>  <font color="#000000">WebSocket</font> <font color="#000080">:</font> <font color="#000000">null;</font> <font color="#000000"><br><br></font>  <font color="#008000">if</font> <font color="#000000">(zenIsMissing (wsCtor)) zenAlert (</font> <font color="#800000">'WebSocket is NOT supported by your browser!'</font> <font color="#000000">);</font> <font color="#000000"><br></font>  <font color="#000000">}</font> <br><br>  <font color="#000080">ClientMethod</font> <font color="#000000">start () [</font> <font color="#000080">Language</font> <font color="#000000">= javascript]</font> <font color="#000000"><br></font>  <font color="#000000">{</font> <font color="#000000"><br></font>  <font color="#008000">if</font> <font color="#000000">(</font> <font color="#000080">!</font> <font color="#000000">zenIsMissing (wsCtor)) {</font> <font color="#000000"><br></font>  <font color="#008000">if</font> <font color="#000000">(zenIsMissing (ws)) {</font> <font color="#000000"><br></font>  <font color="#000000">ws</font> <font color="#000080">=</font> <font color="#800000">new</font> <font color="#000000">wsCtor (url);</font> <font color="#000000"><br><br></font>  <font color="#000000">ws.onopen</font> <font color="#000080">=</font> <font color="#008080">function</font> <font color="#000000">() {</font> <font color="#000000"><br></font>  <font color="#000000">zenAlert (</font> <font color="#800000">'onopen \ n \ nreadyState:'</font> <font color="#000000">, ws.readyState,</font> <font color="#800000">'\ nbinaryType:'</font> <font color="#000000">, ws.binaryType,</font> <font color="#800000">'\ nbufferedAmount:'</font> <font color="#000000">, ws.bufferedAmount);</font> <font color="#000000"><br></font>  <font color="#000000">};</font> <font color="#000000"><br><br></font>  <font color="#000000">ws.onmessage</font> <font color="#000080">=</font> <font color="#008080">function</font> <font color="#000000">(e) {</font> <font color="#000000"><br></font>  <font color="#000000">zenAlert (e.data);</font> <font color="#000000"><br></font>  <font color="#000000">};</font> <font color="#000000"><br><br></font>  <font color="#000000">ws.onclose</font> <font color="#000080">=</font> <font color="#008080">function</font> <font color="#000000">(e) {</font> <font color="#000000"><br></font>  <font color="#000000">zenAlert (</font> <font color="#800000">'onclose \ n \ nwasClean:'</font> <font color="#000000">, e.wasClean,</font> <font color="#800000">'\ ncode:'</font> <font color="#000000">, e.code,</font> <font color="#800000">'\ nreason:'</font> <font color="#000000">, e.reason);</font> <font color="#000000"><br></font>  <font color="#000000">ws</font> <font color="#000080">=</font> <font color="#000000">null;</font> <font color="#000000"><br></font>  <font color="#000000">};</font> <font color="#000000"><br><br></font>  <font color="#000000">ws.onerror</font> <font color="#000080">=</font> <font color="#008080">function</font> <font color="#000000">(e) {</font> <font color="#000000"><br></font>  <font color="#000000">zenAlert (</font> <font color="#800000">'onerror'</font> <font color="#000000">);</font> <font color="#000000"><br></font>  <font color="#000000">};</font> <font color="#000000"><br></font>  <font color="#000000">}</font> <font color="#000000"><br></font>  <font color="#000000">}</font> <font color="#000000"><br></font>  <font color="#000000">}</font> </blockquote><br>  Since the WebSocket server implementation is on the same page, the connection string will be identical except for the protocol.  That is, if the url of our ZEN-page looks like <br> <code><a href="http://localhost/"></a> localhost:57772/csp/user/demo.WebSocket.cls</code> <br>  , it will be for the WebSocket server <br> <code>ws://localhost:57772/csp/user/demo.WebSocket.cls</code> <br> <br>  Now let's add some interface to our page: a few buttons to connect, disconnect and send data to the server: <blockquote>  <font color="#000080">XData</font> <font color="#000000">Contents [</font> <font color="#000080">XMLNamespace</font> <font color="#000000">=</font> <font color="#800080">" <a href="http://www.intersystems.com/zen%2522%25C2%25A0">www.intersystems.com/zen"</a></font> <font color="#000000">]</font> <font color="#000000"><br></font>  <font color="#000000">{</font> <font color="#000000"><br></font>  <font color="#000000">&lt;</font> <font color="#000080">page</font> <font color="#800000">xmlns</font> <font color="#000000">=</font> <font color="#008000">" <a href="http://www.intersystems.com/zen%2522%25C2%25A0">www.intersystems.com/zen"</a></font> <font color="#800000">title</font> <font color="#000000">=</font> <font color="#008000">""</font> <font color="#000000">&gt;</font> <font color="#000000"><br></font>  <font color="#000000">&lt;</font> <font color="#000080">text</font> <font color="#800000">id</font> <font color="#000000">=</font> <font color="#008000">"txt"</font> <font color="#800000">label</font> <font color="#000000">=</font> <font color="#008000">"Text to send"</font> <font color="#800000">value</font> <font color="#000000">=</font> <font color="#008000">"World"</font> <font color="#000000">/&gt;</font> <font color="#000000"><br></font>  <font color="#000000">&lt;</font> <font color="#000080">button</font> <font color="#800000">caption</font> <font color="#000000">=</font> <font color="#008000">"1.Connect"</font> <font color="#800000">onclick</font> <font color="#000000">=</font> <font color="#008000">"zenPage.start ();"</font>  <font color="#000000">/&gt;</font> <font color="#000000"><br></font>  <font color="#000000">&lt;</font> <font color="#000080">button</font> <font color="#800000">caption</font> <font color="#000000">=</font> <font color="#008000">"2.Send text"</font> <font color="#800000">onclick</font> <font color="#000000">=</font> <font color="#008000">"if (! zenIsMissing (ws)) ws.send (zenGetProp ('txt', 'value'));"</font>  <font color="#000000">/&gt;</font> <font color="#000000"><br></font>  <font color="#000000">&lt;</font> <font color="#000080">button</font> <font color="#800000">caption</font> <font color="#000000">=</font> <font color="#008000">"3.Send a long line"</font> <font color="#800000">onclick</font> <font color="#000000">=</font> <font color="#008000">"zenPage.sendLongStr (100000);"</font>  <font color="#000000">/&gt;</font> <font color="#000000"><br></font>  <font color="#000000">&lt;</font> <font color="#000080">button</font> <font color="#800000">caption</font> <font color="#000000">=</font> <font color="#008000">"4.Send JSON"</font> <font color="#800000">onclick</font> <font color="#000000">=</font> <font color="#008000">"zenPage.sendJSON ();"</font>  <font color="#000000">/&gt;</font> <font color="#000000"><br></font>  <font color="#000000">&lt;</font> <font color="#000080">button</font> <font color="#800000">caption</font> <font color="#000000">=</font> <font color="#008000">"5. Turn off"</font> <font color="#800000">onclick</font> <font color="#000000">=</font> <font color="#008000">"if (! zenIsMissing (ws)) ws.close ();"</font>  <font color="#000000">/&gt;</font> <font color="#000000"><br></font>  <font color="#000000">&lt;/</font> <font color="#000080">page</font> <font color="#000000">&gt;</font> <font color="#000000"><br></font>  <font color="#000000">}</font> </blockquote><br>  The <i>sendLongStr</i> method <i>code is</i> as follows: <blockquote>  <font color="#000080">ClientMethod</font> <font color="#000000">sendLongStr (</font> <font color="#ff00ff">N</font> <font color="#000000">) [</font> <font color="#000080">Language</font> <font color="#000000">= javascript]</font> <font color="#000000"><br></font>  <font color="#000000">{</font> <font color="#000000"><br></font>  <font color="#008000">if</font> <font color="#000000">(zenIsMissing (ws))</font> <font color="#008000">return</font> <font color="#000000">;</font> <font color="#000000"><br><br></font>  <font color="#008080">var</font> <font color="#000000">s</font> <font color="#000080">=</font> <font color="#800000">'a'</font> <font color="#000000">;</font> <font color="#000000"><br></font>  <font color="#008000">for</font> <font color="#000000">(</font> <font color="#008000">var</font> <font color="#000000">i</font> <font color="#000080">= 1</font> <font color="#000000">; i</font> <font color="#000080">&lt;</font> <font color="#000000">N; i</font> <font color="#000080">++</font> <font color="#000000">) s</font> <font color="#000080">+ =</font> <font color="#800000">'a'</font> <font color="#000000">;</font> <font color="#000000"><br></font>  <font color="#000000">ws.send (s);</font> <font color="#000000"><br></font>  <font color="#000000">}</font> </blockquote><br>  The code of the <i>sendJSON</i> method: <blockquote>  <font color="#000080">ClientMethod</font> <font color="#000000">sendJSON () [</font> <font color="#000080">Language</font> <font color="#000000">= javascript]</font> <font color="#000000"><br></font>  <font color="#000000">{</font> <font color="#000000"><br></font>  <font color="#008000">if</font> <font color="#000000">(zenIsMissing (ws))</font> <font color="#008000">return</font> <font color="#000000">;</font> <font color="#000000"><br><br></font>  <font color="#008080">var</font> <font color="#000000">obj</font> <font color="#000080">=</font> <font color="#000000">{</font> <font color="#000000"><br></font>  <font color="#800000">"firstName"</font> <font color="#000000">:</font> <font color="#800000">"Ivan"</font> <font color="#000000">,</font> <font color="#000000"><br></font>  <font color="#800000">"lastName"</font> <font color="#000000">:</font> <font color="#800000">"Ivanov"</font> <font color="#000000">,</font> <font color="#000000"><br></font>  <font color="#800000">"address"</font> <font color="#000000">: {</font> <font color="#000000"><br></font>  <font color="#800000">"streetAddress"</font> <font color="#000000">:</font> <font color="#800000">"Moskovskoye sh., 101, ap. 101"</font> <font color="#000000">,</font> <font color="#000000"><br></font>  <font color="#800000">"city"</font> <font color="#000000">:</font> <font color="#800000">"Leningrad"</font> <font color="#000000">,</font> <font color="#000000"><br></font>  <font color="#800000">"postalCode"</font> <font color="#000000">:</font> <font color="#000080">101101</font> <font color="#000080"><br></font>  <font color="#000000">},</font> <font color="#000000"><br></font>  <font color="#800000">"phoneNumbers"</font> <font color="#000000">: [</font> <font color="#000000"><br></font>  <font color="#800000">"812 123-1234"</font> <font color="#000000">,</font> <font color="#000000"><br></font>  <font color="#800000">"916 123-4567"</font> <font color="#800000"><br></font>  <font color="#000000">]</font> <font color="#000000"><br></font>  <font color="#000000">};</font> <font color="#000000"><br><br></font>  <font color="#000000">ws.send (ZLM.jsonStringify (obj));</font> <font color="#000000"><br></font>  <font color="#000000">}</font> </blockquote><br>  It's time to implement our own WebSocket server itself.  To do this, override the <i>OnPreServer</i> , <i>OnPostServer</i> and <i>Server</i> methods, as shown below: <blockquote>  <font color="#000080">Method</font> <font color="#000000">OnPreServer ()</font> <font color="#000080">As% Status</font> <font color="#000080"><br></font>  <font color="#000000">{</font> <font color="#000000"><br></font>  <font color="#0000ff">Do $ system</font> <font color="#008080">.Process</font> <font color="#000000">.</font>  <font color="#0000ff">Undefined</font> <font color="#000000">(2)</font> <font color="#000000"><br><br></font>  <font color="#0000ff">Set</font> <font color="#000000">^ tmp (</font> <font color="#0000ff">$ Increment</font> <font color="#000000">(^ tmp),</font> <font color="#008000">"OnPreServer"</font> <font color="#000000">) =</font> <font color="#008000">""</font> <font color="#008000"><br></font>  <font color="#0000ff">Quit $$$ OK</font> <font color="#0000ff"><br></font>  <font color="#000000">}</font> </blockquote><br><blockquote>  <font color="#000080">Method</font> <font color="#000000">OnPostServer ()</font> <font color="#000080">As% Status</font> <font color="#000080"><br></font>  <font color="#000000">{</font> <font color="#000000"><br></font>  <font color="#0000ff">Set</font> <font color="#000000">^ tmp (</font> <font color="#0000ff">$ Increment</font> <font color="#000000">(^ tmp),</font> <font color="#008000">"OnPostServer"</font> <font color="#000000">) =</font> <font color="#008000">""</font> <font color="#008000"><br></font>  <font color="#0000ff">Quit $$$ OK</font> <font color="#0000ff"><br></font>  <font color="#000000">}</font> </blockquote><br><blockquote>  <font color="#000080">Method</font> <font color="#000000">Server ()</font> <font color="#000080">As% Status</font> <font color="#000080"><br></font>  <font color="#000000">{</font> <font color="#000000"><br></font>  <font color="#0000ff">For</font> <font color="#800080">{</font> <font color="#800080"><br><br></font>  <font color="#0000ff">Set</font> <font color="#800000">len</font> <font color="#000000">= 32656</font> <font color="#000000"><br></font>  <font color="#0000ff">Set</font> <font color="#800000">data</font> <font color="#000000">=</font> <font color="#0000ff">$ ZConvert</font> <font color="#000000">(..</font> <font color="#0000ff">Read</font> <font color="#000000">(.</font> <font color="#0000ff">Len,.</font> <font color="#800000">Status</font> <font color="#000000">),</font> <font color="#008000">"I"</font> <font color="#000000">,</font> <font color="#008000">"UTF8"</font> <font color="#000000">)</font> <font color="#000000"><br><br></font>  <font color="#0000ff">If $$$ ISOK</font> <font color="#000000">(</font> <font color="#800000">status</font> <font color="#000000">)</font> <font color="#800080">{</font> <font color="#800080"><br><br></font>  <font color="#0000ff">If</font> <font color="#800000">data</font> <font color="#000000">=</font> <font color="#008000">"World"</font> <font color="#800080">{</font> <font color="#800080"><br></font>  <font color="#0000ff">Do</font> <font color="#000000">..</font> <font color="#0000ff">Write</font> <font color="#000000">(</font> <font color="#0000ff">$ ZConvert</font> <font color="#000000">(</font> <font color="#008000">"Hello,"</font> <font color="#000000">_</font> <font color="#800000">data</font> <font color="#000000">_</font> <font color="#008000">"!"</font> <font color="#000000">,</font> <font color="#008000">"O"</font> <font color="#000000">,</font> <font color="#008000">"UTF8"</font> <font color="#000000">))</font> <font color="#000000"><br></font>  <font color="#800080">}</font> <font color="#0000ff">ElseIf</font> <font color="#800000">data</font> <font color="#000000">=</font> <font color="#008000">"bye"</font> <font color="#800080">{</font> <font color="#800080"><br><br></font>  <font color="#008000">;</font>  <font color="#008000">forcibly shutting down the WebSocket server and exiting an infinite loop</font> <font color="#008000"><br></font>  <font color="#008000">;</font>  <font color="#008000">on the client, this will work onclose</font> <font color="#008000"><br></font>  <font color="#0000ff">Do</font> <font color="#000000">..</font> <font color="#0000ff">EndServer</font> <font color="#000000">()</font> <font color="#000000"><br></font>  <font color="#0000ff">Quit</font> <font color="#0000ff"><br><br></font>  <font color="#800080">}</font> <font color="#0000ff">Else</font> <font color="#800080">{</font> <font color="#800080"><br><br></font>  <font color="#0000ff">#Dim</font> <font color="#800000">obj</font> <font color="#0000ff">As</font> <font color="#008080">% RegisteredObject</font> <font color="#000000">=</font> <font color="#0000ff">$$$ NULLOREF</font> <font color="#0000ff"><br><br></font>  <font color="#0000ff">Set</font> <font color="#000000">^ tmp =</font> <font color="#0000ff">$ Increment</font> <font color="#000000">(^ tmp)</font> <font color="#000000"><br><br></font>  <font color="#008000">;</font>  <font color="#008000">convert string to object</font> <font color="#008000"><br></font>  <font color="#0000ff">If $$$ ISOK</font> <font color="#000000">(</font> <font color="#000080">## class</font> <font color="#000000">(</font> <font color="#008080">% ZEN.Auxiliary.jsonProvider</font> <font color="#000000">).</font> <font color="#0000ff">% ConvertJSONToObject</font> <font color="#000000">(</font> <font color="#800000">data</font> <font color="#000000">,,.</font> <font color="#800000">Obj</font> <font color="#000000">))</font> <font color="#800080">{</font> <font color="#800080"><br><br></font>  <font color="#008000">;</font>  <font color="#008000">if there is no error, save the property values</font> <font color="#008000"><br></font>  <font color="#0000ff">Set</font> <font color="#000000">^ tmp (^ tmp,</font> <font color="#008000">"Server"</font> <font color="#000000">,</font> <font color="#008000">"firstName"</font> <font color="#000000">) =</font> <font color="#800000">obj</font> <font color="#000000">.</font>  <font color="#0000ff">firstName</font> <font color="#0000ff"><br></font>  <font color="#0000ff">Set</font> <font color="#000000">^ tmp (^ tmp,</font> <font color="#008000">"Server"</font> <font color="#000000">,</font> <font color="#008000">"lastName"</font> <font color="#000000">) =</font> <font color="#800000">obj</font> <font color="#000000">.</font>  <font color="#0000ff">lastName</font> <font color="#0000ff"><br></font>  <font color="#0000ff">Set</font> <font color="#000000">^ tmp (^ tmp,</font> <font color="#008000">"Server"</font> <font color="#000000">,</font> <font color="#008000">"address.streetAddress"</font> <font color="#000000">) =</font> <font color="#800000">obj</font> <font color="#000000">.</font>  <font color="#0000ff">address</font> <font color="#000000">.</font>  <font color="#0000ff">streetAddress</font> <font color="#0000ff"><br></font>  <font color="#0000ff">Set</font> <font color="#000000">^ tmp (^ tmp,</font> <font color="#008000">"Server"</font> <font color="#000000">,</font> <font color="#008000">"address.city"</font> <font color="#000000">) =</font> <font color="#800000">obj</font> <font color="#000000">.</font>  <font color="#0000ff">address</font> <font color="#000000">.</font>  <font color="#0000ff">city</font> <font color="#0000ff"><br></font>  <font color="#0000ff">Set</font> <font color="#000000">^ tmp (^ tmp,</font> <font color="#008000">"Server"</font> <font color="#000000">,</font> <font color="#008000">"address.postalCode"</font> <font color="#000000">) =</font> <font color="#800000">obj</font> <font color="#000000">.</font>  <font color="#0000ff">address</font> <font color="#000000">.</font>  <font color="#0000ff">postalCode</font> <font color="#0000ff"><br></font>  <font color="#0000ff">Set</font> <font color="#000000">^ tmp (^ tmp,</font> <font color="#008000">"Server"</font> <font color="#000000">,</font> <font color="#008000">"phoneNumbers.1"</font> <font color="#000000">) =</font> <font color="#800000">obj</font> <font color="#000000">.</font>  <font color="#0000ff">phoneNumbers</font> <font color="#000000">.</font>  <font color="#0000ff">GetAt</font> <font color="#000000">(1)</font> <font color="#000000"><br></font>  <font color="#0000ff">Set</font> <font color="#000000">^ tmp (^ tmp,</font> <font color="#008000">"Server"</font> <font color="#000000">,</font> <font color="#008000">"phoneNumbers.2"</font> <font color="#000000">) =</font> <font color="#800000">obj</font> <font color="#000000">.</font>  <font color="#0000ff">phoneNumbers</font> <font color="#000000">.</font>  <font color="#0000ff">GetAt</font> <font color="#000000">(2)</font> <font color="#000000"><br><br></font>  <font color="#008000">;</font>  <font color="#008000">Change the name</font> <font color="#008000"><br></font>  <font color="#0000ff">Set</font> <font color="#800000">obj</font> <font color="#000000">.</font>  <font color="#0000ff">lastName</font> <font color="#000000">=</font> <font color="#008000">"Sidorov"</font> <font color="#008000"><br><br></font>  <font color="#008000">;</font>  <font color="#008000">Add another phone</font> <font color="#008000"><br></font>  <font color="#0000ff">Do</font> <font color="#800000">obj</font> <font color="#000000">.</font>  <font color="#0000ff">phoneNumbers</font> <font color="#000000">.</font>  <font color="#0000ff">Insert</font> <font color="#000000">(</font> <font color="#008000">"111 111-1111"</font> <font color="#000000">)</font> <font color="#000000"><br><br></font>  <font color="#008000">;</font>  <font color="#008000">Add two more new properties to the object.</font> <font color="#008000"><br></font>  <font color="#0000ff">Set</font> <font color="#800000">obj</font> <font color="#000000">.</font>  <font color="#0000ff">name</font> <font color="#000000">=</font> <font color="#008000">"Vasya"</font> <font color="#008000"><br></font>  <font color="#0000ff">Set</font> <font color="#800000">obj</font> <font color="#000000">.</font>  <font color="#0000ff">street</font> <font color="#000000">=</font> <font color="#008000">"Mira St. 17"</font> <font color="#008000"><br><br></font>  <font color="#008000">;</font>  <font color="#008000">Convert the modified object to a string and send it back to the client.</font> <font color="#008000"><br></font>  <font color="#0000ff">Do</font> <font color="#000000">..</font> <font color="#0000ff">Write</font> <font color="#000000">(..</font> <font color="#0000ff">Write2Str</font> <font color="#000000">(.</font> <font color="#800000">Obj</font> <font color="#000000">))</font> <font color="#000000"><br><br></font>  <font color="#800080">}</font> <font color="#0000ff">Else</font> <font color="#800080">{</font> <font color="#800080"><br><br></font>  <font color="#008000">;</font>  <font color="#008000">save data when getting a long string</font> <font color="#008000"><br></font>  <font color="#0000ff">Set</font> <font color="#000000">^ tmp (^ tmp,</font> <font color="#008000">"Server"</font> <font color="#000000">,</font> <font color="#008000">"longStr"</font> <font color="#000000">) = ..</font> <font color="#0000ff">AtEnd</font> <font color="#000000">_</font> <font color="#008000">":"</font> <font color="#000000">_</font> <font color="#0000ff">$ Length</font> <font color="#000000">(</font> <font color="#800000">data</font> <font color="#000000">) _</font> <font color="#008000">":"</font> <font color="#000000">_</font> <font color="#800000">len</font> <font color="#800000"><br></font>  <font color="#800080">}</font> <font color="#800080"><br></font>  <font color="#800080">}</font> <font color="#800080"><br></font>  <font color="#800080">}</font> <font color="#0000ff">Else</font> <font color="#800080">{</font> <font color="#800080"><br></font>  <font color="#0000ff">Quit</font> <font color="#000000">:(</font> <font color="#0000ff">$$$ GETERRORCODE</font> <font color="#000000">(</font> <font color="#800000">status</font> <font color="#000000">) =</font> <font color="#0000ff">$$$ CSPWebSocketClosed</font> <font color="#000000">)</font> <font color="#000000"><br></font>  <font color="#800080">}</font> <font color="#800080"><br></font>  <font color="#800080">}</font> <font color="#800080"><br></font>  <font color="#0000ff">Quit $$$ OK</font> <font color="#0000ff"><br></font>  <font color="#000000">}</font> </blockquote><br>  The <i>utility</i> method <i>Write2Str</i> is used to assemble into a string, the output of the Write command, data: <blockquote>  <font color="#000080">ClassMethod</font> <font color="#000000">Write2Str (</font> <font color="#000080">ByRef</font> <font color="#ff00ff">obj</font> <font color="#000000">)</font> <font color="#000080">As% String</font> <font color="#000000">[</font> <font color="#000080">Private</font> <font color="#000000">]</font> <font color="#000000"><br></font>  <font color="#000000">{</font> <font color="#000000"><br></font>  <font color="#0000ff">Try</font> <font color="#800080">{</font> <font color="#800080"><br></font>  <font color="#0000ff">Set</font> <font color="#800000">tIO</font> <font color="#000000">=</font> <font color="#0000ff">$ IO</font> <font color="#000000">,</font> <font color="#800000">tXDEV</font> <font color="#000000">=</font> <font color="#008000">"| XDEV |"</font>  <font color="#000000">_ +</font> <font color="#0000ff">$ Job</font> <font color="#0000ff"><br></font>  <font color="#0000ff">Do</font> <font color="#800080">{</font> <font color="#800080"><br><br></font>  <font color="#008000">// For $$$ IsUnicode use UTF-8</font> <font color="#008000"><br></font>  <font color="#0000ff">Open</font> <font color="#800000">tXDEV</font> <font color="#000000">:(</font> <font color="#0000ff">$ ZF</font> <font color="#000000">(-6,</font> <font color="#0000ff">$$$ XSLTLibrary</font> <font color="#000000">, 12):</font> <font color="#008000">""</font> <font color="#000000">:</font> <font color="#008000">"S"</font> <font color="#000000">: / HOSTNAME =</font> <font color="#008000">"XSLT"</font> <font color="#000000">: / IOT =</font> <font color="#0000ff">$ Select</font> <font color="#000000">(</font> <font color="#0000ff">$$$ IsUnicode</font> <font color="#000000">:</font> <font color="#008000">"UTF8"</font> <font color="#000000">, 1:</font> <font color="#008000">" RAW "</font> <font color="#000000">): / IBU = 16384: / OBU = 16384)</font> <font color="#000000"><br></font>  <font color="#0000ff">Use</font> <font color="#800000">tXDEV</font> <font color="#800000"><br><br></font>  <font color="#0000ff">Quit</font> <font color="#000000">:</font> <font color="#0000ff">$$$ ISERR</font> <font color="#000000">(</font> <font color="#800000">obj</font> <font color="#000000">.</font> <font color="#0000ff">% ToJSON</font> <font color="#000000">(,</font> <font color="#008000">"aeloiwu"</font> <font color="#000000">))</font> <font color="#000000"><br><br></font>  <font color="#008000">// Flush any remaining output</font> <font color="#008000"><br></font>  <font color="#0000ff">Write</font> <font color="#000000">* -3</font> <font color="#000000"><br><br></font>  <font color="#008000">// Now read back a string (up to the maximum possible length, 32k or ~ 4MB for long strings)</font> <font color="#008000"><br></font>  <font color="#0000ff">Set</font> <font color="#800000">s</font> <font color="#000000">=</font> <font color="#008000">""</font> <font color="#008000"><br></font>  <font color="#0000ff">While</font> <font color="#000000">(1)</font> <font color="#800080">{</font> <font color="#800080"><br></font>  <font color="#0000ff">#Dim</font> <font color="#800000">tChunk</font> <font color="#0000ff">As</font> <font color="#008080">% String</font> <font color="#008080"><br></font>  <font color="#0000ff">Read</font> <font color="#800000">tChunk</font> <font color="#000000">: 0</font> <font color="#000000"><br></font>  <font color="#0000ff">Quit</font> <font color="#000000">: '</font> <font color="#0000ff">$ Length</font> <font color="#000000">(</font> <font color="#800000">tChunk</font> <font color="#000000">)</font> <font color="#000000"><br></font>  <font color="#0000ff">Set</font> <font color="#800000">s</font> <font color="#000000">=</font> <font color="#800000">s</font> <font color="#000000">_</font> <font color="#800000">tChunk</font> <font color="#800000"><br></font>  <font color="#800080">}</font> <font color="#800080"><br><br></font>  <font color="#800080">}</font> <font color="#0000ff">While</font> <font color="#000000">(0)</font> <font color="#000000"><br></font>  <font color="#800080">}</font> <font color="#0000ff">Catch</font> <font color="#800080">{}</font> <font color="#800080"><br><br></font>  <font color="#0000ff">Close</font> <font color="#800000">tXDEV</font> <font color="#800000"><br></font>  <font color="#0000ff">Use</font> <font color="#800000">tIO</font> <font color="#800000"><br></font>  <font color="#0000ff">Quit</font> <font color="#800000">s</font> <font color="#800000"><br></font>  <font color="#000000">}</font> </blockquote><br>  It remains to compile our class (Ctrl + F7) and open it for viewing in a browser (F5). <br>  After consistently pressing the buttons, the contents of the global ^ tmp will be as follows: <br><br> <code>^tmp=7</code> <br> <code>^tmp(1,"OnPreServer")=""</code> <br> <code>^tmp(2,"Server","longStr")="0:32656:32656"</code> <br> <code>^tmp(3,"Server","longStr")="0:32656:32656"</code> <br> <code>^tmp(4,"Server","longStr")="0:32656:32656"</code> <br> <code>^tmp(5,"Server","longStr")="1:2032:2032"</code> <br> <code>^tmp(6,"Server","address.city")=""</code> <br> <code>^tmp(6,"Server","address.postalCode")=101101</code> <br> <code>^tmp(6,"Server","address.streetAddress")=" ., 101, .101"</code> <br> <code>^tmp(6,"Server","firstName")=""</code> <br> <code>^tmp(6,"Server","lastName")=""</code> <br> <code>^tmp(6,"Server","phoneNumbers.1")="812 123-1234"</code> <br> <code>^tmp(6,"Server","phoneNumbers.2")="916 123-4567"</code> <br> <code>^tmp(7,"OnPostServer")=""</code> <br> <br>  Download the <b>demo.WebSocket</b> class <b>source</b> . </div><p>Source: <a href="https://habr.com/ru/post/181113/">https://habr.com/ru/post/181113/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../181101/index.html">(Kiev) Free course on design solutions based on Cisco UCS and Nexus</a></li>
<li><a href="../181103/index.html">The option of managing a computer on Windows from under the Linux console</a></li>
<li><a href="../181105/index.html">HTC One - many new things in one phone</a></li>
<li><a href="../181107/index.html">Features of the use of interfaces in Delphi</a></li>
<li><a href="../181111/index.html">Using S3cmd in Windows</a></li>
<li><a href="../181117/index.html">Smartphones on Atom. Achievements and prospects</a></li>
<li><a href="../181119/index.html">Micron - the heart of Russian microelectronics</a></li>
<li><a href="../181121/index.html">Kerberos constraint delegation for SharePoint 2010 SP1 and SQL Server 2012 Reporting Services (Named Instance)</a></li>
<li><a href="../181123/index.html">BIDI (unicode bidirectional algorithm)</a></li>
<li><a href="../181125/index.html">Better Place has declared bankruptcy</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>