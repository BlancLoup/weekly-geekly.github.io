<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Single Authorization (SSO) using JASIG CAS. Part 1</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This article was conceived as a practical guide to installing and configuring the server JASIG CAS. I did not set out to explain what Single Sign On (...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Single Authorization (SSO) using JASIG CAS. Part 1</h1><div class="post__text post__text-html js-mediator-article"><img align="right" src="https://habrastorage.org/storage2/9d2/3a7/597/9d23a7597a7d830d72c84693eaae1c46.jpg"><br>  This article was conceived as a practical guide to installing and configuring the server JASIG CAS.  I did not set out to explain what Single Sign On (SSO) is, so if you are not familiar with this concept, then first look at <a href="http://en.wikipedia.org/wiki/Single_sign-on">Wikipedia</a> and the <a href="http://searchsecurity.techtarget.com/definition/single-sign-on">Techtarget</a> portal.  It is also desirable to have experience with Spring and Maven. <br>  The article will consist of <nobr>3</nobr> parts.  In the beginning I will briefly explain why we chose CAS and the features of its protocol.  The rest of the article will be devoted to setting up an authorization service, starting with the configuration of the servlet container and ending with solving some non-trivial issues, such as authorization from the external form and hashing of credentials. <br><a name="habracut"></a><br><h4>  Why JASIG CAS </h4><br>  There are <a href="http://en.wikipedia.org/wiki/List_of_single_sign-on_implementations">many implementations of the</a> idea of ‚Äã‚Äãa single authorization, and I cannot say that JASIG CAS is better at all than its counterparts, however, for several reasons, we stopped at it. <br><ul><li>  <b>JAVA technology stack.</b>  CAS is written entirely in JAVA using Spring.  Maven is used for assembly. </li><li>  <b>Open Source.</b> </li><li>  <b>Support for multiple LDAP implementations.</b> </li><li>  <b>Active community.</b>  Pleasant <a href="http://www.jasig.org/cas/public-api">JASIG portal</a> and <a href="https://wiki.jasig.org/">wiki</a> , there are many articles online. </li><li>  <b>Clients under all popular platforms.</b>  More details can be found here. </li><li>  <b>Support for different authentication methods.</b> </li><li>  <b>Frequent releases.</b> </li><li>  <b>Relative ease of setup.</b>  I hope that thanks to this article, it will become really simple and understandable. </li></ul><br>  If you choose a platform for SSO by the same criteria, then CAS is exactly what you are looking for. <br><br><h4>  How it works </h4><br>  We took as the basis of our SSO service, CAS, working under the protocol of the second version.  Details on this protocol can be found <a href="http://www.jasig.org/cas/protocol">on the JASIG portal</a> .  Below is a diagram of the process, successful authorization in CAS.  I did not find a similar scheme on the JASIG portal, although it seems to me that it should be useful for understanding the process. <br><br><h6>  Legend </h6><br><ul><li>  <b>The client</b> is the user's browser.  Not to be confused with the CAS client. </li><li>  <b>An application</b> is one of your applications that have a CAS client onboard and use a CAS server for authorization. </li><li>  <b>CAS</b> - server or cluster with SSO service deployed on it. </li><li>  <b>ST</b> - service ticket.  Represents a string that is used as client credentials to access the service.  The client receives it in response to the credentials and service identifier provided by the CAS server. </li><li>  <b>TGT</b> (ticket granting ticket) and TGC (ticket granting cookie).  A TGT is a string that serves as an indicator of the client‚Äôs authorized state.  After authorization, it replaces the client credentials.  The TGT value is stored in the TGC installed by the CAS server, after successful client authorization. </li><li>  <b>LT</b> (login ticket).  A string passed along with client credentials.  Used to prevent credentials from being re-processed. </li><li>  <b>SAML</b> (The Security Assertion Markup Language) is an XML-based language developed by OASIS.  Details can be found on <a href="http://www.oasis-open.org/committees/tc_home.php%3Fwg_abbrev%3Dsecurity">the community website.</a> </li></ul>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/storage2/efe/fea/178/efefea17838e10ea2e6824f879e285b9.jpg"><br><br>  Please note that all requests to the SSO server must be via HTTPS.  This is not a requirement of the protocol, however, without this, it is impossible to ensure the security of user credentials. <br>  Another important feature of the protocol is that while checking the values ‚Äã‚Äãof ST + TGT, the CAS client installed in the service being authorized stops the original request and creates a new one.  Those.  At this moment, the client for the CAS server is not the user's browser, but the service being authorized.  This means that the service must be properly configured to create an HTTPS connection.  How to do this I will write a little later.  Processing of the original request to resume only after the verification. <br><br><h4>  Servers, keys, problems </h4><br>  We chose Tomcat as the servlet container.  Information about users is stored in openLDAP, and as the CAS client for applications we most often use the official java client.  At the time of this writing, the <a href="">latest version was 3.1</a> . <br>  SSO configuration begins with the configuration of servlet containers.  In test and combat environments, we do it a little differently. <br>  In the test environment using the <a href="http://docs.oracle.com/javase/1.3/docs/tooldocs/win32/keytool.html">keytool</a> utility, <a href="http://docs.oracle.com/javase/1.3/docs/tooldocs/win32/keytool.html">you</a> need to create a self-signed certificate.  Keytool is a standard utility that is included with any JDK. <br><pre><code class="bash hljs">keytool -genkey -<span class="hljs-built_in"><span class="hljs-built_in">alias</span></span> cas -keypass 12345678 -keystore ssoServer.jks -storepass 12345678 -dname ¬´cn=localhost, ou=webdev, o=ourOrganisation, c=RU¬ª -validity=365</code> </pre> <br>  As a result, we will create a keystore ssoServer.jks and a pair of keys, private and public.  Now you can export the public key from the keystore. <br><pre> <code class="bash hljs">keytool -<span class="hljs-built_in"><span class="hljs-built_in">export</span></span> -<span class="hljs-built_in"><span class="hljs-built_in">alias</span></span> cas -file casServerPublic.cer -keystore ssoServer.jks -storepass 12345678</code> </pre><br>  and, import it into the truststore of trusted certificates for all services that will participate in a single authorization.  On a PC, the command looks like this: <br><pre> <code class="bash hljs">keytool -import -<span class="hljs-built_in"><span class="hljs-built_in">alias</span></span> cas -file %PATH_TO%casServerPublic.cer -keypass 12345678 -keystore JAVA_HOME/jre/lib/security/cacerts cacerts -storepass changeit</code> </pre><br>  On a Mac like this: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># /Library/Java/Home/bin/keytool -import -alias cas -file %PATH_TO_CERTIFICATE%/casServerPublic.cer -keypass 12345678 -keystore /Library/Java/Home/lib/security/cacerts -storepass changeit</span></span></code> </pre><br>  The key import is needed so that the service being authorized can establish an HTTPS connection with the CAS.  Before importing keys, make sure that <br><ul><li>  You are using JAVA version you need.  If you have multiple versions installed, problems may occur. </li><li>  Use the Keytool and the cascerts path of exactly the java that you will use to start the service being authorized. </li><li>  You have rights to import keys into the repository. </li></ul><br>  As a result, you should see the message: <br><pre> <code class="bash hljs">Certificate was added to keystore.</code> </pre><br>  If the message looks wrong or it is followed by some text, it means that you did something wrong, and the key most likely was not imported. <br>  In a combat environment, you will most likely use keys provided by one of the well-known CAs, such as <a href="http://www.thawte.com/">Thawte</a> or <a href="http://www.verisign.com/">Verisign</a> .  In this case, the keys will be in the format pkcs # 7 or x.509 and you will need to first convert them to the format pkcs # 12. <br>  For example, for certificates in X.509 (Base64) format, you need to perform the following sequence of steps: <br><ul><li>  We glue all intermediate certificates into one file.  It should be your certificate first, and then the entire intermediate chain in order. </li><li>  We convert it using OpenSSL to the desired format. <br><pre> <code class="bash hljs">openssl pkcs12 -<span class="hljs-built_in"><span class="hljs-built_in">export</span></span> ‚Äî<span class="hljs-keyword"><span class="hljs-keyword">in</span></span> your.crt ‚Äîinkey your.key ‚Äîout your.p12 -name ¬´cas¬ª</code> </pre><br></li><li>  Check that the key pair is created correctly. <br><pre> <code class="bash hljs">keytool ‚Äîkeystore your.p12 -storetype pkcs12 ‚Äîlist</code> </pre><br></li><li>  And the last step is to create a keystore based on a pair of keys. <br><pre> <code class="bash hljs">keytool -importkeystore -deststorepass 12345678 -destkeypass 12345678 -destkeystore ssoServer.jks -srckeystore your.p12 -srcstoretype PKCS12 -srcstorepass 12345678 -<span class="hljs-built_in"><span class="hljs-built_in">alias</span></span> cas</code> </pre><br></li></ul><br>  The public certificate store has a default password changeit.  In a combat environment, you need to change it. <br>  It remains to configure the connector on tomcat, which will be located CAS.  To do this, we add a connector description to the% TOMCAT-HOME% / conf / server.xml file, for example: <br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Connector</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">port</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"8443"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">protocol</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"org.apache.coyote.http11.Http11NioProtocol"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">SSLEnabled</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">maxThreads</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"150"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">scheme</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"https"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">secure</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">clientAuth</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"false"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">sslProtocol</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"TLS"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">keyAlias</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"cas"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">keystoreFile</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"%PATH_TO%.ssoServer.jks"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">keystorePass</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"12345678"</span></span></span><span class="hljs-tag"> /&gt;</span></span></code> </pre><br>  More information about configuring connectors can be found <a href="http.html">on the documentation page</a> . <br>  In the HTTP combat environment, the connector from server.xml is best removed about sin further). <br><br>  This time all.  In the next part I will tell you how to set up and build a CAS server. </div><p>Source: <a href="https://habr.com/ru/post/142407/">https://habr.com/ru/post/142407/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../142401/index.html">Twitter will remain neutral in patent wars</a></li>
<li><a href="../142402/index.html">Research "Developer Economics 2012"</a></li>
<li><a href="../142403/index.html">Tax closed the largest online store of Ukraine, Rozetka.ua</a></li>
<li><a href="../142404/index.html">Enthusiasts have created a prototype PS4</a></li>
<li><a href="../142405/index.html">"Cloud stick" - flour choice</a></li>
<li><a href="../142408/index.html">Anonymus created their alternative to Pastebin</a></li>
<li><a href="../142409/index.html">Array sizes in java</a></li>
<li><a href="../142410/index.html">SSH and FTP via Dropbox</a></li>
<li><a href="../142411/index.html">New program Facebook Preferred Marketing Developer</a></li>
<li><a href="../142412/index.html">The complexity of multi-storey programming</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>