<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Optimized command system for microcontrollers</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="A little less than a year ago the article "Microprocessor" out of the garage " was published " and, perhaps, now is a good time to remind you of the p...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Optimized command system for microcontrollers</h1><div class="post__text post__text-html js-mediator-article">  A little less than a year ago the article <a href="http://habrahabr.ru/post/222335/">"Microprocessor" out of the garage "</a> was published <a href="http://habrahabr.ru/post/222335/">"</a> and, perhaps, now is a good time to remind you of the project again. <br><br>  Perhaps the main news is the expansion of the command system, called "Version 1.1".  Its difference from the previous one is extended addressing capabilities.  But first things first.  To imagine what is at stake, take a look at the command system map (the image is clickable): <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/711/e3c/d1f/711e3cd1fc82762df83e43d180cb76c4.png" alt="image"></a> <br><a name="habracut"></a><br>  First of all, it was her desire to bring to your court.  When designing the command system, two basic requirements were defined - good extensibility and high code density.  Reserved opcodes are marked in yellow in the picture.  As you can see from the picture, we managed to fulfill the requirements of extensibility.  However, yellow ‚Äúcells‚Äù are not the only opportunity for expansion - some reserve is built into the unused bits of multibyte opcodes.  In addition, two prefixes (NOTCH and KOL) can extend the semantics of opcodes.  As can be seen from the image, the number of single-byte prefixes can be increased without serious consequences.  These factors allow us to declare outstanding expansion opportunities.  But that is not all.  Currently, the maximum instruction length is limited to five bytes - this size was chosen based on the capabilities of our inexpensive FPGA.  Imagine how you can extend the command system if you assign operation codes in the range from 0xf0 to 0xff for longer instructions - six bytes, seven ... the length of the instruction can be limited only by common sense.  So, I hope that no one has any doubts about the possibilities of expanding the system of commands, if you still have them, you are welcome to discuss them in the comments. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      And what about the code density?  Yes, Habr is harsh and does not like fictional data.  According to subjective estimates, the current code density can compete in code density with the first versions of processors with the RISC architecture.  For example, if we consider the very first versions of ARM and MIPS, then it seems that version 1.1 surpasses them in this parameter.  As for x86 and modern RISC, thanks to the wealth of commands from these architectures, the code density is higher.  However, if you properly exploit the potential expansion options, then by using the ‚ÄúCode Density‚Äù parameter you can surpass modern popular architectures. <br><br>  I am sure that many programmers who have experience writing in x86 assembler, a quick glance at the table with instructions is enough to say "I can write on this assembler."  I don‚Äôt know how the names of assembler monitors are protected by patents, but they are, if possible, chosen to coincide with x86.  Separately, I would like to say about the instructions from the range 0xd0-0xd7.  These are four-byte instructions, the second byte of which defines general-purpose registers, and the third and fourth serve for extended addressing. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/d99/91d/891/d9991d891e1dadb3285cc1bab055b12e.png" alt="image"><br><br>  Bit S / D determines which of the arguments (four-bit codes of registers in the second byte) is a pointer - the first or second register.  Three bits are reserved for further extensions and must be set to 0, the remaining bits define an unsigned number added to the pointer for indirect addressing.  These operations appeared to simplify work with structured data.  You can <a href="http://everest.l4os.ru/aliases_for_registers/">read</a> about it, for example, right here - <a href="http://everest.l4os.ru/aliases_for_registers/">everest.l4os.ru/aliases_for_registers</a> <br><br>  Characteristically, the code was originally developed as fully positionally independent and in the command system you will not find a single jump instruction at the absolute address, neither conditional nor unconditional.  All transition addresses are represented as offset relative to the team counter.  What for?  This is done to implement at the architecture level 100% position-independent machine code.  Need a constant?  Choose it by offset relative to the program counter.  You need a static variable, address relative to the program counter.  However, implementation details of different addressing modes are reliably hidden behind assembler macros.  The answer to the question of how to call system functions without absolute addressing is hereinafter referred to. <br><br>  Actually, all of the above refers to the command system.  You probably appreciated it, perhaps even agreed with something, but ... it was 20 years late. The main areas of application for microprocessors are already divided between x86, arm, mips and simple microcontrollers.  Extensibility and code density are the latest things that the device developer will look at when choosing a microprocessor.  What gives hope that the project will be interesting to developers?  If we are talking about a system of commands, then look at the single-byte instructions <b>IDLE</b> , <b>TASK_ID</b> , <b>SEND</b> , <b>RECV</b> , <b>LOCK</b> , <b>FREE</b> . <br><br>  The chip of the processor is that within it is hidden a small part of the operating system that manages tasks and the very concept of the task is ‚Äúwired‚Äù in the microprocessor.  New instructions just serve to support multitasking.  The IDLE instruction performs unconditional logging to the scheduler.  Actually unnecessary instruction, useful only for debugging the scheduler itself.  The TASK_ID instruction will return the identifier of the active task and the number of ticks until the next scheduled time distribution operation.  The pair LOCK and FREE instructions serve to capture and free the message buffer.  In this case, despite the coincidence of the name of the LOCK instruction with the x86 instruction, it performs completely different functions.  Since the processor operates on the concept of a task, we need the means to interact with the tasks.  Using the LOCK instruction, the task captures the message buffer, and using the FREE instruction, releases the message buffer.  The message buffer is 64 registers, the exchange with which occurs using the instructions SET_MR (writing the message register value from the RON) and GET_MR and (reading the message register in the RON). <br><br>  Of course, the most important instructions for the sake of which the entire project was started, are the SEND and RECV instructions - instructions for sending and receiving messages.  These instructions have two arguments - the number of the task for interaction and the timeout of the operation (specified in registers).  The simplest way to give a task time to the system or implement a delay is to send a message to yourself or wait for a message from yourself - the scheduler simply will not transfer control to the blocked task before the message timeout expires. <br><br>  SEND and RECV synchronous operations - in order for the message to pass between tasks, one of the tasks must be completed by RECV, and the other by SEND.  In most cases, this means that the first task that completed one of these instructions will be blocked while waiting for another task to be completed.  If for some reason the blocking is undesirable, then a zero timeout is set and, if one of the parties is not ready, instead of blocking, the task receives a status indicating timeout. <br><br>  At the time of sending the message, the message buffer that was previously captured by the LOCK instruction is switched to the task of the message receiving.  The task that received the message, after working with the buffer, should release it.  For example, a call to the <i>puts</i> library function would look like this: <br><br><pre> LOCK;  Message Buffer Capture
 SET_MR MR0, R2;  setting message id
 SET_MR MR1, R3;  setting the message argument
 SEND;  message transfer
 RECV;  waiting for a reply to a message
 GET_MR R0, MR0;  read return code
 FREE;  release message buffer
</pre><br><br>  This code is simplified as much as possible for ease of understanding.  In this example, the FREE instruction releases the message buffer received by the RECV instruction, since the buffer captured by the LOCK instruction is delegated to the target task when the message is transmitted. <br><br>  Despite the seeming complexity and unusualness of the solution, from the point of view of the application programmer nothing changes - the library functions carefully hide implementation details.  But system programmers and library developers will have to try - they will have to start by saying that any program interaction should be described as a protocol describing the format of requests and responses - a complex program complex is described as a set of interacting subjects that solve certain tasks through the interaction. <br><br>  All experiments are carried out with this miracle - the Mars Rover 2: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/568/8de/e92/5688dee929496d8ae2f4f76875581c3d.jpg" alt="image"><br><br>  Thanks for attention.  First of all, I would like to discuss the command system, since it is already working in hardware.  As for the hardware extensions for multitasking, they are not yet ready - information about the support of multitasking is provided for informational purposes, and the actual implementation may not correspond to the material in the article. </div><p>Source: <a href="https://habr.com/ru/post/251063/">https://habr.com/ru/post/251063/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../251043/index.html">Trends of e-marketing for 2015, research and list of top tools from the company Smart Insights</a></li>
<li><a href="../251045/index.html">Using Global Illumination in its own shaders in Unity 5</a></li>
<li><a href="../251047/index.html">iOS application - development, top App Store, Techcrunch and Facebook grant for $ 60,000 services</a></li>
<li><a href="../251049/index.html">Introduction to GStreamer: Initialization</a></li>
<li><a href="../251053/index.html">Remote debugging in Linux using the GDB-gdbserver bundle</a></li>
<li><a href="../251065/index.html">/ ^ 777 $ / or / ^ 7 {3} $ / or number of luck</a></li>
<li><a href="../251069/index.html">Lenovo laptops come with Superfish malware and its CA certificate and private key in storage</a></li>
<li><a href="../251073/index.html">Own Flash on HTML5: the union of vector images (part 1)</a></li>
<li><a href="../251077/index.html">Some interesting and useful things for web developer # 39</a></li>
<li><a href="../251079/index.html">Increase conversion with callback widget UpToCall</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>