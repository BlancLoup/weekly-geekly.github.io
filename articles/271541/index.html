<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Tracking Notifications on Android 4.0-4.2</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Starting with version 4.3, Android OS has added the ability to track all notifications in the system using NotificationListenerService . Unfortunately...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Tracking Notifications on Android 4.0-4.2</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/01f/ff3/997/01fff3997752478b98e640942a845b82.jpg" align="left">  Starting with version 4.3, Android OS has added the ability to track all notifications in the system using <a href="http://developer.android.com/reference/android/service/notification/NotificationListenerService.html">NotificationListenerService</a> .  Unfortunately, backward compatibility with previous versions of the OS is missing.  What if such functionality is needed on devices with an older version of the operating system? <br><br>  In the article you can find a set of crutches and hacks to track notifications on Android OS version 4.0-4.2.  Not on all devices, the result is 100% efficient, so you have to use additional crutches to assume the removal of notifications in certain cases. <br><a name="habracut"></a><br>  Searching for information on the Internet on this issue leads to the conclusion that it is necessary to use the <a href="http://developer.android.com/reference/android/accessibilityservice/AccessibilityService.html">AccessibilityService</a> and monitor the <a href="http://developer.android.com/reference/android/view/accessibility/AccessibilityEvent.html">TYPE_NOTIFICATION_STATE_CHANGED</a> event.  Testing has shown that this event occurs only at the moment when the notification is added to the status bar, but does not occur when the notification is deleted.  Reading additional data about the received notification and tracking removal is the greatest crutches in this task. <br><br><h1>  Tracking incoming notifications with additional information retrieval </h1><br>  So, the notification came, event <a href="http://developer.android.com/reference/android/view/accessibility/AccessibilityEvent.html">TYPE_NOTIFICATION_STATE_CHANGED is received</a> .  We can find out the package name of the application that sent the notification using the <a href="http://developer.android.com/reference/android/view/accessibility/AccessibilityEvent.html">AccessibilityEvent.getPackageName ()</a> method.  The notification itself can be retrieved using the <a href="http://developer.android.com/reference/android/view/accessibility/AccessibilityRecord.html">AccessibilityRecord.getParcelableData ()</a> method; we will get an object of <a href="http://developer.android.com/reference/android/app/Notification.html">Notification</a> type at the output.  But, unfortunately, the set of available data in the retrieved notification is very poor.  To further track the removal of the notification, we will need to get at least a text header.  For this you have to use reflection and other crutches. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre><code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> CharSequence </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getNotificationTitle</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Notification notification, String packageName)</span></span></span><span class="hljs-function"> </span></span>{ CharSequence title = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; title = getExpandedTitle(notification); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (title == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { Bundle extras = NotificationCompat.getExtras(notification); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (extras != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { Timber.d(<span class="hljs-string"><span class="hljs-string">"getNotificationTitle: has extras: %1$s"</span></span>, extras.toString()); title = extras.getCharSequence(<span class="hljs-string"><span class="hljs-string">"android.title"</span></span>); Timber.d(<span class="hljs-string"><span class="hljs-string">"getNotificationTitle: notification has no title, trying to get from bundle. found: %1$s"</span></span>, title); } } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (title == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-comment"><span class="hljs-comment">// if title was not found, use package name as title title = packageName; } Timber.d("getNotificationTitle: discovered title %1$s", title); return title; } private CharSequence getExpandedTitle(Notification n) { CharSequence title = null; RemoteViews view = n.contentView; // first get information from the original content view title = extractTitleFromView(view); // then try get information from the expanded view if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.JELLY_BEAN) { view = getBigContentView(n); title = extractTitleFromView(view); } Timber.d("getExpandedTitle: discovered title %1$s", title); return title; } private CharSequence extractTitleFromView(RemoteViews view) { CharSequence title = null; HashMap&lt;Integer, CharSequence&gt; notificationStrings = getNotificationStringFromRemoteViews(view); if (notificationStrings.size() &gt; 0) { // get title string if available if (notificationStrings.containsKey(mNotificationTitleId)) { title = notificationStrings.get(mNotificationTitleId); } else if (notificationStrings.containsKey(mBigNotificationTitleId)) { title = notificationStrings.get(mBigNotificationTitleId); } else if (notificationStrings.containsKey(mInboxNotificationTitleId)) { title = notificationStrings.get(mInboxNotificationTitleId); } } return title; } // use reflection to extract string from remoteviews object private HashMap&lt;Integer, CharSequence&gt; getNotificationStringFromRemoteViews(RemoteViews view) { HashMap&lt;Integer, CharSequence&gt; notificationText = new HashMap&lt;&gt;(); try { ArrayList&lt;Parcelable&gt; actions = null; Field fs = RemoteViews.class.getDeclaredField("mActions"); if (fs != null) { fs.setAccessible(true); //noinspection unchecked actions = (ArrayList&lt;Parcelable&gt;) fs.get(view); } if (actions != null) { // Find the setText() and setTime() reflection actions for (Parcelable p : actions) { Parcel parcel = Parcel.obtain(); p.writeToParcel(parcel, 0); parcel.setDataPosition(0); // The tag tells which type of action it is (2 is ReflectionAction, from the source) int tag = parcel.readInt(); if (tag != 2) continue; // View ID int viewId = parcel.readInt(); String methodName = parcel.readString(); //noinspection ConstantConditions if (methodName == null) continue; // Save strings else if (methodName.equals("setText")) { // Parameter type (10 = Character Sequence) int i = parcel.readInt(); // Store the actual string try { CharSequence t = TextUtils.CHAR_SEQUENCE_CREATOR.createFromParcel(parcel); notificationText.put(viewId, t); } catch (Exception exp) { Timber.d("getNotificationStringFromRemoteViews: Can't get the text for setText with viewid:" + viewId + " parameter type:" + i + " reason:" + exp.getMessage()); } } parcel.recycle(); } } } catch (Exception exp) { Timber.e(exp, null); } return notificationText; }</span></span></code> </pre> <br></div></div><br>  In the above code, all string values ‚Äã‚Äãand View Ids related to the <a href="http://developer.android.com/reference/android/app/Notification.html">Notification</a> type object are retrieved.  Reflection and reading from <a href="http://developer.android.com/reference/android/os/Parcelable.html">Parcelable</a> objects are used for this.  But we do not know which View Id has a notification header.  To determine this, use the following code: <br><br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">/* * Data constants used to parse notification view ids */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String NOTIFICATION_TITLE_DATA = <span class="hljs-string"><span class="hljs-string">"1"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String BIG_NOTIFICATION_TITLE_DATA = <span class="hljs-string"><span class="hljs-string">"8"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String INBOX_NOTIFICATION_TITLE_DATA = <span class="hljs-string"><span class="hljs-string">"9"</span></span>; <span class="hljs-comment"><span class="hljs-comment">/** * The id of the notification title view. Initialized in the {</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@link</span></span></span><span class="hljs-comment"> #detectNotificationIds()} method */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> mNotificationTitleId = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-comment"><span class="hljs-comment">/** * The id of the big notification title view. Initialized in the {</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@link</span></span></span><span class="hljs-comment"> #detectNotificationIds()} method */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> mBigNotificationTitleId = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-comment"><span class="hljs-comment">/** * The id of the inbox notification title view. Initialized in the {</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@link</span></span></span><span class="hljs-comment"> #detectNotificationIds()} method */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> mInboxNotificationTitleId = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-comment"><span class="hljs-comment">/** * Detect required view ids which are used to parse notification information */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">detectNotificationIds</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ Timber.d(<span class="hljs-string"><span class="hljs-string">"detectNotificationIds"</span></span>); NotificationCompat.Builder mBuilder = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> NotificationCompat.Builder(mContext) .setContentTitle(NOTIFICATION_TITLE_DATA); Notification n = mBuilder.build(); LayoutInflater inflater = (LayoutInflater) mContext.getSystemService(Context.LAYOUT_INFLATER_SERVICE); ViewGroup localView; <span class="hljs-comment"><span class="hljs-comment">// detect id's from normal view localView = (ViewGroup) inflater.inflate(n.contentView.getLayoutId(), null); n.contentView.reapply(mContext, localView); recursiveDetectNotificationsIds(localView); // detect id's from expanded views if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.JELLY_BEAN) { NotificationCompat.BigTextStyle bigtextstyle = new NotificationCompat.BigTextStyle(); mBuilder.setContentTitle(BIG_NOTIFICATION_TITLE_DATA); mBuilder.setStyle(bigtextstyle); n = mBuilder.build(); detectExpandedNotificationsIds(n); NotificationCompat.InboxStyle inboxStyle = new NotificationCompat.InboxStyle(); mBuilder.setContentTitle(INBOX_NOTIFICATION_TITLE_DATA); mBuilder.setStyle(inboxStyle); n = mBuilder.build(); detectExpandedNotificationsIds(n); } } @TargetApi(Build.VERSION_CODES.JELLY_BEAN) private void detectExpandedNotificationsIds(Notification n) { LayoutInflater inflater = (LayoutInflater) mContext.getSystemService(Context.LAYOUT_INFLATER_SERVICE); ViewGroup localView = (ViewGroup) inflater.inflate(n.bigContentView.getLayoutId(), null); n.bigContentView.reapply(mContext, localView); recursiveDetectNotificationsIds(localView); } private void recursiveDetectNotificationsIds(ViewGroup v) { for (int i = 0; i &lt; v.getChildCount(); i++) { View child = v.getChildAt(i); if (child instanceof ViewGroup) recursiveDetectNotificationsIds((ViewGroup) child); else if (child instanceof TextView) { String text = ((TextView) child).getText().toString(); int id = child.getId(); switch (text) { case NOTIFICATION_TITLE_DATA: mNotificationTitleId = id; break; case BIG_NOTIFICATION_TITLE_DATA: mBigNotificationTitleId = id; break; case INBOX_NOTIFICATION_TITLE_DATA: mInboxNotificationTitleId = id; break; } } } }</span></span></code> </pre><br></div></div><br>  The logic of the above code is that a test notification is created with a unique text value for the header.  A View is created for this notification using a <a href="http://developer.android.com/reference/android/view/LayoutInflater.html">LayoutInflater</a> and a recursive search to find a child TextView with previously specified text.  The id of the found object will be the unique identifier for the header of all incoming notifications. <br><br>  After the title has been extracted, save the package, title pair in our list of active notifications for further checks. <br><br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">/** * List to store currently active notifications data */</span></span> ConcurrentLinkedQueue&lt;NotificationData&gt; mAvailableNotifications = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ConcurrentLinkedQueue&lt;&gt;(); <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onAccessibilityEvent</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(AccessibilityEvent accessibilityEvent)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (accessibilityEvent.getEventType()) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> AccessibilityEvent.TYPE_NOTIFICATION_STATE_CHANGED: Timber.d(<span class="hljs-string"><span class="hljs-string">"onAccessibilityEvent: notification state changed"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (accessibilityEvent.getParcelableData() != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> &amp;&amp; accessibilityEvent.getParcelableData() <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> Notification) { Notification n = (Notification) accessibilityEvent.getParcelableData(); String packageName = accessibilityEvent.getPackageName().toString(); Timber.d(<span class="hljs-string"><span class="hljs-string">"onAccessibilityEvent: notification posted package: %1$s; notification: %2$s"</span></span>, packageName, n); mAvailableNotifications.add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> NotificationData(mNotificationParser.getNotificationTitle(n, packageName), packageName)); <span class="hljs-comment"><span class="hljs-comment">// fire event onNotificationPosted(); } break; ... } } /** * Simple notification information holder */ class NotificationData { CharSequence title; CharSequence packageName; public NotificationData(CharSequence title, CharSequence packageName) { this.title = title; this.packageName = packageName; } }</span></span></code> </pre><br></div></div><br>  With the first part, it seems like they did it.  This approach works more or less stable on different versions of Android.  Let us turn to the second part, in which we will try to track the removal of notifications. <br><br><h1>  Tracking deletion notifications </h1><br>  Since the standard way to find out when the notification was deleted is not possible, it is necessary to answer the question: in what cases can it be deleted?  The following options come to mind: <br><br><ol><li>  User waved notification </li><li>  The user opened the application by clicking on the notification and it disappeared. </li><li>  User clicked clear all notifications. </li><li>  The application itself has deleted the notification. </li></ol><br>  Immediately I have to admit that I haven‚Äôt been able to do anything with the last point, but there is hope that this behavior is not too frequent, and therefore not too popular. <br><br>  Consider each scenario separately. <br><br><h2>  User waved notification </h2><br>  Having traced what events occur when the user looks like a notification, he discovered that an event of type <a href="http://developer.android.com/reference/android/view/accessibility/AccessibilityEvent.html">TYPE_WINDOW_CONTENT_CHANGED is generated</a> for the package name <b>"android.system.ui"</b> with a <b>windowId</b> belonging to the status line.  Unfortunately, the window for switching between applications also has a package name <b>"android.system.ui"</b> but another <b>windowId</b> .  WindowId is not a constant, and may change after restarting the device or on different versions of Android. <br><br>  How to calculate that the event came exactly from the status line?  I had to pretty much puzzle over this issue.  In the end, I had to implement a certain crutch for this.  Assumed that the status bar should be expanded at the time of removal of the notification by the user.  It should contain a button to clear all notifications with a specific accessibility description.  Fortunately, the constant has the same name on different versions of Android.  Now we need to analyze the view hierarchy for the presence of this button, and then we will be able to detect the windowId belonging to the status line.  Probably, someone from the knowers knows a more reliable way to do this, I will be grateful if you share your knowledge. <br><br>  Determine whether an event belongs to the status line: <br><br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">/** * Find "clear all notifications" button accessibility text used by the systemui application */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">findClearAllButton</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ Timber.d(<span class="hljs-string"><span class="hljs-string">"findClearAllButton: called"</span></span>); Resources res; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { res = mPackageManager.getResourcesForApplication(SYSTEMUI_PACKAGE_NAME); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = res.getIdentifier(<span class="hljs-string"><span class="hljs-string">"accessibility_clear_all"</span></span>, <span class="hljs-string"><span class="hljs-string">"string"</span></span>, <span class="hljs-string"><span class="hljs-string">"com.android.systemui"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (i != <span class="hljs-number"><span class="hljs-number">0</span></span>) { mClearButtonName = res.getString(i); } } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception exp) { Timber.e(exp, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); } } <span class="hljs-comment"><span class="hljs-comment">/** * Check whether accessibility event belongs to the status bar window by checking event package * name and window id * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> accessibilityEvent * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isStatusBarWindowEvent</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(AccessibilityEvent accessibilityEvent)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">boolean</span></span> result = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!SYSTEMUI_PACKAGE_NAME.equals(accessibilityEvent.getPackageName())) { Timber.v(<span class="hljs-string"><span class="hljs-string">"isStatusBarWindowEvent: not system ui package"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mStatusBarWindowId != -<span class="hljs-number"><span class="hljs-number">1</span></span>) { <span class="hljs-comment"><span class="hljs-comment">// if status bar window id is already initialized result = accessibilityEvent.getWindowId() == mStatusBarWindowId; Timber.v("isStatusBarWindowEvent: comparing window ids %1$d %2$d, result %3$b", mStatusBarWindowId, accessibilityEvent.getWindowId(), result); } else { Timber.v("isStatusBarWindowEvent: status bar window id not initialized, starting detection"); AccessibilityNodeInfo node = accessibilityEvent.getSource(); node = getRootNode(node); if (hasClearButton(node)) { Timber.v("isStatusBarWindowEvent: the root node has clear text button in the view hierarchy. Remember window id for future use"); mStatusBarWindowId = accessibilityEvent.getWindowId(); result = isStatusBarWindowEvent(accessibilityEvent); } if (!result) { Timber.v("isStatusBarWindowEvent: can't initizlie status bar window id"); } } return result; } /** * Get the root node for the specified node if it is not null * * @param node * @return the root node for the specified node in the view hierarchy */ public AccessibilityNodeInfo getRootNode(AccessibilityNodeInfo node) { if (node != null) { // workaround for Android 4.0.3 to avoid NPE. Should to remember first call of the node.getParent() such // as second call may return null AccessibilityNodeInfo parent; while ((parent = node.getParent()) != null) { node = parent; } } return node; } /** * Check whether the node has clear notifications button in the view hierarchy * * @param node * @return */ private boolean hasClearButton(AccessibilityNodeInfo node) { boolean result = false; if (node == null) { return result; } Timber.d("hasClearButton: %1$s %2$d %3$s", node.getClassName(), node.getWindowId(), node.getContentDescription()); if (TextUtils.equals(mClearButtonName, node.getContentDescription())) { result = true; } else { for (int i = 0; i &lt; node.getChildCount(); i++) { if (hasClearButton(node.getChild(i))) { result = true; break; } } } return result; }</span></span></code> </pre><br></div></div><br>  Now it is necessary to determine whether the notification has been deleted or is still present.  We use a method that does not have 100% reliability: we extract all rows from the status line and look for matches with previously saved notification headers.  If the title is missing, consider the notification to be deleted.  It happens that an event comes with the necessary <b>windowId</b> but with an empty <a href="http://developer.android.com/reference/android/view/accessibility/AccessibilityNodeInfo.html">AccessibilityNodeInfo</a> (it happens when the user looks like the last available notification).  In this case, we assume that all notifications have been deleted. <br><br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">/** * Update the available notification information from the node information of the accessibility event * &lt;br&gt; * The algorithm is not exact. All the strings are recursively retrieved in the view hierarchy and then * titles are compared with the available notifications * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> accessibilityEvent */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">updateNotifications</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(AccessibilityEvent accessibilityEvent)</span></span></span><span class="hljs-function"> </span></span>{ AccessibilityNodeInfo node = accessibilityEvent.getSource(); node = mStatusBarWindowUtils.getRootNode(node); <span class="hljs-keyword"><span class="hljs-keyword">boolean</span></span> removed = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; Set&lt;String&gt; titles = node == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> ? Collections.emptySet() : recursiveGetStrings(node); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (Iterator&lt;NotificationData&gt; iter = mAvailableNotifications.iterator(); iter.hasNext(); ) { NotificationData data = iter.next(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!titles.contains(data.title.toString())) { <span class="hljs-comment"><span class="hljs-comment">// if the title is absent in the view hierarchy remove notification from available notifications iter.remove(); removed = true; } } if (removed) { Timber.d("updateNotifications: removed"); // fire event if at least one notification was removed onNotificationRemoved(); } } /** * Get all the text information from the node view hierarchy * * @param node * @return */ private Set&lt;String&gt; recursiveGetStrings(AccessibilityNodeInfo node) { Set&lt;String&gt; strings = new HashSet&lt;&gt;(); if (node != null) { if (node.getText() != null) { strings.add(node.getText().toString()); Timber.d("recursiveGetStrings: %1$s", node.getText().toString()); } for (int i = 0; i &lt; node.getChildCount(); i++) { strings.addAll(recursiveGetStrings(node.getChild(i))); } } return strings; }</span></span></code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Event handling code</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">case</span></span> AccessibilityEvent.TYPE_WINDOW_CONTENT_CHANGED: <span class="hljs-comment"><span class="hljs-comment">// auto clear notifications when cleared from notifications bar (old api, Android &lt; 4.3) if (mStatusBarWindowUtils.isStatusBarWindowEvent(accessibilityEvent)) { Timber.d("onAccessibilityEvent: status bar content changed"); updateNotifications(accessibilityEvent); } break;</span></span></code> </pre><br></div></div><br><h2>  The user opened the application by clicking on the notification and it disappeared </h2><br>  It would be ideal if this behavior generated, as in the first case, the event <a href="http://developer.android.com/reference/android/view/accessibility/AccessibilityEvent.html">TYPE_WINDOW_CONTENT_CHANGED</a> for the package name <b>"android.system.ui"</b> , would not have to consider this case separately.  But tests have shown that the desired event is generated, but not always: it depends on the Android version, the speed at which the status line is closed, and it is not clear from what.  In my application, I needed to stop notifying the user of a missed notification.  It was decided to insure and assume that once a user has opened an application that has missed notifications, it can be considered that the previously saved notifications are not important for him and may not remind of themselves. <br><br>  When the application opens, a <a href="http://developer.android.com/reference/android/view/accessibility/AccessibilityEvent.html">TYPE_WINDOW_STATE_CHANGED</a> event is <a href="http://developer.android.com/reference/android/view/accessibility/AccessibilityEvent.html">generated</a> , where you can find out the packageName and delete all tracked notifications for it. <br><br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">/** * Remove all notifications from the available notifications with the specified package name * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> packageName */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">removeNotificationsFor</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String packageName)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">boolean</span></span> removed = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; Timber.d(<span class="hljs-string"><span class="hljs-string">"removeNotificationsFor: %1$s"</span></span>, packageName); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (Iterator&lt;NotificationData&gt; iter = mAvailableNotifications.iterator(); iter.hasNext(); ) { NotificationData data = iter.next(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (TextUtils.equals(packageName, data.packageName)) { iter.remove(); removed = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (removed) { Timber.d(<span class="hljs-string"><span class="hljs-string">"removeNotificationsFor: removed for %1$s"</span></span>, packageName); onNotificationRemoved(); } }</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Event handling code</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">case</span></span> AccessibilityEvent.TYPE_WINDOW_STATE_CHANGED: <span class="hljs-comment"><span class="hljs-comment">// auto clear notifications for launched application (TYPE_WINDOW_CONTENT_CHANGED not always generated // when app is clicked or cleared) Timber.d("onAccessibilityEvent: window state changed"); if (accessibilityEvent.getPackageName() != null) { String packageName = accessibilityEvent.getPackageName().toString(); Timber.d("onAccessibilityEvent: window state has been changed for package %1$s", packageName); removeNotificationsFor(packageName); } break;</span></span></code> </pre><br></div></div><br><h2>  User clicked clear all notifications </h2><br>  Here, as in the previous case, the <a href="http://developer.android.com/reference/android/view/accessibility/AccessibilityEvent.html">TYPE_WINDOW_CONTENT_CHANGED</a> event is not always generated.  I had to assume that once the user pressed the button, the previously received notifications are no longer important and stop notifying about them. <br><br>  It is necessary to track the <a href="http://developer.android.com/reference/android/view/accessibility/AccessibilityEvent.html">TYPE_VIEW_CLICKED</a> event in the status bar and if it belongs to the ‚ÄúClear All‚Äù button, stop tracking all notifications. <br><br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">/** * Check whether the accessibility event is generated by the clear all notifications button * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> accessibilityEvent * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isClearNotificationsButtonEvent</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(AccessibilityEvent accessibilityEvent)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> TextUtils.equals(accessibilityEvent.getClassName(), android.widget.ImageView.class.getName()) &amp;&amp; TextUtils.equals(accessibilityEvent.getContentDescription(), mClearButtonName); }</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Event handling code</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">case</span></span> AccessibilityEvent.TYPE_VIEW_CLICKED: <span class="hljs-comment"><span class="hljs-comment">// auto clear notifications when clear all notifications button clicked (TYPE_WINDOW_CONTENT_CHANGED not always generated // when this event occurs so need to handle this manually // // also handle notification clicked event Timber.d("onAccessibilityEvent: view clicked"); if (mStatusBarWindowUtils.isStatusBarWindowEvent(accessibilityEvent)) { Timber.d("onAccessibilityEvent: status bar content clicked"); if (mStatusBarWindowUtils.isClearNotificationsButtonEvent(accessibilityEvent)) { // if clicked image view element with the clear button name content description Timber.d("onAccessibilityEvent: clear notifications button clicked"); mAvailableNotifications.clear(); // fire event onNotificationRemoved(); } else { // update notifications if another view is clicked updateNotifications(accessibilityEvent); } } break;</span></span></code> </pre><br></div></div><br><h2>  What's up with Android up to version 4.0? </h2><br>  Unfortunately, I have not yet managed to find a working way to track the removal of notifications.  The ability to work with the ViewHierarchy in the <a href="http://developer.android.com/reference/android/accessibilityservice/AccessibilityService.html">AccessibilityService</a> was added only starting from API version 14. If someone knows how to access the ViewHierarchy status bar directly, this task may be solved <br><br><h1>  PS </h1><br>  I hope someone is interested in the topic discussed in the article.  I will be glad to hear your ideas on how to improve the result of tracking the removal of notifications. <br><br>  Most of the information was drawn from here <a href="https://github.com/minhdangoz/notifications-widget">https://github.com/minhdangoz/notifications-widget</a> (I had to finish in some places) <br><br>  Ready project <a href="httpdispatch/MissedNotificationsReminder">https://github.com/httpdispatch/MissedNotificationsReminder</a> is an application that reminds of missed notifications.  Do not forget to choose the v14 build variant, since  v18 works through NotificationListenerService </div><p>Source: <a href="https://habr.com/ru/post/271541/">https://habr.com/ru/post/271541/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../271529/index.html">Black Friday at the Russian VDS-hoster</a></li>
<li><a href="../271531/index.html">Conference DotNext 2015 Moscow: final program and review of reports</a></li>
<li><a href="../271533/index.html">Carefully, true class contracts may differ from formal</a></li>
<li><a href="../271535/index.html">Preview Android Studio 2.0 is available: two uber features</a></li>
<li><a href="../271537/index.html">Install and configure LXC on Debian 8</a></li>
<li><a href="../271543/index.html">Announcement of laboratory work on the development, testing and management of the life cycle of software for Visual Studio 2015</a></li>
<li><a href="../271545/index.html">Dinosaur Walking: How I Adapted a Web Application for IE 7</a></li>
<li><a href="../271547/index.html">Key Performance Indicator Analysis - Part 1</a></li>
<li><a href="../271549/index.html">Lock-free algorithms and stack implementation</a></li>
<li><a href="../271555/index.html">Machine learning as a method of analyzing the microstructure of the market and its application in high-frequency trading</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>