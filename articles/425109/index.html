<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>The book "Java in the cloud. Spring Boot, Spring Cloud, Cloud Foundry ¬ª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello! Basically, this book is intended for Java and JVM machine developers who are looking for ways to create better software in a short time using S...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>The book "Java in the cloud. Spring Boot, Spring Cloud, Cloud Foundry ¬ª</h1><div class="post__text post__text-html js-mediator-article"> <a href="https://habr.com/company/piter/blog/425109/"><img src="https://habrastorage.org/webt/g5/vp/gz/g5vpgzgoyh2hlalmrajcysuwvwo.jpeg" align="left" alt="image"></a>  Hello!  Basically, this book is intended for Java and JVM machine developers who are looking for ways to create better software in a short time using Spring Boot, Spring Cloud and Cloud Foundry.  It is for those who have already heard the noise that has risen around microservices.  You may have already realized how stratospheric heights the Spring Boot environment has flown, and you are surprised that businesses today use the Cloud Foundry platform.  If so, then this book is for you. <br><br><h3>  Excerpt  3. Configuration style of twelve factor applications </h3><br>  This chapter will look at how to implement an application‚Äôs configuration. <br><a name="habracut"></a><br>  Define a number of vocabulary terms.  When it comes to configuration in Spring, the most common thing is to enter into the Spring environment various implementations of the application context - <a href="https://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/context/ApplicationContext.html">ApplicationContext</a> , which helps the container to understand how to connect beans.  Such a configuration can be represented as an XML file, which must be submitted to <a href="https://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/context/support/ClassPathXmlApplicationContext.html">ClassPathXmlApplicationContext</a> , or Java classes annotated in a manner that can be provided to the <a href="https://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/context/annotation/AnnotationConfigApplicationContext.html">AnnotationConfigApplicationContext</a> object.  And of course, when studying the latter option, we will refer to <i>the Java configuration.</i> <br><br>  But in this chapter we are going to look at the configuration as defined in the manifest of the <a href="https://12factor.net/config">12-factor application</a> .  In this case, it refers to literal values ‚Äã‚Äãthat can vary from one environment to another: we are talking about passwords, ports and host names, or property flags.  The configuration ignores magic constants embedded in the code.  The manifest includes an excellent criterion for correct configuration: can the application code base be open source at any time without disclosing and compromising important credentials?  This type of configuration refers solely to values ‚Äã‚Äãthat vary from one environment to another, and does not apply, for example, to connecting Spring beans or configuring Ruby routes. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h3>  Spring Framework Support </h3><br>  In Spring, the configuration style corresponding to 12 factors has been supported since the appearance of the <a href="https://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/beans/factory/config/PropertyPlaceholderConfigurer.html">PropertyPlaceholderConfigurer</a> class.  Once its instance is determined, it replaces the literals in the XML configuration with the values ‚Äã‚Äãextracted from the file with the .properties extension.  In Spring, <a href="https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/beans/factory/config/PropertyPlaceholderConfigurer.html">PropertyPlaceholderConfigurer</a> has been offered since 2003.  Spring 2.5 introduces support for the XML namespace, as well as support for this property lookup space.  This allows you to substitute the literal values ‚Äã‚Äãof the definitions of beans into the XML configurations with the values ‚Äã‚Äãassigned to the keys in the external properties file (in this case, the simple.properties file, which may appear in the class path or be external to the application). <br><br>  Configuration in the style of 12 factors is aimed at eliminating the unreliability of the existing magic strings, that is, values ‚Äã‚Äãlike database addresses and accounts for connecting to them, ports, etc., which are hard coded in the compiled application.  If the configuration is moved outside the application, then it can be replaced without resorting to this new code assembly. <br><br><h3>  PropertyPlaceholderConfigurer class </h3><br>  Let's look at a sample of how to use the PropertyPlaceholderConfigurer class, the XML definitions of Spring beans, and the file with the .properties extension outside the application.  We just need to print the value in this property file.  This will help to make the code shown in Example 3.1. <br><br>  Example 3.1.  Properties File: some.properties <br><br><pre><code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">configuration</span></span>.projectName=Spring Framework</code> </pre> <br>  This is the Spring-owned ClassPathXmlApplicationContext class, so we use the XML namespace from the Spring context and point to our some.properties file.  Then, in the definitions of the beans, we use literals in the form of $ {configuration.projectName}, and Spring replaces them with values ‚Äã‚Äãfrom our properties file (example 3.2). <br><br>  Example 3.2.  Spring XML configuration file <br><br><pre> <code class="hljs pgsql">&lt;context:property-placeholder <span class="hljs-keyword"><span class="hljs-keyword">location</span></span>="classpath:some.properties"/&gt; (<span class="hljs-number"><span class="hljs-number">1</span></span>) &lt;bean <span class="hljs-keyword"><span class="hljs-keyword">class</span></span>="classic.Application"&gt; &lt;property <span class="hljs-type"><span class="hljs-type">name</span></span>="configurationProjectName" <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>="${configuration.projectName}"/&gt; &lt;/bean&gt;</code> </pre> <br>  (1) classpath: location referencing the file in the current compiled block of code (.jar, .war, etc.).  Spring supports many alternatives, including file: and url:, allowing a file to exist apart from a block of code. <br><br>  Finally, let's look at how the Java class looks, thanks to which it is possible to bring all this together (Example 3.3). <br><br>  Example 3.3.  Java class that must be configured with a property value <br>  package classic; <br><br><pre> <code class="hljs actionscript"><span class="hljs-meta"><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">import</span></span></span><span class="hljs-meta"> org.apache.commons.logging.LogFactory;</span></span> <span class="hljs-meta"><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">import</span></span></span><span class="hljs-meta"> org.springframework.context.support.ClassPathXmlApplicationContext;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Application</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> main(String[] args) { <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ClassPathXmlApplicationContext(<span class="hljs-string"><span class="hljs-string">"classic.xml"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> setConfigurationProjectName(String pn) { LogFactory.getLog(getClass()).info(<span class="hljs-string"><span class="hljs-string">"the configuration project name is "</span></span> + pn); } }</code> </pre> <br>  The first example uses the XML format for the configuration of Spring beans.  In Spring 3.0 and 3.1, the situation for developers using Java configuration has improved significantly.  In these issues, the <a href="https://habr.com/users/value/" class="user_link">Value</a> annotation and the Environment abstraction were introduced. <br><br><h3>  Abstraction Environment and <a href="https://habr.com/users/value/" class="user_link">Value</a> </h3><br>  The <a href="https://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/core/env/Environment.html">Environment</a> abstraction represents, during the execution of a code, its indirect relation to the environment in which it is running, and allows the application to ask a question (‚ÄúWhat line separator line.separator on this platform?‚Äù) About the properties of the environment.  Abstraction acts as a mapping from keys and values.  By configuring the PropertySource PropertySource in Environment, you can configure the location from which these values ‚Äã‚Äãwill be read.  By default, Spring loads system keys and environment values, such as line.separator.  Spring can be instructed to load configuration keys from a file in the same order that might have been used in early releases of the Spring property lookup solution using the @PropertySource annotation. <br><br>  The <a href="https://habr.com/users/value/" class="user_link">Value</a> annotation provides a way to embed environment values ‚Äã‚Äãin constructors, setters, fields, etc. These values ‚Äã‚Äãcan be calculated using the Spring Expression Language or the property substitution syntax, provided the <a href="https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/context/support/PropertySourcesPlaceholderConfigurer.html">PropertySourcesPlaceholderConfigurer is</a> registered, as done in Example 3.4. <br><br>  Example 3.4.  Register PropertySourcesPlaceholderConfigurer <br>  package env; <br><br><pre> <code class="hljs kotlin"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.apache.commons.logging.Log; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.apache.commons.logging.LogFactory; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.beans.factory.InitializingBean; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.beans.factory.<span class="hljs-keyword"><span class="hljs-keyword">annotation</span></span>.Autowired; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.beans.factory.<span class="hljs-keyword"><span class="hljs-keyword">annotation</span></span>.Value; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.context.<span class="hljs-keyword"><span class="hljs-keyword">annotation</span></span>.AnnotationConfigApplicationContext; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.context.<span class="hljs-keyword"><span class="hljs-keyword">annotation</span></span>.Bean; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.context.<span class="hljs-keyword"><span class="hljs-keyword">annotation</span></span>.Configuration; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.context.<span class="hljs-keyword"><span class="hljs-keyword">annotation</span></span>.PropertySource; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.context.support.PropertySourcesPlaceholderConfigurer; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.core.env.Environment; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> javax.<span class="hljs-keyword"><span class="hljs-keyword">annotation</span></span>.PostConstruct; (<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-meta"><span class="hljs-meta">@Configuration</span></span> <span class="hljs-meta"><span class="hljs-meta">@PropertySource(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"some.properties"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Application</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Log log = LogFactory.getLog(getClass()); <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> static void main(String[] args) throws Throwable { new AnnotationConfigApplicationContext(Application.<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>); } (<span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-meta"><span class="hljs-meta">@Bean</span></span> static PropertySourcesPlaceholderConfigurer pspc() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new PropertySourcesPlaceholderConfigurer(); } (<span class="hljs-number"><span class="hljs-number">3</span></span>) <span class="hljs-meta"><span class="hljs-meta">@Value(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"</span></span><span class="hljs-subst"><span class="hljs-meta"><span class="hljs-meta-string"><span class="hljs-subst">${configuration.projectName}</span></span></span></span><span class="hljs-meta"><span class="hljs-meta-string">"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String fieldValue; (<span class="hljs-number"><span class="hljs-number">4</span></span>) <span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> Application(<span class="hljs-meta"><span class="hljs-meta">@Value(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"</span></span><span class="hljs-subst"><span class="hljs-meta"><span class="hljs-meta-string"><span class="hljs-subst">${configuration.projectName}</span></span></span></span><span class="hljs-meta"><span class="hljs-meta-string">"</span></span></span><span class="hljs-meta">)</span></span> String pn) { log.info(<span class="hljs-string"><span class="hljs-string">"Application constructor: "</span></span> + pn); } (<span class="hljs-number"><span class="hljs-number">5</span></span>) <span class="hljs-meta"><span class="hljs-meta">@Value(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"</span></span><span class="hljs-subst"><span class="hljs-meta"><span class="hljs-meta-string"><span class="hljs-subst">${configuration.projectName}</span></span></span></span><span class="hljs-meta"><span class="hljs-meta-string">"</span></span></span><span class="hljs-meta">)</span></span> void setProjectName(String projectName) { log.info(<span class="hljs-string"><span class="hljs-string">"setProjectName: "</span></span> + projectName); } (<span class="hljs-number"><span class="hljs-number">6</span></span>) <span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> void setEnvironment(Environment env) { log.info(<span class="hljs-string"><span class="hljs-string">"setEnvironment: "</span></span> + env.getProperty(<span class="hljs-string"><span class="hljs-string">"configuration.projectName"</span></span>)); } (<span class="hljs-number"><span class="hljs-number">7</span></span>) <span class="hljs-meta"><span class="hljs-meta">@Bean</span></span> InitializingBean both(Environment env, <span class="hljs-meta"><span class="hljs-meta">@Value(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"</span></span><span class="hljs-subst"><span class="hljs-meta"><span class="hljs-meta-string"><span class="hljs-subst">${configuration.projectName}</span></span></span></span><span class="hljs-meta"><span class="hljs-meta-string">"</span></span></span><span class="hljs-meta">)</span></span> String projectName) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> () -&gt; { log.info(<span class="hljs-string"><span class="hljs-string">"@Bean with both dependencies (projectName): "</span></span> + projectName); log.info(<span class="hljs-string"><span class="hljs-string">"@Bean with both dependencies (env): "</span></span> + env.getProperty(<span class="hljs-string"><span class="hljs-string">"configuration.projectName"</span></span>)); }; } <span class="hljs-meta"><span class="hljs-meta">@PostConstruct</span></span> void afterPropertiesSet() throws Throwable { log.info(<span class="hljs-string"><span class="hljs-string">"fieldValue: "</span></span> + <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.fieldValue); } }</code> </pre> <br>  (1) The @PropertySource annotation is an abbreviation like property-placeholder that configures a PropertySource from a file with the .properties extension. <br><br>  (2) PropertySourcesPlaceholderConfigurer must be registered as a static bean component, since it is an implementation of the BeanFactoryPostProcessor and must be called at an early stage of the initialization life cycle in Spring bean components.  When using XML configuration of beans in Spring, this nuance is not visible. <br><br>  (3) You can decorate the fields with the <a href="https://habr.com/users/value/" class="user_link">Value</a> annotation (but do not do this, otherwise the code will not be tested!) ... <br><br>  (4) ... or the <a href="https://habr.com/users/value/" class="user_link">Value</a> annotation, you can decorate the parameters of the constructor ... <br><br>  (5) ... or use the installation methods ... <br><br>  (6) ... or implement the Spring Environment object and perform key resolution manually. <br><br>  (7) Parameters with the <a href="https://habr.com/users/value/" class="user_link">Value</a> annotation can also be used in the argument provider of <a href="https://habr.com/users/bean/" class="user_link">Bean</a> methods in the Spring Java configuration. <br><br>  In this example, the values ‚Äã‚Äãare loaded from the file simple.properties, and then it contains the configuration.projectName value provided in various ways. <br><br><h3>  Profiles </h3><br>  Among other things, the Environment abstraction introduces <a href="https://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/context/annotation/Profile.html">profiles</a> .  This allows you to assign labels (profiles) in order to group the beans.  Profiles should be used to describe bean-components and bean-graphs, varying from medium to medium.  Multiple profiles can be activated simultaneously.  Bean components that do not have profiles assigned to them are always activated.  Bean components that have a default profile are activated only if they have no other active profiles.  The profile attribute can be specified in a bean definition in XML or in tag classes, configuration classes, individual beans, or in the Provider <a href="https://habr.com/users/bean/" class="user_link">Bean</a> methods using <a href="https://habr.com/users/profile/" class="user_link">Profile</a> . <br><br>  Profiles allow you to describe sets of beans that must be created in one environment a little differently than in another.  In the local dev development profile, for example, you can use the built-in H2 data source javax.sql.DataSource, and then, when the prod profile is active, switch to the javax.sql.DataSource data source for PostgreSQL, obtained using JNDI search or by reading properties from the environment variable in <a href="https://cloudfoundry.org/">Cloud Foundry</a> .  In both cases, your code will work: you get javax.sql.DataSource, but the decision on which specific instance to use is made by activating one profile or several (example 3.5). <br><br>  Example 3.5.  Demonstrate that @Configuration classes can load various configuration files and provide various bean-based components <br>  active profile <br><br><pre> <code class="hljs kotlin"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> profiles; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.apache.commons.logging.Log; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.apache.commons.logging.LogFactory; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.beans.factory.InitializingBean; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.beans.factory.<span class="hljs-keyword"><span class="hljs-keyword">annotation</span></span>.Value; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.context.<span class="hljs-keyword"><span class="hljs-keyword">annotation</span></span>.*; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.context.support.PropertySourcesPlaceholderConfigurer; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.core.env.Environment; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.util.StringUtils; <span class="hljs-meta"><span class="hljs-meta">@Configuration</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Application</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Log log = LogFactory.getLog(getClass()); <span class="hljs-meta"><span class="hljs-meta">@Bean</span></span> static PropertySourcesPlaceholderConfigurer pspc() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new PropertySourcesPlaceholderConfigurer(); } (<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-meta"><span class="hljs-meta">@Configuration</span></span> <span class="hljs-meta"><span class="hljs-meta">@Profile(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"prod"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-meta"><span class="hljs-meta">@PropertySource(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"some-prod.properties"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> static <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ProdConfiguration</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Bean</span></span> InitializingBean <span class="hljs-keyword"><span class="hljs-keyword">init</span></span>() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> () -&gt; LogFactory.getLog(getClass()).info(<span class="hljs-string"><span class="hljs-string">"prod InitializingBean"</span></span>); } } <span class="hljs-meta"><span class="hljs-meta">@Configuration</span></span> <span class="hljs-meta"><span class="hljs-meta">@Profile({ </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"default"</span></span></span><span class="hljs-meta">, </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"dev"</span></span></span><span class="hljs-meta"> })</span></span> (<span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-meta"><span class="hljs-meta">@PropertySource(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"some.properties"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> static <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DefaultConfiguration</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Bean</span></span> InitializingBean <span class="hljs-keyword"><span class="hljs-keyword">init</span></span>() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> () -&gt; LogFactory.getLog(getClass()).info(<span class="hljs-string"><span class="hljs-string">"default InitializingBean"</span></span>); } } (<span class="hljs-number"><span class="hljs-number">3</span></span>) <span class="hljs-meta"><span class="hljs-meta">@Bean</span></span> InitializingBean which(Environment e, <span class="hljs-meta"><span class="hljs-meta">@Value(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"</span></span><span class="hljs-subst"><span class="hljs-meta"><span class="hljs-meta-string"><span class="hljs-subst">${configuration.projectName}</span></span></span></span><span class="hljs-meta"><span class="hljs-meta-string">"</span></span></span><span class="hljs-meta">)</span></span> String projectName) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> () -&gt; { log.info(<span class="hljs-string"><span class="hljs-string">"activeProfiles: '"</span></span> + StringUtils.arrayToCommaDelimitedString(e.getActiveProfiles()) + <span class="hljs-string"><span class="hljs-string">"'"</span></span>); log.info(<span class="hljs-string"><span class="hljs-string">"configuration.projectName: "</span></span> + projectName); }; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> static void main(String[] args) { AnnotationConfigApplicationContext ac = new AnnotationConfigApplicationContext(); ac.getEnvironment().setActiveProfiles(<span class="hljs-string"><span class="hljs-string">"dev"</span></span>); (<span class="hljs-number"><span class="hljs-number">4</span></span>) ac.register(Application.<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>); ac.refresh(); } }</code> </pre> <br>  (1) This configuration class and all its <a href="https://habr.com/users/bean/" class="user_link">Bean</a> definitions will be calculated only if the prod profile is active. <br><br>  (2) This configuration class and all its <a href="https://habr.com/users/bean/" class="user_link">Bean</a> definitions will be calculated only if the dev profile is active or no profile is active, including dev. <br><br>  (3) This InitializingBean component simply records the current active profile and enters the value that was eventually entered into the properties file. <br><br>  (4) Activating a profile (or profiles) programmatically is quite simple. <br><br>  Spring responds to several other profile activation methods that use the spring_profiles_active or spring.profiles.active token.  A profile can be set using an environment variable (for example, SPRING_PROFILES_ACTIVE), JVM properties (‚ÄëDspring.profiles.active = ...), the initialization parameter of a servlet application, or programmatically. <br><br><h3>  Bootiful configuration </h3><br>  <a href="http://spring.io/projects/spring-boot">Spring Boot</a> significantly improves the situation.  The environment will initially automatically load properties from a hierarchy of previously known locations.  Command line arguments override property values ‚Äã‚Äãobtained from JNDI, which override properties obtained from System.getProperties (), etc. <br><br>  - Command line arguments. <br>  - JNDI attributes from java: comp / env. <br>  - Properties System.getProperties (). <br>  - Operating system environment variables. <br>  - External files files properties: (config /)? Application. (Yml.properties). <br>  - Internal properties files in the archive (config /)? Application. (Yml.properties). <br>  - Annotation @PropertySource in configuration classes. <br>  - Source properties from SpringApplication.getDefaultProperties (). <br><br>  If a <a href="https://docs.spring.io/spring-boot/docs/current/reference/html/boot-features-profiles.html">profile is active,</a> data will be automatically read from configuration files based on the profile name, for example, from a file such as src / main / resources / application-foo.properties, where foo is the current profile. <br><br>  If the <a href="https://bitbucket.org/asomov/snakeyaml">SnakeYAML</a> library <a href="https://bitbucket.org/asomov/snakeyaml">is</a> mentioned in the classpath, the YAML files will also be automatically downloaded, following basically the same convention. <br><br><blockquote>  The <a href="http://yaml.org/">YAML</a> specification page states that "YAML is a human data standard for data serialization for all programming languages."  YAML is a hierarchical representation of values.  In regular files with the .properties extension, the hierarchy is denoted by a dot (‚Äú.‚Äù), While in YAML files, the newline character and additional indent level are used.  It would be nice to use these files to avoid having to specify common roots in the presence of highly branched configuration trees. </blockquote><br>  The contents of the file with the extension .yml shown in Example 3.6. <br><br>  Example 3.6.  Property file application.yml.  Data is hierarchical. <br><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">configuration</span></span>: projectName : Spring Boot management: <span class="hljs-keyword"><span class="hljs-keyword">security</span></span>: enabled: <span class="hljs-keyword"><span class="hljs-keyword">false</span></span></code> </pre> <br>  In addition, the Spring Boot environment greatly simplifies obtaining the correct result in general cases.  It turns the -D arguments into java process and environment variables available as properties.  It even normalizes them, in which the $ CONFIGURATION_PROJECTNAME environment variable (CONFIGURATION_NAME PROJECT) or the -D argument in the form ‚ÄëDconfiguration.projectName (project_name_configuration) are available using the configuration.projectName key (configuration.project_name) in the same way. The spring_profiles_active token is available. <br><br>  Configuration values ‚Äã‚Äãare strings and, with a sufficient number of them, can become unreadable when trying to make sure that such keys do not themselves become magic strings in the code.  Spring Boot introduces the component type @ConfigurationProperties.  When you annotate a POJO ‚Äî Plain Old Java Object (a plain old Java object) ‚Äî‚Äì using @ConfigurationProperties and specifying the prefix, Spring will attempt to map all properties that begin with this prefix to POJO properties.  In the example below, the value for configuration.projectName will be mapped to a POJO instance, which all code can then embed and dereference for type-safe reading of values.  As a result, you will only have a mapping from (String) key in one place (Example 3.7). <br><br>  Example 3.7.  Automatic property resolution from src / main / resources / application.yml <br>  package boot; <br><br><pre> <code class="hljs java"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.apache.commons.logging.Log; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.apache.commons.logging.LogFactory; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.beans.factory.annotation.Autowired; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.boot.SpringApplication; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.boot.autoconfigure.SpringBootApplication; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.boot.context.properties.ConfigurationProperties; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.boot.context.properties.EnableConfigurationProperties; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.stereotype.Component; (<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-meta"><span class="hljs-meta">@EnableConfigurationProperties</span></span> <span class="hljs-meta"><span class="hljs-meta">@SpringBootApplication</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Application</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Log log = LogFactory.getLog(getClass()); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String[] args)</span></span></span><span class="hljs-function"> </span></span>{ SpringApplication.run(Application.class); } <span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Application</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ConfigurationProjectProperties cp)</span></span></span><span class="hljs-function"> </span></span>{ log.info(<span class="hljs-string"><span class="hljs-string">"configurationProjectProperties.projectName = "</span></span> + cp.getProjectName()); } } (<span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-meta"><span class="hljs-meta">@Component</span></span> <span class="hljs-meta"><span class="hljs-meta">@ConfigurationProperties</span></span>(<span class="hljs-string"><span class="hljs-string">"configuration"</span></span>) <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ConfigurationProjectProperties</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String projectName; (<span class="hljs-number"><span class="hljs-number">3</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getProjectName</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> projectName; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setProjectName</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String projectName)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.projectName = projectName; } }</code> </pre> <br>  (1) The @EnableConfigurationProperties annotation instructs Spring to map properties to POJO objects annotated with @ConfigurationProperties. <br><br>  (2) The @ConfigurationProperties annotation indicates to Spring that this bean should be used as the root component for all properties starting with configuration., With subsequent tokens mapped to the properties of the object. <br><br>  (3) The projectName field will eventually have the value assigned to the configuration.projectName property key. <br><br>  Spring Boot actively applies the @ConfigurationProperties mechanism to enable users to redefine the elementary components of the system.  You may notice that property keys allow you to make changes, for example, by adding the org.springframework.boot: spring-boot-starter-actuator dependency to a Spring Boot based web application and then visiting page <a href="http://127.0.0.1/">127.0.0.1</a> : 8080 / configprops. <br><br><blockquote>  The end points of the actuator will be discussed in more detail in Chapter 13. They are locked and require a username and password by default.  Security measures can be disabled (but only to look at these points) by specifying management.security.enabled = false in the application.properties file (or application.yml). </blockquote><br>  You will get a list of supported configuration properties based on the types represented in the classpath at run time.  As the number of Spring Boot types grows, additional properties will be shown.  At this endpoint, the properties exported by your POJO objects annotated with @ConfigurationProperties will also be displayed. <br><br><h3>  Centralized logged configuration using Spring Cloud configuration server </h3><br>  So far so good, but it is necessary that things go even more successfully.  We still did not answer the questions about common applications: <br><br><ul><li>  after changes made to the application configuration, a restart will be required; </li><li>  no traceability: how to identify changes put into operation and roll back if necessary? </li><li>  configuration is decentralized;  it is not immediately clear where changes should be made in order to change one or another aspect; </li><li>  There is no installation support for encoding and decoding for security. </li></ul><br><h3>  Spring Cloud Configuration Server </h3><br>  The problem of configuration centralization can be solved by saving the configuration in one directory and pointing all applications to it.  You can also install version control of this directory using Git or Subversion.  Then the support needed for verification and registration will be obtained.  But the last two requirements will still not be fulfilled, so something more sophisticated is needed.  Refer to the <a href="http://cloud.spring.io/spring-cloud-config/">Spring Cloud</a> configuration server.  The Spring Cloud platform offers a configuration server and client for this server. <br><br>  The Spring Cloud Config server is a REST API to which our customers will connect to pick up their configuration.  The server also manages a version control configuration repository.  He is an intermediary between our clients and the configuration repository and thus is in a favorable position, allowing to implement security tools for connections from clients to the service and connections from the service to the repository of configurations with version control.  The Spring Cloud Config client provides client applications with a new scope, refresh, which makes it possible to configure Spring components again without restarting the application. <br><br><blockquote>  Technologies similar to the Spring Cloud Config server play an important role, but entail additional work costs.  Ideally, this duty should be shifted to the platform and automated.  When using Cloud Foundry, you can find the Config Server service in the services catalog, whose actions are based on the use of the Spring Cloud Config server. </blockquote><br>  Consider a simple example.  First we set up the Spring Cloud Config server.  Several Spring Boot applications can access one such service at once.  You need somewhere and somehow make it function.  Then it will only remain to inform all our services about where to find the configuration service.  It works as a kind of intermediary for configuration keys and values ‚Äã‚Äãthat it reads from Git storage over the network or from disk.  Add org.springframework.cloud: spring-cloud-config-server to your Spring Boot application build to enter the Spring Cloud Config server (Example 3.8). <br><br>  Example 3.8.  To embed a configuration server into an assembly, use the @EnableConfigServer annotation <br><br><pre> <code class="hljs java"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> demo; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.boot.SpringApplication; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.boot.autoconfigure.SpringBootApplication; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.cloud.config.server.EnableConfigServer; (<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-meta"><span class="hljs-meta">@SpringBootApplication</span></span> <span class="hljs-meta"><span class="hljs-meta">@EnableConfigServer</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Application</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String[] args)</span></span></span><span class="hljs-function"> </span></span>{ SpringApplication.run(Application.class, args); } }</code> </pre> <br>  (1) Using the @EnableConfigServer annotation installs Spring Cloud Config server. <br><br>  Example 3.9 shows the configuration for the configuration service. <br><br>  Example 3.9.  Configuration of the src / main / resources / application.yml configuration server <br><br>  server.port = 8888 <br>  spring.cloud.config.server.git.uri = \ <br>  <a href="https://github.com/cloud-native-java/config-server-configuration-repository">github.com/cloud-native-java/config-server-configuration-repository</a> (1) <br><br>  (1) An indication of a running Git repository that has a local character or is accessible over the network (for example, on GitHub (https://github.com/)) and used by the Spring Cloud Config server. <br><br>  Here, the Spring Cloud configuration service is instructed to search for configuration files for individual clients in Git storage on GitHub.  We pointed to this repository, but a link to any valid Git URI would fit.  Of course, he doesn‚Äôt even have to do with the Git system, you can use Subversion or even unmanaged directories (although we strongly advise against this).  In this case, the repository URI is hard-coded, but there is nothing to prevent it from getting from the -D argument, the argument ‚Äî or from the environment variable. <br><br>  ¬ªMore information about the book can be found on <a href="https://www.piter.com/product/java-v-oblake-spring-boot-spring-cloud-cloud-foundry">the publisher's website.</a> <br>  ¬ª <a href="https://storage.piter.com/upload/contents/978544610713/978544610713_X.pdf">Table of Contents</a> <br>  ¬ª <a href="https://storage.piter.com/upload/contents/978544610713/978544610713_p.pdf">Excerpt</a> <br><br>  For Habrozhiteley a 20% discount on coupon - <b>Java</b> </div><p>Source: <a href="https://habr.com/ru/post/425109/">https://habr.com/ru/post/425109/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../425099/index.html">What I understood and what problems I encountered creating the Hacker News clone</a></li>
<li><a href="../425101/index.html">Docker + Laravel = ‚ù§</a></li>
<li><a href="../425103/index.html">Stop Google predators chasing your kids</a></li>
<li><a href="../425105/index.html">Intel ME Manufacturing Mode - hidden threat or what is behind CVE-2018-4251 vulnerability in MacBook</a></li>
<li><a href="../425107/index.html">Fintech Digest: problems of biometrics on mobiles, leasing phones from Samsung, securities on the blockchain</a></li>
<li><a href="../425111/index.html">Promotional tricks that can cost you money and reputation</a></li>
<li><a href="../425113/index.html">‚ÄúDigital typography‚Äù or my experience in mobile book digitization</a></li>
<li><a href="../425115/index.html">Full-blown DevOps: Greek tragedy in three acts</a></li>
<li><a href="../425117/index.html">Two bits per transistor: Intel 8087 floating point high density ROM</a></li>
<li><a href="../425123/index.html">Mysterious heart of the drum machine Roland TR-808</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>