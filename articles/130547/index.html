<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>A little about setting up the VPS and about the script to add users</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Last Saturday, I wrote in the comments on Habr√© ‚Äúwell, one of these days I will publish my script,‚Äù and this came the other day. SUDDENLY. 

 Link to ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>A little about setting up the VPS and about the script to add users</h1><div class="post__text post__text-html js-mediator-article">  Last Saturday, I wrote in the comments on Habr√© ‚Äúwell, one of these days I will publish my script,‚Äù and this came the other day.  SUDDENLY. <br><br>  <a href="https://github.com/hshhhhh/Vps-configuration">Link</a> to the script. <br><br><h3>  VPS setup in general </h3>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Before setting up, I firmly decided that my VPS would be a security stronghold.  I wanted for each domain in the system to have its own user.  It is very neat and adds a little safety.  Began to consider options, they turned 5: <br><br><ol><li>  Proxy ngingx for one fcgi daemon running from under the root.  This is an excellent solution, but it works only in single-domain versions, I also wanted something like a shared one, but it turned out that through one process it was possible to reach any domain on the server.  Does not fit. </li><li>  For each user in the system, run your cgi process and constantly keep them in memory, proxy nginx to them.  I doubted such a decision and did not want to implement it (perhaps I had some objective considerations, but I do not remember).  But on the other hand someone <a href="http://habrahabr.ru/users/equand/" class="user_link">equand</a> <a href="http://habrahabr.ru/blogs/linux/129900/%3Freply_to%3D4304897">told</a> me in the comments that this solution shows itself very well.  I will believe him, but I will check on the next version. </li><li>  In freebsd, they say, there is a magic thing ‚ÄúJail‚Äù that solves all problems.  But it is freebsd.  Does not fit. </li><li>  Chroot'ing each domain.  I decided not to do because of the bulkiness and deadness of the VPS. </li><li>  I chose a traditional and disgusting performance solution with nginx + apache, but under Apache I use the <a href="http://mpm-itk.sesse.net/">mpm-itk module</a> for security.  It behaves well, but the performance is nearing the level of a pumpkin: 20 simultaneous requests to the dynamics of the server are enough :). </li></ol><br><br><a name="habracut"></a><h3>  About the organization of users and domains </h3><br><br>  I let Nginx out from under nginx: nginx, add the user nginx to the group for each user that is created for the domain.  I put 750 permissions on all directories in / home / in order for nginx to read the files, but it doesn't need any more - it only gives statics. <br><br>  A separate user is created for each domain.  To make it easier to look at the created domains, I call users in reverse notation, for example, hshhhhh.hahrahabr.ru will turn into ru_habrahabr_hshhhhh.  It becomes extremely convenient when several third-level domains are started up on a server.  Unfortunately I didn‚Äôt come to this right away and it was a dreary thing to rename. <br><br>  Apache launches a worker from under the user who owns the domain, which means he can only see his home directory and system files.  In any case, there will not be much strangers on my world. <br><br><h3>  About the script </h3><br><br>  Now, in fact, for the sake of which everything was started and therefore I will immediately make a reservation: <br><ol><li>  I perfectly understand that I am a bylokloder and pkhpshnik. </li><li>  I wrote a script for myself and was not going to show it to anyone at all. </li><li>  Based on the first two points, I weakly decided not to suffer and wrote it on pkhp instead of bash.  In light of the latest topics from <a href="http://habrahabr.ru/blogs/crazydev/">abnormal programming,</a> I am ashamed, but I will not rewrite. </li><li>  My knowledge of English is at an extremely high level and therefore errors in the comments are inevitable. </li><li>  I know that with quotes and strings I have hell there, but I will not rewrite again. </li></ol><br><br>  The script does the following: <br><ol><li>  Required to enter a domain name, for example ‚Äúmysite.ru‚Äù. </li><li>  Displays the future username, home directory and username in mysql. </li><li>  It offers to create a user, checks if there is such in the system.  If yes, it will die, and if not, it will create a home directory, create public_html in it, create index.html and write the domain name there, and then assign the correct owner and rights to the entire home directory. </li><li>  Asks whether to create a rule for nginx.  If yes, then take the template, replace the variables in it with the correct paths and put the rule for nginx in sites-availible.  Then he will ask if this rule is enabled for nginx and, if so, it will create a symlink in sites-enabled and tell nginx to re-read the configuration. </li><li>  He will do the same for Apache, and he can create a rule for Apache even if he refuses to make a rule for nginx.  On the one hand, there is a flaw, but on the other hand, it may come in handy (not yet). </li><li>  Ask if you want to create a database, cut the username to 16 characters, check for the existence of such in mysql and, if there is, torture until you enter a unique name.  Will create a database and prescribe accesses. </li><li>  Save all passwords (for ssh and mysql) to a file, then quit. </li></ol><br><br>  At the same time, passwords are stored in clear form in the home directory of the root - well, if there is access there, then why hide the passwords? <br><br>  And this script does not allow the newly created user to connect via ssh, it must be done by hand and I do not see any sense in automating this process. <br><br>  The control <a href="https://github.com/hshhhhh/Vps-configuration">link</a> to the script. <br><br>  <strong>UPD</strong> : forgot to add 2 useful config files to nginx. <br><br>  <strong>UPD2</strong> from some mike@danilenko.name about an interesting feature of mpm-itk: <br><blockquote>  I myself host several sites of adjacent offices on our server with ours, and also decided to try mod_itk during the transition from FreeBSD to Ubuntu.  even in spite of its inhibition, it was not relevant to me because the load on the sites is not big at all, this module has one big disadvantage, it is described in some foreign resources. <br>  When using keep-alive in Apache, a robot, for example, from Yandex, coming to index sites, walks all sites on the same IP at a time.  But since the rights are different, then by going to the xxx.ru website, having promoted it, he goes to the yyy.ru website ... and the Apache does not give him because he already works with the rights xxx.ru :( <br>  This is solved only by disabling keep-alive in the Apache ... maybe when working as a backend, this is not so bad, but for example, for me, he then gives static to individual forks. <br></blockquote><br><br>  <strong>UPD3</strong> : But <a href="http://habrahabr.ru/users/kuzmich/" class="user_link">Kuzmich</a> <a href="http://habrahabr.ru/blogs/sysadm/130547/">says</a> that: <br><blockquote>  The problem has been fixed about six months ago, as described in the documentation, the connection is now closed in these cases. <br></blockquote><br><br>  Just like in the series!  Shock!  Intrigue!  Investigations! </div><p>Source: <a href="https://habr.com/ru/post/130547/">https://habr.com/ru/post/130547/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../130542/index.html">Is it time for jQuery to go on a diet?</a></li>
<li><a href="../130543/index.html">Improved Google Calendar interface</a></li>
<li><a href="../130544/index.html">Apple potentially has the ability to block shipments of any Android device in Australia</a></li>
<li><a href="../130545/index.html">ScalaSPB Conference Video</a></li>
<li><a href="../130546/index.html">Visiting Odnoklassniki</a></li>
<li><a href="../130551/index.html">Might & Magic Heroes VI - burn in hell!</a></li>
<li><a href="../130552/index.html">Droider Show # 11. Sounds of music</a></li>
<li><a href="../130553/index.html">Gartner estimates the market for data center equipment at $ 99 billion</a></li>
<li><a href="../130554/index.html">CubeStormer II collects the Rubik's Cube in 5 seconds</a></li>
<li><a href="../130555/index.html">Execution of arbitrary code in Opera</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>