<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Androids in Dolphinariums</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Greetings to all lovers of those devices that fit in your pocket, as well as those who hold their pockets wider than 7 ". Now we are going to learn th...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Androids in Dolphinariums</h1><div class="post__text post__text-html js-mediator-article"> Greetings to all lovers of those devices that fit in your pocket, as well as those who hold their pockets wider than 7 ". Now we are going to learn the art of programming cross-platform graphical applications, that is, applications that run on a mobile platform (Android smartphones and tablets) and under Windows (stationary PCs, laptops, netbooks, tablets). At the same time, our applications will be graphical, the graphics are based on OpenGL (OGL) and its mobile version OpenGL ES (GLES). I use Embarcadero Delphi XE7. An important feature is in this project I do not use the platform  FM (FireMonkey), we will write everything ourselves and from scratch, like in the good old days. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/1f7/454/296/1f7454296431416a1346dd9da1e46fae.png" alt="image"><br><a name="habracut"></a><br>  I propose to immediately divide the work in half: <br>  - I am writing a cross-platform graphic library, reviewing examples of its use, writing down implementation details, answering questions; <br>  - your part is no less responsible: from you I need a test demos on various mobile devices, performance reports, reviews and critics, new ideas and <s>fresh meat</s> new users of both libraries and applications themselves. <br><br>  <b>1. First demo</b> <br>  Android mc.apk 3.8 MB <a href="https://yadi.sk/d/n1wDuX1RhC4QX">yadi.sk/d/n1wDuX1RhC4QX</a> <br>  Windows mc.zip 1.9 MB <a href="https://yadi.sk/d/tBKQxaV7ff8KW">yadi.sk/d/tBKQxaV7ff8KW</a> <br>  Source codes in repo: <a href="http://sourceforge.net/p/delphioga/code/ci/default/tree/">sourceforge.net/p/delphioga/code/ci/default/tree</a> <br>  In the first version, the program is not tricky - it simply displays 4096 angular colored balls on the screen and allows you to fly past them in the ‚Äúfree camera‚Äù mode.  I painted the spheres according to the RGB color space principle, they also rotate.  In this example, I want to consider methods for constructing 3D primitives (in particular, spheres) and techniques for optimizing rendering (Frustum ulling, detailing objects). <br>  But we can not do without a small introductory part. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <b>2. Operating instructions, Android smartphone / tablet</b> <br>  1. Install mc.apk, this is the program installation archive.  If you have questions on how to do this, I‚Äôm ready to help. <br>  2. When installing apk, a warning is possible that the program requires access to the Internet.  In fact, the program is compiled in Debug mode, so it potentially needs access to the local network for the debugger to work (gdbserver) and the logcat log console.  Logs we still need.  From the program itself to the network, I do not appeal in any way, there is only drawing graphics on the screen. <br>  3. After installation, you will add a new shortcut on the Desktop ‚Äúmc‚Äù.  Run the program.  We admire the splash screen - the light of the FM (I have not changed the icons of the mobile project Delphi by default yet).  Pay attention to the launch time of the application, how much time do you have in seconds and their shares?  We can compare this with the download times of examples of FM applications, so far the comparison is in our favor. <br>  4. Here you are, welcome.  Use your fingers and touchscreen to change your gaze direction and movement.  At the top right there are a couple of on-screen buttons - back and forth.  If you have 2 hands, you can move and rotate at the same time.  To do this, you need a certain skill, something that, but I did not promise a simple life. <br>  5. When switching to another application or ‚Äúfalling asleep‚Äù of a tablet (let's call a mobile device a tablet, because I have a tablet), the program will stop drawing graphics (the GLES context and the application window itself are deleted, as it should be done on Android), but the program will not stop work  When switching back to the app or ‚Äúwaking up‚Äù the tablet, the window and context will be recreated, we will continue our journey from the place of the stop.  You should pay attention to this nuance when testing, some games do not know how to ‚Äúrecover‚Äù correctly, but we should be able to. <br>  6. Rotate the tablet horizontally, then vertically.  The operation of the application should be checked in each of these two modes.  Of course, such a focus will work only if you have the orientation of the device display set to ‚Äúauto‚Äù. <br>  7. Quit the demo is easy - press the system back button. <br>  8. Write in the comments to the article the type of mobile device that you used (manufacturer, model), I will try to find its characteristics, types of CPU and GPU, OS version.  I include this data in the hardware.txt file in the repo. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/508/c0f/6bb/508c0f6bbd044a850849024f486a7168.png" alt="image"><br><br>  <b>3. Instructions for use, Windows</b> <br>  1. Unpack the zip file.  We are not surprised at the size of the exe file, the demo is compiled in Debug mode, in the release exe weighs 1.5 MB.  Run mc.exe. <br>  There will be no system warnings about using the network, as in Android, because the network is not used in the demo, the PC debugger and logs work locally. <br>  2. Here you are, welcome.  To change the direction of gaze and direction of movement, ‚Äúdrag‚Äù the screen while holding the left mouse button (LMB).  To move in space, the [WASD] keys on the keyboard (either the arrows or the arrows on the NumPad) work.  Screen buttons for moving back and forth too, they are clickable.  [F1] displays help, [ESC] allows you to exit the program. <br>  3. Pay attention to the second window (when you start the program, two windows appear on the control panel), this is the debug console.  We will look at a similar console for Android (logcat) later.  After the GPU Vendor, Renderer (the firm / type of your video card), it writes the Open GL version.  Let's just say, if the OpenGL version is below 3.0, then some future library features will not work on your old video card.  However, an application can contain 2 branches of the implementation of such features and work in any case. <br>  4. VSYNC is turned off in this example, FPS can be much more than 60 Hz (try to turn away from visible objects), the load on the GPU and CPU is maximum.  I do this to test the frame rendering speed, if you turn on VSYNC, the load will become normal. <br><br>  <b>4. Debug output to screen</b> <br>  In the screenshots at the top left there are some yellow letters and numbers. <br>  <u>FPS</u> is the average number of frames per second, our main tool in evaluating drawing performance.  Under Android, VSYNC is enabled, FPS is limited by the refresh rate of the screen (60 Hz), however, I adjusted the load on the GPU so much in the demo that on most mobile devices FPS will ‚Äúsubside‚Äù.  It's not scary yet control and animation remain adequate.  Under Windows, VSYNC is turned off; FPS has no limit; <br>  <u>TDF</u> - the average time of rendering one frame in milliseconds, in essence, the inverse of the FPS;  it is necessary to understand ‚Äútiming‚Äù - what order do we use to draw a frame;  with FPS 60 Hz, this time is about 17 ms; <br>  <u>NFR</u> - the number of rendered frames from the start of the application;  with an FPS of 60 Hz, this number will reach 60 in the first second; <br>  <u>T</u> is the time in ms from the start of the application, I use it as an argument for the animation functions, in the example the rotation of the spheres depends on it; <br>  <u>POS</u> - coordinates of the camera in the 3D world of XYZ, at the start of the axis are as follows: X to the right, Y up, Z to us; <br>  <u>AH, AV</u> - the angles of rotation of the camera relative to the horizontal and vertical in degrees;  it is better to talk about the angle of heel separately; <br>  <u>N</u> is the total number of objects in the Universe; <br>  <u>NV</u> - as many objects in whole or in part fall into the field of visibility (frustum, truncated pyramid of the camera's field of view); <br>  <u>HD</u> - so many near objects are displayed with slightly better quality of drawing, distant objects are drawn simpler; <br>  <u>SCR</u> - screen resolution. <br><br>  <b>5. What is the development process?</b> <br>  I connect the tablet to the PC under Windows with a USB cable (it can also be via Wi-Fi).  First, I write the platform-dependent code of some functions for Android, I run the program on the tablet.  This part of the work requires a lot of patience, the application compiles for a relatively long time and runs on the tablet.  Debugging is available (breakpoints, step-by-step execution, viewing the status of variables).  I also use the debug output of the application in logcat, I can watch the logs directly on the PC in real time.  When it worked on the tablet, I write a platform-specific version of the function code for Windows, this is easier.  After this, the most interesting begins - I write the main part of the program with a universal code causing platform functions of the same name, check on the PC and only occasionally upload it to the tablet, as a rule, everything works there. <br><br>  <b>6. Under the hood</b> <br>  Let's look at the source code a little bit.  In the common folder I own the library itself.  Let's start with the file Draw.pas. <br>  What are cross-platform graphics based on?  Under Windows, I use the OpenGL.pas module, but only those functions that have analogues in GLES for Android (modules Androidapi.Egl.pas, Androidapi.Gles.pas, Androidapi.Gles2.pas). <br><pre><code class="hljs delphi"><span class="hljs-keyword"><span class="hljs-keyword">uses</span></span> Types,SysUtils, <span class="hljs-meta"><span class="hljs-meta">{$IFDEF Android}</span></span> Androidapi.Egl, Androidapi.Gles, Androidapi.Gles2, <span class="hljs-meta"><span class="hljs-meta">{$ENDIF}</span></span> <span class="hljs-meta"><span class="hljs-meta">{$IFDEF MSWINDOWS}</span></span> Winapi.OpenGL, <span class="hljs-meta"><span class="hljs-meta">{$ENDIF}</span></span> Vectors, Colors, Textures, DrawPolyhedron, DrawSphere;</code> </pre> <br>  Where OGL and GLES match the differences in syntax is small, except that glOrtho had to trim.  Using conditional compilation directives like {$ IFDEF ANDROID} and {$ IFDEF MSWINDOWS}, we will describe a platform-dependent implementation. <br><pre> <code class="hljs delphi"><span class="hljs-meta"><span class="hljs-meta">{$IFDEF ANDROID}</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">glOrtho</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(left, right, bottom, top, zNear, zFar: GLfloat)</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> glOrthof(left, right, bottom, top, zNear, zFar); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-meta"><span class="hljs-meta">{$ENDIF}</span></span></code> </pre> <br>  What else does not match?  On GLES there is no glBegin / glEnd and, accordingly, the entire family of related functions.  It's not scary, we will draw in OGL 2.0 style by passing pointers to arrays of vertices at a time (normals, colors, texture coordinates).  For example, one simple triangle can be drawn like this (the color is current, there are no normals or textures): <br><pre> <code class="hljs delphi"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Triangle</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(p1, p2, p3: TV3)</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">overload</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> SetLength(ap3, <span class="hljs-number"><span class="hljs-number">3</span></span>); ap3[<span class="hljs-number"><span class="hljs-number">0</span></span>] := p1; ap3[<span class="hljs-number"><span class="hljs-number">1</span></span>] := p2; ap3[<span class="hljs-number"><span class="hljs-number">2</span></span>] := p3; glVertexPointer(<span class="hljs-number"><span class="hljs-number">3</span></span>, GL_FLOAT, <span class="hljs-number"><span class="hljs-number">0</span></span>, @ap3[<span class="hljs-number"><span class="hljs-number">0</span></span>]); glDrawArrays(GL_TRIANGLES, <span class="hljs-number"><span class="hljs-number">0</span></span>, Length(ap3)); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>;</code> </pre> <br>  To draw a set of triangles of a 3D shape, you should not call the Triangle procedure many times.  You should add all the vertices of all triangles into one array and draw them with a single call to glDrawArrays.  This function is used in the current demo to draw each sphere, both with GL_TRIANGLES and GL_TRIANGLE_STRIP: <br><pre> <code class="hljs pgsql">//     c  <span class="hljs-keyword"><span class="hljs-keyword">procedure</span></span> DrawAVNT(avn: TAVertexN; met:GLenum; Position,Rotation,Scale: TV3); <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> glPushMatrix; <span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span>(Position,Rotation,Scale); glVertexPointer(<span class="hljs-number"><span class="hljs-number">3</span></span>, GL_FLOAT, SizeOf(TVertexN), @avn[<span class="hljs-number"><span class="hljs-number">0</span></span>].V); glNormalPointer(GL_FLOAT, SizeOf(TVertexN), @avn[<span class="hljs-number"><span class="hljs-number">0</span></span>].N); glDrawArrays(met,<span class="hljs-number"><span class="hljs-number">0</span></span>,Length(avn));// GL_TRIANGLES glPopMatrix; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>;</code> </pre> <br><br>  At this point we will stop, for the first acquaintance this introductory part should suffice.  If you like it - I already have a continuation outline of the article. <br><br>  PS / 05.06.2015 <br>  The loading of 3D models in obj format has been added to the library. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/0f7/7e4/0e6/0f77e40e644adbfa6ebe15e9f568e1d4.png" alt="image"><br><br>  An additional source of information on the topic: <a href="http://forum.sources.ru/index.php%3Fshowtopic%3D401121">forum.sources.ru/index.php?showtopic=401121</a> </div><p>Source: <a href="https://habr.com/ru/post/258379/">https://habr.com/ru/post/258379/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../258367/index.html">Dadata.ru checks documents and knows all banks</a></li>
<li><a href="../258369/index.html">The main vulnerabilities of online banks: authorization, authentication and Android</a></li>
<li><a href="../258371/index.html">Moscow Python Meetup on "Async: why and when?" At Rambler & Co</a></li>
<li><a href="../258373/index.html">First look at HTML6 with examples and links</a></li>
<li><a href="../258377/index.html">Broadcast video from Raspberry Pi over 3G in three ways</a></li>
<li><a href="../258381/index.html">Automatic update of IP phones in 3CX. Part one. Theory</a></li>
<li><a href="../258383/index.html">Scrollport.js - new scrolling animation</a></li>
<li><a href="../258385/index.html">Odessa Open Class Programming Competition 2015</a></li>
<li><a href="../258387/index.html">How I complemented reality in the library</a></li>
<li><a href="../258389/index.html">Using IaaS-clouds for a loaded web project: the Hotels.ru experience</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>