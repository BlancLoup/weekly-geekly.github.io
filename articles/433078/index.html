<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We write trading robots using the StockSharp graphic framework. Part 2</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="We continue to talk about creating trading robots using the StockSharp platform. The first article dealt with the creation of the project and the draw...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We write trading robots using the StockSharp graphic framework. Part 2</h1><div class="post__text post__text-html js-mediator-article"> <a href="https://habr.com/company/iticapital/blog/433078/"><img src="https://habrastorage.org/webt/bv/ll/xa/bvllxaiaoeshjg0_71xwfocozqa.png"></a> <br><br>  We continue to talk about creating trading robots using the <a href="https://stocksharp.ru/">StockSharp</a> platform.  The <a href="https://habr.com/company/iticapital/blog/432812/">first article</a> dealt with the creation of the project and the drawing of the main elements of the trading system.  In the final material of the cycle, we will deal directly with the implementation of a trading strategy. <a name="habracut"></a><br><br><h2>  Creating a dashboard portfolio </h2><br>  By analogy with the toolbar, create a log panel.  To do this, add another UserControl to the XAML folder.  Give it the name PortfolioGridControl.  Add a PortfolioGrid element to it. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre><code class="cs hljs">&lt;UserControl x:Class=<span class="hljs-string"><span class="hljs-string">"ShellNew.XAML.PortfolioGridControl"</span></span> xmlns=<span class="hljs-string"><span class="hljs-string">"http://schemas.microsoft.com/winfx/2006/xaml/presentation"</span></span> xmlns:x=<span class="hljs-string"><span class="hljs-string">"http://schemas.microsoft.com/winfx/2006/xaml"</span></span> xmlns:mc=<span class="hljs-string"><span class="hljs-string">"http://schemas.openxmlformats.org/markup-compatibility/2006"</span></span> xmlns:d=<span class="hljs-string"><span class="hljs-string">"http://schemas.microsoft.com/expression/blend/2008"</span></span> xmlns:xaml=<span class="hljs-string"><span class="hljs-string">"http://schemas.stocksharp.com/xaml"</span></span> mc:Ignorable=<span class="hljs-string"><span class="hljs-string">"d"</span></span> d:DesignHeight=<span class="hljs-string"><span class="hljs-string">"450"</span></span> d:DesignWidth=<span class="hljs-string"><span class="hljs-string">"800"</span></span>&gt; &lt;xaml:PortfolioGrid x:Name=<span class="hljs-string"><span class="hljs-string">"PortfolioGrid"</span></span> /&gt; &lt;/UserControl&gt;</code> </pre> <br>  In the PortfolioGridControl designer, we need to subscribe to the events of the appearance of a new portfolio and the event of the emergence of a new position at the Connector. <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">PortfolioGridControl</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { InitializeComponent(); MainWindow.Instance.Connector.NewPortfolio += PortfolioGrid.Portfolios.Add; MainWindow.Instance.Connector.NewPosition += PortfolioGrid.Positions.Add; }</code> </pre> <br>  Thus, when creating a new portfolio, it will appear in the portfolios panel, and when a new position appears in the portfolios panel, it will be updated. <br><br>  Add the PortfolioGridControl panel created to the central part of the MainWindow: <br><br><pre> <code class="cs hljs">&lt;dxlc:LayoutGroup HorizontalAlignment=<span class="hljs-string"><span class="hljs-string">"Stretch"</span></span> View=<span class="hljs-string"><span class="hljs-string">"Tabs"</span></span>&gt; &lt;!--  --&gt; &lt;dxlc:LayoutGroup Header=<span class="hljs-string"><span class="hljs-string">"Securities"</span></span>&gt; &lt;myxaml:SecurityGridControl x:Name=<span class="hljs-string"><span class="hljs-string">"SecurityPanel"</span></span> /&gt; &lt;/dxlc:LayoutGroup&gt; &lt;dxlc:LayoutGroup Header=<span class="hljs-string"><span class="hljs-string">"Portfolios"</span></span>&gt; &lt;myxaml:PortfolioGridControl x:Name=<span class="hljs-string"><span class="hljs-string">"PortfolioGridControl"</span></span> /&gt; &lt;/dxlc:LayoutGroup&gt; &lt;/dxlc:LayoutGroup&gt;</code> </pre> <br>  Run to check: <br><br><img src="https://habrastorage.org/webt/bz/vs/tl/bzvstlk5xgb54mycansuoqjozhu.png"><br><br>  We have a tab with portfolios. <br><br><h2>  Creation of orders panel </h2><br>  The order pane in S # .API has the ability to place bids, withdraw bids and re-register.  By analogy with the toolbar, create an order panel, add another UserControl to the XAML folder.  Give it the name OrderGridControl.  Add an OrderGrid element to it: <br><br><pre> <code class="cs hljs">&lt;UserControl x:Class=<span class="hljs-string"><span class="hljs-string">"ShellNew.XAML.OrderGridControl"</span></span> xmlns=<span class="hljs-string"><span class="hljs-string">"http://schemas.microsoft.com/winfx/2006/xaml/presentation"</span></span> xmlns:x=<span class="hljs-string"><span class="hljs-string">"http://schemas.microsoft.com/winfx/2006/xaml"</span></span> xmlns:mc=<span class="hljs-string"><span class="hljs-string">"http://schemas.openxmlformats.org/markup-compatibility/2006"</span></span> xmlns:d=<span class="hljs-string"><span class="hljs-string">"http://schemas.microsoft.com/expression/blend/2008"</span></span> xmlns:xaml=<span class="hljs-string"><span class="hljs-string">"http://schemas.stocksharp.com/xaml"</span></span> mc:Ignorable=<span class="hljs-string"><span class="hljs-string">"d"</span></span> d:DesignHeight=<span class="hljs-string"><span class="hljs-string">"450"</span></span> d:DesignWidth=<span class="hljs-string"><span class="hljs-string">"800"</span></span>&gt; &lt;xaml:OrderGrid x:Name=<span class="hljs-string"><span class="hljs-string">"OrderGrid"</span></span> /&gt; &lt;/UserControl&gt;</code> </pre> <br>  OrderGrid has an OrderRegistering order registration event, an OrderReRegistering order re-registration event and an OrderCanceling order event. <br><br>  Create their handlers: <br><br><pre> <code class="cs hljs">&lt;UserControl x:Class=<span class="hljs-string"><span class="hljs-string">"ShellNew.XAML.OrderGridControl"</span></span> xmlns=<span class="hljs-string"><span class="hljs-string">"http://schemas.microsoft.com/winfx/2006/xaml/presentation"</span></span> xmlns:x=<span class="hljs-string"><span class="hljs-string">"http://schemas.microsoft.com/winfx/2006/xaml"</span></span> xmlns:mc=<span class="hljs-string"><span class="hljs-string">"http://schemas.openxmlformats.org/markup-compatibility/2006"</span></span> xmlns:d=<span class="hljs-string"><span class="hljs-string">"http://schemas.microsoft.com/expression/blend/2008"</span></span> xmlns:xaml=<span class="hljs-string"><span class="hljs-string">"http://schemas.stocksharp.com/xaml"</span></span> mc:Ignorable=<span class="hljs-string"><span class="hljs-string">"d"</span></span> d:DesignHeight=<span class="hljs-string"><span class="hljs-string">"450"</span></span> d:DesignWidth=<span class="hljs-string"><span class="hljs-string">"800"</span></span>&gt; &lt;xaml:OrderGrid x:Name=<span class="hljs-string"><span class="hljs-string">"OrderGrid"</span></span> OrderRegistering=<span class="hljs-string"><span class="hljs-string">"OrderGrid_OnOrderRegistering"</span></span> OrderReRegistering=<span class="hljs-string"><span class="hljs-string">"OrderGrid_OnOrderReRegistering"</span></span> OrderCanceling=<span class="hljs-string"><span class="hljs-string">"OrderGrid_OnOrderCanceling"</span></span> /&gt; &lt;/UserControl&gt;</code> </pre> <br>  In the event registration event handler, we create an OrderWindow window in which you need to specify data sources for instruments, portfolios, and market data.  In our case, this will all be Connector. <br><br>  After that, we call the OrderWindow method ShowModal.  If the OK button was pressed in this window, then we register the request via the RegisterOrder method: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OrderGrid_OnOrderRegistering</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> newOrder = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> OrderWindow { Title = <span class="hljs-string"><span class="hljs-string">"Order registering"</span></span>, Order = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Order(), SecurityProvider = MainWindow.Instance.Connector, MarketDataProvider = MainWindow.Instance.Connector, Portfolios = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PortfolioDataSource(MainWindow.Instance.Connector), }; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (newOrder.ShowModal(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>)) MainWindow.Instance.Connector.RegisterOrder(newOrder.Order); }</code> </pre> <br>  In the handler of the re-registration event, we do everything in the same way.  Only in this case, the Order object arrives at the event ‚Äî this is the application that needs to be reregistered.  Therefore, in OrderWindow, we specify <code>Order = order.ReRegisterClone(newVolume: order.Balance)</code> to fill in the fields of the OrderWindow window. <br><br>  After that, we call the OrderWindow method ShowModal.  If the OK button was pressed in this window, we will re-register the application through the ReRegisterClone method.  In it, we pass the old application, which must be canceled, and a new one, which must be submitted. <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OrderGrid_OnOrderReRegistering</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Order order)</span></span></span><span class="hljs-function"> </span></span>{ var window = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> OrderWindow { Title = <span class="hljs-string"><span class="hljs-string">"Order re-registering"</span></span>, SecurityProvider = MainWindow.Instance.Connector, MarketDataProvider = MainWindow.Instance.Connector, Portfolios = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PortfolioDataSource(MainWindow.Instance.Connector), Order = order.ReRegisterClone(newVolume: order.Balance) }; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (window.ShowModal(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>)) MainWindow.Instance.Connector.ReRegisterOrder(order, window.Order); }</code> </pre> <br>  In the event handler for the cancellation of an order, it is enough to call the CancelOrder method and pass an order to it, which must be canceled: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OrderGrid_OnOrderCanceling</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Order order</span></span></span><span class="hljs-function">)</span></span> { MainWindow.Instance.Connector.CancelOrder(order); }</code> </pre> <br>  In order for bids to be displayed in the OrderGrid, it is necessary in the OrderGridControl constructor to subscribe to the events of the appearance of a new bid and to the registration error event, and then transfer these events to the OrderGrid: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OrderGridControl</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { InitializeComponent(); MainWindow.Instance.Connector.NewOrder += OrderGrid.Orders.Add; MainWindow.Instance.Connector.OrderRegisterFailed += OrderGrid.AddRegistrationFail; }</code> </pre> <br>  Add the created OrderGridControl panel to the central part of the MainWindow: <br><br><pre> <code class="cs hljs">&lt;dxlc:LayoutGroup HorizontalAlignment=<span class="hljs-string"><span class="hljs-string">"Stretch"</span></span> View=<span class="hljs-string"><span class="hljs-string">"Tabs"</span></span>&gt; &lt;!--  --&gt; &lt;dxlc:LayoutGroup Header=<span class="hljs-string"><span class="hljs-string">"Securities"</span></span>&gt; &lt;myxaml:SecurityGridControl x:Name=<span class="hljs-string"><span class="hljs-string">"SecurityPanel"</span></span> /&gt; &lt;/dxlc:LayoutGroup&gt; &lt;dxlc:LayoutGroup Header=<span class="hljs-string"><span class="hljs-string">"Portfolios"</span></span>&gt; &lt;myxaml:PortfolioGridControl x:Name=<span class="hljs-string"><span class="hljs-string">"PortfolioGridControl"</span></span> /&gt; &lt;/dxlc:LayoutGroup&gt; &lt;dxlc:LayoutGroup Header=<span class="hljs-string"><span class="hljs-string">"Orders"</span></span>&gt; &lt;myxaml:OrderGridControl x:Name=<span class="hljs-string"><span class="hljs-string">"OrderGridControl"</span></span> /&gt; &lt;/dxlc:LayoutGroup&gt; &lt;/dxlc:LayoutGroup&gt;</code> </pre> <br>  Run to check: <br><br><img src="https://habrastorage.org/webt/hp/hu/m7/hphum7vg9x0p-ym0vwdg5_bhdv4.png"><br><br><h2>  Creating a panel of your own transactions </h2><br>  By analogy with the toolbar, create a panel of your own transactions.  Add another UserControl to the XAML folder.  Give it the name MyTradeGridControl.  Add the MyTradeGrid element to it: <br><br><pre> <code class="cs hljs">&lt;UserControl x:Class=<span class="hljs-string"><span class="hljs-string">"ShellNew.XAML.MyTradeGridControl"</span></span> xmlns=<span class="hljs-string"><span class="hljs-string">"http://schemas.microsoft.com/winfx/2006/xaml/presentation"</span></span> xmlns:x=<span class="hljs-string"><span class="hljs-string">"http://schemas.microsoft.com/winfx/2006/xaml"</span></span> xmlns:mc=<span class="hljs-string"><span class="hljs-string">"http://schemas.openxmlformats.org/markup-compatibility/2006"</span></span> xmlns:d=<span class="hljs-string"><span class="hljs-string">"http://schemas.microsoft.com/expression/blend/2008"</span></span> xmlns:xaml=<span class="hljs-string"><span class="hljs-string">"http://schemas.stocksharp.com/xaml"</span></span> mc:Ignorable=<span class="hljs-string"><span class="hljs-string">"d"</span></span> d:DesignHeight=<span class="hljs-string"><span class="hljs-string">"450"</span></span> d:DesignWidth=<span class="hljs-string"><span class="hljs-string">"800"</span></span>&gt; &lt;xaml:MyTradeGrid x:Name=<span class="hljs-string"><span class="hljs-string">"MyTradeGrid"</span></span> /&gt; &lt;/UserControl&gt;</code> </pre> <br>  In the MyTradeGridControl constructor, we need to subscribe to events of the appearance of a new own transaction and transfer it to MyTradeGrid: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MyTradeGridControl</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { InitializeComponent(); MainWindow.Instance.Connector.NewMyTrade += MyTradeGrid.Trades.Add; }</code> </pre> <br>  Add the created OrderGridControl panel to the central part of the MainWindow: <br><br><pre> <code class="css hljs">&lt;<span class="hljs-selector-tag"><span class="hljs-selector-tag">dxlc</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:LayoutGroup</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">HorizontalAlignment</span></span>="<span class="hljs-selector-tag"><span class="hljs-selector-tag">Stretch</span></span>" <span class="hljs-selector-tag"><span class="hljs-selector-tag">View</span></span>="<span class="hljs-selector-tag"><span class="hljs-selector-tag">Tabs</span></span>"&gt; &lt;!<span class="hljs-selector-tag"><span class="hljs-selector-tag">--</span></span>  <span class="hljs-selector-tag"><span class="hljs-selector-tag">--</span></span>&gt; &lt;<span class="hljs-selector-tag"><span class="hljs-selector-tag">dxlc</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:LayoutGroup</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Header</span></span>="<span class="hljs-selector-tag"><span class="hljs-selector-tag">Securities</span></span>"&gt; &lt;<span class="hljs-selector-tag"><span class="hljs-selector-tag">myxaml</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:SecurityGridControl</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">x</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:Name</span></span>="<span class="hljs-selector-tag"><span class="hljs-selector-tag">SecurityPanel</span></span>" /&gt; &lt;/<span class="hljs-selector-tag"><span class="hljs-selector-tag">dxlc</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:LayoutGroup</span></span>&gt; &lt;<span class="hljs-selector-tag"><span class="hljs-selector-tag">dxlc</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:LayoutGroup</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Header</span></span>="<span class="hljs-selector-tag"><span class="hljs-selector-tag">Portfolios</span></span>"&gt; &lt;<span class="hljs-selector-tag"><span class="hljs-selector-tag">myxaml</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:PortfolioGridControl</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">x</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:Name</span></span>="<span class="hljs-selector-tag"><span class="hljs-selector-tag">PortfolioGridControl</span></span>" /&gt; &lt;/<span class="hljs-selector-tag"><span class="hljs-selector-tag">dxlc</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:LayoutGroup</span></span>&gt; &lt;<span class="hljs-selector-tag"><span class="hljs-selector-tag">dxlc</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:LayoutGroup</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Header</span></span>="<span class="hljs-selector-tag"><span class="hljs-selector-tag">Orders</span></span>"&gt; &lt;<span class="hljs-selector-tag"><span class="hljs-selector-tag">myxaml</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:OrderGridControl</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">x</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:Name</span></span>="<span class="hljs-selector-tag"><span class="hljs-selector-tag">OrderGridControl</span></span>" /&gt; &lt;/<span class="hljs-selector-tag"><span class="hljs-selector-tag">dxlc</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:LayoutGroup</span></span>&gt; &lt;<span class="hljs-selector-tag"><span class="hljs-selector-tag">dxlc</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:LayoutGroup</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Header</span></span>="<span class="hljs-selector-tag"><span class="hljs-selector-tag">MyTrades</span></span>"&gt; &lt;<span class="hljs-selector-tag"><span class="hljs-selector-tag">myxaml</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:MyTradeGridControl</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">x</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:Name</span></span>="<span class="hljs-selector-tag"><span class="hljs-selector-tag">MyTradeGridControl</span></span>" /&gt; &lt;/<span class="hljs-selector-tag"><span class="hljs-selector-tag">dxlc</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:LayoutGroup</span></span>&gt; &lt;/<span class="hljs-selector-tag"><span class="hljs-selector-tag">dxlc</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:LayoutGroup</span></span>&gt;</code> </pre> <br>  Run to check: <br><br><img src="https://habrastorage.org/webt/-4/dr/x1/-4drx1smuyevvg-e5esktgw4ey4.png"><br><br><h2>  Creating a dashboard with a strategy </h2><br>  We will create a strategy panel in the same way as all previous panels.  Add another UserControl to the XAML folder.  Give it the name StrategyControl.  Using LayoutControl, we split the screen form into two parts.  On the left side there will be a tab with a candle chart and a tab with strategy statistics: <br><br><pre> <code class="cs hljs">&lt;dxlc:LayoutGroup Orientation=<span class="hljs-string"><span class="hljs-string">"Vertical"</span></span>&gt; &lt;dxlc:LayoutGroup View=<span class="hljs-string"><span class="hljs-string">"Tabs"</span></span> Name=<span class="hljs-string"><span class="hljs-string">"StatistisAndChartLayoutGroup"</span></span>&gt; &lt;dxlc:LayoutGroup Header=<span class="hljs-string"><span class="hljs-string">"Chart"</span></span>&gt; &lt;xaml:Chart x:Name=<span class="hljs-string"><span class="hljs-string">"Chart"</span></span> /&gt; &lt;/dxlc:LayoutGroup&gt; &lt;dxlc:LayoutGroup Header=<span class="hljs-string"><span class="hljs-string">"Statistic"</span></span>&gt; &lt;dxlc:LayoutItem VerticalAlignment=<span class="hljs-string"><span class="hljs-string">"Stretch"</span></span> dxlc:LayoutControl.AllowHorizontalSizing=<span class="hljs-string"><span class="hljs-string">"True"</span></span> &gt; &lt;xaml:StatisticParameterGrid x:Name=<span class="hljs-string"><span class="hljs-string">"StatisticParameterGrid"</span></span> MaxHeight=<span class="hljs-string"><span class="hljs-string">"2000"</span></span>/&gt; &lt;/dxlc:LayoutItem&gt; &lt;dxlc:LayoutItem VerticalAlignment=<span class="hljs-string"><span class="hljs-string">"Stretch"</span></span> &gt; &lt;xaml:EquityCurveChart x:Name=<span class="hljs-string"><span class="hljs-string">"EquityCurveChart"</span></span> /&gt; &lt;/dxlc:LayoutItem&gt; &lt;/dxlc:LayoutGroup&gt; &lt;/dxlc:LayoutGroup&gt; &lt;/dxlc:LayoutGroup&gt;</code> </pre> <br>  Here, StatisticParameterGrid is used to display strategy statistics, and EquityCurveChart is used to display profit and loss graphs.  For StatisticParameterGrid, you need to set some MaxHeight value, otherwise the application will not start. <br><br>  In the right part, the properties of the strategy will be set in the PropertyGridEx.  And also will be located the start and stop buttons of the strategy: <br><br><pre> <code class="cs hljs">&lt;dxlc:LayoutGroup View=<span class="hljs-string"><span class="hljs-string">"Group"</span></span> dxlc:LayoutControl.AllowHorizontalSizing=<span class="hljs-string"><span class="hljs-string">"True"</span></span> dxlc:DockLayoutControl.Dock=<span class="hljs-string"><span class="hljs-string">"Right"</span></span> Orientation=<span class="hljs-string"><span class="hljs-string">"Vertical"</span></span>&gt; &lt;dxlc:LayoutItem VerticalAlignment=<span class="hljs-string"><span class="hljs-string">"Stretch"</span></span>&gt; &lt;xaml:PropertyGridEx x:Name=<span class="hljs-string"><span class="hljs-string">"PropertyGridEx"</span></span> /&gt; &lt;/dxlc:LayoutItem&gt; &lt;dxlc:LayoutItem VerticalAlignment=<span class="hljs-string"><span class="hljs-string">"Stretch"</span></span> Height=<span class="hljs-string"><span class="hljs-string">"20"</span></span>&gt; &lt;dx:SimpleButton x:Name=<span class="hljs-string"><span class="hljs-string">"StartStrategyButton"</span></span> Content=<span class="hljs-string"><span class="hljs-string">"Start strategy"</span></span> ToolTip=<span class="hljs-string"><span class="hljs-string">"Start strategy"</span></span> Click=<span class="hljs-string"><span class="hljs-string">"StartStrategyButton_Click"</span></span> /&gt; &lt;/dxlc:LayoutItem&gt; &lt;dxlc:LayoutItem VerticalAlignment=<span class="hljs-string"><span class="hljs-string">"Stretch"</span></span> Height=<span class="hljs-string"><span class="hljs-string">"20"</span></span>&gt; &lt;dx:SimpleButton x:Name=<span class="hljs-string"><span class="hljs-string">"StopStrategyButton"</span></span> Content=<span class="hljs-string"><span class="hljs-string">"Stop strategy"</span></span> ToolTip=<span class="hljs-string"><span class="hljs-string">"Stop strategy"</span></span> Click=<span class="hljs-string"><span class="hljs-string">"StopStrategyButton_Click"</span></span> /&gt; &lt;/dxlc:LayoutItem&gt; &lt;/dxlc:LayoutGroup&gt;</code> </pre> <br>  Full code: <br><br><pre> <code class="cs hljs">&lt;UserControl x:Class=<span class="hljs-string"><span class="hljs-string">"ShellNew.XAML.StrategyControl"</span></span> xmlns=<span class="hljs-string"><span class="hljs-string">"http://schemas.microsoft.com/winfx/2006/xaml/presentation"</span></span> xmlns:x=<span class="hljs-string"><span class="hljs-string">"http://schemas.microsoft.com/winfx/2006/xaml"</span></span> xmlns:mc=<span class="hljs-string"><span class="hljs-string">"http://schemas.openxmlformats.org/markup-compatibility/2006"</span></span> xmlns:d=<span class="hljs-string"><span class="hljs-string">"http://schemas.microsoft.com/expression/blend/2008"</span></span> xmlns:dxlc=<span class="hljs-string"><span class="hljs-string">"http://schemas.devexpress.com/winfx/2008/xaml/layoutcontrol"</span></span> xmlns:xaml=<span class="hljs-string"><span class="hljs-string">"http://schemas.stocksharp.com/xaml"</span></span> xmlns:dx=<span class="hljs-string"><span class="hljs-string">"http://schemas.devexpress.com/winfx/2008/xaml/core"</span></span> mc:Ignorable=<span class="hljs-string"><span class="hljs-string">"d"</span></span>&gt; &lt;dxlc:LayoutControl&gt; &lt;dxlc:LayoutGroup Orientation=<span class="hljs-string"><span class="hljs-string">"Vertical"</span></span>&gt; &lt;dxlc:LayoutGroup View=<span class="hljs-string"><span class="hljs-string">"Tabs"</span></span> Name=<span class="hljs-string"><span class="hljs-string">"StatistisAndChartLayoutGroup"</span></span>&gt; &lt;dxlc:LayoutGroup Header=<span class="hljs-string"><span class="hljs-string">"Chart"</span></span>&gt; &lt;xaml:Chart x:Name=<span class="hljs-string"><span class="hljs-string">"Chart"</span></span> /&gt; &lt;/dxlc:LayoutGroup&gt; &lt;dxlc:LayoutGroup Header=<span class="hljs-string"><span class="hljs-string">"Statistic"</span></span>&gt; &lt;dxlc:LayoutItem VerticalAlignment=<span class="hljs-string"><span class="hljs-string">"Stretch"</span></span> dxlc:LayoutControl.AllowHorizontalSizing=<span class="hljs-string"><span class="hljs-string">"True"</span></span> &gt; &lt;xaml:StatisticParameterGrid x:Name=<span class="hljs-string"><span class="hljs-string">"StatisticParameterGrid"</span></span> MaxHeight=<span class="hljs-string"><span class="hljs-string">"2000"</span></span>/&gt; &lt;/dxlc:LayoutItem&gt; &lt;dxlc:LayoutItem VerticalAlignment=<span class="hljs-string"><span class="hljs-string">"Stretch"</span></span> &gt; &lt;xaml:EquityCurveChart x:Name=<span class="hljs-string"><span class="hljs-string">"EquityCurveChart"</span></span> /&gt; &lt;/dxlc:LayoutItem&gt; &lt;/dxlc:LayoutGroup&gt; &lt;/dxlc:LayoutGroup&gt; &lt;/dxlc:LayoutGroup&gt; &lt;dxlc:LayoutGroup View=<span class="hljs-string"><span class="hljs-string">"Group"</span></span> dxlc:LayoutControl.AllowHorizontalSizing=<span class="hljs-string"><span class="hljs-string">"True"</span></span> dxlc:DockLayoutControl.Dock=<span class="hljs-string"><span class="hljs-string">"Right"</span></span> Orientation=<span class="hljs-string"><span class="hljs-string">"Vertical"</span></span>&gt; &lt;dxlc:LayoutItem VerticalAlignment=<span class="hljs-string"><span class="hljs-string">"Stretch"</span></span>&gt; &lt;xaml:PropertyGridEx x:Name=<span class="hljs-string"><span class="hljs-string">"PropertyGridEx"</span></span> /&gt; &lt;/dxlc:LayoutItem&gt; &lt;dxlc:LayoutItem VerticalAlignment=<span class="hljs-string"><span class="hljs-string">"Stretch"</span></span> Height=<span class="hljs-string"><span class="hljs-string">"20"</span></span>&gt; &lt;dx:SimpleButton x:Name=<span class="hljs-string"><span class="hljs-string">"StartStrategyButton"</span></span> Content=<span class="hljs-string"><span class="hljs-string">"Start strategy"</span></span> ToolTip=<span class="hljs-string"><span class="hljs-string">"Start strategy"</span></span> Click=<span class="hljs-string"><span class="hljs-string">"StartStrategyButton_Click"</span></span> /&gt; &lt;/dxlc:LayoutItem&gt; &lt;dxlc:LayoutItem VerticalAlignment=<span class="hljs-string"><span class="hljs-string">"Stretch"</span></span> Height=<span class="hljs-string"><span class="hljs-string">"20"</span></span>&gt; &lt;dx:SimpleButton x:Name=<span class="hljs-string"><span class="hljs-string">"StopStrategyButton"</span></span> Content=<span class="hljs-string"><span class="hljs-string">"Stop strategy"</span></span> ToolTip=<span class="hljs-string"><span class="hljs-string">"Stop strategy"</span></span> Click=<span class="hljs-string"><span class="hljs-string">"StopStrategyButton_Click"</span></span> /&gt; &lt;/dxlc:LayoutItem&gt; &lt;/dxlc:LayoutGroup&gt; &lt;/dxlc:LayoutControl&gt; &lt;/UserControl&gt;</code> </pre> <br>  In the StrategyControl constructor, we set the Connector as the data source for the PropertyGridEx, in almost every control we performed the following actions: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">StrategyControl</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { InitializeComponent(); PropertyGridEx.SecurityProvider = MainWindow.Instance.Connector; PropertyGridEx.Portfolios = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PortfolioDataSource(MainWindow.Instance.Connector); }</code> </pre> <br>  We need to somehow transfer the strategy to our control.  To do this, we create a BindStraregy method in StrategyControl that will accept the strategy, save a reference to it in a local variable, and also set a strategy in the PropertyGridEx and StatisticParameterGrid. <br><br>  Using the SetChart method into the strategy, we betray the chart of the Chart candles, after which the Chart strategy can be obtained using the GetChart method.  We also set the Connector for the strategy. <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Strategy _strategy; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">BindStraregy</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Strategy strategy</span></span></span><span class="hljs-function">)</span></span> { _strategy = strategy; PropertyGridEx.SelectedObject = strategy; StatisticParameterGrid.Parameters. AddRange(_strategy.StatisticManager.Parameters); _strategy.SetChart(Chart); _strategy.Connector = MainWindow.Instance.Connector; }</code> </pre> <br>  When working with the profit and loss schedule, it is necessary to take into account that we will start and stop the strategy, perhaps several times; the poem must be cleared with each launch of the strategy.  For this, we will create a ResetEquityCurveChart method in which we will first clear EquityCurveChart.  After that we need to create graphic elements for EquityCurveChart, they can specify the name, color and line type. <br><br>  After that we subscribe to the PnL change event of the strategy and in the handler of this event we draw a new value on the EquityCurveChart profit / loss graph: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ResetEquityCurveChart</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { EquityCurveChart.Clear(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> pnl = EquityCurveChart. CreateCurve(<span class="hljs-string"><span class="hljs-string">"PNL"</span></span>, Colors.Green, ChartIndicatorDrawStyles.Area); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> unrealizedPnL = EquityCurveChart. CreateCurve(<span class="hljs-string"><span class="hljs-string">"unrealizedPnL"</span></span>, Colors.Black, ChartIndicatorDrawStyles.Line); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> commissionCurve = EquityCurveChart .CreateCurve(<span class="hljs-string"><span class="hljs-string">"commissionCurve"</span></span>, Colors.Red, ChartIndicatorDrawStyles.Line); _strategy.PnLChanged += () =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> data = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ChartDrawData(); data.Group(_strategy.CurrentTime) .Add(pnl, _strategy.PnL) .Add(unrealizedPnL, _strategy.PnLManager.UnrealizedPnL ?? <span class="hljs-number"><span class="hljs-number">0</span></span>) .Add(commissionCurve, _strategy.Commission ?? <span class="hljs-number"><span class="hljs-number">0</span></span>); EquityCurveChart.Draw(data); }; }</code> </pre> <br>  In the event handler for pressing the Start button, we will call this method.  And also we will reset the state of the strategy and run it: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">StartStrategyButton_Click</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> sender, RoutedEventArgs e</span></span></span><span class="hljs-function">)</span></span> { ResetEquityCurveChart(); _strategy.Reset(); _strategy.Start(); }</code> </pre> <br>  In the event handler, pressing the Stop button will stop the strategy. <br>  private void StopStrategyButton_Click (object sender, RoutedEventArgs e): <br><br><pre> <code class="cs hljs">{ _strategy.Stop(); }</code> </pre> <br>  In the central part of the MainWindow, add the created StrategyControl panel: <br><br><pre> <code class="cs hljs">&lt;dxlc:LayoutGroup HorizontalAlignment=<span class="hljs-string"><span class="hljs-string">"Stretch"</span></span> View=<span class="hljs-string"><span class="hljs-string">"Tabs"</span></span>&gt; &lt;!--  --&gt; &lt;dxlc:LayoutGroup Header=<span class="hljs-string"><span class="hljs-string">"Securities"</span></span>&gt; &lt;myxaml:SecurityGridControl x:Name=<span class="hljs-string"><span class="hljs-string">"SecurityPanel"</span></span> /&gt; &lt;/dxlc:LayoutGroup&gt; &lt;dxlc:LayoutGroup Header=<span class="hljs-string"><span class="hljs-string">"Portfolios"</span></span>&gt; &lt;myxaml:PortfolioGridControl x:Name=<span class="hljs-string"><span class="hljs-string">"PortfolioGridControl"</span></span> /&gt; &lt;/dxlc:LayoutGroup&gt; &lt;dxlc:LayoutGroup Header=<span class="hljs-string"><span class="hljs-string">"Orders"</span></span>&gt; &lt;myxaml:OrderGridControl x:Name=<span class="hljs-string"><span class="hljs-string">"OrderGridControl"</span></span> /&gt; &lt;/dxlc:LayoutGroup&gt; &lt;dxlc:LayoutGroup Header=<span class="hljs-string"><span class="hljs-string">"MyTrades"</span></span>&gt; &lt;myxaml:MyTradeGridControl x:Name=<span class="hljs-string"><span class="hljs-string">"MyTradeGridControl"</span></span> /&gt; &lt;/dxlc:LayoutGroup&gt; &lt;dxlc:LayoutGroup Header=<span class="hljs-string"><span class="hljs-string">"MarketDepth"</span></span>&gt; &lt;myxaml:MarketDepthControl x:Name=<span class="hljs-string"><span class="hljs-string">"MarketDepthControl"</span></span> /&gt; &lt;/dxlc:LayoutGroup&gt; &lt;dxlc:LayoutGroup Header=<span class="hljs-string"><span class="hljs-string">"SimpleStrategyControl"</span></span>&gt; &lt;myxaml:StrategyControl x:Name=<span class="hljs-string"><span class="hljs-string">"SimpleStrategyControl"</span></span> /&gt; &lt;/dxlc:LayoutGroup&gt; &lt;/dxlc:LayoutGroup&gt;</code> </pre> <br><h2>  Creating a strategy </h2><br>  For example, consider creating a simple strategy with candles.  She will buy if the candle is growing (green) and sell if the candle is decreasing (red). <br><br>  Let's create another folder in the project - we will keep all our strategies in it.  In this folder, create a new class, let's call it SimpleStrategy.  All S # strategies must inherit from the base Strategy class. <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">SimpleStrategy</span></span> : <span class="hljs-title"><span class="hljs-title">Strategy</span></span> {}</code> </pre> <br>  Since our strategy uses candles, we will create a public property CandleSeries and in the constructor of our strategy we will give it a default value. <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">SimpleStrategy</span></span> : <span class="hljs-title"><span class="hljs-title">Strategy</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> CandleSeries Series { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SimpleStrategy</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { Series = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CandleSeries(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(TimeFrameCandle), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Security(), TimeSpan.FromSeconds(<span class="hljs-number"><span class="hljs-number">15</span></span>)) { BuildCandlesMode = MarketDataBuildModes.Build }; } }</code> </pre> <br>  Here we indicated that candles in CandleSeries will be TimeFrameCandle, with an interval of 15 seconds (TimeSpan.FromSeconds (15)).  For CandleSeries, you can specify the BuildCandlesMode candlestick creation mode.  We indicated that candles will be built (MarketDataBuildModes.Build).  By default, they will be built from ticks, but other data types can be specified. <br><br>  Since we made the CandleSeries a public property, the CandleSeries can be additionally configured from the PropertyGridEx described in the previous paragraph.  All strategies have methods that can be overridden, we need to override the OnStarted method.  It is called before launching the strategy and allows you to pre-set its starting state. <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnStarted</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { _connector = (Connector)Connector; Series.Security = Security; _connector .WhenCandlesFinished(Series) .Do(ProcessCandle) .Apply(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); _connector.SubscribeCandles(Series); <span class="hljs-keyword"><span class="hljs-keyword">base</span></span>.OnStarted(); }</code> </pre> <br>  Here we set the tool for CandleSeries, which is specified in the PropertyGridEx.  Then create a rule processing the finished candle.  In the rule we specify the method that will process each completed candle - in our case it is the ProcessCandle method.  It will be described later.  After everything is set, we subscribe to the appearance of candles on the CandleSeries in the connector via the SubscribeCandles method.  In our case, the ProcessCandle method contains the main logic of the strategy: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ProcessCandle</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Candle candle</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!IsRealTime(candle)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (candle.OpenPrice &lt; candle.ClosePrice &amp;&amp; Position &lt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) { RegisterOrder(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.BuyAtMarket(Volume + Math.Abs(Position))); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (candle.OpenPrice &gt; candle.ClosePrice &amp;&amp; Position &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) { RegisterOrder(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.SellAtMarket(Volume + Math.Abs(Position))); } }</code> </pre> <br>  First of all, we need to determine whether the candle is being built in real time or is historical.  If the candle is historical, then we ignore it.  Not all strategies require this, for example, strategies based on glasses do not require this as the glasses always go real time.  There is no universal way to determine whether a candle is ‚Äúreal-time‚Äù or historical, and in each strategy this problem will have to be solved independently depending on the requirements.  In this case, we will simply compare the time the candle closes with the time in the connector and if it does not exceed a certain lag, then the candle will have real-time status. <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">IsRealTime</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Candle candle</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (Connector.CurrentTime - candle.CloseTime).TotalSeconds &lt; <span class="hljs-number"><span class="hljs-number">10</span></span>; }</code> </pre> <br>  Next, we look at what kind of candle it is and what the current position of the strategy is.  If the candle is growing, then with a position equal to 0 we will open the position with a market bid for the volume specified by us in PropertyGridEx.  If the candle is growing and the position is less than 0, then we ‚Äúturn over‚Äù the position: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (candle.OpenPrice &lt; candle.ClosePrice &amp;&amp; Position &lt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) { RegisterOrder(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.BuyAtMarket(Volume + Math.Abs(Position))); }</code> </pre> <br><br>  The opposite actions are done for a diminishing candle: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (candle.OpenPrice &gt; candle.ClosePrice &amp;&amp; Position &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) { RegisterOrder(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.SellAtMarket(Volume + Math.Abs(Position))); }</code> </pre> <br>  At the moment our strategy is ready to go.  It must be passed to SimpleStrategyControl, which we created in the previous paragraph using the BindStraregy method.  We do this in the MainWindow constructor immediately after the initialization of the MainWindow components. <br><br><pre> <code class="cs hljs">SimpleStrategyControl.BindStraregy(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SimpleStrategy());</code> </pre> <br><br>  Run to check: <br><br><img src="https://habrastorage.org/webt/b1/-p/t6/b1-pt6ohswyhv5ylanblhvjhsf4.png"><br><br><img src="https://habrastorage.org/webt/ig/qx/kd/igqxkdcsehmsbeeayj-wnhgmhuk.png"><br><br>  The strategy works, transactions are made, but so far there are no candles and deals on the chart. <br><br><h2>  Adding candles and deals to the chart from the strategy </h2><br>  In the paragraph about the strategy panel with the help of the SetChart method in the strategy, we betrayed the chart of candles Chart.  In the OnStarted strategy method, we check whether the Graph is installed on the strategy and if it is installed, then we initialize the chart and also subscribe to the events of the emergence of a new own transaction and a change in the candle. <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnStarted</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { _connector = (Connector)Connector; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.GetChart() <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> Chart chart) { InitChart(chart); NewMyTrade += DrawMyTrade; _connector.CandleSeriesProcessing += CandleSeriesProcessing; } Series.Security = Security; _connector .WhenCandlesFinished(Series) .Do(ProcessCandle) .Apply(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); _connector.SubscribeCandles(Series); <span class="hljs-keyword"><span class="hljs-keyword">base</span></span>.OnStarted(); }</code> </pre> <br>  InitChart chart initialization method: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> ChartCandleElement _chartCandleElement; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> ChartTradeElement _tradesElem; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Chart _chart; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">InitChart</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Chart chart</span></span></span><span class="hljs-function">)</span></span> { _chart = chart; _chart.GuiSync(() =&gt; { _chart.ClearAreas(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> candlesArea = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ChartArea(); _chart.AddArea(candlesArea); _chartCandleElement = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ChartCandleElement(); _chart.AddElement(candlesArea, _chartCandleElement); _tradesElem = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ChartTradeElement { FullTitle = <span class="hljs-string"><span class="hljs-string">"Trade"</span></span> }; _chart.AddElement(candlesArea, _tradesElem); }); }</code> </pre> <br>  Here we store the reference to Chart in a local variable.  Clear the schedule.  We also create and transfer to the chart the chart elements for candles and deals.  Construction _chart.GuiSync (() =&gt; {...});  needed in order for the initialization of the schedule to be executed in the main thread. <br><br>  Candle drawing method on CandleSeriesProcessing chart: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CandleSeriesProcessing</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">CandleSeries candleSeries, Candle candle</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> data = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ChartDrawData(); data.Group(candle.OpenTime) .Add(_chartCandleElement, candle); _chart.Draw(data); }</code> </pre> <br>  Here we get a candle from the event of the CandleSeriesProcessing connector, create a ChartDrawData to display it on the chart.  Specify the time data.Group (candle.OpenTime), indicate that the candle should be added to the candlestick element of the graph .Add (_chartCandleElement, candle) ;.  And we indicate that the graphics need to draw new data. <br><br>  Similar actions are performed for transactions: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DrawMyTrade</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">MyTrade myTrade</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> data = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ChartDrawData(); data.Group(myTrade.Trade.Time) .Add(_tradesElem, myTrade); _chart.Draw(data); }</code> </pre> <br>  Run to check: <br><br><img src="https://habrastorage.org/webt/bv/ll/xa/bvllxaiaoeshjg0_71xwfocozqa.png"><br><br><h2>  Brief conclusion </h2><br>  To create a sophisticated and professional looking application, you don‚Äôt need to spend a lot of time.  Within a few hours we created a full-fledged application with the ability to configure, display direct trading and algorithmic trading. <br>  Do not be afraid to try and create your own trading programs.  We hope this article will help you get started in this matter. <br><br>  <b>The author</b> : Ivan Zalutsky </div><p>Source: <a href="https://habr.com/ru/post/433078/">https://habr.com/ru/post/433078/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../433066/index.html">HighLoad Cup # 2. Championship for backend-developers back in the ranks</a></li>
<li><a href="../433070/index.html">How to distinguish shampoo from champignons, and skewers from champagne ... Elasticsearch - search for goods in store databases</a></li>
<li><a href="../433072/index.html">How to hacked the copy protection console Sega Dreamcast</a></li>
<li><a href="../433074/index.html">Switching to Kotlin in the Android project: Tips and Tricks</a></li>
<li><a href="../433076/index.html">How we made our Android Gallery library to view media content</a></li>
<li><a href="../433080/index.html">Pocket OLAP in Javascript and IndexedDB Performance</a></li>
<li><a href="../433082/index.html">Bleeding someone else's accounts has become a criminal offense in South Korea</a></li>
<li><a href="../433084/index.html">Open lesson "Feature Engineering on the example of the classic dataset of the Titanic"</a></li>
<li><a href="../433086/index.html">Tinkoff and everything, everything, everything: IoT, analytics and observation for banks</a></li>
<li><a href="../433088/index.html">How do you like it, Ilon Musk: BMW and Porsche have developed a charge that adds 100 km of travel in 3 minutes</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>