<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Writing a desktop widget under Maemo5 on Qt. Part one</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good day habrachelovek. I continue to write articles about the N900. This time I address it to the developers. And not only to developers for the N900...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Writing a desktop widget under Maemo5 on Qt. Part one</h1><div class="post__text post__text-html js-mediator-article">  Good day habrachelovek.  I continue to write articles about the N900.  This time I address it to the developers.  And not only to developers for the N900, but to all developers in general. <br>  I‚Äôm addressing all the developers, as there is a lot of controversy that writing for the N900 isn‚Äôt promising.  At least I got the impression after reading the comments in the discussions of <a href="http://habrahabr.ru/blogs/nokia/97441/">my previous article</a> .  Here in this article I will try to show that it is not. <br><img src="http://erudenko.com/photo/N900/th10/widgetBP.jpeg" alt="image"><br>  In this and the next article I will demonstrate how to create an application for the N900 on Qt.  And this is not a simple application, but a desktop widget.  Baseline data will be: <br><ul><li>  lack of knowledge of Hildon and GTK; </li><li>  lack of specific knowledge of mobile platforms in general; </li><li>  little knowledge of developing desktop applications in Qt / C ++ or in any other language (in this case, you will have to spend a little more time reading Qt documentation); </li><li>  a little assiduity and interest (although this is the last point, but it is clear that it is the most important). </li></ul><br>  Thus, I intend to demonstrate that building Qt applications really does not require knowledge of the specifics of the platform in the vast majority of cases.  And if the application uses only Qt API, then it is absolutely portable between the officially supported platforms. <br><a name="habracut"></a><br><h4>  Introduction </h4><br>  And so, what will we do? <br>  I decided to kill two birds with one stone: not only to prove my point of view (what to write for the N900 is easy and promising), but also to make the application I need.  And this application - the schedule of movement of electric trains.  It is simple enough to make an introductory course on the basis of it and useful enough to improve my life (and I hope someone else). <br>  I often use electric trains (I don‚Äôt have to stand in traffic jams and have the opportunity to read or watch movies, since I don‚Äôt need to concentrate on driving), but those who drive this type of transport know that sometimes you get into a situation where there is a big pause between the trains. and you have to wait on the platform (the platform in this case is a concrete structure, so that it would be more convenient to enter high railway cars, and not a <a href="http://ru.wikipedia.org/wiki/%25D0%259A%25D0%25BE%25D0%25BC%25D0%25BF%25D1%258C%25D1%258E%25D1%2582%25D0%25B5%25D1%2580%25D0%25BD%25D0%25B0%25D1%258F_%25D0%25BF%25D0%25BB%25D0%25B0%25D1%2582%25D1%2584%25D0%25BE%25D1%2580%25D0%25BC%25D0%25B0">computer platform</a> ).  The presence in your pocket schedule of the nearest trains can improve the situation. <br><img src="http://erudenko.com/photo/N900/th10/sobaka.jpeg" alt="image"><br>  Naturally it will be more convenient if the application is in the N900 in the most prominent place - on the desktop.  This can be implemented by making the application in the form of a widget.  In addition, we will write on Qt, since this is the official development tool for Maemo5 (despite the fact that Maemo5 is a GTK / Hildon platform). <br>  Moreover, the application can be easily converted into a plasmoid or just a small utility that will hang and show the schedule on the desktop.  Anyway, this application is not limited to trains.  Maybe someone uses buses that go on a schedule or any other type of transport (maybe even a ferry :-)). <br><br><h4>  Where to get the schedule? </h4><br>  Before proceeding with the design of the application, it is necessary to determine where to get the information itself. <br><img src="http://erudenko.com/photo/N900/th10/raspisanie_old.jpeg" alt="image"><br>  Considering that the application should not be tied to a specific schedule provider (at least for now), since this can take a lot of time from the organizational side, I decided to devote a minimum of time to this issue and focus on developing the application itself.  The easiest option that immediately catches the eye is to write an application - which parses the html page with the schedule and converts it to a single view that the application understands. <br>  Advantages of the approach: <br><ul><li>  the application is not tied to a specific source of information (it may not even be an html page); </li><li>  allows you to transparently scale the application without changing the source code (for example, you can provide an application from static content, a web service or a proxy service). </li></ul><br>  Disadvantages: <br><ul><li>  you need to independently monitor the relevance of the content and write a converter for each source of the schedule; </li><li>  the schedule is static, simply as a ‚Äústation to station‚Äù type table, that is, if you need to go from station 1 to station 2, you need one schedule, and if you already want to see the schedule from station 1 to station 3 (even if you are traveling through the station 2), then you need another separate schedule; </li><li>  There is no possibility to select a schedule from the program itself. </li></ul><br>  Given the shortcomings of the approach, I immediately decided that this was all temporary.  And later it will be necessary to rework the data format in such a way as to be able to dynamically select the following points. <br>  What are we going to parse?  I was immediately struck by the <a href="http://rasp.yandex.ru/">service from Yandex</a> and the presence of a <a href="http://m.rasp.yandex.ru/">mobile version</a> convinced me that this is the easiest source for writing and debugging an application.  But to my disappointment, I found that in this way I violate the <a href="http://m.rasp.yandex.ru/user_agreement">user agreement from Yandex</a> .  It clearly states: <br>  <i>The materials posted on the website of the Service (hereinafter - the Materials) are intended solely for personal non-commercial use.</i>  <i>At the same time, any copying, reproduction, processing, distribution, placement in free access (publication) on the Internet, any use in the media and / or for commercial purposes without the prior written permission of the copyright holder is prohibited.</i> <i><br></i> <br>  Therefore, I warn you that you cannot use my parser, it violates this user agreement.  It should be used only for informational purposes with the principle of the application. <br>  Later I found legal sources of information, at least in these sources I did not find information that use for my own purposes is prohibited.  For example, <a href="http://pass.rzd.ru/isvp/public/pass%3FSTRUCTURE_ID%3D5104">directly on the site of the Russian Railways</a> there is a schedule of suburban trains in the xls format (but without prompt changes in the schedule).  Plus in the user agreement from Yandex is a list of sources of information.  I didn‚Äôt find any restrictions on the use of the information provided on many of them either.  Therefore, I believe that these are legal sources.  But they are scattered and motley.  Therefore, we take Yandex as a starting point, although not legal. <br><br><h4>  Parser Yandex. </h4><br>  Since the solution with the parser for Yandex is a temporary solution, and the main task at the moment is to create a Qt-widget on the desktop, I decided to devote a minimum of time to this issue.  The easiest solution for me was to write a parser in Python using the Beautiful Soap library.  I ask python connoisseurs to evaluate the code and make their corrections, if necessary.  Since I am not a python connoisseur, I will be very grateful for any constructive criticism. <br>  You can see the code <a href="http://pastebin.com/qC34p9Yb">here</a> . <br>  To get the necessary xml output, you need to ‚Äúfeed‚Äù the script with the desired URL of the mobile timetable from Yandex.  For example, the URL for the timetable for the Leningrad direction from Ostankino station to Khovrino is: <a href="http://m.rasp.yandex.ru/suburban_search%3Fdirection%3Dmsk_len%26station_from_suggest%3D%26station_to_suggest%3D%26station_to%3D9603505%26mode%3Dall%26station_from%3D9603877">m.rasp.yandex.ru/suburban_search?direction=msk_len&amp;station_from_suggest=&amp;station_to_suggest=&amp;station_to=9603505&amp;mode=all_station_rf</a> <br>  Run the script: <br><blockquote>  python ./rasp.py " <a href="http://m.rasp.yandex.ru/suburban_search%3Fdirection%3Dmsk_len%26station_from_suggest%3D%26station_to_suggest%3D%26station_to%3D9603505%26mode%3Dall%26station_from%3D9603877">m.rasp.yandex.ru/suburban_search?direction=msk_len&amp;station_from_suggest=&amp;station_to_suggest=&amp;station_to=9603505&amp;mode=all&amp;station_from=9603877</a> " <br></blockquote><br>  and get the xml output. <br><blockquote><code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">&lt;</font> <font color="#800000">rasp</font> <font color="#ff0000">name</font> <font color="#0000ff">=" "</font> <font color="#0000ff">&gt;</font> <br> <font color="#0000ff">&lt;</font> <font color="#800000">train</font> <font color="#0000ff">&gt;</font> <br> <font color="#0000ff">&lt;</font> <font color="#800000">time</font> <font color="#0000ff">&gt;</font> <br> 11:04 <br> <font color="#0000ff">&lt;/</font> <font color="#800000">time</font> <font color="#0000ff">&gt;</font> <br> <font color="#0000ff">&lt;</font> <font color="#800000">url</font> <font color="#0000ff">&gt;</font> <br> not realized <br> <font color="#0000ff">&lt;/</font> <font color="#800000">url</font> <font color="#0000ff">&gt;</font> <br> <font color="#0000ff">&lt;</font> <font color="#800000">note</font> <font color="#0000ff">&gt;</font> <br>  <br> <font color="#0000ff">&lt;/</font> <font color="#800000">note</font> <font color="#0000ff">&gt;</font> <br> <font color="#0000ff">&lt;/</font> <font color="#800000">train</font> <font color="#0000ff">&gt;</font> <br> ....................... <br> <font color="#0000ff">&lt;/</font> <font color="#800000">rasp</font> <font color="#0000ff">&gt;</font></font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Then we put this file in the network (on your hosting or somewhere else, from where it will be available at the URL).  I put it in the <a href="">dropbox public folder</a> . <br>  All data preparation is complete.  The file of the format we need lies in the network and is available at the above address.  Now you can go to the design of the application. <br><br><h4>  Design. </h4><br>  The appearance of the application, I think should be simple and clear.  In the header of the article you can see the drawing of the widget, which I took <a href="http://wiki.maemo.org/Documentation/Maemo_5_Developer_Guide/Human_Interface_Guidelines/Desktop_Widget_UI_Guidelines">from the article on the development of desktop widgets for Maemo</a> . <br>  It's simple: a list of the nearest electric trains with departure times, notes (canceled, only on weekends and so on) and when you click you can go to the page / tab with the route of this particular train (bus or plane). <br>  Below are three buttons: the previous schedule, update and the next schedule.  At a minimum, you will need 2 schedules: back and forth. <br>  If there are designers ready to draw this widget - I will be very happy.  Need substrates and buttons and a general view with the names and sizes of fonts.  If there are no such people, you will have to invent them yourself.  Design reward - contributing studio / person to co-developers.  Who knows, maybe this project will grow into a serious product. <br><br>  The interior design is also not original.  I used the standard for Qt MVC template and standard classes that implement it.  Qt's MVC implementation looks like this: <br><img src="http://erudenko.com/photo/N900/th10/modelview.png" alt="image"><br>  It differs from the <a href="http://heim.ifi.uio.no/~trygver/themes/mvc/mvc-index.html">canonical implementation</a> , but it <a href="http://doc.qt.nokia.com/4.6/model-view-programming.html">is not very difficult to understand</a> . <br><br><h4>  Implementation. </h4><br>  That's what I ended up with: <br><img src="http://erudenko.com/photo/N900/th10/MVC.jpeg" alt="image"><br>  According to the scheme, it can be traced that the information from the site is parsed by the Python script and is provided in the form of the above xml file to the application via http. <br>  RaspParser is a QXmlStreamReader descendant that parses this xml.  Analysis is carried out by the recursive descent technique.  This is a Qt implementation of the <a href="http://www.xml.com/pub/a/2005/07/06/tr.html">Pull parser</a> . <br>  The entire main part of the implementation fits into several lines: <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">void</font> RaspParser::readRaspItem() <br> { <br> Q_ASSERT(xml.isStartElement() &amp;&amp; xml.name() == <font color="#A31515">"train"</font> ); <br> <br> RaspItem theItem; <br> <font color="#0000ff">while</font> (xml.readNextStartElement()) { <br> <font color="#0000ff">if</font> (xml.name() == <font color="#A31515">"time"</font> ) <br> theItem.time = QTime::fromString(xml.readElementText().trimmed(), <font color="#A31515">"hh:mm"</font> ); <br> <font color="#0000ff">else</font> <font color="#0000ff">if</font> (xml.name() == <font color="#A31515">"url"</font> ) <br> theItem.url = QUrl(xml.readElementText().trimmed()); <br> <font color="#0000ff">else</font> <font color="#0000ff">if</font> (xml.name() == <font color="#A31515">"note"</font> ) <br> theItem.note = xml.readElementText().trimmed(); <br> <font color="#0000ff">else</font> <br> xml.skipCurrentElement(); <br> } <br> items-&gt;append(theItem); <br> <br> }</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  The data is returned to the model - YandexHttpRaspModel (the name is not successful, it is possible that it will refactor).  This is a QAbstractListModel heir that returns the departure time of the trains.  To ensure the operation of the model, it is necessary to block several methods: <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">int</font> rowCount ( <font color="#0000ff">const</font> QModelIndex &amp; parent = QModelIndex() ) <font color="#0000ff">const</font> ; <br> QVariant data ( <font color="#0000ff">const</font> QModelIndex &amp; index, <font color="#0000ff">int</font> role = Qt::DisplayRole ) <font color="#0000ff">const</font> ; <br></font> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  The implementation also does not strike the imagination: <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">int</font> YandexHttpRaspModel::rowCount ( <font color="#0000ff">const</font> QModelIndex &amp; parent) <font color="#0000ff">const</font> <br> { <br> Q_UNUSED(parent); <br> Q_D( <font color="#0000ff">const</font> YandexHttpRaspModel); <br> <font color="#0000ff">return</font> d-&gt;items.count(); <br> <br> } <br> QVariant YandexHttpRaspModel::data ( <font color="#0000ff">const</font> QModelIndex &amp; index, <font color="#0000ff">int</font> role) <font color="#0000ff">const</font> <br> { <br> Q_D( <font color="#0000ff">const</font> YandexHttpRaspModel); <br> <br> <font color="#0000ff">if</font> (!index.isValid()) <br> <font color="#0000ff">return</font> QVariant(); <br> <br> <font color="#0000ff">if</font> (index.row() &gt;= d-&gt;items.size()) <br> <font color="#0000ff">return</font> QVariant(); <br> <br> <font color="#0000ff">if</font> (role == Qt::DisplayRole) <br> <font color="#0000ff">return</font> d-&gt;items.at(index.row()).time; <br> <font color="#0000ff">else</font> <font color="#0000ff">if</font> (role == Qt::UserRole+1) <br> <font color="#0000ff">return</font> d-&gt;items.at(index.row()).note; <br> <font color="#0000ff">else</font> <font color="#0000ff">if</font> (role == Qt::UserRole+2) <br> <font color="#0000ff">return</font> d-&gt;items.at(index.row()).url; <br> <font color="#0000ff">else</font> <br> <font color="#0000ff">return</font> QVariant(); <br> } <br></font> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  But a little clarification is needed.  The class is written using the pimpl template <a href="http://habrahabr.ru/blogs/qt_software/76248/">I described earlier</a> .  It also has a <a href="http://habrahabr.ru/blogs/qt_software/76506/">private slot</a> . <br>  The data method involved two roles: Qt :: UserRole + 1 and Qt :: UserRole + 2.  Since we have 3 fields (time, note and link), and a model in the form of a one-dimensional list, the delegate will need to somehow find out information about the note and link (‚Äúdeparture time‚Äù is returned directly as data, through the role of Qt :: DisplayRole ) if necessary.  It is through these roles that the delegate will be able to access this data. <br>  Of course, it could be done in the form of a table and not a list, but in this case I decided that the list represents the data, and how to display additional information is the task of the delegate (according to the template). <br><br>  And the last link in the link: QListView.  This is a standard Qt widget for displaying information from a model that provides information in the form of a list (inherited from QAbstractListModel). <br><br>  The delegate, for a beautiful display of information, while we will not implement. <br><br><h4>  Result. </h4><br>  As a result of the build and launch, you should get something like this application (the application is only desktop): <br><img src="http://erudenko.com/photo/N900/th10/MainWindow.jpeg" alt="image"><br>  At this stage, I consider the first part completed.  We have a practically working application (or rather, a prototype) capable of displaying information about the timetable in the form of a list. <br>  Time Spent: <br>  Schedule search and schedule sources - 1 hour. <br>  Writing a parser on python - 15 minutes. <br>  Writing and debugging applications - 1 hour. <br>  Total costs in the first stage: 2 hours and 15 minutes of pure time. <br>  Please note that writing this paper with the design, including creating images, took me about 6 hours of clean time. <br><br><h4>  What we will do in the next article. </h4><br>  There is still plenty of work to complete the second part (it is impossible to completely complete the development of the application, the last 1 percent of development lasts forever).  At least 2 hours. <br>  Here is the estimated list: <br><ul><li>  arrange the application as a widget on the desktop for the N900; </li><li>  make the address settings from where to ship (now "zahardkozheno"); </li><li>  make a delegate to display beautiful items and buttons (really looking forward to participating designers to participate); </li><li>  make the display from the current time point, the functionality of the "nearest trains"; </li><li>  make several bookmarks, several schedules with settings for each one and implement the ‚Äúprevious‚Äù and ‚Äúnext‚Äù schedule buttons; </li><li>  display the names of the schedule and the direction itself. </li></ul><br>  I think after the implementation of these points, the application can be considered to have passed to the preliminary alpha stage. <br><br>  In the comments waiting for feedback, comments and suggestions. <br>  PS: source codes for this first stage can <a href="">be found here</a> . </div><p>Source: <a href="https://habr.com/ru/post/98091/">https://habr.com/ru/post/98091/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../98086/index.html">National video chat "My Choice": a view of the developer</a></li>
<li><a href="../98087/index.html">As an introduction</a></li>
<li><a href="../98088/index.html">Brodsky met with IT-Schnick of Ukraine</a></li>
<li><a href="../98089/index.html">Evaluation of the quality of advertising traffic</a></li>
<li><a href="../98090/index.html">Smartphones on Intel processors will be released in early 2011</a></li>
<li><a href="../98092/index.html">Yandex's response to the copy-paste signal</a></li>
<li><a href="../98093/index.html">Carefully Connected - nice and kind, but only until the time of purchase</a></li>
<li><a href="../98094/index.html">Installing Trojan via USB plug-and-play</a></li>
<li><a href="../98096/index.html">The head of Google does not deny creating your own social network</a></li>
<li><a href="../98098/index.html">Vulnerability on the virtual hosting infobox</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>