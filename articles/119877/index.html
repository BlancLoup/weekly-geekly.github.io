<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>About blocks and their use in Objective-C part 1</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In OS X 10.6 and iOS 4.0, Apple announced support for blocks that are essentially closures . Further about blocks in a development context under IOS, ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>About blocks and their use in Objective-C part 1</h1><div class="post__text post__text-html js-mediator-article">  In OS X 10.6 and iOS 4.0, Apple announced support for <a href="http://developer.apple.com/library/ios/">blocks</a> that are essentially <a href="http://ru.wikipedia.org/wiki/%25D0%2597%25D0%25B0%25D0%25BC%25D1%258B%25D0%25BA%25D0%25B0%25D0%25BD%25D0%25B8%25D0%25B5_(%25D0%25BF%25D1%2580%25D0%25BE%25D0%25B3%25D1%2580%25D0%25B0%25D0%25BC%25D0%25BC%25D0%25B8%25D1%2580%25D0%25BE%25D0%25B2%25D0%25B0%25D0%25BD%25D0%25B8%25D0%25B5)">closures</a> .  Further about blocks in a development context under IOS, Objective-C (that is work without <a href="http://ru.wikipedia.org/wiki/%25D0%25A1%25D0%25B1%25D0%25BE%25D1%2580%25D0%25BA%25D0%25B0_%25D0%25BC%25D1%2583%25D1%2581%25D0%25BE%25D1%2580%25D0%25B0">gc</a> ). <br>  To use IOS blocks ver.  &lt;4.0 you can apply <a href="http://habrahabr.ru/blogs/macosxdev/119472/">ESBlockRuntime</a> or <a href="http://code.google.com/p/plblocks/">PLBlocks</a> . <br><br><h4>  Briefly about the theory </h4><br>  The block instance, the block type, and the block literal itself are denoted using the ^ operator, for example: <br><br><blockquote><code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">typedef <font color="#0000ff">int</font> (^MyBlock)( <font color="#0000ff">int</font> ); <br> <br> <font color="#0000ff">int</font> multiplier = 7; <br> MyBlock myBlock = ^( <font color="#0000ff">int</font> num) { <br> <font color="#0000ff">return</font> num * multiplier; <br> };</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  or 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">int</font> multiplier = 7; <br> <font color="#0000ff">int</font> (^myBlock)( <font color="#0000ff">int</font> ) = ^( <font color="#0000ff">int</font> num) { <br> <font color="#0000ff">return</font> num * multiplier; <br> };</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  Calling a block is similar to calling a regular sishnaya function.  For example: <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">myBlock( 3 )</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  The main feature of the blocks is their ability to store the context in which they were created.  In the example above, ‚ÄúmyBlock‚Äù will always multiply the number by 7. How does all this work? <br><a name="habracut"></a><br><h5>  Kinds of block context variables </h5><br>  1. Primitive types C and structures, blocks stored as constants.  Example: <br><br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">int</font> multiplier = 7; <br> <font color="#0000ff">int</font> (^myBlock)( <font color="#0000ff">int</font> ) = ^( <font color="#0000ff">int</font> num) { <br> <font color="#0000ff">return</font> num * multiplier; <br> }; <br> multiplier = 8; <br> NSLog( <font color="#A31515">@"%d"</font> , myBlock( 3 ) );</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  Prints - 21, not 24. <br><br>  2. Variables set with the __block keyword are mutable.  This works by copying the value of such a variable into a heap, and each block stores a reference to this variable.  Example: <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">__block <font color="#0000ff">int</font> multiplier = 7; <br> <font color="#0000ff">int</font> (^myBlock)( <font color="#0000ff">int</font> ) = ^( <font color="#0000ff">int</font> num) { <br> <font color="#0000ff">return</font> num * multiplier; <br> }; <br> multiplier = 8; <br> NSLog( <font color="#A31515">@"%d"</font> , myBlock( 3 ) );</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  Prints - 24, not 21. <br><br>  3. Variables - pointers to objects with reference counting (id, NSObject).  For them, retain is called when copying a block to a heap.  Example: <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">NSDate* date = [ [ NSDate alloc ] init ]; <br> <br> <font color="#0000ff">void</font> (^printDate)() = ^() { <br> NSLog( <font color="#A31515">@"date: %@"</font> , date ); <br> }; <br> <br> <font color="#008000">//   </font> <br> printDate = [ [ printDate copy ] autorelease ]; <br> <br> [ date release ]; <br> <br> printDate();</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  Here you want to draw your attention to the fact that the retain of the date object occurs during the copying of the block into the heap, and not during its creation.  For example, this code will fall with ‚ÄúEXC_BAD_ACCESS‚Äù <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">NSDate* date = [ [ NSDate alloc ] init ]; <br> <br> <font color="#0000ff">void</font> (^printDate)() = ^() { <br> NSLog( <font color="#A31515">@"date: %@"</font> , date ); <br> }; <br> <br> [ date release ]; <br> <br> <font color="#008000">//     </font> <br> printDate = [ [ printDate copy ] autorelease ]; <br> <br> printDate();</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  4. Variables - pointers to objects with reference counting (id, NSObject) declared with the __block keyword.  They are <b>NOT called</b> retain when copying a block to a heap.  Example: <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">__block NSDate* date = [ [ NSDate alloc ] init ]; <br> <br> <font color="#0000ff">void</font> (^printDate)() = ^() { <br> <font color="#008000">//     date</font> <br> NSLog( <font color="#A31515">@"date: %@"</font> , date ); <br> }; <br> <br> <font color="#008000">//   ,   date retain  </font> <br> printDate = [ [ printDate copy ] autorelease ]; <br> <br> [ date release ]; <br> <br> printDate();</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  This is usually used to avoid circular references.  Example: <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">@ <font color="#0000ff">interface</font> SomeClass : NSObject <br> <br> <font color="#008000">//  </font> <br> @property ( nonatomic, copy ) SimpleBlock block; <br> <br> @end <br> <br> @implementation SomeClass <br> <br> @synthesize block = _block; <br> <br> -( <font color="#0000ff">void</font> )dealloc <br> { <br> [ _block release ]; <br> <br> [ super dealloc ]; <br> } <br> <br> -( <font color="#0000ff">void</font> )methodB <br> { <br> } <br> <br> -( <font color="#0000ff">void</font> )methodA <br> { <br> __block SomeClass* self_ = self; <br> <font color="#008000">//  (  ) -   ,     </font> <br> self.block = ^() <br> { <br> <font color="#008000">// retain  self_  </font> <br> [ self_ methodB ]; <br> }; <br> } <br> <br> @end</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  The blocks are instances of the NSObject class (specific classes of these objects are not defined), so we can and must use the methods of the NSObject - copy, retain, release and autorelease class methods for blocks.  But why do we need it? <br><br><h5>  Blocks and memory management </h5><br>  By default, block instances are not created on the heap, as one might expect, but on the stack.  Therefore, if necessary, make a deferred call block first you need to copy it into a heap. <br><br>  Suppose there is an extension of the class NSObject with the ‚ÄúperformAfterDelay:‚Äù method, which performs the specified block with a delay. <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">@implementation NSObject (BlocksExtensions) <br> <br> -( <font color="#0000ff">void</font> )callSelfBlock <br> { <br> <font color="#0000ff">void</font> * self_ = self; <br> ESSimpleBlock block_ = (ESSimpleBlock)self_; <br> block_(); <br> } <br> <br> -( <font color="#0000ff">void</font> )performAfterDelay:( NSTimeInterval )delay_ <br> { <br> [ self performSelector: @selector( callSelfBlock ) withObject: nil afterDelay: delay_ ]; <br> } <br> <br> @end</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  And, actually, the challenge: <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">NSDate* date = [ NSDate date ]; <br> <br> <font color="#0000ff">void</font> (^printDate)() = ^() { <br> NSLog( <font color="#A31515">@"date: %@"</font> , date ); <br> }; <br> <br> [ printDate performAfterDelay: 0.3 ];</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  Such code will ‚Äúoverthrow‚Äù our application, because the stack unit will be destroyed by the time it is called, and we will turn to random memory in the place where the unit is called.  Although this code: <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">void</font> (^printDate)() = ^() { <br> NSLog( <font color="#A31515">@"date: %@"</font> , [ NSDate date ] ); <br> }; <br> <br> [ printDate performAfterDelay: 0.3 ];</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  will work great.  What is the reason?  Note that the last block does not refer to external variables, therefore there is no need to create a copy of it.  In this case, the compiler creates a so-called Global block.  The program has only one instance of such a block, the lifetime of which is limited by the lifetime of the application.  Thus, GlobalBlock can be considered as a singletone object. <br><br><h5>  Types of block variables </h5><br>  And so, to summarize.  There are three types of blocks: global (stateless), local or stack, and blocks in the heap (MallocBlock).  Therefore, the copy, retain, release, and autorelease methods of the global block do nothing.  The retain method also does nothing for the stack block.  For the Malloc block, the copy method in turn works like a retain for NSObject. <br><br>  And of course the revised version of the previous example with the addition of the copy method: <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">@implementation NSObject (BlocksExtensions) <br> <br> -( <font color="#0000ff">void</font> )callSelfBlock <br> { <br> <font color="#0000ff">void</font> * self_ = self; <br> ESSimpleBlock block_ = (ESSimpleBlock)self_; <br> block_(); <br> } <br> <br> -( <font color="#0000ff">void</font> )performAfterDelay:( NSTimeInterval )delay_ <br> { <br> <font color="#008000">//   ,     - afterDelay:</font> <br> self = [ [ self copy ] autorelease ]; <br> [ self performSelector: @selector( callSelfBlock ) withObject: nil afterDelay: delay_ ]; <br> } <br> <br> @end</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  Continued: <a href="http://habrahabr.ru/blogs/macosxdev/120869/">"On blocks and their use in Objective-C part 2"</a> </div><p>Source: <a href="https://habr.com/ru/post/119877/">https://habr.com/ru/post/119877/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../119872/index.html">SQA Days 9 Conference Continues Online</a></li>
<li><a href="../119873/index.html">Japan is going to create a nationwide "solar" power system</a></li>
<li><a href="../119874/index.html">What does Cisco think about the future?</a></li>
<li><a href="../119875/index.html">Jobs Life: Going for Success with Steve</a></li>
<li><a href="../119876/index.html">Report-Driven Design</a></li>
<li><a href="../119879/index.html">MacBook and accelerometer</a></li>
<li><a href="../119880/index.html">Matte vs. glossy screens: why the PC industry is out of context</a></li>
<li><a href="../119882/index.html">Work with OAuth v2</a></li>
<li><a href="../119884/index.html">Opera Mini 6 for iOS</a></li>
<li><a href="../119885/index.html">The use of metamodel in the design of databases with several abstract layers (Part 2)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>