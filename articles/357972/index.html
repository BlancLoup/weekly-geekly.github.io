<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Reverse "Neuromant". Part 2: Render the Font</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi, you are reading a continuation of an article on reverse engineering of Neuromant, a video game released by Interplay Productions in 1988 based on ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Reverse "Neuromant". Part 2: Render the Font</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://habrastorage.org/webt/q4/lr/_v/q4lr_vdj5burp8iytbrm82blrjw.png" width="96%" height="96%"><br></p><br><p>  Hi, you are reading a continuation of an article on reverse engineering of Neuromant, a video game released by <em>Interplay Productions</em> in 1988 based on the novel by William Gibson.  And, if you have not seen the <a href="https://habr.com/post/352050/">first part</a> , then I recommend starting with it, where I talk about my motivation and share the first results. </p><br><blockquote>  <a href="https://habr.com/post/352050/">Reverse "Neuromant".</a>  <a href="https://habr.com/post/352050/">Part 1: Sprites</a> </blockquote><p>  And we continue literally from the same place where we stopped last time. </p><a name="habracut"></a><br><hr><br><p> Based on the assumption that the same <code>.PIC</code> are stored in .PIC, you can try to apply the same functions to the <code>.PIC</code> files that I unpacked <code>.IMH</code> resources.  I take the first <code>.PIC</code> ( <code>R1.PIC</code> ) and read it into the buffer: </p><br><pre> <code class="markdown hljs">R1.PIC: 4934  0x0000: 0008 010a 000f 020c 0102 020f 0600 0f0f 0x0010: 0004 060e 0000 0607 0309 010f 0a0d 0d0f 0x0020: 981d 0000 2002 0611 74a2 38c5 d003 e9cb 0x0030: fb18 ac3b 8fbf 2713 459e 8c3f 3aa1 6ca7 ... 0x1330: 6f8a c3f5 d9c7 53e5 f47c d945 51d9 c753 0x1340: e5bf 1ebf 3f00</code> </pre> <br><p>  Great, this file starts the same way as any <code>.IMH</code> : </p><br><ul><li>  <code>0x00:0x1F</code> - 32 bytes of unknown purpose <em>[in the last part I mistakenly thought that it was a palette, but that it really was - I hadn‚Äôt yet figured out]</em> ; </li><li>  <code>word 0x20</code> is the byte size of the data after decompression <em>[I understood this a bit later when I noticed that the size of the output data of the decompression algorithm coincides with this value]</em> ; </li><li>  <code>word 0x22</code> - a zero separating the data <em>[it is quite possible that this is the second Word length, but here I have not met such large values]</em> . </li></ul><br><p>  Now carefully, under the debugger, we try to decode it.  The decompression function completes successfully and returns the length of the decompressed data: </p><br><pre> <code class="markdown hljs">R1.PIC_decompd: 7576  0x0000: e901 1130 1113 0111 3011 1301 1130 1113 0x0010: 0111 3011 1301 3130 0113 f801 3330 1333 ... 0x1d80: 00ff 0816 00fe 8000 0108 0100 0180 ff08 0x1d90: 2b00 ff80 0288 0200</code> </pre> <br><p>  But what I see here is somewhat different from what I observed after decompression of <code>.IMH</code> resources.  No, it still looks like a bitmap encoded by the same <em>Run-Length</em> algorithm, but without the _ [ <code>struct rle_hdr_t</code> from the last part] header <em>, containing pixel dimensions.</em>  <em>This is not good, because I used these dimensions to stop the decoding algorithm in time</em> [the <code>decode_rle()</code> function from the last part] _ and build the <code>.BMP</code> header.  If we assume that only one image is encoded there, then the length of the input data would be enough to stop the algorithm, but to save the image in <code>.BMP</code> , one cannot do without linear dimensions. </p><br><p>  But we will solve problems as they come.  Suppose that in each <code>.PIC</code> one image is actually stored, and their pixel dimensions are the same.  I <code>decode_rle()</code> function so that it counts the number of processed <em>input</em> bytes, and not the decoded output.  I pass through it the buffer <code>r1_pic_decompd</code> .  It completes successfully, returning a bitmap with a size of 34048 bytes (17024 * 2, taking into account the fact that the values ‚Äã‚Äãof two pixels are written in one byte): </p><br><pre> <code class="markdown hljs">R1.PIC_decoded: 17024  0x0000: 0111 3011 1301 1130 1113 0111 3011 1301 0x0010: 1130 1113 0131 3013 1301 3330 1333 0333 ... 0x4270: 7777 7777 7777 7777 7708 8800 0088 8880</code> </pre> <br><p>  Width and height are unknown in the wake-up, but I think that I am dealing with backgrounds of locations, which means that we can try to measure them right in the game.  But it is still easier, because among the exported <code>.IMH</code> resources there was an image of the in-game user interface in the natural size ( <code>NEURO.IMH</code> ).  I open the image in <em>Paint</em> and make measurements: </p><br><p><img src="https://habrastorage.org/webt/93/1m/mj/931mmjqis9buq5iduaooefgfaqk.png" width="96%" height="96%"><br></p><br><p>  The multiplication of the width and height gives the necessary 34048 bytes - you can safely wrap this and all other backs in <code>.BMP</code> (55 pieces in total): </p><br><p><img src="https://habrastorage.org/webt/do/m4/7y/dom47ygvaxr7fjyh48a-7_ygm6m.png" width="48%" height="48%"><img src="https://habrastorage.org/webt/le/lq/at/lelqat_f3iov_bdbwacai7jwmhu.png" width="48%" height="48%"><br><img src="https://habrastorage.org/webt/lc/we/ur/lcweurpuhp-p1oxavns5yfydl2c.png" width="32%" height="32%"><img src="https://habrastorage.org/webt/xw/lx/qc/xwlxqcl0qpnulsfjm20nzreerzo.png" width="32%" height="32%"><img src="https://habrastorage.org/webt/ol/qh/sh/olqhshubldipygwtiuvzbkvuk8u.png" width="32%" height="32%"><br></p><br><hr><br><p>  On this wave, you can try to split the resource types of an unknown purpose - <code>.BIH</code> and <code>.ANH</code> .  I act according to the old scheme: I read a random file;  if it looks like you can unclench - unclench it;  if it is similar to <em>RLE</em> - I decode.  And, in general, the plan worked, but what is inside, so to speak ... ambiguous.  I take, for example, the contents of the resource <code>R1.BIH</code> after decompression: </p><br><pre> <code class="markdown hljs">R1.BIH<span class="hljs-emphasis"><span class="hljs-emphasis">_decompd: 2151  0x0000: 00 00 00 00 00 00 fe 00 2a 00 00 00 00 00 fb 00 .......*...... 0x0010: fd 00 fc 00 00 00 c7 00 46 5a 5a 5f 9b 5f 9f 73 .....FZZ_</span></span>.<span class="hljs-emphasis"><span class="hljs-emphasis">_—üs 0x0020: 46 73 5a 77 00 5f 02 73 01 00 2e 00 7a 00 01 02 FsZw._</span></span>.s....z... 0x0030: 13 00 03 04 05 12 00 7f 2c 00 08 14 00 2e 13 00 ........,....... 0x0040: 0e 3d 00 01 00 0e 12 00 ff ff 0e 14 00 00 00 03 .=............ 0x0060: 01 11 16 db 00 01 1f 02 20 0e 14 00 00 00 0e 12 ....... ....... 0x0070: 00 ff ff 12 06 10 00 ff cc ff 05 10 00 06 07 00 ........... 0x0080: 01 08 04 04 00 01 07 04 bc ff 01 0b 13 00 0c 03 ........—ò...... 0x0090: 17 05 10 00 ff 05 00 04 f9 ff 05 10 00 0c 07 00 ............. 0x00A0: 01 0f 04 0a 00 05 10 00 0d 0b 00 01 10 13 00 0c ................ 0x00B0: 03 04 df ff 01 13 13 00 17 02 06 10 00 ff f8 ff ........... 0x00C0: 05 10 00 17 07 00 01 19 04 ed ff 13 00 1b 02 01 .............. 0x00D0: 1a 06 10 00 ff fc ff 05 10 00 1b 07 00 01 1d 04 ............. 0x00E0: 04 00 01 1e 13 00 ff 00 04 ff ff e8 13 00 81 c3 ..........–É 0x00F0: 04 00 8b 1f 8b 47 14 01 87 ca 00 83 97 cc 00 00 .....G....—ì‚Äî.. 0x0100: cb e8 01 00 90 5b 81 eb f4 00 c3 cb cb cb 59 6f ..—í[–É.Yo 0x0110: 75 27 76 65 20 6a 75 73 74 20 73 70 65 6e 74 20 u've just spent 0x0120: 74 68 65 20 6e 69 67 68 74 20 73 6c 65 65 70 69 the night sleepi 0x0130: 6e 67 20 66 61 63 65 2d 64 6f 77 6e 20 69 6e 20 ng face-down in 0x0140: 61 20 70 6c 61 74 65 20 6f 66 20 73 79 6e 74 68 a plate of synth 0x0150: 2d 73 70 61 67 68 65 74 74 69 20 69 6e 20 61 20 -spaghetti in a 0x0160: 62 61 72 20 63 61 6c 6c 65 64 20 74 68 65 20 43 bar called the C 0x0170: 68 61 74 73 75 62 6f 2e 20 41 66 74 65 72 20 72 hatsubo. After r 0x0180: 75 62 62 69 6e 67 20 74 68 65 20 73 61 75 63 65 ubbing the sauce 0x0190: 20 6f 75 74 20 6f 66 20 79 6f 75 72 20 65 79 65 out of your eye 0x01A0: 73 2c 20 79 6f 75 20 63 61 6e 20 73 65 65 20 43 s, you can see C 0x01B0: 68 69 62 61 20 73 6b 79 20 74 68 72 6f 75 67 68 hiba sky through 0x01C0: 20 74 68 65 20 77 69 6e 64 6f 77 2c 20 74 68 65 the window, the 0x01D0: 20 63 6f 6c 6f 72 20 6f 66 20 74 65 6c 65 76 69 color of televi 0x01E0: 73 69 6f 6e 20 74 75 6e 65 64 20 74 6f 20 61 20 sion tuned to a 0x01F0: 64 65 61 64 20 63 68 61 6e 6e 65 6c 2e 0d 0d 41 dead channel...A ... 0x0840: 3f 00 0d 0d 52 61 74 7a 20 72 65 66 75 73 65 73 ?...Ratz refuses 0x0850: 20 74 6f 20 74 61 6b 65 20 79 6f 75 72 20 63 72 to take your cr 0x0860: 65 64 69 74 73 2e 00 edits..</code> </pre> <br><p>  <em>[Yes, this is exactly what you thought.]</em> Other files with the names <code>R%n.BIH</code> have a similar structure: a certain number of bytes above, followed by a text canvas.  Obviously, I deal with in-game strings divided by locations to which they belong <em>[ <code>R1</code> is the first, <code>R2</code> is the second, and so on.</em>  <em>The starting location, for example, loads the backdrop from <code>R1.PIC</code> , and the first text that we will see there is this: <code>You've just spent the night sleeping face-down in a plate of synth-spaghetti in a bar called the Chatsubo</code></em> .  The bytes from the upper part organize some kind of control structure, but apart from the code, it will not be possible to disassemble it, I will try to look into other <code>.BIH</code> files: </p><br><pre> <code class="markdown hljs">CORNERS.BIH_decompd: 128  0x0000: ff ff f0 00 ff f0 0f ff ff 0f ff ff f0 ff ff ff ... 0x0010: f0 ff ff ff 0f ff ff ff 0f ff ff ff 0f ff ff ff ... 0x0020: 00 00 ff ff 0f ff 00 ff 0f ff ff 0f 0f ff ff f0 ....... 0x0030: 0f ff ff f0 0f ff ff ff 0f ff ff ff 0f ff ff ff .... 0x0040: 0f ff ff ff 0f ff ff ff 0f ff ff ff f0 ff ff ff ... 0x0050: f0 ff ff ff ff 0f ff ff ff f0 0f ff ff ff f0 00 ... 0x0060: ff ff ff f0 ff ff ff f0 ff ff ff f0 ff ff ff 0f . 0x0070: ff ff ff 0f ff ff f0 ff ff f0 0f ff 00 0f ff ff ....</code> </pre> <br><pre> <code class="markdown hljs">ROOMPOS.BIH_decompd: 1160  0x0000: 68 8f 75 0d 4b 69 00 02 8e 63 02 17 71 74 29 02 h–èu.Ki..–ãc..qt). 0x0010: 0e 63 02 17 68 8f 75 15 72 69 24 02 8e 63 02 17 .c..h–èu.ri$.–ãc.. 0x0020: 15 74 7a 02 16 63 02 17 68 8f 75 0d 2a 69 00 02 .tz..c..h–èu.*i.. 0x0030: 8e 63 02 17 08 74 8c 02 0e 63 02 17 70 63 75 0d –ãc...t–ä..c..pcu. ... 0x0470: 0e 6b 02 0f 6e 8f 75 0d 08 6f 8c 02 8e 69 02 11 .k..n–èu..o–ä.–ãi.. 0x0480: 08 74 8c 02 0e 69 02 11 .t–ä..i..</code> </pre> <br><p>  What I see here is not at all like the pattern that I observed in <code>R%n.BIH</code> .  They don't even look like each other!  The contents of <code>CORNERS.BIH</code> reminiscent of bitmap, and <code>ROOMPOS.BIH</code> , judging by the name, may be related to the positioning of objects on a location, but its contents are not clear. <br>  In addition to these, there is still: <code>COPEN%n.BIH</code> , <code>DB%nBIH</code> , <code>FIJU0.BIH</code> , <code>HITACHI0.BIH</code> and many others, but they are similar to <code>R%n.BIH</code> even though they contain readable text, but the headings places differ.  I'll leave it for later and see what's there with <code>.ANH</code> . </p><br><p>  Here the situation is better.  All <code>.ANH</code> titled as <code>R%n.ANH</code> , which means that they somehow belong to locations.  There are not many of them: if for all <code>n</code> <code>R%n.PIC</code> and <code>R%n.BIH</code> , then the corresponding <code>R%n.ANH</code> is found only for some <code>n</code> .  They are compressed by the same algorithm, let's see what's inside: </p><br><pre> <code class="markdown hljs">R1.ANH_decomp: 1100  0x0000 04 00 4e 01 0f 00 17 00 00 00 0c 00 00 00 02 00 ..N............. 0x0010 0e 00 03 00 0e 00 01 00 0e 00 02 00 0e 00 02 00 ................ 0x0020 0e 00 03 00 0e 00 01 00 0e 00 02 00 0e 00 0e 00 ................ 0x0030 00 00 15 00 19 00 03 00 72 00 11 00 72 00 03 00 ........r...r... 0x0040 ba 00 23 25 03 17 fd 87 00 87 3e 00 ff 44 01 00 —î.#%.....&gt;.D.. ... 0x0160 73 00 04 00 73 00 03 00 73 00 14 00 73 00 04 00 s...s...s...s... 0x0170 00 00 03 00 00 00 03 00 73 00 04 00 73 00 04 00 ........s...s... 0x0180 00 00 03 00 00 00 03 00 73 00 04 00 73 00 0e 00 ........s...s... 0x0190 00 00 17 00 00 00 03 00 73 00 04 00 73 00 04 00 ........s...s... 0x01A0 00 00 03 00 00 00 03 00 73 00 04 00 73 00 1b 30 ........s...s..0 0x01B0 0b 10 01 00 ff 03 09 00 ff 30 08 00 fc 13 30 08 .......0...0. ... 0x0430 30 02 05 fe 08 88 02 08 fb 88 08 00 08 00 71 36 0...‚Ç¨..‚Ç¨....q6 0x0440 02 05 fe 00 80 02 08 ff 88 03 08 00 ...–Ç..‚Ç¨...</code> </pre> <br><p>  Alas, there is little useful, well, okay, I will understand along the way.  While you can do other things.  <em>[Once, when launching the starting location in the game, I noticed that the backdrop of this location was animated.</em>  <em>And this is interesting, considering that static images are in <code>.PIC</code> .</em>  <em>Not yet verified, but I think it is in <code>.ANH</code> that these animations are contained.]</em> </p><br><hr><br><p>  I spent some time writing a simple window utility - a resource viewer.  In the process, I had to move from 2017 studio to 2015 due to the fact that the first one broke MFC.  In the same solution, I created the <code>LibNeuroRoutines</code> library <code>LibNeuroRoutines</code> , into which I will gradually add reversed procedures from the original game.  First of all, the functions of decompression and decoding of resources got there.  It is convenient to keep these things apart. </p><br><p><img src="https://habrastorage.org/webt/1f/gg/6l/1fgg6lnqoxjnqyw1amucjj4atns.png" width="96%" height="96%"><br></p><br><hr><br><p>  After reading a <a href="http://wiki.scummvm.org/index.php/HOWTO-Reverse_Engineering">note on reverse engineering</a> on the <em>ScummVM</em> project wiki, I decided to reverse the local text rendering.  <em>[At first, I was hoping to just extract the fonts, but in the end, it allowed me to achieve much more.]</em> It was easy to take the first steps in this direction - studying the <code>main</code> function in the disassembled listing, I discovered a function that takes the address of the string displayed in the main game menu - " <code>New/Load</code> ": </p><br><pre> <code class="hljs perl"> ... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">sub</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ax</span></span></span><span class="hljs-function">, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ax</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">push</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ax</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mov</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ax</span></span></span><span class="hljs-function">, 1 </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">push</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ax</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mov</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ax</span></span></span><span class="hljs-function">, 5098</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">h</span></span></span><span class="hljs-function"> </span></span>; <span class="hljs-string"><span class="hljs-string">"New/Load"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">push</span></span> ax call sub_13C6E ; sub_13C6E(<span class="hljs-string"><span class="hljs-string">"New/Load"</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>) ...</code> </pre> <br><p>  Having <code>sub_13C6E</code> function under the debugger, I make sure that it is this one that displays the transferred string: </p><br><p><img src="https://habrastorage.org/webt/16/xx/vh/16xxvhrp46ffe0oqpb8q63hj_9s.png" width="96%" height="96%"><br></p><br><p>  And then you could start to trace it, but there is a nuance, it does not accept anything like coordinates.  The text is drawn exactly in the center of the frame.  Maybe it also draws in this function?  But what have the arguments 1 and 0?  Then I noticed a call to another function, immediately above <code>sub_13C6E</code> : </p><br><pre> <code class="hljs perl"> ... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">sub</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ax</span></span></span><span class="hljs-function">, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ax</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">push</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ax</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">push</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ax</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mov</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ax</span></span></span><span class="hljs-function">, 1 </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">push</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ax</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mov</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ax</span></span></span><span class="hljs-function">, 0</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Ah</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">push</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ax</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mov</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ax</span></span></span><span class="hljs-function">, 14</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">h</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">push</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ax</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mov</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ax</span></span></span><span class="hljs-function">, 5 </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">push</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ax</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mov</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ax</span></span></span><span class="hljs-function">, 6 </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">push</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ax</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">call</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sub_13A9E</span></span></span><span class="hljs-function"> </span></span>; sub_13A9E(<span class="hljs-number"><span class="hljs-number">6</span></span>, <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-number"><span class="hljs-number">20</span></span>, <span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>) add sp, 0Eh <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">sub</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ax</span></span></span><span class="hljs-function">, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ax</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">push</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ax</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mov</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ax</span></span></span><span class="hljs-function">, 1 </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">push</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ax</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mov</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ax</span></span></span><span class="hljs-function">, 5098</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">h</span></span></span><span class="hljs-function"> </span></span>; <span class="hljs-string"><span class="hljs-string">"New/Load"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">push</span></span> ax call draw_string ; draw_string(<span class="hljs-string"><span class="hljs-string">"New/Load"</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>) ...</code> </pre> <br><p>  By tracing this code, I saw that the <code>sub_13A9E</code> function <code>sub_13A9E</code> frame, and the <code>draw_string</code> function - the text in it.  It is likely that these calls are connected through some global variables.  In any case, it's better to start with <code>sub_13A9E</code> , especially since it takes an interesting set of arguments. </p><br><img src="https://habrastorage.org/webt/69/fk/mj/69fkmjk6l3qogcj4pb8pqv6fdn4.png" align="left"><br><p>  We need to make measurements and see if the measurements somehow correlate with the values ‚Äã‚Äãof these arguments.  There is no obvious dependence between the numbers here, so, we will trace <code>sub_13A9E</code> . <br><br clear="left"></p><br><p>  This is what happens there: first, a certain structure is filled in the data segment (in the comments I indicated the sequence of execution and specific operations that calculate the recorded value): </p><br><pre> <code class="hljs django"><span class="xml"><span class="xml">; sub_13A9E(6, 5, 20, 10, 1, 0, 0) ; (a, b, c, d, e, f, g) .dseg ... word[0x65FA]: 0x20 ; 10: word[0x6602] - 8 = 32 word[0x65FC]: 0x98 ; 11: word[0x6604] - 8 = 152 word[0x65FE]: 0x7F ; 12: word[0x6606] + 8 = 127 word[0x6600]: 0xAF ; 13: word[0x6608] + 8 = 175 word[0x6602]: 0x28 ; 2: b </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;&lt; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">3</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">40</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">word</span></span></span></span><span class="xml"><span class="hljs-tag">[</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0x6604</span></span></span></span><span class="xml"><span class="hljs-tag">]</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">:</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0xA0</span></span></span></span><span class="xml"><span class="hljs-tag"> ; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">3:</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">c</span></span></span></span><span class="xml"><span class="hljs-tag"> &lt;&lt; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">3</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">160</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">word</span></span></span></span><span class="xml"><span class="hljs-tag">[</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0x6606</span></span></span></span><span class="xml"><span class="hljs-tag">]</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">:</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0x77</span></span></span></span><span class="xml"><span class="hljs-tag"> ; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">4:</span></span></span></span><span class="xml"><span class="hljs-tag"> (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">d</span></span></span></span><span class="xml"><span class="hljs-tag"> &lt;&lt; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">3</span></span></span></span><span class="xml"><span class="hljs-tag">) + </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">word</span></span></span></span><span class="xml"><span class="hljs-tag">[</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0x6602</span></span></span></span><span class="xml"><span class="hljs-tag">] </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">-</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">1</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">119</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">word</span></span></span></span><span class="xml"><span class="hljs-tag">[</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0x6608</span></span></span></span><span class="xml"><span class="hljs-tag">]</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">:</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0xA7</span></span></span></span><span class="xml"><span class="hljs-tag"> ; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">5:</span></span></span></span><span class="xml"><span class="hljs-tag"> (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">e</span></span></span></span><span class="xml"><span class="hljs-tag"> &lt;&lt; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">3</span></span></span></span><span class="xml"><span class="hljs-tag">) + </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">word</span></span></span></span><span class="xml"><span class="hljs-tag">[</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0x6604</span></span></span></span><span class="xml"><span class="hljs-tag">] </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">-</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">1</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">167</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">word</span></span></span></span><span class="xml"><span class="hljs-tag">[</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0x660A</span></span></span></span><span class="xml"><span class="hljs-tag">]</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">:</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0x28</span></span></span></span><span class="xml"><span class="hljs-tag"> ; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">6:</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">word</span></span></span></span><span class="xml"><span class="hljs-tag">[</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0x6602</span></span></span></span><span class="xml"><span class="hljs-tag">] = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">40</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">word</span></span></span></span><span class="xml"><span class="hljs-tag">[</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0x660C</span></span></span></span><span class="xml"><span class="hljs-tag">]</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">:</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0xA0</span></span></span></span><span class="xml"><span class="hljs-tag"> ; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">7:</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">word</span></span></span></span><span class="xml"><span class="hljs-tag">[</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0x6604</span></span></span></span><span class="xml"><span class="hljs-tag">] = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">160</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">word</span></span></span></span><span class="xml"><span class="hljs-tag">[</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0x660E</span></span></span></span><span class="xml"><span class="hljs-tag">]</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">:</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0x77</span></span></span></span><span class="xml"><span class="hljs-tag"> ; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">8:</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">word</span></span></span></span><span class="xml"><span class="hljs-tag">[</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0x6606</span></span></span></span><span class="xml"><span class="hljs-tag">] = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">119</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">word</span></span></span></span><span class="xml"><span class="hljs-tag">[</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0x6610</span></span></span></span><span class="xml"><span class="hljs-tag">]</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">:</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0xA7</span></span></span></span><span class="xml"><span class="hljs-tag"> ; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">9:</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">word</span></span></span></span><span class="xml"><span class="hljs-tag">[</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0x6608</span></span></span></span><span class="xml"><span class="hljs-tag">] = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">167</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">word</span></span></span></span><span class="xml"><span class="hljs-tag">[</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0x6612</span></span></span></span><span class="xml"><span class="hljs-tag">]</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">:</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0x06</span></span></span></span><span class="xml"><span class="hljs-tag"> ; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">1:</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">a</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">6</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">word</span></span></span></span><span class="xml"><span class="hljs-tag">[</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0x6614</span></span></span></span><span class="xml"><span class="hljs-tag">]</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">:</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0x00</span></span></span></span><span class="xml"><span class="hljs-tag"> ; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">14:</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">...</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">word</span></span></span></span><span class="xml"><span class="hljs-tag">[</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0x66D6</span></span></span></span><span class="xml"><span class="hljs-tag">]</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">:</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0x30</span></span></span></span><span class="xml"><span class="hljs-tag"> ; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">17:</span></span></span></span><span class="xml"><span class="hljs-tag"> (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">d</span></span></span></span><span class="xml"><span class="hljs-tag"> &lt;&lt; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">2</span></span></span></span><span class="xml"><span class="hljs-tag">) + </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">8</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">48</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">word</span></span></span></span><span class="xml"><span class="hljs-tag">[</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0x66D8</span></span></span></span><span class="xml"><span class="hljs-tag">]</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">:</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0x02</span></span></span></span><span class="xml"><span class="hljs-tag"> ; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">15:</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">2</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">word</span></span></span></span><span class="xml"><span class="hljs-tag">[</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0x66DA</span></span></span></span><span class="xml"><span class="hljs-tag">]</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">:</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0x22FB</span></span></span></span><span class="xml"><span class="hljs-tag"> ; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">16:</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">seg11</span></span></span></span></span></span></code> </pre> <br><p>  It is impossible not to notice that the coordinates of the left (32) top (152) corner of the frame, respectively, are located in the Word addresses <code>0x65FA</code> and <code>0x65FC</code> .  If we go further and subtract these values ‚Äã‚Äãfrom those recorded in <code>0x65FE</code> and <code>0x6600</code> , we get 95 and 23. Adding one at a time, the width (96) and height (24) of the frame will be exactly.  Very entertaining.  Now, if you name the arguments of the function <code>draw_frame</code> ( <code>sub_13A9E</code> ) from <code>a</code> to <code>e</code> <em>[the last two arguments are not used by the function, they are probably just added by the compiler]</em> , then you can display the following expressions: </p><br><pre> <code class="markdown hljs">left = b <span class="hljs-bullet"><span class="hljs-bullet">* 8 - 8 = (b - 1) *</span></span> 8 top = c <span class="hljs-bullet"><span class="hljs-bullet">* 8 - 8 = (c - 1) *</span></span> 8 width = (d <span class="hljs-bullet"><span class="hljs-bullet">* 8) + (b *</span></span> 8) + 8 - ((b <span class="hljs-bullet"><span class="hljs-bullet">* 8) - 8) = (d *</span></span> 8) + 16 = (d + 2) <span class="hljs-bullet"><span class="hljs-bullet">* 8 height = (e *</span></span> 8) + (c <span class="hljs-bullet"><span class="hljs-bullet">* 8) + 8 - ((c *</span></span> 8) - 8) = (e <span class="hljs-bullet"><span class="hljs-bullet">* 8) + 16 = (e + 2) *</span></span> 8</code> </pre> <br><p>  After filling in the considered structure, the address <code>[0x66DA]:[0x66D8]</code> ( <em>22FB: 0002 - segment: offset</em> ) builds a bitmap image of the frame of the calculated sizes, which is then transferred line by line to VGA memory, starting from the address (in the VGA buffer), the corresponding calculated coordinate of the upper left corner ( <code>152 * 320 + 32 = 0xBE20, A000:BE20</code> ): </p><br><div class="spoiler">  <b class="spoiler_title">looks like a frame in memory</b> <div class="spoiler_text"><pre> <code class="markdown hljs"> SEG11: 22FB:0002 0000 0000 3000 1800 22FB:000A 000000000000000000000000...000000000000000000000000 22FB:003A 0FFFFFFFFFFFFFFFFFFFFFFF...FFFFFFFFFFFFFFFFFFFFFFF0 22FB:006A 0FFFFFFFFFFFFFFFFFFFFFFF...FFFFFFFFFFFFFFFFFFFFFFF0 22FB:009A 0FFFFFFFFFFFFFFFFFFFFFFF...FFFFFFFFFFFFFFFFFFFFFFF0 22FB:00CA 0FFFFFFFFFFFFFFFFFFFFFFF...FFFFFFFFFFFFFFFFFFFFFFF0 22FB:00FA 0FFFFFFFFFFFFFFFFFFFFFFF...FFFFFFFFFFFFFFFFFFFFFFF0 22FB:012A 0FFFFFFFFFFFFFFFFFFFFFFF...FFFFFFFFFFFFFFFFFFFFFFF0 22FB:015A 0FFFFFFFFFFFFFFFFFFFFFFF...FFFFFFFFFFFFFFFFFFFFFFF0 22FB:018A 0FFFFFFFFFFFFFFFFFFFFFFF...FFFFFFFFFFFFFFFFFFFFFFF0 22FB:01BA 0FFFFFFFFFFFFFFFFFFFFFFF...FFFFFFFFFFFFFFFFFFFFFFF0 22FB:01EA 0FFFFFFFFFFFFFFFFFFFFFFF...FFFFFFFFFFFFFFFFFFFFFFF0 22FB:021A 0FFFFFFFFFFFFFFFFFFFFFFF...FFFFFFFFFFFFFFFFFFFFFFF0 22FB:024A 0FFFFFFFFFFFFFFFFFFFFFFF...FFFFFFFFFFFFFFFFFFFFFFF0 22FB:027A 0FFFFFFFFFFFFFFFFFFFFFFF...FFFFFFFFFFFFFFFFFFFFFFF0 22FB:02AA 0FFFFFFFFFFFFFFFFFFFFFFF...FFFFFFFFFFFFFFFFFFFFFFF0 22FB:02DA 0FFFFFFFFFFFFFFFFFFFFFFF...FFFFFFFFFFFFFFFFFFFFFFF0 22FB:030A 0FFFFFFFFFFFFFFFFFFFFFFF...FFFFFFFFFFFFFFFFFFFFFFF0 22FB:033A 0FFFFFFFFFFFFFFFFFFFFFFF...FFFFFFFFFFFFFFFFFFFFFFF0 22FB:036A 0FFFFFFFFFFFFFFFFFFFFFFF...FFFFFFFFFFFFFFFFFFFFFFF0 22FB:039A 0FFFFFFFFFFFFFFFFFFFFFFF...FFFFFFFFFFFFFFFFFFFFFFF0 22FB:03CA 0FFFFFFFFFFFFFFFFFFFFFFF...FFFFFFFFFFFFFFFFFFFFFFF0 22FB:03FA 0FFFFFFFFFFFFFFFFFFFFFFF...FFFFFFFFFFFFFFFFFFFFFFF0 22FB:042A 0FFFFFFFFFFFFFFFFFFFFFFF...FFFFFFFFFFFFFFFFFFFFFFF0 22FB:045A 000000000000000000000000...000000000000000000000000</code> </pre> <br><pre> <code class="markdown hljs"> VGA: A000:BE20 000000000000000000000000...000000000000000000000000... + 0x140 (320) A000:BF60 000F0F0F0F0F0F0F0F0F0F0F...0F0F0F0F0F0F0F0F0F0F0F00... + 0x140 (320) A000:C0A0 000F0F0F0F0F0F0F0F0F0F0F...0F0F0F0F0F0F0F0F0F0F0F00... + 0x1000 (320 * 21) A000:DAE0 000000000000000000000000...000000000000000000000000</code> </pre> </div></div><br><p>  You can move on to the <code>draw_string</code> function. </p><br><hr><br><p>  <code>draw_string</code> into the <code>draw_string</code> , hooked on the following piece of code: </p><br><pre> <code class="hljs lua">loc_1DB47: mov bx, dx inc dx <span class="hljs-built_in"><span class="hljs-built_in">sub</span></span> ax, ax mov al, ss:[bx] shl ax, <span class="hljs-number"><span class="hljs-number">1</span></span> jz short loc_1DB97 shl ax, <span class="hljs-number"><span class="hljs-number">1</span></span> shl ax, <span class="hljs-number"><span class="hljs-number">1</span></span> add ax, <span class="hljs-number"><span class="hljs-number">0</span></span>FA6Eh mov si, ax mov cx, <span class="hljs-number"><span class="hljs-number">8</span></span> mov bx, <span class="hljs-number"><span class="hljs-number">4</span></span>BA1h loc_1DB62: lodsb mov ah, al <span class="hljs-built_in"><span class="hljs-built_in">sub</span></span> al, al rol ax, <span class="hljs-number"><span class="hljs-number">1</span></span> rol ax, <span class="hljs-number"><span class="hljs-number">1</span></span> xlat <span class="hljs-built_in"><span class="hljs-built_in">byte</span></span> ptr ss:[bx] stosb <span class="hljs-built_in"><span class="hljs-built_in">sub</span></span> al, al rol ax, <span class="hljs-number"><span class="hljs-number">1</span></span> rol ax, <span class="hljs-number"><span class="hljs-number">1</span></span> xlat <span class="hljs-built_in"><span class="hljs-built_in">byte</span></span> ptr ss:[bx] stosb <span class="hljs-built_in"><span class="hljs-built_in">sub</span></span> al, al rol ax, <span class="hljs-number"><span class="hljs-number">1</span></span> rol ax, <span class="hljs-number"><span class="hljs-number">1</span></span> xlat <span class="hljs-built_in"><span class="hljs-built_in">byte</span></span> ptr ss:[bx] stosb <span class="hljs-built_in"><span class="hljs-built_in">sub</span></span> al, al rol ax, <span class="hljs-number"><span class="hljs-number">1</span></span> rol ax, <span class="hljs-number"><span class="hljs-number">1</span></span> xlat <span class="hljs-built_in"><span class="hljs-built_in">byte</span></span> ptr ss:[bx] stosb add di, ss:<span class="hljs-number"><span class="hljs-number">4</span></span>BA5h loop loc_1DB62 <span class="hljs-built_in"><span class="hljs-built_in">sub</span></span> di, ss:<span class="hljs-number"><span class="hljs-number">4</span></span>BA7h jmp short loc_1DB47 loc_1DB97: ...</code> </pre> <br><p>  It was ‚Äúhooked‚Äù, because of the large accumulation of instructions <code>lodsb</code> , <code>stosb</code> , <code>xlat</code> , <em>[for myself I concluded that these instructions do most of the useful work, in the end, all this programming comes down to the trivial movement of data from one area memory in another, is not it?]</em> and began to trace it.  Coming from the <code>loc_1DB47</code> tag: </p><br><ul><li>  in the <code>dx</code> register is the address of the source string " <code>New/Load</code> ", save it in <code>bx</code> and increment it; </li><li>  adjust <code>ax</code> ( <code>sub ax, ax</code> ); </li><li>  put in <code>al</code> code of the symbol of the source string pointed to by <code>bx</code> ( <code>mov al, ss:[bx]</code> , <code>al = 0x4E ('N')</code> ); </li><li>  shift the character code one bit to the left and, if the result is zero, jump to <code>loc_1DB97</code> (check for null-terminator); </li><li>  move <code>ax</code> two more bits to the left and add <code>0xFA6E</code> (together with the previous shift it is equivalent: <code>ax = ax * 8 + 0xFA6E</code> , <code>ax = 0xFCDE</code> ); </li><li>  save <code>ax</code> to <code>si</code> (and therefore <code>ax</code> - the address); </li><li>  we save in <code>cx</code> - 8, and in <code>bx</code> - <code>0x4BA1</code> (probably, also the address). </li></ul><br><p>  Considering the further <code>loop loc_1DB62</code> instruction <code>loop loc_1DB62</code> , a cycle of 8 ( <code>cx</code> ) iterations was prepared here, I deal with it: </p><br><ul><li>  the <code>lodsb</code> instruction in <code>al</code> loads the byte value at <code>ds:si</code> , <code>si</code> then incremented.  In my case, <code>ds:si = F000:FCDE</code> , the value <code>0xC6</code> loaded into <code>al</code> , <code>si</code> becomes equal to <code>0xFCDF</code> ; </li><li>  low byte <code>ax</code> written to high ( <code>mov ah, al</code> , <code>ax = 0xC6C6</code> ); </li><li>  <code>al</code> vanishes, <code>ax</code> shifts two bits to the left ( <code>ax = 0x1803</code> ); </li><li>  The <code>xlat</code> instruction uses <code>al</code> as an index in the byte array at <code>ds:bx</code> and stores the value written there in <code>al</code> , and the <code>ds</code> segment can be redefined.  This is where the array is addressed to <code>ss:bx</code> ( <code>47EA:4BA1 = {0xFF, 0xF0, 0x0F, 0x00}</code> ), and as a result of the instruction: <code>al = ss:bx[al] = 0x00</code> ; </li><li>  <code>stosb</code> value from <code>al</code> written to <code>es:di</code> , <code>di</code> then incremented.  I have <code>es:di = 22FB:0192</code> , and this is important, because it is there that the bitmap frame is located in which the text will be displayed.  After executing the instruction at address <code>22FB:0192</code> , the value <code>0x00</code> ( <code>al</code> ) will be written, and <code>di</code> will become equal to <code>0x0193</code> . </li></ul><br><p>  The last three steps are repeated three times, then the <code>ss:4BA5</code> saved to <code>ss:4BA5</code> ( <code>0x2C</code> ) is added to <code>di</code> , and the <code>loop</code> instruction <code>loc_1DB62</code> code from the <code>loc_1DB62</code> label to itself again 7 times.  After completing the cycle, the <code>ss:4BA7</code> added to <code>di</code> , stored at <code>ss:4BA7</code> ( <code>0x17C</code> ), and the program jumps back to the <code>loc_1DB47</code> label. </p><br><p>  So in this convoluted way, all characters of the source string are processed in turn here.  As a result, in the frame the specified text is formed <em>[highlight zeros, or reduce the page]</em> : </p><br><pre> <code class="markdown hljs">FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF FFF00FFF00FFFFFFFFFFFFFFFFFFFFFF00F0000FFFFFFFFFFFFFFFFFFFFFFF000FFF FFF000FF00FFFFFFFFFFFFFFFFFFFFF00FFF00FFFFFFFFFFFFFFFFFFFFFFFFF00FFF FFF0000F00FF0000FFF00FFF00FFFF00FFFF00FFFFFF0000FFFF0000FFFFFFF00FFF FFF00F0000F00FF00FF00F0F00FFF00FFFFF00FFFFF00FF00FFFFFF00FFF00000FFF FFF00FF000F000000FF0000000FF00FFFFFF00FFF0F00FF00FFF00000FF00FF00FFF FFF00FFF00F00FFFFFF0000000F00FFFFFFF00FF00F00FF00FF00FF00FF00FF00FFF FFF00FFF00FF0000FFFF00F00FF0FFFFFFF0000000FF0000FFFF000F00FF000F00FF FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF</code> </pre> <br><p>  Here, in principle, everything is clear, except for the magic number <code>0xFA6E</code> , adding to which the symbol code multiplied by eight, we got the address in the <code>F000</code> segment.  This is clearly outside the memory of the program itself, which means you need to google the <em>MS-DOS</em> memory scheme.  And <a href="http://staff.ustc.edu.cn/~xyfeng/research/cos/resources/BIOS/Resources/assembly/biosdataarea.html">googled</a> , specifically, it‚Äôs what interests you there: <code>FFA6:E ROM graphics character table</code> .  Considering the segment addressing, the <code>FFA6:E</code> record is equivalent to <code>F000:FA6E</code> , and at this address the font is sewn to display characters in the native DOS coding of <a href="https://ru.wikipedia.org/wiki/CP437"><em>CP437</em></a> .  For each character there is allocated 8 bytes.  Here is how it works on the example of the letter 'N': </p><br><pre> <code class="markdown hljs"><span class="hljs-bullet"><span class="hljs-bullet">1. </span></span>  : 0x4E 2.   : 0x4E * 8 = 0x270 3.       : 0xFA6E + 0x270 = 0xFCDE 4.      : C6 E6 F6 DE CE C6 C6 00 5.     ,   : C6: 11000110 E6: 11100110 F6: 11110110 DE: 11011110 (    'N') CE: 11001110 C6: 11000110 C6: 11000110 00: 00000000</code> </pre> <br><p>  And this code: </p><br><pre> <code class="hljs lua"> <span class="hljs-built_in"><span class="hljs-built_in">sub</span></span> al, al rol ax, <span class="hljs-number"><span class="hljs-number">1</span></span> rol ax, <span class="hljs-number"><span class="hljs-number">1</span></span> xlat <span class="hljs-built_in"><span class="hljs-built_in">byte</span></span> ptr ss:[bx]</code> </pre> <br><p>  can be illustrated as follows: </p><br><img src="https://habrastorage.org/webt/iw/y9/ji/iwy9jipppmwfzbaofogg4fjaw9g.png"><br><p>  Everything is sufficient just to implement this logic on its own and display the font on the screen.  <em>[What I did, leaving the positioning of the text for later.]</em> </p><br><hr><br><p>  Under this case, in one solution with <em>ResourceBrowser</em> and <em>LibNeuroRoutines</em> , created the project <em>NeuromancerWin32</em> .  I decided to use <a href="https://www.sfml-dev.org/"><em>SFML</em></a> as a multimedia <a href="https://www.sfml-dev.org/"><em>backend</em></a> .  Before that, I already had a very positive experience with <em>SDL2</em> , but here I wanted to try something new.  I liked <em>SDL2</em> , including the fact that it is implemented in <em>C</em> and, accordingly, out of the box has a <em>C-</em> compatible interface.  <em>SFML</em> , in turn, is written in <em>C ++</em> .  In order not to complicate my project, I will be leading to <em>C</em> , and, fortunately, <em>SFML</em> has an official <em>C-</em> binding, <em>CSFML</em> . </p><br><p>  Already from the start, <em>CSFML was</em> pleased with its ease of use.  Here, for example, everything you need to create a window: </p><br><pre> <code class="hljs mel">sfEvent <span class="hljs-keyword"><span class="hljs-keyword">event</span></span>; sfVideoMode mode = { <span class="hljs-number"><span class="hljs-number">320</span></span>, <span class="hljs-number"><span class="hljs-number">200</span></span>, <span class="hljs-number"><span class="hljs-number">32</span></span> }; sfRenderWindow *<span class="hljs-keyword"><span class="hljs-keyword">window</span></span> = sfRenderWindow_create(mode, <span class="hljs-string"><span class="hljs-string">"NeuromancerWin32"</span></span>, sfClose, NULL); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (sfRenderWindow_isOpen(<span class="hljs-keyword"><span class="hljs-keyword">window</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (sfRenderWindow_pollEvent(<span class="hljs-keyword"><span class="hljs-keyword">window</span></span>, &amp;<span class="hljs-keyword"><span class="hljs-keyword">event</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">event</span></span>.type == sfEvtClosed) { sfRenderWindow_close(<span class="hljs-keyword"><span class="hljs-keyword">window</span></span>); } } sfRenderWindow_clear(<span class="hljs-keyword"><span class="hljs-keyword">window</span></span>, sfBlack); sfRenderWindow_display(<span class="hljs-keyword"><span class="hljs-keyword">window</span></span>) } sfRenderWindow_destroy(<span class="hljs-keyword"><span class="hljs-keyword">window</span></span>);</code> </pre> <br><p>  The original game for displaying graphics on the screen uses 256-color <em>VGA</em> <em>mode</em> ( <em>mode 0x13</em> ).  In this mode, drawing is reduced to recording pixel color values ‚Äã‚Äãin <em>VGA</em> memory ( <code>A000:0000</code> , <code>320 * 200</code> bytes).  One byte, in this case, corresponds to one pixel.  I decided to act in a similar way, but with the amendment that the 32-bit video mode will be used.  Thus, I got myself a buffer <code>uint8_t *g_vga[320*200*4]</code> (each pixel in 32-bit mode is represented by 4 components - <em>RGBA</em> ), which will serve me as an analogue of the original <em>VGA</em> memory.  In this buffer, I'll draw, and then, using <em>SFML</em> , display the contents on the screen: </p><br><pre> <code class="cpp hljs">sfRenderWindow *g_ window = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; sfTexture *g_texture = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> *g_vga[<span class="hljs-number"><span class="hljs-number">320</span></span>*<span class="hljs-number"><span class="hljs-number">200</span></span>*<span class="hljs-number"><span class="hljs-number">4</span></span>]; ... g_texture = sfTexture_create(<span class="hljs-number"><span class="hljs-number">320</span></span>, <span class="hljs-number"><span class="hljs-number">200</span></span>); ... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">render</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ sfTexture_updateFromPixels(g_texture, g_vga, <span class="hljs-number"><span class="hljs-number">320</span></span>, <span class="hljs-number"><span class="hljs-number">200</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); sfSprite *sprite = sfSprite_create(); sfSprite_setTexture(sprite, g_texture, <span class="hljs-number"><span class="hljs-number">1</span></span>); sfRenderWindow_clear(g_window, sfBlack); sfRenderWindow_drawSprite(g_window, sprite, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>); sfRenderWindow_display(g_window); sfSprite_destroy(sprite); } ... sfTexture_destroy(g_texture);</code> </pre> <br><p> : </p><br><img src="https://habrastorage.org/webt/rq/kq/mr/rqkqmrtkja902_e7d-8j5rbzgaw.png" align="left"><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">320</span></span> * <span class="hljs-number"><span class="hljs-number">240</span></span> * <span class="hljs-number"><span class="hljs-number">4</span></span>; i++) { g_vga[i] = rand() % <span class="hljs-number"><span class="hljs-number">256</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (sfRenderWindow_isOpen(g_window)) { ... render(); }</code> </pre> <br><p><br clear="left"></p><br><p> ,  .    ,          <em>VGA</em> -: <code>void draw_to_vga(int32_t l, int32_t t, uint32_t w, uint32_t h, uint8_t *pixels)</code> <em>[    VGA,   , ]</em> : </p><br><img src="https://habrastorage.org/webt/66/i-/zp/66i-zp0u1ali25fn142fmracrq4.png" align="right"><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> red_rectangle[<span class="hljs-number"><span class="hljs-number">96</span></span>*<span class="hljs-number"><span class="hljs-number">48</span></span>]; <span class="hljs-built_in"><span class="hljs-built_in">memset</span></span>(red_rectangle, <span class="hljs-number"><span class="hljs-number">0x44</span></span>, <span class="hljs-number"><span class="hljs-number">96</span></span>*<span class="hljs-number"><span class="hljs-number">48</span></span>); draw_to_vga(<span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-number"><span class="hljs-number">96</span></span>, <span class="hljs-number"><span class="hljs-number">48</span></span>, red_rectangle); ... render();</code> </pre> <br><p><br clear="right"></p><br><p>  ,   (8x8)   : </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> cp437_font[<span class="hljs-number"><span class="hljs-number">1024</span></span>] = { <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-comment"><span class="hljs-comment">// 0x00 NULL ... 0x30, 0x78, 0xCC, 0xCC, 0xFC, 0xCC, 0xCC, 0x00, // 0x41 A 0xFC, 0x66, 0x66, 0x7C, 0x66, 0x66, 0xFC, 0x00, // 0x42 B 0x3C, 0x66, 0xC0, 0xC0, 0xC0, 0x66, 0x3C, 0x00, // 0x43 C ... }; static uint8_t cp437_font_pixels[4] = { 0xFF, 0xF0, 0x0F, 0x00 }; static uint8_t cp437_font_mask[4] = { 0xC0, 0x30, 0x0C, 0x03 }; void build_character(char c, uint8_t *dst) { uint32_t index = c * 8; /* unprintable */ if (c &lt; 0x20 || c &gt; 0x7E) { return; } memset(dst, 0, 32); for (int i = 0; i &lt; 8; i++) { uint8_t al = cp437_font[index++]; for (int j = 0; j &lt; 4; j++) { dst[i * 4 + j] = cp437_font_pixels[(al &amp; cp437_font_mask[j]) &gt;&gt; (6 - j * 2)]; } } }</span></span></code> </pre> <br><p>     : </p><br><img src="https://habrastorage.org/webt/nn/aq/uq/nnaquq-zftqsdbzbbpgcwqkom8y.png" align="left"><br><pre> <code class="cpp hljs"><span class="hljs-built_in"><span class="hljs-built_in">memset</span></span>(g_vga, <span class="hljs-number"><span class="hljs-number">0xFF</span></span>, <span class="hljs-number"><span class="hljs-number">320</span></span> * <span class="hljs-number"><span class="hljs-number">200</span></span> * <span class="hljs-number"><span class="hljs-number">4</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> character_bm[<span class="hljs-number"><span class="hljs-number">32</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> left = <span class="hljs-number"><span class="hljs-number">2</span></span>, top = <span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">char</span></span> c = <span class="hljs-number"><span class="hljs-number">0x20</span></span>; c &lt;= <span class="hljs-number"><span class="hljs-number">0x7E</span></span>; c++) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (left + <span class="hljs-number"><span class="hljs-number">8</span></span> &gt;= <span class="hljs-number"><span class="hljs-number">320</span></span>) { left = <span class="hljs-number"><span class="hljs-number">2</span></span>; top += <span class="hljs-number"><span class="hljs-number">10</span></span>; } build_character(c, character_bm); draw_to_vga(left, top, <span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-number"><span class="hljs-number">8</span></span>, character_bm); left += <span class="hljs-number"><span class="hljs-number">8</span></span>; } render();</code> </pre> <br><p><br clear="left"></p><br><p>   <code>build_character</code>   <code>build_string(char *s, uint32_t w, uint32_t h, uint8_t *dst)</code> ,    : </p><br><img src="https://habrastorage.org/webt/-r/ag/at/-ragatniljinomkcooo0vinbw_m.png" align="right"><br><pre> <code class="cpp hljs"><span class="hljs-built_in"><span class="hljs-built_in">memset</span></span>(g_vga, <span class="hljs-number"><span class="hljs-number">0xFF</span></span>, <span class="hljs-number"><span class="hljs-number">320</span></span> * <span class="hljs-number"><span class="hljs-number">200</span></span> * <span class="hljs-number"><span class="hljs-number">4</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> <span class="hljs-built_in"><span class="hljs-built_in">string</span></span>[<span class="hljs-number"><span class="hljs-number">320</span></span> * <span class="hljs-number"><span class="hljs-number">20</span></span>]; build_string(<span class="hljs-string"><span class="hljs-string">"The future is here.\n"</span></span> <span class="hljs-string"><span class="hljs-string">"It's just not widely distributed yet."</span></span>, <span class="hljs-number"><span class="hljs-number">320</span></span>, <span class="hljs-number"><span class="hljs-number">20</span></span>, dst); draw_to_vga(<span class="hljs-number"><span class="hljs-number">20</span></span>, <span class="hljs-number"><span class="hljs-number">88</span></span>, <span class="hljs-number"><span class="hljs-number">320</span></span>, <span class="hljs-number"><span class="hljs-number">20</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">string</span></span>); render();</code> </pre> <br><p><br clear="right"></p><br><hr><br><p>     .   ,              -     .         ,    .                 . </p><br><blockquote> <a href="https://habr.com/post/415555/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Reverse "Neuromant". </font><font style="vertical-align: inherit;">Part 3: Finished Rendering, Making the Game</font></font></a> </blockquote></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/357972/">https://habr.com/ru/post/357972/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../357962/index.html">Restricted Access and CCTV at Raspberry PI</a></li>
<li><a href="../357964/index.html">Access Controller for Go + Raspberry Pi + Arduino Nano</a></li>
<li><a href="../357966/index.html">Orange Pi 2G-IOT or Orange Paradise</a></li>
<li><a href="../357968/index.html">Released updated Raspberry Pi 3 Model B +</a></li>
<li><a href="../357970/index.html">Second GIS-hackathon "Guessing on the Cards"</a></li>
<li><a href="../357974/index.html">Get free, quick, easy and simple system information from a variety of PCs on the network</a></li>
<li><a href="../357976/index.html">The basis of the gameplay in C ++ for the Unreal Engine</a></li>
<li><a href="../357978/index.html">Turn on teleport: moving hubs</a></li>
<li><a href="../357980/index.html">Roskomnadzor threatens 15 hosting providers. Whatsapp and viber can also block</a></li>
<li><a href="../357982/index.html">On the rezolv plot of domain names from the RosComNadzor registry, someone sends a ‚Äúmessage‚Äù in Morse code</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>