<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Using Roslyn to edit game content</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Chatter is worth nothing. Show me the code. 
 - Linus Torvalds 
 Hello! I work as a programmer in a small (but proud) gamedev-office. In the past few ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Using Roslyn to edit game content</h1><div class="post__text post__text-html js-mediator-article"><blockquote>  Chatter is worth nothing.  Show me the code. <br>  - Linus Torvalds </blockquote><br>  Hello!  I work as a programmer in a small (but proud) gamedev-office.  In the past few years, the company has been producing casual games for mobile phones in the match3 genre.  We write on C # (which is good news) and do not use Unity (well, almost).  It so happened that the main area of ‚Äã‚Äãmy responsibility is gameplay and UI.  And I'm also crazy about C # 's and its ecosystems.  Today I want to tell you how I managed to use the <a href="https://github.com/dotnet/roslyn">Roslyn</a> code analysis and modification tool to edit game content.  Who cares - I ask under the cat. <br><br>  <b>Note.</b>  Sections that understand the implementation method and provide code examples that are marked with <b>[technical section]</b> in the headers.  If you do not want to dive into the details at this level, just skip them.  This will not affect the general understanding of the idea. <br><a name="habracut"></a><br><h3>  Prehistory  One match3 will not be full </h3><br>  In many games of the match3 genre, there is a separate entity that represents the game world.  We call it a card.  The card‚Äôs functionality may be different: from very simple (an indicator of progress in the game) to a full-fledged action scene (with its own internal story, plot, characters, etc.). <br><br>  In one of the projects I'm working on, special attention is paid to the plot and map.  Enough requirements: a large amount of content, variety, excitement, well-directed cut-scenes, etc.  It should also be easy to edit and expand.  Until now, there was nothing like this in the game projects of our studio.  Both the plot system and the tools for it had to be developed almost from scratch. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h3>  Plot architecture [technical section] </h3><br>  We divide the whole story into separate gaps - quests.  A quest is a set of stages (states), each of which has its own logic.  Let's look at the Stub-quest code: <br><br><pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> StubQuestState { Initial, } <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Stub</span></span> : <span class="hljs-title"><span class="hljs-title">SectorComponent</span></span>&lt;<span class="hljs-title"><span class="hljs-title">StubQuestState</span></span>&gt; {} <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">StubQuest</span></span> : <span class="hljs-title"><span class="hljs-title">SectorBehaviour</span></span>&lt;<span class="hljs-title"><span class="hljs-title">Stub</span></span>, <span class="hljs-title"><span class="hljs-title">StubQuestState</span></span>&gt; { [State(StubQuestState.Initial)] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> IEnumerator&lt;</span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">object</span></span></span><span class="hljs-function">&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">InitialState</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } }</code> </pre> <br>  So we see: <br><br><ul><li>  enum StubQuestState - quest status; </li><li>  class Stub - quest component, stores state and optional data; </li><li>  class StubQuest - logic of the quest.  Each state of the quest must correspond to a method that returns an iterator (the method is linked through the State attribute and determines the actions that are performed directly in this state). </li></ul><br>  Also, each quest has an activation condition - when it should be launched (in the code it is represented as Func and is called ReachedCondition). <br><br><div class="spoiler">  <b class="spoiler_title">About the name</b> <div class="spoiler_text">  It must be admitted that the name was not chosen very well - it is not the canonical sequence ‚Äútalked to the NPC‚Äù - ‚Äúfilled 10 frags‚Äù - ‚Äúpassed, got a nishtyak‚Äù.  Quest implemented quite a lot of different things: the opening of the functionality while moving through the plot, the issuance of awards inherent in each game location, etc.  It would be more correct to call it ‚ÄúBehaviour‚Äù (like Unity), but it was decided to leave the usual name. <br></div></div><br>  Quests are divided by locations, in our terminology by sectors (static classes with names like SectorN).  Each sector has the Initialize method, initializing the map (here I mean graphics, animations directly), tutorials (some of them are not implemented through quests and are separate entities) and the quests themselves.  Here is an example of the initialization code: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> fixSubmarineQuest = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FixSubmarineQuest { ReachedCondition = () =&gt; plot.Levels.Completed &gt; <span class="hljs-number"><span class="hljs-number">3</span></span>, }; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> removeSeaweedQuest = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RemoveSeaweedQuest { ReachedCondition = () =&gt; fixSubmarineQuest.Component.IsFinished, }; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> fixGateStatuesQuest = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FixGateStatuesQuest { ReachedCondition = () =&gt; removeSeaweedQuest.Component.IsFinished &amp;&amp; fixSubmarineQuest.Component.IsFinished, };</code> </pre><br>  Visualize the link quests: <br><br><img src="https://habrastorage.org/webt/y0/z0/mk/y0z0mk9p1zhvk8caavvy12lqnww.png" alt="image"><br><br>  As we can see, quests form a disconnected acyclic directed graph. <br>  Let us examine the logic of the state of the quest.  Each state is in its essence a sequence of actions that must be performed in this state.  Actions can be completely different: activate animation, move the camera around the scene, launch the game level, launch and control the cut-scene, etc.  Example: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">yield</span></span></span><span class="hljs-function"> return </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">WaitForMapScreenOnTop</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>; MapScreen.HideUi(); <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> MapScreen.ScrollToMapNodeTask( MapScreen.Map._Sector02._RadioTower.It, zooming: MapZooming.Minimal, screenPivot: <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Vector2(<span class="hljs-number"><span class="hljs-number">0.5f</span></span>, <span class="hljs-number"><span class="hljs-number">0.4f</span></span>) ); <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> MapScreen.Map._Sector02._RadioTower.RunAnimationFixTower(); <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> MapScreen.Map._Sector02._RadioTower.RunAnimationCommunicate(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> dialog = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CutScene(CharacterEmotion.Playfulness); dialog.AddBubble(<span class="hljs-string"><span class="hljs-string">"Bla-bla-bla"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Task.WaitWhile(() =&gt; !dialog.IsNearlyHidden); MapScreen.ShowUiWithDelay(); SetState(FixCommunicationCrystalQuestState.Final);</code> </pre><br>  In this example, we: <br><br><ol><li>  We are waiting until the top dialog is a map. </li><li>  Hide the UI and move the camera. </li><li>  Successively launch plot animations. </li><li>  Show a cut-scene with a happy character saying ‚Äúbla-bla-bla‚Äù. </li><li>  Show UI and go to the next state. </li></ol><br><br><h3>  Roslyn and content </h3><br>  As you know, gamedev is a rather extreme software development area.  Not only is the game a ‚Äúhodgepodge‚Äù of systems and components, so also the relationships between them change with lightning speed (and sometimes even according to the principle of a pendulum: remove, return, remove half ...).  At the stage of active development, the plot is constantly undergoing changes.  This affects all levels of the described architecture: the relationship between quests (their order), and the division of quests into sectors, and directly the logic of the quest (state and action).  I honestly got tired of writing everything by hand (or doing Ctrl + C, Ctrl + V, and then renaming, etc.), so first I wrote a small WinForms application to generate StubQuest with the specified name and states.  And then I remembered Roslyn and decided to create a plot editing tool. <br><br>  As I already described above, the whole plot is set by code.  Without programming skills you will not edit.  To provide the ability to change all the above components (quests, order, logic, actions) to other people (producers, game designers), and even to work many times faster, an editor was created, an important part of which is Roslyn.  The principle of its work: <br><br><ol><li>  Using Roslyn (in particular, Microsoft.CodeAnalysis.CSharp), the game code is analyzed and a logical model is built. </li><li>  The logical model is displayed in the diagram. </li><li>  Chart changes are displayed in the model, and then (again through Roslyn, but using the API for generating and modifying code) back to the code base. </li></ol><br>  Schematically, this can be expressed as: <br><br><img src="https://habrastorage.org/webt/kt/0r/on/kt0roniddsgqbmfdhum1urcokna.png" alt="image"><br><br>  The logical representation is quite simple in itself - a set of classes / structures representing game entities, various data with which to describe / supplement them, and the connections between these entities.  Thanks to the logical model, it is easy to check the correctness of behavior (for example, the presence of cycles in the graph or the forgetfulness of the developers to show the UI after the cut scene).  Let's talk about code analysis and building a logical structure in more detail. <br><br><div class="spoiler">  <b class="spoiler_title">About solving code editing outside of Visual Studio by non-programmers</b> <div class="spoiler_text">  Skeptics may ask: why all this?  How can I give code to non-programmers to edit? <br>  The answer is: very simple.  The tool allows you to edit only strictly certain parts of the code, and also checks for correctness.  Using it, you can not break the assembly of the project. <br>  And what about ‚Äúconstantly and rapidly changing requirements‚Äù?  Everything is also simple: new features are added as needed.  As soon as the concept is implemented, approved and found in different places of the plot, the tool is finalized. <br></div></div><br><br><h4>  Code analysis and model building [technical section]. </h4><br>  What is a code?  For starters, it's just text.  Then, at the <a href="https://en.wikipedia.org/wiki/Parsing">parsing</a> stage, AST ( <a href="https://en.wikipedia.org/wiki/Abstract_syntax_tree">Abstract Syntax Tree</a> ) is obtained from it.  After the semantic analysis, <a href="https://en.wikipedia.org/wiki/Symbol_table">a symbol table</a> appears.  Using Roslyn, getting the required data structures is easy (an example is taken <a href="https://joshvarty.com/2014/10/30/learn-roslyn-now-part-7-introducing-the-semantic-model/">from here</a> ): <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> tree = CSharpSyntaxTree.ParseText(<span class="hljs-string"><span class="hljs-string">@" public class MyClass { int MyMethod() { return 0; } }"</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> Mscorlib = MetadataReference.CreateFromFile(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">object</span></span>).Assembly.Location); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> compilation = CSharpCompilation.Create( <span class="hljs-string"><span class="hljs-string">"MyCompilation"</span></span>, syntaxTrees: <span class="hljs-keyword"><span class="hljs-keyword">new</span></span>[] { tree }, references: <span class="hljs-keyword"><span class="hljs-keyword">new</span></span>[] { Mscorlib } ); <span class="hljs-comment"><span class="hljs-comment">//Note that we must specify the tree for which we want the model. //Each tree has its own semantic model var model = compilation.GetSemanticModel(tree);</span></span></code> </pre><br>  So, we have the code in a form suitable for analysis.  It remains to link this with the logical structure of the plot.  The project‚Äôs file structure and the architecture described above help us in this: <br><br><img src="https://habrastorage.org/webt/qr/ye/l6/qryel6ol1hzpg_iayc3ejxujiaa.png" alt="image"><br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">LoadSectorCode</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> dirPath</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> sectorFile = Directory.EnumerateFiles(dirPath) .FirstOrDefault(p =&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FileInfo(p).Name.StartsWith(<span class="hljs-string"><span class="hljs-string">"Sector"</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sectorFile == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SectorFileNotFoundException(); } code.ReadFromFile(Path.Combine(dirPath, sectorFile), CodeBulkType.Sector); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> questsDir = Path.Combine(dirPath, <span class="hljs-string"><span class="hljs-string">"Quests"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Directory.Exists(questsDir)) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> files = Directory.EnumerateFiles(questsDir); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> filePath <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> files) { code.ReadFromFile(filePath, CodeBulkType.Quest); } } }</code> </pre><br>  Each file in the codebase is associated with a type (enum CodeBulkType): quest, sector, configuration file, etc.  Knowing the type, you can perform a higher level analysis.  For example, read quest data: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">QuestReader</span></span> : <span class="hljs-title"><span class="hljs-title">CodeReader</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> CodeBulkType[] AcceptedTypes =&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span>[] { CodeBulkType.Quest, }; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Read</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">CodeBulk codeBulk, Code code, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">ref</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Flow flow</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> quest = FromCodeTransformer.ReadQuest(codeBulk.Tree); <span class="hljs-comment"><span class="hljs-comment">//... sector.Quests.Add(quest); //... } }</span></span></code> </pre><br><br><div class="spoiler">  <b class="spoiler_title">A little about data architecture and reading</b> <div class="spoiler_text">  With the changes in the project, the development tools of the project are also changing; therefore, the mandatory requirements for the architecture were extensibility and flexibility.  I see the logical model as a repository: data can be added, changed, deleted.  Data Extensibility: <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-title"><span class="hljs-title">IData</span></span> {} <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">DataStorage</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> List&lt;IData&gt; Records = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;IData&gt;(); <span class="hljs-comment"><span class="hljs-comment">//‚Ä¶. } // -   , ,  ‚Ä¶ public DataStorage Data { get; } = new DataStorage();</span></span></code> </pre><br>  Reading: <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-title"><span class="hljs-title">ICodeReader</span></span> { CodeBulkType[] AcceptedTypes { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Read</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">CodeBulk codeBulk, Code code, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">ref</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Flow flow</span></span></span><span class="hljs-function">)</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">CodeReader</span></span> : <span class="hljs-title"><span class="hljs-title">ICodeReader</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> CodeBulkType[] AcceptedTypes { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">abstract</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Read</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">CodeBulk codeBulk, Code code, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">ref</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Flow flow</span></span></span><span class="hljs-function">)</span></span>; }</code> </pre><br>  Need to count something?  Get a class, follow from CodeReader / implement ICodeReader.  Need to provide additional.  data for analysis?  Well, inherit from IData and read them from where it is necessary and add where necessary. <br></div></div><br>  For the analysis and editing of the syntax tree, the <a href="https://sourcemaking.com/design_patterns/visitor">Visitor</a> pattern, or <a href="https://en.wikipedia.org/wiki/Language_Integrated_Query">LINQ</a> , is actively used.  The latter is rather inconvenient, suitable for very simple analysis.  In the project code, I actively used the <a href="http://source.roslyn.codeplex.com/">SyntaxVisitor</a> , <a href="http://source.roslyn.codeplex.com/">SyntaxWalker</a> and <a href="http://source.roslyn.codeplex.com/">SyntaxRewriter</a> classes.  Use-case of the first two - analysis of the syntax tree.  For example, a quest can be added to the plot, or just lie quietly, do not touch anyone.  To determine this characteristic you need to look, the quest constructor is called somewhere.  With Roslyn, this is quite simple: inherit from SyntaxWalker and ‚Äúvisit‚Äù all ObjectCreationExpression: <br><br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">// SyntaxWalker -  CSharpSyntaxWalker'a  .  private class QuestInitializationFinder : SyntaxWalker { //... public override void VisitObjectCreationExpression(ObjectCreationExpressionSyntax node) { base.VisitObjectCreationExpression(node); var model = Code.Compilation.GetSemanticModel(node.SyntaxTree); if (model.GetTypeInfo(node).Type == questTypeToFind) { //‚Ä¶. } } //... }</span></span></code> </pre><br><br><h4>  Display of the constructed model. </h4><br>  So, we built the model.  It remains to display it, and then learn to edit. <br><br>  Model mapping was implemented using the open <a href="https://www.dataweb.de/en/products/diagramming.html">NShape</a> library.  This project turned out to be the easiest to learn and has rich functionality (although sometimes you want more opportunities for expansion ...).  The <a href="https://en.wikipedia.org/wiki/Layered_graph_drawing">Sugiyama</a> algorithm from the <a href="https://en.wikipedia.org/wiki/Microsoft_Automatic_Graph_Layout">Microsoft Automatic Graph Layout</a> library was used to locate the vertices of the quest <a href="https://en.wikipedia.org/wiki/Microsoft_Automatic_Graph_Layout">graph</a> , and I also had to write a few heuristics. <br><br>  I will give an example of the quests of the first sector: <br><br><img src="https://habrastorage.org/webt/5-/hf/w-/5-hfw-fhl5cc04k2ub_rh7pxcgm.png" alt="image"><br><br>  It looks much more user-friendly than the initialization code, right?  (This is a very simple example, where there are few quests and they are initialized in a linear manner.) But the display of the logic of the quest (the mode ‚Äúfor programmer‚Äù is to show the code; in the mode ‚Äúfor all others‚Äù the verbal description of the action is shown): <br><br><img src="https://habrastorage.org/webt/km/bd/pn/kmbdpnxagynue_g_8gbhuwkswti.png" alt="image"><br><br><h4>  Editing model [technical section]. </h4><br>  The <a href="https://www.dataweb.de/en/products/diagramming.html">NShape</a> library <a href="https://www.dataweb.de/en/products/diagramming.html">is</a> intended for creating and editing diagrams.  Displaying the logical structure in the form of a diagram, we have the possibility of its (structure) visual editing.  The main thing is to correctly interpret the changes and to prohibit invalid. <br><br>  The translation of actions on a diagram into logical ones takes place in special wrappers over the NShape library tools (writing this code was still a pleasure).  Only actions that carry a certain meaning in the context of a logical model are transformed (for example, the rotation of a shape denoting a quest does not imply any structural change in our display method).  All actions are encapsulated in objects of type Command (did you recognize the <a href="https://sourcemaking.com/design_patterns/command">pattern</a> ?) And are reversible. <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">delegate</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DoneHandler</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> firstTime</span></span></span><span class="hljs-function">)</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">delegate</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">UndoneHandler</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-title"><span class="hljs-title">ICommand</span></span> { DoneHandler Done { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } UndoneHandler Undone { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Do</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Undo</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>; }</code> </pre><br><br>  This interface (and the abstract class implementing it) is responsible for changing the logical model and code.  Updating of visual representation occurs through a subscription to Done / Undone delegates. <br><br><div class="spoiler">  <b class="spoiler_title">Breaking up compound actions</b> <div class="spoiler_text">  Some actions consist of several others.  For example, linking two quests.  If both of them are activated, then this one action is the direct addition of a link.  If at least one of them is inactive, then before placing a link, you must ‚Äúturn it on‚Äù.  Or another example - the removal of the quest.  Before deleting the quest, you must remove all links with his participation and deactivate the quest.  Such a partition allows splitting up complex actions into components and constructing others from them. <br><br>  In the code, this is implemented through a specific case of the command - CompositeCommand: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">CompositeCommand</span></span> : <span class="hljs-title"><span class="hljs-title">Command</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> List&lt;ICommand&gt; commands = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;ICommand&gt;(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Do</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> cmd <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> commands) { cmd.Do(); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Undo</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> cmd <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> Enumerable.Reverse(commands)) { cmd.Undo(); } } }</code> </pre><br>  Here I would like to highlight editing the undone property of this command.  The fact is that the commands are executed in the order of addition, and rolled back - in the opposite.  Therefore, Undone delegates must be combined in the reverse order: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AddCommands</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IEnumerable&lt;ICommand&gt; commandsToAdd</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-comment"><span class="hljs-comment">//... foreach (var cmd in commandsToAdd) { Done += cmd.Done; Undone = (UndoneHandler)Delegate.Combine(cmd.Undone, Undone); } }</span></span></code> </pre><br></div></div><br>  For editing syntax trees, the extensions of the <a href="http://source.roslyn.codeplex.com/">CSharpSyntaxRewriter</a> class are used, as described above (the technique is well described <a href="https://joshvarty.com/2014/08/15/learn-roslyn-now-part-5-csharpsyntaxrewriter/">here</a> ).  An example of deactivating a quest (removing a constructor call): <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">DeactivateQuestCommand</span></span> : <span class="hljs-title"><span class="hljs-title">Command</span></span> { <span class="hljs-comment"><span class="hljs-comment">//‚Ä¶ public override void Do() { var classDecls = codeBulk.Tree.GetRoot().DescendantNodes().OfType&lt;ClassDeclarationSyntax&gt;(); foreach (var classDecl in classDecls) { var typeRemover = new ClassConstructorCallRemover( Context.CodeEditor.GetSymbolFor(classDecl, codeBulk), Context.Code ); Context.CodeEditor.ApplySyntaxRewriter(typeRemover); } //... } //... } class ClassConstructorCallRemover : SyntaxRewriter { //‚Ä¶ public override SyntaxNode VisitExpressionStatement(ExpressionStatementSyntax node) { var model = Compilation.GetSemanticModel(node.SyntaxTree); var expr = node.Expression; if (expr is ObjectCreationExpressionSyntax oces) { if (ReferenceEquals(model.GetTypeInfo(expr).Type, typeToRemove)) { return null; } } return base.VisitExpressionStatement(node); } public override SyntaxNode VisitLocalDeclarationStatement(LocalDeclarationStatementSyntax node) { if (node.Declaration.Variables.Count == 1) { var model = Compilation.GetSemanticModel(node.SyntaxTree); var type = model.GetTypeInfo(node.Declaration.Variables.First().Initializer.Value).Type; if (ReferenceEquals(type, typeToRemove)) { return null; } } return base.VisitLocalDeclarationStatement(node); } //... }</span></span></code> </pre><br>  I want to note that some of the editing features Roslyn provides out of the box.  A vivid example is renaming ( <a href="http://source.roslyn.codeplex.com/">Renamer</a> ) and formatting spaces ( <a href="http://source.roslyn.codeplex.com/">Formatter</a> ).  And it greatly simplifies life. <br>  Up to now, we have dealt only with deleting / changing the already existing code.  And what about the generation of a new one?  This is done simply - via <a href="http://source.roslyn.codeplex.com/">SyntaxFactory</a> .Parse * and node modification functions: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> linkExprText = <span class="hljs-string"><span class="hljs-string">$"ReachedCondition = </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{newLinkText}</span></span></span><span class="hljs-string">"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> newInitializer = node.Initializer.AddExpressions(SyntaxFactory.ParseExpression(linkExprText));</code> </pre><br>  As you can see (if you carefully looked at the second line), the AddExpressions function returns us a new node.  In general, the whole Roslyn follows a functional approach in architecture: if you want to change something, create a new one with the required parameters.  At first, it is inconvenient, and then you begin to love it. <br><br><div class="spoiler">  <b class="spoiler_title">About code fixes</b> <div class="spoiler_text">  Roslyn is a good tool, but not all-powerful.  For example, after modifying the code, banal compilation errors may occur.  And you need to fix them yourself.  So I had to write code-fix for the order of initialization of quests in the sectors. <br></div></div><br>  To write such code, you need a good knowledge of grammar (what syntactic units you need to check / edit / create) and Roslyn API.  But after you get everything you need, programming with Roslyn turns into one pleasure (especially in architectural terms - I'm a big fan of beautiful code and functionalism). <br><br><h4>  Editor features and tradeoffs.  A practical example. </h4><br>  Up to this point little has been said about the editor and its functionality.  Let's fix the situation: let's discuss, in the end, what exactly can be edited, what compromises had to be made to achieve a balance between the wealth of features and complexity, and then consider an example from real practice (albeit somewhat simplified). <br><br>  So, decided to edit the code.  We admit to ourselves that the wording is rather scary.  Here people do not always write as they should, but we need to write a program that will <b>analyze</b> and <b>change</b> other code.  And not necessarily written by us.  No restrictions can not do. <br><br>  The first thing I want to describe is the behavior of the editor in case of detection of code that he doesn‚Äôt know how to interpret: some internal affairs of programmers, hacks, new features, about which it is impossible to say for sure whether they will enter the project or not, etc. .  This situation must be ‚Äúresolved‚Äù very carefully.  Otherwise, the tool will do more harm than good. <br><br>  How do we solve this problem?  Do not play with what <b>you do not understand</b> .  The term is referring to the knowledge of the program about the logical value of a piece of code.  Too abstract?  Here are a couple of examples. <br><br>  The first example.  The quest must be activated not only after another, but also after three levels passed.  Or five.  And even after the user was given a daily reward.  In general, there is some additional condition.  From the editor, to set such a condition in the general case is impossible - the intervention of the programmer is required.  Okay, the programmer finally got free and added a couple of lines to the code.  What's next?  First, the editor displays this in a diagram: <br><br><img src="https://habrastorage.org/webt/-q/31/je/-q31jegqlkhfrex0dy76hqqv-vw.png" alt="image"><br><br>  The user immediately sees that everything is not so simple with this quest.  Secondly, it is forbidden to edit the unknown (not parsed by the editor) conditions.  The maximum that we can do is to read its source code and the comment left to it (a useful function - allows the programmer to explain the meaning of the code to the uninitiated).  Thirdly, it is only allowed to add <b>new</b> conditions (and, of course, to edit and delete them).  Those.  the condition may become <b>stricter</b> , and as much as the editor allows. <br><br>  An example of the second.  Unassembled code in the logic (actions) of the quest.  Probably the most common situation.  The philosophy here is the same: do not give to edit and unobtrusively show a sign that says <b>WARNING</b> (in general, there is a tick to hide / show the unparsed code). <br><br>  The second thing to discuss is editing the flow of execution.  For example, in one of the quests there is a part of logic, which in itself is optional and is launched only according to a definite and undetectable condition.  It would be foolish to ban its editing altogether.  Therefore, it was decided to leave this possibility to the user, but with some reservations: no editing of the condition of occurrence is allowed (conditions in if, while), as well as moving the whole block in the general case (yes, the bitter truth - moving can break the compilation or what is worse, it is not obvious to change the logic).  Need to move the logic?  Two options: either turn off the block and in the right place create a new one, or give the task to the programmer. <br><br>  Now consider a simple example for illustration.  The game designer gets the task: to insert the TalkToLeeroy quest between FindKey and OpenTheDoor quests.  In the quest, we show the cut-scene, wait for the direct passage of the quest, then show the second cut-scene and complete the quest.  Algorithm action game designer (from his face): <br><br><ol><li>  We find quests, between which it is necessary to insert a new one: <br><img src="https://habrastorage.org/webt/lu/on/he/luonheuiixervmbdffrmjyy_liq.png" alt="image"></li><li>  Add a new quest with the desired name, throws connections: <br><img src="https://habrastorage.org/webt/co/ay/rs/coayrspnepkqm9xsppjm7b9l80g.png" alt="image"></li><li>  Open the quest editing window, add the required states: <br><img src="https://habrastorage.org/webt/zs/ao/js/zsaojsnstv4j1syylmozt7odvoo.png" alt="image"></li><li>  Then we fill each state with the necessary action.  For example, the Initial status task is to show the first cut-scene: <br><img src="https://habrastorage.org/webt/xj/gs/wu/xjgswuc7tgmtpvgisee_kgo2zc4.png" alt="image"></li><li>  By analogy, the remaining states are filled. </li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If errors are suddenly detected (for example, we have hidden the interface and forgot to show it), we are warned about this visually (with special marks on the diagram). </font><font style="vertical-align: inherit;">We correct errors.</font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> We start the game, make sure that everything works as it was intended. </font></font></li></ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">So, the task is completed, the joyful designer calmly sends it for testing and leaves to drink tea. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The purpose of the creation of the editor was rapid prototyping and content filling. </font><font style="vertical-align: inherit;">In the end, only the programmer, the little king and god of the virtual world, has absolute power over the logic of the game. </font><font style="vertical-align: inherit;">It is cheaper (and, as a result, more expedient) to give him the task of polishing / refining the game functionality, rather than complicating the tool a lot. </font><font style="vertical-align: inherit;">And then so before such a situation is not far:</font></font><br><br><img src="https://habrastorage.org/webt/f8/fe/nj/f8fenjgxemkxpbtyplzkujqbzxy.png" alt="image"><br><br><h3>  Conclusion </h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I described not all. </font><font style="vertical-align: inherit;">I had to omit some points (analysis and visualization of errors, operations with sectors, etc.). </font><font style="vertical-align: inherit;">If there is interest - write in the comments, perhaps I will write another article. </font><font style="vertical-align: inherit;">The purpose of this was to show that even such tools, which, it would seem, are poorly related to gamedev, can be successfully applied in practice. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">What was finally done:</font></font><br><br><ol><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Work speeds up at times </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Improved structure and architecture of the game </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> The author learned Roslyn, deepened knowledge of C #, improved design skills </font></font></li></ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Would I recommend Roslyn to learn and use? </font></font> Of course.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Be patient and go. </font></font></div><p>Source: <a href="https://habr.com/ru/post/345330/">https://habr.com/ru/post/345330/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../345320/index.html">Visual programming in DRAGON</a></li>
<li><a href="../345322/index.html">Karmic incompatibility and other vicissitudes of service engineer</a></li>
<li><a href="../345324/index.html">Pygest # 20. Releases, articles, interesting projects, packages and libraries from the world of Python [December 6, 2017 - December 23, 2017]</a></li>
<li><a href="../345326/index.html">Is there life without standards in javascript?</a></li>
<li><a href="../345328/index.html">Simulation of the simplest statements</a></li>
<li><a href="../345332/index.html">Kubernetes Service Writing Guide</a></li>
<li><a href="../345336/index.html">We spread the application in the App Store. Even if you are not a developer</a></li>
<li><a href="../345340/index.html">A story about how to create a repository and understand Redux</a></li>
<li><a href="../345342/index.html">What are dangerous social networks on your PC?</a></li>
<li><a href="../345344/index.html">Sending a request to the specified MS SQL Server databases of all the specified servers using available tools</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>