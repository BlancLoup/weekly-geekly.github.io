<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>From repository to CI / CD infrastructure in production for the week</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Usually, the term ‚Äúsupport‚Äù means only one meaning - it is the response to the troubles with hosting, replacement of bad drives, setting up web server...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>From repository to CI / CD infrastructure in production for the week</h1><div class="post__text post__text-html js-mediator-article">  Usually, the term ‚Äúsupport‚Äù means only one meaning - it is the response to the troubles with hosting, replacement of bad drives, setting up web servers and DBMS, and general day-to-day administration.  But, in fact, this is only the first level of control over the stability of the operation of any Internet project. <a name="habracut"></a><br><br>  After all, even when you have already configured a failover cluster of multiple servers in different data centers, with backup of all critical data and automatic file server, there are still situations where the streamlined operation of production sites can be seriously disrupted.  Do you often have to see instead of this: <br><br><img src="https://habrastorage.org/web/fc1/72e/f52/fc172ef520f247609cfc660769c8dd53.png" alt="image">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Here it is: <br><br><img src="https://habrastorage.org/web/906/6ef/d17/9066efd17ffc4cc0b8a9a30d33806895.png" alt="image"><br>  And it is about this post - about security and stability of development and about what systems and principles they can provide.  Or, if you use fashionable words - about DevOps and CI / CD. <br><br><h2>  What for? </h2><br>  In the basic scheme, when we have only one server on which the site itself is spinning, and the base for it, and all other related services, such as caching and searching, almost all things can be done manually - take updates from the repository, restart services , re-index the search base and all that. <br><br><img src="https://habrastorage.org/web/961/8ef/802/9618ef80236e4e09a98ee909211eb0a2.jpg" alt="image"><br><br>  But what to do when the project grows up?  Both vertically and horizontally.  When we already have ten servers with a web, three with a base, several servers for searching.  We also decided to understand exactly how our customers use our service, we got a separate analytics with their own databases, frontend, and periodic tasks.  And now we have more than one server, but thirty, for example.  Continue to do all the little things by hand?  We'll have to increase the staff of admins, because  one already physically will not have enough time and attention to all supported systems. <br><br>  Or you can stop being the admin craft workshop and start building production chains.  Move on to the next level of abstraction, manage not individual services or programs, but servers as a whole, as the minimum unit of a common system. <br><br>  For this purpose, the DevOps and CI / CD methodologies were invented.  CI / CD implies a separate development site, separate staging and separate sales. <br><br><img src="https://habrastorage.org/web/cbb/c26/382/cbbc263829fc40e2a97166840f5db087.jpg" alt="image"><br><br>  It also implies that each release necessarily goes through certain stages of life, be it manual or automated testing, installing on a stage to test its performance in an environment identical to that of the product.  This eliminates the possibility that something will go wrong during the deployment itself - pulnully the wrong branch, not from that turnip, not on that server, etc. Everything is provided in advance and structured, and the influence of the human factor is minimal.  It remains only to monitor the quality of the code itself and the work of the internal logic of the project. <br><br>  This allows admins not to interfere in the development and display process itself and to deal with their immediate responsibilities for monitoring and reflecting on how to further expand the architecture. <br><br>  Usually such things are said more in a theoretical way.  Here, they say, there is such a thing as Docker.  Here we can make inexpensive containers.  Create, update, roll back, everything can be done without serious consequences, without touching the vital parts of the parent system, without loading with unnecessary layers and services.  And then in another article - here are the Kubernetes.  He can insert and pull out docker-bricks in your project independently, without manual intervention, just describe to him the configuration how it will work.  Here are three lines from the official documentation.  And in such a style almost all the materials.  I would like to talk about how all this happens in real life, starting from the real task of providing a mechanic with a safe and stable development. <br><br><h2>  About whom? </h2><br>  I will tell you on the example of the <a href="https://edwin.ai/ru/">Edwin</a> service, which helps to learn English using a bot in Facebook Messenger.  Bot <a href="https://m.me/EnglishWithEdwin/%3Fref%3Dlp">@EnglishWithEdwin</a> determines the level of English and personalizes the curriculum based on the progress and speed of learning of each student. <br><br>  By this time, the company had been developing for several months, there was a working product that was developing rapidly, and the company was preparing for the first public release.  At the site where the development was carried out, services in docker containers have already been launched, databases on AWS have been raised, and it all even worked. <br><br>  The head of Edwin‚Äôs development, Sergey Vasilyev, having carefully analyzed existing offers on the market, came to us with a description of the architecture of his product and requirements for reliability in operation.  In addition to our main task - round-the-clock support of services - we needed to understand what was going on and organize the staging and production site with the possibility of convenient updates and general infrastructure management. <br><br>  The use of containers in production at that time was not massive, and chat bots were just beginning to develop.  Thus, for us it was a great opportunity to practice modern tools on the example of a real and interesting product. <br><br><h2>  Project structure </h2><br>  How is Edwin built from the inside?  Keywords - Python, PostgreSQL, Neo4j, RabbitMQ.  Conventionally, the architecture can be divided into three large blocks: transport, logical and analytical. <br><br><img src="https://habrastorage.org/web/0aa/ffd/20c/0aaffd20c19b4c21ba508328f2847099.png" alt="image"><br>  In the first block, a documented mailer application written in python, which receives messages from Facebook via Facebook Gateway, saves them to the database and adds an event to the RabbitMQ queue. <br><br>  In the second block, there are containers with the bot itself, which reads data from queues about incoming messages, processes, collects data for analysts in the third block, and with the scheduler, a dokerized Tornado application responsible for all periodic and pending tasks, like push notifications and expiration of the lifetime of the sessions. <br><br>  In the third block, there are databases with data for analytics and several containers with services dealing with aggregation of data from bots and uploading to Google Analytics and other places. <br><br>  But all this is only a supposed structure, since  Edwin came to us, not yet having a release version of the project, in production he never glowed.  It was exactly the setting of the stage- / prod-environment that we had to do. <br><br>  In general, all this did not look very difficult, if it were not for one thing - while all the introductory details were discussed, the deadline time inexorably approached, and we only had a week left to realize all our wishes. <br><br><h2>  CI / CD setup <br></h2><br>  The first thing to remember is that everything is not as difficult as it seems from afar.  The main thing is to understand what you are doing and why.  Choose tools only for those needs that are really important, adequately assess their real needs and capabilities. <br><br>  The basis of our entire system is docker-containers with services and business logic.  Containers are selected for greater versatility and mobility in infrastructure management.  The most popular tool for juggling docker-containers at the moment is Kubernetes from Google (at least, he is the most widely heard).  But it seemed to us to be unnecessarily confused and structurally re-complicated, and therefore requiring too many gestures to maintain working capacity (and too much time for initial understanding).  And since  the time of putting the whole CI / CD system into service was compressed to a minimum, we decided to look for simpler and lightweight solutions. <br><br>  To store container templates, it was decided to take (in fact, not even take, but simply to leave the developers, already chosen by us,) Amazon EC2 Container Registry.  In general, it is not much different from the registry itself raised on the localhost.  Basically by the fact that it does not need to be personally lifted on localhost. <br><br>  So, we have a repository with container templates.  How to make so that the expanded containers can always know about each other and can communicate with each other even with the changed network configuration, for example?  At the same time, without interfering constantly in the insides of the containers themselves and their configuration? <br><br>  To do this, there is such a type of software as service discovery - probably, for ease of understanding, it could be called a ‚Äúbusiness logic router‚Äù, although technically it is not a completely correct definition.  A single call distribution center is established, to which all services address their neighbors' location data, agents of this center are initially placed inside containers.  And all services at startup announce their location and status to the router. <br><br>  How to quickly prepare new machines for containers?  After all, the hosts also need to be properly configured for network loads and so on, the default kernel parameters are also often quite far from what I would like to see in my production.  For this, several Ansible-recipes were written, which reduce the time spent on preparing the new site by an order of magnitude. <br><br>  When the servers for containers are configured, all the necessary services are documented, it remains only to understand how to organize, in fact, ‚Äúcontinuous integration‚Äù, without pressing 500 buttons every half hour.  As a result, they stopped on a system like GoCD and a small scripting system.  Why GoCD, you ask me, not Jenkins?  Earlier, in other projects, we had to deal with that, and with the other, and on the totality of interactions GoCD seemed to be easier to configure than Jenkins.  It is possible to create templates for tasks and pipelines, on the basis of which you can then generate different production chains for different environments. <br><br><h2>  Development process </h2><br><h4>  Monday, February 6 </h4><br>  The first day was, in general, calm.  We finally got a TK for what we had to do. <br><br>  Here it is, of course, to make a reservation that exactly a week is still a small trick.  In the end, not in a vacuum, we exist!  Admins in advance were aware of what kind of project will come to support, and which, in general, the tasks will be in the first place.  So we had some time to get a little understanding of the options for choosing tools. <br><br>  As a result, we quietly and measuredly study the existing servers, on which the project was developed at that time.  We are hanging monitoring, figure out where that is running, how it works. <br><br>  Based on the received information, we write Ansible-recipes and start installing servers for production, we start a separate VPC in Amazon, which would not overlap with the existing dev-environment in order to avoid careless actions during development.  We expand containers with all necessary services - PostgreSQL, Neo4j, project code. <br><br>  By the way, when developing, colleagues used PostgreSQL in the form of Amazon RDS, but for the production environment, by joint agreement, they decided to switch to regular instances with PostgreSQL - this made the situation more transparent for admins who could control the behavior of all elements of the system as much as possible. time of the subsequent growth of loads. <br><br>  In fact, if you do a project with small forces, and you do not have enough dedicated administrative hours, you can use RDS as well, it is quite suitable for yourself, and at the same time allows, if anything, frees up resources for more urgent tasks. <br><br><h4>  Tuesday, February 7 </h4><br>  On a separate server, we install GoCD and Consul service discovery in the base version. <br><br>  As I mentioned earlier, Edwin came to us already with some kind of infrastructure ready for development.  For juggling containers, they used Amazon ECS, also known as EC2 Container Service.  Something like Kubernetes-as-a-Service.  After discussing the wishes with the developers on the future structure of the project and work with the calculations, it was decided to abandon ECS.  Like many cloud pieces, it was not transparent enough to control things going on inside; there was a lack of things that were very useful in the current situation, such as the environment settings for the same container.  Those.  There is no possibility to use the same container in different pipelines just by redefining the environment.  In the Amazonian paradigm, you have to create a separate container for each environment. <br><br>  It is also impossible for some reason to use the same tasks in different chains.  In general, GoCD seemed to us much more flexible. <br><br>  The rest of the day we are engaged in the creation and adjustment of the pipelines for the GoCD sales environment - building the code, re-creating the containers, rolling out new containers for sale, registering the updated services in the consul. <br><br><h4>  Wednesday, February 8 </h4><br>  We double-check yesterday's settings, carry out test calculations, check the connectivity of the systems - that the code is correctly retrieved from the repository, that the same code is then correctly assembled into a container, the container is started on the correct server, and then announces its status to the consul. <br><br>  In general, at the moment we have a ready-made basic infrastructure, within which we can already work on a new paradigm.  The GoCD panel is there, the mechanics of assembling and laying out the project in production are set up in it, Consul allows seamlessly and without any special additional time and labor costs to include new servers and services in the existing infrastructure. <br><br>  Making sure that everything works as it should, we set up backup replications for databases in neighboring Accessibility Zones, and, together with the developers, we upload working data to the sales databases. <br><br><h4>  Thursday, February 9 </h4><br>  As I have already said, at this moment, in general, the minimum necessary elements of the CI / CD system are all installed and configured.  We transfer to the developers all the data on the structure of the resulting system, for their part, they start testing all the mechanisms for assembling and laying out the project. <br><br>  Here, by the way, comes the realization that when drawing up the TK, such an important point was forgotten as the centralized collection of all system logs from all containers and services.  This is useful for background analysis of the overall project situation and tracking potential bottlenecks and impending problems. <br><br>  Logs decided to collect in Kibana - a very convenient interface for all sorts of analysts.  We repeatedly encountered it both on side projects and used it on our internal projects. <br><br>  In a few hours, we are raising Kibana, setting up a collection of logs from services, setting up monitoring of all critical services for sale. <br><br><h4>  Friday, February 10 </h4><br>  For the most part, from the organizational side on Friday everything was ready.  We, of course, met a bunch of different minor bugs and glitches, but it had nothing to do with the system of continuous integration. <br><br><h2>  results </h2><br><img src="https://habrastorage.org/web/959/3fe/aba/9593feaba5b84d558f86884f1a001877.jpg" alt="image"><br><br>  What did we get in the end?  A modular project development system consisting of three stages and environments - dev, stage and prod.  The whole project is divided into separate microservices, each of which has its own pipelines. <br><br>  When developers release a new version, they go to the GoCD panel and simply launch the corresponding pipeline.  For example, ‚Äúroll out a new logger on the stage‚Äù, test there, check that everything works as it should, then roll it out on the prod.  If suddenly something went wrong, then again, independently through the panel roll back the desired service to the desired version. <br><br><img src="https://habrastorage.org/web/906/be3/d0a/906be3d0a3a849d6addf68d4c63fbd12.jpg" alt="image"><br><br>  All three environments ‚Äî both dev, and stage, and prod ‚Äî are isolated in different VPCs.  Consul has separate data centers set up for each environment, so services cannot even walk between different environments by chance.  And even with a great desire in such a situation, it is rather difficult to break the prod for example by any actions on the maiden. <br><br>  Also, now you can easily increase the capacity for the project.  When there is a need for new computing power, a new instance can be launched and prepared for work for approximately ten minutes. <br><br><h2>  Problems encountered <br></h2><br>  In general, despite the fact that the field of activity itself may seem rather complicated to many, with a bunch of underlying problems, almost everything turned out right away, minus only a couple of questions.  Which, in general, are not really related to continuous integration. <br><br>  Problems threw Amazon Web Services, which hosts this project. <br><br>  When setting up the Consul, we encountered an interesting plug.  Agents and access to them are registered in containers through system resolvers.  But AMI Linux, used by Amazon by default, is slightly different from the default CentOS, and work with resolvers is included in the Virtual Private Cloud (VPC) network settings.  When restarting the server, Amazon enforces its resolvers.  To force him not to break the settings of the rezolv of the consul, we have so far failed, unfortunately.  But chattr + i saved everyone, so now we live. <br><br>  In general, the structure of the VPC and its networks is quite interesting, and there you can stumble upon restrictions in very unexpected places.  For example, an application balancer can be created only for the accessibility zone, that is, the backends must be located in several different access zones at once.  To do this, the VPC network must have a breakdown so that there are addresses in private / public and one zone, and another.  A change in the breakdown of the VPC network is possible only at creation.  And changing the VPC from instances is also possible only at creation. <br><br>  And it turns out that when you already have a ready infrastructure with working servers within the same availability zone, there is no possibility to modify it by simply adding more servers in another zone and hanging the balancer in front.  Alas, it is necessary to completely redo the entire structure from scratch. <br><br><h2>  Conclusions and plans </h2><br>  Do not be afraid to grow and change the usual workflows if they no longer meet the requirements of the situation, the current level of development of your project.  Do not be afraid that the transition to the next stage of development of the project will certainly be too burdensome for you.  If you really come to your own needs and do not clutch thoughtlessly at the first available solutions that you have heard about, then this road can be easily mastered even alone. <br><br>  Although, of course, many may say: ‚ÄúAha-aha, they have been supporting projects like Habrahabr and Nashe Radio for ten years, and here we are being rant about simplicity!‚Äù.  Yes, indeed, in our age we have seen many different things.  And, perhaps, this is precisely what helps us to distinguish the simple from the complex and not to step on too many rakes.  But again, if at the very beginning it is reasonable to approach the task and select the right tools, without chasing ‚Äúcoolness‚Äù, then you can make your life much easier. <br><br>  On the other hand, you should definitely bear in mind that the scheme described (and any other based on containerisation) implies that the project must be initially ready for such manipulations.  The project should consist of full-fledged microservices, the state of which can not be saved, so that they are mobile and interchangeable.  Within the framework of monolithic systems, the introduction of such an approach of integration integration seems to be much more labor-intensive and less comfortable in further application. <br><br>  What are our future plans for the project? <br><br>  After the basic infrastructure has been established, there is a desire to connect to it also the Jira-based bugtracker so that when you roll out a new version into the prod from the Git repository, select data about requests for bugs, automatically close them and write to the release notes . <br><br>  It also seems that the moment is approaching when it will be necessary to set up auto-scaling on the main working nodes,  their total number is constantly growing, and saving on the number of active servers in hours of minimum load will help reduce costs. </div><p>Source: <a href="https://habr.com/ru/post/333650/">https://habr.com/ru/post/333650/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../333638/index.html">Education in the online magistracy as an option for professional and career growth</a></li>
<li><a href="../333640/index.html">Emacs + handy window and buffer manager</a></li>
<li><a href="../333642/index.html">Startup eyes of the developer. Which framework is better to choose</a></li>
<li><a href="../333644/index.html">Kernel test automation in microservice architecture</a></li>
<li><a href="../333648/index.html">What's new in IntelliJ IDEA 2017.2</a></li>
<li><a href="../333652/index.html">5D market. Projection systems</a></li>
<li><a href="../333654/index.html">Work-stealing scheduler in Go</a></li>
<li><a href="../333656/index.html">XBRL: just about the complex - Chapter 2. What is XBRL?</a></li>
<li><a href="../333658/index.html">Cost of data storage: ‚Äúzero-sum game‚Äù</a></li>
<li><a href="../333660/index.html">Use of vulcanization for polymer modules</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>