<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Jii: Full Query Builder for Node.js with API from Yii 2</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introduction 
 Hello to all habrovchanam, fans of Yii and Node.js. Why are the PHP framework and server-side JavaScript lovers combined? 
 Because Yii...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Jii: Full Query Builder for Node.js with API from Yii 2</h1><div class="post__text post__text-html js-mediator-article"><h1>  Introduction </h1><br>  Hello to all habrovchanam, fans of Yii and Node.js.  Why are the PHP framework and server-side JavaScript lovers combined? <br>  Because Yii is now available in JavaScript (for both Node.js and the browser)! <br><br>  In this article, we will look at the Query Builder, which fully preserves the API from Yii2 and works on Node.js. <br>  Query Designer is only one of the implemented parts of Jii (not to be confused with Yii), in this article I will not specifically consider the framework as a whole, because it can also be used in parts. <br><br><img src="https://habrastorage.org/files/b9c/e1d/925/b9ce1d9253aa4d0595a6aedb0157380f.png" alt="Jii" align="left"><h2>  What is Jii? </h2><br>  <a href="http://jiiframework.ru/">Jii</a> is a component MVC JavaScript framework that repeats the architectural solutions of the legendary PHP framework Yii 2, in most cases retaining its API.  Hence the origin of the name Jii - JavaScript Yii. <br><a name="habracut"></a><br><h2>  Installation </h2><br>  Jii and its parts are distributed as npm manager packages.  You can install it with one command: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre><code class="bash hljs">npm install jii jii-model jii-ar-sql</code> </pre> <br>  After installation, you have access to the namespace and Jii class, this is the only entry point to all Jii classes. <br>  The <i>jii</i> package is the basic jii package, which just declares the namespace and the Jii class and returns it.  All other parts of Jii (including <i>jii-ar-sql</i> ) are also put as packages, but they only fill the base namespace. <br><br><div class="spoiler">  <b class="spoiler_title">Spoiler</b> <div class="spoiler_text">  As you can see, in the name of the package there is the letter <i>ar</i> .  Yes, this is Active Record with API from Yii2, it is already written and covered with a bunch of tests.  I will describe it in the following articles.  For now we will consider only its Query Builder. <br></div></div><br>  All the examples that will be described below assume that MySQL, Node.js is installed, and something like this: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> Jii = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'jii-ar-sql'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> db = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Jii.sql.mysql.Connection({ <span class="hljs-attr"><span class="hljs-attr">host</span></span>: <span class="hljs-string"><span class="hljs-string">'127.0.0.1'</span></span>, <span class="hljs-attr"><span class="hljs-attr">database</span></span>: <span class="hljs-string"><span class="hljs-string">'example'</span></span>, <span class="hljs-attr"><span class="hljs-attr">username</span></span>: <span class="hljs-string"><span class="hljs-string">'root'</span></span>, <span class="hljs-attr"><span class="hljs-attr">password</span></span>: <span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-attr"><span class="hljs-attr">charset</span></span>: <span class="hljs-string"><span class="hljs-string">'utf8'</span></span> }); db.open().then(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ (<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Jii.sql.Query()) .from(<span class="hljs-string"><span class="hljs-string">'user'</span></span>) .where({<span class="hljs-attr"><span class="hljs-attr">last_name</span></span>: <span class="hljs-string"><span class="hljs-string">'Smith'</span></span>}) .count(<span class="hljs-string"><span class="hljs-string">'*'</span></span>, db) .then(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">count</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'Records count:'</span></span>, count); db.close(); }); });</code> </pre><br><h1>  Database Access Objects </h1><br>  These objects implement an interface through which you can send queries to the database and receive responses in a specific format.  They are used by query designers and Active Record. <br><br>  Each of the data access objects accesses the DBMS through drivers, which are different for each database.  All of them implement a single API that allows you to change the DBMS. <br><br>  At the moment, the <a href="http://www.mysql.com/">MySQL</a> access object is implemented, which uses the driver package from <br>  npm <a href="https://www.npmjs.com/package/mysql">mysql</a> .  Support for other DBMS is planned and planned in the future. <br><br><h2>  Creating a database connection </h2><br><div style="text-align:center;"><img src="https://habrastorage.org/files/21a/517/e24/21a517e246f54644a8e666414d36f5e2.jpg"></div><br>  To access the database, you must create an instance of the <i>Jii.sql.Connection</i> connection.  Then you need to open the connection to load the database schema and establish a permanent connection. <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> db = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Jii.sql.mysql.Connection({ <span class="hljs-attr"><span class="hljs-attr">host</span></span>: <span class="hljs-string"><span class="hljs-string">'127.0.0.1'</span></span>, <span class="hljs-attr"><span class="hljs-attr">database</span></span>: <span class="hljs-string"><span class="hljs-string">'example'</span></span>, <span class="hljs-attr"><span class="hljs-attr">username</span></span>: <span class="hljs-string"><span class="hljs-string">'root'</span></span>, <span class="hljs-attr"><span class="hljs-attr">password</span></span>: <span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-attr"><span class="hljs-attr">charset</span></span>: <span class="hljs-string"><span class="hljs-string">'utf8'</span></span> }); db.open().then(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// ... });</span></span></code> </pre><br>  If you are creating a Jii application, then it is more convenient to set this connection in the application configuration as a component of the application available via `Jii.app.db`. <br><br><pre> <code class="javascript hljs"><span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports = { <span class="hljs-comment"><span class="hljs-comment">// ... components: { // ... db: { className: 'Jii.sql.mysql.Connection', host: '127.0.0.1', database: 'example', username: 'root', password: '', charset: 'utf8', } }, // ... };</span></span></code> </pre><br><h2>  Execute SQL queries </h2><br>  When you have an instance of connecting to a database, you can execute a SQL query by following these steps: <br><ol><li>  Create an instance of <i>Jii.sql.Command</i> with plain SQL; </li><li>  Add parameters to the request, if necessary; </li><li>  Call one of the <i>Jii.sql.Command</i> methods. </li></ol><br>  Consider a few examples of sample data from the database: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> db = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Jii.sql.mysql.Connection(...); db.open().then(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//   ,       , //    -   ,   -     //  .       . db.createCommand('SELECT * FROM post') .queryAll() .then(function(posts) { }); //  ,     (  ) //  `null`    db.createCommand('SELECT * FROM post WHERE id=1') .queryOne() .then(function(post) { }); //  ,     (  ) //       db.createCommand('SELECT title FROM post') .queryColumn() .then(function(titles) { }); //  . `null`    db.createCommand('SELECT COUNT(*) FROM post') .queryScalar() .then(function(count) { }); });</span></span></code> </pre><br><h3>  Adding Parameters </h3><br>  When creating a command with parameters, you should always add parameters via calls to the `bindValue` or` bindValues` methods to prevent SQL injection attacks.  For example: <br><br><pre> <code class="javascript hljs">db.createCommand(<span class="hljs-string"><span class="hljs-string">'SELECT * FROM post WHERE id=:id AND status=:status'</span></span>) .bindValue(<span class="hljs-string"><span class="hljs-string">':id'</span></span>, request.id) .bindValue(<span class="hljs-string"><span class="hljs-string">':status'</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>) .queryOne() .then(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">post</span></span></span><span class="hljs-function">) </span></span>{ });</code> </pre><br><h3>  Execution of queries not on sampling data </h3><br>  Requests to change data must be performed using the `execute ()` method: <br><br><pre> <code class="javascript hljs">db.createCommand(<span class="hljs-string"><span class="hljs-string">'UPDATE post SET status=1 WHERE id=1'</span></span>) .execute();</code> </pre><br>  The <i>Jii.sql.Command.execute ()</i> method returns an object containing information with the result of the queries.  Each of the access objects can add specific parameters to it, but the minimum set of parameters in it is as follows: <br><ul><li>  `affectedRows` - ‚Äã‚ÄãNumber of affected (changed) rows </li><li>  `insertId` is a unique generated identifier.  Returned for INSERT requests if a PK column has AUTO_INCREMENT. </li></ul><br>  For INSERT, UPDATE and DELETE queries, instead of writing ordinary SQL queries, you can call <br>  <i>Jii.sql.Command.insert ()</i> , <i>Jii.sql.Command.update ()</i> , <i>Jii.sql.Command.delete ()</i> methods for creating <br>  corresponding SQL.  These methods will correctly escape the names of tables, columns, and parameter values. <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// INSERT (table name, column values) db.createCommand().insert('user', { name: 'Sam', age: 30 }).execute().then(function(result) { // result.affectedRows // result.insertId }); // UPDATE (table name, column values, condition) db.createCommand().update('user', {status: 1}, 'age &gt; 30').execute(); // DELETE (table name, condition) db.createCommand().delete('user', 'status = 0').execute();</span></span></code> </pre><br>  You can also call <i>Jii.sql.Command.batchInsert ()</i> to insert multiple lines into one query, this will be more <br>  effective in terms of performance: <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// table name, column names, column values db.createCommand().batchInsert('user', ['name', 'age'], { ['Tom', 30], ['Jane', 20], ['Linda', 25], }).execute();</span></span></code> </pre><br><h2>  Database schema change </h2><br>  Jii DAO provides a set of methods for modifying a database schema: <br><ul><li>  <i>Jii.sql.Command.createTable ()</i> : creating a table </li><li>  <i>Jii.sql.Command.renameTable ()</i> : rename table </li><li>  <i>Jii.sql.Command.dropTable ()</i> : deleting a table </li><li>  <i>Jii.sql.Command.truncateTable ()</i> : deleting all rows from tablitsy </li><li>  <i>Jii.sql.Command.addColumn ()</i> : add a column </li><li>  <i>Jii.sql.Command.renameColumn ()</i> : rename column </li><li>  <i>Jii.sql.Command.dropColumn ()</i> : delete column </li><li>  <i>Jii.sql.Command.alterColumn ()</i> : change column </li><li>  <i>Jii.sql.Command.addPrimaryKey ()</i> : adding a primary key </li><li>  <i>Jii.sql.Command.dropPrimaryKey ()</i> : removing the primary key </li><li>  <i>Jii.sql.Command.addForeignKey ()</i> : adding a foreign key </li><li>  <i>Jii.sql.Command.dropForeignKey ()</i> : deleting a foreign key </li><li>  <i>Jii.sql.Command.createIndex ()</i> : creating an index </li><li>  <i>Jii.sql.Command.dropIndex ()</i> : removing an index </li></ul><br>  An example of using these methods: <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// CREATE TABLE db.createCommand().createTable('post', { id: 'pk', title: 'string', text: 'text' });</span></span></code> </pre><br>  You can also get information about the table through the <i>Jii.sql.Connection.getTableSchema ()</i> method <i>.</i> <br><br><pre> <code class="javascript hljs">table = db.getTableSchema(<span class="hljs-string"><span class="hljs-string">'post'</span></span>);</code> </pre><br>  The method returns a <i>Jii.sql.TableSchema</i> object that contains information about the table columns, primary keys, foreign keys, and so on.  All this data is used mainly in the query designer and Active Record to simplify working with the database. <br><br><h1>  Query Builder </h1><br><div style="text-align:center;"><img src="https://habrastorage.org/files/5ba/f15/1fe/5baf151fe0d34b238b1dbb8d01b71038.jpg"></div><br><br>  Query Designer uses Database Access Objects, which allows you to build SQL queries in JavaScript.  Query Designer improves the readability of SQL code and allows you to generate more secure queries to the database. <br><br>  Using the query designer is divided into 2 stages: <br><ol><li>  Creating an instance of the <i>Jii.sql.Query</i> class to represent various parts of the SQL statement (for example, `SELECT`,` FROM`). </li><li>  Calling methods (for example, `all ()`) on the Jii.sql.Query <i>statement</i> to perform a database query and asynchronous data retrieval. </li></ol><br>  The following code shows the simplest way to use the query designer: <br><br><pre> <code class="javascript hljs">(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Jii.sql.Query()) .select([<span class="hljs-string"><span class="hljs-string">'id'</span></span>, <span class="hljs-string"><span class="hljs-string">'email'</span></span>]) .from(<span class="hljs-string"><span class="hljs-string">'user'</span></span>) .where({<span class="hljs-attr"><span class="hljs-attr">last_name</span></span>: <span class="hljs-string"><span class="hljs-string">'Smith'</span></span>}) .limit(<span class="hljs-number"><span class="hljs-number">10</span></span>) .all() .then(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">rows</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// ... });</span></span></code> </pre><br>  The above code will generate and execute the following SQL code, in which the `: last_name` parameter is associated with the value` `Smith'`. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-string"><span class="hljs-string">`id`</span></span>, <span class="hljs-string"><span class="hljs-string">`email`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> <span class="hljs-string"><span class="hljs-string">`user`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-string"><span class="hljs-string">`last_name`</span></span> = :last_name <span class="hljs-keyword"><span class="hljs-keyword">LIMIT</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span></code> </pre><br><h2>  Making requests </h2><br>  To build a query, you need to call various methods of the <i>Jii.sql.Query</i> object, thereby filling various parts of the SQL command.  Method names are similar to SQL statement names.  For example, to specify `FROM`, you must call the` from () `method.  All methods return the request object itself, which allows you to combine several calls together. <br><br>  Next, we describe the use of each query design method. <br><br><h3>  <i>Jii.sql.Query.select ()</i> </h3><br>  The <i>Jii.sql.Query.select ()</i> method defines the `SELECT` part of an SQL query.  You can specify the columns that <br>  will be selected. <br><br><pre> <code class="javascript hljs">query.select([<span class="hljs-string"><span class="hljs-string">'id'</span></span>, <span class="hljs-string"><span class="hljs-string">'email'</span></span>]); <span class="hljs-comment"><span class="hljs-comment">// : query.select('id, email');</span></span></code> </pre><br>  Column names can include table names and / or column aliases. <br>  For example, <br><br><pre> <code class="javascript hljs">query.select([<span class="hljs-string"><span class="hljs-string">'user.id AS user_id'</span></span>, <span class="hljs-string"><span class="hljs-string">'email'</span></span>]); <span class="hljs-comment"><span class="hljs-comment">// : query.select('user.id AS user_id, email');</span></span></code> </pre><br>  You can pass an object where the keys are column aliases. <br>  For example, the above code can be rewritten as follows: <br><br><pre> <code class="javascript hljs">query.select({<span class="hljs-attr"><span class="hljs-attr">user_id</span></span>: <span class="hljs-string"><span class="hljs-string">'user.id'</span></span>, <span class="hljs-attr"><span class="hljs-attr">email</span></span>: <span class="hljs-string"><span class="hljs-string">'email'</span></span>});</code> </pre><br>  By default (even if you do not call the <i>Jii.sql.Query.select ()</i> method), an asterisk `*` will be generated in the query <br>  to select all columns. <br><br>  In addition to column names, you can also specify SQL expressions.  For example: <br><br><pre> <code class="javascript hljs">query.select([<span class="hljs-string"><span class="hljs-string">"CONCAT(first_name, ' ', last_name) AS full_name"</span></span>, <span class="hljs-string"><span class="hljs-string">'email'</span></span>]);</code> </pre><br>  <i>Sub</i> -queries are also supported, for this you need to pass the <i>Jii.sql.Query</i> object as one of the elements for selection. <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> subQuery = (<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Jii.sql.Query()).select(<span class="hljs-string"><span class="hljs-string">'COUNT(*)'</span></span>).from(<span class="hljs-string"><span class="hljs-string">'user'</span></span>); <span class="hljs-comment"><span class="hljs-comment">// SELECT `id`, (SELECT COUNT(*) FROM `user`) AS `count` FROM `post` var query = (new Jii.sql.Query()).select({id: 'id', count: subQuery}).from('post');</span></span></code> </pre><br>  To add the word `` DISTINCT'` to the SQL query, you need to call the <i>Jii.sql.Query.distinct ()</i> method: <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// SELECT DISTINCT `user_id` ... query.select('user_id').distinct();</span></span></code> </pre><br>  You can also call the <i>Jii.sql.Query.addSelect ()</i> method to add additional columns. <br><br><pre> <code class="javascript hljs">query.select([<span class="hljs-string"><span class="hljs-string">'id'</span></span>, <span class="hljs-string"><span class="hljs-string">'username'</span></span>]) .addSelect([<span class="hljs-string"><span class="hljs-string">'email'</span></span>]);</code> </pre><br><h3>  <i>Jii.sql.Query.from ()</i> </h3><br>  The <i>Jii.sql.Query.from ()</i> method fills the `FROM` fragment from the SQL query.  For example: <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// SELECT * FROM `user` query.from('user');</span></span></code> </pre><br>  Table names may contain prefixes and / or aliases of tables.  For example: <br><br><pre> <code class="javascript hljs">query.from([<span class="hljs-string"><span class="hljs-string">'public.user u'</span></span>, <span class="hljs-string"><span class="hljs-string">'public.post p'</span></span>]); <span class="hljs-comment"><span class="hljs-comment">// : query.from('public.user u, public.post p');</span></span></code> </pre><br>  When transferring an object, the object keys will be aliased tables. <br><br><pre> <code class="javascript hljs">query.from({<span class="hljs-attr"><span class="hljs-attr">u</span></span>: <span class="hljs-string"><span class="hljs-string">'public.user'</span></span>, <span class="hljs-attr"><span class="hljs-attr">p</span></span>: <span class="hljs-string"><span class="hljs-string">'public.post'</span></span>});</code> </pre><br>  In addition, table names can contain subqueries - <i>Jii.sql.Query</i> objects. <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> subQuery = (<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Jii.sql.Query()).select(<span class="hljs-string"><span class="hljs-string">'id'</span></span>).from(<span class="hljs-string"><span class="hljs-string">'user'</span></span>).where(<span class="hljs-string"><span class="hljs-string">'status=1'</span></span>); <span class="hljs-comment"><span class="hljs-comment">// SELECT * FROM (SELECT `id` FROM `user` WHERE status=1) u query.from({u: subQuery});</span></span></code> </pre><br><h3>  <i>Jii.sql.Query.where ()</i> </h3><br>  The <i>Jii.sql.Query.where ()</i> method fills the `WHERE` section in the SQL statement.  You can use several formats for specifying SQL expression conditions: <br><ul><li>  string, `` status = 1'` </li><li>  object, `{status: 1, type: 2}` </li><li>  with the operator, `['like', 'name', 'test']` </li></ul><br><h4>  String format </h4><br>  The string format is very well suited for specifying simple conditions.  The specified string is directly written to the SQL expression. <br><br><pre> <code class="javascript hljs">query.where(<span class="hljs-string"><span class="hljs-string">'status=1'</span></span>); <span class="hljs-comment"><span class="hljs-comment">//     query.where('status=:status', {':status': status});</span></span></code> </pre><br>  You can add parameters to the query through the <i>Jii.sql.Query.params ()</i> or <i>Jii.sql.Query.addParams ()</i> methods. <br><br><pre> <code class="javascript hljs">query.where(<span class="hljs-string"><span class="hljs-string">'status=:status'</span></span>) .addParams({<span class="hljs-string"><span class="hljs-string">':status'</span></span>: status});</code> </pre><br><h4>  Condition as an object (hash) </h4><br>  The object is best used to specify several combined (`AND`) sub-conditions, each of which has <br>  simple equality.  The object keys are the columns, and the values ‚Äã‚Äãare the corresponding values ‚Äã‚Äãpassed to the condition. <br>  For example: <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// ...WHERE (`status` = 10) AND (`type` IS NULL) AND (`id` IN (4, 8, 15)) query.where({ status: 10, type: null, id: [4, 8, 15] });</span></span></code> </pre><br>  The query designer is smart enough to properly handle `NULL` and arrays as values. <br><br>  You can also use subqueries with a hash format: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> userQuery = (<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Jii.sql.Query()).select(<span class="hljs-string"><span class="hljs-string">'id'</span></span>).from(<span class="hljs-string"><span class="hljs-string">'user'</span></span>); <span class="hljs-comment"><span class="hljs-comment">// ...WHERE `id` IN (SELECT `id` FROM `user`) query.where({id: userQuery});</span></span></code> </pre><br><h4>  Format with operator </h4><br>  This format allows you to set arbitrary conditions in software.  The general format is: <br><br><pre> <code class="javascript hljs">[operator, operand1, operand2, ...]</code> </pre><br>  where the operands can be a friend specified in the format of a string, an object, or with an operator.  Operator can be one <br>  of the following: <br><ul><li>  `and`: operands should be combined together using` AND`.  For example, `['and', 'ID = 1', 'ID = 2']` will generate `ID = 1 AND ID = 2`.  If the operand is an array, it will be converted to a string using the rules described here.  For example, `['and', 'type = 1', ['or', 'id = 1', 'id = 2']]` will generate `type = 1 AND (id = 1 OR id = 2)`. <br>  The method does not perform shielding. </li><li>  `or`: is similar to the` AND` operator, except that operands are connected using `OR`. </li><li>  `between`: operand 1 is the name of the column, and operands 2 and 3 are the starting and ending values ‚Äã‚Äãof the range in which the column values ‚Äã‚Äãare located. <br>  For example, `['between', 'ID', 1, 10]` generates the expression `id BETWEEN 1 AND 10`. </li><li>  `not between`: like` between`, but `BETWEEN` is replaced with` NOT BETWEEN` in the generated expression. </li><li>  `IN`: operand 1 must be a column or SQL expression.  The second operand can be either an array or a `Jii.sql.Query` object.  For example, `['in', 'id', [1, 2, 3]]` will generate `id IN (1, 2, 3)`. <br>  The method escapes the name of the column and processes the values ‚Äã‚Äãin the range. <br>  The `IN` operator also supports composite columns.  In this case, operand 1 must be an array of columns, while operand 2 must be an array of arrays or an `Jii.sql.Query` object representing a range of columns. </li><li>  `NOT IN`: is similar to the` IN` operator, except that `IN` is replaced with` NOT IN` in the generated expression. </li><li>  Like Like: The first operand must be a column or SQL expression, and operand 2 is a string or an array representing the values ‚Äã‚Äãto be searched.  For example, `['like', 'name', 'tester']` will generate `name LIKE '% tester%'`. <br>  In the case of specifying an array, several `LIKE` will be generated, combined by the operator` AND`.  For example, `['like', 'name', ['test', 'sample']]] will generate` name LIKE '% test%' AND name LIKE '% sample%' `. </li><li>  `or like`: similar to` like`, but the OR operator is used to join, when an array is passed by the second operand. </li><li>  `not like`: similar to the` like` operator, except that `LIKE` is replaced with` NOT LIKE` in the generated expression. </li><li>  `or not like`: is similar to` not like`, but the OR operator is used to join, when the second operand is passed an array. </li><li>  `exists`: one operand is required, which must be an instance of <i>Jii.sql.Query</i> .  Generates an expression <br>  `EXISTS (sub-query)`. </li><li>  `not exists`: similar to the` exists` operator, generates the expression `NOT EXISTS (sub-query)`. </li><li>  `&gt;`, `&lt;=`, or any other database operator.  The first operand must be the name of a column, and the second must be a value.  For example, `['&gt;', 'age', 10]` will generate `age&gt; 10`. </li></ul><br><h4>  Adding conditions </h4><br>  You can use the <i>Jii.sql.Query.andWhere ()</i> or <i>Jii.sql.Query.orWhere ()</i> methods to add conditions to <br>  existing request.  You can call these methods several times, for example: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> status = <span class="hljs-number"><span class="hljs-number">10</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> search = <span class="hljs-string"><span class="hljs-string">'jii'</span></span>; query.where({<span class="hljs-attr"><span class="hljs-attr">status</span></span>: status}); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (search) { query.andWhere([<span class="hljs-string"><span class="hljs-string">'like'</span></span>, <span class="hljs-string"><span class="hljs-string">'title'</span></span>, search]); }</code> </pre><br>  If `search` is not empty, then the above code will generate the following SQL query: <br><br><pre> <code class="sql hljs">... WHERE (`status` = 10) AND (`title` LIKE '%jii%')</code> </pre><br><h4>  Condition filtering </h4><br>  When building `WHERE` conditions based on user data, it is usually necessary to ignore empty <br>  values.  For example, in a search form that allows you to search by name and email, you need <br>  ignore the field if the user has not entered anything into it.  This can be done using the method <br>  <i>Jii.sql.Query.filterWhere ()</i> : <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//   username  email    query.filterWhere({ username: username, email: email, });</span></span></code> </pre><br>  The differences between <i>Jii.sql.Query.filterWhere ()</i> and <i>Jii.sql.Query.where ()</i> is the first one to ignore <br>  null values <br><blockquote>  A value is considered empty if it is `null`,` false`, an empty array, an empty string, or a string consisting only of spaces. </blockquote><br>  Like the <i>Jii.sql.Query.andWhere ()</i> and <i>Jii.sql.Query.orWhere ()</i> methods, you can use <br>  <i>Jii.sql.Query.andFilterWhere ()</i> and <i>Jii.sql.Query.orFilterWhere ()</i> for adding additional conditions. <br><br><h4>  <i>Jii.sql.Query.orderBy ()</i> </h4><br>  The <i>Jii.sql.Query.orderBy ()</i> method adds the `ORDER BY` part to the SQL query.  For example: <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// ... ORDER BY `id` ASC, `name` DESC query.orderBy({ id: 'asc', name: 'desc', });</span></span></code> </pre><br>  In the above code, the object keys are the column names, and the values ‚Äã‚Äãare the corresponding sort direction. <br><br>  To add sorting conditions, use the <i>Jii.sql.Query.addOrderBy ()</i> method. <br>  For example: <br><br><pre> <code class="javascript hljs">query.orderBy(<span class="hljs-string"><span class="hljs-string">'id ASC'</span></span>) .addOrderBy(<span class="hljs-string"><span class="hljs-string">'name DESC'</span></span>);</code> </pre><br><h3>  <i>Jii.sql.Query.groupBy ()</i> </h3><br>  The <i>Jii.sql.Query.orderBy ()</i> method adds the `GROUP BY` part to the SQL query.  For example, <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// ... GROUP BY `id`, `status` query.groupBy(['id', 'status']);</span></span></code> </pre><br>  If `GROUP BY` only includes simple column names, you can specify it using a string, just like in normal SQL.  For example: <br><br><pre> <code class="javascript hljs">query.groupBy(<span class="hljs-string"><span class="hljs-string">'id, status'</span></span>);</code> </pre><br>  You can use the <i>Jii.sql.Query.addGroupBy ()</i> method to add additional columns to the `GROUP BY` part. <br>  For example: <br><br><pre> <code class="javascript hljs">query.groupBy([<span class="hljs-string"><span class="hljs-string">'id'</span></span>, <span class="hljs-string"><span class="hljs-string">'status'</span></span>]) .addGroupBy(<span class="hljs-string"><span class="hljs-string">'age'</span></span>);</code> </pre><br><h3>  <i>Jii.sql.Query.having ()</i> </h3><br>  The <i>Jii.sql.Query.having ()</i> method defines the `HAVING` part of the SQL expression.  This method works the same as the <i>Jii.sql.Query.where ()</i> method.  For example, <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// ... HAVING `status` = 1 query.having({status: 1});</span></span></code> </pre><br>  Add additional conditions using the <i>Jii.sql.Query.andHaving ()</i> or <i>Jii.sql.Query.orHaving ()</i> methods. <br>  For example: <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// ... HAVING (`status` = 1) AND (`age` &gt; 30) query.having({status: 1}) .andHaving(['&gt;', 'age', 30]);</span></span></code> </pre><br><h3>  <i>Jii.sql.Query.limit ()</i> and <i>Jii.sql.Query.offset ()</i> </h3><br>  The <i>Jii.sql.Query.limit ()</i> and <i>Jii.sql.Query.offset ()</i> methods <i>populate the</i> `LIMIT` and` OFFSET` SQL statements.  For example: <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// ... LIMIT 10 OFFSET 20 query.limit(10).offset(20);</span></span></code> </pre><br>  If you pass incorrect values ‚Äã‚Äãof `limit` and` offset`, they will be ignored. <br><br><h3>  <i>Jii.sql.Query.join ()</i> </h3><br>  The <i>Jii.sql.Query.join ()</i> method fills the `JOIN` part of the SQL expression.  For example: <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// ... LEFT JOIN `post` ON `post`.`user_id` = `user`.`id` query.join('LEFT JOIN', 'post', 'post.user_id = user.id');</span></span></code> </pre><br>  The method has 4 parameters: <br><ul><li>  `type`: type, for example,`  ªINNER JOIN``, `` LEFT JOIN'`. </li><li>  `table`: the name of the table being joined. </li><li>  `on`: (optional) condition, part of the` ON` SQL expression.  The syntax is similar to the <i>Jii.sql.Query.where ()</i> method. </li><li>  `params`: (optional), condition parameters (` ON` part). </li></ul><br>  You can use the following methods to specify `INNER JOIN`,` LEFT JOIN` and `RIGHT JOIN` respectively. <br><ul><li>  <i>Jii.sql.Query.innerJoin ()</i> </li><li>  <i>Jii.sql.Query.leftJoin ()</i> </li><li>  <i>Jii.sql.Query.rightJoin ()</i> </li></ul><br>  For example, <br><br><pre> <code class="javascript hljs">query.leftJoin(<span class="hljs-string"><span class="hljs-string">'post'</span></span>, <span class="hljs-string"><span class="hljs-string">'post.user_id = user.id'</span></span>);</code> </pre><br>  To join multiple columns, you need to call the `join` methods several times. <br><br>  In addition, you can attach sub-requests.  In this case, you need to pass an object, where the key will be an alias of the join request.  For example: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> subQuery = (<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Jii.sql.Query()).from(<span class="hljs-string"><span class="hljs-string">'post'</span></span>); query.leftJoin({<span class="hljs-attr"><span class="hljs-attr">u</span></span>: subQuery}, <span class="hljs-string"><span class="hljs-string">'u.id = author_id'</span></span>);</code> </pre><br><h3>  <i>Jii.sql.Query.union ()</i> </h3><br>  The <i>Jii.sql.Query.union ()</i> method fills in the `UNION` part of the SQL query.  For example, <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> query1 = (<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Jii.sql.Query()) .select(<span class="hljs-string"><span class="hljs-string">'id, category_id AS type, name'</span></span>) .from(<span class="hljs-string"><span class="hljs-string">'post'</span></span>) .limit(<span class="hljs-number"><span class="hljs-number">10</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> query2 = (<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Jii.sql.Query()) .select(<span class="hljs-string"><span class="hljs-string">'id, type, name'</span></span>) .from(<span class="hljs-string"><span class="hljs-string">'user'</span></span>) .limit(<span class="hljs-number"><span class="hljs-number">10</span></span>); query1.union(query2);</code> </pre><br>  You can call this method several times to add several `UNION` fragments. <br><br><h3>  Query methods </h3><br>  The <i>Jii.sql.Query</i> class provides a whole range of methods for various query results: <br><ul><li>  <i>Jii.sql.Query.all ()</i> : returns an array of objects, where the keys are the names of the columns. </li><li>  <i>Jii.sql.Query.one ()</i> : returns the first result of the query - the object corresponding to the found string. </li><li>  <i>Jii.sql.Query.column ()</i> : returns an array corresponding to the values ‚Äã‚Äãin the first column of the query result. </li><li>  <i>Jii.sql.Query.scalar ()</i> : returns a scalar value located in the first cell of the result. </li><li>  <i>Jii.sql.Query.exists ()</i> : returns a boolean indicating whether the query contains any result. </li><li>  <i>Jii.sql.Query.count ()</i> : returns the number of rows found. </li><li>  Other query aggregation methods, including <i>Jii.sql.Query.sum (q)</i> , <i>Jii.sql.Query.average (q)</i> , <br>  <i>Jii.sql.Query.max (q)</i> , <i>Jii.sql.Query.min (q)</i> .  The q parameter is required for these methods. <br>  and can be either a column name or an SQL expression. </li></ul><br>  All of these methods return an instance of `Promise` for handling an asynchronous response. <br><br>  For example: <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// SELECT `id`, `email` FROM `user` (new Jii.sql.Query()) .select(['id', 'email']) .from('user') .all().then(function(rows) { // ... }); // SELECT * FROM `user` WHERE `username` LIKE `%test%` (new Jii.sql.Query()) .from('user') .where(['like', 'username', 'test']) .one().then(function(row) { // ... });</span></span></code> </pre><br>  All of these methods accept the optional `db` parameter representing <i>Jii.sql.Connection</i> .  If this parameter is not <br>  set, the application component `db` will be used to connect to the database.  Below is another example of using the `count ()` method: <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// executes SQL: SELECT COUNT(*) FROM `user` WHERE `last_name`=:last_name (new Jii.sql.Query()) .from('user') .where({last_name: 'Smith'}) .count() .then(function(count) { // ... })</span></span></code> </pre><br><h3>  Indexes in the query results </h3><br>  When you call <i>Jii.sql.Query.all ()</i> , it returns an array of strings, which are indexed by consecutive integers.  But you can index them differently, for example, specific values ‚Äã‚Äãof a column or expression using the <i>Jii.sql.Query.indexBy ()</i> method called before the <i>Jii.sql.Query.all ()</i> method.  In this case, the object will be returned. <br>  For example: <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// returns {100: {id: 100, username: '...', ...}, 101: {...}, 103: {...}, ...} var query = (new Jii.sql.Query()) .from('user') .limit(10) .indexBy('id') .all();</span></span></code> </pre><br>  To specify complex indexes, you can pass an anonymous function to the <i>Jii.sql.Query.indexBy ()</i> method: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> query = (<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Jii.sql.Query()) .from(<span class="hljs-string"><span class="hljs-string">'user'</span></span>) .indexBy(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">row</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> row.id + row.username; }).all();</code> </pre><br>  The anonymous function takes the `row` parameter which contains the data of the current row and should return a row or a number that will be used as an index value (object key) for the current row. <br><br><h1>  At the end </h1><br><img src="https://habrastorage.org/files/b82/88f/df2/b8288fdf202e42589c32482f60bcd6f7.jpg"><br><br>  Jii is an open source project, so I will be very happy if someone joins the development of Jii.   affka@affka.ru. <br>  Jii           Active Record. <br><br><div class="spoiler"> <b class="spoiler_title">  </b> <div class="spoiler_text"><ul><li> <a href="http://habrahabr.ru/post/266929/">Jii:   </a> </li><li>  <a href="http://habrahabr.ru/post/260931/">Jii - a JavaScript framework with architecture from Yii 2</a> </li><li> <a href="http://habrahabr.ru/post/260569/">Jii: Active Record  Node.js  API  Yii 2</a> </li><li> <a href="http://habrahabr.ru/post/260295/">Jii:  Query Builder  Node.js  API  Yii 2</a> </li></ul></div></div></div><p>Source: <a href="https://habr.com/ru/post/260295/">https://habr.com/ru/post/260295/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../260279/index.html">Do we really need start-ups for large corporations</a></li>
<li><a href="../260285/index.html">Analysis of the tasks of the qualifying round of RCC 2015</a></li>
<li><a href="../260287/index.html">Are you ready to complain?</a></li>
<li><a href="../260289/index.html">LabVIEW Programming Contest. The decision of the winning team</a></li>
<li><a href="../260291/index.html">Examples of using MongoDB in e-commerce (part 2)</a></li>
<li><a href="../260297/index.html">Accelerate MySQL insert / update 5-10 times</a></li>
<li><a href="../260301/index.html">Buying in the online store: work on the bugs</a></li>
<li><a href="../260303/index.html">The hijacking of Telecom Malaysia trunk provider noticeably worsened global routing last Friday.</a></li>
<li><a href="../260309/index.html">New panels and connections for Kubotronika</a></li>
<li><a href="../260311/index.html">Using git capabilities in the modular project build system</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>