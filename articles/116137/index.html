<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>New cloud storage system</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Just a couple of days ago, we put into operation a new storage system, the creation of which worked the last six months. Before telling you what is ne...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>New cloud storage system</h1><div class="post__text post__text-html js-mediator-article"> Just a couple of days ago, we put into operation a new storage system, the creation of which worked the last six months.  Before telling you what is new in it, I will tell you about the history of its development. <br><br>  It should be immediately noted that the storage system is the cornerstone in the device of cloud hosting.  There are two mandatory storage requirements.  First, it must be networked so that users' virtual machines can move freely between compute nodes.  Secondly, it must be productive for parallel operations, since it is simultaneously used by a large number of clients. <br><a name="habracut"></a><br>  At the time when we designed the system, and it was 2007, there were 3 main technologies on the market for organizing network storage: iSCSI on 1/10 Gbps Ethernet, Fibre Channel 4 Gbps and Infiniband 40 Gbps.  After conducting research, including on price characteristics, we chose the latest option with Infiniband.  This allowed us to use one network fabric for both storage and IP data transfer.  At first glance, this seems strange, as many are accustomed to think of Infiniband as a very expensive exotic technology from the world of supercomputers.  But a simple price comparison shows that in this case, Infiniband is very economical. <br><br>  Thus, we are likely to become the first company in the history of the world hosting, who used Infiniband.  Now, besides us, some of these are <a href="http://www.logicworks.net/cloud">American</a> and savvy Russian hosting companies, as well as some data centers for their internal needs. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Regarding the repositories themselves, we did not find a single ready-made productive solution capable of working with Infiniband;  Something was in <a href="http://lsi.com/">LSI</a> and <a href="http://ddn.com/">DDN</a> , but in a very raw form.  Once again, having considered the cost of iSCSI and FC-based fault-tolerant solutions, we realized that at the resulting price, no one would buy them. <br><br>  At that moment, <a href="http://shmuma.ru/">Maxim Lapan</a> , who had experience with the commercial product of IBM - the cluster file system GPFS, joined our company.  It turned out that GPFS can work directly with Infiniband, making the most of all its capabilities, and has all the tools for backing up.  So the first version of the Scalaxi cloud storage system was created.  We used raid10 on GPFS nodes and double redundancy of the nodes themselves.  The virtual machine disk images were in the form of regular files on GPFS. <br><br>  However, during the operation, it turned out that GPFS solves our problems extremely badly.  First, frequent crashes during cluster configuration (adding new nodes, etc.).  Colleagues who have followed our path now face various <a href="http://habrahabr.ru/company/clodo/blog/115478/">problems</a> .  Secondly, low performance: GPFS was originally designed to work consistently with large pieces of data, for example, to stream video files, and not to work with images of user disks, where random access to small blocks comes to the fore. <br><br>  We began to think about the problem, to try different solutions.  At the same time, I really wanted to get away from proprietary and unpredictable technologies.  Stumbled upon <a href="http://sourceforge.net/apps/mediawiki/vastsky/index.php%3Ftitle%3DMain_Page">VastSky</a> , a development by VA Linux Systems.  Its architecture was very similar to what we were moving to - using the <a href="http://sourceware.org/dm/">device-mapper</a> driver to work with custom images.  LVM also works on the basis of this driver and is essentially its management utility.  However, VastSky is not yet ready for use in production systems. <br><br>  However, this concept has convinced us that we are on the right path.  As a result, a new version of the storage system was developed.  Here is its scheme: <br><br><img src="http://www.oversun.ru/i/ibraidschemeforhabr.png" alt="image"><br><br>  There are three types of servers in our cloud: <br><br>  VRT (ViRTualization) - diskless virtualization servers running client virtual machines. <br>  IBRP (IB Raid Proxy) are storage proxy servers whose task is to maintain raids. <br>  IBRN (IB Raid Node) - storage system nodes that contain disks and caches. <br><br>  Photo stand with IBRN front: <br><br><img src="http://www.oversun.ru/i/ibraid_front.jpg" alt="image"><br><br>  Behind: <br><br><img src="http://www.oversun.ru/i/ibraid_back.jpg" alt="image"><br><br>  Photo of Infiniband switch: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/2ed/1aa/756/2ed1aa7569cc4f280d2fe45e50c77e6b.jpg" alt="image"><br><br>  It all works as follows: <br><br>  - IBRN export their drives via Infiniband <a href="http://en.wikipedia.org/wiki/SCSI_RDMA_Protocol">SRP</a> (SRP - SCSI over RDMA Protocol) using the <a href="http://scst.sourceforge.net/">SCST</a> driver with caching, the fastest open source SCSI driver.  SCST is generally a good thing, the same Maxim Lapan advised us;  develop it Russian guys.  It allows you to make an enterprise storage from any Linux box. <br>  - IBRPs get disks from IBRN, for each IBRN pair they collect raid10 using md, whose code we carefully checked for performance under competitive conditions, create an LV group on this raid and export it again via SCST without caching. <br>  - VRTs get disks from all IBRPs, the multipath driver creates a round-robin group of them, thus distributing the load across all IBRPs. <br>  - When creating a new disk on one of the IBRPs, the lvcreate command is executed, the device-mapper table for the created volume is remembered, the device is created on the VRT via the device-mapper and sent to Xen. <br>  - I / O write operations from the client virtual machine reach IBRP, get into md, md makes a record on both IBRNs and only after that returns the answer that the operation was successful.  Thus, if any I / O node drops, the operation in the client machine will be processed correctly. <br><br>  At first glance, it seems that there are a lot of levels and they will reduce performance.  But this is not the case; the Infiniband bus speed exceeds the SAS speed, and the whole design works at least no slower than local drives, and using 96 GB caches, exceeds them several times. <br><br>  Next, we have compiled a list of test scenarios for testing this system for fault tolerance and conducted them many times; <br><br>  1. IBRN freeze or power drop. <br><br>  Tests passed successfully.  For some time, I / O on client machines is frozen until the timeout of the disks on the IBRP is working.  Further md on IBRP disconnects disks of fallen IBRN and continues work.  After the restoration of the IBRN, the md synchronization is successful within 24 hours. <br><br>  2. Stop IBRN unloading SCST driver. <br><br>  Tests passed successfully.  The course of events is similar to the previous test, but without a timeout. <br><br>  3. IBRP freeze or power drop. <br><br>  Tests successfully passed.  The SRP session is terminated by timeout, and the multipath on the VRT deletes the path.  On client machines, all I / O is frozen for the duration of the multipath timeout. <br><br>  4. Stop IBRP unloading SCST driver. <br><br>  Tests successfully passed.  After the SCST is unloaded, the SRP session is properly broken, and the multipath on the VRT immediately marks the path as failed.  For clients, everything looks transparent and without timeouts. <br><br>  5. Failed disk in IBRN (pull out the disk on the hot). <br><br>  Tests successfully passed.  The disk disappears in IBRN, errors fall out, errors also happen on IBRP, and md constantly redirects to the mirror.  After inserting the disk back, the md synchronization is successful within 24 hours. <br><br>  6. Restart the Infiniband <a href="http://mellanox.com/content/pages.php%3Fpg%3Dproducts_dyn%26product_family%3D98%26menu_section%3D49">switch</a> . <br><br>  Tests successfully passed.  The switch was turned off on power for a couple of seconds and turned back on.  When rebooting, it was observed: a fall and a raise of IB links, a break and restore SRP sessions, a temporary drop in multipathd paths on VRT.  Client I / O is frozen during reboot. <br><br>  7. Simultaneous drop in IBRP and IBRN. <br><br>  Tests successfully passed. <br><br>  8. Simultaneous stopping of an IBRN pair by unloading SCST drivers. <br><br>  Tests successfully passed.  During the test, the IBRN pair was stopped, rebooted and put back into operation.  All this time, I / O client machines were frozen, after the end of the test, all client machines were frozen, I / O operations were resumed.  Conclusion - a simultaneous stop of an IBRN pair can be made to maintain the physical IBRN servers in a regular window (from 2 am to 6 am). <br><br>  Recall that all servers of the storage system are located in our data center <a href="http://www.oversunmercury.ru/">Oversan-Mercury</a> , each rack has two power supplies from independent inputs, this is additionally reserved by the UPS and diesel generators.  Thus, in order to drop such a storage, you need to block (for example, riot police) the supply of diesel fuel to the DC and de-energize all of Moscow for a week. <br><br>  The performance of the new storage system is truly colossal, we managed to get more than 120,000 IOPS per record from the IBRN pair.  But we will tell about it in one of the following posts, having conducted a comparative analysis of the performance of disk subsystems of various Russian and foreign cloud hosting sites. <br><br>  Those who already want to check the new storage system can <a href="http://wiki.scalaxy.ru/pages/viewpage.action%3FpageId%3D4554781">clone</a> their existing servers (all new disks are created on the new system), or wait until next week when we will complete the final migration.  Those who do not have servers in Skalaxi, it's time to start them, <a href="http://scalaxy.ru/">150 rubles</a> are available for registration when testing. </div><p>Source: <a href="https://habr.com/ru/post/116137/">https://habr.com/ru/post/116137/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../116124/index.html">node-sync - pseudo-synchronous programming on nodejs using fibers</a></li>
<li><a href="../116126/index.html">"An open letter of Russian and Russian-speaking writers" to President Medvedev about the need to stop the "pirated" distribution of the texts of books</a></li>
<li><a href="../116128/index.html">The fragility of free</a></li>
<li><a href="../116130/index.html">Sqrt-decomposition</a></li>
<li><a href="../116134/index.html">Most internet projects are fast food.</a></li>
<li><a href="../116138/index.html">Color.com as a bubble proof</a></li>
<li><a href="../116139/index.html">Twice two = 3DMark Vantage record</a></li>
<li><a href="../116140/index.html">Maintaining periodic information in information systems</a></li>
<li><a href="../116142/index.html">Accelerate Website Database</a></li>
<li><a href="../116145/index.html">Property again</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>