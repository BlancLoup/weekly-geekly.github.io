<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Cache it: increase the stability of the ONLYOFFICE server with Redis</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The main task that we set for ourselves when working on ONLYOFFICE Enterprise Edition was to increase stability. Mono helped us a lot when designing a...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Cache it: increase the stability of the ONLYOFFICE server with Redis</h1><div class="post__text post__text-html js-mediator-article">  The main task that we set for ourselves when working on ONLYOFFICE Enterprise Edition was to increase stability.  Mono helped us a lot when designing an office for Linux (we have already written a little about this), but at the same time caused us a lot of concern.  It was with him was connected with such a problem as the fall of http web servers. <br><br>  The situation, of course, is not the most pleasant, so we decided to err and run not one server, but two.  In normal mode, they work in parallel, and when problems begin, they insure each other: one falls, the other, respectively, takes all the responsibility for what is happening.  But there was a problem with the synchronization of server caches, to solve which we needed Redis. <br><br>  Next, we will talk a little about how we started working with Redis and what came of it. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/files/d99/5ce/dbf/d995cedbf583440abd5c2f25b9db92b6.png"><br><a name="habracut"></a><br><h1>  How things are arranged </h1><br><br>  Let's start from the beginning: ONLYOFFICE runs on the nginx http-server and the fastcgi-mono-server4 module for running .net applications. <br><br>  For load balancing, we use the nginx ngx_stream_upstream_module module, which is configured using the upstream and fastcgi_pass directives as follows: <br><br><pre><code class="nginx hljs"><span class="hljs-attribute"><span class="hljs-attribute">upstream</span></span> fastcgi_backend { <span class="hljs-attribute"><span class="hljs-attribute">server</span></span> <span class="hljs-number"><span class="hljs-number">127.0.0.1:9000</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">server</span></span> <span class="hljs-number"><span class="hljs-number">127.0.0.1:9001</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">keepalive</span></span> <span class="hljs-number"><span class="hljs-number">64</span></span>; } <span class="hljs-section"><span class="hljs-section">server</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">listen</span></span> <span class="hljs-number"><span class="hljs-number">80</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">location</span></span> / { ... <span class="hljs-attribute"><span class="hljs-attribute">fastcgi_pass</span></span> fastcgi_backend; ...</code> </pre> <br>  That is: two fastcgi-mono-server4 servers at the addresses 127.0.0.1:9000 and 127.0.0.1:9001 and nginx (thanks to him!) Are simultaneously starting up to balance the load. <br><br>  In this case, all incoming requests are distributed equally between the two servers: the first request is sent to the first server, the second request to the second server, the third - again to the first server, etc. <br><br>  To speed up the work used caching.  In the cache, we carefully store the most frequently used data.  These include, for example, users, groups, user group membership relationships, access rights, portals lists, alert subscriptions, billing information and quotas, settings, and much more. <br><br><h1>  Now the problem </h1><br><br>  As we mentioned above, nginx distributes requests in a circle to different servers.  This and the fact that in our free version there is no possibility to stick a session to a specific ip-address (user), led to numerous errors due to the mismatch of caches. <br><br>  For example, the user decided to start everything from a clean slate and change his name on the portal.  The change request came to the first server, where a new name of our hero was saved in the database.  Information about the event has also been located in the cache of the first server.  That is, when the next request comes to the second server, it turns out that he is simply not aware of the changes.  The user will again see his old name and realize that the new life has not begun.  And all this is due to the fact that the information in the cache of the second server has not been changed.  The update, of course, will happen and the second server will know everything, but only after a few minutes after the cache is synchronized with the data from the database. <br><br><h1>  And here he is, Redis </h1><br><br>  Actually, to solve this problem, we decided to use the Redis project, which acted as a common cache for our ONLYOFFICE servers.  Here, of course, there were some difficulties too.  Further we will tell what and how we overcame them. <br><br><h1>  Main difficulties </h1><br><br>  <u>Issue with StackExchange.Redis Nuget Package</u> <br><br>  <b>What was wrong</b> : The Nuget-package StackExchange.Redis we chose to work with Redis refused to cooperate with Mono.  After installing it, we successfully launched the .net application.  Under Mono, there was a constant error: <br><br>  It was not possible to connect to the redis server (s);  to create a disconnected multiplexer, disable AbortOnConnectFail.  SocketFailure on PING <br><br>  <b>As they decided</b> : everything is simple.  Collected StackExchange.Redis.dll from source under Mono. <br><br>  <u>Increase page response time</u> <br><br>  <b>What was wrong</b> : Pages with a large number of cache accesses (everything related to user lists, groups and access rights), as well as pages where cached data occupy a significant amount (a list of all portals), became less responsive to our requests.  Still, their data is stored in the memory of another process or even on another physical machine, and access to it is through network sockets, which is much slower than accessing the memory of its process. <br><br>  <b>As decided</b> : On critical for the number of hits and the size of these areas, local caches, as before, remained, however we screwed a small warning system there. <br><br>  We added code to all methods for changing data cached by this algorithm, which sent information about changed data using the mechanism of publish / subscribe redis.  Further, all servers that received the alert synchronized the specified objects with the database. <br><br>  <u>The problem with long operations</u> <br><br>  <b>What was wrong</b> : When a user initiates a file operation, a task is created that is queued.  Then, any thread freed from the previous task starts its execution.  The number of threads is limited from above to avoid overloading the server with file operations (this functionality was implemented based on a specialized version of TaskScheduler). <br><br>  During the execution of file tasks, the user is shown the progress of the progress, and upon completion of the task, information about success or error is displayed.  This is implemented using periodic polling of the status of file operations through the API module of documents, with all the information about the progress of the operation stored in the local cache of the process.  But when several ONLYOFFICE servers were started, some of the requests for the status of operations were sent to the server other than the one on which the current file operation was running.  This led to errors in displaying the status of operations for the user (tasks suddenly appeared, then disappeared). <br><br>  <b>As decided</b> : We have created a distributed task manager.  It stores the status of running tasks in Redis, limits the number of worker threads, synchronizes the status of tasks between servers and removes completely hopelessly hung ones. <br><br>  By the way, we took the standard System.Threading.Tasks tasks from Microsoft .NET 4.0 as a basis. <br><br>  <u>Problem with session providers</u> <br><br>  <b>What was wrong</b> : We also decided to render sessions in Redis and chose the native session provider for Redis from Microsoft RedisSessionStateProvider for this.  Actually, it is used and maintained by Microsoft for the Azure platform, so you can put it on your server, but only at your own peril and risk.  As it turned out, it works fine under Windows.  But not with Mono: problems with stable work immediately arose, with a small load, the provider fell from a NullReferenceException.  It was decided to try a third-party provider.  But here the same NullReferenceException occurred. <br><br>  <b>As decided</b> : We started to understand the internal structure of session providers and how their processing in ASP.NET under .NET differs from Mono.  It turned out that if the request comes without cookies, then the session id in the version for Mono will be null, and the providers do not expect such a dirty trick.  We wrote a pull-request with the addition of checking the session id to null. <br><br>  Of the two session providers, third-party seemed to us faster and more lightweight, so we chose it.  To connect it, it was necessary to replace it with a standard provider in Web.config. <br><br><pre> <code class="bash hljs">&lt;sessionState mode=<span class="hljs-string"><span class="hljs-string">"Custom"</span></span> customProvider=<span class="hljs-string"><span class="hljs-string">"RedisSessionStateProvider"</span></span>&gt; &lt;providers&gt; &lt;add name=<span class="hljs-string"><span class="hljs-string">"RedisSessionStateProvider"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=<span class="hljs-string"><span class="hljs-string">"RedisSessionProvider.RedisSessionStateStoreProvider, RedisSessionProvider"</span></span> /&gt; &lt;/providers&gt; &lt;/sessionState&gt;</code> </pre><br>  In addition, it was necessary to add some code at the start of the application: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> configuration = RedisCachingSectionHandler.GetConfig(); RedisConnectionConfig.GetSERedisServerConfig = (HttpContextBase context) =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (configuration.RedisHosts != <span class="hljs-literal"><span class="hljs-literal">null</span></span> &amp;&amp; configuration.RedisHosts.Count &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> host = configuration.RedisHosts[<span class="hljs-number"><span class="hljs-number">0</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> KeyValuePair&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, ConfigurationOptions&gt;(<span class="hljs-string"><span class="hljs-string">"DefaultConnection"</span></span>, ConfigurationOptions.Parse(String.Concat(host.Host, <span class="hljs-string"><span class="hljs-string">":"</span></span>, host.CachePort))); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> KeyValuePair&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, ConfigurationOptions&gt;(); };</code> </pre><br><h1>  Results </h1><br><br>  Here we just briefly say that we are satisfied with the work done and its results.  Thanks to Redis, we managed to increase both server resiliency and its scalability, which is simply vital for the corporate server version, which implies a large (moreover, constantly growing) number of users. <br><br>  Plans to replace Mono with a new cross-platform version of ASP.Net.  While we are looking at each other. </div><p>Source: <a href="https://habr.com/ru/post/276395/">https://habr.com/ru/post/276395/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../276383/index.html">Habra graph, community and where did all the karma go</a></li>
<li><a href="../276385/index.html">Hyper-scale server farm Amazon, Apple, Google, Switch, Toyota</a></li>
<li><a href="../276389/index.html">Telegram bot framework</a></li>
<li><a href="../276391/index.html">MonCach√© - implementation of the MongoDB API based on InterSystems Cach√©</a></li>
<li><a href="../276393/index.html">Smart babysitter based on Intel Edison and Ubidots</a></li>
<li><a href="../276397/index.html">What is the future of email: Opinions of the creator of Wikipedia, engineers and entrepreneurs from Silicon Valley</a></li>
<li><a href="../276399/index.html">What experts in Data Science and Big Data are discussing today</a></li>
<li><a href="../276401/index.html">The book "Hello World! Entertaining programming ¬ª</a></li>
<li><a href="../276403/index.html">Moira: Realtime Alerting</a></li>
<li><a href="../276407/index.html">Parse Server Migration Guide for Developers</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>