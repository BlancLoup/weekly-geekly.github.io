<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>DIY Epilepsy Attack Detector</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="My friend has some incomprehensible health problems. Doctors say that this is "cryptogenic epilepsy." The bottom line is that sometimes he has an atta...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>DIY Epilepsy Attack Detector</h1><div class="post__text post__text-html js-mediator-article">  My friend has some incomprehensible health problems.  Doctors say that this is "cryptogenic epilepsy."  The bottom line is that sometimes he has an attack of "shaking" at night in a dream.  As a result, I was asked to make a device that should be put on my hand and squeaky if you shake it for ten seconds to notify your loved ones and help you in a timely manner. <br><br>  The most obvious solution is to use an accelerometer.  I bought one of the first available - BMA150 from Bosch. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/7a0/f1f/85e/7a0f1f85ebfbeb80ed201b7ee97b1fbd.jpg" alt="image">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <a name="habracut"></a><br>  Small, contagion, only 3x3mm, but we were not so soldered. <br><br>  I‚Äôll say at once that I‚Äôm doing this exclusively at the amateur level, so don‚Äôt criticize much. <br><br>  After reading the datasheet, it turned out that I¬≤C or SPI can communicate with the accelerometer, but he also has a special conclusion for external interruption.  Those.  you can configure it once so that under certain conditions it displays a logical unit there.  In our case, this is ideal - it is not necessary to constantly interrogate the sensor, it will take the microcontroller out of sleep mode if there is a certain amount of shaking.  This is very important, given that you need to make the device as economical as possible in terms of power. <br><br><h4>  Accelerometer Setup </h4><br>  For experimentation and tuning, I etched the board so that you can easily solder: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/061/2e3/e36/0612e3e3621014d764d151d9ffae956f.jpg"><br><br>  For some reason, the accelerometer did not want to work on I¬≤C.  It is possible that I was mistaken somewhere.  But on SPI it all worked without problems.  The sensor is available as an array of memory, which is divided into two parts: <br><br><ul><li>  EEPROM with default settings, i.e.  which are used at the time of inclusion </li><li>  Operational registers with current settings and sensor readings themselves </li></ul><br><br>  My joy knew no bounds when I finally received the data: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/25a/531/78c/25a53178c6e487ccce6a00a31959e23e.png"><br><br>  The accelerometer can automatically generate an external interrupt in a variety of cases.  We need the simplest event - any sufficiently strong movement.  The sensor does this if the following condition is true for any of the axes: <br><br> <code>|acc(t0)-acc(t0+3/(2*bandwidth))| &gt;= any_motion_thres</code> <br> <br>  <b>any_motion_thres</b> is set in a special register.  Experienced, I found out that at a refresh rate of 25 Hz, the optimal value is 20h.  In this scenario, the interrupt flag is set if it is easy to shake the sensor.  The flag is automatically removed if the condition stops being fulfilled for some time. <br><br>  Making sure that all parameters are set optimally, I saved these settings already in the EEPROM.  Thus, an accelerometer immediately after switching on will output a logical unit to INT, if there is movement, and SPI is no longer needed. <br><br><h4>  Board development </h4><br>  I chose the ATMEGA8A microcontroller.  It has two external interrupts (I decided to use one for the button, and the other for the accelerometer itself), works in the 2.7‚Äì5.5V voltage range, and in the deepest sleep mode ‚Äúpower down‚Äù consumes only 0.5 ¬µA.  It is assumed that the microcontroller will sleep almost all the time, because energy saving is very important.  However, to wake up from such a sleep mode, you need to close the INT0 / INT1 foot to the ground, and the accelerometer, if there is motion, on the contrary gives a high level, therefore, to invert, you need to put a transistor.  I decided to feed the sensor directly from the legs of the microcontroller itself so that it could be switched on and off without unnecessary losses.  The speaker also connected directly.  For debugging, it was decided to put one more LED.  I did not draw the scheme, and the board in the end looked like this: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/46f/c98/f7a/46fc98f7a934a1517bbfcc19ec81b874.png"><br><br>  Ready fee: <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/cf1/6bc/19d/cf16bc19d3ffb0fd240bfca726b9b671.jpg"></a> <br><br>  Alas, I only had a squeaker, which turned out to be more than the board itself: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/4b1/fbe/1c1/4b1fbe1c1bae5a04b19eecb105165d4e.jpg"><br><br><h4>  Firmware </h4><br>  It's all quite simple.  The device has two modes of operation: <br><br><ul><li>  Off  In this state, we do not power on the accelerometer and wake up only by pressing a button.  In this form, the microcontroller can work for at least a year (checked), the discharge of the battery is close to self-discharge. </li><li>  Included.  When the device is turned on, we power the accelerometer and wake up both from the touch of a button and from the signal from the sensor.  If the button is held for one and a half seconds, the device goes back to the off state.  If the interruption generated a signal from the sensor, and it repeats within 10 seconds at least once in two seconds, then let us sound the alarm until the button is pressed. </li></ul><br><br>  The accelerometer, by the way, also has a sleep mode, from which it can wake up at specified intervals, but I decided not to use it in order not to affect the accuracy and reliability.  According to the documentation, this sensor consumes 200 ŒºA, this should be enough for many nights. <br><br><h4>  Body creation </h4><br>  The body was decided to print on a 3D printer. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/477/c2e/71e/477c2e71e82c6f0d52b89fd66a836ede.png"><br><br>  As a result, everything inside looked like this: <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/66c/947/c75/66c947c7599d74287720f9c0a47a0fba.jpg"></a> <br><br>  Alas, in the end, the device turned out very cumbersome and collective farm: <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/ee3/326/e8e/ee3326e8ef6a72449f27a2a518b8f466.jpg"></a> <br><br>  But this is still the first experimental sample.  I think that later the dimensions and appearance can be greatly optimized.  Well, do not forget that even in this form it can save a person's life. <br><br>  Video devices in operation: <br><iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/Na79GRWbc3I%3Ffeature%3Doembed&amp;xid=17259,15700022,15700186,15700190,15700253&amp;usg=ALkJrhiEbaQ0dyIeiJy1_Jge7ucH3EVz7w" frameborder="0" allowfullscreen=""></iframe><br>  Sorry for dirty fingers, they are still in plastic and ferric chloride. <br><br>  I foresee certain questions, I will answer them immediately: <br><br><ul><li>  Yes, this man‚Äôs seizures are only in a dream </li><li>  Yes, all attacks are accompanied by shaking. </li><li>  The button is recessed, so it is difficult to turn off the device by accident </li></ul><br><br><h4>  Update 07/07/2014 </h4><br>  As I promised, I could not stop at the first version, especially in the end I was asked to reduce the response time and increase the sensitivity. <br><br>  Alas, the BMA150 accelerometers were no longer in the store, but there was a BMA250.  A quick glance at the datasheet showed that it is even much cooler.  True, even less: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/e60/574/5f4/e605745f43ca0731c1d4009b1c079802.jpg"><br><br>  Two to two millimeters, with 12 contacts.  However, problems with the size and this time did not arise.  It is rather even a plus. <br><br>  This model has a number of very nice settings.  And the polarity of the interruption can be specified (goodbye, additional transistor), and their duration, and much more.  Yes, it's just great!  I was already very happy when I selected the optimal parameters of all the registers, but all the joy disappeared when I realized that the BMA250 does not have the ability to save these settings in the EEPROM.  This is such a spoon of tar in a barrel of honey that I could not believe it for a long time. <br><br>  I had to dissolve on the board and SPI to the accelerometer, so that every time you turn it on, you need to configure it again. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/e29/e87/018/e29e870187b82a77671b109f0fecbc09.jpg"><br><br>  But if you have to change some of the settings, it will not need to be unsoldered.  And yes, I listened to the advice in the comments and took advantage of the small piezo squeaker, the battery is placed under the board, as a result, the device has greatly decreased in size.  Even when turned on, the voltage on the battery is now measured, and if it is below 2.8V, an additional signal is issued.  For this, an ADC with an internal stabilizer of 2.56V and a voltage divider is used to fit into this range. <br><br>  In the case: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/6ec/3a8/b56/6ec3a8b567182bae95676e7a55899c34.jpg"><br><br>  And in closed form: <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/bcd/3f3/f89/bcd3f3f8905a06d6307b4abd9aa34223.jpg"></a> </div><p>Source: <a href="https://habr.com/ru/post/227473/">https://habr.com/ru/post/227473/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../227453/index.html">How to find out the real version of Windows from compatibility mode</a></li>
<li><a href="../227455/index.html">Useful code implementation</a></li>
<li><a href="../227459/index.html">Russian stage of the World Olympics Robots - we did it!</a></li>
<li><a href="../227467/index.html">Stories that have taught us a lot: the results of habrakrakursa</a></li>
<li><a href="../227471/index.html">Russian physicists have discovered two types of dust in the atmosphere of Mars.</a></li>
<li><a href="../227475/index.html">Creating audio plugin, part 9</a></li>
<li><a href="../227477/index.html">Myo - official release in September</a></li>
<li><a href="../227479/index.html">Nokia X2 introduced: the next generation of the X line</a></li>
<li><a href="../227483/index.html">Why the growth of quality causes the growth of poor quality, or whether the main function</a></li>
<li><a href="../227485/index.html">Why do you still wear "silly" clothes?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>