<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>February 31</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Now I am studying the report of the regular verification of the Chromium project and the libraries used in it, using the PVS-Studio code analyzer. Fol...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>February 31</h1><div class="post__text post__text-html js-mediator-article"><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/dff/572/6fc/dff5726fc4a885c95a3cbfc1a028818d.png" alt="February 31"></div><br>  Now I am studying the report of the regular verification of the Chromium project and the libraries used in it, using the PVS-Studio code analyzer.  Following the results of the check, I have a cycle of articles about the analysis of certain types of errors and how to avoid them.  However, one mistake was so much liked that I decided not to postpone its description, but immediately write a little note to the blog. <br><a name="habracut"></a><br>  Our team has already written 5 articles ( <a href="https://www.viva64.com/ru/a/0074/">1</a> , <a href="https://www.viva64.com/ru/b/0113/">2</a> , <a href="https://www.viva64.com/ru/b/0205/">3</a> , <a href="https://www.viva64.com/ru/b/0225/">4</a> , <a href="https://www.viva64.com/ru/b/0442/">5</a> ), devoted to finding errors in the open project <a href="http://www.chromium.org/">Chromium</a> .  And, apparently, soon I will write a few more notes to our blog on this topic. <br><br>  Now I study the report issued by the <a href="https://www.viva64.com/ru/pvs-studio/">PVS-Studio</a> analyzer and just write out the errors found.  Writing notes is the next step.  I like to look at the report at the beginning, and then decide how and what to write about.  However, I especially liked one mistake, and I decided to describe it immediately, not postponing it for later. <br><br>  The bug lives in the <a href="https://ru.wikipedia.org/wiki/Protocol_Buffers">Protocol Buffers</a> (protobuf) library used in the Chromium project.  Protocol Buffers is a protocol for the serialization (transmission) of structured data, proposed by Google as an effective binary alternative to XML text format. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      If I saw this error a couple of months ago, I would have passed by it.  Well, error and error.  However, when I saw it, I immediately remembered the epic failure of cash registers, which recently occurred in Russia.  On December 20, the largest retailers and gas station networks across Russia faced disruptions in the operation of new cash registers.  The residents of Vladivostok were the first to find out about the problem, then it spread throughout the country as the working day began, affecting Novosibirsk, Barnaul, Krasnoyarsk, Kemerovo and other major cities. <br><br>  Error in cash registers and an error in the Protocol Buffers are two different errors that are not related to each other.  But I wanted to show how such errors can occur.  Indeed, defects are often not tailored to cunning algorithms, but are the result of trivial typos.  I do not know what was confused in the cash register code, but I know how a stupid typo leads to the inoperability of the <i>ValidateDateTime</i> function designed to check the date in Protocol Buffers.  Let's look at the code for this function and look at it. <br><br><pre><code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> kDaysInMonth[<span class="hljs-number"><span class="hljs-number">13</span></span>] = { <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">31</span></span>, <span class="hljs-number"><span class="hljs-number">28</span></span>, <span class="hljs-number"><span class="hljs-number">31</span></span>, <span class="hljs-number"><span class="hljs-number">30</span></span>, <span class="hljs-number"><span class="hljs-number">31</span></span>, <span class="hljs-number"><span class="hljs-number">30</span></span>, <span class="hljs-number"><span class="hljs-number">31</span></span>, <span class="hljs-number"><span class="hljs-number">31</span></span>, <span class="hljs-number"><span class="hljs-number">30</span></span>, <span class="hljs-number"><span class="hljs-number">31</span></span>, <span class="hljs-number"><span class="hljs-number">30</span></span>, <span class="hljs-number"><span class="hljs-number">31</span></span> }; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ValidateDateTime</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> DateTime&amp; time)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (time.year &lt; <span class="hljs-number"><span class="hljs-number">1</span></span> || time.year &gt; <span class="hljs-number"><span class="hljs-number">9999</span></span> || time.month &lt; <span class="hljs-number"><span class="hljs-number">1</span></span> || time.month &gt; <span class="hljs-number"><span class="hljs-number">12</span></span> || time.day &lt; <span class="hljs-number"><span class="hljs-number">1</span></span> || time.day &gt; <span class="hljs-number"><span class="hljs-number">31</span></span> || time.hour &lt; <span class="hljs-number"><span class="hljs-number">0</span></span> || time.hour &gt; <span class="hljs-number"><span class="hljs-number">23</span></span> || time.minute &lt; <span class="hljs-number"><span class="hljs-number">0</span></span> || time.minute &gt; <span class="hljs-number"><span class="hljs-number">59</span></span> || time.second &lt; <span class="hljs-number"><span class="hljs-number">0</span></span> || time.second &gt; <span class="hljs-number"><span class="hljs-number">59</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (time.month == <span class="hljs-number"><span class="hljs-number">2</span></span> &amp;&amp; IsLeapYear(time.year)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> time.month &lt;= kDaysInMonth[time.month] + <span class="hljs-number"><span class="hljs-number">1</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> time.month &lt;= kDaysInMonth[time.month]; } }</code> </pre> <br>  The <i>ValidateDateTime</i> function accepts a date as input and must determine whether it is valid or not.  At the beginning, basic checks are performed.  It is checked that the month number is in the range [1..12], the days are in the range [1..31], the minutes are in the range [0..59] and so on.  In the code, all this is clearly visible, and does not require special explanations. <br><br>  Next comes a more difficult test whether there is a certain day in a particular month.  For example, December consists of 31 days, and in November the 31st is not, since there are only 30 days in a month. <br><br>  To check the days and not to write a set of <i>if statements</i> or a long <i>switch</i> , the auxiliary array <i>kDaysInMonth is used</i> .  The array contains the number of days in different months.  By the month number, the maximum number of days is extracted from the array and used for verification. <br><br>  Additionally, it is taken into account that the year may be a leap year, and then in February 1 day more. <br><br>  In general, the function is written simply and beautifully.  That's just wrong. <br><br>  Due to a typo, days are checked incorrectly.  Please note that with the maximum possible number of days in a month, not a day is compared, but a month. <br><br>  Take another look at the code: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (time.month == <span class="hljs-number"><span class="hljs-number">2</span></span> &amp;&amp; IsLeapYear(time.year)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> time.month &lt;= kDaysInMonth[time.month] + <span class="hljs-number"><span class="hljs-number">1</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> time.month &lt;= kDaysInMonth[time.month]; }</code> </pre> <br>  In the " <i>time.month &lt;=</i> " comparisons, you should not use the member of the <i>month</i> structure, but the <i>day</i> member.  Those.  The correct code should look like this: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (time.month == <span class="hljs-number"><span class="hljs-number">2</span></span> &amp;&amp; IsLeapYear(time.year)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> time.day &lt;= kDaysInMonth[time.month] + <span class="hljs-number"><span class="hljs-number">1</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> time.day &lt;= kDaysInMonth[time.month]; }</code> </pre> <br>  Naturally, the month number (from 1 to 12) is always less than the number of days in any of the months. <br><br>  Because of this error, such days as, for example, February 31 or November 31 will be considered as correct. <br><br>  Here is such an interesting mistake met.  Because of it, incorrect dates can be processed, which can theoretically be used later to attack the system.  Here, perhaps, I exaggerate, but in fact, vulnerabilities usually look that way.  Just somewhere some input data is not verified, and someone guessed that. <br><br>  This error (or rather, two errors) is detected by means of the following warnings of PVS-Studio: <br><br><ul><li>  <a href="https://www.viva64.com/ru/w/v547/">V547</a> / <a href="https://cwe.mitre.org/data/definitions/571.html">CWE-571</a> Expression 'time.month &lt;= kDaysInMonth [time.month] + 1' is always true.  time.cc 83 </li><li>  <a href="https://www.viva64.com/ru/w/v547/">V547</a> / <a href="https://cwe.mitre.org/data/definitions/571.html">CWE-571</a> Expression 'time.month &lt;= kDaysInMonth [time.month]' is always true.  time.cc 85 </li></ul><br>  As you can see, now PVS-Studio also immediately classifies warnings according to Common Weakness Enumeration ( <a href="https://cwe.mitre.org/">CWE</a> ). <br><br>  I also want to note that the PVS-Studio analyzer is learning more and more deeply to analyze the code.  By itself, the V547 diagnosis is old (it was implemented in 2010).  However, let's say, a year ago, the analyzer could not find this error.  Now the analyzer is able to look inside the array and understand that the values ‚Äã‚Äãin the range [28..31] are extracted.  At the same time, he understands that 0 in the array is not necessary to take into account, since the possible range of <i>time.month</i> is [1..12].  If the month number was, say, 100, then there was an exit from the function and the analyzer understands this. <br><br>  As a result, the analyzer sees that the following range comparisons occur: <br><br><ul><li>  [2..2] &lt;= [28..31] </li><li>  [1..12] &lt;= [29..32] </li></ul><br>  Therefore, the conditions are always true, what the analyzer and the warning.  Here is such a deep analysis.  As you see, we not only add new warnings in PVS-Studio, but also refine the Data-Flow analysis, which affects the quality of the existing diagnostics. <br><br>  Why is the first range [2, 2] represented by only one number 2?  The fact is that the clarifying condition <i>time.month == 2 is</i> taken into account. <br><br>  One should ask: how can one improve the style in order to protect oneself from such mistakes? <br><br>  I do not know.  The function is simple and written in good style.  It‚Äôs just human nature to make mistakes, and he can make such typos.  No professional is immune from such errors. <br><br>  We can only recommend to write more carefully unit tests and use professional static code analyzers, such as PVS-Studio. <br><br>  Thanks for attention.  I will go further to study the report. <br><br><div style="text-align:center;"> <a href="https://www.viva64.com/en/b/0550/"><img src="https://habrastorage.org/files/8d2/41b/5bf/8d241b5bf34747169141ed7c1997143b.png"></a> </div><br><br>  If you want to share this article with an English-speaking audience, then please use the link to the translation: Andrey Karpov.  <a href="https://www.viva64.com/en/b/0550/">February 31</a> . </div><p>Source: <a href="https://habr.com/ru/post/346128/">https://habr.com/ru/post/346128/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../346114/index.html">Meltdown: not only affects performance</a></li>
<li><a href="../346116/index.html">Restate - or how to turn a Redux log into a tree</a></li>
<li><a href="../346118/index.html">MPS 2017.3 released</a></li>
<li><a href="../346120/index.html">Ok google get me a car</a></li>
<li><a href="../346126/index.html">Tachometer or speedometer: The flow of thoughts about measuring the frequency in the Arduino</a></li>
<li><a href="../346130/index.html">So why aren't you participating in the development of open source software?</a></li>
<li><a href="../346132/index.html">Stimulus 1.0: a modest JavaScript HTML framework that you already have</a></li>
<li><a href="../346134/index.html">Genetic algorithm for constructing algorithms</a></li>
<li><a href="../346136/index.html">L√ñVE Development</a></li>
<li><a href="../346138/index.html">Game Design Techniques: Mixing</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>