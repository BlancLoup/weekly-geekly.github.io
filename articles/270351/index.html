<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Pure architecture in a go app. Part 2</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="From the translator: this article was written by Manuel Kiessling in September 2012, as the implementation of Uncle Bob ‚Äôs article on pure architectur...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Pure architecture in a go app. Part 2</h1><div class="post__text post__text-html js-mediator-article">  From the translator: this article was <a href="http://manuel.kiessling.net/2012/09/28/applying-the-clean-architecture-to-go-applications/">written by Manuel Kiessling</a> in September 2012, as the implementation <a href="http://blog.8thlight.com/uncle-bob/2012/08/13/the-clean-architecture.html">of Uncle Bob</a> ‚Äôs <a href="http://blog.8thlight.com/uncle-bob/2012/08/13/the-clean-architecture.html">article</a> on pure architecture with consideration for Go-specificity. <br><br><img src="https://habrastorage.org/files/938/553/6f2/9385536f2f3649fdba1cf361dce6480a.jpg"><br><br>  This is the second article in a series on the implementation of Pure Architecture in Go.  [ <a href="http://habrahabr.ru/post/269893/">Part 1</a> ] 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <a name="habracut"></a><br><br><h2>  Scenarios </h2><br>  Immediately start with the Script layer code: <br><br><pre><code class="go hljs"><span class="hljs-comment"><span class="hljs-comment">// $GOPATH/src/usecases/usecases.go package usecases import ( "domain" "fmt" ) type UserRepository interface { Store(user User) FindById(id int) User } type User struct { Id int IsAdmin bool Customer domain.Customer } type Item struct { Id int Name string Value float64 } type Logger interface { Log(message string) error } type OrderInteractor struct { UserRepository UserRepository OrderRepository domain.OrderRepository ItemRepository domain.ItemRepository Logger Logger } func (interactor *OrderInteractor) Items(userId, orderId int) ([]Item, error) { var items []Item user := interactor.UserRepository.FindById(userId) order := interactor.OrderRepository.FindById(orderId) if user.Customer.Id != order.Customer.Id { message := "User #%i (customer #%i) " message += "is not allowed to see items " message += "in order #%i (of customer #%i)" err := fmt.Errorf(message, user.Id, user.Customer.Id, order.Id, order.Customer.Id) interactor.Logger.Log(err.Error()) items = make([]Item, 0) return items, err } items = make([]Item, len(order.Items)) for i, item := range order.Items { items[i] = Item{item.Id, item.Name, item.Value} } return items, nil } func (interactor *OrderInteractor) Add(userId, orderId, itemId int) error { var message string user := interactor.UserRepository.FindById(userId) order := interactor.OrderRepository.FindById(orderId) if user.Customer.Id != order.Customer.Id { message = "User #%i (customer #%i) " message += "is not allowed to add items " message += "to order #%i (of customer #%i)" err := fmt.Errorf(message, user.Id, user.Customer.Id, order.Id, order.Customer.Id) interactor.Logger.Log(err.Error()) return err } item := interactor.ItemRepository.FindById(itemId) if domainErr := order.Add(item); domainErr != nil { message = "Could not add item #%i " message += "to order #%i (of customer #%i) " message += "as user #%i because a business " message += "rule was violated: '%s'" err := fmt.Errorf(message, item.Id, order.Id, order.Customer.Id, user.Id, domainErr.Error()) interactor.Logger.Log(err.Error()) return err } interactor.OrderRepository.Store(order) interactor.Logger.Log(fmt.Sprintf( "User added item '%s' (#%i) to order #%i", item.Name, item.Id, order.Id)) return nil } type AdminOrderInteractor struct { OrderInteractor } func (interactor *AdminOrderInteractor) Add(userId, orderId, itemId int) error { var message string user := interactor.UserRepository.FindById(userId) order := interactor.OrderRepository.FindById(orderId) if !user.IsAdmin { message = "User #%i (customer #%i) " message += "is not allowed to add items " message += "to order #%i (of customer #%i), " message += "because he is not an administrator" err := fmt.Errorf(message, user.Id, user.Customer.Id, order.Id, order.Customer.Id) interactor.Logger.Log(err.Error()) return err } item := interactor.ItemRepository.FindById(itemId) if domainErr := order.Add(item); domainErr != nil { message = "Could not add item #%i " message += "to order #%i (of customer #%i) " message += "as user #%i because a business " message += "rule was violated: '%s'" err := fmt.Errorf(message, item.Id, order.Id, order.Customer.Id, user.Id, domainErr.Error()) interactor.Logger.Log(err.Error()) return err } interactor.OrderRepository.Store(order) interactor.Logger.Log(fmt.Sprintf( "Admin added item '%s' (#%i) to order #%i", item.Name, item.Id, order.Id)) return nil }</span></span></code> </pre> <br><br>  The Script layer code consists mainly of a User entity and two scripts.  An entity has a repository in the same way as it was in the Domain layer, because Users require a persistent storage and retrieval mechanism. <br><br>  Scripts are implemented as methods of the OrderInteractor structure, which, however, is not surprising.  This is not a mandatory requirement; they can also be implemented as unrelated functions, but as we will see later, this facilitates the introduction of certain dependencies. <br><br>  The code above is a prime example of food for thought about what to put.  First of all, all interactions of the external layers should be carried out through the OrderInteractor and AdminOrderInteractor methods, the structures that operate within the Scripting layer and deeper.  Again, this is all following the Rule of Dependencies.  This way of working allows us not to have external dependencies, which, in turn, allows us, for example, to test this code using mocks of repositories or, if necessary, we can replace the internal implementation of the Logger (see code) with another without any difficulties, because these changes do not affect the remaining layers. <br><br>  Uncle Bob says about Scenarios: ‚ÄúIn this layer, the specificity of business rules is implemented.  It encapsulates and implements all uses of the system.  These scripts implement the flow of data to and from the Entity layer to implement business rules. ‚Äù <br><br>  If you look at, say, the Add method in the OrderInteractor, you will see this in action.  The method controls the receipt of necessary objects and saving them in a form suitable for further use.  This method is used to handle errors that may be specific to this Scenario, subject to certain limitations of this particular layer.  For example, a limit on the purchase of $ 250 is imposed at the Domain level, since this is a business rule and it takes precedence over the Script rules.  On the other hand, the checks related to the addition of goods to the order are the specifics of the Scenarios, and it is this layer that contains the User entity, which in turn affects the processing of goods, depending on whether a regular user or an administrator does this. <br><br>  Let's also discuss logging on this layer.  In the application, all types of logging affect several layers.  Even with the understanding that all log entries will ultimately be lines in a disk file, it is important to separate conceptual details from technical ones.  The script level does not know anything about text files and hard drives.  Conceptually, this level simply says: ‚ÄúAt the Scenario level, something interesting happened and I would like to report it‚Äù, where ‚Äúreport‚Äù does not mean ‚Äúwrite somewhere‚Äù, it simply means ‚Äúinform‚Äù - without any knowledge, what's next with this all happens. <br><br>  Thus, we simply provide an interface that satisfies the needs of the Scenario and provides an implementation for this ‚Äî in this way, regardless of how we decide to save the logs (file, database, ...), we will still satisfy the logging processing interface on this layer and these changes will not affect the inner layers. <br><br>  The situation is even more interesting in the light of the fact that we created two different OrderInteractor.  If we wanted to log administrator actions into one file, and ordinary user actions into another file, then it was also very simple.  In this case, we would simply create two implementations of the Logger and both versions would satisfy the usecases.Logger interface and use them in the appropriate OrderInteractor - OrderInteractor and AdminOrderInteractor. <br><br>  Another important detail in the Script code is the Item structure.  At the domain level, we already have a similar structure, right?  Why not just return it in the Items () method?  Because it contradicts the rule - not to transfer structures to the outer layers.  Entities of a layer can contain not only data, but also behavior.  Thus, the behavior of script entities can only be applied on this layer.  Without transferring the essence to the outer layers, we guarantee the preservation of the behavior within the layer.  The outer layers need only pure data and our task is to provide them in this form. <br><br>  As in the Domain layer, this code shows how the Pure Architecture helps to understand how the application actually works: if we only have to look at the domain layer in order to understand what business rules, then in order to understand how the user interacts with the business, we just look at the Script layer code.  We see that the application allows the user to add products to the order on their own and that the administrator can add products to the user's order. <br><br>  To be continued ... In the <a href="http://habrahabr.ru/post/271157/">third part</a> we will discuss the Interfaces layer. </div><p>Source: <a href="https://habr.com/ru/post/270351/">https://habr.com/ru/post/270351/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../270335/index.html">SAP ERP / ABAP useful resources</a></li>
<li><a href="../270337/index.html">MagOS in industrial application</a></li>
<li><a href="../270339/index.html">Observer vs Pub-Sub</a></li>
<li><a href="../270343/index.html">Building native applications in ExtJS 6</a></li>
<li><a href="../270347/index.html">How is the profession "Data Scientist"</a></li>
<li><a href="../270353/index.html">Overview of ES6 at 350 points. Part one</a></li>
<li><a href="../270359/index.html">We force the php-fpm 5.6 service running through systemd to read global environment variables</a></li>
<li><a href="../270361/index.html">Animation of transitions between two fragments</a></li>
<li><a href="../270363/index.html">Game with a list of conditions</a></li>
<li><a href="../270365/index.html">Evaluation of test coverage on the project</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>