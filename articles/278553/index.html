<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How we fought parsers</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Key points: 
 * Implementing a script to check the PTR of visitors; 
 * Configuring nginx in IfIsEvil-style with branching map; 
 * Location names in ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How we fought parsers</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/c55/a04/3dd/c55a043ddd3b007885d70bc836a5729e.jpg" alt="image"><br>  Key points: <br>  * Implementing a script to check the PTR of visitors; <br>  * Configuring nginx in IfIsEvil-style with branching map; <br>  * Location names in map variables; <br>  * Branch control via try_files / nonexist $ map_var. <br><br>  Many high-load and popular sites suffer from the fact that in addition to live visitors they are visited by various parsers, bots and other automated scanners that do not have any beneficial effect, but only create spurious traffic and load on the already loaded system.  In this case, I do not mean the search bots, which, although often load the project is not normalized, but are simply necessary for any project. <br>  One of our clients regularly experienced the problem of an avalanche-like increase in load at certain times of the day.  Periodically, once a day and more often, there was an influx of visits with a significant increase in LA on the servers.  It was decided to build protection from parasitic traffic. <br><br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h5>  <a href="http://centos-admin.ru/">We</a> found that sneak traffic has certain behavior patterns and properties, namely: </h5><br>  * By request source - subnet Amazon, Tor; <br>  * By entry points - most requests to the section of goods; <br>  * According to UserAgent - the main part of the bots was sent by the UA search engines Google, Yandex, Bing, but they were not objectively them; <br>  * By referrer - basically the referrer was empty. <br><br><h5>  Implemented checks, restrictions and locks: </h5><br>  * Manually added pre-known IPs to the white list <br>  * And previously compromised IP - blacklisted <br>  * Limit limit_req_zone for all but whitelists <br>  * Checking visitors from the UA search engines for PTR-record compliance with the real PTR-records of the search engines and put on the white list of the tested and always allow them. <br>  * When LA increases the ‚ÄúAttack‚Äù threshold: <br>  ** We do not pass the UA check on PTR in the black list and block. <br>  ** Check the repeatability of referrers in the access-log and block visitors with the referrer exceeding the specified number of entries <br>  ** The rest is checked by captcha and resolved if successful. <br><br>  The first three points are common solutions, so I‚Äôll focus more on checking visitors by PTR, configuring nginx using the try_files / nonexist $ map_var construction and complex maps. <br><br><h5>  We have implemented a script for asynchronous checking of visitors from search engines UA to match PTR records with real PTR records of search engines. </h5><br><br>  It runs on cron once a minute.  According to the unique IP list of visitors from the search engine UA, it performs a PTR check and checks the second-level domain name.  If the domain matches, it adds IP to the white list, otherwise to the black list.  When checking the list, the script does not check the PTR of previously verified IPs to speed up the verification process.  This allows you to go through the IP list from the access-log every minute, even at a high speed of filling the access-log.  Blacklisting entries are recorded with an indication of a fixed time to remove from the block list in order to avoid permanent blocking of common IPs in large NAT networks. <br><br>  Thus, we create and maintain the ptr_blacklist.map and ptr_whitelist.map files that are included in the nginx config. <br><br>  Runs every minute. <br><div class="spoiler">  <b class="spoiler_title">Listing of the UA and PTR compliance check script:</b> <div class="spoiler_text"><pre><code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash #   ,     , #        ,    . # Export inc file for nginx EXPORT_MAP=true # Domain list DOMAIN_LIST="domain" # Block time (in minutes) BLOCK_TIME=1440 # White list IP IP_WHITELIST="" # White list PTR BOTS="google|yandex|bing|Bing|msn" # false - not block IP if there is a PTR record BLOCK_WITH_PTR=true UNBLOCK_ENABLE=true LOGFILE=/var/log/ua-table.log LOGFILE2=/var/log/ua-table-history.log LOCK=/tmp/ua_check.lock D=$DOMAIN_LIST #   ptr_blacklist  ptr_whitelist       map- #      BL_FILE=/etc/nginx/vhosts.d/ptr_blacklist WL_FILE=/etc/nginx/vhosts.d/ptr_whitelist BL_FILE_MAP=$BL_FILE.map WL_FILE_MAP=$WL_FILE.map TMP_LOG=/tmp/$D-acc-temp.log TMP_LOG1=/tmp/$D-acc-temp1.log NGINX_LOG=/srv/www/$D/shared/log/$D-acc.log [ ! -f /usr/bin/host ] &amp;&amp; echo "/usr/bin/host not found. Please yum install bind-utils" &amp;&amp; exit [ -z "$DOMAIN_LIST" ] &amp;&amp; echo "DOMAIN_LIST is empty" [ ! -f $LOGFILE ] &amp;&amp; touch $LOGFILE [ ! -f $LOGFILE2 ] &amp;&amp; touch $LOGFILE2 debug="0" function e { echo -e $(/bin/date "+%F %T") $1 } #     ,       [ -f $LOCK ] &amp;&amp; e "Script $0 is already runing" &amp;&amp; exit /bin/touch $LOCK DT=`/bin/date "+%F %T"` if [ ! -f $NGINX_LOG ];then echo "Log ($NGINX_LOG) not found." /bin/rm -rf $LOCK exit fi #    #    acc-,  ,         referer /bin/egrep "Yandex|Google|bingbot|Bing" $NGINX_LOG | /usr/bin/awk '{print $1}' | /bin/sort -n | /usr/bin/uniq &gt; $TMP_LOG if [ "$EXPORT_MAP" == "true" ]; then [ ! -f $BL_FILE_MAP ] &amp;&amp; /bin/touch $BL_FILE_MAP [ ! -f $WL_FILE_MAP ] &amp;&amp; /bin/touch $WL_FILE_MAP [ ! -f $BL_FILE ] &amp;&amp; /bin/touch $BL_FILE || /bin/cp -f $BL_FILE $BL_FILE.bak [ ! -f $WL_FILE ] &amp;&amp; /bin/touch $WL_FILE || /bin/cp -f $WL_FILE $WL_FILE.bak fi #   UNBLOCK=0 while read line do if [[ "$line" == *=* ]]; then GET_TIME=`echo $line | /usr/bin/awk -F"=" '{print $2}'` NOW=`/bin/date '+%s'` #echo $NOW #echo $GET_TIME if [ "$NOW" -gt "$GET_TIME" ]; then IP=`echo $line | awk '{print $3}'` e "$IP unblocked." &gt;&gt; $LOGFILE2 /bin/sed -i '/'$IP'/d' $BL_FILE /bin/sed -i '/'$IP'/d' $LOGFILE UNBLOCK=1 #else #e "Nothing to unblock" &gt;&gt; $LOGFILE2 fi fi done &lt; $LOGFILE #   while read line do IP=$line wl=0 bl=0 #    WL for I in $IP_WHITELIST do if [ "$I" = "$IP" ];then wl=1 fi done #       WL for I in $(/usr/bin/awk '{print $1}' &lt; "$WL_FILE" ) do if [ "$I" = "$IP" ];then wl=1 fi done #       BL for I in $(/usr/bin/awk '{print $1}' &lt; "$BL_FILE" ) do if [ "$I" = "$IP" ];then bl=1 fi done #  IP   ,    ,    PTR if [ "$wl" = "1" -o "$bl" = "1" ]; then [ "$debug" -gt "1" ] &amp;&amp; e "$IP in white or black list" &gt;&gt; $LOGFILE2 else PTR="" SRCHBOT="" FINDPTR="`/usr/bin/host $IP | /bin/grep -v 'not found' | /bin/grep -v 'no PTR record' | /usr/bin/head -1 | /usr/bin/awk '{ print $5 }' | /bin/sed 's/\.$//'`" if [ -z "$FINDPTR" ];then PTR=" (PTR record not found)" else PTR=" ($FINDPTR)" fi SRCHBOT=`/usr/bin/host $IP | /usr/bin/awk '{ print $5 }' | /usr/bin/rev | /usr/bin/cut -d . -f 2-3 | /usr/bin/rev | /bin/egrep "$BOTS"` [ -n "$SRCHBOT" ] &amp;&amp; BOT="YES" || BOT="NO" [ -z "$BLOCK_WITH_PTR" ] &amp;&amp; BLOCK_WITH_PTR=true if [ "$EXPORT_MAP" == "true" ]; then if [ "$BOT" == "NO" ]; then e "$IP blocked $BLOCK_TIME minutes. ($D) Unblock = `/bin/date --date="$BLOCK_TIME minute" +%s`" &gt;&gt; $LOGFILE e "$IP$PTR blocked $BLOCK_TIME minutes. ($D)" &gt;&gt; $LOGFILE2 echo "$IP 0;" &gt;&gt; $BL_FILE else echo "$IP 1;" &gt;&gt; $WL_FILE fi fi fi done &lt; $TMP_LOG #     map- if [ "$EXPORT_MAP" == "true" ]; then /bin/sort -u -o $BL_FILE $BL_FILE &gt; /dev/null 2&gt;&amp;1 /bin/sort -u -o $WL_FILE $WL_FILE &gt; /dev/null 2&gt;&amp;1 MAP_CHANGED=0 if ! diff $BL_FILE $BL_FILE.bak &gt; /dev/null 2&gt;&amp;1; then /bin/cp -f $BL_FILE_MAP $BL_FILE_MAP.bak &gt; /dev/null 2&gt;&amp;1 /bin/cp -f $BL_FILE $BL_FILE_MAP &gt; /dev/null 2&gt;&amp;1 MAP_CHANGED=1 fi if ! diff $WL_FILE $WL_FILE.bak &gt; /dev/null 2&gt;&amp;1; then /bin/cp -f $WL_FILE_MAP $WL_FILE_MAP.bak &gt; /dev/null 2&gt;&amp;1 /bin/cp -f $WL_FILE $WL_FILE_MAP &gt; /dev/null 2&gt;&amp;1 MAP_CHANGED=1 fi if [ "$MAP_CHANGED" -eq "1" -o "$UNBLOCK" -eq "1" ]; then RELOAD=`/usr/sbin/nginx -t 2&gt;&amp;1 | /bin/grep ok` if [ -n "$RELOAD" ];then /sbin/service nginx reload e "nginx is reloaded" &gt;&gt; $LOGFILE2 else ERROR_RELOAD=`/sbin/service nginx configtest 2&gt;&amp;1` /bin/cp -f $BL_FILE_MAP.bak $BL_FILE_MAP &gt; /dev/null 2&gt;&amp;1 /bin/cp -f $WL_FILE_MAP.bak $WL_FILE_MAP &gt; /dev/null 2&gt;&amp;1 e "nginx error config test failed" &gt;&gt; $LOGFILE2 fi fi fi /bin/rm -rf $LOCK</span></span></code> </pre> <br></div></div><br><h5>  Script to check the frequency of referrers and the formation of the file referer-block.conf type </h5><br><pre> <code class="bash hljs">~domain.ru 0; ~‚Ä¶ 1; ~‚Ä¶ 1;</code> </pre><br>  Runs every minute. <br><div class="spoiler">  <b class="spoiler_title">Listing of the referrer frequency checking script:</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash # referer_protect v.1.0.6 #   ,     , #        ,    . RECORDS=500 DOMAIN_LIST=domain LA=15 # if Load Average &gt; $LA = Referer is block BLOCK_TIME=360 #in minutes #REF_WHITELIST="" BLOCK_ENABLE=true # true/false - enable/disable add firewall rule. email="mail@mail.ru" LOGFILE=/var/log/referer-table.log LOGFILE2=/var/log/referer-table-history.log LOCK=/tmp/referer.lock MSG_ALERT=/tmp/msg-alert.tmp debug="0" LA_CURRENT="`cat /proc/loadavg | awk '{ print $1}' | awk 'BEGIN { FS="."; }{ print $1}'`" DT=`date "+%F %T"` [ ! -f $LOGFILE ] &amp;&amp; touch $LOGFILE [ -f "$MSG_ALERT" ] &amp;&amp; rm -f $MSG_ALERT function e { echo -e $(date "+%F %T") $1 } function msg { echo "Referer:$REFERER. Domain:$D" &gt;&gt; $MSG_ALERT } function send_mail { if [ "$BLOCK_ENABLE" = "true" -a "$LA_CURRENT" -gt "$LA" ];then cat $MSG_ALERT | mailx -s "Referers report. Warning" $email elif [ "$BLOCK_ENABLE" = "true" -a "$LA_CURRENT" -le "$LA" ];then cat $MSG_ALERT | mailx -s "Referers report. Notice " $email else cat $MSG_ALERT | mailx -s "Referers report. Notice (Test mode)" $email fi } [ -f $LOCK ] &amp;&amp; e "Script $0 is already runing" &amp;&amp; exit touch $LOCK NEED_NGINX_RELOAD=0 for D in $DOMAIN_LIST do TMP_LOG=/tmp/ddos-$D-acc-referer.log TMP_AWK=/tmp/tmp_$D-awk.tmp #NGINX_LOG=/srv/www/$D/logs/$D-acc NGINX_LOG=/srv/www/$D/shared/log/$D-acc.log REFCONF=/etc/nginx/referer-block-$D.conf [ ! -s "$REFCONF" ] &amp;&amp; echo "~$D 0;" &gt;&gt; $REFCONF if [ ! -f $NGINX_LOG ];then echo "Log ($NGINX_LOG) not found." /bin/rm -rf $LOCK exit fi tail -10000 $NGINX_LOG | awk '($9 == "200") || ($9 == "404")' | awk '{print $11}' | sort | uniq -c | sort -n | awk -vx=$RECORDS ' $1 &gt; x {print $2} ' &gt; $TMP_LOG sed -i "s/\"//g" $TMP_LOG #   sed -i "/^-/d" $TMP_LOG #  referer "-" sed -i "/$D/d" $TMP_LOG #    sed -i "/^localhost/d" $TMP_LOG #  localhost awk -F/ '{print $3}' $TMP_LOG &gt; $TMP_AWK #     url cat $TMP_AWK &gt; $TMP_LOG #   referer while read line do if [[ "$line" == *=* ]]; then GET_TIME=`echo $line | awk -F"=" '{print $2}'` NOW=`date +%s` #echo $NOW #echo $GET_TIME if [ "$NOW" -gt "$GET_TIME" ]; then REFERER=`echo $line | awk '{print $4}'` e "Referer $REFERER unblocked." &gt;&gt; $LOGFILE2 /bin/sed -i '/'$REFERER'/d' $LOGFILE /bin/sed -i '/'$REFERER'/d' $REFCONF NEED_NGINX_RELOAD=1 fi fi done &lt; $LOGFILE #  referer while read line do REFERER=$line DOUBLE=`cat $REFCONF | grep "$REFERER"` if [ -n "$DOUBLE" ]; then [ "$debug" != "0" ] &amp;&amp; e "referer $REFERER exist in DROP rule" else if [ "$BLOCK_ENABLE" = "true" -a "$LA_CURRENT" -gt "$LA" ];then echo "~$REFERER 1;" &gt;&gt; $REFCONF e "Referer $REFERER blocked $BLOCK_TIME minutes ($D) Unblock = `date --date="$BLOCK_TIME minute" +%s`" &gt;&gt; $LOGFILE e "Referer $REFERER blocked $BLOCK_TIME minutes ($D)" &gt;&gt; $LOGFILE2 NEED_NGINX_RELOAD=1 if [ ! -s "$MSG_ALERT" ];then echo "Status: WARNING" &gt; $MSG_ALERT echo "Date: $DT" &gt;&gt; $MSG_ALERT echo "Referer: $RECORDS matches from 10000" &gt;&gt; $MSG_ALERT echo "LA: $LA_CURRENT" &gt;&gt; $MSG_ALERT echo "Referer(s) is blocked on $BLOCK_TIME minutes:" &gt;&gt; $MSG_ALERT echo "" &gt;&gt; $MSG_ALERT fi msg elif [ "$BLOCK_ENABLE" = "true" -a "$LA_CURRENT" -le "$LA" ];then TESTDOUBLE=`cat $LOGFILE | grep "$REFERER"` if [ -z "$TESTDOUBLE" ]; then e "Referer $REFERER TEST blocked $BLOCK_TIME minutes ($D) Unblock = `date --date="$BLOCK_TIME minute" +%s`" &gt;&gt; $LOGFILE e "TEST. Referer $REFERER TEST blocked $BLOCK_TIME minutes ($D)" &gt;&gt; $LOGFILE2 if [ ! -s "$MSG_ALERT" ];then echo "Status: Notice" &gt; $MSG_ALERT echo "Date: $DT" &gt;&gt; $MSG_ALERT echo "Referer: $RECORDS matches from 10000" &gt;&gt; $MSG_ALERT echo "LA: $LA_CURRENT" &gt;&gt; $MSG_ALERT echo "Referer(s) not blocking:" &gt;&gt; $MSG_ALERT echo "" &gt;&gt; $MSG_ALERT fi msg fi else TESTDOUBLE=`cat $LOGFILE | grep "$REFERER"` if [ -z "$TESTDOUBLE" ]; then e "Referer $REFERER TEST blocked $BLOCK_TIME minutes ($D) Unblock = `date --date="$BLOCK_TIME minute" +%s`" &gt;&gt; $LOGFILE e "TEST. Referer $REFERER TEST blocked $BLOCK_TIME minutes ($D)" &gt;&gt; $LOGFILE2 if [ ! -s "$MSG_ALERT" ];then echo "Date: $DT" &gt; $MSG_ALERT echo "Current referer found over $RECORDS matches from 10000 records, but script working is TEST MODE " &gt;&gt; $MSG_ALERT echo "Current LA - $LA_CURRENT" &gt;&gt; $MSG_ALERT echo "Referer(s) not blocking:" &gt;&gt; $MSG_ALERT echo "" &gt;&gt; $MSG_ALERT fi msg fi fi fi done &lt; $TMP_LOG [ -n "email" -a -s "$MSG_ALERT" ] &amp;&amp; send_mail done # reload nginx if config change if [ $NEED_NGINX_RELOAD -eq 1 ]; then /sbin/service nginx reload &gt;/dev/null 2&gt;/dev/null fi /bin/rm -rf $LOCK</span></span></code> </pre><br></div></div><br><h5>  The nginx configuration file as a symlink points to one of two files operating in normal and high LA modes. </h5><br>  The mode is switched by the script executed every minute from Cron. <br><div class="spoiler">  <b class="spoiler_title">Script switching modes:</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash ### check LA level MAX_LA=10 processid=`/sbin/pidof -x $(basename $0) -o %PPID` if [[ $processid ]];then exit fi CFG_DDOS='fpm.domain.ru.ddos' CFG_NODDOS='fpm.domain.ru.noddos' load_average=$(uptime | awk '{print $11}' | cut -d "." -f 1) echo "$(date '+%Y-%m-%d %H:%M') : LA $load_average" if [[ $load_average -ge $MAX_LA ]]; then if [ -f /tmp/la_flag ]; then date '+%s' &gt; /tmp/la_flag exit 1 else # echo "$(date +%Y-%m-%d-%H-%M)" date '+%s' &gt; /tmp/la_flag mv /etc/nginx/vhosts.d/new.domain.ru.conf /etc/nginx/vhosts.d/new.domain.ru.conf.bak &gt; /dev/null 2&gt;&amp;1 ln -s /etc/nginx/vhosts.d/$CFG_DDOS /etc/nginx/vhosts.d/new.domain.ru.conf reload=`/usr/sbin/nginx -t 2&gt;&amp;1 | grep ok` if [ -n "$reload" ];then /sbin/service nginx reload rm -f /etc/nginx/vhosts.d/new.domain.ru.conf.bak &gt; /dev/null 2&gt;&amp;1 echo "$(date '+%Y-%m-%d %H:%M') : DDOS config up $reload" exit 0 else /sbin/service nginx configtest 2&gt;&amp;1 mv /etc/nginx/vhosts.d/new.domain.ru.conf.bak /etc/nginx/vhosts.d/new.domain.ru.conf &gt; /dev/null 2&gt;&amp;1 echo "nginx error config ddos test failed" echo "alarm nginx config ddos test failed" | mail -s alarm root exit 1 fi fi else if [ -f /tmp/la_flag ]; then TIMEA=`cat /tmp/la_flag` TIMEC=`date '+%s'` TIMED=$(( $TIMEC - $TIMEA )) if [ $TIMED -gt 600 ]; then echo "high LA ENDED $(date +%Y-%m-%d-%H-%M)" rm -f /tmp/la_flag &gt; /dev/null 2&gt;&amp;1 mv /etc/nginx/vhosts.d/new.domain.ru.conf /etc/nginx/vhosts.d/new.domain.ru.conf.bak &gt; /dev/null 2&gt;&amp;1 ln -s /etc/nginx/vhosts.d/$CFG_NODDOS /etc/nginx/vhosts.d/new.domain.ru.conf reload=`/usr/sbin/nginx -t 2&gt;&amp;1 | grep ok` echo "$(date '+%Y-%m-%d %H:%M') : NO DDOS config up $reload" if [ -n "$reload" ];then /sbin/service nginx reload rm -f /etc/nginx/vhosts.d/new.domain.ru.conf.bak &gt; /dev/null 2&gt;&amp;1 echo "$(date '+%Y-%m-%d %H:%M') : NO ddos config up" exit 0 else /sbin/service nginx configtest 2&gt;&amp;1 mv /etc/nginx/vhosts.d/new.domain.ru.conf.bak /etc/nginx/vhosts.d/new.domain.ru.conf &gt; /dev/null 2&gt;&amp;1 echo "nginx error config noddos test failed" echo "alarm nginx config noddos test failed" | mail -s alarm root exit 1 fi else exit 1 fi else exit 1 fi fi</span></span></code> </pre><br></div></div><br><h5>  A part of the configuration is placed in a separate file that is included in the main configuration files. </h5><br><div class="spoiler">  <b class="spoiler_title">A file with general configuration parameters for both vhosts.d / map.domain.ru.inc modes:</b> <div class="spoiler_text"><pre> <code class="bash hljs">map_hash_bucket_size 128; geoip_country /usr/share/GeoIP/GeoIP.dat; limit_req_zone <span class="hljs-variable"><span class="hljs-variable">$newlimit_addres1</span></span> zone=newone:10m rate=50r/m; map <span class="hljs-variable"><span class="hljs-variable">$whitelist</span></span>-<span class="hljs-variable"><span class="hljs-variable">$remote_addr</span></span>:<span class="hljs-variable"><span class="hljs-variable">$remote_port</span></span> <span class="hljs-variable"><span class="hljs-variable">$newlimit_addres1</span></span> { ~<span class="hljs-string"><span class="hljs-string">"^0"</span></span> <span class="hljs-variable"><span class="hljs-variable">$binary_remote_addr</span></span>; ~<span class="hljs-string"><span class="hljs-string">"^1-(?&lt;match_rap&gt;.*)"</span></span> <span class="hljs-variable"><span class="hljs-variable">$match_rap</span></span>; } geo <span class="hljs-variable"><span class="hljs-variable">$whitelist</span></span> { default 0; 91.205.47.150 1; 194.87.91.154 1; 83.69.225.78 1; 77.88.18.82 1; 91.143.46.202 1; 213.180.192.0/19 1; 87.250.224.0/19 1; 77.88.0.0/18 1; 93.158.128.0/18 1; 95.108.128.0/17 1; 178.154.128.0/17 1; 199.36.240.0/22 1; 84.201.128.0/18 1; 141.8.128.0/18 1; 188.134.88.105 1; 89.163.3.25 1; 46.39.246.91 1; 84.21.76.123 1; 136.243.83.53 1; 77.50.238.152 1; 83.167.117.49 1; 109.188.82.40 1; 79.141.227.19 1; 176.192.62.78 1; 86.62.91.133 1; 144.76.88.101 1; } <span class="hljs-comment"><span class="hljs-comment">#     block_referer.sh map $http_referer $bad_referer { default "0"; include /etc/nginx/referer-block.conf; } map $http_referer:$request_method $bad_post_referer { default "0"; "~*domain.ru.*:POST$" "0"; "~*:POST$" "1"; include /etc/nginx/referer-block.conf; } #      map $query_string $bad_query { ... default 0; } #  ,     /checkcapcha.php map $http_cookie $allowed_cookie { "~somecookie" 1; default 0; }   GeoIP     map $geoip_country_code $allowed_country { RU 1; default 0; } #   Amazon include vhosts.d/deny-amazon.inc; #      map $remote_addr $valid_addr { include vhosts.d/main_blacklist.map; include vhosts.d/main_whitelist.map; default 2; } # UA - map $http_user_agent $user_agent_search_bot { "~Yandex" "1"; "~Google" "1"; "~*bing" "1"; "~*MSNBot" "1"; default ""; } map $remote_addr $ptr_wl_bl { include vhosts.d/ptr_blacklist.map; include vhosts.d/ptr_whitelist.map; default ""; } map "$user_agent_search_bot:$ptr_wl_bl" $searchbot { "1:1" "1"; "1:0" "0"; default "2"; }</span></span></code> </pre><br></div></div><br><h5>  Configuration File Listings </h5><br><div class="spoiler">  <b class="spoiler_title">The main config for normal operation is vhosts.d/fpm.domain.ru.noddos:</b> <div class="spoiler_text"><pre> <code class="bash hljs">include vhosts.d/map.domain.ru.inc; map <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$searchbot</span></span></span><span class="hljs-string">:</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$valid_addr</span></span></span><span class="hljs-string">:</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$bad_referer</span></span></span><span class="hljs-string">:</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$bad_query</span></span></span><span class="hljs-string">"</span></span> <span class="hljs-variable"><span class="hljs-variable">$root_location_p1</span></span> { default @allow_limit; <span class="hljs-string"><span class="hljs-string">"~^1:"</span></span> @allow; <span class="hljs-string"><span class="hljs-string">"~^2:1"</span></span> @allow_limit; <span class="hljs-string"><span class="hljs-string">"~^0"</span></span> @loc_403; <span class="hljs-string"><span class="hljs-string">"~^2:0"</span></span> @loc_403; <span class="hljs-string"><span class="hljs-string">"2:2:1:0"</span></span> @loc_403; <span class="hljs-string"><span class="hljs-string">"2:2:1:1"</span></span> @loc_403; <span class="hljs-string"><span class="hljs-string">"2:2:0:1"</span></span> @loc_403; } map <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$searchbot</span></span></span><span class="hljs-string">:</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$valid_addr</span></span></span><span class="hljs-string">:</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$bad_post_referer</span></span></span><span class="hljs-string">:</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$bad_query</span></span></span><span class="hljs-string">"</span></span> <span class="hljs-variable"><span class="hljs-variable">$root_only_location_p1</span></span> { default @allow_limit; <span class="hljs-string"><span class="hljs-string">"~^1:"</span></span> @allow; <span class="hljs-string"><span class="hljs-string">"~^2:1"</span></span> @allow_limit; <span class="hljs-string"><span class="hljs-string">"~^0"</span></span> @loc_403; <span class="hljs-string"><span class="hljs-string">"~^2:0"</span></span> @loc_403; <span class="hljs-string"><span class="hljs-string">"2:2:1:0"</span></span> @loc_403; <span class="hljs-string"><span class="hljs-string">"2:2:1:1"</span></span> @loc_403; <span class="hljs-string"><span class="hljs-string">"2:2:0:1"</span></span> @loc_403; } <span class="hljs-comment"><span class="hljs-comment">######################################################## server { listen 80; listen 443 ssl; fastcgi_read_timeout 300s; fastcgi_send_timeout 300s; fastcgi_connect_timeout 300s; server_name domain.ru www.domain.ru m.domain.ru www.m.domain.ru; ssl_certificate ssl/www.domain.ru.crt; ssl_certificate_key ssl/www.domain.ru.key; charset UTF-8; access_log /srv/www/domain/shared/log/domain-acc.log main; error_log /srv/www/domain/shared/log/domain-err.log; root /srv/www/domain/current/public/; error_page 500 502 /highla.html; #  capcha   POST  action="/checkcapcha.php" location = /highla.html { charset UTF-8; root /srv/www/domain/current/public/; allow all; } #       . location = /checkcapcha.php { charset UTF-8; root /srv/www/domain/current/public/; include fastcgi_params; fastcgi_buffers 8 16k; fastcgi_buffer_size 32k; fastcgi_index index.php; fastcgi_param SCRIPT_FILENAME $realpath_root$fastcgi_script_name; fastcgi_param REQUEST_SCHEME $scheme; fastcgi_param HTTPS $https if_not_empty; fastcgi_pass 127.0.0.1:9000; allow all; } #  location       map location @loc_403 { access_log /srv/www/domain/shared/log/loc_403-acc main; return 403; } location @allow { access_log /srv/www/domain/shared/log/allow-acc main; add_header X-debug-message "Allow"; try_files $uri /index.php?$query_string; } location @allow_limit { limit_req zone=newone burst=15; access_log /srv/www/domain/shared/log/allow-acc main; add_header X-debug-message "Allow"; try_files $uri /index.php?$query_string; } location @deny { access_log /srv/www/domain/shared/log/deny-acc main; add_header X-debug-message "Deny"; return 403; } location @restrict { access_log /srv/www/domain/shared/log/resrtict-acc main; add_header X-debug-message "Restrict"; return 502; } location / { try_files /fake-nonexistens-location-forr273 $root_location_p1; } location = / { try_files /fake-nonexistens-location-forr273 $root_only_location_p1; } location ~* \.php { include fastcgi_params; fastcgi_buffers 8 16k; fastcgi_buffer_size 32k; fastcgi_index index.php; fastcgi_param SCRIPT_FILENAME $realpath_root$fastcgi_script_name; fastcgi_param REQUEST_SCHEME $scheme; fastcgi_param HTTPS $https if_not_empty; fastcgi_pass 127.0.0.1:9000; } location ~* \.(jpg|jpeg|gif|png|ico|css|zip|tgz|gz|rar|bz2|doc|xls|exe|pdf|ppt|tar|mid|midi|wav|bmp|rtf|js|swf|flv|avi|djvu|mp3)$ { root /srv/www/domain/current/public; expires 7d; access_log off; log_not_found off; } location ~ /\.git { deny all; } location ~ /\.ht { deny all; } location ~ /\.svn { deny all; } }</span></span></code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Config for high LA mode vhosts.d/fpm.domain.ru.ddos:</b> <div class="spoiler_text"><pre> <code class="bash hljs">include vhosts.d/map.domain.ru.inc; map <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$searchbot</span></span></span><span class="hljs-string">:</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$valid_addr</span></span></span><span class="hljs-string">:</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$bad_referer</span></span></span><span class="hljs-string">:</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$bad_query</span></span></span><span class="hljs-string">"</span></span> <span class="hljs-variable"><span class="hljs-variable">$root_location</span></span> { default @main; <span class="hljs-string"><span class="hljs-string">"~^1:"</span></span> @allow; <span class="hljs-string"><span class="hljs-string">"~^2:1"</span></span> @allow; <span class="hljs-string"><span class="hljs-string">"~^0"</span></span> @loc_403; <span class="hljs-string"><span class="hljs-string">"~^2:0"</span></span> @loc_403; <span class="hljs-string"><span class="hljs-string">"2:2:1:0"</span></span> @loc_403; <span class="hljs-string"><span class="hljs-string">"2:2:1:1"</span></span> @loc_403; <span class="hljs-string"><span class="hljs-string">"2:2:0:1"</span></span> @loc_403; } map <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$searchbot</span></span></span><span class="hljs-string">:</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$valid_addr</span></span></span><span class="hljs-string">:</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$bad_post_referer</span></span></span><span class="hljs-string">:</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$bad_query</span></span></span><span class="hljs-string">"</span></span> <span class="hljs-variable"><span class="hljs-variable">$root_only_location</span></span> { default @main; <span class="hljs-string"><span class="hljs-string">"~^1:"</span></span> @allow; <span class="hljs-string"><span class="hljs-string">"~^2:1"</span></span> @allow; <span class="hljs-string"><span class="hljs-string">"~^0"</span></span> @loc_403; <span class="hljs-string"><span class="hljs-string">"~^2:0"</span></span> @loc_403; <span class="hljs-string"><span class="hljs-string">"2:2:1:0"</span></span> @loc_403; <span class="hljs-string"><span class="hljs-string">"2:2:1:1"</span></span> @loc_403; <span class="hljs-string"><span class="hljs-string">"2:2:0:1"</span></span> @loc_403; } map <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$allowed_country</span></span></span><span class="hljs-string">:</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$allowed_cookie</span></span></span><span class="hljs-string">"</span></span> <span class="hljs-variable"><span class="hljs-variable">$main_location</span></span> { <span class="hljs-string"><span class="hljs-string">"1:0"</span></span> @allow_limit; <span class="hljs-string"><span class="hljs-string">"1:1"</span></span> @allow_limit; <span class="hljs-string"><span class="hljs-string">"0:1"</span></span> @allow_limit; default @restrict; } <span class="hljs-comment"><span class="hljs-comment">######################################################## server { listen 80; listen 443 ssl; fastcgi_read_timeout 300s; fastcgi_send_timeout 300s; fastcgi_connect_timeout 300s; server_name domain.ru www.domain.ru m.domain.ru www.m.domain.ru; ssl_certificate ssl/www.domain.ru.crt; ssl_certificate_key ssl/www.domain.ru.key; charset UTF-8; access_log /srv/www/domain/shared/log/domain-acc.log main; error_log /srv/www/domain/shared/log/domain-err.log; root /srv/www/domain/current/public/; #  capcha   POST  action="/checkcapcha.php" error_page 500 502 /highla.html; location = /highla.html { charset UTF-8; root /srv/www/domain/current/public/; allow all; } #       . location = /checkcapcha.php { charset UTF-8; root /srv/www/domain/current/public/; include fastcgi_params; fastcgi_buffers 8 16k; fastcgi_buffer_size 32k; fastcgi_index index.php; fastcgi_param SCRIPT_FILENAME $realpath_root$fastcgi_script_name; fastcgi_param REQUEST_SCHEME $scheme; fastcgi_param HTTPS $https if_not_empty; fastcgi_pass 127.0.0.1:9000; allow all; } #  location       map location @loc_403 { access_log /srv/www/domain/shared/log/loc_403-acc main; return 403; } location @allow { access_log /srv/www/domain/shared/log/allow-acc main; add_header X-debug-message "Allow"; try_files $uri /index.php?$query_string; } location @allow_limit { limit_req zone=newone burst=55; access_log /srv/www/domain/shared/log/allow-limit-acc main; add_header X-debug-message "Allow"; try_files $uri /index.php?$query_string; } location @deny { access_log /srv/www/domain/shared/log/deny-acc main; add_header X-debug-message "Deny"; return 403; } location @restrict { access_log /srv/www/domain/shared/log/resrtict-acc main; add_header X-debug-message "Restrict"; return 502; } location @main { add_header X-debug-message "Main"; try_files /fake-nonexistens-location-forr273 $main_location; } location / { try_files /fake-nonexistens-location-forr273 $root_location; } location = / { try_files /fake-nonexistens-location-forr273 $root_only_location; } location ~* \.php { include fastcgi_params; fastcgi_buffers 8 16k; fastcgi_buffer_size 32k; fastcgi_index index.php; fastcgi_param SCRIPT_FILENAME $realpath_root$fastcgi_script_name; fastcgi_param REQUEST_SCHEME $scheme; fastcgi_param HTTPS $https if_not_empty; fastcgi_pass 127.0.0.1:9000; } location ~* \.(jpg|jpeg|gif|png|ico|css|zip|tgz|gz|rar|bz2|doc|xls|exe|pdf|ppt|tar|mid|midi|wav|bmp|rtf|js|swf|flv|avi|djvu|mp3)$ { root /srv/www/domain/current/public; expires 7d; access_log off; log_not_found off; } location ~ /\.git { deny all; } location ~ /\.ht { deny all; } location ~ /\.svn { deny all; } }</span></span></code> </pre><br></div></div><br><h5>  Total </h5><br>  With this solution, we helped our client protect their project from spurious traffic and increase server stability. <br>  Author: Leading System Administrator of the <a href="http://centos-admin.ru/">company</a> Marat Rakhimov. </div><p>Source: <a href="https://habr.com/ru/post/278553/">https://habr.com/ru/post/278553/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../278541/index.html">We invite you to a round table on gaming industry trends.</a></li>
<li><a href="../278545/index.html">Complex hardware nodes, simultaneous parallel execution and kernel / system runtime</a></li>
<li><a href="../278547/index.html">6 secrets of Bitbucket</a></li>
<li><a href="../278549/index.html">Security firmware on the example of the Intel Management Engine</a></li>
<li><a href="../278551/index.html">fsharpConf 2016 - Live Broadcast of the F # Virtual Conference</a></li>
<li><a href="../278555/index.html">Security Week 09: DROWN attack, HackingTeam returns, impressions from RSA Conference 2016</a></li>
<li><a href="../278557/index.html">Three small but useful buns in Laravel 5.2.22</a></li>
<li><a href="../278559/index.html">New resource about Intel technologies for game developers on Unity3D.com</a></li>
<li><a href="../278561/index.html">Interfaces - the most important concept in software development</a></li>
<li><a href="../278563/index.html">Intensive announcement on ASP.NET Core at the Microsoft DevCon 2016 conference</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>