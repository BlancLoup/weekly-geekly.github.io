<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Ethereum Smart Contract Testing for Go: Goodbye JavaScript</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I want to thank my colleagues: Sergey Nemesh, Mikhail Popsuev, Evgeny Babich and Igor Titarenko for their advice, feedback and testing. I also want to...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Ethereum Smart Contract Testing for Go: Goodbye JavaScript</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://cdn-images-1.medium.com/max/1600/1*WNQyyGK2TrOy2m784kJang.jpeg" alt="image"><br>  <em>I want to thank my colleagues: Sergey Nemesh, Mikhail Popsuev, Evgeny Babich and Igor Titarenko for their advice, feedback and testing.</em>  <em>I also want to say thank you to the PolySwarm team for developing the original version of Perigord.</em> <em><br></em> <br>  <em>This is a translation of my first published article in <a href="https://medium.com/%40olena_stoliarova/test-ethereum-smart-contracts-with-go-tell-javascript-goodbye-561789abc04b">Medium</a> on English.</em> </p><br><p>  Testing has always been an integral part of software development, although not the most enjoyable.  When it comes to smart contracts, thorough testing is needed with exceptional attention to detail, because  errors will not be fixed after deployment in the blockchain network.  In recent years, the Ethereum community has created many tools for developing smart contracts.  Some of them did not become popular, for example, Vyper is a Python dialect for writing smart contracts.  Others, such as Solidity, have become the recognized standard.  The most extensive test documentation for smart contracts today is provided by the Truffle &amp; Ganache bundle.  Both of these tools have good documentation, many cases have already been solved on Stack Overflow and similar resources.  However, this approach has one important drawback: Node.js should be used for writing tests. </p><a name="habracut"></a><br><h4 id="lovushki-javascript">  JavaScript traps </h4><br><p>  Even if you are not a fan of static-typed programming languages ‚Äã‚Äãand like JavaScript, think about what you can make a typo and start comparing the result of executing a function that returns a string with a boolean value using the outdated equal method instead of strictEqual. </p><br><pre><code class="plaintext hljs">let proposalExists = await voting.checkProposal(); assert.equal(proposalExists, true, 'Proposal should exist');</code> </pre> <br><p>  If checkProposal returns the string ‚Äúyes‚Äù or ‚Äúno‚Äù, you always convert them to true.  Dynamic typing hides many such pitfalls, and even experienced programmers can make similar mistakes while working on a large project or in a team with other developers who can make changes to the code and not report it. </p><br><p>  Static typing in Go allows you to prevent such errors.  In addition, the use of the Go language instead of Node.js for testing is the dream of any Go-developer who starts working with smart contracts. </p><br><p>  My team has been developing an investment system based on smart contracts with a very complex architecture.  The smart contract system contained over 2000 lines of code.  Since the main part of the team were Go-developers, testing for Go was preferable to Node.js. </p><br><h4 id="pervaya-sreda-dlya-testirovaniya-smart-kontraktov-na-go">  The first environment to test smart contracts on Go </h4><br><p>  In 2017, PolySwarm was developed by <a href="https://github.com/polyswarm/perigord">Perigord</a> , a tool similar to Truffle, using Go instead of JavaScript.  Unfortunately, this project is no longer supported, it has only one tutorial with very simple examples.  In addition, it does not support integration with Ganache (a private blockchain for developing Ethereum with a very convenient GUI).  We improved Perigord by eliminating bugs and introducing two new functions: generating wallets from the mnemonic code and using them to test and connect to the Ganache blockchain.  You can view the source code <a href="https://gitlab.com/go-truffle/enhanced-perigord">here</a> . </p><br><p>  The original Perigord tutorial contains only the simplest example of calling a contract to change a single value.  However, in the real world, you also need to call a contract from different wallets, send and receive Ether, etc.  Now you can do all this using advanced Perigord and good old Ganache.  Below you will find a detailed guide to developing and testing smart contracts with Perigord &amp; Ganache. </p><br><h4 id="ispolzovanie-uluchshennogo-perigord-polnoe-rukovodstvo">  Using Improved Perigord: The Complete Guide </h4><br><p>  To use Perigord, you need to install Go 1.7+, solc, abigen and ganache.  Please read the documentation for your operating system. </p><br><p>  Install Perigord as follows: </p><br><pre> <code class="plaintext hljs">$ go get gitlab.com/go-truffle/enhanced-perigord $ go build</code> </pre> <br><p>  After that you can use the perigord command: </p><br><pre> <code class="plaintext hljs">$ perigord A golang development environment for Ethereum Usage: perigord [command] Available Commands: add Add a new contract or test to the project build (alias for compile) compile Compile contract source files deploy (alias for migrate) generate (alias for compile) help Help about any command init Initialize new Ethereum project with example contracts and tests migrate Run migrations to deploy contracts test Run go and solidity tests Flags: -h, --help help for perigord Use "perigord [command] --help" for more information about a command.</code> </pre> <br><p>  We will now create a simple Smart Market contract to demonstrate the available test options. </p><br><p>  To start a project, enter the following into the terminal: </p><br><pre> <code class="plaintext hljs">$ perigord init market</code> </pre> <br><p>  The project will appear in the src / folder of GOPATH.  Move the project to another folder and update the import paths if you want to change its location.  Let's see what is in the market / folder. </p><br><pre> <code class="plaintext hljs">$ tree . ‚îú‚îÄ‚îÄ contracts ‚îÇ ‚îî‚îÄ‚îÄ Foo.sol ‚îú‚îÄ‚îÄ generate.go ‚îú‚îÄ‚îÄ main.go ‚îú‚îÄ‚îÄ migrations ‚îÇ ‚îî‚îÄ‚îÄ 1_Migrations.go ‚îú‚îÄ‚îÄ perigord.yaml ‚îú‚îÄ‚îÄ stub ‚îÇ ‚îú‚îÄ‚îÄ README.md ‚îÇ ‚îî‚îÄ‚îÄ main.go ‚îú‚îÄ‚îÄ stub_test.go ‚îî‚îÄ‚îÄ tests ‚îî‚îÄ‚îÄ Foo.go</code> </pre> <br><p>  Very similar to the project created in Truffle, is not it?  But this is all on Go!  Let's see what's in the perigord.yaml configuration file. </p><br><pre> <code class="plaintext hljs">networks: dev: url: /tmp/geth_private_testnet/geth.ipc keystore: /tmp/geth_private_testnet/keystore passphrase: blah mnemonic: candy maple cake sugar pudding cream honey rich smooth crumble sweet treat num_accounts: 10</code> </pre> <br><p>  For testing, you can use both the geth private network and wallet files, as well as connect to Ganache.  These options are mutually exclusive.  We take the default mnemonic, generate 10 accounts and connect to Ganache.  Replace the code in perigord.yaml with: </p><br><pre> <code class="plaintext hljs">networks: dev: url: HTTP://127.0.0.1:7545 mnemonic: candy maple cake sugar pudding cream honey rich smooth crumble sweet treat num_accounts: 10</code> </pre> <br><p>  <a href="http://127.0.0.1:7545/">HTTP://127.0.0.1:7545</a> - the standard address of the server Ganache RPC.  Please note that you can create as many accounts as you wish for testing, but only accounts generated in Ganache (GUI) will contain funds. </p><br><p>  We will create a contract called Market.sol.  He can keep a record of address pairs, one of which sends funds to the account of the contract, and the other has the right to receive funds when the owner of the contract gives permission for such a transaction.  For example, two parties do not trust each other, but trust the contract owner, who decides whether a certain condition is met.  The example implements several basic functions for demonstration purposes. </p><br><p>  Add a contact to the project: </p><br><pre> <code class="plaintext hljs">$ perigord add contract Market</code> </pre> <br><p>  Postfix .sol will be added automatically.  You can also add other contracts or delete the example contract Foo.sol.  While you work at GOPATH, you can use import contracts to create complex structures.  We will have three Solidity files: the main Market contract, the Ownable and Migrations auxiliary contracts, and the SafeMath library.  You can find the source code <a href="https://gitlab.com/go-truffle/perigord-contract-example">here</a> . </p><br><p>  Now the project has the following structure: </p><br><pre> <code class="plaintext hljs">. ‚îú‚îÄ‚îÄ contracts ‚îÇ ‚îú‚îÄ‚îÄ Market.sol ‚îÇ ‚îú‚îÄ‚îÄ Ownable.sol ‚îÇ ‚îî‚îÄ‚îÄ SafeMath.sol ‚îú‚îÄ‚îÄ generate.go ‚îú‚îÄ‚îÄ main.go ‚îú‚îÄ‚îÄ migrations ‚îÇ ‚îî‚îÄ‚îÄ 1_Migrations.go ‚îú‚îÄ‚îÄ perigord.yaml ‚îú‚îÄ‚îÄ stub ‚îÇ ‚îú‚îÄ‚îÄ README.md ‚îÇ ‚îî‚îÄ‚îÄ main.go ‚îú‚îÄ‚îÄ stub_test.go ‚îî‚îÄ‚îÄ tests ‚îî‚îÄ‚îÄ Foo.go</code> </pre> <br><p>  We generate byte-code EVM, ABI and Go bindings: </p><br><pre> <code class="plaintext hljs">$ perigord build</code> </pre> <br><p>  We add migrations of all contracts that you will deploy.  Because  we only deploy Market.sol, we need only one new migration: </p><br><pre> <code class="plaintext hljs">$ perigord add migration Market</code> </pre> <br><p>  Our contract does not contain a constructor that accepts parameters.  If you need to pass parameters to the constructor, add them to the Deploy {NewContract} function in the migration file: </p><br><pre> <code class="plaintext hljs">address, transaction, contract, err := bindings.Deploy{NewContract}(auth, network.Client(), ‚ÄúFOO‚Äù, ‚ÄúBAR‚Äù)</code> </pre> <br><p>  Delete the sample file Foo.go and add a test file for our contract: </p><br><pre> <code class="plaintext hljs">$ perigord add test Market</code> </pre> <br><p>  To use deterministic wallets, we need to read the mnemonic from the configuration file: </p><br><pre> <code class="plaintext hljs">func getMnemonic() string { viper.SetConfigFile("perigord.yaml") if err := viper.ReadInConfig(); err != nil { log.Fatal() } mnemonic := viper.GetStringMapString("networks.dev")["mnemonic"] return mnemonic }</code> </pre> <br><p>  The following auxiliary function is used to get the network address: </p><br><pre> <code class="plaintext hljs">func getNetworkAddress() string { viper.SetConfigFile("perigord.yaml") if err := viper.ReadInConfig(); err != nil { log.Fatal() } networkAddr := viper.GetStringMapString("networks.dev")["url"] return networkAddr }</code> </pre> <br><p>  Another auxiliary function that we need is sendETH, we will use it to transfer Ether from one of the generated wallets (indicated by the index) to any Ethereum address: </p><br><pre> <code class="plaintext hljs">func sendETH(s *MarketSuite, c *ethclient.Client, sender int, receiver common.Address, value *big.Int) { senderAcc := s.network.Accounts()[sender].Address nonce, err := c.PendingNonceAt(context.Background(), senderAcc) if err != nil { log.Fatal(err) } gasLimit := uint64(6721975) // in units gasPrice := big.NewInt(3700000000) wallet, err := hdwallet.NewFromMnemonic(getMnemonic()) toAddress := receiver var data []byte tx := types.NewTransaction(nonce, toAddress, value, gasLimit, gasPrice, data) chainID, err := c.NetworkID(context.Background()) if err != nil { log.Fatal(err) } privateKey, err := wallet.PrivateKey(s.network.Accounts()[sender]) signedTx, err := types.SignTx(tx, types.NewEIP155Signer(chainID), privateKey) if err != nil { log.Fatal(err) } ts := types.Transactions{signedTx} rawTx := hex.EncodeToString(ts.GetRlp(0)) var trx *types.Transaction rawTxBytes, err := hex.DecodeString(rawTx) err = rlp.DecodeBytes(rawTxBytes, &amp;trx) err = c.SendTransaction(context.Background(), trx) if err != nil { log.Fatal(err) } }</code> </pre> <br><p>  The following two functions are used to modify a contract call: </p><br><pre> <code class="plaintext hljs">func ensureAuth(auth bind.TransactOpts) *bind.TransactOpts { return &amp;bind.TransactOpts{ auth.From, auth.Nonce, auth.Signer, auth.Value, auth.GasPrice, auth.GasLimit, auth.Context} } func changeAuth(s MarketSuite, account int) bind.TransactOpts { return *s.network.NewTransactor(s.network.Accounts()[account]) }</code> </pre> <br><h4 id="procedura-testirovaniya">  Testing procedure </h4><br><p>  To call, we create a contractSessionActual for a specific contract.  Because  the contract has an owner, we can get its address and check whether it corresponds to the default zero Ganache account.  We do this as follows (we omit error handling to save space): </p><br><pre> <code class="plaintext hljs">contractSession := contract.Session("Market") c.Assert(contractSession, NotNil) contractSessionActual, ok := contractSession.(*bindings.MarketSession) c.Assert(ok, Equals, true) c.Assert(contractSessionActual, NotNil) owner, _ := contractSessionActual.Owner() account0 := s.network.Accounts()[0] c.Assert(owner.Hex(), Equals, account0.Address.Hex()) //Owner account is account 0</code> </pre> <br><p>  The next useful feature is to change the wallet calling the contract: </p><br><pre> <code class="plaintext hljs">ownerInd := 0 sender := 5 receiver := 6 senderAcc := s.network.Accounts()[sender].Address receiverAcc := s.network.Accounts()[receiver].Address //Call contract on behalf of its owner auth := changeAuth(*s, ownerInd) _, err = contractSessionActual.Contract.SetSenderReceiverPair(ensureAuth(auth), senderAcc, receiverAcc)</code> </pre> <br><p>  Because  One of the main functions used in testing is changing the calling contract, let's make a payment on behalf of the sender: </p><br><pre> <code class="plaintext hljs">auth = changeAuth(*s, sender) //Change auth fo senderAcc to make a deposit on behalf of the sender client, _ := ethclient.Dial(getNetworkAddress()) //Let's check the current balance balance, _ := client.BalanceAt(context.Background(), contract.AddressOf("Market"), nil) c.Assert(balance.Int64(), Equals, big.NewInt(0).Int64()) //Balance should be 0 //Let's transfer 3 ETH to the contract on behalf of the sender value := big.NewInt(3000000000000000000) // in wei (3 eth) contractReceiver := contract.AddressOf("Market") sendETH(s, client, sender, contractReceiver, value) balance2, _ := client.BalanceAt(context.Background(), contract.AddressOf("Market"), nil) c.Assert(balance2.Int64(), Equals, value.Int64()) //Balance should be 3 ETH</code> </pre> <br><p>  The full test code is <a href="https://gitlab.com/go-truffle/perigord-contract-example">here</a> . </p><br><p>  Now open stub_test.go and make sure that all imports point to your current project.  In our case it is: </p><br><pre> <code class="plaintext hljs">import ( _ "market/migrations" _ "market/tests" "testing" . "gopkg.in/check.v1" )</code> </pre> <br><p>  Run the tests: </p><br><pre> <code class="plaintext hljs">$ perigord test</code> </pre> <br><p>  If everything is done correctly, after the end of testing there will be a similar result: </p><br><pre> <code class="plaintext hljs">Running migration 2 Running migration 3 OK: 1 passed PASS ok market 0.657s</code> </pre> <br><p>  If you have problems, download the source <a href="https://gitlab.com/go-truffle/perigord-contract-example">files</a> and repeat the steps in this guide. </p><br><h4 id="v-zaklyuchenie">  Finally </h4><br><p>  Perigord is a robust testing tool written in your favorite language.  It creates the same project structure as Truffle, and has the same commands, so you will not need to relearn.  Static typing and an unambiguous signature of functions allow you to quickly develop and execute debugging, and also largely protect against typos in arguments.  In Perigord, you can easily migrate an existing project to Truffle (all you need is to copy and paste the contract files into the appropriate folder and add tests), as well as start a completely new project with tests written in Go. </p><br><p>  I hope that the work begun by the PolySwarm team and continued by Inn4Science will be useful for the Go community and free from hours of testing and debugging using less convenient tools. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/445254/">https://habr.com/ru/post/445254/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../445238/index.html">Grow Big: Top 10 Reports Mobius 2018 Moscow</a></li>
<li><a href="../445240/index.html">How to move, unload and integrate very large data cheaply and quickly? What is pushdown optimization?</a></li>
<li><a href="../445242/index.html">Experience using Coroutines and Retrofit2</a></li>
<li><a href="../445244/index.html">"Money games outside the blockchain must die"</a></li>
<li><a href="../445252/index.html">Digital rights got to Russia</a></li>
<li><a href="../445256/index.html">Cybercriminals controlled ASUS Live Update for five months</a></li>
<li><a href="../445260/index.html">Will robots ever truly realize themselves? Scientists are moving in this direction.</a></li>
<li><a href="../445262/index.html">GeekUniversity opens a set of Big Data Analytics Faculty</a></li>
<li><a href="../445264/index.html">Preload, prefetch and other tags</a></li>
<li><a href="../445266/index.html">GeekBrains together with Rostelecom will hold IoT Hackathon</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>