<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Flask Mega-Tutorial, Part XVII: Deploying Under Linux</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="(edition 2018) 
 Miguel grinberg 



 There 


 This is the seventeenth part of the Flask Mega-tutorial series, in which I am going to deploy a microb...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Flask Mega-Tutorial, Part XVII: Deploying Under Linux</h1><div class="post__text post__text-html js-mediator-article"><h2 id="izdanie-2018">  (edition 2018) </h2><br><h3 id="miguel-grinberg">  <em>Miguel grinberg</em> </h3><br><hr><br><p><img src="https://habrastorage.org/webt/jl/jn/bb/jljnbbjr-ejh473xy_eccsmknpk.png">  <a href="https://habrahabr.ru/post/351900/">There</a> <img src="https://habrastorage.org/webt/rw/dy/-g/rwdy-grsvbpcetjttrmecdkxtlk.png"></p><br><p>  This is the seventeenth part of the Flask Mega-tutorial series, in which I am going to deploy a microblog on a Linux server. </p><a name="habracut"></a><br><p>  Under the spoiler is a list of all articles in this 2018 series. </p><br><div class="spoiler">  <b class="spoiler_title">Table of contents</b> <div class="spoiler_text"><ul><li>  <a href="https://habrahabr.ru/post/346306/"><strong>Chapter 1: Hello world!</strong></a> </li><li>  <a href="https://habrahabr.ru/post/346340/"><strong>Chapter 2: Templates</strong></a> </li><li>  <a href="https://habrahabr.ru/post/346342/"><strong>Chapter 3: Web Forms</strong></a> </li><li>  <a href="https://habrahabr.ru/post/346344/"><strong>Chapter 4: Database</strong></a> </li><li>  <a href="https://habrahabr.ru/post/346346/"><strong>Chapter 5: User Logins</strong></a> </li><li>  <a href="https://habrahabr.ru/post/346348/"><strong>Chapter 6: Profile Page and Avatars</strong></a> </li><li>  <a href="https://habrahabr.ru/post/346880/"><strong>Chapter 7: Error Handling</strong></a> </li><li>  <a href="https://habrahabr.ru/post/347450/"><strong>Chapter 8: Subscribers, Contacts, and Friends</strong></a> </li><li>  <a href="https://habrahabr.ru/post/347926/"><strong>Chapter 9: Pagination</strong></a> </li><li>  <a href="https://habrahabr.ru/post/348566/"><strong>Chapter 10: Email Support</strong></a> </li><li>  <a href="https://habrahabr.ru/post/349060/"><strong>Chapter 11: Reconstruction</strong></a> </li><li>  <a href="https://habrahabr.ru/post/349604/"><strong>Chapter 12: Date and Time</strong></a> </li><li>  <a href="https://habrahabr.ru/post/350148/"><strong>Chapter 13: I18n and L10n</strong></a> </li><li>  <a href="https://habrahabr.ru/post/350626/"><strong>Chapter 14: Ajax</strong></a> </li><li>  <a href="https://habrahabr.ru/post/351218/"><strong>Chapter 15: Improving Application Structure</strong></a> </li><li>  <a href="https://habrahabr.ru/post/351900/"><strong>Chapter 16: Full Text Search</strong></a> </li><li>  <a href="https://habrahabr.ru/post/352266/"><strong>Chapter 17: Deploying to Linux</strong></a> (This article) </li><li>  <a href="https://habrahabr.ru/post/352830/"><strong>Chapter 18: Deploying to Heroku</strong></a> </li><li>  <a href="https://habrahabr.ru/post/353234/"><strong>Chapter 19: Deploying to Docker Containers</strong></a> </li><li>  <a href="https://habrahabr.ru/post/353804/"><strong>Chapter 20: JavaScript Magic</strong></a> </li><li>  Chapter 21: User Notifications (Available April 24, 2018) </li><li>  Chapter 22: Reference Tasks (Available May 1, 2018) </li><li>  Chapter 23: Application Programming Interfaces (APIs) (Available May 8, 2018) </li></ul></div></div><br><p>  <em>Note 1: If you are looking for old versions of this course, this is <a href="https://blog.miguelgrinberg.com/post/the-flask-mega-tutorial-part-i-hello-world-legacy" title="here">here</a> .</em> </p><br><p>  <em>Note 2: If suddenly you would like to speak in support of my (Miguel) work, or simply do not have the patience to wait for the article for a week, I (Miguel Greenberg) offer the full version of this manual (in English) in the form of an electronic book or video.</em>  <em>For more information, visit <a href="http://learn.miguelgrinberg.com/" title="learn.miguelgrinberg.com">learn.miguelgrinberg.com</a> .</em> </p><br><p>  This chapter is an important milestone in the life of my Microblog application, as it is time to discuss how it can be deployed on a working server for access by real users. </p><br><p>  The topic of deployment is extensive, and for this reason it is impossible to cover all possible options within one chapter.  This chapter is devoted to the study of traditional hosting options, and I‚Äôm going to use a dedicated Linux server running Ubuntu, as well as the widely used Raspberry Pi mini-computer, as research objects.  About other options, such as the deployment of clouds and containers, I will discuss in subsequent chapters. </p><br><p>  <em>GitHub links for this chapter:</em> <a href="">Browse</a> , <a href="">Zip</a> , <a href="">Diff</a> . </p><br><h2 id="tradicionnyy-hosting">  Traditional hosting </h2><br><p>  When I talk about "traditional hosting", I mean that the application is installed manually or through a script installer on a regular server.  The process involves installing the application, its dependencies, and a production scale web server plus setting up the security system. </p><br><p>  The first question to ask when deploying your own project is where to find the server.  Nowadays, there are many low-cost hosting services.  For example, for $ 5 a month, <a href="https://www.digitalocean.com/">Digital Ocean</a> , <a href="https://www.linode.com/">Linode,</a> or <a href="https://amazonlightsail.com/">Amazon Lightsail</a> will lease a virtual Linux server (VPS) for you to conduct deployment experiments.  (Linode and Digital Ocean provide their entry-level servers with 1 GB of RAM, while Amazon provides only 512 MB.)  If you prefer to practice without spending money, then <a href="https://www.vagrantup.com/">Vagrant</a> and <a href="https://www.virtualbox.org/">VirtualBox are</a> two tools that, when combined, allow you to create a virtual server, like a paid one, on your own computer. </p><br><p>  As for the choice of operating system, from a technical point of view, this application can be deployed to any of the major operating systems, a list that includes a large number of open source Linux and BSD distributions, as well as commercial OS X and Microsoft Windows ( although OS X is a hybrid version of open-source / commercial, since it is based on Darwin (an open source BSD derivative). </p><br><p>  Since OS X and Windows are desktop operating systems that are not optimized to work as servers, I am going to immediately abandon such candidates.  The choice between the Linux or BSD operating system is largely based on preferences, so I'm going to choose the most popular of the two, which is Linux.  As for Linux distributions, I think it would be fair to make a choice in popularity and continue with Ubuntu. </p><br><h2 id="server-ubuntu">  Ubuntu server </h2><br><p>  If you are interested in this deployment with me, then you obviously need a server to work with.  I will recommend you two options for acquiring a server, one paid and one free.  If you are ready to spend some money, you can get an account with Digital Ocean, Linode or Amazon Lightsail and create a virtual server Ubuntu 16.04.  You will only need to use the smallest server version, which today, when I write this phrase, costs $ 5 per month for all three suppliers from the above list.  Payment is hourly, so if you create a server, play with it for a few hours, and then delete it, you only pay with cents. </p><br><p>  The free alternative is based on a virtual machine that you can run on your own computer.  To use this option, install <a href="https://www.vagrantup.com/">Vagrant</a> and <a href="https://www.virtualbox.org/">VirtualBox</a> on your computer, and then create a file called <em>Vagrantfile</em> to describe the specifications of your virtual machine with the following contents: </p><br><p>  <em>Vagrantfile</em> : Vagrant configuration. </p><br><pre><code class="hljs lua">Vagrant.configure(<span class="hljs-string"><span class="hljs-string">"2"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> |<span class="hljs-built_in"><span class="hljs-built_in">config</span></span>| <span class="hljs-built_in"><span class="hljs-built_in">config</span></span>.vm.box = <span class="hljs-string"><span class="hljs-string">"ubuntu/xenial64"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">config</span></span>.vm.network <span class="hljs-string"><span class="hljs-string">"private_network"</span></span>, ip: <span class="hljs-string"><span class="hljs-string">"192.168.33.10"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">config</span></span>.vm.provider <span class="hljs-string"><span class="hljs-string">"virtualbox"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> |vb| vb.memory = <span class="hljs-string"><span class="hljs-string">"1024"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre> <br><p>  This file configures the Ubuntu 16.04 server with 1 GB of RAM, from which you can access the host computer at the IP address 192.168.33.10.  To create a server, run the following command: </p><br><pre> <code class="hljs ruby">$ vagrant up</code> </pre> <br><p>  In <a href="https://www.vagrantup.com/docs/cli/">the</a> Vagrant <a href="https://www.vagrantup.com/docs/cli/">command line documentation</a> , you will learn about other options for managing a virtual server. </p><br><h2 id="ispolzovanie-ssh-klienta">  Using SSH client </h2><br><p>  Your server is console, so you will not have a desktop like on your own computer.  You will need to connect to your server via an SSH client and work with it via the command line.  If you are using Linux or Mac OS X, most likely <a href="http://www.openssh.org/">OpenSSH is</a> already installed.  If you are using Microsoft Windows, <a href="https://www.cygwin.com/">Cygwin</a> , <a href="https://git-scm.com/">Git</a> and <a href="https://msdn.microsoft.com/en-us/commandline/wsl/about">Windows Subsystem for Linux</a> , they also provide the option to use OpenSSH, so you can install any of these options. </p><br><p>  If you are using a third-party virtual server, then when you created the server, you were given an IP address.  You can open a terminal session with your new server with the following command: </p><br><pre> <code class="hljs pgsql">$ ssh root@&lt;<span class="hljs-keyword"><span class="hljs-keyword">server</span></span>-ip-address&gt;</code> </pre> <br><p>  You will be prompted to enter a password.  Depending on the service, the password can be automatically generated and shown to you after the server is created, or perhaps you yourself have given the opportunity to choose your own password. </p><br><p>  If you are using a Vagrant VM, you can open a terminal session with the command: </p><br><pre> <code class="hljs ruby">$ vagrant ssh</code> </pre> <br><p>  If you are using Windows and Vagrant VM, note that you will need to run the above command from the shell, which can invoke the <code>ssh</code> command from OpenSSH. </p><br><h2 id="login-bez-parolya-password-less">  Login without password (password-less) </h2><br><p>  You can skip this section if you are using a Vagrant VM, because your virtual machine is configured correctly to use a non-root account with the name <code>ubuntu</code> without an automatic password from Vagrant. </p><br><p>  If you are using a virtual server, it is recommended that you create a regular user account to perform your deployment work and configure this account to log in without using a password (password-less), which may initially seem like a bad decision, but you will see that Not only more convenient, but also safer. </p><br><p>  I'm going to create a user account named <code>ubuntu</code> (you can use a different name if you want).  To create this account, log in to the root account of your server using the <code>ssh</code> instructions from the previous section, and then enter the following commands to create a user, give it <code>sudo</code> permissions, and finally switch to it: </p><br><pre> <code class="hljs ruby">$ adduser --gecos <span class="hljs-string"><span class="hljs-string">""</span></span> ubuntu $ usermod -aG sudo ubuntu $ su ubuntu</code> </pre> <br><p>  Now I am going to configure this new <code>ubuntu</code> account to use <a href="http://en.wikipedia.org/wiki/Public-key_cryptography">public key</a> authentication so that you can log in without entering a password. </p><br><p>  Leave the terminal session that you have opened on your server, and start the second terminal on your local computer.  If you are using Windows, it should be a terminal from which you have access to the <code>ssh</code> command, so it will probably be a <code>bash</code> or similar prompt, and not a native Windows terminal.  In this terminal session, check the contents of the <em>~ / .ssh directory</em> : </p><br><pre> <code class="hljs mel">$ <span class="hljs-keyword"><span class="hljs-keyword">ls</span></span> ~/.ssh id_rsa id_rsa.pub</code> </pre> <br><p>  If there are files in the directory list with the name <em>id_rsa</em> and <em>id_rsa.pub</em> , as indicated above, then you already have the key.  If you do not have these two files or the <em>~ / .ssh</em> directory at all, you need to create your own SSH key pair by running the following command, also included in the OpenSSH toolbox: </p><br><pre> <code class="hljs ruby">$ ssh-keygen</code> </pre> <br><p>  This application prompts you to enter several values, for which I recommend that you accept the default values ‚Äã‚Äãby pressing Enter on all prompts.  If you know what you are doing and you want to do otherwise, then, as they say, the flag is in your hands. </p><br><p>  After executing this command, you should have two files listed above.  The <em>id_rsa.pub</em> file is your <em>public key-public key</em> , the file that you provide to third parties for identification.  The <em>id_rsa</em> file is your <em>private key-private key</em> that you don‚Äôt share with anyone. </p><br><p>  Now you need to configure the public key as the <em>authorized host</em> on the server.  Print your public key on the screen of the terminal that you opened on your computer: </p><br><pre> <code class="hljs ruby">$ cat ~<span class="hljs-regexp"><span class="hljs-regexp">/.ssh/id</span></span>_rsa.pub ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCjw....F8Xv4f/<span class="hljs-number"><span class="hljs-number">0</span></span>+<span class="hljs-number"><span class="hljs-number">7</span></span>WT miguel@miguelspc</code> </pre> <br><p>  It will be a very long sequence of characters, possibly spanning several lines.  You need to copy this data to the clipboard, and then switch back to the terminal on the remote server, where these commands will be issued to store the public key: </p><br><pre> <code class="hljs ruby">$ echo &lt;paste-your-key-here&gt; <span class="hljs-meta"><span class="hljs-meta">&gt;&gt; </span></span>~<span class="hljs-regexp"><span class="hljs-regexp">/.ssh/authorized</span></span>_keys $ chmod <span class="hljs-number"><span class="hljs-number">600</span></span> ~<span class="hljs-regexp"><span class="hljs-regexp">/.ssh/authorized</span></span>_keys</code> </pre> <br><p>  Now the password-less should work.  The idea is that <code>ssh</code> on your computer identifies itself on the server, performing a cryptographic operation that requires a secret key.  The server then verifies that the operation is valid using the public key. </p><br><p>  Now you can log out of your <code>ubuntu</code> session, and then from your <code>root</code> session, and then try to log in directly to your <code>ubuntu</code> account with: </p><br><pre> <code class="hljs pgsql">$ ssh ubuntu@&lt;<span class="hljs-keyword"><span class="hljs-keyword">server</span></span>-ip-address&gt;</code> </pre> <br><p>  This time you do not need to enter a password! </p><br><h2 id="zaschita-servera">  Server security </h2><br><p>  To minimize the risk of server hacking, several steps can be taken to close a number of potential doors through which an attacker can gain access. </p><br><p>  The first change that needs to be made is to disable root logins via SSH.  Now you have password-less access to your <code>ubuntu</code> account, and you can run admin commands from this account via <code>sudo</code> (on behalf of), so there really is no need to provide a root account.  To disable root logins, you need to edit the <em>/ etc / ssh / sshd_config</em> file on your server.  Perhaps <code>vi</code> and <code>nano</code> (text editors) are already installed on your server and you can use them to edit files (if you are not familiar with any of them, try <code>nano</code> first).  You will need to prefix your editor with sudo, because the SSH configuration is not available to regular users (for example, <code>sudo vi /etc/ssh/sshd_config</code> ).  You need to change one line in this file: </p><br><blockquote>  <em>/ etc / ssh / sshd_config</em> : Disable root logins. </blockquote><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">PermitRootLogin</span></span> <span class="hljs-literal"><span class="hljs-literal">no</span></span></code> </pre> <br><p>  After you finish editing the SSH configuration, you must restart the service for the changes to take effect: </p><br><pre> <code class="hljs pgsql">$ sudo service ssh <span class="hljs-keyword"><span class="hljs-keyword">restart</span></span></code> </pre> <br><p>  The third change to make is to install a firewall.  This is software that blocks access to the server on ports that are not explicitly allowed: </p><br><pre> <code class="hljs sql">$ sudo apt-get <span class="hljs-keyword"><span class="hljs-keyword">install</span></span> -y ufw $ sudo ufw <span class="hljs-keyword"><span class="hljs-keyword">allow</span></span> ssh $ sudo ufw <span class="hljs-keyword"><span class="hljs-keyword">allow</span></span> <span class="hljs-keyword"><span class="hljs-keyword">http</span></span> $ sudo ufw <span class="hljs-keyword"><span class="hljs-keyword">allow</span></span> <span class="hljs-number"><span class="hljs-number">443</span></span>/tcp $ sudo ufw <span class="hljs-comment"><span class="hljs-comment">--force enable $ sudo ufw status</span></span></code> </pre> <br><p>  These commands install UFW, a simple firewall, and configure it to allow only external traffic on ports 22 (SSH), 80 (http) and 443 (HTTPS).  Any other ports will be closed. </p><br><h2 id="ustanovka-bazovyh-zavisimostey">  Install Base Dependencies </h2><br><p>  If you followed my advice and installed the server on Ubuntu 16.04, then you already have a system with full support for Python 3.5, which I am going to use for deployment. </p><br><p>  So, we believe that the basic Python interpreter is pre-installed on your server, but there are some additional packages that are likely to be missing, and there are several other packages outside of Python that will be useful in creating a reliable, work-ready deployment.  For the database server, I'm going to switch from SQLite to MySQL.  postfix is ‚Äã‚Äãa mail transfer agent that I will use to send email.  The supervisor tool will monitor the Flask server process and automatically restart it if it ever crashes or if the server restarts.  The nginx server will accept all requests coming from outside and redirect them to the application.  Finally, I'm going to use git as a tool to download an application directly from my git repository. </p><br><pre> <code class="hljs sql">$ sudo apt-get -y <span class="hljs-keyword"><span class="hljs-keyword">update</span></span> $ sudo apt-<span class="hljs-keyword"><span class="hljs-keyword">get</span></span> -y <span class="hljs-keyword"><span class="hljs-keyword">install</span></span> python3 python3-venv python3-dev $ sudo apt-<span class="hljs-keyword"><span class="hljs-keyword">get</span></span> -y <span class="hljs-keyword"><span class="hljs-keyword">install</span></span> mysql-<span class="hljs-keyword"><span class="hljs-keyword">server</span></span> postfix supervisor nginx git</code> </pre> <br><p>  These installations are started mostly unattended, but at some point, on the third installation statement, you will be asked to select the root password for the MySQL service, and you will also be asked a few questions regarding the installation of the postfix package, in which you can accept values ‚Äã‚Äãfor default </p><br><p>  Note that for this deployment, I prefer not to install Elasticsearch.  This service requires a large amount of RAM, so it is viable if you have a large server with more than 2 GB of memory.  To avoid problems with low memory on the server, I‚Äôll leave the search functionality.  If you have a large enough server, you can download the official .deb package from Elasticsearch and follow their installation instructions to add it to your server.  Another important point!  The Elasticsearch package available in the repository of the Ubuntu 16.04 package is too old and does not work, you need version 6.x or newer. </p><br><p>  It should also be noted that the default installation of postfix is ‚Äã‚Äãprobably not enough to send email in a production environment.  To avoid spam and malware, many servers require the sender server to identify itself with security extensions, which means at least you must have a domain name associated with your server.  If you want to learn how to completely configure your mail server to pass standard security tests, see the following guides to Digital Ocean: </p><br><ul><li>  <a href="http://do.co/2FhdIes">Postfix configuration</a> </li><li>  <a href="http://do.co/2Ff8ksk">Adding an SPF Record</a> </li><li>  <a href="http://do.co/2HW2oTD">DKIM Installation and Configuration</a> </li></ul><br><h2 id="ustanovka-prilozheniya">  Application installation </h2><br><p>  Now I am going to use <code>git</code> to download the Microblog source code from my GitHub repository.  I would recommend you to read <a href="http://ryanflorence.com/git-for-beginners/">git for beginners</a> if you are not familiar with the git version control system. </p><br><blockquote>  <strong>Note:</strong> Three good tutorials for Git learners in Russian: <br><ul><li>  <a href="http://rogerdudler.github.io/git-guide/index.ru.html">Git the simple guide</a> is a simple git <a href="http://rogerdudler.github.io/git-guide/index.ru.html">guide</a> .  But for someone this material may not be enough, because everything is described there very briefly and only the main points. </li><li>  <a href="https://git-scm.com/book/ru/v1">Pro Git</a> is an exhaustive <a href="https://git-scm.com/book/ru/v1">Git</a> book that you can buy on Amazon or read online / download for free. </li><li>  <a href="https://githowto.com/ru">Git How To</a> is an interactive tour that introduces you to the basics of Git.  The tour was created with the understanding that the best way to learn something is to do it yourself. </li></ul><br></blockquote><p>  To download the application to the server, make sure that you are in the home directory of the <code>ubuntu</code> user, and then run: </p><br><pre> <code class="hljs smalltalk"><span class="hljs-string"><span class="hljs-string">$ </span></span>git clone https://github.com/miguelgrinberg/microblog <span class="hljs-string"><span class="hljs-string">$ </span></span>cd microblog <span class="hljs-string"><span class="hljs-string">$ </span></span>git checkout v0<span class="hljs-number"><span class="hljs-number">.17</span></span></code> </pre> <br><p>  This command sequence installs the code on your server and synchronizes it with this chapter.  If you maintain your version of this tutorial code in your git repository, you can change the repository URL to your own, in which case you can skip the git checkout command. </p><br><p>  Now I need to create a virtual environment and fill it with all the dependencies of the package, which for convenience I saved in the requirements.txt file in <a href="https://habrahabr.ru/post/351218/">Chapter 15</a> : </p><br><pre> <code class="hljs ruby">$ python3 -m venv venv $ source venv/bin/activate (venv) $ pip install -r requirements.txt</code> </pre> <br><p>  In addition to the general required packages in <em>requirements.txt</em> , I'm going to use two more that apply only to this environment, so they are not included in the requirements file.  The <code>gunicorn</code> package is a web server for Python applications.  The <code>pymysql</code> package contains a MySQL driver that allows SQLAlchemy to work with MySQL databases: </p><br><pre> <code class="hljs sql">(venv) $ pip <span class="hljs-keyword"><span class="hljs-keyword">install</span></span> gunicorn pymysql</code> </pre> <br><p>  I need to create a <em>.env</em> file with all the necessary environment variables: </p><br><blockquote>  <em>/home/ubuntu/microblog/.env</em> : Environment Configuration. </blockquote><br><pre> <code class="hljs objectivec">SECRET_KEY=<span class="hljs-number"><span class="hljs-number">52</span></span>cb883e323b48d78a0a36e8e951ba4a MAIL_SERVER=localhost MAIL_PORT=<span class="hljs-number"><span class="hljs-number">25</span></span> DATABASE_URL=mysql+pymysql:<span class="hljs-comment"><span class="hljs-comment">//microblog:&lt;db-password&gt;@localhost:3306/microblog MS_TRANSLATOR_KEY=&lt;your-translator-key-here&gt;</span></span></code> </pre> <br><p>  This <em>.env</em> file <em>is a</em> bit like the example I showed in <a href="https://habrahabr.ru/post/351218/">chapter 15</a> , but I used a random string for SECRET_KEY.  To generate a random string, I used the following command: </p><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">python3</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-c</span></span> "<span class="hljs-selector-tag"><span class="hljs-selector-tag">import</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">uuid</span></span>; <span class="hljs-selector-tag"><span class="hljs-selector-tag">print</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">uuid</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.uuid4</span></span>()<span class="hljs-selector-class"><span class="hljs-selector-class">.hex</span></span>)</code> </pre> <br><p>  For the <code>DATABASE_URL</code> variable, I defined the MySQL URL.  I will show you how to set up a database in the next section. </p><br><p>  I need to set the <code>FLASK_APP</code> environment <code>FLASK_APP</code> to the application entry point for the <code>flask</code> command to work, but this variable must be defined before analyzing the <em>.env</em> file, so it must be set manually.  To avoid having to do this every time, I am going to add it to the bottom of <em>~ / .profile</em> for the <code>ubuntu</code> account, so it will be installed automatically every time I log in: </p><br><pre> <code class="hljs ruby">$ echo <span class="hljs-string"><span class="hljs-string">"export FLASK_APP=microblog.py"</span></span> <span class="hljs-meta"><span class="hljs-meta">&gt;&gt; </span></span>~<span class="hljs-regexp"><span class="hljs-regexp">/.profile</span></span></code> </pre> <br><p>  If you log out and return, the FLASK_APP value will already be set for you.  You can confirm that the value is defined using <code>flask --help</code> .  If the auxiliary message shows the <code>translate</code> command added by the application, then the application was found. </p><br><p>  And now that the <code>flask</code> command is functional, I can compile the language translations: </p><br><pre> <code class="hljs ruby">(venv) $ flask translate compile</code> </pre> <br><h2 id="nastroyka-mysql">  MySQL setup </h2><br><p>  The sqlite database that I used during development is great for simple applications, but when deploying a full-scale web server that can potentially handle multiple queries at the same time, it is better to use a more reliable DBMS.  For this reason, I'm going to create a MySQL database, which I will call <code>microblog</code> . </p><br><p>  To manage the database server, use the <code>mysql</code> command, which should already be installed on your server: </p><br><pre> <code class="hljs pgsql">$ mysql -u root -p Enter <span class="hljs-keyword"><span class="hljs-keyword">password</span></span>: Welcome <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> the MySQL monitor. Commands <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> ; <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> \g. Your MySQL <span class="hljs-keyword"><span class="hljs-keyword">connection</span></span> id <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Server</span></span> <span class="hljs-keyword"><span class="hljs-keyword">version</span></span>: <span class="hljs-number"><span class="hljs-number">5.7</span></span><span class="hljs-number"><span class="hljs-number">.19</span></span><span class="hljs-number"><span class="hljs-number">-0</span></span>ubuntu0<span class="hljs-number"><span class="hljs-number">.16</span></span><span class="hljs-number"><span class="hljs-number">.04</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> (Ubuntu) Copyright (c) <span class="hljs-number"><span class="hljs-number">2000</span></span>, <span class="hljs-number"><span class="hljs-number">2017</span></span>, Oracle <span class="hljs-keyword"><span class="hljs-keyword">and</span></span>/<span class="hljs-keyword"><span class="hljs-keyword">or</span></span> its affiliates. <span class="hljs-keyword"><span class="hljs-keyword">All</span></span> rights reserved. Oracle <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> a registered trademark <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> Oracle Corporation <span class="hljs-keyword"><span class="hljs-keyword">and</span></span>/<span class="hljs-keyword"><span class="hljs-keyword">or</span></span> its affiliates. Other names may be trademarks <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> their respective owners. <span class="hljs-keyword"><span class="hljs-keyword">Type</span></span> <span class="hljs-string"><span class="hljs-string">'help;'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-string"><span class="hljs-string">'\h'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> help. <span class="hljs-keyword"><span class="hljs-keyword">Type</span></span> <span class="hljs-string"><span class="hljs-string">'\c'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> clear the <span class="hljs-keyword"><span class="hljs-keyword">current</span></span> <span class="hljs-keyword"><span class="hljs-keyword">input</span></span> <span class="hljs-keyword"><span class="hljs-keyword">statement</span></span>. mysql&gt;</code> </pre> <br><p>  Please note that you will need to enter the MySQL root-password that you chose when installing MySQL to access the MySQL command line. </p><br><p>  These are the commands that create a new database called <code>microblog</code> and a user with the same name with full access to it: </p><br><pre> <code class="hljs pgsql">mysql&gt; <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">database</span></span> microblog <span class="hljs-type"><span class="hljs-type">character</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> utf8 <span class="hljs-keyword"><span class="hljs-keyword">collate</span></span> utf8_bin; mysql&gt; <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">user</span></span> <span class="hljs-string"><span class="hljs-string">'microblog'</span></span>@<span class="hljs-string"><span class="hljs-string">'localhost'</span></span> identified <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> <span class="hljs-string"><span class="hljs-string">'&lt;db-password&gt;'</span></span>; mysql&gt; <span class="hljs-keyword"><span class="hljs-keyword">grant</span></span> <span class="hljs-keyword"><span class="hljs-keyword">all</span></span> <span class="hljs-keyword"><span class="hljs-keyword">privileges</span></span> <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> microblog.* <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-string"><span class="hljs-string">'microblog'</span></span>@<span class="hljs-string"><span class="hljs-string">'localhost'</span></span>; mysql&gt; flush <span class="hljs-keyword"><span class="hljs-keyword">privileges</span></span>; mysql&gt; quit;</code> </pre> <br><p>  You will need to replace <code>&lt;db-password&gt;</code> password of your choice.  This will be the password for the <code>microblog</code> database user, so it will be correct that it is different from the password for the root user.  The password for the <code>microblog</code> user must match the password included in the <code>DATABASE_URL</code> variable <em>.env</em> file. </p><br><p>  If the database configuration is correct, you can run database migrations that create all the tables: </p><br><pre> <code class="hljs ruby">(venv) $ flask db upgrade</code> </pre> <br><p>  Before proceeding, make sure that the command above has been completed without error. </p><br><h2 id="nastroyka-gunicorn-i-supervisor">  Configuring Gunicorn and Supervisor </h2><br><p>  When you start the server with the <code>flask run</code> command, you use the web server that comes with Flask.  This server is useful during development, but it is not a good choice for use on a production server, because it was not built for performance and reliability.  Instead of the Flask development server for this deployment, I decided to use <a href="http://gunicorn.org/">gunicorn</a> , which is also a pure Python web server, but unlike Flask, it is a reliable production server that is used by many people, while at the same time it is very easy to use. </p><br><p>  To run Microblog under gunicorn, you can use the following command: </p><br><pre> <code class="hljs ruby">(venv) $ gunicorn -b <span class="hljs-symbol"><span class="hljs-symbol">localhost:</span></span><span class="hljs-number"><span class="hljs-number">8000</span></span> -w <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-symbol"><span class="hljs-symbol">microblog:</span></span>app</code> </pre> <br><p>  The <code>-b</code> option tells gunicorn that port 8000 of the internal network interface is installed to listen to requests.  It is generally recommended to run Python web applications without external access, and then have a very fast web server optimized to serve static files that accept all requests from clients.  This fast web server will serve static files directly and redirect any requests destined for the application to an internal server.  I will show you how to configure nginx as a public server in the next section. </p><br><p>  The <code>-w</code> determines how many <em>worker processes</em> will work with gunicorn.  The presence of four processes allows an application to process up to four clients simultaneously, which is usually enough for a web application to process a decent number of clients, since not all of them constantly request content.  Depending on the amount of RAM available on the server, you may need to adjust the number of processes in order not to run out of memory. </p><br><p>  The <code>microblog:app</code> argument tells gunicorn how to download an instance of the application.  The name before the colon is the module containing the application, and the name after the colon is the name of this application. </p><br><p>  Although gunicorn is very easy to configure, running from the command line is not really a good solution for a production server.  I want it to work in the background and be constantly monitored, because if for any reason the server crashes and goes out, I would like to make sure that the new server will automatically start to take its place.  In addition, when the computer is restarted, the server should start automatically without the need to log in and start everything on its own.  I am going to use the <a href="http://supervisord.org/">supervisor</a> package that I installed above for this purpose. </p><br><p>  The supervisor utility uses configuration files that tell it which programs to monitor and how to restart them if necessary.  Configuration files should be stored in <em>/etc/supervisor/conf.d.</em>  Here is the configuration file for Microblog, which I am going to call <em>microblog.conf</em> : </p><br><blockquote>  <em>/etc/supervisor/conf.d/microblog.conf</em> : Supervisor configuration. </blockquote><br><pre> <code class="hljs javascript">[program:microblog] command=<span class="hljs-regexp"><span class="hljs-regexp">/home/u</span></span>buntu/microblog/venv/bin/gunicorn -b localhost:<span class="hljs-number"><span class="hljs-number">8000</span></span> -w <span class="hljs-number"><span class="hljs-number">4</span></span> microblog:app directory=<span class="hljs-regexp"><span class="hljs-regexp">/home/u</span></span>buntu/microblog user=ubuntu autostart=<span class="hljs-literal"><span class="hljs-literal">true</span></span> autorestart=<span class="hljs-literal"><span class="hljs-literal">true</span></span> stopasgroup=<span class="hljs-literal"><span class="hljs-literal">true</span></span> killasgroup=<span class="hljs-literal"><span class="hljs-literal">true</span></span></code> </pre> <br><p>  The <code>command</code> , <code>directory</code> and <code>user</code> settings tell the supervisor how to start the application.  <code>autostart</code> and <code>autorestart</code> auto reboot settings due to starting the computer or crashing.  The <code>stopasgroup</code> and <code>killasgroup</code> ensure that when the supervisor needs to stop the application in order to restart it, it will also reach all the child processes of the top-level gunicorn process. </p><br><p>  After writing this configuration file, you need to restart the supervisor service to import it: </p><br><pre> <code class="hljs ruby">$ sudo supervisorctl reload</code> </pre> <br><p>  And likewise, the gunicorn web server must be up and running! </p><br><h2 id="nastroyka-nginx">  Nginx setup </h2><br><p>  The gunicorn microblog application server is now running on private port 8000. What I need to do now to give the app to the outside world is to enable my public web server on ports 80 and 443, two ports that I opened on the firewall for processing web traffic applications. </p><br><p>  I want this to be a secure deployment, so I'm going to configure port 80 to forward all traffic to port 443, which will be encrypted.  So, I'm going to start by creating an SSL certificate.     <em>self-signed SSL certificate</em> ,     ,      ,   -   ,        .     SSL  : </p><br><pre> <code class="hljs cs">$ mkdir certs $ openssl req -<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> -newkey rsa:<span class="hljs-number"><span class="hljs-number">4096</span></span> -days <span class="hljs-number"><span class="hljs-number">365</span></span> -nodes -x509 \ -keyout certs/key.pem -<span class="hljs-keyword"><span class="hljs-keyword">out</span></span> certs/cert.pem</code> </pre> <br><p>            .  ,      SSL,   -   ,     .           <code>key.pem</code>  <code>cert.pem</code> ,      <em>certs</em>   . </p><br><p>  -  nginx,      .    nginx       <em>/etc/nginx/sites-enabled directory.</em> Nginx      ,    ,       : </p><br><pre> <code class="hljs haskell">$ sudo rm /etc/nginx/sites-enabled/<span class="hljs-keyword"><span class="hljs-keyword">default</span></span></code> </pre> <br><p>       nginx  Microblog,    <em>/etc/nginx/sites-enabled/microblog:</em> </p><br><blockquote> /etc/nginx/sites-enabled/microblog: Nginx configuration. </blockquote><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">server</span></span> { #   <span class="hljs-number"><span class="hljs-number">80</span></span> (http) <span class="hljs-keyword"><span class="hljs-keyword">listen</span></span> <span class="hljs-number"><span class="hljs-number">80</span></span>; server_name _; <span class="hljs-keyword"><span class="hljs-keyword">location</span></span> / { #         URL-,   https <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">301</span></span> https://$host$<span class="lua"><span class="lua">request_uri; } } server { #   </span><span class="hljs-number"><span class="lua"><span class="hljs-number">443</span></span></span><span class="lua"> (https) listen </span><span class="hljs-number"><span class="lua"><span class="hljs-number">443</span></span></span><span class="lua"> ssl; server_name _; #  self-signed SSL- ssl_certificate /home/ubuntu/microblog/certs/cert.pem; ssl_certificate_key /home/ubuntu/microblog/certs/key.pem; #       /var/</span><span class="hljs-built_in"><span class="lua"><span class="hljs-built_in">log</span></span></span><span class="lua"> access_log /var/</span><span class="hljs-built_in"><span class="lua"><span class="hljs-built_in">log</span></span></span><span class="lua">/microblog_access.</span><span class="hljs-built_in"><span class="lua"><span class="hljs-built_in">log</span></span></span><span class="lua">; error_log /var/</span><span class="hljs-built_in"><span class="lua"><span class="hljs-built_in">log</span></span></span><span class="lua">/microblog_error.</span><span class="hljs-built_in"><span class="lua"><span class="hljs-built_in">log</span></span></span><span class="lua">; location / { #      gunicorn proxy_pass http://localhost:</span><span class="hljs-number"><span class="lua"><span class="hljs-number">8000</span></span></span><span class="lua">; proxy_redirect off; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; } location /static { #    ,     alias /home/ubuntu/microblog/static; expires </span><span class="hljs-number"><span class="lua"><span class="hljs-number">30</span></span></span><span class="lua">d; } }</span></span></code> </pre> <br><p>  nginx   ,     , ,   ,  ,    .        ,   <a href="https://nginx.org/ru/docs/">  nginx</a> . </p><br><p>        nginx    ,   : </p><br><pre> <code class="hljs ruby">$ sudo service nginx reload</code> </pre> <br><p>     .  -   IP-  ( 192.168.33.10,      Vagrant),     .     ,     -,    . </p><br><p>                ,        .             IP-  .  ,     ,     <a href="https://letsencrypt.org/">Let's Encrypt</a>  SSL.         ,  <a href="https">  Flask  HTTPS</a> . </p><br><h2 id="razvertyvanie-obnovleniy-prilozheniy">  Deploying Application Updates </h2><br><p>         Linux    ,    .        <code>git</code> ,   ,        ,     <code>git pull</code> ,    ,       . </p><br><p> , ,        .  ,    ,     ,        .   ,       ,       . </p><br><p>     ,    . ,          ,        : </p><br><pre> <code class="hljs smalltalk">(venv) <span class="hljs-string"><span class="hljs-string">$ </span></span>git pull #    (venv) <span class="hljs-string"><span class="hljs-string">$ </span></span>sudo supervisorctl stop microblog #    (venv) <span class="hljs-string"><span class="hljs-string">$ </span></span>flask db upgrade #    (venv) <span class="hljs-string"><span class="hljs-string">$ </span></span>flask translate compile #   (venv) <span class="hljs-string"><span class="hljs-string">$ </span></span>sudo supervisorctl start microblog #   </code> </pre> <br><h2 id="raspberry-pi-hosting"> Raspberry Pi  </h2><br><p> <a href="http://www.raspberrypi.org/">Raspberry Pi</a> -     Linux,     ,        -,     24/7,       .    Linux,    Raspberry Pi.   <a href="http://www.raspbian.org/">Raspbian</a> ,      Raspberry Pi Foundation. </p><br><p>   Raspberry Pi,      Raspbian.     raspbian Stretch Lite   2017 ,    ,    ,  ,   ,    <a href="https://www.raspberrypi.org/downloads/raspbian/"> </a> ,     . </p><br><p>  Raspbian     SD-,      Raspberry Pi,      .     Raspbian  SD-  Windows, Mac OS X  Linux    <a href="https://www.raspberrypi.org/documentation/installation/installing-images/">Raspberry Pi</a> . </p><br><p>    Raspberry Pi        ,       .   ,    SSH,               . </p><br><p>   Ubuntu, Raspbian   Debian,      Ubuntu Linux      ,    Raspberry Pi.      ,           . ,         .     SQLite  MySQL    .      nginx     gunicorn    . , ,     gunicorn.      ,      ,         Raspberry Pi. </p><br><p><img src="https://habrastorage.org/webt/jl/jn/bb/jljnbbjr-ejh473xy_eccsmknpk.png">  <a href="https://habrahabr.ru/post/351900/">There</a> <img src="https://habrastorage.org/webt/rw/dy/-g/rwdy-grsvbpcetjttrmecdkxtlk.png"></p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/352266/">https://habr.com/ru/post/352266/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../352254/index.html">Linux fornsica in the face of tracking USB device connection history</a></li>
<li><a href="../352256/index.html">Marvin Minsky "The Emotion Machine": Chapter 2 "How our brain can control itself, despite its complexity"</a></li>
<li><a href="../352258/index.html">Implement targeted marketing on the site</a></li>
<li><a href="../352260/index.html">As we did backups in the ISPsystem. Part one</a></li>
<li><a href="../352264/index.html">General cleaning in the company</a></li>
<li><a href="../352268/index.html">Conference DEFCON 21. ‚ÄúThe secret life of SIM cards‚Äù. Eric Butler, Karl Kosher</a></li>
<li><a href="../352270/index.html">How to track file downloads from your site on WordPress</a></li>
<li><a href="../352272/index.html">Thymeleaf Tutorial: Chapter 13. Template text modes</a></li>
<li><a href="../352274/index.html">Critical vulnerability in Drupal core versions 6, 7 and 8</a></li>
<li><a href="../352276/index.html">Time-to-Digital (TDC) converters: what it is and how they are implemented in FPGA</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>