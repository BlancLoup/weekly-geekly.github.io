<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>RabbitMQ tutorial 4 - Routing</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I continue the series of translation lessons from the official site . Examples will be on php, but they can be implemented on most popular PL . 
 In t...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>RabbitMQ tutorial 4 - Routing</h1><div class="post__text post__text-html js-mediator-article">  I continue the <a href="http://habrahabr.ru/post/200870/">series of</a> translation lessons from the <a href="http://www.rabbitmq.com/tutorials/tutorial-four-php.html">official site</a> .  Examples will be on php, but they can be implemented on most popular <a href="http://www.rabbitmq.com/devtools.html">PL</a> . <br>  In the previous <a href="http://habrahabr.ru/post/200870/">article,</a> we developed a logging system.  We were able to send messages to multiple recipients.  In this article we are updating our program - we will send the recipient only a part of the messages.  For example, we can save only messages with critical errors on a disk (saving disk space), and in the console we will display all messages. <br><a name="habracut"></a><br><h4>  Bindings </h4><br>  In the previous article, we created bindings.  Recall the code: <br><pre><code class="php hljs">$channel-&gt;queue_bind($queue_name, <span class="hljs-string"><span class="hljs-string">'logs'</span></span>);</code> </pre> <br>  Binding is the connection between the access point and the queue.  This can be interpreted as: the queue wants to receive messages from the access point. <br>  Binding can take the parameter routing_key.  In order not to be confused with the $ channel :: basic_publish parameter (it also contains the routing_key parameter), let's call it binding_key.  Consider creating a binding with the binding_key key: <br><br><pre> <code class="php hljs">$binding_key = <span class="hljs-string"><span class="hljs-string">'black'</span></span>; $channel-&gt;queue_bind($queue_name, $exchange_name, $binding_key);</code> </pre><br><br>  The value of this key depends on the type of access point.  A fanout access point will simply ignore it. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Direct Access Point </h4><br>  Our logging system in the previous article sent all messages to all subscribers.  We want to expand our system to filter messages by importance.  For example, we will make the script that writes logs to disk not spend its space on messages with warning or info. <br>  Previously, we used an access point with a fanout type, which does not give us complete flexibility - it is only suitable for simple translation. <br>  Instead, we will use the direct type.  Its algorithm is very simple - messages go to the queue whose binding_key matches the routing key of the message. <br>  Consider the diagram in the picture: <br><img src="https://habrastorage.org/getpro/habr/post_images/7e6/e66/dc6/7e6e66dc6dc2671db78878e0a28f1b9a.png"><br>  The diagram shows an access point X and two associated queues.  The first stage is associated with binding key = orange, and the second stage has two connections.  One with the key binding key = black, and the second with the key green. <br>  Messages with routing key = orange will be sent to the Q1 queue, and messages with the black or green key will be sent to the Q2 queue.  All other messages will be deleted. <br><br><h4>  Multiple bindings </h4><br><img src="https://habrastorage.org/getpro/habr/post_images/75d/79c/a88/75d79ca88de6629904dc8b1dfc8a9f56.png"><br>  It is perfectly acceptable to bind multiple queues with the same binding key.  In this example, we associate an access point X and a queue Q1 with the same black key as the queue Q2.  In this example, direct behaves in the same way as fanout: sends messages to all associated queues.  Messages with the black key will fall into both queues Q1 and Q2. <br><br><h4>  Sending logs </h4><br>  Let's build an algorithm for sending messages.  Instead of fanout for the access point we will use the direct type.  Routing key will match the name of the log type.  Assume that the log sending script will know the type of log. <br>  First, create an access point: <br><pre> <code class="php hljs">$channel-&gt;exchange_declare(<span class="hljs-string"><span class="hljs-string">'direct_logs'</span></span>, <span class="hljs-string"><span class="hljs-string">'direct'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>);</code> </pre><br>  Now we will send the message: <br><pre> <code class="javascript hljs">$channel-&gt;exchange_declare(<span class="hljs-string"><span class="hljs-string">'direct_logs'</span></span>, <span class="hljs-string"><span class="hljs-string">'direct'</span></span>, <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-literal"><span class="hljs-literal">false</span></span>); $channel-&gt;basic_publish($msg, <span class="hljs-string"><span class="hljs-string">'direct_logs'</span></span>, $severity);</code> </pre><br>  The log will have 3 types: 'info', 'warning', 'error'. <br><br><h4>  Subscription </h4><br>  Sending messages will be the same as in the example of the previous <a href="http://habrahabr.ru/post/200870/">article</a> , with one condition - you need to create your own binding for each type of log. <br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span>($severities <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $severity) { $channel-&gt;queue_bind($queue_name, <span class="hljs-string"><span class="hljs-string">'direct_logs'</span></span>, $severity); }</code> </pre><br><br><h4>  Total we get </h4><br><img src="https://habrastorage.org/getpro/habr/post_images/090/365/572/0903655728106b27e853b101d939af9b.png"><br>  The script code of the producer emit_log_direct.php: <br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">require_once</span></span> <span class="hljs-keyword"><span class="hljs-keyword">__DIR__</span></span> . <span class="hljs-string"><span class="hljs-string">'/vendor/autoload.php'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">PhpAmqpLib</span></span>\<span class="hljs-title"><span class="hljs-title">Connection</span></span>\<span class="hljs-title"><span class="hljs-title">AMQPConnection</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">PhpAmqpLib</span></span>\<span class="hljs-title"><span class="hljs-title">Message</span></span>\<span class="hljs-title"><span class="hljs-title">AMQPMessage</span></span>; $connection = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AMQPConnection(<span class="hljs-string"><span class="hljs-string">'localhost'</span></span>, <span class="hljs-number"><span class="hljs-number">5672</span></span>, <span class="hljs-string"><span class="hljs-string">'guest'</span></span>, <span class="hljs-string"><span class="hljs-string">'guest'</span></span>); $channel = $connection-&gt;channel(); $channel-&gt;exchange_declare(<span class="hljs-string"><span class="hljs-string">'direct_logs'</span></span>, <span class="hljs-string"><span class="hljs-string">'direct'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); $severity = $argv[<span class="hljs-number"><span class="hljs-number">1</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>($severity)) $severity = <span class="hljs-string"><span class="hljs-string">"info"</span></span>; $data = implode(<span class="hljs-string"><span class="hljs-string">' '</span></span>, array_slice($argv, <span class="hljs-number"><span class="hljs-number">2</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>($data)) $data = <span class="hljs-string"><span class="hljs-string">"Hello World!"</span></span>; $msg = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AMQPMessage($data); $channel-&gt;basic_publish($msg, <span class="hljs-string"><span class="hljs-string">'direct_logs'</span></span>, $severity); <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">" [x] Sent "</span></span>,$severity,<span class="hljs-string"><span class="hljs-string">':'</span></span>,$data,<span class="hljs-string"><span class="hljs-string">" \n"</span></span>; $channel-&gt;close(); $connection-&gt;close(); <span class="hljs-meta"><span class="hljs-meta">?&gt;</span></span></code> </pre><br><br>  The script code of the subscriber's receive_logs_direct.php: <br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">require_once</span></span> <span class="hljs-keyword"><span class="hljs-keyword">__DIR__</span></span> . <span class="hljs-string"><span class="hljs-string">'/vendor/autoload.php'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">PhpAmqpLib</span></span>\<span class="hljs-title"><span class="hljs-title">Connection</span></span>\<span class="hljs-title"><span class="hljs-title">AMQPConnection</span></span>; $connection = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AMQPConnection(<span class="hljs-string"><span class="hljs-string">'localhost'</span></span>, <span class="hljs-number"><span class="hljs-number">5672</span></span>, <span class="hljs-string"><span class="hljs-string">'guest'</span></span>, <span class="hljs-string"><span class="hljs-string">'guest'</span></span>); $channel = $connection-&gt;channel(); $channel-&gt;exchange_declare(<span class="hljs-string"><span class="hljs-string">'direct_logs'</span></span>, <span class="hljs-string"><span class="hljs-string">'direct'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">list</span></span>($queue_name, ,) = $channel-&gt;queue_declare(<span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); $severities = array_slice($argv, <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>($severities )) { file_put_contents(<span class="hljs-string"><span class="hljs-string">'php://stderr'</span></span>, <span class="hljs-string"><span class="hljs-string">"Usage: $argv[0] [info] [warning] [error]\n"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">exit</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span>($severities <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $severity) { $channel-&gt;queue_bind($queue_name, <span class="hljs-string"><span class="hljs-string">'direct_logs'</span></span>, $severity); } <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">' [*] Waiting for logs. To exit press CTRL+C'</span></span>, <span class="hljs-string"><span class="hljs-string">"\n"</span></span>; $callback = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($msg)</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">' [x] '</span></span>,$msg-&gt;delivery_info[<span class="hljs-string"><span class="hljs-string">'routing_key'</span></span>], <span class="hljs-string"><span class="hljs-string">':'</span></span>, $msg-&gt;body, <span class="hljs-string"><span class="hljs-string">"\n"</span></span>; }; $channel-&gt;basic_consume($queue_name, <span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>, $callback); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(count($channel-&gt;callbacks)) { $channel-&gt;wait(); } $channel-&gt;close(); $connection-&gt;close(); <span class="hljs-meta"><span class="hljs-meta">?&gt;</span></span></code> </pre><br><br>  If you want to save to the file only logs with the error and warning types, type in the console: <br><br> <code>$ php receive_logs_direct.php warning error &gt; logs_from_rabbit.log <br></code> <br>  If you want to display all the logs on the screen, type in the console <br><br><pre> <code class="bash hljs">$ php receive_logs_direct.php info warning error [*] Waiting <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> logs. To <span class="hljs-built_in"><span class="hljs-built_in">exit</span></span> press CTRL+C</code> </pre><br><br>  Or to pull out only the error logs: <br><pre> <code class="bash hljs">$ php emit_log_direct.php error <span class="hljs-string"><span class="hljs-string">"Run. Run. Or it will explode."</span></span> [x] Sent <span class="hljs-string"><span class="hljs-string">'error'</span></span>:<span class="hljs-string"><span class="hljs-string">'Run. Run. Or it will explode.'</span></span></code> </pre><br>  (source <a href="https://github.com/rabbitmq/rabbitmq-tutorials/blob/master/php/emit_log_direct.php">(emit_log_direct.php source)</a> and <a href="https://github.com/rabbitmq/rabbitmq-tutorials/blob/master/php/receive_logs_direct.php">(receive_logs_direct.php source)</a> ) <br><br>  In the following article, the interception of messages corresponding to a template will be considered. </div><p>Source: <a href="https://habr.com/ru/post/201096/">https://habr.com/ru/post/201096/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../201076/index.html">Behavioral advertising ‚â† government surveillance. Time to clear up</a></li>
<li><a href="../201080/index.html">Dell and Red Cross create a unique social media monitoring system.</a></li>
<li><a href="../201084/index.html">PrettyTasks - personal task manager for everyone</a></li>
<li><a href="../201086/index.html">Anti-piracy manifesto on the concept of a new social contract of copyright in the digital age</a></li>
<li><a href="../201090/index.html">Concept application Booking.com for iOS 7</a></li>
<li><a href="../201098/index.html">How to create a world, hide the corpse and scour the Persian. Stacks of sandwiched keys. Virtual FMS and Federal Drug Control Service (or who resolves 228 and "powders the nose")</a></li>
<li><a href="../201100/index.html">The basis of AI is human language</a></li>
<li><a href="../201102/index.html">GimBall - a flying robot that bounces off walls like a ball</a></li>
<li><a href="../201104/index.html">Data Center risks: we built, built and finally built ... Or actions on the construction site</a></li>
<li><a href="../201106/index.html">Megaphone has disabled sending sms with an alphabetic addressee</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>