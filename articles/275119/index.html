<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Juniper routing instances</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Routing Instance is a collection of routing tables, interfaces, and parameters for routing protocols. Routing protocols control information in the rou...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Juniper routing instances</h1><div class="post__text post__text-html js-mediator-article">  Routing Instance is a collection of routing tables, interfaces, and parameters for routing protocols.  Routing protocols control information in the routing tables, and in one routing instance there can be both IPv4 and IPv6 routes at the same time, as well as several physical or logical interfaces.  One physical interface, divided into several logical units (subinterfaces), can be assigned to different routing instance (however, the same unit (subinterface) or physical interface, not divided into units, cannot be attached to different routing instance ). <br><br>  Routing instance is the most powerful tool of the JunOS operating system, which allows you to perform any task when sharing c rib-groups, firewall filters and policy.  Unfortunately, many engineers are unaware of the appointment of most of the routing instances, except for all the painfully familiar VRF. <br><br>  JunOS provides us with a large selection of routing instances available for configuration: <br><pre><code class="cpp hljs">routing-instances { routing-instance-name { interface interface-name; instance-type (forwarding | l2vpn | layer2-control | no-forwarding | <span class="hljs-keyword"><span class="hljs-keyword">virtual</span></span>-router | <span class="hljs-keyword"><span class="hljs-keyword">virtual</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> | vpls | vrf); } }</code> </pre> <br><a name="habracut"></a><br>  At the time of this writing, the following types of routing instance are available for configuration: <br>  1. VRF, <br>  2. Forwarding, <br>  3. Virtual router, <br>  4. Nonforwarding, <br>  5. VPLS, <br>  6. Layer 2 VPN, <br>  7. Layer2-control (MX Series routers only), <br>  8. Virtual switch (MX Series routers only) <br>  9. Layer 2 Backhaul VPN (MX Series routers only) (I'll try to write a separate post about it). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <i>If someone finds out any mistakes or inaccuracies in the article (I am also a person and I can be mistaken) or someone will have additions, please write personal messages with links to the necessary information.</i> <br><br>  <b>VRF (Virtual routing and forwarding).</b> <br><br>  Almost everyone knows this type of routing instance.  In terms of its functionality, it is similar to that of the Cisco world and is used to implement services based on MPLS (for example, for L3VPN, 6VPE). <br><br>  VRF is not a separate router inside the main router (or switch).  VRF isolates the routing table and client interfaces from the main routing table and router interfaces, as well as from the routing tables and interfaces of other clients.  The VRF configuration is as follows: <br><pre> <code class="cpp hljs">root@PE2<span class="hljs-meta"><span class="hljs-meta"># show routing-instances 6pe-2 { instance-type vrf; interface ge-0/0/3.101; route-distinguisher 2001:31133; vrf-target target:200:31133; vrf-table-label; routing-options { router-id 101.101.101.101; } protocols { ospf3 { export isis-ce2-export; area 0.0.0.0 { interface ge-0/0/3.101; } } } }</span></span></code> </pre> <br>  The functionality of this routing-instance supports all routing protocols, static routes, the ldp label distribution protocol (but rsvp is not supported), as well as export and import of routes (from the routing protocols of the main routing-instance and other VRF configured on the router). <br><br>  In the configuration, you must specify the unique value of route-distinguisher, route-targets values ‚Äã‚Äã(import and export), as well as the interface (or interfaces) towards the client, related to this routing-instance.  Using RT and RD is one of the key concepts in the implementation of l3vpn (and other technologies that use this logic, for example, 6VPE, respectively) - these two values ‚Äã‚Äãallow you to use overlapping client addressing (RD) and filter the prefixes received from different clients and follow installing them into isolated routing tables (RT).  This routing-instance creates its own routing table, which has the name instance_name.inet.0 or instance_name.inet6.0: <br><pre> <code class="cpp hljs">vrf1.inet<span class="hljs-number"><span class="hljs-number">.0</span></span>: <span class="hljs-number"><span class="hljs-number">12</span></span> destinations, <span class="hljs-number"><span class="hljs-number">22</span></span> routes (<span class="hljs-number"><span class="hljs-number">12</span></span> active, <span class="hljs-number"><span class="hljs-number">0</span></span> holddown, <span class="hljs-number"><span class="hljs-number">0</span></span> hidden) + = Active Route, - = Last Active, * = Both <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">30</span></span> *[OSPF/<span class="hljs-number"><span class="hljs-number">10</span></span>] <span class="hljs-number"><span class="hljs-number">01</span></span>:<span class="hljs-number"><span class="hljs-number">59</span></span>:<span class="hljs-number"><span class="hljs-number">31</span></span>, metric <span class="hljs-number"><span class="hljs-number">2</span></span> &gt; to <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> via ge<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">0.0</span></span> <span class="hljs-number"><span class="hljs-number">10.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>/<span class="hljs-number"><span class="hljs-number">32</span></span> *[OSPF/<span class="hljs-number"><span class="hljs-number">10</span></span>] <span class="hljs-number"><span class="hljs-number">01</span></span>:<span class="hljs-number"><span class="hljs-number">59</span></span>:<span class="hljs-number"><span class="hljs-number">31</span></span>, metric <span class="hljs-number"><span class="hljs-number">2</span></span> &gt; to <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> via ge<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">0.0</span></span> <span class="hljs-number"><span class="hljs-number">10.2</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span>/<span class="hljs-number"><span class="hljs-number">32</span></span> *[OSPF/<span class="hljs-number"><span class="hljs-number">10</span></span>] <span class="hljs-number"><span class="hljs-number">01</span></span>:<span class="hljs-number"><span class="hljs-number">59</span></span>:<span class="hljs-number"><span class="hljs-number">31</span></span>, metric <span class="hljs-number"><span class="hljs-number">2</span></span> &gt; to <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> via ge<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">0.0</span></span></code> </pre><br>  In the client's routing table there are only routes to other sites of this client and its internal routes.  That is, for the client, the provider's network is transparent and has the appearance of a router to which all its sites are connected. <br><br>  In addition to the client's routing table, another bgp.l3vpn.0 routing table will be created on the router, into which all routes received by the bgp router (address family inet-vpn unicast) are installed, according to the configured RT import values: <br><pre> <code class="cpp hljs">bgp.l3vpn<span class="hljs-number"><span class="hljs-number">.0</span></span>: <span class="hljs-number"><span class="hljs-number">12</span></span> destinations, <span class="hljs-number"><span class="hljs-number">9</span></span> routes (<span class="hljs-number"><span class="hljs-number">9</span></span> active, <span class="hljs-number"><span class="hljs-number">0</span></span> holddown, <span class="hljs-number"><span class="hljs-number">0</span></span> hidden) Prefix Nexthop MED Lclpref AS path <span class="hljs-number"><span class="hljs-number">100</span></span>:<span class="hljs-number"><span class="hljs-number">100</span></span>:<span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">16</span></span> * <span class="hljs-number"><span class="hljs-number">10.2</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">100</span></span> ? <span class="hljs-number"><span class="hljs-number">100</span></span>:<span class="hljs-number"><span class="hljs-number">100</span></span>:<span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>/<span class="hljs-number"><span class="hljs-number">32</span></span> * <span class="hljs-number"><span class="hljs-number">10.2</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">100</span></span> ? <span class="hljs-number"><span class="hljs-number">200</span></span>:<span class="hljs-number"><span class="hljs-number">100</span></span>:<span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">16</span></span> * <span class="hljs-number"><span class="hljs-number">10.3</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">100</span></span> ?</code> </pre><br>  Note: in the case when it is necessary to run the ISIS protocol in this VRF, then an additional unit of the Lo logical interface must be configured with the NET address, and this logic interface must be attached to the VRF: <br><pre> <code class="cpp hljs">ce2-l3vpn { instance-type vrf; interface ge<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">2.0</span></span>; interface lo0<span class="hljs-number"><span class="hljs-number">.1</span></span>; # VRF  unit <span class="hljs-number"><span class="hljs-number">1</span></span>  Lo0 route-distinguisher <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>:<span class="hljs-number"><span class="hljs-number">31133</span></span>; vrf-target target:<span class="hljs-number"><span class="hljs-number">10</span></span>:<span class="hljs-number"><span class="hljs-number">31133</span></span>; protocols { isis { <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> isis-ce2-<span class="hljs-keyword"><span class="hljs-keyword">export</span></span>; interface ge<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">2.0</span></span>; interface lo0<span class="hljs-number"><span class="hljs-number">.1</span></span>; } } }</code> </pre><br>  Note: there is a vrf-table-label command in the configuration.  By default, JunOS uses per-next-hop label allocation for client routes.  The above command translates the label distribution mode into per-vrf, that is, all routes of this vrf will have the same label.  (If anyone is interested, I will write an article about it.) <br><br>  Moving on to the next type of routing instance - <b>Forwarding</b> . <br><br>  As you know, JunOS deters many newbies with long and seemingly incomprehensible configurations, especially if this newcomer comes from the Cisco world.  For example, if at Cisco you need to do policy based routing (PBR), then you write an access-list and a simple route-map.  In JunOS, everything is more complicated, but by understanding Juniper's approach, you will understand how elegant he is than tsiskovskogo.  Why am I writing this?  The fact is that routing instance Forwarding was conceived precisely for PBR purposes (in the Juniper world, this kind of routing is called filter based routing).  Below is the configuration of this routing instance: <br><pre> <code class="cpp hljs">[edit routing-instances] root<span class="hljs-meta"><span class="hljs-meta"># show forward { instance-type forwarding; routing-options { static { route 10.0.0.0/24 next-hop 10.0.1.1; } } }</span></span></code> </pre><br>  It's simple - not any RT, RD.  This routing instance does not support interface specification and configuration of the routing protocol *.  The fact is that for the work of the FBR this is not necessary.  We make a static route with the next-hop we need, and on the interface from which the packets will arrive at the router, we hang the filter, which in case of coincidence, for example, of the outgoing address, will send traffic through the configured routing instance along the static route, Otherwise, the package will ‚Äúfly‚Äù according to the main routing table. <br><br>  There is one thing but that the routing instance can send a packet to the desired next-hop, we need it to have a route to this next-hop.  To do this, we need to transfer the routes from the inet.0 routing table to the routing table of the configured routing instance (which will be called instance_name.inet.0), and not all the routes are necessary (don't forget about directly connected).  This is done with the help of the rib groups, the description can be read <a href="http://habrahabr.ru/post/111687/">here</a> . <br><br>  This routing instance creates its own routing table, by manipulating the contents of which we can send traffic along a different route. <br><br>  <i>* JunOS will allow you to configure for example ospf or isis in this type of routing instance (BGP is not supported), but since you do not have interfaces assigned to routing instance, using the routing protocol will be meaningless, and you can add routes from the main table via rib- groups without using a separate routing protocol.</i> <br><br>  <b>Virtual router.</b> <br><br>  Functional routing instance virtual router is similar to vrf-lite from the world of Cisco.  This routing instance allows you to run any routing protocols from rip to bgp, create GRE and ipsec tunnels, implement the nat and dhcp functionality, and also supports the LDP protocol (however RSVP is not supported).  The main task of this routing instance is to isolate the client‚Äôs interface (s) and its routing table.  The closest relative of virtual-router can be called routing instance no-forwarding (to be described below), their functionality is somewhat similar.  But, the type of routing instance we are considering sets the routes to a separate routing table that has the name instance_name.inet.0 (instance_name.inet6.0): <br><pre> <code class="cpp hljs">r6.inet<span class="hljs-number"><span class="hljs-number">.0</span></span>: <span class="hljs-number"><span class="hljs-number">4</span></span> destinations, <span class="hljs-number"><span class="hljs-number">4</span></span> routes (<span class="hljs-number"><span class="hljs-number">4</span></span> active, <span class="hljs-number"><span class="hljs-number">0</span></span> holddown, <span class="hljs-number"><span class="hljs-number">0</span></span> hidden) + = Active Route, - = Last Active, * = Both <span class="hljs-number"><span class="hljs-number">60.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">30</span></span> *[Direct/<span class="hljs-number"><span class="hljs-number">0</span></span>] <span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">11</span></span>:<span class="hljs-number"><span class="hljs-number">18</span></span> &gt; via ge<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">2.0</span></span> <span class="hljs-number"><span class="hljs-number">60.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>/<span class="hljs-number"><span class="hljs-number">32</span></span> *[Local/<span class="hljs-number"><span class="hljs-number">0</span></span>] <span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">11</span></span>:<span class="hljs-number"><span class="hljs-number">18</span></span> Local via ge<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">2.0</span></span> <span class="hljs-number"><span class="hljs-number">60.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>/<span class="hljs-number"><span class="hljs-number">32</span></span> *[OSPF/<span class="hljs-number"><span class="hljs-number">10</span></span>] <span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">11</span></span>:<span class="hljs-number"><span class="hljs-number">04</span></span>, metric <span class="hljs-number"><span class="hljs-number">2</span></span> &gt; to <span class="hljs-number"><span class="hljs-number">60.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> via ge<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">2.0</span></span> <span class="hljs-number"><span class="hljs-number">224.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.5</span></span>/<span class="hljs-number"><span class="hljs-number">32</span></span> *[OSPF/<span class="hljs-number"><span class="hljs-number">10</span></span>] <span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">11</span></span>:<span class="hljs-number"><span class="hljs-number">19</span></span>, metric <span class="hljs-number"><span class="hljs-number">1</span></span> MultiRecv</code> </pre> <br>  The client is given only the routes that are in this routing-instance.  With the help of rib groups, you can redistribute routes from the main routing table to the client's routing table or redistribute routes between virtual routers that live on the router. <br><br>  This type of routing instance is used quite often.  If to compare it with VRF, then this routing instance is free from the need to configure RT and RD.  An example configuration of this routing-instance is presented below: <br><pre> <code class="cpp hljs">r6 { instance-type <span class="hljs-keyword"><span class="hljs-keyword">virtual</span></span>-router; interface ge<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">2.0</span></span>; } protocols { ospf { <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">export</span></span><span class="hljs-number"><span class="hljs-number">-200</span></span>; area <span class="hljs-number"><span class="hljs-number">0.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> { interface all; } } }</code> </pre><br><br>  The next type of routing instance is <b>No-forwarding.</b> <br><br>  This type of routing instance, in contrast to the three previous ones, although it creates its own routing table, but installs all routes into the main default forwarding table. <br><br>  The difference between fib and rib is that all routes for example the ospf protocol fall into rib (for example, there are two routes to the same prefix - both will be mapped to rib), but only the best of these routes will fall into fib and will be used for traffic transfer (exceptions, for example ECMP).  Also rib is designed for storing and exchanging routing information between peers in the network and it is not convenient for sending traffic.  Fib is just designed to quickly find the data necessary for sending traffic and makes it possible to implement hardware-based traffic processing. <br><br>  This routing instance is used when it is necessary to perform network segmentation at the third level (like VLAN).  The configuration is presented below: <br><pre> <code class="cpp hljs">[edit routing-instances] root<span class="hljs-meta"><span class="hljs-meta"># show noforward { instance-type no-forwarding; interface ge-0/0/3.0; routing-options { auto-export; } protocols { ospf { export export-100; area 0.0.0.0 { interface ge-0/0/3.0; } } } }</span></span></code> </pre><br>  Note: auto-export must be configured to basic routing instance and routing instance no-forwarding, otherwise you will not get the expected result. <br><br>  Let's look at how this routing instance works.  We have several configured routing instances: <br><pre> <code class="cpp hljs">root&gt; show route instance summary Instance Type Primary RIB Active/holddown/hidden master forwarding inet<span class="hljs-number"><span class="hljs-number">.0</span></span> <span class="hljs-number"><span class="hljs-number">19</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span> __juniper_private1__ forwarding __juniper_private1__.inet<span class="hljs-number"><span class="hljs-number">.0</span></span> <span class="hljs-number"><span class="hljs-number">7</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span> __juniper_private2__ forwarding __juniper_private2__.inet<span class="hljs-number"><span class="hljs-number">.0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">1</span></span> __master.anon__ forwarding forward forwarding forward.inet<span class="hljs-number"><span class="hljs-number">.0</span></span> <span class="hljs-number"><span class="hljs-number">7</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span> no-frw non-forwarding no-frw.inet<span class="hljs-number"><span class="hljs-number">.0</span></span> <span class="hljs-number"><span class="hljs-number">16</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">virtual</span></span>-router <span class="hljs-keyword"><span class="hljs-keyword">virtual</span></span>-router <span class="hljs-keyword"><span class="hljs-keyword">virtual</span></span>-router.inet<span class="hljs-number"><span class="hljs-number">.0</span></span> <span class="hljs-number"><span class="hljs-number">14</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre><br>  From the conclusion that we have three configured and one default routing instance (we do not consider private routing instance): <br><br>  1.virtual-router with type virtual-router (corresponds to the routing table of virtual-router.inet.0) <br>  2.forward with the type of forwarding (corresponds to the routing table forward.inet.0) <br>  3.default (corresponds to the inet.0 routing table) <br>  4.no-frw with non-forwarding type (corresponds to the no-frw.inet.0 routing table) <br><br>  While everything is as usual - each routing instance has its own routing table. <br>  Now let's see how things are with forwarding-table on the router: <br><pre> <code class="cpp hljs">root&gt; show route forwarding-table | match table Routing table: <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>.inet Routing table: __master.anon__.inet Routing table: forward.inet Routing table: <span class="hljs-keyword"><span class="hljs-keyword">virtual</span></span>-router.inet Routing table: <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>.iso Routing table: __master.anon__.iso Routing table: forward.iso Routing table: <span class="hljs-keyword"><span class="hljs-keyword">virtual</span></span>-router.iso Routing table: <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>.inet6 Routing table: __master.anon__.inet6 Routing table: forward.inet6 Routing table: <span class="hljs-keyword"><span class="hljs-keyword">virtual</span></span>-router.inet6 Routing table: <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>.mpls Routing table: :mpls-oam.mpls Routing table: <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>.ethernet-switching Routing table: <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>.vmembers Routing table: <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>.device-route Routing table: <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>.MSTI Routing table: <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>.dhcp-snooping</code> </pre><br>  Only forwarding table was created for: <br>  1.virtual-router.inet.0 <br>  2.forward.inet.0 <br>  3.default.inet.0 <br><br>  forwarding-table for no-frw.inet.0 does not exist, therefore routing instance no-forwarding installs its routes to forwarding-table default (more precisely, in addition to its routing table, routing instance no-forwarding exports its routes to defaul inet. 0, whence they get into defaul fib). <br><br>  Then the question arises - why do we need this routing instance?  Unlike Cisco, you cannot run two copies of the same routing protocol in the same instance on Juniper hardware.  That is, if at Cisco we can start the ospf 1 process and the ospf 2 process at the same time, then at JunOS at the level of the hierarchy [edit protocols], there is no possibility to run two copies of the same process, for example, OSPF (do not confuse with the area, since there may be several).  This routing instance is designed just to run multiple copies of a single routing protocol. <br><br>  The functionality of this routing instance supports all routing protocols, with the exception of BGP.  Not supported and distribution protocols labels ldp or rsvp. <br><br>  For completeness, consider the following scheme (taken from the site Juniper): <br><img src="https://habrastorage.org/files/ede/481/4ca/ede4814ca8d3437f9ba9b8f20080a156.gif"><br>  So, suppose that we want CE2 to communicate only with CE3, and, accordingly, CE1 can communicate only with CE4.  This is where we will use the routing instance no-forwarding. <br>  We create two routing instance (1 and 2) with no-forwarding type on PE0 and PE2, specify the necessary interface in them and start ospf. <br><br>  We create policies according to which the ospf routing instance 1 process, receiving routes from CE1, adds the tag 100 to these routes and exports it to default rib inet.0, and the ospf routing instance 2 process adds the tag 200 to the routes received from CE2 and exports it to default rib inet.0. <br><br>  That is, we received all the routes from CE1 and CE2 in inet.0, and we can clearly distinguish which routes came from CE1 and which routes came from CE2. <br><br>  Further, these routes are transmitted to PE2 along with tags.  With the help of the policy, on PE2 in routing instance 1 we indicate that only routes with a tag of 200 should be exported to CE3, and, accordingly, only routes with a tag of 100 should be exported to CE4. As a result, we received practically VLAN at the third level. <br><br>  As we wanted, traffic exchange is possible between CE1 and CE4, and accordingly between CE2 and CE3;  Why is there no traffic exchange between CE1 and CE3?  For a simple reason - CE1 does not have a route to CE2 or CE3.  A similar picture will be on the rest of the routers of this topology. <br><br>  At first glance, the considered routing instance is very similar to virtual-router.  But I hope that now you understand that it is intended for other purposes and has less functionality. <br><br>  <b>VPLS.</b> <br><br>  The principle of operation of the VPLS technology is not included in the text of this article, but will be partially affected during the explanations (otherwise nothing can be explained). <br><br>  We need to implement the Virtual Private LAN Service, we create this routing instance.  In essence, it repeats the functional VRF (especially when using BGP signaling), but it is intended for the implementation of L2 services.  This type of routing instance allows you to automatically create a fully connected topology from virtual l2 connections between client sites.  This routing instance, due to the lack of the need to run routing protocols and label distribution, does not support their configuration.  Since this routing instance works with l2 and not IP addresses, the forwarding table stores the mac addresses: <br><pre> <code class="cpp hljs">Routing table: vpls_bgp_signalig.vpls VPLS: Destination Type RtRef Next hop Type Index NhRef Netif <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> perm <span class="hljs-number"><span class="hljs-number">0</span></span> rjct <span class="hljs-number"><span class="hljs-number">587</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> ge<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">3.0</span></span> user <span class="hljs-number"><span class="hljs-number">0</span></span> comp <span class="hljs-number"><span class="hljs-number">580</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> lsi<span class="hljs-number"><span class="hljs-number">.1048577</span></span> user <span class="hljs-number"><span class="hljs-number">0</span></span> comp <span class="hljs-number"><span class="hljs-number">581</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> ca:<span class="hljs-number"><span class="hljs-number">04</span></span>:<span class="hljs-number"><span class="hljs-number">76</span></span>:<span class="hljs-number"><span class="hljs-number">68</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span>c/<span class="hljs-number"><span class="hljs-number">48</span></span> dynm <span class="hljs-number"><span class="hljs-number">0</span></span> ucst <span class="hljs-number"><span class="hljs-number">577</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> ge<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">3.0</span></span> ca:<span class="hljs-number"><span class="hljs-number">05</span></span>:<span class="hljs-number"><span class="hljs-number">79</span></span>:f4:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span>c/<span class="hljs-number"><span class="hljs-number">48</span></span> dynm <span class="hljs-number"><span class="hljs-number">0</span></span> indr <span class="hljs-number"><span class="hljs-number">262142</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> Push <span class="hljs-number"><span class="hljs-number">262146</span></span>, Push <span class="hljs-number"><span class="hljs-number">17</span></span>(top) <span class="hljs-number"><span class="hljs-number">572</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> ge<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">0.0</span></span> ca:<span class="hljs-number"><span class="hljs-number">08</span></span>:<span class="hljs-number"><span class="hljs-number">5f</span></span>:e4:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span>c/<span class="hljs-number"><span class="hljs-number">48</span></span> dynm <span class="hljs-number"><span class="hljs-number">0</span></span> indr <span class="hljs-number"><span class="hljs-number">262142</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> Push <span class="hljs-number"><span class="hljs-number">262146</span></span>, Push <span class="hljs-number"><span class="hljs-number">17</span></span>(top) <span class="hljs-number"><span class="hljs-number">572</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> ge<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">0.0</span></span></code> </pre><br>  Below is the routing table of one of the clients (BGP signaling): <br><pre> <code class="cpp hljs">customer1.site1.l2vpn<span class="hljs-number"><span class="hljs-number">.0</span></span>: <span class="hljs-number"><span class="hljs-number">3</span></span> destinations, <span class="hljs-number"><span class="hljs-number">3</span></span> routes (<span class="hljs-number"><span class="hljs-number">3</span></span> active, <span class="hljs-number"><span class="hljs-number">0</span></span> holddown, <span class="hljs-number"><span class="hljs-number">0</span></span> hidden) + = Active Route, - = Last Active, * = Both <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>:<span class="hljs-number"><span class="hljs-number">100</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span>/<span class="hljs-number"><span class="hljs-number">96</span></span> *[L2VPN/<span class="hljs-number"><span class="hljs-number">170</span></span>/<span class="hljs-number"><span class="hljs-number">-101</span></span>] <span class="hljs-number"><span class="hljs-number">04</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">26</span></span>, metric2 <span class="hljs-number"><span class="hljs-number">1</span></span> Indirect <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span>:<span class="hljs-number"><span class="hljs-number">100</span></span>:<span class="hljs-number"><span class="hljs-number">2</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span>/<span class="hljs-number"><span class="hljs-number">96</span></span> *[BGP/<span class="hljs-number"><span class="hljs-number">170</span></span>] <span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">04</span></span>:<span class="hljs-number"><span class="hljs-number">23</span></span>, localpref <span class="hljs-number"><span class="hljs-number">100</span></span>, from <span class="hljs-number"><span class="hljs-number">1.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.254</span></span> AS path: I &gt; to <span class="hljs-number"><span class="hljs-number">20.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> via ge<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">1.0</span></span> <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span>:<span class="hljs-number"><span class="hljs-number">100</span></span>:<span class="hljs-number"><span class="hljs-number">3</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span>/<span class="hljs-number"><span class="hljs-number">96</span></span> *[BGP/<span class="hljs-number"><span class="hljs-number">170</span></span>] <span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">04</span></span>:<span class="hljs-number"><span class="hljs-number">54</span></span>, localpref <span class="hljs-number"><span class="hljs-number">100</span></span>, from <span class="hljs-number"><span class="hljs-number">1.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.254</span></span> AS path: I &gt; to <span class="hljs-number"><span class="hljs-number">20.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> via ge<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">0.0</span></span>, Push <span class="hljs-number"><span class="hljs-number">299808</span></span> to <span class="hljs-number"><span class="hljs-number">20.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> via ge<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">2.0</span></span>, Push <span class="hljs-number"><span class="hljs-number">299808</span></span></code> </pre><br>  10.0.1.1:100:1:1/96 - this prefix denotes the client's site and consists of: <br>  1. 10.0.1.1:100 - RD <br>  2. 1 - site id <br>  3. 1 - label block offcet (shift of a block of labels, if anyone is interested, I can write a separate article about operations with labels when organizing VPLS) <br><br>  In addition to the above routing table, JunOS will have another bgp.l2vpn.0 routing table, which will display all l2vpn routes of this PE router (when using bgp as an alarm): <br><pre> <code class="cpp hljs">bgp.l2vpn<span class="hljs-number"><span class="hljs-number">.0</span></span>: <span class="hljs-number"><span class="hljs-number">4</span></span> destinations, <span class="hljs-number"><span class="hljs-number">4</span></span> routes (<span class="hljs-number"><span class="hljs-number">4</span></span> active, <span class="hljs-number"><span class="hljs-number">0</span></span> holddown, <span class="hljs-number"><span class="hljs-number">0</span></span> hidden) + = Active Route, - = Last Active, * = Both <span class="hljs-number"><span class="hljs-number">30.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>:<span class="hljs-number"><span class="hljs-number">100</span></span>:<span class="hljs-number"><span class="hljs-number">102</span></span>:<span class="hljs-number"><span class="hljs-number">97</span></span>/<span class="hljs-number"><span class="hljs-number">96</span></span> *[BGP/<span class="hljs-number"><span class="hljs-number">170</span></span>] <span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">04</span></span>:<span class="hljs-number"><span class="hljs-number">55</span></span>, localpref <span class="hljs-number"><span class="hljs-number">100</span></span>, from <span class="hljs-number"><span class="hljs-number">1.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.254</span></span> AS path: I &gt; to <span class="hljs-number"><span class="hljs-number">20.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> via ge<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">0.0</span></span>, Push <span class="hljs-number"><span class="hljs-number">299808</span></span> to <span class="hljs-number"><span class="hljs-number">20.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> via ge<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">2.0</span></span>, Push <span class="hljs-number"><span class="hljs-number">299808</span></span> <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span>:<span class="hljs-number"><span class="hljs-number">100</span></span>:<span class="hljs-number"><span class="hljs-number">2</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span>/<span class="hljs-number"><span class="hljs-number">96</span></span> *[BGP/<span class="hljs-number"><span class="hljs-number">170</span></span>] <span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">04</span></span>:<span class="hljs-number"><span class="hljs-number">23</span></span>, localpref <span class="hljs-number"><span class="hljs-number">100</span></span>, from <span class="hljs-number"><span class="hljs-number">1.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.254</span></span> AS path: I &gt; to <span class="hljs-number"><span class="hljs-number">20.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> via ge<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">1.0</span></span></code> </pre><br>  The configuration of this routing instance depends on what kind of signaling is used to organize the VPLS - BGP (draft CompELLA) or LDP (Martini).  Depending on your choice, the configuration will vary. <br><br>  If we implement VPLS according to the Compell Draft (BGP signaling), then the configuration will look like this: <br><pre> <code class="cpp hljs">routing-instances { customer1.site1 { instance-type vpls; interface ge<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">3.0</span></span>; route-distinguisher <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>:<span class="hljs-number"><span class="hljs-number">100</span></span>; vrf-target target:<span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>:<span class="hljs-number"><span class="hljs-number">100</span></span>; protocols { vpls { no-tunnel-services; site site1 { site-range <span class="hljs-number"><span class="hljs-number">10</span></span>; site-identifier <span class="hljs-number"><span class="hljs-number">1</span></span>; interface ge<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">3.0</span></span>; } } } }</code> </pre> <br>  Since Compella's Draft includes autodiscovery PE routers, in the configuration, besides the interface, specify RT and RD.  As I showed earlier, RD is used to find and identify PE routers to which client sites are connected.  At the hierarchy level [edit routing-instance protocols vpls], you must specify the site name, its site-identifier (this JunOS can be set automatically if specified in the configuration) and the maximum number of sites (site-range) of the client, and site-identifier must be less than site-range. <br><br>  If we use LDP-signaling (Martini), then the configuration will be a bit simpler: <br><pre> <code class="cpp hljs">ce3-vpls-ldp { instance-type vpls; interface ge<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">3.0</span></span>; protocols { vpls { no-tunnel-services; vpls-id <span class="hljs-number"><span class="hljs-number">101</span></span>; neighbor <span class="hljs-number"><span class="hljs-number">1.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>; neighbor <span class="hljs-number"><span class="hljs-number">2.2</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span>; } } }</code> </pre> <br>  This VPLS technology does not support autodiscovery without an additional ‚Äúcrutch‚Äù *, therefore, in the basic configuration, only the interface to which the client is connected is specified, neither RT nor RD.  At the hierarchy level [edit routing-instance protocols vpls], you must specify the loopbacks of all PE routers to which the client's sites are connected, as well as the VPLS-ID, which must be the same for all VPLS routing instance of this client. <br><br>  * To use autodiscovery in this case, you must use BGP using address family bgp l2vpn auto-discovery-only.  At the same time, it is not necessary to explicitly specify neighbors on PE routers, but then you need to configure RT, RD, and also l2vpn-id: <br><pre> <code class="cpp hljs">vpls100 { instance-type vpls; interface ge<span class="hljs-number"><span class="hljs-number">-1</span></span>/<span class="hljs-number"><span class="hljs-number">1</span></span>/<span class="hljs-number"><span class="hljs-number">0.100</span></span>; l2vpn-id l2vpn-id:<span class="hljs-number"><span class="hljs-number">100</span></span>:<span class="hljs-number"><span class="hljs-number">200</span></span>; vrf-target target:<span class="hljs-number"><span class="hljs-number">100</span></span>:<span class="hljs-number"><span class="hljs-number">208</span></span>; protocols { vpls { no-tunnel-services; } } }</code> </pre><br>  You can check the status of the connections that this routing instance has established using the show vpls connections command: <br><pre> <code class="cpp hljs">[edit] root<span class="hljs-meta"><span class="hljs-meta"># run show vpls connections Layer-2 VPN connections: Legend for connection status (St) EI -- encapsulation invalid NC -- interface encapsulation not CCC/TCC/VPLS EM -- encapsulation mismatch WE -- interface and instance encaps not same VC-Dn -- Virtual circuit down NP -- interface hardware not present CM -- control-word mismatch -&gt; -- only outbound connection is up CN -- circuit not provisioned &lt;- -- only inbound connection is up OR -- out of range Up -- operational OL -- no outgoing label Dn -- down LD -- local site signaled down CF -- call admission control failure RD -- remote site signaled down SC -- local and remote site ID collision LN -- local site not designated LM -- local site ID not minimum designated RN -- remote site not designated RM -- remote site ID not minimum designated XX -- unknown connection status IL -- no incoming label MM -- MTU mismatch MI -- Mesh-Group ID not available BK -- Backup connection ST -- Standby connection PF -- Profile parse failure PB -- Profile busy RS -- remote site standby SN -- Static Neighbor VM -- VLAN ID mismatch Legend for interface status Up -- operational Dn -- down Instance: customer1.site1 Local site: site1 (1) connection-site Type St Time last up # Up trans 2 rmt Up Nov 2 00:25:33 2015 1 Remote PE: 1.1.1.2, Negotiated control-word: No Incoming label: 262154, Outgoing label: 262153 Local interface: lsi.1049099, Status: Up, Encapsulation: VPLS Description: Intf - vpls customer1.site1 local site 1 remote site 2 3 rmt Up Nov 2 00:25:01 2015 1 Remote PE: 1.1.1.3, Negotiated control-word: No Incoming label: 262155, Outgoing label: 262153 Local interface: lsi.1049098, Status: Up, Encapsulation: VPLS Description: Intf - vpls customer1.site1 local site 1 remote site 3</span></span></code> </pre><br>  From the client‚Äôs point of view, this technology will be in the form of a switch to which client sites are connected. <br><br>  <b>Layer 2 VPN</b> <br><br>  In Junos, there are (in any case, I know) three ways to create l2vpn (unlike VPLS, l2vpn has the p2p topology).  This routing-instance is similar in configuration and signaling to VPLS BGP signaling.  The configuration provides an indication of rd and rt to search for PE routers and then establish a p2p connection: <br><pre> <code class="cpp hljs">root<span class="hljs-meta"><span class="hljs-meta"># show instance-type l2vpn; interface ge-0/0/3.0; route-distinguisher 100:100; vrf-target target:1:1; protocols { l2vpn { encapsulation-type ethernet-vlan; no-control-word; site site2 { site-identifier 2; interface ge-0/0/3.0 { remote-site-id 1; } } } }</span></span></code> </pre><br>  Like its older brother, the routing-instance vpls, this routing-instance, by virtue of its purpose, does not imply setting up routing protocols. <br><br>  The advantage of this routing-instance is the ease of configuration and, unlike other types of l2vpn, has better scalability (if necessary, other sites are easily added).  Unlike VPLS, routing-instance l2vpn does not support cross-platform interaction (for example, between Juniper and Cisco). <br><br>  This routing-instance does not allow you to create a VPLS, although it does allow you to configure more than one virtual L2 connection (but this will not be a full-fledged VPLS). <br><br>  The routing table looks almost the same as VPLS: <br><pre> <code class="cpp hljs">root@PE1&gt; show route table vpn.l2vpn<span class="hljs-number"><span class="hljs-number">.0</span></span> vpn1.l2vpn<span class="hljs-number"><span class="hljs-number">.0</span></span>: <span class="hljs-number"><span class="hljs-number">2</span></span> destinations, <span class="hljs-number"><span class="hljs-number">2</span></span> routes (<span class="hljs-number"><span class="hljs-number">2</span></span> active, <span class="hljs-number"><span class="hljs-number">0</span></span> holddown, <span class="hljs-number"><span class="hljs-number">0</span></span> hidden) + = Active Route, - = Last Active, * = Both <span class="hljs-number"><span class="hljs-number">100</span></span>:<span class="hljs-number"><span class="hljs-number">100</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span>/<span class="hljs-number"><span class="hljs-number">96</span></span> *[BGP/<span class="hljs-number"><span class="hljs-number">170</span></span>] <span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">14</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>, localpref <span class="hljs-number"><span class="hljs-number">100</span></span>, from <span class="hljs-number"><span class="hljs-number">10.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> AS path: I &gt; to <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> via ge<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">3.0</span></span>, label-switched-path pe1_to_pe2 <span class="hljs-number"><span class="hljs-number">200</span></span>:<span class="hljs-number"><span class="hljs-number">200</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span>:<span class="hljs-number"><span class="hljs-number">2</span></span>/<span class="hljs-number"><span class="hljs-number">96</span></span> *[L2VPN/<span class="hljs-number"><span class="hljs-number">170</span></span>/<span class="hljs-number"><span class="hljs-number">-101</span></span>] <span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">17</span></span>:<span class="hljs-number"><span class="hljs-number">35</span></span>, metric2 <span class="hljs-number"><span class="hljs-number">1</span></span> Indirect</code> </pre> <br>  You can check the connection status using the show l2vpn connections command, and the output will be similar to the show vpls connections output (routing-instance VPLS). <br><br>  <b>Layer2-control</b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This routing-instance is designed to run the STP family protocol when using VPLS Multihoming. Its use is very well described in this </font></font><a href="http://habrahabr.ru/post/259645/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">article</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , so I will not repeat. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Virtual switch</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> In addition to routing, MX series routers can perform functions unique to the switch. Initially, when configuring VLAN and trunk ports on an MX-series router, all VLAN and trunk interfaces fall into one bridge domian, called default-switch routing-instance. MX series routers provide the ability to configure custom routing-instance virtual-switch:</font></font><br><pre> <code class="cpp hljs">[edit] routing-instances { routing-instance-name ( instance-type <span class="hljs-keyword"><span class="hljs-keyword">virtual</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">switch</span></span>; bridge-domains { bridge-domain-name { domain-type bridge; interface interface-name; vlan-id (all | none | number); vlan-id-<span class="hljs-built_in"><span class="hljs-built_in">list</span></span> [ vlan-id-numbers ]; vlan-tags outer number inner number; } } protocols { mstp { ...mstp-configuration ... } } } }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This routing-instance allows you to implement switch functionality on the router and isolates interfaces and one or more VLANs. </font><font style="vertical-align: inherit;">That is, virtual switch allows you to segmentation of networks at the second level, without resorting to network segmentation at the third level (which will save us IP addresses). </font><font style="vertical-align: inherit;">For each segment, you can run your own protocol from the STP family. </font><font style="vertical-align: inherit;">MX series routers support protocols: STP, RSTP, MSTP, VSTP.</font></font><br><br>  Thanks for attention! </div><p>Source: <a href="https://habr.com/ru/post/275119/">https://habr.com/ru/post/275119/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../275107/index.html">Case NGINX: How to counter DDoS attacks</a></li>
<li><a href="../275109/index.html">Sortable nested list with selectable items</a></li>
<li><a href="../275111/index.html">Final Results of the JS Programming Contest: Mail Filters</a></li>
<li><a href="../275113/index.html">Revolution R has been renamed to Microsoft R and is available for free to developers and students.</a></li>
<li><a href="../275115/index.html">Veeam Availability Suite v9: ‚Äúinfinitely‚Äù scalable backup repository</a></li>
<li><a href="../275121/index.html">Alternative options for installing the Vivaldi browser in Linux</a></li>
<li><a href="../275123/index.html">Simple removal of the "tricked" protection kraftway credo vv18</a></li>
<li><a href="../275125/index.html">How to determine which files on the disk correspond to PostgreSQL tables</a></li>
<li><a href="../275129/index.html">Five reasons not to use your employees for translation and localization</a></li>
<li><a href="../275131/index.html">Image Generator invites v. 2.0</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>