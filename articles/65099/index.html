<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How I became an application developer for vkontakte.ru. Part 2: Flex + Zend AMF</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="So, I continue to describe my experience creating an application for vkontakte.ru. In the first part, I described how the initial version of my music ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How I became an application developer for vkontakte.ru. Part 2: Flex + Zend AMF</h1><div class="post__text post__text-html js-mediator-article">  So, I continue to describe my experience creating an application for vkontakte.ru.  In the <a href="http://bone.habrahabr.ru/blog/61521/">first part,</a> I described how the initial version of <a href="http://vkontakte.ru/app593265_1933734">my music player was created</a> .  In this part I will describe how I added the server part. <br><br>  The application is done using Flex, and under the cut my experience with such things is described: TabNavigator, Menu Control, working with coordinates, pop up windows, TitleWindow, homemade events, Zend, Zend AMF, working with a database, ItemRenderer, crossdomain policy. <br><br>  In short, I simply describe how I learned to add, read, update and delete information from the database using the Flex + Zend AMF bundle. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <a name="habracut"></a><br><br><h2>  06/10/09 </h2><br><br>  So, in the first 5 days, "Media" gathered 330 users.  I do not know whether it is a lot or a little, but the main thing is that the process has begun and is not going to stop.  During these five days I gave myself a break and practically did not work on the player, but I cannot relax, so I resume work and, as before, I will document my actions. <br><br>  For the first few days, a decent amount of bugs and suggestions from users were gathered, which I will gradually eliminate / add.  Today I started by adding the lastFM logo and links to <a href="http://www.lastfm.com/">www.lastfm.com</a> , this is a mandatory requirement when using their API. <br><br>  One user suggested adding the ability to play all the music of friends in one list.  In my opinion, sound thought, so we will deal with it.  Unfortunately, it is not possible to transfer the list of users to the contact's API and get a list of their audio recordings in one request, which means you have to consistently transfer user IDs to the API and add the received records to the general list.  Another interesting question is how to add the ‚ÄúAll friends music‚Äù field to the ComboBox (drop-down list of friends), this field is out of the general structure and must be processed in a separate way.  Let's start with this. <br><br>  Adding a new item to the ComboBox was elementary, creating a new XML like so var newNode: XML =, and then adding it to the desired XMLListCollection via .addItemAt (newNode, 1).  Unfortunately, thinking about further actions, I decided that the function of listening to all the music of friends in one list so far does not need to be done.  In order to compile a complete list of music, for example, with 45 friends, you will need to send 45 requests to the contact's API, with the maximum you can send 3 requests per second, hence it will take at least 15 seconds to compile the list, and if there are any then mistakes, the result I can not even predict at all.  In general, we will leave this function for the future, either I will wait until it becomes possible for the contact to transfer several uids with the getAudios method at once, or I will do the necessary function through my own server and own database. <br><br><h2>  13.06.09 </h2><br><br>  Today to the country, but as long as there is time, I will continue to develop.  Let's start by fixing the Play button.  Judging by the reviews, when you click on Play, people expect that the selected track will start playing (which is, in general, logical, but initially I was guided by WinAMP in this question).  The task was solved quickly and there was nothing special to do, just a few if ... else constructs. <br><br>  I was also asked to press the ‚ÄúNext track‚Äù button, if the list is over, the very first track should start.  Well, this is absolutely elementary, even nothing to describe. <br><br>  Now change the volume so that the volume changes when the half-bone moves, and not just after releasing it.  Elementary again, just adding liveDragging = "true" to &lt;mx: HSlider&gt;. <br><br>  When the random track playback function is enabled, the Next track button should go to the next random track, not the next one in the list.  Again, nothing complicated, if else and everything. <br><br><h2>  &lt;Once&gt; </h2><br><br>  Perhaps I will no longer indicate specific dates, because the time intervals between them are depressing.  In a previous post, I somehow did not write what I did to count down the time (until the end of the track).  In general, I did it and no longer remember how.  In addition, I finally made a less noticeable improvement.  Now, not only information about the performer is displayed, but also the text of the current song, which is taken from lyricwiki (I spied the idea with the text in another player, which I honestly confess to).  To display the lyrics, I made a right column using the viewstack component, which allows you to switch the displayed information.  In the first layer of the viewstack, I left the information about the artist, and in the second layer I placed the self-made component of the lyrics, which displays the text (everything is elementary, just sending a request to the lyricwiki API using HTTPService and outputting the result).  Switching between layers (I call it layers, although perhaps there is some more appropriate definition) I made using the Combobox component, again, everything is simple, at the level of the property change = "vsRightColumn.Selectedindex = cbShow.Selectedindex".  Everything worked the first time, the only problem is that before the first switching of the viewstack to the display of the lyrics, the lyrics component is not active.  As a result, when you first switch to the song text, no text is displayed, but starts to be displayed, either after the second switch, or after changing the track, but I think this can be solved with the help of the init () function and, possibly, a self-made event, which will send the message that the component is initialized. <br><br><h2>  &lt;Once&gt; </h2><br><br>  These &lt;sometime&gt; headers are probably not the best idea.  Now I will come up with headlines with meaning (or without meaning, but at least interesting).  So, it seems, I finally matured for the first experiments to add interaction with the database and PHP.  The first function that I would like to implement using the database will be the ability to recommend the track to my friends (of course, only to those who installed the application).  Of course, for these purposes it is already possible to use the ‚Äúwall‚Äù, but through the player it should be more convenient, and besides, there is hope that this will stimulate users (of whom there are only 750) to invite their friends to the app. <br><br>  So the first thing I need is to design a database.  I am in this case a complete zero, so I climbed for information on Habr.  To begin with, these two articles were enough for me (thanks to the authors): <a href="http://abarmot.habrahabr.ru/blog/23423/">http://abarmot.habrahabr.ru/blog/23423/</a> , <a href="http://habrahabr.ru/blogs/development/45707/">http://habrahabr.ru/blogs/development/45707/</a> .  After reading the articles, I singled out for myself 3 entities: the user, the track, the recommendation, and made the corresponding tables for them (users, audio, advices), which, it seems to me, satisfy the normal forms.  I also recently read a small part of the Getting Real book from 37signals and it was written there that you first need to make an interface.  Once, for the sake of interest, I wanted to use their products, I poked 5 seconds into links on their website, did not understand anything and scored, but still, they, apparently, are tough guys and know what (I like the letter Y) , so follow their advice, run Flex Builder and make an interface.  With the interface, by the way, the problem is, because I already run out of free space for all buttons, etc., but I will not pay attention to this in the best traditions of the redneck designer and I will sculpt as it will.  Pretty soon, this approach will cease to work, and then I will have to thoroughly rework everything, but at least I will already know what I can design and draw on from the real experience of a very specific application.  In general, I will cut seven times, in order to understand how best to measure. <br><br>  Recommendations can be immediately played in the player, so I will display them in place of the list of songs.  I will switch between recommendations and my list with the help of Viewstack and buttons on the player panel.  I'll start with the buttons.  No, I tried to start with the buttons and it turned out badly.  I'll start with Viewstack.  So, I need to add a viewstack and place a good old list of songs on one layer, and a datagrid with recommendations on another layer.  No, I lied again.  It turns out that TabNavigator is best suited for my purpose - this is the viewstack to which tabs are already attached, to switch between layers.  Yes, now everything is correct.  TabNavigator is just super, it's even strange why I didn't use it before.  Now you need to add a TabNavigator datagrid (or, quite simply, a table) to display recommendations.  The datagrid should consist of the following columns: the sender of the recommendation, the name of the artist and the track, the duration and the button for receiving an additional comment if the sender left it.  It turns out quite a lot and in one line it will all look bad, you need to find a way to make the sender above the track.  It is probably better to use TileList.  In general, I have so far put an empty TileList, then it will be necessary to further refine it when a working dataProvider appears.  We assume that I have an interface for displaying recommendations, now I need an interface for sending recommendations.  Here, it seems the time has come to add a new column to the DataGrid with a list of songs.  This column will contain a button to open the track menu.  For now, the menu will have only one function - ‚Äúrecommend‚Äù, but over time, others may appear. <br><br><h2>  &lt;I continue to make recommendations&gt; </h2><br><br>  First, I decided that it would be logical to make the track menu using Menu control.  First, I added a new column to the DataGrid with tracks, in this column, with the help of itemRenderer put the usual button.  The first thing I need to do is display the menu in the right place, i.e.  close to the upper right corner of the pressed button, for this I need to determine the coordinates of the button.  The X coordinate will not change, just like the button size, so the task is reduced to determining the Y coordinate.  To check how it works, I added the click = "testButton (event)" button and, in fact, the function itself: <br><br>  public function testButton (e: Event): void <br>  { <br>  var tmpString: String = new String (); <br>  tmpString = "y:" + String (e.target.y); <br>  Alert.show (tmpString); <br>  } <br><br>  As it turned out, to call a function from itemRenderer, you must use the outerDocument property, and the function itself should not be private.  Thus, the click property had to be rewritten with click = ‚ÄúouterDocument.testButton (event)‚Äù, after that everything worked and I got the Y coordinate.  The y coordinate was shown relative to the parent element, it was not what I needed, I need to know the coordinate relative to the entire component.  Go to google and write <br>  flex 3 coordinates, the first link is the article ‚ÄúUsing Flex coordinates‚Äù from the Adobe Flex 3 Help.  From the article it becomes clear that there are three types of coordinates: global, local and content, I need exactly the global coordinate and you can get it using the localToGlobal method.  Let's try to use this design. <br><br>  public function testButton (e: Event): void <br>  { <br>  var tmpString: String = new String (); <br>  var pt: Point = new Point (e.target.x, e.target.y); <br>  pt = e.target.localToGlobal (pt); <br>  tmpString = "y:" + String (pt.y); <br>  Alert.show (tmpString); <br>  } <br><br>  As expected, we got the global Y coordinate.  Now you need to create a menu.  As always, we turn to Help'u, in this case to "Using Menu-Based Controls".  First you need to define the menu structure, it can be done in various ways, I personally will do it through XML, like this: <br><br>  &lt;mx: XML format = "e4x" id = "trackMenu"&gt; <br><br><br>  &lt;/ mx: XML&gt; <br><br>  Now we make a function to display the menu: <br><br>  public function showTrackMenu (e: Event): void <br>  { <br>  var trackMenu: Menu = Menu.createMenu (null, trackMenuData, false); <br>  trackMenu.labelField = "@ label"; <br>  var pt: Point = new Point (e.target.x, e.target.y); <br>  pt = e.target.localToGlobal (pt); <br>  trackMenu.show (pt.x + e.target.width, pt.y); <br>  } <br><br>  Assign this function to a button: click = "showTrackMenu (event)".  The result was unexpected, the horizontal menu is excellent, but the Y menu goes down exactly as many as the buttons above are pressed.  I could not understand why this happens, so I did this: <br><br>  trackMenu.show (e.target.x + e.target.width + 3, e.target.y + 294); <br><br>  The solution, of course, sucks, but it works - the menu appears where necessary.  Now it is necessary that when you click on a menu item, a pop-up window appears with a list of friends and the ability to enter a comment on your recommendation.  First you need to understand how, in general, to determine that the user has clicked on a specific menu item, for this I will add another ‚Äúclose‚Äù item to the menu and I will experiment with it.  Everything turned out, it is very easy to add eventListener and a function to handle the event.  For the sake of experiment, I added the selectedMenu = "rec" property to the first menu item, and then checked how it works: <br><br>  public function showTrackMenu (e: Event): void <br>  { <br>  var trackMenu: Menu = Menu.createMenu (dgTracklist, trackMenuData, false); <br>  trackMenu.labelField = "@ label"; <br>  trackMenu.addEventListener (MenuEvent.ITEM_CLICK, itemClickInfo); <br>  trackMenu.show (e.target.x + e.target.width + 3, e.target.y + 294); <br>  } <br>  private function itemClickInfo (event: MenuEvent): void <br>  { <br>  if (event.item. @ menuSelected == "rec") Alert.show (event.item. @ menuSelected); <br>  } <br>  Everything worked fine.  Now you need to add a pop-up window, with a list of friends, a field for comment and the buttons "send" and "cancel."  I already know that you need to use TitleWindow for this.  Despite the fact that the ‚Äúrecommend track‚Äù menu is in the player component, I will create a pop-up window from the main application, which means you need to transfer the event from the component with the player to the main application.  At the same time, in event'e it will be necessary to transmit full information about the recommended track.  We need to create a custom event.  It seems that I have not yet described the creation of event events, so I will describe this process in more detail.  First I added the definition of a new event. <br>  &lt;mx: Metadata&gt; [Event (name = "giveAdvice", type = "com.vkapps.events.GiveAdviceEvent")] &lt;/ mx: Metadata&gt; <br>  Now you need to create it, create a new file GiveAdviceEvent.as and describe the event itself in it.  Here I will post the source directly, I think everything is clear in it: <br>  package com.vkapps.events <br>  { <br>  import flash.events.Event; <br>  public class GiveAdviceEvent extends Event <br>  { <br>  public static const GIVE_ADVICE: String = "giveAdvice"; <br>  public var aid: String; <br>  public var owner_id: String; <br>  public var artist: String; <br>  public var title: String; <br>  public var duration: String; <br>  public var url: String; <br>  public function GiveAdviceEvent (aid: String, owner_id: String, artist: String, title: String, duration: String, url: String) <br>  { <br>  super (GIVE_ADVICE); <br>  this.aid = artist; <br>  this.owner_id = title; <br>  this.artist = artist; <br>  this.title = title; <br>  this.duration = artist; <br>  this.url = title; <br>  } <br>  override public function clone (): Event <br>  { <br>  return new GiveAdviceEvent (this.aid, this.owner_id, this.artist, this.title, this.duration, this.url); <br>  } <br>  } <br>  } <br><br>  Well, there is an event.  It remains only to send it at the right time, like this: <br><br>  private function itemClickInfo (event: MenuEvent): void <br>  { <br>  if (event.item. @ menuSelected == "rec") <br>  { <br>  var giveAdvice: GiveAdviceEvent = new GiveAdviceEvent (dgTracklist.selectedItem.aid, dgTracklist.selectedItem.owner_id, dgTracklist.seidItem.artist, dgTracklist.septItem.title, dgTracklist.selectedItem.duration, dgTrack.ta..title, dgTracklist.selectedItem.duration, dgTrack.ta.ti.title, dgTracklist.selectedItem.duration, dgTrack.ta.ti.title, dgTracklist.tistle, dgTracklist.tistle, dgTracklist.tistle, dgTracklist.title, dgTracklist. <br>  dispatchEvent (giveAdvice); <br>  } <br>  } <br>  Go to the main application and add event listener: <br>  player.addEventListener (‚ÄúgiveAdvice‚Äù, giveAdvice); <br><br>  Now you need to prepare a pop-up window, for creating a new component based on TitleWindow.  Place the necessary controls there and declare variables that will contain information about the track, approximately, like this: <br><br>  [Bindable] <br>  public var _artist: String; <br>  Again we return to the main function and write a function to handle the event (I have reduced it): <br>  private function giveAdvice (event: Object): void <br>  { <br>  var pop1: AdviceForm = AdviceForm (PopUpManager.createPopUp (this, AdviceForm, true)); <br>  pop1.title = "Submit a recommendation"; <br>  pop1.showCloseButton = true; <br>  pop1._artist = event.artist; <br>  ... <br>  pop1._url = event.url; <br>  PopUpManager.centerPopUp (pop1); <br>  } <br>  Everything, the main interface for recommendations is ready.  Now we need the server part. <br><br><h2>  &lt;API, Zend and all such things&gt; </h2><br><br>  I wrote that the interface for recommendations is ready, but in fact I lied a little.  For complete happiness, it is necessary that the pop-up TitleWindow displays a list of friends who installed the application, because you can only recommend them.  In the api contact there is already a suitable getAppFriends method.  The problem is different - to create a request to api right in the pop-up window again - this is completely ugly and leads me to the need to make a separate class for working with contact api and then send all requests using instances of this class (actually, this is obvious, but before the urgent need for this was not).  Making the class was elementary, difficulties arose when I needed to return the result of the query from the class to the component.  The only (at least others I don‚Äôt know) way to do this is in the event.  I need to send the ResultEvent to the top, for this I again made my own event: <br><br>  import flash.events.Event; <br>  import mx.rpc.events.ResultEvent; <br>  public class CustomResultEvent extends Event <br>  { <br>  public static const FRIENDS_RESULT: String = "friendsResult"; <br>  public static const FRIENDS_APP_RESULT: String = "friendsAppResult"; <br>  public var customResult: ResultEvent; <br>  public function CustomResultEvent (type: String, e: ResultEvent) <br>  { <br>  super (type); <br>  this.customResult = e; <br>  } <br>  override public function clone (): Event <br>  { <br>  return new CustomResultEvent (type, customResult); <br>  } <br>  } <br><br>  In the file with the API, I send it, for example, as follows: <br><br>  private function friendsAppRequestHandler (event: ResultEvent): void <br>  { <br>  var friendsAppResult: CustomResultEvent = new CustomResultEvent ("friendsAppResult", event) <br>  dispatchEvent (friendsAppResult); <br>  } <br>  And I accept, for example, like this: <br><br>  private function init () <br>  { <br>  api.addEventListener ("friendsAppResult", friendsHandler); <br>  api.requestAppFriends (this._uid); <br>  } <br>  [Bindable] <br>  private var lFriendsList: XMLListCollection = new XMLListCollection (); <br>  private function friendsHandler (event: CustomResultEvent): void <br>  { <br>  lFriendsList.source = new XMLList (event.customResult.result.user); <br>  } <br>  Now the interface is actually ready and again now you need to do the server part.  So far it seems difficult.  For the server part, I plan to use Zend, so go google looking for a ‚Äúflex zend‚Äù.  The first link leads to the article: ‚ÄúFlex and PHP: Party in the Front, Business in the Back‚Äù, I quickly ran through her eyes, but it seems that this is not what I need.  After that, I switched to the article ‚ÄúIntegrating Adobe Flex and PHP‚Äù and this is already something closer to what I was looking for (despite the fact that Zend is not used in it).  At the end of the article there was a link to the author's blog: <a href="http://blogs.adobe.com/mikepotter/">blogs.adobe.com/mikepotter</a> I <a href="http://blogs.adobe.com/mikepotter/">followed the</a> link and there, for the first time, read about AMF.  Further searches in this direction convinced me that the use of the Flex + Zend AMF bundle would be optimal and in this sense two articles helped me: <br>  "Using Zend_Amf and Adobe Flex SDK" ( <a href="http://zendframework.ru/articles/flex-with-zend-amf">http://zendframework.ru/articles/flex-with-zend-amf</a> ) <br>  "Flex and PHP: remoting with Zend AMF" ( <a href="http://corlan.org/2008/11/13/flex-and-php-remoting-with-zend-amf/">http://corlan.org/2008/11/13/flex-and-php-remoting-with-zend-amf/</a> ) <br><br><h2>  &lt;Denver, Zend, AMF&gt; </h2><br><br>  In general, the basic things, I think I understood.  We must proceed to practice.  I will debug on my own computer, which means I need to run Denwer and configure everything there, including, of course, the database.  In the local database, I created two tables: audio and advice.  The audio table structure repeats the xml response from the contact, and the advice table now consists of the following fields: <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">id - recommendation number, aid - song id, owner_id - song owner id, sender_id - id of the person who sent the recommendation, comment - comment on the recommendation, read - indication whether the recommendation is read or not.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Now you need to configure the Zend part. First, the whole framework is hardly useful to me, so I limited myself to the components: Amf, Db, Filter, Validate, Xmlrpc. Let's try to create Amf endpoint, as described in the article. For writing PHP code, I will use NetBeans, I tried to use Zend Studio, but my whole business slowed down so wildly that I had to abandon this idea. I‚Äôll start by creating Value Object (descriptive class) for recommendations: VOadvice.php. I will not describe the creation process, everything is already described in the article I mentioned earlier. In general, having done everything that is written in the article about the creation of the server part, I got the desired line in the Zend Amf Endpoint browser, i.e. in theory, everything works. Go back to Flex and add interaction. At first I created the services-config.xml file, there was a small snag here,it turned out that there should be spaces at the beginning of the file. Fortunately, google immediately enlightened me about this. The rest of the day I spent in desperate attempts to understand why nothing works. More precisely, why the code from the article works, but my completely analogous code does not. I did not find the exact reason (perhaps the reason was that in my recommendation model, I did not describe the id field), in the end I just meticulously changed the names of the variables in the code from the article and I managed to add a recommendation. This is definitely wine, otherwise I was already afraid that I would have to go to bed to the vanquished, with gloomy thoughts about an unexpected deadlock. Fortunately, everything was decided, which means that tomorrow I will be able to continue to move towards the goal.The rest of the day I spent in desperate attempts to understand why nothing works. More precisely, why the code from the article works, but my completely analogous code does not. I did not find the exact reason (perhaps the reason was that in my recommendation model, I did not describe the id field), in the end I just meticulously changed the names of the variables in the code from the article and I managed to add a recommendation. This is definitely wine, otherwise I was already afraid that I would have to go to bed to the vanquished, with gloomy thoughts about an unexpected deadlock. Fortunately, everything was decided, which means that tomorrow I will be able to continue to move towards the goal.The rest of the day I spent in desperate attempts to understand why nothing works. More precisely, why the code from the article works, but my completely analogous code does not. I did not find the exact reason (perhaps the reason was that in my recommendation model, I did not describe the id field), in the end I just meticulously changed the names of the variables in the code from the article and I managed to add a recommendation. This is definitely wine, otherwise I was already afraid that I would have to go to bed to the vanquished, with gloomy thoughts about an unexpected deadlock. Fortunately, everything was decided, which means that tomorrow I will be able to continue to move towards the goal.in the end, I just meticulously changed the names of the variables in the code from the article and I managed to add a recommendation. This is definitely wine, otherwise I was already afraid that I would have to go to bed to the vanquished, with gloomy thoughts about an unexpected deadlock. Fortunately, everything was decided, which means that tomorrow I will be able to continue to move towards the goal.in the end, I just meticulously changed the names of the variables in the code from the article and I managed to add a recommendation. This is definitely wine, otherwise I was already afraid that I would have to go to bed to the vanquished, with gloomy thoughts about an unexpected deadlock. Fortunately, everything was decided, which means that tomorrow I will be able to continue to move towards the goal.</font></font><br><br><h2> &lt;AMF, PHP, &gt; </h2><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I have a lot of other things to do, so today I‚Äôd hardly be able to work a lot on the player, but I‚Äôll select a couple of hours. So, yesterday I stopped at the fact that I could force the code from the example to add a new recommendation to my database, now I need to bring this code into line with my project, i.e. in fact, I need to carefully rename the classes and methods so that they reflect my purpose, and not the purpose from the article (in particular, I need to rename everything that was User and Users into Advice and Advices). Renaming was successful, recommendations are added (although sometimes there are errors similar to the timeout, this is confirmed by entries like ‚ÄúMaximum execution time of 30 seconds exceeded‚Äù in the logs, but for now I will not focus on them). Now you need to add various checks for data correctness and, first of all, you need to make surethat the request was sent by the Contact user and exactly to the one specified, for that there is a contact provided by auth_key. It's time to use it. auth_key is calculated on the VK server as follows:</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">auth_key = md5 (api_id + '_' + viewer_id + '_' + api_secret) and transferred to the application via flashvars, api_secret is known only to the author of the application, therefore in the server part, I will have to calculate md5 and compare it with the data sent from the application so that make sure that the request is sent by the correct user. At first, I had to at least just have a look at this very auth_key, in Flex it is stored in Application.application.parameters.auth_key, for a long time I could not get this key until I found out that in the settings of the VKontakte application, I had to go to The ‚Äúpayments‚Äù tab and these same payments are included, only then does the auth_key start to be issued. In general, in Flex I received the key, now I need to transfer it to the server. Therefore, we will now send 2 parameters to the server: an object with a recommendation and an auth_key for comparison.On the server, re-create the md5 with api_secret known to us and passed to viewer_id, if the keys match, then everything is fine. Nevertheless, theoretically, an unscrupulous user can still recognize his own auth_key and then send requests to bypass my Flex shell, so the transferred data should be checked anyway. Well, apparently Zend Filter and Zend Validate help me. I go to read docks on these components. After reading some simple documentation, I added a few filters and validators that properly filter incoming data. So, at the moment we have the opportunity to add a recommendation and it is hoped that it will be added in a safe manner. We need another check - check for the existence of such a record on VKontakte, i.e.we must send a request to the contact and get an answer in which the field of aid received from the client and received from the contact API will match. In case of successful verification, if a song with this aid does not exist in the audio table, you need to add it there. After that, it will be necessary to receive a list of recommendations for a specific user from the server, display recommendations in a convenient form, delete recommendations and send notifications to the user that he has received a new recommendation. In general, again I spent all day with the player and did nothing of the other things. So now I will return to the player only after I do the most urgent things, I think this is a good motivation to deal with them sooner.After that, it will be necessary to receive a list of recommendations for a specific user from the server, display recommendations in a convenient form, delete recommendations and send notifications to the user that he has received a new recommendation. In general, again I spent all day with the player and did nothing of the other things. So now I will return to the player only after I do the most urgent things, I think this is a good motivation to deal with them sooner.After that, it will be necessary to receive a list of recommendations for a specific user from the server, display recommendations in a convenient form, delete recommendations and send notifications to the user that he has received a new recommendation. In general, again I spent all day with the player and did nothing of the other things. So now I will return to the player only after I do the most urgent things, I think this is a good motivation to deal with them sooner.I think this is a good motivation rather to deal with them.I think this is a good motivation rather to deal with them.</font></font><br><br><h2> &lt;, , ¬´¬ª,     &gt; </h2><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">For a few days I left the city, first with friends to the dacha, then to the tourist center, then I noticed something else in the city, in general, I rested for five days and did not work on the player. It is very good that in the previous post I described the approximate front of the next works and now I don‚Äôt have to go long. So, we need to send a request to the contact, it seems that the time has come for the xmlrpc module. Useful to understand. So, it seems xmlrpc is at all that. Most likely you need zend_rest, I'll try to read about it. I read it, tried it, but in the end I did it through the usual Zend_Http_Client (I will redo it if necessary). In response, I received ‚ÄúUser authorization failed‚Äù from the api contact, apparently the requests from the server should be made in a more complicated way, but now it is three in the morning, so I will go to sleep, and tomorrow I will deal with this issue.</font></font><br><br><h2> &lt; secure&gt; </h2><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">As it turned out, only secure requests can be sent from an external server to an api contact, normal requests cannot be sent. </font><font style="vertical-align: inherit;">This is a rather unpleasant news, because I am deprived of the opportunity to check the received data, I think the api developers will eventually solve this problem, but for now I‚Äôll have to be content with what we have. </font><font style="vertical-align: inherit;">Well, then we‚Äôll assume that adding recommendations works. </font><font style="vertical-align: inherit;">Now we need to make a receipt of recommendations. </font><font style="vertical-align: inherit;">To begin with the server part. </font><font style="vertical-align: inherit;">As soon as I started doing, I immediately noticed that I forgot the most important thing - the recipient's id. </font><font style="vertical-align: inherit;">Just add the appropriate field to the database and make small changes to the client and server parts, there is nothing special to describe here. </font><font style="vertical-align: inherit;">After the changes, a gid field appeared in the database in which the recipient's id is entered. </font><font style="vertical-align: inherit;">Now for sure, you can proceed to receive recommendations.</font></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> &lt;Database&gt; </font></font></h2><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It was originally thought that the client would receive only id tracks, and then he himself would send a request to the contact for the rest of the information, but after a little thought, I realized that this was too inefficient. With more than twenty recommendations, their receipt will take too much time. Therefore, I will keep all the tracks on the server, as well as user data and I will receive this information from the server. To do this, I added new properties to my model of advice, including full track information and sender information (first and last name). Now when sending a recommendation, the presence of such a track in the audio table is checked and if there is no such track, it is entered into the table. We do the same with the sender, if it is not already in my database, then add it there. Accordingly, when we receive a recommendation,We get full information: recommendation, track information, information about the sender. To display the recommendations in the application, I decided to use a regular list with item renderer.</font></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> &lt;Final touches&gt; </font></font></h2><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I worked here for a few more days and, it seems, did everything. </font><font style="vertical-align: inherit;">For starters, I made an itemRenderer for a list of recommendations. </font><font style="vertical-align: inherit;">itemRenderer includes a label pair with an indication of who came from the recommendations and the name of the track, TextArea, in which the comment and the delete button are displayed. </font><font style="vertical-align: inherit;">The list is </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">populated </font><font style="vertical-align: inherit;">like this: </font><font style="vertical-align: inherit;">private function getAllHandler (event: ResultEvent): void</font></font><br>  { <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">if (event.result.toString () == '') Alert.show ('No recommendation'); </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">else tlAdvices.dataProvider = event.result as Array; </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">adviceLoaded = true;</font></font><br>  } <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The request for a list of recommendations is sent when switching to the appropriate tab, and only once, for this is the variable adviceLoaded. All this construction worked well and I moved on to the next step. Now it was necessary to make a list of unread recommendations, and if the number of unread recommendations is more than zero, then this value should be displayed in parentheses in the header of the ‚Äúrecommend‚Äù tab, i.e. should be something like ‚Äúrecommendations (2)‚Äù. We create a new countRead method on the server, I will not describe it entirely, in general, after all the checks, such a request is sent and its result is returned: </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">$ select -&gt; from (array ('a' =&gt; 'advice'), array ('num' =&gt; 'count (*)')) </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-&gt; where ('a.gid =?', $ gid) </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-&gt; where ('a.read = 0 ');</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Accordingly, in the client, when you start the player, we send the roAdvices.countRead (cuid, auth); request, and process the result of the query like this: </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">private function countReadHandler (event: ResultEvent): void</font></font><br>  { <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> if (int (event.result)&gt; 0) cAdvices.label = cAdvices.label + '(' + String (event.result) + ')'; </font></font><br>  } <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Well, it works, now you need to somehow mark the read and unread recommendations, as well as add a mechanism that will translate the recommendation into the category of read. Here I decided to use the scheme that is implemented in ‚ÄúTheBat‚Äù, unread recommendations are highlighted in bold, read - normal, and the recommendation is considered to be read after clicking on it. Read or unread is determined by the read property, which can be 1 or 0, respectively. To display the status of the recommendation, naturally, it is necessary inside itemRenderer. To do this, add a few actionscript: </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">override public function set data (value: Object): void { </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">super.data = value; </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">if (int (data.read) == 0)</font></font><br>  { <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">lSender.setStyle ("fontWeight", "bold"); </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">lTrack.setStyle ("fontWeight", "bold");</font></font><br>  } <br>  else <br>  { <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">lSender.setStyle ("fontWeight", "normal"); </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">lTrack.setStyle ("fontWeight", "normal");</font></font><br>  } <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">if (String (data.comment) == '') taComment.htmlText = 'No Comments'; </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">if (String (data.comment)! = '') taComment.htmlText = data.comment;</font></font><br>  } <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This allowed us to separate read and unread recommendations. </font><font style="vertical-align: inherit;">Now it is necessary that after clicking on the recommendation, it becomes read. </font><font style="vertical-align: inherit;">This is done in two stages: firstly, you need to change the read field for this recommendation in the database on the server, secondly, to display these changes in the application. </font><font style="vertical-align: inherit;">Add the itemClick = ‚ÄúcheckRead (event)‚Äù property to the List component, and then write the function itself and the event handler for it: </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">public function checkRead (event: Event): void</font></font><br>  { <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> if (int (event.currentTarget.selectedItem.read) == 0) </font></font><br>  { <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">index = event.currentTarget.dataProvider.getItemIndex (event.currentTarget.selectedItem); </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">roAdvices.updateRead (event.currentTarget.selectedItem.id, cuid, auth);</font></font><br>  } <br>  } <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> private function updateReadHandler (event: ResultEvent): void </font></font><br>  { <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tlAdvices.dataProvider [index] .read = 1; </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tlAdvices.invalidateList ();</font></font><br>  } <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Well, on the server we create the updateRead method, which ends like this: </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">$ adviceData = array ('read' =&gt; 1); </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">$ where [] = "id =". </font><font style="vertical-align: inherit;">$ this -&gt; _ db-&gt; quote ($ id); </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">$ where [] = "gid =". </font><font style="vertical-align: inherit;">$ this -&gt; _ db-&gt; quote ($ gid); </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">return $ this -&gt; _ db-&gt; update ('advice', $ adviceData, $ where); </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">invalidateList () in the updateReadHandler function is needed in order for the changes to appear in the list.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">At the moment, we already have the opportunity to create, receive and update the recommendation, it remains only to add the deletion. For deletion, we have a ‚ÄúDelete‚Äù button in itemRenderer. It is considered a good practice to send an itemRenderer event to the top, which some function will catch there and do the necessary action, but for some reason I didn‚Äôt manage to do that, so I did all the actions to delete the entry directly from itemRenderer. Here I had to get acquainted with such a thing as listData. The listData contains information about the parent component; I need this information in order to delete the entry in the database on the server as well in the application. To begin, I added the property </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">implements = "mx.controls.listClasses.IDropInListItemRenderer" to the base component, in my case it was vbox:</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&lt;? xml version = "1.0" encoding = "utf-8"?&gt; </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&lt;mx: VBox xmlns: mx = " </font></font><a href="http://www.adobe.com/2006/mxml"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">www.adobe.com/2006/mxml</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> " width = "298" height = "124" horizontalScrollPolicy = "off "PaddingLeft =" 10 "paddingRight =" 10 "paddingTop =" 10 "dropShadowEnabled =" true "dropShadowColor =" # A4A4A4 "borderStyle =" solid "borderThickness =" 0 "implements =" mx.controls.listClasses.IDropInListItemRenderer "&gt; </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A also added functions: </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">private var _listData: BaseListData; </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">public function get listData (): BaseListData</font></font><br>  { <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> return _listData; </font></font><br>  } <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> public function set listData (value: BaseListData): void </font></font><br>  { <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> _listData = value; </font></font><br>  } <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Now I have access to listData, and then everything is simple. </font><font style="vertical-align: inherit;">Add a couple of functions: </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">private function itemDelete (): void</font></font><br>  { <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">var ow: List = listData.owner as List; </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">index = ow.dataProvider.getItemIndex (this.data); </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">roAdvices.deleteById (this.data.id, parentDocument.cuid, parentDocument.auth);</font></font><br>  } <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> private function deleteHandler (event: ResultEvent): void </font></font><br>  { <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">var ow: List = listData.owner as List; </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ow.dataProvider.removeItemAt (ow.dataProvider.getItemIndex (this.data)); </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ow.invalidateList ();</font></font><br>  } <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Well, in the button, add the property click = "itemDelete ()". </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In the list component, which displays a list of all recommendations, I added itemDoubleClick = "onUrlChange (event)", this property starts playing the song by double-clicking on recommendations. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Now everything is ready, it remains to update the application in contact. To my surprise, after downloading the new version of the application, I could not connect to the server to get recommendations. It turned out that the problem in the crossdomain.xml file, this file should be located in the root directory of the server and allow receiving data, in my case it looks like this:</font></font><br><br>  &lt;? xml version = "1.0"?&gt; <br><br>  &lt;! DOCTYPE cross-domain-policy SYSTEM " <a href="">www.macromedia.com/xml/dtds/cross-domain-policy.dtd</a> "&gt; <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&lt;cross-domain-policy&gt; </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&lt;allow-access-from domain = " </font></font><a href="http://www.company.com/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">www.company.com</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> " secure = "false" /&gt; </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&lt;/ cross-domain-policy&gt; </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">After creating this file, everything worked. </font><font style="vertical-align: inherit;">If you have any questions, money, oil or servers - write.</font></font><br></div><p>Source: <a href="https://habr.com/ru/post/65099/">https://habr.com/ru/post/65099/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../65094/index.html">Video Recorder Zoom Q3</a></li>
<li><a href="../65095/index.html">Video from the first meeting of Yota with bloggers</a></li>
<li><a href="../65096/index.html">Retrieving information from Active Directory and Firebird</a></li>
<li><a href="../65097/index.html">Start beta testing Handy.CMS 3.1 for developers</a></li>
<li><a href="../65098/index.html">Lazy!</a></li>
<li><a href="../65101/index.html">Stap man stapler</a></li>
<li><a href="../65104/index.html">How do you feel about IT infrastructure service outsourcing?</a></li>
<li><a href="../65109/index.html">Expression Web 3 + SuperPreview Released</a></li>
<li><a href="../65111/index.html">Programming Threads under Compact Framework</a></li>
<li><a href="../65114/index.html">New iGoogle features</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>