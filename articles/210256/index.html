<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>The subtleties of analyzing C / C ++ source code using cppcheck</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the previous post , the main features of the open source static analyzer cppcheck were considered. It does not show itself from the worst even with...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>The subtleties of analyzing C / C ++ source code using cppcheck</h1><div class="post__text post__text-html js-mediator-article">  In the previous <a href="http://habrahabr.ru/post/210226/">post</a> , the main features of the open source static analyzer <a href="http://cppcheck.sourceforge.net/">cppcheck</a> were considered.  It does not show itself from the worst even with the basic settings, but today it will be a question of how to squeeze the most useful out of this analyzer. <br><br>  This article will look at the possibilities of cppcheck in capturing memory leaks, useful parameters for improving the analysis, as well as an experimental opportunity to create your own rules.  Today there are no comparisons of ‚Äúwho's better‚Äù analyzers, the article is completely devoted to working with cppcheck. <br><a name="habracut"></a><br><h4>  Download and install </h4><br>  You can download cppcheck from the <a href="http://cppcheck.sourceforge.net/">official website</a> , there is an installer for Windows, and for Linux I recommend downloading the source code from the <a href="https://github.com/danmar/cppcheck">gita</a> , since it is very easy to assemble and has no dependencies.  Building from the source code will enable an experimental feature, which will be discussed at the end of the article. <br><br>  In particular, for my Linux machine, I <a href="https://help.github.com/articles/fork-a-repo">forked</a> a cppcheck on GitHub and made a git clone fork.  This will make it possible in the future to commit to the repository its own configs and hand-written verification rules, <a href="https://help.github.com/articles/syncing-a-fork">periodically synchronizing</a> with the main repository, which you will agree is very convenient (not to mention the possibility of sending patches to the project). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h5>  We collect for Linux </h5><br>  Building in Linux is extremely simple: download, unpack, change directory and make: <br><br><pre><code class="bash hljs">unzip cppcheck-master.zip <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> cppcheck-master make</code> </pre> <br><h5>  We collect for Windows </h5><br>  Building in Windows shouldn't be difficult either - there is a project for VS.  We open, we collect.  I have not tried it myself, since I do not have such a need. <br><br><h5>  Cppcheck as plugin </h5><br>  Regarding plugins for IDE, there are plugins for Code :: Blocks, CodeLite, Gedit and Eclipse, of course.  But this is not limited to this, as there are plugins for Hudson, Jenkins assembly farms, for Tortoise SVN and Mercurial version control systems.  There is no plugin for Visual Studio, but there is a very nice phrase on the main page: <br><br><blockquote>  Cppcheck as an external tool.  You can also try the proprietary PVS-Studio (there is a free trial), which is for this environment. </blockquote><br>  In cppcheck there is a GUI written in Qt.  It even more simplifies the analysis process, but we don‚Äôt go into much detail in it - severe programmers do not use graphical interfaces :) Moreover, the GUI completely repeats the command line capabilities (and in some cases, is inferior) and sort out it after learning about cppcheck labor will not make up. <br><br>  It is worth noting that cppcheck is distributed under the GNU GPL license.  This allows you to easily take the source code of this program, drag Git into your repository and finish there for any needs, adding your own rules and libraries. <br><br><h4>  Analyzer Setup </h4><br>  The good thing about cppcheck is the ability to fine tune.  You can adjust the level of sensitivity, format the output of messages, and filter some annoying messages. <br><br>  For the sake of fairness, I note that all the information outlined below can be obtained from the <a href="http://cppcheck.sourceforge.net/manual.html">documentation</a> or by executing the command <i>cppcheck --help</i> , but I will focus on the most important nuances in more detail (and in Russian :).  The cppcheck documentation is getting better from year to year, so it is sometimes useful to reread it. <br><br>  If it seems to you that I am engaged in the retelling of documentation - go on to read the next section, because here is the information for those who have never used cppcheck and analyzers in principle before. <br><br><h5>  Error levels </h5><br>  By default, cppcheck tries, if possible, to display only 100% errors.  This means that if the analyzer found a suspicious area, but is not sure that it is a bug, it will not report it.  This feature allows you to use cppcheck at assembly stations, so that due to false positives of the analyzer, the assembly does not stop after each commit. <br><br>  An example of how this works.  Suppose you need to analyze the following code: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">f</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *a = <span class="hljs-built_in"><span class="hljs-built_in">malloc</span></span>(<span class="hljs-number"><span class="hljs-number">100</span></span>); process_a(a); }</code> </pre><br>  At first glance, there is an error: no <i>free</i> .  However, if the function <i>process_a</i> is a library function, it is impossible to say with certainty that <i>process_a</i> somewhere inside does not make <i>free</i> for the pointer <i>a</i> .  If, inside the <i>process_a</i> function, the variable <i>a is</i> actually released, this is a false positive that will interfere with the analysis.  Therefore, cppcheck will first try to find the implementation of the <i>process_a</i> function in the code of the program being analyzed, make sure that it does not call <i>free</i> , and only in this case will generate an error.  If the implementation is not found, cppcheck assumes the most favorable scenario possible: <i>process_a</i> frees the memory and therefore does not generate an error.  However, cppcheck can be ‚Äútaught‚Äù to recognize the functions of libraries, thereby increasing the accuracy of the analysis - this will be discussed below. <br><br>  Second example: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">f</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *a = <span class="hljs-built_in"><span class="hljs-built_in">malloc</span></span>(<span class="hljs-number"><span class="hljs-number">100</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(random()) g_exit(<span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">free</span></span>(a) }</code> </pre><br>  There is obviously already a memory leak, since <i>g_exit</i> is a wrapper of the GLib library over the standard <i>exit</i> function.  But cppcheck does not know that <i>g_exit</i> interrupts program execution, so the analyzer will not be able to recognize errors here.  It is necessary to somehow provide cppcheck with the information that the <i>g_exit</i> function can interrupt the program so that the analyzer <i>learns</i> to recognize such errors. <br><br>  From the examples it is clear that cppcheck is reinsured, and the adequacy level is high.  Most cppcheck checks do not include by default.  Among them are the following categories of checks, each of which can be turned on / off independently: <br><br><ul><li>  <b>error</b> - obvious errors that the analyzer considers critical and usually lead to bugs (enabled by default); </li><li>  <b>warning</b> - warnings, there are messages about unsafe code; </li><li>  <b>style</b> - stylistic errors, messages appear in the case of inaccurate coding (more like recommendations); </li><li>  <b>performance</b> - <b>performance</b> problems, here cppcheck offers options on how to make the code faster (but this does not always give a performance boost); </li><li>  <b>portability</b> - compatibility errors, usually associated with different behavior of compilers or systems of different length; </li><li>  <b>information</b> - informational messages arising during the test (not related to errors in the code); </li><li>  <b>unusedFunction</b> - an attempt to calculate unused functions (dead code), does not know how to work in multi-threaded mode; </li><li>  <b>missingInclude</b> - check for missing <i>#include</i> (for example, use <i>random</i> , but forgot to connect <i>stdlib.h</i> ). </li></ul><br>  Checks are <b>enabled with the --enable</b> parameter, the list of check categories is separated by commas.  For example: <br><br><pre> <code class="bash hljs">cppcheck -q -j4 --<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>=warning,style,performance,portability ./<span class="hljs-built_in"><span class="hljs-built_in">source</span></span></code> </pre><br>  Thus, I usually include the most important checks.  There is the keyword <i>all</i> , which includes all the listed checks. <br><br>  <i>Note</i>  The <b>-j</b> parameters and the <i>unusedFunction</i> check <i>mode</i> are incompatible, so <b>-j</b> will turn off the unusedFunction check, even if it is explicitly specified. <br><br>  An example of a command that ‚Äúdrives‚Äù the code according to all the rules: <br><br><pre> <code class="bash hljs">cppcheck -q --<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>=all ./<span class="hljs-built_in"><span class="hljs-built_in">source</span></span></code> </pre><br>  And that is not all.  If your program is error-free from the point of view of the analyzer, try running cppcheck with the <b>--inclusive option</b> .  This mode does include all possible checks, even errors with low probability, which cppcheck misses by default. <br><br>  Thus, the most detailed verification mode: <br><br><pre> <code class="bash hljs">cppcheck -q --<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>=all --inconclusive ./<span class="hljs-built_in"><span class="hljs-built_in">source</span></span></code> </pre><br><h5>  Do not forget about cross-platform! </h5><br>  Cppcheck was originally created as a tool that works with different operating systems and platforms.  Therefore, it is imperative to keep track of which platform the program is written for and which verification mode uses cppcheck.  The platform is switched by the <b>--platform</b> parameter. <br><br>  Different platforms: <br><br><ul><li>  unix32 - all 32-bit * nix (including Linux); </li><li>  unix64 - all 64-bit * nix; </li><li>  win32A is a 32-bit Windows family with ASCII encoding; </li><li>  win32W is a 32-bit Windows family with UNICODE encoding; </li><li>  win64 is a family of 64-bit Windows. </li></ul><br>  If you need to check the code that was written for Win32 using Linux, you must specify the platform: <br><br><pre> <code class="bash hljs">cppcheck --platform=win32A ./<span class="hljs-built_in"><span class="hljs-built_in">source</span></span></code> </pre><br>  You can specify the standard by which the source code is written, which sometimes allows you to refine the check and catch new errors.  Use the <b>--std option</b> with the following options: <br><br><ul><li>  posix - for POSIX compatible OS (including Linux); </li><li>  c89 - C language, the standard of the 89th year; </li><li>  c99 - C language, standard of the 99th year; </li><li>  c11 - C language, standard 11th year (default for C); </li><li>  c ++ 03 - C ++ language, standard of the 3rd year; </li><li>  c ++ 11 - C ++ language, standard of the 11th year (default for C ++). </li></ul><br>  You can use two standards at once: <br><br><pre> <code class="bash hljs">cppcheck --std=c99 --std=posix ./<span class="hljs-built_in"><span class="hljs-built_in">source</span></span></code> </pre><br><h5>  Useful command line arguments </h5><br>  Probably already striking that I always use the parameters <b>-q</b> , <b>-j</b> .  What are they needed for?  Consider the most interesting. <br><br>  <b>-j</b> is a very useful parameter that allows you to run a scan in multi-threaded mode.  It is very simple to use - the number of processors is passed as a parameter and the check will go more fun. <br>  <b>-q</b> - silent mode.  By default, cppcheck issues informational messages about the progress of the check (which can be very much).  This option completely disables informational messages, only error messages remain. <br>  <b>-f</b> or <b>--force</b> - enable <b>iteration of</b> all variants of ifdef directives (by default, cppcheck checks a dozen variants).  What is it - then it will be considered separately. <br>  <b>-v</b> - debug mode - cppcheck gives internal information on the progress of the check. <br>  <b>--xml</b> - display the result of the check in XML format. <br>  <b>--template = gcc</b> - display errors in the gcc compiler warning format (convenient for integration with an IDE that supports this compiler). <br>  <b>--suppress</b> - error suppression mode with the specified identifiers (need to be re-analyzed). <br>  <b>-h</b> - issues a certificate for all parameters in pure English. <br><br><h5>  Message Filtering and Exceptions </h5><br>  Like any self-respecting cppcheck analyzer, you can flexibly customize the display of errors during the test.  Most useful is it is possible to disable a specific warning in a specific file (and possibly in a specific line).  Disabling messages is implemented by the <b>--suppress</b> parameter, where you need to specify an exception, or <b>--suppress-file</b> with a text file, which contains a list of exceptions.  To pass several exceptions in the command line, you can specify several options <b>--suppress</b> in a row, but it is better to file a file with exceptions for such purposes. <br><br>  Exception format: <br><br><pre> <code class="bash hljs">id[:file:[line]]</code> </pre><br>  Mandatory parameter id (error identifier), followed by a colon, you can optionally specify the file name, after the file name, also optionally, you can specify the line number. <br><br>  For example, very often this warning pops up: <br><br><pre> <code class="bash hljs">The scope of the variable <span class="hljs-string"><span class="hljs-string">'%VAR'</span></span> can be reduced.</code> </pre><br>  This error is inherent in most projects and so that it does not discourage the desire to refactor, at first I recommend turning it off.  This can be done in the following way: <br><br><pre> <code class="bash hljs">cppcheck -q -j4 --<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>=all --suppress=variableScope ./<span class="hljs-built_in"><span class="hljs-built_in">source</span></span></code> </pre><br>  As you can see from this example, cppcheck uses human-readable error identifiers rather than numbers, which is much easier to remember. <br><br>  Find out the list of all possible errors will help parameter <b>--errorlist</b> , which gives a complete list in XML format.  But I can advise another method of determining "unwanted" messages.  To do this, you will need to change the message display format using the - <b>template</b> parameter <br><br><pre> <code class="bash hljs">cppcheck -q -j4 --<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>=all --template=<span class="hljs-string"><span class="hljs-string">'{id} {file}:{line} {message}'</span></span> ./<span class="hljs-built_in"><span class="hljs-built_in">source</span></span></code> </pre><br>  My template now first displays the message ID, followed by the file with the line number and, finally, the message itself.  Find out the ID of the interfering message is not difficult. <br><br><div class="spoiler">  <b class="spoiler_title">Sample output</b> <div class="spoiler_text"><pre> <code class="bash hljs">variableScope geany/src/document.c:1099 The scope of the variable <span class="hljs-string"><span class="hljs-string">'use_ft'</span></span> can be reduced. variableScope geany/src/document.c:1257 The scope of the variable <span class="hljs-string"><span class="hljs-string">'filename'</span></span> can be reduced. variableScope geany/src/document.c:2306 The scope of the variable <span class="hljs-string"><span class="hljs-string">'keywords'</span></span> can be reduced. variableScope geany/src/document.c:3011 The scope of the variable <span class="hljs-string"><span class="hljs-string">'old_status'</span></span> can be reduced. variableScope geany/src/editor.c:194 The scope of the variable <span class="hljs-string"><span class="hljs-string">'specials'</span></span> can be reduced. variableScope geany/src/editor.c:248 The scope of the variable <span class="hljs-string"><span class="hljs-string">'ptr'</span></span> can be reduced. variableScope geany/src/editor.c:1545 The scope of the variable <span class="hljs-string"><span class="hljs-string">'text'</span></span> can be reduced. variableScope geany/src/editor.c:4309 The scope of the variable <span class="hljs-string"><span class="hljs-string">'tab_str'</span></span> can be reduced.</code> </pre><br></div></div><br>  Finally, a recipe for automatically creating a file for use in the <b>--suppress-file</b> parameter.  On the command line, this is done in two accounts: <br><br><pre> <code class="bash hljs">cppcheck -q --<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>=all --template=<span class="hljs-string"><span class="hljs-string">'{id}:{file}:{line}'</span></span> ./<span class="hljs-built_in"><span class="hljs-built_in">source</span></span> &gt; suppress-list.txt</code> </pre><br>  Now the resulting file can be submitted to the cppcheck input and there will not be a single error in the output.  This is useful when the analysis is completed and all analyzer responses are false. <br><br>  Cppcheck also allows you to write exceptions inside comments, but the example above will avoid cluttering up the source code by collecting all the exceptions in one place, rather than scattering them throughout the project. <br><br><h5>  We understand with include and define </h5><br>  Cppcheck understands some compiler options, which allows you to specify which path is being tested.  Since cppcheck does not use the services of a compiler, it has its own preprocessor.  This preprocessor does not require the presence of all the header files, nor the correctness of the source code.  If somewhere there is an unknown <i>include</i> , cppcheck simply does not process it. <br><br>  Uncertainty can play a cruel joke.  A common practice in the GLib library is to check the arguments: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">f</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(gchar *s1, gchar *s1)</span></span></span><span class="hljs-function"> </span></span>{ g_return_if_fail(s1); gchar *a = g_strdup(s1); g_return_if_fail(s2); gchar *b = g_strdup(s2); }</code> </pre><br>  All is well with the exception that <i>g_return *</i> are macros that interrupt the execution of a function in case of errors.  Thus, if the first argument of the function <i>f</i> turns out to be correct, and the second does not, a memory leak occurs.  Cppcheck does not know about this, since it considers <i>g_return_if_fail</i> by default to be a ‚Äúgood function‚Äù and not a macro. <br><br>  You can change the behavior of cppcheck if you include the necessary header files so that the preprocessor does all the necessary work: it finds the implementation of the <i>g_return_if_fail</i> macro, <i>opens</i> it, and cppcheck sees the conditional <i>return</i> without <i>free</i> , which is a memory leak pattern. <br><br>  In order to make the preprocessor work as it should, you need to specify the paths where to look for the header files.  The <b>-I</b> parameter, which is similar to the gcc compiler of the same name, is responsible for this.  For GLib and Linux, this is quite a predictable path: <br><br><pre> <code class="bash hljs">cppcheck -q -I/usr/include/glib-2.0/ ./<span class="hljs-built_in"><span class="hljs-built_in">source</span></span></code> </pre><br>  An interesting feature (which greatly increases the analysis time) is a search of ifdef variants.  If there is one ifdef in the program, cppcheck will make two preprocessing options and scan both versions of the source code.  The more ifdef-branches in the source code, the more options you have to iterate.  You can control this behavior with the <b>-D</b> and <b>-U</b> parameters.  The <b>-D <i>A</i></b> parameter means that the macro <b><i>A is</i></b> defined.  The <b>-U <i>B</i></b> parameter means that the macro <b><i>B is</i></b> not defined. <br><br>  By default, only a dozen configurations are checked.  You can change this number with the <b>--max-configs</b> parameter.  To check only one configuration, you can set one configuration check.  The <b>--force option</b> will check all configurations (very slowly). <br><br>  Cppcheck does not distinguish macros from header files from macros defined in the source code.  If the analysis is strengthened by preprocessing all <i>#include</i> , specifying a directory with header files - prepare for a <u>very</u> long analysis - cppcheck will peel <b>all</b> macros from all header files that the preprocessor has reached. <br><br>  The use of the preprocessor is the easiest way to improve the check, but it is obvious that the time of this check is greatly increased, since the preprocessing inflates the source code to hundreds of megabytes.  Using the GLib example, a more efficient way to catch memory leaks will be shown, using another cppcheck feature to provide information about third-party libraries. <br><br><h4>  We write the implementation of functions independently </h4><br>  It is worth noting that the <b>-I</b> parameter only tells cppcheck where to look for the header files and connects them only if there is a corresponding <i>#include</i> in the source file.  You can use a slightly more costly alternative: implement the most frequent macros and functions manually and connect them to all project files.  We will have to work a little to create such a file, but the analysis will go much faster and more accurately.  Moreover, you can use some interesting tricks with macros. <br><br>  Connecting a file with the implementation of functions is implemented by the parameter <b>--append</b> .  The specified file is automatically inserted <b>at the end of</b> each project file. <br><br>  Connecting a file with macros is implemented by the <b>--include</b> parameter.  The specified file is automatically inserted <b>at the beginning of</b> each project file. <br><br>  For example, the program uses the GLib library and you need to tell cppcheck that <i>g_return_if_fail</i> is a macro. <br><br>  Let's try to analyze this code: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">f</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *s1, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *s1)</span></span></span><span class="hljs-function"> </span></span>{ g_return_if_fail(s1); <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *a = g_strdup(s1); g_return_if_fail(s2); <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *b = g_strdup(s2); <span class="hljs-built_in"><span class="hljs-built_in">free</span></span>(a); <span class="hljs-built_in"><span class="hljs-built_in">free</span></span>(b); }</code> </pre><br>  Run cppcheck: <br><br><pre> <code class="bash hljs">cppcheck -q test.c</code> </pre><br>  Nothing. <br><br>  Create a file gtk.h with the following content: <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> g_return_if_fail(expr) do{</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta">(!(expr)){return;}}while(0)</span></span></code> </pre><br>  Since this is a macro, it must be included at the beginning: <br><br><pre> <code class="bash hljs">cppcheck -q test.c --include=gtk.h</code> </pre><br>  Hm  Nothing again?  If you look at the code in the example, you can notice the function <i>g_strdup</i> , about which cppcheck does not know anything yet.  Let's try to write the simplest implementation ( <i>gtk.c</i> file): <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">char</span></span></span><span class="hljs-function"> * </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">g_strdup</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *s)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> strdup(s); }</code> </pre><br>  Note that this is a function, not a macro. <br>  We analyze.  The file with the function implementation is inserted by the <b>--append</b> parameter; <br><br><pre> <code class="bash hljs">cppcheck -q test.c --include=gtk.h --append=gtk.c [test.c:4]: (error) Memory leak: a</code> </pre><br>  Done!  Now cppcheck has learned to detect new memory leaks.  A smart analyzer climbed inside the g_strdup function code, made a trace of the return value, and found a <i>strdup</i> there, marking the pointers as pointers to the memory to be freed. <br><br>  This example is not taken from the ceiling: this is one of the most common mistakes in GLib programs that I find all the time. <br><br><h4>  Tricks with macros and implementations </h4><br>  The mechanism for connecting files to a project is a very flexible tool.  With it, you can do such things as the elimination of functions with known behavior, the substitution of function arguments, the definition of missing typedefs. <br><br>  In many cases, cppcheck does not need to have any header file present or a data type / class defined.  Therefore, writing macros only makes sense if they improve the check. <br><br><h5>  Non-standard memory allocation </h5><br>  Suppose there is a function my_alloc, which allocates memory within its arguments: <br><br><pre> <code class="cpp hljs">my_alloc(<span class="hljs-keyword"><span class="hljs-keyword">char</span></span> **a);</code> </pre><br>  The following example will not be recognized as a memory leak: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">f</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *a, *b; my_alloc(&amp;a, &amp;b); }</code> </pre><br>  Now add the implementation: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">my_alloc</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> **a, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> **b)</span></span></span><span class="hljs-function"> </span></span>{ *a = <span class="hljs-built_in"><span class="hljs-built_in">malloc</span></span>(<span class="hljs-number"><span class="hljs-number">13</span></span>); *b = <span class="hljs-built_in"><span class="hljs-built_in">malloc</span></span>(<span class="hljs-number"><span class="hljs-number">42</span></span>); }</code> </pre><br>  and the check will issue the following: <br><br><pre> <code class="bash hljs">[test.c:4]: (error) Memory leak: a [test.c:4]: (error) Memory leak: b</code> </pre><br><h5>  We exclude function from check </h5><br>  If there is any function that we do not want to check, it is easy to hide: <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> unused_func(arg...)</span></span></code> </pre><br><h5>  Memory allocation with error flag </h5><br>  Some functions, allocating memory, may report an error through their arguments.  For example, this code is correct: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">f</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> is_ok; <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *a = my_alloc(&amp;is_ok); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(is_ok) <span class="hljs-built_in"><span class="hljs-built_in">free</span></span>(a); }</code> </pre><br>  However, if the cppcheck my_alloc is listed as a memory allocation function, the result of the check will be an error.  To avoid it, you can use the following trick: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">char</span></span></span><span class="hljs-function"> *</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">my_alloc</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *ok)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *a = <span class="hljs-built_in"><span class="hljs-built_in">malloc</span></span>(<span class="hljs-number"><span class="hljs-number">42</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(a) *ok = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> *ok = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> a; }</code> </pre><br><h4>  Analysis taking into account the features of libraries </h4><br>  Most applications use any libraries, in particular, glibc.  The analyzer sometimes needs some information about library functions.  For example, malloc allocates memory, and free allocates.  If there is a malloc, but no free, it often means a memory leak.  These functions are included in glibc and are part of the standard, so the analyzer (and the compiler) is simply obliged to know about them. <br><br>  As for the rest, ideally, for each library used, the analyzer should have some description of its features in order to be able to detect errors made not only when using glibc. <br><br>  Why is this so important?  If an unknown function is encountered, cppcheck assumes that it is located somewhere in a third-party library and makes the most favorable predictions about it (it frees up memory, does not interrupt the execution of the program, etc.).<font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> If a memory leak or uninitialized variable pattern was found somewhere, but there is an unknown function inside, cppcheck blocks the error message. </font></font><br><br>  Consider a simple example.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">On Linux, many graphics applications use the GLib library. </font><font style="vertical-align: inherit;">This library practically duplicates glibc, including it has its own malloc / free implementations. </font><font style="vertical-align: inherit;">Typically, code using GLib looks like this:</font></font><br><br><pre> <code class="cpp hljs">gchar *s = g_strdup(<span class="hljs-string"><span class="hljs-string">"test"</span></span>); gint *a = g_malloc(<span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>) * <span class="hljs-number"><span class="hljs-number">10</span></span>);</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The fact that after </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">g_strdup</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">g_malloc the</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> memory needs to be freed, the person will guess intuitively, even without having previously had experience with GLib. What can not be said about the analyzer: the implementation of the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">g_malloc</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> function </font><i><font style="vertical-align: inherit;">is</font></i><font style="vertical-align: inherit;"> hidden inside the library's binary code ‚Äî who knows what it does there? </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">There is one solution to this situation: keep a database of the most popular libraries and gradually replenish it, fixing the features of the functions of each library. Using the database, the analyzer can easily check any code using the library to find errors in it in the future.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The best part about cppcheck is that it has such an updated database. This means that the community can improve cppcheck by simply adding all the new information about standard libraries, which cppcheck will then use in the analysis. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cppcheck does not automatically load the necessary libraries, it must be done manually. Libraries are specified with the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">--library</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> parameter </font><font style="vertical-align: inherit;">, you can specify multiple libraries, separated by commas. cppcheck first searches for a file named </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">library.cfg</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> in the current directory (it‚Äôs convenient to store the library for your project this way), then tries to find it in its library database. If there is no library anywhere, cppcheck will generate an error. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">An example of project analysis using the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">gtk</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> library </font><font style="vertical-align: inherit;">:</font></font><br><br><pre> <code class="bash hljs">cppcheck -q --library=gtk ./<span class="hljs-built_in"><span class="hljs-built_in">source</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> You can clearly indicate in which file the library is located (I must say, without looking at the source code, I would not have guessed that this can be done): </font></font><br><br><pre> <code class="bash hljs">cppcheck -q --library=my/path/mylib.xml ./<span class="hljs-built_in"><span class="hljs-built_in">source</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Today cppcheck supports quite a few libraries: </font></font><br><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> gtk (in fact, glib, gtk is not supported there) </font></font></li><li>  Qt </li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> windows (all sorts of scanf_s ...) </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> posix </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> glibc (standard library ceases to be hard-coded and is gradually being forced into the base) </font></font></li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The list is clearly not rich. </font><font style="vertical-align: inherit;">Moreover, from the contents of this database, I want to put out a mean tear, for example, the POSIX base:</font></font><br><br><pre> <code class="xml hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?xml version="1.0"?&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">def</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">function</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"usleep"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">noreturn</span></span></span><span class="hljs-tag">&gt;</span></span>false<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">noreturn</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">arg</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">nr</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"1"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">not-bool</span></span></span><span class="hljs-tag">/&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">valid</span></span></span><span class="hljs-tag">&gt;</span></span>0-999999<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">valid</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">arg</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">function</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">function</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"_exit"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">noreturn</span></span></span><span class="hljs-tag">&gt;</span></span>true<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">noreturn</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">function</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">def</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Only one thing can be learned from this file: cppcheck uses XML to expand its database. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">What cppcheck currently knows how to "get" from the library database:</font></font><br><br><ul><li>        ,         / ‚Äî      ; </li><li> ,   ( exit); </li><li> ,          (,  strlen               ); </li><li>    ,       ; </li><li>  -      (  printf); </li></ul><br><h5>    (  ) </h5><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The base is generated as an XML file that is placed in the cfg directory of the cppcheck project. </font><font style="vertical-align: inherit;">That is why I recommended downloading the program source code at the beginning of the article. </font><font style="vertical-align: inherit;">The cfg files are nailed to the cfg subdirectory next to the executable file and this has not yet been fixed. </font><font style="vertical-align: inherit;">There are </font><font style="vertical-align: inherit;">already several libraries </font><font style="vertical-align: inherit;">inside the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cfg</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> directory </font><font style="vertical-align: inherit;">that can be used as examples to create your own library - there are not very many documentation on this topic. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Each file starts with a header:</font></font><br><br><pre> <code class="xml hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?xml version="1.0"?&gt;</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The entire database is wrapped in a </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">def</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> tag </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">There are </font><font style="vertical-align: inherit;">three </font><font style="vertical-align: inherit;">different tags inside </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">def</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br><br><ul><li> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">memory</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - information about the functions working with memory;</font></font></li><li> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">resource</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - similar, but for resources (open / closed), a typical representative is </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">open</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> / </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">close</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ;</font></font></li><li> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">function</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is just a function.</font></font></li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">As for </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">memory</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">resource</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , their internal structure is the same:</font></font><br><br><ul><li> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">alloc</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - the </font><i><font style="vertical-align: inherit;">allocator</font></i><font style="vertical-align: inherit;"> is placed inside the tag, you can add the attribute of the tag </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">init = ‚Äútrue | false‚Äù</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - indicates whether the allocator initializes the memory;</font></font></li><li> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dealloc</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - the corresponding memory freeing function for all memory allocation functions in a block is placed inside the tag (it is possible to combine several </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">alloc</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> / </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dealloc</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> in one block);</font></font></li><li> <i>use</i> ‚Äî ,    ,   (,            ).   ,       . </li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Each </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">memory</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">resource</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> block </font><font style="vertical-align: inherit;">must be duplicated for different groups of functions. </font><font style="vertical-align: inherit;">For example, if the memory allocated by the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">malloc</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> function </font><font style="vertical-align: inherit;">needs to be freed with the help of </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">free</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , and </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">g_malloc</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> with the help of </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">g_free</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , they need to be placed in pairs in different </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">memory</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> tags </font><font style="vertical-align: inherit;">. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Function ( </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">function</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) - has the greatest number of possibilities. </font><font style="vertical-align: inherit;">The name of the function is specified as the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">name</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> attribute of the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">function</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> tag </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Inside the tag you can use:</font></font><br><br><ul><li> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">noreturn</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - if </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">true</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , this function does not interrupt execution;</font></font></li><li> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A leak-ignore</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is a non-standard tag, meaning that this function definitely does not free pointers and can be ignored when checking for memory leaks;</font></font></li><li> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">arg</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - checking the argument, the argument number is specified by the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nr</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> attribute </font><font style="vertical-align: inherit;">(described in detail in the documentation).</font></font></li></ul><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Note</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">The </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">noreturn</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> tag </font><font style="vertical-align: inherit;">for a function should be set only when it unconditionally interrupts execution. </font><font style="vertical-align: inherit;">It may seem that this tag describes non-void functions, but it is not. </font><font style="vertical-align: inherit;">An example of such a function is </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">exit</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Because of this particularity, there were great oddities when compiling rules for the GLib library.</font></font><br><br><h5><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Describe the GLib library </font></font></h5><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GLib is a C library that underlies GTK + and implements object-oriented programming in C (and more recently, introspection has appeared). </font><font style="vertical-align: inherit;">A lot of projects are built on it: GIMP, GNOME, Xfce, even Chromium / Firefox use it to some extent. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GLib is cross-platform, so even functions such as </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">malloc</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> / </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">free</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> or </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">printf are</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> duplicated inside GLib so as not to depend on the specific implementation or version of glibc supported platforms. </font><font style="vertical-align: inherit;">As a result, GLib has dozens of functions working with memory, its own error handler, in general, everything that cppcheck does not suspect.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In cppcheck, only relatively recently appeared the beginnings of support for the GLib library. </font><font style="vertical-align: inherit;">For example, such obvious memory leaks cppcheck can catch:</font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">f</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ g_malloc(<span class="hljs-number"><span class="hljs-number">42</span></span>); }</code> </pre><br><pre> <code class="bash hljs">cppcheck -q test.c --library=gtk [test.c:3]: (error) Return value of allocation <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> g_malloc is not used.</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> However, in GLib hundreds of functions, and such an intricacies cppcheck will not take: </font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">f</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ gchar *a = g_strdup(s); g_strdown(a); }</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This is because the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">g_strdown</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> function </font><i><font style="vertical-align: inherit;">is</font></i><font style="vertical-align: inherit;"> unknown. </font><font style="vertical-align: inherit;">Suddenly she frees the memory herself? </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The GLib library can be conditionally divided into its component parts:</font></font><br><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">general purpose allocator functions, all of which are freed by a single </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">g_free</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> function </font><font style="vertical-align: inherit;">;</font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> constructors and destructors of objects; </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Functions that "absorb" pointers (hash tables, lists) - for such you do not need to report about memory leaks - there will be a lot of false positives; </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">only one function that interrupts execution is </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">g_exit</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ;</font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">all other functions that can be ignored. </font><font style="vertical-align: inherit;">This list is the most important, because it tells cppcheck not to hide the error due to a function that does nothing with pointers.</font></font></li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Let's start forming the list of rules. In GLib and GTK + more than four thousand functions, it is logical that it is almost impossible to assemble them manually. Fortunately, introspection has appeared in newer versions of GLib, which will allow you to effortlessly pull out all the methods from the XML file. Unfortunately, the GLib developers did not think that someone would be interested to know whether it was necessary to free up memory after a particular function, therefore, we had to manually search for constructors and destructors while reading the documentation. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fortunately, all this work (for the GLib / GTK + family) will not have to be done, since it has already been completed and the result is in </font></font><a href="https://github.com/scriptum/cppcheck-libs"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">my repository</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Since I'm allergic to XML, I made a simplified version of the format for describing functions, which are then glued together in a giant XML file with a small parser written in python. To get an XML file, simply type make. There are two </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">source codes</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : </font><i><font style="vertical-align: inherit;">gtk.rules</font></i><font style="vertical-align: inherit;"> , which manually lists functions that cannot be parsed automatically, and </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">gtk-functions.rules</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ‚Äî an automatically generated file based on the GLib / GTK + XML interfaces. The parser is written so that the functions do not repeat. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">At the moment, the library is more or less stable, you can </font></font><a href=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pick</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> it </font><a href=""><font style="vertical-align: inherit;">up from here</font></a><font style="vertical-align: inherit;"> and put it in the </font><i><font style="vertical-align: inherit;">cppcheck / cfg</font></i><font style="vertical-align: inherit;"> directory</font></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">by replacing the old one. </font><font style="vertical-align: inherit;">After that, you can analyze any projects written in GLib / GTK +. </font><font style="vertical-align: inherit;">After testing and eliminating false positives, I will try to push Pull Request in cppcheck with this base, so there is a chance to see it in the next releases. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Additionally, I made a </font></font><a href=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">header file</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> that lists popular </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">g_return_ *</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> macros </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">With it, cppcheck will not miss the memory errors caused by the insertion of these macros. </font><font style="vertical-align: inherit;">This file must be attached using the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">--include</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> parameter </font><font style="vertical-align: inherit;">.</font></font><br><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Source Code Analysis Thunar </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A small example of how library usage affects analysis. </font></font><a href="http://archive.xfce.org/src/xfce/thunar/1.6/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Thunar version 1.6.3</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> will be the test subject today </font><font style="vertical-align: inherit;">, there will be no in-depth analysis (it will not be required for the demonstration), just a scan with standard settings. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">First, the analysis of "clean" cppcheck:</font></font><br><br><pre> <code class="bash hljs">cppcheck -q -j4 --max-configs=1 ./Thunar-1.6.3 [Thunar-1.6.3/thunar/thunar-chooser-dialog.c:450]: (error) Uninitialized variable: app_info</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pretty small catch. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We connect the library:</font></font><br><br><pre> <code class="bash hljs">cppcheck -q -j4 --max-configs=1 --library=gtk --include=gtk.h ./Thunar-1.6.3</code> </pre><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Command output</font></font></b> <div class="spoiler_text"><pre> <code class="bash hljs">[Thunar-1.6.3/plugins/thunar-sendto-email/main.c:410]: (error) Memory leak: tmpdir [Thunar-1.6.3/plugins/thunar-uca/thunar-uca-provider.c:166]: (error) Memory leak: dialog [Thunar-1.6.3/plugins/thunar-uca/thunar-uca-editor.c:150]: (error) Memory leak: label [Thunar-1.6.3/plugins/thunar-uca/thunar-uca-editor.c:168]: (error) Memory leak: label [Thunar-1.6.3/plugins/thunar-uca/thunar-uca-editor.c:211]: (error) Memory leak: label [Thunar-1.6.3/plugins/thunar-uca/thunar-uca-editor.c:251]: (error) Memory leak: label [Thunar-1.6.3/plugins/thunar-uca/thunar-uca-editor.c:391]: (error) Memory leak: align [Thunar-1.6.3/plugins/thunar-uca/thunar-uca-editor.c:395]: (error) Memory leak: label [Thunar-1.6.3/plugins/thunar-uca/thunar-uca-editor.c:399]: (error) Memory leak: align [Thunar-1.6.3/plugins/thunar-uca/thunar-uca-editor.c:433]: (error) Memory leak: align [Thunar-1.6.3/plugins/thunar-uca/thunar-uca-editor.c:446]: (error) Memory leak: label [Thunar-1.6.3/plugins/thunar-uca/thunar-uca-editor.c:458]: (error) Memory leak: align [Thunar-1.6.3/plugins/thunar-wallpaper/twp-provider.c:301]: (error) Memory leak: escaped_file_name [Thunar-1.6.3/plugins/thunar-uca/thunar-uca-model.c:1520]: (error) Memory leak: command_line [Thunar-1.6.3/plugins/thunar-uca/thunar-uca-model.c:1521]: (error) Memory leak: command_line [Thunar-1.6.3/plugins/thunar-uca/thunar-uca-model.c:1522]: (error) Memory leak: command_line [Thunar-1.6.3/thunar/thunar-column-editor.c:576]: (error) Memory leak: dialog [Thunar-1.6.3/thunar/thunar-chooser-dialog.c:450]: (error) Uninitialized variable: app_info [Thunar-1.6.3/thunar/thunar-device-monitor.c:829]: (error) Mismatching allocation and deallocation: devices [Thunar-1.6.3/thunar/thunar-folder.c:686]: (error) Mismatching allocation and deallocation: attrs [Thunar-1.6.3/thunar/thunar-file.c:1568]: (error) Mismatching allocation and deallocation: argv [Thunar-1.6.3/thunar/thunar-list-model.c:1084]: (error) Memory leak: old_order [Thunar-1.6.3/thunar/thunar-properties-dialog.c:446]: (error) Memory leak: spacer [Thunar-1.6.3/thunar/thunar-properties-dialog.c:534]: (error) Memory leak: spacer [Thunar-1.6.3/thunar/thunar-shortcuts-model.c:2210]: (error) Mismatching allocation and deallocation: bookmarks [Thunar-1.6.3/thunar/thunar-standard-view.c:1911]: (error) Returning/dereferencing <span class="hljs-string"><span class="hljs-string">'file'</span></span> after it is deallocated / released [Thunar-1.6.3/thunar/thunar-window.c:2028]: (error) Memory leak: checksum [Thunar-1.6.3/thunar/thunar-window.c:2028]: (error) Memory leak: tooltip</code> </pre><br></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">27 new bugs - something already! </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Is it really a bug or a bunch of false positives? </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A memory leak in the event of an error check is the most common type of memory leak:</font></font><br><br><pre> <code class="cpp hljs"> tmpdir = g_strdup (<span class="hljs-string"><span class="hljs-string">"/tmp/thunar-sendto-email.XXXXXX"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (G_UNLIKELY (mkdtemp (tmpdir) == <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>)) { error = g_error_new_literal (G_FILE_ERROR, g_file_error_from_errno (errno), g_strerror (errno)); tse_error (error, _(<span class="hljs-string"><span class="hljs-string">"Failed to create temporary directory"</span></span>)); g_error_free (error); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> FALSE; } <span class="hljs-comment"><span class="hljs-comment">/* -   */</span></span> g_free(tmpdir);</code> </pre><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Similar examples</font></font></b> <div class="spoiler_text"><pre> <code class="cpp hljs"> escaped_file_name = g_shell_quote (file_name); <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (desktop_type) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> DESKTOP_TYPE_XFCE: ... <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> DESKTOP_TYPE_NAUTILUS: ... <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; <span class="hljs-comment"><span class="hljs-comment">/* , ?    break??? */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } g_free (escaped_file_name);</code> </pre><br><pre> <code class="cpp hljs"> GString *command_line = g_string_new (<span class="hljs-literal"><span class="hljs-literal">NULL</span></span>); GList *lp; gchar *dirname; gchar *quoted; gchar *path; gchar *uri; g_return_val_if_fail (THUNAR_UCA_IS_MODEL (uca_model), FALSE); g_return_val_if_fail (iter-&gt;stamp == uca_model-&gt;stamp, FALSE); g_return_val_if_fail (error == <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> || *error == <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, FALSE);</code> </pre><br></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Constructor / destructor mismatch. </font><font style="vertical-align: inherit;">In fact, this is a memory leak, since the internal structure of the array is not released. </font><font style="vertical-align: inherit;">The code below will work fine without errors, but will flow in the </font></font><a href="https://developer.gnome.org/gio/stable/GFileInfo.html"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">elements of the array</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br><br><pre> <code class="cpp hljs"> gchar **attrs; ... attrs = g_file_info_list_attributes (info1, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>); ... g_free (attrs);</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Pointer returns after release: </font></font><br><br><pre> <code class="cpp hljs"> GtkTreePath *path = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; GtkTreeIter iter; ThunarFile *file = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; path = (*THUNAR_STANDARD_VIEW_GET_CLASS (standard_view)-&gt;get_path_at_pos) (standard_view, x, y); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (G_LIKELY (path != <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>)) { gtk_tree_model_get_iter (GTK_TREE_MODEL (standard_view-&gt;model), &amp;iter, path); file = thunar_list_model_get_file (standard_view-&gt;model, &amp;iter); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!thunar_file_is_directory (file) &amp;&amp; !thunar_file_is_executable (file)) { g_object_unref (G_OBJECT (file)); <span class="hljs-comment"><span class="hljs-comment">/*     ! */</span></span> gtk_tree_path_free (path); path = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> file;</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This is a controversial warning, since </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">g_object_unref</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> counts the links and whether the object will be deleted is unknown, but you should take a look at the error. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">False alarms. </font><font style="vertical-align: inherit;">There were such - some gtk functions allow you to alienate an object that will be destroyed automatically with the parent, if they are not excluded - cppcheck will swear.</font></font><br><br><div class="spoiler">  <b class="spoiler_title">Examples</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">manage_actions</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(GtkWindow *window)</span></span></span><span class="hljs-function"> </span></span>{ GtkWidget *dialog; dialog = g_object_new (THUNAR_UCA_TYPE_CHOOSER, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>); gtk_window_set_transient_for (GTK_WINDOW (dialog), window); gtk_widget_show (dialog); }</code> </pre><br><pre> <code class="cpp hljs"> label = g_object_new (GTK_TYPE_LABEL, <span class="hljs-string"><span class="hljs-string">"label"</span></span>, _(<span class="hljs-string"><span class="hljs-string">"Appears if selection contains:"</span></span>), <span class="hljs-string"><span class="hljs-string">"xalign"</span></span>, <span class="hljs-number"><span class="hljs-number">0.0f</span></span>, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>); gtk_table_attach (GTK_TABLE (table), label, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>, GTK_EXPAND | GTK_FILL, GTK_FILL, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>);</code> </pre><br>     ,    ,   g_object   : <br><br><pre> <code class="cpp hljs"> dialog = g_object_new (THUNAR_TYPE_COLUMN_EDITOR, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>); ... gtk_widget_destroy (dialog);</code> </pre><br>      ,   g_new      : <br><br><pre> <code class="cpp hljs"> devices = g_new0 (gchar *, length + <span class="hljs-number"><span class="hljs-number">2</span></span>); ... g_strfreev (devices);</code> </pre><br>  cppcheck   .   cppcheck: <br><br><pre> <code class="cpp hljs"> <span class="hljs-comment"><span class="hljs-comment">/* be sure to not overuse the stack */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (G_LIKELY (length &lt; <span class="hljs-number"><span class="hljs-number">2000</span></span>)) { old_order = g_newa (GSequenceIter *, length); new_order = g_newa (gint, length); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { old_order = g_new (GSequenceIter *, length); new_order = g_new (gint, length); } ... <span class="hljs-comment"><span class="hljs-comment">/* clean up if we used the heap */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (G_UNLIKELY (length &gt;= <span class="hljs-number"><span class="hljs-number">2000</span></span>)) { g_free (old_order); g_free (new_order); }</code> </pre><br></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">But the beauty of these false positives is that they are easy to fix by patching the XML file with the library. </font><font style="vertical-align: inherit;">Thus, it was possible to reduce the number of errors to 14. Over time, introspection in GLib will be improved and it will be possible to automatically gather information about the library.</font></font><br><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> We write rules for cppcheck </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Finally - the most delicious. Here we will talk about how to implement your own checks for cppcheck. Surely, you have already found some kind of bug and would like to check the entire project for similar errors. Another situation is that you are a team leader and programmers on your team regularly model typical mistakes that you would like to stop in automatic mode. Keeping your own code in check is useful to develop efficient and secure programs. Found a mistake - we wrote to it not only the regression test, but also the rule of the analyzer.</font></font><br><br><h5>  What is under the hood? </h5><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">First, a few words about how cppcheck works. </font><font style="vertical-align: inherit;">Before directly analyzing, cppcheck runs the preprocessor, similarly to the compiler, followed by a step to simplify the source code. </font><font style="vertical-align: inherit;">That is: all unnecessary indents and spaces are removed, each lexical construction of the language is separated by exactly one space. </font><font style="vertical-align: inherit;">All constants that can be simplified during preprocessing are calculated. </font><font style="vertical-align: inherit;">Everywhere {} blocks are placed, even if they are omitted. </font><font style="vertical-align: inherit;">If there is a declaration or assignment of a variable inside an if / for / while block, it will be rendered outside this block. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Since the coding style is different for everyone, cppcheck aims to make the code be reduced to a kind of ‚Äúnormal form‚Äù. </font><font style="vertical-align: inherit;">For example, one programmer writes a loop like this:</font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">10</span></span>; i++) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(i % <span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">printf</span></span>(<span class="hljs-string"><span class="hljs-string">"%d\n"</span></span>, i);</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> And another - so: </font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">10</span></span>; i++) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(i % <span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">printf</span></span>(<span class="hljs-string"><span class="hljs-string">"%d\n"</span></span>, i); }</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Cppcheck will bring this all to mind: </font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i ; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> ( i = <span class="hljs-number"><span class="hljs-number">0</span></span> ; i &lt; <span class="hljs-number"><span class="hljs-number">10</span></span> ; i ++ ) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( i % <span class="hljs-number"><span class="hljs-number">2</span></span> ) { <span class="hljs-built_in"><span class="hljs-built_in">printf</span></span> ( <span class="hljs-string"><span class="hljs-string">"%d\n"</span></span> , i ) ; } }</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Not very readable, but easy to analyze. All lexical structures are neatly separated by spaces and have nothing superfluous. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cppcheck uses several levels of simplification: simple, normal, and original. For example, at the ‚Äúsimple‚Äù level, the sizeof operator is expanded as a number, while at the ordinary level it remains an operator. This is sometimes useful for finding errors related to a particular operator. The initial level is the code in its original form, on which the preprocessor has not yet worked and it is only brought to normal form.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Thus, cppcheck builds a model based on the source code (Tokenizer class), where all the tokens are simply separated by a space, allowing the analyzing modules to easily use these tokens. </font><font style="vertical-align: inherit;">The analyzing module can, in turn, build its own model, if it needs it, navigate to tokens, determine the type of token, etc. At the moment there is a basic model (token splitting, it is used almost everywhere), ValueFlow - to check for leaks memory and experimental AST module (syntax tree). </font><font style="vertical-align: inherit;">Policy makers can use any of these models. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In order not to wrestle with how cppcheck optimizes certain constructions, you can use the debug mode, in which cppcheck will display a simplified version of the code:</font></font><br><br><pre> <code class="bash hljs">cppcheck --debug ./file.cpp</code> </pre><br><h5><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Regular Expression Based Rules </font></font></h5><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cppcheck allows you to expand your capabilities with regular expressions. The scheme of work is as follows: the source code is simplified, it is glued together in one line, after which a regular expression is applied to the resulting line. If a match is found, cppcheck will issue this warning and report a line of code that triggered the rule. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Before using this feature, you need to recompile cppcheck (which is why I recommend downloading the source version of the git), including experimental support for regular expressions. This will require the pcre library. Compiling everything is just as easy:</font></font><br><br><pre> <code class="bash hljs">make HAVE_RULES=yes</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Now cppcheck will have two new parameters: </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">--rule</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - you can set a regular expression directly on the command line and </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">--rule-file</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - XML-base with your own validation rules. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Visually get acquainted with the new opportunity as follows. </font><font style="vertical-align: inherit;">Test case:</font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">f</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(a) <span class="hljs-built_in"><span class="hljs-built_in">free</span></span>(a); }</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Next check. </font><font style="vertical-align: inherit;">Create a regular expression, which presses under it all:</font></font><br><br><pre> <code class="bash hljs">cppcheck -q --rule=<span class="hljs-string"><span class="hljs-string">".*"</span></span> test.c [test.c:1]: (style) found <span class="hljs-string"><span class="hljs-string">' void f ( ) { if ( a ) { free ( a ) ; } }'</span></span></code> </pre><br>  Fine!<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Now it is clear what kind is "simplified". </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Now we‚Äôll write a rule that allows you to search for unnecessary checks on a variable before freeing:</font></font><br><br><pre> <code class="bash hljs">cppcheck -q --rule=<span class="hljs-string"><span class="hljs-string">'if \( (\w+) \) { free \( \1'</span></span> test.c [test.c:2]: (style) found <span class="hljs-string"><span class="hljs-string">'if ( a ) { free ( a'</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The pattern works. </font><font style="vertical-align: inherit;">It remains to write it to the database. </font><font style="vertical-align: inherit;">Create a </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">rules.xml</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> file </font><font style="vertical-align: inherit;">, finalizing the regular expression:</font></font><br><br><pre> <code class="xml hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?xml version="1.0"?&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">rule</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">pattern</span></span></span><span class="hljs-tag">&gt;</span></span>if \( (\b\w+\b) \) { (?:g_)?free \( \b\1\b \) ; }<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">pattern</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">message</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">severity</span></span></span><span class="hljs-tag">&gt;</span></span>style<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">severity</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">summary</span></span></span><span class="hljs-tag">&gt;</span></span>Redundant condition. It is valid to free a NULL pointer.<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">summary</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">message</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">rule</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Now you can check some source code using this file as a rule base: </font></font><br><br><pre> <code class="bash hljs">cppcheck -q --rule-file=rules.xml test.c [test.c:2]: (style) Redundant condition. It is valid to free a NULL pointer.</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The format of the XML file is quite obvious. </font><font style="vertical-align: inherit;">Sometimes you may need another version of the simplified code, for example, raw - source code without simplifications. </font><font style="vertical-align: inherit;">Then it‚Äôs enough to add a tag to the rule:</font></font><br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">tokenlist</span></span></span><span class="hljs-tag">&gt;</span></span>raw<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">tokenlist</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Inside the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tokenlist</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> tag </font><i><font style="vertical-align: inherit;">you</font></i><font style="vertical-align: inherit;"> can use:</font></font><br><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> raw - code with minimal simplification </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> normal - the default mode </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> simple - the most simplified code </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> define - to check the preprocessor directives, cppcheck does not exclude macros from the source </font></font></li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If you delete the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">summary</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> tag </font><font style="vertical-align: inherit;">, you can see which line falls under a regular expression ‚Äî such a debugging mode. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Some examples of rules:</font></font><br><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Function without arguments, but without void</font></font></b> <div class="spoiler_text">           void: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">f</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{} <span class="hljs-comment"><span class="hljs-comment">/*  */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">f</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{} <span class="hljs-comment"><span class="hljs-comment">/*  */</span></span></code> </pre><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">rule</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">tokenlist</span></span></span><span class="hljs-tag">&gt;</span></span>raw<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">tokenlist</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">pattern</span></span></span><span class="hljs-tag">&gt;</span></span>\( \) {<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">pattern</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">message</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">severity</span></span></span><span class="hljs-tag">&gt;</span></span>style<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">severity</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">summary</span></span></span><span class="hljs-tag">&gt;</span></span>Always specify void even if a function accepts no arguments<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">summary</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">message</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">rule</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br></div></div><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We catch increment / decrement inside sizeof</font></font></b> <div class="spoiler_text"><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">rule</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">tokenlist</span></span></span><span class="hljs-tag">&gt;</span></span>raw<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">tokenlist</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">pattern</span></span></span><span class="hljs-tag">&gt;</span></span>sizeof \( [^)]*(?:\w+ [+-]{2}|[+-]{2} \w+)[^)]* \)<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">pattern</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">message</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">severity</span></span></span><span class="hljs-tag">&gt;</span></span>warning<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">severity</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">summary</span></span></span><span class="hljs-tag">&gt;</span></span>Operands to the sizeof operator should not contain side effects<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">summary</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">message</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">rule</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br></div></div><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Do not use constants inside mktemp</font></font></b> <div class="spoiler_text"><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">rule</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">pattern</span></span></span><span class="hljs-tag">&gt;</span></span>mktemp \( "[^"]+" \)<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">pattern</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">message</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">severity</span></span></span><span class="hljs-tag">&gt;</span></span>error<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">severity</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">summary</span></span></span><span class="hljs-tag">&gt;</span></span>The mktemp() function modifies its string argument<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">summary</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">message</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">rule</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br></div></div><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In principle, it avoids the gets function.</font></font></b> <div class="spoiler_text"><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">rule</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">pattern</span></span></span><span class="hljs-tag">&gt;</span></span> gets \( \w+ \)<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">pattern</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">message</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">severity</span></span></span><span class="hljs-tag">&gt;</span></span>error<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">severity</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">summary</span></span></span><span class="hljs-tag">&gt;</span></span>The gets() function is obsolescent, and is deprecated<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">summary</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">message</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">rule</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">As you know, I'm allergic to XML, so I created a </font></font><a href="https://github.com/scriptum/cppcheck-rules"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">repository</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> with a slightly simplified base format and compiler on Python. </font></font><a href=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The XML database</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> compiled by me contains the </font></font><a href="https://www.securecoding.cert.org/confluence/display/seccode/CERT%2BCoding%2BStandards"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">basic recommendations of CERT</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> good-tune C programming (not C ++!) And is slowly growing. As they say, contibutions are welcome. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Of course, the rules on regular expressions are not perfect at all: fewer possibilities, it is impossible to distinguish a variable from a function or operator. But they are useful when written for a specific project with their own features and a database of errors. The rules can be used in conjunction with regression tests after detecting a bug manually, is it not enough, somewhere else in the code there is the same bug or it will appear in the future.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If you want to know more, there is some good documentation on the topic of creating rules for cppcheck: </font></font><a href="http://sourceforge.net/projects/cppcheck/files/Articles/writing-rules-1.pdf/download"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">one</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><a href="http://sourceforge.net/projects/cppcheck/files/Articles/writing-rules-2.pdf/download"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">two</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><a href="http://sourceforge.net/projects/cppcheck/files/Articles/writing-rules-3.pdf/download"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">three</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (the third part is devoted to developing rules in C ++). </font><font style="vertical-align: inherit;">You can greatly help the project by sending patches to developers, reports of false positives, bugs, and feel free to do PR (no, not one, but Pull Request :).</font></font></div><p>Source: <a href="https://habr.com/ru/post/210256/">https://habr.com/ru/post/210256/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../210238/index.html">Four methods for downloading images from a website using Python</a></li>
<li><a href="../210240/index.html">How statistics help make Yandex.Probki better</a></li>
<li><a href="../210248/index.html">Neurosystem: a revolution of consciousness</a></li>
<li><a href="../210252/index.html">What does a robot need to build a card?</a></li>
<li><a href="../210254/index.html">The lessons of space catastrophes</a></li>
<li><a href="../210258/index.html">Opportunity has been on Mars for 10 years.</a></li>
<li><a href="../210262/index.html">What should look like a manual for a female phone</a></li>
<li><a href="../210264/index.html">CMS development practice</a></li>
<li><a href="../210266/index.html">COOLRF: Pricing and Investments</a></li>
<li><a href="../210268/index.html">KolibriOS Digest # 1: getting up to date</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>