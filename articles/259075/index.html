<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Creating AUX input for Kenwood GX806EF2 radio with i2c bus grab</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The hero of the note, the Kenwood GX806EF2 radio cassette player, is famous for being installed in a very large number of export Japanese cars (take a...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Creating AUX input for Kenwood GX806EF2 radio with i2c bus grab</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/d05/d54/36c/d05d5436c08c43778543a69757002ef7.jpg" alt="image"><br><br>  The hero of the note, the Kenwood GX806EF2 radio cassette player, is famous for being installed in a very large number of export Japanese cars (take at least the Subaru Forester) and has no AUX input for connecting external sound sources, nor the ability to play MP3 files from CDs (with external drives too).  The tape recorder came out quite utilitarian for its time (2004-2007), despite the CD changer on 6 CDs.  CD audio, FM / AM tuner, and everything, but the cassette receiver, by the way, no longer exists. <br><br>  But still make it an AUX input without damage to the appearance and functionality. <br><a name="habracut"></a><br>  I got this radio along with the car.  Having mounted an Android 7 tablet in the navigation booth, I began to look for ways to get the sound from the tablet to the radio tape recorder, but I didn‚Äôt want to buy a new ‚Äúhead‚Äù for this. <br>  It turned out that many people disconnect the internal CD changer and connect serially produced emulators with the ability to play MP3 via USB, for <a href="">example</a> , but it seemed to me excessive vandalism with excessive costs. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The transmission of sound from an external device can also be solved with the help of an FM transmitter, but the sound quality with this option is very poor and there is also a link with an extra cost to the FM transmitter and its placement in the cabin. <br><br>  In some places I found mentioning about cutting the AM tuner line from the radio tape recorder and using its remainder for external sound, but this is not feasible with this particular radio tape recorder, in any modes of the tuner the signals go in the same line.  It was decided to analyze the entire scheme of the radio tape recorder for "vulnerable" places. <br><br>  You can see the glued scheme of the main board <a href="https://drive.google.com/file/d/0B3mSRUbAfsthSm9BVVNXeU52WHM/view%3Fusp%3Dsharing">here</a> .  Here is the interesting part of the scheme: <br><br><img src="https://habrastorage.org/files/d88/396/a76/d88396a76dcd474297420161693846ff.jpg" alt="image"><br><br>  The sought-for is located next to the TDA7406 audio processor (IC203 in the diagram) from STMicroelectronics.  In red, I circled the i2c bus, which connects the main controller with the IC203 chip, the blue one ‚Äî the unused audio inputs MD and TAPE.  As it turns out from the <a href="http://www.st.com/web/en/resource/technical/document/datasheet/CD00134024.pdf">datasheet</a> on this chip, it has 4 separate stereo audio inputs and 4 separate mono audio inputs.  However, they are not used all, and unused ‚Äúplugged‚Äù capacitors on the ground (C233-C236 example). <br><br>  Having studied the principle of operation of the TDA7406, I realized that you can try to hook into the control of the main controller and use unused audio inputs when necessary.  I soldered the wires SDA and SCL (resistors R855, R857) and connected a logic analyzer to them: <br><br><img src="https://habrastorage.org/files/a8f/3b2/875/a8f3b2875a894061a8158f73f6994913.jpg" alt="image"><br><br>  It turned out that during normal operation the controller requests the TDA7406 status on the i2c bus every half second.  There is nothing interesting in this request for us - there are TDA7406 status flags.  There are no control commands at rest: <br><br><img src="https://habrastorage.org/files/c9a/417/e39/c9a417e39ebe4385bcd276c968c02637.png" alt="image"><br><img src="https://habrastorage.org/files/81d/80e/c79/81d80ec79f5d43a48eea8933b617ae65.png" alt="image"><br><br>  The most interesting thing on the bus occurs at the time of switching modes CD / BAND and when the volume changes.  In such cases, the controller gives a long burst for the TDA7406 control registers.  This package contains settings for almost all available registers.  Here is an example of a package (its small initial part): <br><br><img src="https://habrastorage.org/files/edf/7cb/368/edf7cb368e714fab94f8c670fa2c934b.png" alt="image"><br><br>  Consider this package: <br>  0x8C (chip address) - the address of the TDA7406 chip with the R / W bit reset (the controller is going to write to the registers). <br>  0x60 (subaddress) is the address of the first register from which the recording of the parcel will begin and some settings of the recording order (in this case, the recording will be made from the zero address, as indeed always when the controller configures the TDA7406: it always records the configuration starting from register 0). <br>  0x0E (register 0) - the configuration for register 0, what we need, judging by the documentation: this is the Input Selector register.  It indicates what input of the audio mixer should now be selected and what gain (volume) this channel should have: <br><br><img src="https://habrastorage.org/files/b4a/1a2/823/b4a1a28232404aab858483826432cddd.png" alt="image"><br><br>  When selecting a tuner channel and further working with it (raising / lowering the volume), the controller sends bits 110 to the Source Selector field of the zero register. This is very good, because in order to use the AUX input, MD must transfer bits 010 to this field. For reference: the i2c bus has braces to the supply voltage and is always free, and the bus active level is zero, i.e.  management is conducted by an open collector (open drain).  At any given time, any i2c bus line can be ‚Äúpulled‚Äù to zero without affecting all devices on this bus. <br><br>  You can hook into the communication between the controller and the audio mixer at the right time and turn the FM mode into MD mode.  The only thing required is to accurately track the right time for the impulse so that the ‚Äú110‚Äù turns into a ‚Äú010‚Äù.  And this should be done every time the controller talks to the TDA7406.  Here is the moment we need in the diagram, at the moment of the SCL line highlighted in red, the SDA line should be set to zero: <br><br><img src="https://habrastorage.org/files/730/a8b/9fb/730a8b9fb9e2445e8c13c28caeb69983.png" alt="image"><br><br>  I drew and made a small handkerchief with an Attiny13 microcontroller, with pin connectors on all pins for ease of programming and further connection to i2c and power: <br><br><img src="https://habrastorage.org/files/dad/69a/247/dad69a2472cb44a58931e9c0f44147c7.jpg" alt="image"><br><br>  I intentionally made the bottom layer of the board flat, without bulging the pins, so that you can glue the board onto the TDA7406 head without any problems. <br><br><img src="https://habrastorage.org/files/3ed/dcd/df0/3eddcddf0ba343398afb0d67283bb7f2.jpg" alt="image"><br><br>  It remains a small matter: solder to the board with ATTiny13 power wires, i2c, wires from the 3.5 mm external connector ("mother") and wiring for the motherboard radio to the MD lines (after removing the C233, C234 capacitors): <br><br><img src="https://habrastorage.org/files/7d3/120/493/7d3120493ccc40948db5c40cecdfdd6f.jpg" alt="image"><br>  <sub>I apologize for the quality of the photo, I was fascinated more by the process of creation, and not by documentation.</sub> <br><br>  The blue wire going up in the photo goes to the News button on the front panel of the radio.  That it is used to enable the interception control audio mixer.  By pressing the button, we activate interception, by another pressing - we deactivate.  Important: after pressing the News button, you will need to decrease or increase the volume, since  alone, as we remember, the audio mixer does not control, and the ATTiny13 microcontroller itself does not send any messages to the bus. <br><br>  The program for the microcontroller was very simple;  Basically this is a solution to the problem "in the forehead," without interruptions.  I will return to the program below. <br><br>  So, for those who decide to use this method to create the AUX input of this radio tape recorder: <br>  1. Disassemble the radio, remembering the types of screws and their place. <br>  2. Get to the main board and find the TDA7406 chip. <br>  3. Make and program a board with ATTiny13 (nominal values ‚Äã‚Äãof capacitors C1-C3 0.1 microfarad): <br><img src="https://habrastorage.org/files/f01/d2e/e85/f01d2ee85a094da8a6e4543fff94ca1c.png" alt="image"><br>  4. Glue the board to the TDA7406 chip. <br>  5. Vypayat from the main board C233, C234.  Solder the wiring from the main board to the ATTiny13 board according to the scheme: <br><img src="https://habrastorage.org/files/004/a19/f7f/004a19f7fdde48ec84186afb86305ebd.png" alt="image"><br>  Food for ATTiny13 near TDA7406 is not, because  The TDA7406 is powered by 8 V, and we need 5. We pull to XP2: 1 wire from pin 8 of the IC803 memory chip (24C02), body SO-8, see photo above. <br>  The wire from the News button (it has two contacts, we need the one that sits on the power supply, and not on the ground) pull to XP1: 2 (PB3). <br>  6. Solder the AUX output itself (I have a factory 3.5mm jack "mother" with a wire from the headphone extension) to the board: XP1: 5 left channel, XP2: 5 right channel and common wire on XP1: 4.  We get the wire from the connector in front of it from where it is more convenient. <br>  7. Connect the speakers to the radio, check. <br>  8. The soldering of wires is well checked and we fix the wires to the board with elastic glue of the ‚ÄúMoment‚Äù type. <br><br>  This modification has been working for me for almost a month without any complaints.  The only inconvenience is the two-step switching on and off of AUX.  First, press the button News, and then we move a little volume.  This could have been avoided by adding the program in such a way that ATTiny itself sent the configuration to the audio mixer registers at the moment the button was pressed, but I considered this to be an unnecessary intervention complicating the program.  But with proper experience working with microcontrollers, such a function is not long to attach. <br><br>  A few words about the program.  It does not use interrupts, and the tracking of clock cycles (fronts) on the SCL line is carried out using GIFR flags in cycles.  With each SCL clock cycle, the program evaluates the state of the SDA bus and if it satisfies the sequence 0x8C 0x60 0x0E, then log.0 is set on the SDA line in the right place.  And so in a circle.  When using interrupts, ATTiny13 spends a lot of clocks on entering and processing an interrupt and does not keep up with the clocks;  i2c frequency for him is tall: 160 kHz. <br><br>  PCB P-CAD 2006 PCB format <a href="https://drive.google.com/file/d/0B3mSRUbAfsthaGVycnpaT3pfVEk/view%3Fusp%3Dsharing">here</a> . <br>  ATTiny13 firmware in Intel hex format <a href="https://drive.google.com/file/d/0B3mSRUbAfsthcGdRTGwyTk81TmM/view%3Fusp%3Dsharing">here</a> . <br><br>  <b>UPD: at the request of users add information about "fyyuzy".</b> <br>  From production ATTniy13 comes with a programmed CKDIV8 bit in Fuse Low Byte.  It must be removed by writing bit 1 in its field.  For example, if the ATTiny13 has a value of 0x6A from Fuse Low Byte from the factory, then it should be made equal to 0x7A.  Thus, we make the clock frequency maximum (9.6 MHz);  with another clock frequency, the program will not work properly. </div><p>Source: <a href="https://habr.com/ru/post/259075/">https://habr.com/ru/post/259075/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../259065/index.html">Digest news of the gaming industry</a></li>
<li><a href="../259067/index.html">Simple Web Service with Jetty Embedded</a></li>
<li><a href="../259069/index.html">Memory Optimization DataTable</a></li>
<li><a href="../259071/index.html">New to Wolfram SystemModeler: FMI Import</a></li>
<li><a href="../259073/index.html">Browser history sniffing using favicon</a></li>
<li><a href="../259077/index.html">Encryption of personal correspondence. Friday post</a></li>
<li><a href="../259081/index.html">24 hours PASS - review of the SQL conference reports</a></li>
<li><a href="../259083/index.html">Online development event for Windows 10, June 10, from industry veterans</a></li>
<li><a href="../259085/index.html">John Forbes Nash died</a></li>
<li><a href="../259087/index.html">Basic troubleshooting in VMware vSphere or what to do if VM slows down</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>