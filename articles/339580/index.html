<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Using the event model in Doctrine 2 + Symfony 3</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Let's imagine a situation: you have an order in an online store (Entity). The order has a certain status. When changing the status of the order, it is...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Using the event model in Doctrine 2 + Symfony 3</h1><div class="post__text post__text-html js-mediator-article"><p>  Let's imagine a situation: you have an order in an online store (Entity).  The order has a certain status.  When changing the status of the order, it is necessary to conduct a bunch of related actions, for example: </p><br><ul><li>  save the last modified date in the order </li><li>  write to the history of the order information on the status change </li><li>  send email / sms to client </li><li>  call the API method of the delivery service / payment system / partner, etc. </li></ul><br><p>  The question arises how to organize all this correctly in terms of program code. <br>  Everything described below is true for Doctrine 2 and Symfony&gt; 3.1. </p><a name="habracut"></a><br><p>  If you are not familiar with the Doctrine event model, I first recommend that you familiarize yourself with the <a href="http://docs.doctrine-project.org/projects/doctrine-orm/en/latest/reference/events.html">documentation</a> . </p><br><p>  I will give an example of the simplest code for an Entity order: </p><br><div class="spoiler">  <b class="spoiler_title">Entity Order Code</b> <div class="spoiler_text"><pre><code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">/** * Order * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@ORM</span></span></span><span class="hljs-comment">\Table(name="order") */</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Order</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@ORM</span></span></span><span class="hljs-comment">\Column(name="id", type="integer") * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@ORM</span></span></span><span class="hljs-comment">\Id * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@ORM</span></span></span><span class="hljs-comment">\GeneratedValue(strategy="AUTO") */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $id; <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@ORM</span></span></span><span class="hljs-comment">\Column(name="fio", type="string", length=100) */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $fio; <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@ORM</span></span></span><span class="hljs-comment">\Column(name="last_update_date", type="datetime") */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $lastUpdateDate; <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@ORM</span></span></span><span class="hljs-comment">\Column(name="create_date", type="datetime") */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $createDate; <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@ORM</span></span></span><span class="hljs-comment">\Column(name="status_id", type="integer") */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $statusId; <span class="hljs-comment"><span class="hljs-comment">//  getter/setter  }</span></span></code> </pre> </div></div><br><p>  Let's start with the simplest - we need to have the creation date recorded in the <code>create_date</code> field, and when any order changes, the last modified date in the <code>last_update_date</code> field. </p><br><p>  The simplest thing is to explicitly add parameters in the place where the order is created and updated (in the controller or a special service). </p><br><pre> <code class="php hljs">$order = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Order(); $order-&gt;setCreateDate(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> \DateTime()); $order-&gt;setLastUpdateDate(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> \DateTime()); <span class="hljs-comment"><span class="hljs-comment">// .... $em-&gt;persist($order); $em-&gt;flush();</span></span></code> </pre> <br><p>  The disadvantages of this approach are obvious - if an order is created, and even more so, it is updated in several places - it will be necessary to repeat this logic in each place.  Fortunately, Doctrine contains event handling (LifecycleEvents). </p><br><p>  Add to the Entity description a construct that tells Doctrine that the Entity contains some events that need to be processed: </p><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@ORM</span></span></span><span class="hljs-comment">\HasLifecycleCallbacks() */</span></span></code> </pre> <br><p>  and create methods that will "respond" to these events.  In our case there will be two methods: </p><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@ORM</span></span></span><span class="hljs-comment">\PrePersist */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setCreateDate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;createDate = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> \DateTime(); } <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@ORM</span></span></span><span class="hljs-comment">\PreFlush */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setLastUpdateDate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;lastUpdateDate = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> \DateTime(); }</code> </pre> <br><p>  <code>@ORM\PrePersist</code> and <code>@ORM\PreFlush</code> tell Doctrine to execute the corresponding methods respectively when creating an Entity and each time it is updated.  Now there is no need to set these dates separately.  Full list of possible events can be <a href="http://docs.doctrine-project.org/projects/doctrine-orm/en/latest/reference/events.html">found here.</a> </p><br><div class="spoiler">  <b class="spoiler_title">Current Entity Order Type</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">/** * Order * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@ORM</span></span></span><span class="hljs-comment">\Table(name="order") * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@ORM</span></span></span><span class="hljs-comment">\HasLifecycleCallbacks() */</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Order</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@ORM</span></span></span><span class="hljs-comment">\Column(name="id", type="integer") * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@ORM</span></span></span><span class="hljs-comment">\Id * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@ORM</span></span></span><span class="hljs-comment">\GeneratedValue(strategy="AUTO") */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $id; <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@ORM</span></span></span><span class="hljs-comment">\Column(name="fio", type="string", length=100) */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $fio; <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@ORM</span></span></span><span class="hljs-comment">\Column(name="last_update_date", type="datetime") */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $lastUpdateDate; <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@ORM</span></span></span><span class="hljs-comment">\Column(name="create_date", type="datetime") */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $createDate; <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@ORM</span></span></span><span class="hljs-comment">\Column(name="status_id", type="integer") */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $statusId; <span class="hljs-comment"><span class="hljs-comment">//  getter/setter  /** * @ORM\PrePersist */ public function setCreateDate() { $this-&gt;createDate = new \DateTime(); } /** * @ORM\PreFlush */ public function setLastUpdateDate() { $this-&gt;lastUpdateDate = new \DateTime(); } }</span></span></code> </pre> </div></div><br><p>  Let's complicate the task - now we need to record in the order history information about who and when changed the status of this order, plus we want to send a letter about the status change to the client. </p><br><div class="spoiler">  <b class="spoiler_title">OrderHistory: Entity history entries by order</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">/** * OrderHistory * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@ORM</span></span></span><span class="hljs-comment">\Table(name="order_status_history") * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@ORM</span></span></span><span class="hljs-comment">\HasLifecycleCallbacks() */</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">OrderHistory</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@ORM</span></span></span><span class="hljs-comment">\Column(name="id", type="integer") * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@ORM</span></span></span><span class="hljs-comment">\Id * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@ORM</span></span></span><span class="hljs-comment">\GeneratedValue(strategy="AUTO") */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $id; <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@ORM</span></span></span><span class="hljs-comment">\Column(name="order_id", type="integer") */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $orderId; <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@ORM</span></span></span><span class="hljs-comment">\Column(name="manager_id", type="integer") */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $managerId; <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@ORM</span></span></span><span class="hljs-comment">\Column(name="status_id", type="integer") */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $statusId; <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@ORM</span></span></span><span class="hljs-comment">\ManyToOne(targetEntity="OrderStatus") * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@ORM</span></span></span><span class="hljs-comment">\JoinColumn(name="status_id", referencedColumnName="id") */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $status; <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@ORM</span></span></span><span class="hljs-comment">\ManyToOne(targetEntity="AppBundle\Entity\Manager") * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@ORM</span></span></span><span class="hljs-comment">\JoinColumn(name="manager_id", referencedColumnName="id") */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $manager; <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@ORM</span></span></span><span class="hljs-comment">\ManyToOne(targetEntity="Order", inversedBy="orderHistory") * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@ORM</span></span></span><span class="hljs-comment">\JoinColumn(name="order_id", referencedColumnName="id") */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $order; <span class="hljs-comment"><span class="hljs-comment">//  getter/setter  /** * @ORM\Column(name="create_date", type="datetime") */ private $createDate; /** * @ORM\PrePersist */ public function setCreateDate() { $this-&gt;createDate = new \DateTime(); } }</span></span></code> </pre> </div></div><br><p>  You can do all this "manually" in the place of the code where the status changes, but I would like everything to happen "automatically" without reference to the place of the operation to change the status. </p><br><p>  For this, Doctrine has <a href="http://docs.doctrine-project.org/projects/doctrine-orm/en/latest/reference/events.html">EntityListeners</a> , a class that tracks changes;  a place where you can keep all the logic of event handling. </p><br><p>  There are two options: either we add an event handler at the Entity description level: </p><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@ORM</span></span></span><span class="hljs-comment">\EntityListeners({"AppBundle\EntityListeners\OrderListener"}) */</span></span></code> </pre> <br><p>  And create a class Listener </p><br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">OrderHistoryListener</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">postUpdate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Order $order, LifecycleEventArgs $event)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// some code } }</span></span></code> </pre> <br><p>  The first parameter is a reference to the object in which the events occurred.  The second is the event object (we'll talk about it below). </p><br><p>  Or, </p><br><ul><li>  we have a lot of logic that reacts to events, we want to spread it across different classes </li><li>  EntityListener should respond not only to events of a particular class (for example, the same letter is sent for events of several types of Entity) </li></ul><br><p>  you can register handlers through standard symfony services: </p><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">services</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">order</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.history</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.status</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.listener</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">class</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">AppBundle</span></span>\<span class="hljs-selector-tag"><span class="hljs-selector-tag">EntityListeners</span></span>\<span class="hljs-selector-tag"><span class="hljs-selector-tag">OrderListener</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">tags</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">name</span></span>: doctrine.event_listener, event: preUpdate, method: preUpdate } <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">name</span></span>: doctrine.event_listener, event: prePersist, method: prePersist }</code> </pre> <br><p>  The <code>event</code> parameter defines the event for which the given service will be called, <code>method</code> - determines the specific method within the service.  Those.  service can be one, but to process different events for different Entity. </p><br><p>  In this case, the Listener will respond to events in general of any Entity and inside the class it will be necessary to check the type of the object. </p><br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">OrderHistoryListener</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">preUpdate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(PreUpdateEventArgs $event)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($event-&gt;getEntity() <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> Order) { } } }</code> </pre> <br><p>  EntityListener may contain different methods (handlers), depending on which event we want to receive a response. </p><br><p>  The <code>$event</code> object already contains references to the EntityManager and to UnitOfWork.  Accordingly, there is already everything to work with Doctrine objects.  You can pull out the necessary objects, update and delete them. </p><br><p>  Difficulties begin when you want to do something that is not related to the base, for example, send a letter.  To do this, you need to implement dependencies on external services in the EntityListener. </p><br><p>  In the first case, we create a view entry that will inject the dependencies into the EntityListener </p><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">services</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">app</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.doctrine</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.listener</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.order</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">class</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">AppBundle</span></span>\<span class="hljs-selector-tag"><span class="hljs-selector-tag">EntityListeners</span></span>\<span class="hljs-selector-tag"><span class="hljs-selector-tag">OrderListener</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">public</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">false</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">arguments</span></span>: <span class="hljs-selector-attr"><span class="hljs-selector-attr">["@mailer", "@security.token_storage"]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">tags</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">name</span></span>: <span class="hljs-string"><span class="hljs-string">"doctrine.orm.entity_listener"</span></span> }</code> </pre> <br><p>  In the second, just add a line with dependencies. </p><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">services</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">order</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.history</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.status</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.listener</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">class</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">AppBundle</span></span>\<span class="hljs-selector-tag"><span class="hljs-selector-tag">EntityListeners</span></span>\<span class="hljs-selector-tag"><span class="hljs-selector-tag">OrderListener</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">arguments</span></span>: <span class="hljs-selector-attr"><span class="hljs-selector-attr">["@mailer", "@security.token_storage"]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">tags</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">name</span></span>: doctrine.event_listener, event: preUpdate, method: preUpdate } <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">name</span></span>: doctrine.event_listener, event: prePersist, method: prePersist }</code> </pre> <br><p>  Then everything is as with the usual symfony-service. </p><br><p>  Inside the Listener, you can get a check on whether the field has changed, and also get the current and previous values. </p><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($event-&gt;hasChangedField(<span class="hljs-string"><span class="hljs-string">'status_id'</span></span>)) { $oldValue = $event-&gt;getOldValue(<span class="hljs-string"><span class="hljs-string">'status_id'</span></span>); $newValue = $event-&gt;getNewValue(<span class="hljs-string"><span class="hljs-string">'status_id'</span></span>); }</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">Final Entity Order Type</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">/** * Order * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@ORM</span></span></span><span class="hljs-comment">\Table(name="order") * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@ORM</span></span></span><span class="hljs-comment">\EntityListeners({"AppBundle\EntityListeners\OrderListener"}) * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@ORM</span></span></span><span class="hljs-comment">\HasLifecycleCallbacks() */</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Order</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@ORM</span></span></span><span class="hljs-comment">\Column(name="id", type="integer") * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@ORM</span></span></span><span class="hljs-comment">\Id * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@ORM</span></span></span><span class="hljs-comment">\GeneratedValue(strategy="AUTO") */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $id; <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@ORM</span></span></span><span class="hljs-comment">\Column(name="fio", type="string", length=100) */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $fio; <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@ORM</span></span></span><span class="hljs-comment">\Column(name="last_update_date", type="datetime") */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $lastUpdateDate; <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@ORM</span></span></span><span class="hljs-comment">\Column(name="create_date", type="datetime") */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $createDate; <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@ORM</span></span></span><span class="hljs-comment">\Column(name="status_id", type="integer") */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $statusId; <span class="hljs-comment"><span class="hljs-comment">//  getter/setter  /** * @ORM\PrePersist */ public function setCreateDate() { $this-&gt;createDate = new \DateTime(); } /** * @ORM\PreFlush */ public function setLastUpdateDate() { $this-&gt;lastUpdateDate = new \DateTime(); } }</span></span></code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">OrderListener code</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">OrderListener</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $_securityContext = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, $_mailer = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(\SwiftMailer $mailer, TokenStorage $securityContext)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_mailer = $mailer; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_securityContext = $securityContext; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">postUpdate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Order $order, LifecycleEventArgs $event)</span></span></span><span class="hljs-function"> </span></span>{ $em = $event-&gt;getEntityManager(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($event-&gt;hasChangedField(<span class="hljs-string"><span class="hljs-string">'status_id'</span></span>)) { $status = $em-&gt;getRepository(<span class="hljs-string"><span class="hljs-string">'AppBundle:OrderStatus'</span></span>)-&gt;find($event-&gt;getNewValue(<span class="hljs-string"><span class="hljs-string">'status_id'</span></span>)); $history = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> OrderHistory(); $history-&gt;setManager(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_securityContext-&gt;getToken()-&gt;getUser()); $history-&gt;setStatus($status); $history-&gt;setOrder($order); $em-&gt;persist($history); $em-&gt;flush(); <span class="hljs-comment"><span class="hljs-comment">//       SwiftMailer } } }</span></span></code> </pre> </div></div></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/339580/">https://habr.com/ru/post/339580/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../339566/index.html">Development of browser-based online games without frameworks and engines</a></li>
<li><a href="../339568/index.html">PostgreSQL 10 released</a></li>
<li><a href="../339570/index.html">The economy of tokens: discounts - the main problems</a></li>
<li><a href="../339572/index.html">API on Swift in five minutes. Lecture in Yandex</a></li>
<li><a href="../339576/index.html">REPL - setting for saving history and loading modules by default</a></li>
<li><a href="../339582/index.html">About design patterns for working with RDBMS</a></li>
<li><a href="../339584/index.html">We make life easier with the conclusion of SLA</a></li>
<li><a href="../339586/index.html">Red arrows of extra reality</a></li>
<li><a href="../339590/index.html">Webpack and addictions</a></li>
<li><a href="../339592/index.html">Functional F #, which slowly appears in C #</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>