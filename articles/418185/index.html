<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>The story of one autopsy: how we reversed Hancitor</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="For those who have already played enough with crackme puzzles , we brought up a fresh Trojan. In the wild, the Hancitor downloader is also found in it...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>The story of one autopsy: how we reversed Hancitor</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/webt/dn/-j/1o/dn-j1ohonpxz_urf0totdzgdxa4.jpeg"><br><br>  For those who have already played enough with <a href="https://habr.com/company/vyshtech/blog/350470/">crackme puzzles</a> , we brought up a fresh Trojan.  In the wild, the Hancitor downloader is also found in its natural habitat - spam mailings.  Currently, it is actively used to download the Panda banking trojan, which is a modification of the notorious Zeus. <br><br>  One cold summer evening we met him face to face, looking through email spam.  If you like to watch what is there in the malware "under the hood", read our new reverse-analysis. <br><a name="habracut"></a><br>  Our malicious document looks like this: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/webt/am/z_/bu/amz_buin-rjqprnnk-v2xuaio28.png"><br><br>  By default, the launch of macros is blocked, so the system warns: "Macros have been disabled."  However, the content of the letter assures that macros should be included.  Well, let's do it.  After clicking on the Enable Content button, the computer becomes infected.  And now let's see what kind of macro is being executed and how exactly the infection occurs.  This can be done immediately in the Word by clicking on the View-&gt; Vacros \ View Macros tab. <br><br><img src="https://habrastorage.org/webt/ly/uq/kd/lyuqkdosmy1commpds7-nu96gsa.png"><br><br>  You can do more professionally - use <a href="https://github.com/decalage2/oletools/wiki/olevba">olevba</a> from the oletools package.  You can install the package in the same link.  Next, type olevba doc_file ‚Äìc ‚Äìdecode&gt; source.txt and get the macro source. <br><br><img src="https://habrastorage.org/webt/tc/tk/gp/tctkgps17vavk9-zgtmzyjgparw.png"><br><br>  From the code I immediately want to say that the trojan belongs to the class of downloaders.  The script simply downloads malvaru from somewhere.  To prove this, let's decode the base64 strings.  It is more convenient for us to do this right away through the hiew, so as not to copy and paste a hundred times.  For this we use a special plugin, which is described <a href="https://reverse-pub.ru/2016/05/03/%25D0%25BF%25D0%25B8%25D1%2588%25D0%25B5%25D0%25BC-%25D0%25BF%25D0%25BB%25D0%25B0%25D0%25B3%25D0%25B8%25D0%25BD-base64decoder-%25D0%25BA-hiew/">here</a> .  Here's what happened: <br><br><img src="https://habrastorage.org/webt/az/tv/jo/aztvjo9bo-8zxu7vaus2mzxadcc.png"><br><br>  This is a malicious script, divided into two parts and saved as 1.hta.  In principle, we are not particularly interested in how it works.  It's all pretty trite.  The only important point is to determine the URL where the malicious file is being downloaded.  Let's try to find it, as this information may be useful to <a href="https://hackeru.pro/pentesting%3Futm_source%3Dhabrahabr%26utm_medium%3Dpost%26utm_campaign%3Dsmarcomm_pentest">security</a> guards.  They can add network rules to block requests from such URLs, which can save the company from infection. <br><br>  Ha!  There are no links.  But where does the 6.exe file come from, which runs 1.hta?  It's time to take another look at our dock file in hiew, but carefully: <br><br><img src="https://habrastorage.org/webt/b2/cc/y1/b2ccy1ewmolwz5wnaqojxdracbm.png"><br><br>  Yes, the exe-file is built into the dock document.  Yes, and heavily packed.  Explain what happens.  The macro drops the malicious script 1.hta into the Temp folder and launches it, and 1.hta starts in turn 6.exe from its directory.  It's clear that 6.exe is the same packed PE file that we see on the screen.  But we are now wondering how 6.exe drops in% temp%.  And this happens because of an interesting feature in the Microsoft Office package.  The point is that any other file in Ole10Native format can be embedded in any OLE document. <br><br>  If this is the case, then when it starts up, MS-Office itself drops the file embedded in this way into the% temp% folder under the name specified in the header of the Ole10Native structure.  Let's look at this object.  We were helped by the plugin for FAR-manager - <a href="https://plugring.farmanager.com/plugin.php%3Fpid%3D968%26l%3Dru">OLE2Viewer</a> .  Open our malicious document in the plugin, go to the ObjectPool \ _1593522492 directory and see this: <br><br><img src="https://habrastorage.org/webt/cc/wn/mx/ccwnmx32xpqyiizulnovkdnrkla.png"><br><br>  Copy this file (Ole10Native) and open it in the hiew. <br><br><img src="https://habrastorage.org/webt/vr/xb/37/vrxb37l9_urz13rlu0jvxphqpus.png"><br><br>  Here we see under what name our OLE-object - 5c.pif will drop into the% temp% folder.  Now back to our macro.  His task is to launch a dropped exe-shnik. <br><br><img src="https://habrastorage.org/webt/lo/wk/li/lowkli2uxojiyiq0gsoq6iuxh7e.png"><br><br>  In fact, to be precise, the macro starts the dropped file not always through 1.hta, but also like this: Shell "cmd.exe / c ping localhost -n 100 &amp;&amp;" &amp; Environ ("Temp") &amp; "\ 6 .pif ", vbHide <br><br><img src="https://habrastorage.org/webt/ut/8p/va/ut8pvaykzvbydqbqdfw3wuapvyy.png"><br><br>  The launch method, as we see, depends on the presence of the following processes in the system: bdagent.exe and PSUAMain.exe.  Why then do you need to ping localhost -n 100?  And this is an ancient Greek trick to create an artificial delay, just in case.  Usually its variations are used for self-removal. <br><br>  At this stage, we have analyzed the scheme of the malicious document.  It became clear to us that the document itself does not belong to malware like Trojan-Downloader, as it seemed at first glance, but it fits to type Trojan-Dropper.  Here is what happened at startup: <br><br><img src="https://habrastorage.org/webt/rd/qp/ki/rdqpkibxofr7rfrqloll1p_xf_q.png"><br><br>  Now it remains to disassemble the payload itself.  We already realized that our Trojan is packed, so we must first unpack it.  Usually this process is divided into two stages: <br>  1. Removing unpacked dump + restore import table. <br>  2. Analysis and cleaning of global variables. <br><br>  We need the second stage because there are many API functions that, as a result of their work, return non-recurring values.  For example, CreatHeap will return us a heap descriptor, which will then be used for work.  Very often in the code there are type checks: <i>if the heap descriptor == 0, then get the heap descriptor, otherwise use the already initialized one</i> .  But at the time of the dump, the variable containing the given descriptor was already initialized by it, and at that moment the descriptor was valid.  When we try to launch a captured dump, the variable with our descriptor will contain the old value, that is, not equal to 0, which means it will be checked. <br><br>  After that, as soon as the program tries to use this descriptor, the OS will throw an exception, and the program will crash with an error.  So, to avoid this, these variables need to be zeroed out.  Usually they are in the writeable data section.  Probably you offer to open this section in a hex editor and wipe everything with zeros?  You are partly right, but you should not commit rash actions.  There are such trojans that check variables not at 0, but at random DWORD.  And depending on whether the test passes or not, different actions are taken.  There is no need to go far for examples.  Just look at the <a href="https://www.webopedia.com/TERM/C/cridex-malware.html">Cridex</a> (recently disappeared somewhere from the radar, apparently completely upgraded to EMOTETA). <br><br>  So let's run our sample (on a virtual machine, of course).  It is also desirable that the traffic that will leave the virtual machine go through the VPN. <br><br>  We launch our trojan, and it ‚Äújust‚Äù hangs in the process.  Wonderful!  Typically, the Trojans "in a hurry" do their work, and then immediately terminate and delete themselves.  Therefore, you have to look for places in the code that are responsible for these actions, put a bryak on them, and then dump them.  In our case, we can do it just like that. <br><br>  For dump use a great utility - Process Dump, which can be taken <a href="https://github.com/glmcdona/Process-Dump">here</a> .  This utility not only finds all hidden executables and dumps them, but also restores the import table itself.  The utility must be run as administrator in the following way: pd / pid xxxx, where xxxx is the Trojan process id.  After that, the utility will dump all process modules.  We removed the extra and that's what's left: <br><br><img src="https://habrastorage.org/webt/tg/je/db/tgjedb068z9unx10xyhit2dftii.png"><br><br>  The name of the executable file of the Trojan process is 1.exe.  It turns out that at the address 0x2C0000 there was an unpacked Trojan.  Open it in hiew: <br><br><img src="https://habrastorage.org/webt/84/je/fc/84jefcffxabgt-pihoargfo-raa.png"><br><br>  Just happy eyes!  Now the file is unpacked, it is clearly visible.  The import table was also recognized.  Let's open it in IDA-PRO. <br><br><img src="https://habrastorage.org/webt/fn/hd/nc/fnhdncwcqiqd7jx_f7m8czjyf3m.png"><br><br>  We have already renamed some of the functions while the sample is being parsed.  The first thing a trojan starts working with is determining the load address of its module.  And really: how can he know at what address his stub unpacked?  This is done by an old proven technique - scribbling a page of memory back on 0x1000 relative to the current address until we stumble upon the ‚ÄúMZ‚Äù bytes.  This works because executables always load the OS at a multiple of 0x1000.  Check for yourself.  In our case, the limit is set to 100 scans. <br><br><img src="https://habrastorage.org/webt/7z/cy/5c/7zcy5cbgu4nls8b9yxz8gv9x3ai.png"><br><br>  If someone doesn‚Äôt understand where is otlivanie back, then here is where: <br>  result + = 0xFFFFF000 is equivalent to result - = 0x1000. <br><br>  After receiving the download address of its module, the unpacked Trojan receives the addresses of the functions necessary for its work.  First of all, the addresses of two functions are searched for - LoadLibraryA and GetProcAddress.  Knowing the addresses of these functions, you can use them to get all the rest.  These functions are located in the kernel32 library.  Its address is obtained by reading the first (zero - ntdll, first kernelbase, etc.) of the ring list element, which describes all the modules loaded in the initialization order by the _LDR_DATA_TABLE_ENTRY structure.  A pointer to the list is pulled out of PEB. <br><br><img src="https://habrastorage.org/webt/zx/o3/s3/zxo3s3kevu7prcaoffacdxvklow.png"><br><br>  Having received the address of kernel32.dll (starting with Windows 7 - kernelBase.dll), the trojan can manually parse its export table and find the necessary two functions, which is predictably performed in the sub_EF1E60 subroutine. <br><br><img src="https://habrastorage.org/webt/7k/xz/4v/7kxz4vk7-ad4q4d221g-ealmkko.png"><br><br>  Now take a look at the function we called getHeap. <br><br><img src="https://habrastorage.org/webt/qc/gv/oz/qcgvozmioggzgsidsap-5frkfas.png"><br><br>  Here we see exactly the situation described above.  At the time of the dump, the variable hHeap contained the value 600000h.  Therefore, GetProcessHeap will not be called.  Instead, the program will go to the loc_EF11DD label, where HeapAlloc will be called with an invalid handle, which will give us an error.  Therefore, we take the hex editor and zero this number.  We counted six similar places. <br><br>  Next, the fun begins.  Troyan generates a unique ‚Äúclient‚Äù ID, based on the serial number of the hard disk and the MAC address.  Information obtained here: <br><br><img src="https://habrastorage.org/webt/hx/fo/ce/hxfoceeap2k3oqut_yjgwqsjnwu.png"><br><br>  We also get the following: IP address, OS version, network name and username.  Based on all this, an HTTP request to the admin panel is created, the address of which we do not know yet.  In the lines it is not (even unpacked).  And it is not there, because it is encrypted in the config.  His address can be pulled from the code: <br><br><img src="https://habrastorage.org/webt/vw/9n/ej/vw9nej-cbxk5jgjljgjgasiwikw.png"><br><br>  The config weighs 0x2008 bytes and has the following format: the first 8 bytes are the RC4 key, 0x2000 bytes are the encrypted data. <br><br><img src="https://habrastorage.org/webt/tf/ne/je/tfneje_zc_aeq5nzmnzmkfd5r6c.png"><br><br>  The fact that the RC4 encryption algorithm is used becomes clear from the following listing: <br><br><img src="https://habrastorage.org/webt/4g/jc/ci/4gjccirc5sxslir_xgfoiytzjhc.png"><br><br>  Note that the first 8 bytes themselves are not the key to RC4.  The key is the SHA1 hash from these bytes.  You also need to pay attention to the flag 0x280011 to the function CryptDeriveKey.  In MSDN there is a reservation about this flag: <br><br><img src="https://habrastorage.org/webt/_t/2m/lu/_t2mlufhbsvpfivk9knvzdnoas0.png"><br><br>  From it it becomes clear that the older 16 bits of this flag set the key size in bits.  Ie in bytes, the key size is: (0x280011 &gt;&gt; 16) / 8 = 5. Therefore, the key will be the first five bytes from the hash from the first eight bytes of the config.  We will set up the config and write a script in python that will decrypt it to us.  The script looks like this: <br><br><img src="https://habrastorage.org/webt/fo/ow/7t/foow7ta0eo02epz-qp8vtkiozfy.png"><br><br>  The result of his work was the file config.rc4.  Open it in hiew: <br><br><img src="https://habrastorage.org/webt/rc/tz/dj/rctzdjyqwmh4ysz7pt7lhahlpna.png"><br><br>  We see the decoded list of admins.  The first word - "19nep07" - build number.  Under it allocated 16 bytes.  Next comes the list of admin URLs separated by "|". <br><br>  So, the first call to the admin panel will have the following format: <br>  GUID = 3068075364164635648 &amp; BUILD = 19nep07 &amp; INFO = WIN-56G04BL06SL @ WIN -56G04BL06SL \ Reverse &amp; IP = 35.0.127.52 &amp; TYPE = 1 &amp; WIN = 6.1 (x32 <br><br><img src="https://habrastorage.org/webt/1e/5o/bg/1e5obgayvnhe8mlproaehfms000.png"><br><br>  Then the generated request is sent to the first admin in the list. <br><br><img src="https://habrastorage.org/webt/ou/u8/ue/ouu8ueyhzcz_3hh2zbkmdh_hqvw.png"><br><br>  Then the answer is read from the admin panel, of course, if it is still alive.  The answer must be base64 encoded.  If this is not the case, the next admin from the list is taken.  Sometimes live admins return a strange answer: <br><br><img src="https://habrastorage.org/webt/lu/d_/uo/lud_uoa61fkscmma-05nbxlkoic.png"><br><br>  Familiar, is not it?  Yes, these are the same <a href="http://ru.lostpedia.wikia.com/wiki/%25D0%25A7%25D0%25B8%25D1%2581%25D0%25BB%25D0%25B0">numbers</a> !  In fact, one author knows why the admin panel starts returning them!  In normal form, the command is returned.  Unfortunately, it is impossible to say with complete confidence what the response format will be, since there is no traffic, all admin panels are dead.  The decoded file additionally splits into 0x7A: <br><br><img src="https://habrastorage.org/webt/f0/sc/8k/f0sc8kchkod-u2luugrrlty75t8.png"><br><br>  The answer must contain a command.  If it does not exist, the next admin panel is accessed.  The command code is encoded as ‚Äúx:‚Äù, where x is the letter coding for a specific command.  There are 7 of them in all: 'r', 'l', 'e', ‚Äã‚Äã'b', 'd', 'c', 'n'.  Consider the commands "b" and "r". <br><br>  The handlers of these commands have the same function.  We called it GetExe.  Here's what she looks like: <br><br><img src="https://habrastorage.org/webt/_a/rz/lk/_arzlkrepv0wjyhlt0k4krtjtv8.png"><br><br>  I think everything is clear.  The trojan makes an http request and returns the executable file in a compressed form, which is then compressed.  Then variations are possible.  In the case of the ‚Äúb‚Äù command, the following three actions occur: <br><br>  <b>1. Making the svchost process frozen</b> <br><br><img src="https://habrastorage.org/webt/lz/yw/cy/lzywcy3d56o5tmkxdz8yu5ttvp4.png"><br><br>  <b>2. Inject into the address space of the process of the downloaded module</b> <br><br><img src="https://habrastorage.org/webt/7b/ab/fe/7babfemu0nyrag5bv6jtadst3o8.png"><br><br>  <b>3. Transfer of control to the module</b> <br><br><img src="https://habrastorage.org/webt/xj/m4/i5/xjm4i5ch6cpnogd79cz47tn1pny.png"><br><br>  In the case of the ‚Äúr‚Äù command, the following three actions occur: <br>  1. Downloading the executable file by calling the GetExe function. <br>  2. Saving the downloaded file to a temp folder under a random name. <br>  3. Run the drop file. <br><br><img src="https://habrastorage.org/webt/qk/go/sj/qkgosjsrb_45ny1kkfi7cguuvbm.png"><br><br>  Done. <br><br>  PS Next time we can do a parsing of either the "Panda" or some cryptographer.  Write in the comments which malware interests you the most (for research purposes, of course). </div><p>Source: <a href="https://habr.com/ru/post/418185/">https://habr.com/ru/post/418185/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../418171/index.html">What metrics to rely on, if users perform few conversions on the site?</a></li>
<li><a href="../418173/index.html">"There and back" for neural networks, or a review of auto-encoder applications in text analysis</a></li>
<li><a href="../418177/index.html">Editing .heic images without losing colors</a></li>
<li><a href="../418181/index.html">Roskomnadzor re-blocked the Hideme.ru VPN service. The site again moved to a new address.</a></li>
<li><a href="../418183/index.html">The use of speech analytics in business</a></li>
<li><a href="../418187/index.html">In America, they suggested replacing all libraries with Amazon hubs. The public is indignant</a></li>
<li><a href="../418189/index.html">The heir of Zeus: how dangerous is IcedID Trojan for bank customers</a></li>
<li><a href="../418191/index.html">Analogs in Python and JavaScript. Part three</a></li>
<li><a href="../418193/index.html">How does it feel to create a game for Game Boy in 2017</a></li>
<li><a href="../418195/index.html">MIT course "Computer Systems Security". Lecture 4: "Separation of privileges", part 1</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>