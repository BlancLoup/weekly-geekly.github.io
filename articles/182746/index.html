<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Overview of Windows Workflow Foundation on the example of building an electronic document management system [Part 2]</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Development of a document management system is an overwhelming task for a small team? 



 In a previous post, I looked at the architectural features ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Overview of Windows Workflow Foundation on the example of building an electronic document management system [Part 2]</h1><div class="post__text post__text-html js-mediator-article"><h2>  Development of a document management system is an overwhelming task for a small team? </h2><br><img src="https://habrastorage.org/storage2/78e/792/9ab/78e7929ab7d7c20a9b9031212f8cd06d.jpg"><br><p>  In a previous <a href="http://habrahabr.ru/company/luxoft/blog/181562/">post,</a> I looked at the architectural features of WF when it is best to use this technology.  In this part, I will convey how WF is applied in a particular project. <br></p><br><p>  So, the task is to implement an electronic document management system. <br></p><br><a name="habracut"></a><br><p>  For convenience, I will break this part into several blocks. <br></p><br>  <b>Maintaining lists of documents</b> <b><br></b> <br><p>  This module was implemented using ASP.NET MVC technology.  Allows you to create and edit various types of documents, run workflows on them.  We denote it here so that it can be referenced in the future, but we will not consider it in detail. <br></p><br><p>  We assume that we have document classes that implement approximately the following common interface *: <br></p><br><pre><code class="cs hljs"><span class="hljs-comment"><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">   </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> public interface IDocument { </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">   </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> int DocumentId { get; set; } </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">   </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> User Author { get; set; } </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">    </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> int AuthorId { get; set; } }</span></span></code> </pre> <br><p>  * Here and further, a simplified version of the production code is used to simplify. <br></p><br>  <b>General activities</b> <b><br></b> <br><p>  Users launch document activity activities (hereinafter referred to as General Activities).  Common activities have 2 input arguments: <br></p><br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">      </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> public interface IDocumentWorkflow { </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">   ( ) </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> InArgument</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;int&gt;</span></span></span><span class="hljs-comment"> DocumentId { get; set; } </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">  ,   ( ) </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> Inrgument</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;int&gt;</span></span></span><span class="hljs-comment"> UserId { get; set; } }</span></span></code> </pre><br><p>  , here <i>DocumentId</i> is the document key, and <i>UserId</i> is the key of the user who starts the activity. <br></p><br><p>  Thus, in the General activities, only the key of the document rotates, and not the entire object, which will help avoid problems when restoring the state of the saved workflows if we need to modify the document class in the future (add a property, for example). <br></p><br><p>  In addition, a separate set of metadata is separately stored for each General activity: launch privileges, document types for which the activity is allowed to run, <a href="http://sergeyteplyakov.blogspot.ru/2010/12/dynamic-linq.html">Dynamic LINQ</a> expression to the document for testing the launch capability, and others. <br></p><br><p>  The total activity ‚Äî the custom part of our system ‚Äî is coded by the workflow designer and saved as XAML.  The implementation of the designer will be discussed below. <br></p><br><p>  Below is the code to start the activity in the WF runtime. <br></p><br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">         </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;typeparam name="T"&gt;</span></span></span><span class="hljs-comment">  </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/typeparam&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;param name="documentId"&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/param&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;param name="userId"&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/param&gt;</span></span></span><span class="hljs-comment"> public static void StartDocumentWorkflow</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;T&gt;</span></span></span><span class="hljs-comment">(int documentId, int userId) where T: Activity, IDocumentWorkflow, new() { //              var wfApp = new WorkflowApplication(new T(), new Dictionary</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;string, object&gt;</span></span></span><span class="hljs-comment">() { { "DocumentId", documentid}, { "UserId", userId}}); //     wfApp.InstanceStore = new SqlWorkflowInstanceStore(ApplicationData.ConnectionString); wfApp.PersistableIdle = (e) =&gt; { // ,    ‚Äì    return PersistableIdleAction.Unload; }; wfApp.Completed = (completeArg) =&gt; { //   }; wfApp.Aborted = (abortArg) =&gt; { //  }; wfApp.OnUnhandledException = (exceptionArg) =&gt; { //    return UnhandledExceptionAction.Abort; }; wfApp.Run(); }</span></span></code> </pre><br><p>  One thing needs to be clarified here: in order for the workflow to save its state if necessary, an instance of the <i>SqlWorkflowInstanceStore</i> storage class is transferred to the runtime using <a href="http://sergeyteplyakov.blogspot.ru/2013/01/di-property-injection.html">Property Injection</a> . <br></p><br>  <b>Passing Arguments to the Workflow</b> <b><br></b> <br><p>  So Total Activity is up and running.  But at some point, she may need additional data from users of the system for her work.  On the basis of this data, in accordance with her logic, she chooses a branch of execution, changes the properties of a document, sends notifications, as well as other actions. <br></p><br><p>  Therefore, it is necessary to describe these data (hereinafter - Arguments).  There were 2 options.  Describe one universal type (the ‚Äúkey - value‚Äù collection) that would be used to transfer any information to the workflow.  But I chose the benefits of strong typing and implemented a dynamically loadable library of custom Arguments.  Classes implement the <i>IAssignArgument</i> interface: <br></p><br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">        </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> public interface IAssignArgument { </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">  ,   </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> int UserId { get; set; } } </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">          </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> public abstract class AssignArgumentBase : IAssignArgument { </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">  ,   </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> [DisplayName(" ")] [EditorBrowsable(EditorBrowsableState.Never)] public int UserId { get; set; } } [DisplayName("")] [Category("")] public sealed class Learn : AssignArgumentBase { } [DisplayName(" , , ")] [Category("")] public sealed class EnterNumberDateFile : AssignArgumentBase { [Required, DisplayName(" ")] public string Number {get; set;} [Required, DisplayName(" ")] public DateTime Date {get; set;} [FileId, Required, DisplayName("")] public int? FileId {get; set;} }</span></span></code> </pre><br><p>  where <i>UserId</i> is the key of the user who is passing the Argument to the workflow. <br></p><br><p>  We now turn to the activity itself, which is waiting for input data.  For these purposes, the <a href="http://msdn.microsoft.com/ru-ru/library/dd454626.aspx">NativeActivity &lt;T&gt;</a> class is provided in the base activity library, where <i>T</i> is the result of the work of the activity ‚Äî our Argument.  We will inherit our class from <i>NativeActivity</i> : <br></p><br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">DisplayName(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">" ..."</span></span></span><span class="hljs-meta">)</span></span>] [Category(<span class="hljs-string"><span class="hljs-string">""</span></span>)] [Designer(<span class="hljs-string"><span class="hljs-string">"DocWorkflow.Activities.Designer.GenericActivityDesigner, DocWorkflow.Activities.Designer"</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">AssignDocumentActivity</span></span>&lt;<span class="hljs-title"><span class="hljs-title">T</span></span>&gt; : <span class="hljs-title"><span class="hljs-title">NativeActivity</span></span>&lt;<span class="hljs-title"><span class="hljs-title">T</span></span>&gt; <span class="hljs-title"><span class="hljs-title">where</span></span> <span class="hljs-title"><span class="hljs-title">T</span></span> : <span class="hljs-title"><span class="hljs-title">class</span></span>, <span class="hljs-title"><span class="hljs-title">IAssignArgument</span></span>, <span class="hljs-title"><span class="hljs-title">new</span></span>() { <span class="hljs-comment"><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">    </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> [DisplayName("")] public new OutArgument</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;T&gt;</span></span></span><span class="hljs-comment"> Result { get { return base.Result; } set { base.Result = value; } } </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">    </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> [DisplayName("")] [RequiredArgument] public InArgument</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;int&gt;</span></span></span><span class="hljs-comment"> DocumentId { get; set; } </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">  ,     </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> [DisplayName(" ")] [RequiredArgument] public InArgument</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;int&gt;</span></span></span><span class="hljs-comment"> UserId { get; set; } </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> 1-  (   ): </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> -       ,     ; </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> -  . </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> protected override void Execute(NativeActivityContext context) { var bookmarkName = Guid.NewGuid().ToString(); using (var store = new DataStore()) { store.Add(new AssignedDocumentInfo() { UserId = context.GetValue(this.UserId), WorkflowInstanceId = context.WorkflowInstanceId.ToString(), ActivityInstanceId = context.ActivityInstanceId.ToString(), WorkflowType = context.GetExtension</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;WorkflowInstInfo&gt;</span></span></span><span class="hljs-comment">().GetProxy().WorkflowDefinition.GetType().FullName, ArgumentType = typeof(T).FullName, BookmarkName = bookmarkName, DocumentId = context.GetValue(this.DocumentId), ActivityName = this.DisplayName, AssignedDate = DateTime.Now }); } context.CreateBookmark(bookmarkName, new BookmarkCallback(this.Continue)); } </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> 2-  (   ): </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> -       ; </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> -    . </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> protected void Continue(NativeActivityContext context, Bookmark bookmark, object obj) { using (var store = new DataStore()) { foreach (var item in store.AssignedDocumentInfo.Where(aa =&gt; aa.WorkflowInstanceId == context.WorkflowInstanceId.ToString() &amp;&amp; aa.ActivityInstanceId == context.ActivityInstanceId.ToString() &amp;&amp; aa.UserId == context.GetValue(this.UserId) &amp;&amp; aa.BookmarkName == bookmark.Name).ToArray()) { store.Remove(item); } } Result.Set(context, (T)obj); } }</span></span></code> </pre><br><p>  As you can see, this activity at the first stage saves the data necessary for restoring the state to the repository (document key, user key to which the task is assigned, type of General activity, type of Argument, name of action, ‚Äúbookmark‚Äù for recovery).  At the second stage, it receives the input Argument and passes it to the out-parameter for use in the body of the Common Stream. <br></p><br><img src="https://habrastorage.org/storage2/8c5/3a5/d3b/8c53a5d3bd432d97ad421abb9164b632.gif"><br><br><p>  The module for working with documents, in turn, sees the tasks assigned to the user, when starting the workflow restoration process dynamically forms a view based on the type of Argument (if necessary, you can specify a custom view, of course) receives an Argument from the user and sends it to restore Total Activity . <br></p><br><p><img src="https://habrastorage.org/storage2/9d3/874/f74/9d3874f746f935c804923259375b744f.gif"><br><br></p><br><p>  Strong typing of Arguments (the antipode - <i>Argument [‚ÄúProp1‚Äù]</i> ) allows validating references to the properties of the Argument at the stage of building activity in the designer. <br></p><br><img src="https://habrastorage.org/storage2/e58/d1d/169/e58d1d169a27d0fd3038cdc13daa927a.gif"><br><p>  Stream with violation of the rules of type conversion will not start.  That is, errors occur at compile time, not at run time, literally. <br></p><br><p>  Below is the code to restore the workflow. <br></p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> ResumeWorkflow&lt;T&gt;(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> assignedDocumentInfoKey, T arg) <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> T: IAssignArgument { AssignedDocumentInfo assignedDocumentInfo = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> store = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DataStore()) { <span class="hljs-comment"><span class="hljs-comment">//     assignedDocumentInfo = store.AssignedDocumentInfo .Where(aa =&gt; aa.AssignedDocumentInfoId=assignedDocumentInfoKey).First(); } var activity = (Activity) Activator.CreateInstance(Type.GetType(assignedDocumentInfo.WorkflowType)); WorkflowApplication wfApp = new WorkflowApplication(activity); wfApp.InstanceStore = new SqlWorkflowInstanceStore(ApplicationData.ConnectionString); wfApp.PersistableIdle = (e) =&gt; { return PersistableIdleAction.Unload; }; //    wfApp.Load(new Guid(assignedDocumentInfo.WorkflowInstanceId)); //           wfApp.ResumeBookmark(new Bookmark(assignedDocumentInfo.BookmarkName), arg); }</span></span></code> </pre><br><p>  I would like to clarify the difference between the two types of activity properties: <br></p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">MyActivity</span></span>&lt;<span class="hljs-title"><span class="hljs-title">T</span></span>&gt; : <span class="hljs-title"><span class="hljs-title">CodeActivity</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> InArgument&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt; UserId1 {<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>;} <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> UserId2 {<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>;} }</code> </pre><br><p>  In the first case, the actual value of the property (this also applies to <i>OutArgument &lt;T&gt;</i> and <i>Variable &lt;T&gt;</i> ) is a participant in the work activity process, it can change the value in the process, save and restore its state in the repository: an element of the activity property table in the designer <img src="https://habrastorage.org/storage2/f1c/9d4/027/f1c9d4027572b712fec888717a0826c6.gif">  XAML Activity Attribute - <img src="https://habrastorage.org/storage2/ddb/cb1/912/ddbcb19128c0dae818e5a0ab229456b5.gif">  . <br></p><br><p>  In the second case, the value is constant - it does not change when the activity is working.  It is convenient to use to save unchanged activity parameters in XAML: an element of the table of activity properties in the designer - <img src="https://habrastorage.org/storage2/38a/cdf/852/38acdf8520e2dc899269fda4116e1897.gif">  XAML Activity Attribute - <img src="https://habrastorage.org/storage2/37e/e35/1b4/37ee351b4314c54ad138cbc4015e824d.gif">  . <br></p><br>  <b>Managing the launch of child activities</b> <b><br></b> <br><p>  Next, analyze the activity for updating objects in the repository.  There may be plenty of options.  For example, we implement it in the form of a composition of child activities.  For activities that do not require data from the outside, a special base class <a href="http://msdn.microsoft.com/ru-ru/library/system.activities.codeactivity.aspx">CodeActivity is</a> also implemented in the base activity library. <br></p><br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">         -  </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;typeparam name="T"&gt;</span></span></span><span class="hljs-comment">  </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/typeparam&gt;</span></span></span><span class="hljs-comment"> public abstract class ObjectSetPropertyActivity</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;T&gt;</span></span></span><span class="hljs-comment"> : CodeActivity where T : class { public T Object { get; set; } } </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">       -  </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;typeparam name="T"&gt;</span></span></span><span class="hljs-comment">  </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/typeparam&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;typeparam name="TProperty"&gt;</span></span></span><span class="hljs-comment">  </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/typeparam&gt;</span></span></span><span class="hljs-comment"> public class ObjectSetPropertyActivity</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;T, TProperty&gt;</span></span></span><span class="hljs-comment"> : ObjectSetPropertyActivity</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;T&gt;</span></span></span><span class="hljs-comment"> where T : class { </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">   </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> public string Property { get; set; } </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">     ( ) </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> [RequiredArgument] public InArgument</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;TProperty&gt;</span></span></span><span class="hljs-comment"> Value { get; set; } protected override void Execute(CodeActivityContext context) { //   typeof(T).GetProperty(Property).SetValue(Object, Value.Get(context), null); } } </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> ,      </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;typeparam name="T"&gt;</span></span></span><span class="hljs-comment">   </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/typeparam&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;typeparam name="TKey"&gt;</span></span></span><span class="hljs-comment">  </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/typeparam&gt;</span></span></span><span class="hljs-comment"> public class ObjectUpdateActivity</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;T, TKey&gt;</span></span></span><span class="hljs-comment"> : CodeActivity where T : class { public ObjectUpdateActivity() { this.Activities = new Collection</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;ObjectSetPropertyActivity&lt;T&gt;</span></span></span><span class="hljs-comment">&gt;(); } </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">     ( ) </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> public InArgument</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;TKey&gt;</span></span></span><span class="hljs-comment"> Key { get; set; } </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">        </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> public Collection</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;ObjectSetPropertyActivity&lt;T&gt;</span></span></span><span class="hljs-comment">&gt; Activities { get; set; } protected override void Execute(NativeActivityContext context) { if (this.Activities.Count &gt; 0) { var store = new DocWorkflowDbContext(); var obj = store.LoadObject</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;T&gt;</span></span></span><span class="hljs-comment">(context.GetValue(Key)); var index = 0; CompletionCallback callback = (context1, activityInstance) =&gt; { index++; //    : //-  ; //-      . if (index </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt; this.Activities.Count) { this.Activities[index].Object = obj; context1.ScheduleActivity(this.Activities[index], callback); } else { store.UpdateObject(obj); store.SaveChanges(); store.Dispose(); } }; //      this.Activities[index].Object = obj; //    context.ScheduleActivity(this.Activities[index], callback); } } }</span></span></span></span></code> </pre><br><p>  As you can see, the parent activity loads the object from the database, runs all child activities in the WF runtime to change the properties of the object, and then saves the changes to the repository.  Due to the universality of the types of activities, we also have a validation of the types of input new values ‚Äã‚Äãfor the properties of an object in the designer. <br></p><br><p>  So this activity may look like in a designer. <br></p><br><img src="http://habrastorage.org/storage2/0fa/acc/8ca/0faacc8ca96317108aefb27f14518bf4.gif"><br>  <b>Workflow Designer</b> <b><br></b> <br><p>  This is the most "viscous" part of the technology, that is, to realize something slightly protruding beyond the framework, we need to "dance and beat the tambourine." <img src="http://habrastorage.org/storage2/bce/6e6/8d8/bce6e68d869fbb8ca63e8f0af3625854.png" alt="that same"><br></p><br><p>  Designer is built on technology WPF. <br></p><br><p>  The main element here is <a href="http://msdn.microsoft.com/ru-ru/library/system.activities.presentation.workflowdesigner.aspx">WorkflowDesigner</a> - the graphic area in which the <a href="http://msdn.microsoft.com/ru-ru/library/system.activities.presentation.workflowdesigner.aspx">workflow</a> is being constructed. <br></p><br><p>  Each activity can be associated with its own design-object (VS even has a special type of project for developing the design of a WF element - Activity Designer Library) using the <i>[Designer]</i> attribute.  The same applies to the properties of the activity - attribute <i>[Editor]</i> .  That is, nothing new in this part, in fact. <br></p><br><p>  I will not give the code, since it is difficult to identify something that stands out at the same time and is quite compact.  For that I will give a few links. <br></p><br><p>  <a href="http://www.codeproject.com/Articles/375034/A-dynamic-Rehosted-Workflow-Designer-for-WF-4">Here is a</a> great example of the implementation of the designer.  This is a model of how created activities encoded in XAML can be immediately used as building elements in new activities.  The peculiarity of the example is that a change in the initial activity does not lead to a change in the algorithms of all the activities where the original is used.  Unfortunately, this ‚Äúfeature‚Äù did not suit us. <br></p><br><p>  And <a href="http://www.neovolve.com/%3Ftag%3D/WF">here is a</a> series of excellent posts on WF with examples (in particular, you can find a <a href="http://www.neovolve.com/post/2010/09/30/Creating-updatable-generic-Windows-Workflow-activities.aspx">sample</a> by replacing the arguments of the universal type in the designer).  If necessary, you will need less ‚Äújumping with a tambourine‚Äù, but you still have to. <br></p><br>  <b>Conclusion</b> <b><br></b> <br><p>  As you can see, the development is not very complicated, the system easily expands.  If desired, we can implement the activity that controls the availability of specific properties of the document for changing, for example, and in the module for maintaining lists of documents - support this functionality. <br></p><br><p>  Was a lot of work done in the end?  Big.  But is she in the teeth for a small team?  Yes, even for a team of 3 - 4 people.  And within a reasonable time! <br></p><br><p>  I hope the information outlined in this post will be useful to you.  If I missed something, stated it incorrectly, or you have questions - welcome to the comments! <br></p><br><img src="https://mc.yandex.ru/watch/39622305" alt="image"></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/182746/">https://habr.com/ru/post/182746/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../182734/index.html">‚ÄúWe need a reliable wireless network‚Äù</a></li>
<li><a href="../182736/index.html">Opportunity found evidence on Mars of the existence (in the past) of fresh water</a></li>
<li><a href="../182738/index.html">Adopted a law on open data</a></li>
<li><a href="../182740/index.html">Automatic installation of the operating system on dedicated servers Selektel</a></li>
<li><a href="../182742/index.html">RADUG + DI = WWDC</a></li>
<li><a href="../182748/index.html">Gentle introduction to Coq: inductive definitions</a></li>
<li><a href="../182750/index.html">SlideStackView or extending ViewGroup in Android</a></li>
<li><a href="../182754/index.html">Skype spam campaign endangered hundreds of thousands of users.</a></li>
<li><a href="../182758/index.html">Windows 8 Technology Conference</a></li>
<li><a href="../182760/index.html">Bunny: We hide traffic in the noise of Wi-Fi</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>