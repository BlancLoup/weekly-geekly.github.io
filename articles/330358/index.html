<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Rapid STP</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Protocols of the STP family usually slightly excite the minds of engineers. And for the most part on the Internet, you most often come across the deta...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Rapid STP</h1><div class="post__text post__text-html js-mediator-article"><div style="text-align:center;"><img src="https://habrastorage.org/web/336/074/a46/336074a46451407083cd53ed2349fff3.png"></div><br>  Protocols of the STP family usually slightly excite the minds of engineers.  And for the most part on the Internet, you most often come across the details of how STP works.  But time does not stand still and classic STP is less and less common in work and in various vendor materials.  The idea was to make a small overview of the key points of <b>RSTP</b> in the form of a FAQ.  Anyone who is interested in this question, please under the cat. <a name="habracut"></a><br><br>  <b>What to configure STP, RSTP or MST?</b> <br><br>  In modern standards, the STP protocol does not appear anywhere else.  Known to all <b><i>802.1d</i></b> in the latest edition ( <a href="https://standards.ieee.org/findstds/standard/802.1D-2004.html">802.1d-2004</a> ) describes the RSTP protocol.  At the same time MST migrated to <b><i>802.1q</i></b> ( <a href="https://standards.ieee.org/findstds/standard/802.1Q-2014.html">802.1q-2014</a> ).  As we remember, earlier RSTP was described by the standard 802.1w, and MST - 802.1s. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      RSTP and MST have significantly less convergence time.  They are much faster rebuild the network topology in case of failure of equipment or communication channels.  The convergence time for a series of failures of these protocols is less than 1 second versus 30+ seconds in the case of STP.  Therefore, classic STP is recommended to be used only where old equipment is used, which does not support more modern protocols. <br><br>  MST uses RSTP algorithms in its work.  But unlike RSTP, MST allows you to create a separate STP instance (instance) for a group of VLANs.  In the case of a regular RSTP, we have one common topology for all VLANs.  This is not very convenient, since it does not allow even in manual mode to balance traffic across different channels.  So, we lose at least half of the bandwidth in the case of redundant paths. <br><br>  Some vendors (including Cisco) offer another kind of fast STP protocol - Rapid Per-VLAN Spanning Tree (PVRST +).  In this case, each virtual network has its own topology, which allows for more efficient utilization of the channels.  The main disadvantage of this approach is the limit on the maximum number of such topologies.  To ensure the operation of each topology device spends hardware resources.  And they are not limitless.  For example, in Cisco 2960 switches, a maximum of 128 STP instances are supported. <br><br>  Thus, MST is a good alternative between standard RSTP and proprietary PVRST +.  Especially if our network is built on the basis of switches from different manufacturers.  It is worth noting that all three variations of fast STP are compatible with each other. <br><br>  <i>In the future, mentioning RSTP, we will also include its MST / PVRST + extensions.</i> <br><br>  <b>What technologies provide quick response in RSTP?</b> <br><br>  RSTP primarily relies on mechanisms that are not tied to standard timers.  That is why it allows you to get significantly less time convergence of the network.  The following improvements in the work of RSTP in comparison with the classical STP can be distinguished: <br><br><ol><li>  BPDU generation of messages by each device regardless of the root switch. <br><br>  In the classic version of BPDU, only the root switch is ‚Äúgenerated‚Äù on the network.  All other devices only relay it.  Thus, the absence of a BPDU from the upstream device means that there may be a problem anywhere between this device and the root switch.  Therefore, we had to wait long enough (MaxAge = 20 seconds) before accepting the fact that something went wrong and you need to rebuild the topology. <br><br>  In the case of RSTP, BPDU messages have become the role of Hello packets.  Now the loss of three such packages (which is 2 * 3 = 6 seconds) means that it is time to think about changes in the topology. <br><br></li><li>  Proposal / Agreement mechanism when a point-to-point connection is activated on non-edge ports for fast transition to the forwarding state. <br><br><div class="spoiler">  <b class="spoiler_title">Note</b> <div class="spoiler_text">  RSTP provides two types of connections: <br><ul><li>  <b>point-to-point</b> ‚Äî only one RSTP switch is connected to this port; <br></li><li>  shared ( <b>shared</b> ) - several RSTP switches are connected to such a port (through a hub, which is a big exotic nowadays). <br></li></ul><br>  Usually, switches determine the type of connection automatically, based on the full-duplex (point-to-point) or half-duplex (general) transmission mode.  In the case of a shared connection, the RSTP tweaks stop working. <br></div></div><br>  In the classic STP port, which should become the root, goes through all stages of the transition to transfer mode (Listening ‚Üí Learning ‚Üí Forwarding), which takes more than 30 seconds. <br><br>  Before touching on the Proposal / Agreement mechanism, you need to note two different types of ports in the RSTP: the <b>Edge port</b> and the <b>non-Edge port</b> .  Edge port connects endpoints (PCs, servers, in some cases routers, etc.).  Other switches participating in the STP topology are connected to the non-edge port. <br><br><div class="spoiler">  <b class="spoiler_title">Note</b> <div class="spoiler_text">  Edge port type is set manually.  The switch can not quickly determine who is connected to it: a normal host or switch.  Of course, he could focus on having a BPDU on this port.  But according to the standard, the switch must wait at least 15 seconds (Forward delay) before deciding that no message has come to its port.  And this is too long.  Therefore, the right to determine what is connected to the port is entrusted to the person. <br><br>  On Cisco switches, the Edge port type is specified by the <i>spanning-tree portfast command</i> . <br></div></div><br>  RSTP uses the Proposal / Agreement mechanism to quickly move ports from the state of Discarding to the state of Forwarding.  This mechanism starts when the Root Port of the switch changes (at least when it is switched on in the network).  In this case, it turns off all ports that are not edge ports.  This is indicated by the upstream switch (where the Root port is looking at), after which only the Root port is included in the Forwarding mode.  The remaining ports (not Edge) are in a locked state until one of two things happen: <br><br><ul><li>  the switch exchanges the Proposal / Agreement with the downstream switch, </li><li>  transition timers will expire from Discarding to Learning (15 seconds) and from Learning to Forwarding (15 seconds) if the connected equipment does not support RSTP. <br></li></ul><br>  The Proposal message is sent by the port that wants to become Designated for this network segment.  And it actually starts the Proposal / Agreement mechanism.  Agreement message is sent by the port, which becomes the root (Root).  It is necessary to notify the upstream device about the possibility of immediately transferring the port to the Forwarding state. <br><div style="text-align:center;"><img src="https://habrastorage.org/web/49a/cba/d5b/49acbad5bb994c25931c15ef046c40d2.png"></div><br></li><li>  The mechanism of the alternative port in case of loss of connection through the root port. <br><br>  RSTP differs from STP in that the port state is untied from its role.  This allowed us to describe the role of the port in the network topology without regard to its state.  So, to have the best vision of the network topology and the ability to quickly respond to changes in it.  So there were alternative (alternative) and reserve (backup) ports.  Alternative port - replace the root.  Through it, the root switch can be reached, but this port does not have the role of the root (i.e., receives BPDUs with the worst metric) and is not designated (i.e., it is not the best in this network segment to reach the root device). <br><br>  In the RSTP protocol, the alternative port enters the transfer state immediately after the root has failed.  The same behavior can be achieved in classic STP using proprietary improvements.  For example, Cisco offers UplinkFast technology for this purpose. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/web/62e/bdc/395/62ebdc395a1a48e9b881d69d450795da.png"></div><br></li><li>  The mechanism of an immediate response to receiving BPDUs with information about the ‚Äúworst‚Äù root switch from a neighbor with a designated (designated) port for this network segment. <br><br>  In such a situation, if the device has another route to the root switch, in the classic STP port, which was previously blocked, will go through all the stages and switch to the transfer mode only after 50 seconds (MaxAge + 2x Forward Delay). <br><br>  In the case of RSTP, the switch will immediately evaluate the received BPDU (there is no MaxAge timer in RSTP) and will begin to transmit its own by setting the Proposal flag.  Having received such a BPDU, the switch that has lost contact with the ‚Äúroot‚Äù will take part in the Proposal / Agreement mechanism, since its root port has changed.  And then, rather quickly, the ports on both switches will go into the transfer state. <br><div style="text-align:center;"><img src="https://habrastorage.org/web/73b/b63/e93/73bb63e935984b50b36134a7b04b29c4.png"></div><br></li><li>  Improved distribution and processing of TCN BPDU messages about changes in the network. <br><br>  Classic STP believes that the topology has changed if the port has moved from the state blocked to the transmission state or vice versa.  Since a topology change may result in MAC addresses becoming available through other ports (which means the switch will send packets not there), the procedure for notifying all devices about such an event is launched.  For this, a Topology Change Notification (TCN) message is sent.  Having received that, the switch changes the aging time of MAC addresses from the default (300 sec.) To 15 sec. (Forward Delay).  A TCN message is sent in two stages.  First, the switch that detects changes in the topology sends it to the root switch.  Further, the root switch, having received such a message, learns about the change in the network and sends the TCN message (BPDU with the corresponding flag) to everyone else.  A two-tier scheme is necessary, since the BPDU in the classic version is sent only by the root switch. <br><br>  In the case of RSTP, the change in the topology is considered only the transition of the port to the transfer mode.  Moreover, the ports that are not border (non-edge port) are taken into account.  This is logical, since the transition of the port to the locked state automatically makes the MAC addresses behind it no longer available.  As soon as a topology change is detected, the switch sends out all ports (root and assigned) BPDUs with the TC flag.  This message quickly spreads over the network.  Having received it, the switches remove from the table all MAC addresses accessible through non-edge ports, except where the BPDU was received with the TC flag. <br><br>  Edge port never causes changes in the topology, and for such a port, MAC addresses are not reset in case of receiving a BPDU with the TC flag. <br></li></ol><br>  <b>Why does RSTP sometimes ‚Äúslow down‚Äù and switch the port to the traffic transfer mode only after several tens of seconds?</b> <br><br>  RSTP uses ordinary timers in its work in the following cases: <br><br><ul><li>  A device that only supports classic STP is connected to the port.  In this case, the switch port from RSTP mode switches to STP mode.  It means that it passes all the standard STP stages: Blocking, Listening, Learning, Forwarding (depending on what values ‚Äã‚Äãof the root switch and the cost BPDU will be received). <br><br></li><li>  The switch identified the connection as shared.  In this case, standard RSTP timers are used.  Since two or more switches are connected to this port, it is impossible to use the Proposal / Agreement mechanism. <br><br></li><li>  A device that does not participate in STP is connected, and the port does not have an edge type.  In this case, the port will pass the following RSTP stages: Discarding (15 seconds), Learning (15 seconds), Forwarding.  Thus, it will go into transfer mode only after 30 seconds. </li></ul><br>  <b>Why is setting the port type Edge more important for RSTP than for STP?</b> <br><br>  The division into ports Edge and non-Edge is typical not only for RSTP, but also for STP.  But in the case of STP, this is a vendor refinement of the protocol, rather than the requirements of the standard. <br><br>  The main ‚ÄúFOR‚Äù switches on the Edge mode port (for Cisco equipment is portfast) in the case of using the STP protocol: <br><br><ul><li>  Fast port switching to transfer mode (Forwarding).  The port in this case does not pass the standard stages on the basis of timers.  This is important if conventional equipment is connected to such a port.  For example, server or PC. </li><li>  There is no decrease in the aging time of the MAC addresses behind such a port when receiving a TCN message.  So, there is less likelihood of packet flushing for hosts that listen more than they send something. </li></ul><br>  For RSTP, in addition to the above points, there is one more characteristic only for this protocol: <br><br><ul><li>  When the Proposal / Agreement mechanism is triggered, all non-edge ports are blocked.  This means that if we do not configure the normal port where the terminal equipment is connected to in Edge mode, the switch will turn it off for 30 seconds (RSTP timer operation) every time the root port changes.  In simple networks this does not happen often.  But in relatively large.  This is exactly the case when it seems that the rebuilds will occur on the network quickly enough, and no one will even notice.  And in fact, the device "fall off" from the network for half a minute. </li></ul><br>  Thus, we can conclude: for RSTP, the lack of Edge-port configuration is more critical than for classic STP. <br><br><div class="spoiler">  <b class="spoiler_title">Note</b> <div class="spoiler_text"> With the setting of the port in Edge mode, you need to be careful. <br><br>  Let's take a look at the behavior of a Cisco switch with a port in portfast (Edge) mode.  The port immediately goes into transfer mode.  But he continues to participate in the transmission of BPDUs and most importantly continues to listen to the network for the presence of BPDUs from other devices, in case another switch is connected to it by mistake.  If BPDU comes suddenly, the port loses its portfast state and goes through standard RSTP phases.  So what could be the problem? <br><br>  BPDUs are sent from 0 to 2 seconds after the port is turned on.  Plus, you can add to this the distribution time of BPDUs over the network (relevant for STP).  Therefore, within a few seconds, there may be a loop in the network.  If there is a lot of traffic, these seconds may be enough for the broadcast storm generated by the loop to ‚Äúkill‚Äù the control-plane of our switch.  To prevent this, it is recommended that portfast be configured in conjunction with additional technologies, for example: BPDU Guard and storm-control. <br></div></div><br>  <b>If the network is multi-vendor, and some of the equipment does not support STP in any way at all, everything will be bad?</b> <br><br>  <i>This question is not entirely related to the work of RSTP, but still I decided to turn it on.</i>  <i>Oddly enough, such questions periodically arise from our customers.</i>  <i>Therefore, it makes sense to dwell on it.</i> <br><br>  If the switch does not support STP in any way, what will it do with BPDU packets?  The answer is simple - send such packets through all ports.  As the MAC destination address of the BPDU packet, the STP and RSTP set the address 0180.C200.0000, which is the multicast address.  This BPDU packet is transmitted within VLAN 1. <br><br><div class="spoiler">  <b class="spoiler_title">Note</b> <div class="spoiler_text">  The MST protocol packs data about all topologies into one BPDU (by the way, this is why the maximum number of instances for MST is 64).  The default MAC address is 0180.C200.0000. <br><br>  The PVST + and PVRST + protocols use two types of BPDUs in their work: <br><br><ul><li>  IEEE-formatted BPDU for compatibility with other versions of STP, contains STP topology data for VLAN 1. The standard MAC address 0180.C200.0000 is used as the destination address. </li><li>  PVST + BPDUs that contain STP topology data for different VLANs.  The destination address is the MAC address 0100.0CCC.CCCD. </li></ul></div></div><br>  Another interesting moment is connected with the fact that even if we exclude VLAN 1 from the trunk between the switches, the BPDU for the first VLAN will still be transmitted. <br><br>  As a result, if in our topology there is a switch that does not support STP, it will look for the STP topology as a normal communication channel. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/web/aad/0a9/a52/aad0a9a520d243ebab0d3ad3b80cb2bb.png"></div><br>  And what happens if you connect the two ports to each other on switch SW1 (i.e., make a ring).  Will our network die?  There is a big chance that not.  In this case, Root SW will receive its own BPDU on the same port from which it was sent.  After that, he will immediately block it.  And the loop will remain ‚Äúlive‚Äù only within the SW1 switch.  But a positive outcome is possible only if Root SW does not ‚Äúchoke‚Äù ahead of time from a broadcasting storm caused by a loop on SW1.  Therefore, it is better not to use switches that do not support STP in the network. <br><br>  <b>Do I need STP / RSTP / MST / ... on the network if there are no loops?</b> <br><br>  Of course.  If there is no loop now, it‚Äôs not a fact that it will not appear in the future.  For example, due to a simple human error, when one access-port of the switch connects to another access-port of the same device. <br><br>  This FAQ does not claim to be complete.  It is more of an introductory nature and sets a certain vector of further research on a particular issue related to the work of modern protocols of the STP family. </div><p>Source: <a href="https://habr.com/ru/post/330358/">https://habr.com/ru/post/330358/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../330348/index.html">Ask a question to Mail.Ru Group cloud service developers</a></li>
<li><a href="../330350/index.html">Five steps to save the Linux server that crashed</a></li>
<li><a href="../330352/index.html">We provide the PVS-Studio analyzer to security experts</a></li>
<li><a href="../330354/index.html">Video: indie developers about failure, success and monetization</a></li>
<li><a href="../330356/index.html">Chromium based browsers - now also in ReactOS</a></li>
<li><a href="../330360/index.html">Freeswitch Phonebook</a></li>
<li><a href="../330362/index.html">Mikrotik. QoS for home</a></li>
<li><a href="../330364/index.html">On the road with clouds. Relational databases in a new technological context</a></li>
<li><a href="../330366/index.html">We are building the development process and the CI pipeline, or How can a developer become DevOps for QA</a></li>
<li><a href="../330368/index.html">‚ÄúBreak the vote on RHS ++‚Äù. Give us 1,000,000 RPS</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>