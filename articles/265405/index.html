<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Android client application architecture</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Client-server applications are the most common and at the same time the most difficult to develop. Problems arise at any stage, from choosing the mean...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Android client application architecture</h1><div class="post__text post__text-html js-mediator-article">  Client-server applications are the most common and at the same time the most difficult to develop.  Problems arise at any stage, from choosing the means to execute queries to caching methods for the result.  If you want to learn how you can competently organize a complex architecture that will ensure the stable operation of your application, I ask for cat. <br><br><img src="https://habrastorage.org/files/7c9/53f/134/7c953f134ac648bcb82ff9e553f4ed03.png"><br><a name="habracut"></a><br>  Of course, now it is not 2010, when the developers had to use the <a href="https://docs.google.com/a/dz.ru/file/d/0B2dn_3573C3RdlVpU2JBWXdSb3c/edit">famous A / B / C patterns</a> or even run AsyncTask in general <s>and beat the tambourines a lot</s> .  There are a large number of different libraries that allow you to effortlessly fulfill requests, including asynchronously.  These libraries are very interesting, and we should also start by choosing the right one.  But first, let's remember a little bit what we already have. <br><br>  Previously, in Android, the only available tool for performing network requests was the Apache client, which is actually far from ideal, and it‚Äôs not for nothing that Google is now trying hard to get rid of it in new applications.  Later, the fruit of the efforts of Google developers was the HttpUrlConnection class.  He corrected the situation not much.  There was still not enough ability to perform asynchronous requests, although the HttpUrlConnection + Loaders model is already more or less operational. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      2013 has become very effective in this regard.  There were wonderful libraries Volley and Retrofit.  Volley is a more general library for networking, while Retrofit is specifically designed for working with REST Api.  And it was the last library that became the generally accepted standard in the development of client-server applications. <br><br>  In Retrofit, in comparison with other means, there are several main advantages: <br>  1) An extremely convenient and simple interface that provides full functionality for performing any queries; <br>  2) Flexible configuration - you can use any client to fulfill the request, any library for parsing json, etc .; <br>  3) No need to independently perform parsing json-a - this work is performed by the Gson library (and <a href="">not only Gson</a> ); <br>  4) Convenient processing of results and errors; <br>  5) Rx support, which is also an important factor today. <br><br>  If you are not familiar with the Retrofit library, it's time <a href="http://square.github.io/retrofit/">to explore it</a> .  But in any case, I will make a small introduction, and at the same time we will consider a little new features of version 2.0.0 (I also advise you to watch the <a href="http-with-retrofit-2-droidcon-nyc-2015">presentation on Retrofit 2.0.0</a> ). <br><br>  As an example, I chose the <a href="https://support.travelpayouts.com/hc/ru/articles/203956153-API-%25D0%25B4%25D0%25BB%25D1%258F-%25D0%25B8%25D1%2581%25D0%25BF%25D0%25BE%25D0%25BB%25D1%258C%25D0%25B7%25D0%25BE%25D0%25B2%25D0%25B0%25D0%25BD%25D0%25B8%25D1%258F-%25D0%25B2-%25D0%25BC%25D0%25BE%25D0%25B1%25D0%25B8%25D0%25BB%25D1%258C%25D0%25BD%25D1%258B%25D1%2585-%25D0%25BF%25D1%2580%25D0%25B8%25D0%25BB%25D0%25BE%25D0%25B6%25D0%25B5%25D0%25BD%25D0%25B8%25D1%258F%25D1%2585">API for airports</a> for its maximum simplicity.  And we solve the most trivial task - getting a list of nearby airports. <br><br>  First of all, we need to connect all the selected libraries and the required dependencies for Retrofit: <br><pre><code class="java hljs">compile <span class="hljs-string"><span class="hljs-string">'com.squareup.retrofit:retrofit:2.0.0-beta1'</span></span> compile <span class="hljs-string"><span class="hljs-string">'com.squareup.retrofit:converter-gson:2.0.0-beta1'</span></span> compile <span class="hljs-string"><span class="hljs-string">'com.squareup.okhttp:okhttp:2.0.0'</span></span></code> </pre> <br>  We will receive airports in the form of a list of objects of a particular class. <div class="spoiler">  <b class="spoiler_title">Therefore, this class must be created</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Airport</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@SerializedName</span></span>(<span class="hljs-string"><span class="hljs-string">"iata"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String mIata; <span class="hljs-meta"><span class="hljs-meta">@SerializedName</span></span>(<span class="hljs-string"><span class="hljs-string">"name"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String mName; <span class="hljs-meta"><span class="hljs-meta">@SerializedName</span></span>(<span class="hljs-string"><span class="hljs-string">"airport_name"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String mAirportName; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Airport</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ } }</code> </pre><br></div></div><br>  We create a service for requests: <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AirportsService</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@GET</span></span>(<span class="hljs-string"><span class="hljs-string">"/places/coords_to_places_ru.json"</span></span>) Call&lt;List&lt;Airport&gt;&gt; airports(<span class="hljs-meta"><span class="hljs-meta">@Query</span></span>(<span class="hljs-string"><span class="hljs-string">"coords"</span></span>) String gps); }</code> </pre><br>  <i>Note about Retrofit 2.0.0</i> <br>  Previously, to perform synchronous and asynchronous queries, we had to write different methods.  Now when you try to create a service that contains a void method, you will get an error.  In Retrofit 2.0.0, the Call interface encapsulates requests and allows them to be executed synchronously or asynchronously. <br><div class="spoiler">  <b class="spoiler_title">Earlier</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AirportsService</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@GET</span></span>(<span class="hljs-string"><span class="hljs-string">"/places/coords_to_places_ru.json"</span></span>) <span class="hljs-function"><span class="hljs-function">List&lt;Airport&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">airports</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(@Query(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"coords"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> String gps)</span></span>; <span class="hljs-meta"><span class="hljs-meta">@GET</span></span>(<span class="hljs-string"><span class="hljs-string">"/places/coords_to_places_ru.json"</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">airports</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(@Query(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"coords"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> String gps, Callback&lt;List&lt;Airport&gt;&gt; callback)</span></span>; }</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Now</b> <div class="spoiler_text"><pre> <code class="java hljs">AirportsService service = ApiFactory.getAirportsService(); Call&lt;List&lt;Airport&gt;&gt; call = service.airports(<span class="hljs-string"><span class="hljs-string">"55.749792,37.6324949"</span></span>); <span class="hljs-comment"><span class="hljs-comment">//sync request call.execute(); //async request Callback&lt;List&lt;Airport&gt;&gt; callback = new RetrofitCallback&lt;List&lt;Airport&gt;&gt;() { @Override public void onResponse(Response&lt;List&lt;Airport&gt;&gt; response) { super.onResponse(response); } }; call.enqueue(callback);</span></span></code> </pre><br></div></div><br>  Now create auxiliary methods: <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ApiFactory</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> CONNECT_TIMEOUT = <span class="hljs-number"><span class="hljs-number">15</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> WRITE_TIMEOUT = <span class="hljs-number"><span class="hljs-number">60</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> TIMEOUT = <span class="hljs-number"><span class="hljs-number">60</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> OkHttpClient CLIENT = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> OkHttpClient(); <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> { CLIENT.setConnectTimeout(CONNECT_TIMEOUT, TimeUnit.SECONDS); CLIENT.setWriteTimeout(WRITE_TIMEOUT, TimeUnit.SECONDS); CLIENT.setReadTimeout(TIMEOUT, TimeUnit.SECONDS); } <span class="hljs-meta"><span class="hljs-meta">@NonNull</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> AirportsService </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getAirportsService</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> getRetrofit().create(AirportsService.class); } <span class="hljs-meta"><span class="hljs-meta">@NonNull</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> Retrofit </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getRetrofit</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Retrofit.Builder() .baseUrl(BuildConfig.API_ENDPOINT) .addConverterFactory(GsonConverterFactory.create()) .client(CLIENT) .build(); } }</code> </pre><br>  Fine!  Preparation is complete, and now we can execute the query: <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MainActivity</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AppCompatActivity</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Callback</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">List</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Airport</span></span></span><span class="hljs-class">&gt;&gt; </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onCreate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Bundle savedInstanceState)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.onCreate(savedInstanceState); setContentView(R.layout.activity_main); AirportsService service = ApiFactory.getAirportsService(); Call&lt;List&lt;Airport&gt;&gt; call = service.airports(<span class="hljs-string"><span class="hljs-string">"55.749792,37.6324949"</span></span>); call.enqueue(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onResponse</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Response&lt;List&lt;Airport&gt;&gt; response)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (response.isSuccess()) { List&lt;Airport&gt; airports = response.body(); <span class="hljs-comment"><span class="hljs-comment">//do something here } } @Override public void onFailure(Throwable t) { } }</span></span></code> </pre><br>  Everything seems very simple.  We effortlessly created the necessary classes, and we can already make requests, get results and handle errors, and all this in literally 10 minutes.  What else is needed? <br><br>  However, this approach is fundamentally wrong.  What happens if, during the execution of the request, the user turns the device or closes the application altogether?  With confidence we can only say that the desired result is not guaranteed to you, and we are not far from the initial problems.  Yes, and requests for activations and fragments do not add beauty to your code.  Therefore, it is time to finally return to the main topic of the article - building the architecture of a client-server application. <br><br>  In this situation, we have several options.  You can use any library that provides competent work with multithreading.  The Rx framework is perfect here, especially as Retrofit supports it.  However, building an architecture with Rx or even just using functional reactive programming is not a trivial task.  We will go in a simpler way: we will use the tools that Android offers us out of the box.  Namely, loaders. <br><br>  Loaders appeared in API version 11 and still remain a very powerful tool for parallel query execution.  Of course, you can do anything at all in loaders, but usually they are used either to read data from the database or to perform network requests.  And the most important advantage of loaders is that through the LoaderManager class they are linked to the Activity and Fragment life cycle.  This allows you to use them without fear that the data will be lost when the application is closed or the result returns to the wrong callback. <br><br>  Typically, a loader model involves the following steps: <br>  1) Execute the query and get the result; <br>  2) Somehow we cache the result (most often in the database); <br>  3) Return the result to an Activity or Fragment. <br><br>  <i>Note</i> <br>  Such a model is good because Activity or Fragment do not think exactly how the data is obtained.  For example, an error may be returned from the server, but the loader will return cached data. <br><br>  Let's implement such a model.  I omit the details of how work with the database is implemented, if necessary, you can see an example on Github (link at the end of the article).  Here, too, many variations are possible, and I will consider them in turn, all their advantages and disadvantages, until I finally get to the model that I consider optimal. <br><br>  <i>Note</i> <br>  All loaders must work with a universal data type so that you can use the LoaderCallbacks interface in the same activation or snippet for different types of loaded data.  The first such type that comes to mind is Cursor. <br><br>  <i>One more note</i> <br>  All models related to loaders have a small drawback: for each request a separate loader is needed.  This means that when changing the architecture or, for example, switching to another database, we will encounter a great refactoring, which is not too good.  To get around this problem as much as possible, I will use the base class for all loaders, and it is in it that all the common logic is stored. <br><br><h4>  Loader + ContentProvider + asynchronous requests </h4><br>  Preconditions: there are classes for working with a SQLite database through ContentProvider, it is possible to save entities to this database. <br><br>  In the context of this model, it is extremely difficult to put some kind of common logic into the base class, so in this case it is just a loader, from which it is convenient to be inherited to make asynchronous requests.  Its content is not directly related to the architecture in question, so it is in the spoiler.  However, you can also use it in your applications: <br><div class="spoiler">  <b class="spoiler_title">Baseloader</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BaseLoader</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Loader</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Cursor</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Cursor mCursor; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">BaseLoader</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Context context)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(context); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">deliverResult</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Cursor cursor)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (isReset()) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cursor != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { cursor.close(); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } Cursor oldCursor = mCursor; mCursor = cursor; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (isStarted()) { <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.deliverResult(cursor); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (oldCursor != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> &amp;&amp; oldCursor != cursor &amp;&amp; !oldCursor.isClosed()) { oldCursor.close(); } } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onStartLoading</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mCursor != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { deliverResult(mCursor); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { forceLoad(); } } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onReset</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mCursor != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> &amp;&amp; !mCursor.isClosed()) { mCursor.close(); } mCursor = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; } }</code> </pre><br></div></div><br>  Then the loader for loading airports might look like this: <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AirportsLoader</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BaseLoader</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String mGps; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> AirportsService mAirportsService; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AirportsLoader</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Context context, String gps)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(context); mGps = gps; mAirportsService = ApiFactory.getAirportsService(); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onForceLoad</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ Call&lt;List&lt;Airport&gt;&gt; call = mAirportsService.airports(mGps); call.enqueue(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RetrofitCallback&lt;List&lt;Airport&gt;&gt;() { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onResponse</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Response&lt;List&lt;Airport&gt;&gt; response)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (response.isSuccess()) { AirportsTable.clear(getContext()); AirportsTable.save(getContext(), response.body()); Cursor cursor = getContext().getContentResolver().query(AirportsTable.URI, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); deliverResult(cursor); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { deliverResult(<span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); } } }); } }</code> </pre><br>  And now we can finally use it in UI classes: <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MainActivity</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AppCompatActivity</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">LoaderManager</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">LoaderCallbacks</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Cursor</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onCreate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Bundle savedInstanceState)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.onCreate(savedInstanceState); setContentView(R.layout.activity_main); getLoaderManager().initLoader(R.id.airports_loader, Bundle.EMPTY, <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Loader&lt;Cursor&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onCreateLoader</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> id, Bundle args)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (id) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> R.id.airports_loader: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AirportsLoader(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, <span class="hljs-string"><span class="hljs-string">"55.749792,37.6324949"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; } } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onLoadFinished</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Loader&lt;Cursor&gt; loader, Cursor data)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> id = loader.getId(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (id == R.id.airports_loader) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (data != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> &amp;&amp; data.moveToFirst()) { List&lt;Airport&gt; airports = AirportsTable.listFromCursor(data); <span class="hljs-comment"><span class="hljs-comment">//do something here } } getLoaderManager().destroyLoader(id); } @Override public void onLoaderReset(Loader&lt;Cursor&gt; loader) { } }</span></span></code> </pre><br>  As you can see, there is nothing complicated.  This is absolutely standard work with loaders.  In my opinion, loaders provide an ideal level of abstraction.  We load the necessary data, but without the extra knowledge about how they are loaded. <br><br>  This model is stable, convenient enough to use, but still has drawbacks: <br>  1) Each new loader contains its own logic for working with the result.  This deficiency can be corrected, and in part we will do it in the next model and completely in the last one. <br>  2) The second drawback is much more serious: all database operations are performed in the main application thread, and this can lead to various negative consequences, even before the application is stopped with a very large amount of data stored.  And in the end, we use loaders.  Let's do everything asynchronously! <br><br><h4>  Loader + ContentProvider + synchronous requests </h4><br>  The question is, why did we execute the request asynchronously using Retrofit, when loaders and so allow us to work in the background?  Fix it. <br><br>  This model is simplified, but the main difference is that the asynchrony of the request is achieved by loaders, and work with the database is not happening in the main thread.  The heirs of the base class should only return us an object of type Cursor.  Now the base class might look like this: <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BaseLoader</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AsyncTaskLoader</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Cursor</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">BaseLoader</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Context context)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(context); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onStartLoading</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.onStartLoading(); forceLoad(); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Cursor </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">loadInBackground</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> apiCall(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (IOException e) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">abstract</span></span></span><span class="hljs-function"> Cursor </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">apiCall</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IOException</span></span>; }</code> </pre><br>  And then the implementation of an abstract method might look like this: <br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> Cursor </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">apiCall</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IOException </span></span>{ AirportsService service = ApiFactory.getAirportsService(); Call&lt;List&lt;Airport&gt;&gt; call = service.airports(mGps); List&lt;Airport&gt; airports = call.execute().body(); AirportsTable.save(getContext(), airports); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> getContext().getContentResolver().query(AirportsTable.URI, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); }</code> </pre><br>  Work with the loader in the UI has not changed at all. <br><br>  In fact, this model is a modification of the previous one, it partially eliminates its disadvantages.  But in my opinion, this is still not enough.  Here you can again highlight the shortcomings: <br>  1) Each loader has an individual data storage logic. <br>  2) Only work with SQLite database is possible. <br><br>  And finally, let's completely eliminate these shortcomings and get a universal and almost perfect model! <br><br><h4>  Loader + any data storage + synchronous requests </h4><br>  Before reviewing specific models, I said that for loaders, we must use a single data type.  Besides Cursor, nothing comes to mind.  So let's create this type!  What should be in it?  Naturally, it should not be a generic type (otherwise we will not be able to use loader callbacks for different data types in the same activation / fragment), but at the same time it should be a container for an object of any type.  And here I see the only weak point in this model - we have to use the Object type and perform unchecked transformations.  But still, this is not a significant minus.  The final version of this type is as follows: <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Response</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Nullable</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Object mAnswer; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> RequestResult mRequestResult; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Response</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ mRequestResult = RequestResult.ERROR; } <span class="hljs-meta"><span class="hljs-meta">@NonNull</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> RequestResult </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getRequestResult</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> mRequestResult; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Response </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setRequestResult</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(RequestResult requestResult)</span></span></span><span class="hljs-function"> </span></span>{ mRequestResult = requestResult; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; } <span class="hljs-meta"><span class="hljs-meta">@Nullable</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> &lt;T&gt; <span class="hljs-function"><span class="hljs-function">T </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getTypedAnswer</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mAnswer == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; } <span class="hljs-comment"><span class="hljs-comment">//noinspection unchecked return (T) mAnswer; } public Response setAnswer(@Nullable Object answer) { mAnswer = answer; return this; } public void save(Context context) { } }</span></span></code> </pre><br>  This type can store the result of the query.  If we want to do something for a specific request, we need to inherit from this class and override / add the necessary methods.  For example: <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AirportsResponse</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Response</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">save</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Context context)</span></span></span><span class="hljs-function"> </span></span>{ List&lt;Airport&gt; airports = getTypedAnswer(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (airports != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { AirportsTable.save(context, airports); } } }</code> </pre><br>  Fine!  Now let's write the base class for loaders: <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BaseLoader</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AsyncTaskLoader</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Response</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">BaseLoader</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Context context)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(context); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onStartLoading</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.onStartLoading(); forceLoad(); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Response </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">loadInBackground</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { Response response = apiCall(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (response.getRequestResult() == RequestResult.SUCCESS) { response.save(getContext()); onSuccess(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { onError(); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> response; } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (IOException e) { onError(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Response(); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onSuccess</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onError</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">abstract</span></span></span><span class="hljs-function"> Response </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">apiCall</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IOException</span></span>; }</code> </pre><br>  This loader class is the ultimate goal of this article and, in my opinion, an excellent, workable and expandable model.  Want to upgrade from SQLite to Realm, for example?  No problem.  Consider this as the next example.  Loader classes will not change, only the model that you would edit anyway will change.  Failed to complete the request?  Not a problem, modify the apiCall method in the heir.  Want to clear the database on error?  Override onError and run ‚Äî this method runs in the background thread. <br><br>  And any particular loader can be represented as follows (again, I will show only the implementation of the abstract method): <br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> Response </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">apiCall</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IOException </span></span>{ AirportsService service = ApiFactory.getAirportsService(); Call&lt;List&lt;Airport&gt;&gt; call = service.airports(mGps); List&lt;Airport&gt; airports = call.execute().body(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AirportsResponse() .setRequestResult(RequestResult.SUCCESS) .setAnswer(airports); }</code> </pre><br>  <i>Note</i> <br>  If the request is unsuccessful, Exception will be thrown, and we will get into the catch branch of the base loader. <br><br>  As a result, we obtained the following results: <br>  1) Each loader depends solely on its query (on the parameters and the result), but at the same time it does not know what it does with the received data.  That is, it will change only when the parameters of a particular query change. <br>  2) The basic loader controls all the logic of query execution and work with the results. <br>  3) Moreover, the model classes themselves also have no idea how the work with the database is organized, and so on.  All this is carried out in separate classes / methods.  I did not indicate this anywhere explicitly, but this can be seen in the example on Github - the link at the end of the article. <br><br><h4>  Instead of conclusion </h4><br>  Slightly above, I promised to show one more example - switching from SQLite to Realm - and make sure that we really do not touch the loaders.  Let's do that.  In fact, the code here is quite a bit, because the work with the base is now performed in only one method (I do not take into account changes related to the specifics of Realm, and they are, in particular, the rules for naming fields and working with Gson; can be viewed on Github). <br><br>  Connect the Realm: <br><pre> <code class="java hljs">compile <span class="hljs-string"><span class="hljs-string">'io.realm:realm-android:0.82.1'</span></span></code> </pre><br>  And change the save method in AirportsResponse: <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AirportsResponse</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Response</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">save</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Context context)</span></span></span><span class="hljs-function"> </span></span>{ List&lt;Airport&gt; airports = getTypedAnswer(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (airports != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { AirportsHelper.save(Realm.getInstance(context), airports); } } }</code> </pre><br><div class="spoiler">  <b class="spoiler_title">AirportsHelper</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AirportsHelper</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">save</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(@NonNull Realm realm, List&lt;Airport&gt; airports)</span></span></span><span class="hljs-function"> </span></span>{ realm.beginTransaction(); realm.clear(Airport.class); realm.copyToRealm(airports); realm.commitTransaction(); } <span class="hljs-meta"><span class="hljs-meta">@NonNull</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> List&lt;Airport&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getAirports</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(@NonNull Realm realm)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> realm.allObjects(Airport.class); } }</code> </pre><br></div></div><br>  That's all!  We in an elementary way, without affecting classes that contain other logic, have changed the way data is stored. <br><br><h4>  Still, the conclusion </h4><br>  I want to single out one rather important point: we did not consider issues related to the use of cached data, that is, in the absence of the Internet.  However, the strategy for using cached data in each application is individual, and I do not consider it necessary to impose any particular approach.  <s>And so the article stretched out.</s> <br><br>  As a result, we reviewed the main issues of organizing the architecture of client-server applications, and I hope that this article has helped you learn something new and that you will use any of these models in your projects.  In addition, if you have your own ideas on how to organize such an architecture, write, I will be happy to discuss. <br><br>  Thank you for reading to the end.  Successful development! <br><br>  PS <a href="https://github.com/ArturVasilov/RetrofitLoadersSample">Promised link to GitHub code.</a> </div><p>Source: <a href="https://habr.com/ru/post/265405/">https://habr.com/ru/post/265405/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../265395/index.html">Development of browser online games on meteor</a></li>
<li><a href="../265397/index.html">RailsClub 2015: Interview with Sam Pippen</a></li>
<li><a href="../265399/index.html">Riak and Riak Search Yokozuna: First acquaintance</a></li>
<li><a href="../265401/index.html">Scaling up to 24 controllers in the new ETERNUS DX storage system</a></li>
<li><a href="../265403/index.html">Autumn online courses from Computer Science Center and Academic University</a></li>
<li><a href="../265409/index.html">How to create interactive tabs in an email</a></li>
<li><a href="../265411/index.html">Vscale: create the first server</a></li>
<li><a href="../265413/index.html">LinuxONE: IBM mainframe that works only with Linux. Project details</a></li>
<li><a href="../265415/index.html">REG.RU introduces the verification and treatment of sites for viruses and threats with the help of Virusday.Server</a></li>
<li><a href="../265417/index.html">VAD (Voice Application Designer). Part 1 Review</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>