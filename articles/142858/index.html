<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>SysAdmin Anywhere: Using UDP Hole Punching to implement remote desktop</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introduction 
 System administrators are by nature lazy people. They do not like to do the same thing a hundred times. They want to automate everythin...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>SysAdmin Anywhere: Using UDP Hole Punching to implement remote desktop</h1><div class="post__text post__text-html js-mediator-article"><h4>  Introduction </h4><br><img align="left" src="https://habrastorage.org/storage2/fd5/cef/c8e/fd5cefc8e567f4f5a177d0575c8a1d1e.jpg">  System administrators are by nature lazy people.  They do not like to do the same thing a hundred times.  They want to automate everything so that it works with minimal intervention.  And I am. <br><br>  In order to make life easier for me and those like me, a program was created that combined disparate administration tools into one product with the simple name <a href="http://ria-media.net/products/sysadmin.aspx">SysAdmin</a> .  It includes multi-domain network support, reports, inventory, and many other useful things that are scattered across different MMCs or are included in third-party products.  Work has become much more convenient.  This program has already grown to version 5.3, changed the interface to Metro-style.  But, unfortunately, it is not possible to administer computers that are not included in the domain. <br><br>  However, I wanted more: <br><a name="habracut"></a><br><ul><li>  Fully administer remote computers; </li><li>  Configure access without personal presence on the remote side and without a qualified employee from the remote side; </li><li>  Do not open ports on the router; </li><li>  If it is impossible for personal presence to not open access to the router from the Internet; </li><li>  Do not complicate the technical solution if you need to have access to more than one computer on a remote network: </li><li>  Do not open ports on the router for each computer; </li><li>  Do not open access on the router to the server, and from there to computers (There is not always a need for a server, and introducing it as a means for remote access is not economically feasible); </li><li>  Do not open one port and every time do not reconfigure the router to access another computer; </li><li>  Do not raise VPN. </li></ul>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/storage2/a02/31f/aff/a0231faff267154d36e3b220e44531b4.png"><br><br><blockquote>  <b>From experience:</b> <br>  At work, it was necessary to create a VPN-network with regional offices located throughout the country.  In the central office was installed powerful VPN-equipment, and on-site equipment was planned by the same company, but simpler.  It was necessary to find out everything about their Internet connection, local network, installed equipment, etc.  Prepare the VPN equipment and send it to them so that they connect it and it all works.  The piquancy of the situation consisted in the fact that this was actually to be done to me alone, business trips were not provided for, and the level of users in the field was very diverse.  Of course, everything was implemented, but it took a lot of time for correspondence and telephone conversations. </blockquote><br><br>  Because of the limitations previously listed, an intermediary was needed for implementation.  The client part is installed on the remote computer, which creates a connection with an intermediary that is not blocked by firewalls, since  it is initiated by the most distant machine.  It is enough for an administrator to know only the address of the intermediary in order to connect to him to gain access to remote computers.  Thanks to such an intermediary, we get a number of advantages: <br><br><ul><li>  No need to open ports on the router.  Security increases, the level of necessary user qualifications decreases; </li><li>  The administrator has access to the control panel located in the cloud through a browser that supports Microsoft Silverlight through a secure connection; </li><li>  Commands from the administrator using the cloud service are sent to the remote computer.  The response is transmitted to the administrator in a similar way; </li><li>  The remote computer is online, so there is no need for the presence of the user; </li><li>  Additional services (inventory, service desk, reports, license accounting, archiving, monitoring, etc.) with data storage in the cloud and access to them, even if the remote computer is not connected to the Internet; </li><li>  Remote Desktop (VNC); </li><li>  Access from a mobile phone to Windows Phone. </li></ul><br><br><img src="https://habrastorage.org/storage2/ffc/b4b/578/ffcb4b578a07b7f192052940467649b7.png"><br><br>  The platform for the mediator did not have to look long.  Microsoft Azure, by the way, was suitable for this.  Moreover, it was possible to get 30 days access for experiments. <br><br>  It so happened that by this time I had changed my line of business from system administration to programming, so I decided to create the service myself. <br>  My colleague joined me, and together we began to develop a prototype service.  We faced the task during the test period to create a workable model of the interaction of a remote client with a cloud service.  Further development could be continued using the Azure SDK. <br><br><img src="https://habrastorage.org/storage2/d21/7e0/e03/d217e0e03887312a6f1d0574b2162503.png"><br><br>  The hardest thing was to organize a permanent connection of a remote computer with a cloud service.  As a result of long and tedious experiments (deploying to the cloud takes a significant amount of time), a working solution appeared that gave confidence in achieving this goal. <br><br>  We were able to connect the remote computer with the cloud, without setting anything up from the network equipment.  For us, this was a breakthrough. <br><br>  Now there was a task to transfer the command from the administrator to the cloud, and then to the computer and get an answer from it.  We settled on the fact that a universal solution would be to use WMI.  Moreover, the cloud service should not know anything about WMI.  His task is to forward.  This was conceived so that, as rarely as possible, you had to update the cloud service itself and client software on remote computers (it is now being updated to the latest version by clicking a button in the console). <br><br><blockquote>  <b>Example:</b> <br>  A request is sent from the administrator to get a list of installed services (Select * From Win32_Service) plus a set of fields whose values ‚Äã‚Äãwe need.  All this is serialized by JSON, packaged, encrypted and transmitted to the cloud.  In the cloud, data is written to a queue and then taken from it by the service instance to which the remote computer is connected. <br>  The client, having received the request, executes it.  The result is serialized by JSON, packaged, encrypted and transmitted in reverse order to the administrator. </blockquote><br><br>  The use of WMI is not limited to just a request; a call to functions and procedures is implemented.  For example, any of the services can be stopped. <br><br><img src="https://habrastorage.org/storage2/72e/cc8/1b7/72ecc81b7475ae259e6a1e232821ef7d.png"><br><br>  It would seem that everything is simple, but do not forget that if we are planning to make a scalable solution, we cannot do without working with several instances of our service in the cloud.  Working with them requires some revision of their development experience.  You should always keep in mind that there is not one copy, but several, and they work in parallel.  Want to do something exclusively - do not forget to notify the rest of the copies.  For example, billing.  It will be extremely unpleasant when each copy goes through the database and recounts the client‚Äôs balance, reducing it each time.  This option is shown as an example of what might happen, although we are currently working to eliminate this problem in the future. <br><br><img src="https://habrastorage.org/storage2/51e/655/bb7/51e655bb77e49b33282078c9254e2023.png"><br><br>  Creating the service, we proceeded from the fact that in most cases it is not necessary to have access to the remote desktop.  Enough direct management of processes, services, etc.  This is faster and easier to do through the web interface. <br><br><img src="https://habrastorage.org/storage2/fea/d98/38e/fead9838e836961f5b537f85ee85a0dd.png"><br><br>  Nevertheless, the remote desktop is very popular and its implementation requires a direct connection between computers.  Transmitting this amount of information through the cloud is not rational, as the delay in updating the screen can reach several seconds. <br><br><h4>  Implement UDP Hole Punching </h4><br>  The most interesting task turned out to be the implementation of a remote desktop access system.  To save time, it was decided to take a ready-made implementation of VNC, which, however, caused its own problems: it was impossible to connect the client and the VNC server directly.  The only solution was the creation of intermediaries whose task is to relay traffic.  Thus, the VNC client and server will ‚Äúthink‚Äù that they are working locally, when in fact all the traffic between them will be transmitted via the Internet. <br><br><img src="https://habrastorage.org/storage2/7f8/bc2/161/7f8bc2161df1bf360d2e753b29743662.png"><br><br><h5>  NAT Travesal </h5><br>  The question remains: how to transfer information between intermediaries?  The first option that comes to mind - to drive everything through the cloud - is an expensive and inefficient way.  It is much better to connect everything directly.  This is where we come up against the standard NAT Traversal problem. <br><br><img src="https://habrastorage.org/storage2/761/3e5/0ac/7613e50ac04f5b4993b0a9a9dbe2b9d2.png"><br><br>  Network Address Translation (NAT) makes it impossible to establish a direct connection between clients.  <a href="http://ru.wikibooks.org/wiki/%25D0%259F%25D0%25BE%25D1%2580%25D1%2582/NAT">NAT</a> is the process of translating local addresses that are not accessible from the Internet to external ones.  To bypass NAT, there are several standard methods: open the port, raise the VPN. <br><br>  Unfortunately, none of them suits us, because  immediately complicates the installation of all necessary components (and we want the client installation on the working machine to be available to the least advanced users without the help of the administrator).  Therefore, we use the UDP Hole Punching mechanism. <br><br><h5>  UDP Hole Punching </h5><br>  UDP hole punching is a method for directly connecting two computers that are behind NATs.  To initiate a connection, a third party is required ‚Äî a server that is visible to both computers.  Commonly used public <a href="http://ru.wikipedia.org/wiki/STUN">STUN</a> servers. <br><br>  So, our task is to directly connect the client on the remote machine and the console.  To do this, you need to take a few steps: <br><br><ul><li>  Find out the external IP and port of the remote machine.  To do this, we use STUN - a network protocol that allows you to determine the external IP-address. </li><li>  Send this information to our application. </li><li>  Establish a connection and use it further to exchange data </li></ul><br><br><img src="https://habrastorage.org/storage2/a4c/e0e/461/a4ce0e4612cca9b5c508b7e2d31548f8.png"><br><br><h5>  What does this look like in code? </h5><br>  In theory, everything is simple.  How does all this look in practice? <br><br><img src="https://habrastorage.org/storage2/1c4/ce1/da3/1c4ce1da34ad369a3875012bc089004c.png"><br><br>  As can be seen from the image above, a little more complicated.  First, we send a connection request from our application, which is transmitted via the cloud to the application on the client machine (steps 1 and 2).  The client machine requests its external address and port from the STUN server (steps 3 and 4).  In the network you can find many implementations of the STUN protocol. <br><br><pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">string</span></span> address = String.Empty; udpClient = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> UdpClient(); udpClient.AllowNatTraversal(<span class="hljs-literal"><span class="hljs-literal">true</span></span>); ResultSTUN result = ClientSTUN.Query(<span class="hljs-string"><span class="hljs-string">"stun.ekiga.net"</span></span>, <span class="hljs-number"><span class="hljs-number">3478</span></span>, udpClient.Client); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result.NetType == UDP_BLOCKED) { <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { address = result.PublicEndPoint.ToString(); }</code> </pre> <br><br>  Because  our solution uses UDP, we can, using the same socket, connect to the client (which distinguishes it from TCP). <br><br>  After these simple manipulations, the address will contain the external address and port of the client machine (or an error message).  This valuable information is transmitted to the management console via the cloud (steps 5 and 6).  Creating a connection, knowing the port and the address is a matter of technique.  Now we can transfer all the information we need. <br><br>  NAT Traversal‚Äôs challenge is simple and elegant when using UDP, but what if we want all the advantages of TCP: guaranteed packet delivery, data integrity, no duplication, etc.?  The first thought that comes to mind is to write your protocol over UDP.  Naturally, we are not the first who faced this problem.  Therefore, after a short search, you can find a solution such as <a href="http://code.google.com/p/lidgren-network-gen3/">Lindgren.Network</a> , which is ultimately used in our application. <br><br> <a href="http://www.sysadminanywhere.com/"><img src="https://habrastorage.org/storage2/732/1ce/eee/7321ceeeed8aa604c419fd77d11f07c3.png"></a> </div><p>Source: <a href="https://habr.com/ru/post/142858/">https://habr.com/ru/post/142858/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../142852/index.html">Ubuntu 12.04 released</a></li>
<li><a href="../142853/index.html">5 new courses Udacity</a></li>
<li><a href="../142854/index.html">Postgraduate Studies in Japan - Admission Experience and Personal Impressions</a></li>
<li><a href="../142856/index.html">Mail.Ru and Rambler covered up the possibility of registering new users with Cyrillic logins</a></li>
<li><a href="../142857/index.html">Google Drive against other cloud services</a></li>
<li><a href="../142859/index.html">Architecture Bitrix24 - Inside View</a></li>
<li><a href="../142860/index.html">Google launched Trusted Stores service in test mode</a></li>
<li><a href="../142861/index.html">TSM service for managing NFC SIM applications</a></li>
<li><a href="../142862/index.html">Getting cross-domain data in Google Chrome via user scripts (bypassing a bug)</a></li>
<li><a href="../142863/index.html">Flickr has undergone major changes.</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>