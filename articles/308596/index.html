<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How to use the standard settings to kill the microcontroller. Part 1</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I can not call myself a very neat and attentive person, but nevertheless, for more than 10 years of software development for embedded devices, I reall...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How to use the standard settings to kill the microcontroller. Part 1</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://habrastorage.org/files/776/388/305/7763883051724bd4a7b1441fb3a18d7d.jpg" alt="enter image description here"></p><br><p>  I can not call myself a very neat and attentive person, but nevertheless, for more than 10 years of software development for embedded devices, I really did not manage to burn or spoil anything.  On the one hand, it‚Äôs worth saying "thank you" to my colleagues - circuit engineers.  On the other hand, modern "smart" microelectronics has a rather serious "protection against a fool."  But a couple of days ago there was one interesting case.  I managed to turn the Atmel SAMD21G18AU microcontroller into a ‚Äúbrick‚Äù by performing the usual manipulations described in the user manual. </p><a name="habracut"></a><br><p>  It so happened that since my student days I was taught that "only amateurs work with Atmel", so you should not use it.  The argument is very doubtful, but according to the principle ‚ÄúI did not read it, but I condemn it‚Äù, the dislike of Atmel was also transmitted to me. </p><br><p>  However, at one point, another customer came to us and brought a draft of the device, which needs to be improved and for which you need to write a ‚Äúfirmware‚Äù.  The core of this device is an Atmel microcontroller SAMD21G18AU.  So I had to throw away my prejudices and start exploring this crystal. </p><br><p><img src="https://habrastorage.org/files/00d/ae2/0e9/00dae20e97eb4196b6152dd1ffbb2553.jpg" alt="enter image description here"></p><br><p>  The microcontroller turned out to be quite famous and widespread thanks to <a href="https://www.arduino.cc/en/Main/ArduinoBoardZero">ArduinoZero</a> . </p><br><p><img src="https://habrastorage.org/files/7c4/1ff/40b/7c41ff40bffd44a7a75d4dd2aa4f910d.jpg" alt="enter image description here"></p><br><p>  After studying the general parameters, I was very impressed.  The controller has little in common with the old Atmelovian families, works on the Cortex M0 core and uses a sophisticated system of configuration of the periphery, of which it has a lot. </p><br><p><img src="https://habrastorage.org/files/582/17c/9a0/58217c9a0fc44c4e894b1692dda8076c.jpg" alt="enter image description here"></p><br><p>  This system allows you to flexibly adjust the crystal to a wide range of tasks, but it also increases its "complexity" and negatively affects the learning curve of working with it (I do not take Arduino IDE into account :). </p><br><p>  Atmel also has its own software library for working with its <a href="http://www.atmel.com/ru/ru/tools/avrsoftwareframework.aspx">Atmel Software Framework</a> microcontrollers.  It's a good thing, until you start using it :) The library is designed to work in IAR and Atmel Studio and contains a huge number of drivers, modules and examples for almost all Atmel controllers ... But in my opinion, it is designed and documented badly enough (try to deal with <a href="http://asf.atmel.com/docs/latest/">it</a> yourself) </p><br><p>  The architecture of the library is designed so that everything is tied to the debug boards: </p><br><p><img src="https://habrastorage.org/files/886/3e4/443/8863e4443824401faf61a42e59216167.jpg" alt="enter image description here"></p><br><p>  That is, to use the library for your own board, you need to make its "description" in a certain format (very vaguely documented) and fix a couple of files (in particular, board.h).  At the same time, if you just want to take a specific driver and use it in your project, then you will encounter serious difficulties.  Especially if your project is not made in IAR or Atmel Studio.  We'll have to rake the dependencies of the modules for a long time and isolate the necessary files. </p><br><p>  This process ruined my copy of the controller.  I needed a watchdog driver.  He, in turn, pulls several other drivers, including the Clock driver, which is engaged in setting up clock generators for both the core and the periphery.  Well, Clock uses a special .h file containing the generator configuration for a particular device.  And I was so "lucky" that I didn‚Äôt get the wrong file that eventually turned off the core clock generator and, at the same time, the module for working with SWD. </p><br><p>  SAMD21G18AU has two built-in clock generators and allows the use of two external.  The GENERIC CLOCK CONTROLLER module incorporates several internal generators.  The first of them clocks the core, the rest are used to clock the periphery.  For each internal generator, you can set the source (internal or external), the multiplier and other parameters, among which is "OnDemand".  It allows you to run the generator "on demand", thereby reducing system consumption. </p><br><p><img src="https://habrastorage.org/files/dc7/e60/c10/dc7e60c1092448fba6a98025028a251c.jpg" alt="enter image description here"></p><br><p>  After rebooting, the SAMD21G18AU default tunes the core to 8 MHz from the internal oscillator, and disconnects the remaining generators. </p><br><p>  The file I‚Äôve got is forcing the Clock driver to set the core clock to an internal 8 MHz oscillator, but at the same time it switches it to the ‚ÄúOnDemand‚Äù mode.  But for some reason this mode does not work and the generator does not start.  It turns out that as soon as the controller starts to execute the code, it disables the clocking itself. </p><br><p>  At the same time, the module for working with SWD also ceases to be clocked, which means that it stops responding when trying to connect.  And no tricks are helping to catch the moment when the processor has already turned on, but has not yet had time to work out the curve setting of the GENERIC CLOCK CONTROLLER module. </p><br><p>  It would be possible to use a flashing through the bootloader.  Usually, microcontrollers have a wired bootloader that allows you to program it at least via a COM port.  But it was not there!  Atmel outwitted himself.  Although the use of the bootloadr is <a href="http://www.atmel.com/images/atmel-42366-sam-ba-bootloader-for-sam-d21_applicationnote_at07175.pdf">provided for</a> , but due to the ‚Äúflexibility‚Äù in the settings, the place reserved for it can be used to store the executable code.  And it looks like this is the default setting. </p><br><p>  That is, to work with the bootloader, it must first be ‚Äúsewn‚Äù into the controller.  And of course, in my case it was not done. </p><br><p>  The funny thing is that although both external quartz are soldered on the board, in the end, neither works.  It is impossible to approach the controller either through SWD or via Bootloader. </p><br><p>  In conclusion of the story I want to say that I still do not have deep skills in working with this microcontroller, so perhaps there is a way to ‚Äúrevive‚Äù it.  Maybe someone will tell me a solution to the problem, until we soldered the "brick" and did not solder the new SAMD21G18AU? </p><br><p>  <strong>ps</strong> Well, my dislike of Atmel got the first argument in its favor.  The controller, which allows you to drive yourself into a dead end by a combination of settings, while not having full-time recovery tools - this is somehow not solid ... </p><br><p>  <b>Update:</b> <br>  Read the story <a href="https://habrahabr.ru/post/309724/">here</a> . </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/308596/">https://habr.com/ru/post/308596/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../308578/index.html">Big Data hackathon from Innopolis University and Provectus</a></li>
<li><a href="../308586/index.html">What is big data, part 2</a></li>
<li><a href="../308588/index.html">KUKU.io SMM application case: the path from a sprint of 4 months to sensible planning</a></li>
<li><a href="../308590/index.html">How we taught Facebook to make websites or Plan ‚ÄúEnvelope‚Äù</a></li>
<li><a href="../308594/index.html">An example of using policy-based design in C ++ instead of copy-paste and creating OOPs of hierarchies</a></li>
<li><a href="../308598/index.html">Several new products in the world of data centers: will they become the norm?</a></li>
<li><a href="../308600/index.html">Russian hacker convicted of stealing $ 169 million</a></li>
<li><a href="../308602/index.html">WhatsApp is going to share data of its users with Facebook</a></li>
<li><a href="../308604/index.html">Mathematics for artificial neural networks for beginners, part 3 - gradient descent continued</a></li>
<li><a href="../308606/index.html">The history of the virus "The program that dismisses people"</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>