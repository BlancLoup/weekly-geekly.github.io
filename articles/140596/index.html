<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Portion of servers please, or how to start deployment with Opscode Chef</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Most of the Russian articles on ( Opscode Chef ) that I came across contained excerpts from a cookbook and the story "What a cool thing Chef." And tha...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Portion of servers please, or how to start deployment with Opscode Chef</h1><div class="post__text post__text-html js-mediator-article">  Most of the Russian articles on ( <a href="http://www.opscode.com/chef/">Opscode Chef</a> ) that I came across contained excerpts from a cookbook and the story "What a cool thing Chef."  And that's all.  Like, look how I can!  What and how to do with it is not clear.  The official site has a detailed wiki.  But in her, IMHO, it's easy to get lost.  A simple manual ‚Äúhow to make an elementary work‚Äù found only in the form of a video, based on which this article was born. <br><a name="habracut"></a><br><h3>  Part one.  Ideological.  What for. </h3><br>  If you have 5 servers, they need to be installed extremely rarely, then a couple of hands will be enough.  You can also put / etc in Git or SVN, be sure to make regular backups and live in peace.  To automate the application's deploys, the one that admin is best at, even if it is a simple script in bash / python / ruby, or capistrano / fabric / etc. <br>  If there are more than a dozen machines, moreover, similar or identical, then the scripts are already quite complicated.  Capistrano / fabric - gives some convenience, parallel launch on multiple servers, but you still have to write the logic yourself.  It is convenient to deploy with them, especially the application in the same language, but not to configure or set up.  Here you need to either build your own ‚Äúcrutches‚Äù, or, which is easier, take it ready. <br><br>  From the Chief, I unlocked to the last, until I ran into the following.  Let us have n identical servers, and / etc all in the same repository branch.  Changed the nginx config.  It is necessary to apply the changes on all other machines.  How?  For example, take dsh: <br><pre><code class="bash hljs">dsh -r ssh -c -M -m node1 -m node2 -m nodeN -- <span class="hljs-string"><span class="hljs-string">'cd /etc &amp;&amp; sudo git pull'</span></span></code> </pre> <br>  Here, in principle, you can add "/etc/init.d/nginx reload" and update everything, everywhere and immediately.  But for prodakshina this is no good.  Yes, and local users interruptions are not very pleasant.  Everything else, there is still a supervisor, postgres, mongodb and many other services with which the same story.  At a minimum, you have to do a script to reload each.  In general, "crutches" are obtained. <br>  And the Chief is just for this intended.  Changed the config, it scattered throughout the farm, the necessary (and only necessary) services were overloaded.  Plus abstraction from the * nix version, and MS, it seems, is supported.  For configs, there are templates that are ‚Äúassembled‚Äù depending on server parameters.  In general, a lot of tasty.  By the way, on the current project are used all at once: a couple of scripts on bash, fabric and Chef. <br>  Closer to practice.  Let's write from scratch and write down a simple kookbook installation nginx, at the same time we will understand.  First you need a test machine with sudo.  The instruction is designed for Ubuntu 11.10, but should fit any * nix. <br><br><h3>  2. Installation and configuration </h3><br>  Chef is written in Ruby.  And Ruby is more convenient to install via <a href="http://beginrescueend.com/">Ruby Version Manager (RVM)</a> . <br>  On my machine, from the normal user: <br><pre> <code class="bash hljs">bash -s stable &lt; &lt;(curl -s https://raw.github.com/wayneeseguin/rvm/master/binscripts/rvm-installer)</code> </pre> <br>  Next, relogin, or open a new terminal (to reboot the bash profile). <br><pre> <code class="bash hljs">rvm install 1.9.2 rvm use 1.9.2 --default</code> </pre> <br>  RVM puts both itself and hack into ~ / .rvm if it is not run as root.  The system does not get dirty, and easy to remove, if that. <br>  We put Chef solo.  You can also install from packages, but rubygems is a more ‚Äúnative‚Äù method, independent of the package manager. <br><pre> <code class="bash hljs">gem install knife-solo</code> </pre> <br>  There are 3 Chef configurations: <br><ul><li>  <b><a href="http://wiki.opscode.com/display/chef/Chef%2BClient">Solo</a></b> - gives you the opportunity to run Kukbuk. </li><li>  <b><a href="http://wiki.opscode.com/display/chef/Chef%2BServer">Server</a></b> - centralized repository for kukbooks, data about servers, search by them, web-interface. </li><li>  <b><a href="http://wiki.opscode.com/display/chef/Chef%2BClient">Client</a></b> - runs on a managed machine. </li></ul><br>  Configuring: <br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ~ knife configure -r . --defaults</code> </pre><br><h3>  3. Kitchen, cookbook and knife </h3><br><pre> <code class="bash hljs">knife kitchen solodemo</code> </pre> <br>  This will create the solodemo folder: <br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> solodemo tree . |-- cookbooks - .  . |-- data_bags -     (, ,  ,   ). |-- nodes -    (). |-- roles - .        . , Apache , MySQL . |-- site-cookbooks `-- solo.rb</code> </pre><br>  This is the so-called.  "kitchen".  In fact, a kind of simplified version of Chef Server, only on the local file system. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Create a kookbook to install nginx. <br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> solodemo knife cookbook create nginx -o cookbooks</code> </pre><br>  This is also a folder.  We look. <br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> cookbooks tree . |-- attributes |-- definitions |-- files | `-- default |-- libraries |-- metadata.rb |-- providers |-- README.md |-- recipes -  <span class="hljs-string"><span class="hljs-string">" "</span></span>. default.rb   ,    .     . | `-- default.rb |-- resources `-- templates -    ERB. `-- default</code> </pre><br>  <a href="http://wiki.opscode.com/display/chef/Recipes">Recipe (recipe)</a> - a script that describes what should be done.  Both Ruby and Bash, Perl, Python, csh inserts are supported. <br>  There may be several recipes, but the ‚Äúdefault‚Äù is executed if you do not specify any particular (when calling the Kukbook). <br>  Add to recipes / default.rb <br><pre> <code class="ruby hljs">package <span class="hljs-string"><span class="hljs-string">"nginx"</span></span></code> </pre> <br>  We save. <br>  ‚ÄúPackage‚Äù here is a resource.  View a <a href="http://wiki.opscode.com/display/chef/Resources">list of embedded resources on the wiki</a> .  They can be supplemented and expanded right in the cookbooks, if necessary.  The language in which the recipients are written is <a href="http://wiki.opscode.com/display/chef/Recipes">Ruby DSL</a> .  The logic is built from the reverse.  We simply say that the ‚Äúnginx‚Äù package must be installed on the server.  And Chef makes sure that it does what is required.  In principle, the same can be described in any other language.  But there are a lot of handy things, as they say, out of the box.  Of course, there are nuances.  For example, with packages, it is important to set the name correctly.  So, for apache you need to write a condition, since  in RPM-based distributions it is httpd, in Debian it is apache2. <br>  Next, go to the test server and set the hostname.  This is important because  Chef distinguishes nodes by it. <br><pre> <code class="bash hljs">hostname testserver.example.com <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"testserver.example.com"</span></span> &gt; /etc/hostname</code> </pre> <br>  and add to / etc / hosts <br><pre> <code class="bash hljs">10.10.10.10 testserver.example.com</code> </pre> <br>  Checking: <br><pre> <code class="bash hljs">hostname -f</code> </pre> <br>  If the answer "testserver.example.com" - everything is fine.  No - rule / etc / hosts. <br>  Now, from the local machine from the solodemo folder: <br><pre> <code class="bash hljs">knife prepare ubuntu@testserver.example.com</code> </pre><br>  We'll have to wait a bit and maybe enter a password for sudo.  Prepare will install chef-client, which will accept commands. <br>  A file of the type testserver.example.com.json should appear in the nodes folder.  We write to it: <br><pre> <code class="javascript hljs">{ <span class="hljs-string"><span class="hljs-string">"run_list"</span></span>: [<span class="hljs-string"><span class="hljs-string">"recipe[nginx]"</span></span>] }</code> </pre><br>  That is, you need to run the kookbook ‚Äúnginx‚Äù, or rather, the recipe ‚Äúdefault‚Äù from it. <br>  Then <br><pre> <code class="bash hljs">knife cook ubuntu@testserver.example.com</code> </pre>  Everything. <br><br><h3>  findings </h3><br>  Yes, dancing around one nginx is a lot.  But for trivial tasks there are kukbuki, and they are quite flexible and well thought out.  And for non-trivial - once written, the book allows the installation to be fully automated, and is a kind of documentation.  In order to understand and describe the installation of the first server, I spent a week, but the installation from scratch now takes 20 minutes. How often is this necessary?  Not yet.  But configuring now is a pleasure.  And if you still write documentation, so why not do it right away at Chef?  Yes, and the customer can pick up and ‚Äútouch‚Äù everything on his virtual machine with the help of a couple of commands. <br>  I decided not to overload the article with information.  This is still more of a guide.  But the terms are referenced so that anyone is interested - easily found. <br><br><h3>  Links </h3><br><ul><li>  <a href="http://www.youtube.com/watch%3Fv%3D1G6bd4b91RU">Video by Matt Schaeffer</a> , for which his immense gratitude.  :) It is advisable to watch all the episodes at once. </li><li>  <a href="https://github.com/opscode/cookbooks">Repository with official kukbukami.</a>  They can draw a lot, or use fully. </li><li>  <a href="http://www.opscode.com/chef/">Site</a> and <a href="http://wiki.opscode.com/display/chef/Home">Wiki by Chef.</a> </li></ul></div><p>Source: <a href="https://habr.com/ru/post/140596/">https://habr.com/ru/post/140596/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../140588/index.html">Batteries charge an hour longer than they seem</a></li>
<li><a href="../140590/index.html">Microsoft StreamInsight - real-time data stream processing</a></li>
<li><a href="../140591/index.html">‚ÄúHow to make money on mobile phones?‚Äù - podcast with Leonid Bugaev and Darya Batukhtina</a></li>
<li><a href="../140592/index.html">NUI and UI Evolution</a></li>
<li><a href="../140594/index.html">Blur js</a></li>
<li><a href="../140599/index.html">Oldfag Festival continues - Baldur's Gate will be released on the iPad</a></li>
<li><a href="../140600/index.html">Report on the 5th Kiev Habravstreche</a></li>
<li><a href="../140601/index.html">A brief glossary of basic terms for a start-up community, or 33 trendy words for public interactions</a></li>
<li><a href="../140602/index.html">Web services play poker</a></li>
<li><a href="../140603/index.html">Frustro: impossible font</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>