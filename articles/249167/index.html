<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Pebble: an example of using an Android companion</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Thanks to the official mobile application, Pebble copes with informing about the status of your smartphone - show incoming messages, call information ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Pebble: an example of using an Android companion</h1><div class="post__text post__text-html js-mediator-article"><img align="left" src="https://habrastorage.org/files/3ce/e7c/ea8/3cee7cea8e454a579c5b05fccfb04f0b.png">  Thanks to the official mobile application, Pebble copes with informing about the status of your smartphone - show incoming messages, call information and other notifications.  But what to do if such a necessary "trifle", such as the condition of a smartphone's battery, the number of unread SMS and e-mail, is not available for use in your applications on the clock?  Option to implement it yourself. <br><br>  And so, on how to use PebbleKit Android to integrate Pebble and Android applications using the example of <b>notification of the number of missed calls</b> : some code, translation of extracts from the <a href="https://habr.com/ru/post/249167/">documentation [1],</a> and very few pictures. <br><br><a name="habracut"></a><br>  Thesis how the interaction of the mobile application and the watchappp works: <br><ul><li>  companion application recognizes, connects and communicates with Pebble through the PebbleKit library; </li><li>  The watchapp (watchface) and the mobile application exchange messages bilaterally, the channel is identified from both sides by the Pebble application UUID; </li><li>  The exchange between the Pebble application and the mobile application is carried out by <a href="https://habr.com/ru/post/249167/">Dictionary</a> objects <a href="https://habr.com/ru/post/249167/">[2]</a> . </li></ul><br>  To solve the task, to display a notification on the clock about the number of missed calls, you need: <br><ul><li>  Pebble-application that can receive, process and display information from the companion application; </li><li>  Android application that tracks calls and sends the number of unanswered to our application on the clock. </li></ul>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h2>  Watchapp </h2><br><br>  In the Pebble-application, in the same way as in the case of PebbleKit JS, the <a href="https://habr.com/ru/post/249167/">AppMessage API</a> mechanism is used <a href="https://habr.com/ru/post/249167/">[3]</a> . <br>  Since our application does not initiate a communication session itself, but only waits for a message from the smartphone, I will use the <a href="https://habr.com/ru/post/249167/">Synchronizing App UI [4]</a> - an auxiliary layer on top of AppMessage, which simplifies the synchronization of values ‚Äã‚Äãbetween the watchapp and the mobile device.  Only two callbacks are used, one of which in the case when the predefined value changes, and the other if an error occurs. <br><br>  We define the key, AppSync and buffer for synchronizing the tuple: <br><pre><code class="hljs swift">#define <span class="hljs-type"><span class="hljs-type">KEY_CALLS_COUNT</span></span> <span class="hljs-number"><span class="hljs-number">41</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-type"><span class="hljs-type">AppSync</span></span> s_sync; <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> uint8_t s_sync_buffer[<span class="hljs-number"><span class="hljs-number">32</span></span>];</code> </pre> <br>  The initialization of the synchronization mechanism and the initial value of the tuple will be put into a separate function: <br><pre> <code class="hljs pgsql"><span class="hljs-comment"><span class="hljs-comment">/* ... */</span></span> static <span class="hljs-type"><span class="hljs-type">void</span></span> start_sync() { app_message_open(app_message_inbox_size_maximum(), app_message_outbox_size_maximum()); //    (<span class="hljs-number"><span class="hljs-number">0</span></span> ) Tuplet initial_values[] = { TupletInteger(KEY_CALLS_COUNT, <span class="hljs-number"><span class="hljs-number">0</span></span>), }; app_sync_init(&amp;s_sync, s_sync_buffer, sizeof(s_sync_buffer), initial_values, ARRAY_LENGTH(initial_values), sync_changed_handler, sync_error_handler, <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>); } static <span class="hljs-type"><span class="hljs-type">void</span></span> init(<span class="hljs-type"><span class="hljs-type">void</span></span>) { <span class="hljs-comment"><span class="hljs-comment">/* ... */</span></span> start_sync(); }</code> </pre><br>  Define callbacks: <br><pre> <code class="hljs cpp"><span class="hljs-comment"><span class="hljs-comment">/* ... */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> s_count_buffer[<span class="hljs-number"><span class="hljs-number">4</span></span>]; <span class="hljs-comment"><span class="hljs-comment">/* ... */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sync_changed_handler</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint32_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> key, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Tuple *new_tuple, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Tuple *old_tuple, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *context)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//      snprintf(s_count_buffer, sizeof(s_count_buffer), "%d", (int)new_tuple-&gt;value-&gt;int32); //       layer_mark_dirty(layer); } static void sync_error_handler(DictionaryResult dict_error, AppMessageResult app_message_error, void *context) { APP_LOG(APP_LOG_LEVEL_ERROR, "sync error!"); } /* ... */</span></span></code> </pre><br>  <i>NB In this case, the key used to exchange the value does not require registration in appinfo.json.</i> <br><br>  If we start our simple application now, there will be a single indicator on the screen (0 missed calls): <br><img src="https://habrastorage.org/files/306/183/c4a/306183c4af3145d59ea19d48f3ac09e5.png"><br><br><h2>  Android application </h2><br><br>  You can get the number of missed calls in Android in different ways, in this example I will take it from the "curtain" with notifications - Notification Area. <br>  The application itself consists of two classes: MainActivity for entering the UUID watchapp that will receive data and the NotificationListener service that monitors notifications. <br><br>  <i>NB Access to the Notification Area via the NotificationListenerService appeared in Android 4.3.</i>  <i>As the additional metadata Notification.extras is used, the example will be guaranteed to work only on Android 4.4+.</i> <br><br>  For Android Studio, the addition of PebbleKit is done via a gradle file. <br>  Add to <i>app / build.gradle</i> : <br><pre> <code class="hljs cs">dependencies { compile <span class="hljs-string"><span class="hljs-string">'com.getpebble:pebblekit:2.6.0'</span></span> } repositories { mavenCentral() maven { url <span class="hljs-string"><span class="hljs-string">"https://oss.sonatype.org/content/groups/public/"</span></span> } }</code> </pre><br>  After synchronization, PebbleKit can be used in your project. <br><br>  To access notifications, I use the NotificationListener class, inherited from NotificationListenerService with overridden onNotificationPosted () and onNotificationRemoved () methods: <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NotificationListener</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NotificationListenerService</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onNotificationPosted</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( StatusBarNotification sbn)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.getMissedCalls(); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onNotificationRemoved</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( StatusBarNotification sbn)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.getMissedCalls(); } }</code> </pre><br>  When adding or deleting a notification, all active calls are viewed and if there is information about missed calls, the number of them is sent to the application on the clock: <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NotificationListener</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NotificationListenerService</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//    int missedCallsCount = 0; /*...*/ void getMissedCalls() { int tCount = 0; for (StatusBarNotification notif : this.getActiveNotifications()) { if (notif.getPackageName().equals("com.android.phone")) { String extras_text = notif.getNotification().extras.getString(Notification.EXTRA_TEXT); if (extras_text.indexOf(" :") != -1) { tCount = Integer.parseInt(extras_text.split(":")[1].trim()); } } } if (tCount != missedCallsCount) { missedCallsCount = tCount; this.sendMissedCalls(missedCallsCount); } } }</span></span></code> </pre><br>  To send data to the clock, we define the key, UUID, form the dictionary and use the sendDataToPebble method: <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NotificationListener</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NotificationListenerService</span></span></span><span class="hljs-class"> </span></span>{ UUID APPS_UUID; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> CALLS_KEY = <span class="hljs-number"><span class="hljs-number">41</span></span>; <span class="hljs-comment"><span class="hljs-comment">/*...*/</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sendMissedCalls</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> missedCalls)</span></span></span><span class="hljs-function"> </span></span>{ APPS_UUID = UUID.fromString(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.getUUID()); PebbleDictionary data = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PebbleDictionary(); data.addUint32(CALLS_KEY, missedCalls); PebbleKit.sendDataToPebble(getApplicationContext(), APPS_UUID, data); } <span class="hljs-comment"><span class="hljs-comment">/*...*/</span></span> }</code> </pre><br><br>  To provide the application with access rights to notifications, you need to add to the manifest: <br><pre> <code class="xml hljs"> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">service</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">".NotificationListener"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:label</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"@string/app_name"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:permission</span></span></span><span class="hljs-tag">= </span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"android.permission.BIND_NOTIFICATION_LISTENER_SERVICE"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">intent-filter</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">action</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">= </span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"android.service.notification.NotificationListenerService"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">intent-filter</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">service</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><br>  Note, after installing the application, you must enable the service, it will not work without authorization.  The setting is located on the path ‚ÄúSettings‚Äù -&gt; ‚ÄúSecurity‚Äù -&gt; ‚ÄúNotification access‚Äù.  In my Russian locale, I have ‚ÄúSettings‚Äù -&gt; ‚ÄúPrivacy‚Äù -&gt; ‚ÄúAccess to notifications‚Äù. <br><img src="https://habrastorage.org/files/0c3/852/638/0c385263804d44f4acbcc55e09080e42.png"><br><br>  We start the android application, indicate the UUID of the Pebble application in it, call and do not answer, see how the notification changes on the clock: <br><img src="https://habrastorage.org/files/8a2/2e0/7e2/8a22e07e29c14657ad010424d189b659.png"><br><br>  Sources: <br>  <a href="https://bitbucket.org/tmnhy/notify-ex/src/734ffd702ebbb46732bbf8aa6cb76fafb0d76993/notice/%3Fat%3Dmaster">notice watchapp</a> - <a href="">pbw</a> <br>  <a href="https://bitbucket.org/tmnhy/notify-ex/src/734ffd702ebbb46732bbf8aa6cb76fafb0d76993/PebbleNotify/%3Fat%3Dmaster">PebbleNotify (Android Studio project)</a> - <a href="">apk</a> <br><br><a name="Anchor1"></a>  <a href="https://developer.getpebble.com/guides/mobile-apps/">1. Pebble Developers // Mobile App Developer Guide</a> <br><a name="Anchor2"></a>  <a href="https://developer.getpebble.com/docs/c/group___dictionary.html">2. Pebble Developers // Dictionary</a> <br><a name="Anchor3"></a>  <a href="https://developer.getpebble.com/guides/pebble-apps/communications/appmessage">3. Pebble Developers // App Communication</a> <br><a name="Anchor4"></a>  <a href="https://developer.getpebble.com/guides/pebble-apps/communications/appsync/">4. Pebble Developers // Synchronizing App UI</a> </div><p>Source: <a href="https://habr.com/ru/post/249167/">https://habr.com/ru/post/249167/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../249151/index.html">Free internet for tablet from Beeline and MTS</a></li>
<li><a href="../249155/index.html">Analytics for December, plans for a new iPhone, Roskomnadzor measures - and other news of the week for a mobile developer</a></li>
<li><a href="../249159/index.html">Apple fixed important OS X vulnerabilities</a></li>
<li><a href="../249163/index.html">Introduction to topological spaces. Java finite topology programming. Part 2: Base topology. Continuous display</a></li>
<li><a href="../249165/index.html">Features of domain modeling using OOP</a></li>
<li><a href="../249169/index.html">AdBlock Plus and Adguard + Anti-Adblock banner blocking bypass</a></li>
<li><a href="../249173/index.html">We continue to watch Moscow‚Äôs public video surveillance cameras</a></li>
<li><a href="../249175/index.html">Conveyor - time delayed data element processing</a></li>
<li><a href="../249177/index.html">Unity 2D: working with sprites in different display resolutions</a></li>
<li><a href="../249179/index.html">TM represents TM Feed</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>