<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Asynchronous multithreaded pool of Perl workers</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the work of a web service, and indeed of many other systems, there is often a need to perform various background tasks. To do this, write scripts -...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Asynchronous multithreaded pool of Perl workers</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/118/4c9/d0e/1184c9d0e1be5a439792c99e5c51e5a8.jpg" alt="image"><br><br>  In the work of a web service, and indeed of many other systems, there is often a need to perform various background tasks.  To do this, write scripts - workers - who take a list of existing tasks and begin to perform them - with some speed and in some sequence. <br><br>  It is clear, well, when all tasks are performed quickly and without delay. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      To speed up the execution of tasks, it is desirable to solve two problems: <br><br><ul><li>  Teach the worker not to wait for the execution of each individual stage of the task (asynchrony) </li><li>  To teach a worker to perform several tasks simultaneously (multithreading) (disclaimer: in fact, the term ‚Äúmultithreading‚Äù is used here to mean ‚Äúmultiprocessing‚Äù) </li></ul><br>  In this article, we will look at an implementation option for a worker that is both asynchronous and multithreaded. <br><a name="habracut"></a><br><h4>  AnyEvent module </h4><br>  For programming in asynchronous mode in Perla there is an excellent <a href="https://metacpan.org/pod/AnyEvent">AnyEvent</a> module. <br><br>  Just in case, you should say that AnyEvent is actually a wrapper over other low-level asynchronous modules.  As DBI is a wrapper and universal interface to different databases, so AnyEvent is a wrapper and universal interface to various implementations of asynchronous engines. <br><br>  AnyEvent has a huge number of various extensions, including an extension for writing multi-threaded applications - the <a href="https://metacpan.org/pod/AnyEvent::Fork::Pool">AnyEvent :: Fork :: Pool</a> module. <br><br>  The AnyEvent :: Fork :: Pool module provides an easy way to create a pool of workers who will handle tasks in asynchronous multithreaded mode. <br><br><h4>  Script </h4><br>  Consider the anyevent_pool.pl script: <br><br><pre><code class="perl hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/perl use strict; use warnings; use AnyEvent::Fork::Pool; #   my $mod = 'Worker'; #   my $sub = 'work'; #      my $cpus = AnyEvent::Fork::Pool::ncpu 1; #    my $pool = AnyEvent::Fork -&gt;new -&gt;require ($mod) -&gt;AnyEvent::Fork::Pool::run( "${mod}::$sub", # :: -    init =&gt; "${mod}::init", # ::init -    max =&gt; $cpus, #     idle =&gt; 0, #     load =&gt; 1, #    ); #    for my $str (qw{q2 rtr4 ui3 asdg5}) { $pool-&gt;($str, sub { print "result: @_\n"; }); }; AnyEvent-&gt;condvar-&gt;recv;</span></span></code> </pre> <br>  Despite its small size, this script is a complete asynchronous multi-threaded application. <br><br>  We analyze it in parts. <br><br><h4>  Variables </h4><br><pre> <code class="perl hljs"><span class="hljs-comment"><span class="hljs-comment">#   my $mod = 'Worker'; #   my $sub = 'work';</span></span></code> </pre><br>  These variables define a link between the pool and the code that will execute specific background tasks.  The pool is one for all, and the tasks may be different.  These variables tell the pool which code (which function from which module) you want to run to perform a specific task. <br><br>  For example, you might have a Text module for text processing, and in a module, functions length and trim.  And you can also have an Image module, in which there can be resize and crop functions.  Pula is completely indifferent to what your functions do and how they work.  You just need to tell the pool what module they are in and what they are called, and the pool will execute them. <br><br>  Important!  The module of the worker does not need to be connected in the script through the use Worker.  The pool itself automatically loads the module of the worker, you only need to correctly specify the name of the module in the variable. <br><br><h4>  Number of Cores </h4><br><pre> <code class="perl hljs"><span class="hljs-comment"><span class="hljs-comment">#      my $cpus = AnyEvent::Fork::Pool::ncpu 1;</span></span></code> </pre><br>  For multithreaded tasks, it is desirable to know how many cores are in the system.  It is desirable that the number of threads that you will run is equal to the number of cores.  If there are less threads, some cores will be idle in vain, if there will be more threads, some threads will get in the queue and instead of acceleration you will get dispatching losses. <br><br>  If for some reason the number of cores could not be determined, then the value specified manually will be used.  In this case, it is 1. <br><br><h4>  Pool </h4><br><pre> <code class="perl hljs"><span class="hljs-comment"><span class="hljs-comment">#    my $pool = AnyEvent::Fork -&gt;new -&gt;require ($mod) -&gt;AnyEvent::Fork::Pool::run( "${mod}::$sub", # :: -    init =&gt; "${mod}::init", # ::init -    max =&gt; $cpus, #     idle =&gt; 0, #     load =&gt; 1, #    );</span></span></code> </pre><br>  Explanation of the parameters: <br><br><ul><li>  The work function of the worker must always be specified by the first parameter.  This is the same function of that module that we specified in the first two "tuning" variables $ mod and $ sub.  This is the only required parameter. </li><li>  init - If your worker needs initialization, then in this parameter you can specify the name of the initialization function.  In this case, the name of the function is indicated as ‚Äúinit‚Äù, since this is the usual name for such a function, but, in principle, you can specify any other name. </li><li>  max - This parameter sets the number of threads that the pool will start.  It is here that you should specify the previously determined number of cores in the system (but if you want, you can specify any number if you know what you are doing). </li><li>  idle - here you can see the number of workers who will wait ‚Äúat a low start‚Äù.  The greater this number (but not more than the max parameter), the faster the pool will react to the new incoming task, but the more there will be no useless waiting (and resource-consuming) processes. </li><li>  load - How many tasks will be given to each worker without waiting for the previous ones to be executed.  The value strongly depends on the situation - in some cases less is better, in some better more.  Other things being equal, greater importance should increase the efficiency of the pool (wholesale - cheaper). </li></ul><br>  There are also other options that I do not consider here.  They are highly specific and rarely required.  A complete list of parameters can be found in the module documentation. <br><br><h4>  Task setting pool </h4><br><pre> <code class="perl hljs"><span class="hljs-comment"><span class="hljs-comment">#    for my $str (qw{q2 rtr4 ui3 asdg5}) { $pool-&gt;($str, sub { print "result: @_\n"; }); };</span></span></code> </pre><br>  An arbitrary number of parameters can be passed to the pool, but the last parameter should be a callback.  Callback is an anonymous function that will be called after the worker has completed the task.  The results of the work of the worker will be transferred to this function. <br><br>  In other words - this function is the recipient of the results of the function $ sub.  All that $ sub returns will be passed as arguments to the callback function.  Conventionally, this relationship can be written something like this - "callback ($ sub)". <br><br>  In our case, the callback function simply prints everything it receives. <br><br>  The $ str variable is, in fact, the very task that the worker must perform.  In our case, this is just one line (more precisely, 4 lines, launched in a loop).  The lines here have no deep meaning, I just called the cat to walk on the keyboard. <br><br>  Depending on the situation, instead of a line, there can be anything, such as the file name, the record identifier in the database, a mathematical expression, a link to a complex data structure ... in short, anything.  Pula no matter what it is, he does not handle this value.  The pool simply transfers this value to the worker, but he should already know what to do with it. <br><br><h4>  Run engine </h4><br><pre> <code class="perl hljs">AnyEvent-&gt;condvar-&gt;<span class="hljs-keyword"><span class="hljs-keyword">recv</span></span>;</code> </pre><br>  This line tells the AnyEvent module to start the event engine and continue to work endlessly. <br><br>  At this point, the script will loop.  The given example has no way to stop and exit an infinite task processing loop.  The issue of conditional exit from the AnyEvent loop is more general, and here I want to consider only the special case of using the pool.  About the conditional exit from the cycle you can read <a href="http://pragmaticperl.com/issues/01/pragmaticperl-01-%25D0%25B2%25D1%2581%25D1%2591-%25D1%2587%25D1%2582%25D0%25BE-%25D0%25B2%25D1%258B-%25D1%2585%25D0%25BE%25D1%2582%25D0%25B5%25D0%25BB%25D0%25B8-%25D0%25B7%25D0%25BD%25D0%25B0%25D1%2582%25D1%258C-%25D0%25BE%25D0%25B1-anyevent-%25D0%25BD%25D0%25BE-%25D0%25B1%25D0%25BE%25D1%258F%25D0%25BB%25D0%25B8%25D1%2581%25D1%258C-%25D1%2581%25D0%25BF%25D1%2580%25D0%25BE%25D1%2581%25D0%25B8%25D1%2582%25D1%258C.html">here</a> . <br><br><h4>  Self worker </h4><br>  Now the question arises - where, in fact, is the worker himself?  Where is the code that executes the actual work? <br><br>  This code is placed in a separate module, which we specified in the $ mod variable. <br><br>  Here is the code for the Worker module: <br><br><pre> <code class="perl hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> Worker; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> strict; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> warnings; <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> $file; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">sub</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">init</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">open</span></span> $file, <span class="hljs-string"><span class="hljs-string">'&gt;&gt;'</span></span>, <span class="hljs-string"><span class="hljs-string">'file.txt'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> $q = <span class="hljs-keyword"><span class="hljs-keyword">select</span></span>($file); $|=<span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">select</span></span>($q); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">sub</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">work</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> ($str) = @_; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span>..length($str)) { <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> $file <span class="hljs-string"><span class="hljs-string">"$$ $str\n"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">sleep</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>; }; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $str, <span class="hljs-keyword"><span class="hljs-keyword">length</span></span>($str); } <span class="hljs-number"><span class="hljs-number">1</span></span>;</code> </pre><br>  As you can see, in the module there are two functions - init and work. <br><br>  The init function initializes the worker.  In our case, the function opens the log file, which will later display the results of the work function work.  As mentioned above, the init function is optional; in our case, I made it just for clarity. <br><br>  The work function is the main function.  This is the same work function that was specified in the $ sub variable.  It is in this function that all the work related to the performance of a specific task is performed. <br><br>  In our case, the function performs the simplest work ‚Äî it calculates the length of the string.  For a more visual demonstration of the work of the worker, I added a second-delay cycle to the function, which displays the line to the log as many times as there are letters in the line. <br><br>  Please note - the function returns two values ‚Äã‚Äã- the string itself and its length.  It is these two values ‚Äã‚Äãthat will be transferred to the callback specified at the stage of problem statement for the pool (and in the callback, as mentioned above, these values ‚Äã‚Äãwill be simply printed). <br><br>  That's the whole code. <br><br><h4>  Start the pool </h4><br>  Now let's run our pool and see what happens: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/70f/bae/878/70fbae878efaa1fcfcdd080e71f252ad.png" alt="image"><br><br>  Here we see the results of the pool.  You may notice that the order of output of the results is different from the order of the lines specified in the loop in the script.  The reason is clear - the strings have different lengths, so workers handle strings with different speeds.  The simpler the task - the faster it is executed. <br><br>  Now let's look not just at the results, but also at the work process of the workers.  To do this, run tail for the log file in the second window: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/b65/862/82a/b6586282a9295c60de42d5b80c6375f9.png" alt="image"><br><br>  Please note - the results of the work are mixed, as the tasks are performed simultaneously.  The process identifiers are visible on the left - we see that 4 processes are involved.  I have 4 cores in the system, so all 4 tasks are performed simultaneously. <br><br>  And finally, let's look at the process table: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/9d0/eb0/b7b/9d0eb0b7b10a2f9b2a8ffbdb61430d1d.png" alt="image"><br><br>  This is the process tree of our pool. <br><br>  The first in the list is the script, then the pool manager (yes, there can be several pools), then the pool manager, and finally the workers. <br><br>  If you do not be lazy and compare the identifiers of the processes, then you can see that the identifiers of the workers coincide with the identifiers in the log file. <br><br><h4>  Literature </h4><br><ul><li>  <a href="https://metacpan.org/pod/AnyEvent">AnyEvent</a> </li><li>  <a href="https://metacpan.org/pod/AnyEvent::Fork::Pool">AnyEvent :: Fork :: Pool</a> </li><li>  <a href="http://pragmaticperl.com/issues/01/pragmaticperl-01-%25D0%25B2%25D1%2581%25D1%2591-%25D1%2587%25D1%2582%25D0%25BE-%25D0%25B2%25D1%258B-%25D1%2585%25D0%25BE%25D1%2582%25D0%25B5%25D0%25BB%25D0%25B8-%25D0%25B7%25D0%25BD%25D0%25B0%25D1%2582%25D1%258C-%25D0%25BE%25D0%25B1-anyevent-%25D0%25BD%25D0%25BE-%25D0%25B1%25D0%25BE%25D1%258F%25D0%25BB%25D0%25B8%25D1%2581%25D1%258C-%25D1%2581%25D0%25BF%25D1%2580%25D0%25BE%25D1%2581%25D0%25B8%25D1%2582%25D1%258C.html">An article about AnyEvent</a> (Russian) </li></ul></div><p>Source: <a href="https://habr.com/ru/post/234835/">https://habr.com/ru/post/234835/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../234825/index.html">Nice to meet you. Custom</a></li>
<li><a href="../234827/index.html">Database Development with Code First</a></li>
<li><a href="../234829/index.html">Docker image optimization</a></li>
<li><a href="../234831/index.html">What does ITshnik like to love some marketers or marketing guide for an IT startup?</a></li>
<li><a href="../234833/index.html">As I pointed out to the bank on the bugs or data leakage</a></li>
<li><a href="../234837/index.html">Reflections on Personal Information Management</a></li>
<li><a href="../234839/index.html">The 2014 LVEE Conference was held. Results</a></li>
<li><a href="../234841/index.html">Hibernate and PostgreSQL JSON Type</a></li>
<li><a href="../234845/index.html">Study: PHP sites turned out to be the most vulnerable for hackers</a></li>
<li><a href="../234847/index.html">How Wikipedia works (part 3)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>