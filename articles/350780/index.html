<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Thin diskless client based on Ubuntu that does not require mounting the file system over the network</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Image from getwallpapers.com 
 Story 


 Back in 2013, thin clients based on DisklessUbuntu were used in one bank. There were some problems with them,...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Thin diskless client based on Ubuntu that does not require mounting the file system over the network</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://habrastorage.org/webt/8e/05/m0/8e05m0c8bvkugwwlqvcraya_v9u.jpeg" alt="logo ubuntu and windows"><br>  <em>Image from <a href="http://getwallpapers.com/collection/kali-linux-desktop-wallpaper">getwallpapers.com</a></em> </p><br><h2 id="istoriya">  Story </h2><br><p>  <a href="https://help.ubuntu.com/community/DisklessUbuntuHowto">Back</a> in 2013, thin clients based on <a href="https://help.ubuntu.com/community/DisklessUbuntuHowto">DisklessUbuntu were</a> used in one bank.  There were some problems with them, in my opinion, mounting the root filesystem over the network in large branches with a weak network did not work very well.  Then my good friend <a href="https://habrahabr.ru/users/deadroot/">@deadroot</a> made the first version of the thin client, which was loaded entirely into memory, without requiring something to be mounted on the network for work. </p><br><p>  Then I actively finished this client, there were made a lot of useful pieces that are specific to our usage scenario.  Then the bank closed (the license was revoked), the remnants of the client‚Äôs source code moved to my githab: <a href="https://github.com/selivan/thinclient">thunclient</a> .  A couple of times I finished it slightly to order. </p><br><p>  Recently, I got around to making this pile of scary, unreliable scripts a fairly convenient solution to use: </p><br><ul><li>  Vagrant raises virtualku, which can be configured as a normal workstation. </li><li>  One script from it is going to ready for downloading files over the network, the excess is cut. </li><li>  Vagrant brings up a virtual PXE server and a network client to check the resulting build. </li></ul><a name="habracut"></a><br><h2 id="chto-umeet">  What can </h2><br><ul><li>  Entirely loaded into memory, does not require to install the root file system over the network. </li><li>  Built on the basis of Ubuntu, almost any software can be installed from its rich repositories, and connect third-party if something is not enough.  It is especially nice that security updates arrive in Ubuntu fairly quickly. </li><li>  Able to mount overlay root overlay additional.  You can add some software only for some workstations without collecting a new image. </li><li>  <a href="https://www.kernel.org/doc/Documentation/blockdev/zram.txt">Able zram</a> - memory compression, useful for old customers with a small amount of RAM.  Although for the new usually does not hurt. </li><li>  A lightweight desktop (LXDE) with an RDP client is assembled out of the box, the addresses and parameters of the RDP servers are simply transferred from the PXE server via boot parameters. </li><li>  You can change one parameter in the config and a minimal console system will be assembled without too much software - the basis for some of your non-standard builds. </li><li>  If the download fails due to a server or network problem, it will display an error message for a short time and try to load again.  Conveniently, when problems are fixed, the workstations will rise without any extra movements. </li></ul><br><p> In the bank for remote connection to the user's thin client, VNC was used ( <code>x11vnc</code> to connect to the already running Xorg session).  Not everyone needs this (usually there is enough connectivity to the RDP session on the terminal server), and everything is very individual in terms of convenience / security requirements.  Therefore, I did not publish this part. </p><br><h2 id="analogi">  Analogs </h2><br><ul><li>  <a href="http://www.thinstation.org/">Thinstation</a> </li></ul><br><p>  If Thinstation is completely satisfied, then it is better to use it, this is an older and more mature project.  Plus, it is one and a half times smaller in size, after all, this is a specially crafted assembly for a minimum volume, and not a slightly doped regular Ubuntu. </p><br><p>  But the software versions in it are quite ancient and there is little of it.  If you need something extra, in addition to RDP / Citrix / ... clients, you will need to collect it by hand, and so with each update. </p><br><ul><li>  <a href="http://ltsp.org/">Ltsp</a> </li></ul><br><p>  <a href="https://habr.com/ru/users/kvaps/" class="user_link">kvaps</a> pointed out in the <a href="https://habrahabr.ru/post/350780/">comments</a> that LTSP can copy the squashfs image into memory and work without mounting the FS over the network: this is configured by the <a href="https://github.com/kvaps/ltsp/blob/master/client/Debian/share/initramfs-tools/scripts/init-bottom/ltsp">LTSP_NBD_TO_RAM</a> variable.  Use chroot for configuration, which may be less convenient, especially for setting up the graphical environment and applications.  Also a good mature project, can be considered as an alternative. </p><br><h2 id="vagrant-vs-chroot">  Vagrant vs chroot </h2><br><p>  Past versions used chroot, like most similar projects, the same Thinstation for example.  This is not difficult, but still a separate program running in chroot does not correspond to what is happening on a real machine: there is no interaction with system init, with other programs and services.  Plus Vagrant made it possible to make the process of creating the client as simple as possible: the virtual machine is configured as a regular machine. </p><br><p>  Of course, using Vagrant brings some difficulties. </p><br><p>  The machine must be running the <code>virtualbox-guest-utils</code> for shared folders to work.  In addition, you need a boot manager ( <code>grub</code> ), mandatory for a machine with a disk and useless for a client that is downloaded over the network.  I solved these problems, excluding all files of these packages from the assembly.  Therefore, they do not affect the size of the resulting image. </p><br><p>  In addition, for Vagrant, ssh is required to run on a machine, allowing the user to generate a generated key.  I exclude from the assembly the home directory of the vagrant user used for configuration, along with its ssh keys.  Keys for the ubuntu user to be used when running can be put in his home directory. </p><br><p>  Well, for Vagrant to work, it generates settings for network interfaces that will be erroneous for a real machine.  I had to replace the <code>interfaces</code> file at the time of the assembly, and write a script that generates a config on a real machine to configure all available interfaces via DHCP. </p><br><p>  Provisioning is done with Ansible.  This is a very handy tool for configuring all kinds of software and hardware.  But I don‚Äôt want to include Ansible in the final image and the required second python with the necessary libraries: useless ballast.  I don‚Äôt want to put Ansible on a machine where a virtual environment is buried: it will complicate the work. </p><br><p>  Vagrant allows you to do the trick: put Ansible on one machine (test PXE server), and from it do the deployment of other machines, within the same playbook.  To do this, the machines must have a static IP in order to register it in ansible inventory.  Well, the problem with the configuration of the interfaces we solved in the last paragraph. </p><br><h2 id="neposlushnyy-kabachok">  Naughty zucchini </h2><br><p>  <a href="https://en.wikipedia.org/wiki/SquashFS">Squashfs</a> is a compressed read-only file system.  Underlies most existing Linux LiveCDs.  That is, it allows you to create a fairly compact image of the system that fits in the RAM of a thin client. </p><br><p>  From the final image, you need to cut a lot of things: <code>/tmp</code> , <code>/run</code> , <code>/proc</code> , <code>/sys</code> , <code>/usr/share/doc</code> and so on. </p><br><p>  The <code>mksquashfs</code> utility supports as many as 3 types of lists for excluding files: by full path, by masks and by regular expressions.  It would seem that everything is fine.  But the last two options do not support paths starting with <code>/</code> .  I did not manage to exclude all the files inside a certain folder structure, not excluding the last folder. </p><br><p>  I quickly got tired of struggling with it, I just found all the files and folders that I need to exclude with <code>find</code> , and stuffed it into one big file with exceptions in the full path.  Crutches.jpg.  But it works.  The only artifact of this approach in the final image is the lonely folder <code>/proc/NNN</code> , corresponding to the number of the mksquashfs process, which was not yet in the list of exceptions.  Procfs is still mounted above. </p><br><h2 id="magiya-initrd">  Initrd magic </h2><br><p>  In order not to pull into the kernel all the necessary drivers and mounting logic of the root file system, Linux uses an initial ramdisk.  Previously, the initrd format was used, in which this disk was a real image of the file system.  In the 2.6 kernel a new format appeared - initramfs, which is a cpio-archive extracted into tmpfs.  Both initrd and initramfs can be compressed to save load time.  Many utility names and file names still mention the initrd, although it is no longer used. </p><br><p>  In Debian / Ubuntu, the initramfs-tools package is used to create initramfs.  It gives the following options for customization: </p><br><ul><li>  hooks are special format scripts that allow you to add kernel modules and executable files with all the libraries they need to the image </li><li>  scripts in the directories <code>init-bottom</code> , <code>init-premount</code> , <code>init-top</code> , <code>local-block</code> , <code>local-bottom</code> , <code>local-premount</code> , <code>local-top</code> , executed at the appropriate moment of loading.  See <a href="http://manpages.ubuntu.com/manpages/xenial/en/man8/initramfs-tools.8.html">man initramfs-tools (8)</a> </li><li>  the most interesting thing is to add your own boot scripts that are responsible for mounting the root filesystem.  They must define the shell <code>mountroot()</code> function, which will be used by the main <code>/init</code> script.  The composition already has a <code>local</code> for mounting the root on the local disk and <code>nfs</code> for mounting the root over the network.  The script used is selected by the boot parameter <code>boot</code> . </li></ul><br><p>  So, to mount the root file system in some very tricky way, you need to create your own boot script, define the <code>mountroot()</code> function in it, transfer the name of this script in the boot parameter to <code>boot</code> and remember to write hooks that pull all the necessary programs and modules into the initramfs kernels. </p><br><h2 id="borba-za-overlei">  Fight for overlays </h2><br><p>  <a href="https://www.kernel.org/doc/Documentation/filesystems/overlayfs.txt">OverlayFS is</a> used to create a single root file system from several.  The first versions used AUFS (it is used by most Linux LiveCDs).  But it was not accepted into the core, and now everyone is recommended to switch to OverlayFS. </p><br><p>  After the real root FS is mounted in the directory inside the initramfs, the <code>run_init</code> program from the <code>klibc-utils</code> will be launched.  She will check that the root file system is mounted inside the initramfs, clean the initramfs (why waste memory?) And move the root file mount point to <code>/</code> , and start the system init.  <a href="https://askubuntu.com/a/910374/25924">Details</a>  This program is compiled as a separate executable file, because the script that uses any external utilities will break after cleaning up the initramfs. </p><br><p>  If the root file system is assembled from several overlays mounted inside the initramfs, when <code>run_init</code> these mount points disappear and it breaks.  This problem can be solved by moving the overlay mount points <strong>inside the</strong> root file system, where they will not be lost.  Recursion :) It is done like this: <code>mount --move olddir newdir</code> . </p><br><p>  AppArmor had to be disabled: its profiles are designed for direct mounting of the root file system from one device.  When using OverlayFS, it sees that <code>/sbin/dhclient</code> is actually <code>/AUFS/root/sbin/dhclient</code> , and the profile is broken.  The only option to use it is to rewrite all profiles for all applications, and update if necessary. </p><br><h2 id="gde-nuzhna-vozmozhnost-zapisi">  Where do I need to write </h2><br><p>  Under the idea, Linux can work quietly when all filesystems are mounted only for reading.  But many programs are counting on the ability to write to disk, you have to mount tmpfs there: </p><br><ul><li>  <code>/tmp</code> , <code>/var/tmp</code> - clear, needed by very many </li><li>  <code>/var/log</code> - write logs </li><li>  <code>/run</code> - almost all services will not start without it </li><li>  <code>/media</code> - mount mounted media </li><li>  <code>/var/lib/system</code> - used by many programs from systemd, in particular <code>systemd-timesyncd</code> </li><li>  <code>/var/lib/dhclient</code> - here dhclient records information about leases </li><li>  <code>/etc/apparmor.d/cache</code> - if you still beat AppArmor, then it will have to write files in <code>/etc</code>  IMHO disgusting, for such things is <code>/var</code> . </li></ul><br><h2 id="itogo">  Total </h2><br><p>  If you want to build a Ubuntu build that is downloadable from the network and works only from memory, here is a ready-made convenient constructor: <a href="https://github.com/selivan/thinclient">thinclient</a> .  If you need help - write in the LAN or in a ticket on a githaba, I will. </p><br><p>  <strong>PS</strong> <a href="https://selivan.github.io/2018/03/08/ubuntu-based-thin-client.html">English version of the article in my blog</a> . </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/350780/">https://habr.com/ru/post/350780/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../350768/index.html">DigiCert revokes 23 thousand SSL certificates: what is the reason</a></li>
<li><a href="../350772/index.html">Convert React to Angular using a universal abstract tree. Proof of concept</a></li>
<li><a href="../350774/index.html">Java 9 - Have you switched? Not? Do not need ...!?</a></li>
<li><a href="../350776/index.html">Is it easy to speak at a conference for the first time?</a></li>
<li><a href="../350778/index.html">How do you work with Laravel?</a></li>
<li><a href="../350782/index.html">Learn OpenGL. Lesson 4.9 - Geometric Shader</a></li>
<li><a href="../350786/index.html">Do not deny yourself anything: giving carte blanche to uncensored reviews of our events in our blog</a></li>
<li><a href="../350788/index.html">Issue # 14: IT training - current issues and challenges from leading companies</a></li>
<li><a href="../350790/index.html">Lightning Network In Depth, part 2: HTLC And Payment Routing</a></li>
<li><a href="../350792/index.html">Goldman Sachs lured away Google‚Äôs lead engineer to develop an API for his services</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>