<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Two-phase commit and the future of distributed systems</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this article, we will model and investigate a two-phase commit protocol using TLA +. 

 The two-phase commit protocol is practical and is used toda...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Two-phase commit and the future of distributed systems</h1><div class="post__text post__text-html js-mediator-article">  In this article, we will model and investigate a two-phase commit protocol using TLA +. <br><br>  The two-phase commit protocol is practical and is used today in many distributed systems.  However, it is rather short.  Therefore, we can quickly simulate it and learn a lot.  In fact, with this example we will illustrate what result is <i>fundamentally impossible</i> in distributed systems. <br><br><h3>  The problem of two-phase commit </h3><br>  The transaction goes through <b>resource managers (RM)</b> .  All RMs must agree on whether the transaction will be <i>completed</i> or <i>aborted</i> . 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The transaction manager (TM) makes the final decision: <b>commit</b> or <b>cancel</b> .  The prerequisite for a commit is a commitment to committing all RMs.  Otherwise, the transaction should be canceled. <br><a name="habracut"></a><br><h3>  Some notes on modeling </h3><br>  For simplicity, we perform simulations in a shared memory model, not in a messaging system.  It also provides quick model validation.  But we will add non-atomicity to the ‚Äúread from neighboring node and state update‚Äù actions to capture interesting behavior in message passing. <br><br>  RM can only read the TM state and read / update its own state.  He cannot read the status of another resource manager.  TM can read the status of all RM nodes and read / update its own state. <br><br><h3>  Definitions </h3><br><img src="https://habrastorage.org/getpro/habr/post_images/d93/803/abe/d93803abea49766a0fbd7bb1d168c2c1.png"><br><br>  Lines 9-10 set the initial <code>rmState</code> for each RM to <code>working</code> , and TM to <code>init</code> . <br><br>  The predicate <code>canCommit</code> is <code>true</code> if all RMs are ‚Äúprepared‚Äù (ready for commit).  If there is a RM in the "hang up" state, then the predicate <code>canAbort</code> becomes <code>canAbort</code> . <br><br><img src="https://habrastorage.org/getpro/habr/post_images/f2a/8a9/11c/f2a8a911c47b672d4f95b1eb59d11e60.png"><br><br>  TM modeling is simple.  The transaction manager checks for commit or cancellation ‚Äî and updates <code>tmState</code> . <br><br>  There is a possibility that TM will not be able to make <code>tmState</code> ‚Äúinaccessible‚Äù, but only if the <code>TMMAYFAIL</code> constant <code>TMMAYFAIL</code> set to <code>true</code> before starting the model check.  In TLA +, labels define the degree of atomicity, that is, its granularity.  By the labels F1 and F2 we denote that the corresponding operators are executed nonatomic (after some indefinite time) with respect to the previous operators. <br><br><h3>  RM Model </h3><br><img src="https://habrastorage.org/getpro/habr/post_images/425/42e/e7a/42542ee7a105be00451a28460cafc502.png"><br><br>  The RM model is also simple.  Since the ‚Äúworking‚Äù and ‚Äúprepared‚Äù states are non-finite, RM selects non-deterministic among the actions until it reaches the final state.  The ‚Äúworking‚Äù RM can go to the ‚Äúinterrupted‚Äù or ‚Äúprepared‚Äù state.  A ‚Äúprepared‚Äù RM expects a commit / cancel from TM, and acts accordingly.  The figure below shows the possible state transitions for one RM.  But note that we have several RMs, each of which passes through its own states at its own pace without knowing the status of other RMs. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/8d9/b25/0bd/8d9b250bd8aeeba4807f08e1d52a2675.png"><br><br><h3>  Two Phase Commit Model </h3><br><img src="https://habrastorage.org/getpro/habr/post_images/62d/4e6/b1c/62d4e6b1c2046535daddbeeba285c7ac.png"><br><br>  We need to check the consistency of our two-phase commit: so that there are no different RMs, one of which says ‚Äúcommit‚Äù and the other ‚Äúabortion‚Äù. <br><br>  <code>Completed</code> predicate verifies that the protocol does not hang forever: in the end, each RM reaches the <code>committed</code> or <code>aborted</code> final state. <br><br>  Now we are ready to check the protocol model.  Initially, we set <code>TMMAYFAIL=FALSE, RM=1..3</code> to run the protocol with three RMs and one TM, that is, in a reliable configuration.  Verifying the model takes 15 seconds and says that there are no errors.  Both <code>Consistency</code> and <code>Completed</code> satisfied with any possible protocol execution with any alternation of RM actions and TM actions. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/c25/c9e/ed0/c25c9eed093f51eb577cbbb97a4775b2.png"><br><br>  Now set <code>TMMAYFAIL=TRUE</code> and restart the check.  The program quickly produces the opposite result, where RM is stuck waiting for a response from an inaccessible TM. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/652/e12/7ec/652e127ec391fae452f651c27f2855db.png"><br><br>  We see that at the <code>State=4</code> stage, the RM2 transitions are interrupted, the RM3 transitions are interrupted at <code>State=7</code> , the <code>State=8</code> TM goes into the ‚Äúhang up‚Äù state and falls to the <code>State=9</code> .  At <code>State=10</code> system freezes because RM1 remains in a prepared state forever, awaiting a decision from a fallen TM. <br><br><h3>  BTM simulation </h3><br>  To avoid transaction freezes, we add a backup TM (BTM), which quickly takes control if the main TM is unavailable.  For decision making, BTM uses the same logic as TM.  And for simplicity, we assume that BTM never falls. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/43b/96f/842/43b96f8421fe04f10b8adbc573507c36.png"><br><br>  When we check the model with the added BTM process, we get a new error message. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/369/151/826/369151826a6dbe641acb2ae81340b1ea.png"><br><br>  BTM cannot accept a commit, because our original condition <code>canCommit</code> states that all <code>RMstates</code> must be ‚Äúprepared‚Äù and do not take into account the condition that some RMs have already received a decision on a commit from the original TM before BTM took control.  It is necessary to rewrite <code>canCommit</code> conditions taking into account this situation. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/9ed/4cf/bd5/9ed4cfbd55de80c58a7068b246c2375b.png"><br><br>  Success!  When we check the model, we achieve both consistency and completeness, since the BTM takes control and completes the transaction if TM drops.  <a href="">Here is the 2PCwithBTM model in TLA +</a> (BTM and the second line canCommit were originally unpacked) and the <a href="https://www.dropbox.com/s/rx1oq3vxaysysab/2PCwithBTM.pdf%3Fdl%3D0">corresponding pdf</a> . <br><br><h3>  What if RM fails too? </h3><br>  We assumed that RM is reliable.  Now cancel this condition and see how the protocol behaves when RM fails.  Add the "unavailable" state to the failure model.  To investigate the behavior and model intermittent loss of accessibility, let the emergency RM recover and continue working by reading its status from the log.  Here is another RM state transition diagram with the ‚Äúunavailable‚Äù state added and red transitions.  Below is the revised model for RM. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/ff1/f05/b6c/ff1f05b6cd817bb0d4050de4e30f37b6.png"><br><br><img src="https://habrastorage.org/getpro/habr/post_images/94d/91f/8da/94d91f8da2aa4674044a71330da06d4e.png"><br><br>  It is also necessary to modify <code>canAbort</code> , taking into account the state of inaccessibility.  TM may decide to ‚Äúhang up‚Äù if any of the services is in an interrupted or inaccessible state.  If you omit this condition, then the fallen and not restored RM will interrupt the progress of the transaction.  Of course, again, it is necessary to take into account the RMs, who have learned the transaction completion decision from the source TM. <br><br><h3>  Model checking </h3><br><img src="https://habrastorage.org/getpro/habr/post_images/bf7/973/f0f/bf7973f0fd5815dfec816ff93dc03f3c.png"><br><br>  When we check the model, the inconsistency problem arises!  How could this happen?  We trace the trace. <br><br>  With <code>State=6</code> all RMs are in a prepared state, TM decided to complete the transaction, RM1 saw this decision and switched to RC tag, which means it is ready to change its state to ‚Äúcompleted‚Äù.  (Memorize RM1, this gun will fire in the last act).  Unfortunately, TM collapses at <code>State=7</code> , and RM2 becomes unavailable at <code>State=8</code> .  In the ninth step, the backup BTM takes control and reads the state of the three RMs as ‚Äúprepared, unavailable, prepared‚Äù - and decides to cancel the transaction in the tenth step.  Remember RM1?  He decides to complete the transaction, because he received such a decision from the original TM, and goes into the <code>committed</code> state at the 11th step.  In <code>State=13</code> RM3 executes the decision to abort the transaction from the BTM and goes into the <code>aborted</code> state - and now we have broken consistency with RM1. <br><br>  In this case, the BTM made a decision that broke the <b>consistency</b> .  On the other hand, if you force the BTM to wait for the RM to exit from the inaccessible state, it may hang forever in the event of a crash on the node, and this will violate the condition for <b>fulfillment</b> (progress). <br><br>  <a href="">An updated TLA + model file is available here</a> , as well as the <a href="https://www.dropbox.com/s/vkdgugmkjlgb8z6/2PC2withBTM.pdf%3Fdl%3D0">corresponding pdf</a> . <br><br><h3>  Impossibility of FLP </h3><br>  So what happened?  We have stumbled into the <a href="https://www.the-paper-trail.org/post/2008-08-13-a-brief-tour-of-flp-impossibility/">theorem of Fisher, Lynch, Paterson (FLP)</a> about the impossibility of consensus in an asynchronous system with failures. <br><br>  In our example, the BTM cannot correctly decide whether RM2 is in a state of failure or not ‚Äî and it is incorrect to decide to abort the transaction.  If only the original TM made the decision, such an inaccuracy in recognizing the failure would not have become a problem.  RM will comply with any TM decision, so both consistency and implementation progress will be maintained. <br><br>  The problem is that we have two objects make decisions: TM and BTM, they look at the state of RM at different times and make different decisions.  Such asymmetric information is the root of all evil in distributed systems. <br><br>  The problem does not disappear even with the extension to a three-phase commit.  <a href="">Here is a three-phase commit modeled in TLA +</a> ( <a href="https://www.dropbox.com/s/vr2qnkuqlldhmve/3PCwithBTM.pdf%3Fdl%3D0">pdf version</a> ), and the error tracing below shows that progress has been broken this time (on <a href="https://en.wikipedia.org/wiki/Three-phase_commit_protocol">the Wikipedia page on the three-phase commit,</a> the situation is described when RM1 hangs after receiving the solution before the commit and RM2 and RM3 commit commit, which violates consistency). <br><br><img src="https://habrastorage.org/getpro/habr/post_images/0d3/6d8/06d/0d36d806d38003f3cd995bbefbc0802d.png"><br><br><h3>  Paxos is trying to make the world better </h3><br><img src="https://habrastorage.org/webt/q-/o_/wq/q-o_wq_jdl14y0ulz-nud8k4idw.jpeg"><br><br>  But all is not lost, hope is not dead.  <a href="http://muratbuffalo.blogspot.com/search%3Fq%3Dpaxos">We have Paxos</a> .  It acts neatly within the FLP theorem.  The innovation of Paxos is that it is <b>always safe</b> (even in the presence of inaccurate detectors, asynchronous execution and failures), and <b>ultimately ends the transaction</b> when consensus becomes possible. <br><br>  You can emulate TM on a cluster with three Paxos nodes, and this solves the inconsistency problem of TM / BTM.  Or, as Gray and Lamport showed in a <a href="https://lamport.azurewebsites.net/video/consensus-on-transaction-commit.pdf">scientific article on consensus in a commit transaction</a> , if RM uses the Paxos container to store its decisions at the same time as the TM response, this eliminates one extra step in the standard protocol algorithm. </div><p>Source: <a href="https://habr.com/ru/post/434496/">https://habr.com/ru/post/434496/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../434482/index.html">Another year of our blog: the results of 2018</a></li>
<li><a href="../434486/index.html">Loyalty cards. Google Pay API for Passes in ASP.NET</a></li>
<li><a href="../434490/index.html">How we cut the speakerphone with waterjet cutting</a></li>
<li><a href="../434492/index.html">Russia remained in the top ten countries with the cheapest mobile traffic</a></li>
<li><a href="../434494/index.html">What to read. List of Russian-language fiction for 2017 and 2018</a></li>
<li><a href="../434498/index.html">MVP and Dagger 2 - Skeleton Android Application - Part 1</a></li>
<li><a href="../434500/index.html">Black woman named Joan or Watch your ears</a></li>
<li><a href="../434502/index.html">How ‚Äúdigital archaeologists‚Äù discovered the lost version of SimCity for NES and restored it</a></li>
<li><a href="../434504/index.html">20 years of Fast Reports ‚ÄúThe product was created in one breath, just a thrill ...‚Äù</a></li>
<li><a href="../434506/index.html">The experience of publishing an application for video editing in the Microsoft Store</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>