<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Catching unusual SNMP-trap messages in an unusual way</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="We have a large number of D-Link switches in our network, on access. 

 There is a need to take SNMP traps. But it turned out not so simple, because a...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Catching unusual SNMP-trap messages in an unusual way</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/f8e/f59/73c/f8ef5973c3a24dde9a629f8951a4a7cd.jpg"><br><br>  We have a large number of D-Link switches in our network, on access. <br><br>  There is a need to take SNMP traps.  But it turned out not so simple, because a huge number of switches were from the DES-1228 / 1210-28 / 1210-52 series.  These switches seem to be able to send traps, but the server did not want to catch them.  It turned out that traps can catch only an application under Windows, and its name is Smart Console Utility. <br><a name="habracut"></a><br>  Those.  Automate the process of collecting traps, as conceived by the vendor, does not work. <br>  However, packets with SNMP traps, still go to the trap server and have to do something about it. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Without thinking twice, they raised xinetd on the ramp server and began to receive packets with messages.  They came to UDP port 64514. And what was surprising and interesting was that the messages were sent at the end of the packet, in plain text, all that was needed was to cut off the binary unreadable headers. <br><br>  By the way, inetd / xinetd is also called the ‚Äúsuper-Internet server‚Äù, this is a network service that listens for sockets and sends incoming network packets to your application for analysis / storage / and for anything.  Those.  in * nix system, you can write your network service with ‚Äúbare hands‚Äù.  This is truly awesome! <br><br>  Xinetd configuration (/etc/xinetd.d/trap-handler-scu): <br><br><pre><code class="bash hljs">service smart-console-utility { <span class="hljs-built_in"><span class="hljs-built_in">disable</span></span> = no id = <span class="hljs-built_in"><span class="hljs-built_in">trap</span></span>-handler-scu <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> = UNLISTED flags = IPv4 protocol = udp socket_type = dgram user = root <span class="hljs-built_in"><span class="hljs-built_in">wait</span></span> = yes server = /services/snmp/<span class="hljs-built_in"><span class="hljs-built_in">trap</span></span>-handler-scu.php port = 64514 <span class="hljs-comment"><span class="hljs-comment"># log_type = FILE /var/log/xinetd-trap-handler-scu.log # log_on_success = PID HOST # log_on_failure = HOST }</span></span></code> </pre> <br><br>  The code to which each incoming UDP packet will be transmitted (/services/snmp/trap-handler-scu.php): <br>  Written in PHP, because  runs quickly, and after that you can add the ability to add trap messages to the database. <br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/php5 &lt;?php set_time_limit(5); error_reporting(0); $logging = true; // Global logging $debug_logging = false; // Logging debug messages $dump_requests = false; // Save requests $request_buffer_size = 1024; // 1024 Bytes - Maximum request size $log_file = '/var/log/smart-console-utility/smart-console-utility.log'; $req_id = preg_replace(array('/\./', '/(\-)([0-9]{1}$)/', '/(\-)([0-9]{2}$)/', '/(\-)([0-9]{3}$)/'), array('-', '$1---$2', '$1--$2', '$1-$2'), array_sum(explode(' ', microtime()))); $dump_dir = '/tmp/smart-console-utility'; $dump_request_file = $dump_dir.'/'.$req_id.'.request'; // - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - function write_log($message) { global $log_file, $logging, $req_id; if ($logging) {$logging = (file_put_contents($log_file, date('Ymd H:i:s ').'['.$req_id.' '.sprintf('%-14s', $_SERVER['REMOTE_HOST']).'] '.$message."\n", FILE_APPEND) !== false);} } // - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - if ($debug_logging) {write_log('Start');} if ($read_handle = fopen('php://stdin', 'r')) { if (($dump_requests) &amp;&amp; (!is_dir($dump_dir))) { mkdir($dump_dir, 644, true); $dump_requests = is_dir($dump_dir); } // Read client request if ($request = fread($read_handle, $request_buffer_size)) { // Get trap message preg_match('/[\w\d\s\-\(\)\.]+$/', $request, $matches); if ($matches) { $trap_message = preg_replace(array('/\([\d]+\)/', '/[\.]+$/'), '', preg_replace('/[ ]{2,}/', ' ', preg_replace('/^.DES/', 'DES', trim(end($matches)) ) ) ); } else {$trap_message = '';} if ($logging) {write_log($trap_message);} if ($debug_logging) {write_log('Handle request, size('.strlen($request).")\t-&gt; ".$trap_message);} if ($dump_requests) {file_put_contents($dump_request_file, $request, FILE_APPEND);} // Parse trap message } else {write_log('Null request');} fclose($read_handle); } else {write_log('Unable to open STDIN!');} if ($debug_logging) {write_log('End');} ?&gt;</span></span></code> </pre> <br><br>  As a result, the following journal entries will be obtained: <br><br><pre> <code class="bash hljs">2014-09-12 06:25:50 SCU--1410485150-0287 10.X.0.26 DES-1210-28 Port 2 copper link up 2014-09-12 06:25:50 SCU--1410485150-3536 10.X.0.18 DES-1210-52 Port 9 copper link up 2014-09-12 06:25:50 SCU--1410485150-7605 10.X.0.31 DES-1210-52 Port 48 copper link up 2014-09-12 06:25:52 SCU--1410485152-9745 10.X.0.104 DES-1210-28 Port 10 copper link up 2014-09-12 06:25:55 SCU--1410485155-5064 10.X.0.11 DES-1210-52 Port 28 copper link up 2014-09-12 06:25:55 SCU--1410485155-7615 10.X.0.31 DES-1210-52 Port 48 copper link up 2014-09-12 06:25:58 SCU--1410485158-7782 10.X.0.31 DES-1210-52 Port 48 copper link up 2014-09-12 06:26:01 SCU--1410485161-4395 10.X.0.31 DES-1210-52 Port 48 copper link up 2014-09-12 06:26:04 SCU--1410485164-0377 10.X.0.31 DES-1210-52 Port 48 copper link up 2014-09-12 06:26:04 SCU--1410485164-3473 10.X.0.18 DES-1210-52 Port 9 copper link up 2014-09-12 06:26:06 SCU--1410485166-0395 10.X.0.31 DES-1210-52 Port 48 copper link up 2014-09-12 06:26:07 SCU--1410485167-1539 10.X.0.31 DES-1210-52 Port 47 copper link up 2014-09-12 06:26:07 SCU--1410485167-2226 10.X.0.128 DES-1210-28 Port 2 copper link up</code> </pre><br><br>  By the way, this conclusion shows the ‚Äúcollapse‚Äù of the port (port-flapping), the line ‚ÄúDES-1210-52 Port 48 copper link up‚Äù is repeated many times.  It indicates that something is wrong with the port or cable. <br><br>  Defect on the port is found - the task is completed. </div><p>Source: <a href="https://habr.com/ru/post/236897/">https://habr.com/ru/post/236897/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../236885/index.html">The first intermediate results of the competition Android-developers Moverio Apps Market</a></li>
<li><a href="../236887/index.html">The results of the survey ‚ÄúHow I work‚Äù and some disappointing conclusions</a></li>
<li><a href="../236889/index.html">Opera 25 Beta: Bookmarks and New Express Panel</a></li>
<li><a href="../236891/index.html">And what does your grandmother know about IT?</a></li>
<li><a href="../236893/index.html">ESA specialists selected a primary and alternative landing point for the Philae / Rosetta probe on the comet Churyumov-Gerasimenko</a></li>
<li><a href="../236899/index.html">Amateur and back-engineering. Part 1: Paths and Files</a></li>
<li><a href="../236901/index.html">Probabilistic law of the distribution of the duration of a session of an artificial Earth satellite with a ground object</a></li>
<li><a href="../236903/index.html">Behind smart carts the future of retail, or How I invented the wheel</a></li>
<li><a href="../236905/index.html">Bummer Live Apple</a></li>
<li><a href="../236907/index.html">How I developed a markup language translator</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>