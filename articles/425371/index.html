<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Node.JS: a library for modifying http responses</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Some time ago, I wrote a site with a backend on Express /Node.JS. There was a problem with the minification of answers. I found many ready-made packag...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Node.JS: a library for modifying http responses</h1><div class="post__text post__text-html js-mediator-article">  Some time ago, I wrote a site with a backend on <a href="">Express</a> /Node.JS.  There was a problem with the minification of answers.  I found many ready-made packages, but everyone had a problem - html was not minified after the templates.  As a result, I decided to write my own small and native bicycle - the <a href="https://github.com/dmitriym09/web-minify">web-minify library</a> , which allows you to embed a hook before sending it to the client and modify the response. <br><a name="habracut"></a><br><h3>  Package installation </h3><br><pre><code class="bash hljs">npm i @dmitriym09/web-minify --save</code> </pre> <br>  I think the best library description for a developer is code sample =) <br><br><h2>  Example </h2><br>  <a href="https://github.com/dmitriym09/web-minify">web-minify</a> - middleware-function: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> htmlminify = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'html-minifier'</span></span>).minify; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> csso = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'csso'</span></span>).minify; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> postcss = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'postcss'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> precss = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'precss'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> autoprefixer = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'autoprefixer'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> minify = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'web-minify'</span></span>); app.use(minify([ { <span class="hljs-attr"><span class="hljs-attr">contentType</span></span>: <span class="hljs-regexp"><span class="hljs-regexp">/css/</span></span>, <span class="hljs-attr"><span class="hljs-attr">minify</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> (data, req, res) =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> resData = (<span class="hljs-keyword"><span class="hljs-keyword">await</span></span> postcss([precss, autoprefixer]).process(data, { <span class="hljs-attr"><span class="hljs-attr">from</span></span>: <span class="hljs-literal"><span class="hljs-literal">undefined</span></span> })).css; resData = csso(resData).css; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> resData; } } ]));</code> </pre> <br>  In this example, all responses with a Content-Type containing the substring "css" will be intercepted.  The response body is processed using <a href="">csso</a> , <a href="">postcss</a> , <a href="">precss</a> , <a href="">autoprefixer</a> .  The contentType parameter is passed to a String (an entry of String.prototype.indexOf () will be searched for) or RegExp (RegExp.prototype.test ()).  The minify parameter, the Function function (data: String, req: Request, res: Response), must return a String with a new body or Promise, which in turn is resolved to a String.  If an exception is not caught, the client will receive a response of 500. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      As already said, most of the existing popular libraries with similar functionality well minify static files.  However, the minification of the responses generated in the code (for example, html template) does not work.  One of the problems is that the response can be sent in parts, and for processing, you usually need complete data.  Accordingly, it is necessary to intercept all sending to the user, collect and already at the end process and send.  This must be taken into account when using <a href="https://github.com/dmitriym09/web-minify">web-minify</a> : the terabyte file that you want to send to the client and which falls under the contentType will accumulate in memory. <br><br><h2>  Examples </h2><br><h3>  HTML minification with <a href="">html-minifier</a> from unit tests </h3><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> htmlminify = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'html-minifier'</span></span>).minify; it(<span class="hljs-string"><span class="hljs-string">'HTML'</span></span>, (done) =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> app = createServer([minify([ { <span class="hljs-attr"><span class="hljs-attr">contentType</span></span>: <span class="hljs-string"><span class="hljs-string">'html'</span></span>, <span class="hljs-attr"><span class="hljs-attr">minify</span></span>: <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">data</span></span></span><span class="hljs-function">) =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> res = htmlminify(data, { <span class="hljs-attr"><span class="hljs-attr">removeAttributeQuotes</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">collapseWhitespace</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">conservativeCollapse</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-attr"><span class="hljs-attr">decodeEntities</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">keepClosingSlash</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-attr"><span class="hljs-attr">preserveLineBreaks</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, preventAttributesEscapin, <span class="hljs-attr"><span class="hljs-attr">processConditionalComments</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">removeAttributeQuotes</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">removeComments</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">trimCustomFragments</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">useShortDoctype</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span> }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> res; } } ])], <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">req, res</span></span></span><span class="hljs-function">) </span></span>{ res.setHeader(<span class="hljs-string"><span class="hljs-string">'Content-Type'</span></span>, <span class="hljs-string"><span class="hljs-string">'text/html; charset=utf-8'</span></span>); res.end(<span class="hljs-string"><span class="hljs-string">`&lt;!DOCTYPE html&gt; &lt;html lang="en"&gt; &lt;head&gt; &lt;meta charset="utf-8"&gt; &lt;/head&gt; &lt;body&gt; &lt;h1&gt;Test&lt;/h1&gt; &lt;p&gt;Test&lt;/p&gt; &lt;/body&gt;`</span></span>); }); request(app) .get(<span class="hljs-string"><span class="hljs-string">'/'</span></span>) .set(<span class="hljs-string"><span class="hljs-string">'Accept'</span></span>, <span class="hljs-string"><span class="hljs-string">'text/html; charset=utf-8'</span></span>) .expect(<span class="hljs-string"><span class="hljs-string">'Content-Type'</span></span>, <span class="hljs-string"><span class="hljs-string">'text/html; charset=utf-8'</span></span>) .expect(<span class="hljs-string"><span class="hljs-string">'&lt;!doctype html&gt;&lt;html lang=en&gt;&lt;head&gt;&lt;meta charset=utf-8&gt;&lt;/head&gt;&lt;body&gt;&lt;h1&gt;Test&lt;/h1&gt;&lt;p&gt;Test&lt;/p&gt;&lt;/body&gt;&lt;/html&gt;'</span></span>) .expect(<span class="hljs-number"><span class="hljs-number">200</span></span>) .end(done) });</code> </pre> <br><h3>  JSON and response code modifications with Promise return from unit tests </h3><br><pre> <code class="javascript hljs">it(<span class="hljs-string"><span class="hljs-string">'JSON'</span></span>, (done) =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> app = createServer([minify([ { <span class="hljs-attr"><span class="hljs-attr">contentType</span></span>: <span class="hljs-regexp"><span class="hljs-regexp">/json/</span></span>, <span class="hljs-attr"><span class="hljs-attr">minify</span></span>: <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">data, req, res</span></span></span><span class="hljs-function">) =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">resolve, reject</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { res.statusCode = <span class="hljs-number"><span class="hljs-number">456</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> o = <span class="hljs-built_in"><span class="hljs-built_in">JSON</span></span>.parse(data); o.dt = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Date</span></span>(<span class="hljs-string"><span class="hljs-string">'2018-09-28T11:05:13.492Z'</span></span>) resolve(<span class="hljs-built_in"><span class="hljs-built_in">JSON</span></span>.stringify(o)) } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span>(exc) { reject(exc) } }) } } ])], <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">req, res</span></span></span><span class="hljs-function">) </span></span>{ res.setHeader(<span class="hljs-string"><span class="hljs-string">'Content-Type'</span></span>, <span class="hljs-string"><span class="hljs-string">'application/json; charset=utf-8'</span></span>); res.end(<span class="hljs-built_in"><span class="hljs-built_in">JSON</span></span>.stringify({<span class="hljs-attr"><span class="hljs-attr">a</span></span>: <span class="hljs-number"><span class="hljs-number">12</span></span>})); }); request(app) .get(<span class="hljs-string"><span class="hljs-string">'/'</span></span>) .set(<span class="hljs-string"><span class="hljs-string">'Accept'</span></span>, <span class="hljs-string"><span class="hljs-string">'applicatio3n/json; charset=utf-8'</span></span>) .expect(<span class="hljs-string"><span class="hljs-string">'Content-Type'</span></span>, <span class="hljs-string"><span class="hljs-string">'application/json; charset=utf-8'</span></span>) .expect(<span class="hljs-string"><span class="hljs-string">'{"a":12,"dt":"2018-09-28T11:05:13.492Z"}'</span></span>) .expect(<span class="hljs-number"><span class="hljs-number">456</span></span>) .end(done) });</code> </pre> <br>  <a href="https://github.com/dmitriym09/web-minify">Web-minify</a> is available on <a href="https://github.com/dmitriym09/web-minify">github</a> and in <a href="https://www.npmjs.com/package/%40dmitriym09/web-minify">npm</a> under the MIT license. <br><br>  Thanks for attention!  Criticism, suggestions and comments are welcome! </div><p>Source: <a href="https://habr.com/ru/post/425371/">https://habr.com/ru/post/425371/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../425359/index.html">The Chinese used a microchip to control American computers.</a></li>
<li><a href="../425361/index.html">Content blocking, chromium browser extension</a></li>
<li><a href="../425363/index.html">Tips for student programmers</a></li>
<li><a href="../425367/index.html">Simplest Arduino Game with Display 1602 - Part # 2</a></li>
<li><a href="../425369/index.html">KTRU (Catalog of goods, works, services) or the death of IT public procurement</a></li>
<li><a href="../425373/index.html">QA Fest 2018: Review of the Main QA Conference of Ukraine</a></li>
<li><a href="../425375/index.html">Another way to see application communications</a></li>
<li><a href="../425377/index.html">If digital product designers were creating real things.</a></li>
<li><a href="../425379/index.html">Charles Nutter. How to transfer an ancient monolithic project to JRuby and is it worth it?</a></li>
<li><a href="../425383/index.html">Jet Infosystems, Rosreestr, NLMK and Utkonos launch AI hackathon</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>