<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>REST interface generator framework vibe.d</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this article, I will show you step by step how to use the rest interface generator built into the vibe.d framework. If you are interested in D and ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>REST interface generator framework vibe.d</h1><div class="post__text post__text-html js-mediator-article">  In this article, I will show you step by step how to use the rest interface generator built into the vibe.d framework.  If you are interested in D and its features, then this article, I hope, will slightly clarify to beginners how to use D in practice and learn all of its power. <br><br>  For this we need: <br><ol><li>  Configure eclipse to work with vibe.d.  <sup>for beginners</sup> </li><li>  Launch ‚ÄúHello World‚Äù on vibe.d.  <sup>for beginners</sup> </li><li>  Create a client for the OpenWeatherMap api. </li><li>  Create a backup server based on the OpenWeatherMap api </li></ol><br>  The documentation for vibe.d has <a href="http://vibed.org/docs">an example of</a> using a generator.  However, this example, in my opinion, is too simple and does not reveal the mechanism of the generator. <br><a name="habracut"></a><br><h4>  Training </h4><br>  For the D language, there are many programming tools, including both individual full-fledged ides and plug-ins to existing ones.  I chose the DDT plugin for eclipse for myself, because thanks to the cross-platform eclipse allows me not to be tied to one operating system. <br><div class="spoiler">  <b class="spoiler_title">Instruments</b> <div class="spoiler_text"><ul><li>  Download and install <a href="http://dlang.org/download.html">dmd</a> . </li><li>  Download and install <a href="http://source.dlang.org/download">dub</a> .  From now on, you can program in D. However, we need ide. </li><li>  Download and install <a href="https://www.eclipse.org/downloads/">eclipse</a> . </li><li>  Install <a href="">ddt.</a> </li></ul><br>  At this point, the installation can be considered complete.  Next, we will customize the project.  By the way, the standard DDT settings are suitable for writing simple programs, like ‚Äúhello world‚Äù, although for such purposes a regular console is perfect, not to mention the built-in support for D with the sublime text editor. <br><br>  For something more complicated, dub is convenient to use as a collector.  To do this, disable the standard ddt builders: Project-&gt; Properties-&gt; Builders, and add a dub there that is launched from the directory with your project and the build argument.  I also advise you to check that in the menu Window-&gt; Preferences-&gt; DDT-&gt; Compilers there is a dmd compiler.  If not, indicate the path to it.  Then ddt will have access to the standard phobos library. <br></div></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <div class="spoiler">  <b class="spoiler_title">Hello World on vibe.d</b> <div class="spoiler_text"><ul><li>  Initialize the project: <pre><code class="hljs swift">dub <span class="hljs-keyword"><span class="hljs-keyword">init</span></span> helloVibe</code> </pre> </li><li>  Edit dub.json.  Add there the following <br><br><pre> <code class="hljs objectivec"><span class="hljs-string"><span class="hljs-string">"libs-posix"</span></span>: [<span class="hljs-string"><span class="hljs-string">"dl"</span></span>], <span class="hljs-string"><span class="hljs-string">"versions"</span></span>: [<span class="hljs-string"><span class="hljs-string">"VibeCustomMain"</span></span>], <span class="hljs-string"><span class="hljs-string">"dependencies"</span></span>: { <span class="hljs-string"><span class="hljs-string">"vibe-d"</span></span>: <span class="hljs-string"><span class="hljs-string">"~master"</span></span> }</code> </pre><br><br></li><li>  Then from the helloVibe directory <pre> <code class="bash hljs">dub run</code> </pre>  Congratulations, your first program on D earned. </li><li>  Create a project in eclipse.  And as a library, add the source folder <pre> <code class="hljs mel">%APPDATA%/dub/packages/vibe-d-master/<span class="hljs-keyword"><span class="hljs-keyword">source</span></span></code> </pre>  Now autocompletion is our assistant. </li><li>  Run vibe.d.  To do this, we need to start listening to the port and run a loop of events.  This is done by functions <pre> <code class="hljs lisp">listenHTTP(<span class="hljs-name"><span class="hljs-name">HTTPServerSettings</span></span>,URLRouter)</code> </pre> <pre> <code class="hljs lisp">runEventLoop()</code> </pre>  respectively.  You also need to create server settings and configure the router. </li><li>  Create the settings as follows: <br><br><pre> <code class="hljs cpp"><span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> settings = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HTTPServerSettings; settings.bindAddresses = [<span class="hljs-string"><span class="hljs-string">"127.0.0.1"</span></span>]; settings.port = <span class="hljs-number"><span class="hljs-number">80</span></span>;</code> </pre></li><li>  Do not forget to connect the vibe: <pre> <code class="hljs swift"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> vibe.d;</code> </pre> </li><li>  The router will have one address available using the GET method. <br><br><pre> <code class="hljs pgsql">auto router = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> URLRouter; router.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>("/", &amp;<span class="hljs-keyword"><span class="hljs-keyword">index</span></span>);</code> </pre><br><br></li><li>  And the handler function: <br><br><pre> <code class="hljs cs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">index</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">HTTPServerRequest req, HTTPServerResponse res</span></span></span><span class="hljs-function">)</span></span> { res.writeBody(<span class="hljs-string"><span class="hljs-string">"Hello World!"</span></span>); }</code> </pre><br><br>  A handler can be either a function or a delegate, which is very convenient and allows you to use class methods as handlers.  This feature is used in both the REST interface generator and the Web interface generator. </li><li>  It remains to call all in the right order: <br><br><pre> <code class="hljs cpp"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>.stdio; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> vibe.d; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ writeln(<span class="hljs-string"><span class="hljs-string">"Edit source/app.d to start your project."</span></span>); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">index</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(HTTPServerRequest req, HTTPServerResponse res)</span></span></span><span class="hljs-function"> </span></span>{ res.writeBody(<span class="hljs-string"><span class="hljs-string">"Hello World!"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> settings = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HTTPServerSettings; settings.bindAddresses = [<span class="hljs-string"><span class="hljs-string">"127.0.0.1"</span></span>]; settings.port = <span class="hljs-number"><span class="hljs-number">80</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> router = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> URLRouter; router.get(<span class="hljs-string"><span class="hljs-string">"/"</span></span>, &amp;index); listenHTTP(settings, router); runEventLoop(); }</code> </pre><br><br></li><li><pre> <code class="bash hljs">dub run</code> </pre>  .  Congratulations, your first server on vibe.d is ready. </li></ul><br></div></div><br><br><h4>  Rest interface generator </h4><br><br><h5>  Customer </h5><br><br>  Vibe.d is suitable for writing servers and clients. <br>  To create a rest interface, you must declare the interface (which is logical).  In this article we will consider the client for <a href="http://openweathermap.org/api">the</a> OpenWeatherMap <a href="http://openweathermap.org/api">API</a> .  This API has only one weather method with the q parameter.  So let's write <br><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-title"><span class="hljs-title">OpenWeather</span></span> { <span class="hljs-function"><span class="hljs-function">Weather </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getWeather</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> q</span></span></span><span class="hljs-function">)</span></span>; }</code> </pre><br><br>  The response from the server will automatically be converted to a Weather structure.  We will describe it according to the OpenWeatherMap API. <br><div class="spoiler">  <b class="spoiler_title">The structure into which the server response is converted</b> <div class="spoiler_text"><pre> <code class="hljs perl">struct Weather { @Label(<span class="hljs-string"><span class="hljs-string">"City identification"</span></span>) long id; @Label(<span class="hljs-string"><span class="hljs-string">"Data receiving time, unix time, GMT"</span></span>) ulong dt; @Label(<span class="hljs-string"><span class="hljs-string">"City name"</span></span>) string name; WCoord coord; WSys sys; WMain main; WWind wind; WClouds clouds; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>@optional() //WConditions[] weather; @optional() WRain rain; @optional() WSnow snow; } struct WCoord { @Label(<span class="hljs-string"><span class="hljs-string">"City geo location, lat"</span></span>) double lat; @Label(<span class="hljs-string"><span class="hljs-string">"City geo location, lon"</span></span>) double lon; } struct WSys { @Label(<span class="hljs-string"><span class="hljs-string">"System parameter, do not use it"</span></span>) double message; @Label(<span class="hljs-string"><span class="hljs-string">"Country (GB, JP etc.)"</span></span>) string country; @Label(<span class="hljs-string"><span class="hljs-string">"Sunrise time, unix, UTC"</span></span>) ulong sunrise; @Label(<span class="hljs-string"><span class="hljs-string">"Sunset time, unix, UTC"</span></span>) ulong sunset; } struct WMain { @Label(<span class="hljs-string"><span class="hljs-string">"Temperature, Kelvin (subtract 273.15 to convert to Celsius)"</span></span>) double temp; @Label(<span class="hljs-string"><span class="hljs-string">"Humidity, %") double humidity; @Label("</span></span>Minimum temperature at the moment. This is deviation from current temp that is possible <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> large cities <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> megalopolises geographically expanded (<span class="hljs-keyword"><span class="hljs-keyword">use</span></span> these parameter optionally)<span class="hljs-string"><span class="hljs-string">") double temp_min; @Label("</span></span>Maximum temperature at the moment. This is deviation from current temp that is possible <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> large cities <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> megalopolises geographically expanded (<span class="hljs-keyword"><span class="hljs-keyword">use</span></span> these parameter optionally)<span class="hljs-string"><span class="hljs-string">") double temp_max; @Label("</span></span>Atmospheric pressure, hPa <span class="hljs-string"><span class="hljs-string">") double pressure; @Label("</span></span>Atmospheric pressure on the sea level, hPa<span class="hljs-string"><span class="hljs-string">") @optional() double sea_level; @Label("</span></span>Atmospheric pressure on the ground level, hPa<span class="hljs-string"><span class="hljs-string">") @optional() double grnd_level; } struct WWind { @Label("</span></span>Wind speed, mps<span class="hljs-string"><span class="hljs-string">") double speed; @Label("</span></span>Wind direction, degrees (meteorological)<span class="hljs-string"><span class="hljs-string">") double deg; @Label("</span></span>Wind gust, mps<span class="hljs-string"><span class="hljs-string">") @optional() double gust; } struct WClouds { @Label("</span></span>Cloudiness, %") double all; } struct WConditions { @Label(<span class="hljs-string"><span class="hljs-string">"Weather condition id"</span></span>) long id; @Label(<span class="hljs-string"><span class="hljs-string">"Group of weather parameters (Rain, Snow, Extreme etc.)"</span></span>) Weather main; @Label(<span class="hljs-string"><span class="hljs-string">"Weather condition within the group"</span></span>) string description; @Label(<span class="hljs-string"><span class="hljs-string">"Weather icon id"</span></span>) string icon; } struct WRain { @Label(<span class="hljs-string"><span class="hljs-string">"Precipitation volume for last 3 hours, mm"</span></span>) @optional() double _3h; } struct WSnow { @Label(<span class="hljs-string"><span class="hljs-string">"Snow volume for last 3 hours, mm"</span></span>) @optional() double _3h; }</code> </pre><br>  A couple of words about the shoals of vibe.d. <br>  First, deserialization of arrays from user types does not work well. <br>  Secondly, due to the peculiarities of such a programming language, variables cannot begin with a digit (this is not only the case with d).  I would write this joint to the OpenWeatherMap API account, not vibe.d, since, IMHO, this moment was poorly thought out by the API developers. <br></div></div><br>  D allows us to centrally manage the response.  The <a href="http://habrahabr.ru/users/label/" class="user_link">Label</a> () attribute (here "doggy") contains a description of the variable, @optional () tells the generator that this field may not be contained in the server's response.  <a href="http://habrahabr.ru/users/label/" class="user_link">Label</a> () is user defined, it allows, for example, not to worry about the correspondence of the description and variable. <pre> <code class="hljs dos"><span class="hljs-built_in"><span class="hljs-built_in">Label</span></span></code> </pre>  is a structure: <br><br><pre> <code class="hljs cpp"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Label</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-built_in"><span class="hljs-built_in">string</span></span> text; }</code> </pre><br><br>  All that remains is to create an interface client.  This is done like this: <br><br><pre> <code class="hljs axapta">auto <span class="hljs-keyword"><span class="hljs-keyword">client</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RestInterfaceClient!OpenWeather(<span class="hljs-string"><span class="hljs-string">"http://api.openweathermap.org/data/2.5/"</span></span>);</code> </pre><br><br>  Here through the "!"  interface passed.  This means that the RestInterfaceClient template class uses it in compiletime.  In D, your program runs first in compiletime and then in runtime.  In compiletime, the template is instantiated; in other words, a special class is generated, the object of which will be used during program execution. <br>  If the method starts with get *, then the generator will register this handler using the GET method, similarly for post *, put *, delete *.  You can not specify a method at all, then the generator itself will determine how to deal with it.  For more information, see the documentation for vibe.d. <br><div class="spoiler">  <b class="spoiler_title">Rewrite the index function</b> <div class="spoiler_text"><br><pre> <code class="hljs pgsql"><span class="hljs-type"><span class="hljs-type">void</span></span> <span class="hljs-keyword"><span class="hljs-keyword">index</span></span>(HTTPServerRequest req, HTTPServerResponse res) { auto client = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> RestInterfaceClient!OpenWeather("http://api.openweathermap.org/data/2.5/"); auto weather = client.getWeather("Moscow"); string result = "&lt;html&gt;"; <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">each</span></span>; respond(weather)) { auto writer = res.bodyWriter(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">each</span></span>.label.empty) { result ~=format("&lt;b&gt;%s&lt;/b&gt;:&lt;br/&gt;\"%s\" = %s&lt;br/&gt;", <span class="hljs-keyword"><span class="hljs-keyword">each</span></span>.label, <span class="hljs-keyword"><span class="hljs-keyword">each</span></span>.name, <span class="hljs-keyword"><span class="hljs-keyword">each</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { result ~= format("&lt;i&gt;%s&lt;/i&gt;&lt;br/&gt;", <span class="hljs-keyword"><span class="hljs-keyword">each</span></span>.name); } } result ~= "&lt;/html&gt;"; res.writeBody(result); }</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Respond function</b> <div class="spoiler_text"><br><pre> <code class="hljs cs">import std.traits; import std.conv; <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> A { <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> name; <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> label; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getLabel</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">alias</span></span></span></span><span class="hljs-function"><span class="hljs-params"> ST, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">alias</span></span></span></span><span class="hljs-function"><span class="hljs-params"> mem</span></span></span><span class="hljs-function">)(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (attr; __traits(getAttributes, __traits(getMember,ST,mem))) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">is</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(attr) == Label)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> attr.text; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">""</span></span>; } <span class="hljs-function"><span class="hljs-function">A[] </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">respond</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ST</span></span></span><span class="hljs-function">)(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ST st</span></span></span><span class="hljs-function">)</span></span> { A[] ret = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> A[<span class="hljs-number"><span class="hljs-number">0</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span>(mem; __traits(derivedMembers, ST)) { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">if</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">is</span></span></span></span><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">typeof</span></span></span></span><span class="hljs-function"><span class="hljs-params">(__traits(getMember,ST,mem</span></span></span><span class="hljs-function">))</span></span> == <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span>)) { ret ~= A(mem,<span class="hljs-string"><span class="hljs-string">""</span></span>,<span class="hljs-string"><span class="hljs-string">""</span></span>); ret ~= respond!(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(__traits(getMember,ST,mem)))(__traits(getMember,st, mem)); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { ret ~= A(mem, to!<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>(__traits(getMember,st, mem)), getLabel!(ST,mem) ); } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ret; }</code> </pre><br><br>  The getLabel template restores the description to a variable (I wrote above about matching the variable and the description).  The respond template collects variable names, their values ‚Äã‚Äãand descriptions into a convenient array of structures A. <br><br>  After the project is assembled and launched, at <a href="http://127.0.0.1/">127.0.0.1</a> we will receive detailed information about the weather in Moscow. <br></div></div><br><br><h5>  Server </h5><br>  You can create a server by creating a class that releases the API, that is, the class OpenWeatherMapImpl. <br><br><pre> <code class="hljs cpp"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">OpenWeatherImpl</span></span></span><span class="hljs-class">:</span></span>OpenWeather { <span class="hljs-function"><span class="hljs-function">Weather </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getWeather</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> q)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> client = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RestInterfaceClient!OpenWeather(<span class="hljs-string"><span class="hljs-string">"http://api.openweathermap.org/data/2.5/"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> client.getWeather(q); } }</code> </pre><br><br>  This class duplicates the readings of the official OpenWeatherMap server.  We register the interface <pre> <code class="hljs cs">router.registerRestInterface(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> OpenWeatherImpl);</code> </pre> <br><br><div class="spoiler">  <b class="spoiler_title">Together</b> <div class="spoiler_text"><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> std.traits; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> std.conv; struct Label { string <span class="hljs-type"><span class="hljs-type">text</span></span>; } struct A { string <span class="hljs-type"><span class="hljs-type">name</span></span>; string <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>; string label; } string getLabel(<span class="hljs-keyword"><span class="hljs-keyword">alias</span></span> ST, <span class="hljs-keyword"><span class="hljs-keyword">alias</span></span> mem)() { <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (attr; __traits(getAttributes, __traits(getMember,ST,mem))) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">is</span></span>(typeof(attr) == Label)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> attr.text; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ""; } A[] respond(ST)(ST st) { A[] ret = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> A[<span class="hljs-number"><span class="hljs-number">0</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span>(mem; __traits(derivedMembers, ST)) { static <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">is</span></span>(typeof(__traits(getMember,ST,mem)) == struct)) { ret ~= A(mem,"",""); ret ~= respond!(typeof(__traits(getMember,ST,mem)))(__traits(getMember,st, mem)); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { ret ~= A(mem, <span class="hljs-keyword"><span class="hljs-keyword">to</span></span>!string(__traits(getMember,st, mem)), getLabel!(ST,mem) ); } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ret; } struct Weather { @Label("City identification") long id; @Label("Data receiving time, unix time, GMT") ulong dt; @Label("City name") string <span class="hljs-type"><span class="hljs-type">name</span></span>; WCoord coord; WSys sys; WMain main; WWind wind; WClouds clouds; //@optional() //WConditions[] weather; @optional() WRain rain; @optional() WSnow snow; } struct WCoord { @Label("City geo location, lat") <span class="hljs-type"><span class="hljs-type">double</span></span> lat; @Label("City geo location, lon") <span class="hljs-type"><span class="hljs-type">double</span></span> lon; } struct WSys { @Label("System parameter, do not use it") <span class="hljs-type"><span class="hljs-type">double</span></span> message; @Label("Country (GB, JP etc.)") string country; @Label("Sunrise time, unix, UTC") ulong sunrise; @Label("Sunset time, unix, UTC") ulong sunset; } struct WMain { @Label("Temperature, Kelvin (subtract 273.15 to convert to Celsius)") <span class="hljs-type"><span class="hljs-type">double</span></span> <span class="hljs-keyword"><span class="hljs-keyword">temp</span></span>; @Label("Humidity, %") <span class="hljs-type"><span class="hljs-type">double</span></span> humidity; @Label("Minimum temperature at the moment. This is deviation from current temp that is possible for large cities and megalopolises geographically expanded (use these parameter optionally)") <span class="hljs-type"><span class="hljs-type">double</span></span> temp_min; @Label("Maximum temperature at the moment. This is deviation from current temp that is possible for large cities and megalopolises geographically expanded (use these parameter optionally)") <span class="hljs-type"><span class="hljs-type">double</span></span> temp_max; @Label("Atmospheric pressure, hPa ") <span class="hljs-type"><span class="hljs-type">double</span></span> pressure; @Label("Atmospheric pressure on the sea level, hPa") @optional() <span class="hljs-type"><span class="hljs-type">double</span></span> sea_level; @Label("Atmospheric pressure on the ground level, hPa") @optional() <span class="hljs-type"><span class="hljs-type">double</span></span> grnd_level; } struct WWind { @Label("Wind speed, mps") <span class="hljs-type"><span class="hljs-type">double</span></span> speed; @Label("Wind direction, degrees (meteorological)") <span class="hljs-type"><span class="hljs-type">double</span></span> deg; @Label("Wind gust, mps") @optional() <span class="hljs-type"><span class="hljs-type">double</span></span> gust; } struct WClouds { @Label("Cloudiness, %") <span class="hljs-type"><span class="hljs-type">double</span></span> <span class="hljs-keyword"><span class="hljs-keyword">all</span></span>; } struct WConditions { @Label("Weather condition id") long id; @Label("Group of weather parameters (Rain, Snow, Extreme etc.)") Weather main; @Label("Weather condition within the group") string description; @Label("Weather icon id") string icon; } struct WRain { @Label("Precipitation volume for last 3 hours, mm") @optional() <span class="hljs-type"><span class="hljs-type">double</span></span> _3h; } struct WSnow { @Label("Snow volume for last 3 hours, mm") @optional() <span class="hljs-type"><span class="hljs-type">double</span></span> _3h; } interface OpenWeather { Weather getWeather(string q); } <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> OpenWeatherImpl:OpenWeather { Weather getWeather(string q) { auto client = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> RestInterfaceClient!OpenWeather("http://api.openweathermap.org/data/2.5/"); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> client.getWeather(q); } } <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> std.stdio; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> vibe.d; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> std.string; <span class="hljs-type"><span class="hljs-type">void</span></span> main() { writeln("Edit source/app.d to start your project."); <span class="hljs-type"><span class="hljs-type">void</span></span> <span class="hljs-keyword"><span class="hljs-keyword">index</span></span>(HTTPServerRequest req, HTTPServerResponse res) { auto client = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> RestInterfaceClient!OpenWeather("http://api.openweathermap.org/data/2.5/"); auto weather = client.getWeather("Moscow"); string result = "&lt;html&gt;"; <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">each</span></span>; respond(weather)) { auto writer = res.bodyWriter(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">each</span></span>.label.empty) { result ~=format("&lt;b&gt;%s&lt;/b&gt;:&lt;br/&gt;\"%s\" = %s&lt;br/&gt;", <span class="hljs-keyword"><span class="hljs-keyword">each</span></span>.label, <span class="hljs-keyword"><span class="hljs-keyword">each</span></span>.name, <span class="hljs-keyword"><span class="hljs-keyword">each</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { result ~= format("&lt;i&gt;%s&lt;/i&gt;&lt;br/&gt;", <span class="hljs-keyword"><span class="hljs-keyword">each</span></span>.name); } } result ~= "&lt;/html&gt;"; res.writeBody(result); } auto settings = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> HTTPServerSettings; settings.bindAddresses = ["127.0.0.1"]; settings.port = <span class="hljs-number"><span class="hljs-number">80</span></span>; auto router = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> URLRouter; router.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>("/", &amp;<span class="hljs-keyword"><span class="hljs-keyword">index</span></span>); router.registerRestInterface(<span class="hljs-built_in"><span class="hljs-built_in">new</span></span> OpenWeatherImpl); listenHTTP(settings, router); runEventLoop(); }</code> </pre><br><br></div></div><br>  At <a href="http://127.0.0.1/weather%3Fq%3D">127.0.0.1/weather?q=</a> "Moscow" we will receive a json response to the weather in Moscow. <br><br>  Examples from the article in a convenient format <a href="https://github.com/ntstv/viberest">github.com/ntstv/viberest</a> </div><p>Source: <a href="https://habr.com/ru/post/231581/">https://habr.com/ru/post/231581/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../231571/index.html">The British Parliament opposed the "right to be forgotten"</a></li>
<li><a href="../231573/index.html">Spaniards have built in sensors monitoring the health of car drivers in the seat belt</a></li>
<li><a href="../231575/index.html">"The Kids Want Mobile!" Tips for promoting children's apps</a></li>
<li><a href="../231577/index.html">Who is a game designer?</a></li>
<li><a href="../231579/index.html">Making a small monitor with autonomous power</a></li>
<li><a href="../231583/index.html">About testing metrics: code coverage for testers</a></li>
<li><a href="../231585/index.html">How to create custom exceptions in C #</a></li>
<li><a href="../231587/index.html">As I did not publish the application in Autodesk Apps Exchange</a></li>
<li><a href="../231589/index.html">5 stories about mergers and acquisitions of technological advertising startups</a></li>
<li><a href="../231591/index.html">Toy Genetic Testing</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>