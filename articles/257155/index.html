<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Our report on the strike: "How to get rid of persistent database dependencies"</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="On April 10-11, our team took part in the largest in the Russian regions IT conference "Strike", which was held for the fourth time in Ulyanovsk. IT c...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Our report on the strike: "How to get rid of persistent database dependencies"</h1><div class="post__text post__text-html js-mediator-article">  On April 10-11, our team took part in the largest in the Russian regions IT conference "Strike", which was held for the fourth time in Ulyanovsk.  IT companies presented their stands where they could get acquainted with their products, learn about vacancies, take part in competitions. <br><br>  This year, XIMAD also decided to present a stand with its products at the conference in connection with the development of the mobile section.  This is a profile direction for us.  We listened to the reports, exchanged experiences with colleagues and answered many questions about the technologies used in our games. <br><br>  In two days, 130 experts spoke at 8 platforms and a total of 150 topical reports were delivered in various areas.  Our developer Alexey Klyuchnikov presented his report on ‚ÄúWe are doing interactive in mobile games or how to get rid of persistent database dependencies‚Äù on the example of our flagship Magic Jigsaw Puzzles (2M MAU, 600K DAU and up to 50K online players with interactive interaction). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <b>Below is the text of his speech:</b> <br><img src="https://habrastorage.org/files/034/27d/1da/03427d1da4174245bc156fecfa872f8f.jpg"><br><a name="habracut"></a><br>  What is the main problem with the server part of gamedev?  And the fact that this is hiload!  This is not hiload in only one case, if the project is not completed.  If the game enters the market, advertising will go on, the flow of players will go and for the first few days it will be, albeit small, but quite real hiload.  And if you overtake success ... <br><br>  Visiting the conference at high loads, it became clear that all are working in approximately the same direction.  The first thing that resists any highly loaded project is the data, and most of the speakers told how to replicate, shard, denormalize, etc.  We have not escaped this fate, but the path is chosen somewhat different.  It is proposed to minimize work with the database.  Essentially, get rid of her.  How to do it?  A very simple. <br><br>  <b>Idea</b> <br>  We write the server to which the player will log in, the selected process is started for the player, a profile is loaded into it from the database, and then all player actions take place in the process.  As a player, he does not show activity for some time, even 10 minutes, save the profile to the database and complete the process.  As a result, we have one reading from the database at login and one record in the database at logout and that's it! <br><br>  <b>What do we want?</b> <br>  We received one reading and one record for one gaming session.  So, we can count and predict how many players our decision will pull.  I think many people can figure out how much a simple key / value label can produce, for example, in mysql, read operations per second.  And how many players such a base will last a day.  The number will turn out impressive, and here on this number we have fenced ourselves from problems with the database.  What could be better? <br><br>  <b>Implementation</b> <br>  To implement, we take Erlang, since it works well with processes and ... and that's it. <br>  What Erlang gives us: processes out of the box, can start them, stop and send messages between them.  This means that one player's process can send a message to another process of another player.  And on the same principle to interact with the processes that provide the game logic.  Interactivity in this case is also obtained almost out of the box. <br><br>  We will understand in order with the nuances. <br><br><ul><li>  Addressing </li></ul><br>  Everything is canonical, each player is assigned a unique identifier during registration, and all the addressing is carried out over it in the future.  Sometimes it may be tempting to use additional keys for addressing, but this should be avoided for the following reasons: addressing is used to send messages when the message is transferred offline to the player, we must start the process, load this player‚Äôs profile into it and only then send the message to it.  But if we use different keys when addressing, we have a chance to get into a difficult-to-track collision, when 2 or more processes start per player. <br><br><ul><li>  Process Recorder </li></ul><br>  The recorder built into Erlang has serious drawbacks that do not allow its use for dynamically starting and terminating processes, so we take the gproc recorder.  Registrar is required to register the processes and issue their Pid upon request.  And at the completion of the processes or when they fall to produce their "deregistration". <br><br><ul><li>  Start processes </li></ul><br>  As mentioned above, when a message arrives to a player, we turn to the registrar asking which Pid to send the message, if there is no process for such a player, you need to start it.  Each operation takes, albeit small, but time and it is possible that two messages will come to the same player, at about the same time both of them will receive a negative response from the registrar and try to start the processes.  As a result, one of them starts first, and the second receives an exception, and the message will be lost.  We cannot start processes asynchronously and must organize a queue to start them.  To do this, we start a process in which we will direct all our appeals to the registrar and which will start the processes.  But we get a bottleneck, so we need not just one such ‚Äúprocess_starting_worker‚Äù, but a pool, for example, out of 100 stations, among which to distribute all references to the users ‚Äôid by any convenient algorithm, even the remainder of the division. <br><br><ul><li>  Stop processes </li></ul><br>  Stopping processes is no less interesting.  When it is time to complete the process, we need to perform a series of actions, such as saving the profile to the database, signing out from the registrar, sending a farewell message to all the friends, and actually completing the process.  All these actions can not be done one after another, because the player may suddenly come to life, or he just might receive a message while we are engaged in saving the profile.  Therefore, after each operation, you need to read the message queue, and if something is found in it, then process it, and in the case before leaving the registrar, return the process to its normal state, and after checking out the registrar, honestly reply to the sender that the process is unregistered. that the sender must re-send the message. <br><br><ul><li>  Caching and further denormalization </li></ul><br>  As you can see, our recorder is used for each message and this makes it a bottleneck, so it makes sense to cache Pids in processes.  After the first exchange of messages between processes, each of the processes remembers the opponent's Pid, ‚Äã‚Äãand in the future they communicate without contacting the registrar.  That is why at the end of the process, an action is added to notify all Pids from the cache about their completion, so that everyone can clear their caches from the terminating process. <br><br>  The second thing to think about is an optimization for reading.  Should a player see his friends play?  And how should he receive this information?  Every time I interview all my friends, or each friend should ‚Äúboast‚Äù to all his friends who have registered this result in their profile and will not generate any queries to display the results of friends, but will give it immediately from their profile.  Which approach to choose depends on the nature of the data usage.  If reading is more frequent than writing, then it makes sense to go this way. <br><br><ul><li> Thoughts on scaling </li></ul><br>  First, you can estimate our load and get that the server under the database + server under our code will stretch several hundred thousand players a day.  Erlang fairly honestly uses memory, so if you use an average of 100kb under the player profile, then to serve 50 thousand players you will need 5GB of RAM.  In other words, we take a server for 32-64GB and with a high probability we forget about the need to scale up, until the deafening success of the project. <br><br>  Secondly, if the deafening success nevertheless has come, then nothing prevents ‚Äúscaling down‚Äù the database on the player's id and distributing the players using DNS to different Erlang nodes.  The problem is only with our registrar, he should be able to work in cluster mode.  Gproc can, but as shown by tests - not to the end.  All you need is to patch it up a bit or to get another registrar, but this is a separate topic, perhaps for a separate article. <br><br>  <b>Conclusion</b> <br>  The decision was not as simple as it might seem.  There are still a lot of questions about messaging, how to guarantee their delivery, how to roll back, for example, message chains, which messages to transmit synchronously which asynchronously, etc. <br><br>  But the most important conclusion from the use of such an architecture is that we crammed into the unwelding and got a workable service.  What would be impossible, using the classical implementation of each player's sneeze with a query in the database. </div><p>Source: <a href="https://habr.com/ru/post/257155/">https://habr.com/ru/post/257155/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../257141/index.html">Sleep and self-powered ESP8266</a></li>
<li><a href="../257147/index.html">IPv6 is not needed?</a></li>
<li><a href="../257149/index.html">Factory sites (F.CMS) lost the court</a></li>
<li><a href="../257151/index.html">Several useful ruby ‚Äã‚Äãtricks that (possibly) will improve your code.</a></li>
<li><a href="../257153/index.html">A simple example of using ES6 today</a></li>
<li><a href="../257159/index.html">What tests do you need? Part 2. Test matrix</a></li>
<li><a href="../257161/index.html">Goals, objectives and principles of automation</a></li>
<li><a href="../257163/index.html">Error in AFNetworking code allows you to intercept user HTTPS traffic</a></li>
<li><a href="../257165/index.html">Own browser - the way of the mouse: meeting with the Rat</a></li>
<li><a href="../257167/index.html">Mono 4.0 release with import code from referencesource.microsoft.com and corefx</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>