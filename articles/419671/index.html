<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Restrictions that need to be violated or how we accelerated the functional tests three times</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Functional tests are a useful thing. At first they don‚Äôt take much time, but the project is growing, and more and more tests are needed. We did not in...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Restrictions that need to be violated or how we accelerated the functional tests three times</h1><div class="post__text post__text-html js-mediator-article"> <a href="https://habr.com/company/2gis/blog/419671/"><img src="https://habrastorage.org/webt/t0/cx/ye/t0cxyeb2tn7qjezwopepfwjy1ne.jpeg" alt="image"></a> <br><br>  Functional tests are a useful thing.  At first they don‚Äôt take much time, but the project is growing, and more and more tests are needed.  We did not intend to tolerate a slowdown in delivery speed and, gathering our strength, we accelerated the functional tests three times.  In the article you will find universal tips, however, you will notice a special effect on large projects. <br><a name="habracut"></a><br><h3>  Briefly about the application </h3><br>  My team is developing a public API that provides data to 2GIS users.  When you go to 2gis.ru and search for "Supermarkets", you get a list of organizations - this is the data from our API.  On our 2000+ RPS, almost every problem becomes critical if some functionality breaks down. <br><br>  The application is written in Scala, the tests are written in PHP, the database is PostgreSQL-9.4.  We have about 25,000 functional tests, they take 30 minutes on a dedicated virtual machine for general regression.  We were not particularly bothered by the duration of the tests - we are used to the fact that tests could take 60 minutes on the old framework. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h3>  How we accelerated and so "quick" tests </h3><br>  It all started by chance.  As usually happens.  We supported one feature after another, and at the same time signed tests.  Their number grew and the necessary time to perform - too.  Once the tests started to get out within the time limits assigned to them, and therefore the process of their execution was completed forcibly.  Incomplete tests are fraught with a missed problem in the code. <br><br>  We analyzed the speed of the tests and the task of their acceleration has become urgent.  So began a study called "Tests are working slowly - correct." <br><br>  Below are three big problems that we found in the tests. <br><br><h3>  Problem 1: Incorrectly used jsQuery </h3><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/4g/t9/0a/4gt90azsdwffnvwr2zy7pdsafiq.gif"></div><br>  All our data is stored in the PostgreSQL database.  Basically - in the form of json, so we actively use jsQuery. <br><br>  Here is an example of the query we made in the database in order to get the necessary data: <br><br><pre><code class="sql">SELECT * FROM firm WHERE json_data @@ 'rubrics.@# &gt; 0' AND json_data @@ 'address_name = *' AND json_data @@ 'contact_groups.#.contacts.#.type = ‚Äúwebsite‚Äù' ORDER BY RANDOM() LIMIT 1</code> </pre> <br>  It is easy to see that the example uses json_data several times in a row, although it would be correct to write this: <br><br><pre> <code class="sql">SELECT * FROM firm WHERE json_data @@ 'rubrics.@# &gt; 0 AND address_name = * AND contact_groups.#.contacts.#.type = ‚Äúwebsite‚Äù' ORDER BY RANDOM() LIMIT 1</code> </pre> <br>  Such flaws are not too striking, because in the tests we do not write all the queries with our hands, but instead we use QueryBuilders, which themselves compose them after specifying the necessary functions.  We did not think that this could affect the speed of execution of requests.  Accordingly, in the code it looks something like this: <br><br><pre> <code class="php">$qb = $this&gt;createQueryBulder() -&gt;selectAllBranchFields() -&gt;fromBranchPartition() -&gt;hasRubric() -&gt;hasAddressName() -&gt;hasWebsite() -&gt;orderByRandom() -&gt;setMaxResults(1);</code> </pre><br>  <b>Do not repeat our mistakes</b> : if there are several conditions in one JSONB field, describe them all within the same operator '@@'.  After we remade, we have accelerated the execution time of each request twice.  Previously, the described request took 7500ms, and now it takes 3500ms. <br><br><h3>  Problem 2: Extra Test Data </h3><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/yz/ko/yc/yzkoyc5ixzl8pmj6vtkdltnubbc.gif"></div><br>  Access to our API is provided by key, for each user of API it has its own.  Previously, tests often needed to modify key settings.  Because of this, tests fell. <br><br>  We decided to create several keys with the necessary settings at each regression run to eliminate intersection problems.  And since the creation of a new key does not affect the functionality of the entire application, this approach in the tests will not affect anything.  We lived in such conditions for about a year, until we started to deal with performance. <br><br>  There are not so many keys - 1000 pieces.  To speed up the application, we store them in memory and update every few minutes or on demand.  Thus, after saving the next key, the tests started the synchronization process, the end of which we did not wait - we received in response ‚Äú504‚Äù, which was written to the logs.  At the same time, the application did not signal a problem in any way and we thought that everything works fine for us.  The regression testing process itself continued.  And in the end it turned out that we were always lucky and our keys were saved. <br><br>  We lived in ignorance until we checked the logs.  It turned out that we created the keys but did not delete them after running the tests.  Thus, we have accumulated 500,000 of them. <br><br>  <b>Do not repeat our mistakes:</b> if you somehow modify the database in tests, be sure to ensure that the database is returned to its original state.  After we cleaned the base, the process of updating the keys has accelerated 500 times. <br><br><h3>  Problem 3: Random data sampling </h3><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/x7/s4/yw/x7s4ywwe8d2kg4upx_y0-k98k4a.gif"></div><br>  We love to check the application for various data.  We have a lot of data, and periodically there are problems.  For example, there was a case when we were not unloaded with data on advertising, but the tests caught this problem in time.  That is why in each request of our tests you can see ORDER BY RANDOM () <br><br>  When we looked at the results of the queries, with and without a random one, with the help of EXPLAIN, we saw a performance increase of 20 times.  If we talk about the example above, then without a random he works out for 160ms.  We seriously thought about what we should do, because we didn‚Äôt really want to completely refuse the random house. <br><br>  For example, in Novosibirsk, about 150 thousand companies, and when we tried to find a company that has an address, a website and a rubric, we received random records from almost the entire database.  We decided to reduce the sample to the first 100 firms that fit our conditions.  The result of deliberation was a compromise between the constant sampling of different data and speed: <br><br><pre> <code class="sql">SELECT * FROM (SELECT * FROM firm_1 WHERE json_data @@ 'rubrics.@# &gt; 0 AND address_name = * AND contact_groups.#.contacts.#.type = "website"' LIMIT 100) random_hack ORDER BY RANDOM() LIMIT 1;</code> </pre> <br>  In this simple way, we almost lost nothing at 20-fold acceleration.  The execution time of such a request is 180ms. <br><br>  <b>Do not repeat our mistakes:</b> this moment, of course, can hardly be called a mistake.  If you really have a lot of tests, always think about how much random data you need.  The compromise between the speed of query execution in the database and the uniqueness of the sample helped us to speed up SQL queries by 20 times. <br><br><h3>  Once again a short list of actions: </h3><br><ol><li>  If we specify several conditions for sampling data in the JSONB field, then they need to be listed in a single operator '@@'. </li><li>  If we create test data, be sure to delete them.  Even if it seems that their presence does not affect the functionality of the application. </li><li>  If random data is needed for each run, then we find a compromise between the uniqueness of the sample and the speed of execution. </li></ol><br>  We have speeded up the regression three times thanks to simple (and for some, perhaps even obvious) modifications.  Now our 25K tests pass in 10 minutes.  And this is not the limit - on the queue we have code optimization.  It is not known how many unexpected discoveries are still waiting for us there. </div><p>Source: <a href="https://habr.com/ru/post/419671/">https://habr.com/ru/post/419671/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../419659/index.html">Where Hollywood portrays hackers correctly, and where - mistakenly</a></li>
<li><a href="../419661/index.html">Making a radio station from GTA: San Andreas</a></li>
<li><a href="../419663/index.html">Governmental organizations lure the creators of ultra-low RN with contracts, bonuses and simplified bureaucracy</a></li>
<li><a href="../419665/index.html">Experience of using LoRaWAN in the AMR system in a real urban environment</a></li>
<li><a href="../419667/index.html">Selection of useful materials on Azure. Part 1 - Books</a></li>
<li><a href="../419673/index.html">Early Universe 6. The Dynamics of a Homogeneous Expanding Universe, Part 2</a></li>
<li><a href="../419675/index.html">Review of per minute rental of electric scooters in Moscow, summer 2018</a></li>
<li><a href="../419677/index.html">How to sniff HTTPS traffic on an iOS device</a></li>
<li><a href="../419679/index.html">Implementing the Spring Framework API from scratch. Step-by-step guide for beginners. Part 1</a></li>
<li><a href="../419683/index.html">What do the metrics mean for Agile teams?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>