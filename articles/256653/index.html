<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Microsoft SQL Server Data Tools</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this article I would like to tell about a set of useful additions to Visual Studio, which can greatly facilitate the development of databases based...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Microsoft SQL Server Data Tools</h1><div class="post__text post__text-html js-mediator-article">  In this article I would like to tell about a set of useful additions to Visual Studio, which can greatly facilitate the development of databases based on MS SQL Server. <br>  The main advantages of using SSDT I would highlight the following: <br><ul><li>  the possibility of a simple change (refactoring) of the base scheme (you can rename the table column and all Views, Functions and Stored Procedures that refer to it will automatically be corrected to reflect the changes) </li><li>  creating unit tests for database </li><li>  storing database structure in source control </li><li>  comparison of the schema / data with the ability to generate a script to bring the schema / data to the desired state </li></ul><br>  Of course, the advantages of using SSDT do not end there, but the rest is not as impressive as the one mentioned above.  If you are interested in how to take advantage of these and other benefits - I ask for cat. <br><a name="habracut"></a><br><br><h4>  Installation and first acquaintance </h4><br>  Everything you need to install can be found on <a href="https://msdn.microsoft.com/en-us/data/hh297027">the download page</a> in the Data Developer Center.  Having chosen the necessary version, you can easily install the tools on your computer and describe it does not see the point.  After installation, a new project type will appear in the create new project window: <br><img src="https://habrastorage.org/files/c23/cc1/324/c23cc13248ff42d89bbb3c3960808309"><br><br>  Creating a new project you will see the following: <br><img src="https://habrastorage.org/files/707/862/706/7078627066f240faa6de4ff1eb5775f1">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In the SQL Server Object Explorer panel (menu View -&gt; SQL Server Object Explorer) we see something very similar to Object Explorer in SQL Server Management Studio, from which everything that does not make much sense at the database development stage is removed. <br>  By connecting to an existing database, you can develop a database in the so-called Connected mode.  This is not much different from the classical approach used in SQL Server Management Studio and will not be discussed in this article. <br><br><h4>  Disconnected mode </h4><br>  This development mode is most interesting to us, since  It is this one that allows you to get the main benefits of using SSDT <br>  The work is based on a very simple idea - to allow developers to store all the scripts for creating database objects (tables, views, store procedures, etc.) in a project of a special type as part of an existing or new solution (solution).  Based on scripts, Visual Studio can generate a DACPAC file, which is essentially a zip archive with all t-sql scripts.  Having a DACPAC file, it will be possible to publish (publish) the required database instance by comparing the schema described in DACPAC and the schema in the target database.  During the publication, special mechanisms make comparisons, as a result of which migration scripts are automatically created to apply changes without losing data. <br>  In order to see this in action, I suggest to look at the following examples. <br>  Let's start with the possibility of import.  Call the project context menu and see 3 possible options: <br><img src="https://habrastorage.org/files/50f/b25/068/50fb250680f44dee8c77239a666f830f"><br><ul><li>  <i>Script (* .sql)</i> - adds one or several * .sql files from the specified location to the project structure; </li><li>  <i>Data-tier Application (* .dacpac)</i> - adds * .sql files, as well as various database settings from the special DACPAC file described above;  may contain not only the base scheme, but also data and various base settings; </li><li>  <i>Database ...</i> - is similar to the previous version, but the data source is the existing database </li></ul><br>  We will select the ‚ÄúDatabase ...‚Äù option and import the local database.  It contains one table and one stored procedure.  In SQL Server Object Explorer, the source database looks like this: <br><img src="https://habrastorage.org/files/9cb/a90/7aa/9cba907aa35b481ba96063785f629b6d"><br>  After the import is complete, we will see an extremely similar picture, with the only difference that the database structure will be presented in Solution Explorer as * .sql files. <br><img src="https://habrastorage.org/files/f0a/016/0e5/f0a0160e5504412585353e5068034b07"><br>  Also, we can always add new items using the Add New Item dialog box, which lists all possible database objects: <br><img src="https://habrastorage.org/files/096/f63/876/096f6387660042acaa62649a1fab7de6"><br>  Add the TestTable table.  A new script file TestTable.sql will be added to the project root and for convenience we will transfer it to the Tables folder. <br><img src="https://habrastorage.org/files/bfa/6c4/2ce/bfa6c42ce589496b843190dc014c1045"><br>  To create a table schema, we can use both the designer panel and the T-SQL panel.  All changes made on one panel will be immediately displayed in another. <br>  We can also modify existing scripts.  Visual Studio for this provides a convenient and beloved by all IntelliSense.  Since we are not connected to the physical database, Visual Studio for IntelliSence to work correctly parses all the scripts in the project, which allows it to instantly reflect the latest changes made to the database schema. <br><img src="https://habrastorage.org/files/3c6/5bc/94a/3c65bc94a5bc49f5bfc18e5e2c6c8fad"><br>  I want to draw attention to the fact that we do not have to worry about incremental changes to our base.  Instead, we always create scripts as if objects were created anew.  When publishing a DACPAC package, migration scripts will be generated automatically by comparing the DACPAC file and the schema in the target database. <br>  As already mentioned, DACPAC contains not only the schema and data, but also a number of useful settings, for viewing / editing of which we can use the properties window of our project. <br><img src="https://habrastorage.org/files/0b3/763/166/0b3763166bf843c99e640db41f85eec2"><br>  The Target platform property allows you to set the version of the database for which scripts in the project will be validated.  The minimum supported version of MS SQL Server 2005. For example, if you specify the version of the database 2005 and try to create a column of the Geography type, then we will receive the following message when compiling: <br><img src="https://habrastorage.org/files/feb/98b/583/feb98b583f79474c909c6631ccf306f4"><br>  On the Project Settings tab, we can set the database settings by clicking on the Database Settings button.  Clicking on it we will see a dialog with settings similar to those we used to see in SQL Server Management Studio: <br><img src="https://habrastorage.org/files/02c/64a/e1b/02c64ae1b8314d73915e236c489544a6"><br>  I would also like to mention the SQLCMD Variables tab, on which we can set various variables for further use in our scripts. <br><img src="https://habrastorage.org/files/292/205/055/2922050558ba4249b4a2251dbac7e169"><br><br><h4>  Publishing the DACPAC file (publishing) </h4><br>  After all the settings are specified and the * .sql scripts are added / updated, we can apply the changes to the target database.  To do this, go to the menu Build-&gt; Publish, or choose a similar item in the context menu of the project. <br><img src="https://habrastorage.org/files/094/44d/344/09444d3443a5410cb0c9fbe954affa7d"><br>  In the dialog box that appears, we set the connection string to the target database (target database) and, if necessary, additional settings by clicking the Advanced button: <br><img src="https://habrastorage.org/files/57e/d37/bfa/57ed37bfa233423f9c5297e0cb6272ef"><br>  Most of the settings are understandable without additional description, so we will not dwell on them in detail, but I recommend you to familiarize yourself with them, so that if it is impossible to successfully ‚Äúfill in‚Äù the project, you know what the problem may be. <br><br>  If you want to publish to the target database more than once, then the settings can be saved to the publish profile by clicking the Create Profile button.  This will add a file with the extension * .publish.xml to our project and in the future we will be able to publish without the need to enter the settings again.  If any of the publication profiles should be used by default, then you can select Set As Default Publish Profile in the context menu of the publication file.  This profile will automatically load into the Publish dialog. <br><img src="https://habrastorage.org/files/42a/f6b/50e/42af6b50e6e14a06a3df55ce530495bc"><br>  All necessary changes can be applied immediately by clicking on the Publish button.  And you can postpone until later by generating the corresponding migration script (button Generate Script) - it will contain all the necessary instructions to bring the destination database to the desired state. <br>  If we do not have access to the database, then we can transfer the results of our work as a DACPAC file, which is created by compiling the project and located in ../bin/Debug/Database1.dacpac.  Having given a file, for example, to a database administrator, he, in turn, will be able to use any convenient way to apply changes to the target database. <br>  Methods of publishing DACPAC (publishing): <br><ul><li>  Free edition of Visual Studio with installed SSDT (in particular, for publish, the client tools included in the DAC Framework that are installed with SSDT are used) </li><li>  MS SQL Server Management Studio + DAC Framework </li><li>  Console utility <a href="https://msdn.microsoft.com/ru-ru/library/hh550080(v%3Dvs.103).aspx">SqlPackage.exe</a> </li><li>  Windows PowerShell ( <a href="http://www.sqlskills.com/blogs/bobb/using-powershell-with-dac-3-0/">example</a> ) </li><li>  The Data-tier Application Framework (DACFx) allows you to put a DACPAC file by calling methods from a C # program ( <a href="https://msdn.microsoft.com/en-us/library/dn702988.aspx">documentation</a> and <a href="http://blogs.msmvps.com/deborahk/deploying-a-dacpac-with-dacfx-api/">example</a> ) </li></ul><br><h4>  Data seeding </h4><br>  In our project we will create a DataSeeding folder (the name does not matter) and add a new script to it. <br><img src="https://habrastorage.org/files/45c/b62/11b/45cb6211b5604f3da124e85ea32eea62"><br>  In fact, all types in the User Script section are normal * .sql scripts and differ only in the value of the ‚ÄúBuild Action‚Äù property of the newly created file. <br><img src="https://habrastorage.org/files/ee8/a39/28a/ee8a3928a3e94ce0ac4699e5a1ba2f93"><br>  The logic from the PostDeployment.sql file will be executed after applying all changes to the database schema.  In the case of creating PreDeployment.sql, the logic will be executed before applying the schema changes. <br>  The value of the Build Action property for files created through the Script template (Not in Build) will be set to ‚ÄúNone‚Äù.  They are useful for conveniently structuring commands in separate files that are called from Pre or Post Deployment scripts. <br>  Files created through the Script template have a Build Action value of ‚ÄúBuild‚Äù, and their contents are added to the resulting script, which is executed when the DACPAC file is published at the time the database is changed. <br>  Since there can be only one Post Deployment script in a project and its size can quickly grow, it is recommended that the data insertion logic be placed into separate scripts.  That is why we will add a Script file (Not in Build), and in the Post Deployment script we will add a link to it.  Here is what it will look like: <br><img src="https://habrastorage.org/files/f10/3a1/39a/f103a139a65649eb90dbd9532649788d"><br><br><img src="https://habrastorage.org/files/382/85e/b5d/38285eb5dc96460885b97adeffa4ce8f"><br>  Now when publishing our project, 2 records will always be inserted into the Employees table in the database. <br><br><h4>  Tools -&gt; SQL Server </h4><br>  Along with the ability to create a Database project, installing SSDT adds a number of useful tools available from the Tools menu. <br><img src="https://habrastorage.org/files/41a/b5d/d36/41ab5dd36b5c4017a1fafa80d4151281"><br>  I think that it is clear from the title that each of the points does.  As an example, I will show a convenient graphical schema comparison tool.  As a source and target object, you can choose one of three options: <br><img src="https://habrastorage.org/files/1fa/ca1/9b2/1faca19b2c59453f804864c4dcd4080e"><br>  We will compare our project with a local database.  The result of the comparison will be as follows: <br><img src="https://habrastorage.org/files/ec1/784/b36/ec1784b367c24c599e785b244248715d"><br>  In the resulting window, we can apply various grouping methods (according to the scheme, according to the type of objects and according to the required action) to more conveniently view the proposed changes and select the objects that need to be updated.  In order to apply the migration script, you must click the Update button - this will lead the Target DB to the state of our project. <br><br><h4>  Refactoring </h4><br>  This is my favorite feature.  For example, we will show how to rename the LastName column in the Employees table.  To do this, open the table creation script, select the LastName column in the table editor and select the Rename item in the SQL menu -&gt; Refactor: <br><img src="https://habrastorage.org/files/d7f/5fc/46b/d7f5fc46b07642368cb93262ee4590a8"><br><br>  Set a new name: <br><img src="https://habrastorage.org/files/bdc/c00/10c/bdcc0010c11444599ec13f96b223ee20"><br><br>  Review the effects of renaming and apply the proposed changes: <br><img src="https://habrastorage.org/files/cf8/eb5/702/cf8eb57020714d08b899e6391d4c75a9"><br><br>  As a result, all scripts will be changed and after the first refactoring a special * .refactoring file will be added to the project.  It will save all schema changes in historical order in an XML document format.  This data will be useful in generating a migration script and will allow you to migrate the schema and data more correctly. <br><img src="https://habrastorage.org/files/2d1/8ce/94c/2d18ce94c0ff4d9daec72085de529cf3"><br><br><h4>  Unit testing </h4><br>  Let's create our first unit test.  To do this, call the context menu for the stored procedure that we want to test: <br><img src="https://habrastorage.org/files/301/dde/2b1/301dde2b1fc341c7ae7bd7b54c463bff"><br>  In the dialog box that appears, we will have the opportunity to select additional objects (if any) and set the type and name of the test project and the name of the class containing the unit test code: <br><img src="https://habrastorage.org/files/658/b16/f9d/658b16f9d959454ca00bdac9d3b968a9"><br><br>  Having created a project, we will be asked to select a database on which tests will be run, as well as some project settings: <br><img src="https://habrastorage.org/files/1fb/512/24d/1fb51224dd5845609706f6e6c0351c21"><br><br>  After successful creation, we will open the graphical editor of the unit test, at the bottom of which various checks for the tested object will be presented.  In our case, this is the EmployeeGetList stored procedure. <br><img src="https://habrastorage.org/files/97c/98f/ac2/97c98fac2cd048f4917dba856fef6240"><br>  Our task is to write the necessary Sql script and set the required verification conditions, which will be performed after the script code execution.  Checks can be different: execution time, number of rows returned, checksum returned data, etc.  A complete list of checks can be found in the drop-down menu under the text of the script and above the table checks.  For each check, you can set a number of settings through the standard Properties panel.  To call it, select the Properties item in the context menu of a specific scan. <br>  For example, this is how the verification of the returned number of lines will look like: <br><img src="https://habrastorage.org/files/557/b93/fda/557b93fda5b543e48c04534f092cfe6a"><br><br>  And this is how you can check Checksum: <br><img src="https://habrastorage.org/files/1dc/b23/5d8/1dcb235d825346ceb3ee01b22614c926"><br>  In fact, this check is performed by our script (it gets 2 rows from the Employees table) and finds the Checksum on the received data.  Our task at the stage of test creation is to find reference data, calculate Checksum for them, and in the future this result will be verified with this value.  In other words, this is a convenient way to ensure that the result of the stored procedure does not change.  To get the Checksum control value, you need to use the button in the Properties window, which will allow you to select a reference database and get the Cheksum reference value: <br><img src="https://habrastorage.org/files/815/5fd/ea1/8155fdea1df840adb2f70539bf04a9f3"><br><br><h4>  Conclusion </h4><br>  I hope this brief review has provided an overview of what SSDT is and how they can be useful in your project.  Of course there were not considered all the details.  But you, as a developer, don't need this.  You should just have a general idea of ‚Äã‚Äãthe list of opportunities, and I hope that their further use will be intuitive because  The SSDT developers did a great job and supplied the tools with a huge number of wizards and contextual clues. </div><p>Source: <a href="https://habr.com/ru/post/256653/">https://habr.com/ru/post/256653/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../256641/index.html">To help the fisherman - bite warning device</a></li>
<li><a href="../256643/index.html">Material Design. Dynamic Toolbar on a live example</a></li>
<li><a href="../256647/index.html">Container in linux, linux in egg, egg in python</a></li>
<li><a href="../256649/index.html">PHP Digest number 61 - interesting news, materials and tools (April 13 - 26, 2015)</a></li>
<li><a href="../256651/index.html">93 video lectures on Scala</a></li>
<li><a href="../256655/index.html">All about triggers in Oracle</a></li>
<li><a href="../256659/index.html">Anatomy of IPsec. Check the strength of the legendary protocol</a></li>
<li><a href="../256661/index.html">Car Hacking: Are car safety systems safe?</a></li>
<li><a href="../256663/index.html">Attack on the oracle. Detailed Guide for Oracle DB Attack Vectors</a></li>
<li><a href="../256665/index.html">We play with muscles. Methods and tools for hacking MySQL databases</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>