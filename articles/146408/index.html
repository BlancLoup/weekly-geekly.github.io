<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>History of a single file manager</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I do not know about you, but I began to study the web and PHP in particular by writing free scripts. I wrote 2 of my CMS, gallery, forum, guestbook .....">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>History of a single file manager</h1><div class="post__text post__text-html js-mediator-article">  I do not know about you, but I began to study the web and PHP in particular by writing free scripts.  I wrote 2 of my CMS, gallery, forum, guestbook ... My first project was a file manager, and I would like to tell you about what stages of development it went through and what it became in the end.  For example, I taught him to open folders with 500k files without getting out for 32 MB of memory_limit with a page generation time of a few seconds. <br><br>  I prepared a <a href="http://www.youtube.com/watch%3Fv%3DXSvY9joxQqI">small demo of his work</a> , and also laid out the <a href="https://github.com/YuriyNasretdinov/Dolphin.php">source file manager</a> on github.  The source texts are not of very high quality, for this was mainly written by me in 2007, that is, 5 years ago :). <br><a name="habracut"></a><br><h4>  2002  How it all began  PHPFM 1.0 </h4><br>  In fact, the first project I decided to write was the file manager.  The reason was very simple: then I did not know how to use MySQL, but I more or less learned from files :).  I called the file manager PHPFM and even posted it on cgi.myweb.ru under the name <i>aa.</i>  <i>PHPFM</i> , and I added the first two letters ‚Äúa‚Äù to be at the very top of the list :).  Echoes of this <a href="http://www.google.ru/">can</a> still <a href="http://www.google.ru/">be found</a> on the network, although nothing can be downloaded - websites with ‚Äúfree software‚Äù, apparently, have lost an archive with source codes for some iteration. <br><br>  Everything was implemented very simply - the same code for working with folders was roughly of this kind: <br><div class="spoiler">  <b class="spoiler_title">Govnokod!</b> <div class="spoiler_text"><pre><code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// ,     PHP   ,  htmlspecialchars,      .. $dh = opendir($dir); while ($f = readdir($dh)) { if ($f == '.' || $f == '..') continue; $fullpath = $dir . '/' . $f; $is_dir = is_dir($fullpath); </span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">?&gt;</span></span></span><span class="hljs-comment">&lt;tr&gt;&lt;td&gt;&lt;input type="checkbox" name="files[]" value="</span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">&lt;?</span></span></span><span class="hljs-comment">=$f</span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">?&gt;</span></span></span><span class="hljs-comment">" /&gt;&lt;/td&gt;&lt;td&gt;&lt;img src="..." /&gt;&lt;/td&gt;&lt;td&gt;&lt;a href="..."&gt;</span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">&lt;?</span></span></span><span class="hljs-comment">=$f</span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">?&gt;</span></span></span><span class="hljs-comment">&lt;/a&gt;&lt;/td&gt;&lt;/tr&gt;</span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">&lt;?</span></span></span><span class="hljs-comment"> }</span></span></code> </pre> </div></div><br>  The code was a classic PHP script, in which PHP and HTML code is mixed, nothing is escaped, and non-obvious dynamic typing errors in PHP are allowed (in fact, reading the directory should look like <i>while (false! == ($ f = readdir ( $ dh)))</i> , because otherwise the reading will end on a file with the name "0").  Nevertheless, it worked quite well and generated an answer even in 1,000 files in about 0.5 seconds, but it took a lot of time to render. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      This file manager had a lot of drawbacks: it was Web 1.0, it didn‚Äôt work quite correctly and couldn‚Äôt edit anything if the user running the web server didn‚Äôt have write access to the files.  By the way, this is a typical approach for virtual hosting - access via FTP, from under a different user (for example, yuriy), rather than a web server user (for example, www-data). <br><br><h4>  2003  Version two, improved </h4><br>  The main reason for rewriting the first version of the file manager was my desire to make it more ‚ÄúWeb 2.0,‚Äù although such a term did not yet exist.  I wanted to make it possible to select files by clicking on a file, as in a regular Windows Explorer, and also to make support for the context menu.  This version is already <a href="http://forum.dklab.ru/viewtopic.php%3Ft%3D9504">preserved</a> in <a href="http://forum.dklab.ru/viewtopic.php%3Ft%3D9504">some places</a> (it can be downloaded via a <a href="">direct link</a> , it is not necessary to register)  By the way, it still works (at least in PHP 5.3 :), but the layout and JS are sharpened for IE 6, so not all the functionality will be available in modern browsers.  Actually, there is still a miracle of opening the right-click context menu, as well as displaying information about the selected file in the Details tab (implemented through the iframe, because the world did not yet know about the existence of XMLHttpRequest). <br><br>  Here is an example of the function of deleting a directory, which still exists in my file manager in a similar form, almost with the same errors :).  In the current version, these errors are not corrected, because I am thinking about starting from scratch again and finally writing a decent version that will work really well and will not contain obvious security errors, and will also have a good structure. <br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">//  ,    function removedir($dir) { $dh=opendir($dir); while ($file=readdir($dh)) { if($file!="." &amp;&amp; $file!="..") { $fullpath=$dir."/".$file; if(!is_dir($fullpath)) { unlink($fullpath); }else { removedir($fullpath); } } } closedir($dh); if(rmdir($dir)) { return true; }else { return false; } }</span></span></code> </pre><br><br>  At least 3 things are wrong here: <br>  1) there is no verification of the result <br>  2) there is no check for symbolic links (which means that if there is a symlink on "/" in the directory, the function will start recursively deleting the root file system, as far as the rights are enough :)) <br>  3) Invalid directory reading code: the function will stop at the file with the name "0" <br><br><h4>  2004-2005.  Attempts to create a third version </h4><br>  I liked the idea of ‚Äã‚Äã‚Äúweb 2.0‚Äù so much that I decided to go further and do everything on frames, like in real Windows Explorer, and finally add the ‚Äúicon‚Äù view, not the list.  In fact, I copied most of the behavior of the explorer, after which my JavaScript code turned into such a mess that I just could not support it, absolutely :). <br><br>  Here is what I wrote on the forum, so as not to retell: <br><div class="spoiler">  <b class="spoiler_title">Message text</b> <div class="spoiler_text">  Gentlemen, I decided (I also did not know how much time ...) once again take into account all the wishes ... And make a new PhpFM 3.0 on frames (in the image and likeness of the Explorer).  + besides, to make the view support not only a list, but also in the form of icons.  The version that is being developed is very heavy, but cross-browser JavaScript (that is, it works in Opera (in the javascript settings, you must allow the interception of clicks on the right mouse button), and in Mozille, and IE).  So far, under development, here's what's done: <br><br>  1) frame structure, rubber design! <br>  2) in the upper frame, the address bar works (the ‚ÄúTransition‚Äù button is decorative!) And the ‚ÄúUp‚Äù button <br>  3) in the left frame the view is as in Explorer with the ‚ÄúFolder‚Äù mode enabled.  It does not work on JSHTTPRequest (it is planned to change it based on it - a very handy thing), but all folders open dynamically (using an invisible IFRAME).  The opening and folding of folders works - the context menu is NO! <br>  4) in the main frame in the form of icons (there is, in principle, still in the form of a list, but it is nothing special), drawn by javascript, and when resizing the frame, its contents are redrawn without reloading the page.  File selection works (so far, multiple selection is not debugged) with the mouse, when you hover the mouse over the file after a while, a title with information about the file pops up (earlier it was done for folders too).  Too long names are cut off, when you click on a file or folder, its name is restored to its full size (although, so far, without line breaks).  Double-clicking a folder opens, if a file or folder is clicked twice with a significant gap, a window pops up with the file rename (it didn‚Äôt work out for me to make a normal change to &lt;input type = text ...).  For files and folders, the context menu works.  So far, a lot of things have not been implemented, please rate at least the idea. <br><br>  Address of the demonstration: &lt;non-working address, unfortunately&gt;, in order to find out the password, send me a message, I will send you a password (a precautionary measure). </div></div><br><h4>  2006  Dolphin (Dolphin.php) </h4><br>  After some time, I realized that I had already gained more or less experience (and also started to understand something in JavaScript) and now I can manage to do what I wanted - a complete copy of the Explorer, only in PHP: ).  Here is one of the screenshots of that version: <br><br><img src="https://habrastorage.org/storage2/bca/05f/aa5/bca05faa5730a9d2f65b9cda6500383f.png"><br><br>  The menu elements were decorative, but the buttons "back", "forward", etc.  they were animated as close to Explorer, as it generally made sense to do on the Web, and as far as I had the skills.  In fact, even PHPFM 3.0, abandoned by me, worked so much like Explorer that someone ‚Äúfinalized‚Äù it (adding the missing functionality to the level ‚Äújust to work‚Äù) and installed it as a file sharing service at some institute.  Previous versions of PHPFM were also installed by someone on the local network as a file storage for accounting, since everything was very similar to Explorer and it was very easy for people to navigate through it. <br><br><h4>  2007  Change of design due to fear of the reaction of copywriters from Microsoft :) </h4><br>  I was actively developing the ‚Äúdolphin‚Äù from 2006 to 2007, and at some point it dawned on me that it was not good to copy someone else's design, and that it was theoretically to attack me with a copywriter if I continued to take interface elements from Explorer :).  Therefore, I decided to change the design, as a result of which the file manager is still in an unfinished state, since I did not fully catch all the bugs associated with changing it.  Actually, I didn‚Äôt do it myself. <br><br>  Now the file manager looks like this: <br><img src="https://habrastorage.org/storage2/9b9/688/95d/9b968895d85b98641f6c89b69c407d29.png"><br><br><h4>  Performance optimization </h4><br>  I, frankly, belong to the category of people who are important performance.  I love it when everything is fast, and for my file manager, I always tried to come up with new ways to speed up its work.  The main thing I wanted to speed up was the opening of the file list ‚Äî the most frequently used function in the file manager.  Here are some ideas for increasing the speed of work I thought out: <br><br>  1. Minimizing the number of operations performed in the directory reading cycle <br><div class="spoiler">  <b class="spoiler_title">Description</b> <div class="spoiler_text">  Code: <br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">d_filelist_fast</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($dir)</span></span></span><span class="hljs-function"> </span></span>{ setreadable($dir,<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!(@$dh=opendir($dir)) &amp;&amp; !(@$ftp_list=d_ftplist($dir))) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>($dh) { $dirs = $files = $fsizes = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(); <span class="hljs-comment"><span class="hljs-comment">/* chdir($dir); */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>!==(@$file=readdir($dh))) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>($file==<span class="hljs-string"><span class="hljs-string">'.'</span></span> || $file==<span class="hljs-string"><span class="hljs-string">'..'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(is_dir($dir.<span class="hljs-string"><span class="hljs-string">'/'</span></span>.$file)) $dirs[]=$dir.<span class="hljs-string"><span class="hljs-string">'/'</span></span>.$file; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> $files[]=$dir.<span class="hljs-string"><span class="hljs-string">'/'</span></span>.$file; $fsizes[$dir.<span class="hljs-string"><span class="hljs-string">'/'</span></span>.$file] = filesize($dir.<span class="hljs-string"><span class="hljs-string">'/'</span></span>.$file); } closedir($dh); }<span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $ftp_list; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-string"><span class="hljs-string">'dirs'</span></span>=&gt;$dirs,<span class="hljs-string"><span class="hljs-string">'files'</span></span>=&gt;$files,<span class="hljs-string"><span class="hljs-string">'fsizes'</span></span>=&gt;$fsizes); }</code> </pre> <br>  Performance rating on a folder of 50,000 files: <br><blockquote>  488 ms generation <br>  33.51 MB of memory <br>  246 KB in gzip (+ 500 ms per download) <br>  305 ms in browser <br>  = 1300 ms <br><br>  + no data uploads (at all) <br>  - the slowest option <br>  - it takes a lot of memory <br></blockquote><br></div></div><br>  2. Performance analysis when opening the i386 folder for Windows made it clear that calling stat () for Windows is a very expensive operation.  If you divide the result into pages and call stat () only for files on the current page, you can save a lot.  I also tried to save on matches by generating code on the fly and feeding it with eval, so the code was very complex, but rather fast. <br><div class="spoiler">  <b class="spoiler_title">Description</b> <div class="spoiler_text">  Code: <br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">/* extremely complicated :), extremely fast (on huge directories) and extremely customizable sorted filelist :) $dir -- directory from which to get filelist $params -- array with optional parameters (see beginning of function for details) RETURN: array( 'pages' =&gt; array( $pagemin =&gt; array( 'files' =&gt; array('field1' =&gt; $list1, ..., 'fieldN' =&gt; $listN), 'dirs' =&gt; ... (array of the same format) ), ... (the intermediate pages) $pagemax =&gt; array( 'files' =&gt; ..., 'dirs' =&gt; ... ) ), 'pages_num' =&gt; ..., 'items_num' =&gt; ... ) where field1, ..., fieldN -- requested fields (default 'name' and 'size') $list1, ..., $listN -- a list of values (array('value1', 'value2', ...,'valueN')), $pagemin and $pagemax -- the page numbers of the specified range (default 1) pages_num -- filtered number of pages (returns 1 if you do not ask not to split to pages) items_num -- filtered number of files + total number of folders EXAMPLE: $res = d_filelist_exteme('/home/yourock'); print_r($res); this will result in: Array ( [pages] =&gt; Array ( [1] =&gt; Array ( [files] =&gt; Array ( [name] =&gt; Array ( [0] =&gt; file1 [1] =&gt; file3 [2] =&gt; file20 ) [size] =&gt; Array ( [0] =&gt; 1000 [1] =&gt; 2000 [2] =&gt; 300000 ) ) [dirs] =&gt; Array ( [name] =&gt; Array ( [0] =&gt; dir1 ) [size] =&gt; Array ( [0] =&gt; 512 ) ) ) ) [pages_num] =&gt; 1 [items_num] =&gt; 4 ) */</span></span> <span class="hljs-comment"><span class="hljs-comment">/* </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">TODO:</span></span></span><span class="hljs-comment"> move it to config.php in some time */</span></span> define(<span class="hljs-string"><span class="hljs-string">'LIGHT_PERPAGE'</span></span>, <span class="hljs-number"><span class="hljs-number">30</span></span>); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">d_filelist_extreme</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($dir, $params=array</span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">()</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/* set defaults: $key = ''; is equal to default value for $params['key'] */</span></span> $fields = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-string"><span class="hljs-string">'name'</span></span>, <span class="hljs-string"><span class="hljs-string">'size'</span></span>); <span class="hljs-comment"><span class="hljs-comment">// name, chmod or any field of stat(): (size, mtime, uid, gid, ...) $filt=''; // filename filter $sort='name'; // what field to sort (see $fields) $order='asc'; // sorting order: "asc" (ascending) or "desc" (descending) $fast=true; // use some optimizations (eg can allow to get some range from a filelist of 5000 files in 0.1 sec) $maxit=defined('JS_MAX_ITEMS') ? JS_MAX_ITEMS : 200; // how many items is enough to enable optimization? $split=true; // split result to pages and return only results for pages from $pagemin to $pagemax (including both) $pagemin=1; $pagemax=1; // see description for $split $perpage=LIGHT_PERPAGE; // how many files per page $ftp=true; // try to get filelist through FTP also (can affect performance) /* read parameters, overwriting default values */ extract($params,EXTR_OVERWRITE); if($sort!='name') { /*return d_error('Not supported yet');*/ $fast = false; if(array_search('mode', $fields) === false) $fields[] = 'mode'; } if($pagemax &lt; $pagemin) $pagemax = $pagemin; if(array_search($sort, $fields)===false) $fields[] = $sort; if($order != 'asc') $order = 'desc'; $filt = strtolower($filt); /* check required fields */ $st = stat(__FILE__); foreach($fields as $k=&gt;$v) { if($v == 'name' || $v=='chmod') continue; if(!isset($st[$v])) { $keys = array_filter(array_keys($st), 'is_string'); return d_error('Unknown field: '.$v.'. Use the following: name, chmod, '.implode(', ', $keys)); } } setreadable($dir, true); if(!@$dh = opendir($dir)) { if(!$ftp) return d_error('Directory not readable'); if(!@$ftp_list=d_ftplist($dir)) return d_error('Directory not readable'); } if($dh) { $it = array(); /* items */ if(!$filt) { while(false!==(@$f=readdir($dh))) { if($f=='.' || $f=='..') continue; $it[] = $f; } }else { while(false!==(@$f=readdir($dh))) { if($f=='.' || $f=='..') continue; if(strpos(strtolower($f),$filt)!==false) $it[] = $f; } } closedir($dh); if(!$split) $perpage = sizeof($it); $old_dir = getcwd(); chdir($dir); $l = sizeof($it); if($l &lt; $maxit) $fast = false; /* $fast means do not sort "folders first" */ if($fast) /* $sort = 'name' and $split = true */ { if($order=='asc') sort($it); else rsort($it); }else { $dirs = $files = array(); if($sort=='name') { for($i = 0; $i &lt; $l; $i++) { if(is_dir($it[$i])) $dirs[] = $it[$i]; else $files[] = $it[$i]; } if($order=='asc') { sort($dirs); sort($files); $it = array_merge($dirs, $files); }else { rsort($files); rsort($dirs); $it = array_merge($files, $dirs); } } } /* array_display($it); */ $res = array('pages_num' =&gt; ceil($l / $perpage), 'items_num' =&gt; $l); $all = $pages = array(); /* fix invalid page range, if it is required */ if($pagemin &gt; $res['pages_num']) { $pagemin = //max(1, $pagemin + ($pagemax - $res['pages_num']) ); $pagemax = $res['pages_num']; } $cd = $cf = $ci = ''; /* Code for Directories, Code for Files and Code for Items */ foreach($fields as $v) { $t = '[\''.$v.'\'][] = '; if ($v == 'name') $t .= '$n'; else if ($v == 'chmod') $t .= 'decoct($s[\'mode\'] &amp; 0777)'; else $t .= '$s[\''.$v.'\']'; if($sort == 'name') { $cd .= '$pages[$page][\'dirs\']'.$t.";\n"; $cf .= '$pages[$page][\'files\']'.$t.";\n"; }else { $ci .= '$all'.$t.";\n"; } } /* we cannot optimize sorting, if sorted field is not name: we will have to call expensive stat() for every file, not only $perpage files. */ if($sort == 'name') { eval(' for($i = 0; $i &lt; '.$l.'; $i++) { $page = floor($i / '.$perpage.') + 1; if( $page &lt; '.$pagemin.' || $page &gt; '.$pagemax.' ) continue; $n = $it[$i]; $s = stat($n); // is a directory? if(($s[\'mode\'] &amp; 0x4000) == 0x4000) { '.$cd.' }else { '.$cf.' } } '); } if($sort!='name') { eval(' for($i = 0; $i &lt; '.$l.'; $i++) { $n = $it[$i]; $s = stat($n); '.$ci.' } '); $code = 'array_multisort($all[\''.$sort.'\'], SORT_NUMERIC, SORT_'.strtoupper($order); foreach($fields as $v) { if($v != $sort) $code .= ', $all[\''.$v.'\']'; } $code .= ');'; /* code is evalled to prevent games with links to arrays */ eval($code); $pages = array(); $cf = $cd = ''; foreach($fields as $k =&gt; $v) { $cf .= '$pages[$page][\'files\'][\''.$v.'\'][] = $all[\''.$v.'\'][$i];'; $cd .= '$pages[$page][\'dirs\'][\''.$v.'\'][] = $all[\''.$v.'\'][$i];'; } eval(' for($i = 0; $i &lt; $l; $i++) { $page = floor($i / '.$perpage.') + 1; if( $page &lt; '.$pagemin.' || $page &gt; '.$pagemax.' ) continue; if(($all[\'mode\'][$i] &amp; 0x4000) == 0x4000) { '.$cd.' }else { '.$cf.' } } '); } if($res) $res['pages'] = $pages; chdir($old_dir); return $res; }else { extract($ftp_list); if($fields !== array('name', 'size') || $sort!='name') return d_error('Custom fields and sorting not by name are not currently supported in FTP mode'); $files = array_map('basename', $files); $dirs = array_map('basename', $dirs); $fl = sizeof($files); $dl = sizeof($dirs); if($filt) { $files_c = $dirs_c = array(); for($i=0; $i&lt;$fl; $i++) if(strpos(strtolower($files[$i]),$filt)!==false) $files_c[]=$files[$i]; for($i=0; $i&lt;$dl; $i++) if(strpos(strtolower($dirs[$i]),$filt)!==false) $dirs_c[]=$dirs[$i]; $dirs = $dirs_c; $files = $files_c; $fl = sizeof($files); $dl = sizeof($dirs); } if(!$split) $perpage = $fl + $dl; $pages = array(); for($i=0,$arr='files'; $arr=='files'||$i&lt;$dl; $i++) { if($arr=='files' &amp;&amp; $i&gt;=$fl) { $arr='dirs'; $i=0; } $page = floor($i / $perpage) + 1; if( $page &lt; $pagemin || $page &gt; $pagemax ) continue; $pages[$page][$arr]['name'][] = ${$arr}[$i]; $pages[$page][$arr]['size'][] = @$fsizes[$dir.'/'.${$arr}[$i]]; } return array('items_num' =&gt; ($fl+$dl), 'pages_num' =&gt; ceil(($fl+$dl) / $perpage), 'pages' =&gt; $pages); } }</span></span></code> </pre><br>  Performance Analysis: <br><blockquote>  169 ms generation <br>  13.48 MB of memory <br>  2 kb in gzip <br>  7 ms to request in browser <br>  = 200 ms <br><br>  + quick start <br>  - it takes a lot of memory <br>  - long and resource-intensive data upload: folder scan again </blockquote><br></div></div><br>  3. The idea of ‚Äã‚Äãthe next optimization came to my mind when I wrote my DBMS, which I already told about here on Habr√© (yes, that crazy one is me :)).  The previous mechanism was doing well, except that it was necessary to do the division into pages, and for each page I had to bypass the directory again.  Therefore, I decided to write code that would cache the directory structure in such a way that it was possible to quickly select ranges of files, for example, to quickly get files from 1000 to 1100. <br><div class="spoiler">  <b class="spoiler_title">Description</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">/* the cached version of filelist especially made for JS GGGR returns: array( 'items' =&gt; array( start: array( 'name' =&gt; ..., 'size' =&gt; ..., 'is_dir' =&gt; true|false, ), ... start+length-1: array( 'name' =&gt; ..., 'size' =&gt; ..., 'is_dir' =&gt; true|false, ), ), 'cnt' =&gt; N ) */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">d_filelist_cached</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($dir, $start, $length, $filter = </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">''</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//sleep(1); $tmpdir = is_callable('get_tmp_dir') ? get_tmp_dir() : '/tmp'; $cache_prefix = $tmpdir.'/dolphin'.md5(__FILE__); $cache_dat = $cache_prefix.'.dat'; $cache_idx = $cache_prefix.'.idx'; $new = false; if(!file_exists($cache_dat) || filemtime($dir) &gt; filemtime($cache_dat)) { $new = true; $fp = fopen($cache_dat, 'w+b'); $ifp = fopen($cache_idx, 'w+b'); }else { $fp = fopen($cache_dat, 'r+b'); $ifp = fopen($cache_idx, 'r+b'); list(, $l) = unpack('n', fread($fp, 2)); $cached_dir = fread($fp, $l); list(, $l) = unpack('n', fread($fp, 2)); $cached_filter = fread($fp, $l); if($cached_dir != $dir || $cached_filter != $filter) { ftruncate($fp, 0); ftruncate($ifp, 0); fseek($fp, 0, SEEK_SET); fseek($ifp, 0, SEEK_SET); $new = true; } } $items = array(); $cnt = 0; $old_cwd = getcwd(); try { if(!@chdir($dir)) throw new Exception('Could not chdir to the folder'); if($new) { fwrite($fp, pack('n', strlen($dir)).$dir); fwrite($fp, pack('n', strlen($filter)).$filter); $pos = ftell($fp); $dh = opendir('.'); if(!$dh) throw new Exception('Could not open directory for reading'); $filter = strtolower($filter); while( false !== ($f = readdir($dh)) ) { if($f == '.' || $f == '..') continue; if(strlen($filter) &amp;&amp; !substr_count(strtolower($f), $filter)) continue; fwrite($ifp, pack('NN', $pos, strlen($f))); fwrite($fp, $f); $pos += strlen($f); // ftell is not as fast as it should be, sadly } fflush($ifp); fflush($fp); } fseek($ifp, $start * 8 /* length(pack('NN')) */); $first = true; $curr_idx = $start; while( $curr_idx &lt; $start + $length ) { list(, $pos, $l) = unpack('N2', fread($ifp, 8)); if($first) { fseek($fp, $pos); $first = false; } $f = fread($fp, $l); if(!strlen($f)) break; if(strlen($f) != $l) { throw new Exception('Consistency error'); } $items[$curr_idx++] = array( 'name' =&gt; $f, 'size' =&gt; filesize($f), 'is_dir' =&gt; is_dir($f), ); } $cnt = filesize($cache_idx) / 8; }catch(Exception $e) { fclose($fp); fclose($ifp); unlink($cache_dat); unlink($cache_idx); @chdir($old_cwd); return is_callable('d_error') ? d_error($e-&gt;getMessage()) : false; } if($cnt &lt; 500 &amp;&amp; $length &gt;= 500) { usort($items, 'd_filelist_cached_usort_cmp'); } @chdir($old_cwd); return array( 'items' =&gt; $items, 'cnt' =&gt; $cnt ); } function d_filelist_cached_usort_cmp($it1, $it2) { return strcmp( $it1['name'], $it2['name'] ); }</span></span></code> </pre> <br>  Performance Analysis: <br><blockquote>  460 ms generation <br>  1.18 MB of memory <br>  2 kb in gzip <br>  8 ms to request in browser <br>  = 500 ms <br><br>  + easy and fast loading <br>  + does not require much memory <br>  - slow start <br>  - storage of intermediate files of significant size (800 Kb per 50,000 files with a directory file size of 1.6 MB) </blockquote><br></div></div><br>  4. If you read the code above, you probably noticed that the code was very simple at first, then it became very difficult (to the extent that it was impossible to maintain), then it became easier ... And of course, the simplest idea came to me for some reason to the head last: the fastest code is one that does as little as possible, and for PHP it is very relevant.  You may notice that the "/" symbol can never be present in the names of files and directories, so the list of files can be made up as a string: <br><pre> <code class="php hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">d_filelist_simple</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($dir)</span></span></span><span class="hljs-function"> </span></span>{ $dh = opendir($dir); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!$dh) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> d_error(<span class="hljs-string"><span class="hljs-string">"Cannot open $dir"</span></span>); <span class="hljs-comment"><span class="hljs-comment">// use as little memory as possible using strings $files = ''; // assuming that first two entries are always "." and ".." or (in case of root dir) it is only "." // we can read first two entries separately and skip check for "." and ".." in main cycle for // maximum possible performance for ($i = 0; $i &lt; 2; $i++) { $f = readdir($dh); if ($f === false) return array('res' =&gt; '', 'cnt' =&gt; 0); if ($f === "." || $f === "..") continue; $files .= "$f/"; } while (false !== ($f = readdir($dh))) $files .= "$f/"; closedir($dh); return array('res' =&gt; $files, 'cnt' =&gt; substr_count($files, '/')); }</span></span></code> </pre> <br>  Since in PHP concatenation is O (1), this code in PHP, I think, works as fast as it is possible at all (in this situation) and consumes the minimum possible amount of RAM: it is very hard to do less (without compression), because somehow separate file names. <br>  This code, in fact, allows you to open a folder of 500k files, consuming less than 32 MB, and this taking into account json_encode.  Since we compose a very simple data structure - just a string, the running time of json_encode will also be very short, as is the cost of parsing by the browser.  After receiving the line split is done ('/') and we get a complete list of files in the folder.  After that, the second AJAX request can ask for information only for visible files (you can also include the first few hundred files in response).  Thus, we solve all the problems that we had before: long generation of the list of files, wasteful memory consumption and inconvenience with scrolling large lists. <br><div class="spoiler">  <b class="spoiler_title">Analysis of the performance of this scheme (50 000 files)</b> <div class="spoiler_text">  48 ms generation <br>  1.92 MB of memory <br>  107 KB in gzip (+ 200 ms per download) <br>  56 ms in browser <br>  = 300 ms <br><br>  + quick start <br>  + no data load for file names <br>  + low CPU cost <br>  - spends a lot of traffic <br>  - spends a lot of memory in the browser </div></div><br><br><h4>  Links </h4><br>  Video showing the latest version of my file manager (version is not without problems): <a href="http://www.youtube.com/watch%3Fv%3DXSvY9joxQqI">www.youtube.com/watch?v=XSvY9joxQqI</a> <br>  <b>Sources:</b> <a href="https://github.com/YuriyNasretdinov/Dolphin.php">github.com/YuriyNasretdinov/Dolphin.php</a> <br>  The forum branch with the surviving old version: <a href="http://forum.dklab.ru/viewtopic.php%3Ft%3D9504">forum.dklab.ru/viewtopic.php?t=9504</a> </div><p>Source: <a href="https://habr.com/ru/post/146408/">https://habr.com/ru/post/146408/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../146402/index.html">Development of a startup in 24 hours at AngelHack 2012</a></li>
<li><a href="../146403/index.html">About the MultiWii flight controller (copters, airplanes and helicopters)</a></li>
<li><a href="../146404/index.html">Once again about WOL</a></li>
<li><a href="../146405/index.html">CoffeeScript: Classes</a></li>
<li><a href="../146407/index.html">Nokia fires some Qt developers</a></li>
<li><a href="../146409/index.html">Google Maps API reduces prices by 8 times</a></li>
<li><a href="../146410/index.html">Court decision: Motorola Mobility (aka Google) does not infringe Apple patents</a></li>
<li><a href="../146413/index.html">Boxopus - download torrents in a dropbox account</a></li>
<li><a href="../146414/index.html">Features processing HTML-letters</a></li>
<li><a href="../146415/index.html">Ivy Bridge Documentation and Programming Guide</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>