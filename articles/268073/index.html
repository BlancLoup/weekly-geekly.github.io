<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Recommended system on .Net or first steps with MyMediaLite</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I once went to the courses on BigData, on the recommendation of friends and I was lucky enough to participate in the competition. I will not talk abou...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Recommended system on .Net or first steps with MyMediaLite</h1><div class="post__text post__text-html js-mediator-article"><img alt=" ,    ? :)" title="Try to choose which one is better? :)" src="https://habrastorage.org/files/d32/920/b51/d32920b513b149649fdaf96d38b1f772.jpg"><br><br>  I once went to the courses on BigData, on the recommendation of friends and I was lucky enough to participate in the competition.  I will not talk about learning on the course, but I will tell you about the <a href="http://www.mymedialite.net/">MyMediaLite</a> library on .Net and how I used it. <br><a name="habracut"></a><br><h4>  Foreplay </h4><br>  On the nose was the final laboratory work.  Throughout the course, I didn‚Äôt really compete in laboratory work, towards the end, life forced me to fight - in order to receive a certificate, I had to earn points.  The last lecture was not very informative, rather a review, and I decided not to waste time, in parallel to do the last lab.  Unfortunately, I did not have a cluster with Apache Spark installed at that time.  On the educational cluster, as everyone rushed to do the laboratory, there were few chances and resources for success.  My choice fell on <a href="http://www.mymedialite.net/">MyMediaLite</a> on C # .Net.  Fortunately, there was a working server, not very loaded and dedicated for experiments, quite good, with two percents and 16 Gb of RAM. <br><br><h4>  Conditions of the problem </h4><br>  We were provided with the following data: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ul><li>  The <b>train.csv</b> movie rating table (userId, movieId, rating, timestamp).  A good half of the sample is given to the mercy (randomly sorted by movieId and userId), the second half remains with the course supervisor, to assess the quality of the recommender system </li><li>  table <b>tags.csv</b> (userId, movieId, tag, timestamp fields) with movie tags </li><li>  the <b>movies.csv</b> table (movieId, title, genres fields) with the movie title and its genre </li><li>  table <b>links.csv</b> (movieId, imdbId, tmdbId fields) matching movie identifier in imdb and themoviedb databases (there you can find additional movie features) </li><li>  the <b>test.csv</b> table (userId, movieId and rating fields) is actually the second half of the sample, but without ratings. </li></ul><br>  It is necessary to predict movie ratings in the test.csv table, generate a result file that contains data in the format: userId, movieId, rating and fill in the checker.  The quality of the recommendations will be evaluated by <a href="https://en.wikipedia.org/wiki/Root-mean-square_deviation">RMSE</a> and it should be no worse (means no more) 0.9 for the test.  Next will be a struggle for the best result. <br><br>  All data files are available here <a href="https://goo.gl/iVEbfA">https://goo.gl/iVEbfA</a> <br>  Excellent article about how to count <a href="http://www.australianweathernews.com/verify/example.htm">RMSE</a> <br><br><h4>  My decision </h4><br>  The latest version of the <a href="https://github.com/nodirmcsd/lab10">code</a> is available in Gihab. <br><br>  Well, who goes into battle without intelligence?  ‚ÄúIntelligence data‚Äù was received during the breaks in lectures and it turned out that we were slipped :) the notorious <a href="http://grouplens.org/datasets/movielens/">movielens 1m</a> , with the <a href="http://grouplens.org/datasets/movielens/">addition of</a> some other data set.  Those who have already coped with the laby praised <a href="https://en.wikipedia.org/wiki/Singular_value_decomposition">SVD</a> ++. <br><br>  As a rule, any machine learning consists of three parts: <br><br><ul><li>  Representation </li><li>  Evaluation </li><li>  Optimization </li></ul><br>  I also went down this path and divided the sample into two parts, 70% and 30%, respectively.  The second part of the sample is needed to verify the accuracy of the model.  The very first version of the code was written, according to the results of which the laboratory work was successfully submitted.  The result is <i>0.880360573502</i> on the <i>BiasedMatrixFactorization</i> model.  I dismounted all the tinsel with tags and links immediately, they could be used as additional features to get the best result.  I did not spend time on it and it was the right decision, IMHO.  Users who were not in the training set were also ignored boldly, and ratings were put down by unknown values, which were returned by the BiasedMatrixFactorization class.  This was a serious mistake that cost me first place.  On the <i>SVD ++</i> model, the result was <i>0.872325203952</i> .  Checker showed the first place and I, with peace of mind, rehearsing the speech of the winner went to sleep.  But as they say, chickens count in the fall. <br><br><h4>  Results of the competition </h4><br>  I will be brief, the winning place has passed from hand to hand several times.  As a result, at the time of the deadline, my friend got the first place, and I - the second.  We, programmers - stubborn people, managed to squeeze out the best result on <i>BiasedMatrixFactorization</i> .  Alas, after the deadline. <br><br><img src="https://habrastorage.org/files/1b0/b7f/124/1b0b7f12481e4383a7c1540c81e318c6.png" alt="image"><br><br><h4>  Alternative solution </h4><br>  My friend <a href="http://habrahabr.ru/users/wenk/" class="user_link">wenk</a> , who received the first place, kindly agreed to provide his code.  His solution was implemented on a cluster with Apache Spark, using ALS from scikit-learn. <br><br><pre><code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># coding: utf-8 # In[1]: import os import sys os.environ["PYSPARK_SUBMIT_ARGS"]=' --driver-memory 5g --packages com.databricks:spark-csv_2.10:1.1.0 pyspark-shell' sys.path.insert(0, os.environ.get('SPARK_HOME', None) + "/python") import py4j from pyspark import SparkContext,SparkConf,SQLContext conf = (SparkConf().setMaster("spark://bd-m:7077") .setAppName("lab09") .set("spark.executor.memory", "50g") .set("spark.driver.maxResultSize","5g") .set("spark.driver.memory","2g") .set("spark.cores.max", "26")) sc = SparkContext(conf=conf) sqlCtx = SQLContext(sc) # In[2]: ratings_src=sc.textFile('/lab10/train.csv',26) ratings=ratings_src.map(lambda r: r.split(",")).filter(lambda x: x[0]!='userId').map(lambda x: (int(x[0]),int(x[1]),float(x[2]))) ratings.take(5) # In[3]: test_src=sc.textFile('/lab10/test.csv',26) test=test_src.map(lambda r: r.split(",")).filter(lambda x: x[0]!='userId').map(lambda x: (int(x[0]),int(x[1]))) test.take(5) # In[4]: from pyspark.mllib.recommendation import ALS, MatrixFactorizationModel from pyspark.mllib.recommendation import Rating rat = ratings.map(lambda r: Rating(int(r[0]),int(r[1]),float(r[2]))) rat.cache() rat.first() # In[14]: training,validation,testing = rat.randomSplit([0.6,0.2,0.2]) # In[15]: print training.count() print validation.count() print testing.count() # In[16]: training.cache() validation.cache() # In[17]: import math def evaluate_model(model, dataset): testdata = dataset.map(lambda x: (x[0],x[1])) predictions = model.predictAll(testdata).map(lambda r: ((r[0], r[1]), r[2])) ratesAndPreds = dataset.map(lambda r: ((r[0], r[1]), r[2])).join(predictions) MSE = ratesAndPreds.map(lambda r: (r[1][0] - r[1][1])**2).reduce(lambda x, y: x + y) / ratesAndPreds.count() RMSE = math.sqrt(MSE) return {'MSE':MSE, 'RMSE':RMSE} # In[12]: rank=20 numIterations=30 # In[28]: model = ALS.train(training, rank, numIterations) # In[ ]: numIterations=30 lambda_=0.085 ps = [] for rank in range(25,500,25): model = ALS.train(training, rank, numIterations,lambda_) metrics = evaluate_model(model, validation) print("Rank = " + str(rank) + " MSE = " + str(metrics['MSE']) + " RMSE = " + str(metrics['RMSE'])) ps.append((rank,metrics['RMSE'])) # In[10]: ls = [] rank=2 numIterations = 30 for lambda_ in [0.0001, 0.001, 0.01, 0.1, 1.0, 10.0, 100.0, 1000.0]: model = ALS.train(training, rank, numIterations, lambda_) metrics = evaluate_model(model, validation) print("Lambda = " + str(lambda_) + " MSE = " + str(metrics['MSE']) + " RMSE = " + str(metrics['RMSE'])) ls.append((lambda_,metrics['RMSE'])) # In[23]: ls = [] rank=250 numIterations = 30 for lambda_ in [0.085]: model = ALS.train(training, rank, numIterations, lambda_) metrics = evaluate_model(model, validation) print("Lambda = " + str(lambda_) + " MSE = " + str(metrics['MSE']) + " RMSE = " + str(metrics['RMSE'])) ls.append((lambda_,metrics['RMSE'])) #Lambda = 0.1 MSE = 0.751080178965 RMSE = 0.866648821014 #Lambda = 0.075 MSE = 0.750219897276 RMSE = 0.866152352232 #Lambda = 0.07 MSE = 0.750033337876 RMSE = 0.866044651202 #Lambda = 0.08 MSE = 0.749335888762 RMSE = 0.865641894066 #Lambda = 0.09 MSE = 0.749929174577 RMSE = 0.865984511742 #rank 200 Lambda = 0.085 MSE = 0.709501168484 RMSE = 0.842318923261 get_ipython().run_cell_magic(u'time', u'', u'rank=400\nnumIterations=30\nlambda_=0.085\nmodel = ALS.train(rat, rank, numIterations,lambda_)\npredictions = model.predictAll(test).map(lambda r: (r[0], r[1], r[2]))') # In[7]: te=test.collect() base=sorted(te,key=lambda x: x[0]*1000000+x[1]) # In[8]: pred=predictions.collect() # In[9]: t_=predictions.map(lambda x: (x[0], {x[1]:x[2]})).reduceByKey(lambda a,b: dict(a.items()+b.items())).collect() t={} for i in t_: t[i[0]]=i[1] s="userId,movieId,rating\r\n" for i in base: if t.has_key(i[0]): u=t[i[0]] if u.has_key(i[1]): s+=str(i[0])+","+str(i[1])+","+str(u[i[1]])+"\r\n" else: s+=str(i[0])+","+str(i[1])+",3.67671059005\r\n" else: s+=str(i[0])+","+str(i[1])+",3.67671059005\r\n" # In[12]: text_file = open("lab10.csv", "w") text_file.write(s) text_file.close()</span></span></code> </pre> <br><br><h4>  My experience </h4><br>  I noted some facts for myself: <br><br><ul><li>  You should always carefully study the data, not ‚Äúfill in the gaps‚Äù, but try to fill them with similar values.  For example, the average rating of the sample instead of empty values, significantly improved the result </li><li>  Rounding the result (rating) reduced prediction accuracy rather than a long tail. </li><li>  The best option was calculated for the entire sample, without validation.  The <b>DoCrossValidation</b> method was used <b>.</b> </li><li>  Ideally, it was necessary to plot the parameters (number of iterations, etc.) and the result of RMSE.  Move to victory is not blind, but sighted </li><li>  Apache Spark gives a gain in computation time, since it runs on several machines.  If time is critical - use spark </li><li>  MyMediaLite is quite a decent library for small, non-time-critical tasks.  It can justify itself when it is unprofitable to raise a cluster with a spark </li></ul><br>  Oh, if I knew all this before, I would have won ... I am grateful for your opinion and advice from friends, do not kick much ... </div><p>Source: <a href="https://habr.com/ru/post/268073/">https://habr.com/ru/post/268073/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../268057/index.html">CUSTIS Open Seminars: Graduation Season</a></li>
<li><a href="../268061/index.html">Democracy and Program Committee</a></li>
<li><a href="../268063/index.html">Friday format: How to write code that no one can accompany</a></li>
<li><a href="../268067/index.html">Security Week 40: Invincibility in WinRAR, bug veteran in Firefox, Microsoft update-oops</a></li>
<li><a href="../268069/index.html">Unity - Conceptual ideas and tips for newcomers igrodeva. Simple procedural generation of models for 2D games</a></li>
<li><a href="../268077/index.html">Project Fi - what can its subscribers get?</a></li>
<li><a href="../268079/index.html">Playgrounds for browser games</a></li>
<li><a href="../268081/index.html">Diagnosing the behavior of "cumulative" (rollup) fields in Microsoft Dynamics CRM 2015</a></li>
<li><a href="../268087/index.html">Critical vulnerabilities discovered in TrueCrypt cryptograph</a></li>
<li><a href="../268089/index.html">It's time. Upgrade to Oracle Database 12</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>