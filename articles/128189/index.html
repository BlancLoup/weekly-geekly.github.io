<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Implementing code in Silverlight</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In my free time I develop Snoop . This is a great help for WPF developers, which does not have good free analogues in the world of Silverlight. Snoop ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Implementing code in Silverlight</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/303/8f4/92b/3038f492ba9950aad98414f38abe4ea1.jpg" alt="image" align="right">  In my free time I develop <a href="http://snoopwpf.codeplex.com/">Snoop</a> .  This is a great help for WPF developers, which does not have good free analogues in the world of Silverlight.  Snoop injects its assembly into the WPF process and lays it out on the shelves. <br><br>  I was curious: is it possible to embed an arbitrary assembly into a running silverlight process from outside the browser?  <s>(possible)</s> This will be discussed under the cut. <br><br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      As far as I know, all existing programs that embed code in silverlight do this by intercepting and modifying the .xap file before loading the application.  This is a good way, but it has several disadvantages: <br><br>  1. You can not connect to an already running application without reloading the page. <br>  2. Intercepting the .xap file often limits the execution environment of the Internet Explorer plugin.  For a universal interceptor, you need to use / write http-sniffer. <br><br>  I want to suggest a method that allows you to connect to an already running application and integrate into it without reloading the page, without modifying the .xap file and without restricting the browser.  Before we begin, let me introduce today's open-source guest: <br><br><h5>  slinject </h5><br>  This console program is the fruit of programmer curiosity.  It allows you to select a process that executes the Silverlight and embed the Silverlight assembly into it (click for higher resolution): <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/303/8f4/92b/3038f492ba9950aad98414f38abe4ea1.jpg" alt="Assembly injection example"></div><br><br>  Binaries can be downloaded <a href="">here</a> , and the source code in C # is available on <a href="https://github.com/anvaka/slinject">github'e</a> .  Before you begin to be introduced, the program must be installed by running the command: <br><br> <code>slinject --install</code> <br> <br>  This is a one-time operation requiring administrative rights.  After installing the injector can be implemented by any user. <br><br><h5>  Wait, don't leave!  Or how it works </h5><br>  As is often the case, the idea is very simple.  Connect with the debugger to the Silverlight process and execute the Assembly.Load () command.  It was always possible to do it from the Visual Studio debugger, but can it be done from your program? <br><br>  Silverlight is installed with a number of interesting libraries and tools that, unfortunately, have either disgusting documentation or none.  One such library is <b>dbgshim.dll</b> .  It is through this door that debuggers walk into the world of Silverlight.  Visual Studio uses it, so why don't we take advantage of the loophole?  True, why not?  The absence of good <a href="http://msdn.microsoft.com/en-us/library/cc994496.aspx">documentation</a> cannot be called a good argument.  But a good challenge for the curious is possible. <br><br>  So, after several nights of wandering around the <s>realm of Morpheus, the</s> <a href="http://msdn.microsoft.com/en-us/library/ms230588.aspx">ICorDebug</a> namespace managed to write a console program that could be a simple Silverlight debugger of processes.  She was able to react to the main events of the debugger, find the necessary functions, set bryakpoint and dwell on them.  Sometimes she even knew how to do expression evaluation (aka function evaluation, FuncEval), to execute code, I mean.  Alas, she never learned how to make coffee. <br><br><h5>  Problem </h5><br>  It was necessary to find a method in Silverlight, which would be guaranteed to be called in any Silverlight process in order to put a breakpoint in it.  In the case of WPF / WinForms applications, everything is simple.  We take handler of queue of Windows of messages and we put break point in it.  But there is no Windows message queue in Silverlaite.  Fortunately, it has a close analogue: the JoltHelper.FireEvent () method.  This method is called even in an empty Silverlight application, you just need to move the mouse. <br><br>  Remember, I said that the console debugger could do expression evaluation ... sometimes?  In fact, to execute code during a breakpoint, the debugging infrastructure requires a <a href="http://blogs.msdn.com/b/jmstall/archive/2005/11/15/funceval-rules.aspx">number of conditions</a> .  If the method is optimized for any funceval, there can be no talk.  JoltHelper.FireEvent () is, of course, optimized: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/ab9/471/d6e/ab9471d6e35af124f90f214f03643985.jpg" alt="Optimized code disables FuncEval"></div><br><br><h5>  Decision </h5><br>  It turns out Silverlight jitter, like its big brother from the .NET world, listens to <a href="http://msdn.microsoft.com/en-us/library/9dd8z24x.aspx">.ini recommendations</a> for optimizing the generated code.  It is enough to create the following .INI file next to the assembly: <br><br> <code>[.NET Framework Debugging Control] <br> GenerateTrackingInfo=1 <br> AllowOptimize=0</code> <br> <br>  Save it as ‚ÄúAssembly_No_D_D_DJ.INI‚Äù, and the next time during JIT compilation the generated code will be more friendly to the debugger.  The biggest catch is in the .ini file encoding.  If it is different from UTF-16 Little Endian, the file will be simply ignored. <br><br>  To improve performance, Silverlight, during installation, generates machine code images for standard assemblies.  In fact, the same <a href="http://msdn.microsoft.com/en-us/library/6t9t5wcf(v%3Dvs.80).aspx">ngen</a> , only the utility is called coregen, and the result of the generation is put in the Silverlight folder.  Coregen also takes into account the availability of .ini recommendations, and can generate debugged machine code. <br><br>  When you speak: <br><br> <code>slinject --install</code> <br> <br>  The program creates a System.Windows.ini file with the necessary jitter recommendations.  deletes the old precompiled System.Windows.ni.dll image, and asks the coregen to create a debugged image.  And of course, to undo all these changes, you just need to perform <br><br> <code>slinject --uninstall</code> <br> <br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/4c7/8f8/ffa/4c78f8ffae88c0c443ff4794d3002d0d.jpg" alt="So what?"></div><br><br><h5>  Finally </h5><br>  So, are we getting a universal Silverlight assembly builder?  Unfortunately no.  Even killing a thread looks more innocuous than interrupting it in a random place with a request to execute a random code.  Mike Stall in his blog tells why <a href="http://blogs.msdn.com/b/jmstall/archive/2005/03/23/400794.aspx">FuncEval is evil</a> , but useful evil.  In the end, this is how Watches / Locals / Immediate windows work in Visual Studio.  Armed with this knowledge, using slinject, get ready for the crashes of Silverlight processes, browser crashes and deception of politicians. <br><br>  Moreover, I am not an expert in COM'e / ICorDebug'e.  Surely I have done a bunch of blunders <a href="https://github.com/anvaka/slinject">in the code</a> , but this is open source - I will be glad if you show / fix errors. <br><br>  I hope you enjoyed this walk into the world of the Silverlight debugger - I will be happy for the reviews :). </div><p>Source: <a href="https://habr.com/ru/post/128189/">https://habr.com/ru/post/128189/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../128182/index.html">Docblox - some innovations</a></li>
<li><a href="../128183/index.html">"RosYama" opened the source code of the site under a free license</a></li>
<li><a href="../128184/index.html">Ridiculous nonsense</a></li>
<li><a href="../128186/index.html">What does Junior need to get settled?</a></li>
<li><a href="../128188/index.html">From the Windows Phone Marketplace removed "antivirus", collecting personal data</a></li>
<li><a href="../128191/index.html">How to write quine</a></li>
<li><a href="../128192/index.html">Free book "Best of Smashing Magazine"</a></li>
<li><a href="../128193/index.html">Find greater value without comparison and conditions</a></li>
<li><a href="../128194/index.html">Smozzy application for Android: go to the Internet without the Internet</a></li>
<li><a href="../128197/index.html">Looking for mail.ru on Google?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>