<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Business logic in a database using SchemaKeeper</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The purpose of this article is to show, using the example of the schema-keeper library, tools that make it possible to significantly simplify the proc...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Business logic in a database using SchemaKeeper</h1><div class="post__text post__text-html js-mediator-article"><p>  The purpose of this article is to show, using the example of the <a href="https://packagist.org/packages/schema-keeper/schema-keeper">schema-keeper</a> library, tools that make it possible to significantly simplify the process of developing databases within PHP projects using the PostgreSQL DBMS. </p><br><p>  The information from this article, first of all, will be useful for developers who want to use the capabilities of PostgreSQL to the maximum, but are faced with the problems of maintaining the business logic in the database. </p><br><p>  The article will not describe the advantages or disadvantages of storing business logic in a database.  It is assumed that the choice has already been made by the reader. </p><br><p>  The following questions will be considered: </p><br><ol><li>  In which form to store the database structure in the version control system (hereinafter referred to as VCS) </li><li>  How to track changes in the database structure after saving a dump </li><li>  How to transfer changes in the database structure to other environments without conflicts and giant migration files </li><li>  How to adjust the process of parallel work on a project of several developers </li><li>  How to safely deploy a large number of changes in the database structure in a production environment <a name="habracut"></a><br><blockquote>  <strong>SchemaKeeper is designed</strong> to work with stored procedures written in the <a href="https://www.postgresql.org/docs/current/plpgsql.html">PL / pgSQL</a> language.  Testing with other languages ‚Äã‚Äãwas not conducted, respectively, the use may not be as effective or impossible. <br></blockquote></li></ol><br><h2 id="v-kakom-vide-hranit-damp-struktury-bd-v-vcs">  How to store the dump structure of the database in VCS </h2><br><p>  The <a href="https://packagist.org/packages/schema-keeper/schema-keeper">schema-keeper</a> library provides the <a href="">saveDump</a> function, which saves the structure of all objects from the database as separate text files.  The output creates a directory containing the database structure, divided into grouped files that are easy to add to the VCS. </p><br><p>  Consider the conversion of objects from the database to files with a few examples: </p><br><table><thead><tr><th>  Object type </th><th>  Scheme </th><th>  Title </th><th>  Relative file path </th></tr></thead><tbody><tr><td>  Table </td><td>  public </td><td>  accounts </td><td><code>./public/tables/accounts.txt</code> </td> </tr><tr><td>  Stored procedure </td><td>  public </td><td>  auth (hash bigint) </td><td> <code>./public/functions/auth(int8).sql</code> </td> </tr><tr><td>  Representation </td><td>  booking </td><td>  tariffs </td><td> <code>./booking/views/tariffs.txt</code> </td> </tr></tbody></table><br><p>  The contents of the files is a textual representation of the structure of a specific database object.  For example, for stored procedures, the contents of the file will be the complete definition of the stored procedure, starting with the <code>CREATE OR REPLACE FUNCTION</code> block. </p><br><p>  As can be seen from the table above, the path to the file stores information about the type, scheme and name of the object.  This approach makes it easier to navigate through the dump and code review of changes to the database. </p><br><blockquote>  The <code>.sql</code> for the files with the source code of stored procedures is selected in order for the IDE to automatically provide tools for interacting with the database when opening a file. </blockquote><br><h2 id="kak-otslezhivat-izmeneniya-v-strukture-bd-posle-sohraneniya-dampa">  How to track changes in the database structure after saving a dump </h2><br><p>  By saving the dump of the current database structure in VCS, we are able to check whether changes have been made to the database structure after creating the dump.  The <a href="https://packagist.org/packages/schema-keeper/schema-keeper">schema-keeper</a> library for detecting changes in the database structure provides a function <a href="">verifyDump</a> , which returns information about differences without side effects. </p><br><p>  An alternative way to check is to call the <code>saveDump</code> function <code>saveDump</code> , specifying the same directory, and check for changes in the VCS.  Since all objects from the database are saved in separate files, VCS will show only the changed objects.  The main disadvantage of this method is the need to overwrite files to see the changes. </p><br><h2 id="kak-perenosit-izmeneniya-v-strukture-bd-na-drugie-okruzheniya-bez-konfliktov-i-gigantskih-faylov-migraciy">  How to transfer changes in the database structure to other environments without conflicts and giant migration files </h2><br><p>  Thanks to the <a href="">deployDump</a> function <a href="">, the</a> source code of stored procedures can be edited in exactly the same way as regular application source code.  You can add / delete new lines in the code of stored procedures and immediately send changes to the version control system, or create / delete stored procedures by creating / deleting the corresponding files in the dump directory. </p><br><p>  For example, to create a new stored procedure in the <code>public</code> scheme, it is enough to create a new file with the <code>.sql</code> extension in the <code>public/functions</code> directory, place the source code of the stored procedure in it, including the <code>CREATE OR REPLACE FUNCTION</code> block, then call the <code>deployDump</code> function.  Similarly, the change and removal of the stored procedure.  Thus, the code simultaneously enters both the VCS and the database. </p><br><p>  If an error appears in the source code of any stored procedure, then <code>deployDump</code> will not be executed, throwing an exception.  The mismatch of stored procedures between the dump and the current database is not possible when using <code>deployDump</code> . </p><br><blockquote>  When creating a new stored procedure, there is no need to manually enter the correct file name.  It is enough that the file has the extension <code>.sql</code> .  The correct name can be obtained from the return value of the <code>deployDump</code> function, and use it to rename the file. </blockquote><p>  <code>deployDump</code> allows <code>deployDump</code> to change the parameters of a function or return type without additional actions, while the classical approach would have to <br>  first perform <code>DROP FUNCTION</code> , and only then <code>CREATE OR REPLACE FUNCTION</code> . </p><br><p>  Unfortunately, there are some situations where <code>deployDump</code> not able to automatically apply changes.  For example, if a trigger function is deleted that is used by at least one trigger.  Such situations are solved manually with the help of migration files. </p><br><p>  If the <a href="https://packagist.org/packages/schema-keeper/schema-keeper">schema-keeper</a> is responsible for transferring changes in stored procedures, then the migration files must be used to transfer the remaining changes in the structure.  For example, <a href="https://packagist.org/packages/doctrine/migrations">doctrine / migrations</a> is a good migration library. </p><br><p>  Migrations must be applied before <code>deployDump</code> .  This allows you to make all changes to the structure and resolve problem situations so that changes in stored procedures are subsequently transferred without problems. </p><br><p>  Work with migrations will be described in more detail in the following sections. </p><br><h2 id="kak-naladit-process-parallelnoy-raboty-nad-proektom-neskolkih-razrabotchikov">  How to adjust the process of parallel work on a project of several developers </h2><br><p>  You need to create a full database initialization script that will be launched by the developer on your working machine, adjusting the structure of the local database to the dump stored in the VCS.  The easiest way to divide the local database initialization into 3 steps: </p><br><ol><li>  Import a file with a basic structure, which will be called, for example, <code>base.sql</code> </li><li>  Migration application </li><li>  Call <code>deployDump</code> </li></ol><br><blockquote>  <code>base.sql</code> is the starting point, over which migrations are applied and <code>deployDump</code> is <code>deployDump</code> , that is, <code>base.sql +  + deployDump =   </code> .  You can generate such a file using the <code>pg_dump</code> utility.  <code>base.sql</code> used exclusively when initializing a database from scratch. </blockquote><p>  Let's call the full database initialization script <code>refresh.sh</code> .  Workflow might look like this: </p><br><ol><li>  The developer runs <code>refresh.sh</code> in his environment and gets the current database structure. </li><li>  The developer begins work on the task, modifying the local database to the needs of the new functionality ( <code>ALTER TABLE ... ADD COLUMN</code> , etc.) </li><li>  After completing the task, the developer calls the <code>saveDump</code> function to commit the changes made to the database to the VCS. </li><li>  The developer <code>refresh.sh</code> , then <code>verifyDump</code> , which now shows a list of changes to include in the migration. </li><li>  The developer transfers the entire structure change to the migration file, launches <code>refresh.sh</code> and <code>verifyDump</code> , and, if the migration is completed correctly, <code>verifyDump</code> will show that there is no difference between the local database and the saved dump </li></ol><br><p>  The process described above is compatible with gitflow principles.  Each branch in VCS will contain its own version of the dump, and when merging the branches, the dumps will be merged.  In most cases, no additional actions need to be taken after the merger, but if changes were made in different branches, for example, in the same table, a conflict may arise. </p><br><p>  Consider a conflict situation on an example: there is a <em>develop</em> branch, from which two branches are <em>branched</em> : <em>feature1</em> and <em>feature2</em> , which do not have conflicts with <em>develop</em> , but have conflicts between themselves.  The goal is to merge both branches in <em>develop</em> .  For such a case, it is recommended to first merge one of the branches in <em>develop</em> , and then merge <em>develop</em> to the remaining branch, while resolving conflicts in the remaining branch, and then merging the last branch to <em>develop</em> .  At the stage of conflict resolution, you may have to correct the migration file in the last branch so that it corresponds to the final dump, which includes the merge results. </p><br><h2 id="kak-bezopasno-deploit-bolshee-kolichestvo-izmeneniy-v-strukture-bd-na-production-okruzhenie">  How to safely deploy a large number of changes in the database structure in a production environment </h2><br><p>  Due to the presence in the VCS of the actual database structure, it becomes possible to check the production base for exact correspondence to the required structure.  This ensures that all the changes that the developers intended were successfully transferred to the production-base. </p><br><p>  Since the PostgreSQL <a href="https://www.postgresql.org/docs/current/ddl.html">DDL</a> is <a href="https://wiki.postgresql.org/wiki/Transactional_DDL_in_PostgreSQL:_A_Competitive_Analysis">transactional</a> , it is recommended that you follow the following deployment order so that, in case of an unforeseen error, it is ‚Äúpainless‚Äù to perform a <code>ROLLBACK</code> : </p><br><ol><li>  Start transaction </li><li>  Complete all migrations in a transaction </li><li>  In the same transaction, perform <code>deployDump</code> </li><li>  Without completing the transaction, execute <code>verifyDump</code> .  If there are no errors, execute <code>COMMIT</code> .  If there is an error, perform a <code>ROLLBACK</code> </li></ol><br><p>  These steps are fairly easy to integrate into existing approaches to the deployment of applications, including zero-downtime. </p><br><h1 id="zaklyuchenie">  Conclusion </h1><br><p>  Thanks to the methods described above, you can squeeze out maximum performance from ‚ÄúPHP + PostgreSQL‚Äù projects, while sacrificing a relatively small amount of design convenience compared to implementing all the business logic in the main application code.  Moreover, data processing in <a href="https://www.postgresql.org/docs/current/plpgsql.html">PL / pgSQL</a> often looks more transparent and requires less code than the same functionality written in PHP. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/447746/">https://habr.com/ru/post/447746/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../447734/index.html">Why the front-end should understand the principles of UI</a></li>
<li><a href="../447736/index.html">Video from the drone - a new trend of social networks</a></li>
<li><a href="../447738/index.html">Julian Assange arrested by British police</a></li>
<li><a href="../447742/index.html">What is DevOps methodology and who needs it</a></li>
<li><a href="../447744/index.html">Climbing Elbrus - Reconnaissance. Technical Part 2. Interrupts, exceptions, system timer</a></li>
<li><a href="../447748/index.html">Linux Virtual File Systems: Why Do They Need It and How Do They Work? Part 2</a></li>
<li><a href="../447750/index.html">New processors for data centers - parse announcements of recent months</a></li>
<li><a href="../447754/index.html">Application in the menu bar for macOS</a></li>
<li><a href="../447756/index.html">New Gartner Application Monitoring Solution (APM) quadrant</a></li>
<li><a href="../447758/index.html">The story of the hacking of the classic game Dendy or Contra for 100 lives</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>