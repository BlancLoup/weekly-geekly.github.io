<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Delayed Durability or a story about how to speed up the execution of autotests from 11 to 2.5 minutes</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Relatively recently, I started helping with a new product project, which is being developed as a free web service for tracking working time. 

 The te...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Delayed Durability or a story about how to speed up the execution of autotests from 11 to 2.5 minutes</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/bc8/fd0/8de/bc8fd08deb74407fa06ff355019a3f60.png"><br><br>  Relatively recently, I started helping with a new product project, which is being developed as a free web service for tracking working time. <br><br>  The technology stack was initially small-scale, and <i>SQL Server 2014 Express was</i> used as a data warehouse.  One of the first tasks that I was assigned was to look into the possibility of accelerating autotests. <br><a name="habracut"></a><br>  Before I joined the work, the project existed for a long time and had already managed to acquire a fair amount of tests (at that time I counted 1300 autotests).  On the build machine with <i>SSD</i> tests were performed in 4-5 minutes, and on a regular <i>HDD</i> more than 11-12 minutes.  It would be possible to put the entire <i>SSD</i> team, but this would not solve the essence of the problem, especially since in the near future it was planned to expand the functionality and the tests would become even more. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      All tests were grouped and before performing each group, the database was cleared of old data.  Previously, cleaning took place by re-creating the database, but this approach was very slow in practice.  It was much faster to simply clean all the tables from the data and reset the <i>IDENTITY</i> value to zero, so that subsequent insertions would form the correct test data.  The script with this approach became my starting point: <br><br><pre><code class="1c hljs">EXEC sys.sp_msforeachtable 'ALTER TABLE ? NOCHECK CONSTRAINT ALL' DELETE FROM [dbo].[Project] DBCC CHECKIDENT('[dbo].[Project]', RESEED, <span class="hljs-number"><span class="hljs-number">0</span></span>) DBCC CHECKIDENT('[dbo].[Project]', RESEED) DELETE FROM [dbo].[RecentWorkTask] ... EXEC sys.sp_msforeachtable 'ALTER TABLE ? WITH CHECK CHECK CONSTRAINT ALL'</code> </pre> <br>  The first thing that caught my eye was to turn off and re-enable all the foundations on the base.  This behavior was intended to speed up the delete operation, but in fact it turned out to be a resource-intensive operation for the server.  Decided to abandon the use of this approach. <br><br>  Also, the idea immediately arose of using dynamic <i>SQL</i> to form a request to delete data.  For example, if there are foreign keys on the table, then use the <i>DELETE</i> operation as before. Otherwise, you can delete data with minimal logging using the <i>TRUNCATE</i> command. <br><br>  As a result, the request to delete data took the following form: <br><br><pre> <code class="1c hljs">DECLARE @SQL NVARCHAR(MAX) = '' SELECT @SQL = ( SELECT CASE WHEN p.[object_id] IS NOT <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> THEN CASE WHEN f.referenced_object_id IS <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> THEN N'TRUNCATE TABLE ' ELSE N'DELETE FROM ' END + obj_name ELSE '' END + CHAR(<span class="hljs-number"><span class="hljs-number">13</span></span>) + CHAR(<span class="hljs-number"><span class="hljs-number">10</span></span>) + CASE WHEN has_identity &gt; <span class="hljs-number"><span class="hljs-number">0</span></span> THEN N'DBCC CHECKIDENT('''+ obj_name + N''', RESEED, 0) WITH NO_INFOMSGS' ELSE '' END + CHAR(<span class="hljs-number"><span class="hljs-number">13</span></span>) + CHAR(<span class="hljs-number"><span class="hljs-number">10</span></span>) FROM ( SELECT obj_name = QUOTENAME(s.name) + '.' + QUOTENAME(o.name) , o.[object_id] , has_identity = IdentityProperty(o.[object_id], 'LastValue') FROM sys.objects o JOIN sys.schemas s ON o.[schema_id] = s.[schema_id] WHERE o.is_ms_shipped = <span class="hljs-number"><span class="hljs-number">0</span></span> AND o.[type] = 'U' ) t LEFT JOIN ( SELECT DISTINCT [object_id] FROM sys.partitions WHERE [rows] &gt; <span class="hljs-number"><span class="hljs-number">0</span></span> AND index_id IN (<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>) ) p ON t.[object_id] = p.[object_id] LEFT JOIN ( SELECT DISTINCT referenced_object_id FROM sys.foreign_keys ) f ON f.referenced_object_id = t.[object_id] FOR XML PATH(''), TYPE).value('.', 'NVARCHAR(MAX)') PRINT @SQL --EXEC sys.sp_executesql @SQL</code> </pre><br>  And if auto tests were initially performed for 11 minutes on my machine: <br><br><img src="https://habrastorage.org/files/d5b/12c/cd2/d5b12ccd2f3e4e73afdeb758e6a4cac5.png"><br><br>  Then after I threw out the <i>ALTER</i> statements and rewrote the request, all the tests started to run 40 seconds faster: <br><br><img src="https://habrastorage.org/files/fb1/6bd/708/fb16bd70896e4f88bc1d928daae90db5.png"><br><br>  Of course, you could be glad and put <i>Resolved</i> on the quiet for task, but the main problem remained: <br><br><img src="https://habrastorage.org/files/9b7/65d/62d/9b765d62d945457caf4360701a4823ad.png"><br><br>  When performing tests, the disk was very heavily loaded.  Decided to see what are waiting on the server.  To do this, first cleaned up <a href="https://msdn.microsoft.com/en-us/library/ms179984.aspx"><i>sys.dm_os_wait_stats</i></a> : <br><br><pre> <code class="1c hljs">DBCC SQLPERF(<span class="hljs-string"><span class="hljs-string">"sys.dm_os_wait_stats"</span></span>, CLEAR)</code> </pre><br>  Re-run the run AutoTests and after fulfilled the query: <br><br><pre> <code class="1c hljs">SELECT TOP(<span class="hljs-number"><span class="hljs-number">20</span></span>) wait_type , wait_time = wait_time_ms / <span class="hljs-number"><span class="hljs-number">1000</span></span>. , wait_resource = (wait_time_ms - signal_wait_time_ms) / <span class="hljs-number"><span class="hljs-number">1000</span></span>. , wait_signal = signal_wait_time_ms / <span class="hljs-number"><span class="hljs-number">1000</span></span>. , waiting_tasks_count , percentage = <span class="hljs-number"><span class="hljs-number">100.0</span></span> * wait_time_ms / SUM(wait_time_ms) OVER () , avg_wait = wait_time_ms / <span class="hljs-number"><span class="hljs-number">1000</span></span>. / waiting_tasks_count , avg_wait_resource = (wait_time_ms - signal_wait_time_ms) / <span class="hljs-number"><span class="hljs-number">1000</span></span>. / [waiting_tasks_count] , avg_wait_signal = signal_wait_time_ms / <span class="hljs-number"><span class="hljs-number">1000.0</span></span> / waiting_tasks_count FROM sys.dm_os_wait_stats WHERE [waiting_tasks_count] &gt; <span class="hljs-number"><span class="hljs-number">0</span></span> AND max_wait_time_ms &gt; <span class="hljs-number"><span class="hljs-number">0</span></span> AND [wait_type] NOT IN ( N'BROKER_EVENTHANDLER', N'BROKER_RECEIVE_WAITFOR', N'BROKER_TASK_STOP', N'BROKER_TO_FLUSH', N'BROKER_TRANSMITTER', N'CHECKPOINT_QUEUE', N'CHKPT', N'CLR_AUTO_EVENT', N'CLR_MANUAL_EVENT', N'CLR_SEMAPHORE', N'DBMIRROR_DBM_EVENT', N'DBMIRROR_EVENTS_QUEUE', N'DBMIRROR_WORKER_QUEUE', N'DBMIRRORING_CMD', N'DIRTY_PAGE_POLL', N'DISPATCHER_QUEUE_SEMAPHORE', N'EXECSYNC', N'FSAGENT', N'FT_IFTS_SCHEDULER_IDLE_WAIT', N'FT_IFTSHC_MUTEX', N'HADR_CLUSAPI_CALL', N'HADR_FILESTREAM_IOMGR_IOCOMPLETION', N'HADR_LOGCAPTURE_WAIT', N'HADR_NOTIFICATION_DEQUEUE', N'HADR_TIMER_TASK', N'HADR_WORK_QUEUE', N'KSOURCE_WAKEUP', N'LAZYWRITER_SLEEP', N'LOGMGR_QUEUE', N'ONDEMAND_TASK_QUEUE', N'PWAIT_ALL_COMPONENTS_INITIALIZED', N'QDS_PERSIST_TASK_MAIN_LOOP_SLEEP', N'QDS_CLEANUP_STALE_QUERIES_TASK_MAIN_LOOP_SLEEP', N'REQUEST_FOR_DEADLOCK_SEARCH', N'RESOURCE_QUEUE', N'SERVER_IDLE_CHECK', N'SLEEP_BPOOL_FLUSH', N'SLEEP_DBSTARTUP', N'SLEEP_DCOMSTARTUP', N'SLEEP_MASTERDBREADY', N'SLEEP_MASTERMDREADY', N'SLEEP_MASTERUPGRADED', N'SLEEP_MSDBSTARTUP', N'SLEEP_SYSTEMTASK', N'SLEEP_TASK', N'SLEEP_TEMPDBSTARTUP', N'SNI_HTTP_ACCEPT', N'SP_SERVER_DIAGNOSTICS_SLEEP', N'SQLTRACE_BUFFER_FLUSH', N'SQLTRACE_INCREMENTAL_FLUSH_SLEEP', N'SQLTRACE_WAIT_ENTRIES', N'WAIT_FOR_RESULTS', N'WAITFOR', N'WAITFOR_TASKSHUTDOWN', N'WAIT_XTP_HOST_WAIT', N'WAIT_XTP_OFFLINE_CKPT_NEW_LOG', N'WAIT_XTP_CKPT_CLOSE', N'XE_DISPATCHER_JOIN', N'XE_DISPATCHER_WAIT', N'XE_TIMER_EVENT' ) ORDER BY [wait_time_ms] DESC</code> </pre><br>  The greatest delay is observed with <i>WRITELOG</i> . <br><br><pre> <code class="sql hljs">wait_type wait_time waiting_tasks_count percentage <span class="hljs-comment"><span class="hljs-comment">----------------------- ------------ -------------------- ----------- WRITELOG 546.798 60261 96.07 PAGEIOLATCH_EX 13.151 96 2.31 PAGELATCH_EX 5.768 46097 1.01 PAGEIOLATCH_UP 1.243 86 0.21 IO_COMPLETION 1.158 89 0.20 MEMORY_ALLOCATION_EXT 0.480 683353 0.08 LCK_M_SCH_S 0.200 34 0.03 ASYNC_NETWORK_IO 0.115 688 0.02 LCK_M_S 0.082 10 0.01 PAGEIOLATCH_SH 0.052 1 0.00 PAGELATCH_UP 0.037 6 0.00 SOS_SCHEDULER_YIELD 0.030 3598 0.00</span></span></code> </pre><br>  We open the <a href="https://www.sqlskills.com/help/waits/">‚Äúencyclopedia of expectations‚Äù</a> by <i>Paul Randal,</i> and find <a href="https://www.sqlskills.com/help/waits/writelog/"><i>WRITELOG at the</i></a> same time referring to <i>MSDN</i> : <br><br>  <i>Log flush to disk.</i>  <i>It is clearly indicated that it was not a problem. or even make your transactions longer to reduce log flushes.</i>  <i>If you want to use your DMV, you can use your DMV system.</i>  <i>If WRITELOG is longer, you need to shard.</i>  <i>If not, investigate why you're creating so much transaction log.</i> <br><br>  The log management subsystem waits for the log to disk.  As a rule, it means that the disk system cannot ensure timely recording of the entire log volume, but on high-loaded systems this may be caused by general log recording restrictions / This may mean that you should divide the load between several databases, or even make your transactions a little more long to reduce the number of log entries to disk.  To verify that the cause is in the I / O system, use <i>DMV</i> <a href="https://msdn.microsoft.com/uk-ua/library/ms190326.aspx"><i>sys.dm_io_virtual_file_stats</i></a> to examine the I / O latency for the log file and see if it is the same as the <i>WRITELOG</i> delay <i>time</i> .  If the <i>WRITELOG</i> lasts longer, you have received internal <i>contention</i> for writing to disk and must share the workload.  If not, find out why you are creating such a large transaction log. <br><br>  And what do I need to find out now?  Yes, every autotest when doing something writes to the database.  As a solution to the problem with the expectations of <i>WRITELOG</i> , it would be possible to insert data not line by line, but in larger chunks.  But in <i>SQL Server 2014</i> , a new option appeared at the <a href="https://msdn.microsoft.com/en-us/library/dn449490.aspx"><i>Delayed Durability</i></a> database level, i.e., the ability to not flush data to disk immediately when committing a transaction. <br><br>  How is data modified in <i>SQL Server</i> ?  Suppose we are inserting a new line.  <i>SQL Server</i> calls the <i>Storage Engine</i> component, which in turn refers to the <i>Buffer Manager</i> (which works with buffers in memory and disk) and says that I want to change the data. <br><br>  After that, the <i>Buffer Manager</i> refers to the <i>Buffer Pool</i> (cache in memory for all our data, which stores information page by page - 8KB per page) and then modifies the necessary pages in memory.  If these pages do not exist, then it will load them from the disk.  At the moment when the page in memory has changed, <i>SQL Server</i> cannot yet say that the query has been completed.  Otherwise, one of the <i>ACID</i> principles, namely <i>Durability</i> , would be violated, when at the end of the modification it is guaranteed that the data will be written to disk. <br><br>  After modifying the page in memory, the <i>Storage Engine</i> calls the <i>Log Manager</i> , which writes data to the log.  But it does not immediately, but through the <i>Log Buffer</i> , which has a size of 60Kb and is used to optimize performance when working with the log.  Resetting data from the buffer to the log file occurs in a situation when: <br><br><ul><li>  The buffer was filled and the data was saved in the log. </li><li>  The user has executed <i>sys.sp_flush_log</i> . </li><li>  There was a commit transaction and all that was in the <i>Log Buffer</i> was recorded in the log. </li></ul><br>  When the data has been saved in the log, it is confirmed that the data has been modified and the <i>SQL Server</i> weighs the client. <br><br>  According to this logic, you can see that the data does not fall into the data file.  <i>SQL Server</i> uses an asynchronous mechanism to write to data files.  There are two such mechanisms in total: <br><br>  1) <i>Lazy Writer</i> , which runs periodically, checks whether there is enough memory for <i>SQL Server</i> .  If not, pages from memory are pushed out and written to the data file.  And those that have been changed are flushed to disk and discarded from memory. <br><br>  2) <i>Checkpoint</i> , which scans dirty pages about once a minute, drops them to disk and leaves them in memory. <br><br>  Suppose a situation occurs when a bunch of small transactions occur in the system, which, for example, modify the data line by line.  After each change, the data leaves the <i>Log Buffer</i> in the transaction log.  Remember that all changes go to the log synchronously and other transactions have to wait for their turn. <br><br>  I will show by example: <br><br><pre> <code class="1c hljs">USE [master] GO SET NOCOUNT ON IF DB_ID('TT') IS NOT <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> BEGIN ALTER DATABASE TT SET SINGLE_USER WITH ROLLBACK IMMEDIATE DROP DATABASE TT END GO CREATE DATABASE TT GO ALTER DATABASE TT MODIFY FILE (NAME = N'TT', SIZE = <span class="hljs-number"><span class="hljs-number">25</span></span>MB, FILEGROWTH = <span class="hljs-number"><span class="hljs-number">5</span></span>MB) GO ALTER DATABASE TT MODIFY FILE (NAME = N'TT_log', SIZE = <span class="hljs-number"><span class="hljs-number">25</span></span>MB, FILEGROWTH = <span class="hljs-number"><span class="hljs-number">5</span></span>MB) GO USE TT GO CREATE TABLE dbo.tbl ( a INT IDENTITY PRIMARY KEY , b INT , c CHAR(<span class="hljs-number"><span class="hljs-number">2000</span></span>) ) GO IF OBJECT_ID('tempdb.dbo.#temp') IS NOT <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> DROP TABLE <span class="hljs-meta"><span class="hljs-meta">#temp GO SELECT t.[file_id], t.num_of_writes, t.num_of_bytes_written INTO #temp FROM sys.dm_io_virtual_file_stats(DB_ID(), NULL) t DECLARE @WaitTime BIGINT , @WaitTasks BIGINT , @StartTime DATETIME = GETDATE() , @LogRecord BIGINT = ( SELECT COUNT_BIG(*) FROM sys.fn_dblog(NULL, NULL) ) SELECT @WaitTime = wait_time_ms , @WaitTasks = waiting_tasks_count FROM sys.dm_os_wait_stats WHERE [wait_type] = N'WRITELOG' DECLARE @i INT = 1 WHILE @i &lt; 5000 BEGIN INSERT INTO dbo.tbl (b, c) VALUES (@i, 'text') SELECT @i += 1 END SELECT elapsed_seconds = DATEDIFF(MILLISECOND, @StartTime, GETDATE()) * 1. / 1000 , wait_time = (wait_time_ms - @WaitTime) / 1000. , waiting_tasks_count = waiting_tasks_count - @WaitTasks , log_record = ( SELECT COUNT_BIG(*) - @LogRecord FROM sys.fn_dblog(NULL, NULL) ) FROM sys.dm_os_wait_stats WHERE [wait_type] = N'WRITELOG' SELECT [file] = FILE_NAME(o.[file_id]) , num_of_writes = t.num_of_writes - o.num_of_writes , num_of_mb_written = (t.num_of_bytes_written - o.num_of_bytes_written) * 1. / 1024 / 1024 FROM #temp o CROSS APPLY sys.dm_io_virtual_file_stats(DB_ID(), NULL) t WHERE o.[file_id] = t.[file_id]</span></span></code> </pre><br>  The insertion of 5 thousand lines took approximately 42.5 seconds, while the delays when inserting into the log amounted to 42 seconds. <br><br><pre> <code class="sql hljs">elapsed_seconds wait_time waiting_tasks_count log_record <span class="hljs-comment"><span class="hljs-comment">---------------- ---------- -------------------- ----------- 42.54 42.13 5003 18748</span></span></code> </pre><br>  Physically, SQL Server logged 5,000 times and recorded a total of 20Mb. <br><br><pre> <code class="sql hljs">file num_of_writes num_of_mb_written <span class="hljs-comment"><span class="hljs-comment">------- -------------- ------------------ TT 79 8.72 TT_log 5008 19.65</span></span></code> </pre><br>  For such situations, <i>Delayed Durability is</i> needed.  When it is enabled, logging occurs only when the <i>Log Buffer</i> is full.  You can enable <i>Delayed Durability</i> for the entire database: <br><br><pre> <code class="1c hljs">ALTER DATABASE TT SET DELAYED_DURABILITY = FORCED GO</code> </pre><br>  or for individual transactions: <br><br><pre> <code class="1c hljs">ALTER DATABASE TT SET DELAYED_DURABILITY = ALLOWED GO BEGIN TRANSACTION t ... COMMIT TRANSACTION t WITH (DELAYED_DURABILITY = ON)</code> </pre><br>  Turn on at the base level and re-execute the script. <br><br>  The expectations disappeared and the request worked on my machine for 170ms: <br><br><pre> <code class="sql hljs">elapsed_seconds wait_time waiting_tasks_count log_record <span class="hljs-comment"><span class="hljs-comment">---------------- ---------- -------------------- ----------- 0.17 0.00 0 31958</span></span></code> </pre><br>  Due to the fact that writing to the log was less intense: <br><br><pre> <code class="sql hljs">file num_of_writes num_of_mb_written <span class="hljs-comment"><span class="hljs-comment">------- -------------- ------------------ TT 46 9.15 TT_log 275 12.92</span></span></code> </pre><br>  Of course there is a fly in the ointment.  Even before the data physically got into the log file, the client is already being notified that the changes are committed.  In case of failure, we can lose data equal to the size of the buffer and beat the base. <br><br>  In my case, the safety of test data was not required.  For the test base on which the autotests <i>ran, they</i> set <i>DELAYED_DURABILITY</i> in <i>FORCED</i> and the next run of all the tests worked in 2.5 minutes. <br><br><img src="https://habrastorage.org/files/6be/c4f/4cd/6bec4f4cdf2044dab9653166bd203a7f.png"><br><br>  And while all the delays associated with writing to the log began to have a minimal impact on performance: <br><br><pre> <code class="sql hljs">wait_type wait_time waiting_tasks_count percentage <span class="hljs-comment"><span class="hljs-comment">-------------------- ----------- -------------------- ----------- PAGEIOLATCH_EX 16.031 61 43.27 WRITELOG 15.454 787 41.72 PAGEIOLATCH_UP 2.210 36 5.96 PAGEIOLATCH_SH 1.472 2 3.97 LCK_M_SCH_M 0.756 9 2.04 ASYNC_NETWORK_IO 0.464 735 1.25 PAGELATCH_UP 0.314 8 0.84 SOS_SCHEDULER_YIELD 0.154 2759 0.41 PAGELATCH_EX 0.154 44785 0.41 LCK_M_SCH_S 0.021 7 0.05 PAGELATCH_SH 0.011 378 0.02</span></span></code> </pre><br>  Let's summarize some results on <i>Delayed Durability</i> : <br><br><ul><li>  Available in all editions since <i>SQL Server 2014</i> . </li><li>  It can be used if you have a bottleneck when writing to the transaction log (delayed writing in large blocks can be more efficient than many small ones). </li><li>  Simultaneously, the executed transactions are less likely to compete for <i>IO</i> operations when writing to the transaction log. </li><li>  When enabled, the <i>COMMIT</i> operation does not wait for a record in the transaction log and we can get a significant performance boost in <i>OLTP</i> systems. </li><li>  You can safely turn on <i>Delayed Durability</i> , if you are willing to play Russian Roulette and, under ‚Äúsuccessful‚Äù circumstances, lose approximately 60Kb of data in the event of a failure. </li></ul><br><div class="spoiler">  <b class="spoiler_title">UPDATE 2016-07-12: The data deletion script made more functional</b> <div class="spoiler_text"><pre> <code class="1c hljs">DECLARE @SQL NVARCHAR(MAX) , @FK_TurnOff NVARCHAR(MAX) , @FK_TurnOn NVARCHAR(MAX) SELECT @SQL = ( SELECT CHAR(<span class="hljs-number"><span class="hljs-number">13</span></span>) + CHAR(<span class="hljs-number"><span class="hljs-number">10</span></span>) + IIF(p.[rows] &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>, IIF(t2.referenced_object_id IS <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, N'TRUNCATE TABLE ', N'DELETE FROM ') + obj_name, '' ) + CHAR(<span class="hljs-number"><span class="hljs-number">13</span></span>) + CHAR(<span class="hljs-number"><span class="hljs-number">10</span></span>) + IIF(IdentityProperty(t.[object_id], 'LastValue') &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>, N'DBCC CHECKIDENT('''+ obj_name + N''', RESEED, 0) WITH NO_INFOMSGS', '' ) FROM ( SELECT obj_name = QUOTENAME(s.name) + '.' + QUOTENAME(o.name), o.[object_id] FROM sys.objects o JOIN sys.schemas s ON o.[schema_id] = s.[schema_id] WHERE o.is_ms_shipped = <span class="hljs-number"><span class="hljs-number">0</span></span> AND o.[type] = 'U' AND o.name != N'__MigrationHistory' ) t JOIN sys.partitions p ON t.[object_id] = p.[object_id] AND p.index_id IN (<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>) LEFT JOIN ( SELECT DISTINCT f.referenced_object_id FROM sys.foreign_keys f ) t2 ON t2.referenced_object_id = t.[object_id] FOR XML PATH(''), TYPE).value('.', 'NVARCHAR(MAX)') SELECT @FK_TurnOff = CAST(x.query('off/text()') AS NVARCHAR(MAX)) , @FK_TurnOn = CAST(x.query('on/text()') AS NVARCHAR(MAX)) FROM ( SELECT [off] = CHAR(<span class="hljs-number"><span class="hljs-number">10</span></span>) + 'ALTER TABLE ' + obj + ' NOCHECK CONSTRAINT ' + fk , [on] = CHAR(<span class="hljs-number"><span class="hljs-number">10</span></span>) + 'ALTER TABLE ' + obj + ' CHECK CONSTRAINT ' + fk FROM ( SELECT fk = QUOTENAME(f.name) , obj = QUOTENAME(SCHEMA_NAME(f.[schema_id])) + '.' + QUOTENAME(OBJECT_NAME(f.parent_object_id)) FROM sys.foreign_keys f WHERE f.delete_referential_action = <span class="hljs-number"><span class="hljs-number">0</span></span> AND EXISTS( SELECT * FROM sys.partitions p WHERE p.[object_id] = f.parent_object_id AND p.[rows] &gt; <span class="hljs-number"><span class="hljs-number">0</span></span> AND p.index_id IN (<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>) ) ) t FOR XML PATH(''), TYPE ) t(x) IF @SQL LIKE '%[az]%' BEGIN SET @SQL = ISNULL(@FK_TurnOff, '') + @SQL + ISNULL(@FK_TurnOn, '') PRINT @SQL --EXEC sys.sp_executesql @SQL END</code> </pre><br></div></div><br>  If you want to share this article with an English-speaking audience: <br>  <a href="http://blog.sqlauthority.com/2016/07/20/sql-server-delayed-durability-story-speed-autotests-11-2-5-minutes/"><i>Speed ‚Äã‚ÄãUp Autotests From 11 to 2.5 Minutes</i></a> </div><p>Source: <a href="https://habr.com/ru/post/303156/">https://habr.com/ru/post/303156/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../303140/index.html">Matrix procrastination (postponing cases "for later")</a></li>
<li><a href="../303142/index.html">OpenGL ES 2.0. One million particles</a></li>
<li><a href="../303144/index.html">CD Changer Control Protocol</a></li>
<li><a href="../303146/index.html">NetApp SDS: ONTAP Select</a></li>
<li><a href="../303150/index.html">We automate the purchase of railway tickets Ukrzal—ñznits—ñ</a></li>
<li><a href="../303158/index.html">The digest of interesting materials for the mobile # 157 developer (June 6-13)</a></li>
<li><a href="../303160/index.html">10 rules that allow NASA to write millions of lines of code with minimal errors</a></li>
<li><a href="../303162/index.html">On the implementation of persistent processes in real-time control systems (part 1)</a></li>
<li><a href="../303164/index.html">Renewal of the old code or how to do well to an application that is bad</a></li>
<li><a href="../303166/index.html">Debriefing or how to clean up the state</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>