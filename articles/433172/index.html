<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Screwing multiplayer to the mobile game "Make a word from a word" on iOS and Android, written in C ++</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Earlier, I already wrote about my experience in developing a mobile word game on Android and iOS, which enjoys a certain popularity, and I decided to ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Screwing multiplayer to the mobile game "Make a word from a word" on iOS and Android, written in C ++</h1><div class="post__text post__text-html js-mediator-article">  Earlier, I already wrote about my experience in developing a mobile <a href="https://habr.com/post/309800/">word game</a> on Android and iOS, which enjoys a certain popularity, and I decided to tie the multiplayer mode to it, when two players compete with each other, making up words one by one as the final round of the TV show Sergei Suponev Star. hour". <br><br><img src="https://habrastorage.org/webt/kk/v7/fw/kkv7fwu9wif6l37aoqmyzcp3gjm.png"><br><br>  It took me a month and a half to study and implement multiplayer, in the article I will try to describe the concept without source code examples, making a squeeze from the amount of work done. <br><a name="habracut"></a><br><h3>  A bit of history </h3><br>  The application was written in C ++ using the Marmalade SDK.  Since then, the vendor has stopped supporting this platform, selling sorts to the Japanese, and the future of this development environment has become very vague. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/webt/sa/c4/fy/sac4fyzpnydiynvhugn1fl8olww.jpeg"><br><br>  The question arose of what to port the current projects for their further support. <br><br><h3>  Why not cocos2d-x </h3><br><img src="https://habrastorage.org/webt/il/dh/fn/ildhfnxa9jhrtc31jiw-sf5b6zm.png"><br><br>  <a href="http://www.cocos2d-x.org/">Cocos2d-x</a> is one of the most common engines for developing cross-platform mobile games in C ++.  Apparently, due to its free and open source.  The engine is poorly documented.  The description covers a scanty part of the engine and most of the material is long outdated. <br><br>  According to the results of a certain period, I still managed to create a prototype of my application.  But the impressions were very bad: the feeling that cocos2d-x is assembled on the knee.  The levels of abstraction Scene, Sprite, Application Delegate seemed to me very inconvenient, and the need to look for answers to questions on the coconut forum more often lead you to think that you are doing something wrong.  Probably my hands are not growing from that place. <br><br><h3>  My choice fell on SDL </h3><br><img src="https://habrastorage.org/webt/4q/a4/vf/4qa4vfo-qzvtxas0a6egqpqknjk.png"><br><br>  <a href="https://www.libsdl.org/">SDL</a> , as well as Marmalade SDL, is not an engine, it is a platform.  It provides a low-level API, from which I then build convenient levels of abstraction for me.  All this is written in C, the source code is open. <br><br>  In a nutshell, SDL is a free cross-platform library for working with graphics, sound, and processing messages from the operating system.  It is very convenient to do a win32 build and debug the game logic on Windows, leaving only OS debugging for mobile emulators and physical devices. <br><br>  Fortunately or unfortunately, the SDL does not provide tools for such a narrow task as developing multiplayer for iOS and Android, so I had to integrate with the corresponding services myself. <br><br><h3>  Multithreaded application architecture </h3><br>  The application logic and all the work with graphics is implemented in the main thread, which is the message processing cycle and starts in the main function.  Let's call this thread SDL Thread.  In turn, other threads throw events (SDL_PushEvent) to it for processing into a queue, and that one reads them from it using SDL_WaitEvent and SDL_PollEvent.  These are either system events thrown by the system and whose support is already implemented in the SDL, or calls to Callbacks and Listeners that we implement above SDL functionality. <br><br><img src="https://habrastorage.org/webt/cr/li/-r/crli-rojztdxy1p7fhqhiqa0jru.png"><br><br>  The whole logic of the game is written in C ++.  The project directory contains a set of * .cpp files that can be divided into three groups: <br><br><ul><li>  cross-platform - those files that are included in the assembly of all platforms (the logic of the game); </li><li>  monoplatform, i.e.  included in the application of a single platform for the implementation of its features. </li></ul><br>  Accordingly, there are three separate directories for the project of each platform: <br><br><ul><li>  proj.win32 - project VS2017 Community Edition; </li><li>  proj.android - Android project using Gradle; </li><li>  proj.ios - Xcode project for iOS. </li></ul><br><h3>  Integration with multiplayer services </h3><br>  Now we need to paste a separate layer, which will be responsible for such functionality as: <br><br><ul><li>  search for an opponent, connect to the game; </li><li>  messaging between rivals; </li><li>  exit from the game room; </li><li>  fixing player points in Leaderboards. </li></ul><br>  Both iOS and Android platforms support Real-time Multiplayer (RTMP).  In the case of Android, we integrate with Google Play Services (GPS), in the case of iOS - Game Center.  Previously, Google supported and integration with iOS, but this year decided to abandon it. <br><br>  In this article I will not describe the actions that need to be performed in the Google Play Console and AppStoreConnect to configure multiplayer, I will not describe the specification of classes and integration methods - all this is described on vendor sites. <br><br>  Next, I briefly describe what changes need to be made in the project for each of the platforms. <br><br><h4>  Android </h4><br>  How?  I have not said this yet?  To compile C ++ code, <a href="https://developer.android.com/ndk/">Android NDK is used</a> .  Although, if you are an Android developer, then you already know. <br><br>  <a href="https://developers.google.com/android/guides/setup">General instructions</a> for integrating Google Play Services into an Android project are described on the website for Android developers.  In my project I use the following dependencies: <br><br><pre><code class="json hljs">implementation 'com.google.android.gms:play-services-games:<span class="hljs-number"><span class="hljs-number">16.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>' implementation 'com.google.android.gms:play-services-nearby:<span class="hljs-number"><span class="hljs-number">16.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>' implementation 'com.google.android.gms:play-services-auth:<span class="hljs-number"><span class="hljs-number">16.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>'</code> </pre> <br>  Initially, the idea was to use <a href="https://developers.google.com/games/services/downloads/sdks">C ++ api</a> , which comes in the form of compiled static libraries without source codes.  Due to the fact that there is no build for the x86_64 platform in the list of libraries, I decided that the guys from Google didn‚Äôt really follow the relevance of this SDK and decided to <s>invent my bike</s> to write this layer in Java, wrapping it with <a href="https://ru.wikipedia.org/wiki/Java_Native_Interface">JNI</a> wrappers.  And then, why do I need an extra dependency in the form of a lib without source code, which is still jerking Java inside itself?  In addition to the relevance of Java classes, it will also be necessary to monitor the relevance of these libs. <br><br>  As a guide used a good example from <a href="">Google Samples</a> .  Thank you google for this.  Apple, take a cue from Google! <br><br><h4>  iOS </h4><br>  To integrate with the Game Center you need to connect the GameKit framework.  We describe the entire layer of integration with the Game Center in one * .m-file and provide the interface to it through a separate * .h file.  Since C ++ is a subset of the language objective-C, then with the assembly of * .cpp and * .m files in one project there will be no problems. <br><br>  In addition to the <a href="https://developer.apple.com/library/archive/documentation/NetworkingInternet/Conceptual/GameKit_Guide/Matchmaking/Matchmaking.html">official documentation, I</a> guided this project: <a href="https://github.com/nihalahmed/GameCenterManager">GameCenterManager</a> .  True, some things from the example are already outdated, XCode 10 will indicate this to you and you will replace the outdated functionality with a new one. <br><br><h3>  The principle of working with a multiplayer layer </h3><br><h4>  Single entry point </h4><br>  Having studied the features of working with multiplayer on both platforms, I created a single C ++ asbestos for my application and, at the time of compilation, the corresponding implementation is ‚Äúattached‚Äù to it depending on the specific platform.  That is, my application does not know about any Google Play Services, Game Center and their features.  It knows only the C ++ api provided to it, where, for example, there are such methods as: <br><br><pre> <code class="cpp hljs">SignIn() <span class="hljs-comment"><span class="hljs-comment">//     SignOut() //     LeaveRoom() //    SendMessage(...) //    ShowLeaderboards() //    SubmitScore(...) //    ...</span></span></code> </pre><br><h4>  Search for an opponent </h4><br>  A player can invite a friend from his list of contacts, or start a game with a random opponent.  The player who received the invitation can accept it, or reject it.  For all these scenarios, I use the standard interface of the service used.  It should be noted that google muzzles look much nicer than iOS-ovsky.  Maybe someday my hands will get there and I will write my interface with dominoes and young ladies. <br><br><h4>  Connect to the game room </h4><br>  When two players have connected to the virtual gaming room, they receive the appropriate callback.  Now you need to choose who will be the host. <br><br><h4>  Host selection </h4><br>  Among the players, you need to select a host so that it determines the initial state of the game. <br>  Consider possible ways to route messages between players in the general case.  Please note that in the second version the host also has the role of the router. <br><br><img src="https://habrastorage.org/webt/zl/u8/qu/zlu8qufestbs25fic3j8ajfn2w8.png"><br><br>  Since I always have only two players in the game, it turns out that I have a special case of peer-to-peer connections.  And therefore, only the definition of the initial state drops to the role of the host, namely, the choice of the word from which the words will be composed. <br><br>  So, after the players connected to the game room, each of the players knows the list of identifiers of the participants in the game that has begun.  We will call it a list of <b>participantID</b> .  A participantID is a kind of unique string identifier for a participant in a game, which is assigned by the service.  It is necessary to choose which of them will be the host, bring it to the host itself and inform the other that its opponent is selected as the host.  How to do it? <br><br><h5>  Choosing a host on Android </h5><br>  In the Google dock, I did not find tips on choosing a host.  Silent, partisans.  But kind people at <a href="https://stackoverflow.com/questions/46731122/how-to-define-a-host-in-google-play-games-real-time-multiplayer">stackoverflow.com</a> threw a link to the <a href="https://www.youtube.com/watch%3Fv%3DyIY1zsZ2yCU">video</a> , which explains in detail the following principle: <br><br><ul><li>  each participant sorts the participantID list (ascending or descending - it does not matter, as long as everything is done in the same order); </li><li>  each participant compares his participantID with the first participantID from the list; </li><li>  if they match, then the current player is given the right to choose who will be the host.  He <s>throws a coin</s> jerks random (), thereby selecting a host from existing members, and informs everyone who is a host. </li></ul><br><h5>  IOS Host Selection </h5><br>  For iOS, there is a method <a href="https://developer.apple.com/documentation/gamekit/gkmatch/1502044-choosebesthostplayerwithcompleti">selectBestHostPlayerWithCompletionHandler</a> , which greatly simplifies the scenario of choosing a host compared to what I described for Android.  But, judging by the noticeable delays during the call of this method, it evaluates the parameters of the network response, measures the ping and, on the basis of these statistics, decides who will be the host.  It is more suitable for the above client-server architecture, where the host serves as a router.  In my own variant of a private peer-to-peer connection, this does not make sense, and in order to save time, I use a principle similar to what I did for Android. <br><br><h4>  Messaging between players </h4><br>  What is a message?  The message is an array of bytes. <br><br><ul><li>  In java, this is the type: <pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[]</code> </pre> </li><li>  in objective-C it is: <pre> <code class="objectivec hljs"><span class="hljs-built_in"><span class="hljs-built_in">NSData</span></span> *</code> </pre> </li><li>  in C ++, I drop everything above <pre> <code class="cpp hljs"><span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">vector</span></span>&lt;Uint8&gt;</code> </pre> </li></ul><br>  There are 2 types of sending messages: <br><br><ul><li>  Reliable - guaranteed delivery through the queue.  Used to deliver critical messages. </li><li>  Unreliable - unwarranted delivery.  Used messages, the delivery of which can be neglected. </li></ul><br>  Unreliable is usually delivered faster than Reliable.  More information can be found on the vendors website: <br><br><ul><li>  <a href="https://developers.google.com/games/services/common/concepts/realtimeMultiplayer">Google Play Services: Real-time Multiplayer</a> </li><li>  <a href="https://developer.apple.com/library/archive/documentation/NetworkingInternet/Conceptual/GameKit_Guide/Matchmaking/Matchmaking.html">Game Center Programming Guide: Real-Time Matches</a> </li></ul><br>  How will we use this array?  Very simple: <br><br><ul><li>  in the first byte we will write the message type. </li><li>  if the message has any parameters, we will put them in the next bytes.  For each type of message that has an additional.  parameters, we implement our function of serialization and deserialization. </li><li>  We‚Äôll put a checksum at the end of the message to check the integrity. </li></ul><br>  So, we define the <b>enum</b> with the types of messages that players will exchange with each other during the game: <br><br><ul><li>  I am selected as a host.  I pass the initial state.  Now my turn (parameters: the version number of the messaging protocol, the original word); </li><li>  You are the selected host.  I am waiting for you to start; </li><li>  I open (call) a word.  Now it's your turn (parameter: named word); </li><li>  I give up.  You won; </li><li>  I could not make a word during the course.  You won; </li><li>  I agree to a rematch; </li><li>  I am leaving the game; </li><li>  Error parsing message.  Disconnect; </li><li>  Your version of the messaging protocol is outdated.  Check the application update.  Disconnect; </li><li>  My version of the messaging protocol is outdated.  Need to check the update.  Disconnect; </li><li>  Ping (system message); </li></ul><br>  When an application receives an incoming message from an opponent, the corresponding Callback is called, which in turn sends it to the main SDL Thread for processing. <br><br><h4>  Connection monitoring </h4><br>  Gaming services (like Google‚Äôs, Apple‚Äôs) have listener functions that, in one form or another, are designed to alert us to breaking the connection with an opponent.  But, I noticed that if one of the players is disconnected from the Internet, the second one does not immediately recognize that the first one has disconnected and there is no one to play with.  Callbacks are not called in such cases, or they are called after a rather long time.  So that in this case the second player would not have to wait for the cancer on the mountain to whistle, I had to do my own monitoring of the compound, working on the principle: <br><br><ul><li>  Each player sends a ping message to the opponent every second; </li><li>  Each player checks: if there was no message from the opponent for more than 5 seconds, then the connection is lost, we exit the game. </li></ul><br><h3>  Result </h3><br>  As a result of the work done, I got a game that I play with my friends and family.  I play both on iOS, and on Android. <br><br>  True, there is a nuance on iOS - for some reason, points in Leaderboards are not fixed, which I am currently in correspondence with Apple support. <br><br>  I hope this article will be useful as the members of my team, and those who are interested in developing mobile applications.  Thanks for attention. </div><p>Source: <a href="https://habr.com/ru/post/433172/">https://habr.com/ru/post/433172/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../433158/index.html">Musical parodies from SUSE about Kubernetes, Linus Torvalds and others</a></li>
<li><a href="../433164/index.html">Fast & Furious: Forza Horizon 4 acceleration due to window shaders</a></li>
<li><a href="../433166/index.html">Predicting the time to solve a ticket using machine learning</a></li>
<li><a href="../433168/index.html">Why does a programmer have an internship in the kitchen - a conversation with ‚ÄúDodo Pizza‚Äù about gembu, .NET and openness</a></li>
<li><a href="../433170/index.html">How did we fail to remake the architecture of the company</a></li>
<li><a href="../433176/index.html">Docker Remote API with certificate authentication with revocation checking</a></li>
<li><a href="../433178/index.html">How we recovered a corrupted .wav file</a></li>
<li><a href="../433180/index.html">Solving data type problems in Ruby or Make data reliable again</a></li>
<li><a href="../433182/index.html">Is it possible to train with reinforcements agent for trading in the stock market? R language implementation</a></li>
<li><a href="../433184/index.html">ASP.NET Core 2.2 has been released. What's new? (2 of 3)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>