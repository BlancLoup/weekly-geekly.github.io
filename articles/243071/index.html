<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Mikrotik automatically switch to the backup channel for a dynamic ip address (issued by DHCP)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Greetings, Habr! Due to the poor quality of the line, I was asked to configure automatic switching to the backup channel. For this purpose, provided t...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Mikrotik automatically switch to the backup channel for a dynamic ip address (issued by DHCP)</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/cb4/09e/ce6/cb409ece60254bdabc8dbbaf226aa2e2.jpg" width="190" height="160" align="right"><br><br>  Greetings, Habr!  Due to the poor quality of the line, I was asked to configure automatic switching to the backup channel.  For this purpose, provided the router MikroTik RB 951Ui. <br><br>  I thought that there would be no problems ... Just set up checking the channel and routes.  But, unfortunately, both providers give out IP dynamically.  At first I tried to substitute the interface name into the route, but the ping did not pass.  After reading several articles, including foreign sites, but did not find a solution to the problem that would suit me.  I had to get acquainted with RouterOS closer, and in particular with the creation of scripts ... 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <a name="habracut"></a><br>  In this OS, you can create a route in two ways: <br><ul><li>  <i>manually</i> (via the graphic interface or via the terminal); </li><li>  <i>automatically by the</i> DHCP client. </li></ul><br>  When creating a route manually, it will not be possible to update the gateway dynamically.  To do this, you have to write some fairly large scripts and add a lot of checks.  When writing them, I noticed that in RouterOS it is problematic to make complex scripts work.  It is very difficult to track the logic of work, although logs and variables were used for verification.  The scripts were written, but they were unstable, despite the optimization of the code and the addition of checks.  When the number of checks began to grow exponentially and the repeated optimization of the logical scheme slightly improved the situation - I decided to abandon this option and try to use the script option in the script to automatically create a route by the DHCP client. <br><br><pre><code class="bash hljs">/ip dhcp-client <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> [/ip dhcp-client find interface=<span class="hljs-variable"><span class="hljs-variable">$Iface</span></span>] add-default-route=yes [no]</code> </pre> <br>  <i>The option to automatically create a default route is set for the desired interface in the settings of the DHCP client.</i> <br><br>  So, the script will work according to this algorithm: <br><br><div style="text-align:center;"> <a href="http://http:"><img src="https://habrastorage.org/files/b54/f07/2d1/b54f072d16c442d8b2ada1d4cac36b3b.png"></a> </div><br><br><h3>  Algorithm explanation </h3><br><br>  A copy of the script will be launched for each interface.  Each copy will autonomously create a default route.  The priority of the route will depend on the distance.  That is, when the connection ‚Äúfalls‚Äù on the route from Distance 10, the switching to 11. will occur. Due to this, the switching is seamless. <br><br>  To start, the script pings the selected host on the Internet along the default route.  If the ping is less than ($ PingCount- $ Margin) (Margin - sets the error for accuracy control), then we ping the test route to check whether the connection is ‚Äúlive‚Äù.  In case of a negative result, check the route and the presence of problems with the settings: <br><br><ul><li>  we overload the interface every $ TimeToWait times (reducing the load on the processor); </li><li>  waiting for the interface to load; </li><li>  check if there are DHCP client settings for this interface, otherwise we create; </li><li>  check the DHCP status of the client (sometimes RouterOS can ‚Äúslip the pig‚Äù); </li><li>  waiting for receiving DHCP lease; </li><li>  add the required interface to the $ CurrentGateway value; </li><li>  check if there is a test route; </li><li>  check if the gateway is correct in the test route. </li></ul><br><br>  <b>The reaction rate</b> to the state of the compound can be individually adjusted using the following variables: <br><br><ul><li>  <i>PingCount</i> - the number of requests sent by icmp (you can also add another variable to determine the number of sent requests via the test route and to the provider's gateway, that is, the number of requests will decrease and the script speed will increase accordingly); </li><li>  <i>Margin</i> - the coefficient is needed to set the error.  For example, when $ Margin = 1, the route check cycle is started only when more than one packet disappears, which is important in my situation; </li><li>  <i>TimeToWait</i> while waiting for a connection, the interface is overloaded every $ TimeToWait times (this is necessary in order to relieve the load on the processor) </li></ul><br><br><h3>  Preparatory setting </h3><br>  I will not describe the default settings of the router for two reasons: firstly, this topic has been raised on the Internet more than once, including Habr√©, and secondly, the networks are distinguished by their configuration.  Since the work of the script affects only the default routes and DHCP client settings, I think you will have no difficulty in adapting the script to your network. <br><br>  For the script does not need to create routes by default - it will create them automatically.  The only thing you need to choose the appropriate distance for test routes (you can both with $ Distance = 1) and $ DistanceDefault 10 and 11 for default routes (one for each provider).  Also, do not need to create dhcp clients. <br><br>  When configuring the router, I used SSH and Winbox (a specialized program for configuring devices managed by RouterOS, even works in * nix using Wine). <br><br>  Let's get started <br><br>  In Interfaces, we change the names of two interfaces to match the value of the $ Iface variable in the script (I have isp1, isp2): <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/8da/651/c76/8da651c76e504f05845e1153846bc9d1.png"></div><br><br>  Change DNS addresses to google-cue: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/1b3/d9f/85b/1b3d9f85b75e46e5872170b18c13f880.png"></div><br><br>  Create a script: System ‚Üí Scripts ‚Üí Add and paste the code below: <br><br><img src="https://habrastorage.org/files/e79/73e/712/e7973e712c1344c4b463b50cae6e00f4.png"><br><br><div class="spoiler">  <b class="spoiler_title">Script code</b> <div class="spoiler_text"><pre> <code class="bash hljs">:delay 10s :<span class="hljs-built_in"><span class="hljs-built_in">local</span></span> Iface <span class="hljs-string"><span class="hljs-string">"isp1"</span></span> :<span class="hljs-built_in"><span class="hljs-built_in">local</span></span> StatusIface :<span class="hljs-built_in"><span class="hljs-built_in">local</span></span> CurrentGateway :<span class="hljs-built_in"><span class="hljs-built_in">local</span></span> pingInet :<span class="hljs-built_in"><span class="hljs-built_in">local</span></span> pingLink :<span class="hljs-built_in"><span class="hljs-built_in">local</span></span> pingGateway :<span class="hljs-built_in"><span class="hljs-built_in">local</span></span> IPToPingInet <span class="hljs-string"><span class="hljs-string">"213.180.193.3"</span></span> :<span class="hljs-built_in"><span class="hljs-built_in">local</span></span> IPToPing <span class="hljs-string"><span class="hljs-string">"8.8.4.4"</span></span> :<span class="hljs-built_in"><span class="hljs-built_in">local</span></span> PingCount 5 :<span class="hljs-built_in"><span class="hljs-built_in">local</span></span> Margin 1 :<span class="hljs-built_in"><span class="hljs-built_in">local</span></span> Distance 1 :<span class="hljs-built_in"><span class="hljs-built_in">local</span></span> DistanceDefault 10 :<span class="hljs-built_in"><span class="hljs-built_in">local</span></span> RunTime 0 :<span class="hljs-built_in"><span class="hljs-built_in">local</span></span> TimeToWait 20 <span class="hljs-comment"><span class="hljs-comment">#  while (true) do={ #    :set pingInet [/ping $IPToPingInet count=$PingCount interface=$Iface] :log debug "$pingInet $Iface $IPToPingInet" :if ($pingInet &lt; ($PingCount-$Margin)) do={ :log error "No internet connection on $Iface." /ip dhcp-client set [/ip dhcp-client find interface=$Iface] add-default-route=no #   :while ($pingInet &lt; ($PingCount-$Margin)) do={ #     :set pingLink [/ping $IPToPing count=$PingCount interface=$Iface] :log debug "$pingLink $Iface $IPToPing" :if ($pingLink &lt; ($PingCount-$Margin)) do={ #   /interface ethernet disable $Iface; /interface ethernet enable $Iface :while ($pingLink &lt; ($PingCount-$Margin)) do={ :log debug "$pingLink $Iface $IPToPing" :set RunTime ($RunTime + 1) :log debug $RunTime # Time to wait :if ( $RunTime = $TimeToWait ) do={ # Reboot interface :log info "reboot and release $Iface" /interface ethernet disable $Iface; /interface ethernet enable $Iface :set RunTime 0 } #    :if ([/interface ethernet get $Iface disabled] = false) do={ :log debug "Interface $Iface enabled" #   /interface ethernet monitor $Iface once do={ :set StatusIface $status } :if ($StatusIface = "link-ok") do={ :log debug "$Iface link-ok." #  dhcp :if ([/ip dhcp-client find interface=$Iface] != "") do={ :log debug "test1" #     DHCP :if ( [/ip dhcp-client get [/ip dhcp-client find interface=$Iface] invalid ] != true) do={ :log debug "test2" #   DHCP lease :set CurrentGateway [/ip dhcp-client get [/ip dhcp-client find interface=$Iface] gateway ] :log debug "Waiting DHCP lease" :if ($CurrentGateway != nil) do={ :set CurrentGateway [:put ("$CurrentGateway" . "%$Iface")] :log debug "CurrentGateway $CurrentGateway" # Looking for route test :log debug "Cheking test route for $Iface..." :local a [ /ip route find comment="$Iface" ] :if (($a) = "") do={ :log info ("Adding test route for $Iface...") /ip route add dst-address=$IPToPing gateway=$CurrentGateway comment="$Iface" distance=$Distance } else={ :local EstablishedGateway [/ip route get [/ip route find comment="$Iface"] gateway ] :log debug "EstablishedGateway $EstablishedGateway" :if ( $CurrentGateway = $EstablishedGateway ) do={ :log debug "No route changes needed for $Iface." } else={ :log info "Updating test route for $Iface..." /ip route set [/ip route find comment="$Iface" ] dst-address=$IPToPing gateway=$CurrentGateway comment="$Iface" distance=$Distance } } :set pingGateway [/ping [/ip dhcp-client get [/ip dhcp-client find interface=$Iface] gateway ] count=$PingCount interface=$Iface] :log debug "$pingGateway $Iface $IPToPing" :if ($pingGateway &lt; ($PingCount-$Margin)) do={ :log error "route error on $Iface" :log debug [/ip dhcp-client get [/ip dhcp-client find interface=$Iface] gateway ] /ip dhcp-client release [/ip dhcp-client find interface=$Iface] } } else={ :log error "DHCP no lease." :delay 1s } } else={ :log error "DHCP failure on $Iface." :log info "reboot and release $Iface" /interface ethernet disable $Iface; /interface ethernet enable $Iface :delay 1s } } else={ :log info "adding DHCP client for $Iface" /ip dhcp-client add interface=$Iface disabled=no add-default-route=yes default-route-distance=$DistanceDefault use-peer-dns=no use-peer-ntp=no } } else={ :log debug "No-link on $Iface." :delay 1s } } else={ :log error "Interface $Iface disabled." } :set pingLink [/ping $IPToPing count=$PingCount interface=$Iface] } } else={ :log info "add default route= yes for $Iface" /ip dhcp-client set [/ip dhcp-client find interface=$Iface] add-default-route=yes } :set pingInet [/ping $IPToPingInet count=$PingCount interface=$Iface] } } else={ :log debug "Internet on $Iface connected." } }</span></span></code> </pre><br></div></div><br><br>  Repeat the previous step for the second interface, only changing the value of the $ Iface variable to ‚Äúisp2‚Äù, also changing the $ DistanceDefault to the above values ‚Äã‚Äã(for me isp1 - 10, and for isp2 - 11). <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/3da/c0e/0cf/3dac0e0cfbd0480d8be67c65f7c031cc.png"></div><br><br>  Now you need to configure the scheduler to automatically run scripts when loading the router. <br>  System ‚Üí Scheduler-&gt; <br><br><img src="https://habrastorage.org/files/061/913/f12/061913f1219043b1995d63da26379984.png"><br><br>  This can also be done using ssh or from the console if you have problems with the Cyrillic alphabet in the date: <br><br><pre> <code class="bash hljs">/system scheduler add name=CheckTestRoute1 start-time=startup on-event=CheckTestRoute1</code> </pre><br>  We are overloading ... <br>  I thought that there would be problems with NAT when switching routes, but for now <br>  normal flight.  If you have to write ... <br><br>  That's all.  I hope that this article will be useful for someone. <br><br>  <b>PS:</b> Finally, RouterOS threw another puzzle ... <br><br><img src="https://habrastorage.org/files/3f9/ab0/80e/3f9ab080e002432299ce05023278b7e0.png"><br><br>  As you can see, despite the fact that the route is specified correctly, the ping does not pass. <br><br>  To fix this, added another check (it has already been added above in the script code). </div><p>Source: <a href="https://habr.com/ru/post/243071/">https://habr.com/ru/post/243071/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../243059/index.html">Another script for generating icons for Android</a></li>
<li><a href="../243063/index.html">We make our own indication of an incoming call</a></li>
<li><a href="../243065/index.html">.NET Framework is coming to Open Source and on * nix</a></li>
<li><a href="../243067/index.html">.NET Server Core, cross-platform development, Visual Studio 2015 and other announcements of Microsoft Connect ()</a></li>
<li><a href="../243069/index.html">Restarting LitTime or a small story of 2 years of startup slip</a></li>
<li><a href="../243075/index.html">What could be simpler buttons?</a></li>
<li><a href="../243077/index.html">Personalization of mailings using the column ‚Äúname‚Äù in fillable forms: pros and cons</a></li>
<li><a href="../243079/index.html">Bring the user to the ... end of the funnel</a></li>
<li><a href="../243081/index.html">‚ÄúWrite your game!‚Äù - KolibriOS New Year Contest</a></li>
<li><a href="../243083/index.html">PENTESTIT. Practical Information Security: The Results of 2014, Part I</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>