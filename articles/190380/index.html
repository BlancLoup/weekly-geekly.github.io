<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Singleton serialization or rock garden</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the development process, I wanted to serialize a singleton, but with the preservation and restoration of the values ‚Äã‚Äãof its fields. At first glanc...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Singleton serialization or rock garden</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage2/989/646/257/98964625779826612d8d33af89fe1d70.png" alt="image"><br><br>  In the development process, I wanted to serialize a singleton, but with the preservation and restoration of the values ‚Äã‚Äãof its fields.  At first glance, the uncomplicated process turned into a fascinating journey into a rock and cobblestone garden: from receiving two singletones to the lack of field serialization. <br><a name="habracut"></a><br><h5>  But why make a <s>garden</s> garden? </h5><br>  The first logical question is: if so problems, then why is it even needed?  Such cunning, indeed, is not often required.  Although many people are just starting out with WPF or WinForms, they are trying to implement the application settings file this way.  Please do not waste your time and do not reinvent the wheel: there is an Application and User Settings (you can read about it <a href="http://msdn.microsoft.com/en-us/library/k4s6c3a0.aspx">here</a> and <a href="http://www.codeproject.com/Articles/25829/User-Settings-Applied">here</a> ).  Here are examples when serialization may be required: <br>  I want to send a singleton over the network or between the AppDomain.  For example, the client and the server simultaneously work with the same ftp and synchronize their information about it.  Information about ftp can be stored in singleton (and attach methods for working with it in the same place). <br>  The class that is assigned to different elements is serialized, but the value must be the same for all.  An example of such a class is <a href="http://msdn.microsoft.com/en-us/library/system.dbnull.aspx">DBNull</a> . <br><h5>  Singleton </h5><br>  As a simple example, take the following singleton: <br><pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sealed</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Settings</span></span> : <span class="hljs-title"><span class="hljs-title">ISerializable</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> Settings Inst = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Settings(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Settings</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> Settings Instance { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Inst; } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String ServerAddress { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _servAddr; } <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { _servAddr = <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String Port { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _port; } <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { _port = <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String _port = <span class="hljs-string"><span class="hljs-string">""</span></span>; }</code> </pre> <br>  Immediately make a few comments on the code: <br><ul><li>  Intentionally there are no lazy calculations to keep the code simple. </li><li>  Properties cannot be made automatic, because  the names of hidden class fields are generated again at each compilation, and once an honestly serialized object can no longer be deserialized due to the difference of these names. </li></ul><br><h5>  First look </h5><br>  In simple cases, for serialization in C #, adding the <a href="http://msdn.microsoft.com/en-us/library/system.serializableattribute.aspx">Serializable</a> attribute is enough.  Well, let's not think much about how complicated our case is and add this attribute.  Now let's try to serialize our singleton in three versions: <a href="http://msdn.microsoft.com/en-us/library/system.runtime.serialization.formatters.soap.soapformatter.aspx">SOAP</a> , <a href="http://msdn.microsoft.com/en-us/library/system.runtime.serialization.formatters.binary.binaryformatter.aspx">Binary,</a> and plain <a href="http://msdn.microsoft.com/en-us/library/system.xml.serialization.xmlserializer.aspx">XML</a> . <br>  For example, serialize and deserialize binary (other methods are similar): <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> mem = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MemoryStream()) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> serializer = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BinaryFormatter(); serializer.Serialize(mem, Settings.Instance); mem.Seek(<span class="hljs-number"><span class="hljs-number">0</span></span>, SeekOrigin.Begin); <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> o = serializer.Deserialize(mem); Console.WriteLine((Settings)o == Settings.Instance); }</code> </pre><br>  (Not) expectedly on the console will be displayed false, which means that we received two singleton objects.  <s>Such a result can be foreseen if we recall that in the process of deserialization using reflection, a private constructor is called and all deserialized values ‚Äã‚Äãare assigned to a new object</s> .  <b>UPD</b> : As <a href="https://habrahabr.ru/users/kekekeks/" class="user_link">kekekeks</a> rightly noted, <a href="https://habrahabr.ru/users/kekekeks/" class="user_link">it</a> ‚Äôs not the private constructor that will be called, but <blockquote>  BinaryFormatter uses FormatterServices.GetSafeUninitializedObject, which allows you to create an instance of an object without calling a constructor. </blockquote>  It is this singularity feature that puts the first stone in our garden: the singleton ceases to be a singleton. <br><br><h5>  Complicate and ... we put more stones. </h5><br>  Since it didn‚Äôt work out easy, we‚Äôll have to complicate it. If we turn to the more ‚Äúmanual‚Äù serialization process via the <a href="http://msdn.microsoft.com/en-us/library/system.runtime.serialization.iserializable.aspx">ISerializable</a> interface, then at first glance there seems to be no benefit: the past misfortune has not disappeared, and the complexity has increased.  Therefore, for further actions, we still need a rarely used <a href="http://msdn.microsoft.com/en-us/library/system.runtime.serialization.iobjectreference.aspx">IObjectReference</a> interface.  All that it does: shows that the object of the class implementing this interface points to another object.  It sounds strange, doesn‚Äôt it?  But we need another feature: after deserialization of such an object, the pointer will be returned not to itself, but to the object to which it points.  In our case, it would be logical to return a pointer to a singleton.  The class will look like this: <br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">Serializable</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">internal</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sealed</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">SettingsSerializationHelper</span></span> : <span class="hljs-title"><span class="hljs-title">IObjectReference</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Object </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetRealObject</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">StreamingContext context</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Settings.Instance; } }</code> </pre><br>  Now we can serialize an object of the class <i>SettingsSerializationHelper</i> , and when deserializing we can get <i>Settings.Instance</i> .  True, there are two more two stones: <br><ul><li>  Before you serialize a singleton, you need to create an object of another class. </li><li>  Singleton fields are still not serialized. </li></ul><br>  Consider the first stone, which is not very critical, but clearly not pleasant.  The solution to the problem lies in replacing the class for serialization inside <i>GetObjectData</i> .  It will look like this (inside the singleton): <br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetObjectData</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">SerializationInfo info, StreamingContext context</span></span></span><span class="hljs-function">)</span></span> { info.SetType(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(SettingsSerializationHelper)); }</code> </pre><br>  Now when we serialize a singleton instead of it, the <i>SettingsSerializationHelper</i> object will be saved, and during deserialization we will get our singleton back.  Checking the console output from the previously described serialization example, we will see that in the case of Binary and SOAP, true will be output to the console, but false for XML serialization.  Therefore, <i>XMLSerializer</i> does not call <i>GetObjectData</i> and simply processes all public fields / properties on its own. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h5>  Dirty hacks </h5><br>  The problem with the serialization of fields is the largest stone in our garden.  Unfortunately, I did not manage to find a very elegant and honest solution, but it turned out to build a not very honest, fairly flexible ‚Äúhack‚Äù. <br>  To begin with, in the <i>GetObjectData</i> method <i>,</i> add saving singleton fields.  It will look like this: <br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetObjectData</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">SerializationInfo info, StreamingContext context</span></span></span><span class="hljs-function">)</span></span> { info.SetType(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(SettignsSerializeHelper)); info.AddValue(<span class="hljs-string"><span class="hljs-string">"_servAddr"</span></span>, ServerAddressr); info.AddValue(<span class="hljs-string"><span class="hljs-string">"_port"</span></span>, Port); }</code> </pre><br>  If you now do SOAP serialization, you can see that all the fields are truly serialized.  However, in reality, we serialized <i>SettignsSerializationHelper</i> , which lacks these fields, which means that when deserializing, problems arise.  There are two solutions: <br><ul><li>  Completely repeat all singleton fields in <i>SettignsSerializationHelper</i> .  The deserializer completely consumes such a substitution, fills all the fields, and within the <i>GetRealObject</i> method <i>,</i> they must be assigned back to the singleton.  This approach has one big and serious drawback: manual support for duplicating fields, adding them for serialization and deserialization.  This is clearly not our <s>bro</s> . </li><li>  To call for help reflection, surrogate selector and a little linq, so that everything is done for us.  Consider this in more detail. </li></ul><br>  In the beginning, change the <i>GetObjectData</i> method: <br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetObjectData</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">SerializationInfo info, StreamingContext context</span></span></span><span class="hljs-function">)</span></span> { info.SetType(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span> (SettignsSerializeHelper)); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> fields = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">from</span></span></span><span class="hljs-function"> field </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">in</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">typeof</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Settings</span></span></span><span class="hljs-function">).</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetFields</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">BindingFlags.Instance | BindingFlags.NonPublic | BindingFlags.Public</span></span></span><span class="hljs-function">) </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">where</span></span></span><span class="hljs-function"> field.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetCustomAttribute</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">typeof</span></span></span></span><span class="hljs-function"><span class="hljs-params"> (NonSerializedAttribute</span></span></span><span class="hljs-function">))</span></span> == <span class="hljs-literal"><span class="hljs-literal">null</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> field; <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> field <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> fields) { info.AddValue(field.Name, field.GetValue(Settings.Instance)); } }</code> </pre><br>  Great, now when we want to add a field to a singleton, it will also be serialized without hands.  Let us turn to deserialization. <br>  All singleton fields should be repeated in <i>SettignsSerializationHelper</i> , but in order to avoid their real duplication, apply a <a href="http://msdn.microsoft.com/en-us/library/system.runtime.serialization.iserializationsurrogate.aspx">surrogate selector</a> and change <i>SettignsSerializationHelper</i> . <br>  New <i>SettignsSerializationHelper</i> : <br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">Serializable</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">internal</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sealed</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">SettignsSerializeHelper</span></span> : <span class="hljs-title"><span class="hljs-title">IObjectReference</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> Dictionary&lt;String, <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>&gt; infos = (<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">from</span></span></span><span class="hljs-function"> field </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">in</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">typeof</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Settings</span></span></span><span class="hljs-function">).</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetFields</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">BindingFlags.Instance | BindingFlags.NonPublic | BindingFlags.Public</span></span></span><span class="hljs-function">) </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">where</span></span></span><span class="hljs-function"> field.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetCustomAttribute</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">typeof</span></span></span></span><span class="hljs-function"><span class="hljs-params"> (NonSerializedAttribute</span></span></span><span class="hljs-function">))</span></span> == <span class="hljs-literal"><span class="hljs-literal">null</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> field).ToDictionary(x =&gt; x.Name, x =&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>()); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">object</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetRealObject</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">StreamingContext context</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> info <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> infos) { <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span> (Settings).GetField(info.Key, BindingFlags.Instance | BindingFlags.NonPublic | BindingFlags.Public).SetValue(Settings.Instance, info.Value); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Settings.Instance; } }</code> </pre><br>  And so, inside <i>SettignsSerializationHelper</i> , a hash map is created, where key is the names of the fields to be serialized, and value in the future will become the values ‚Äã‚Äãof these fields after deserialization.  Here, for more encapsulation, you can make infos as private and write a method to access its key-value pairs, but we will not complicate the example.  Inside <i>GetRealObject,</i> we set its deserialized field values ‚Äã‚Äãto a singleton and return a reference to it. <br>  Now you just have to fill infos with the field values.  A selector will be used for this. <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">internal</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sealed</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">SettingsSurrogate</span></span> : <span class="hljs-title"><span class="hljs-title">ISerializationSurrogate</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetObjectData</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> obj, SerializationInfo info, StreamingContext context</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> NotImplementedException(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">object</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SetObjectData</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> obj, SerializationInfo info, StreamingContext context, ISurrogateSelector selector</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ssh = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SettignsSerializeHelper(); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> val <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> info) { ssh.infos[val.Name] = val.Value; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ssh; } }</code> </pre><br>  Since the selector will be used only for deserialization, we will only write <i>SetObjectData</i> .  When obj (the object being deserialized) comes inside the selector, its fields are filled with 0 and null, regardless of the circumstances (obj is obtained after calling <i>GetUninitializedObject</i> from <a href="http://msdn.microsoft.com/en-us/library/system.runtime.serialization.formatterservices.aspx">FormatterServices</a> in the process of deserializing).  Therefore, in our case, it is easier to create a new <i>SettignsSerializationHelper</i> and return it (this object will be considered deserialized).  Next, inside the foreach, fill in infos with deserialized data, which will then be assigned to the singleton fields. <br>  And now an example of the serialization / deserialization process itself: <br><pre> <code class="cs hljs">     /: <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> mem = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MemoryStream()) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> soapSer = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SoapFormatter(); soapSer.Serialize(mem, Settings.Instance); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ss = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SurrogateSelector(); ss.AddSurrogate(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(SettignsSerializeHelper), soapSer.Context, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SettingsSurrogate()); soapSer.SurrogateSelector = ss; mem.Seek(<span class="hljs-number"><span class="hljs-number">0</span></span>, SeekOrigin.Begin); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> o = soapSer.Deserialize(mem); Console.WriteLine((Settings)o == Settings.Instance); }</code> </pre><br>  True will be displayed on the console and all fields will be restored.  Finally, we finished and brought our rock garden into the proper form. </div><p>Source: <a href="https://habr.com/ru/post/190380/">https://habr.com/ru/post/190380/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../190362/index.html">The 20% rule is no longer valid in Google</a></li>
<li><a href="../190364/index.html">Convert HTML to PDF with Dompdf</a></li>
<li><a href="../190370/index.html">A set of methods for working with lists in AngularJS</a></li>
<li><a href="../190374/index.html">Inheritance in Backbone.js</a></li>
<li><a href="../190376/index.html">Why balance the balance sheet?</a></li>
<li><a href="../190388/index.html">Impressive examples of webgl</a></li>
<li><a href="../190390/index.html">How uLogin forgot to extend the domain and what came of it</a></li>
<li><a href="../190394/index.html">Convenient interface Habra? Easy!</a></li>
<li><a href="../190396/index.html">Methods of anonymity online. Part 1. Just about the difficult</a></li>
<li><a href="../190400/index.html">The first quantum teleportation of information on a computer chip</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>