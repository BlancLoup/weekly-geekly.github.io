<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We download VKontakte audio through client js or .m3u8 file extension</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="How it all began... 
 As always, while hanging on VKontakte, I decided to download a couple of new audio recordings on a PC. But I was disappointed: t...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We download VKontakte audio through client js or .m3u8 file extension</h1><div class="post__text post__text-html js-mediator-article"><h1>  How it all began... </h1><br>  As always, while hanging on VKontakte, I decided to download a couple of new audio recordings on a PC.  But I was disappointed: the recordings were returned in a strange format: m3u8.  This format did not even reproduce the vlc media pleyer, and I began to think what to do ... <br><a name="habracut"></a><br><h2>  What to actually do? </h2><br>  Googling what the actual format is .m3u8, I realized that this is audio in <a href="https://ru.wikipedia.org/wiki/M3U">.m3u</a> format.  Great, download this .m3u8 file, open it with a text editor and see something like this: <br><br><div class="spoiler">  <b class="spoiler_title">Text</b> <div class="spoiler_text"><pre><code class="plaintext hljs">#EXTM3U #EXT-X-TARGETDURATION:3 #EXT-X-ALLOW-CACHE:YES #EXT-X-PLAYLIST-TYPE:VOD #EXT-X-VERSION:3 #EXT-X-MEDIA-SEQUENCE:1 #EXTINF:1.000, 6cfGpgIDcrZjA.ts?extra=0F4d1n-wWV6igsS5Ji7x6gYIbtU_aRzsiByqvrumv4W1iznLLoiC552LnsmyKeuuOtw70WTqfYdDCir-nmlL3VlLR9i2Y6IPOudQxWPbZjlslXE7prmIvdLyoLxb3A9NFnHo2KR5NStPg1sk6ZVXrYBh #EXTINF:2.000, c2d2tpKzIsYzM.ts?extra=0F4d1n-wWV6igsS5Ji7x6gYIbtU_aRzsiByqvrumv4W1iznLLoiC552LnsmyKeuuOtw70WTqfYdDCir-nmlL3VlLR9i2Y6IPOudQxWPbZjlslXE7prmIvdLyoLxb3A9NFnHo2KR5NStPg1sk6ZVXrYBh #EXTINF:3.000, a3fWlvLDwmZD4.ts?extra=0F4d1n-wWV6igsS5Ji7x6gYIbtU_aRzsiByqvrumv4W1iznLLoiC552LnsmyKeuuOtw70WTqfYdDCir-nmlL3VlLR9i2Y6IPOudQxWPbZjlslXE7prmIvdLyoLxb3A9NFnHo2KR5NStPg1sk6ZVXrYBh #EXTINF:3.000, edeWZhKTUnazE.ts?extra=0F4d1n-wWV6igsS5Ji7x6gYIbtU_aRzsiByqvrumv4W1iznLLoiC552LnsmyKeuuOtw70WTqfYdDCir-nmlL3VlLR9i2Y6IPOudQxWPbZjlslXE7prmIvdLyoLxb3A9NFnHo2KR5NStPg1sk6ZVXrYBh #EXTINF:3.000, 9df2NqJzcmZj0.ts?extra=0F4d1n-wWV6igsS5Ji7x6gYIbtU_aRzsiByqvrumv4W1iznLLoiC552LnsmyKeuuOtw70WTqfYdDCir-nmlL3VlLR9i2Y6IPOudQxWPbZjlslXE7prmIvdLyoLxb3A9NFnHo2KR5NStPg1sk6ZVXrYBh #EXT-X-ENDLIST</code> </pre> <br></div></div><br>  We further understand that <br><br><pre> <code class="plaintext hljs">9df2NqJzcmZj0.ts?extra=0F4d1n-wWV6igsS5Ji7x6gYIbtU_aRzsiByqvrumv4W1iznLLoiC552LnsmyKeuuOtw70WTqfYdDCir-nmlL3VlLR9i2Y6IPOudQxWPbZjlslXE7prmIvdLyoLxb3A9NFnHo2KR5NStPg1sk6ZVXrYBh</code> </pre> <br>  - The path to the audio.  That is, it is necessary to substitute a host for each path and, most likely, this audio will become playable.  Quickly having scribbled on a python a couple of lines of code we implement this: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> re text=<span class="hljs-string"><span class="hljs-string">'''#EXTM3U #EXT-X-TARGETDURATION:3 #EXT-X-ALLOW-CACHE:YES #EXT-X-PLAYLIST-TYPE:VOD #EXT-X-VERSION:3 #EXT-X-MEDIA-SEQUENCE:1 #EXTINF:1.000, 6cfGpgIDcrZjA.ts?extra=0F4d1n-wWV6igsS5Ji7x6gYIbtU_aRzsiByqvrumv4W1iznLLoiC552LnsmyKeuuOtw70WTqfYdDCir-nmlL3VlLR9i2Y6IPOudQxWPbZjlslXE7prmIvdLyoLxb3A9NFnHo2KR5NStPg1sk6ZVXrYBh #EXTINF:2.000, c2d2tpKzIsYzM.ts?extra=0F4d1n-wWV6igsS5Ji7x6gYIbtU_aRzsiByqvrumv4W1iznLLoiC552LnsmyKeuuOtw70WTqfYdDCir-nmlL3VlLR9i2Y6IPOudQxWPbZjlslXE7prmIvdLyoLxb3A9NFnHo2KR5NStPg1sk6ZVXrYBh #EXTINF:3.000, a3fWlvLDwmZD4.ts?extra=0F4d1n-wWV6igsS5Ji7x6gYIbtU_aRzsiByqvrumv4W1iznLLoiC552LnsmyKeuuOtw70WTqfYdDCir-nmlL3VlLR9i2Y6IPOudQxWPbZjlslXE7prmIvdLyoLxb3A9NFnHo2KR5NStPg1sk6ZVXrYBh #EXTINF:3.000, edeWZhKTUnazE.ts?extra=0F4d1n-wWV6igsS5Ji7x6gYIbtU_aRzsiByqvrumv4W1iznLLoiC552LnsmyKeuuOtw70WTqfYdDCir-nmlL3VlLR9i2Y6IPOudQxWPbZjlslXE7prmIvdLyoLxb3A9NFnHo2KR5NStPg1sk6ZVXrYBh #EXTINF:3.000, 9df2NqJzcmZj0.ts?extra=0F4d1n-wWV6igsS5Ji7x6gYIbtU_aRzsiByqvrumv4W1iznLLoiC552LnsmyKeuuOtw70WTqfYdDCir-nmlL3VlLR9i2Y6IPOudQxWPbZjlslXE7prmIvdLyoLxb3A9NFnHo2KR5NStPg1sk6ZVXrYBh #EXT-X-ENDLIST'''</span></span> host=<span class="hljs-string"><span class="hljs-string">'https://cs9-5v4.vkuseraudio.net/p16/d5fce44eae6dbc/'</span></span> al = re.findall(<span class="hljs-string"><span class="hljs-string">'\n.+?\.ts\?extra\=.+?\n'</span></span>,text) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> r <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> al: text=text.replace(r,<span class="hljs-string"><span class="hljs-string">'\n'</span></span>+host+r.strip(<span class="hljs-string"><span class="hljs-string">'\n'</span></span>)+<span class="hljs-string"><span class="hljs-string">'\n'</span></span>) print(text) input()</code> nmlL3VlLR9i2Y6IPOudQxWPbZjlslXE7prmIvdLyoLxb3A9NFnHo2KR5NStPg1sk6ZVXrYBh <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> re text=<span class="hljs-string"><span class="hljs-string">'''#EXTM3U #EXT-X-TARGETDURATION:3 #EXT-X-ALLOW-CACHE:YES #EXT-X-PLAYLIST-TYPE:VOD #EXT-X-VERSION:3 #EXT-X-MEDIA-SEQUENCE:1 #EXTINF:1.000, 6cfGpgIDcrZjA.ts?extra=0F4d1n-wWV6igsS5Ji7x6gYIbtU_aRzsiByqvrumv4W1iznLLoiC552LnsmyKeuuOtw70WTqfYdDCir-nmlL3VlLR9i2Y6IPOudQxWPbZjlslXE7prmIvdLyoLxb3A9NFnHo2KR5NStPg1sk6ZVXrYBh #EXTINF:2.000, c2d2tpKzIsYzM.ts?extra=0F4d1n-wWV6igsS5Ji7x6gYIbtU_aRzsiByqvrumv4W1iznLLoiC552LnsmyKeuuOtw70WTqfYdDCir-nmlL3VlLR9i2Y6IPOudQxWPbZjlslXE7prmIvdLyoLxb3A9NFnHo2KR5NStPg1sk6ZVXrYBh #EXTINF:3.000, a3fWlvLDwmZD4.ts?extra=0F4d1n-wWV6igsS5Ji7x6gYIbtU_aRzsiByqvrumv4W1iznLLoiC552LnsmyKeuuOtw70WTqfYdDCir-nmlL3VlLR9i2Y6IPOudQxWPbZjlslXE7prmIvdLyoLxb3A9NFnHo2KR5NStPg1sk6ZVXrYBh #EXTINF:3.000, edeWZhKTUnazE.ts?extra=0F4d1n-wWV6igsS5Ji7x6gYIbtU_aRzsiByqvrumv4W1iznLLoiC552LnsmyKeuuOtw70WTqfYdDCir-nmlL3VlLR9i2Y6IPOudQxWPbZjlslXE7prmIvdLyoLxb3A9NFnHo2KR5NStPg1sk6ZVXrYBh #EXTINF:3.000, 9df2NqJzcmZj0.ts?extra=0F4d1n-wWV6igsS5Ji7x6gYIbtU_aRzsiByqvrumv4W1iznLLoiC552LnsmyKeuuOtw70WTqfYdDCir-nmlL3VlLR9i2Y6IPOudQxWPbZjlslXE7prmIvdLyoLxb3A9NFnHo2KR5NStPg1sk6ZVXrYBh #EXT-X-ENDLIST'''</span></span> host=<span class="hljs-string"><span class="hljs-string">'https://cs9-5v4.vkuseraudio.net/p16/d5fce44eae6dbc/'</span></span> al = re.findall(<span class="hljs-string"><span class="hljs-string">'\n.+?\.ts\?extra\=.+?\n'</span></span>,text) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> r <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> al: text=text.replace(r,<span class="hljs-string"><span class="hljs-string">'\n'</span></span>+host+r.strip(<span class="hljs-string"><span class="hljs-string">'\n'</span></span>)+<span class="hljs-string"><span class="hljs-string">'\n'</span></span>) print(text) input()</code> </pre><br></div></div><br>  and we get a playable .m3u file. <br><br>  BUT!  The problem is that: <br><br><ul><li>  This file can be played only as long as the links to the audio gaps are valid. </li><li>  The file can also be converted only as long as the links are valid. <br></li><li>  The file can be converted only on the computer on which it was received.  Links tied to the ip address of the PC. </li></ul><br>  Having understood all this, I decided to write a program on the client js so that it could be executed on the command line.  Here's what I got: <br><br><div class="spoiler">  <b class="spoiler_title">Program</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">music_get</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>(){ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.el=<span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.getElementsByClassName(<span class="hljs-string"><span class="hljs-string">"audio_row"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.str_param=[]; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.json=[]; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.last_len=<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.el.length; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.make_str(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.el); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.load_audio_to_json(<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.str_param[<span class="hljs-number"><span class="hljs-number">0</span></span>]); } parse(element_){ <span class="hljs-comment"><span class="hljs-comment">//,  id ,     ,   . //let i=JSON.parse(element_.attributes['data-audio'].nodeValue),s1=i[13].split("/"); //return i[1]+"_"+i[0]+"_"+s1[2]+"_"+s1[s1.length-2]; let i = AudioUtils.asObject(JSON.parse(element_.getAttribute('data-audio'))); return i.fullId+"_"+i.actionHash+"_"+i.urlHash; } encode_url(t) { //,     let c = {v:(t)=&gt; { return t.split('').reverse().join('')},r: (t, e) =&gt; {t = t.split('');for (let i, o = _ + _, a = t.length; a--; ) ~(i = o.indexOf(t[a])) &amp;&amp; (t[a] = o.substr(i - e, 1));return t.join('')}, s: (t,e)=&gt; { let i = t.length;if (i) { let o = function(t, e) {let i = t.length,o = [];if (i) {let a = i;for (e = Math.abs(e); a--; ) e = (i * (a + 1) ^ e + a) % i,o[a] = e }return o}(t, e), a = 0;for (t = t.split(''); ++a &lt; i; ) t[a] = t.splice(o[i - 1 - a], 1, t[a]) [0];t = t.join('')}return t}, i:(t, e)=&gt; {return cs(t, e ^ vk.id)},x: (t, e)=&gt; {let i = [];return e = e.charCodeAt(0),each(t.split(''), (t, o) =&gt; {i.push(String.fromCharCode(o.charCodeAt(0) ^ e))}),i.join('')} },_ = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMN0PQRSTUVWXYZO123456789+/=',h=(t)=&gt;{ if (!t || t.length % 4 == 1) return !1;for (var e, i, o = 0, a = 0, s = ''; i = t.charAt(a++); ) ~(i = _.indexOf(i)) &amp;&amp; (e = o % 4 ? 64 * e + i : i, o++ % 4) &amp;&amp; (s += String.fromCharCode(255 &amp; e &gt;&gt; ( - 2 * o &amp; 6)));return s}; if ((!window.wbopen || !~(window.open + '').indexOf('wbopen')) &amp;&amp; ~t.indexOf('audio_api_unavailable')) { let e = t.split('?extra=')[1].split('#'),i=''===e[1]?'':h(e[1]); if (e = h(e[0]), 'string' != typeof i || !e) return t;for (var o, a, s = (i = i ? i.split(String.fromCharCode(9)) : []).length; s--; ) {if (o = (a = i[s].split(String.fromCharCode(11))).splice(0, 1, e) [0], !c[o]) return t; e = c[o].apply(null, a)}if (e &amp;&amp; 'http' === e.substr(0, 4)) return e}return t } end(){ //    html    each(this.json,(_,item)=&gt;{ let els = document.querySelectorAll('[data-full-id="'+item.fullId+'"]')[0]; if(els.children[0].children[6].children.length===3)return; els.children[0].children[6].innerHTML+="&lt;div onclick='new music_download().download(this);' style='float:right;height:40px;width:40px;background:url(/doc472427950_504561254) no-repeat 5px 5px;'&gt;&lt;/div&gt;" els.children[0].children[6].children[2].attributes.info=item; }); } make_str(mass){ //,    str_param   id ,     . each(mass,(i,e)=&gt;{ if(Math.floor(i/10)===i/10) this.str_param.push(this.parse(e)); else this.str_param[this.str_param.length-1]+=","+this.parse(e); }); } load_audio_to_json(i,l){ //    ,        , //       this.json ajax.post("/al_audio.php",{act:'reload_audio',al:'1',ids:l},{onDone:(a)=&gt;{ //each - ,     vk.com -   array.forEach each(a,(_,c)=&gt;{ c=AudioUtils.asObject(c); //   ,    ) c.url = this.encode_url(c.url); this.json.push(c); }); // if(this.str_param.length-1===i) this.end(); else this.load_audio_to_json(i+1,this.str_param[i+1]); }}); } _update_scroll(){ //,    . if(this.el.length===this.last_len)return; let c = this.el.length,offset=c-this.last_len; this.last_len=c; let arr = Array.from(this.el).splice(-offset); this._load_button(arr); } _load_button(list){ //,    . let leng=this.str_param.length-1; this.make_str(list); this.load_audio_to_json(leng,this.str_param[leng]); } } class music_download{ //constructor(){} download(e){ this.info = e.attributes.info; //   - .mp3,        if(this.info.url.indexOf(".mp3?")!==-1) window.open(this.info.url); else //       .m3u8,   (), //       .ts,    . //    response: fetch(this.info.url).then((e)=&gt;e.text().then((e)=&gt;this.response(e))); } response(data){ let alls = data.match(/\n.+?\.ts\?/ig), host=this.info.url.split("index.m3u8")[0]; each(alls,(_,e)=&gt;data=data.replace(e,"\n"+host+e.replace('\n',''))); //   this.download_data(this.info.title.replace(/[-\/\\:*?"&lt;&gt;|]/gim,'')+".m3u8",data); } download_data(f_n, t) { let e = document.createElement('a'); e.setAttribute('href', //'data:text/plain;charset=utf-8,' 'data:text/html;base64,'+ btoa(t)); e.setAttribute('download', f_n); e.style.display = 'none'; document.body.appendChild(e); e.click(); document.body.removeChild(e); } } var mus = new music_get(); //  window.onscroll=()=&gt;mus._update_scroll();</span></span></code> </pre> <br>  The result is something like this: <br><img src="https://habrastorage.org/webt/pd/3z/zl/pd3zzlmw_eav9zxexidxgicinv4.png"><br></div></div><br>  Next, after downloading all the audio in one folder, I wrote the following code on python to convert all the audio .m3u8 to <a href="https://ru.wikipedia.org/wiki/MPEG-TS">.ts</a> : <br><br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> requests,re,os <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">convert_mp3</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(f)</span></span></span><span class="hljs-function">:</span></span> z=open(f).read() con=list(map(<span class="hljs-keyword"><span class="hljs-keyword">lambda</span></span> e: e.rstrip(<span class="hljs-string"><span class="hljs-string">'\n'</span></span>).rstrip(<span class="hljs-string"><span class="hljs-string">'#EXT-X-ENDLIST'</span></span>).rstrip(<span class="hljs-string"><span class="hljs-string">"\n"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-string"><span class="hljs-string">'#EXTM3U'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> e <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-string"><span class="hljs-string">''</span></span> ,re.split(<span class="hljs-string"><span class="hljs-string">'#EXTINF:\d+.\d+,\n'</span></span>,z))) z = <span class="hljs-string"><span class="hljs-string">b''</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> r <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> con: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(r==<span class="hljs-string"><span class="hljs-string">''</span></span>):<span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; z+=requests.get(r).content open(f.strip(<span class="hljs-string"><span class="hljs-string">".m3u8"</span></span>)+<span class="hljs-string"><span class="hljs-string">".ts"</span></span>,<span class="hljs-string"><span class="hljs-string">'bw'</span></span>).write(z) z=set() <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> file <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> os.listdir(): <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> file.endswith(<span class="hljs-string"><span class="hljs-string">".m3u8"</span></span>): z.add(file) convert_mp3(file) z=<span class="hljs-string"><span class="hljs-string">',\n'</span></span>.join(z) input(<span class="hljs-string"><span class="hljs-string">f":</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{z}</span></span></span><span class="hljs-string"> .\n Enter,  !"</span></span>)</code> </pre><br></div></div><br>  In principle, you can try to connect the excerpts .ts on js and then download the entire file, but I did not succeed ( <br><br>  <b>PS</b> who will succeed - write in the comments <br>  <b>PPS I</b> forgot to say that Yandex. Browser still returns links to .mp3) <br><h2>  Update: </h2><br>  As correctly noted, <a href="https://habr.com/ru/users/nokimaro/" class="user_link">nokimaro</a> can immediately download mp3: <br><div class="spoiler">  <b class="spoiler_title">code</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">music_get</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>(){ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.el=<span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.getElementsByClassName(<span class="hljs-string"><span class="hljs-string">"audio_row"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.s=[]; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.j=[]; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.last_len=<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.el.length; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.make_str(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.el); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.load_audio_to_json(<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.s[<span class="hljs-number"><span class="hljs-number">0</span></span>]); } parse(element_){ <span class="hljs-comment"><span class="hljs-comment">//,  id ,     ,   . //let i=JSON.parse(element_.attributes['data-audio'].nodeValue),s1=i[13].split("/"); //return i[1]+"_"+i[0]+"_"+s1[2]+"_"+s1[s1.length-2]; let i = AudioUtils.asObject(JSON.parse(element_.getAttribute('data-audio'))); return i.fullId+"_"+i.actionHash+"_"+i.urlHash; } encode_url(t) { //,     let c = {v:(t)=&gt; { return t.split('').reverse().join('')},r: (t, e) =&gt; {t = t.split('');for (let i, o = _ + _, a = t.length; a--; ) ~(i = o.indexOf(t[a])) &amp;&amp; (t[a] = o.substr(i - e, 1));return t.join('')}, s: (t,e)=&gt; { let i = t.length;if (i) { let o = function(t, e) {let i = t.length,o = [];if (i) {let a = i;for (e = Math.abs(e); a--; ) e = (i * (a + 1) ^ e + a) % i,o[a] = e }return o}(t, e), a = 0;for (t = t.split(''); ++a &lt; i; ) t[a] = t.splice(o[i - 1 - a], 1, t[a]) [0];t = t.join('')}return t}, i:(t, e)=&gt; {return cs(t, e ^ vk.id)},x: (t, e)=&gt; {let i = [];return e = e.charCodeAt(0),each(t.split(''), (t, o) =&gt; {i.push(String.fromCharCode(o.charCodeAt(0) ^ e))}),i.join('')} },_ = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMN0PQRSTUVWXYZO123456789+/=',h=(t)=&gt;{ if (!t || t.length % 4 == 1) return !1;for (var e, i, o = 0, a = 0, s = ''; i = t.charAt(a++); ) ~(i = _.indexOf(i)) &amp;&amp; (e = o % 4 ? 64 * e + i : i, o++ % 4) &amp;&amp; (s += String.fromCharCode(255 &amp; e &gt;&gt; ( - 2 * o &amp; 6)));return s}; if ((!window.wbopen || !~(window.open + '').indexOf('wbopen')) &amp;&amp; ~t.indexOf('audio_api_unavailable')) { let e = t.split('?extra=')[1].split('#'),i=''===e[1]?'':h(e[1]); if (e = h(e[0]), 'string' != typeof i || !e) return t;for (var o, a, s = (i = i ? i.split(String.fromCharCode(9)) : []).length; s--; ) {if (o = (a = i[s].split(String.fromCharCode(11))).splice(0, 1, e) [0], !c[o]) return t; e = c[o].apply(null, a)}if (e &amp;&amp; 'http' === e.substr(0, 4)) return e}return t } end(){ //    html    each(this.j,(_,i)=&gt;{ let e = document.querySelectorAll('[data-full-id="'+i.fullId+'"]')[0],q=e.children[0].children[6]; if(q.children.length===3)return; q.innerHTML+="&lt;a href='"+this._g(i)+"' target='_blank' style='float:right;height:40px;width:40px;background:url(/doc472427950_504561254) no-repeat 5px 5px;'&gt;&lt;/a&gt;" }); } _g(info){ if(info.url.indexOf(".mp3?")!==-1) return info.url; else return info.url.replace("/index.m3u8",".mp3").replace(/\/\w{11}\//,'/'); } make_str(mass){ //,    s   id ,     . each(mass,(i,e)=&gt;{ if(Math.floor(i/10)===i/10) this.s.push(this.parse(e)); else this.s[this.s.length-1]+=","+this.parse(e); }); } load_audio_to_json(i,l){ //    ,        , //       this.j ajax.post("/al_audio.php",{act:'reload_audio',al:'1',ids:l},{onDone:(a)=&gt;{ //each - ,     vk.com -   array.forEach each(a,(_,c)=&gt;{ c=AudioUtils.asObject(c); //   ,    ) c.url = this.encode_url(c.url); this.j.push(c); }); // if(this.s.length-1===i) this.end(); else this.load_audio_to_json(i+1,this.s[i+1]); }}); } _update_scroll(){ //,    . if(this.el.length===this.last_len)return; let c = this.el.length,offset=c-this.last_len; this.last_len=c; let arr = Array.from(this.el).splice(-offset); this._load_button(arr); } _load_button(list){ //,    . let leng=this.s.length-1; this.make_str(list); this.load_audio_to_json(leng,this.s[leng]); } } //  var m = new music_get(); window.onscroll=()=&gt;m._update_scroll();</span></span></code> </pre><br>  compressed code: <br><pre> <code class="javascript hljs"><span class="hljs-built_in"><span class="hljs-built_in">eval</span></span>(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">p,a,c,k,e,r</span></span></span><span class="hljs-function">)</span></span>{e=<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">c</span></span></span><span class="hljs-function">)</span></span>{<span class="hljs-keyword"><span class="hljs-keyword">return</span></span>(c&lt;a?<span class="hljs-string"><span class="hljs-string">''</span></span>:e(<span class="hljs-built_in"><span class="hljs-built_in">parseInt</span></span>(c/a)))+((c=c%a)&gt;<span class="hljs-number"><span class="hljs-number">35</span></span>?<span class="hljs-built_in"><span class="hljs-built_in">String</span></span>.fromCharCode(c+<span class="hljs-number"><span class="hljs-number">29</span></span>):c.toString(<span class="hljs-number"><span class="hljs-number">36</span></span>))};<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!<span class="hljs-string"><span class="hljs-string">''</span></span>.replace(<span class="hljs-regexp"><span class="hljs-regexp">/^/</span></span>,<span class="hljs-built_in"><span class="hljs-built_in">String</span></span>)){<span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(c--)r[e(c)]=k[c]||e(c);k=[<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e</span></span></span><span class="hljs-function">)</span></span>{<span class="hljs-keyword"><span class="hljs-keyword">return</span></span> r[e]}];e=<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{<span class="hljs-keyword"><span class="hljs-keyword">return</span></span><span class="hljs-string"><span class="hljs-string">'\\w+'</span></span>};c=<span class="hljs-number"><span class="hljs-number">1</span></span>};<span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(c--)<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(k[c])p=p.replace(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">RegExp</span></span>(<span class="hljs-string"><span class="hljs-string">'\\b'</span></span>+e(c)+<span class="hljs-string"><span class="hljs-string">'\\b'</span></span>,<span class="hljs-string"><span class="hljs-string">'g'</span></span>),k[c]);<span class="hljs-keyword"><span class="hljs-keyword">return</span></span> p}(<span class="hljs-string"><span class="hljs-string">'8 p=7(){5.y=O.1a("1b");5.s=[];5.j=[];5.C=5.yo;5.J(5.y);5.D(0,5.s[0])};pqE=7(a){a=PQ(1c.E(a.1d("R-1e")));n a.S+"T"+a.1f+"T"+a.1g};pqU=7(a){8 b={v:7(a){n at("").1h().F("")},r:7(a,b){a=at("");A(8 k=1i 0,e=d+d,c=ao;c--;)~(k=eB(a[c]))&amp;&amp;(a[c]=eV(kb,1));n aF("")},s:7(a,b){8 c=ao;u(c){8 e=b,d=ao,f=[];u(d){8 g=d;A(e=W.1j(e);g--;)e=(d*(g+1)^e+g)%d,f[g]=e}e=0;A(a=at("");++e&lt;c;)a[e]=aK(f[c-1-e],1,a[e])[0];a=aF("")}na},i:7(a,d){n bs(a,d^1k.X)},x:7(a,d){8 b=[];nd=dY(0),G(at(""),7(a,c){bL(HI(cY(0)^d))}),bF("")}},d="1l+/=",c=7(a){u(!a||1==ao%4)n!1;A(8 b,c,e=0,g=0,f="";c=a.1m(g++);)~(c=dB(c))&amp;&amp;(b=e%4?1n*b+c:c,e++%4)&amp;&amp;(f+=HI(1o&amp;b&gt;&gt;(-2*e&amp;6)));nf};u((!MZ||!~(M.1p+"").B("Z"))&amp;&amp;~aB("1q")){8 f=at("?1r=")[1].t("#"),g=""===f[1]?"":c(f[1]);u(f=c(f[0]),"1s"!=1t g||!f)na;A(8 h,l=(g=g?gt(HI(9)):[]).o;l--;){u(h=(c=g[l].t(HI(11))).K(0,1,f)[0],!b[h])na;f=b[h].1u(1v,c)}u(f&amp;&amp;"1w"===fV(0,4))nf}na};pq12=7(){8 a=5;G(5.j,7(b,d){8 c=O.1x(\'[R-1y-X="\'+d.S+\'"]\')[0].N[0].N[6];3!==cNo&amp;&amp;(c.1z+="&lt;a 1A=\'"+a.13(d)+"\' 1B=\'1C\' 1D=\'1E:1F;1G:14;1H:14;1I:z(/1J) 1K-1L 15 15;\'&gt;&lt;/a&gt;")})};pq13=7(a){n-1!==azB(".16?")?az:az17("/1M.1N",".16").17(/\\/\\w{11}\\//,"/")};pqJ=7(a){8 b=5;G(a,7(a,c){W.1O(a/10)===a/10?bsL(bE(c)):bs[bso-1]+=","+bE(c)})};pqD=7(a,b){8 d=5;1P.1Q("/1R.1S",{1T:"1U",1V:"1",1W:b},{1X:7(b){G(b,7(a,b){b=PQ(b);bz=dU(bz);djL(b)});dso-1===a?d.12():dD(a+1,ds[a+1])}})};pq18=7(){u(5.yo!==5.C){8 a=5.yo,b=a-5.C;5.C=a;a=1Y.1Z(5.y).K(-b);5.19(a)}};pq19=7(a){8 b=5.so-1;5.J(a);5.D(b,5.s[b])};8 m=20 p;M.21=7(){n m.18()};'</span></span>,<span class="hljs-number"><span class="hljs-number">62</span></span>,<span class="hljs-number"><span class="hljs-number">126</span></span>,<span class="hljs-string"><span class="hljs-string">'|||||this||function|var|||||||||||||||return|length|music_get|prototype|||split|if||||el|url|for|indexOf|last_len|load_audio_to_json|parse|join|each|String|fromCharCode|make_str|splice|push|window|children|document|AudioUtils|asObject|data|fullId|_|encode_url|substr|Math|id|charCodeAt|wbopen|||end|_g|40px|5px|mp3|replace|_update_scroll|_load_button|getElementsByClassName|audio_row|JSON|getAttribute|audio|actionHash|urlHash|reverse|void|abs|vk|abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMN0PQRSTUVWXYZO123456789|charAt|64|255|open|audio_api_unavailable|extra|string|typeof|apply|null|http|querySelectorAll|full|innerHTML|href|target|_blank|style|float|right|height|width|background|doc472427950_504561254|no|repeat|index|m3u8|floor|ajax|post|al_audio|php|act|reload_audio|al|ids|onDone|Array|from|new|onscroll'</span></span>.split(<span class="hljs-string"><span class="hljs-string">'|'</span></span>),<span class="hljs-number"><span class="hljs-number">0</span></span>,{}))</code> </pre> <br></div></div></div><p>Source: <a href="https://habr.com/ru/post/457438/">https://habr.com/ru/post/457438/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../457424/index.html">Set for playing laser tag. Dedicated to those who played the war</a></li>
<li><a href="../45743/index.html">Habraquest - issue number 1. The prize is an invite to habr! - completed</a></li>
<li><a href="../457430/index.html">Grow, Team Leader, big and small</a></li>
<li><a href="../457434/index.html">Security Week 26: Google Spam</a></li>
<li><a href="../457436/index.html">Golang Meetup vol.4 - June 27, Nizhny Novgorod</a></li>
<li><a href="../45744/index.html">Scenario casual games - what is it?</a></li>
<li><a href="../457440/index.html">ServiceLoader: a built-in DI framework you may have never heard of</a></li>
<li><a href="../457442/index.html">Project Salmon: how to effectively counter Internet censorship using a proxy with levels of trust to users</a></li>
<li><a href="../457444/index.html">AR glasses in the case. Real case studies on how augmented reality has been applied in various business areas.</a></li>
<li><a href="../457446/index.html">Building and operating a fault-tolerant anycast network</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>