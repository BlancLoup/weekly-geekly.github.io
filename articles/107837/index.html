<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Linux HA based on Pacemaker</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In my previous article, I briefly touched upon the topic of creating a High Availability solution based on the heartbeat daemon. However, as it turned...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Linux HA based on Pacemaker</h1><div class="post__text post__text-html js-mediator-article">  In my <a href="https://habrahabr.ru/post/104621/">previous article,</a> I briefly touched upon the topic of creating a High Availability solution based on the heartbeat daemon.  However, as it turned out, something more complicated than a 2-node cluster on it is not so convenient to do.  Studying the problem put me on the trail of the <a href="http://clusterlabs.org/">Pacemaker</a> project.  We will now look at it briefly. <br><a name="habracut"></a><br><h4>  Posemaker </h4><br><img src="https://habrastorage.org/storage/741dc1ce/9563dc90/8a7458ee/e4ef9af7.png"><br>  According to the official documentation, Pacemaker is a cluster resource manager with the following main features: <br><ul><li>  Detection and recovery of failures at the level of nodes and services; </li><li>  Independence from the storage subsystem: a shared disk is not required; </li><li>  Resource type independence: everything that can be scripted can be clustered; </li><li>  Support STONITH (Shoot-The-Other-Node-In-The-Head) - drugs from Split-Brain;); </li><li>  Support for clusters of any size; </li><li>  Support for both quorum and resource-dependent clusters; </li><li>  Support virtually any redundant configuration; </li><li>  Automatic replication of the config to all nodes of the cluster; </li><li>  Ability to set the order of start-up resources, as well as their compatibility on one node </li><li>  Support for advanced resource types: clones (running on multiple nodes) and with additional states (master / slave, etc.); </li><li>  Single cluster shell (crm), unified, scripted. </li></ul><br>  The project, in addition to its own demons that support the cluster configuration and the above shell, also uses third-party, the same heartbeat and corosync.  I personally (the authors themselves, too) recommend using corosync.  In general, it supports heartbeat scripts, so there should be no problems. <br><img src="https://habrastorage.org/storage/28e549ea/1bcbfba3/f4c6c925/b3e65e80.png"><br><br><h4>  Installation </h4><br>  There is nothing easier on RHEL / CentOS. <br><pre><code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /etc/yum.repos.d wget http://www.clusterlabs.org/rpm/epel-5/clusterlabs.repo yum install pacemaker</code> </pre> <br>  Then we edit /etc/corosync/corosync.conf (there is corosync.conf.sample) and start. <br><pre> <code class="bash hljs">/etc/init.d/corosync start</code> </pre><br>  Yes, it is imperative to have a properly configured DNS so that all nodes relocate in both directions. <br><br>  How to add nodes?  There is nothing easier, put Pacemaker, copy /etc/corosync/corosync.conf and / etc / ais / authkeys (if configured) and run.  The node will be automatically included in the cluster.  The cluster configuration will also be automatically copied. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      If the node has failed and you replaced the iron?  The same, giving the new node the same name, copying the configs and starting.  Lepot <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># crm_mon ============ Last updated: Thu Aug 27 16:54:55 2009 Stack: openais Current DC: pcmk-1 - partition with quorum Version: 1.0.5-462f1569a43740667daf7b0f6b521742e9eb8fa7 2 Nodes configured, 2 expected votes 0 Resources configured. ============ Online: [ pcmk-1 pcmk-2 ]</span></span></code> </pre><br><br><h4>  Configuration </h4><br>  Cluster configuration is a simple XML.  However, manually edit it NOT.  All changes to the config are subject to automatic versioning, the nodes do not receive the entire config at once, but only the deltas from what they know about.  Those.  if the node has failed, and at this time you have changed the config, then when it returns, it will receive all the changes you have made. <br><br>  To work with the config, you can use either cibadmin or the crm shell itself.  You can see the config for example: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># crm configure show node pcmk-1 node pcmk-2 property $id="cib-bootstrap-options" \ dc-version="1.0.5-462f1569a43740667daf7b0f6b521742e9eb8fa7" \ cluster-infrastructure="openais" \ expected-quorum-votes="2"</span></span></code> </pre><br>  In addition to the cluster options themselves, configuration also includes: <br><ul><li>  Nodes; </li><li>  Resources (Resources); </li><li>  Connections (Constraints). </li></ul><br><h4>  Knots </h4><br>  How to add nodes, we have already figured out.  Nodes are removed much more difficult: stop corosync on the node, and then remove the node from the config. <br><br>  Do not forget that quorum is reached when more than half of the nodes are in the ranks.  Therefore, if you have a cluster of only 2, then this option should be disabled, otherwise if any of them fall, the cluster will consider itself collapsed. <br><br><h4>  Resources </h4><br>  What is a resource in terms of corosync?  Anything that can be scripted!  Usually, scripts are written in bash, but nothing prevents you from writing them in Perl, Python, or even C. All that the script needs is to perform 3 actions: start, stop and monitor.  In general, scripts must comply with LSB (Linux Standard Base) or OCF (Open Cluster Framework) - the latter expands the LSB somewhat, also requiring the transfer of parameters through environment variables with a special name. <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># crm ra classes heartbeat lsb ocf / heartbeat pacemaker stonith # crm ra list ocf heartbeat AoEtarget AudibleAlarm ClusterMon Delay Dummy EvmsSCC Evmsd Filesystem ICP IPaddr IPaddr2 IPsrcaddr LVM LinuxSCSI MailTo ManageRAID ManageVE Pure-FTPd Raid1 Route SAPDatabase SAPInstance SendArp ServeRAID SphinxSearchDaemon Squid Stateful SysInfo VIPArip VirtualDomain WAS WAS6 WinPopup Xen Xinetd anything apache db2 drbd eDir88 iSCSILogicalUnit iSCSITarget ids iscsi ldirectord mysql mysql-proxy nfsserver oracle oralsnr pgsql pingd portblock rsyncd scsi2reservation sfex tomcat vmware</span></span></code> </pre><br>  As we can see, there are quite a few ready-made agents (Resource Agents).  However, it is unlikely that it will be very difficult to write the new one yourself. <br><br>  When creating a resource, we will need to specify its class, type, provider, and the actual name with additional parameters.  In the list above: ocf - class, heartbeat - provider, IPaddr - agent type. <br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">crm</span></span> configure primitive ClusterIP ocf:heartbeat:IPaddr2 \ params ip=<span class="hljs-number"><span class="hljs-number">192.168.9.101</span></span> cidr_netmask=<span class="hljs-number"><span class="hljs-number">32</span></span> \ op monitor interval=<span class="hljs-number"><span class="hljs-number">30s</span></span></code> </pre><br>  Resources support many additional parameters, like binding to a node (resource-stickiness), default roles (started, stoped, master), etc.  There are opportunities to create groups of resources, clones (working on several nodes), etc. <br><br><h4>  Connections </h4><br>  To begin with, any link has its own weight - an integer ranging from -INFINITY to + INFINITY.  Moreover, if the weight of the bond is ¬± INFINITY, then it is considered rigid, otherwise - soft, i.e.  if the weights of other links are higher, it can be ignored. <br><br>  Relationships determine the binding of resources to a site (location), the order in which resources are started (ordering) and their co-residence on a site (colocation). <br><pre> <code class="hljs pgsql"># crm configure primitive WebSite ocf:heartbeat:apache \ params configfile=/etc/httpd/conf/httpd.conf \ op monitor <span class="hljs-type"><span class="hljs-type">interval</span></span>=<span class="hljs-number"><span class="hljs-number">1</span></span>min # crm configure colocation website-<span class="hljs-keyword"><span class="hljs-keyword">with</span></span>-ip <span class="hljs-keyword"><span class="hljs-keyword">INFINITY</span></span>: WebSite ClusterIP # crm configure <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> apache-<span class="hljs-keyword"><span class="hljs-keyword">after</span></span>-ip mandatory: ClusterIP WebSite # crm configure <span class="hljs-keyword"><span class="hljs-keyword">location</span></span> prefer-pcmk<span class="hljs-number"><span class="hljs-number">-1</span></span> WebSite <span class="hljs-keyword"><span class="hljs-keyword">rule</span></span> <span class="hljs-number"><span class="hljs-number">50</span></span>: pcmk<span class="hljs-number"><span class="hljs-number">-1</span></span></code> </pre><br>  Here we created another resource - WebSite, set it to live with ClusterIP (by the way, -INFINITY would mean that resources should NOT be on the same node), determine the launch order: first ClusterIP, then WebSite, and then set that WebSite is very it is desirable to be on the pcmk-1 node, with a weight of 50. When setting the order, you can also specify whether you can start resources in parallel or do it sequentially. <br><br>  In general, this way you can build quite complex chains of resource dependencies.  Everything becomes even more interesting if we consider that it is possible to set more complex rules (rules) that work, for example, only at a certain time of day or depending on the state of the cluster components. <br><br>  By the way, to facilitate understanding, the authors gave Pacemaker the opportunity to build graphviz graphics - see the ptest utility. <br><img src="https://habrastorage.org/storage/d4beb3c6/04f18e5d/e2262198/233f3123.png"><br><br><h4>  Conclusion </h4><br>  Pacemaker is simple and convenient, but at the same time very powerful and rich in capabilities.  After IBM HA MS, I can't get enough of this project at all :).  In order not to score a post with unnecessary details, and for further study you will need the following literature: <br><ul><li>  <a href="http://www.clusterlabs.org/doc/Cluster_from_Scratch.pdf">Cluster from Scratch</a> - a detailed example of installation and configuration with brief explanations; </li><li>  <a href="http://www.clusterlabs.org/doc/en-US/Pacemaker/1.0/pdf/Pacemaker_Explained/Pacemaker_Explained.pdf">Pacemaker Explained</a> - a complete, exhaustive description of all settings with examples; </li><li>  <a href="http://www.clusterlabs.org/mwiki/images/8/8d/Crm_cli.pdf">CRM command line interface</a> - crm shell description; </li><li>  <a href="http://www.clusterlabs.org/">clusterlabs.org</a> is the project site itself. </li></ul><br><br>  Thanks for attention. </div><p>Source: <a href="https://habr.com/ru/post/107837/">https://habr.com/ru/post/107837/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../107826/index.html">Happy Birthday, Firefox!</a></li>
<li><a href="../107827/index.html">About encodings and Unicode</a></li>
<li><a href="../107829/index.html">WYSIWYG HTML editor in the browser. Part 1</a></li>
<li><a href="../107831/index.html">GNU Compiler Collection, first steps</a></li>
<li><a href="../107834/index.html">Auto-increment primary keys (surrogate keys) = evil?</a></li>
<li><a href="../107839/index.html">Assign buttons MCE Remote</a></li>
<li><a href="../107841/index.html">‚ÄúFrom Good to Great‚Äù is a book that is definitely worth reading. (in quotes) - PART 1</a></li>
<li><a href="../107843/index.html">E-mail on sites services</a></li>
<li><a href="../107848/index.html">Features of IT project optimization when entering the German segment</a></li>
<li><a href="../107849/index.html">Common Sense - the latest anti-virus solution</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>