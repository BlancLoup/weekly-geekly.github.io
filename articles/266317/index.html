<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Redirecting data from a COM port to the web. Revision</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Recently I published an article ‚ÄúRedirecting Data from a COM Port to the Web‚Äù , in which I described a prototype of a system translating strings from ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Redirecting data from a COM port to the web. Revision</h1><div class="post__text post__text-html js-mediator-article">  Recently I published an article <a href="http://habrahabr.ru/post/264663/">‚ÄúRedirecting Data from a COM Port to the Web‚Äù</a> , in which I described a prototype of a system translating strings from a serial port of a computer to a web browser.  In that article, I indicated the directions in which the prototype should be finalized in order to bring it closer to the production stage: <br>  - no web page design <br>  - at each time point, only one web client will receive data <br>  - A very limited set of browsers through which you can access.  For example, it does not work in Internet Explorer 8, nor in the browser from Android 2.3.5 <br>  - python installation required <br><br>  After a while I decided not to leave it in this form and modify it.  Under the cut the result of refinement and a description of how I eliminated all the listed disadvantages. <br><br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Immediately show the final result: <br><iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/QGeEhhwA5MI%3Ffeature%3Doembed&amp;xid=17259,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjrKZ_usQdK8HpMSO0vuL2PAQVnqg" frameborder="0" allowfullscreen=""></iframe><br>  This video shows that the lines from the COM port are displayed simultaneously in three browsers at the same time: in Firefox and IE 8 on the same computer to which the Arduino is connected, and on the smartphone. <br>  The Arduino itself transmits the string ‚ÄúTemperature: XXXXXX‚Äù, and the string with the date-time and line number is one of the parts of the backend. <br><br>  Now, in order, how to eliminate shortcomings.  This time I will try not to be very tedious and not to describe every line of code, but to show only the main points.  If you have questions, ask in the comments. <br><br><h2>  Bad web page design </h2><br><br>  In a previous article I wrote that I understand the word ‚Äúno way‚Äù in creating a web front end, so creating a normal web page was the most difficult for me.  Fortunately, I almost immediately found the <a href="http://www.w3schools.com/">w3schools.com</a> site, where I discovered Bootstrap and found some good Ajax and jQuery tutorials.  For experienced front-end developers, the textbooks presented on this site will probably only cause a smile, but for such newcomers as me, this is exactly what is needed. <br>  The most pleasant thing about these textbooks is that they are very small and very substantive.  Without smearing porridge on a plate.  In principle, one evening to study is enough to start doing something. <br><br>  It turned out that using Bootstrap to create a more or less acceptable web page design is not so difficult.  Of course, he will not make Artemy Lebedev out of you, but you can <b>program the</b> user interface very quickly. <br><br>  The only thing that I couldn‚Äôt understand was how to use it to make the necessary division of a page into two parts: a large one, in which text is displayed in the middle in the vertical plane, and a small one, which is ‚Äúpressed‚Äù to the bottom edge of the browser window all the time.  But here came the article <a href="http://www.jakpsatweb.cz/css/css-vertical-center-solution.html">"Vertical Centering in CSS"</a> .  As a result, the following web page was obtained: <br><br><pre><code class="html hljs xml"><span class="hljs-comment"><span class="hljs-comment">&lt;!-- Vertical aligment of text from "Vertical Centering in CSS" at http://www.jakpsatweb.cz/css/css-vertical-center-solution.html --&gt;</span></span> <span class="hljs-meta"><span class="hljs-meta">&lt;!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN"&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">head</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">style</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text/css"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="css"><span class="css"> </span><span class="hljs-selector-tag"><span class="css"><span class="hljs-selector-tag">html</span></span></span><span class="css">, </span><span class="hljs-selector-tag"><span class="css"><span class="hljs-selector-tag">body</span></span></span><span class="css"> { </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">height</span></span></span><span class="css">: </span><span class="hljs-number"><span class="css"><span class="hljs-number">100%</span></span></span><span class="css">; </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">margin</span></span></span><span class="css">: </span><span class="hljs-number"><span class="css"><span class="hljs-number">0px</span></span></span><span class="css">; } </span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">style</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">head</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">style</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"display: table; height: 90%; width: 100%; overflow: hidden;"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">style</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">" display: table-cell; vertical-align: middle;"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">style</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text-align: center"</span></span></span><span class="hljs-tag">&gt;</span></span> data place<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">br</span></span></span><span class="hljs-tag">&gt;</span></span>    <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">style</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"display: table; height: 10%; width: 100%; overflow: hidden;"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">style</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">" display: table-cell; vertical-align: middle;"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">style</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text-align: right;"</span></span></span><span class="hljs-tag">&gt;</span></span> buttons <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><br>  Practically all the rest of the page code turned out after reading Bootstrap and JavaScript tutorials (section JS HTML DOM).  The exception is the jQuery code that updates the data on the page.  But more on that later. <br><br><h2>  Limited number of supported browsers </h2><br><br>  Weak browser support for the previous prototype was due to the chosen technology for delivering information updates: Server-Sent Events.  Therefore, this time I decided to use the old time-tested technology Ajax.  Using Ajax leads to an increase in web traffic, but, in my opinion, it should work in the maximum number of browsers. <br>  Another disadvantage of Ajax is the fact that, if no special measures are taken, there may be gaps in the lines that are transmitted through the COM port: if the lines to the serial port are received very quickly, and Ajax requests come less often, all lines between requests will not be visible to the client.  But for the task of displaying, for example, the current temperature - this is not at all scary. <br><br>  I could probably use the WebSockets technology, but as far as I understood, in IE it is supported only from version 10, and I have IE 8, so I didn‚Äôt even work out this direction. <br>  Just a few days ago in some of the articles on Habr√© or HykTimes I came across the mention of the <a href="https://github.com/sockjs/sockjs-client">SockJS</a> library, which seems to be able to bypass the absence of WebSockets, but, first, it requires special.  support on the server side, and, secondly, Ajax was working for me by this moment, so it was left without my attention. <br><br>  So, Ajax.  Once upon a time I tried to learn this technology.  But all the paper books that I came across were too tedious and I very quickly gave up.  But at the already mentioned <a href="http://www.w3schools.com/">w3schools.com</a> tutorial turned out to be very good.  As a result, the following code came out pretty quickly: <br><br><pre> <code class="javascript hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_data</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> xmlhttp; xmlhttp=<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> XMLHttpRequest(); xmlhttp.open(<span class="hljs-string"><span class="hljs-string">"GET"</span></span>,<span class="hljs-string"><span class="hljs-string">"/get_serial?r="</span></span> + <span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.random(),<span class="hljs-literal"><span class="hljs-literal">true</span></span>); xmlhttp.onreadystatechange=<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (xmlhttp.readyState==<span class="hljs-number"><span class="hljs-number">4</span></span> &amp;&amp; xmlhttp.status==<span class="hljs-number"><span class="hljs-number">200</span></span>) { <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.getElementById(<span class="hljs-string"><span class="hljs-string">"data"</span></span>).innerHTML=xmlhttp.responseText; get_data(); } } xmlhttp.send(); }</code> </pre><br>  which was called at the end of the page loading: <br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">onload</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"get_data()"</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><br>  In this code, you probably need to pay attention to two points.  First, on the line <br><pre> <code class="javascript hljs"> xmlhttp.open(<span class="hljs-string"><span class="hljs-string">"GET"</span></span>,<span class="hljs-string"><span class="hljs-string">"/get_serial?r="</span></span> + <span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.random(),<span class="hljs-literal"><span class="hljs-literal">true</span></span>);</code> </pre><br>  This is where the web server is accessed for the next line from the COM port.  Additive <br><pre> <code class="javascript hljs">r=<span class="hljs-string"><span class="hljs-string">" + Math.random()</span></span></code> </pre><br>  needed to ensure that Internet Explorer does not cache the answers.  Otherwise, he will send only one Ajax request, will receive a response and will no longer contact the server.  On the Internet, I have seen solutions for caching problems by sending special HTTP headers from the server side <br><pre> <code class="python hljs"> response.headers[<span class="hljs-string"><span class="hljs-string">'Last-Modified'</span></span>] = datetime.now() response.headers[<span class="hljs-string"><span class="hljs-string">'Cache-Control'</span></span>] = <span class="hljs-string"><span class="hljs-string">'no-store, no-cache, must-revalidate, post-check=0, pre-check=0, max-age=0'</span></span> response.headers[<span class="hljs-string"><span class="hljs-string">'Pragma'</span></span>] = <span class="hljs-string"><span class="hljs-string">'no-cache'</span></span> response.headers[<span class="hljs-string"><span class="hljs-string">'Expires'</span></span>] = <span class="hljs-string"><span class="hljs-string">'-1'</span></span></code> </pre><br>  but for some reason it didn't work for me. <br>  An alternative is to use POST instead of GET.  They say that IE does not cache such requests, but I did not check. <br>  By the way, jQuery, uses the exact same way of dealing with caching - it also adds a random string to the URL.  It only looks different. <br><br>  The second point is a sequence of lines. <br><pre> <code class="javascript hljs"> xmlhttp.open(<span class="hljs-string"><span class="hljs-string">"GET"</span></span>,<span class="hljs-string"><span class="hljs-string">"/get_serial?r="</span></span> + <span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.random(),<span class="hljs-literal"><span class="hljs-literal">true</span></span>);</code> </pre><br>  and <br><pre> <code class="javascript hljs"> xmlhttp.onreadystatechange=<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) ...</span></span></code> </pre><br><br>  Initially, they were in a different order.  And in Internet Explorer, this led to strange problems - he was surviving all the available memory.  And only after that updated data.  What and finished his work. <br>  Only on the site <a href="httprequest.ru/">XmlHttpRequest.ru</a> I found that when reusing an XMLHttpRequest object, it is recommended to first call the open () method and only after that change the onreadystatechange property. <br><br>  Having received so many problems with IE out of the blue, I decided that I should use the library, in which such nuances are most likely already taken into account.  Since for Bootstrap, jQuery was already loaded on the page. <br><pre> <code class="html hljs xml"> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  I decided that it was worth not to use the Ajax support built into this library.  Therefore, the data update code has been converted to: <br><pre> <code class="javascript hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">on_load</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">responseTxt, statusTxt, xhr</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( statusTxt == <span class="hljs-string"><span class="hljs-string">"success"</span></span> ){ $(<span class="hljs-string"><span class="hljs-string">"#data"</span></span>).load(<span class="hljs-string"><span class="hljs-string">"/get_serial?r="</span></span> + <span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.random(), on_load ) } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { $(<span class="hljs-string"><span class="hljs-string">"#data"</span></span>).text( <span class="hljs-string"><span class="hljs-string">"Error: "</span></span> + xhr.status + <span class="hljs-string"><span class="hljs-string">": "</span></span> + xhr.statusText ); } } $(<span class="hljs-built_in"><span class="hljs-built_in">document</span></span>).ready(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{ on_load(<span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-string"><span class="hljs-string">"success"</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>); });</code> </pre><br><br><h2>  One customer at a time </h2><br><br>  In the previous article I already wrote about a possible way to solve this problem: splitting the backend into two parts, using ZMQ for their connection + multiplayer http-server as the second part.  As such a server, I chose Flask.  I did not make any comparisons of alternatives, he just caught me first.  It turned out that it can be run in the mode of parallel processing of http-requests and this turned out to be sufficient.  To start this mode, it is enough to pass a parameter to it. <br>  threaded = True (see <a href="http://stackoverflow.com/questions/14672753/handling-multiple-requests-in-flask">stackoverflow.com/questions/14672753/handling-multiple-requests-in-flask</a> ): <br><br><pre> <code class="python hljs"> app.run(host=<span class="hljs-string"><span class="hljs-string">'0.0.0.0'</span></span>, debug=<span class="hljs-keyword"><span class="hljs-keyword">False</span></span>, threaded=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>)</code> </pre><br><br>  In addition to multi-threading, Flask provides another very convenient routing mechanism, i.e.  compliance of individual procedures with certain http requests.  So for creating simple web applications, Flask is a very nice thing. <br><br>  But most of all I would like to tell you about the ZMQ library - to demonstrate its amazing capabilities. <br>  Here is the code for the demo ZMQ server: <br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> zmq <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> time context = zmq.Context.instance() pub_sock = context.socket(zmq.PUB) pub_sock.bind( <span class="hljs-string"><span class="hljs-string">'tcp://*:12345'</span></span> ) count = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_full_line_from_serial</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">global</span></span> count count += <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> time.strftime( <span class="hljs-string"><span class="hljs-string">'%Y.%m.%d %H:%M:%S'</span></span> ) + <span class="hljs-string"><span class="hljs-string">': string N %d'</span></span> % count <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>: line = get_full_line_from_serial() <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> line pub_sock.send( line ) time.sleep(<span class="hljs-number"><span class="hljs-number">1</span></span>)</code> </pre><br>  which simulates reading from a COM port.  In fact, it generates a new line every second, ‚Äúpublishes‚Äù it (that is, sends it to all subscribing clients) and prints it for debugging. <br><br>  And water client code: <br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> zmq context = zmq.Context.instance() zmq_sub_sock = context.socket(zmq.SUB) zmq_sub_sock.setsockopt(zmq.SUBSCRIBE, <span class="hljs-string"><span class="hljs-string">''</span></span>) zmq_sub_sock.connect( <span class="hljs-string"><span class="hljs-string">'tcp://localhost:12345'</span></span> ) poller = zmq.Poller() poller.register( zmq_sub_sock, zmq.POLLIN ) <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>: socks = dict(poller.poll(timeout=<span class="hljs-number"><span class="hljs-number">5000</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> zmq_sub_sock <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> socks: <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> zmq_sub_sock.recv() <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> <span class="hljs-string"><span class="hljs-string">'No data within 5 sec'</span></span></code> </pre><br>  which opens a ZMQ socket, subscribes to all possible messages and connects to the server.  After that, in an infinite loop, it waits for new data and displays it. <br><br>  But a demonstration of their collaboration: <br><iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/T-BZ8Sy22_I%3Ffeature%3Doembed&amp;xid=17259,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhh_hbZyxwQ4QTm0q8zLlKt_i4dzWQ" frameborder="0" allowfullscreen=""></iframe><br>  What I want to draw attention to.  First, you can start the client before starting the server.  And it does not affect its performance.  Secondly, even a server crash will not cause clients to crash - as soon as the server restarts, clients will again receive messages from it.  Isn't that fantastic?  And this is in the absence of any special instructions in the source code of the client and server.  How much code would you have to write yourself to implement this functionality when using conventional TCP / IP sockets? <br>  And this is just a little bit of what the ZMQ library can do.  Once again, I highly recommend that you look at this library. <br><br><h2>  Standalone app </h2><br><br>  I already, it seems, mentioned that python is poorly adapted for creating standalone applications.  It is an interpreted language for which normal work requires an interpreter program.  Unfortunately, there is no compiler for it that can generate the native binary code.  I know two programs that allow you to create a kind of self-contained application from a script: py2exe and pyInstaller.  I myself often use the second one, so I decided to use it in this project. <br><br>  pyInstaller takes the Python script, analyzes all the files on which it depends (determines all imported modules and dynamic link libraries) and then either collects them all into a separate folder, or packs them into some kind of analog self-extracting archive.  The code of the interpreter itself is also added there, as well as a small starting part, which, at the start, prepares the execution environment and starts the interpretation of the target script. <br><br>  Since neither the creators of python, nor the creators of libraries under it did not think about such a possible use, it all works somewhat ‚Äúthrough the stump-deck‚Äù.  The main problems are to prepare a list of all necessary libraries and modules.  Because many authors of libraries use implicit import, with which there is no explicit indication of which module will be imported into a script or another module.  Accordingly, often after automatic analysis of the pyInstaller script, you need to manually add the names of additional modules and / or paths in the configuration file (with the .spec extension) where to find them.  Together with pyInstaller there is a large set of ready-made functions for such libraries, but life does not stand still.  In particular, this turned out to be the case with the current version of ZMQ - the developers of pyZMQ (ZMQ binding to python) have changed the mechanism for importing auxiliary libraries, as a result of which the application built by pyInstaller does not start.  The people have already figured out this case and have prepared a corresponding patch for pyInstaller.  The patch is working, but I haven‚Äôt yet got into the official release, so I had to patch pyInstaller with my hands.  See the patch code at <a href="https://github.com/pyinstaller/pyinstaller/pull/110/files">github.com/pyinstaller/pyinstaller/pull/110/files</a> <br><br>  But even this patch was not enough if the standalone application should be just one executable file, and not a whole folder.  I had to manually adjust the .spec file so that the libsodium.pyd library from the ZMQ distribution kit got to the right place when unpacking the .exe file. <br><br>  The second problem was the multiprocessing module.  I divided the backend into two parts, which should work in parallel.  It seemed to me wrong if I had to run two separate programs to run the backend.  And to use multithreading (multithreading) it seemed to me wrong because of the presence of GIL (Global Interpretation Lock).  It would seem that it is easier to write a simple script that, when started, will simply generate two new processes: one for the ZMQ server that reads data from the COM port, the second for the HTTP server that responds to web client requests.  And indeed, when working in normal mode (i.e., when ‚Äúmanually‚Äù running the interpreter), the following script works fine: <br><br><pre> <code class="hljs scala"># -*- coding: utf<span class="hljs-number"><span class="hljs-number">-8</span></span> -*- from multiprocessing <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-type"><span class="hljs-type">Process</span></span> <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> serial_to_zmq <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> zmq2web_using_flask <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> time <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span></span>(): args = get_command_line_params() p1 = <span class="hljs-type"><span class="hljs-type">Process</span></span>( target=serial_to_zmq.work, args=(args.serial_port_name, args.serial_port_speed, args.zmq_pub_addr) ) p1.start() p2 = <span class="hljs-type"><span class="hljs-type">Process</span></span>(target=zmq2web_using_flask.work, args=(args.zmq_sub_addr,)) p2.start() print <span class="hljs-symbol"><span class="hljs-symbol">'Press</span></span> <span class="hljs-type"><span class="hljs-type">Ctrl</span></span>+<span class="hljs-type"><span class="hljs-type">C</span></span> to stop...', <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-type"><span class="hljs-type">True</span></span>: time.sleep(<span class="hljs-number"><span class="hljs-number">10</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_command_line_params</span></span></span></span>(): ... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> __name__ == <span class="hljs-symbol"><span class="hljs-symbol">'__main_</span></span>_': main()</code> </pre><br><br>  But after processing pyInstaller, the resulting .exe did not work normally.  Several ZMQ servers and Flask applications were launched with the appropriate messages that the ‚Äúsocket is already busy‚Äù and some other oddities.  It turned out that when launching a Flask application, it needs to pass the debug = False parameter: <br><br><pre> <code class="python hljs"> app.run(host=<span class="hljs-string"><span class="hljs-string">'0.0.0.0'</span></span>, debug=<span class="hljs-keyword"><span class="hljs-keyword">False</span></span>, threaded=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>)</code> </pre><br><br>  and for the multiprocessing module, you need to call the special function freeze_support (), which is needed in that mode (froozen), which is created when the script is interpreted in the case of standalone applications created by pyInstaller. <br><br>  In general, the result of this point is this: you can create a standalone application from the Python script, but this is not easy. <br><br>  All source code can be downloaded from github: <a href="https://github.com/alguryanow/serial2web-2">github.com/alguryanow/serial2web-2</a> <br><br>  PS Another Bootstrap <a href="http://www.tutorialrepublic.com/twitter-bootstrap-2.3.2-tutorial/">Tutorial</a> : <a href="http://www.tutorialrepublic.com/twitter-bootstrap-2.3.2-tutorial/">www.tutorialrepublic.com/twitter-bootstrap-2.3.2-tutorial</a> </div><p>Source: <a href="https://habr.com/ru/post/266317/">https://habr.com/ru/post/266317/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../266307/index.html">To help the marketer: write automatic download of data from Adfox with visualization</a></li>
<li><a href="../266309/index.html">Traditional testing will die soon</a></li>
<li><a href="../266311/index.html">The digest of interesting materials from the world of web development and IT for the last week? 175 (August 31 - September 6, 2015)</a></li>
<li><a href="../266313/index.html">PHP Digest number 69 - interesting news, materials and tools (August 24 - September 6, 2015)</a></li>
<li><a href="../266315/index.html">Peering network base.network</a></li>
<li><a href="../266319/index.html">Visualization of the job market with R</a></li>
<li><a href="../266321/index.html">The storage of research results by the method of radiology</a></li>
<li><a href="../266323/index.html">Security on trust</a></li>
<li><a href="../266325/index.html">Hidden bug (feature?) Switch ZyXEL ES-2108-G</a></li>
<li><a href="../266327/index.html">Installing Zabbix 2.4 on RedHat Openshift</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>