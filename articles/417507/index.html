<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Tricks for linking and downloading Mach-O files</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I present to your attention the translation of my article from the blog of the Darling Project. A little help on the concepts used: Darwin - the open ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Tricks for linking and downloading Mach-O files</h1><div class="post__text post__text-html js-mediator-article"><p> <em>I present to your attention the translation of my article from the blog of the Darling Project.</em>  <em>A little help on the concepts used: Darwin - the open source operating system underlying macOS, iOS and other operating systems from Apple;</em>  <em>Mach-O is a binary format of executable files and libraries used in Darwin;</em>  <em>dyld is a dynamic loader used in Darwin for downloading Mach-O files;</em>  <em>dylib is a dynamically loaded library (usually with the extension <code>.dylib</code> ).</em> </p><br><p><img src="https://habrastorage.org/webt/q4/to/tb/q4totbx7ltcbh_gj58-qnayiffg.png" alt="Picture to attract attention"></p><br><p>  The goal of the Darling Project is to make it possible to run macOS applications under Linux, and the ability to download binary files in the Mach-O format is one of the key steps towards achieving this goal. </p><br><p>  Initially, Darling was built around its own implementation of the Mach-O loader and the idea of ‚Äã‚Äãtranslating calls between the high-level Darwin API and its Linux counterparts.  Since then, our focus has shifted to running code in an increasingly isolated Darwin container.  Since we <a href="http://blog.darlinghq.org/2017/02/the-mach-o-transition-darling-in-past-5.html">switched to using Mach-O for internal components of Darling</a> , we have the opportunity to use Apple's original dyld, as well as build many other open-source components of Darwin.  We still need a simple Mach-O loader to load the dyld itself. </p><a name="habracut"></a><br><p>  Mach-O, along with Mach itself, is probably the most noticeable distinguishing features of Darwin, and the various libraries and frameworks supplied by Apple make extensive use of the little-known features of the Mach-O format.  This makes working with Mach-O one of the most important and visible tasks in the development of Darling.  From implementing your own Mach-O loaders to building Darwin components (first as special ELF files, and now as true Mach-O) - we need to understand the internal structure of Mach-O at a much deeper level than is usually required from ordinary developers under the Darwin-platform. </p><br><p>  Let's finish with this introduction and proceed to discuss some of the tricks that Mach-O format can offer us. </p><br><h2 id="ustanovochnye-imena">  Setup Names </h2><br><p>  In Windows and Linux, dynamic libraries are referenced by their name (for example, <code>libc.so</code> ), after which the task of the dynamic linker is to find a library with the same name in one of the standard directories for libraries.  In Darwin, the (almost) full path to the library file, called the install name of this library, is used instead.  Supposedly, this was done to prevent the <em>substitution of dylib</em> [dylib hijacking] - an attack in which a fake dylib is placed in the directory in which it will be found by the dynamic linker before the real one, which allows the fake dylib to execute arbitrary code on behalf of the program, which was thus convinced dylib download. </p><br><p>  Not only executable files and libraries store the full installation names of their dependencies, but Mach-O dependencies themselves ‚Äúknow‚Äù their own installation names.  Actually, this is how the linker learns which setup names to use for the dependencies: he reads them from the dependencies themselves. </p><br><p>  When linking dylib, you specify its installation name using the ld <code>-install_name</code> or <code>-dylib_install_name</code> : </p><br><pre> <code class="bash hljs">$ ld -o libfoo.dylib foo.o -install_name /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/lib/libfoo.dylib</code> </pre> <br><p>  Now, when you link another Mach-O file (say, <code>libbar.dylib</code> ) to <code>libfoo.dylib</code> , ld will write the libfoo installation name <code>/usr/local/lib/libfoo.dylib</code> in the <code>libbar</code> dependency <code>libbar</code> , and that‚Äôs where dyld is will look for <code>libfoo</code> at runtime. </p><br><p>  Using the full path works quite well for system libraries, which are indeed installed in previously known places in the file system;  but with libraries that come as part of [app bundles], there is a problem.  Although each application might assume that it will be installed in <code>/Applications/AppName.app</code> , generally speaking, it is understood that application assemblies are portable and can be freely moved around the file system, so a specific library path inside such assemblies cannot be known in advance. </p><br><p>  As a solution to this problem, Darwin allows the installation names to begin with <code>@executable_path</code> , <code>@loader_path</code> , or <code>@rpath</code> ‚Äî that is, not to be absolute, but to specify the path to the library relative to the path to the main executable file, the path to the ‚Äúload‚Äù (executable file or library, which directly depends on this library) or relative to the list of paths defined by the main executable file, respectively.  <code>@executable_path</code> and <code>@loader_path</code> work without additional complexity, but if at least one of your dependencies (or their transitive dependencies) has an installation name using <code>@rpath</code> , you must explicitly specify <code>@rpath</code> when linking your executable file using the ld <code>-rpath</code> option times as you need: </p><br><pre> <code class="bash hljs">$ ld -o runme -rpath @executable_path/../Frameworks -rpath @executable_path/../bin/lib</code> </pre> <br><p>  (The concept of rpath to some extent destroys the original idea of ‚Äã‚Äãpreviously known paths to libraries, and <a href="https://www.virusbulletin.com/virusbulletin/2015/03/dylib-hijacking-os-x">opens up the</a> possibility of carrying out attacks to replace dylib. We can assume that this makes everything associated with the installation names rather useless.) </p><br><h2 id="ciklicheskie-zavisimosti">  Cyclic dependencies </h2><br><p>  When the source code of a project occupies several files, it is perfectly normal if these files are mutually dependent on each other.  This works fine as long as all these files are compiled into one binary ‚Äî an executable file or a library.  What does not work is when several dynamic libraries are dependent on each other. </p><br><p>  You can argue that instead of using circular dependencies between dynamic libraries, it is worth redesigning the project architecture, and I agree with you.  But if there is something typical for Apple, it is that they never stop to think things over and do it right;  instead, they lay crutches and stunts on top of each other.  In this case, we need to make circular dependencies work for Darling, since the various libSystem <code>libSystem</code> , such as <code>libsystem_dyld</code> , <code>libsystem_kernel</code> and <code>libsystem_pthread</code> , all depend on each other.  (Until recently, we also had to loop Cocoa frameworks such as AppKit, Core Graphics and Core OpenGL cyclically, because of how Core OpenGL was implemented in The Cocotron, but we <a href="https://github.com/darlinghq/darling/issues/365">redesigned the</a> architecture of our Core OpenGL and were able to get rid of this cyclic dependencies.) </p><br><p>  In principle, cyclic dependencies should work fine: the dynamic linker can already load each library only once, so that it will not have problems with endless recursion.  The problem is that such libraries cannot be simply <em>linked</em> , since each call to the linker creates only one library, and when linking any binary it is necessary to transfer to the linker all its dependencies already linked.  We have to link one of our libraries first, and at this moment the rest are not ready yet, so we can not transfer them to the linker. </p><br><p>  The trick here is to link some (or, for simplicity, all) of these libraries <em>twice</em> .  For the first time, tell the linker to ignore the missing dependencies, and indeed, do not pass the dependencies: </p><br><pre> <code class="bash hljs">$ ld -o libfoo.dylib foo.o -flat_namespace -undefined suppress $ ld -o libbar.dylib bar.o -flat_namespace -undefined suppress</code> </pre> <br><p>  (See below about <code>-flat_namespace</code> .) </p><br><p>  Of course, if you try to directly use the resulting dylib-ki, you will get dynamic linking errors at runtime.  Instead, link these libraries a second time, passing the resulting dylib-ki as dependencies: </p><br><pre> <code class="bash hljs">$ ld -o libfoo.dylib foo.o libbar.dylib $ ld -o libbar.dylib bar.o libfoo.dylib</code> </pre> <br><p>  This time the linker sees all the characters, so we do not tell him to ignore errors (and if there are really not enough characters, you will get an error). </p><br><p>  Despite the fact that some, if not all, of the libraries are linked to the "wrong" copies of their dependencies, during the execution of dyld they will see the correct versions.  To make this work, make sure that both copies of each library have the same installation name. </p><br><p>  Another detail here is the order of initialization.  Any code can declare initialization functions using the <code>__attribute__((constructor))</code> compiler magic command (the list of such initializers falls into the <code>__mod_init_func</code> section in the Mach-O file).  These functions are called by dyld when loading the binary in which they are located before calling <code>main()</code> .  Usually, the initializers of each library are executed after the initializers of its dependencies, so each initializer can count on the fact that the dependency libraries are already initialized and ready to go.  Of course, this cannot be guaranteed for circular dependencies;  dyld will execute their initializers in <em>some</em> order.  You can mark dependencies as <em>dependencies up</em> [upward dependencies] to customize this order;  dyld will initialize the libraries that someone has marked as their dependency up, last.  So, to get <code>libfoo</code> initialize after <code>libbar</code> , link them like this: </p><br><pre> <code class="bash hljs">$ ld -o libfoo.dylib foo.o libbar.dylib $ ld -o libbar.dylib bar.o -upward_library libfoo.dylib</code> </pre> <br><p>  To make it more convenient, we in Darling have a CMake function called <a href="https://github.com/darlinghq/darling/blob/master/cmake/darling_lib.cmake"><code>add_circular</code></a> , which takes on all the difficulties and allows us to use it in such a simple and declarative way: </p><br><pre> <code class="cmake hljs"><span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(DYLIB_INSTALL_NAME <span class="hljs-string"><span class="hljs-string">"/usr/lib/system/libdispatch.dylib"</span></span>) add_circular(libdispatch_shared FAT SOURCES <span class="hljs-variable"><span class="hljs-variable">${dispatch_SRCS}</span></span> SIBLINGS system_c system_kernel system_malloc system_blocks system_pthread system_dyld system_duct unwind platform compiler_rt UPWARD objc )</code> </pre> <br><h2 id="dvuhurovnevoe-prostranstvo-imyon-simvolov">  Two-level symbol name space </h2><br><p>  Character tables in Mach-O do not just store the names of characters, they also ‚Äúremember‚Äù which library (or executable file) which character comes from.  In other words, symbol names exist in namespaces, given by which binary defines them;  hence the ‚Äútwo-level namespace] (another level refers to the names of symbols themselves). </p><br><p>  A two-level namespace is <a href="http://mirror.informatimago.com/next/developer.apple.com/releasenotes/DeveloperTools/TwoLevelNamespaces.html">introduced</a> to prevent character name conflicts.  Usually, if several libraries define characters with the same name, you will get an error during linking;  but it may not work if you load the libraries at runtime (for example, plugins) or when the versions of the libraries during linking and runtime are different.  For libraries that use a two-level namespace, this is not a problem ‚Äî it allows several libraries to define characters with the same name without creating conflicts. </p><br><p>  Two-level namespaces can be disabled by returning to using the "flat namespace" (one of the reasons for this is that the use of a two-level namespace implies that each character must be resolved during linking, so flat namespace is required for <code>-undefined_suppress</code> we saw above).  Ld has two flags that allow you to disable the two-level namespace during linking: <code>-flat_namespace</code> , which affects only one Mach-O file, and <code>-force_flat_namespace</code> , which only works with executable files, not libraries, and makes the whole process use a flat namespace.  In addition, you can force dyld to use flat namespace at runtime by setting the environment variable <code>DYLD_FORCE_FLAT_NAMESPACE</code> . </p><br><p>  One feature of using a two-level namespace is that you always have to explicitly link each Mach-O to all the libraries and frameworks on which it depends.  For example, if you link to AppKit, you can't just use Foundation;  You will have to link explicitly to her.  Another feature is that, as the author of a library or framework, you cannot freely move the implementation of the ‚Äúdown‚Äù symbol along a chain of dependencies, as you could get used to doing (for example, you can't just move the code from AppKit to Foundation).  To allow this, Mach-O, ld and dyld have several additional features, namely, <em>sub-libraries</em> , <em>re-export of</em> <em>symbols</em> and <em>meta-symbols</em> . </p><br><h2 id="podbiblioteki">  Sub-libraries </h2><br><p>  Sub-libraries ‚Äî a mechanism that allows one library (called a <em>facade</em> library [facade library] or umbrella library [umbrella library]) to delegate the implementation of a part of its functionality to another library (called its sub-library);  or, if you look at it from the other side, allowing the library to publicly re-export symbols provided by another library. </p><br><p>  The main place where it is used is, again, the <code>libSystem</code> with its sub-libraries, which are located in <code>/usr/lib/system</code> ;  but it can be used with any pair of libraries: </p><br><pre> <code class="bash hljs">$ ld -o libfoo.dylib foo.o -lobjc -sub_library libobjc <span class="hljs-comment"><span class="hljs-comment"># : $ ld -o libfoo.dylib foo.o -reexport-lobjc</span></span></code> </pre> <br><p>  The only thing that affects this compared to just linking to that library is that the command <code>LC_REEXPORT_DYLIB</code> written to the resulting file instead of the usual <code>LC_LOAD_DYLIB</code> (including, the symbols from the library sub-library are <em>not</em> copied to the umbrella library, so it is not even relink if new symbols are later added to the sublibrary).  At runtime, <code>LC_REEXPORT_DYLIB</code> also works similar to <code>LC_LOAD_DYLIB</code> : dyld loads the sub-library and makes its characters available to others (but unlike <code>LC_LOAD_DYLIB</code> , from the point of view of the two-level namespace, characters will come from the umbrella-library). </p><br><p>  What really is different about <code>LC_REEXPORT_DYLIB</code> is what ld does when you link <em>another</em> library to <code>libfoo</code> : instead of just looking for characters in all the object and dylib files that were passed to it, ld will also open and view the re-exported sub-library (in this example <code>libobjc</code> ). </p><br><p>  How does he know where to find her?  The only thing that is stored in <code>libfoo.dylib</code> is the installation name <code>libobjc.dylib</code> , so this is where ld expects to find it.  This means that the library must be installed in its place before it can be used as a sub-library for anything else;  this works fine for system libraries like <code>libobjc</code> , but it can be very inconvenient or completely impossible if you are trying to re-export your own sub-library. </p><br><p>  To solve this problem, ld provides the option <code>-dylib_file</code> , which allows you to specify a different path to dylib for use during linking: </p><br><pre> <code class="bash hljs">$ ld -o libfoo.dylib foo.o -reexport_library /path/to/libsubfoo.dylib $ ld -o libbar.dylib bar.o libfoo.dylib -dylib_file @executable_path/lib/foo/libsubfoo.dylib:/path/to/libsubfoo.dylib</code> </pre> <br><p>  Although <code>libSystem</code> and some other system libraries re-export their sub-libraries, you do not have to use <code>-dylib_file</code> when linking each of the executable files to macOS;  This is because the system libraries are already installed according to their installation name.  But when building Darling on Linux, we have to pass several options <code>-dylib_file</code> (and other common arguments) to each ld call.  We do this using a <a href="https://github.com/darlinghq/darling/blob/master/cmake/use_ld64.cmake">special function</a> that is automatically applied when using <code>add_darling_library</code> , <code>add_darling_executable</code> and others. </p><br><h2 id="pereeksportirovanie-simvolov">  Re-exporting characters </h2><br><p>  Sometimes the library may need to re-export some of the characters ‚Äî but not all at once ‚Äî from another library.  For example, the Core Foundation <code>NSObject</code> , which in recent versions is implemented within the Objective-C runtime, for the sake of compatibility. </p><br><p>  (If you are wondering why <code>NSObject</code> was once at all in the Core Foundation instead of the Foundation, then this is due to the fact that the <em>free conversion</em> [toll-free bridging] is implemented, the ability to directly cast between the corresponding Core Foundation and the Foundation types without additional conversion], requires that private wrapper classes over types from the Core Foundation (for example, <code>__NSCFString</code> ) be implemented in the Core Foundation, and being Objective-C objects, they must inherit from <code>NSObject</code> . another, leaving <code>NSObject</code> with all his heirs in the Foundation and cyclic  The Core Foundation and Foundation are <code>NSObject</code> together, but Apple decided to move these helper private classes along with the <code>NSObject</code> to the Core Foundation, and in Darling we do it the same way to maintain compatibility.) </p><br><p>  You can pass ld a list of characters to be <code>-reexported_symbols_list</code> using its option <code>-reexported_symbols_list</code> : </p><br><pre> <code class="bash hljs">$ <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> .objc_class_name_NSObject &gt; reexport_list.exp $ ld -o CoreFoundation CFFiles.o -lobjc -reexported_symbols_list reexport_list.exp</code> </pre> <br><p>  Although re-exporting <em>some</em> characters sounds very similar to re-exporting <em>all</em> characters, the mechanism by which this is implemented is very different from how sub-libraries work.  No special <code>LC_*_DYLIB</code> -command is used;  instead, a special <em>indirect character is</em> inserted into the name table (denoted by the <code>N_INDIR</code> flag), and it behaves like the character defined in this library.  If the library itself uses this symbol, the <em>second</em> , ‚Äúundefined‚Äù copy of the symbol will <em>appear</em> in the table of names (as it happens without any re-export). </p><br><p>  One important thing to keep in mind when using explicitly re-exporting characters is that you most likely need to re-export characters with different names for different architectures.  Indeed, the name resolution convention of [name mangling convention] for Objective-C and the Objective-C binary interface [ABI] for i386 and x86-64 architectures are different, so on i386 you need to <code>.objc_class_name_NSObject</code> only <code>.objc_class_name_NSObject</code> , and on x86-64 - <code>_OBJC_CLASS_$_NSObject</code> , <code>_OBJC_IVAR_$_NSObject.isa</code> and <code>_OBJC_METACLASS_$_NSObject</code> .  This does not have to be thought of when using sub-libraries, since all the available symbols for each architecture are automatically re-exported there. </p><br><p>  Most of the tools for working with Mach-O are transparently understood with thick, or universal, binaries (Mach-O files containing several sub-Mach-O for several architectures).  Clang can build universal binaries with all the requested architectures, dyld chooses which architecture to load from dylib, looking at which architectures the executable file supports, and tools such as ld, otool and nm work with the architecture corresponding to the computer architecture (i.e. .x86-64), unless explicitly requiring a different architecture with a special flag.  The only thing that still reminds you that several architectures are processed is that when you compile you get errors and warnings twice, once for each architecture. </p><br><p>         .  ld          ,  ,     dylib-           lipo: </p><br><pre> <code class="bash hljs">$ ld -o CF_i386.dylib CFFiles.o -arch i386 -lobjc -reexported_symbols_list reexport_i386.exp $ ld -o CF_x86-64.dylib CFFiles.o -arch x86_64 -lobjc -reexported_symbols_list reexport_x86_64.exp $ lipo -arch i386 CF_i386.dylib -arch x86_64 CF_x86-64.dylib -create -output CoreFoundation</code> </pre> <br><p>  Darling   CMake-   <a href="https://github.com/darlinghq/darling/blob/master/cmake/darling_framework.cmake"><code>add_separated_framework</code></a> ,        lipo,    CMake-   Core Foundation <a href="https://github.com/darlinghq/darling-corefoundation/blob/master/CMakeLists.txt">  </a> : </p><br><pre> <code class="cmake hljs">add_separated_framework(CoreFoundation CURRENT_VERSION SOURCES <span class="hljs-variable"><span class="hljs-variable">${cf_sources}</span></span> VERSION <span class="hljs-string"><span class="hljs-string">"A"</span></span> DEPENDENCIES objc system icucore LINK_FLAGS <span class="hljs-comment"><span class="hljs-comment"># ...    ) set_property(TARGET CoreFoundation_i386 APPEND_STRING PROPERTY LINK_FLAGS " -Wl,-reexported_symbols_list,${CMAKE_CURRENT_SOURCE_DIR}/reexport_i386.exp") set_property(TARGET CoreFoundation_x86_64 APPEND_STRING PROPERTY LINK_FLAGS " -Wl,-reexported_symbols_list,${CMAKE_CURRENT_SOURCE_DIR}/reexport_x86_64.exp")</span></span></code> </pre> <br><h2 id="meta-simvoly"> - </h2><br><p> - ‚Äì   , ,   Apple     ,    . </p><br><p>   Mach-O-       macOS,   ,     <code>-mmacosx-version-min=10.x</code> (    iOS, tvOS, watchOS    ,  Apple      ).     ;   ,         <code>AVAILABLE_MAC_OS_X_VERSION_10_13_AND_LATER</code>      C++  <code>libstdc++</code> (  GNU)  <code>libc++</code> (  LLVM).      ,        Mach-O.  ,   ld   <code>-macosx_version_min</code> (        <code>m</code> ),     Mach-O- <code>LC_VERSION_MIN_MACOSX</code> ( dyld,    ,        ). </p><br><p>    ,  ld  <code>-macosx_version_min</code>   ,  - <em></em> Mach-O- . - ‚Äì  ,     <code>$ld$</code> ,  ld,    ,    :     ,   .      <code>$ld$$$</code> .  <code></code>   <code>os10.5</code>  ,       - ‚Äì  ,        <em></em>   Mach-O-   <em></em> ,   ; <code></code>   <code>add</code> , <code>hide</code> , <code>install_name</code>  <code>compatibility_version</code> ,   ld ,          <code></code> ,  <code></code>          ( )  , . </p><br><p>  <code></code>     , ,  ,             ; ,   -,   <code>libobjc</code> ,   <code>NSObject</code>  ,      macOS: </p><br><pre> <code class="hljs perl">$ld$hide$os10.<span class="hljs-number"><span class="hljs-number">0</span></span>$_OBJC_CLASS_$_NSObject $ld$hide$os10.<span class="hljs-number"><span class="hljs-number">0</span></span>$_OBJC_IVAR_$_NSObject.isa $ld$hide$os10.<span class="hljs-number"><span class="hljs-number">0</span></span>$_OBJC_METACLASS_$_NSObject $ld$hide$os10.<span class="hljs-number"><span class="hljs-number">1</span></span>$_OBJC_CLASS_$_NSObject $ld$hide$os10.<span class="hljs-number"><span class="hljs-number">1</span></span>$_OBJC_IVAR_$_NSObject.isa $ld$hide$os10.<span class="hljs-number"><span class="hljs-number">1</span></span>$_OBJC_METACLASS_$_NSObject $ld$hide$os10.<span class="hljs-number"><span class="hljs-number">2</span></span>$_OBJC_CLASS_$_NSObject $ld$hide$os10.<span class="hljs-number"><span class="hljs-number">2</span></span>$_OBJC_IVAR_$_NSObject.isa $ld$hide$os10.<span class="hljs-number"><span class="hljs-number">2</span></span>$_OBJC_METACLASS_$_NSObject $ld$hide$os10.<span class="hljs-number"><span class="hljs-number">3</span></span>$_OBJC_CLASS_$_NSObject $ld$hide$os10.<span class="hljs-number"><span class="hljs-number">3</span></span>$_OBJC_IVAR_$_NSObject.isa $ld$hide$os10.<span class="hljs-number"><span class="hljs-number">3</span></span>$_OBJC_METACLASS_$_NSObject $ld$hide$os10.<span class="hljs-number"><span class="hljs-number">4</span></span>$_OBJC_CLASS_$_NSObject $ld$hide$os10.<span class="hljs-number"><span class="hljs-number">4</span></span>$_OBJC_IVAR_$_NSObject.isa $ld$hide$os10.<span class="hljs-number"><span class="hljs-number">4</span></span>$_OBJC_METACLASS_$_NSObject $ld$hide$os10.<span class="hljs-number"><span class="hljs-number">5</span></span>$_OBJC_CLASS_$_NSObject $ld$hide$os10.<span class="hljs-number"><span class="hljs-number">5</span></span>$_OBJC_IVAR_$_NSObject.isa $ld$hide$os10.<span class="hljs-number"><span class="hljs-number">5</span></span>$_OBJC_METACLASS_$_NSObject $ld$hide$os10.<span class="hljs-number"><span class="hljs-number">6</span></span>$_OBJC_CLASS_$_NSObject $ld$hide$os10.<span class="hljs-number"><span class="hljs-number">6</span></span>$_OBJC_IVAR_$_NSObject.isa $ld$hide$os10.<span class="hljs-number"><span class="hljs-number">6</span></span>$_OBJC_METACLASS_$_NSObject $ld$hide$os10.<span class="hljs-number"><span class="hljs-number">7</span></span>$_OBJC_CLASS_$_NSObject $ld$hide$os10.<span class="hljs-number"><span class="hljs-number">7</span></span>$_OBJC_IVAR_$_NSObject.isa $ld$hide$os10.<span class="hljs-number"><span class="hljs-number">7</span></span>$_OBJC_METACLASS_$_NSObject</code> </pre> <br><p>           ,   ,   ,          ,   <em></em>   . </p><br><h2 id="rezolvery-simvolov">   </h2><br><p>      dyld ‚Äì   <em> </em> [symbol resolvers],     .    ,  ,          ,  dyld     ,     . </p><br><p>         ld,     .          <a href="https://sourceware.org/binutils/docs/as/Pseudo-Ops.html"></a> <code>.symbol_resolver</code> : </p><br><pre> <code class="hljs mel">;    foo _foo1: movl <span class="hljs-number"><span class="hljs-number">1</span></span>, %eax ret _foo2: movl <span class="hljs-number"><span class="hljs-number">2</span></span>, %eax ret .symbol_resolver _foo ;  -  call _condition jz .ret_foo2 movq _foo1, %rax ret .ret_foo2: movq _foo2, %rax ret ;   ,   _foo  ;   ,     , ;     . .<span class="hljs-keyword"><span class="hljs-keyword">global</span></span> _foo _foo:</code> </pre> <br><p>    C          ,    ,     C: </p><br><pre> <code class="hljs cs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">foo1</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">foo2</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">foo</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-comment"><span class="hljs-comment">//         return 0; } static void *foo_resolver() { __asm__(".symbol_resolver _foo"); return condition() ? &amp;foo1 : &amp;foo2; }</span></span></code> </pre> <br><p> (     <code>_foo</code>   <code>foo</code> ,    Darwin        C,          .  ,      Mach-O    Darling,            ELF-,     .) </p><br><p>   <code>_foo</code>     ,          (           ),  <code>foo()</code>  <code>foo_resolver()</code>     ,  : </p><br><pre> <code class="hljs cpp"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> *</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">foo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ __asm__(<span class="hljs-string"><span class="hljs-string">".symbol_resolver _foo"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> condition() ? &amp;foo1 : &amp;foo2; }</code> </pre> <br><p>   ,    ‚Äì     - ,   <code>foo()</code>   ,      (      <code>int</code> -).  ,  ,       :  <code>dlsym("_foo")</code>    <code>_foo</code> ‚Äì  ,      ,       , ‚Äì         . ,       ,    ,      <code>foo()</code>    <code>_foo</code> . </p><br><p>         .  Apple    <code>libplatform</code>                     : </p><br><pre> <code class="hljs tex">#define _OS_VARIANT_RESOLVER(s, v, ...) <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>__attribute__((visibility(OS_STRINGIFY(v)))) extern void* s(void); <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>void* s(void) { <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>__asm__(".symbol_resolver _" OS_STRINGIFY(s)); <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>__VA_ARGS__ <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>} #define _OS_VARIANT_UPMP_RESOLVER(s, v) <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>_OS_VARIANT_RESOLVER(s, v, <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>uint32_t *_c = (void*)(uintptr_t)_COMM_PAGE_CPU_CAPABILITIES; <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>if (*_c &amp; kUP) { <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>extern void OS_VARIANT(s, up)(void); <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>return &amp;OS_VARIANT(s, up); <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>} else { <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>extern void OS_VARIANT(s, mp)(void); <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>return &amp;OS_VARIANT(s, mp); <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>})</code> </pre> <br><p>    ,  ‚Äì    ‚Äì     (   <code>kUP</code>    ,   <a href="https://wiki.darlinghq.org/documentation:commpage">commpage</a> ), , ,       [spinlock].            ,                . </p><br><p>  Darling          :    Mach-O-   ELF-  Linux,    [host,    ,      Darling] ‚Äì ,   <code>libX11</code>  <code>libcairo</code> . </p><br><p>     ELF- ‚Äì  <a href="https://github.com/darlinghq/darling/tree/master/src/libelfloader"><code>libelfloader</code></a> ,     ELF,        ,   ld-linux,  dyld  Linux,    ld-linux      ELF-.    <code>libelfloader</code>  Mach-O     <code>/usr/lib/darling/libelfloader.dylib</code>   Darwin-chroot-;  ,       Darwin-. </p><br><p>     ,  <code>libelfloader</code>  <em></em>     Mach-O  ELF.    ( <code>_elfcalls</code> ),  <a href=""> </a> <code>libSystem</code> ,  Darwin      ,        ELF-  Linux. ¬´¬ª Darwin  Linux         ‚Äì   ,      C ( <code>libSystem_c</code>  <code>glibc</code> , ). </p><br><p>     ELF-   Darwin,   - <code>libelfloader</code> API  <code>_elfcalls-&gt;dlsym_fatal(_elfcalls-&gt;dlopen_fatal("libX11.so"), "XOpenDisplay")</code> . ,       <a href="">wrapgen</a> ,   ELF-    ,       ,   The Cocotron ‚Äì          Linux ‚Äì   .   wrapgen  ELF- (, <code>libX11.so</code> ),           : </p><br><pre> <code class="hljs delphi">#include &lt;elfcalls.h&gt; extern struct elf_calls* _elfcalls; <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> void* lib_handle; __attribute__((<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">constructor</span></span></span><span class="hljs-function">)) </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">static</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">initializer</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-comment">{ lib_handle = _elfcalls-&gt;dlopen_fatal("libX11.so"); }</span></span></span><span class="hljs-function"> __</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">attribute__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">((</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">destructor</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">) </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">static</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">destructor</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-comment">{ _elfcalls-&gt;dlclose_fatal(lib_handle); }</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">void</span></span></span><span class="hljs-function">* </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">XOpenDisplay</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-comment">{ __asm__(".symbol_resolver _XOpenDisplay"); return _elfcalls-&gt;dlsym_fatal(lib_handle, "XOpenDisplay"); }</span></span></span></span></code> </pre> <br><p>       Mach-O-     <code>/usr/lib/native/libX11.dylib</code> ,   Mach-O-     ,     <em></em> <code>libX11.so</code> ,    Mach-O.  ,    CMake-   <a href="https://github.com/darlinghq/darling/blob/master/cmake/wrap_elf.cmake"><code>wrap_elf</code></a> ,    wrapgen,  Mach-O-     <code>/usr/lib/native</code> :   <a href="https://github.com/darlinghq/darling/blob/master/src/native/CMakeLists.txt"></a> <code>wrap_elf(X11 libX11.so)</code>      <code>libX11</code> ,         Mach-O-. </p><br><p>       Linux        <em></em> .    ,   Darling   ,      Darwin    Linux,     .  Darling ‚Äì     Darwin ( ,  Darwin); , , ,           Darwin,   <code>libSystem</code> , dyld, XNU  launchd,        ,     ,   commpage.       ,   <code>libsystem_kernel</code> ,    ,         Linux,   ¬´¬ª   Darwin- ‚Äì Linux  GNU/Linux   .          Linux-    ,   Linux   (  X server)      ,     [witnessing a magic trick] ‚Äì     <code>libelfloader</code> ,    wrapgen, ,  .   ,    ,   , ,  ,   . </p><br><h2 id="poryadok-simvolov">   </h2><br><p>   -   ,      Mach-O-,    ld      . ( ,     ‚Äì <em></em> ,  Apple,  ,  .) </p><br><p>   ,   ,     ,      ,  <em> </em> [order file],     ld   : </p><br><pre> <code class="bash hljs">$ ld -o libfoo.dylib foo.o -order_file foo.order</code> </pre> <br><p>     <code>-reexported_symbols_list</code> ,     , <code>-order_file</code>  ,    : </p><br><pre> <code class="hljs 1c">symbol1 symbol2 <span class="hljs-meta"><span class="hljs-meta">#  . # #    ,     , # </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword"></span></span></span><span class="hljs-meta">   (   C)  #        . foo.o: _static_function3 #  ,   ,     #     ;    # </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword"></span></span></span><span class="hljs-meta">       #  lipo,   </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword"></span></span></span><span class="hljs-meta">  # . i386:symbol4</span></span></code> </pre> <br><p>   ( ,    ,  )         ¬´¬ª        .         ,       ,    ,        ,       <code>.subsections_via_symbols</code> ,    Mach-O-   ,     , ,   ,   . </p><br><p>   ,   Apple    ‚Äì     <code>libdispatch</code> . <code>libdispatch</code>     , ¬´OS object¬ª,     ,       .          Objective-C,  <code>libdispatch</code>   <em> </em> (    Core Foundation),     <code>libdispatch</code> -  Objective-C-    ,     Objective-C-.  ,      <code>dispatch_data_t</code>  <code>NSData *</code>      API  Cocoa (    ). </p><br><p>   <a href=""></a>     ,    ,   Objective-C-   <em>OS object vtables</em>     .   ,    <a href=""><code>DISPATCH_OBJECT_TFB</code></a> , ,   Objective-C     <code>libdispatch</code> -,    <code>isa</code>  <code>vtable</code> - <code>dispatch_object</code>  <code>object</code> : </p><br><pre> <code class="hljs tex">#define DISPATCH_OBJECT_TFB(f, o, ...) <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>if (slowpath((uintptr_t)((o)._os_obj-&gt;os_obj_isa) &amp; 1) || <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>slowpath((Class)((o)._os_obj-&gt;os_obj_isa) &lt; <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>(Class)OS_OBJECT_VTABLE(dispatch_object)) || <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>slowpath((Class)((o)._os_obj-&gt;os_obj_isa) &gt;= <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>(Class)OS_OBJECT_VTABLE(object))) { <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>return f((o), ##__VA_ARGS__); <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>}</code> </pre> <br><p> <a href="https://github.com/darlinghq/darling-libdispatch/blob/master/xcodeconfig/libdispatch.order">  </a> ,   ,     <code>libdispatch</code> . </p><br><h2 id="podmena-simvolov">   </h2><br><p>       (   ) ‚Äì    <code>DYLD_INSERT_LIBRARIES</code> ,  dyld     Mach-O-          . ,         ,    ,          <code>DYLD_FORCE_FLAT_NAMESPACE</code> . </p><br><p>  ,      ,    <em></em> -  .     (   ),     <code>dlsym()</code>   <code>RTLD_NEXT</code> ,  : </p><br><pre> <code class="hljs lua">int <span class="hljs-built_in"><span class="hljs-built_in">open</span></span>(const <span class="hljs-built_in"><span class="hljs-built_in">char</span></span>* <span class="hljs-built_in"><span class="hljs-built_in">path</span></span>, int flags, mode_t mode) { printf(<span class="hljs-string"><span class="hljs-string">" open(%s)\n"</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">path</span></span>); // <span class="hljs-string"><span class="hljs-string">"  "</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (strcmp(<span class="hljs-built_in"><span class="hljs-built_in">path</span></span>, <span class="hljs-string"><span class="hljs-string">"foo"</span></span>) == <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-built_in"><span class="hljs-built_in">path</span></span> = <span class="hljs-string"><span class="hljs-string">"bar"</span></span>; } int (*original_open)(const <span class="hljs-built_in"><span class="hljs-built_in">char</span></span> *, int, mode_t); original_open = dlsym(RTLD_NEXT, <span class="hljs-string"><span class="hljs-string">"open"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> original_open(<span class="hljs-built_in"><span class="hljs-built_in">path</span></span>, flags, mode); }</code> </pre> <br><p>    , dyld     ,  <em>dyld-</em> [dyld iterposing].      Mach-O-   <code>__interpose</code> , dyld      ,    ‚Äì    . </p><br><p>   ,       ‚Äì ,        <code>__interpose</code> ‚Äì    <em> </em> [implicit interposing].   ,  <code>__interpose</code>       (     ),  dyld      .  , dyld- <em></em>       ,      - .  , dyld  ,      -    ,     - (   Mach-O-): </p><br><pre> <code class="hljs pgsql">static <span class="hljs-type"><span class="hljs-type">int</span></span> my_open(const <span class="hljs-type"><span class="hljs-type">char</span></span>* <span class="hljs-type"><span class="hljs-type">path</span></span>, <span class="hljs-type"><span class="hljs-type">int</span></span> flags, mode_t mode) { printf("Called open(%s)\n", <span class="hljs-type"><span class="hljs-type">path</span></span>); // "  " <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (strcmp(<span class="hljs-type"><span class="hljs-type">path</span></span>, "foo") == <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-type"><span class="hljs-type">path</span></span> = "bar"; } //    ,    //  <span class="hljs-keyword"><span class="hljs-keyword">open</span></span>()      my_open(). <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">open</span></span>(<span class="hljs-type"><span class="hljs-type">path</span></span>, flags, mode); } //      __interpose __attribute__ ((section ("__DATA,__interpose"))) static struct { <span class="hljs-type"><span class="hljs-type">void</span></span> *replacement, *replacee; } replace_pair = { my_open, <span class="hljs-keyword"><span class="hljs-keyword">open</span></span> };</code> </pre> <br><p>  ,      ‚Äì          ‚Äì       Mach-O-  -        [relocation table].        ,   dyld      (    ),     . </p><br><p> ,      <code>dyld_dynamic_interpose</code> ,       : </p><br><pre> <code class="hljs cpp"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> *replacement, *replacee; } replacement_tuple; <span class="hljs-keyword"><span class="hljs-keyword">extern</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">mach_header</span></span></span><span class="hljs-class"> __</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dso_handle</span></span></span><span class="hljs-class">;</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">extern</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">dyld_dynamic_interpose</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> struct mach_header*, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> replacement_tuple replacements[], </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">size_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> count)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">interpose</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ replacement_tuple replace_pair = { my_open, open }; dyld_dynamic_interpose(&amp;__dso_handle, &amp;replace_pair, <span class="hljs-number"><span class="hljs-number">1</span></span>); }</code> </pre> <br><p> ,     ,         ,     . </p><br><p> <code>DYLD_INSERT_LIBRARIES</code>  dyld-         Objective-C,   C,  - ,       Objective-C- ( <code>IMP</code> ),    Objective-C       ,   <em>method swizzling</em> ( <em>isa swizzling</em> ). </p><br><p>      Darling     xtrace,       . </p><br><p>   Darwin    Darwin (    ‚Äì   BSD    Mach- [Mach traps]).        <code>libsystem_kernel</code> ,   ABI     userspace.  Darling,    <code>libsystem_kernel</code> <a href="https://github.com/darlinghq/darling/tree/master/src/kernel/emulation/linux"></a>    Darwin     Linux    <a href="https://github.com/darlinghq/darling-newlkm">Darling-Mach</a> ,    Linux,  Mach   . </p><br><p> strace,       Linux,    ,  Linux-;  strace    Darwin,   Darling,     Linux,       Darwin (    Linux,    ELF- ).   ,    Darwin  Linux      ,   ,    Darwin   ‚Äì  ,       ‚Äì   . </p><br><p>        , <a href="https://github.com/darlinghq/darling/tree/master/src/xtrace">xtrace</a> .    strace,           ,   <code>ptrace()</code> API, xtrace          .    <a href="https://github.com/darlinghq/darling/blob/master/src/xtrace/xtrace"></a> <code>DYLD_INSERT_LIBRARIES=/usr/lib/darling/libxtrace.dylib</code> ,   - [trampoline functions]       ,        .  xtrace   ,  strace,       ,       ,   : </p><br><pre> <code class="bash hljs">Darling [~]$ xtrace arch &lt;......&gt; [223] mach_timebase_info_trap (...) [223] mach_timebase_info_trap () -&gt; KERN_SUCCESS [223] issetugid (...) [223] issetugid () -&gt; 0 [223] host_self_trap () [223] host_self_trap () -&gt; port right 2563 [223] mach_msg_trap (...) [223] mach_msg_trap () -&gt; KERN_SUCCESS [223] _kernelrpc_mach_port_deallocate_trap (task=2563, name=-6) [223] _kernelrpc_mach_port_deallocate_trap () -&gt; KERN_SUCCESS [223] ioctl (...) [223] ioctl () -&gt; 0 [223] fstat64 (...) [223] fstat64 () -&gt; 0 [223] ioctl (...) [223] ioctl () -&gt; 0 [223] write_nocancel (...) i386 [223] write_nocancel () -&gt; 5 [223] <span class="hljs-built_in"><span class="hljs-built_in">exit</span></span> (...)</code> </pre> <br><p>    ,       BSD  Mach.   ,   <code>write()</code>  <code>exit()</code> ,     Linux-,       . ,  Mach-   <code>ioctl</code> -   <code>/dev/mach</code> ,     ;   BSD- <code>ioctl()</code> ,   stdio   ,      stdin  stdout (    tty) <a href=""></a>     <code>readlink()</code>    <code>/proc/self/fd/</code> . </p><br><hr><br><p>          Mach-O,        ,     dyld.      : </p><br><ul><li>    ,       ,     dylib,  ,  <em> </em>  . ld       <code>-bundle_loader</code> . </li><li>   ,  <code>LC_LOAD_DYLIB</code> , <code>LC_REEXPORT_DYLIB</code>  <code>LC_DYLIB_ID</code>    ,   <em></em>  <em></em>  [compatibility version, current version] ,    ‚Äì    ,    .              ld <code>-current_version</code>  <code>-compatibility_version</code> , .     dyld ,       ,    ,     . </li><li>      ,  Mach-O     <em>  </em> [source version].     , <code>LC_SOURCE_VERSION</code> .        ld <code>-source_version</code> ,    ,       Mach-O- ‚Äì    <code>-add_source_version</code>  <code>-no_source_version</code> . </li><li>    <code>Info.plist</code>   <code>__info_plist</code> Mach-O-    [codesign] ,           <code>Info.plist</code> .    <a href="">ad-hoc </a>  Security.framework,  ,      <code>CFBundle</code> / <code>NSBundle</code> API,       ,     ,  . </li></ul><br><p> ,  ,       , ld  dyld    ,    ¬´ ¬ª,   <code>libSystem</code> ,  -.            <code>/usr/lib/</code> . </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/417507/">https://habr.com/ru/post/417507/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../417497/index.html">4 years of Data Science at the Schibsted Media Group</a></li>
<li><a href="../417499/index.html">"Yandex" began work on creating its own system of "smart home"</a></li>
<li><a href="../417501/index.html">Layfkhaki manufacturing double-layer boards (LUT)</a></li>
<li><a href="../417503/index.html">What a web developer should remember to do everything on SEO</a></li>
<li><a href="../417505/index.html">Intel has released fixes for new ME firmware vulnerabilities</a></li>
<li><a href="../417509/index.html">Kubernetes tips & tricks: speeding up the bootstrap of large databases</a></li>
<li><a href="../417511/index.html">Intel acquired eASIC - developer of "structural ASIC"</a></li>
<li><a href="../417513/index.html">Analogs in Python and JavaScript. Part two</a></li>
<li><a href="../417515/index.html">What I learned by creating 100 games in 5 years</a></li>
<li><a href="../417517/index.html">Intel history pages. Photo chronicle and quiz</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>