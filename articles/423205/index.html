<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Storage project on MS SQL Server, integration with 1C 7.7 and development automation in SSDT</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Time flows and soon there will be almost nothing left from this development, but I still couldn‚Äôt have time to describe it. 



 It will be about a fe...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Storage project on MS SQL Server, integration with 1C 7.7 and development automation in SSDT</h1><div class="post__text post__text-html js-mediator-article">  Time flows and soon there will be almost nothing left from this development, but I still couldn‚Äôt have time to describe it. <br><br><img src="https://habrastorage.org/webt/fi/5s/if/fi5siftwc5fvceqqsjgxfnqubum.png"><br><br>  It will be about a federal company with a large number of branches and sub-branches.  But, as usual, it all started a long time ago with one small shop.  Over the years, there was a fairly rapid and spontaneous development, branches, divisions and other offices appeared, and the IT infrastructure was not given due attention at that time, and this is also a frequent phenomenon.  Of course, 1C77 was used everywhere, without any replication or scaling, therefore, you know, in the end they came to the conclusion that the frankenstein was spawned with tentacles tied with electrical tape ‚Äî in each branch there was an autonomous mutant that shared with the central base in the "knee-length" mode, only a few directories, without which, well, there was no way at all, and the rest is autonomous.  For a while they were content with copies (dozens of them!) Of branch bases in the central office, but the data in them lagged behind for several days. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The reality requires receiving information more quickly and flexibly, and something else needs to be done about it.  To change from one accounting system to another at such scales is still a swamp.  Therefore, it was decided to make a data warehouse (HH) into which information would flow from different databases, so that later other services and analytical system could receive data in the form of cubes, SSRS reports and protocols from this HD. <br><br>  Looking ahead, I will say that the transition to a new accounting system has almost happened and most of the project described here will be cut out as soon as unnecessary.  It is a pity, of course, but nothing can be done. <br><br>  This is followed by a long article, but before you begin to read, let me say that in no case do I issue this decision as a standard, but someone may find something useful in it. <br><a name="habracut"></a><br>  I will start with a general approach to the project, for which SSDT was chosen as the development environment, with the subsequent publication of the project in Git.  I think that today there are enough various articles and tutorials describing the strengths of this tool.  But there are a few points whose problem lies outside this environment. <br><br><h4>  Storage of transfers and database versions </h4><br>  With regards to versions and listings, the project requirements implied: <br><br><ul><li>  Ease of editing and tracking changes in the database version within the project </li><li>  Ease of viewing the database version via SSMS for admins </li><li>  Saving history of version changes in the database itself (who performed the deployment and when) </li><li>  Storage in a project enumerations </li><li>  Ease of editing and tracking changes in listings </li><li>  Blocking the database deployment over the existing one if there was no version increment </li><li>  Installing a new version, recording history, enumeration and restructuring should be performed in one transaction and completely rolled back in case of failure at any of the stages. </li></ul><br>  Since  Since enumerations often store logic and are basic values, without which adding records to other tables becomes impossible (due to FK foreign keys), in fact they are part of the database structure, along with metadata.  Therefore, changing any element of the enumeration leads to an increment in the database version and, together with this version, the records must be updated to be updated during deployment. <br><br>  I think all the advantages of deployment blocking without version increment are obvious, one of which is the impossibility of re-launching the publication script if it has already been successfully completed earlier. <br><br>  Although the network often suggests using only the major version (without fractions) in the network, we decided to use versions in XY format, where Y is a patch, when a typo was corrected in the description of the table, column, the name of the enumeration element or something else small, type of adding a comment to a stored procedure, etc.  In all other cases, the major version is increased. <br><br>  Perhaps for someone there is nothing <i>like this</i> and everything is obvious.  But in my time, it took quite a few nerves and forces to internal disputes about how to store transfers in the database project, so that it would be Fengshui ( <i>in accordance with my idea of ‚Äã‚Äãit</i> ) and so that it was convenient to work with them, at the same time minimizing the likelihood of errors. <br><br>  With enumerations, in general, everything is simple - we create a PostDeploy file in the project and write code in it to populate the tables.  With merdzhami or trunks - this is someone as you like.  We chose to merge, first checking whether the number of records in the target table does not exceed the number of records that is in the source (project).  If it exceeds, then an exception is called to draw attention to it, for it is strange.  Why is there less records in the source?  Because one extra?  Why should I?  And if the database already has links to it?  Although we use foreign keys (FK), which will not allow deleting an entry if there are links to it, they still preferred to leave this option.  As a result, PostDeploy has turned into an unreadable sheet, because for each table being filled, in addition to the values ‚Äã‚Äãthemselves, there is also a verification code, merge, and so on. <br><br>  However, if you use PostDeploy in SQLCMD mode, then you can put code blocks into separate files, and as a result only a structured list of file names remains to fill the enumerations in PostDeploy. <br><br>  With versions of the database there are nuances.  On the Internet, there have long been debates about where to store the version of the database, how it should look, and in general, should it be stored somewhere?  Suppose we decided that we need it, where in the project to store it?  Somewhere in the wilds of the PostDeploy script or put it in a variable that is declared in the first line of the script? <br><br>  In my opinion - neither one nor the other.  It is more convenient when it is stored in a separate file and there is nothing else there. <br><br>  Someone will say - in the properties of the project there is the same dacpac and in it you can set the version.  Of course, you can even pull up this version in your script, as described <a href="https://www.oraylis.de/blog/agile-bi-tools-database-versioning-with-ssdt-1">here</a> , but this is inconvenient - to change the version of the database, you need to go somewhere far, click a bunch of buttons.  I do not understand the logic of the microsoftware - they hid it in a far corner, along with such database parameters as sorting, compatibility level, etc., because the database version changes as often as the sorting parameters, right?  When ongoing development is underway, the version grows with each new deployment, and the convenience of tracking changes also plays an important role, because when the modified file with a clear name is lit is one thing, and when the project file is .sqlproj, in which there are many lines in the XML format , and among them, somewhere in the center of the line, one changed digit is highlighted, somehow not very much. <br><br><img src="https://habrastorage.org/webt/bg/i3/48/bgi3485rgezdefuaami2weappqy.png"><br><br>  That's better <br><br><img src="https://habrastorage.org/webt/ro/9y/ld/ro9yldaaeoqcmubpi42adq-so50.png"><br><br>  However, perhaps this is only my cockroaches and should not pay attention to them. <br><br>  Now the question is: where to store this version already in the deployed database.  Again, it seems that dacpac does it beautifully - it writes everything to the system labels, but to see the version, you need to execute the request (or can it be otherwise, but I just do not know how to prepare them? It seems that in older versions of SSMS there was an interface for this, but now not) <br><br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> msdb.dbo.sysdac_instances_internal</code> </pre> <br>  for the administrator (and not only) it is not very convenient.  It is much more logical that the version would be displayed directly in the properties of the database itself. <br><br><img src="https://habrastorage.org/webt/ed/ax/le/edaxle3ic1lfwvaeuhhhphmrulo.png"><br><br>  Or not? <br><br>  To do this, you need to add a file to the project, which is included in the construction that describes the extended properties. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">EXECUTE</span></span> sp_addextendedproperty @<span class="hljs-keyword"><span class="hljs-keyword">name</span></span> = N<span class="hljs-string"><span class="hljs-string">'DeployerName'</span></span>, @<span class="hljs-keyword"><span class="hljs-keyword">value</span></span> = <span class="hljs-string"><span class="hljs-string">''</span></span>; GO <span class="hljs-keyword"><span class="hljs-keyword">EXECUTE</span></span> sp_addextendedproperty @<span class="hljs-keyword"><span class="hljs-keyword">name</span></span> = N<span class="hljs-string"><span class="hljs-string">'DeploymentDate'</span></span>, @<span class="hljs-keyword"><span class="hljs-keyword">value</span></span> = <span class="hljs-string"><span class="hljs-string">''</span></span>; GO <span class="hljs-keyword"><span class="hljs-keyword">EXECUTE</span></span> sp_addextendedproperty @<span class="hljs-keyword"><span class="hljs-keyword">name</span></span> = N<span class="hljs-string"><span class="hljs-string">'DBVersion'</span></span>, @<span class="hljs-keyword"><span class="hljs-keyword">value</span></span> = <span class="hljs-string"><span class="hljs-string">''</span></span>;</code> </pre> <br>  Yes, they are empty, and it looks ugly in the publication script, but it is impossible without them.  If they are not described in the project, and they are in the database, the studio will try to remove them every time it is deployed.  (There were many attempts to circumvent this succinctly and without unnecessary options during deployment, but to no avail) <br><br>  Values ‚Äã‚Äãfor them will be set in the PostDeploy script. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> @username <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">256</span></span>) = suser_sname() ,@curdatetime <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">20</span></span>) = <span class="hljs-keyword"><span class="hljs-keyword">format</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">getdate</span></span>(),<span class="hljs-string"><span class="hljs-string">'dd.MM.yyyy HH:mm:ss'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">EXECUTE</span></span> sp_updateextendedproperty @<span class="hljs-keyword"><span class="hljs-keyword">name</span></span> = N<span class="hljs-string"><span class="hljs-string">'DeployerName'</span></span>, @<span class="hljs-keyword"><span class="hljs-keyword">value</span></span> = @username; <span class="hljs-keyword"><span class="hljs-keyword">EXECUTE</span></span> sp_updateextendedproperty @<span class="hljs-keyword"><span class="hljs-keyword">name</span></span> = N<span class="hljs-string"><span class="hljs-string">'DBVersion'</span></span>, @<span class="hljs-keyword"><span class="hljs-keyword">value</span></span> = [$(DBVersion)]; <span class="hljs-keyword"><span class="hljs-keyword">EXECUTE</span></span> sp_updateextendedproperty @<span class="hljs-keyword"><span class="hljs-keyword">name</span></span> = N<span class="hljs-string"><span class="hljs-string">'DeploymentDate'</span></span>, @<span class="hljs-keyword"><span class="hljs-keyword">value</span></span> = @curdatetime;</code> </pre> <br>  <code>sp_updateextendedproperty</code> without any checks, because by the time the block starts from PostDeploy, all properties have already been created if they were not. <br><br>  Well, it would be nice to keep history, on the subject of who and when deployed the database. <br><br>  You can deploy metadata changes in the transaction using standard tools by selecting the <b>Enable transaction scripts</b> check box in the <b>Advanced Publishing Settings</b> window.  But this flag does not affect scripts (Pre / Post) deploy and they continue to run without a transaction.  Of course, nothing prevents you from starting a transaction at the beginning of the PostDeploy script, however, this will be a separate transaction from the metadata, and our task is to roll back the metadata changes if an exception has occurred in PostDeploy. <br><br>  The solution is simple - start a transaction in PreDeploy, and fix it in PostDeploy, and do not use any checkboxes in the publishing parameters for this purpose. <br><br>  To make the database version convenient to store in the project and to register it in the desired places during deployment, you can resort to the SQLCMD variables.  However, I do not want to store the version somewhere in the wilds of the code, I want it to be on the surface. <br><br><img src="https://habrastorage.org/webt/yg/qm/o9/ygqmo9wf5pnwnyx7kfnumsflps8.png"><br><br>  To place the base version in a separate file at the project level and manage the version from there, add the following block to .sqlproj: <br><br><pre> <code class="xml hljs"> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Target</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"BeforeBuild"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ReadLinesFromFile</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">File</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"$(ProjectDir)\Properties\DBVersion"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Output</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">TaskParameter</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Lines"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">PropertyName</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"ExtDBVersion"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ReadLinesFromFile</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">WriteLinesToFile</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">File</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"$(ProjectDir)\\SetPreDepVarsTmp.sql"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Lines</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">":setvar DBVersion $(ExtDBVersion)"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Overwrite</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Target</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Target</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  This is an instruction for MSBuild to read a string from a file before construction and to create a temporary file based on the read data.  MSBuild will create a temporary file <code>SetPreDepVarsTmp.sql</code> , in which it will <code>:setvar DBVersion $(ExtDBVersion)</code> line <code>:setvar DBVersion $(ExtDBVersion)</code> , where <code>$(ExtDBVersion)</code> is the value read from our file storing the version of the database. <br><br>  After such manipulations, you can refer to this temporary file from the PreDeploy script and start the global transaction in it: <br><br><pre> <code class="sql hljs">:r .\SetPreDepVarsTmp.sql go :r ".\BeginTransaction.sql"</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">Intermediate version</b> <div class="spoiler_text">  Initially, in the ExtendedProperties.sql file, not empty values ‚Äã‚Äãwere assigned, but values ‚Äã‚Äãfrom variables <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">EXECUTE</span></span> sp_addextendedproperty @<span class="hljs-keyword"><span class="hljs-keyword">name</span></span> = N<span class="hljs-string"><span class="hljs-string">'DeployerName'</span></span>, @<span class="hljs-keyword"><span class="hljs-keyword">value</span></span> = [$(DeployerName)]; GO <span class="hljs-keyword"><span class="hljs-keyword">EXECUTE</span></span> sp_addextendedproperty @<span class="hljs-keyword"><span class="hljs-keyword">name</span></span> = N<span class="hljs-string"><span class="hljs-string">'DeploymentDate'</span></span>, @<span class="hljs-keyword"><span class="hljs-keyword">value</span></span> = [$(DeploymentDate)]; GO <span class="hljs-keyword"><span class="hljs-keyword">EXECUTE</span></span> sp_addextendedproperty @<span class="hljs-keyword"><span class="hljs-keyword">name</span></span> = N<span class="hljs-string"><span class="hljs-string">'DBVersion'</span></span>, @<span class="hljs-keyword"><span class="hljs-keyword">value</span></span> = [$(DBVersion)];</code> </pre> <br>  The variables, in turn, were set in the SetPreDepVarsTmp.sql file automatically by MSBuild like this: <br><br><pre> <code class="xml hljs"> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">PropertyGroup</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">CurrentDateTime</span></span></span><span class="hljs-tag">&gt;</span></span>$([System.DateTime]::Now.ToString(dd.MM.yyyy HH:mm:ss))<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">CurrentDateTime</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">PropertyGroup</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">PropertyGroup</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">NewLine</span></span></span><span class="hljs-tag">&gt;</span></span> -- <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">NewLine</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">PropertyGroup</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Target</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"BeforeBuild"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ReadLinesFromFile</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">File</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"$(ProjectDir)\DBVersion"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Output</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">TaskParameter</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Lines"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">PropertyName</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"ExtDBVersion"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ReadLinesFromFile</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">WriteLinesToFile</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">File</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"$(ProjectDir)\SetPreDepVarsTmp.sql"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Lines</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">":setvar DBVersion $(ExtDBVersion)$(NewLine):setvar DeploymentDate "</span></span></span><span class="hljs-tag">$(</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">CurrentDateTime</span></span></span><span class="hljs-tag">)"$(</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">NewLine</span></span></span><span class="hljs-tag">)</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">:setvar</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">DeploymentUser</span></span></span><span class="hljs-tag"> $(</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">UserDomain</span></span></span><span class="hljs-tag">)\$(</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">UserName</span></span></span><span class="hljs-tag">)" </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Overwrite</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Target</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  With this approach, you do not need to reinstall these properties in PostDeploy, but the trouble is that SetPreDepVarsTmp.sql contained static values ‚Äã‚Äãand if the publishing script was generated now, but deployed after an hour, or even worse, the next day (the developer re-tested it for a long time) visually, for example), the date of publication, written in the properties, will differ from the actual date of publication and does not coincide with the date in history. <br></div></div><br><div class="spoiler">  <b class="spoiler_title">Contents of the BeginTransaction.sql file</b> <div class="spoiler_text">  In essence, this is just copy-paste from the standard transaction start block that the studio generates when the <b>Enable transaction scripts</b> checkbox is <b>checked</b> , but we use it in our own way.  In the script, only the temporary table name was changed from <code>#tmpErrors</code> to <code>#tmpErrorsManual</code> , so that there is no name conflict if someone turns on the checkbox. <br><br><pre> <code class="sql hljs">IF (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> OBJECT_ID(<span class="hljs-string"><span class="hljs-string">'tempdb..#tmpErrors'</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-comment"><span class="hljs-comment">#tmpErrorsManual GO CREATE TABLE #tmpErrorsManual (Error int) GO SET XACT_ABORT ON GO SET TRANSACTION ISOLATION LEVEL READ COMMITTED GO BEGIN TRANSACTION GO</span></span></code> </pre> <br></div></div><br><div class="spoiler">  <b class="spoiler_title">PostDeploy Script</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> @TableName <span class="hljs-built_in"><span class="hljs-built_in">VarChar</span></span>(<span class="hljs-number"><span class="hljs-number">255</span></span>) = <span class="hljs-literal"><span class="hljs-literal">null</span></span> <span class="hljs-comment"><span class="hljs-comment">--        if $(SkipEnumDeploy) = 0 begin PRINT N' ...' :r ..\\EnumTable1.sql end --   PRINT N'  ...'; declare @username varchar(256) = suser_sname() , @curdatetime varchar(20) = format(getdate(),'dd.MM.yyyy HH:mm:ss') if $(DBVersion) &gt; (select isnull( MAX( DBVersion),0) from zDBVersionHistory) begin insert into zDBVersionHistory( DBVersion, DeploymentDate, DeployerName) values ($(DBVersion),@curdatetime,@username) EXECUTE sp_updateextendedproperty @name = N'DeployerName', @value = @username; EXECUTE sp_updateextendedproperty @name = N'DBVersion', @value = [$(DBVersion)]; EXECUTE sp_updateextendedproperty @name = N'DeploymentDate', @value = @curdatetime; end else begin RaisError ( N':          ,  .      ,        DBVersion          .' , 16 , 1 ) WITH SETERROR; end GO :r ".\CaptureTransactionError.sql" :r ".\CommitTransaction.sql"</span></span></code> </pre> <br>  The variable SkipEnumDeploy, as has already become clear, allows you to skip the update process for transfers, this can be useful for minor cosmetic changes.  Although, from the point of view of religion, this may be wrong, but at the design stage it definitely comes in handy. <br></div></div><br>  The <code>CaptureTransactionError.sql</code> and <code>CommitTransaction.sql</code> files <code>CaptureTransactionError.sql</code> also copy-paste (with minor edits) from the standard transaction operation algorithm that the studio generates when the above-described check box is set, and which we now reproduce on our own. <br><br><div class="spoiler">  <b class="spoiler_title">Content CaptureTransactionError.sql</b> <div class="spoiler_text"><pre> <code class="sql hljs">IF @@ERROR &lt;&gt; 0 AND @@TRANCOUNT &gt; 0 <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ROLLBACK</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> @@TRANCOUNT = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> <span class="hljs-comment"><span class="hljs-comment">#tmpErrorsManual (Error) VALUES (1); BEGIN TRANSACTION; END</span></span></code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">Content CommitTransaction.sql</b> <div class="spoiler_text"><pre> <code class="sql hljs">IF EXISTS (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> <span class="hljs-comment"><span class="hljs-comment">#tmpErrorsManual) ROLLBACK TRANSACTION GO DROP TABLE #tmpErrorsManual GO IF @@TRANCOUNT&gt;0 BEGIN PRINT N'     .' COMMIT TRANSACTION END ELSE RaisError ( N'    .' , 16 , 1 );</span></span></code> </pre> <br></div></div><br><div class="spoiler">  <b class="spoiler_title">Contents EnumTable1.sql</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">set</span></span> @TableName = N<span class="hljs-string"><span class="hljs-string">'Table1'</span></span> PRINT N<span class="hljs-string"><span class="hljs-string">'  '</span></span>+@TableName+<span class="hljs-string"><span class="hljs-string">'...'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> try <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> nocount <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> <span class="hljs-keyword"><span class="hljs-keyword">drop</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">exists</span></span> <span class="hljs-comment"><span class="hljs-comment">#tmpEnums; select * into #tmpEnums from (values ( 0, ' 1') , ( 1, ' 2') , ( 2, ' 3') ) as tmp ( Id , Title ) set nocount off --         If ((select count(*) from Table1) &gt; (select count(*) from #tmpEnums)) begin RaisError ( N':      ,   .' , 0 , 1 ) WITH SETERROR; end set Identity_insert Table1 on Merge Table1 as target Using ( select * from #tmpEnums except select * from dbo.Table1 ) as source on target.Id = source.Id when matched then update set target.Title = source.Title when not matched by target then insert ( Id , Title ) values ( source.Id , source.Title ); set Identity_insert Table1 off drop table if exists #tmpEnums; END TRY begin catch IF @@trancount &gt; 0 ROLLBACK TRANSACTION set @Error_Message = Error_Message(); RaisError ( N': %s.' , 0 , 1 , @Error_Message ) WITH SETERROR; end catch :r "..\\CaptureTransactionError.sql"</span></span></code> </pre> <br></div></div><br>  When deploying <code>Publish</code> script will have the following structure <br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">-- PreDeploy ----:setvar DBVersion "10.6" --   ,     DBVersion ----   --    ,           -- PostDeploy ----  ----   ----  </span></span></code> </pre> <br><br>  Ideally, of course, I would like the version to be displayed at the time of publication. <br><img src="https://habrastorage.org/webt/8a/9w/o2/8a9wo2o5lemfglm1ru1kt5yntdm.png"><br><br>  But it is impossible to pull the value from the file into this window, although MSBuild reads it and places it in the ExtDBVersion property using additional instructions in the .sqlproj file, as in the example above, but the design <br><br><pre> <code class="xml hljs"> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">SqlCmdVariable</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Include</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"DBVersion"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">DefaultValue</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">DefaultValue</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Value</span></span></span><span class="hljs-tag">&gt;</span></span>$(ExtDBVersion)<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Value</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">SqlCmdVariable</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  does not roll. <br><br>  The developers of the sequel in their <a href="https://blogs.msdn.microsoft.com/gertd/2009/06/21/assigning-msbuild-properties-to-sqlcmd-variables/">web blog</a> write how to do it.  According to their version, the magic lies in the <code>SqlCommandVariableOverride</code> statement, from which everything is simple - we add a couple of lines to the .sqlproj project file. <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ItemGroup</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">SqlCommandVariableOverride</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Include</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"DBVersion=$(ExtDBVersion)"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ItemGroup</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  and ready.  Nice try, but no.  Perhaps, when this blog entry was published, everything worked, but since then in these Americans of yours they managed to go through the presidential elections three times and no one knows what instruction may stop working tomorrow. <br><br><img src="https://habrastorage.org/webt/xv/d9/li/xvd9liiwyjicnv5icr9d1utjnxs.jpeg"><br><br>  And <a href="https://stackoverflow.com/questions/7955216/msbuild-and-sqlcmd-variables-in-data-tier-applications-postdeployment-sql">here</a> one comrade tried all the options, but none of them took off. <br><br>  Therefore, either take the version from dacpac, or store it in PostDeploy, or in a separate file, or _________ (enter your own version). <br><br><h4>  Integration with 1C </h4><br>  The first problem was that the 1C77 has no application server or other daemon that allows you to interact with it without launching the platform.  Who worked with 1C77, knows that she does not have a full console mode.  You can run the platform with parameters and even do something based on them, but there are very few console parameters and their purpose was different.  But even with their help, one can combine a whole combine.  However, it can fly out unpredictably, it can display a modal window and wait for someone to click OK and other charms.  And, perhaps, the biggest problem - the speed of the platform leaves much to be desired ... Therefore, there is only one solution - direct queries to the 1C database.  Considering the structure, it is impossible to simply take and write these requests, but the benefit is that there is a whole community, which at one time developed a great tool - 1C ++ (1cpp.dll), incredible THANKS to it for it!  The library allows you to write queries in terms of 1C, which are then converted into real names of tables and fields.  If someone does not know, then the request can be written using pseudo names and it will look like this <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span>  <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> $.</code> </pre> <br>  Such a request is understandable to a person, but there is no such table and field on the server, there are other names, so 1C ++ will turn it into <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> SP5278 <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> SC2235</code> </pre> <br>  and such a request is already clear to the server.  Everyone is happy, no one swears - neither man nor server.  There seems to be a question resolved. <br><br>  The second problem lay in the configuration plane: in branches, one configuration was used, in the central office another, and in the sub-branches - the third!  Class? !! ‚Äã‚Äã1 I think so too.  And all of them are not typical, and even not a heritage of typical ones, but completely written from scratch in the time of the Vikings and, unfortunately, the foundation of these confes was laid not by the best architects ... Document Implementation, for example, has a different set of details in each configuration.  But it is not only the names of some fields that are different, where the names of the details are the same, but the meaning of the data stored in them is DIFFERENT. <br><br><img src="https://habrastorage.org/webt/hs/jx/sv/hsjxsv_f7qy4xlgpwjiw7uir0ko.jpeg"><br><br>  In configurations almost no registers are used, everything is built on the intricacies of documents.  Therefore, sometimes you had to write a whole sheet on a clean transaction, with a bunch of cases and joins, to repeat the logic of some procedure from the configuration that displays some information in a text field on a form. <br><br>  We must pay tribute to the development team, which all these years have supported what they inherited from the "implementers", it is a lot of work - to maintain this and even optimize something.  Until you see it - you will not understand, at first I myself did not believe that everything could be so difficult.  Ask - why not rewrite from scratch?  Banal lack of resources.  The company developed so quickly that, despite a large team of programmers, they simply did not keep up with the needs of the business, not to mention rewriting the entire concept. <br><br>  We continue the story of the requests.  Obviously, all the data extraction blocks were wrapped in storage so that they could later be run on the server side bypassing the 1C platform.  The rule was this: one store is responsible for retrieving one entity.  Since  Wishlist at the start stage has already accumulated a lot, because it has become painful over the years, then the storage has turned out a few dozen. <br><br>  The third problem is how to increase the speed and quality of development, and how can we support all this monster?  Write a request for 1C ++ and copy-paste the result of its conversion to the storage?  It is very inconvenient and tedious, besides the likelihood of errors is great - copy the wrong and wrong place or not select the last line of the request and copy without it.  This is especially true when it comes to direct 1C queries, because there are no pseudo-names of the <i>Directory</i> type. Nomenclature. Article, only real names <i>SC2235.SP5278</i> and therefore it is very easy to copy the request from under the directory of products into the store that retrieves customers.  Of course, the query is likely to fall down due to inconsistencies between the types and the number of fields in the destination table, but there are identical labels, such as enumerations, where only two columns are the ID and the Name.  In general, there remains only to apply some kind of automation.  Well, enough of the lyrics, let's get down to business! <br><br>  It would be desirable, that process of development was reduced to approximately such actions: <br><br><ol><li>  Fix an SQL query with pseudo names and save it </li><li>  Click the <b>magic button</b> and get the output stored procedure on the converted SQL, understandable to the server </li></ol><br><h4>  Few details </h4><br>  To solve the third problem, an external processing (.ert) was written.  In processing, there are a number of procedures, each of which contains the text of a query for retrieving a single entity using pseudo-names, such as <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> $.</code> </pre> <br>  There is a field on the processing form to display the result of the work of a procedure, i.e.  request, converted to understandable for the server so that you can quickly try it in.  Plus, this request is always added to the <b>debugging block</b> , with the declaration of variables, the names of test databases, servers, and so on.  It remains only to copy-paste into SSMS and press F5.  You can, of course, execute this request from the processing itself, but the request plan and all that, well, you understand ... In general, this is how debugging is done.  Since  There are several configurations; it is possible to convert the same query texts with pseudo-names of objects into final queries for different configurations.  After all, the Nomenclature is SC123 in one directory, and SC321 in the other.  But 1C ++ allows you to load different confesses in rantaime and for each of them generate individual output in accordance with the dictionary. <br><br>  Next, the batch run mode was added to the processing, when it automatically starts each of the procedures for each configuration, and the output of each of them writes to the .sql files (hereinafter referred to as the base files).  Thus, we get a bunch of basic file combinations, which should then automatically be converted into stored procedures using VS.  It is worth noting that the basic files include <b>a debugging unit</b> . <br><br>  It would seem, why not draw the output directly to the final files of stored procedures and keep everything in this processing?  The fact is that for some tests, it is necessary to batchly run debug versions of requests in which all variables are declared, plus I wanted the names of stored procedures to be managed from VS, bypassing the launch of 1C, because this is logical, isn't it? <br><br>  By the way, the base files are also stored in the project, well, and the files of the finished stored procedures, of course.  At any time, without starting 1C, you can open the base file in SSMS and execute it without bothering with the declaration of variables. <br><br>  In processing, all procedures with queries are also template, having the same set of parameters, but in one procedure or another only the necessary parameters are used.  In some, everything is involved, and in some, two is enough.  Therefore, adding a new procedure is reduced to copying the template and filling in the parameters with the requests themselves. <br><br>  The code of one of the processing procedures that later becomes a stored procedure. <br><img src="https://habrastorage.org/webt/ci/ev/sb/cievsb9urq5miainrvoqu9mkig0.png"><br><br>  The final query is approximately as follows: <br><pre> <code class="1c hljs">++<span class="hljs-string"><span class="hljs-string">"("</span></span>+OPENQUERY()+<span class="hljs-string"><span class="hljs-string">")"</span></span>+ </code> </pre> <br>  Appearance processing <br><img src="https://habrastorage.org/webt/yv/n4/in/yvn4injz09-m8ljnqhbediqvmqy.png"><br><br>  When switching configurations, the list of available (necessary) for uploading items in the Data list also changes.  If possible, the code of procedures in 1C maximally unified.  If counterparties are extracted and in different configurations these directories have inconsistencies, then there are different cases inside the generation procedure, such as: this block is fixed for everyone, this one is added to the final query only for such a conf, and that one is for another.  It turns out that the stored procedures for one entity but different configurations may differ not only by the names of the tables, but by the whole blocks of joins present in one and missing in another.  The set of output fields, of course, is the same and corresponds to the receiver table or container of the SSIS packet, some fields are clogged with plugs for configurations in which these details are not present in principle. <br><br>  <b>Magic button</b> <br><br>  In Visual Studio, there are tools such as MSbuild and some absolutely wonderful T4 templates.  Therefore, a C # script for T4 was written as a magic button, which: <br><br><ol><li>  Registers an empty configuration in the registry (otherwise, 1C will display a modal window with the offer to register a con and wait for user actions) </li><li>  Creates an empty database for this config on the SQL server, because without it 1C will generate an error </li><li>  It launches 1C and through OLE tells it to perform processing (that .ert), also passing a unique GUID to 1C </li><li>  The output is a series of files with ready (converted) requests and a token file to which the GUID written at startup is written. </li><li>  Registration of a konfa is deleted from the registry and a temporary empty database is deleted from the server. </li><li>  Checks the contents of the token file.  If the marker file that we transferred to 1C when it is launched is in the marker file, it means that it worked to the end, did not crash, etc., then proceed to the next step, or output an error </li><li>  We create. </li><li>  We decompile the .ert file using gcomp to get the module text and form processing, well, convert it to unicode, for later sending to Git and displaying it correctly there.  For those who did not work with the 1C: .ert file, this is a binary and the studio along with git trumpeting that the .ert file is changed, but it‚Äôs not clear what changed in it, maybe someone just moved the button one pixel to the left (what unacceptable without justification) </li></ol><br><br>     T4       ,     (   ,    )        .      ,          .         ,     ,       ,      ,         - ‚Äî   1. <br><br>  ,  ,    ,        ,        ,          .      ‚Äî   1,     1,  -   . <br><br>      :       ? <br><br><ol><li>     / ; </li><li>    VS     ,     ; </li><li>   4; </li><li> <s>.</s>  Is done. </li></ol><br><div class="spoiler"> <b class="spoiler_title">?</b> <div class="spoiler_text">  Since               ,       ,    .sqlproj,  <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ItemGroup</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">None</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Include</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">" \1.sql"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">None</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Include</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">" \2.sql"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">None</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Include</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">" \3.sql"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ItemGroup</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  On <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ItemGroup</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Content</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Include</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">" \*.sql"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ItemGroup</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>       ¬´     ¬ª.   ,  ,   ,     :) <br><br>     , ,    (, )     .           ( ),         , -   - -       ,             . <br></div></div><br>         ,      .      . , ,      ,      ,       ,       (    ),      . ,    (   ,      )  ,        ,  ,          .           ,   . ,     ,      ,     ,   ,     (   ,          1, ,    MD ). <br><br>      ,         <i>OPENQUERY</i> ,     1   ,     ,       ,       ,         <i>EXEC</i> . <i>OPENQUERY</i>    ,      ,   ,   . <br><br>  177 (  )   SQL2000,   varchar(max)  ,  varchar(8000),     9, ‚Ä¶ ,          EXEC(@SQL1+@SQL2).    ,       SQL2016,     SQL2000.     ,     ,    . <br><br><div class="spoiler"> <b class="spoiler_title">      </b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> ... <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> ... <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> @<span class="hljs-number"><span class="hljs-number">1</span></span>CDBName.dbo.$. <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> @<span class="hljs-number"><span class="hljs-number">1</span></span>CDBName.dbo.$. <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> ... <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> xxx = <span class="hljs-string"><span class="hljs-string">'hello!'</span></span> ^<span class="hljs-comment"><span class="hljs-comment">--       8 , ,        ,       ,   .          ,             .. ... join ... ) join ...</span></span></code> </pre> </div></div><br><br><div class="spoiler"> <b class="spoiler_title">     </b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PROCEDURE</span></span> [dbo].[SP1] @LinkedServerName <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">24</span></span>) ,@<span class="hljs-number"><span class="hljs-number">1</span></span>CDBName <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">24</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Declare</span></span> @TSQL0 <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">8000</span></span>), @TSQL1 <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">8000</span></span>), @TSQL2 <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">8000</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> @TSQL0=<span class="hljs-string"><span class="hljs-string">' select ... from OPENQUERY('</span></span>+@LinkedName+<span class="hljs-string"><span class="hljs-string">','' select ... from '</span></span>+@<span class="hljs-number"><span class="hljs-number">1</span></span>CDBName+<span class="hljs-string"><span class="hljs-string">'.dbo.DH123. join '</span></span>+@<span class="hljs-number"><span class="hljs-number">1</span></span>CDBName+<span class="hljs-string"><span class="hljs-string">'.SC123. ... where '</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> @TSQL1=<span class="hljs-string"><span class="hljs-string">' xxx = ''''hello!'''' join ... join ... )'' join ... '''</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> @TSQL2=<span class="hljs-string"><span class="hljs-string">' ... EXEC(@TSQL0+@TSQL1+@TSQL2) END</span></span></code> </pre> <br></div></div><br>     ‚Äî     .       (, )   ,       , ,     ,      ,      ,   OPENQUERY  8 . <br><br> .ert             ,        ..  ,     . <br><br>          ,    . <br><br><h4> ETL </h4><br> ,       (  ).      (Stage).   ,  ETL    SSIS , ,   ,     ,      .      .                    (  ),            . <br><br>                 ,     (   ) ,   ,        (..   ),            ,        . <br><br>          ,     ,      . ,     .     zabbix. <br><br>             . <br><br>  Since    1     ,        ,            .      ,   ,   <code>truncate</code>  . <br><br> ,       (  )       -,  ¬´ 1-¬ª     . <br><br>     SSIS  <br><br><img src="https://habrastorage.org/webt/al/nl/u_/alnlu_3yriilaxfcwlhq_mcf_ce.png"><br><br>      <br><br><img src="https://habrastorage.org/webt/rh/eh/c8/rhehc8b9jtn6qf6polrfqjiduuk.png"><br><br><h4>  ,   </h4><br>         SSIS     <a href="https://docs.microsoft.com/ru-ru/sql/integration-services/data-flow/sql-server-destination"> SQL Server</a> (SQL Server Destination),     ,  <a href="https://docs.microsoft.com/ru-ru/sql/integration-services/data-flow/ole-db-destination"> OLE DB</a> (OLE DB Destination). <br><br>      ,       ,     ,             .    ,        ,   . (,     ) <br><br>       .           ,    ,      ,        (/  ). <br>                      . <br><br>          ,         (  ).  Those.       ,        .      ,        ,         .    -        ‚Äî          .            . <br><br>                  ,         (.. )   . <br><br>       ,     ,          . <br><br><h4>  PS </h4><br>     ,     ,      ,    ,   .   ‚Äî   ,    .           -  ,       ,   . </div><p>Source: <a href="https://habr.com/ru/post/423205/">https://habr.com/ru/post/423205/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../423191/index.html">Launching elements of offshore platforms. Part 1</a></li>
<li><a href="../423193/index.html">Configure Web Push Notifications using pywebpush step by step</a></li>
<li><a href="../423195/index.html">What's new in JPA 2.2</a></li>
<li><a href="../423197/index.html">LOLWUT: artwork in the DB team</a></li>
<li><a href="../423203/index.html">A cool team lead will be responsible for the service.</a></li>
<li><a href="../423207/index.html">How to make an automatic update of the client online game</a></li>
<li><a href="../423209/index.html">Killer Form 2? MoonRay S100 3D Printer Review for Dentists</a></li>
<li><a href="../423211/index.html">State Duma Committee: for likes and repost, criminal liability will remain</a></li>
<li><a href="../423213/index.html">As in Old Russian will be "this is a test"</a></li>
<li><a href="../423215/index.html">Where is my money, dude: what is silent Steam</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>