<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Using SQLite in Android development. Tips and tricks</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi, Habr! 
 I've been working on Android for a while and today I would like to tell you about the experience gained in the process of solving one task...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Using SQLite in Android development. Tips and tricks</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/381/b27/fdf/381b27fdf094f4ae197822a3fcc8ee92.png"><br>  Hi, Habr! <br>  I've been working on Android for a while and today I would like to tell you about the experience gained in the process of solving one task. <br><div class="spoiler">  <b class="spoiler_title">A warning:</b> <div class="spoiler_text">  For experienced developers in the article, most likely, there will be nothing new. </div></div><br>  For me, this project was the first where it was necessary to use SQLite closely (before it was needed no more than for <i>select &lt;something&gt; &lt;from somewhere&gt;</i> ). <br><br>  The task is as follows: scan the barcodes of products, recognize them, compare with reference books and display the result to the user. <br><br><h5>  During the decision made some interesting conclusions for themselves. </h5><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <b>1) The primary key of the tables does not have to be called " <a href="http://developer.android.com/reference/android/provider/BaseColumns.html">_id</a> ".</b> <br><br>  This is only necessary if you want to display the table using the standard mechanism. <br>  <i>ListView - CursorAdapter - LoaderManager - ContentProvider</i> (see note <a href="http://developer.android.com/guide/topics/providers/content-provider-basics.html">here</a> ) <br>  In principle, the trivial statement described in the documentation, however somehow (personally, in any case, I got the impression that the primary key field in the tables must be called <i>_id)</i> .  I have always done this before, without going into details, to avoid it. <br><br>  Another key name may be necessary if you need to import a previously developed table structure into SQLite. <br>  In my case, the reference tables already have their own fields <i>[Something_ID]</i> , which are used to join these tables.  And it is logical to make these fields primary keys, since they will be automatically indexed. <br><br>  <b>2) Solving the problem of automatically creating a database structure and filling it with initial data.</b> <br><br>  At first, when I first started the application, I thought of simply receiving data from a remote server and doing <i>insert</i> reference tables.  This is a bad option, since there is a lot of data (a little more than 2Mb). <br><br>  A little better is to do <i>bulkInsert</i> , i.e.  insert data within a single transaction.  It works faster, but not fundamentally different from the original version.  On Habr√© on this topic there is already a good <a href="http://habrahabr.ru/post/190876/">article</a> . <br><br>  The implementation variant bulkInsert in the provider: <br><pre><code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">bulkInsert</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Uri uri, ContentValues[] values)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> numInserted = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String table = selectTable(uri); database = databaseHandler.getWritableDatabase(); database.beginTransaction(); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (ContentValues cv : values) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (database.insert(table, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, cv) &lt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SQLException(<span class="hljs-string"><span class="hljs-string">"Failed to insert row into "</span></span> + uri); } } database.setTransactionSuccessful(); numInserted = values.length; } <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> { database.endTransaction(); getContext().getContentResolver().notifyChange(uri, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> numInserted; }</code> </pre> <br>  And I would like the pre-filled data tables to be ready for the user to start working with the application.  And there was an alternative option - the library <a href="https://github.com/jgilfelt/android-SQLite-asset-helper">android-SQLite-asset-helper</a> <br><br>  The essence is this: the database is not created on the device at the time of work, but in the process of developing an application, it is compressed, ziped and put into <i>assets</i> .  Further in the project, the database helper is inherited not from the standard <a href="http://developer.android.com/reference/android/database/sqlite/SQLiteOpenHelper.html">SQLiteOpenHelper</a> , but from <b>SQLiteAssetHelper</b> .  And everything, when the user first accesses the database is copied into the application, the implementation details are encapsulated in the helper (and I was even too lazy to go into them). <br><br>  I really liked the approach: <br><br><ul><li>  Speed.  It takes me less than a second to copy 2MB of the filled database with a dozen tables, which happens exactly 1 time in the entire lifetime of the application. <br>  There will also be no additional data conversions from one format to another (I would begin to solve a similar problem before, putting assets, say, a JSON file, and reading it into the database when it is first launched). </li><li>  Simplify the development of the database structure.  There is no tedious need to write table creation scripts in the <i>OnCreate</i> helper +; you can use additional applications for managing SQLite.  For ubunt I liked <a href="http://sqlitestudio.pl/">SQLitestudio</a> , simple and clear.  (Although not a buggy, to be honest - in the current version 2.1.4 it cannot create a trigger for the presentation, but where it failed to do it, it completed the standard console <i>sqlite3</i> ). </li></ul><br><br>  <b>3) Features of the interaction of views (view) SQLite android LoaderManager.</b> <br>  I will not dwell on the issues of what <a href="http://developer.android.com/reference/android/app/LoaderManager.html">LoaderManager is</a> and how to use it, I personally was helped by a wonderful <a href="http://www.androiddesignpatterns.com/2012/07/understanding-loadermanager.html">series of articles</a> .  I can only say that I wanted to use exactly LoaderManager to assign him the task of automatically updating the changed data in the list. <br><br>  However, it is necessary to insert data into the table, and to display it from the associated view, where instead of id-fields the values ‚Äã‚Äãare substituted: <br><pre> <code class="sql hljs"> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> [table_scan] ( [_id] <span class="hljs-built_in"><span class="hljs-built_in">INTEGER</span></span> PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> AUTOINCREMENT, [NR_ID] <span class="hljs-built_in"><span class="hljs-built_in">INTEGER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [T_ID] <span class="hljs-built_in"><span class="hljs-built_in">INTEGER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [Color_ID] <span class="hljs-built_in"><span class="hljs-built_in">INTEGER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [R_ID] <span class="hljs-built_in"><span class="hljs-built_in">INTEGER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [Barcode] <span class="hljs-built_in"><span class="hljs-built_in">TEXT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [NumberSeat] <span class="hljs-built_in"><span class="hljs-built_in">INTEGER</span></span>, [<span class="hljs-built_in"><span class="hljs-built_in">Date</span></span>] DATETIME <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span>(DATETIME(<span class="hljs-string"><span class="hljs-string">'now'</span></span>, <span class="hljs-string"><span class="hljs-string">'localtime'</span></span>)), [Deleted] <span class="hljs-built_in"><span class="hljs-built_in">INTEGER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-string"><span class="hljs-string">'0'</span></span>, [<span class="hljs-keyword"><span class="hljs-keyword">Status</span></span>] <span class="hljs-built_in"><span class="hljs-built_in">INTEGER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-string"><span class="hljs-string">'0'</span></span>, [<span class="hljs-keyword"><span class="hljs-keyword">Export</span></span>] <span class="hljs-built_in"><span class="hljs-built_in">INTEGER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-string"><span class="hljs-string">'0'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">VIEW</span></span> [view_scan] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> _id, Barcode, <span class="hljs-keyword"><span class="hljs-keyword">Status</span></span>, Deleted, NumberSeat, goods_catalog.T_Articul, colors_catalog.Color_Name, sizes_catalog.R_Name <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> table_scan <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> goods_catalog <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> goods_catalog.T_ID = table_scan.T_ID <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> colors_catalog <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> colors_catalog.Color_ID = table_scan.Color_ID <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> sizes_catalog <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> sizes_catalog.R_ID = table_scan.R_ID <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> Deleted = <span class="hljs-number"><span class="hljs-number">0</span></span>;</code> </pre><br>  In the forehead, this option, as it turned out, does not work.  For the uri loader on the table and the uri on the view - two different uri :) <br>  Those.  if you initialize <i>view_scan</i> in it, instead of <i>table_scan</i> , then there will not be a list when inserting it into the update table. <br>  With the table, everything is perfectly updated, but at the output, instead of beautiful values, their ID keys are incomprehensible to people. <br><br>  The first option found <a href="http://www.sqlite.org/lang_createview.html">in the SQLite documentation</a> was a suitable solution.  You cannot insert data directly into a view (which is expected), but you can create a trigger that automatically inserts it into the desired table. <br><br>  Ok, I complement the view with missing id fields <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">VIEW</span></span> [view_scan] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> table_scan._id, table_scan.NR_ID, table_scan.T_ID,table_scan.Color_ID, table_scan.R_ID, table_scan.Barcode, table_scan.NumberSeat, table_scan.Deleted, table_scan.Status, goods_catalog.T_Articul, colors_catalog.Color_Name, sizes_catalog.R_Name <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> table_scan <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> goods_catalog <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> goods_catalog.T_ID = table_scan.T_ID <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> colors_catalog <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> colors_catalog.Color_ID = table_scan.Color_ID <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> sizes_catalog <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> sizes_catalog.R_ID = table_scan.R_ID <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> Deleted = <span class="hljs-number"><span class="hljs-number">0</span></span>;</code> </pre><br>  and write the insert trigger: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRIGGER</span></span> insert_view_scan instead <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> view_scan <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> table_scan(NR_ID,T_ID,Color_ID,R_ID,Barcode,NumberSeat,<span class="hljs-keyword"><span class="hljs-keyword">Status</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">values</span></span>(new.NR_ID, new.T_ID, new.Color_ID, new.R_ID, new.Barcode, new.NumberSeat, new.Status); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>;</code> </pre><br>  Now everything works.  In LoaderManager, during initialization, the uri views are given, the insert request also goes to the view, and the rest of the work is done by SQLite.  The loader does what it should, i.e.  monitor the cursor and automatically transfer the changed data to the list adapter. <br><br>  That's all.  It will be interesting to read something else about advanced techniques of working with SQLite on Android. <br>  Well, objective criticism is also interesting :) </div><p>Source: <a href="https://habr.com/ru/post/205620/">https://habr.com/ru/post/205620/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../205600/index.html">Google introduced the LG G Pad 8.3, Sony Z Ultra and white Nexus 7</a></li>
<li><a href="../205608/index.html">Why switch to DDR4?</a></li>
<li><a href="../205612/index.html">How SmartTV forgot about the main thing</a></li>
<li><a href="../205614/index.html">How to "send" the client</a></li>
<li><a href="../205616/index.html">Stop being cute and smart</a></li>
<li><a href="../205622/index.html">Optimization of Android applications for x86. 2GIS Experience</a></li>
<li><a href="../205626/index.html">Python for microcontrollers</a></li>
<li><a href="../205636/index.html">Central Bank of Russia approved the official sign of the ruble</a></li>
<li><a href="../205638/index.html">Xperia and KitKat</a></li>
<li><a href="../205642/index.html">Barack Obama calls on all Americans to learn programming</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>