<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Auto-collection of data on completed tasks in MS SQL Server</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Foreword 


 It is important for the database administrator to know what tasks were performed and how this happened (by duration, successfully or not ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Auto-collection of data on completed tasks in MS SQL Server</h1><div class="post__text post__text-html js-mediator-article"><h3>  Foreword </h3><br><p>  It is important for the database administrator to know what tasks were performed and how this happened (by duration, successfully or not successfully, etc.).  To not do this manually on each server, it is better to automate this process. </p><br><p>  In this article I will give an implementation of the automatic daily collection of information about completed tasks of the Agent in MS SQL Server. </p><br><a name="habracut"></a><br><h3>  Decision </h3><br><p>  Algorithm: </p><br><p>  1) create a submission for the selection of tasks: </p><br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">USE</span></span> [__] <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> ANSI_NULLS <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> QUOTED_IDENTIFIER <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">view</span></span> [srv].[vJobRunShortInfo] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> sj.[job_id] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> Job_GUID ,j.name <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> Job_Name ,<span class="hljs-keyword"><span class="hljs-keyword">case</span></span> sj.[last_run_outcome] <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-string"><span class="hljs-string">''</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-string"><span class="hljs-string">''</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-string"><span class="hljs-string">''</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> sj.[last_run_date] <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-keyword"><span class="hljs-keyword">len</span></span>(sj.[last_run_date])=<span class="hljs-number"><span class="hljs-number">8</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-string"><span class="hljs-string">' '</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> LastFinishRunState ,sj.[last_run_outcome] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> LastRunOutcome ,<span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> sj.[last_run_date] <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-keyword"><span class="hljs-keyword">len</span></span>(sj.[last_run_date])=<span class="hljs-number"><span class="hljs-number">8</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> DATETIMEFROMPARTS( <span class="hljs-keyword"><span class="hljs-keyword">substring</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">cast</span></span>(sj.[last_run_date] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>(<span class="hljs-number"><span class="hljs-number">255</span></span>)),<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">4</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">substring</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">cast</span></span>(sj.[last_run_date] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>(<span class="hljs-number"><span class="hljs-number">255</span></span>)),<span class="hljs-number"><span class="hljs-number">5</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">substring</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">cast</span></span>(sj.[last_run_date] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>(<span class="hljs-number"><span class="hljs-number">255</span></span>)),<span class="hljs-number"><span class="hljs-number">7</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-keyword"><span class="hljs-keyword">len</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">cast</span></span>(sj.[last_run_time] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>(<span class="hljs-number"><span class="hljs-number">255</span></span>)))&gt;=<span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">substring</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">cast</span></span>(sj.[last_run_time] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>(<span class="hljs-number"><span class="hljs-number">255</span></span>)),<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">len</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">cast</span></span>(sj.[last_run_time] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>(<span class="hljs-number"><span class="hljs-number">255</span></span>)))<span class="hljs-number"><span class="hljs-number">-4</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-keyword"><span class="hljs-keyword">len</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">right</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">cast</span></span>(sj.[last_run_time] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>(<span class="hljs-number"><span class="hljs-number">255</span></span>)),<span class="hljs-number"><span class="hljs-number">4</span></span>))&gt;=<span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">substring</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">right</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">cast</span></span>(sj.[last_run_time] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>(<span class="hljs-number"><span class="hljs-number">255</span></span>)),<span class="hljs-number"><span class="hljs-number">4</span></span>),<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-keyword"><span class="hljs-keyword">len</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">right</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">cast</span></span>(sj.[last_run_time] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>(<span class="hljs-number"><span class="hljs-number">255</span></span>)),<span class="hljs-number"><span class="hljs-number">4</span></span>))=<span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">substring</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">right</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">cast</span></span>(sj.[last_run_time] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>(<span class="hljs-number"><span class="hljs-number">255</span></span>)),<span class="hljs-number"><span class="hljs-number">4</span></span>),<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">right</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">cast</span></span>(sj.[last_run_duration] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>(<span class="hljs-number"><span class="hljs-number">255</span></span>)),<span class="hljs-number"><span class="hljs-number">2</span></span>), <span class="hljs-number"><span class="hljs-number">0</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> LastDateTime ,<span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-keyword"><span class="hljs-keyword">len</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">cast</span></span>(sj.[last_run_duration] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>(<span class="hljs-number"><span class="hljs-number">255</span></span>)))&gt;<span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">substring</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">cast</span></span>(sj.[last_run_duration] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>(<span class="hljs-number"><span class="hljs-number">255</span></span>)),<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">len</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">cast</span></span>(sj.[last_run_duration] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>(<span class="hljs-number"><span class="hljs-number">255</span></span>)))<span class="hljs-number"><span class="hljs-number">-4</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-keyword"><span class="hljs-keyword">len</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">cast</span></span>(sj.[last_run_duration] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>(<span class="hljs-number"><span class="hljs-number">255</span></span>)))=<span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-string"><span class="hljs-string">'0'</span></span>+<span class="hljs-keyword"><span class="hljs-keyword">substring</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">cast</span></span>(sj.[last_run_duration] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>(<span class="hljs-number"><span class="hljs-number">255</span></span>)),<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">len</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">cast</span></span>(sj.[last_run_duration] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>(<span class="hljs-number"><span class="hljs-number">255</span></span>)))<span class="hljs-number"><span class="hljs-number">-4</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-string"><span class="hljs-string">'00'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> +<span class="hljs-string"><span class="hljs-string">':'</span></span> +<span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-keyword"><span class="hljs-keyword">len</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">cast</span></span>(sj.[last_run_duration] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>(<span class="hljs-number"><span class="hljs-number">255</span></span>)))&gt;=<span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">substring</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">right</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">cast</span></span>(sj.[last_run_duration] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>(<span class="hljs-number"><span class="hljs-number">255</span></span>)),<span class="hljs-number"><span class="hljs-number">4</span></span>),<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-keyword"><span class="hljs-keyword">len</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">cast</span></span>(sj.[last_run_duration] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>(<span class="hljs-number"><span class="hljs-number">255</span></span>)))=<span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-string"><span class="hljs-string">'0'</span></span>+<span class="hljs-keyword"><span class="hljs-keyword">substring</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">right</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">cast</span></span>(sj.[last_run_duration] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>(<span class="hljs-number"><span class="hljs-number">255</span></span>)),<span class="hljs-number"><span class="hljs-number">4</span></span>),<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-string"><span class="hljs-string">'00'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> +<span class="hljs-string"><span class="hljs-string">':'</span></span> +<span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-keyword"><span class="hljs-keyword">len</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">cast</span></span>(sj.[last_run_duration] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>(<span class="hljs-number"><span class="hljs-number">255</span></span>)))&gt;=<span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">substring</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">right</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">cast</span></span>(sj.[last_run_duration] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>(<span class="hljs-number"><span class="hljs-number">255</span></span>)),<span class="hljs-number"><span class="hljs-number">2</span></span>),<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-keyword"><span class="hljs-keyword">len</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">cast</span></span>(sj.[last_run_duration] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>(<span class="hljs-number"><span class="hljs-number">255</span></span>)))=<span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-string"><span class="hljs-string">'0'</span></span>+<span class="hljs-keyword"><span class="hljs-keyword">substring</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">right</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">cast</span></span>(sj.[last_run_duration] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>(<span class="hljs-number"><span class="hljs-number">255</span></span>)),<span class="hljs-number"><span class="hljs-number">2</span></span>),<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-string"><span class="hljs-string">'00'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> [LastRunDurationString] ,sj.last_run_duration <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> LastRunDurationInt ,sj.[last_outcome_message] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> LastOutcomeMessage ,j.enabled <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> [Enabled] <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> [msdb].[dbo].[sysjobservers] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> sj <span class="hljs-keyword"><span class="hljs-keyword">inner</span></span> <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> msdb.dbo.sysjobs_view <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> j <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> j.job_id=sj.job_id; GO</code> </pre> </div></div><br><p>  It uses two system views <a href="https://msdn.microsoft.com/ru-ru/library/ms187761(v%3Dsql.110).aspx">sysjobservers</a> and <a href="https://msdn.microsoft.com/ru-ru/library/ms189817(v%3Dsql.110).aspx">sysjobs_view</a> <br>  2) create a table for storing the selected information: </p><br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">USE</span></span> [__] <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> ANSI_NULLS <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> QUOTED_IDENTIFIER <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> [srv].[ShortInfoRunJobs]( [Job_GUID] [uniqueidentifier] <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [Job_Name] [<span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>](<span class="hljs-number"><span class="hljs-number">255</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [LastFinishRunState] [<span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>](<span class="hljs-number"><span class="hljs-number">255</span></span>) <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [LastDateTime] [datetime] <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [LastRunDurationString] [<span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>](<span class="hljs-number"><span class="hljs-number">255</span></span>) <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [LastRunDurationInt] [<span class="hljs-built_in"><span class="hljs-built_in">int</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [LastOutcomeMessage] [<span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>](<span class="hljs-number"><span class="hljs-number">255</span></span>) <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [LastRunOutcome] [tinyint] <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [<span class="hljs-keyword"><span class="hljs-keyword">Server</span></span>] [<span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>](<span class="hljs-number"><span class="hljs-number">255</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [InsertUTCDate] [datetime] <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [<span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>] [<span class="hljs-built_in"><span class="hljs-built_in">int</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">IDENTITY</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> [PK_ShortInfoRunJobs] PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> CLUSTERED ( [<span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">ASC</span></span> )<span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> (PAD_INDEX = <span class="hljs-keyword"><span class="hljs-keyword">OFF</span></span>, STATISTICS_NORECOMPUTE = <span class="hljs-keyword"><span class="hljs-keyword">OFF</span></span>, IGNORE_DUP_KEY = <span class="hljs-keyword"><span class="hljs-keyword">OFF</span></span>, ALLOW_ROW_LOCKS = <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span>, ALLOW_PAGE_LOCKS = <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [PRIMARY] ) <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [PRIMARY] <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> [srv].[ShortInfoRunJobs] <span class="hljs-keyword"><span class="hljs-keyword">ADD</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> [DF_ShortInfoRunJobs_InsertUTCDate] <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">getutcdate</span></span>()) <span class="hljs-keyword"><span class="hljs-keyword">FOR</span></span> [InsertUTCDate] <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span></code> </pre> </div></div><br><p>  3) create a task in the Agent and daily collect information on those tasks that have either been completed for a long time (more than 30 seconds) or failed in the last 2 days: </p><br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">USE</span></span> [__]; GO <span class="hljs-keyword"><span class="hljs-keyword">truncate</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> [srv].[ShortInfoRunJobs]; <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> [srv].[ShortInfoRunJobs] ([Job_GUID] ,[Job_Name] ,[LastFinishRunState] ,[LastDateTime] ,[LastRunDurationString] ,[LastRunDurationInt] ,[LastOutcomeMessage] ,[LastRunOutcome] ,[<span class="hljs-keyword"><span class="hljs-keyword">Server</span></span>]) <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> [Job_GUID] ,[Job_Name] ,[LastFinishRunState] ,[LastDateTime] ,[LastRunDurationString] ,[LastRunDurationInt] ,[LastOutcomeMessage] ,LastRunOutcome ,@@SERVERNAME <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> [srv].[vJobRunShortInfo] <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> [Enabled]=<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> ([LastRunOutcome]=<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> [LastRunDurationInt]&gt;=<span class="hljs-number"><span class="hljs-number">30</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> LastDateTime&gt;=<span class="hljs-keyword"><span class="hljs-keyword">DateAdd</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">day</span></span>,<span class="hljs-number"><span class="hljs-number">-2</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">getdate</span></span>()); GO</code> </pre> </div></div><br><p>  Here or in step 2, you can configure the filter to remove unnecessary tasks.  For example, associated with replication, because they work long <br>  4) generate an HTML report for further sending to administrators about the results by mail: </p><br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">USE</span></span> [__] <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> ANSI_NULLS <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> QUOTED_IDENTIFIER <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PROCEDURE</span></span> [srv].[GetHTMLTableShortInfoRunJobs] @<span class="hljs-keyword"><span class="hljs-keyword">body</span></span> <span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">max</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">OUTPUT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-comment"><span class="hljs-comment">/*  HTML-     */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> NOCOUNT <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRANSACTION</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ISOLATION</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LEVEL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">READ</span></span> UNCOMMITTED; <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> @tbl <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> ( Job_GUID uniqueidentifier ,Job_Name <span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>(<span class="hljs-number"><span class="hljs-number">255</span></span>) ,LastFinishRunState <span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>(<span class="hljs-number"><span class="hljs-number">255</span></span>) ,LastDateTime datetime ,LastRunDurationString <span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>(<span class="hljs-number"><span class="hljs-number">255</span></span>) ,LastOutcomeMessage <span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">max</span></span>) ,[<span class="hljs-keyword"><span class="hljs-keyword">Server</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>(<span class="hljs-number"><span class="hljs-number">255</span></span>) ,<span class="hljs-keyword"><span class="hljs-keyword">ID</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">identity</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>) ); <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> @Job_GUID uniqueidentifier ,@Job_Name <span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>(<span class="hljs-number"><span class="hljs-number">255</span></span>) ,@LastFinishRunState <span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>(<span class="hljs-number"><span class="hljs-number">255</span></span>) ,@LastDateTime datetime ,@LastRunDurationString <span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>(<span class="hljs-number"><span class="hljs-number">255</span></span>) ,@LastOutcomeMessage <span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">max</span></span>) ,@<span class="hljs-keyword"><span class="hljs-keyword">Server</span></span> <span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>(<span class="hljs-number"><span class="hljs-number">255</span></span>) ,@<span class="hljs-keyword"><span class="hljs-keyword">ID</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> @tbl( Job_GUID ,Job_Name ,LastFinishRunState ,LastDateTime ,LastRunDurationString ,LastOutcomeMessage ,[<span class="hljs-keyword"><span class="hljs-keyword">Server</span></span>] ) <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> Job_GUID ,Job_Name ,LastFinishRunState ,LastDateTime ,LastRunDurationString ,LastOutcomeMessage ,[<span class="hljs-keyword"><span class="hljs-keyword">Server</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> srv.ShortInfoRunJobs <span class="hljs-comment"><span class="hljs-comment">--order by LastRunDurationInt desc; if(exists(select top(1) 1 from @tbl)) begin set @body='     ,    ,     ,      30 :&lt;br&gt;&lt;br&gt;'+'&lt;TABLE BORDER=5&gt;'; set @body=@body+'&lt;TR&gt;'; set @body=@body+'&lt;TD&gt;'; set @body=@body+'‚Ññ /'; set @body=@body+'&lt;/TD&gt;'; set @body=@body+'&lt;TD&gt;'; set @body=@body+''; set @body=@body+'&lt;/TD&gt;'; set @body=@body+'&lt;TD&gt;'; set @body=@body+''; set @body=@body+'&lt;/TD&gt;'; set @body=@body+'&lt;TD&gt;'; set @body=@body+''; set @body=@body+'&lt;/TD&gt;'; set @body=@body+'&lt;TD&gt;'; set @body=@body+'  '; set @body=@body+'&lt;/TD&gt;'; set @body=@body+'&lt;TD&gt;'; set @body=@body+''; set @body=@body+'&lt;/TD&gt;'; set @body=@body+'&lt;TD&gt;'; set @body=@body+''; set @body=@body+'&lt;/TD&gt;'; set @body=@body+'&lt;TD&gt;'; set @body=@body+''; set @body=@body+'&lt;/TD&gt;'; set @body=@body+'&lt;/TR&gt;'; while((select top 1 1 from @tbl)&gt;0) begin set @body=@body+'&lt;TR&gt;'; select top 1 @ID = [ID] ,@Job_GUID = Job_GUID ,@Job_Name = Job_Name ,@LastFinishRunState = LastFinishRunState ,@LastDateTime = LastDateTime ,@LastRunDurationString = LastRunDurationString ,@LastOutcomeMessage = LastOutcomeMessage ,@Server = [Server] from @tbl order by LastRunDurationInt desc; set @body=@body+'&lt;TD&gt;'; set @body=@body+cast(@ID as nvarchar(max)); set @body=@body+'&lt;/TD&gt;'; set @body=@body+'&lt;TD&gt;'; set @body=@body+cast(@Job_GUID as nvarchar(255)); set @body=@body+'&lt;/TD&gt;'; set @body=@body+'&lt;TD&gt;'; set @body=@body+coalesce(@Job_Name,''); set @body=@body+'&lt;/TD&gt;'; set @body=@body+'&lt;TD&gt;'; set @body=@body+coalesce(@LastFinishRunState,''); set @body=@body+'&lt;/TD&gt;'; set @body=@body+'&lt;TD&gt;'; set @body=@body+rep.GetDateFormat(@LastDateTime, default)+' '+rep.GetTimeFormat(@LastDateTime, default);--cast(@InsertDate as nvarchar(max)); set @body=@body+'&lt;/TD&gt;'; set @body=@body+'&lt;TD&gt;'; set @body=@body+coalesce(@LastRunDurationString,''); set @body=@body+'&lt;/TD&gt;'; set @body=@body+'&lt;TD&gt;'; set @body=@body+coalesce(@LastOutcomeMessage, ''); set @body=@body+'&lt;/TD&gt;'; set @body=@body+'&lt;TD&gt;'; set @body=@body+coalesce(@Server, ''); set @body=@body+'&lt;/TD&gt;'; delete from @tbl where ID=@ID; set @body=@body+'&lt;/TR&gt;'; end set @body=@body+'&lt;/TABLE&gt;'; end else begin set @body='     ,    ,   ,      30 ,  '; end set @body=@body+'&lt;br&gt;&lt;br&gt;       __.srv.ShortInfoRunJobs'; END GO</span></span></code> </pre> </div></div><br><p>  This stored procedure generates an HTML report on completed tasks that were performed for longer than 30 seconds or that ended with an error (in accordance with paragraph 3). </p><br><h3>  Result </h3><br><p>  In the article above, an example of the implementation of the system of daily automatic collection of information about the Agent‚Äôs tasks performed was considered.  Using this information, you can identify tasks that were performed for a long time or ended with an error.  This allows the administrator to take timely measures to prevent errors in the future. <br>  For example, you can improve the task so that it runs faster, or set the maximum time for a given task to be higher than the others. <br>  This solution also helps to keep track of problems with creating backup copies (but more on that later, because it is not enough to notify you about critical errors once a day, you need to notify immediately and constantly repeat the notification after a certain period of time until the error is corrected ). <br>  If you need to collect information from multiple servers, you can combine the result and send it in one message. </p><br><h3>  Sources: </h3><br><p>  ¬ª <a href="https://msdn.microsoft.com/ru-ru/library/ms189817(v%3Dsql.110).aspx">Sysjobs</a> <br>  ¬ª <a href="https://msdn.microsoft.com/ru-ru/library/ms187761(v%3Dsql.110).aspx">Sysjobservers</a> </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/314628/">https://habr.com/ru/post/314628/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../314616/index.html">A person. Anders Hejlsberg - creator of Turbo Pascal, Delphi and C #</a></li>
<li><a href="../314618/index.html">Once executed block in an arbitrary place of code (C ++ 11 and higher)</a></li>
<li><a href="../314620/index.html">Product Design Digest October 2016</a></li>
<li><a href="../314622/index.html">Setting up email notifications in MS SQL Server</a></li>
<li><a href="../314624/index.html">EF Core: Setting the name of the generated models in Scaffolding</a></li>
<li><a href="../314630/index.html">Auto-collection of data about changes in database schemas in MS SQL Server</a></li>
<li><a href="../314632/index.html">Automatic removal of hung processes in MS SQL Server</a></li>
<li><a href="../314642/index.html">Remote work: 50 shades of freedom</a></li>
<li><a href="../314644/index.html">Is DevOps afraid of modern QA?</a></li>
<li><a href="../314650/index.html">Experience preparing for the exam on the status of RHCVA (Red Hat Certified Virtualizaion Administrator)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>