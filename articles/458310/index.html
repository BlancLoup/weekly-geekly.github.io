<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Collect metrics from .NET applications using Telegraf</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="One of the most important tasks in the design of systems is the organization of monitoring the status of all nodes, including a large number of servic...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Collect metrics from .NET applications using Telegraf</h1><div class="post__text post__text-html js-mediator-article"><p>  One of the most important tasks in the design of systems is the organization of monitoring the status of all nodes, including a large number of services.  In conditions when additional forces and means are not allocated for this, it is necessary to make the most of ready-made solutions. </p><br><p>  I think many people have a picture of this in the project: </p><br><p><img src="https://im0-tub-ru.yandex.net/i?id=4d2bad3c3f78d3b51b20e110d1e8bc5e&amp;n=13" alt="image"></p><br><p>  Something is sent somewhere, somehow processed and kept on one nail.  The task was to collect data processing statistics from all points and put them in one place in order to build graphs and write reports. </p><a name="habracut"></a><br><p>  Thanks to the <a href="https://habr.com/ru/post/331016/">article, the</a> choice fell on a bunch of Telegraf-Elasticsearch-Grafana.  <a href="https://github.com/influxdata/telegraf">Telegraf</a> fits perfectly into the project to organize monitoring of the state of both hardware and publicly available third-party software, but I will separately address the issue of measuring the load on my own services.  In this case, we are talking about .NET services running in docker containers under Linux.  All services form several stages of processing incoming information, and I needed to measure the number of successfully processed and rejected packets with additional marks of the processing stage, the source, and others to enable subsequent statistical processing. </p><br><p>  I will skip the installation process and go straight to the configuration.  So, Telegraf is able to receive messages with metrics via tcp, udp, and also through unixsocket: </p><br><pre><code class="plaintext hljs">[[inputs.socket_listener]] #service_address = "unixgram:///tmp/telegraf.sock" service_address = "udp4://:14230" data_format = "json" json_name_key = "name" namepass = ["query_pass"] tag_keys = ["appname","fromip"]</code> </pre> <br><p>  Services will send messages every time the next packet is processed, therefore we will additionally configure aggregation.  The interval of 10 seconds is quite enough, depending on the load of a particular system. </p><br><pre> <code class="plaintext hljs">[[aggregators.basicstats]] period = "10s" drop_original = true stats = ["sum"] namepass = ["query_pass"] fieldpass = ["pass","fail"]</code> </pre> <br><p>  Go through the parameters: <em>query_pass</em> - the name of the metric that combines future measurements, <em>pass</em> - successful processing, <em>fail</em> - not.  Additionally, metrics will be tagged with <em>appname</em> and <em>fromip</em> . </p><br><p>  Now for some code.  I like to send metrics via udp and unixsocket, although other options may be appropriate for you. </p><br><pre> <code class="cs hljs">UdpClient udpClient = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> UdpClient(<span class="hljs-string"><span class="hljs-string">"127.0.0.1"</span></span>, <span class="hljs-number"><span class="hljs-number">14230</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] datagramBytes= Encoding.UTF8.GetBytes(<span class="hljs-string"><span class="hljs-string">"{\"name\":\"query_pass\",\"pass\":1,\"fromip\":\"127.0.0.1\",\"appname\":\"application\"}"</span></span>); udpClient.Send(datagramBytes, datagramBytes.Length); datagramBytes= Encoding.UTF8.GetBytes(<span class="hljs-string"><span class="hljs-string">"{\"name\":\"query_pass\",\"fail\":1,\"fromip\":\"127.0.0.1\",\"appname\":\"application\"}"</span></span>); udpClient.Send(datagramBytes, datagramBytes.Length);</code> </pre> <br><p>  All this is perfectly summed up and folds into the base, in my case it is elasticsearch ( <a href="">screenshot</a> ). </p><br><pre> <code class="plaintext hljs">[[outputs.elasticsearch]] urls = [ "http://localhost:9200" ] # required. timeout = "5s" health_check_interval = "5s" index_name = "telegraf-%Y.%m.%d" # required. manage_template = true template_name = "tp_telegraf" overwrite_template = true</code> </pre> <br><p>  All cats. </p><br><p>  PS: here is the <a href="">final project</a> for sending metrics under net.core </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/458310/">https://habr.com/ru/post/458310/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../45830/index.html">About great patriots</a></li>
<li><a href="../458304/index.html">Nightmare "Knight": an instructive story about DevOps</a></li>
<li><a href="../458306/index.html">The digest of fresh materials from the world of the frontend for the last week ‚Ññ371 (June 24 - 30, 2019)</a></li>
<li><a href="../458308/index.html">Overview: What will be the future of Tesla, and what factors will influence it</a></li>
<li><a href="../45831/index.html">Vkontakte.ru in 50 years</a></li>
<li><a href="../458312/index.html">Android Academy in Moscow: Advanced Course</a></li>
<li><a href="../458316/index.html">Yandex Retro Games Battle 2019 - develop games for ZX Spectrum</a></li>
<li><a href="../45832/index.html">Search site</a></li>
<li><a href="../458324/index.html">Everything you need to get started with Vue.js</a></li>
<li><a href="../458326/index.html">Yandex opens datasets Toloki for researchers</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>