<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Accelerate Ansible with Mitogen</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ansible has become one of the most popular Configuration Management systems . After Red Hat was bought in 2015, the number of project participants exc...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Accelerate Ansible with Mitogen</h1><div class="post__text post__text-html js-mediator-article"><p>  <a href="https://www.ansible.com/">Ansible has</a> become one of the most popular <a href="https://en.wikipedia.org/wiki/Configuration_management">Configuration Management systems</a> .  After <a href="https://www.redhat.com/en/blog/why-red-hat-acquired-ansible">Red Hat was bought</a> in 2015, the number of <a href="https://github.com/ansible/ansible/graphs/contributors">project participants</a> exceeded thousands and Ansible was probably the most used deployment and orchestration system.  Its wide applications are very impressive. </p><br><p>  Ansible works through SSH connections to remote hosts.  It opens an SSH session, makes a login, copies the Python code over the network and writes it into a separate temporary file.  After that, it runs this file on a remote machine.  This whole sequence of operations is quite long and tedious, so there are various ways to optimize it. </p><a name="habracut"></a><br><p> One of these methods is <a href="https://docs.ansible.com/ansible/2.3/intro_configuration.html">SSH pipelines</a> which allows you to use one SSH session to execute instructions, rather than opening a new session every time, which can save us a lot of time.  (Just do not forget to disable the <code>requiretty</code> setting for sudo in your <code>/etc/sudoers</code> file on the remote machine) </p><br><p>  A new way to "accelerate" Ansible is the python library called <a href="https://mitogen.networkgenomics.com/">Mitogen</a> .  if someone has not heard about it - then briefly describe its functionality.  It allows fast execution of python code on a remote machine and Ansible is just one example of use.  Mitogen uses the UNIX pipe on the remote machine and transmits the python code compressed zlib and serialized using pickle.  This helps to perform it faster and saves traffic.  If you are interested in a more detailed explanation, it is best to read about it on the page <a href="https://mitogen.networkgenomics.com/howitworks.html">"How it works"</a> .  But today we will focus only on the work of the library with Ansible. </p><br><p>  Mitogen in certain circumstances can speed up your Ansible code several times and significantly reduce traffic consumption.  Let's check the most popular examples of use and see how it helps us. </p><br><p>  I mostly use Ansible for: creating configuration files on a remote machine, installing packages, copying files to and from a remote machine.  Perhaps you have other examples - write in the comments. </p><br><p>  Go! </p><br><p>  The Mitogen configuration for Ansible is very simple: <br>  Install the Mitogen library: </p><br><pre> <code class="bash hljs">pip install mitogen</code> </pre> <br><p>  Now there are two equivalent ways - either to configure the options in the configuration file ansible.cfg, or to set the desired environment variables. </p><br><p>  Suppose that the path to the installed Mitogen is <code>/usr/lib/python2.7/site-packages/ansible_mitogen/plugins/strategy</code> .  Then: </p><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">export</span></span> ANSIBLE_STRATEGY_PLUGINS=/usr/lib/python2.7/site-packages/ansible_mitogen/plugins/strategy <span class="hljs-built_in"><span class="hljs-built_in">export</span></span> ANSIBLE_STRATEGY=mitogen_linear</code> </pre> <br><p>  or </p><br><pre> <code class="plaintext hljs">[defaults] strategy = mitogen_linear strategy_plugins = /usr/lib/python2.7/site-packages/ansible_mitogen/plugins/strategy</code> </pre> <br><p>  Install Ansible in virtualenv, with and without Mitogen: </p><br><pre> <code class="bash hljs">virtualenv mitogen_ansible ./mitogen_ansible/bin/pip install ansible==2.7.10 mitogen virtualenv pure_ansible ./pure_ansible/bin/pip install ansible==2.7.10</code> </pre> <br><p>  <strong>Please note that Mitogen 0.2.7 does not work with Ansible 2.8 (as of May 2019)</strong> </p><br><p>  Make aliases: </p><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">alias</span></span> pure-ansible-playbook=<span class="hljs-string"><span class="hljs-string">'$(pwd)/pure_ansible/bin/ansible-playbook'</span></span> <span class="hljs-built_in"><span class="hljs-built_in">alias</span></span> mitogen-ansible-playbook=<span class="hljs-string"><span class="hljs-string">'ANSIBLE_STRATEGY_PLUGINS=$(pwd)/mitogen_ansible/lib/python3.7/site-packages/ansible_mitogen/plugins/strategy ANSIBLE_STRATEGY=mitogen_linear $(pwd)/mitogen_ansible/bin/ansible-playbook'</span></span></code> </pre> <br><p>  Now we will try to start the playbook creating files on the remote machine: </p><br><pre> <code class="plaintext hljs">--- - hosts: all gather_facts: false tasks: - name: Create files with copy content module copy: content: | test file {{ item }} dest: ~/file_{{ item }} with_sequence: start=1 end={{ n }}</code> </pre> <br><p>  And run it with and without Mitogen to create 10 files: </p><br><pre> <code class="bash hljs">time mitogen-ansible-playbook file_creation.yml -i hosts -en=10 &amp;&gt;/dev/null real 0m2.603s user 0m1.152s sys 0m0.096s time pure-ansible-playbook file_creation.yml -i hosts -en=10 &amp;&gt;/dev/null real 0m5.908s user 0m1.745s sys 0m0.643s</code> </pre> <br><p>  We see an improvement of 2 times.  Let's check for 20, 30, ..., 100 files: </p><br><pre> <code class="bash hljs">time pure-ansible-playbook file_creation.yml -i hosts -en=100 &amp;&gt;/dev/null real 0m51.775s user 0m8.039s sys 0m6.305s time mitogen-ansible-playbook file_creation.yml -i hosts -en=100 &amp;&gt;/dev/null real 0m4.331s user 0m1.903s sys 0m0.197s</code> </pre> <br><p>  As a result, we accelerated the execution of more than 10 times! <br>  Now we will try different scenarios and see how much faster everything works with us: </p><br><ul><li><p>  The script for copying files to a remote host from a local host (with a <code>copy</code> module): <br><img src="https://habrastorage.org/getpro/habr/post_images/4e8/349/44b/4e834944bcfe865814d0cdb6538b61c5.svg" alt="Uploading files"></p><br></li><li><p>  The script for creating files on a remote host with a <code>copy</code> module: <br><img src="https://habrastorage.org/getpro/habr/post_images/5dc/3db/ec2/5dc3dbec26ec1f9502e0a270aee5ef2d.svg" alt="Creating files"></p><br></li><li><p>  Script loading files from a remote host to a local host: <br><img src="https://habrastorage.org/getpro/habr/post_images/dfb/fe8/385/dfbfe838521a915708a2f543715c7e25.svg" alt="Fetching files"></p><br></li></ul><br><p>  Let's try a script with several (3) remote machines, for example a script copying files to a remote host: <br><img src="https://habrastorage.org/getpro/habr/post_images/eef/f89/d91/eeff89d9135f5c8890d57e18ec052b8a.svg" alt="Uploading files to multiple hosts"></p><br><p>  As you can see, Mitogen saves us both time and traffic in these scenarios.  But if the bottleneck is not in Ansible, but for example in an I / O disk or network, or anywhere else, then it‚Äôs hard to expect Mitogen to help us. </p><br><p>  Let's try a script with installing packages with yum / dnf and python modules using pip.  Packages were cached so as not to depend on glitches on the network: </p><br><pre> <code class="plaintext hljs">--- - hosts: all gather_facts: false tasks: - name: Install packages become: true package: name: - samba - httpd - nano - ruby state: present - name: Install pip modules become: true pip: name: - pytest-split-tests - bottle - pep8 - flask state: present</code> </pre><br><p>  With Mitogen, it took 12 seconds, as well as without it. <br>  On the <a href="https://mitogen.networkgenomics.com/ansible_detailed.html">Mitogen for Ansible page</a> you can see other benchmarks and tests.  As stated on the page: </p><br><blockquote>  Mitogen cannot speed up a module when it is executed.  It can only make the execution of this module as fast as possible. </blockquote><p>  Therefore, it is important to find your bottlenecks in the deployment and if they are due to Ansible, then Mitogen will help you solve them and significantly speed up the execution of your playbooks. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/453520/">https://habr.com/ru/post/453520/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../453502/index.html">My rake: from rags to riches</a></li>
<li><a href="../453508/index.html">Man without a smartphone</a></li>
<li><a href="../453510/index.html">All Your Own: Tutorial on Creating New Actions for UiPath RPA</a></li>
<li><a href="../453512/index.html">Style transfer</a></li>
<li><a href="../453514/index.html">Introductory Offers Guide for iOS</a></li>
<li><a href="../453522/index.html">Happy Birthday, Habr ‚ù§</a></li>
<li><a href="../453524/index.html">The digest of interesting materials for the mobile # 299 developer (May 20 - 26)</a></li>
<li><a href="../453526/index.html">ITSM - what is it and where to start implementation</a></li>
<li><a href="../453528/index.html">Psion SIBO - PDAs that don't even need to be emulated</a></li>
<li><a href="../453534/index.html">Physics teacher conquers Big Data in Scotland</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>