<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Contracts in D</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good day, Habr! 

 Today I want to tell you about contract programming and its implementation in D. This is a very interesting concept of building an ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Contracts in D</h1><div class="post__text post__text-html js-mediator-article">  Good day, Habr! <br><br>  Today I want to tell you about contract programming and its implementation in D. This is a very interesting concept of building an API.  The point is in the formal specification of the function or class at the code level, not a comment. <br><br>  An example of a similar specification for a function: <br><a name="habracut"></a><br><pre><code class="hljs pgsql"><span class="hljs-type"><span class="hljs-type">float</span></span> foo( <span class="hljs-type"><span class="hljs-type">float</span></span> <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> //  ,  ,      { <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span>( <span class="hljs-number"><span class="hljs-number">0</span></span> &lt;= <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> &amp;&amp; <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> &lt;= <span class="hljs-number"><span class="hljs-number">1</span></span>, "value out of range [0,1]" ); //     "    " } <span class="hljs-keyword"><span class="hljs-keyword">out</span></span>( result ) //            ,    <span class="hljs-type"><span class="hljs-type">void</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span>( <span class="hljs-number"><span class="hljs-number">0</span></span> &lt;= result &amp;&amp; result &lt; <span class="hljs-number"><span class="hljs-number">100</span></span>, "bad result" ); //   : "  ,   ,     " } body //    (<span class="hljs-keyword"><span class="hljs-keyword">in</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">out</span></span>)   body ,    { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> * <span class="hljs-number"><span class="hljs-number">20</span></span> + sqrt( <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> ); }</code> </pre> <br>  The code in the in and out blocks is a normal code, except that the restrictions of the nothrow modifier are not distributed to it, which is logical, since the meaning of the contract is to throw an exception if it is not followed. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      It is important to understand that contracts <b>do not</b> replace the in-house verification of input data (inside the function body) and they should not affect the logic of work in any way (change any data), since they <b>do not</b> fall into release.  This is an additional software verification tool, the ‚Äúcode documentation‚Äù of a specific API, so to speak.  That is, the debug version of the program is run based on real data and, in case of non-compliance with any contract, terminates execution with a diagnostic error, which signals, first of all, about incorrect use of any API or incorrect algorithm, and not about an error in the input data.  If there were no errors, then all calls go according to the contract specifications, and not the fact that the input data passed the test. <br><br>  We dealt with the general moments, further more juicy: contracts and OOP. <br><br>  Let's start with the simple: <br><br><pre> <code class="hljs scala"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Foo</span></span></span><span class="hljs-class"> </span></span>{ float <span class="hljs-keyword"><span class="hljs-keyword">val</span></span>; invariant { assert( <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">"bad val"</span></span> ); } }</code> </pre><br>  A new invariant keyword is added.  The invariant-code block checks the state of an object 2 times - before and after calls to public and protected methods.  The first time the invariant block is executed after the in block, before the method body, the second time immediately after the method body and before the out block.  There are several invariant blocks, the order of the declaration does not matter.  They can be used only within classes, structures, and unions (union); for interfaces, this is not allowed, as is the declaration of invariant blocks at the module level.  The code of such blocks must use const methods to access the state of the object. <br><br>  Calling private methods does not lead to invariant block calling, which is logical - inside public and protected methods, several private methods can be called that cause an object to be invalid, the main thing is that the state should become valid by the end of the calling public or protected method.  Thus, the validity of the state of the object is always guaranteed when calling its methods from the outside, and the fact that it is done inside is implementation details, the object user will not be able to ‚Äúcatch the object‚Äù when it is in an invalid state between calls to private methods. <br><br>  The invariant block is not called before the constructor is called, since an object that is waiting for construction is by definition not valid (otherwise there would be no need to write a constructor).  The reverse point about the destructor is that the invariant is not called after it, which is also logical, since the object was not valid after the destruction.  Also for constructors and destructors, the out block is forbidden (for lack of meaning). <br><br>  During inheritance, invariant blocks of both the base and derived classes must be respected, that is, they must not be mutually exclusive.  Also with out blocks for overridden methods: the result of the method operation must satisfy the contract of both the base and derived class. <br><br>  The in contracts for redefined methods have a different logic, which for me personally was not at all obvious. <br><br>  Example: <br><br><pre> <code class="hljs cpp"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>.stdio; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>.<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">label</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> f=__FUNCTION__,Args...)</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( Args args )</span></span></span></span>{ writeln( f, <span class="hljs-string"><span class="hljs-string">": "</span></span>, args ); } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">A</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">float</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">calc</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params"> val )</span></span></span><span class="hljs-function"> in </span></span>{ label; assert( val &gt; <span class="hljs-number"><span class="hljs-number">0</span></span> ); } out( res ) { assert( res &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>, format( <span class="hljs-string"><span class="hljs-string">"%f &lt; 0"</span></span>, res ) ); label; } body { label; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> val * <span class="hljs-number"><span class="hljs-number">2</span></span>; } } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">B</span></span></span><span class="hljs-class"> :</span></span> A { <span class="hljs-function"><span class="hljs-function">override </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">float</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">calc</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params"> val )</span></span></span><span class="hljs-function"> in </span></span>{ label; assert( val &lt; <span class="hljs-number"><span class="hljs-number">0</span></span> ); } body { label; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> -val * <span class="hljs-number"><span class="hljs-number">4</span></span>; } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> x = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> B; x.calc( <span class="hljs-number"><span class="hljs-number">10</span></span> ); }</code> </pre><br>  It can be assumed that such a code will fall down on checking the conditions in the in block of the overloaded function calc (B.calc), but we see a different picture: <br><br><pre> <code class="hljs pgsql">contract_in.A.calc.__require: //    <span class="hljs-keyword"><span class="hljs-keyword">in</span></span>   contract_in.B.calc: //     calc   core.<span class="hljs-keyword"><span class="hljs-keyword">exception</span></span>.AssertError@contract_in.d(<span class="hljs-number"><span class="hljs-number">10</span></span>): <span class="hljs-number"><span class="hljs-number">-40.000000</span></span> &lt; <span class="hljs-number"><span class="hljs-number">0</span></span> //     <span class="hljs-keyword"><span class="hljs-keyword">out</span></span>   </code> </pre><br>  An in block for an overloaded method was not called at all!  This is due to the fact that the in block expands the possible range of input options, that is, in the derived class inside in, we kind of write ‚Äúand now I can also process this,‚Äù unlike other contracts (out and invariant), which are characterized with such a phrase: ‚Äúthis condition must also be fulfilled.‚Äù  You can compare the behavior of the out and invariant block combinations with a logical evaluation of the AND operation (all must be true for the result to be true) and the in behavior with an OR operation (true must be at least one).  Therefore, the in block for B.calc will be called only when the in block for A.calc has completed with the exception. <br><br><pre> <code class="hljs css">... <span class="hljs-selector-tag"><span class="hljs-selector-tag">x</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.calc</span></span>( <span class="hljs-selector-tag"><span class="hljs-selector-tag">-10</span></span> ); ...</code> </pre><br><pre> <code class="hljs pgsql">contract_in.A.calc.__require: //  <span class="hljs-keyword"><span class="hljs-keyword">in</span></span>   -  contract_in.B.calc.__require: //  <span class="hljs-keyword"><span class="hljs-keyword">in</span></span>   -  contract_in.B.calc: contract_in.A.calc.__ensure: //   - </code> </pre><br>  In fact, the code in the example above is not correct, it should be rewritten as follows: <br><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">class</span></span> B : A { override <span class="hljs-type"><span class="hljs-type">float</span></span> calc( <span class="hljs-type"><span class="hljs-type">float</span></span> val ) <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> { label; <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span>( val &lt; <span class="hljs-number"><span class="hljs-number">0</span></span> ); } //   body { label; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( val &lt; <span class="hljs-number"><span class="hljs-number">0</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> -val * <span class="hljs-number"><span class="hljs-number">4</span></span>; //       (   ) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> super.calc( val ); //      } }</code> </pre><br>  Now when we call calc (10), we will see: <br><br><pre> <code class="hljs ruby">contract_in.A.calc.<span class="hljs-symbol"><span class="hljs-symbol">__require:</span></span> /<span class="hljs-regexp"><span class="hljs-regexp">/  in   -  contract_in.B.calc: /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/       else    contract_in.A.calc.__require: /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/    in   contract_in.A.calc: /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/    contract_in.A.calc.__ensure: /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/    ,    contract_in.A.calc.__ensure: /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/    ,     (   out  )</span></span></code> </pre><br>  If you specify a value that does not match any input contract (in this case, 0), the exception will be thrown from the in block of the derived class. <br><br>  It seems that all aspects of contract programming in D that I know about.  I hope you have learned something new. <br><br>  I want to note that the embedded documentation system does not add the contract code to the documentation, only the signature of the function, unlike third-party documentation generation systems, for example <a href="https://github.com/kiith-sa/harbored-mod">hmod</a> . </div><p>Source: <a href="https://habr.com/ru/post/260779/">https://habr.com/ru/post/260779/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../260769/index.html">Action-Domain-Responder - revision of MVC for web tasks</a></li>
<li><a href="../260771/index.html">Forecast for Specification pattern in Domain layer - problems are expected</a></li>
<li><a href="../260773/index.html">Java string processing Part II: Pattern, Matcher</a></li>
<li><a href="../260775/index.html">How I Made and Sold the Axure 7 Course</a></li>
<li><a href="../260777/index.html">Favicons, Touch Icons, Tile Icons, etc. What to choose?</a></li>
<li><a href="../260781/index.html">Why I do not teach SOLID and the "principle of eliminating dependencies"</a></li>
<li><a href="../260783/index.html">Acquaintance with the robotic constructor TRIK: reverse pendulum</a></li>
<li><a href="../260787/index.html">The digest of interesting materials for the mobile developer # 108 (June 15-21)</a></li>
<li><a href="../260789/index.html">Node Webkit without webkit</a></li>
<li><a href="../260791/index.html">Howto Qemu-kvm Debian 8</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>