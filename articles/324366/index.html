<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Tracking js errors with Metrics</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Using the tracking system js-errors can not be overestimated. Even on the site covered by tests js-errors occur, it is important to find and fix them....">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Tracking js errors with Metrics</h1><div class="post__text post__text-html js-mediator-article"><p>  Using the tracking system js-errors can not be overestimated.  Even on the site covered by tests js-errors occur, it is important to find and fix them.  I'll tell you how I was looking for a suitable solution. <a name="habracut"></a></p><br><p>  There are three types of js error tracking systems. </p><br><h3 id="pervyy-vid">  First view </h3><br><p>  Samopisnaya system.  Add a compact js-code to the site: </p><br><pre><code class="hljs javascript"><span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.onerror = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">msg, file, line, col</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Image().src = <span class="hljs-string"><span class="hljs-string">'/jserrors/?msg='</span></span> + msg + ...; }</code> </pre> <br><p>  Make a "handle" to save errors, parsim logs.  At the best, we write the interface for the analysis of errors.  Then we are engaged in refinement and support. </p><br><h3 id="vtoroy-vid">  Second kind </h3><br><p>  Paid service with advanced features, but with restrictions, for example, on the number of js-errors per day or month.  It‚Äôs impossible to put this system on any website, every time you have to choose which of your websites is ‚Äúworthy‚Äù of a paid service.  And do not forget to pay for services. </p><br><p>  You will need to add an external script to the site, which will adversely affect the speed of loading your site. </p><br><h3 id="tretiy-vid">  Third type </h3><br><p>  To use the analytics system for collecting errors, for this you need to install its full-fledged tracking code on the site. </p><br><p>  Since the tracking code is loaded asynchronously, sending errors will be available only after it is loaded.  This system should have reports that can be independently generated. </p><br><h3 id="reshenie">  Decision </h3><br><p>  Combine the first and third species.  Errors will be manually sent to <a href="https://metrika.yandex.ru/">Yandex.Metrica</a> using a compact js-code.  The Metric has the necessary reports and tools for data analysis, there are no special restrictions on the number of counters and data collected, and it is free. </p><br><p>  To collect errors, the report ‚Äú <a href="">Visit parameters</a> ‚Äù is suitable. </p><br><ol><li><p>  <a href="https://metrika.yandex.ru/add">Let's start a</a> separate counter. </p><br></li><li><p>  Add to the page <strong>in front of all the scripts</strong> compact code: </p><br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span><span class="xml"><span class="xml"> //   320   . window.onerror = function(msg, file, line, col, err) { //    . if (!window.JSON) { return; } var counterId = 12345, //    . siteInfo = {}, pointer = siteInfo, //   . path = [ 'JS errors', // 1  msg, // 2  err &amp;&amp; err.stack || (file + ':' + line + ':' + col) // 3  //   ?  ! ]; //         . for (var i = 0; i </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">path.length</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">-</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">1</span></span></span></span><span class="xml"><span class="hljs-tag">; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span></span><span class="xml"><span class="hljs-tag">++) { </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">var</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">item</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">path[i];</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">pointer</span></span></span></span><span class="xml"><span class="hljs-tag">[</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">item</span></span></span></span><span class="xml"><span class="hljs-tag">] = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{};</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">pointer</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">pointer[item];</span></span></span></span><span class="xml"><span class="hljs-tag"> } </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">pointer</span></span></span></span><span class="xml"><span class="hljs-tag">[</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">path</span></span></span></span><span class="xml"><span class="hljs-tag">[</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span></span><span class="xml"><span class="hljs-tag">]] = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">1;</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">new</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">Image</span></span></span></span><span class="xml"><span class="hljs-tag">()</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">.src</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">'https://mc.yandex.ru/watch/'</span></span></span></span><span class="xml"><span class="hljs-tag"> + </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">counterId</span></span></span></span><span class="xml"><span class="hljs-tag"> + '/?</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">site-info</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">' + encodeURIComponent(JSON.stringify(siteInfo)) '</span></span></span></span><span class="xml"><span class="hljs-tag">&amp;</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">rn</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">' + Math.random(); }; </span></span></span></span></span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br></li><li><p>  Do not forget to specify your counter number (counterId) in the code. </p><br></li><li>  We get something <a href="https://metrika.yandex.ru/stat/user_vars%3Fgroup%3Ddekaminute%26chart_type%3Dpie%26period%3D2017-03-12%253A2017-03-12%26id%3D43395579">like this report</a> : </li></ol><br><p> <a href="https://metrika.yandex.ru/stat/user_vars%3Fgroup%3Ddekaminute%26chart_type%3Dpie%26period%3D2017-03-12%253A2017-03-12%26id%3D43395579"><img src="https://habrastorage.org/files/3c2/994/ae4/3c2994ae44994c47a9da2f08971db566.png"></a> </p><br><p>  The structure and order of parameters in the report can be changed on the fly, as well as add new parameters.  Let's add a <a href="https://metrika.yandex.ru/stat/user_vars%3Fselected_rows%3DyZkKR9%26chart_type%3Dpie%26period%3D2017-03-12%253A2017-03-12%26metrics%3Dym%253As%253Avisits%252Cym%253As%253AsumParams%26dimensions%3Dym%253As%253AparamsLevel1%252Cym%253As%253AoperatingSystemRoot%252Cym%253As%253Abrowser%252Cym%253As%253AparamsLevel2%252Cym%253As%253AparamsLevel3%252Cym%253As%253AparamsLevel4%252Cym%253As%253AparamsLevel5%26id%3D43395579">browser and OS</a> to the report using the ‚ÄúGrouping‚Äù button. <br> <a href="https://metrika.yandex.ru/stat/user_vars%3Fselected_rows%3DyZkKR9%26chart_type%3Dpie%26period%3D2017-03-12%253A2017-03-12%26metrics%3Dym%253As%253Avisits%252Cym%253As%253AsumParams%26dimensions%3Dym%253As%253AparamsLevel1%252Cym%253As%253AoperatingSystemRoot%252Cym%253As%253Abrowser%252Cym%253As%253AparamsLevel2%252Cym%253As%253AparamsLevel3%252Cym%253As%253AparamsLevel4%252Cym%253As%253AparamsLevel5%26id%3D43395579"><img src="https://habrastorage.org/files/af0/01a/0ad/af001a0ada1f424b887cdf2f7d095587.png"></a> <br><br> <a href="https://metrika.yandex.ru/stat/user_vars%3Fselected_rows%3DyZkKR9%26chart_type%3Dpie%26period%3D2017-03-12%253A2017-03-12%26metrics%3Dym%253As%253Avisits%252Cym%253As%253AsumParams%26dimensions%3Dym%253As%253AparamsLevel1%252Cym%253As%253AoperatingSystemRoot%252Cym%253As%253Abrowser%252Cym%253As%253AparamsLevel2%252Cym%253As%253AparamsLevel3%252Cym%253As%253AparamsLevel4%252Cym%253As%253AparamsLevel5%26id%3D43395579"><img src="https://habrastorage.org/files/b26/e2d/7fb/b26e2d7fba15464ab9bf8e5cabdbfe35.png"></a> </p><br><p>  And one more thing, if the scripts on the site are loaded from another domain (CDN), then the report will most likely see messages like ‚ÄúScript error‚Äù and without a stack. <br>  To return a normal view to messages, you need to add the <code>crossorigin="anonymous"</code> attribute to the scripts and the <code>Access-Control-Allow-Origin:"*"</code> HTTP header <code>Access-Control-Allow-Origin:"*"</code> . </p><br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"https://mycdn.com/folder/file.js"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">crossorigin</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"anonymous"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><p>  Gradually, the report will contain errors from browser extensions, viruses, and external scripts (advertising systems, social networking buttons, etc.).  To separate these errors, we will add check of the domain at scripts by means of the regular expression. </p><br><p>  Additionally, add a limit on the collected number of errors (no more than 5) on the page.  For example, the same type of errors that occur when moving the mouse, can create hundreds of requests to the Metric. </p><br><p>  In modern browsers, we will send data via <code>sendBeacon</code> . </p><br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span><span class="javascript"><span class="javascript"> </span><span class="hljs-built_in"><span class="javascript"><span class="hljs-built_in">window</span></span></span><span class="javascript">.onerror = </span><span class="hljs-function"><span class="hljs-keyword"><span class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span></span><span class="javascript"><span class="hljs-function"> </span></span><span class="hljs-title"><span class="javascript"><span class="hljs-function"><span class="hljs-title">handler</span></span></span></span><span class="javascript"><span class="hljs-function">(</span></span><span class="hljs-params"><span class="javascript"><span class="hljs-function"><span class="hljs-params">msg, file, line, col, err</span></span></span></span><span class="javascript"><span class="hljs-function">) </span></span></span><span class="javascript">{ </span><span class="hljs-keyword"><span class="javascript"><span class="hljs-keyword">if</span></span></span><span class="javascript"> (!</span><span class="hljs-built_in"><span class="javascript"><span class="hljs-built_in">window</span></span></span><span class="javascript">.JSON || handler.count &gt; </span><span class="hljs-number"><span class="javascript"><span class="hljs-number">5</span></span></span><span class="javascript">) { </span><span class="hljs-keyword"><span class="javascript"><span class="hljs-keyword">return</span></span></span><span class="javascript">; } </span><span class="hljs-keyword"><span class="javascript"><span class="hljs-keyword">var</span></span></span><span class="javascript"> counterId = </span><span class="hljs-number"><span class="javascript"><span class="hljs-number">12345</span></span></span><span class="javascript">, </span><span class="hljs-comment"><span class="javascript"><span class="hljs-comment">//    . siteInfo = {}, pointer = siteInfo, stack = err &amp;&amp; err.stack, path = [ //     ,       . 'JS ' + (!file || /mysite\.ru|cdn\.com/.test(file) ? 'in' : 'ex') + 'ternal errors', 'message: ' + msg, stack ? 'stack: ' + stack : (file ? 'file: ' + file + ':' + line + ':' + col : 'nofile'), 'href: ' + location.href ]; for (var i = 0; i &lt; path.length - 1; i++) { var item = path[i]; pointer[item] = {}; pointer = pointer[item]; } pointer[path[i]] = 1; var url = 'https://mc.yandex.ru/watch/' + counterId + '/' + '?site-info=' + encodeURIComponent(JSON.stringify(siteInfo)) + '&amp;rn=' + Math.random(); if (typeof navigator.sendBeacon === 'function') { navigator.sendBeacon(url, ' '); } else { new Image().src = url; } if (handler.count) { handler.count++; } else { handler.count = 1; } }; </span></span></span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><p>  And yet, data on errors can be obtained using the <a href="https://tech.yandex.ru/metrika/">API</a> and do anything with them. </p><br><p>  Do not forget to add links to error reports in your documentation in a prominent place. <br>  And to give <a href="">access</a> to the reports to the other developers from the group so that the correction of errors turned into a competition. </p><br><p>  References: </p><br><ul><li>  <a href="https://github.com/hcodes/metrika-js-errors/">Github</a> </li><li>  Report " <a href="">Parameters of visits</a> " </li><li>  <a href="https://metrika.yandex.ru/stat/user_vars%3Fselected_rows%3DyZkKR9%26chart_type%3Dpie%26period%3D2017-03-12%253A2017-03-12%26metrics%3Dym%253As%253Avisits%252Cym%253As%253AsumParams%26dimensions%3Dym%253As%253AparamsLevel1%252Cym%253As%253AoperatingSystemRoot%252Cym%253As%253Abrowser%252Cym%253As%253AparamsLevel2%252Cym%253As%253AparamsLevel3%252Cym%253As%253AparamsLevel4%252Cym%253As%253AparamsLevel5%26id%3D43395579">Sample Report</a> in Metric </li></ul></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/324366/">https://habr.com/ru/post/324366/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../324354/index.html">Project Olympus: Microsoft‚Äôs own open-source server equipment</a></li>
<li><a href="../324358/index.html">Best practices for search results</a></li>
<li><a href="../324360/index.html">[NeoQuest2017] 6 planet or "Too much of everything ..."</a></li>
<li><a href="../324362/index.html">IBM offers a new way to superdense information: 1 bit to 1 atom</a></li>
<li><a href="../324364/index.html">The best reports of HolyJS 2016 Moscow: Access open</a></li>
<li><a href="../324368/index.html">How to choose NGFW or what manufacturers keep back?</a></li>
<li><a href="../324370/index.html">Set method</a></li>
<li><a href="../324372/index.html">How and why static analyzers deal with false positives</a></li>
<li><a href="../324374/index.html">CEPH for pumping</a></li>
<li><a href="../324376/index.html">Exceptions in Windows x64. How it works. Part 3</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>