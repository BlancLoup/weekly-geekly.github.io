<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>RocksDB server - fast key-value storage for SSD drives</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="RocksDB is a permanent key-value storage for fast drives. Its main purpose is to store data on flash drives. 

 A performance bottleneck is often data...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>RocksDB server - fast key-value storage for SSD drives</h1><div class="post__text post__text-html js-mediator-article"><img src="http://alpha.hstor.org/files/a49/6e6/929/a496e6929797428fa90a8cb55492354f.png" alt="RocksDB" align="left">  <a href="http://rocksdb.org/">RocksDB</a> is a permanent key-value storage for fast drives.  Its main purpose is to store data on flash drives. <br><br>  A performance bottleneck is often database access. <br>  This problem can be solved in different ways. <br>  Using the cache solves the performance problem, but significantly complicates the program architecture.  Graph database out of the situation due to the optimal algorithms for this task.  Another type of solution is storage, achieving high performance through the use of fast media. <br>  Recently, a lot of NoSQL repositories have appeared that completely store data in memory.  But the memory is still expensive and its volume is limited.  The increase in memory due to sharding again rests on the cost. <br>  The logical way out would be to use SSD drives.  They have a relatively low cost and at the same time quite short response time. <br><br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Unfortunately, despite the fact that SSD drives have been around for several years, not many databases are optimized to work with them.  The main problem when using an SSD disk as a carrier for a database is multiple rewriting of the same blocks.  T.N.Z.  "Freezing". <br><br>  RocksDB is a flexible, productive NoSQL embedded storage.  It is designed for use on fast media, such as SSD drives.  It is written in Facebook and is based on LevelDB Google. <br>  If you don‚Äôt go into details, the main differences from LevelDB are the engine optimized for working with flash drives;  optimization for working with large amounts of data;  Greater flexibility and expandability and, as a result, many tasty buns that are absent in LevelDB. <br><br>  As I said, RocksDB is an embedded solution.  And in order to be able to use it, you need to either build it into your application, or wrap it in a server.  I needed it for use in web applications.  And, for certain reasons, due to the fact that only one process (but not the thread) can have access to it at the same time, I just needed a server. <br>  I learned about RocksDB about a year ago and waited patiently for someone to start writing a server for it.  All that appeared during this time did not fully suit me.  So I decided to write my own server wrapper over RocksDB. <br><br>  <a href="https://github.com/valmat/RocksServer">RocksServer</a> is a single- <a href="https://github.com/valmat/RocksServer">stream</a> http server that provides access to RocksDB. <br><br>  The server is written in C ++.  <a href="http://libevent.org/">Libevent</a> was used to implement the http layer. <br>  In addition to Libevent and RocksDB, the code does not contain any other dependencies. <br><br>  RocksDB has very rich features.  I have implemented only the basic functionality I need at the moment.  In the future, of course, as far as possible, I plan to expand the functionality of the server. <br><br>  I did not conduct large-scale benchmarks, but preliminary measurements of performance showed <a href="http://www.valmat.ru/2014/08/rocksdb-mikro-bench.html">quite decent</a> results. <br><br>  Currently supported operations: <br><table><tbody><tr><td>  Get </td><td>  get one value by key </td></tr><tr><td>  Multi get </td><td>  atomically get multiple values ‚Äã‚Äãon a set of keys </td></tr><tr><td>  Set </td><td>  set one value by key </td></tr><tr><td>  Multi set </td><td>  atomically set multiple values ‚Äã‚Äãon a set of keys </td></tr><tr><td>  Delete key </td><td>  remove key from DB </td></tr><tr><td>  Multi delete </td><td>  atomically delete multiple keys </td></tr><tr><td>  Check key exist </td><td>  quick check of the existence of a key in the database (with the ability to quickly retrieve values) </td></tr><tr><td>  Imcrement </td><td>  atomic increase / decrease values ‚Äã‚Äãby a given value </td></tr></tbody></table><br>  If necessary, the list of operations can be easily expanded.  To do this, just need to implement the interface: <br><br><pre><code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RequestBase</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">virtual</span></span> ~RequestBase() {} <span class="hljs-comment"><span class="hljs-comment">/** * Runs request listener * @param event request object * @param event buffer object */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> EvRequest &amp;, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> EvBuffer &amp;)</span></span></span><span class="hljs-function"> </span></span>= <span class="hljs-number"><span class="hljs-number">0</span></span>; };</code> </pre> <br><br>  For example, depending on your data schema, you may need to implement an atomic keyset insertion / update. <br>  Connecting your handler to the server is also not difficult.  This is done in one line: <br><br><pre> <code class="cpp hljs">server.onRequest(<span class="hljs-string"><span class="hljs-string">"/castom_handler"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Requestastom());</code> </pre><br><br><h5>  Compile / Install </h5><br><br>  As I said, <i>RocksServer</i> has two dependencies: RocksDB itself and http layer in the form of Libevent.  You can install them separately, or you can do without installation by limiting compilation (due to static binding).  For me personally, the latter method is preferable since it allows you to run RocksServer including.  on old servers that do not have all the necessary dependencies. <br><br>  So. <br>  Clone the repository: <br><br><pre> <code class="bash hljs">git <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> --recursive git@github.com:valmat/RocksServer.git <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> RocksServer</code> </pre><br>  or <br><pre> <code class="bash hljs">git <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> git@github.com:valmat/RocksServer.git <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> RocksServer git submodule update</code> </pre><br>  After cloning, Libevent and RocksDB will be in the deps directory. <br>  Then compile the dependencies: <br><br><pre> <code class="bash hljs">./deps/make.sh</code> </pre><br>  After this step, you can, if you want, run the tests or install Libevent and RocksDB on your system. <br>  And you can immediately go to the compilation of RocksServer <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> src make</code> </pre><br>  Your compiler must support <code>C++11</code> standard. <br>  Immediately after compiling RocksServer, you can start it by editing the configuration file: <br><br><pre> <code class="bash hljs">./RocksServer.bin config.ini</code> </pre><br>  And you can install it. <br><pre> <code class="bash hljs">make install</code> </pre><br>  In the latter case, you need to use the <code>init.d</code> script to start / restart / stop: <br><pre> <code class="bash hljs">/etc/init.d/rocksserver start</code> </pre><br>  Most likely, you will want to configure the server for yourself.  All available settings are recorded in the <code>config.ini</code> file. <br><br>  For testing, I put a simple driver in php ( <i>yes, I know that it needs to be rewritten</i> ), or you can directly use the <a href="">protocol</a> .  Including using programs such as <code>Curl</code> and <code>Wget</code> . <br>  The protocol is very simple.  When choosing between RPC and HTTP, the simplicity of the exchange protocol was one of the decisive moments. <br><br>  At the moment, despite the not very rich functionality, RocksServer is completely ready for work.  In any case, I plan to use it in production in the project I am working on now (and wrote for this). <br><br>  Except for me, Valgrind and CppCheck, nobody conducted a review of the code.  Therefore, the fear that something might go wrong is quite normal. <br>  In this case, there is the possibility of logging RocksServer and the ability to make backups, including in human-readable format. <br><br>  To enable logging in the configuration file, you just need to specify the log file: <br><br><pre> <code class="hljs pgsql">; Error <span class="hljs-keyword"><span class="hljs-keyword">log</span></span> file <span class="hljs-type"><span class="hljs-type">name</span></span> ; <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>: /var/<span class="hljs-keyword"><span class="hljs-keyword">log</span></span>/rocksserver/error.<span class="hljs-keyword"><span class="hljs-keyword">log</span></span> ; ; error_log =</code> </pre><br>  And indicate the level of log details: <br><pre> <code class="hljs pgsql">; Error <span class="hljs-keyword"><span class="hljs-keyword">level</span></span> ; Possible <span class="hljs-keyword"><span class="hljs-keyword">values</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">debug</span></span> | msg | warn | error | fatal | <span class="hljs-keyword"><span class="hljs-keyword">none</span></span> ; <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">none</span></span> ; ; log_level =</code> </pre><br>  For backup, you need to specify the directory in which the backups will be added: <br><pre> <code class="hljs sql">; RocksDB <span class="hljs-keyword"><span class="hljs-keyword">backup</span></span> <span class="hljs-keyword"><span class="hljs-keyword">path</span></span> ; The directory in which a <span class="hljs-keyword"><span class="hljs-keyword">backup</span></span> will be <span class="hljs-keyword"><span class="hljs-keyword">stored</span></span> ; default value: /var/rocksserver/<span class="hljs-keyword"><span class="hljs-keyword">backup</span></span> ; ; backup_path =</code> </pre><br>  and perform a <code>POST</code> request to <code>127.0.0.1:5577/backup</code> <br><br>  To restore the database from the backup, use the command <br><pre> <code class="bash hljs">restore -f/path/to/backup -t/path/to/db</code> </pre><br>  To convert a database to a human readable form: <br><pre> <code class="bash hljs">human_readable -f/path/to/db -t/path/to/restore_file</code> </pre><br>  I am planning the following backup scheme: <br><pre> <code class="bash hljs">wget <span class="hljs-string"><span class="hljs-string">"http://localhost:5577/backup"</span></span> --post-data=<span class="hljs-string"><span class="hljs-string">""</span></span> -O - restore -f/path/to/backup -t/path/to/db_on_hdd human_readable -f/path/to/db_on_hdd -t/path/to/restore_file</code> </pre><br><br>  I would appreciate constructive criticism. <br>  Ready to help with installation and configuration. <br>  Well, of course, Pull Requests are welcome. <br>  Thanks for attention. </div><p>Source: <a href="https://habr.com/ru/post/234173/">https://habr.com/ru/post/234173/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../234155/index.html">Replenishment in the Linux Foundation</a></li>
<li><a href="../234161/index.html">TelecityGroup expands its Suvilahti data center in Helsinki</a></li>
<li><a href="../234165/index.html">Video analytics in studies of the effects of stress on the body</a></li>
<li><a href="../234169/index.html">Do not know what your client needs - ask</a></li>
<li><a href="../234171/index.html">Field kitchen for bacteria</a></li>
<li><a href="../234175/index.html">3D modeling of face shape by human genes</a></li>
<li><a href="../234177/index.html">Wal Commander - replacement Far Manager for Linux</a></li>
<li><a href="../234179/index.html">Game quiz: from idea to appstore</a></li>
<li><a href="../234181/index.html">Intelligent user object handles in MultiCAD.NET</a></li>
<li><a href="../234183/index.html">Conversion optimization: ruthless criticism of 10 landing pages</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>