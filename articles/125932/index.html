<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>The story of how lightning "killed" the Amazon cloud</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="As one of our partners wrote on his Twitter : ‚ÄúWrite about five years ago,‚Äú lightning caused a cloud to fall ‚Äùand you would be considered an idiot.‚Äù B...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>The story of how lightning "killed" the Amazon cloud</h1><div class="post__text post__text-html js-mediator-article">  As one of our partners <a href="http://twitter.com/unnamed777/status/100543584863916032">wrote on his Twitter</a> : ‚ÄúWrite about five years ago,‚Äú lightning caused a cloud to fall ‚Äùand you would be considered an idiot.‚Äù  But this is exactly what happened on Sunday evening - <a href="http://www.irishtimes.com/newspaper/breaking/2011/0808/breaking20.html">lightning hit the transformer</a> , which completely de-energized the Amazon data center in Ireland.  Unfortunately, the sites of the company ‚Äú1C-Bitrix‚Äù were located in this data center. <br><br><img src="https://habrastorage.org/storage1/5f252dee/29c41092/fd314ec8/7c692b46.jpg"><br><br>  We sincerely apologize to all our customers and partners to whom the temporary unavailability of our sites could cause some inconvenience. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      And today we want to tell you about ‚Äúhow it was‚Äù, about our actions and conclusions that we made after this incident. <a name="habracut"></a><br><br>  The whole story "through the eyes of Amazon" is available on a special site that allows you to monitor all of the services of Amazon - <a href="http://status.aws.amazon.com/">status.aws.amazon.com</a> : <br><table><tbody><tr><td>  <i>11:13 AM PDT We are investigating connectivity issues in the EU-WEST-1 region.</i> <i><br></i>  <i>11:27 AM PDT EC2 APIs in the EU-WEST-1 region are currently impaired.</i>  <i>We are working to restore full service.</i>  <i>We are also investigating an instance of the availability zone.</i> </td></tr></tbody></table><br>  <b>The recorded beginning of the accident - August 7th (Sunday) at 21:13 (Moscow time).</b> <br><br>  The first minus in karma is to us - we, for our part, have not monitored the problem.  Why did it happen? <br><br>  All websites of our company are served by several servers in the ‚Äúcloud‚Äù: two virtual machines ‚Äî cluster backends, one machine ‚Äî a load balancer between them, and another machine ‚Äî a monitoring server that has nagios installed, monitoring a bunch of different services we need ( Load average on servers, correct replication in MySQL, launching the processes we need, etc.) <br><br><img src="https://habrastorage.org/storage1/883cb670/860d3de8/a4ff9e16/5dce7e8d.png"><br><br>  In fact, we are monitoring everything.  In addition to the monitoring itself.  And this server was in the same data center.  That is why we learned about the problem only on Monday morning. <br><br>  First conclusion: it is necessary to duplicate the monitoring, to use completely external resources for its purposes. <br><br>  But, let's continue ... Monday, morning, sites are not available.  The administrative interface of Amazon says that the machines are running.  However, from the outside, only some of them are accessible from the Internet, and there is no connection between them inside.  At the same time, the picture changes periodically, something that was previously available is no longer available, which gives some hope that Amazon engineers are working and everything will be available soon. <br><table><tbody><tr><td>  <i>9:36 PM PDT We have now recovered 75% of the impacted instances.</i> </td></tr></tbody></table><br>  A small digression - why the data recovery process on the part of Amazon takes so long. <br><br>  Raising the virtual machines themselves is not such a big problem.  Worse discs.  In terms of Amazon, this is <b>EBS (Elastic Block Store)</b> , some virtual block devices that can be mounted like regular drives, organized as RAID, and so on. <br><br>  Due to the accident, the servers controlling EBS were de-energized.  As a result, according to Amazon, it required many manual operations, the creation of additional copies of data and the emergency commissioning of additional capacity. <br><br>  Back to our story.  At about 11 am on Monday, it became clear that the quick recovery of our machines would not happen: both cluster backends (files, base) were inaccessible. <br><br>  A quick launch option is to bring up a new virtual machine in another data center, but in the same <b>Availability Zone</b> . <br><br>  <b>Why so, and what is the Availability Zone?</b> <br><br>  One zone combines several data centers.  It is within one zone that, for example, using Amazon tools, can quickly make a <b>snapshot of a</b> disk and connect it as a new disk to another server, even located in another data center.  It is important that he be in the same ‚Äúzone‚Äù.  Also, it is within the same zone that you can switch between different servers (including - and in different data centers) <b>Elastic IP</b> - external IP-addresses by which virtual servers are available. <br><br>  Amazon has several availability zones: US East, US West, Asia Pacific (Singapore), Asia Pacific (Tokyo) and the EU - Ireland, where our servers are located. <br><br>  At the same time in Ireland - three data centers.  Let's call them conditionally A, B, C. <br><br>  The very first thought was the decision to launch in general in another zone.  For example, somewhere in the States.  But practice has shown that this would be an extremely long process - all the data (and we have several hundred gigabytes of it) would have to tediously and for a long time to copy over the network.  And the main difficulty would be that for a start it would be necessary to raise the server from which everything can be copied. <br><br>  (Well, if we have already found the opportunity to raise it, then why not just launch a website on it?) <br><br>  So.  All our servers were located in the data center A. Yes, of course, it would be more correct to install them in different data centers (to ensure reliability).  However, in terms of performance (file synchronization, replication in MySQL), it is more convenient to use a configuration in which there is minimal network latency between servers. <br><br>  <b>1.</b> We have raised a new car in the data center B - a similar configuration. <br><br>  <b>2. The</b> root section (/ - all software settings, etc.) was transferred from one of the cluster backends in several steps (fortunately, despite the fact that the machine was not available via the Internet, most of the operations could be performed from the Amazon admin panel ): <br><ul><li>  made a snapshot of the disk from the old machine in the data center A; </li><li>  a disk (volume) made available in data center B was made from a snapshot; </li><li>  The new drive is mounted on a new machine in the data center B. </li></ul><br>  The whole operation (as opposed to a simple copy) is performed fairly quickly, takes minutes.  By the way, this is the standard data transfer mechanism between different data centers in Amazon.  But, as mentioned above, it works only within the same Availability Zone. <br><br>  <b>3.</b> The next step is the transfer of basic data (content, database).  We have them on RAID-10, which provides both speed and reliability. <br><br>  And - the problem.  Not from all disks of raid it turns out to make snapshot.  We get in the admin short and not very capacious: " <i>Internal error</i> ". <br><br>  For the files, we take a daily backup (snapshots of all the disks, including the raid disks, are automatically made once a day).  Restoring RAID (the procedure for backup and restoring software RAID-10 is generally a separate topic, if someone is interested in it - write, tell). <br><br>  <b>4.</b> I don‚Äôt really want to use a daily backup for the database, this is the most extreme measure.  Losing the latest changes in the database, got from the site - very, very sad ... <br><br>  And here we are saved by the fact that in our web cluster in MySQL replication, not one slave was connected (on the second backend), but two.  The second slave was on the monitoring machine and was used only as a real-time backup: the data on this server was copied in real time, but requests to this server were not distributed. <br><br>  It would seem that happiness is already close ... However, at the time of copying MySQL data to a new machine ... this machine is no longer available. <br><br>  It was about 13: 00-13: 30.  Ironically adds the fact that at about the same time the next, quite positive, Amazon update appeared: <br><table><tbody><tr><td>  <i>2:26 AM PDTs, we‚Äôve been able to keep track of the EBS backed EC2 instances.</i>  <i>We're continuing to bring additional capacity online.</i>  <i>We will continue to post updates as we have new information.</i> </td></tr></tbody></table><br>  It sounds positive, but in practice it means that the storage inside one zone is centralized.  And even the fact that lightning has de-energized only one data center does not guarantee us that everything will work well in another data center. <br><br>  We never saw the new car in the data center B anymore ... <br><br>  By the way, it still remains in some ‚Äúsuspended‚Äù state (status - stopping): <br><br><img src="https://habrastorage.org/storage1/0f56b259/9c061535/ceee9544/3e5386a8.png"><br><br>  At 13:30, the next stage of recovery began - we raised a new car in the data center C. <br><br>  The above paragraphs 1-3 were repeated.  Point 4 - successfully completed. <br><br>  <b>5.</b> Switched the MySQL database from slave mode to master mode. <br><br>  <b>6.</b> Corrected all configuration files, started all services. <br><br>  <b>7.</b> Checked the work of the site, after which they switched the external Elastic IP (actually, the address to which <a href="http://www.1c-bitrix.ru/">www.1c-bitrix.ru resolves</a> ) to a new machine in the admin panel of Amazon. <br><br>  It was about 3:30 PM Monday. <br><br>  * * * <br><br>  The inaccessibility of sites is always unpleasant.  However, even in spite of such a regrettable incident, we tried to extract a maximum of experience from it and draw several conclusions. <br><br>  1. Many people asked the question: ‚Äú <i>How did the cloud help you?</i>  " <br><br>  It helped a lot - no matter how paradoxical it sounds, the speed of recovery.  A few hours (in fact - for two restorations) - this is a very good result. <br><br>  If we were located in a datacenter on real physical servers: <br><ul><li>  If this data center were de-energized, we would not have access to our data.  At all.  We would wait for it to rise. </li><li>  If you did not want to wait, you would need to take data from the backup.  From which?  How and where to do it?  In another datacenter? </li><li>  The good question is which other data center to move during an accident.  Finding the server we need configuration - not the most trivial task.  Time consuming. </li><li>  Moved  It is necessary to change the DNS.  It is time again. </li></ul><br>  We didn‚Äôt have any disappointment in the cloud concept. <br><br>  2. Another question: ‚Äú <i>How did your cluster help you?</i>  " <br><br>  The most important advantage is the availability of relevant data. <br><br>  Without them, we would wait for the service to be restored in Amazon (as of Monday 19:30, the work of all services was not restored, for all users the sample instructions for moving to another data center described above were published; as of this writing The incident on the site <a href="http://status.aws.amazon.com/">status.aws.amazon.com was</a> not closed - it took 39 hours) or they took data from the backup, losing the last changes (they are critical for our site). <br><br>  In addition, we have made very important conclusions on the support of a symmetric web cluster in the 1C-Bitrix platform.  It just allows you to run different nodes of a web project at once in several data centers at any distance from each other.  Such a scheme would allow us to locate one node now, for example, in the same Ireland, and another - for example, in the USA.  Failure of the entire Availability Zone, and not just one data center, would not affect another zone, and the downtime of our sites would be minimal. <br><br><img src="https://habrastorage.org/storage1/e3d46410/c5d8c547/2debbf5b/91baf134.png"><br><br>  Support for this decision <a href="http://conf.1c-bitrix.ru/summer2011/agenda/1459/">was announced at the latest partner conference</a> "1C-Bitrix".  It will be included in the next release of the 1C-Bitrix platform 10.5, which will be released this fall. <br><br>  Let's get ready for the raging of the elements and we will believe that nature has no bad weather.  :) </div><p>Source: <a href="https://habr.com/ru/post/125932/">https://habr.com/ru/post/125932/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../125920/index.html">Luxoft Corporate Blog: how to find us?</a></li>
<li><a href="../125923/index.html">Monkey Business, or how to use Kinect</a></li>
<li><a href="../125925/index.html">NFC vs biometric identification - who is first?</a></li>
<li><a href="../125927/index.html">Defcon presents an Android program to test the reliability of computer network protection.</a></li>
<li><a href="../125931/index.html">UIWebView Synchronous Download</a></li>
<li><a href="../125933/index.html">Taiwanese Research Institute has developed a rewritable thermal paper</a></li>
<li><a href="../125934/index.html">Restrictions in the secure_link "real" world</a></li>
<li><a href="../125935/index.html">Hi, Habr</a></li>
<li><a href="../125936/index.html">Viral marketing: basic rules</a></li>
<li><a href="../125937/index.html">Property in C ++ to C ++ (without using a preprocessor)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>