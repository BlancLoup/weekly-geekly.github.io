<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How I made the API work in Yiinitializr Advanced</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In continuation of my previous post about such an interesting tool as Yiinitializr , I decided to answer the question about the possibilities of the A...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How I made the API work in Yiinitializr Advanced</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/e35/937/e6d/e35937e6db98e4fdead307aa3f7f8d9d.png"><br><br>  In continuation of <a href="http://habrahabr.ru/post/207454/">my previous post</a> about such an interesting tool as <a href="http://yiinitializr.2amigos.us/">Yiinitializr</a> , I decided to answer the question about the possibilities of the API, provided by the Advanced template.  In the framework of the commentary or an additional paragraph to the last article, the material could not be accommodated, therefore I invite all those who are interested in this topic under cat.  In it, we will not deal with the principles of designing the correct API architecture, but let's figure out how to take advantage of the work of the <i>2amigos</i> guys, who gave us the opportunity to quickly <i>(after reading the article - exactly quickly)</i> deploy the API for our projects on Yii. <br><br><h3>  The way to implement working with the API in Yiinitializr </h3><br>  <b>API</b> - application programming interface that serves for use in external software products.  If we want other developers to use the capabilities of our application in their projects, we cannot do without a well-designed API.  Unfortunately, Yii of the first version will not be able to help in this matter.  Probably, Yiinitializr will suit you, which will solve some of the issues, but, as we know, the lack of documentation is a serious obstacle. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Imagine that the work on our wonderful application is completed, the work of the API is adjusted, and the first developer who wants to take advantage of the capabilities of our system has appeared.  What is the principle of its use? <br><a name="habracut"></a><br>  Our system generates, issues and stores in the database the public key (external application identifier), the private key, as well as the user for whom these keys are reserved.  Registration is over.  The interaction of the user API with our system is based on the principles of REST.  The user application sends a request to our system using a specific HTTP method, which includes the HTTP header with the public key, as well as a message in JSON format, which necessarily contains the signature and its expiration date, as well as various additional parameters.  After processing the request and making sure that it is correct, the system gives the answer. <br><br><h3>  Advanced Pattern Differences </h3><br>  If earlier it was a question of the Intermediate pattern, now let's take a look at what has been added to the Advanced pattern.  As you already understood - all the additional features that it gives us are associated with the API.  Download, unpack and go to the directory <code>./api</code> to see what we now have.  And we have: <br><br>  <code>./api/extensions/filters/EApiAccessControlFilter.php</code> is a filter class for checking API access rules. <br>  <code>./api/extensions/components/EApiAccessRule.php</code> is a class that represents an API access rule. <br>  <code>./api/extensions/components/EApiActiveRecord.php</code> - class for auxiliary methods of working with AR-models with API. <br>  <code>./api/extensions/components/EApiController.php</code> - controller class for processing requests to API. <br>  <code>./api/extensions/components/EApiError.php</code> is an API error class that exists for the convenience of reading logs. <br>  <code>./api/extensions/components/EApiErrorHandler.php</code> is a class for handling API errors.  If we decide to log errors to the database, then we will use this particular class. <br>  <code>./api/models/ApiUser.php</code> is an example of a model with which we will manage external users of our API. <br>  <code>./common/lib/YiiRestTools/</code> - helper classes for the functioning of the REST API. <br><br>  This general information will be enough to go directly to the implementation of the interaction of a third-party application with our system through the API. <br><br><h3>  Configuring and fixing bugs </h3><br>  The developers of Yiinitializr apparently followed the Pareto principle, and having completed 80% of the work, they decided not to spend 80% of the time on documentation and fixing bugs, putting it on the shoulders of sophisticated developers <i>(that is, us)</i> . <br><br>  Once we decided to do the configuration of Yiinitializr, then of course we are interested in the configuration file.  Open it and look at the API routing rules ( <code>./api/config/api.php</code> ): <br><br><pre> <code class="php hljs"><span class="hljs-string"><span class="hljs-string">'rules'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-comment"><span class="hljs-comment">// REST patterns array('&lt;controller&gt;/index', 'pattern' =&gt; 'api/&lt;controller:\w+&gt;', 'verb' =&gt; 'POST'), array('&lt;controller&gt;/view', 'pattern' =&gt; 'api/&lt;controller:\w+&gt;/view', 'verb' =&gt; 'POST'), array('&lt;controller&gt;/update', 'pattern' =&gt; 'api/&lt;controller:\w+&gt;/update', 'verb' =&gt; 'PUT'), array('&lt;controller&gt;/delete', 'pattern' =&gt; 'api/&lt;controller:\w+&gt;/delete', 'verb' =&gt; 'DELETE'), array('&lt;controller&gt;/create', 'pattern' =&gt; 'api/&lt;controller:\w+&gt;/create', 'verb' =&gt; 'POST'), ),</span></span></code> </pre><br>  We see something incomprehensible.  The comment tells us that this is a REST template, but in fact we get not quite that.  REST assumes that all requests go to a single URL, and actions are selected based on HTTP methods and request parameters, i.e. it should be like this: <br><table><tbody><tr><th>  Address </th><th>  HTTP method </th><th>  Action caused </th></tr><tr><td>  api.yiinitializr.dev/test/ </td><td>  Get </td><td>  TestController \ actionIndex () </td></tr><tr><td>  api.yiinitializr.dev/test/1/ </td><td>  Get </td><td>  TestController \ actionView (1) </td></tr><tr><td>  api.yiinitializr.dev/test/ </td><td>  POST </td><td>  TestController \ actionCreate () </td></tr><tr><td>  api.yiinitializr.dev/test/1/ </td><td>  PUT </td><td>  TestController \ actionUpdate (1) </td></tr><tr><td>  api.yiinitializr.dev/test/1/ </td><td>  DELETE </td><td>  TestController \ actionDelete (1) </td></tr></tbody></table><br>  We bring the rules to the desired form: <br><br><pre> <code class="php hljs"><span class="hljs-string"><span class="hljs-string">'rules'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-comment"><span class="hljs-comment">// REST patterns array('&lt;controller&gt;/index', 'pattern' =&gt; '&lt;controller:\w+&gt;', 'verb' =&gt; 'GET'), array('&lt;controller&gt;/view', 'pattern' =&gt; '&lt;controller:\w+&gt;/&lt;id:\d+&gt;', 'verb' =&gt; 'GET'), array('&lt;controller&gt;/update', 'pattern' =&gt; '&lt;controller:\w+&gt;/&lt;id:\d+&gt;', 'verb' =&gt; 'PUT'), array('&lt;controller&gt;/delete', 'pattern' =&gt; '&lt;controller:\w+&gt;/&lt;id:\d+&gt;', 'verb' =&gt; 'DELETE'), array('&lt;controller&gt;/create', 'pattern' =&gt; '&lt;controller:\w+&gt;', 'verb' =&gt; 'POST'), ),</span></span></code> </pre><br>  We will not find anything really important for the current stage in the configuration file, so we move on to other problems.  The solution to the first is absolutely simple - portable <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">YiiRestTools</span></span>\<span class="hljs-title"><span class="hljs-title">Helpers</span></span>\<span class="hljs-title"><span class="hljs-title">RequestData</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Yiinitializr</span></span>\<span class="hljs-title"><span class="hljs-title">Helpers</span></span>\<span class="hljs-title"><span class="hljs-title">ArrayX</span></span>;</code> </pre><br>  from <code>EApiAccessControlFilter.php</code> in <code>EApiAccessRule.php</code> , <code>EApiAccessRule.php</code> these classes are used in the second file. <br><br>  The next problem is more interesting.  Perhaps I did not understand something, so I propose to speculate together.  Take a close look at the code below ( <code>./api/extensions/components/EApiAccessRule.php</code> ): <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isRequestAllowed</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($user, $controller, $action, $ip, $verb)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;isActionMatched($action) &amp;&amp; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;isUserMatched(Yii::app()-&gt;user) &amp;&amp; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;isRoleMatched(Yii::app()-&gt;user) &amp;&amp; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;isSignatureMatched($user) &amp;&amp; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;isIpMatched($ip) &amp;&amp; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;isVerbMatched($verb) &amp;&amp; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;isControllerMatched($controller) ) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;allow ? <span class="hljs-number"><span class="hljs-number">1</span></span> : <span class="hljs-number"><span class="hljs-number">-1</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; } }</code> </pre><br>  The <code>isRequestAllowed</code> method checks the compliance of the request with the rules.  If the chain of checks in the if block is true, then this rule is applied, returning 1 or -1, depending on what this rule does - allows or denies.  Otherwise, this rule is not applicable to a specific request and the method returns 0. To make it clearer, I remind you what the rules for filters look like: <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">filters</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'EApiAccessControlFilter -error'</span></span>, <span class="hljs-string"><span class="hljs-string">'rules'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-string"><span class="hljs-string">'allow'</span></span>, <span class="hljs-string"><span class="hljs-string">'users'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-string"><span class="hljs-string">'@'</span></span>)), ) ) ); }</code> </pre><br>  Confuses one thing, namely the verification of the signature of <code>$this-&gt;isSignatureMatched($user)</code> in this thread.  Obtaining an incorrect signature, the system decides that this rule is not applicable and accordingly passes the user <i>(or hacker)</i> inside.  Most likely, verification of the signature should be made at the correct request after, and according to the result, let or not let us into the system.  Therefore, it is necessary to slightly change this method: <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isRequestAllowed</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($user, $controller, $action, $ip, $verb)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;isActionMatched($action) &amp;&amp; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;isUserMatched(Yii::app()-&gt;user) &amp;&amp; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;isRoleMatched(Yii::app()-&gt;user) &amp;&amp; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;isIpMatched($ip) &amp;&amp; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;isVerbMatched($verb) &amp;&amp; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;isControllerMatched($controller) ) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;allow &amp;&amp; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;isSignatureMatched($user)) ? <span class="hljs-number"><span class="hljs-number">1</span></span> : <span class="hljs-number"><span class="hljs-number">-1</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; } }</code> </pre><br>  With flaws like over.  The lack of documentation comes into play.  Using the debugger step-by-step, I studied the interaction mechanisms of the API classes and I hasten to share my observations with you. <br><br>  To get started, do the basic settings as described in the <a href="http://habrahabr.ru/post/207454/">Large manual</a> .  Then let's define in the configuration the name of the HTTP header in which we will send the public key ( <code>./api/config/api.php</code> ): <br><br><pre> <code class="php hljs"><span class="hljs-string"><span class="hljs-string">'params'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'api.key.name'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'APIKEY'</span></span>, )</code> </pre><br>  Do not forget to set the correct time zone (it should be the same for our system and the client application) ( <code>common/config/main.php</code> ): <br><br><pre> <code class="php hljs"><span class="hljs-string"><span class="hljs-string">'params'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( ... <span class="hljs-string"><span class="hljs-string">'php.timezone'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Europe/Moscow'</span></span>, ),</code> </pre><br>  We start installation through Composer, it is <i>already possible</i> . <br>  Now, to test the API, we need to register an external user.  Create a new migration: <br><br><pre> <code class="bash hljs">&gt; yiic migrate create create_api_user_table</code> </pre><br>  And we bring <code>up()</code> and <code>down()</code> methods to the following form: <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">up</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;createTable(<span class="hljs-string"><span class="hljs-string">'{{api_user}}'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'id'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'pk'</span></span>, <span class="hljs-string"><span class="hljs-string">'username'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'varchar(32) NOT NULL'</span></span>, <span class="hljs-string"><span class="hljs-string">'api_key'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'varchar(32) NOT NULL'</span></span>, <span class="hljs-string"><span class="hljs-string">'api_secret'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'varchar(32) NOT NULL'</span></span>, )); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;insert(<span class="hljs-string"><span class="hljs-string">'{{api_user}}'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'username'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'test_user'</span></span>, <span class="hljs-string"><span class="hljs-string">'api_key'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'e4afe26b5b57083f74b2d01c7066379c'</span></span>, <span class="hljs-comment"><span class="hljs-comment">// md5('public_key') 'api_secret' =&gt; '156a17333e77a3c504018cae5ada8c3b', // md5('private_key') )); } public function down() { $this-&gt;dropTable('{{api_user}}'); }</span></span></code> </pre><br>  We also edit the name of the table containing the users of our API in the <code>ApiUser</code> model. <br><br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ApiUser</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EApiActiveRecord</span></span></span><span class="hljs-class"> </span></span>{ ... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">tableName</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">'{{api_user}}'</span></span>; } ... }</code> </pre><br>  We apply our migration.  The result will be a table in the database with a single <i>hypothetical</i> user of our API.  Go ahead. <br><br><h3>  We write a simple client application </h3><br>  The final step is to write a simple client application for working with the Yiinitializr API.  For its work, you must be able to send requests using various HTTP methods, the <a href="http://php.net/manual/ru/book.curl.php">cURL library</a> will help us with this.  Without further ado all the code is decomposed under spoilers.  We open, we look, we copy. <br><br><div class="spoiler">  <b class="spoiler_title">SimpleClient Client Class</b> <div class="spoiler_text">  The <code>generateSignature()</code> method for generating a signature is based on the <code>prepareData($secretKey)</code> method of the <code>prepareData($secretKey)</code> class of the <code>RequestData</code> library. <br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">/** * Class SimpleClient * * Simple REST-client for Yiinitializr Advanced API. */</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SimpleClient</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $baseUrl; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $apiPublic; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $apiSecret; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $expiration; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($url, $publicKey, $secretKey, $expiration = </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">'+1 hour'</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;baseUrl = $url; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;apiPublic = $publicKey; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;apiSecret = $secretKey; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;expiration = $expiration; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">makeRequest</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($verb, $controller, $params = array</span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">()</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ $ch = curl_init(); $signature = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;generateSignature(); $url = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;makeUrl($controller); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>($params) &amp;&amp; <span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>($params[<span class="hljs-string"><span class="hljs-string">'id'</span></span>])) { $url .= $params[<span class="hljs-string"><span class="hljs-string">'id'</span></span>]; } curl_setopt_array($ch, <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( CURLOPT_URL =&gt; $url, CURLOPT_CUSTOMREQUEST =&gt; $verb, CURLOPT_HTTPHEADER =&gt; <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-string"><span class="hljs-string">'APIKEY: '</span></span> . <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;apiPublic), CURLOPT_POSTFIELDS =&gt; json_encode(<span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'signature'</span></span> =&gt; $signature, <span class="hljs-string"><span class="hljs-string">'expiration'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;relativeTimeToAbsolute(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;expiration), )), )); $result = curl_exec($ch); curl_close($ch); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $result; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">generateSignature</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $ttdInt = strtotime(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;expiration); $raw = json_encode(<span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-string"><span class="hljs-string">'expiration'</span></span> =&gt; gmdate(<span class="hljs-string"><span class="hljs-string">'Ymd\TH:i:s\Z'</span></span>, $ttdInt))); $jsonPolicy64 = base64_encode($raw); $signature = base64_encode(hash_hmac( <span class="hljs-string"><span class="hljs-string">'sha1'</span></span>, $jsonPolicy64, <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;apiSecret, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> )); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $signature; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">makeUrl</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($controller)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">'http://'</span></span> . rtrim(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;baseUrl, <span class="hljs-string"><span class="hljs-string">'/'</span></span>) . <span class="hljs-string"><span class="hljs-string">'/'</span></span> . $controller . <span class="hljs-string"><span class="hljs-string">'/'</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">relativeTimeToAbsolute</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($relativeTime)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> date(<span class="hljs-string"><span class="hljs-string">'M d Y, H:i:s'</span></span>, strtotime($relativeTime)); } }</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Working with the SimpleClient class</b> <div class="spoiler_text"><pre> <code class="php hljs">$api = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SimpleClient(<span class="hljs-string"><span class="hljs-string">'api.yiinitializr.dev'</span></span>, <span class="hljs-string"><span class="hljs-string">'e4afe26b5b57083f74b2d01c7066379c'</span></span>, <span class="hljs-string"><span class="hljs-string">'156a17333e77a3c504018cae5ada8c3b'</span></span>); $api-&gt;makeRequest(<span class="hljs-string"><span class="hljs-string">'GET'</span></span>, <span class="hljs-string"><span class="hljs-string">'test'</span></span>); $api-&gt;makeRequest(<span class="hljs-string"><span class="hljs-string">'GET'</span></span>, <span class="hljs-string"><span class="hljs-string">'test'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-string"><span class="hljs-string">'id'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">1</span></span>)); $api-&gt;makeRequest(<span class="hljs-string"><span class="hljs-string">'POST'</span></span>, <span class="hljs-string"><span class="hljs-string">'test'</span></span>); $api-&gt;makeRequest(<span class="hljs-string"><span class="hljs-string">'PUT'</span></span>, <span class="hljs-string"><span class="hljs-string">'test'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-string"><span class="hljs-string">'id'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">1</span></span>)); $api-&gt;makeRequest(<span class="hljs-string"><span class="hljs-string">'DELETE'</span></span>, <span class="hljs-string"><span class="hljs-string">'test'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-string"><span class="hljs-string">'id'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">1</span></span>));</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Modified Test Controller Version</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TestController</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EApiController</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">actionIndex</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// just drop API request :) $this-&gt;renderJson(array('response' =&gt; 'index')); } public function actionView($id) { $this-&gt;renderJson(array('response' =&gt; 'view#' . $id)); } public function actionCreate() { $this-&gt;renderJson(array('response' =&gt; 'created')); } public function actionUpdate($id) { $this-&gt;renderJson(array('response' =&gt; 'updated#' . $id)); } public function actionDelete($id) { $this-&gt;renderJson(array('response' =&gt; 'deleted#' . $id)); } }</span></span></code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Apache setup</b> <div class="spoiler_text">  In order for Apache to stop blocking PUT and DELETE requests, you need to add the following lines to the <code>./api/www/.htaccess</code> file: <br><br><pre> <code class="apache hljs"><span class="hljs-section"><span class="hljs-section">&lt;Limit GET POST PUT DELETE&gt;</span></span> <span class="hljs-attribute"><span class="hljs-nomarkup"><span class="hljs-attribute"><span class="hljs-nomarkup">order</span></span></span></span> deny,allow allow from <span class="hljs-literal"><span class="hljs-literal">all</span></span> &lt;/Limit&gt;</code> </pre><br>  <a href="http://www.yiiframework.com/wiki/175/how-to-create-a-rest-api">The decision is made here</a> . <br></div></div><br><h3>  Summing up </h3><br>  This is the <i>simple</i> way we made <i>our car</i> start.  It took me more than one day <i>(and not even two)</i> to understand what was happening.  In any case, such a decision would be quite appropriate as a starting point, based on which it is much easier to make a high-quality API, without having deep knowledge in this matter.  Of the additional links, I can advise you to look at the <a href="http://habrahabr.ru/post/207454/">Great Guide to Yiinitializr</a> <i>(haven't you done it yet?)</i> And the article <a href="http://www.yiiframework.com/wiki/175/how-to-create-a-rest-api">How to make a REST API for Yii</a> <i>(in English)</i> . <br><br>  In the comments I propose to share your thoughts on the implementation of the API on Yii, criticize this method and suggest improvements.  Thanks for attention. </div><p>Source: <a href="https://habr.com/ru/post/208376/">https://habr.com/ru/post/208376/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../208358/index.html">Turning your smartphone into a gaming console Dendy, Sega, PS</a></li>
<li><a href="../208364/index.html">Get ROOT rights on any * phone</a></li>
<li><a href="../208368/index.html">Calculation of the fractal dimension of Minkowski for a flat image</a></li>
<li><a href="../208370/index.html">Koreans made a nanobot to fight cancer</a></li>
<li><a href="../208374/index.html">Intel announced support for Steam Machines and announced Dual OS officially + response from AMD</a></li>
<li><a href="../208378/index.html">Creating zip modules in python</a></li>
<li><a href="../208384/index.html">The official openSUSE forum is hacked</a></li>
<li><a href="../208388/index.html">Vaadin: Useful Improvements and Observations</a></li>
<li><a href="../208390/index.html">High-precision machines must not be moved without the permission of the manufacturer.</a></li>
<li><a href="../208392/index.html">Name in success or success in name? (trademarks part2)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>