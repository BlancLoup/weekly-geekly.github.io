<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Safe code in Drupal: Work with the database</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="(P1. Cross-site request forgery; P3. Working with user input ) 

 Drupal provides its own means to access the database. 

 Firstly, it allows not to d...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Safe code in Drupal: Work with the database</h1><div class="post__text post__text-html js-mediator-article"><img src="http://drupaldance.com/files/dbtroll.gif" align="right"><br><br>  (P1. <a href="http://habrahabr.ru/blogs/drupal/52132/">Cross-site request</a> forgery; P3. <a href="http://habrahabr.ru/blogs/drupal/56291/">Working with user input</a> ) <br><br>  Drupal provides its own means to access the database. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Firstly, it allows not to depend on the type of DBMS used.  By the way, at the moment, the layer for MySQL and PostgreeSQL is fully functioning.  In the seventh Drupal this list will be expanded by Oracle and SQLite. <br><br>  Secondly, the database layer helps protect against SQL injections. <br><a name="habracut"></a><br>  The very first function that you should learn about when working with the database is <a href="http://api.drupal.ru/api/function/db_query">db_query ()</a> . <br><br>  I will begin, perhaps, with an example in the style of which almost all beginning drupallers write: <br><br><blockquote><code><font color="black"><font color="#008000">/**</font> <br> <font color="#008000">*  1 - </font> <br> <font color="#008000">*        $type (,    )</font> <br> <font color="#008000">*/</font> <br> $result = db_query( <font color="#A31515">"SELECT nid, title FROM node WHERE type = '$type'"</font> ); <br> <br> $items = array(); <br> <font color="#0000ff">while</font> ($row = db_fetch_object($result)) { <br> $items[] = l($row-&gt;title, <font color="#A31515">"node/{$row-&gt;nid}"</font> ); <br> } <br> <font color="#0000ff">return</font> theme( <font color="#A31515">'item_list'</font> , $items);</font></code> </blockquote> <br><br>  In this example, several things are wrong at the root. <br><br><h2>  Table Name Aliases </h2><br><br>  Table names should be enclosed in curly brackets, and they should also be assigned aliases, which are recommended to be always used when referring to columns.  The modified call will look like this: <br><br><blockquote> <code><font color="black">$result = db_query( <font color="#A31515">"SELECT n.nid, n.title FROM {node} n WHERE n.type = '$type'"</font> );</font> <br></code> </blockquote><br><br>  What will it give us?  This will ensure that tables with prefixes are easily processed.  That is, if you have all the tables in the database called ‚Äúpr_node‚Äù, ‚Äúpr_users‚Äù, etc., Drupal will automatically substitute the correct prefixes to the tables enclosed in brackets.  Specifying pseudonyms will eliminate the need to use curly brackets more than once. <br><br><h2>  Argument Filtering </h2><br><br>  There is no filtering of the request arguments.  This is a direct path to SQL injection.  If the <code>$type</code> is <code>story' UNION SELECT s.sid, s.sid FROM {sessions} s WHERE s.uid = 1/*</code> , then the whole query will be like this: <br><br><blockquote> <code><font color="black"><font color="#0000ff">SELECT</font> n.nid, n.title <font color="#0000ff">FROM</font> {node} n <font color="#0000ff">WHERE</font> n.type = <font color="#A31515">'story'</font> <font color="#0000ff">UNION</font> <font color="#0000ff">SELECT</font> s.sid, s.sid <font color="#0000ff">FROM</font> {sessions} s <font color="#0000ff">WHERE</font> s.uid = 1/*'</font> <br></code> </blockquote><br><br>  which will allow the fraudster to get hold of the session IDs and, in turn, when creating the correct session cookie, get direct admin access to the site. <br><br>  To protect against this is quite simple, using the parameterization of the query.  When forming a query, Drupal uses the syntax of the <a href="http://www.php.net/manual/en/function.sprintf.php">sprintf</a> function.  In the query string, stubs are inserted, which are replaced by parameters that go separately.  In this case, the parameters are tested and screened, so that you can forget about injections using this approach.  Here are some examples: <br><br><blockquote> <code><font color="black">db_query( <font color="#A31515">"SELECT n.nid FROM {node} n WHERE n.nid &gt; %d"</font> , $nid); <br> db_query( <font color="#A31515">"SELECT n.nid FROM {node} n WHERE n.type = '%s'"</font> , $type); <br> db_query( <font color="#A31515">"SELECT n.nid FROM {node} n WHERE n.nid &gt; %d AND n.type = '%s'"</font> , $nid, $type); <br> db_query( <font color="#A31515">"SELECT n.nid FROM {node} n WHERE n.type = '%s' AND n.nid &gt; %d"</font> , $type, $nid);</font> <br></code> </blockquote><br><br>  List of substitutes: <br><br><ul><li>  % d - for integers </li><li>  % f - for floating-point numbers, i.e.  fractional (floats) </li><li>  % s - for strings (however, note that in the query, quotation marks are set around the string) </li><li>  % b - binary data (no need to wrap in quotes) </li><li>  %% - replaced by% (for example, for <code>LIKE %monkey%</code> ) </li></ul><br><br>  For <code>IN (... , ... , ...)</code> constructions, use the <a href="http://api.drupal.ru/api/function/db_placeholders">db_placeholders ()</a> function, which will create the necessary sequence of substitutes, using a given array of parameters, for example: <br><br><blockquote> <code><font color="black">$nids = array(1, 5, 449); <br> db_query( <font color="#A31515">'SELECT * FROM {node} n WHERE n.nid IN ('</font> . db_placeholders($nids) . <font color="#A31515">')'</font> , $nids);</font> <br></code> </blockquote><br><br><blockquote>  If you are using the Devel module, you have a very simple way of getting final queries for debugging purposes.  Just call the <code>db_queryd()</code> function with exactly the same parameters as you call <code>db_query()</code> . </blockquote><br><br>  Now, our query will look like this: <br><br><blockquote> <code><font color="black">$result = db_query( <font color="#A31515">"SELECT n.nid, n.title FROM {node} n WHERE n.type = '%s'"</font> , $type);</font> <br></code> </blockquote><br><br><h2>  Ranking query results </h2><br><br>  Our example on a large site will display a huge list of nodes.  What if we can be limited to just the top ten?  The first urge is to use the LIMIT SQL construct, for example <br><br><blockquote> <code><font color="black"><font color="#0000ff">SELECT</font> n.nid, n.title <font color="#0000ff">FROM</font> {node} n <font color="#0000ff">WHERE</font> n.type = <font color="#A31515">'%s'</font> <font color="#0000ff">LIMIT</font> 0, 10</font> <br></code> </blockquote><br><br>  and everything seems to be fine, but on Postgree SQL this code will lead to an error, since with this control server you need to use the <code>OFFSET 0 LIMIT 10</code> construct.  And on some Orakle, the syntax is different again.  What to do? <br><br>  The answer is to use <a href="http://api.drupal.ru/api/function/db_query_range">db_query_range ()</a> to limit the number of query results.  Its use is similar to db_query, except that in after all the arguments, you need to specify two parameters - the number of the first line, and the number of results.  Our query will translate into the following: <br><br><blockquote> <code><font color="black"><font color="#008000">//   10 </font> <br> $result = db_query_range( <font color="#A31515">"SELECT n.nid, n.title FROM {node} n WHERE n.type = '%s'"</font> , $type, 0, 10);</font> <br></code> </blockquote><br><br>  And lastly, if you still need pagination for everything, use the <a href="http://api.drupal.ru/api/function/pager_query/6">pager_query ()</a> function.  It differs from <code>db_query_range()</code> by the presence of just one optional parameter, which you can read about on the documentation page.  With this function, flipping pages is as simple as twice two: <br><br><blockquote> <code><font color="black"><font color="#008000">/**</font> <br> <font color="#008000">*  2 - ,  </font> <br> <font color="#008000">*/</font> <br> <font color="#008000">//   </font> <br> $result = pager_query( <font color="#A31515">"SELECT n.nid, n.title FROM {node} n WHERE n.type = '%s'"</font> , $type, 0, 10); <br> <br> $items = array(); <br> <font color="#0000ff">while</font> ($row = db_fetch_object($result)) { <br> $items[] = l($row-&gt;title, <font color="#A31515">"node/{$row-&gt;nid}"</font> ); <br> } <br> <br> $output = theme( <font color="#A31515">'item_list'</font> , $items); <br> <br> <font color="#008000">//  </font> <br> $output .= theme( <font color="#A31515">'pager'</font> ); <br> <br> <font color="#0000ff">return</font> $output;</font> <br></code> </blockquote><br><br>  As you can see, just two lines of change.  The whole routine of picking up the current page, processing, etc.  Drupal takes over completely. <br><br><h2>  The ability to change the request modules </h2><br><br>  Quite often it makes sense to give other modules the opportunity to influence your request.  In Drupal, this is implemented by the <a href="http://api.drupal.ru/api/function/db_rewrite_sql">link</a> function <a href="http://api.drupal.ru/api/function/db_rewrite_sql">db_rewrite_sql ()</a> , and hook implementations <a href="http://api.drupal.ru/api/function/hook_db_rewrite_sql">hook_db_rewrite_sql ()</a> in modules.  Our query will look like this: <br><br><blockquote> <code><font color="black">$result = pager_query(db_rewrite_sql( <font color="#A31515">"SELECT n.nid, n.title FROM {node} n WHERE n.type = '%s'"</font> , <font color="#A31515">'n'</font> , <font color="#A31515">'nid'</font> ), $type, 0, 10);</font> <br></code> </blockquote><br><br>  and here is an example of a hook implementation, so that you have an idea of ‚Äã‚Äãwhat is happening: <br><br><blockquote> <code><font color="black"><font color="#008000">//    ,       </font> <br> function my_module_db_rewrite_sql($query, $primary_table, $primary_field, $args) { <br> <font color="#0000ff">switch</font> ($primary_field) { <br> <font color="#0000ff">case</font> <font color="#A31515">'nid'</font> : <br> <font color="#0000ff">if</font> ($primary_table == <font color="#A31515">'n'</font> ) { <br> $ <font color="#0000ff">return</font> [ <font color="#A31515">'join'</font> ] = <font color="#A31515">"LEFT JOIN {users} u ON $primary_table.uid = u.uid"</font> ; <br> $ <font color="#0000ff">return</font> [ <font color="#A31515">'where'</font> ] = <font color="#A31515">'u.login &gt; '</font> . time() - 60 * 60 * 24; <br> } <br> <font color="#0000ff">return</font> $ <font color="#0000ff">return</font> ; <br> <font color="#0000ff">break</font> ; <br> } <br> }</font> <br></code> </blockquote><br><br>  Items returned from the 'join' hook will be attached to our query, 'where' will be added to the list of conditions, and our query after processing will be like this: <br><br><blockquote> <code><font color="black">SELECT n.nid, n.title FROM {node} n LEFT JOIN {users} u ON n.uid = u.uid WHERE n.type = <font color="#A31515">'%s'</font> AND u.login &gt; 199976743</font> <br></code> </blockquote><br><br>  After that, it will actually go to <code>pager_query()</code> and will be processed as usual. <br><br><h3>  Final sample code </h3><br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#008000">/**</font> <br> <font color="#008000">*  3 - ,      </font> <br> <font color="#008000">*/</font> <br> <font color="#008000">//  db_rewrite_sql</font> <br> $result = pager_query(db_rewrite_sql( <font color="#A31515">"SELECT n.nid, n.title FROM {node} n WHERE n.type = '%s'"</font> , <font color="#A31515">'n'</font> , <font color="#A31515">'nid'</font> ), $type, 0, 10); <br> <br> $items = array(); <br> <font color="#0000ff">while</font> ($row = db_fetch_object($result)) { <br> $items[] = l($row-&gt;title, <font color="#A31515">"node/{$row-&gt;nid}"</font> ); <br> } <br> <br> $output = theme( <font color="#A31515">'item_list'</font> , $items); <br> <br> $output .= theme( <font color="#A31515">'pager'</font> ); <br> <br> <font color="#0000ff">return</font> $output;</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br><h3>  useful links </h3><ul><li>  <a href="http://api.drupal.ru/api/group/database/6">Database functions</a> </li><li>  <a href="http://drupal.org/node/2497">Drupal SQL Encoding Standards</a> </li></ul><br><h3>  Articles cycle "Safe Code" </h3><ul><li>  <a href="http://drupaldance.com/lessons/secure-code-csrf">Cross-site request forgery</a> </li><li>  <a href="http://drupaldance.com/lessons/secure-code-database-layer">Work with database</a> </li></ul></div><p>Source: <a href="https://habr.com/ru/post/52469/">https://habr.com/ru/post/52469/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../52463/index.html">Our abroad - now also the forum ...</a></li>
<li><a href="../52464/index.html">Salesforce.com CRM in Russia</a></li>
<li><a href="../52465/index.html">How to stop animated gif in browser</a></li>
<li><a href="../52467/index.html">Beta Quake Live will be open to all!</a></li>
<li><a href="../52468/index.html">Portable Gajim [win]</a></li>
<li><a href="../52472/index.html">Estimated time to complete the task</a></li>
<li><a href="../52473/index.html">Our abroad - now also the forum ...</a></li>
<li><a href="../52474/index.html">Why itertools rocks</a></li>
<li><a href="../52475/index.html">Progressive technologies, as a way to squeeze the maximum out of the server</a></li>
<li><a href="../52476/index.html">Adium update 1.3.3</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>