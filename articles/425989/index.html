<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Under the hood Graveyard Keeper: How graphic effects are implemented</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello! For 4 years I did not write on Habr. My last series of posts was about various tools and tricks that we used on our last game (developing it on...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Under the hood Graveyard Keeper: How graphic effects are implemented</h1><div class="post__text post__text-html js-mediator-article">  Hello!  For 4 years I did not write on Habr.  My last <a href="https://habr.com/post/244493/">series of posts</a> was about various tools and tricks that we used on our last game (developing it on Unity).  Since then, the game that we have safely released, and also released a new one.  So now you can breathe a little and write a few new articles that may be useful to someone. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/wb/qc/nc/wbqcnc2xkeiepxqphi3iphwnoo0.gif"></div><br>  Today I want to talk about graphic techniques and tricks that we used to create the image that you see on the gif above. <br><br>  We are very sensitive to the visuals of our games and for this we have invested quite a lot of time and energy into various effects and other buns that would make our pixel art as attractive as possible.  Perhaps someone will find something useful for themselves. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      To begin with, briefly list what is going to picture in our game: <a name="habracut"></a><br><br><ol><li>  Variable ambient light - a banal change in light depending on the time of day. </li><li>  LUT-color correction - is responsible for changing the tone of the picture depending on the time of day (or zone type). </li><li>  Dynamic light sources - torches, stoves, lamps. </li><li>  Normal maps - are responsible for giving objects volume, especially when moving light sources. </li><li>  Mathematics of 3D-distribution of light - is responsible for ensuring that the light source in the center of the screen correctly illuminates an object that is above, but does not illuminate an object that is below (that is, turned towards the camera with the unlighted side). </li><li>  Shadows - made by sprites, rotate and react to the position of light sources. </li><li>  Object height simulation - for correct fog display. </li><li>  Other decorators: rain, wind, animations (including shader animation of foliage and grass), etc. </li></ol><br>  Now - more. <br><br><h2>  Variable ambient light </h2><br>  Here, in principle, nothing special.  At night - darker, during the day - lighter.  The color of light is given by the gradient of the time of day.  By nightfall, the light source not only becomes darker, but takes on a blue tint. <br><br>  It looks like this: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/kz/uc/z6/kzucz6juapnzkaxln72k6h6o5pk.png"></div><br><h2>  LUT-color correction </h2><br>  LUT (Look-up table) - color replacement tables.  Roughly speaking, this is a three-dimensional array of RGB where in each node there is a color value, with which the corresponding one should be replaced.  That is, if there is a red dot on the coordinates (1, 1, 1), this means that all the white color in the picture will be replaced with red.  If the coordinates (1, 1, 1) are white (R = 1, G = 1, B = 1), then there is no change.  Accordingly, the LUT without changes has a color for each coordinates corresponding to these coordinates.  Those.  at the point (0.4, 0.5, 0.8) there is a color (R = 0.4, G = 0.5, B = 0.8). <br><br>  Well, it is worth noting that, for convenience, they represent a 3D texture as a two-dimensional one.  For example, this is what the ‚Äúdefault‚Äù LUT looks like (it doesn‚Äôt change the color rendition): <br><br><img src="https://habrastorage.org/webt/ev/dp/a_/evdpa_vrtx8qpwetg0a1lsbnvv4.png"><br><br>  It is implemented elementary, it works quickly and conveniently. <br><br>  It is also very simple to set up - you give the artist any picture from the game and say ‚Äúset the colors so that it is as if the evening‚Äù.  After that, you apply all layers of color correction to the default LUT and you get the LUT of the evening. <br><br>  In our case, the artist stumbled a bit and created as many as 10 different LUTs for different times of the day (night, dusk, evening, etc.).  This is what their setup looks like: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ra/rw/le/rarwlem4o5aoufvhb8vmficb-za.png"></div><br>  As a result, depending on the time of day, the same location looks different: <br><br><img src="https://habrastorage.org/webt/k2/fz/1w/k2fz1wmhn9yw-rcgvticox4_bh4.png"><br><br>  Here the transparency of the sprites of light from the windows still varies depending on the time of day. <br><br><h3>  Dynamic lights and normal maps </h3><br>  Light sources are used absolutely ordinary, from Unity.  In addition, each sprite is drawn normal maps, which allows you to get a sense of volume. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/hy/dv/vf/hydvvfxlld52gux9o0mnz2gavbe.gif"></div><br>  Drawing such normals is pretty simple.  The artist roughly draws light from 4 sides with a brush: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/0o/mv/jv/0omvjvscrffh1o8exichnqylnia.png"></div><br>  And then this script is already going to the normal map: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/_4/md/oa/_4mdoakkf1puyp5lyvwjn6zmm-g.png"></div><br>  If you are looking for a shader (and software) that does this, you can look in the direction of the Sprite Lamp. <br><br><h3>  3D imitation of light </h3><br>  It's a little more complicated here.  You can not just take and illuminate the sprites.  We need to consider whether the sprite is ‚Äúbehind‚Äù the light source or ‚Äúbefore.‚Äù <br><br>  Pay attention to this picture: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/k1/tr/51/k1tr51sgx_4fmnzjkhtkv176ye0.png"></div><br>  Both trees are at the same distance from the light source, but the far tree is lit, but the nearest is not (because its unlighted part is turned toward the camera). <br><br>  I solved this problem quite simply.  The shader calculates the distance along the vertical axis y between the light source and the sprite.  And if it is positive (the light source before the sprite), then we illuminate the sprite as usual, but if it is negative (the sprite blocks the light source), but the illumination intensity is very damped from a distance with a very large factor.  The coefficient is made, and not just ‚Äúnot to light‚Äù, so that when the light source moves and it turns out suddenly behind the sprite, the sprite does not instantly turn black, but gradually.  But still pretty quickly. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/vy/d7/cw/vyd7cwsfbrkbe4majwq81fynkck.gif"></div><br><h2>  Shadows </h2><br>  Shadows are made by sprites rotating around a point.  I tried to add more compression (skew), but it turned out to be unnecessary. <br><br>  In total, each object can have a maximum of 4 shadows.  One - from the sun, and three - from dynamic sources of light.  The picture below shows the principle: <br><br><img src="https://habrastorage.org/webt/8r/8_/u2/8r8_u21cgbiicmqpdvpjywl5rb4.png"><br><br>  The task ‚Äúto find the nearest 3 light sources and calculate the distance / angle of shadows to them‚Äù is solved by a script that revolves in Update.  Yes, it turns out not very fast, because  have to do a lot of math.  If I wrote now, I would use the newfangled systems of parallel jobs in Unity.  But then it was not yet, so I just optimized normal scripts as much as possible. <br><br>  The only thing that matters is that I did not make the rotation of the sprites transform, but inside the vertex shader.  Those.  rotation does not move.  It's just that a parameter is set in the sprite (I used the color for this, since all the shadows are all black), and the shader is responsible for the rotation of the sprite.  So it turns out faster, because  no need to tug geometry in unity. <br><br>  Another disadvantage of this approach is that the shadows have to be customized (and sometimes painted) individually for each object.  True, we managed, probably, a dozen different more or less universal sprites (thin, thick, oval, etc.). <br><br>  The second drawback is that it is sometimes difficult to make a shadow for an object whose ground contact spot is very long.  For example, look at the shadow of the fence: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/mo/i2/dr/moi2drffv8hi9ynls99ve-gqjnc.gif"></div><br>  Not ideal.  It looks like this if you make the sprite of the fence itself translucent: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/7j/0t/fz/7j0tfz3lovxbfy2d2zu1afhtl_e.gif"></div><br>  Here, however, it is worth noting that the sprite is still very strongly deformed vertically (the original shadow sprite looks almost like a circle).  That is why its rotation looks not so much as a rotation, but as a distortion. <br><br><h2>  Fog and height imitation </h2><br>  There is fog in the game.  It looks like this (above - the normal version, below - an extreme 100% fog, to demonstrate the effect). <br><br><img src="https://habrastorage.org/webt/4i/2r/c_/4i2rc__pzbgrqecd4oq83piemsu.png"><br><br>  As you can see, the tops of houses and trees protrude from the fog.  In fact, to achieve this effect was quite simple.  The fog consists of many horizontal clouds that are distributed throughout the depth of the scene.  As a result, the upper part of all sprites is covered with a smaller number of fog sprites: <br><br><img src="https://habrastorage.org/webt/43/gd/gr/43gdgrxqrdisek50lynbramf4bc.png"><br><br><h2>  Wind </h2><br>  The wind in pixel art is another story.  There are not many options here.  Either animate with your hands (which is almost impossible with our quantity of art), or write a deforming shader, but then you will have to endure ugly distortions sometimes.  You can, of course, do not animate at all, but then the picture looks inanimate. <br><br>  We chose the distortion option using a shader.  It looks like this: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/cb/uh/nn/cbuhnnzyx14un9chz96mma0qmyq.gif"></div><br>  If you apply this shader to the checkered texture, it becomes clear what is happening: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/uo/ag/n5/uoagn5vbuxpeee_71sn-frkklyk.gif"></div><br>  It is also worth noting that we are not animating the entire crown, but only individual leaves: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/2s/iu/my/2siumyhll6pl84c_hn6ursn-cpe.png"></div><br>  We also wind wheat in the wind, but everything is simple here - the vertex shader deforms the x-coordinates, and it takes the y-component into account.  The higher the point, the harder it is.  This is done so that only the tip staggers, but the root does not.  Plus - the reeling phase changes from x / y coordinates so that different sprites on the screen swing apart. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/gy/ks/z6/gyksz6p4hodfgv4e-shli_gelyg.gif"></div><br>  The same shader is also used to create the effect of swinging wheat and grass when a player passes through them. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/sz/oo/q9/szooq97kmlmd9wmmlqnjohyyqdm.gif"></div><br>  Probably, this is all for now.  I deliberately did not address the issue of constructing the scene and its geometry, since  This material is for a separate article.  In the rest - he told about the main decisions that were used in the development. <br><br>  <b>PS:</b> If someone is interested in some technical aspects, write in the comments.  Perhaps I will tell in a separate article.  If, of course, need. <br><br>  <b>PPS:</b> Taking this opportunity, I‚Äôll say that now we want to find some competent people in the team (programmer, PM, CM, artist).  Details - on the website of the studio.  I hope this phrase did not break the rules. </div><p>Source: <a href="https://habr.com/ru/post/425989/">https://habr.com/ru/post/425989/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../425977/index.html">Flexbox: how big is this flexible box?</a></li>
<li><a href="../425979/index.html">Universal Monitoring - Sucks</a></li>
<li><a href="../425981/index.html">Career newcomer in "LC": With leaps and bounds, slowly grow forward</a></li>
<li><a href="../425983/index.html">Flight safety</a></li>
<li><a href="../425985/index.html">Execution of user code on GO</a></li>
<li><a href="../425991/index.html">How we created hosting</a></li>
<li><a href="../425993/index.html">How to fix the gender gap in technology</a></li>
<li><a href="../425995/index.html">Visualize FHIR - the IT standard for medicine</a></li>
<li><a href="../425997/index.html">MIT course "Computer Systems Security". Lecture 11: "Ur / Web programming language", part 1</a></li>
<li><a href="../425999/index.html">MIT course "Computer Systems Security". Lecture 11: "Ur / Web programming language", part 2</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>